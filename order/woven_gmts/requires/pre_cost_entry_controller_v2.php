<?
/*-------------------------------------------- Comments -----------------------
Version (MySql)          :  V2
Version (Oracle)         :  V1
Converted by             :  MONZU
Converted Date           :  24-05-2014
Purpose			         : 	This Form Will Create Woven Pre Cost Entry.
Functionality	         :
JS Functions	         :
Created by		         :	Zakaria joy
Creation date 	         : 	18-05-2018
Comments		         :  This Page Copy from Woven gmts
Entry form 				 :  425
-------------------------------------------------------------------------------*/
header('Content-type:text/html; charset=utf-8');
session_start();
if( $_SESSION['logic_erp']['user_id'] == "" ) header("location:login.php");
include('../../../includes/common.php');
include('../../../includes/class4/class.conditions.php');
include('../../../includes/class4/class.reports.php');
include('../../../includes/class4/class.fabrics.php');
include('../../../includes/class4/class.yarns.php');
include('../../../includes/class4/class.conversions.php');
include('../../../includes/class4/class.trims.php');
include('../../../includes/class4/class.emblishments.php');
include('../../../includes/class4/class.washes.php');
include('../../../includes/class4/class.commercials.php');
include('../../../includes/class4/class.commisions.php');
include('../../../includes/class4/class.others.php');

if($_SESSION['app_notification'] == 1){
	include('../../../includes/class4/Notifications.php');
}

$data=$_REQUEST['data'];
$action=$_REQUEST['action'];
$type=$_REQUEST['type'];
$permission=$_SESSION['page_permission'];
//----------------------------------------------------Start---------------------------------------------------------
function special_chars_clean($string) {
	$string = str_replace(' ', '-', $string); // Replaces all spaces with hyphens.
	$string = preg_replace('/[^A-Za-z0-9\-]/', '', $string); // Removes special chars. 
	return preg_replace('/-+/', '-', $string); // Replaces multiple hyphens with single one.
}
//*************************************************Master Form Start************************************************
if($action=="save_post_session"){
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$_SESSION['logic_erp']['cons_breck_downn']="";
	$_SESSION['logic_erp']['msmnt_breack_downn']="";
	$_SESSION['logic_erp']['marker_breack_down']="";
	$_SESSION['logic_erp']['cons_breck_downn']=$cons_breck_downn;
	$_SESSION['logic_erp']['msmnt_breack_downn']=$msmnt_breack_downn;
	$_SESSION['logic_erp']['marker_breack_down']=$marker_breack_down;
	echo 1;
	die;
}

if ($action=="load_drop_down_buyer"){
	if($data != 0)
	{
		echo create_drop_down( "cbo_buyer_name", 130, "select buy.id,buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='$data' $buyer_cond and buy.id in (select buyer_id from lib_buyer_party_type where party_type in (1,3,21,90)) order by buyer_name","id,buyer_name", 1, "-- Select Buyer --", $selected, "" );
		exit();
	}
	else{
		echo create_drop_down( "cbo_buyer_name", 130, "SELECT buy.id as id ,buy.buyer_name as buyer_name  from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id $buyer_cond and buy.id in (select  buyer_id from  lib_buyer_party_type where party_type in (1,3,21,90)) group by buy.id,buy.buyer_name order by buyer_name","id,buyer_name", 1, "-- Select Buyer --", $selected, "" );
		exit();
	}
}

if ($action=="load_drop_down_agent"){
	echo create_drop_down( "cbo_agent", 120, "select a.id,a.buyer_name from lib_buyer a, lib_buyer_tag_company b where a.status_active =1 and a.is_deleted=0 and b.buyer_id=a.id and b.tag_company='$data' and a.id in (select buyer_id from lib_buyer_party_type where party_type in (20,21)) order by buyer_name","id,buyer_name", 1, "-- Select Agent --", $selected, "" );
	exit();
}

if ($action=="load_drop_down_po"){
	echo create_drop_down( "txt_po_breack_down_id", 120, "select id,po_number from  wo_po_break_down   where job_no_mst='$data' and status_active =1 and is_deleted=0 ","id,po_number", 1, "-- Select po --", $selected, "" );
	exit();
}

if ($action=="cm_cost_predefined_method")
{
	$cm_cost_method=0; $cm_cost_editable=0; $compulsory =0;
	$cm_cost_sql=sql_select("select cm_cost_method, editable, cm_cost_compulsory from variable_order_tracking where company_name=$data and variable_list=22 and status_active=1 and is_deleted=0");
	//echo "select cm_cost_method, editable, cm_cost_compulsory from variable_order_tracking where company_name=$data and variable_list=22 and status_active=1 and is_deleted=0";
	if($cm_cost_sql[0][csf('cm_cost_method')]=="") $cm_cost_method=0; else $cm_cost_method=$cm_cost_sql[0][csf('cm_cost_method')];
	if($cm_cost_sql[0][csf('editable')]=="") $cm_cost_editable=0; else $cm_cost_editable=$cm_cost_sql[0][csf('editable')];
	if($cm_cost_sql[0][csf('cm_cost_compulsory')]=="") $compulsory=0; else $compulsory=$cm_cost_sql[0][csf('cm_cost_compulsory')];
	echo $cm_cost_method.'___'.$cm_cost_editable.'___'.$compulsory;
	exit();
}

function lib_variable_data($data)
{
	$copy_quotation=$cm_cost_method=$cm_cost_editable=$compulsory=$is_manual_app=$currier_cost_per_percent=$budget_exceeds_quot=$cost_control_source=$trim_rate_source=$efficiency_source=$commercial_compulsory=0;
	//$cm_cost_method=return_field_value("cm_cost_method", "variable_order_tracking", "company_name=$data  and variable_list=22 and status_active=1 and is_deleted=0");
	$cm_cost_sql=sql_select("select variable_list, copy_quotation, commercial_cost_percent, cm_cost_method, editable, budget_exceeds_quot, cm_cost_compulsory, cost_control_source, pre_cost_approval,trim_rate, efficiency_source_for_pre_cost,excut_source from variable_order_tracking where company_name=$data  and variable_list in (20,22,37,41,53,54,57,35,27) and status_active=1 and is_deleted=0");
	foreach($cm_cost_sql as $row)
	{
		if($row[csf('variable_list')]==20)
		{
			if($row[csf('copy_quotation')]=="") $copy_quotation=0; else $copy_quotation=$row[csf('copy_quotation')];
		}
		else if($row[csf('variable_list')]==22)
		{
			if($row[csf('cm_cost_method')]=="") $cm_cost_method=0; else $cm_cost_method=$row[csf('cm_cost_method')];
			if($row[csf('editable')]=="") $cm_cost_editable=0; else $cm_cost_editable=$row[csf('editable')];
			if($row[csf('cm_cost_compulsory')]=="") $compulsory=0; else $compulsory=$row[csf('cm_cost_compulsory')];
		}
		else if($row[csf('variable_list')]==37)
		{
			if($row[csf('budget_exceeds_quot')]=="") $budget_exceeds_quot=0; else $budget_exceeds_quot=$row[csf('budget_exceeds_quot')];
		}
		else if($row[csf('variable_list')]==41)
		{
			if($row[csf('pre_cost_approval')]=="") $is_manual_app=0; else $is_manual_app=$row[csf('pre_cost_approval')];
		}
		else if($row[csf('variable_list')]==53)
		{
			if($row[csf('cost_control_source')]=="") $cost_control_source=0; else $cost_control_source=$row[csf('cost_control_source')];
		}
		else if($row[csf('variable_list')]==54)
		{
			if($row[csf('efficiency_source_for_pre_cost')]=="") $efficiency_source=0; else $efficiency_source=$row[csf('efficiency_source_for_pre_cost')];
		}
		else if($row[csf('variable_list')]==57)
		{
			if($row[csf('cm_cost_compulsory')]=="") $currier_cost_per_percent=0; else $currier_cost_per_percent=$row[csf('commercial_cost_percent')];
		}
		else if($row[csf('variable_list')]==27)
		{
			if($row[csf('excut_source')]=="") $commercial_compulsory=0; else $commercial_compulsory=$row[csf('excut_source')];
		}
		else if($row[csf('variable_list')]==35)
		{
			if($row[csf('trim_rate')]=="") $trim_rate_source=0; else $trim_rate_source=$row[csf('trim_rate')];
		}
	}
	return $cm_cost_method.'___'.$cm_cost_editable.'___'.$compulsory.'___'.$currier_cost_per_percent.'___'.$is_manual_app.'___'.$copy_quotation.'___'.$budget_exceeds_quot.'___'.$cost_control_source.'___'.$trim_rate_source.'___'.$efficiency_source.'___'.$commercial_compulsory;
	exit();
}

if($action=="check_conversion_rate")
{
	$data=explode("**",$data);
	if($db_type==0) $conversion_date=change_date_format($data[1], "Y-m-d", "-",1);
	else $conversion_date=change_date_format($data[1], "d-M-y", "-",1);

	$currency_rate=set_conversion_rate( $data[0], $conversion_date );
	echo "1"."_".$currency_rate;
	exit();
}

function buyer_profit_deffd_lc_per($buyer){
	$sql=sql_select("select deffd_lc_cost_percent, min_budgeted_profit_parcent from lib_buyer where id='$buyer'");
	$deffd_lc_cost_percent=$sql[0][csf('deffd_lc_cost_percent')];
	$buyer_profit_percent=$sql[0][csf('min_budgeted_profit_parcent')];
	return $deffd_lc_cost_percent.'_'.$buyer_profit_percent;
}

function get_job_data($company,$job){
	$data_array=sql_select("select a.order_repeat_no, a.total_set_qnty, sum(c.order_quantity) as order_quantity, sum(c.plan_cut_qnty) as plan_cut_qnty  from wo_po_details_master a,wo_po_break_down b, wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and  a.job_no='$job' and a.company_name=$company  and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 group by a.order_repeat_no,a.total_set_qnty");
	$job_data=array();
	foreach($data_array as $row){
		$order_repeat_no=$row[csf('order_repeat_no')];
		$total_set_qnty=$row[csf('total_set_qnty')];
		$order_quantity=$row[csf('order_quantity')];
		$plan_cut_qnty=$row[csf('plan_cut_qnty')];

		$order_quantity_set=$order_quantity/$total_set_qnty;
		$plan_cut_qnty_set=$plan_cut_qnty/$total_set_qnty;

		$job_data['order_quantity_set']=$order_quantity_set;
		$job_data['plan_cut_qnty_set']=$plan_cut_qnty_set;
		$job_data['order_quantity']=$order_quantity;
		$job_data['plan_cut_qnty']=$plan_cut_qnty;
		$job_data['order_repeat_no']=$order_repeat_no;
	}
	unset($data_array);
	return $job_data;
}

function get_efficiency_percent($company,$job,$smv){
	$efficiency_source=return_field_value("efficiency_source_for_pre_cost", "variable_order_tracking", "company_name=$company and variable_list=54 and status_active=1 and is_deleted=0");
	if($efficiency_source== "" || $efficiency_source==0){
		$efficiency_source=1;
	}
	$job_data=get_job_data($company,$job);

	if($efficiency_source==1) $efficiency_percent=0;
	if($efficiency_source==2) $efficiency_percent=get_efficiency_percent_from_work_study($company,$job);
	if($efficiency_source==3) $efficiency_percent=get_efficiency_percent_from_slab($company,$job_data['order_repeat_no'],$job_data['order_quantity_set'],$smv);
	return array("efficiency_source"=>$efficiency_source,"efficiency_percent"=>$efficiency_percent);
	exit();
}

function get_efficiency_percent_from_slab($company,$order_repeat_no,$order_quantity,$smv){
	$efficiency_percent=0;
	$sql=sql_select("select efficiency_new_order, efficiency_repeat_order from efficiency_percentage_slab where ($smv between smv_lower_limit and  smv_upper_limit) and ($order_quantity between order_qty_lower_limit and order_qty_upper_limit) and company_id=$company and status_active=1 and is_deleted=0");
	foreach($sql as $row){
		if($order_repeat_no) $efficiency_percent=$row[csf('efficiency_repeat_order')];
		else $efficiency_percent=$row[csf('efficiency_new_order')];
	}
	return $efficiency_percent;
	exit();
}

function get_efficiency_percent_from_work_study($company,$jobno){
	$sqlwsid=sql_select("select ws_id from wo_po_details_mas_set_details where job_no='$jobno'");
	$wsidstr="";
	foreach($sqlwsid as $jrow){
		if($jrow[csf('ws_id')]=="") $jrow[csf('ws_id')]=0;
		if($jrow[csf('ws_id')]!=0)
		{
			if($wsidstr=="") $wsidstr=$jrow[csf('ws_id')]; else $wsidstr.=','.$jrow[csf('ws_id')];
		}
	}
	unset($sqlwsid);
	
	$eff_percentws=0;
	if($wsidstr!="")
	{
		$sql=sql_select("select id, efficiency from ppl_balancing_mst_entry where gsd_mst_id in ($wsidstr) and status_active=1 and is_deleted=0");
		$countwseff=count($sql); $efficiency_percent=0;
		foreach($sql as $row){
			$efficiency_percent+=$row[csf('efficiency')];
		}
		if($countwseff==1) $eff_percentws=$efficiency_percent; else if($countwseff>1) $eff_percentws=fn_number_format($efficiency_percent/$countwseff,2); else $eff_percentws=0;
	}
	
	return $eff_percentws;
	exit();
}

if($action=="get_efficiency_percent"){
	$data=explode("**",$data);
	$efficiency_data=get_efficiency_percent($data[0],$data[1],$data[2]);
	echo "set_efficiency_percent('".json_encode($efficiency_data)."')\n";
}

if($action=="is_manula_approved")
{
    $is_manula_approved=0;
	$sql_data=sql_select("select pre_cost_approval from variable_order_tracking where company_name='$data' and variable_list=41 and status_active=1 and is_deleted=0");
	foreach($sql_data as $sql_row)
	{
		$is_manula_approved=$sql_row[csf('pre_cost_approval')];
	}
	echo $is_manula_approved;
	exit();
}

if ($action=="cost_per_minute")
{
	$data=explode("_",$data);
	$cm_cost_method_based_on=return_field_value("cm_cost_method_based_on", "variable_order_tracking", "company_name=$data[0]  and variable_list=22 and status_active=1 and is_deleted=0");
	
	if($cm_cost_method_based_on=="" || $cm_cost_method_based_on==0) $cm_cost_method_based_on=1;
	$txt_costing_date="";
	//echo $cm_cost_method_based_on.'==';die;
	if($cm_cost_method_based_on==1){
		if($data[1]=="" || $data[1]==0)
		{
			if($db_type==0) $txt_costing_date=change_date_format(date('d-m-Y'), "yyyy-mm-dd", "-");
			if($db_type==2) $txt_costing_date=change_date_format(date('d-m-Y'), "yyyy-mm-dd", "-",1);
		}
		else
		{
			if($db_type==0) $txt_costing_date=change_date_format($data[1], "yyyy-mm-dd", "-");
			if($db_type==2) $txt_costing_date=change_date_format($data[1], "yyyy-mm-dd", "-",1)	;
		}
	}
	else if($cm_cost_method_based_on==2){
		$min_shipment_sql=sql_select("select job_no_mst, min(shipment_date) as min_shipment_date from wo_po_break_down where job_no_mst='$data[2]' and status_active=1 and is_deleted=0 group by job_no_mst");
		$min_shipment_date="";
		foreach($min_shipment_sql as $row){
			$min_shipment_date=$row[csf('min_shipment_date')];
		}

		if($db_type==0) $txt_costing_date=change_date_format($min_shipment_date, "yyyy-mm-dd", "-");
		if($db_type==2) $txt_costing_date=change_date_format($min_shipment_date, "yyyy-mm-dd", "-",1)	;
	}
	else if($cm_cost_method_based_on==3){
		$max_shipment_sql=sql_select("select job_no_mst, max(shipment_date) as max_shipment_date from wo_po_break_down where job_no_mst='$data[2]' and status_active=1 and is_deleted=0 group by job_no_mst");
		$max_shipment_date="";
		foreach($max_shipment_sql as $row){
			$max_shipment_date=$row[csf('max_shipment_date')];
		}

		if($db_type==0) $txt_costing_date=change_date_format($max_shipment_date, "yyyy-mm-dd", "-");
		if($db_type==2) $txt_costing_date=change_date_format($max_shipment_date, "yyyy-mm-dd", "-",1)	;
	}
	else if($cm_cost_method_based_on==4){

		$max_shipment_sql=sql_select("select job_no_mst, min(pub_shipment_date) as min_pub_shipment_date from wo_po_break_down where job_no_mst='$data[2]' and status_active=1 and is_deleted=0 group by job_no_mst");
		$min_pub_shipment_date="";
		foreach($max_shipment_sql as $row){
			$min_pub_shipment_date=$row[csf('min_pub_shipment_date')];
		}

		if($db_type==0) $txt_costing_date=change_date_format($min_pub_shipment_date, "yyyy-mm-dd", "-");
		if($db_type==2) $txt_costing_date=change_date_format($min_pub_shipment_date, "yyyy-mm-dd", "-",1)	;
	}
	else if($cm_cost_method_based_on==4){
		$max_shipment_sql=sql_select("select job_no_mst, max(pub_shipment_date) as max_pub_shipment_date from wo_po_break_down where job_no_mst='$data[2]' and status_active=1 and is_deleted=0 group by job_no_mst");
		$max_pub_shipment_date="";
		foreach($max_shipment_sql as $row){
			$max_pub_shipment_date=$row[csf('max_pub_shipment_date')];
		}

		if($db_type==0)  $txt_costing_date=change_date_format($max_pub_shipment_date, "yyyy-mm-dd", "-");
		if($db_type==2) $txt_costing_date=change_date_format($max_pub_shipment_date, "yyyy-mm-dd", "-",1)	;
	}
	/*if($db_type==0)
		{
		   $txt_costing_date=change_date_format($data[1], "yyyy-mm-dd", "-");
		}
		if($db_type==2)
		{
			$txt_costing_date=change_date_format($data[1], "yyyy-mm-dd", "-",1)	;
		}*/

	$monthly_cm_expense=0; $no_factory_machine=0; $working_hour=0; $cost_per_minute=0; $depreciation_amorti=0; $operating_expn=0; $interest_expense=0; $income_tax=0;

	if($db_type==0)
	{
		$sql="select monthly_cm_expense, no_factory_machine, working_hour, cost_per_minute, depreciation_amorti, operating_expn, interest_expense, income_tax from lib_standard_cm_entry where company_id=$data[0] and '$txt_costing_date' between applying_period_date and applying_period_to_date  and status_active=1 and is_deleted=0 LIMIT 1";
	}
	else if($db_type==2)
	{
		$sql="select monthly_cm_expense, no_factory_machine, working_hour, cost_per_minute, depreciation_amorti, operating_expn, interest_expense, income_tax from lib_standard_cm_entry where company_id=$data[0] and '$txt_costing_date' between applying_period_date and applying_period_to_date and status_active=1 and is_deleted=0";
	}
	//echo $sql;die;
	$data_array=sql_select($sql);
	foreach ($data_array as $row)
	{
		if($row[csf("monthly_cm_expense")] !="") $monthly_cm_expense=$row[csf("monthly_cm_expense")];
		if($row[csf("no_factory_machine")] !="") $no_factory_machine=$row[csf("no_factory_machine")];
		if($row[csf("working_hour")] !="") $working_hour=$row[csf("working_hour")];
		if($row[csf("cost_per_minute")] !="") $cost_per_minute=$row[csf("cost_per_minute")];
		if($row[csf("depreciation_amorti")] !="") $depreciation_amorti=$row[csf("depreciation_amorti")];
		if($row[csf("operating_expn")] !="") $operating_expn=$row[csf("operating_expn")];
		if($row[csf("interest_expense")] !="") $interest_expense=$row[csf("interest_expense")];
		if($row[csf("income_tax")] !="") $income_tax=$row[csf("income_tax")];
	}
	$data=$monthly_cm_expense."_".$no_factory_machine."_".$working_hour."_".$cost_per_minute."_".$depreciation_amorti."_".$operating_expn."_".$interest_expense."_".$income_tax;
	echo $data;
	exit();
}

if ($action=="load_drop_down_buyer_brand"){
	if($data!= 0)
	{
		echo create_drop_down( "cbo_buyer_name", 130, "SELECT buy.id,buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='$data' $buyer_cond and buy.id in (select buyer_id from lib_buyer_party_type where party_type in (1,3,21,90)) group by buy.id,buy.buyer_name order by buyer_name","id,buyer_name", 1, "-- Select Buyer --", $selected, "load_drop_down( 'pre_cost_entry_controller_v2', this.value, 'load_drop_down_brand', 'brand_td');load_drop_down( 'pre_cost_entry_controller_v2', this.value+'*'+1, 'load_drop_down_season', 'season_td')" );
		exit();
	}
	else{
		echo create_drop_down( "cbo_buyer_name", 130, "SELECT buy.id as id ,buy.buyer_name as buyer_name  from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id $buyer_cond and buy.id in (select  buyer_id from  lib_buyer_party_type where party_type in (1,3,21,90)) group by buy.id,buy.buyer_name order by buyer_name","id,buyer_name", 1, "-- Select Buyer --", $selected, "load_drop_down( 'pre_cost_entry_controller_v2', this.value, 'load_drop_down_brand', 'brand_td');load_drop_down( 'pre_cost_entry_controller_v2', this.value+'*'+1, 'load_drop_down_season', 'season_td')" );
		exit();
	}
}

if ($action=="load_drop_down_brand") 
{
	$data_arr = explode("*", $data);
	if($data_arr[1] == 1) $width=80; else $width=80;
	if(($data_arr[0]*1)>0)
	{
		echo create_drop_down( "cbo_brand_id", $width, "select id, brand_name from lib_buyer_brand brand where buyer_id='$data_arr[0]' and status_active =1 and is_deleted=0 $brand_cond order by brand_name ASC","id,brand_name", 1, "--Brand--", $selected, "" );
	}
	else
	{
		echo create_drop_down( "cbo_brand_id", $width, $blank_array,'', 1, "--Brand--",$selected, "" );
	}
	exit();
}
if ($action=="load_drop_down_season")
{
	$data_arr = explode("*", $data);
	if($data_arr[1] == 1) $width=80; else $width=80;
	if(($data_arr[0]*1)>0)
	{
		echo create_drop_down( "cbo_season_id", $width, "select id, season_name from lib_buyer_season where buyer_id='$data_arr[0]' and status_active =1 and is_deleted=0 order by season_name ASC","id,season_name", 1, "-- Select Season--", "", "" );
	}
	else
	{
		echo create_drop_down( "cbo_season_id", 80, $blank_array,'', 1, "--Season--",$selected, "" );
	}
	exit();
}


if ($action=="order_popup")
{
  	echo load_html_head_contents("Popup Info","../../../", 1, 1, $unicode);
	extract($_REQUEST);
//	echo $company_id;
	$buyer_sql=sql_select("SELECT buy.id as id ,buy.buyer_name as buyer_name  from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id  and b.tag_company in($company_id) $buyer_cond and buy.id in (select  buyer_id from  lib_buyer_party_type where party_type in (1,3,21,90)) group by buy.id,buy.buyer_name order by buyer_name");
	 
	$buyer_arr=array();
	foreach($buyer_sql as $keys=>$vals)
	{
		$buyer_arrs[$vals[csf("id")]]=$vals[csf("buyer_name")];
	}
	unset($buyer_sql);
	asort($buyer_arrs);
	?>
    <head>
	<script>
		var cbo_buyer_name='<? echo $cbo_buyer_name; ?>';
		function set_checkvalue()
		{
			if(document.getElementById('chk_job_wo_po').value==0) document.getElementById('chk_job_wo_po').value=1;
			else document.getElementById('chk_job_wo_po').value=0;
		}

		function js_set_value( job_no )
		{
			document.getElementById('selected_job').value=job_no;
			parent.emailwindow.hide();
		}
		
		function fnc_brandload()
		{
			var buyer=$('#cbo_buyer_name').val();
			if(buyer!=0)
			{
				load_drop_down( 'pre_cost_entry_controller_v2', buyer, 'load_drop_down_brand', 'brand_td');
			}
		}
    </script>
    </head>
    <body onLoad="fnc_brandload();" >
    <div align="center" style="width:100%;" >
    <form name="searchorderfrm_1"  id="searchorderfrm_1" autocomplete="off">
        <table width="1100" cellspacing="0" cellpadding="0" border="1" class="rpt_table" align="center" rules="all">
            <thead>
                <tr>
                    <th colspan="13"><?=create_drop_down( "cbo_string_search_type", 130, $string_search_type,'', 1, "--Searching Type--"); ?></th>
                </tr>
                <tr>
                    <th width="120" class="must_entry_caption">Company Name</th>
                    <th width="130" class="must_entry_caption">Buyer Name</th>
                    <th width="80">Brand</th>
                    <th width="80">Season</th>
                    <th width="60">Season Year</th>
                    <th width="80">Job No</th>
                    <th width="90">Style Ref</th>
                    <th width="80">M.Style/Int. Ref</th>
                    <th width="80">File No</th>
                    <th width="80">Order No</th>
                    <th width="130" colspan="2">Ship. Date Range</th>
                    <th><input type="hidden" id="selected_job">&nbsp;</th>
                </tr>
            </thead>
            <tr class="general">
                <td><?=create_drop_down( "cbo_company_mst", 120, "select id,company_name from lib_company comp where status_active =1 and is_deleted=0 and core_business not in(3) $company_cond order by company_name","id,company_name",1, "-- Select Company --", $company_id,"load_drop_down( 'pre_cost_entry_controller_v2', this.value, 'load_drop_down_buyer_brand', 'buyer_td' );"); ?></td>
                <td id="buyer_td"><?=create_drop_down( "cbo_buyer_name", 130, $buyer_arrs,'', 1, "-- Select Buyer --",$cbo_buyer_name,"load_drop_down( 'pre_cost_entry_controller_v2', this.value, 'load_drop_down_brand', 'brand_td'); load_drop_down( 'pre_cost_entry_controller_v2', this.value+'*'+1, 'load_drop_down_season', 'season_td')" ); ?></td>
                <td id="brand_td"><?=create_drop_down( "cbo_brand_id", 80, $blank_array,'', 1, "--Brand--",$selected, "" ); ?></td>
                <td id="season_td"><?=create_drop_down( "cbo_season_id", 80, $blank_array,'', 1, "--Season--",$selected, "" ); ?></td>
                <td><?=create_drop_down( "cbo_season_year", 60, create_year_array(),"", 1,"-Year-", 1, "",0,"" ); ?></td>
               
                <td><input name="txt_job_prifix" id="txt_job_prifix" class="text_boxes" style="width:70px"></td>
                <td><input name="txt_style" id="txt_style" class="text_boxes" style="width:80px"></td>
                <td><input name="txt_internal_ref" id="txt_internal_ref" class="text_boxes" style="width:70px"></td>
                <td><input name="txt_file_no" id="txt_file_no" class="text_boxes" style="width:70px"></td>
                <td><input name="txt_order_search" id="txt_order_search" class="text_boxes" style="width:70px"></td>
                <td><input name="txt_date_from" id="txt_date_from" class="datepicker" style="width:50px"></td>
                <td><input name="txt_date_to" id="txt_date_to" class="datepicker" style="width:50px"></td>
                <td align="center">
                    <input type="button" name="button2" class="formbutton" value="Show" onClick="show_list_view ( document.getElementById('cbo_company_mst').value+'_'+document.getElementById('cbo_buyer_name').value+'_'+document.getElementById('txt_date_from').value+'_'+document.getElementById('txt_date_to').value+'_'+document.getElementById('txt_job_prifix').value+'_'+document.getElementById('cbo_year_selection').value+'_'+document.getElementById('txt_order_search').value+'_'+document.getElementById('txt_style').value+'_'+document.getElementById('cbo_string_search_type').value+'_'+document.getElementById('txt_internal_ref').value+'_'+document.getElementById('txt_file_no').value+'_'+document.getElementById('cbo_brand_id').value+'_'+document.getElementById('cbo_season_id').value+'_'+document.getElementById('cbo_season_year').value, 'create_po_search_list_view', 'search_div', 'pre_cost_entry_controller_v2', 'setFilterGrid(\'list_view\',-1)')" style="width:70px;" /></td>
            </tr>
            <tr>
                <td align="center" valign="middle" colspan="13">
                    <?=load_month_buttons(1); ?>
                </td>
            </tr>
     </table>
    <div id="search_div"></div>
    </form>
    </div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
    exit();
}

if($action=="create_po_search_list_view")
{
	$data=explode('_',$data);
	if($data[0]==0 && $data[1]==0)
	{
		echo "<span style='font-weight:bold; text-align:center; color:red; font-size:24px'>Please Select Company or Buyer First.</span>"; die;
	}
	if ($data[0]!=0) $company=" and a.company_name='$data[0]'"; /*else { echo "Please Select Company First."; die; }*/
	if ($data[1]!=0){ $buyer=" and a.buyer_name='$data[1]'"; }
	else
	{
		$buyer=""; $bu_arr=array();
		$pri_buyer=sql_select("select buy.id,buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='$data[0]' $buyer_cond and buy.id in (select buyer_id from lib_buyer_party_type where party_type in (1,3,21,90)) order by buyer_name");
		foreach($pri_buyer as $pri_buyer_row)
		{
			$bu_arr[$pri_buyer_row[csf('id')]]=$pri_buyer_row[csf('id')];
		}
		$bu_arr_str=implode(",",$bu_arr);
		$buyer=" and a.buyer_name in ($bu_arr_str)";
	}
	$job_cond=""; $order_cond=""; $style_cond="";
	$data[4]=trim($data[4]); 
	if($data[8]==1)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num='$data[4]'  $year_cond"; //else  $job_cond="";
		if (str_replace("'","",$data[6])!="") $order_cond=" and b.po_number = '$data[6]'  "; //else  $order_cond="";
		if (trim($data[7])!="") $style_cond=" and a.style_ref_no ='$data[7]'"; //else  $style_cond="";
	}
	else if($data[8]==2)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num like '$data[4]%'  $year_cond"; //else  $job_cond="";
		if (str_replace("'","",$data[6])!="") $order_cond=" and b.po_number like '$data[6]%'  "; //else  $order_cond="";
		if (trim($data[7])!="") $style_cond=" and a.style_ref_no like '$data[7]%'  "; //else  $style_cond="";
	}
	else if($data[8]==3)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num like '%$data[4]'  $year_cond"; //else  $job_cond="";
		if (str_replace("'","",$data[6])!="") $order_cond=" and b.po_number like '%$data[6]'  "; //else  $order_cond="";
		if (trim($data[7])!="") $style_cond=" and a.style_ref_no like '%$data[7]'"; //else  $style_cond="";
	}
	else if($data[8]==4 || $data[8]==0)
	{
		$data[4]=trim($data[4]); 
		//echo $data[4].'fs';
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num like '%$data[4]%'  $year_cond"; //else  $job_cond="";
		if (str_replace("'","",$data[6])!="") $order_cond=" and b.po_number like '%$data[6]%'  "; //else  $order_cond="";
		if (trim($data[7])!="") $style_cond=" and a.style_ref_no like '%$data[7]%'"; //else  $style_cond="";
	}

	$internal_ref = str_replace("'","",$data[9]);
	$file_no = str_replace("'","",$data[10]);
	
	$brand_id = str_replace("'","",$data[11]);
	$season_id = str_replace("'","",$data[12]);
	$season_year = str_replace("'","",$data[13]);
	if ($brand_id==0) $brandCond=""; else $brandCond=" and a.brand_id in($brand_id) ";
	if ($season_id==0) $seasonCond=""; else $seasonCond=" and a.season_buyer_wise in($season_id) ";
	if ($season_year==0) $seasonYearCond=""; else $seasonYearCond=" and a.season_year in($season_year) ";
	if ($file_no=="") $file_no_cond=""; else $file_no_cond=" and b.file_no='".trim($file_no)."' ";
	if ($internal_ref=="") $internal_ref_cond=""; else $internal_ref_cond=" and b.grouping='".trim($internal_ref)."' ";

	if($db_type==0)
	{
		if ($data[2]!="" &&  $data[3]!="") $shipment_date = "and b.pub_shipment_date between '".change_date_format($data[2], "yyyy-mm-dd", "-")."' and '".change_date_format($data[3], "yyyy-mm-dd", "-")."'"; else $shipment_date ="";
		$year_cond=" and SUBSTRING_INDEX(a.insert_date, '-', 1)=$data[5]";
		$insert_year="YEAR(a.insert_date)";
	}
	else if($db_type==2)
	{
		if ($data[2]!="" &&  $data[3]!="") $shipment_date = "and b.pub_shipment_date between '".change_date_format($data[2], "yyyy-mm-dd", "-",1)."' and '".change_date_format($data[3], "yyyy-mm-dd", "-",1)."'"; else $shipment_date ="";
		$year_cond=" and to_char(a.insert_date,'YYYY')=$data[5]";
		$insert_year="to_char(a.insert_date,'YYYY')";
	}

	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$brand_arr=return_library_array( "select id, brand_name from lib_buyer_brand",'id','brand_name');
	$season_arr=return_library_array( "select id, season_name from lib_buyer_season",'id','season_name');
	$comp=return_library_array( "select id, company_short_name from lib_company",'id','company_short_name');
	$preCostApprovStatus = array('' =>'No',0 =>'No',1=>'Yes',2=>'No',3=>'Yes');
	//$arr=array (2=>$comp,3=>$buyer_arr,4=>$brand_arr,5=>$season_arr,15=>$pre_Cost_approv_status);

	$sql= "select $insert_year as year, a.job_no_prefix_num, a.season_buyer_wise as season, a.brand_id, a.company_name, a.buyer_name, a.style_ref_no, a.body_wash_color, a.quotation_id, a.job_quantity, b.po_number, b.grouping, b.file_no, b.po_quantity, b.plan_cut, b.shipment_date, a.job_no, c.id as pre_id, c.approved from wo_po_details_master a, wo_po_break_down b left join wo_pre_cost_mst c on b.job_no_mst=c.job_no and c.status_active=1 and c.is_deleted=0 where a.garments_nature=3 and a.job_no=b.job_no_mst and a.status_active=1 and b.status_active=1 $shipment_date $company $buyer $job_cond $style_cond $order_cond $file_no_cond $internal_ref_cond $brandCond $seasonCond $seasonYearCond $year_cond order by a.id DESC";
	$result=sql_select($sql);
	?> 
 	<div align="left" style=" margin-left:5px;margin-top:10px"> 
    	<table cellspacing="0" cellpadding="0" border="1" rules="all" width="1220" align="left" class="rpt_table" >
 			<thead>
 				<th width="30">SL</th>
 				<th width="40">Year</th>
 				<th width="45">Job No</th>               
 				<th width="50">Company</th>
 				<th width="100">Buyer</th>
                <th width="50">Brand</th>
                <th width="50">Season</th>
                <th width="100">Style Ref.</th>
                <th width="70">Body/Wash Color</th>
                <th width="50">Quot. ID</th>
 				<th width="90">M.Style/Internal Ref.</th>
 				<th width="70">File No</th>               
 				<th width="70">Job Qty.</th>
 				<th width="90">PO NO</th>
                <th width="70">PO Qty.</th>
                <th width="70">Plan Cut Qty.</th>
 				<th width="55">Ship. Date</th>
                <th width="40">App. Sta.</th>
 				<th>BOM ID</th>               
 			</thead>
 		</table>
    	<div style="width:1220px; max-height:300px; overflow-y:scroll">	 
 			<table cellspacing="0" cellpadding="0" border="1" rules="all" width="1200" class="rpt_table" id="list_view">  
 				<?
 				$i=1;
				$color_library=return_library_array("select id,color_name from lib_color where status_active=1 and is_deleted=0","id","color_name");
 				foreach ($result as $row)
 				{  
 					if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF"; 
 					?>
                    <tr bgcolor="<?=$bgcolor; ?>" style="cursor:pointer" onClick="js_set_value('<?=$row[csf('job_no')]; ?>');"> 
                        <td width="30" align="center"><?=$i; ?></td>  
                        <td width="40" align="center"><?=$row[csf('year')]; ?></td>
                        <td width="45" align="center" style="word-break:break-all"><?=$row[csf('job_no_prefix_num')]; ?></td>
                        <td width="50" style="word-break:break-all"><?=$comp[$row[csf('company_name')]]; ?></td>
                        <td width="100" style="word-break:break-all"><?=$buyer_arr[$row[csf('buyer_name')]]; ?></td>
                        <td width="50" style="word-break:break-all"><?=$brand_arr[$row[csf('brand_id')]]; ?></td>
                        <td width="50" style="word-break:break-all"><?=$season_arr[$row[csf('season')]]; ?></td>
                        <td width="100" style="word-break:break-all"><?=$row[csf('style_ref_no')]; ?></td>
                        <td width="70" style="word-break:break-all"><?=$color_library[$row[csf('body_wash_color')]]; ?></td>
                        <td width="50" align="center" style="word-break:break-all"><?=$row[csf('quotation_id')]; ?></td>
                        <td width="90" style="word-break:break-all"><?=$row[csf('grouping')]; ?></td>
                        <td width="70" style="word-break:break-all"><?=$row[csf('file_no')]; ?></td>
                        <td width="70" align="right" style="word-break:break-all"><?=$row[csf('job_quantity')]; ?></td>
                        <td width="90" style="word-break:break-all"><?=$row[csf('po_number')]; ?></td>
                        <td width="70" align="right" style="word-break:break-all"><?=$row[csf('po_quantity')]; ?></td>
                        <td width="70" align="right" style="word-break:break-all"><?=$row[csf('plan_cut')]; ?></td>
                        <td width="55" style="word-break:break-all"><?=change_date_format($row[csf('shipment_date')]); ?></td> 
                        <td width="40" style="word-break:break-all"><?=$preCostApprovStatus[$row[csf('approved')]]; ?></td>
                        <td style="word-break:break-all"><?=$row[csf('pre_id')]; ?></td>
                    </tr> 
                    <? 
                    $i++;
 				}
 				?> 
 			</table>        
 		</div>
 	</div>
    <?php
	exit();
}

function cost_per_minute($data)
{
	global $db_type;
	$data=explode("_",$data);
	if($data[1]=="" || $data[1]==0)
	{
		if($db_type==0) $txt_costing_date=change_date_format(date('d-m-Y'), "yyyy-mm-dd", "-");
		if($db_type==2) $txt_costing_date=change_date_format(date('d-m-Y'), "yyyy-mm-dd", "-",1);
	}
	else
	{
		if($db_type==0) $txt_costing_date=change_date_format($data[1], "yyyy-mm-dd", "-");
		if($db_type==2) $txt_costing_date=change_date_format($data[1], "yyyy-mm-dd", "-",1)	;
	}
	/*if($db_type==0)
		{
		   $txt_costing_date=change_date_format($data[1], "yyyy-mm-dd", "-");
		}
		if($db_type==2)
		{
			$txt_costing_date=change_date_format($data[1], "yyyy-mm-dd", "-",1)	;
		}*/

	$monthly_cm_expense=$no_factory_machine=$working_hour=$cost_per_minute=$depreciation_amorti=$operating_expn=$interest_expense=$income_tax=0;

	if($db_type==0)
	{
		 $sql="select monthly_cm_expense, no_factory_machine, working_hour, cost_per_minute, depreciation_amorti, operating_expn, interest_expense, income_tax from lib_standard_cm_entry where company_id=$data[0] and '$txt_costing_date' between applying_period_date and applying_period_to_date  and status_active=1 and is_deleted=0 LIMIT 1";
	}
	else if($db_type==2)
	{
		 $sql="select monthly_cm_expense, no_factory_machine, working_hour, cost_per_minute, depreciation_amorti, operating_expn, interest_expense, income_tax from lib_standard_cm_entry where company_id=$data[0] and '$txt_costing_date' between applying_period_date and applying_period_to_date and status_active=1 and is_deleted=0";
	}

	$data_array=sql_select($sql);
	foreach ($data_array as $row)
	{
		if($row[csf("monthly_cm_expense")] !="") $monthly_cm_expense=$row[csf("monthly_cm_expense")];
		if($row[csf("no_factory_machine")] !="") $no_factory_machine=$row[csf("no_factory_machine")];
		if($row[csf("working_hour")] !="") $working_hour=$row[csf("working_hour")];
		if($row[csf("cost_per_minute")] !="") $cost_per_minute=$row[csf("cost_per_minute")];
		if($row[csf("depreciation_amorti")] !="") $depreciation_amorti=$row[csf("depreciation_amorti")];
		if($row[csf("operating_expn")] !="") $operating_expn=$row[csf("operating_expn")];
		if($row[csf("interest_expense")] !="") $interest_expense=$row[csf("interest_expense")];
		if($row[csf("income_tax")] !="") $income_tax=$row[csf("income_tax")];
	}
	unset($data_array);
	$data=$monthly_cm_expense."_".$no_factory_machine."_".$working_hour."_".$cost_per_minute."_".$depreciation_amorti."_".$operating_expn."_".$interest_expense."_".$income_tax;
	return  $data;
	exit();
}

if ($action=="populate_data_from_job_table")
{
	$entry_from=0;
	$data_entry_from=sql_select("select entry_from from wo_pre_cost_mst where job_no='$data' and is_deleted=0 and status_active=1");
	if (count($data_entry_from)>0)
	{
		foreach ($data_entry_from as $row)
		{
			$entry_from=$row[csf('entry_from')];
			//txt_sew_efficiency_per
		}
	}
	if($entry_from==111){
		echo "alert('This Job is in Pre-cost V1');\n";
	}
	else
	{
		$company_name=""; $copy_quotation_id=""; $quotation_id=''; $avg_unit_price=''; $price_costing_per='';

		if($db_type==2) $group_concat_all=" listagg(cast(b.grouping as varchar2(4000)),',') within group (order by b.grouping) as grouping, listagg(cast(b.file_no as varchar2(4000)),',') within group (order by b.file_no) as file_no ";
		else { $group_concat_all="group_concat(b.grouping) as grouping, group_concat(b.file_no) as file_no";}

		$job_data_arr=array();
		$data_array = sql_select("select a.job_no,$group_concat_all from wo_po_details_master a, wo_po_break_down b where a.job_no='$data' and a.job_no=b.job_no_mst group by a.job_no");
		foreach($data_array as $row)
		{
			$job_data_arr[$row[csf('job_no')]]['file']=$row[csf('file_no')];
			$job_data_arr[$row[csf('job_no')]]['ref']=$row[csf('grouping')];
		}

		unset($data_array);

		$component_approved_lab=$component_approved_ins=$component_approved_friegt=$component_approved_currier=$component_approved_certificate=$component_approved_others=0;
		//calculate_cm_cost_with_method
		foreach($sql as $row){
			if($row[csf('cost_component_id')]==7 && $row[csf('approved')]==1) $component_approved_lab=1;
			else if($row[csf('cost_component_id')]==8 && $row[csf('approved')]==1) $component_approved_ins=1;
			else if($row[csf('cost_component_id')]==9 && $row[csf('approved')]==1) $component_approved_friegt=1;
			else if($row[csf('cost_component_id')]==10 && $row[csf('approved')]==1) $component_approved_currier =1;
			else if($row[csf('cost_component_id')]==11 && $row[csf('approved')]==1) $component_approved_certificate =1;
			else if($row[csf('cost_component_id')]==12 && $row[csf('approved')]==1) $component_approved_others=1;
		}

		$season_buyer_wise=return_library_array( "select id,season_name from lib_buyer_season",'id','season_name');

		$brand_name_arr=return_library_array( "select id, brand_name from  lib_buyer_brand where status_active=1 and is_deleted=0",'id','brand_name');
		$color_library=return_library_array("select id,color_name from lib_color where status_active=1 and is_deleted=0","id","color_name");
		$data_array=sql_select("select a.id, a.garments_nature, a.job_no, a.job_no_prefix, a.job_no_prefix_num, a.copy_from, a.company_name, a.buyer_name, a.location_name, a.style_ref_no, a.style_description, a.product_dept, a.product_code, a.currency_id, a.agent_name, a.order_repeat_no, a.region, a.team_leader, a.dealing_marchant, a.packing,a.remarks, a.job_quantity, a.avg_unit_price, a.ship_mode, a.order_uom, a.set_break_down, a.gmts_item_id, a.total_set_qnty, a.set_smv, a.quotation_id, a.body_wash_color, b.refusing_cause, b.id as precost_id, b.costing_per, season_buyer_wise, brand_id, season_year from wo_po_details_master a left join wo_pre_cost_mst b on a.job_no = b.job_no where a.job_no='$data' and a.is_deleted=0 and a.status_active=1");
		$qc_no=0;
		foreach ($data_array as $row)
		{
			$print_report_format=return_field_value("format_id","lib_report_template","template_name ='".$row[csf("company_name")]."' and module_id=2 and report_id=122 and is_deleted=0 and status_active=1");

			$refusing_cause=return_field_value("refusing_reason","refusing_cause_history","mst_id ='".$row[csf("precost_id")]."'");

			$season_brand = $season_buyer_wise[$row[csf('season_buyer_wise')]].'-'.substr( $row[csf('season_year')], -2).','.$brand_name_arr[$row[csf('brand_id')]];
			echo "print_report_button_setting('$print_report_format');\n";

			echo "reset_form('quotationdtls_2','','');\n";

			$cbo_buyer_name= create_drop_down( "cbo_buyer_name", 120, "select buy.id,buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='".$row[csf("company_name")]."' $buyer_cond and buy.id in (select buyer_id from lib_buyer_party_type where party_type in (1,3,21,90)) order by buyer_name","id,buyer_name", 1, "-- Select Buyer --", $selected, "" );
			$cbo_agent= create_drop_down( "cbo_agent", 120, "select a.id,a.buyer_name from lib_buyer a, lib_buyer_tag_company b where a.status_active =1 and a.is_deleted=0 and b.buyer_id=a.id and b.tag_company='".$row[csf("company_name")]."' and a.id in (select buyer_id from lib_buyer_party_type where party_type in (20,21)) order by buyer_name","id,buyer_name", 1, "-- Select Agent --", $selected, "" );
			$txt_po_breack_down_id= create_drop_down( "txt_po_breack_down_id", 120, "select id,po_number from  wo_po_break_down   where job_no_mst='".$row[csf("job_no")]."' and status_active =1 and is_deleted=0 ","id,po_number", 0, "-- Select po --", $selected, "" );
			//$cost_sheet_no=$row[csf("quotation_id")];//return_field_value("qc_no", "wo_po_details_master a, qc_mst b", "job_no='".$row[csf("job_no")]."' and a.inquiry_id=b.inquery_id and b.is_deleted=0 and b.status_active=1");
			$qc_no=$row[csf("quotation_id")];

			$company_id=$row[csf("company_name")];
			$cost_per_minute=cost_per_minute($row[csf("company_name")]."_".date("d-m-Y"));
			
			$buyer_profit_deffd_lc_per=buyer_profit_deffd_lc_per($row[csf("buyer_name")]);
			$exbuyer_profit_deffd_lc_per=explode("_",$buyer_profit_deffd_lc_per);
			$deffd_lc_per=$exbuyer_profit_deffd_lc_per[0];
			$buyer_profit_per=$exbuyer_profit_deffd_lc_per[1];
			
			$cm_cost_predefined_method=$cm_cost_editable=$currier_cost_per=$is_manula_approved=$copy_quotation_id=$budget_exceeds_quot_id=$cost_control_source_id=$commercial_compulsory=0;
			$lib_variable_data=lib_variable_data($row[csf("company_name")]);
			$cm_cost_predefined_data=explode("___",$lib_variable_data);
			
			$cm_cost_predefined_method=$cm_cost_predefined_data[0];
			$cm_cost_editable=$cm_cost_predefined_data[1];
			$currier_cost_per=$cm_cost_predefined_data[3];
			
			$currier_cm_cost_data=$cm_cost_predefined_method.'___'.$cm_cost_editable.'___'.$cm_cost_predefined_data[2].'___'.$cm_cost_predefined_data[9];
			
			$is_manula_approved=$cm_cost_predefined_data[4];
			$copy_quotation_id=$cm_cost_predefined_data[5];
			$budget_exceeds_quot_id=$cm_cost_predefined_data[6];
			$cost_control_source_id=$cm_cost_predefined_data[7];
			$trim_rate_source_id=$cm_cost_predefined_data[8];
			$commercial_compulsorys=$cm_cost_predefined_data[10];

			echo "document.getElementById('cost_per_minute').value = '".$cost_per_minute."';\n";
			echo "document.getElementById('txt_deffd_lc_cost_percent').value = '".$deffd_lc_per."';\n";

			echo "$('#txt_margin_dzn_po_price').attr('buyer_profit_per','".$buyer_profit_per."');\n";

			echo "document.getElementById('buyer_td').innerHTML = '".$cbo_buyer_name."';\n";
			echo "document.getElementById('agent_td').innerHTML = '".$cbo_agent."';\n";
			echo "document.getElementById('po_td').innerHTML = '".$txt_po_breack_down_id."';\n";
			echo "document.getElementById('season_brand').innerHTML = '".$season_brand."';\n";
			echo "document.getElementById('bodywashcolor_td').innerHTML = '".$color_library[$row[csf("body_wash_color")]]."';\n";

			echo "document.getElementById('txt_job_no').value = '".$row[csf("job_no")]."';\n";
			echo "document.getElementById('hidd_job_id').value = '".$row[csf("id")]."';\n";
			echo "document.getElementById('txt_precost_id').value = '".$row[csf("precost_id")]."';\n";
			echo "document.getElementById('txt_copy_form').value = '".$row[csf("copy_from")]."';\n";

			$grouping=implode(",",array_unique(explode(",",$job_data_arr[$row[csf('job_no')]]['ref'])));
			$file_no=implode(",",array_unique(explode(",",$job_data_arr[$row[csf('job_no')]]['file'])));
			echo "document.getElementById('txt_intarnal_ref').value = '".$grouping."';\n";
			echo "document.getElementById('txt_file_no').value = '".$file_no."';\n";

			echo "document.getElementById('cbo_company_name').value = '".$row[csf("company_name")]."';\n";		
			if($cost_control_source_id==4)
			{
				$sql_qRate=sql_select("select a.qc_no, a.revise_no, a.option_id from qc_mst a where a.status_active=1 and a.is_deleted=0 and a.qc_no='".$row[csf("quotation_id")]."'");
				$option_revise_no="Option-".$sql_qRate[0][csf("option_id")]."; Revise-".$sql_qRate[0][csf("revise_no")];
				echo "document.getElementById('txt_quotation_id').title = '".$option_revise_no."';\n";
				echo "document.getElementById('txt_style_ref').title = '".$option_revise_no."';\n";
			}
			echo "document.getElementById('txt_quotation_id').value = '".$row[csf("quotation_id")]."';\n";
			echo "document.getElementById('txt_refusing').value = '".$refusing_cause."';\n";
			echo "document.getElementById('txt_style_ref').value = '".$row[csf("style_ref_no")]."';\n";
			echo "document.getElementById('txt_style_desc').value = '".$row[csf("style_description")]."';\n";
			echo "document.getElementById('cbo_buyer_name').value = '".$row[csf("buyer_name")]."';\n";
			echo "document.getElementById('cbo_pord_dept').value = '".$row[csf("product_dept")]."';\n";
			echo "document.getElementById('txt_product_code').value = '".$row[csf("product_code")]."';\n";
			echo "document.getElementById('cbo_currercy').value = '".$row[csf("currency_id")]."';\n";
			echo "document.getElementById('cbo_agent').value = '".$row[csf("agent_name")]."';\n";
			echo "document.getElementById('txt_offer_qnty').value = '".$row[csf("job_quantity")]."';\n";
			echo "document.getElementById('cbo_region').value = '".$row[csf("region")]."';\n";
			echo "document.getElementById('cbo_order_uom').value = '".$row[csf("order_uom")]."';\n";
			echo "document.getElementById('set_breck_down').value = '".$row[csf("set_break_down")]."';\n";
			echo "document.getElementById('item_id').value = '".$row[csf("gmts_item_id")]."';\n";
			echo "document.getElementById('tot_set_qnty').value = '".$row[csf("total_set_qnty")]."';\n";
			echo "document.getElementById('txt_sew_smv').value = '".number_format($row[csf("set_smv")],2)."';\n";

			echo "document.getElementById('update_id').value = '".$row[csf("job_no")]."';\n";
			echo "$('#cbo_buyer_name').attr('disabled','true')".";\n";
			echo "$('#cbo_agent').attr('disabled','true')".";\n";
			echo "$('#cbo_company_name').attr('disabled','true')".";\n";
			echo "$('#cbo_region').attr('disabled','true')".";\n";
			echo "$('#cbo_order_uom').attr('disabled','true')".";\n";
			$quotation_id=$row[csf("quotation_id")];
			$company_name=$row[csf("company_name")];
			echo "document.getElementById('copy_quatation_id').value = '".$copy_quotation_id."';\n";
			//echo "document.getElementById('txt_excut_source').value = '".$cm_cost_predefined_data[10]."';\n";
			echo "document.getElementById('budget_exceeds_quot_id').value = '".$budget_exceeds_quot_id."';\n";
			echo "document.getElementById('txt_cost_control_source').value = '".$cost_control_source_id."';\n";
			echo "document.getElementById('txt_excut_source').value = '".$commercial_compulsorys."';\n";

			$avg_unit_price=$row[csf("avg_unit_price")];
			if($row[csf("costing_per")]==1) $price_costing_per=$avg_unit_price*1*12;
			if($row[csf("costing_per")]==2) $price_costing_per=$avg_unit_price*1*1;
			if($row[csf("costing_per")]==3) $price_costing_per=$avg_unit_price*2*12;
			if($row[csf("costing_per")]==4) $price_costing_per=$avg_unit_price*3*12;
			if($row[csf("costing_per")]==5) $price_costing_per=$avg_unit_price*4*12;
			
			echo "document.getElementById('cm_cost_editable').value = '".$cm_cost_editable."';\n";
			echo "document.getElementById('cm_cost_compulsory').value = '".$cm_cost_predefined_data[2]."';\n";
			echo "document.getElementById('txt_final_price_pcs_pre_cost').value = '".$avg_unit_price."';\n";
			echo "set_multiselect('txt_po_breack_down_id','0','0','0','0');\n";
			echo "document.getElementById('app_sms').innerHTML = '';\n";
			echo "document.getElementById('txt_un_appv_request').disabled = '".true."';\n";
			echo "document.getElementById('txt_un_appv_request').value = '';\n";		
			
			if (count($data_entry_from)<1)
			{
				echo "set_field_level_access(".$company_id.")\n";
				echo "calculate_confirm_price_dzn()\n";
				$efficiency_data=get_efficiency_percent($row[csf("company_name")],$row[csf("job_no")],$row[csf("set_smv")]);
				echo "set_efficiency_percent('".json_encode($efficiency_data)."')\n";
				echo "cm_cost_predefined_method('".$currier_cm_cost_data."')\n";
				echo "set_currier_cost_method_variable(".$company_id.")\n";
			}
			else{
				if($cm_cost_editable==2){
					echo "document.getElementById('txt_cm_pre_cost').disabled = '".true."';\n";
				}				
				echo "cm_cost_predefined_method('".$currier_cm_cost_data."')\n";			
			}

			if($is_manula_approved==1){
				echo "$('#approve1').hide()".";\n";
			}
			else{
				echo "$('#approve1').show()".";\n";
			}
		}
		$cbo_approved_status="";
		$menu_id=$_SESSION['menu_id'];
		$data_array=sql_select("select id, costing_date, incoterm, incoterm_place, machine_line, prod_line_hr, costing_per,refusing_cause, copy_quatation, cm_cost_predefined_method_id, exchange_rate, sew_smv, cut_smv, sew_effi_percent, cut_effi_percent, efficiency_wastage_percent, sew_efficiency_source, remarks, approved, ready_to_approved, budget_minute from wo_pre_cost_mst where job_no='$data' and is_deleted=0 and status_active=1");
		$approved_array=array();
		$user_lib_name=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");
		$user_lib_desg=return_library_array("SELECT id,designation from user_passwd", "id", "designation");
		$designation_lib=return_library_array("SELECT id,custom_designation from lib_designation", "id", "custom_designation");

		if (count($data_array)>0)
		{
			foreach ($data_array as $row)
			{
				$cost_per_minute=cost_per_minute($company_name."_".change_date_format($row[csf("costing_date")],'dd-mm-yyyy','-'));
				$cbo_approved_status= $row[csf("approved")];
				if($cbo_approved_status==3){
					$cbo_approved_status=1;
				}
				echo "document.getElementById('cost_per_minute').value = '".$cost_per_minute."';\n";
				echo "document.getElementById('txt_costing_date').value = '".change_date_format($row[csf("costing_date")],'dd-mm-yyyy','-')."';\n";
				echo "document.getElementById('pre_cost_id').value = '".$row[csf("id")]."';\n";
				echo "document.getElementById('cbo_inco_term').value = '".$row[csf("incoterm")]."';\n";
				echo "document.getElementById('txt_incoterm_place').value = '".$row[csf("incoterm_place")]."';\n";
				echo "document.getElementById('txt_machine_line').value = '".$row[csf("machine_line")]."';\n";
				echo "document.getElementById('txt_prod_line_hr').value = '".$row[csf("prod_line_hr")]."';\n";
				echo "document.getElementById('cbo_costing_per').value = '".$row[csf("costing_per")]."';\n";
				echo "document.getElementById('copy_quatation_id').value = '".$row[csf("copy_quatation")]."';\n";
				echo "document.getElementById('cm_cost_predefined_method_id').value = '".$row[csf("cm_cost_predefined_method_id")]."';\n";
				echo "document.getElementById('cm_cost_editable').value = '".$cm_cost_editable."';\n";
				if($row[csf("cm_cost_predefined_method_id")]==0) { echo "cm_cost_predefined_method('".$currier_cm_cost_data."')\n"; }
				
				echo "set_currier_cost_method_variable(".$company_id.")\n";
				echo "document.getElementById('txt_exchange_rate').value = '".$row[csf("exchange_rate")]."';\n";
				echo "document.getElementById('txt_cut_smv').value = '".$row[csf("cut_smv")]."';\n";
				echo "document.getElementById('txt_sew_efficiency_per').value = '".$row[csf("sew_effi_percent")]."';\n";
				echo "document.getElementById('txt_sew_efficiency_source').value = '".$row[csf("sew_efficiency_source")]."';\n";
				echo "document.getElementById('txt_cut_efficiency_per').value = '".$row[csf("cut_effi_percent")]."';\n";
				echo "document.getElementById('txt_efficiency_wastage').value = '".$row[csf("efficiency_wastage_percent")]."';\n";
				echo "document.getElementById('txt_remarks').value = '".$row[csf("remarks")]."';\n";
				echo "document.getElementById('cbo_approved_status').value = '".$cbo_approved_status."';\n";
				echo "document.getElementById('cbo_ready_to_approved').value = '".$row[csf("ready_to_approved")]."';\n";
				echo "document.getElementById('txt_budget_minute').value = '".$row[csf("budget_minute")]."';\n";

				echo "change_caption_cost_dtls('".$row[csf("costing_per")]."','change_caption_dzn')\n";
				echo "calculate_cm_cost_with_method()\n";

				if($row[csf("costing_per")]==1) $price_costing_per=$avg_unit_price*1*12;
				if($row[csf("costing_per")]==2) $price_costing_per=$avg_unit_price*1*1;
				if($row[csf("costing_per")]==3) $price_costing_per=$avg_unit_price*2*12;
				if($row[csf("costing_per")]==4) $price_costing_per=$avg_unit_price*3*12;
				if($row[csf("costing_per")]==5) $price_costing_per=$avg_unit_price*4*12;

				if($cbo_approved_status==1)
				{
					$approval_cause='';
					$menu_id=$_SESSION['menu_id'];
					$user_id=$_SESSION['logic_erp']['user_id'];
					$sql_request="select MAX(id) as id, approval_cause from fabric_booking_approval_cause where entry_form=46 and user_id='$user_id' and booking_id=".$row[csf("id")]." and approval_type=2 and status_active=1 and is_deleted=0 group by approval_cause";//page_id='$menu_id' and

					$nameArray_request=sql_select($sql_request);
					foreach($nameArray_request as $approw)
					{
						$approval_cause=str_replace("\n", "\\n",$approw[csf("approval_cause")]);
					}
					unset($nameArray_request);
					echo "document.getElementById('approve1').value = 'Un-Approved';\n";
					//echo "$('#load_temp').removeAttr('onclick')".";\n";
					echo "$('#load_temp').css('display','none');\n";
					echo "$('#txt_costing_date').attr('disabled','true')".";\n";
					echo "$('#cbo_inco_term').attr('disabled','true')".";\n";
					echo "$('#txt_incoterm_place').attr('disabled','true')".";\n";
					echo "$('#txt_machine_line').attr('disabled','true')".";\n";
					echo "$('#txt_prod_line_hr').attr('disabled','true')".";\n";
					// echo "$('#cbo_costing_per').attr('disabled','true')".";\n";txtcmcost
					echo "$('#copy_quatation_id').attr('disabled','true')".";\n";
					echo "$('#txt_remarks').attr('disabled','true')".";\n";
					echo "$('#save1').attr('disabled','true')".";\n";
					echo "$('#update1').attr('disabled','true')".";\n";
					echo "$('#Delete1').attr('disabled','true')".";\n";
					echo "$( '#update1' ).removeClass( 'formbutton').addClass( 'formbutton_disabled' )".";\n";
					echo "$( '#Delete1' ).removeClass( 'formbutton').addClass( 'formbutton_disabled' )".";\n";

					echo "document.getElementById('txt_un_appv_request').disabled = '".false."';\n";
					echo "document.getElementById('txt_un_appv_request').value = '".$approval_cause."';\n";
					if($db_type == 2){
						$approved_sql=sql_select("SELECT  mst_id, approved_by ,approved_date from approval_history where current_approval_status=1 and  entry_form in(15,46) and mst_id = '".$row[csf("id")]."' ORDER BY id DESC ");
					}
					else{
						$approved_sql=sql_select("SELECT  mst_id, approved_by ,approved_date from approval_history where current_approval_status=1 and  entry_form in(15,46) and mst_id = '".$row[csf("id")]."' ORDER BY id DESC LIMIT 1 ");
					}
					$approved_info = '';
					if(count($approved_sql)>0)
					{
						foreach($approved_sql as $keys=>$values)
			            {
			                $approved_array["name"]=$user_lib_name[$values[csf("approved_by")]]." ".$designation_lib[$user_lib_desg[$values[csf("approved_by")]]];
			                //$approved_array["dates"]=change_date_format($values[csf("approved_date")]);
			                $approved_array["dates"]=$values[csf("approved_date")];
			                $approved_info .="This job is approved by ".$approved_array["name"]." on ".$approved_array["dates"].'<br>';
			            }
					}
					else{
						$approved_info = "This Job is approved";
					}
					echo "document.getElementById('app_sms').innerHTML = '".$approved_info."';\n";
				}
				else
				{
					echo "$('#load_temp').css('display','block');\n";
					echo "document.getElementById('approve1').value = 'Approved';\n";
					echo "$('#txt_costing_date').removeAttr('disabled')".";\n";
					echo "$('#cbo_inco_term').removeAttr('disabled')".";\n";
					echo "$('#txt_incoterm_place').removeAttr('disabled')".";\n";
					echo "$('#txt_machine_line').removeAttr('disabled')".";\n";
					echo "$('#txt_prod_line_hr').removeAttr('disabled')".";\n";
					echo "$('#copy_quatation_id').removeAttr('disabled')".";\n";
					echo "$('#txt_remarks').removeAttr('disabled')".";\n";
					echo "$('#save1').removeAttr('disabled')".";\n";
					echo "$('#update1').removeAttr('disabled')".";\n";
					echo "$('#Delete1').removeAttr('disabled')".";\n";
					echo "document.getElementById('app_sms').innerHTML = '';\n";
					echo "document.getElementById('txt_un_appv_request').disabled = '".true."';\n";
					echo "document.getElementById('txt_un_appv_request').value = '';\n";
				}
				echo "set_button_status(1, permission, 'fnc_precosting_entry',1)\n";
			}
		}
		else
		{
			//echo $copy_quotation_id.'--'.$cost_control_source_id; die;
			if($copy_quotation_id==1 && $cost_control_source_id==2)
			{
				$data_array=sql_select("select quot_date, incoterm, incoterm_place, machine_line, prod_line_hr, costing_per, cm_cost_predefined_method_id, exchange_rate, sew_smv, cut_smv, sew_effi_percent, cut_effi_percent, efficiency_wastage_percent, remarks from wo_price_quotation where id='$quotation_id' and is_deleted=0 and status_active=1");
				foreach ($data_array as $row)
				{
					echo "document.getElementById('cbo_inco_term').value = '".$row[csf("incoterm")]."';\n";
					echo "document.getElementById('txt_incoterm_place').value = '".$row[csf("incoterm_place")]."';\n";
					echo "document.getElementById('txt_machine_line').value = '".$row[csf("machine_line")]."';\n";
					echo "document.getElementById('txt_prod_line_hr').value = '".$row[csf("prod_line_hr")]."';\n";
					echo "document.getElementById('cbo_costing_per').value = '".$row[csf("costing_per")]."';\n";
					echo "document.getElementById('cm_cost_predefined_method_id').value = '".$row[csf("cm_cost_predefined_method_id")]."';\n";
					echo "document.getElementById('cm_cost_editable').value = '".$cm_cost_editable."';\n";
					if($row[csf("cm_cost_predefined_method_id")]==0) { echo "cm_cost_predefined_method('".$cm_cost_predefined_method."')\n"; }
					echo "document.getElementById('txt_exchange_rate').value = '".$row[csf("exchange_rate")]."';\n";
					//echo "document.getElementById('txt_sew_smv').value = '".number_format($row[csf("sew_smv")],2)."';\n";
					echo "document.getElementById('txt_cut_smv').value = '".$row[csf("cut_smv")]."';\n";
					echo "document.getElementById('txt_sew_efficiency_per').value = '".$row[csf("sew_effi_percent")]."';\n";
					echo "document.getElementById('txt_cut_efficiency_per').value = '".$row[csf("cut_effi_percent")]."';\n";
					echo "document.getElementById('txt_efficiency_wastage').value = '".$row[csf("efficiency_wastage_percent")]."';\n";
					echo "document.getElementById('txt_remarks').value = '".$row[csf("remarks")]."';\n";
					echo "change_caption_cost_dtls('".$row[csf(costing_per)]."','change_caption_dzn')\n";
					echo "set_button_status(0, permission, 'fnc_precosting_entry',1)\n";

					if($row[csf("costing_per")]==1) $price_costing_per=$avg_unit_price*1*12;
					if($row[csf("costing_per")]==2) $price_costing_per=$avg_unit_price*1*1;
					if($row[csf("costing_per")]==3) $price_costing_per=$avg_unit_price*2*12;
					if($row[csf("costing_per")]==4) $price_costing_per=$avg_unit_price*3*12;
					if($row[csf("costing_per")]==5) $price_costing_per=$avg_unit_price*4*12;
				}
			}
		}
		 
		$data_array=sql_select("select id, job_no, fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent, wash_cost, wash_cost_percent, comm_cost as comm_cost, comm_cost_percent, commission, commission_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, calculative_cmcost, freight, freight_percent, currier_pre_cost, currier_percent, certificate_pre_cost, certificate_percent, common_oh, common_oh_percent, depr_amor_pre_cost, depr_amor_po_price, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, cost_pcs_set, cost_pcs_set_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set, margin_pcs_set_percent, cm_for_sipment_sche, deffdlc_cost, deffdlc_percent, interest_cost, interest_percent, incometax_cost, incometax_percent, design_cost, design_percent, studio_cost, studio_percent, margin_pcs_bom, margin_bom_per from wo_pre_cost_dtls where job_no='$data' and status_active=1 and is_deleted=0");

		//echo $copy_quotation_id.'--'.$cost_control_source_id; die;
		if (count($data_array)>0)
		{
			foreach ($data_array as $row)
			{
				echo "reset_form('quotationdtls_2','','');\n";
				echo "document.getElementById('txt_fabric_pre_cost').value = '".$row[csf("fabric_cost")]."';\n";
				echo "$('#txt_fabric_pre_cost').attr('pre_fab_cost','".$row[csf("fabric_cost")]."');\n";
				echo "document.getElementById('txt_fabric_po_price').value = '".$row[csf("fabric_cost_percent")]."';\n";
				echo "document.getElementById('txt_trim_pre_cost').value = '".$row[csf("trims_cost")]."';\n";
				echo "$('#txt_trim_pre_cost').attr('pre_trim_cost','".$row[csf("trims_cost")]."');\n";
				echo "document.getElementById('txt_trim_po_price').value = '".$row[csf("trims_cost_percent")]."';\n";
				echo "document.getElementById('txt_embel_pre_cost').value = '".$row[csf("embel_cost")]."';\n";
				echo "$('#txt_embel_pre_cost').attr('pre_emb_cost','".$row[csf("embel_cost")]."');\n";
				echo "document.getElementById('txt_embel_po_price').value = '".$row[csf("embel_cost_percent")]."';\n";
				echo "document.getElementById('txt_wash_pre_cost').value = '".$row[csf("wash_cost")]."';\n";
				echo "$('#txt_wash_pre_cost').attr('pre_wash_cost','".$row[csf("wash_cost")]."');\n";
				echo "document.getElementById('txt_wash_po_price').value = '".$row[csf("wash_cost_percent")]."';\n";
				$comm_cost=($row[csf("comm_cost")]*1);
				echo "document.getElementById('txt_comml_pre_cost').value = '".$row[csf("comm_cost")]."';\n";
				echo "$('#txt_comml_pre_cost').attr('pre_comml_cost','".$comm_cost."');\n";
				echo "document.getElementById('txt_comml_po_price').value = '".$row[csf("comm_cost_percent")]."';\n";
				echo "document.getElementById('txt_commission_pre_cost').value = '".$row[csf("commission")]."';\n";
				echo "$('#txt_commission_pre_cost').attr('pre_commis_cost','".$row[csf("commission")]."');\n";
				echo "document.getElementById('txt_commission_po_price').value = '".$row[csf("commission_percent")]."';\n";
				echo "document.getElementById('txt_lab_test_pre_cost').value = '".$row[csf("lab_test")]."';\n";
				echo "$('#txt_lab_test_pre_cost').attr('pre_lab_cost','".$row[csf("lab_test")]."');\n";
				echo "document.getElementById('txt_lab_test_po_price').value = '".$row[csf("lab_test_percent")]."';\n";
				echo "document.getElementById('txt_inspection_pre_cost').value = '".$row[csf("inspection")]."';\n";
				echo "document.getElementById('txt_inspection_po_price').value = '".$row[csf("inspection_percent")]."';\n";

				//echo $isCmCostDisable.'='.$row[csf("cm_cost")];
				if($isCmCostDisable==1 && ($row[csf("cm_cost")]*1)>0)//ISD-23-21734
				{
					echo "$('#txt_cm_pre_cost').attr('disabled','true')".";\n";
				}
				else
				{
					echo "document.getElementById('txt_cm_pre_cost').disabled=false".";\n";
				}
				echo "document.getElementById('txt_cm_pre_cost').value = '".$row[csf("cm_cost")]."';\n";
				
				
				
				echo "document.getElementById('txt_cm_po_price').value = '".$row[csf("cm_cost_percent")]."';\n";
				echo "document.getElementById('txtcmcost').value = '".$row[csf("calculative_cmcost")]."';\n";
				echo "document.getElementById('txt_freight_pre_cost').value = '".$row[csf("freight")]."';\n";
				echo "document.getElementById('txt_freight_po_price').value = '".$row[csf("freight_percent")]."';\n";
				echo "document.getElementById('txt_currier_pre_cost').value = '".$row[csf("currier_pre_cost")]."';\n";
				echo "document.getElementById('txt_currier_po_price').value = '".$row[csf("currier_percent")]."';\n";
				echo "document.getElementById('txt_certificate_pre_cost').value = '".$row[csf("certificate_pre_cost")]."';\n";
				echo "document.getElementById('txt_certificate_po_price').value = '".$row[csf("certificate_percent")]."';\n";

				echo "document.getElementById('txt_common_oh_pre_cost').value = '".$row[csf("common_oh")]."';\n";
				echo "document.getElementById('txt_common_oh_po_price').value = '".$row[csf("common_oh_percent")]."';\n";

				echo "document.getElementById('txt_depr_amor_pre_cost').value = '".$row[csf("depr_amor_pre_cost")]."';\n";
				echo "document.getElementById('txt_depr_amor_po_price').value = '".$row[csf("depr_amor_po_price")]."';\n";

				echo "document.getElementById('txt_deffdlc_pre_cost').value = '".$row[csf("deffdlc_cost")]."';\n";
				echo "document.getElementById('txt_deffdlc_po_price').value = '".$row[csf("deffdlc_percent")]."';\n";

				echo "document.getElementById('txt_interest_pre_cost').value = '".$row[csf("interest_cost")]."';\n";
				echo "document.getElementById('txt_interest_po_price').value = '".$row[csf("interest_percent")]."';\n";

				echo "document.getElementById('txt_incometax_pre_cost').value = '".$row[csf("incometax_cost")]."';\n";
				echo "document.getElementById('txt_incometax_po_price').value = '".$row[csf("incometax_percent")]."';\n";

				echo "document.getElementById('txt_design_pre_cost').value = '".$row[csf("design_cost")]."';\n";
				echo "document.getElementById('txt_design_po_price').value = '".$row[csf("design_percent")]."';\n";

				echo "document.getElementById('txt_studio_pre_cost').value = '".$row[csf("studio_cost")]."';\n";
				echo "document.getElementById('txt_studio_po_price').value = '".$row[csf("studio_percent")]."';\n";

				echo "document.getElementById('txt_total_pre_cost').value = '".$row[csf("total_cost")]."';\n";
				echo "document.getElementById('txt_total_po_price').value = '".$row[csf("total_cost_percent")]."';\n";
				if($row[csf("price_dzn")]=="") $row[csf("price_dzn")]=number_format($price_costing_per,4,'.','');
				echo "document.getElementById('txt_final_price_dzn_pre_cost').value = '".$row[csf("price_dzn")]."';\n";
				echo "document.getElementById('txt_final_price_dzn_po_price').value = '".$row[csf("price_dzn_percent")]."';\n";
				echo "document.getElementById('txt_margin_dzn_pre_cost').value = '".$row[csf("margin_dzn")]."';\n";
				echo "document.getElementById('txt_margin_dzn_po_price').value = '".$row[csf("margin_dzn_percent")]."';\n";
				echo "document.getElementById('txt_total_pre_cost_psc_set').value = '".$row[csf("cost_pcs_set")]."';\n";
				echo "document.getElementById('txt_total_pre_cost_psc_set_po_price').value = '".$row[csf("cost_pcs_set_percent")]."';\n";
				echo "document.getElementById('txt_final_price_pcs_pre_cost').value = '".$row[csf("price_pcs_or_set")]."';\n";
				echo "document.getElementById('txt_final_price_pcs_po_price').value = '".$row[csf("price_pcs_or_set_percent")]."';\n";
				echo "document.getElementById('txt_margin_pcs_pre_cost').value = '".$row[csf("margin_pcs_set")]."';\n";
				echo "document.getElementById('txt_margin_pcs_po_price').value = '".$row[csf("margin_pcs_set_percent")]."';\n";
				echo "document.getElementById('txt_margin_pcs_bom_cost').value = '".$row[csf("margin_pcs_bom")]."';\n";
				echo "document.getElementById('txt_margin_pcs_bom_per').value = '".$row[csf("margin_bom_per")]."';\n";
				echo "calculate_interest_incometex_oparating_depreciation_cost();\n";
				
				//echo "calculate_confirm_price_dzn(1)\n";
				echo "document.getElementById('update_id_dtls').value = '".$row[csf("id")]."';\n";
				if($row[csf("margin_dzn")]<0)
				{
					echo "document.getElementById('txt_margin_dzn_pre_cost').style.backgroundColor = '#F00';\n";
				}
				else
				{
					echo "document.getElementById('txt_margin_dzn_pre_cost').style.backgroundColor = '';\n";
				}

				if($row[csf("margin_pcs_set")]<0)
				{
					echo "document.getElementById('txt_margin_pcs_pre_cost').style.backgroundColor = '#F00';\n";
				}
				else
				{
					echo "document.getElementById('txt_margin_pcs_pre_cost').style.backgroundColor = '';\n";
				}
				if($cbo_approved_status==1)
				{
					echo "$('#txt_lab_test_pre_cost').attr('disabled','true')".";\n";
					echo "$('#txt_inspection_pre_cost').attr('disabled','true')".";\n";
					//echo "$('#txt_cm_pre_cost').attr('disabled','true')".";\n";
					echo "$('#txt_freight_pre_cost').attr('disabled','true')".";\n";
					//echo "$('#txt_common_oh_pre_cost').attr('disabled','true')".";\n";
					echo "$('#txt_1st_quoted_price_pre_cost').attr('disabled','true')".";\n";
					echo "$('#txt_first_quoted_price_date').attr('disabled','true')".";\n";
					echo "$('#txt_revised_price_pre_cost').attr('disabled','true')".";\n";
					echo "$('#txt_revised_price_date').attr('disabled','true')".";\n";
					echo "$('#txt_confirm_price_pre_cost').attr('disabled','true')".";\n";
					echo "$('#txt_confirm_date_pre_cost').attr('disabled','true')".";\n";
					echo "$('#save2').attr('disabled','true')".";\n";
					echo "$('#update2').attr('disabled','true')".";\n";
					echo "$('#Delete2').attr('disabled','true')".";\n";
				}
				else
				{
					echo "$('#txt_lab_test_pre_cost').removeAttr('disabled')".";\n";
					echo "$('#txt_inspection_pre_cost').removeAttr('disabled')".";\n";
					//echo "$('#txt_cm_pre_cost').removeAttr('disabled')".";\n";
					echo "$('#txt_freight_pre_cost').removeAttr('disabled')".";\n";
					//echo "$('#txt_common_oh_pre_cost').removeAttr('disabled')".";\n";
					echo "$('#txt_1st_quoted_price_pre_cost').removeAttr('disabled')".";\n";
					echo "$('#txt_first_quoted_price_date').removeAttr('disabled')".";\n";
					echo "$('#txt_revised_price_pre_cost').removeAttr('disabled')".";\n";
					echo "$('#txt_revised_price_date').removeAttr('disabled')".";\n";


					echo "$('#txt_confirm_price_pre_cost').removeAttr('disabled')".";\n";
					echo "$('#txt_confirm_date_pre_cost').removeAttr('disabled')".";\n";
					echo "$('#save2').removeAttr('disabled')".";\n";
					echo "$('#update2').removeAttr('disabled')".";\n";
					echo "$('#Delete2').removeAttr('disabled')".";\n";
				}
				if($component_approved_lab==1) echo "$('#txt_lab_test_pre_cost').attr('disabled','true')".";\n"; else echo "$('#txt_lab_test_pre_cost').removeAttr('disabled')".";\n";
				if($component_approved_ins==1) echo "$('#txt_inspection_pre_cost').attr('disabled','true')".";\n"; else echo "$('#txt_inspection_pre_cost').removeAttr('disabled')".";\n";
				if($component_approved_friegt==1) echo "$('#txt_freight_pre_cost').attr('disabled','true')".";\n"; else echo "$('#txt_freight_pre_cost').removeAttr('disabled')".";\n";
				if($component_approved_currier==1) echo "$('#txt_currier_pre_cost').attr('disabled','true')".";\n"; else echo "$('#txt_currier_pre_cost').removeAttr('disabled')".";\n";
				if($component_approved_certificate==1) echo "$('#txt_certificate_pre_cost').attr('disabled','true')".";\n"; else echo "$('#txt_certificate_pre_cost').removeAttr('disabled')".";\n";
				if($component_approved_others==1)
				{
					echo "$('#txt_interest_pre_cost').attr('disabled','true')".";\n";
					echo "$('#txt_incometax_pre_cost').attr('disabled','true')".";\n";
					echo "$('#txt_common_oh_pre_cost').attr('disabled','true')".";\n";
					echo "$('#txt_depr_amor_pre_cost').attr('disabled','true')".";\n";
				}
				else
				{
					/*echo "$('#txt_interest_pre_cost').removeAttr('disabled')".";\n";
					echo "$('#txt_incometax_pre_cost').removeAttr('disabled')".";\n";
					echo "$('#txt_common_oh_pre_cost').removeAttr('disabled')".";\n";
					echo "$('#txt_depr_amor_pre_cost').removeAttr('disabled')".";\n";*/
				}

				echo "set_button_status(1, permission, 'fnc_quotation_entry_dtls',2)\n";
			}
			
			if($copy_quotation_id==1 && $cost_control_source_id==2)//Price Quotation
			{
				$data_array=sql_select("select id, quotation_id, fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent,wash_cost, wash_cost_percent, comm_cost, comm_cost_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, freight, freight_percent,currier_pre_cost, 	currier_percent, certificate_pre_cost, certificate_percent, common_oh, common_oh_percent, depr_amor_pre_cost, depr_amor_po_price, total_cost, total_cost_percent, commission, commission_percent, final_cost_dzn, final_cost_dzn_percent, final_cost_pcs, final_cost_set_pcs_rate, a1st_quoted_price, a1st_quoted_price_date, revised_price,revised_price_date, confirm_price, confirm_price_set_pcs_rate, confirm_price_dzn, confirm_price_dzn_percent, margin_dzn, margin_dzn_percent, confirm_date, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted from wo_price_quotation_costing_mst where quotation_id='$quotation_id' and status_active=1 and is_deleted=0");
				
				if (count($data_array)>0)
				{
					foreach ($data_array as $row)
					{

						echo "$('#txt_fabric_pre_cost').attr('pri_fabric_pre_cost','".$row[csf("fabric_cost")]."')".";\n";
						echo "$('#txt_trim_pre_cost').attr('pri_trim_pre_cost','".$row[csf("trims_cost")]."')".";\n";
						//echo "$('#txt_trim_pre_cost').attr('pre_trim_cost','".$row[csf("trims_cost")]."');\n";
						echo "$('#txt_embel_pre_cost').attr('pri_embel_pre_cost','".$row[csf("embel_cost")]."')".";\n";
						echo "$('#txt_wash_pre_cost').attr('pri_wash_pre_cost','".$row[csf("wash_cost")]."')".";\n";
						echo "$('#txt_comml_pre_cost').attr('pri_comml_pre_cost','".$row[csf("comm_cost")]."')".";\n";
						echo "$('#txt_commission_pre_cost').attr('pri_commission_pre_cost','".$row[csf("commission")]."')".";\n";
						echo "$('#txt_lab_test_pre_cost').attr('pri_lab_test_pre_cost','".$row[csf("lab_test")]."')".";\n";
						echo "$('#txt_inspection_pre_cost').attr('pri_inspection_pre_cost','".$row[csf("inspection")]."')".";\n";
						echo "$('#txt_cm_pre_cost').attr('pri_cm_pre_cost','".$row[csf("cm_cost")]."')".";\n";
						echo "$('#txt_freight_pre_cost').attr('pri_freight_pre_cost','".$row[csf("freight")]."')".";\n";
						echo "$('#txt_currier_pre_cost').attr('pri_currier_pre_cost','".$row[csf("currier_pre_cost")]."')".";\n";
						echo "$('#txt_certificate_pre_cost').attr('pri_certificate_pre_cost','".$row[csf("certificate_pre_cost")]."')".";\n";
						echo "$('#txt_common_oh_pre_cost').attr('pri_common_oh_pre_cost','".$row[csf("common_oh")]."')".";\n";
						echo "$('#txt_depr_amor_pre_cost').attr('pri_depr_amor_pre_cost','".$row[csf("depr_amor_pre_cost")]."')".";\n";
						echo "$('#txt_total_pre_cost').attr('pri_total_pre_cost','".$row[csf("total_cost")]."')".";\n";
					}
				}
				else
				{
					echo "$('#txt_fabric_pre_cost').attr('pri_fabric_pre_cost','0')".";\n";
					echo "$('#txt_trim_pre_cost').attr('pri_trim_pre_cost','0')".";\n";
					echo "$('#txt_trim_pre_cost').attr('pre_trim_cost','0')".";\n";
					echo "$('#txt_embel_pre_cost').attr('pri_embel_pre_cost','0')".";\n";
					echo "$('#txt_wash_pre_cost').attr('pri_wash_pre_cost','0')".";\n";
					echo "$('#txt_comml_pre_cost').attr('pri_comml_pre_cost','0')".";\n";
					echo "$('#txt_commission_pre_cost').attr('pri_commission_pre_cost','0')".";\n";
					echo "$('#txt_lab_test_pre_cost').attr('pri_lab_test_pre_cost','0')".";\n";
					echo "$('#txt_inspection_pre_cost').attr('pri_inspection_pre_cost','0')".";\n";
					echo "$('#txt_cm_pre_cost').attr('pri_cm_pre_cost','0')".";\n";
					echo "$('#txt_freight_pre_cost').attr('pri_freight_pre_cost','0')".";\n";
					echo "$('#txt_currier_pre_cost').attr('pri_currier_pre_cost','0')".";\n";
					echo "$('#txt_certificate_pre_cost').attr('pri_certificate_pre_cost','0')".";\n";
					echo "$('#txt_common_oh_pre_cost').attr('pri_common_oh_pre_cost','0')".";\n";
					echo "$('#txt_depr_amor_pre_cost').attr('pri_depr_amor_pre_cost','0')".";\n";
					echo "$('#txt_total_pre_cost').attr('pri_total_pre_cost','0')".";\n";
				}
			}
		}
		else
		{
			//echo $copy_quotation_id.'='.$cost_control_source_id.'=asssssssssdsd';
			if($copy_quotation_id==1 && $cost_control_source_id==2)//Price Quotation
			{
				$data_array=sql_select("select id, quotation_id, fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent, wash_cost, wash_cost_percent, comm_cost, comm_cost_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, freight, freight_percent, currier_pre_cost, 	currier_percent, certificate_pre_cost, certificate_percent, common_oh, common_oh_percent, depr_amor_pre_cost, depr_amor_po_price, total_cost, total_cost_percent, commission, commission_percent, final_cost_dzn, final_cost_dzn_percent, final_cost_pcs, final_cost_set_pcs_rate, a1st_quoted_price, a1st_quoted_price_date, revised_price, revised_price_date, confirm_price, confirm_price_set_pcs_rate, confirm_price_dzn, confirm_price_dzn_percent, margin_dzn, margin_dzn_percent, confirm_date, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, design_pre_cost, design_percent, studio_pre_cost, studio_percent, interest_pre_cost, interest_po_price, income_tax_pre_cost, income_tax_po_price from wo_price_quotation_costing_mst where quotation_id='$quotation_id' and status_active=1 and is_deleted=0");

				if(count($data_array)>0)
				{
					foreach ($data_array as $row)
					{
						echo "reset_form('quotationdtls_2','','');\n";
						echo "document.getElementById('txt_fabric_pre_cost').value = '".$row[csf("fabric_cost")]."';\n";
						echo "$('#txt_fabric_pre_cost').attr('pre_fab_cost','".$row[csf("fabric_cost")]."');\n";
						echo "document.getElementById('txt_fabric_po_price').value = '".$row[csf("fabric_cost_percent")]."';\n";
						echo "document.getElementById('txt_trim_pre_cost').value = '".$row[csf("trims_cost")]."';\n";
						echo "$('#txt_trim_pre_cost').attr('pre_trim_cost','".$row[csf("trims_cost")]."');\n";
						echo "document.getElementById('txt_trim_po_price').value = '".$row[csf("trims_cost_percent")]."';\n";
						echo "document.getElementById('txt_embel_pre_cost').value = '".$row[csf("embel_cost")]."';\n";
						echo "$('#txt_embel_pre_cost').attr('pre_emb_cost','".$row[csf("embel_cost")]."');\n";
						echo "document.getElementById('txt_embel_po_price').value = '".$row[csf("embel_cost_percent")]."';\n";
						echo "document.getElementById('txt_wash_pre_cost').value = '".$row[csf("wash_cost")]."';\n";
						echo "document.getElementById('txt_wash_po_price').value = '".$row[csf("wash_cost_percent")]."';\n";
						echo "document.getElementById('txt_comml_pre_cost').value = '".$row[csf("comm_cost")]."';\n";
						echo "document.getElementById('txt_comml_po_price').value = '".$row[csf("comm_cost_percent")]."';\n";
						echo "document.getElementById('txt_commission_pre_cost').value = '".$row[csf("commission")]."';\n";
						echo "document.getElementById('txt_commission_po_price').value = '".$row[csf("commission_percent")]."';\n";
						echo "document.getElementById('txt_lab_test_pre_cost').value = '".$row[csf("lab_test")]."';\n";
						echo "document.getElementById('txt_lab_test_po_price').value = '".$row[csf("lab_test_percent")]."';\n";
						echo "document.getElementById('txt_inspection_pre_cost').value = '".$row[csf("inspection")]."';\n";
						echo "document.getElementById('txt_inspection_po_price').value = '".$row[csf("inspection_percent")]."';\n";
						echo "document.getElementById('txt_cm_pre_cost').value = '".$row[csf("cm_cost")]."';\n";
						echo "document.getElementById('txt_cm_po_price').value = '".$row[csf("cm_cost_percent")]."';\n";
						echo "document.getElementById('txt_freight_pre_cost').value = '".$row[csf("freight")]."';\n";
						echo "document.getElementById('txt_freight_po_price').value = '".$row[csf("freight_percent")]."';\n";
						echo "document.getElementById('txt_currier_pre_cost').value = '".$row[csf("currier_pre_cost")]."';\n";
						echo "document.getElementById('txt_currier_po_price').value = '".$row[csf("currier_percent")]."';\n";
						echo "document.getElementById('txt_certificate_pre_cost').value = '".$row[csf("certificate_pre_cost")]."';\n";
						echo "document.getElementById('txt_certificate_po_price').value = '".$row[csf("certificate_percent")]."';\n";

						echo "document.getElementById('txt_common_oh_pre_cost').value = '".$row[csf("common_oh")]."';\n";
						echo "document.getElementById('txt_common_oh_quotation').value = '".$row[csf("common_oh")]."';\n";
						echo "document.getElementById('txt_common_oh_po_price').value = '".$row[csf("common_oh_percent")]."';\n";

						echo "document.getElementById('txt_depr_amor_pre_cost').value = '".$row[csf("depr_amor_pre_cost")]."';\n";
						echo "document.getElementById('txt_depr_amor_quotation').value = '".$row[csf("depr_amor_pre_cost")]."';\n";
						echo "document.getElementById('txt_depr_amor_po_price').value = '".$row[csf("depr_amor_po_price")]."';\n";

						echo "document.getElementById('txt_interest_pre_cost').value = '".$row[csf("interest_pre_cost")]."';\n";
						echo "document.getElementById('txt_interest_quotation').value = '".$row[csf("interest_pre_cost")]."';\n";
						echo "document.getElementById('txt_interest_po_price').value = '".$row[csf("interest_po_price")]."';\n";

						echo "document.getElementById('txt_incometax_pre_cost').value = '".$row[csf("income_tax_pre_cost")]."';\n";
						echo "document.getElementById('txt_incometax_quotation').value = '".$row[csf("income_tax_pre_cost")]."';\n";
						echo "document.getElementById('txt_incometax_po_price').value = '".$row[csf("income_tax_po_price")]."';\n";

						echo "document.getElementById('txt_total_pre_cost').value = '".$row[csf("total_cost")]."';\n";
						echo "document.getElementById('txt_total_po_price').value = '".$row[csf("total_cost_percent")]."';\n";
						echo "document.getElementById('txt_final_price_pcs_pre_cost').value = '".$avg_unit_price."';\n";
						echo "document.getElementById('txt_final_price_dzn_pre_cost').value = '".$price_costing_per."';\n";

						echo "document.getElementById('txt_design_pre_cost').value = '".$row[csf("design_pre_cost")]."';\n";
						echo "document.getElementById('txt_design_po_price').value = '".$row[csf("design_percent")]."';\n";

						echo "document.getElementById('txt_studio_pre_cost').value = '".$row[csf("studio_pre_cost")]."';\n";
						echo "document.getElementById('txt_studio_po_price').value = '".$row[csf("studio_percent")]."';\n";

						echo "calculate_confirm_price_dzn(1)\n";
						echo "set_button_status(0, permission, 'fnc_quotation_entry_dtls',2)\n";

						echo "$('#txt_fabric_pre_cost').attr('pri_fabric_pre_cost','".$row[csf("fabric_cost")]."')".";\n";
						echo "$('#txt_trim_pre_cost').attr('pri_trim_pre_cost','".$row[csf("trims_cost")]."')".";\n";
						echo "$('#txt_embel_pre_cost').attr('pri_embel_pre_cost','".$row[csf("embel_cost")]."')".";\n";
						echo "$('#txt_wash_pre_cost').attr('pri_wash_pre_cost','".$row[csf("wash_cost")]."')".";\n";
						echo "$('#txt_wash_pre_cost').attr('pre_wash_cost','".$row[csf("wash_cost")]."')".";\n";
						echo "$('#txt_comml_pre_cost').attr('pri_comml_pre_cost','".$row[csf("comm_cost")]."')".";\n";
						echo "$('#txt_comml_pre_cost').attr('pre_comml_cost','".$row[csf("comm_cost")]."')".";\n";
						echo "$('#txt_commission_pre_cost').attr('pri_commission_pre_cost','".$row[csf("commission")]."')".";\n";
						echo "$('#txt_lab_test_pre_cost').attr('pri_lab_test_pre_cost','".$row[csf("lab_test")]."')".";\n";
						echo "$('#txt_lab_test_pre_cost').attr('pre_lab_cost','".$row[csf("lab_test")]."')".";\n";
						echo "$('#txt_inspection_pre_cost').attr('pri_inspection_pre_cost','".$row[csf("inspection")]."')".";\n";
						echo "$('#txt_cm_pre_cost').attr('pri_cm_pre_cost','".$row[csf("cm_cost")]."')".";\n";
						echo "$('#txt_freight_pre_cost').attr('pri_freight_pre_cost','".$row[csf("freight")]."')".";\n";
						echo "$('#txt_currier_pre_cost').attr('pri_currier_pre_cost','".$row[csf("currier_pre_cost")]."')".";\n";
						echo "$('#txt_certificate_pre_cost').attr('pri_certificate_pre_cost','".$row[csf("certificate_pre_cost")]."')".";\n";
						echo "$('#txt_common_oh_pre_cost').attr('pri_common_oh_pre_cost','".$row[csf("common_oh")]."')".";\n";
						echo "$('#txt_depr_amor_pre_cost').attr('pri_depr_amor_pre_cost','".$row[csf("depr_amor_pre_cost")]."')".";\n";
						echo "$('#txt_total_pre_cost').attr('pri_total_pre_cost','".$row[csf("total_cost")]."')".";\n";
					}
				}
				else
				{
					echo "$('#txt_fabric_pre_cost').attr('pri_fabric_pre_cost','0')".";\n";
					echo "$('#txt_trim_pre_cost').attr('pri_trim_pre_cost','0')".";\n";
					echo "$('#txt_trim_pre_cost').attr('pre_trim_cost','0')".";\n";
					echo "$('#txt_embel_pre_cost').attr('pri_embel_pre_cost','0')".";\n";
					echo "$('#txt_wash_pre_cost').attr('pri_wash_pre_cost','0')".";\n";
					echo "$('#txt_comml_pre_cost').attr('pri_comml_pre_cost','0')".";\n";
					echo "$('#txt_commission_pre_cost').attr('pri_commission_pre_cost','0')".";\n";
					echo "$('#txt_lab_test_pre_cost').attr('pri_lab_test_pre_cost','0')".";\n";
					echo "$('#txt_inspection_pre_cost').attr('pri_inspection_pre_cost','0')".";\n";
					echo "$('#txt_cm_pre_cost').attr('pri_cm_pre_cost','0')".";\n";
					echo "$('#txt_freight_pre_cost').attr('pri_freight_pre_cost','0')".";\n";
					echo "$('#txt_currier_pre_cost').attr('pri_currier_pre_cost','0')".";\n";
					echo "$('#txt_certificate_pre_cost').attr('pri_certificate_pre_cost','0')".";\n";
					echo "$('#txt_common_oh_pre_cost').attr('pri_common_oh_pre_cost','0')".";\n";
					echo "$('#txt_depr_amor_pre_cost').attr('pri_depr_amor_pre_cost','0')".";\n";
					echo "$('#txt_total_pre_cost').attr('pri_total_pre_cost','0')".";\n";
				}
			}
			else if($copy_quotation_id==1 && $cost_control_source_id==4)//Quick Costing [WVN]
			{
				$data_array=sql_select("select sum(fab_amount) as fabric_cost, sum(sp_oparation_amount) as embel_cost, sum(wash_amount) as wash_cost, sum(acc_amount) as trims_cost, sum(fright_amount) as freight, sum(lab_amount) as lab_cost, sum(commercial_cost) as commercial_cost, sum(comm_amount) as commission, sum(cm_amount) as cm_cost, sum(courier_amount) as courier_amount, sum(inspection_cost) as inspection_cost, sum(lc_cost) as deffdlc_cost, sum(operating_exp) as common_oh from qc_confirm_dtls where cost_sheet_id='$qc_no' and status_active=1 and is_deleted=0");
				if(count($data_array)>0)
				{
					foreach ($data_array as $row)
					{
						echo "reset_form('quotationdtls_2','','');\n";
						echo "document.getElementById('txt_fabric_pre_cost').value = '".$row[csf("fabric_cost")]."';\n";
						echo "$('#txt_fabric_pre_cost').attr('pre_fab_cost','".$row[csf("fabric_cost")]."');\n";
						echo "document.getElementById('txt_trim_pre_cost').value = '".$row[csf("trims_cost")]."';\n";
						echo "$('#txt_trim_pre_cost').attr('pre_trim_cost','".$row[csf("trims_cost")]."');\n";
						echo "document.getElementById('txt_embel_pre_cost').value = '".$row[csf("embel_cost")]."';\n";
						echo "$('#txt_embel_pre_cost').attr('pre_emb_cost','".$row[csf("embel_cost")]."');\n";
						echo "document.getElementById('txt_wash_pre_cost').value = '".$row[csf("wash_cost")]."';\n";
						echo "$('#txt_wash_pre_cost').attr('pre_wash_cost','".$row[csf("wash_cost")]."');\n";
						echo "document.getElementById('txt_comml_pre_cost').value = '".$row[csf("commercial_cost")]."';\n";
						echo "$('#txt_comml_pre_cost').attr('pre_comml_cost','".$row[csf("commercial_cost")]."');\n";
						echo "document.getElementById('txt_commission_pre_cost').value = '".$row[csf("commission")]."';\n";
						echo "$('#txt_commission_pre_cost').attr('pre_commis_cost','".$row[csf("commission")]."');\n";
						echo "document.getElementById('txt_lab_test_pre_cost').value = '".$row[csf("lab_cost")]."';\n";
						echo "$('#txt_lab_test_pre_cost').attr('pre_lab_cost','".$row[csf("lab_cost")]."');\n";
						echo "document.getElementById('txt_cm_pre_cost').value = '".$row[csf("cm_cost")]."';\n";
						echo "document.getElementById('txt_freight_pre_cost').value = '".$row[csf("freight")]."';\n";
						echo "document.getElementById('txt_currier_pre_cost').value = '".$row[csf("courier_amount")]."';\n";
						echo "document.getElementById('txt_inspection_pre_cost').value = '".$row[csf("inspection_cost")]."';\n";
						echo "document.getElementById('txt_common_oh_pre_cost').value = '".$row[csf("common_oh")]."';\n";
						echo "document.getElementById('txt_deffdlc_pre_cost').value = '".$row[csf("deffdlc_cost")]."';\n";
						echo "set_currier_cost_method_variable(".$company_id.")\n";
						echo "calculate_confirm_price_dzn(1)\n";
						echo "set_button_status(0, permission, 'fnc_quotation_entry_dtls',2)\n";

						echo "$('#txt_fabric_pre_cost').attr('pri_fabric_pre_cost','".$row[csf("fabric_cost")]."')".";\n";
						echo "$('#txt_trim_pre_cost').attr('pri_trim_pre_cost','".$row[csf("trims_cost")]."')".";\n";
						echo "$('#txt_embel_pre_cost').attr('pri_embel_pre_cost','".$row[csf("embel_cost")]."')".";\n";
						echo "$('#txt_wash_pre_cost').attr('pri_wash_pre_cost','".$row[csf("wash_cost")]."')".";\n";
						echo "$('#txt_comml_pre_cost').attr('pri_comml_pre_cost','".$row[csf("commercial_cost")]."')".";\n";
						echo "$('#txt_commission_pre_cost').attr('pri_commission_pre_cost','".$row[csf("commission")]."')".";\n";
						echo "$('#txt_lab_test_pre_cost').attr('pri_lab_test_pre_cost','".$row[csf("lab_cost")]."')".";\n";
						echo "$('#txt_cm_pre_cost').attr('pri_cm_pre_cost','".$row[csf("cm_cost")]."')".";\n";
						echo "$('#txt_freight_pre_cost').attr('pri_freight_pre_cost','".$row[csf("freight")]."')".";\n";
						echo "$('#txt_currier_pre_cost').attr('pri_currier_pre_cost','".$row[csf("courier_amount")]."')".";\n";
						echo "$('#txt_common_oh_pre_cost').attr('pri_common_oh_pre_cost','".$row[csf("common_oh")]."')".";\n";
						
						echo "document.getElementById('txt_final_price_pcs_pre_cost').value = '".$avg_unit_price."';\n";
						echo "document.getElementById('txt_final_price_dzn_pre_cost').value = '".$price_costing_per."';\n";
					}
				}
			}
			else
			{
				echo "$('#txt_fabric_pre_cost').attr('pri_fabric_pre_cost','0')".";\n";
				echo "$('#txt_trim_pre_cost').attr('pri_trim_pre_cost','0')".";\n";
				echo "$('#txt_trim_pre_cost').attr('pre_trim_cost','0')".";\n";
				echo "$('#txt_embel_pre_cost').attr('pri_embel_pre_cost','0')".";\n";
				echo "$('#txt_wash_pre_cost').attr('pri_wash_pre_cost','0')".";\n";
				echo "$('#txt_comml_pre_cost').attr('pri_comml_pre_cost','0')".";\n";
				echo "$('#txt_commission_pre_cost').attr('pri_commission_pre_cost','0')".";\n";
				echo "$('#txt_lab_test_pre_cost').attr('pri_lab_test_pre_cost','0')".";\n";
				echo "$('#txt_inspection_pre_cost').attr('pri_inspection_pre_cost','0')".";\n";
				echo "$('#txt_cm_pre_cost').attr('pri_cm_pre_cost','0')".";\n";
				echo "$('#txt_freight_pre_cost').attr('pri_freight_pre_cost','0')".";\n";
				echo "$('#txt_currier_pre_cost').attr('pri_currier_pre_cost','0')".";\n";
				echo "$('#txt_certificate_pre_cost').attr('pri_certificate_pre_cost','0')".";\n";
				echo "$('#txt_common_oh_pre_cost').attr('pri_common_oh_pre_cost','0')".";\n";
				echo "$('#txt_depr_amor_pre_cost').attr('pri_depr_amor_pre_cost','0')".";\n";
				echo "$('#txt_total_pre_cost').attr('pri_total_pre_cost','0')".";\n";
			}
		}
	}
	exit();
}


if($action=="detail_part_save_check") //Validation check
{
	//$data=explode("_",$data);
	$update_id=$data;
	$sql_fab=sql_select("select job_no,sum(avg_cons) as avg_cons from wo_pre_cost_fabric_cost_dtls where job_no='$update_id' group by job_no");
	$fabQtyPre=0;
	foreach($sql_fab as $row_fab){
		$fabQtyPre=$row_fab[csf('avg_cons')];
	}

	$sql_yar=sql_select("select job_no,sum(cons_qnty) as cons_qnty from wo_pre_cost_fab_yarn_cost_dtls where job_no='$update_id' group by job_no");
	$yarQtyPre=0;
	foreach($sql_yar as $row_yarn){
		$yarQtyPre=$row_yarn[csf('cons_qnty')];
	}
	$sql_tri=sql_select("select job_no,sum(cons_dzn_gmts) as cons_dzn_gmts from wo_pre_cost_trim_cost_dtls where job_no='$update_id' group by job_no");
	$triQtyPre=0;
	foreach($sql_tri as $row_tri){
		$triQtyPre=$row_tri[csf('cons_dzn_gmts')];
	}
	$sql_emb=sql_select("select job_no,sum(cons_dzn_gmts) as cons_dzn_gmts from wo_pre_cost_embe_cost_dtls where job_no='$update_id' and emb_name!=3 group by job_no");
	$embQtyPre=0;
	foreach($sql_emb as $row_emb){
		$embQtyPre=$row_emb[csf('cons_dzn_gmts')];
	}
	$sql_was=sql_select("select job_no,sum(cons_dzn_gmts) as cons_dzn_gmts from wo_pre_cost_embe_cost_dtls where job_no='$update_id' and emb_name =3 group by job_no");
	$wasQtyPre=0;
	foreach($sql_was as $row_was){
		$wasQtyPre=$row_was[csf('cons_dzn_gmts')];
	}
	$sql_comm=sql_select("select job_no,sum(amount) as amount from wo_pre_cost_comarci_cost_dtls where job_no='$update_id'  group by job_no");
	$commQtyPre=0;
	foreach($sql_comm as $row_comm){
		$commQtyPre=$row_comm[csf('amount')];
	}
	if($fabQtyPre==0 || $yarQtyPre==0 || $triQtyPre==0 || $embQtyPre==0 || $wasQtyPre==0 || $commQtyPre==0)
	{
		echo "DetailPartNotEntryFound"."**".$fabQtyPre."**".$yarQtyPre."**".$triQtyPre."**".$embQtyPre."**".$wasQtyPre."**".$commQtyPre;
		die;
	}
	exit();
}


// partial pre cost copy popup action-- new development-- 02-11-2016 kaiyum //
if ($action=="partial_pre_cost_copy_popup")
{
  	echo load_html_head_contents("Popup Partial Pre Cost Copy","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
	var permission = '<? echo $permission; ?>';
	function fnc_copy_pre_cost( )
	{
		//alert( operation);
		if (form_validation('txt_popup_job_no','Job No')==false)
		{
			return;
		}
		else
		{
			var txt_popup_job_no=$("#txt_popup_job_no").val();
			var txt_main_job_no_hidden=$("#txt_main_job_no_hidden").val();
			var hidd_job_id=$("#hidd_job_id").val();
			var cons_variable=$("#hidd_cons_variable").val();
			var data="action=save_partial_pre_cost_copy&datas="+txt_popup_job_no+'*'+txt_main_job_no_hidden+'*'+hidd_job_id+'*'+cons_variable;
			http.open("POST","pre_cost_entry_controller_v2.php",true);
			http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
			http.send(data);
			http.onreadystatechange = fnc_pre_cost_copy_reponse;
		}
	}
	function fnc_pre_cost_copy_reponse()
	{
		if(http.readyState == 4)
		{
			//alert (http.responseText); //return ;
			var reponse=http.responseText.split('**');
			show_msg(trim(reponse[0]));
			if(reponse[0]==0)
			{
				alert('Data is copy successfully');
			}
			else
			{
				alert('Data is copy failed');
			}
			reset_form('partialcopyfrm_1','','');
		}
	}
	</script>
	</head>
	<body>
	<div align="center" style="width:100%;" >
	<form name="partialcopyfrm_1"  id="partialcopyfrm_1" autocomplete="off">
		<table width="300" cellspacing="0" cellpadding="0" border="0"  align="center">
	    	<tr>
	         	<td align="left" width="60" class="must_entry_caption">Job No</td>
	            <td  width="150">
	            	<input type="hidden" id="txt_main_job_no_hidden" name="txt_main_job_no_hidden" class="text_boxes" style="width:150px;" value="<? echo $txt_job_no; ?>" />
	                <input type="hidden" id="hidd_job_id" name="hidd_job_id" class="text_boxes" style="width:100px;" value="<? echo $hidd_job_id; ?>" />
	                <input type="hidden" id="hidd_cons_variable" name="hidd_cons_variable" value="<?=$cons_variable; ?>" />
	            	<input type="text" id="txt_popup_job_no" name="txt_popup_job_no" class="text_boxes" style="width:150px;" />
	            </td>
	            <td align="right" width="60">
	             	<input type="button" id="pre_cost_copy_btn" class="formbutton" value="Copy" onClick="fnc_copy_pre_cost()" />
	            </td>
	        </tr>
	    </table>
	    </form>
	   </div>
	</body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}
// END  partial pre cost copy popup action//
//START  partial pre cost copy SAVE action here...............................
if($action=="save_partial_pre_cost_copy") // Save here....
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$datas=explode('*',$datas);
	$popup_job_no=$datas[0];
	$main_job_no=$datas[1];
	$hidd_job_id=$datas[2];
	$cons_variable=$datas[3];
	//echo 'got it';
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}

	$flag=1;
	$fabric_cost_id_maping=array();
	$trims_cost_id_maping=array();
	//echo "select id from wo_pre_cost_fabric_cost_dtls  where job_no='$popup_job_no' and status_active=1 and is_deleted=0 order by id ASC"; die;
	if($cons_variable==1) $fabConsRateAmt="avg_cons, rate, amount, avg_finish_cons, avg_process_loss,"; else if($cons_variable==2) $fabConsRateAmt="0 as avg_cons, 0 as rate, 0 as amount, 0 as avg_finish_cons, 0 as avg_process_loss,";
	$sql_se_set_2=sql_select("select id from wo_pre_cost_fabric_cost_dtls  where job_no='$popup_job_no' and status_active=1 and is_deleted=0 order by id ASC");
	foreach($sql_se_set_2 as $row_se_set)
	{
		$id2=return_next_id( "id", "wo_pre_cost_fabric_cost_dtls", 1 );		
		$sql_insert_22="insert into  wo_pre_cost_fabric_cost_dtls (id, job_id, job_no, item_number_id, body_part_id, fab_nature_id, color_type_id, lib_yarn_count_deter_id, construction, composition, fabric_description, gsm_weight, color_size_sensitive, color, fabric_source, avg_cons, rate, amount, avg_finish_cons, avg_process_loss, company_id, costing_per, consumption_basis, process_loss_method, cons_breack_down, msmnt_break_down, color_break_down, yarn_breack_down, marker_break_down, width_dia_type, gsm_weight_type, avg_cons_yarn, gsm_weight_yarn, plan_cut_qty, job_plan_cut_qty, is_apply_last_update, uom, body_part_type, nominated_supp_multi, sample_id, inserted_by, insert_date, status_active, is_deleted,budget_on)
		 
		select $id2, '".$hidd_job_id."', '".$main_job_no."', item_number_id, body_part_id, fab_nature_id, color_type_id, lib_yarn_count_deter_id, construction, composition, fabric_description, gsm_weight, color_size_sensitive, color, fabric_source, $fabConsRateAmt company_id, costing_per, consumption_basis, process_loss_method, cons_breack_down, msmnt_break_down, color_break_down, yarn_breack_down, marker_break_down, width_dia_type, gsm_weight_type, avg_cons_yarn, gsm_weight_yarn, plan_cut_qty, job_plan_cut_qty, is_apply_last_update, uom, body_part_type, nominated_supp_multi, sample_id, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', status_active, is_deleted, budget_on from wo_pre_cost_fabric_cost_dtls where job_no='$popup_job_no' and id=".$row_se_set[csf('id')]." and is_deleted=0";
		$rID2=execute_query($sql_insert_22,1);
		$fabric_cost_id_maping[$row_se_set[csf('id')]]=$id2;
		//echo $sql_insert_22; die;
	}
	$fabric_supplier= sql_select("SELECT id, job_id, job_no, fabric_id, supplier_id from wo_pre_cost_fabric_supplier where job_no='$popup_job_no' and status_active=1 and is_deleted=0");
	foreach ($fabric_supplier as $row) {
		$fabric_supplier_id=return_next_id( "id", "wo_pre_cost_fabric_supplier", 1);
		$sql_insert_fabric_supplier = "Insert into wo_pre_cost_fabric_supplier (id, job_id, job_no, fabric_id, supplier_id, inserted_by, insert_date, status_active, is_deleted )
			SELECT $fabric_supplier_id, '".$hidd_job_id."', '".$main_job_no."', ".$fabric_cost_id_maping[$row[csf('fabric_id')]].", supplier_id, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', 1,0 from wo_pre_cost_fabric_supplier where job_no='$popup_job_no' and id=".$row[csf('id')]."";
			//echo $sql_insert_fabric_supplier; die;
		$rIDfsupp=execute_query($sql_insert_fabric_supplier,1);

	}
	if($cons_variable==1)
	{
		$cSizeArr=array();
		$sqlCZ="select b.id, min(c.id) as color_size_table_id, min(c.color_order) as color_order, min(c.size_order) as size_order, c.color_number_id, c.size_number_id from wo_po_break_down b, wo_po_color_size_breakdown c where b.id=c.po_break_down_id and b.job_no_mst='".$main_job_no."' and b.status_active=1 and c.status_active=1 and c.is_deleted=0 group by b.id, c.color_number_id, c.size_number_id order by b.id, color_order, size_order";
		$sqlCZRes=sql_select($sqlCZ);
		
		foreach($sqlCZRes as $czrow)
		{
			$cSizeArr[$czrow[csf('color_number_id')]][$czrow[csf('size_number_id')]][$czrow[csf('id')]][$czrow[csf('color_size_table_id')]]=$czrow[csf('color_size_table_id')];
		}
		$fabConsSql=sql_select("select id, pre_cost_fabric_cost_dtls_id, color_number_id, gmts_sizes, dia_width, item_size from wo_pre_cos_fab_co_avg_con_dtls where job_no='$popup_job_no' and status_active=1 and is_deleted=0 order by id");
		foreach($fabConsSql as $frow)
		{
			foreach($cSizeArr[$frow[csf('color_number_id')]][$frow[csf('gmts_sizes')]] as $poid=>$podata)
			{
				foreach($podata as $color_size_table_id)
				{
					if($color_size_table_id!="")
					{
						$fabcon_tbl_id=return_next_id( "id", "wo_pre_cos_fab_co_avg_con_dtls", 1) ;
						$sql_insert_fabcons_avg="insert into wo_pre_cos_fab_co_avg_con_dtls (id, job_id, pre_cost_fabric_cost_dtls_id, job_no, po_break_down_id, color_number_id, gmts_sizes, dia_width, item_size, cons, process_loss_percent, requirment, pcs, color_size_table_id, body_length, body_sewing_margin, body_hem_margin, sleeve_length, sleeve_sewing_margin, sleeve_hem_margin, half_chest_length, half_chest_sewing_margin, front_rise_length, front_rise_sewing_margin, west_band_length, west_band_sewing_margin, in_seam_length, in_seam_sewing_margin, in_seam_hem_margin, half_thai_length, half_thai_sewing_margin, total, marker_dia, marker_yds, marker_inch, gmts_pcs, marker_length, net_fab_cons, rate, amount, length, inserted_by, insert_date, status_active, is_deleted, length_sleeve, width_sleeve )
						select $fabcon_tbl_id, '".$hidd_job_id."', ".$fabric_cost_id_maping[$frow[csf('pre_cost_fabric_cost_dtls_id')]].", '".$main_job_no."', '".$poid."', color_number_id, gmts_sizes, dia_width, item_size, cons, process_loss_percent, requirment, pcs,'".$color_size_table_id."', body_length, body_sewing_margin, body_hem_margin, sleeve_length, sleeve_sewing_margin, sleeve_hem_margin, half_chest_length, half_chest_sewing_margin, front_rise_length, front_rise_sewing_margin, west_band_length, west_band_sewing_margin, in_seam_length, in_seam_sewing_margin, in_seam_hem_margin, half_thai_length, half_thai_sewing_margin, total, marker_dia, marker_yds, marker_inch, gmts_pcs, marker_length, net_fab_cons, rate, amount, length, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', 1, 0, length_sleeve, width_sleeve from wo_pre_cos_fab_co_avg_con_dtls where job_no='$popup_job_no' and id=".$frow[csf('id')]."";
						//echo $sql_insert_fabcons_avg.'<br>';
						
						$rIDfCons=execute_query($sql_insert_fabcons_avg,0);
						//oci_commit($con);
					}
				}
			}
		}
	}

	//wo_pre_cost_fab_conv_cost_dtls
	if($cons_variable==1) $convConsRateAmt="req_qnty, charge_unit, amount, color_break_down, charge_lib_id, avg_req_qnty, process_loss,"; else if($cons_variable==2) $convConsRateAmt="0 as req_qnty, 0 as charge_unit, 0 as amount, 0 as color_break_down, 0 as charge_lib_id, 0 as avg_req_qnty, 0 as process_loss,";
	$sql_se_set_4=sql_select("select id, fabric_description from wo_pre_cost_fab_conv_cost_dtls where job_no='$popup_job_no' and status_active=1 and is_deleted=0 order by id ASC");
	foreach($sql_se_set_4 as $row_se_set)
	{
		$id4=return_next_id( "id", "wo_pre_cost_fab_conv_cost_dtls", 1 );	
		
		$sql_insert_44="insert into  wo_pre_cost_fab_conv_cost_dtls (id, job_id, job_no, fabric_description, cons_process, req_qnty, charge_unit, amount, color_break_down, charge_lib_id, avg_req_qnty, process_loss, inserted_by, insert_date, status_active, is_deleted) 
		select $id4, '".$hidd_job_id."', '".$main_job_no."', '".$fabric_cost_id_maping[$row_se_set[csf('fabric_description')]]."', cons_process, $convConsRateAmt ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', status_active, is_deleted from  wo_pre_cost_fab_conv_cost_dtls where job_no='$popup_job_no' and id=".$row_se_set[csf('id')]." and is_deleted=0";
		$rID4=execute_query($sql_insert_44,1);
		//echo $sql_insert_44;
	}
	//wo_pre_cost_trim_cost_dtls
	if($cons_variable==1) $trimConsRateAmt="cons_dzn_gmts, rate, amount,"; else if($cons_variable==2) $trimConsRateAmt="0 as cons_dzn_gmts, 0 as rate, 0 as amount,";
	$sql_se_set_5=sql_select("select id from wo_pre_cost_trim_cost_dtls  where job_no='$popup_job_no' and status_active=1 and is_deleted=0 order by id ASC");
	foreach($sql_se_set_5 as $row_se_set)
	{
		$id5=return_next_id( "id", "wo_pre_cost_trim_cost_dtls", 1 );		
		$sql_insert_55="insert into  wo_pre_cost_trim_cost_dtls (id, job_id, job_no, trim_group, description, brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp, cons_breack_down, remark, country, seq, calculatorstring, unit_price, inco_term, add_price, inserted_by, insert_date, status_active, is_deleted, nominated_supp_multi) 
		select $id5, '".$hidd_job_id."', '".$main_job_no."', trim_group, description, brand_sup_ref, cons_uom, $trimConsRateAmt apvl_req, nominated_supp, cons_breack_down, remark, country, seq, calculatorstring, unit_price, inco_term, add_price, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', status_active, is_deleted, nominated_supp_multi from wo_pre_cost_trim_cost_dtls where job_no='$popup_job_no' and id=".$row_se_set[csf('id')]." and is_deleted=0";
		$rID5=execute_query($sql_insert_55,1);
		$trims_cost_id_maping[$row_se_set[csf('id')]]=$id5;
		//echo $sql_insert_55;
	}

	$trim_supplier= sql_select("SELECT id, job_id, job_no, trimid, supplier_id from wo_pre_cost_trim_supplier where job_no='$popup_job_no' and status_active=1 and is_deleted=0");
	//echo "10**SELECT id, job_id, job_no, trimid, supplier_id from wo_pre_cost_trim_supplier where job_no='$popup_job_no' and status_active=1 and is_deleted=0"; die;
	foreach ($trim_supplier as $row) {
		$trim_supplier_id=return_next_id( "id", "wo_pre_cost_trim_supplier", 1);
		$sql_insert_trim_supplier = "Insert into wo_pre_cost_trim_supplier (id, job_id, job_no, trimid, supplier_id, inserted_by, insert_date, status_active, is_deleted )
			SELECT $trim_supplier_id, '".$hidd_job_id."', '".$main_job_no."', ".$trims_cost_id_maping[$row[csf('trimid')]].", supplier_id, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', 1,0 from wo_pre_cost_trim_supplier where job_no='$popup_job_no' and id=".$row[csf('id')]."";
			//echo $sql_insert_trim_supplier; die;
		$rIDtsupp=execute_query($sql_insert_trim_supplier,1);

	}

	if($cons_variable==1)
	{
		$trimConsSql=sql_select("select id, wo_pre_cost_trim_cost_dtls_id, item_number_id, color_number_id, size_number_id, item_size, item_color_number_id, country_id from wo_pre_cost_trim_co_cons_dtls where job_no='$popup_job_no' and status_active=1 and is_deleted=0");
		foreach($trimConsSql as $trow)
		{
			foreach($cSizeArr[$trow[csf('color_number_id')]][$trow[csf('size_number_id')]] as $poid=>$podata)
			{
				foreach($podata as $color_size_table_id)
				{
					if($color_size_table_id!="")
					{
						$trimcon_tbl_id=return_next_id( "id", "wo_pre_cost_trim_co_cons_dtls", 1) ;
						$sql_insert_trimcons_avg="insert into wo_pre_cost_trim_co_cons_dtls (id, job_id, wo_pre_cost_trim_cost_dtls_id, job_no, po_break_down_id, item_size, cons, place, pcs, country_id, excess_per, tot_cons, ex_cons, item_number_id, color_number_id, item_color_number_id, size_number_id, rate, amount, gmts_pcs, color_size_table_id, inserted_by, insert_date, status_active, is_deleted)
			select $trimcon_tbl_id, '".$hidd_job_id."', ".$trims_cost_id_maping[$trow[csf('wo_pre_cost_trim_cost_dtls_id')]].", '".$main_job_no."', '".$poid."', item_size, cons, place, pcs, country_id, excess_per, tot_cons, ex_cons, item_number_id, color_number_id, item_color_number_id, size_number_id, rate, amount, gmts_pcs, '".$color_size_table_id."',".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', 1, 0 from wo_pre_cost_trim_co_cons_dtls where job_no='$popup_job_no' and id=".$trow[csf('id')]."";
						//echo "10**".$sql_insert_trimcons_avg; die;
						
						$rIDtCons=execute_query($sql_insert_trimcons_avg,0);
						//oci_commit($con);
					}
				}
			}
		}
	}
	//wo_pre_cost_embe_cost_dtls
	if($cons_variable==1) $embConsRateAmt="cons_dzn_gmts, rate, amount,"; else if($cons_variable==2) $embConsRateAmt="0 as cons_dzn_gmts, 0 as rate, 0 as amount,";
	$sql_se_set_6=sql_select("select id from wo_pre_cost_embe_cost_dtls  where job_no='$popup_job_no' and status_active=1 and is_deleted=0 order by id ASC");
	foreach($sql_se_set_6 as $row_se_set)
	{
		$id6=return_next_id( "id", "wo_pre_cost_embe_cost_dtls", 1 );		
		$sql_insert_66="insert into wo_pre_cost_embe_cost_dtls (id, job_id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount, charge_lib_id, budget_on, supplier_id, country, body_part_id, inserted_by, insert_date, status_active, is_deleted) 
		select $id6, '".$hidd_job_id."', '".$main_job_no."', emb_name, emb_type, $embConsRateAmt charge_lib_id, budget_on, supplier_id, country, body_part_id, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', status_active, is_deleted from wo_pre_cost_embe_cost_dtls where job_no = '$popup_job_no' and id=".$row_se_set[csf('id')]." and is_deleted=0";
		$rID6=execute_query($sql_insert_66,1);
		$emb_cost_id_maping[$row_se_set[csf('id')]] = $id6;
		//echo $sql_insert_66;
	}
	if($cons_variable==1)
	{
		//echo "10**";
		$embConsSql=sql_select("select id, pre_cost_emb_cost_dtls_id, item_number_id, color_number_id, size_number_id, requirment, rate, amount, color_size_table_id, country_id from wo_pre_cos_emb_co_avg_con_dtls where job_no='$popup_job_no' and status_active=1 and is_deleted=0 order by id");
		foreach($embConsSql as $erow)
		{
			foreach($cSizeArr[$erow[csf('color_number_id')]][$erow[csf('size_number_id')]] as $poid=>$podata)
			{
				foreach($podata as $color_size_table_id)
				{
					if($color_size_table_id!="")
					{
						$embcon_tbl_id=return_next_id( "id", "wo_pre_cos_emb_co_avg_con_dtls", 1) ;
						$sql_insert_embcons_avg="insert into wo_pre_cos_emb_co_avg_con_dtls (id, job_id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id, item_number_id, color_number_id, size_number_id, requirment, rate, amount, gmts_pcs, color_size_table_id, rate_lib_id, country_id, inserted_by, insert_date, status_active, is_deleted)
			select $embcon_tbl_id, '".$hidd_job_id."', '".$emb_cost_id_maping[$erow[csf('pre_cost_emb_cost_dtls_id')]]."', '".$main_job_no."', '".$poid."', item_number_id, color_number_id, size_number_id, requirment, rate, amount, gmts_pcs, '".$color_size_table_id."', rate_lib_id, country_id, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', 1, 0 from wo_pre_cos_emb_co_avg_con_dtls where job_no='$popup_job_no' and id=".$erow[csf('id')]."";
						//echo $sql_insert_embcons_avg.'<br>';
						
						$rIDeCons=execute_query($sql_insert_embcons_avg,0);
						//oci_commit($con);
					}
				}
			}
		}
	}
	//wo_pre_cost_comarci_cost_dtls
	$sql_se_set_7=sql_select("select id from wo_pre_cost_comarci_cost_dtls  where job_no='$popup_job_no' and status_active=1 and is_deleted=0 order by id ASC");
	foreach($sql_se_set_7 as $row_se_set)
	{
		$id7=return_next_id( "id", "wo_pre_cost_comarci_cost_dtls", 1 );
		
		$sql_insert_77="insert into wo_pre_cost_comarci_cost_dtls (id, job_id, job_no, item_id, rate, amount, inserted_by, insert_date, status_active, is_deleted) select $id7, '".$hidd_job_id."', '".$main_job_no."', item_id, rate, amount, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', status_active, is_deleted from  wo_pre_cost_comarci_cost_dtls where job_no = '$popup_job_no' and id=".$row_se_set[csf('id')]." and is_deleted=0";
		$rID7=execute_query($sql_insert_77,1);
		//echo $sql_insert_77;
	}
	//wo_pre_cost_commiss_cost_dtls
	$sql_se_set_8=sql_select("select id from wo_pre_cost_commiss_cost_dtls  where job_no='$popup_job_no' and status_active=1 and is_deleted=0 order by id ASC");
	foreach($sql_se_set_8 as $row_se_set)
	{
		$id8=return_next_id( "id", "wo_pre_cost_commiss_cost_dtls", 1 );
		 $sql_insert_88="insert into wo_pre_cost_commiss_cost_dtls (id, job_id, job_no, particulars_id, commission_base_id, commision_rate, commission_amount, inserted_by, insert_date, status_active, is_deleted) 
		select $id8, '".$hidd_job_id."', '".$main_job_no."', particulars_id, commission_base_id, commision_rate, commission_amount, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', status_active, is_deleted from wo_pre_cost_commiss_cost_dtls where job_no='$popup_job_no' and id=".$row_se_set[csf('id')]." and is_deleted=0";
		$rID8=execute_query($sql_insert_88,1);
		//echo $sql_insert_88;
	}
	//echo "10**".$rID2.'--'.$rID3.'--'.$rID4.'--'.$rID5.'--'.$rID6.'--'.$rID7.'--'.$rID8; die;

	if($db_type==0)
	{
		if( $rID2 || $rID3 || $rID4 || $rID5 || $rID6 || $rID7 || $rID8 ){
			mysql_query("COMMIT");
			echo "0**".$rID2.'*'.$rID3.'*'.$rID4.'*'.$rID5.'*'.$rID6.'*'.$rID7.'*'.$rID8;
		}
		else
		{
			mysql_query("ROLLBACK");
			echo "10**".$rID1;
		}
	}
	if($db_type==2 || $db_type==1 )
		{
			if( $rID2 || $rID3 || $rID4 || $rID5 || $rID6 || $rID7 || $rID8 )
			{
				oci_commit($con);
				echo "0**".$rID2.'*'.$rID3.'*'.$rID4.'*'.$rID5.'*'.$rID6.'*'.$rID7.'*'.$rID8;
			}
			else
			{
				oci_rollback($con);
				echo "10**".$rID2.'*'.$rID3.'*'.$rID4.'*'.$rID5.'*'.$rID6.'*'.$rID7.'*'.$rID8;
			}
		}
	disconnect($con);
	die;

}
// END partial pre cost copy SAVE action here...............................


if($action=="check_data_mismass")
{
	$user_library=return_library_array( "select id,user_name from user_passwd", "id", "user_name"  );

	$isorder_change=return_field_value("isorder_change","wo_pre_cost_mst","job_no='".$data."' and is_deleted=0 and status_active=1");
	if($isorder_change==1)
	{
		$sql_check=sql_select("select Max(a.update_date) as cst_update_date, Max(a.updated_by) as cst_updated_by, Max(b.update_date) as fct_update_date, Max(b.updated_by) as fct_updated_by,Max(b.is_apply_last_update) as is_apply_last_update from wo_po_color_size_breakdown a, wo_pre_cost_fabric_cost_dtls b where a.job_no_mst=b.job_no and a.job_no_mst='$data'  and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 group by a.job_no_mst");
		$chk_msg='';
		foreach($sql_check as $check_row)
		{
			if($check_row[csf("is_apply_last_update")]==2)
			{
				$check_input=1; $fabric_msg=" Fabric, "; $chk_msg=1;
				$cst_update_date=date('d-m-Y',strtotime($check_row[csf("cst_update_date")]));
				$cst_update_time = date('g:i:s A',strtotime($check_row[csf("cst_update_date")]));
				$fct_update_date=date('d-m-Y',strtotime($check_row[csf("fct_update_date")]));
				$fct_update_time = date('g:i:s A',strtotime($check_row[csf("fct_update_date")]));
	
				$pre_cost_up="";
				if($check_row[csf("fct_update_date")] !="" && $check_row[csf("fct_update_date")] !="0000-00-00" && $check_row[csf("fct_update_date")] !="0")
				{
					$pre_cost_up="PreCost is updated by ".ucfirst($user_library[$check_row[csf("fct_updated_by")]])." at ".$fct_update_time.", on ".$fct_update_date;
				}
				$sms="".ucfirst($user_library[$check_row[csf("cst_updated_by")]])." have changed Color Size Break Down at ".$cst_update_time.", on ".$cst_update_date.",".$pre_cost_up."  So You have to update Pre-cost.";
				echo "document.getElementById('check_sms').innerHTML = '".$sms."';\n";
				echo "document.getElementById('check_input').value = '".$check_input."';\n";
			}
			else
			{
				$sms="";
				$check_input=0;
				echo "document.getElementById('check_input').value = '".$check_input."';\n";
				echo "document.getElementById('check_sms').innerHTML = '".$sms."';\n";
			}
		}
		//Fabric ,Trims,Emblishment,Wash Synchronize check//If color size breakdown updated found
		$sql_trim=sql_select("select Max(b.is_apply_last_update) as is_apply_last_update  from  wo_pre_cost_trim_cost_dtls b where  b.job_no='$data' and b.is_deleted=0 and b.status_active=1");
		 
		$trim_msg="";
		foreach($sql_trim as $row)
		{
			if($row[csf("is_apply_last_update")]==2)
			{
				$trim_msg=" Trims,";
				$chk_msg=1; 
			}
		}
		$sql_conv=sql_select("select Max(b.is_apply_last_update) as is_apply_last_update  from  wo_pre_cost_fab_conv_cost_dtls b where  b.job_no='$data' and b.is_deleted=0 and b.status_active=1");
		 
		$conv_msg="";
		foreach($sql_conv as $row)
		{
			if($row[csf("is_apply_last_update")]==2)
			{
				$conv_msg=" Conversion,";
				$chk_msg=1; 
			}
		}
	
		$sql_embl=sql_select("select Max(b.is_apply_last_update) as is_apply_last_update,emb_name  from wo_pre_cost_embe_cost_dtls b where  b.job_no='$data' and b.is_deleted=0 and b.status_active=1 and cons_dzn_gmts>0 group by emb_name");
		 
		$emb_msg="";
		foreach($sql_embl as $row)
		{
			if($row[csf("is_apply_last_update")]==2 && $row[csf("emb_name")]==3) //Wash
			{
				$wash_msg=" Wash,";
				$chk_msg=1; 
			}
			else if($row[csf("is_apply_last_update")]==2 && $row[csf("emb_name")]!=3) 
			{
				$emb_msg=" Emblishment,";
				$chk_msg=1; 
			}
		}
		if($chk_msg==1)
		{
			$check_msg="Color size breakdown is updated. Please synchronize following heads: ";
			$check_msg.=$fabric_msg.$conv_msg.$trim_msg.$emb_msg.$wash_msg;
			echo "document.getElementById('check_sms2').innerHTML = '".$check_msg."';\n";
		}
		else
		{
			$check_msg="";
			echo "document.getElementById('check_sms2').innerHTML = '".$check_msg."';\n";
		}
	}
	exit();
}

if($action=="open_set_list_view")
{
	echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode,'','');
	extract($_REQUEST);
	?>
	<script>
	function js_set_value_set()
	{
		var rowCount = $('#tbl_set_details tr').length-1;
		var set_breck_down="";
		var smv_breck_down="";
		var item_id=""
		for(var i=1; i<=rowCount; i++)
		{
			if (form_validation('cboitem_'+i+'*txtsetitemratio_'+i,'Gmts Items*Set Ratio')==false)
			{
				return;
			}
			if(smv_breck_down=="")
			{
				smv_breck_down+=$('#cboitem_'+i).val()+'_'+$('#smv_'+i).val()+'_'+$('#smvset_'+i).val();
			}
			else
			{
				smv_breck_down+="__"+$('#cboitem_'+i).val()+'_'+$('#smv_'+i).val()+'_'+$('#smvset_'+i).val();
			}
		}
		var job_no=document.getElementById('job_no').value;
		var booking=return_global_ajax_value(job_no+"**"+smv_breck_down, 'update_smv', '', 'pre_cost_entry_controller_v2');
		document.getElementById('set_breck_down').value=smv_breck_down;
		parent.emailwindow.hide();
	}

	function calculate_set_smv(i)
	{
		var txtsetitemratio=document.getElementById('txtsetitemratio_'+i).value;
		var smv=document.getElementById('smv_'+i).value;
		var set_smv=txtsetitemratio*smv;
		document.getElementById('smvset_'+i).value=set_smv;
		set_sum_value_set( 'tot_set_qnty', 'txtsetitemratio_' );
		set_sum_value_set( 'tot_smv_qnty', 'smvset_' );
	}

	function set_sum_value_set(des_fil_id,field_id)
	{
		var rowCount = $('#tbl_set_details tr').length-1;
		if(des_fil_id=="tot_set_qnty")
		{
		math_operation( des_fil_id, field_id, '+', rowCount );
		}
		if(des_fil_id=="tot_smv_qnty")
		{
		var ddd={ dec_type:1, comma:0, currency:1}
		math_operation( des_fil_id, field_id, '+', rowCount,ddd );
		}
	}
	</script>
	</head>
	<body>
       <div id="set_details"  align="center">
        <fieldset>
            <form id="setdetails_1" autocomplete="off">
            <input type="hidden" id="set_breck_down" />
            <input type="hidden" id="item_id" />
            <input type="hidden" id="job_no" value="<? echo $txt_job_no; ?>" />
            <table width="400" cellspacing="0" class="rpt_table" border="0" id="tbl_set_details" rules="all">
                <thead>
                    <tr>
                        <th width="230">Item</th><th width="40">Set Ratio</th><th width="40">SMV/ Pcs</th><th width=""></th>
                    </tr>
                </thead>
                <tbody>
					<?
                    $tot_set_qnty=0;
                    $tot_smv_qnty=0;
                    $data_array=explode("__",$set_breck_down);

                    $data_array=sql_select("Select gmts_item_id,set_item_ratio,smv_pcs,smv_set,smv_pcs_precost,smv_set_precost from wo_po_details_mas_set_details where job_no='$txt_job_no'");

                    if ( count($data_array)>0)
                    {
						$i=0;
						foreach( $data_array as $row )
						{
							$i++;
							//$data=explode('_',$row);
							$smv_pcs_precost=0;
							$smv_set_precost=0;
							$tot_set_qnty=$tot_set_qnty+$row[csf("set_item_ratio")];
							if($row[csf("smv_set_precost")]>0 || $row[csf("smv_pcs_precost")]>0)
							{
								$smv_pcs_precost=$row[csf("smv_pcs_precost")];
								$smv_set_precost=$row[csf("smv_set_precost")];
								$tot_smv_qnty=$tot_smv_qnty+$row[csf("smv_set_precost")];
							}
							else
							{
								$smv_pcs_precost=$row[csf("smv_pcs")];
								$smv_set_precost=$row[csf("smv_set")];
								$tot_smv_qnty=$tot_smv_qnty+$row[csf("smv_set")];
							}
							?>
							<tr id="settr_1" align="center">
                                <td><? echo create_drop_down( "cboitem_".$i, 230, $garments_item, "",1,"-- Select Item --", $row[csf("gmts_item_id")], "",1,'' ); ?></td>
                                <td><input type="text" id="txtsetitemratio_<? echo $i;?>"   name="txtsetitemratio_<? echo $i;?>" style="width:80px"  class="text_boxes_numeric"   value="<? echo $row[csf("set_item_ratio")]; ?>"  readonly/></td>
                                <td>
                                    <input type="text" id="smv_<? echo $i;?>" name="smv_<? echo $i;?>" style="width:30px" class="text_boxes_numeric" onChange="calculate_set_smv(<? echo $i;?>)"  value="<? echo $smv_pcs_precost; ?>" disabled />
                                    <input type="hidden" id="smvset_<? echo $i;?>"   name="smvset_<? echo $i;?>" style="width:30px"  class="text_boxes_numeric"  value="<? echo $smv_set_precost; ?>" />
                                </td>
							</tr>
							<?
						}
                    }
                    else
                    {
						?>
						<tr id="settr_1" align="center">
							<td><? echo create_drop_down( "cboitem_1", 230, $garments_item, "",1,"--Select--", 0, '',1,'' ); ?></td>
							<td><input type="text" id="txtsetitemratio_1" name="txtsetitemratio_1" style="width:80px" class="text_boxes_numeric"  readonly /></td>
							<td>
                                <input type="text" id="smv_1" name="smv_1" style="width:30px" class="text_boxes_numeric" onChange="calculate_set_smv(1)"/>
                                <input type="hidden" id="smvset_1" name="smvset_1" style="width:30px" class="text_boxes_numeric"   value=""  />
							</td>
							<td>&nbsp;</td>
						</tr>
						<?
                    }
                    ?>
                </tbody>
            </table>
            <table width="400" cellspacing="0" class="rpt_table" border="0" rules="all">
                <tfoot>
                    <tr>
                        <th width="230">Total</th>
                        <th width="40"><input type="text" id="tot_set_qnty" name="tot_set_qnty"  class="text_boxes_numeric" style="width:80px"  value="<? echo $tot_set_qnty; ?>" readonly  /></th>
                        <th width="40"><input type="text" id="tot_smv_qnty" name="tot_smv_qnty" class="text_boxes_numeric" style="width:30px"  value="<? if($tot_smv_qnty !=''){ echo $tot_smv_qnty;} else{ echo 1;} ?>" readonly /></th>
                        <th>&nbsp;</th>
                    </tr>
                </tfoot>
            </table>
            <table width="400" cellspacing="0" class="" border="0">
                <tr><td align="center" height="15" width="100%">&nbsp;</td></tr>
                <tr>
                    <td align="center" width="100%" class="button_container"><input type="button" class="formbutton" value="Close" onClick="js_set_value_set()"/></td>
                </tr>
            </table>
            </form>
        </fieldset>
        </div>
	 </body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}

if($action=='update_smv')
{
	$data=explode("**",$data);
	$data_array=explode("__",$data[1]);
	if ( count($data_array)>0)
	{
		$i=0;
		foreach( $data_array as $row )
		{
			$i++;
			$data_smv=explode('_',$row);
			$con = connect();
			if($db_type==0)
			{
				mysql_query("BEGIN");
			}
			$rID_de1=execute_query( "update wo_po_details_mas_set_details set smv_pcs_precost='$data_smv[1]',smv_set_precost='$data_smv[2]',smv_pcs='$data_smv[1]',smv_set='$data_smv[2]'  where  job_no ='".$data[0]."' and gmts_item_id=".$data_smv[0]."",0);
			if($db_type==0)
			{
				if($rID_de1==1){
					mysql_query("COMMIT");
					//echo "0**".$rID."**".str_replace("'","",$txt_job_no);
				}
				else{
					mysql_query("ROLLBACK");
					//echo "10**".$rID."**".str_replace("'","",$txt_job_no);
				}
			}
			else if($db_type==2 || $db_type==1 )
			{
				if($rID_de1==1){
					oci_commit($con);
					//echo "0**".$rID."**".str_replace("'","",$txt_job_no);
				}
				else{
					oci_rollback($con);
					//echo "10**".$rID."**".str_replace("'","",$txt_job_no);
				}
			}
			disconnect($con);
		}
	}

	$job_no="'".$data[0]."'";

	$sql_d=sql_select('Select gmts_item_id AS "gmts_item_id",set_item_ratio AS "set_item_ratio",smv_pcs AS "smv_pcs",smv_set AS "smv_set",complexity AS "complexity",embelishment AS "embelishment", cutsmv_pcs AS "cutsmv_pcs", cutsmv_set AS "cutsmv_set", finsmv_pcs AS "finsmv_pcs", finsmv_set AS "finsmv_set",printseq AS "printseq",embro AS "embro",embroseq AS "embroseq",wash AS "wash",washseq AS "washseq",spworks AS "spworks" ,spworksseq AS "spworksseq",gmtsdying AS "gmtsdying",gmtsdyingseq AS "gmtsdyingseq",ws_id as "ws_id" from wo_po_details_mas_set_details where job_no='.$job_no.' order by id');
	foreach($sql_d as $sql_r){
		if($sql_r['gmts_item_id']=="") $sql_r['gmts_item_id']=0;
		if($sql_r['set_item_ratio']=="") $sql_r['set_item_ratio']=0;
		if($sql_r['smv_pcs']=="") $sql_r['smv_set']=0;
		if($sql_r['complexity']=="") $sql_r['complexity']=0;
		if($sql_r['embelishment']=="") $sql_r['embelishment']=0;
		if($sql_r['cutsmv_pcs']==""){
			$sql_r['cutsmv_pcs']=0;
			$sql_r['cutsmv_set']=0;
		}
		if($sql_r['finsmv_pcs']==""){
			$sql_r['finsmv_pcs']=0;
			$sql_r['finsmv_set']=0;
		}
		if($sql_r['printseq']=="") $sql_r['printseq']=0;
		if($sql_r['embro']=="") $sql_r['embro']=0;
		if($sql_r['embroseq']=="") $sql_r['embroseq']=0;

		if($sql_r['wash']=="") $sql_r['wash']=0;
		if($sql_r['washseq']=="") $sql_r['washseq']=0;

		if($sql_r['spworks']=="") $sql_r['spworks']=0;
		if($sql_r['spworksseq']=="") $sql_r['spworksseq']=0;

		if($sql_r['gmtsdying']=="") $sql_r['gmtsdying']=0;
		if($sql_r['gmtsdyingseq']=="") $sql_r['gmtsdyingseq']=0;
		if($sql_r['ws_id']=="") $sql_r['ws_id']=0;

		$sql_r=removenumeric($sql_r);
		$smv_arr[]=implode("_",$sql_r);
	}
	$smv_srt=rtrim(implode("__",$smv_arr),"__");
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}
	$rID3=execute_query( "update  wo_po_details_master set set_break_down='$smv_srt'  where  job_no =".$job_no."",1);
	if($db_type==0)
	{
		if($rID3==1){
			mysql_query("COMMIT");
		}
		else{
			mysql_query("ROLLBACK");
		}
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($rID3==1){
			oci_commit($con);
		}
		else{
			oci_rollback($con);
		}
	}
	disconnect($con);
}

if($action=='is_used_costing_per')
{
	$sql_data=sql_select("select count(a.id) as id, a.costing_per from  wo_pre_cost_mst a, wo_pre_cost_fabric_cost_dtls b, wo_pre_cost_dtls c where a.job_no=b.job_no and a.job_no=c.job_no and a.job_no='$data' and a.is_deleted=0 and  a.status_active=1 and b.is_deleted=0 and b.status_active=1 group by a.job_no,a.costing_per");
	$id=0;
	$costing_per=0;
	foreach($sql_data as $row)
	{
		$id=$row[csf('id')];
		$costing_per=$row[csf('costing_per')];
	}
	echo trim($id)."_".trim($costing_per);
	die;
}

if($action=='is_booking_found')
{
	$sql_data=sql_select("select count(a.id) as id,a.booking_no from  wo_booking_mst a, wo_booking_dtls b where a.job_no=b.job_no and a.booking_no=b.booking_no  and a.job_no='$data' and a.is_deleted=0 and  a.status_active=1 and b.is_deleted=0 and b.status_active=1 group by a.booking_no");
	$id=0;
	$booking_no=array();
	foreach($sql_data as $row)
	{
		$id=$row[csf('id')];
		$booking_no[]=$row[csf('booking_no')];
	}
	echo trim($id)."_".implode(",",$booking_no);
	die;
}

if($action=='delete_costing')
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}
	$rID_de1=execute_query( "update  wo_pre_cost_dtls set status_active=0, is_deleted=1 where  job_no ='$data'",0);
	$rID_de1=execute_query( "update  wo_pre_cost_fabric_cost_dtls set status_active=0, is_deleted=1 where  job_no ='$data'",0);

	$rID_de1=execute_query( "update  wo_pre_cost_fab_yarn_cost_dtls set status_active=0, is_deleted=1 where  job_no ='$data'",0);
	$rID_de1=execute_query( "update   wo_pre_cost_fab_conv_cost_dtls set status_active=0, is_deleted=1 where  job_no ='$data'",0);


	$rID_de1=execute_query( "update  wo_pre_cost_trim_cost_dtls set status_active=0, is_deleted=1 where  job_no ='$data'",0);
	$rID_de1=execute_query( "update  wo_pre_cost_embe_cost_dtls set status_active=0, is_deleted=1 where  job_no ='$data'",0);

	if($db_type==0)
	{
		if($rID_de1)
		{
			mysql_query("COMMIT");
			echo 0;
		}
		else
		{
			mysql_query("ROLLBACK");
			echo 10;
		}
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($rID_de1)
		{
			oci_commit($con);
			echo 0;
		}
		else
		{
			oci_rollback($con);
			echo 10;
		}
	}
	disconnect($con);
	die;
}

if($action=='active_costing')
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}
	$rID_de1=execute_query( "update  wo_pre_cost_dtls set status_active=1, is_deleted=0 where  job_no ='$data'",0);
	$rID_de1=execute_query( "update  wo_pre_cost_fabric_cost_dtls set status_active=1, is_deleted=0 where  job_no ='$data'",0);
	$rID_de1=execute_query( "update  wo_pre_cost_fab_yarn_cost_dtls set status_active=1, is_deleted=0 where  job_no ='$data'",0);
	$rID_de1=execute_query( "update   wo_pre_cost_fab_conv_cost_dtls set status_active=1, is_deleted=0 where  job_no ='$data'",0);

	$rID_de1=execute_query( "update  wo_pre_cost_trim_cost_dtls set status_active=1, is_deleted=0 where  job_no ='$data'",0);
	$rID_de1=execute_query( "update  wo_pre_cost_embe_cost_dtls set status_active=1, is_deleted=0 where  job_no ='$data'",0);
	if($db_type==0)
	{
		if($rID_de1)
		{
			mysql_query("COMMIT");
			echo 0;
		}

		else
		{
			mysql_query("ROLLBACK");
			echo 10;
		}
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($rID_de1)
		{
			oci_commit($con);
			echo 0;
		}
		else
		{
			oci_rollback($con);
			echo 10;
		}
	}
	disconnect($con);
	die;
}

if($action=='delete_costing_permanently')
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}

	$rID_de1=execute_query( "delete from wo_pre_cost_fabric_cost_dtls where job_no ='$data'",0);
	$rID_de1=execute_query( "delete from wo_pre_cos_fab_co_avg_con_dtls where job_no ='$data'",0);
	$rID_de1=execute_query( "delete from wo_pre_cos_fab_co_color_dtls where job_no ='$data'",0);

	$rID_de1=execute_query( "delete from wo_pre_cost_fab_yarn_cost_dtls where job_no ='$data'",0);
	$rID_de1=execute_query( "delete from wo_pre_cost_fab_yarnbreakdown where job_no ='$data'",0);

	$rID_de1=execute_query( "delete from wo_pre_cost_fab_conv_cost_dtls where job_no ='$data'",0);

	$rID_de1=execute_query( "delete from wo_pre_cost_trim_cost_dtls where job_no ='$data'",0);
	$rID_de1=execute_query( "delete from wo_pre_cost_trim_co_cons_dtls where job_no ='$data'",0);

	$rID_de1=execute_query( "delete from wo_pre_cost_embe_cost_dtls where job_no ='$data'",0);

	$rID_de1=execute_query( "delete from wo_pre_cost_comarci_cost_dtls where job_no ='$data'",0);
	$rID_de1=execute_query( "delete from wo_pre_cost_commiss_cost_dtls where job_no ='$data'",0);

	$rID_de1=execute_query( "delete from wo_pre_cost_dtls where job_no ='$data'",0);
	$rID_de1=execute_query( "delete from wo_pre_cost_sum_dtls where job_no ='$data'",0);
	if($db_type==0)
	{
		if($rID_de1)
		{
			mysql_query("COMMIT");
			echo 0;
		}
		else
		{
			mysql_query("ROLLBACK");
			echo 10;
		}
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($rID_de1)
		{
			oci_commit($con);
			echo 0;
		}
		else
		{
			oci_rollback($con);
			echo 10;
		}
	}

	disconnect($con);
	die;
}

if($action=='check_is_master_part_saved')
{
	$job_no=return_field_value("job_no", "wo_pre_cost_mst","job_no='$data' and status_active =1 and is_deleted=0");
	echo $job_no;
}

if($action=='appSubmission_withoutanyChange')
{
	$con = connect();
	if($db_type==0) mysql_query("BEGIN");
	$flag=1;
	$exdata=explode("**",$data);
	$jobNo=$exdata[0];
	$jobId=$exdata[1];
	$ready_to_approved=$exdata[2];
	$pre_cost_id=$exdata[3];
	$txt_fabric_pre_cost=$exdata[4]*1;
	
	$company_id=$exdata[5];
	
	$cost_mendatorySql=sql_select("select variable_list, excut_source, cm_cost_compulsory from variable_order_tracking where company_name='$company_id' and variable_list in (22,27) and status_active=1 and is_deleted=0");
	
	$commercial_costmendatory=$cm_costmendatory=0;
	
	foreach($cost_mendatorySql as $row)
	{
		if($row[csf('variable_list')]==27 && $row[csf('excut_source')]==1) $commercial_costmendatory=$row[csf('excut_source')];
		if($row[csf('variable_list')]==22 && $row[csf('cm_cost_compulsory')]==1) $cm_costmendatory=$row[csf('cm_cost_compulsory')];
	}
	
	if($ready_to_approved==1)
	{
		if($commercial_costmendatory==1)//ISD-24-00665
		{
			$commercial_costamt=0;
			$data_array=sql_select("select sum(amount) as comlamt from wo_pre_cost_comarci_cost_dtls where job_no='$jobNo' and status_active=1 and is_deleted=0 group by job_no");
			
			$commercial_costamt=$data_array[0][csf('comlamt')]*1;
			
			if($commercial_costamt=="" || $commercial_costamt==0)
			{
				echo "commercial***".str_replace("'","",$jobNo);
				die;
			}
		}
		
		if($cm_costmendatory==1)//ISD-24-00665
		{
			$cm_costamt=0;
			$data_array=sql_select("select sum(CM_COST) as CM_COST from WO_PRE_COST_DTLS where job_no='$jobNo' and status_active=1 and is_deleted=0 group by job_no");
			
			$cm_costamt=$data_array[0]['CM_COST']*1;
			
			if($cm_costamt=="" || $cm_costamt==0)
			{
				echo "cmcost***".str_replace("'","",$jobNo);
				die;
			}
		}
	}
	
	$insDate="15-May-2020";
	
	$isBomInsDate=return_field_value("job_no", "wo_pre_cost_mst", "job_no='$jobNo' and insert_date>'$insDate' and status_active=1 and is_deleted=0");
	/*echo "10**".$isBomInsDate; //die;
	echo "select job_no from wo_pre_cost_mst where job_no='$jobNo' and insert_date>'$insDate' and status_active=1 and is_deleted=0";
	die;*/
	
	$imageArray=sql_select( "select id, image_location, master_tble_id, details_tble_id, form_name, file_type, real_file_name from common_photo_library where master_tble_id='$pre_cost_id' and form_name='pre_cost_v2' and file_type=2");
	//echo "10**".$_SESSION['logic_erp']['mandatory_field'][158][5].'--'.count($imageArray).'--'.$txt_fabric_pre_cost.'--'.$isBomInsDate; die;
	
	if($_SESSION['logic_erp']['mandatory_field'][158][5]!= '' && count($imageArray) == 0 && $txt_fabric_pre_cost>0 && $isBomInsDate!="")
	{
		echo "file**".str_replace("'","",$txt_job_no);
		die;
	}
	
	$approved=0;
	$sql=sql_select("select approved from wo_pre_cost_mst where job_no='$jobNo'");
	foreach($sql as $row){
		if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
	}
	if($approved==1){
		echo "approved***".str_replace("'","",$jobNo);
		die;
	}
	
	$id=return_next_id( "id", "wo_pre_cost_readyapp_his", 1);
	$field_array="id, job_no, job_id, updated_by, update_date";
	$data_array="(".$id.",'".$jobNo."','".$jobId."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."')";
	//echo "10**".$data_array; die;
	$rID=sql_insert("wo_pre_cost_readyapp_his",$field_array,$data_array,1);
	if($rID==1 && $flag==1) $flag=1; else $flag=0;
	//echo "10**insert into wo_pre_cost_readyapp_his (".$field_array.") Values ".$data_array."";die;
	
	$query="UPDATE wo_pre_cost_mst SET ready_to_approved=$ready_to_approved WHERE job_no='$jobNo' and status_active=1 and is_deleted=0";
	//echo "10**".$query;
	$rID1=execute_query($query,1);
	if($rID1==1 && $flag==1) $flag=1; else $flag=0;
	//echo "10**".$rID.'-'.$rID1.'-'.$flag; die;
	
	if($db_type==0)
	{
		if($flag==1)
		{

			mysql_query("COMMIT");
			echo "1***".$flag;
		}
		else
		{
			mysql_query("ROLLBACK");
			echo "10**".$flag;
		}
	}
	else if($db_type==2)
	{
		if($flag==1)
		{
			
			//App Notification....................................
			if($_SESSION['app_notification'] == 1){
				//$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
				$notification = new Notifications();
				if($ready_to_approved == 1){
					$job_sql_res = sql_select("select p.ID,p.COSTING_DATE,a.JOB_NO,d.COMPANY_NAME,a.COMPANY_NAME as COMPANY_ID, a.BUYER_NAME as BUYER_ID,b.BUYER_NAME,a.BRAND_ID,c.BRAND_NAME from WO_PRE_COST_MST p,WO_PO_DETAILS_MASTER a
					left join lib_buyer b on a.buyer_name = b.id left join LIB_BUYER_BRAND c on a.brand_id = c.id left join LIB_COMPANY d on a.company_name = d.id where  a.id = p.job_id and A.id = '$jobId'");
					foreach($job_sql_res as $row){

						$desc = "Company: ".$row['COMPANY_NAME'].",\nJob. No: ".$row['JOB_NO'].", \nCosting. date: ".date('d/m/Y',strtotime($row['COSTING_DATE']));
						$noti_data_arr = array(
							'ID' => $row['ID'],
							'DATE' => date('d/m/Y',strtotime($row['COSTING_DATE'])),
							'DELIVERY_DATE' => date('d/m/Y',strtotime($row['COSTING_DATE'])),
							'COMPANY' => $row['COMPANY_NAME'],
							'BUYER' => $row['BUYER_NAME'],
							'SYS_NUMBER' => $row['JOB_NO'],
							'SYS_DEF' => '',
							'DESC' => $desc,
							'MENU_ID' => return_field_value("page_id as menu_id","ELECTRONIC_APPROVAL_SETUP","entry_form=77","menu_id")
						);

						$approval_parameter = array('BUYER_ID' => $row['BUYER_ID'],'BRAND_ID' => $row['BRAND_ID'],
						'approval_data' => $noti_data_arr,
						'approval_desc' => 'Company :'.$row['COMPANY_NAME'].', Job :'.$row['JOB_NO'].', Buyer :'.$row['BUYER_NAME'].', Brand :'.$row['BRAND_NAME'] );
						$COMPANY_NAME = $row['COMPANY_ID'];
					}
					$not_res = $notification->notificationEngine($pre_cost_id,$COMPANY_NAME,77,$approval_parameter);
				}
				else{
					$appr_data = array("USER_ID"=>'',"SEQUENCE_NO" =>'',"COMPANY_ID"=> '','NOTIFICATION_TYPE'=>0,'approval_desc'=>'','approval_data'=>'');
						$not_res=$notification->pushAll($pre_cost_id,77,$appr_data);
						if($not_res == 1)
						{
							$query="DELETE FROM APPROVAL_NOTIFICATION_ENGINE  WHERE ENTRY_FORM=77 AND REF_ID IN ($pre_cost_id) ";
							$not_delete=execute_query($query,1);
						} 
				}

			}
			//.................................................end;
			
			oci_commit($con);
			echo "1***".$flag;
		}
		else
		{
			oci_rollback($con);
			echo "10**".$flag;
		}
	}
	disconnect($con);
	die;
}

if ($action=="save_update_delete")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$date= date('Y-m-d');
	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	if($is_copy_quatation==1)
	{
		$sql=sql_select("select b.approval_need, b.validate_page, b.allow_partial from approval_setup_mst a, approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
		if(count($sql)==0)
		{
			$sql=sql_select("select b.approval_need, b.validate_page, b.allow_partial from approval_setup_mst a, approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=28 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
		}
		$app_nessity=2; $validate_page=0; $allow_partial=2;
		foreach($sql as $row){
			$app_nessity=$row[csf('approval_need')];
			$validate_page=$row[csf('validate_page')];
			$allow_partial=$row[csf('allow_partial')];
		}
		
		$style_and_smv_source_comb =return_field_value("publish_shipment_date","variable_order_tracking","company_name=$cbo_company_name and variable_list=47 order by id", "publish_shipment_date");
		$txt_cost_control_source =return_field_value("cost_control_source","variable_order_tracking","company_name=$cbo_company_name and variable_list=53 order by id", "cost_control_source");
		if(str_replace("'","",$txt_cost_control_source)==2 && $style_and_smv_source_comb==4 &&  $app_nessity==1)
		{
			$sql=sql_select("select approved from wo_price_quotation where id=$txt_quotation_id");
			$quatation_approved=2;
			foreach($sql as $row){
				$quatation_approved=$row[csf('approved')];
			}
		
			if($app_nessity==1  && $validate_page==2){
				if($quatation_approved==2 || $quatation_approved==0 || $quatation_approved==3){
					echo "quataNotApp**".str_replace("'","",$txt_job_no);
					disconnect($con);die;
				}
			}
		}
		// echo "10**".'='.$txt_cost_control_source.'='.$style_and_smv_source_comb.'='.$app_nessity.'='.$validate_page.',';die;
		if(str_replace("'","",$txt_cost_control_source)==4 && $style_and_smv_source_comb==7 &&  $app_nessity==1 && $validate_page==4)
		{
			//$qc_no=return_field_value("qc_no", "wo_po_details_master a, qc_mst b", "job_no=$txt_job_no and a.inquiry_id=b.inquery_id and b.is_deleted=0 and b.status_active=1");
			$sql=sql_select("select approved from qc_mst where qc_no=$txt_quotation_id");
			$qc_approved=2;
			foreach($sql as $row){
				$qc_approved=$row[csf('approved')];
			}
		
			if($qc_approved==2 || $qc_approved==0 || $qc_approved==3){
				echo "qcNotApp**".str_replace("'","",$txt_job_no);
				disconnect($con);die;
			}
		}
		$sql=sql_select("select approved from wo_price_quotation  where id=$txt_quotation_id");
		$quatation_approved=2;
		foreach($sql as $row){
			$quatation_approved=$row[csf('approved')];
		}

		$is_copy_quatation=str_replace("'","",$copy_quatation_id);
		if($is_copy_quatation==1 && $app_nessity==1){
			if($quatation_approved==2 || $quatation_approved==0){
				echo "quataNotApp**".str_replace("'","",$txt_job_no);
				disconnect($con);die;
			}
		}
		//die;
	}
	
	if ($operation==0)  // Insert Here
	{
		if (is_duplicate_field( "job_no", "wo_pre_cost_mst", "job_no=$txt_job_no and is_deleted=0 and status_active=1" ) == 1)
		{
			echo "11**0"; disconnect($con); die;
		}
		else
		{
			$con = connect();
			if($db_type==0)
			{
				mysql_query("BEGIN");
			}
			$id=return_next_id( "id", "wo_pre_cost_mst", 1 );
			$field_array="id, job_id, garments_nature, job_no, costing_date, incoterm, incoterm_place, machine_line, prod_line_hr, costing_per, copy_quatation, cm_cost_predefined_method_id, exchange_rate, sew_smv, cut_smv, sew_effi_percent, cut_effi_percent, efficiency_wastage_percent, sew_efficiency_source, remarks, ready_to_approved, budget_minute, entry_from,refusing_cause,ready_to_source, inserted_by, insert_date, status_active, is_deleted";
			$data_array="(".$id.",".$hidd_job_id.",".$garments_nature.",".$txt_job_no.",".$txt_costing_date.",".$cbo_inco_term.",".$txt_incoterm_place.",".$txt_machine_line.",".$txt_prod_line_hr.",".$cbo_costing_per.",".$copy_quatation_id.",".$cm_cost_predefined_method_id.",".$txt_exchange_rate.",".$txt_sew_smv.",".$txt_cut_smv.",".$txt_sew_efficiency_per.",".$txt_cut_efficiency_per.",".$txt_efficiency_wastage.",".$txt_sew_efficiency_source.",".$txt_remarks.",".$cbo_ready_to_approved.",".$txt_budget_minute.",'425',".$txt_refusing.",".$cbo_source_status.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."','1','0')";
			//echo "10**INSERT INTO wo_pre_cost_mst (".$field_array.") VALUES ".$data_array; die;
			$rID=sql_insert("wo_pre_cost_mst",$field_array,$data_array,1);
			$rID3=execute_query( "update  wo_po_details_master set set_smv=$txt_sew_smv  where  job_no =".$txt_job_no."",1);

			if($db_type==0)
			{
				if($rID==1){
					mysql_query("COMMIT");
					echo "0**".$rID."**".str_replace("'","",$txt_job_no);
				}
				else{
					mysql_query("ROLLBACK");
					echo "10**".$rID."**".str_replace("'","",$txt_job_no);
				}
			}
			else if($db_type==2 || $db_type==1 )
			{
				if($rID==1){
					oci_commit($con);
					echo "0**".$rID."**".str_replace("'","",$txt_job_no);
				}
				else{
					oci_rollback($con);
					echo "10**".$rID."**".str_replace("'","",$txt_job_no);
				}
			}
			disconnect($con);
			die;
		}
	}
	else if ($operation==1)   // Update Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		$approved=0; $ready_to_approve=0;
		$sql=sql_select("select approved, ready_to_approved from wo_pre_cost_mst where job_no=$txt_job_no and status_active=1 and is_deleted=0");
		foreach($sql as $row){
			//if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
			$approved=$row[csf('approved')];
			$ready_to_approve=$row[csf('ready_to_approved')];
		}
		
		if($approved==1){
			echo "approved**".str_replace("'","",$txt_job_no);
			disconnect($con);die;
		}
		if($approved==3){
			echo "papproved**".str_replace("'","",$txt_job_no);
			disconnect($con);die;
		}
		if($ready_to_approve==1){
			echo "readyapproved**".str_replace("'","",$txt_job_no);
			disconnect($con);die;
		}

		$copy_quatation=0;
		$quotation_id=0;
		$ready_to_approved=str_replace("'","",$cbo_ready_to_approved);
		$sql=sql_select("select a.copy_quatation,b.quotation_id from wo_pre_cost_mst a, wo_po_details_master b where a.job_no=b.job_no and  a.job_no=$txt_job_no");
		foreach($sql as $row){
			$copy_quatation=$row[csf('copy_quatation')];
			$quotation_id=$row[csf('quotation_id')];
		}
		if($copy_quatation==1 && $ready_to_approved==1){
			$sql_fab=sql_select("select job_no ,sum(amount) as avg_cons from wo_pre_cost_fabric_cost_dtls where job_no=$txt_job_no and status_active=1 and is_deleted=0 group by job_no");
			$fabQtyPre=0;
			foreach($sql_fab as $row_fab){
				$fabQtyPre=$row_fab[csf('avg_cons')]*1;
			}
			$sql_fab=sql_select("select quotation_id, sum(amount) as avg_cons from wo_pri_quo_fabric_cost_dtls where quotation_id=$quotation_id and status_active=1 and is_deleted=0 group by quotation_id");
			$fabQtyPri=0;
			foreach($sql_fab as $row_fab){
				$fabQtyPri=$row_fab[csf('avg_cons')]*1;
			}
			//if($fabQtyPri >0 && $fabQtyPre <=0)
			$fabQtyPri=number_format($fabQtyPri,4,'.','');
			$fabQtyPre=number_format($fabQtyPre,4,'.','');
			if($fabQtyPri>0)
			{
				if($fabQtyPri<$fabQtyPre){
					echo "FabApp**".str_replace("'","",$txt_job_no).'**'.$fabQtyPri.'**'.$fabQtyPre;
					 disconnect($con);die;
				}
			}

			$sql_yarn=sql_select("select job_no,sum(amount) as cons_qnty from wo_pre_cost_fab_yarn_cost_dtls where job_no=$txt_job_no and status_active=1 and is_deleted=0 group by job_no");
			$yarQtyPre=0;
			foreach($sql_yarn as $row_yarn){
				$yarQtyPre=$row_yarn[csf('cons_qnty')]*1;
			}

			$sql_yar=sql_select("select quotation_id,sum(amount) as cons_qnty from wo_pri_quo_fab_yarn_cost_dtls where quotation_id=$quotation_id  and status_active=1 and is_deleted=0 group by quotation_id");
			$yarQtyPri=0;

			foreach($sql_yar as $row_yarn){
				$yarQtyPri=$row_yarn[csf('cons_qnty')]*1;
			}
			if($yarQtyPri>0)
			{
				//if( $yarQtyPri >0 && $yarQtyPre <=0)
				if( $yarQtyPri<$yarQtyPre){
					echo "YarApp**".str_replace("'","",$txt_job_no).'**'.$yarQtyPri.'**'.$yarQtyPre;
					 disconnect($con);die;
				}
			}


			$sql_con=sql_select("select job_no, sum(amount) as req_qnty from wo_pre_cost_fab_conv_cost_dtls where job_no=$txt_job_no and status_active=1 and is_deleted=0 group by job_no");
			$conQtyPre=0;
			foreach($sql_con as $row_con){
				$conQtyPre=$row_con[csf('req_qnty')]*1;
			}

			$sql_con=sql_select("select quotation_id, sum(amount) as req_qnty from wo_pri_quo_fab_conv_cost_dtls where quotation_id=$quotation_id and status_active=1 and is_deleted=0 group by quotation_id");
			$conQtyPri=0;
			foreach($sql_con as $row_con){
				$conQtyPri=$row_con[csf('req_qnty')]*1;
			}
			//if( $conQtyPri >0 && $conQtyPre <=0)
			if($conQtyPri>0)
			{
				if( $conQtyPri<$conQtyPre){
					echo "ConApp**".str_replace("'","",$txt_job_no).'**'.$conQtyPri."**".$conQtyPre;
					 disconnect($con);die;
				}
			}

			$sql_tri=sql_select("select job_no,sum(amount) as cons_dzn_gmts from wo_pre_cost_trim_cost_dtls where job_no=$txt_job_no and status_active=1 and is_deleted=0 group by job_no");
			$triQtyPre=0;
			foreach($sql_tri as $row_tri){
				$triQtyPre=$row_tri[csf('cons_dzn_gmts')]*1;
			}

			$sql_tri=sql_select("select quotation_id,sum(amount) as cons_dzn_gmts from wo_pri_quo_trim_cost_dtls where quotation_id=$quotation_id and status_active=1 and is_deleted=0 group by quotation_id");
			$triQtyPri=0;
			foreach($sql_tri as $row_tri){
				$triQtyPri=$row_tri[csf('cons_dzn_gmts')]*1;
			}
			//if($triQtyPri >0 && $triQtyPre <=0)
			if($triQtyPri>0)
			{
				if($triQtyPri<$triQtyPre){
					echo "TriApp**".str_replace("'","",$txt_job_no).'**'.$triQtyPri."**".$triQtyPre;
					 disconnect($con);die;
				}
			}

			$sql_emb=sql_select("select job_no,sum(amount) as cons_dzn_gmts from wo_pre_cost_embe_cost_dtls where job_no=$txt_job_no and emb_name!=3 and status_active=1 and is_deleted=0 group by job_no");
			$embQtyPre=0;
			foreach($sql_emb as $row_emb){
				$embQtyPre=$row_emb[csf('cons_dzn_gmts')]*1;
			}

			$sql_emb=sql_select("select quotation_id,sum(amount) as cons_dzn_gmts from wo_pri_quo_embe_cost_dtls where quotation_id=$quotation_id and emb_name!=3 and status_active=1 and is_deleted=0 group by quotation_id");
			$embQtyPri=0;
			foreach($sql_emb as $row_emb){
				$embQtyPri=$row_emb[csf('cons_dzn_gmts')]*1;
			}
			//if( $embQtyPri >0 && $embQtyPre <=0)
			if($embQtyPri>0)
			{
				if( $embQtyPri<$embQtyPre){
					echo "EmbApp**".str_replace("'","",$txt_job_no).'**'.$embQtyPri."**".$embQtyPre;
					 disconnect($con);die;
				}
			}

			$sql_was=sql_select("select job_no,sum(amount) as cons_dzn_gmts from wo_pre_cost_embe_cost_dtls where job_no=$txt_job_no and emb_name =3 and status_active=1 and is_deleted=0 group by job_no");
			$wasQtyPre=0;
			foreach($sql_was as $row_was){
				$wasQtyPre=$row_was[csf('cons_dzn_gmts')]*1;
			}

			$sql_was=sql_select("select quotation_id,sum(amount) as cons_dzn_gmts from wo_pri_quo_embe_cost_dtls where quotation_id=$quotation_id and emb_name =3 and status_active=1 and is_deleted=0 group by quotation_id");
			$wasQtyPri=0;
			foreach($sql_was as $row_was){
				$wasQtyPri=$row_was[csf('cons_dzn_gmts')]*1;
			}
			//if($wasQtyPri >0 && $wasQtyPre <=0)
			if($wasQtyPri>0)
			{
				if($wasQtyPri<$wasQtyPre){
					echo "WasApp**".str_replace("'","",$txt_job_no).'**'.$wasQtyPri."**".$wasQtyPre;
					 disconnect($con);die;
				}
			}

			$sql_comn=sql_select("select job_no,sum(commission_amount) as commission_amount from wo_pre_cost_commiss_cost_dtls where job_no=$txt_job_no and status_active=1 and is_deleted=0 group by job_no");
			$comnQtyPre=0;
			foreach($sql_comn as $row_comn){
				$comnQtyPre=$row_comn[csf('commission_amount')]*1;
			}

			$sql_comn=sql_select("select quotation_id,sum(commission_amount) as commission_amount from wo_pri_quo_commiss_cost_dtls where quotation_id=$quotation_id and status_active=1 and is_deleted=0 group by quotation_id");
			$comnQtyPri=0;
			foreach($sql_comn as $row_comn){
				$comnQtyPri=$row_comn[csf('commission_amount')]*1;
			}
			//if( $comnQtyPri >0 && $comnQtyPre <=0)
			if($comnQtyPri>0)
			{
				if( $comnQtyPri<$comnQtyPre){
					echo "ComnApp**".str_replace("'","",$txt_job_no).'**'.$comnQtyPri."**".$comnQtyPre;
					 disconnect($con);die;
				}
			}


			$sql_comm=sql_select("select job_no,sum(amount) as amount from wo_pre_cost_comarci_cost_dtls where job_no=$txt_job_no and status_active=1 and is_deleted=0 group by job_no");
			$commQtyPre=0;
			foreach($sql_comm as $row_comm){
				$commQtyPre=$row_comm[csf('amount')]*1;
			}

			$sql_comm=sql_select("select quotation_id,sum(amount) as amount from wo_pri_quo_comarcial_cost_dtls where quotation_id=$quotation_id and status_active=1 and is_deleted=0 group by quotation_id");
			$commQtyPri=0;
			foreach($sql_comm as $row_comm){
				$commQtyPri=$row_comm[csf('amount')]*1;
			}

			//if( $commQtyPri >0 && $commQtyPre <=0)
			if($commQtyPri>0)
			{
				if( $commQtyPri<$commQtyPre){
					echo "CommApp**".str_replace("'","",$txt_job_no).'**'.$commQtyPri."**".$commQtyPre;
					 disconnect($con);die;
				}
			}

			$lab_test=0; $inspection=0; $cm_cost=0; $freight=0; $currier_pre_cost=0; $certificate_pre_cost=0; $common_oh=0; $depr_amor_pre_cost=0; $interest_cost=0; $incometax_cost=0;

			//$deffdlc_cost=0;

			$sql_oth=sql_select("select job_no, lab_test, inspection, cm_cost, freight, currier_pre_cost, certificate_pre_cost, common_oh, depr_amor_pre_cost, deffdlc_cost, interest_cost, incometax_cost from wo_pre_cost_dtls where job_no=$txt_job_no and status_active=1 and is_deleted=0");
			foreach($sql_oth as $oth_row){
				$lab_test=$oth_row[csf('lab_test')]*1;
				$inspection=$oth_row[csf('inspection')]*1;
				$cm_cost=$oth_row[csf('cm_cost')]*1;
				$freight=$oth_row[csf('freight')]*1;
				$currier_pre_cost=$oth_row[csf('currier_pre_cost')]*1;
				$certificate_pre_cost=$oth_row[csf('certificate_pre_cost')]*1;
				$common_oh=$oth_row[csf('common_oh')]*1;
				$depr_amor_pre_cost=$oth_row[csf('depr_amor_pre_cost')]*1;
				$interest_cost=$oth_row[csf('interest_cost')]*1;
				$incometax_cost=$oth_row[csf('incometax_cost')]*1;

				//$deffdlc_cost=$oth_row[csf('deffdlc_cost')];
			}

			$lab_test_pri=0; $inspection_pri=0; $cm_cost_pri=0; $freight_pri=0; $currier_pre_cost_pri=0; $certificate_pre_cost_pri=0; $common_oh_pri=0; $depr_amor_pre_cost_pri=0; $interest_cost_pri=0; $incometax_cost_pri=0;

			//$deffdlc_cost_pri=0;
			$sql_oth=sql_select("select quotation_id, lab_test, inspection, cm_cost, freight, currier_pre_cost, certificate_pre_cost, common_oh, depr_amor_pre_cost, interest_pre_cost, income_tax_pre_cost from wo_price_quotation_costing_mst where quotation_id = $quotation_id and status_active=1 and is_deleted=0");
			foreach($sql_oth as $oth_row){
				$lab_test_pri=$oth_row[csf('lab_test')]*1;
				$inspection_pri=$oth_row[csf('inspection')]*1;
				$cm_cost_pri=$oth_row[csf('cm_cost')]*1;
				$freight_pri=$oth_row[csf('freight')]*1;
				$currier_pre_cost_pri=$oth_row[csf('currier_pre_cost')]*1;
				$certificate_pre_cost_pri=$oth_row[csf('certificate_pre_cost')]*1;
				$common_oh_pri=$oth_row[csf('common_oh')]*1;
				$depr_amor_pre_cost_pri=$oth_row[csf('depr_amor_pre_cost')]*1;
				$interest_cost_pri=$oth_row[csf('interest_pre_cost')]*1;
				$incometax_cost_pri=$oth_row[csf('income_tax_pre_cost')]*1;
				//$deffdlc_cost_pri=$oth_row[csf('deffdlc_cost')];
			}

			//if( $lab_test_pri >0 && $lab_test <=0)
			if($lab_test_pri>0)
			{
				if( $lab_test_pri<$lab_test){
					echo "LabApp**".str_replace("'","",$txt_job_no).'**'.$lab_test_pri."**".$lab_test;
					 disconnect($con);die;
				}
			}

			//if( $inspection_pri >0 &&  $inspection <=0)
			if($inspection_pri>0)
			{
				if( $inspection_pri<$inspection){
					echo "InspApp**".str_replace("'","",$txt_job_no).'**'.$inspection_pri."**".$inspection;
					 disconnect($con);die;
				}
			}

			//if( $cm_cost_pri >0 && $cm_cost <=0)
			if($cm_cost_pri>0)
			{
				if( $cm_cost_pri<$cm_cost){
					echo "CmApp**".str_replace("'","",$txt_job_no).'**'.$cm_cost_pri."**".$cm_cost;
					 disconnect($con);die;
				}
			}

			//if( $freight_pri >0 && $freight <=0)
			if($freight_pri>0)
			{
				if( $freight_pri<$freight){
					echo "FreApp**".str_replace("'","",$txt_job_no).'**'.$freight_pri."**".$freight;
					 disconnect($con);die;
				}
			}

			//if( $currier_pre_cost_pri >0 && $currier_pre_cost <=0)
			if($currier_pre_cost_pri>0)
			{
				if( $currier_pre_cost_pri<$currier_pre_cost){
					echo "CurrApp**".str_replace("'","",$txt_job_no).'**'.$currier_pre_cost_pri."**".$currier_pre_cost;
					 disconnect($con);die;
				}
			}

			//if( $certificate_pre_cost_pri >0 && $certificate_pre_cost <=0)
			if($certificate_pre_cost_pri>0)
			{
				if( $certificate_pre_cost_pri<$certificate_pre_cost){
					echo "CertApp**".str_replace("'","",$txt_job_no).'**'.$certificate_pre_cost_pri."**".$certificate_pre_cost;
					 disconnect($con);die;
				}
			}
			//if( $common_oh_pri >0 && $common_oh <=0)
			if($common_oh_pri>0)
			{
				if( $common_oh_pri<$common_oh){
					echo "CoohApp**".str_replace("'","",$txt_job_no).'**'.$common_oh_pri."**".$common_oh;
					 disconnect($con);die;
				}
			}
			//if( $depr_amor_pre_cost_pri >0 && $depr_amor_pre_cost <=0)
			if($depr_amor_pre_cost_pri>0)
			{
				if( $depr_amor_pre_cost_pri<$depr_amor_pre_cost){
					echo "DeprApp**".str_replace("'","",$txt_job_no).'**'.$depr_amor_pre_cost_pri."**".$depr_amor_pre_cost;
					die;
				}
			}
			//if( $interest_cost_pri >0 && $interest_cost <=0)
			if($interest_cost_pri>0)
			{
				if( $interest_cost_pri<$interest_cost){
					echo "InterApp**".str_replace("'","",$txt_job_no).'**'.$interest_cost_pri."**".$interest_cost;
					 disconnect($con);die;
				}
			}
			//if( $incometax_cost_pri >0 && $incometax_cost <=0)
			if($incometax_cost_pri>0)
			{
				if( $incometax_cost_pri<$incometax_cost){
					echo "IncomApp**".str_replace("'","",$txt_job_no).'**'.$incometax_cost_pri."**".$incometax_cost;
					 disconnect($con);die;
				}
			}
		}

		$field_array="costing_date*incoterm*incoterm_place*machine_line*prod_line_hr*costing_per*copy_quatation*cm_cost_predefined_method_id*exchange_rate*sew_smv*cut_smv*sew_effi_percent*cut_effi_percent*efficiency_wastage_percent*sew_efficiency_source*remarks*ready_to_approved*budget_minute*refusing_cause*ready_to_source*updated_by*update_date*status_active*is_deleted";
		$data_array="".$txt_costing_date."*".$cbo_inco_term."*".$txt_incoterm_place."*".$txt_machine_line."*".$txt_prod_line_hr."*".$cbo_costing_per."*".$copy_quatation_id."*".$cm_cost_predefined_method_id."*".$txt_exchange_rate."*".$txt_sew_smv."*".$txt_cut_smv."*".$txt_sew_efficiency_per."*".$txt_cut_efficiency_per."*".$txt_efficiency_wastage."*".$txt_sew_efficiency_source."*".$txt_remarks."*".$cbo_ready_to_approved."*".$txt_budget_minute."*".$txt_refusing."*".$cbo_source_status."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*'1'*'0'";
		$rID=sql_update("wo_pre_cost_mst",$field_array,$data_array,"job_no","".$txt_job_no."",1);
		//$rID3=execute_query( "update wo_po_details_master set set_smv=$txt_sew_smv  where  job_no =".$txt_job_no."",1);
		//echo "10**".$txt_job_no; die;

		if($db_type==0)
		{
			if($rID )
			{
				mysql_query("COMMIT");
				echo "1**".$rID."**".str_replace("'","",$txt_job_no);
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$rID."**".str_replace("'","",$txt_job_no);
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID )
			{
				oci_commit($con);
				echo "1**".$rID."**".str_replace("'","",$txt_job_no);
			}
			else{
				oci_rollback($con);
				echo "10**".$rID."**".str_replace("'","",$txt_job_no);
			}
		}

		disconnect($con);
		die;
	}
	else if ($operation==2)   // Update Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		$approved=0;
		$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$txt_job_no");
		foreach($sql as $row){
			$approved=$row[csf('approved')];
		}
		if($approved==1){
			echo "approved**".str_replace("'","",$txt_job_no);
			 disconnect($con);die;
		}
		$field_array="updated_by*update_date*status_active*is_deleted";
		$data_array="".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*'0'*'1'";

		$rID=sql_delete("wo_pre_cost_mst",$field_array,$data_array,"job_no","".$txt_job_no."",1);

		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "2**".$rID."**".str_replace("'","",$txt_job_no);
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$rID."**".str_replace("'","",$txt_job_no);
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "2**".$rID."**".str_replace("'","",$txt_job_no);
			}
			else{
				oci_rollback($con);
				echo "10**".$rID."**".str_replace("'","",$txt_job_no);
			}
		}
		disconnect($con);
		die;
	}
	else if ($operation==3)   // Update Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
				//echo "1**select a.copy_quatation,b.quotation_id from wo_pre_cost_mst a, wo_po_details_master b where a.job_no=b.job_no and  a.job_no=$txt_job_no"; die;

		/*$approved=0;
		$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$txt_job_no");
		foreach($sql as $row){
			$approved=$row[csf('approved')];
		}
		if($approved==1){
			echo "approved**".str_replace("'","",$txt_job_no);
			die;
		}*/


		$field_array="approved*approved_by*approved_date";
		if(trim(str_replace("'","",$cbo_approved_status))==2)
		{
			$data_array="'1'*'".$_SESSION['logic_erp']['user_id']."'*'".$pc_date_time."'";
		}
		else
		{
			$data_array="'2'*'".$_SESSION['logic_erp']['user_id']."'*'".$pc_date_time."'";

		}
		$rID=sql_update("wo_pre_cost_mst",$field_array,$data_array,"job_no",$txt_job_no,1);
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "3**".$rID."**".str_replace("'","",$txt_job_no)."**".trim(str_replace("'","",$cbo_approved_status));
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$rID."**".str_replace("'","",$txt_job_no)."**".trim(str_replace("'","",$cbo_approved_status));
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "3**".$rID."**".str_replace("'","",$txt_job_no)."**".trim(str_replace("'","",$cbo_approved_status));
			}
			else{
				oci_rollback($con);
				echo "10**".$rID."**".str_replace("'","",$txt_job_no)."**".trim(str_replace("'","",$cbo_approved_status));
			}
		}
		disconnect($con);
		die;
	}
}

//*************************************************Master Form End ***********************************************
//*************************************************Dtls Form Start ***********************************************
if ($action=="save_update_delete_quotation_entry_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$sql=sql_select("select approval_need from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
	$app_nessity=2;
	foreach($sql as $row){
		$app_nessity=$row[csf('approval_need')];
	}

	$sql=sql_select("select approved from wo_price_quotation  where id=$txt_quotation_id");
	$quatation_approved=2;
	foreach($sql as $row){
		$quatation_approved=$row[csf('approved')];
	}

	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	//echo "10**",$is_copy_quatation."**". $app_nessity."**".$quatation_approved;
	//die;
	if($is_copy_quatation==1 && $app_nessity==1){
		if($quatation_approved==2 || $quatation_approved==0){
			echo "quataNotApp**".str_replace("'","",$txt_job_no);
			 disconnect($con);die;
		}
	}
	$approved=0; $ready_to_approve=0;
	$sql=sql_select("select approved, ready_to_approved from wo_pre_cost_mst where job_no=$update_id and status_active=1 and is_deleted=0");
	foreach($sql as $row){
		//if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
		$approved=$row[csf('approved')];
		$ready_to_approve=$row[csf('ready_to_approved')];
	}
	if($approved==1){
		echo "approved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($approved==3){
		echo "papproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($ready_to_approve==1){
		echo "readyapproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	//============ Negative Margin Allow In Budget ============================
	 $vari_nameArray=sql_select( "select STYLE_FROM_LIBRARY from  variable_order_tracking where company_name=$cbo_company_name and variable_list=86" );
	// echo "10**=select STYLE_FROM_LIBRARY from  variable_order_tracking where company_name='$cbo_company_name' and variable_list=86";die;
	 $negative_margin_vari=1;
	 foreach($vari_nameArray as $row){
		$negative_margin_vari=$row['STYLE_FROM_LIBRARY'];
	}
	$margin_dzn_pre_cost_chk=str_replace("'","",$txt_margin_dzn_pre_cost);
	
	if($operation==1 && count($vari_nameArray)>0)
	{
		
		if($negative_margin_vari==2 && $margin_dzn_pre_cost_chk<0){
			echo "negative**Negative margin not allow in budget";
			disconnect($con);die;
		}
	}
	
	

	$cm_for_shipment_sche = str_replace("'","", $txt_margin_dzn_pre_cost) +str_replace("'","", $txt_cm_pre_cost);
	$date= date('Y-m-d');
	if ($operation==0)  // Insert Here
	{
		$con = connect();
		if($db_type==0) mysql_query("BEGIN");

		$id=return_next_id( "id", "wo_pre_cost_dtls", 1 ) ;
		$field_array="id, job_id, job_no, costing_per_id, order_uom_id, fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent, wash_cost, wash_cost_percent, comm_cost, comm_cost_percent, commission, commission_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, calculative_cmcost, freight, freight_percent, currier_pre_cost, currier_percent, certificate_pre_cost, certificate_percent, common_oh, common_oh_percent, depr_amor_pre_cost, depr_amor_po_price, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, cost_pcs_set, cost_pcs_set_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set, margin_pcs_set_percent, cm_for_sipment_sche, deffdlc_cost, deffdlc_percent, interest_cost, interest_percent, incometax_cost, incometax_percent, design_cost, design_percent, studio_cost, studio_percent, inserted_by, insert_date, status_active, is_deleted";

		$data_array="(".$id.",".$hidd_job_id.", ".$update_id.", ".$cbo_costing_per.", ".$cbo_order_uom.", ".$txt_fabric_pre_cost.", ".$txt_fabric_po_price.", ".$txt_trim_pre_cost.", ".$txt_trim_po_price.", ".$txt_embel_pre_cost.", ".$txt_embel_po_price.", ".$txt_wash_pre_cost.", ".$txt_wash_po_price.", ".$txt_comml_pre_cost.", ".$txt_comml_po_price.", ".$txt_commission_pre_cost.", ".$txt_commission_po_price.", ".$txt_lab_test_pre_cost.", ".$txt_lab_test_po_price.", ".$txt_inspection_pre_cost.", ".$txt_inspection_po_price.", ".$txt_cm_pre_cost.", ".$txt_cm_po_price.", ".$txtcmcost.", ".$txt_freight_pre_cost.", ".$txt_freight_po_price.", ".$txt_currier_pre_cost.", ".$txt_currier_po_price.", ".$txt_certificate_pre_cost.", ".$txt_certificate_po_price.", ".$txt_common_oh_pre_cost.", ".$txt_common_oh_po_price.", ".$txt_depr_amor_pre_cost.", ".$txt_depr_amor_po_price.", ".$txt_total_pre_cost.", ".$txt_total_po_price.", ".$txt_final_price_dzn_pre_cost.", ".$txt_final_price_dzn_po_price.", ".$txt_margin_dzn_pre_cost.", ".$txt_margin_dzn_po_price.", ".$txt_total_pre_cost_psc_set.", ".$txt_total_pre_cost_psc_set_po_price.", ".$txt_final_price_pcs_pre_cost.", ".$txt_final_price_pcs_po_price.", ".$txt_margin_pcs_pre_cost.", ".$txt_margin_pcs_po_price.", ".$cm_for_shipment_sche.", ".$txt_deffdlc_pre_cost.", ".$txt_deffdlc_po_price.", ".$txt_interest_pre_cost.", ".$txt_interest_po_price.", ".$txt_incometax_pre_cost.", ".$txt_incometax_po_price.", ".$txt_design_pre_cost.", ".$txt_design_po_price.", ".$txt_studio_pre_cost.", ".$txt_studio_po_price.", ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', 1,0)";
		$rID=sql_insert("wo_pre_cost_dtls",$field_array,$data_array,1,1);
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "0**".$rID."**".$id;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$rID."**".$id;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "0**".$rID."**".$id;
			}
			else{
				oci_rollback($con);
				echo "10**".$rID."**".$id;
			}
		}
		//update_cost_sheet($update_id);
		//echo "10**kk=".$dt; die;
		if($db_type==0) mysql_query("COMMIT"); else if($db_type==2) oci_commit($con);
		disconnect($con);
		die;
	}
	else if ($operation==1)   // Update Here
	{
		$con = connect();
		if($db_type==0) mysql_query("BEGIN");
		if(str_replace("'",'',$update_id_dtls)=="" && 1==2)
		{
			$id=return_next_id( "id", "wo_pre_cost_dtls", 1 ) ;
			$field_array="id, job_id, job_no, costing_per_id, order_uom_id, fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent, wash_cost, wash_cost_percent, comm_cost, comm_cost_percent, commission, commission_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, calculative_cmcost, freight, freight_percent, currier_pre_cost, currier_percent, certificate_pre_cost, certificate_percent, common_oh, common_oh_percent, depr_amor_pre_cost, depr_amor_po_price, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, cost_pcs_set, cost_pcs_set_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set, margin_pcs_set_percent, cm_for_sipment_sche, deffdlc_cost, deffdlc_percent, interest_cost, interest_percent, incometax_cost, incometax_percent, design_cost, design_percent, studio_cost, studio_percent, inserted_by, insert_date, status_active, is_deleted";
			$data_array="(".$id.",".$hidd_job_id.", ".$update_id.", ".$cbo_costing_per.", ".$cbo_order_uom.", ".$txt_fabric_pre_cost.", ".$txt_fabric_po_price.", ".$txt_trim_pre_cost.", ".$txt_trim_po_price.", ".$txt_embel_pre_cost.", ".$txt_embel_po_price.", ".$txt_wash_pre_cost.", ".$txt_wash_po_price.", ".$txt_comml_pre_cost.", ".$txt_comml_po_price.", ".$txt_commission_pre_cost.", ".$txt_commission_po_price.", ".$txt_lab_test_pre_cost.", ".$txt_lab_test_po_price.", ".$txt_inspection_pre_cost.", ".$txt_inspection_po_price.", ".$txt_cm_pre_cost.", ".$txt_cm_po_price.",".$txtcmcost.", ".$txt_freight_pre_cost.", ".$txt_freight_po_price.", ".$txt_currier_pre_cost.", ".$txt_currier_po_price.", ".$txt_certificate_pre_cost.", ".$txt_certificate_po_price.", ".$txt_common_oh_pre_cost.", ".$txt_common_oh_po_price.", ".$txt_depr_amor_pre_cost.", ".$txt_depr_amor_po_price.", ".$txt_total_pre_cost.", ".$txt_total_po_price.", ".$txt_final_price_dzn_pre_cost.", ".$txt_final_price_dzn_po_price.", ".$txt_margin_dzn_pre_cost.", ".$txt_margin_dzn_po_price.", ".$txt_total_pre_cost_psc_set.", ".$txt_total_pre_cost_psc_set_po_price.", ".$txt_final_price_pcs_pre_cost.", ".$txt_final_price_pcs_po_price.", ".$txt_margin_pcs_pre_cost.", ".$txt_margin_pcs_po_price.", ".$cm_for_shipment_sche.", ".$txt_deffdlc_pre_cost.", ".$txt_deffdlc_po_price.", ".$txt_interest_pre_cost.", ".$txt_interest_po_price.", ".$txt_incometax_pre_cost.", ".$txt_incometax_po_price.", ".$txt_design_pre_cost.", ".$txt_design_po_price.", ".$txt_studio_pre_cost.", ".$txt_studio_po_price.", ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', 1,0)";
			//$rID=sql_insert("wo_pre_cost_dtls",$field_array,$data_array,1);
		}
		if(str_replace("'",'',$update_id_dtls)!="")
		{
			$approved=0;
			$sql=sql_select("select a.approved,b.avg_unit_price from wo_pre_cost_mst a,wo_po_details_master b where a.job_id=b.id  and a.status_active=1 and b.status_active=1   and a.job_no=$update_id");
			foreach($sql as $row){
				$approved=$row[csf('approved')];
				$avg_unit_price_chk=$row[csf('avg_unit_price')];
			}
			if($approved==1){
				echo "approved**".str_replace("'","",$update_id);
				die;
			}
			$final_price_pcs_pre_cost=str_replace("'","",$txt_final_price_pcs_pre_cost);
			if($final_price_pcs_pre_cost!=$avg_unit_price_chk){
				$msg="Job Avg Rate not matched with Budget!,Please Recall the Job no. ";
				echo "avg_rate_not_match**".$msg."**".$final_price_pcs_pre_cost."**".$avg_unit_price_chk;
				die;
			}
			/* $vari_comml_nameArray=sql_select( "select EXCUT_SOURCE from  variable_order_tracking where company_name=$cbo_company_name and commercial_cost_method=2 and variable_list=27 and status_active=1" );
			$commercial_chk=0;
			foreach($vari_comml_nameArray as $row){
				$commercial_chk=$row['EXCUT_SOURCE'];
			}
			$txt_commission_pre_cost_chk=str_replace("'","",$txt_comml_pre_cost);
			if(count($vari_comml_nameArray)>0)
			{
				if($commercial_chk==1 && $txt_commission_pre_cost_chk==""){
					echo "negative**Without Comercial not allow in budget";
					disconnect($con);die;
				}
			} */
			
			$field_array="costing_per_id*order_uom_id*fabric_cost*fabric_cost_percent*trims_cost*trims_cost_percent*embel_cost*embel_cost_percent*wash_cost* 	wash_cost_percent*comm_cost*comm_cost_percent*commission*commission_percent*lab_test*lab_test_percent*inspection*inspection_percent*cm_cost*cm_cost_percent*calculative_cmcost*freight*freight_percent*currier_pre_cost*currier_percent*certificate_pre_cost*certificate_percent*common_oh*common_oh_percent*depr_amor_pre_cost*depr_amor_po_price*total_cost*total_cost_percent*price_dzn*price_dzn_percent*margin_dzn*margin_dzn_percent*cost_pcs_set*cost_pcs_set_percent*price_pcs_or_set*price_pcs_or_set_percent*margin_pcs_set*margin_pcs_set_percent*cm_for_sipment_sche*deffdlc_cost*deffdlc_percent*interest_cost*interest_percent*incometax_cost*incometax_percent*design_cost*design_percent*studio_cost*studio_percent*updated_by*update_date*status_active*is_deleted";
			$data_array="".$cbo_costing_per."*".$cbo_order_uom."*".$txt_fabric_pre_cost."*".$txt_fabric_po_price."*".$txt_trim_pre_cost."*".$txt_trim_po_price."*".$txt_embel_pre_cost."*".$txt_embel_po_price."*".$txt_wash_pre_cost."*".$txt_wash_po_price."*".$txt_comml_pre_cost."*".$txt_comml_po_price."*".$txt_commission_pre_cost."*".$txt_commission_po_price."*".$txt_lab_test_pre_cost."*".$txt_lab_test_po_price."*".$txt_inspection_pre_cost."*".$txt_inspection_po_price."*".$txt_cm_pre_cost."*".$txt_cm_po_price."*".$txtcmcost."*".$txt_freight_pre_cost."*".$txt_freight_po_price."*".$txt_currier_pre_cost."*".$txt_currier_po_price."*".$txt_certificate_pre_cost."*".$txt_certificate_po_price."*".$txt_common_oh_pre_cost."*".$txt_common_oh_po_price."*".$txt_depr_amor_pre_cost."*".$txt_depr_amor_po_price."*".$txt_total_pre_cost."*".$txt_total_po_price."*".$txt_final_price_dzn_pre_cost."*".$txt_final_price_dzn_po_price."*".$txt_margin_dzn_pre_cost."*".$txt_margin_dzn_po_price."*".$txt_total_pre_cost_psc_set."*".$txt_total_pre_cost_psc_set_po_price."*".$txt_final_price_pcs_pre_cost."*".$txt_final_price_pcs_po_price."*".$txt_margin_pcs_pre_cost."*".$txt_margin_pcs_po_price."*".$cm_for_shipment_sche."*".$txt_deffdlc_pre_cost."*".$txt_deffdlc_po_price."*".$txt_interest_pre_cost."*".$txt_interest_po_price."*".$txt_incometax_pre_cost."*".$txt_incometax_po_price."*".$txt_design_pre_cost."*".$txt_design_po_price."*".$txt_studio_pre_cost."*".$txt_studio_po_price."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*1*0";
			//echo "10**".$data_array;	die;
		    $rID=sql_update("wo_pre_cost_dtls",$field_array,$data_array,"id","".$update_id_dtls."",1);
		}

		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "1**".$rID."**".str_replace("'","",$update_id_dtls);
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$rID."**".str_replace("'","",$update_id_dtls);
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "1**".$rID."**".str_replace("'","",$update_id_dtls);
			}
			else{
				oci_rollback($con);
				echo "10**".$rID."**".str_replace("'","",$update_id_dtls);
			}
		}
		//update_cost_sheet($update_id);
		//echo "10**kk=".$dt; die;
		if($db_type==0) mysql_query("COMMIT"); else if($db_type==2) oci_commit($con);
		disconnect($con);
		die;
	}
	else if ($operation==2)//Update Here============================================================================================================================
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		$field_array="updated_by*update_date*status_active*is_deleted";
		$data_array="".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*'0'*'1'";
		$rID=sql_delete("wo_pre_cost_dtls",$field_array,$data_array,"id","".$update_id_dtls."",1);
		if($db_type==0)
		{
			if($rID )
			{
				mysql_query("COMMIT");
				echo "2**".$rID."**".str_replace("'","",$update_id_dtls);
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "10**".$rID."**".str_replace("'","",$update_id_dtls);
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID )
			{
				oci_commit($con);
				echo "2**".$rID."**".str_replace("'","",$update_id_dtls);
			}
			else
			{
				oci_rollback($con);
				echo "10**".$rID."**".str_replace("'","",$update_id_dtls);
			}
		}
		//update_cost_sheet($update_id);
		//echo "10**kk=".$dt; die;
		if($db_type==0) mysql_query("COMMIT"); else if($db_type==2) oci_commit($con);
		disconnect($con);
		die;
	}
	else if ($operation==3)//Update Here============================================================================================================================
	{
			echo "1**".$rID."**".str_replace("'","",$update_id_dtls);
			disconnect($con);
			die;
	}
}
//*************************************************Dtls Form End ***********************************************
//*************************************************Fabric Cost, Yarn Cost, Coversion Cost Start ***********************************************
if($action=="check_booking")
{
	$booking_no="";
	$sql_data=sql_select("select booking_no from wo_booking_dtls where pre_cost_fabric_cost_dtls_id=$data and booking_type=1 and status_active=1 and is_deleted=0 group by  booking_no");
	foreach($sql_data as $row)
	{
		$booking_no=$row[csf("booking_no")];
	}
	echo $booking_no;
	exit();
}


if($action=="booking_no_with_approved_status")
{
	$data=explode("_",$data);
	//echo $data[0];
	//echo $data[1];
	if($data[1]=="")
	{
		$sql="select booking_no, is_approved from wo_booking_mst where job_no='$data[0]' and booking_type=1 and is_short=2 and is_deleted=0 and status_active=1";
	}
	else
	{
		//Mysql
		/*$sql="select a.booking_no,a.is_approved from wo_booking_mst a, wo_booking_dtls b where a.job_no=b.job_no and  a.job_no='$data[0]' and a.booking_type=1 and a.is_short=2 and b.po_break_down_id=$data[1] and a.is_deleted=0 and a.status_active=1 group by a.booking_no";*/
		//Oracle
		$sql="select a.booking_no,a.is_approved from wo_booking_mst a, wo_booking_dtls b where a.job_no=b.job_no and  a.job_no='$data[0]' and a.booking_type=1 and a.is_short=2 and b.po_break_down_id=$data[1] and a.is_deleted=0 and a.status_active=1 group by a.booking_no,a.is_approved";
	}
	$approved_booking="";
	$un_approved_booking="";
	$sql_booking=sql_select($sql);
	foreach($sql_booking as $row)
	{
		if($row[csf('is_approved')]==1)
		{
		  $approved_booking.=$row[csf('booking_no')].", ";
		}
		else
		{
		  $un_approved_booking.=$row[csf('booking_no')].", ";
		}
	}
	echo rtrim($approved_booking ,", ")."_".rtrim($un_approved_booking , ", ");
	exit();
}

if ($action=="show_fabric_cost_listview")
{
	$data=explode("**",$data); $component_approved=0; $approved_message="";$permission=$data[6];
	$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=1 and job_no='$data[0]'");
	foreach($sql as $row){
		if($row[csf('approved')]==1 || $row[csf('approved')]==3) {
			$component_approved=1; $approved_message="<marquee width='500'><p style='color:#f00;'> Approved</p></marquee> ";
		}
	}
	
	$selected_sensivity=1; $variable_editable=0; $fabricBudgetOn=2; $de_fab_source=1;
	$mkt_variable_sql=sql_select("select variable_list, embellishment_id, embellishment_budget_id, color_sensivity, editable from variable_order_tracking where  company_name='$data[3]' and variable_list in (49,75,97) and status_active=1 and is_deleted=0");
	if(count($mkt_variable_sql)>0){
		foreach($mkt_variable_sql as $row){
			if($row[csf('variable_list')]==97) 
			{
				$selected_sensivity=$row[csf('color_sensivity')];
				$variable_editable=$row[csf('editable')];
			}
			if($row[csf('variable_list')]==75 && $row[csf('embellishment_id')]==3) $fabricBudgetOn=$row[csf('embellishment_budget_id')];//
			if($row[csf('variable_list')]==49) $de_fab_source=$row[csf('default_fabric_source')];
		}
	} 

	?>
       <h3 align="left" class="accordion_h" onClick="show_hide_content('fabric_cost', '')"> +Fabric Cost <? echo $approved_message; ?></h3>       
       <div id="content_fabric_cost" style="display:none;">
    	<fieldset>
        	<form id="fabriccost_3" autocomplete="off">
            <input type="hidden" id="tr_ortder" name="tr_ortder" value="" width="500" />
			<input type="hidden" id="selected_sensivity" name="selected_sensivity" value="<? echo $selected_sensivity;?>" />
			<input type="hidden" id="variable_editable" name="variable_editable" value="<? echo $variable_editable;?>" /> 
            <table width="1790" cellspacing="0" class="rpt_table" border="0" id="tbl_fabric_cost" rules="all">
                <thead>
                    <tr>
                    	<th width="30">Seq</th>
                        <th width="80" style="color:#2A3FFF">Gmts Item</th>
                        <th width="80" style="color:#2A3FFF">Body Part</th>
                        <th width="60" style="color:#2A3FFF">Body Part Type</th>
                        <th width="80" style="color:#2A3FFF">Fab Nature</th>
                        <th width="70" style="color:#2A3FFF">Color Type</th>
                        <th width="150" style="color:#2A3FFF">Fabric Description</th>
                        <th width="80" style="color:#2A3FFF">Fabric Source</th>
                        <th width="60" title="Material Source">M.Source</th>
                        <th width="80">Nominated Supp</th>
                        <th width="60" id="">Width Type</th>
                        <th width="40" style="color:#2A3FFF" id="gsmweight_caption">Fabric Weight</th>
                        <th width="100" style="color:#2A3FFF">F. Weight Type</th>
                        <th width="100" style="color:#2A3FFF">Color Sensitivity</th>
                        <th width="75" id="gsmweight_caption">Color</th>
                        <th width="70">Consumption Basis</th>
                        <th width="50" style="color:#2A3FFF">Uom</th>
                        <th width="65" style="color:#2A3FFF">Avg. Fabric Cons</th>
                        <th width="40">Rate</th>
                        <th width="60">Amount</th>
                        <th width="50">Total Qty</th>
                        <th width="70">Total Amount</th>
                        <th width="70">Remarks</th>
                        <th>&nbsp;</th>
                    </tr>
                </thead>
                <tbody id="fabric_tbl_dtls_for">
                <?
				$color_library=return_library_array("select id,color_name from lib_color where status_active=1 and is_deleted=0","id","color_name");
                $supplier_library_fabric=return_library_array( "select a.supplier_name, a.id from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(1,9) and a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");

				$sql_fld_lvl_acss="select field_name, defalt_value, is_disable from field_level_access where user_id=".$_SESSION['logic_erp']['user_id']." and company_id=$data[3] and page_id=425";
				$sql_fld_lvl_acss_data=sql_select($sql_fld_lvl_acss);
				$fld_lvl_acss_arr=array();
				foreach($sql_fld_lvl_acss_data as $fld_lvl_acss_row)
				{
					$fld_lvl_acss_arr[$fld_lvl_acss_row[csf("field_name")]]['defalt_value']=$fld_lvl_acss_row[csf("defalt_value")];
					$fld_lvl_acss_arr[$fld_lvl_acss_row[csf("field_name")]]['is_disable']=$fld_lvl_acss_row[csf("is_disable")];
				}
				unset($sql_fld_lvl_acss_data);
				
				$arr_bo_app=array(); 

				$save_update=1; $gmts_item_id="";
				
				$gmtsItemOrdCri=sql_select("select gmts_item_id, order_criteria from wo_po_details_master where job_no='$data[0]'");
				
				$gmts_item_id=$gmtsItemOrdCri[0][csf('gmts_item_id')];
				$orderCriteriaId=$gmtsItemOrdCri[0][csf('order_criteria')];
				$deFabSource=2;
				if($orderCriteriaId==3) $deFabSource=3;//ISD-22-05229 by Kausar
				
				//echo $deFabSource;
				
				$approved=return_field_value("approved", "wo_pre_cost_mst", "job_no='$data[0]'");
				if($approved==3){
					$approved=1;
				}
				$body_part_type_arr=return_library_array("select id, body_part_type from lib_body_part","id","body_part_type");

				$data_array=sql_select("select id, job_no, seq, nominated_supp_multi as nominated_supp, item_number_id, body_part_id, fab_nature_id, color_type_id, lib_yarn_count_deter_id as lib_yarn_count_deter_id, construction, composition, fabric_description, gsm_weight, color_size_sensitive, color, consumption_basis, avg_cons, fabric_source, rate, amount, avg_finish_cons, avg_process_loss, status_active, cons_breack_down, msmnt_break_down, color_break_down, yarn_breack_down, process_loss_method, marker_break_down, width_dia_type, avg_cons_yarn, gsm_weight_yarn, plan_cut_qty, job_plan_cut_qty, is_apply_last_update, uom, body_part_type, gsm_weight_type, quotdtlsid as quotation_id, budget_on, source_id,sourcing_rate, remarks from wo_pre_cost_fabric_cost_dtls where job_no='$data[0]' and status_active=1 and is_deleted=0 order by seq Asc");
				//nominated_supp
				$is_booking_arr=array();
				if (count($data_array)>0)
				{
					$data_arr=sql_select("select a.is_approved, a.entry_form, b.is_short, b.pre_cost_fabric_cost_dtls_id from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and b.job_no ='$data[0]' and b.booking_type='1' and a.is_deleted=0 and a.status_active=1 and b.status_active=1 and b.is_deleted=0 group by a.is_approved, a.entry_form, b.is_short, b.pre_cost_fabric_cost_dtls_id");

					foreach ($data_arr as $row)
					{
						if($row[csf('entry_form')]==108 || $row[csf('entry_form')]==271 || $row[csf('is_short')]==1 || $row[csf('is_approved')]==1)
						{
							$is_booking_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]]=$row[csf('pre_cost_fabric_cost_dtls_id')];
						}
					}
					unset($data_arr);
				}

				if (count($data_array) < 1 && $data[2]==1 && $data[5]==2 )//Price Quotation 
				{
					$data_array=sql_select("select id as quotation_id, seq, nominated_supp, item_number_id, body_part_id, fab_nature_id, color_type_id, lib_yarn_count_deter_id as lib_yarn_count_deter_id, construction, composition, fabric_description, gsm_weight, fab_cons_in_quotat_varia, avg_cons, fabric_source, rate, amount, avg_finish_cons, avg_process_loss, yarn_breack_down, width_dia_type, status_active, '' as body_part_type, gsm_weight_type, 2 as budget_on, 0 as source_id, '' as remarks from wo_pri_quo_fabric_cost_dtls where quotation_id='$data[1]' and status_active=1 and is_deleted=0 order by seq asc");
					$save_update=0;
				}
				
				if (count($data_array) < 1 && $data[2]==1 && $data[5]==4 )//Quick Costing [WVN]
				{
					$qc_no=$data[1];//return_field_value("qc_no", "wo_po_details_master a, qc_mst b", "job_no='$data[0]' and a.inquiry_id=b.inquery_id and b.is_deleted=0 and b.status_active=1");
					$data_array=sql_select("select id as quotation_id, 0 as nominated_supp, 0 as item_number_id, body_part_id, 0 as fab_nature_id, 0 as color_type_id, fab_id as lib_yarn_count_deter_id, '' as construction, '' as composition, '' as fabric_description, '' as gsm_weight, 0 as fab_cons_in_quotat_varia, tot_cons as avg_cons, 0 as fabric_source, rate, value as amount, 0 as avg_finish_cons, 0 as avg_process_loss, '' as yarn_breack_down, 0 as width_dia_type, status_active, '' as body_part_type, 0 as gsm_weight_type, '' as budget_on, 0 as source_id, uom, '' as remarks from qc_cons_rate_dtls where mst_id='$qc_no' and type=1 and tot_cons>0 and status_active=1 and is_deleted=0 order by id");
					

					$fabeicID="";
					foreach( $data_array as $frow)
					{
						if($fabeicID=="") $fabeicID=$frow[csf('lib_yarn_count_deter_id')]; else $fabeicID.=','.$frow[csf('lib_yarn_count_deter_id')];
					}
					$composition_arr=array();
					if($fabeicID!="")
					{
						$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count");
						
						$sql="select a.fab_nature_id, a.construction, a.type, a.design, a.gsm_weight, a.weight_type, a.color_range_id, a.stich_length, a.process_loss, b.copmposition_id, b.percent, b.count_id, b.type_id, a.id, b.id as bid,a.shrinkage_l,a.shrinkage_w from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.is_deleted=0 and a.id in ($fabeicID) order by a.id,b.id";
						//echo $sql;
						$sqlRes=sql_select($sql); $fabricDataArr=array();
						if (count($sqlRes)>0)
						{
							foreach( $sqlRes as $row )
							{
								$compo_per="";
								if(($row[csf('percent')]*1)>0) $compo_per=$row[csf('percent')]."% "; else $compo_per="";
								if(array_key_exists($row[csf('id')],$composition_arr))
								{
									$composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('copmposition_id')]]." ".$compo_per.$lib_yarn_count[$row[csf('count_id')]]." ".$yarn_type[$row[csf('type_id')]].",";
								}
								else
								{
									$composition_arr[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$compo_per.$lib_yarn_count[$row[csf('count_id')]]." ".$yarn_type[$row[csf('type_id')]].",";
								}
								
								$fabricDataArr[$row[csf('id')]]['construction']=$row[csf('construction')];
								$fabricDataArr[$row[csf('id')]]['fab_nature_id']=$row[csf('fab_nature_id')];
								$fabricDataArr[$row[csf('id')]]['gsm_weight']=$row[csf('gsm_weight')];
								$fabricDataArr[$row[csf('id')]]['process_loss']=$row[csf('process_loss')];
								$fabricDataArr[$row[csf('id')]]['weight_type']=$row[csf('weight_type')];
								$fabricDataArr[$row[csf('id')]]['type']=$row[csf('type')];
								$fabricDataArr[$row[csf('id')]]['design']=$row[csf('design')];
								
								
								if(array_key_exists($row[csf('id')],$fab_description))
								{
									$fab_description[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
								}
								else
								{
									$fab_description[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
								}
							}
							unset($sqlRes);
						}
					}
					$save_update=0;
				}
				
				if (count($data_array)>0)
				{
					$i=0;
					$fabeicID="";
					foreach( $data_array as $frow)
					{
						if($fabeicID=="") $fabeicID=$frow[csf('lib_yarn_count_deter_id')]; else $fabeicID.=','.$frow[csf('lib_yarn_count_deter_id')];
					}
					$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count");
					$sql="select  a.id,a.shrinkage_l,a.shrinkage_w from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.is_deleted=0 and a.id in ($fabeicID) order by a.id,b.id";
					//echo $sql;
					
					$sqlRes=sql_select($sql); //$fabricDataArr=array();
					if (count($sqlRes)>0)
					{
						foreach( $sqlRes as $row )
						{
							$fabricDataArr[$row[csf('id')]]['shrinkage_l']=$row[csf('shrinkage_l')];
							$fabricDataArr[$row[csf('id')]]['shrinkage_w']=$row[csf('shrinkage_w')];
						}
						unset($sqlRes);
					}
					foreach( $data_array as $row )
					{
						$i++;
						$seq='';
                   		if($row[csf("seq")]=="" || $row[csf("seq")]==0) $seq=$i; else $seq=$row[csf("seq")];
						if($db_type==0)
						{
							$cons_breack_down=$row[csf('cons_breack_down')];
							$msmnt_break_down=$row[csf('msmnt_break_down')];
						}
						else if($db_type==2)
						{
							if($row[csf('cons_breack_down')] !="") $cons_breack_down=$row[csf('cons_breack_down')]->load();
							if($row[csf('msmnt_break_down')] !="") $msmnt_break_down=$row[csf('msmnt_break_down')]->load();
						}
						//echo $save_update.",".$data[5];
						
						if($save_update==0 && $data[5]==4)
						{
							$row[csf('construction')]=$fabricDataArr[$row[csf('lib_yarn_count_deter_id')]]['construction'];
							$row[csf('fab_nature_id')]=$fabricDataArr[$row[csf('lib_yarn_count_deter_id')]]['fab_nature_id'];
							$row[csf('gsm_weight')]=$fabricDataArr[$row[csf('lib_yarn_count_deter_id')]]['gsm_weight'];
							$row[csf('avg_process_loss')]=$fabricDataArr[$row[csf('lib_yarn_count_deter_id')]]['process_loss'];
							$row[csf('composition')]=$composition_arr[$row[csf('lib_yarn_count_deter_id')]];
							$row[csf('gsm_weight_type')]=$fabricDataArr[$row[csf('lib_yarn_count_deter_id')]]['weight_type'];
							$row[csf("width_dia_type")]=1;
							$row[csf("color_size_sensitive")]=1;
							$row[csf("item_number_id")]=$gmts_item_id;
							$row[csf("fabric_source")]=2;
							
							if($row[csf('fab_nature_id')]==2)
							{
								$row[csf('fabric_description')]=$row[csf('construction')].' '.$fab_description[$row[csf('lib_yarn_count_deter_id')]];
							}
							else if($row[csf('fab_nature_id')]==3)
							{
								$row[csf('fabric_description')]=$fabricDataArr[$row[csf('lib_yarn_count_deter_id')]]['type'].' '.$row[csf('construction')].' '.$fabricDataArr[$row[csf('lib_yarn_count_deter_id')]]['design'].' '.$fab_description[$row[csf('lib_yarn_count_deter_id')]];
							}
						}
						
						$dis=0; $txt_dis="";
						if($approved!=1)
						{
							$disabled=0; $btn_disabled=0; $grey_cons = 0;
							if($is_booking_arr[$row[csf('id')]]!="")
							{
								$disabled=1; $btn_disabled=1; $txt_dis="disabled"; $grey_cons = 0;
							}
						}
						else if( $component_approved!=1)
						{
							$disabled=0; $btn_disabled=0; $grey_cons = 0;
							if($is_booking_arr[$row[csf('id')]]!="") {
								$disabled=1; $btn_disabled=1; $txt_dis="disabled"; $grey_cons = 0;
							}
						}

						if($approved==1 || $component_approved==1)
						{
							$disabled=1; $btn_disabled=1; $txt_disabled="disabled"; $grey_cons = 0;
						}
						
						if($save_update==0)
						{
							$row[csf("fabric_source")]=$deFabSource;
							if($deFabSource==3) $sourceDis="1";
						}
						else
						{
							if($deFabSource==3) $sourceDis="1";
						}
						if($disabled==1) $sourceDis=$disabled;
						//echo $deFabSource.'';

						$uom=12;
						if($row[csf("fab_nature_id")]==3)
						{
							if($save_update==0)
							{
								if($row[csf('uom')]==0) $uom=27; else $uom=$row[csf('uom')];
							}
							else
							{
								if($row[csf('uom')]==0) $uom=27; else $uom=$row[csf('uom')];
							}
						}
						else
						{
							if($save_update==0)
							{
								if($row[csf('uom')]==0) $uom=12; else $uom=$row[csf('uom')];
							}
							else
							{
								if($row[csf('uom')]==0) $uom=12; else $uom=$row[csf('uom')];
							}
						}
						
						$is_last_app_msg=""; $is_last_app_msg_id=0; $changedmsgcolor="";
						$applyLastUpdateArr[$row[csf("id")]]=$row[csf("is_apply_last_update")];
						if($row[csf("is_apply_last_update")]==2)
						{
							$is_last_app_msg="Color Size Changed.";
							$is_last_app_msg_id="1";
							$changedmsgcolor="red";
						}

						if($row[csf("body_part_type")]=="") $row[csf("body_part_type")]=$body_part_type_arr[$row[csf("body_part_id")]];
						$nominated_supp_str="";
						$exnominated_supp=explode(",",$row[csf('nominated_supp')]);
						foreach($exnominated_supp as $supp)
						{
							if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_fabric[$supp]; else $nominated_supp_str.=','.$supplier_library_fabric[$supp];
						}

						if($row[csf("budget_on")]=="" || $row[csf("budget_on")]==0){
							$budget_on=$fabricBudgetOn;
						} 
						else{
							$budget_on=$row[csf("budget_on")];
						}

						if($variable_editable==1){
							$sensitive_disabled=1;
						}
						else{
							$sensitive_disabled=$disabled;
						}
						
						//echo $sourceDis.'D';
						?>
							<tr id="fabriccosttbltr_<?=$i; ?>" align="center">
                            	<td><input type="text" id="seq_<?=$i; ?>" name="seq_<?=$i; ?>" class="text_boxes_numeric" style="width:18px" value="<?=$seq; ?>" /></td>
                                <td><?=create_drop_down( "cbogmtsitem_".$i, 80, $garments_item,"", 1, "--Select Item--", $row[csf("item_number_id")], "make_avg_for_same_row();",$disabled,$gmts_item_id ); ?></td>
                                <td>
                                    <input type="text" id="txtbodyparttext_<?=$i; ?>" name="txtbodyparttext_<?=$i; ?>" class="text_boxes" style="width:80px" onDblClick="open_body_part_popup(<?=$i; ?>);" value="<?=$body_part[$row[csf("body_part_id")]]; ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?>  title="<?=$row[csf("body_part_id")]; ?>" readonly/>
                                    <input type="hidden" id="txtbodypart_<?=$i; ?>" name="txtbodypart_<?=$i; ?>" class="text_boxes" style="width:90px" value="<?=$row[csf("body_part_id")]; ?>" readonly/>
                                </td>
                                <td><?=create_drop_down( "txtbodyparttype_".$i, 60, $body_part_type, "", 1, "-Display-", $row[csf("body_part_type")], "",1,"" );  ?></td>
                                <td><?=create_drop_down( "cbofabricnature_".$i, 80, $item_category,"", 3, "", $row[csf("fab_nature_id")], "make_avg_for_same_row()",$disabled,"2,3" ); ?></td>
                                <td><? echo create_drop_down( "cbocolortype_".$i, 70, $color_type,"", 1, "-- Select --", $row[csf("color_type_id")], "",$disabled,"1,2,3,4,5,6,7,20,25,26,28,38,39,42,49" ); //issue Id-16654, 2022 Yr, 2 add for Pretty  ?></td>
                                <td><input type="hidden" id="libyarncountdeterminationid_<?=$i; ?>" name="libyarncountdeterminationid_<?=$i; ?>" class="text_boxes" style="width:10px" value="<?=$row[csf("lib_yarn_count_deter_id")];  ?>" readonly />
                                    <input type="hidden" id="oldlibyarncountdeterminationid_<?=$i; ?>" name="oldlibyarncountdeterminationid_<?=$i; ?>" class="text_boxes" style="width:10px" value="<?=$row[csf("lib_yarn_count_deter_id")]; ?>" readonly />
                                    <input type="hidden" id="construction_<?=$i; ?>" name="construction_<?=$i; ?>" class="text_boxes" style="width:10px" value="<?=$row[csf("construction")]; ?>" readonly/>
                                    <input type="hidden" id="composition_<?=$i; ?>" name="composition_<?=i; ?>" class="text_boxes" style="width:10px" value="<?=$row[csf("composition")]; ?>" readonly  />
                                    <input type="text" id="fabricdescription_<?=$i; ?>" name="fabricdescription_<?=$i; ?>" class="text_boxes" style="width:120px; background-color:<?=$changedmsgcolor; ?>" onDblClick="open_fabric_decription_popup(<?=$i; ?>);" title="<?=$row[csf('fabric_description')].','.$fabricDataArr[$row[csf('lib_yarn_count_deter_id')]]['shrinkage_l'].','.$fabricDataArr[$row[csf('lib_yarn_count_deter_id')]]['shrinkage_w']; ?>" value="<?=$row[csf("fabric_description")]; ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> readonly/>
                                </td>
                                <td><? asort($fabric_source); echo create_drop_down( "cbofabricsource_".$i, 70, $fabric_source, "", 0, "", $row[csf("fabric_source")], "enable_disable( this.value,'txtrate_*txtamount_', $i );",$sourceDis,"2,3,4" ); ?></td>
                                <td>
                                	<?
                                		echo create_drop_down( "cbomsource_".$i, 60, $commission_particulars, "",1," -- Select Source --", $row[csf("source_id")], "",$disabled,'' );
                                	?>
                                </td>
                                <td>                                	
		                            <input readonly type="text" id="txtnominasupplier_<?=$i; ?>" name="txtnominasupplier_<?=$i; ?>" class="text_boxes" placeholder="Browse" style="width:80px" value="<?=$nominated_supp_str; ?>" <?=$txt_disabled; echo $txt_dis; ?> onDblClick="fncopenpopup_fabricsupplier(<?=$i; ?>);"/>
		                            <input type="hidden" id="cbonominasupplier_<?=$i; ?>" name="cbonominasupplier_<?=$i; ?>" class="text_boxes" style="width:110px" value="<?=$row[csf("nominated_supp")]; ?>" />
                                </td>
                                <td><? asort($fabric_typee); echo create_drop_down( "cbowidthdiatype_".$i, 60, $fabric_typee,"", 1, "-- Select --", $row[csf("width_dia_type")], "",$disabled,"" ); ?></td>
                                <td><input type="text" id="txtgsmweight_<?=$i; ?>" name="txtgsmweight_<?=$i; ?>" class="text_boxes_numeric" style="width:32px" onBlur="sum_yarn_required();" value="<?=$row[csf("gsm_weight")]; ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> avglvalue="<?=$row[csf("gsm_weight_yarn")]; ?>" title="<?=$row[csf("gsm_weight_yarn")]; ?>"/>
                                    <input type="hidden" id="avgtxtgsmweight_<?=$i; ?>" name="avgtxtgsmweight_<?=$i; ?>" class="text_boxes_numeric" style="width:30px"  value="<?=$row[csf("gsm_weight_yarn")]; ?>" readonly />
                                </td>
                                <td><?=create_drop_down( "txtgsmweighttype_".$i, 100, $fabric_weight_type,"", 1, "--Select--", $row[csf("gsm_weight_type")], "",$disabled,"" ); ?></td>
                                <td><?=create_drop_down( "cbocolorsizesensitive_".$i, 100, $size_color_sensitive,"", 1, "--Select--", $row[csf("color_size_sensitive")], "control_color_field($i);",$sensitive_disabled,"1,3" ); ?></td>
                                <td><input type="text" id="txtcolor_<?=$i; ?>" name="txtcolor_<?=$i; ?>" class="text_boxes" style="width:65px" onClick="open_color_popup(<?=$i; ?>);" value="<?=$color_library[$row[csf("color")]]; ?>" <? if($row[csf("color_size_sensitive")] ==3){echo "";}else{echo "disabled";}?> /></td>
                                <td><?=create_drop_down( "consumptionbasis_".$i, 70, $consumtion_basis,'', 0, '', $row[csf('consumption_basis')], "",$disabled,"" ); ?></td>
                                <td><?=create_drop_down( "uom_".$i, 50, $unit_of_measurement,'', 1, '-select-', $uom, "",$disabled,"1,12,23,27" ); ?></td>
                                <td><input placeholder="Browse" type="text" id="txtconsumption_<?=$i; ?>" name="txtconsumption_<?=$i; ?>" onBlur="math_operation( 'txtamount_<?=$i; ?>', 'txtconsumption_<?=$i; ?>*txtrate_<?=$i; ?>', '*','',{dec_type:1,comma:0, currency:document.getElementById('cbo_currercy').value}); sum_yarn_required(); set_sum_value( 'txtamount_sum', 'txtamount_','tbl_fabric_cost');"  onDblClick="set_session_large_post_data('requires/pre_cost_entry_controller_v2.php?action=consumption_popup', 'Consumption Entry Form','txtbodypart_<?=$i; ?>', 'cbofabricnature_<?=$i; ?>', 'txtgsmweight_<?=$i; ?>','<?=$i; ?>','updateid_<?=$i; ?>')" class="text_boxes_numeric" style="width:55px" value="<?=$row[csf("avg_cons")]; ?>" avglvalue="<?=$row[csf("avg_cons_yarn")]; ?>" title="<?=$row[csf("avg_cons_yarn")]; ?>"  readonly <? if($grey_cons==0){echo "";}else{echo "disabled";}?>/>
                                    <input type="hidden" id="avgtxtconsumption_<?=$i; ?>" name="avgtxtconsumption_<?=$i; ?>" class="text_boxes_numeric" style="width:50px" value="<?=$row[csf("avg_cons_yarn")]; ?>" readonly/>
                                </td>
                                <td><input type="text" id="txtrate_<?=$i; ?>" name="txtrate_<?=$i; ?>" onBlur="math_operation('txtamount_<?=$i; ?>', 'txtconsumption_<?=$i; ?>*txtrate_<?=$i; ?>', '*','',{dec_type:1,comma:0,currency:document.getElementById('cbo_currercy').value} ); set_sum_value( 'txtamount_sum', 'txtamount_','tbl_fabric_cost');" class="text_boxes_numeric" style="width:40px" value="<?=$row[csf("rate")]; ?>" <? if($row[csf("fabric_source")]==2){echo "";}else{echo "disabled";}?> readonly/>
                               <input type="hidden" id="txtsourcingrate_<?=$i; ?>" name="txtsourcingrate_<?=$i; ?>"  class="text_boxes_numeric" style="width:40px" value="<?=$row[csf("sourcing_rate")]; ?>"/>
                                </td>
                                <td><input type="text" id="txtamount_<?=$i; ?>" onBlur="set_sum_value('txtamount_sum', 'txtamount_','tbl_fabric_cost' );" name="txtamount_<?=$i; ?>" class="text_boxes_numeric" style="width:60px" value="<?=$row[csf("amount")]; ?>" <? if($row[csf("fabric_source")]==2 && $disabled==0){echo "";}else{echo "disabled";}?>  disabled /></td>
                                <td><input type="text" id="totalqty_<?=$i; ?>" name="totalqty_<?=$i; ?>" class="text_boxes_numeric" style="width:60px" value="" placeholder="Click to Load" onClick="loadTotal(<?=$i; ?>,'fabric');" readonly /></td>
                                <td><input type="text" id="totalamount_<?=$i; ?>" name="totalamount_<?=$i; ?>" class="text_boxes_numeric" style="width:60px" value=""  disabled />
								<td><input type="text" id="txtremark_<?=$i; ?>" name="txtremark_<?=$i; ?>" class="text_boxes" style="width:60px" value="<?=$row[csf("remarks")]; ?>" <? if($row[csf("fabric_source")]==2 && $disabled==0){echo "";}else{echo "disabled";}?>/>
                                <input type="hidden" id="budgeton_<?=$i; ?>" name="budgeton_<?=$i; ?>" class="text_boxes" style="width:20px" value="<?=$budget_on; ?>" />
                                </td>
                                <td>
                                    <input type="hidden" id="cbostatus_<?=$i; ?>" name="cbostatus_<?=$i; ?>" class="text_boxes" style="width:90px" value="<?=$row[csf("status_active")]; ?>" disabled />
                                    <input type="button" id="increase_<?=$i; ?>" style="width:25px" class="formbutton" value="+" onClick="add_break_down_tr(<?=$i; ?>,this);"  <? if($approved==1 || $component_approved==1) {echo "disabled";} else {echo "";}?> />
                                    <input type="button" id="decrease_<?=$i; ?>" style="width:25px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<?=$i; ?> ,'tbl_fabric_cost',this);" <? if($disabled==0){echo "";}else{echo "disabled";}?> />
                                    <input type="hidden" id="txtfinishconsumption_<?=$i; ?>" name="txtfinishconsumption_<?=$i; ?>" class="text_boxes_numeric" style="width:60px" value="<?=$row[csf("avg_finish_cons")]; ?>" disabled/>
                                    <input type="hidden" id="txtavgprocessloss_<?=$i; ?>"  name="txtavgprocessloss_<?=$i; ?>" class="text_boxes_numeric" style="width:60px" value="<?=$row[csf("avg_process_loss")]; ?>" disabled/>
                                    <input type="hidden" id="consbreckdown_<?=$i; ?>" name="consbreckdown_<?=$i; ?>" class="text_boxes" style="width:90px" value="<?=$cons_breack_down; ?>" disabled />
                                    <input type="hidden" id="msmntbreackdown_<?=$i; ?>" name="msmntbreackdown_<?=$i; ?>" class="text_boxes" style="width:90px" value="<?=$msmnt_break_down; ?>" disabled/>
                                    <input type="hidden" id="markerbreackdown_<?=$i; ?>" name="markerbreackdown_<?=$i; ?>" class="text_boxes" style="width:90px" value="<?=$row[csf("marker_break_down")]; ?>" disabled/>
                                    <input type="hidden" id="colorbreackdown_<?=$i; ?>" name="colorbreackdown_<?=$i; ?>" class="text_boxes" style="width:90px" value="<?=$row[csf("color_break_down")]; ?>" disabled/>
                                    <input type="hidden" id="yarnbreackdown_<?=$i; ?>" name="yarnbreackdown_<?=$i; ?>" class="text_boxes" style="width:90px" value="<?=$row[csf("yarn_breack_down")]; ?>" disabled/>
                                    <input type="hidden" id="processlossmethod_<?=$i; ?>" name="processlossmethod_<?=$i; ?>" value="<?=$row[csf("process_loss_method")]; ?>" disabled/>
                                    <input type="hidden" id="updateid_<?=$i; ?>" name="updateid_<?=$i; ?>" class="text_boxes" style="width:20px" value="<?=$row[csf("id")]; ?>" disabled/>
                                    <!-- Price quatation fabric cost Id-->
                                    <input type="hidden" id="prifabcostdtlsid_<?=$i; ?>" name="prifabcostdtlsid_<?=$i; ?>" class="text_boxes" style="width:20px" value="<?=$row[csf("quotation_id")]; ?>"  disabled/>
                                    <input type="hidden" id="isclickedconsinput_<?=$i; ?>" name="isclickedconsinput_<?=$i; ?>" class="text_boxes" style="width:20px" value="<?=$row[csf("is_apply_last_update")]; ?>"  disabled/>
                                    <input type="hidden" id="plancutqty_<?=$i; ?>" name="plancutqty_<?=$i; ?>" class="text_boxes" style="width:20px" value="<?=$row[csf("plan_cut_qty")]; ?>" disabled/>
                                    <input type="hidden" id="jobplancutqty_<?=$i; ?>" name="jobplancutqty_<?=$i; ?>" class="text_boxes" style="width:20px" value="<?=$row[csf("job_plan_cut_qty")]; ?>" disabled/>
                                    <input type="hidden" id="precostapproved_<?=$i; ?>" name="precostapproved_<?=$i; ?>"  class="text_boxes" style="width:20px" value="<?=$approved   ?> " disabled/>
                                    <input type="hidden" id="isconspopupupdate_<?=$i; ?>" name="isconspopupupdate_<?=$i; ?>" class="text_boxes" style="width:20px" value="0" disabled/>
                                <!-- Price quatation fabric cost Id end-->
                                </td>
                            </tr>
						<?
						}
					}
					else
					{
						$selected_sensivity=1;
						$variable_editable=0;
						$sensivity_variable_sql=sql_select("select color_sensivity,editable from variable_order_tracking where  company_name='$data[3]' and variable_list=97 and status_active=1 and is_deleted=0");
						if(count($sensivity_variable_sql)>0){
							foreach($sensivity_variable_sql as $row){
								$selected_sensivity=$row[csf('color_sensivity')];
								$variable_editable=$row[csf('editable')];
							}
						}
						
						
						$selected_item=0;
						//echo $variArr[3].'T';
						$gmts_item_id_arr=explode(",",$gmts_item_id);
						if(count($gmts_item_id_arr)==1)
						{
							$selected_item=	$gmts_item_id;
						}
						$uom_fld_accs=$fld_lvl_acss_arr['cbo_fabric_costing_uom']['defalt_value'];
						$fab_nature_fld_accs=$fld_lvl_acss_arr['cbo_fabric_costing_fab_nature']['defalt_value'];
						
						if($deFabSource==3) $sourceDis="1";
						
						if($disabled==1) $sourceDis=$disabled;
						
						?>
						<tr id="fabriccosttbltr_1" align="center">
                        	<td><input type="text" id="seq_1" name="seq_1" class="text_boxes_numeric" style="width:18px" value="1" /></td>
                            <td><?=create_drop_down( "cbogmtsitem_1", 80, $garments_item,"", 1, "-- Select Item --", $selected_item, "make_avg_for_same_row()" ,"",$gmts_item_id); ?></td>
                            <td><input type="text" id="txtbodyparttext_1" name="txtbodyparttext_1" class="text_boxes" style="width:80px" onDblClick="open_body_part_popup(1)" value="<? echo $body_part[$row[csf("body_part_id")]]; ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> title="<? echo $row[csf("body_part_id")]; ?>" placeholder="DblClick" readonly/>
                            	<input type="hidden" id="txtbodypart_1" name="txtbodypart_1" class="text_boxes" style="width:90px" value="<? echo $row[csf("body_part_id")]; ?>" title="<? echo $row[csf("body_part_id")]; ?>" readonly/>
                            </td>
                            <td><? echo create_drop_down( "txtbodyparttype_1", 60, $body_part_type, "", 1, "-Display-", "", "",1,"" );  ?></td>
                            <td><? echo create_drop_down( "cbofabricnature_1", 80, $item_category,"", 3, "", "3", "make_avg_for_same_row()","","2,3" ); ?></td>
                            <td><? echo create_drop_down( "cbocolortype_1", 70, $color_type,"", 1, "-- Select --", $selected, "","","1,2,3,4,5,6,7,20,25,26,28,38,39,42,49" ); ?></td>
                            <td>
                                <input type="hidden" id="libyarncountdeterminationid_1" name="libyarncountdeterminationid_1" class="text_boxes" style="width:10px"  />
                                <input type="hidden" id="oldlibyarncountdeterminationid_1" name="oldlibyarncountdeterminationid_1" class="text_boxes" style="width:10px"  />
                                <input type="hidden" id="construction_1" name="construction_1" class="text_boxes" style="width:10px"  />
                                <input type="hidden" id="composition_1" name="composition_1" class="text_boxes" style="width:10px"  />
                                <input type="text" id="fabricdescription_1" placeholder="Double Click To Search"  name="fabricdescription_1"  class="text_boxes" style="width:140px" onDblClick="open_fabric_decription_popup(1);" readonly />
                            </td>
                            <td><? echo create_drop_down( "cbofabricsource_1", 80, $fabric_source, "", 0, "",$deFabSource, "enable_disable( this.value,'txtrate_*txtamount_', 1 );",$sourceDis,"2,3,4" );  ?></td>
                            <td>
                            	<?
                            		echo create_drop_down( "cbomsource_1", 60, $commission_particulars, "",1," -- Select Source --", "", "",$disabled,'' );
                            	?>
                            </td>
                            <td>
                            	<input readonly type="text" id="txtnominasupplier_1" name="txtnominasupplier_1" class="text_boxes" placeholder="Browse" style="width:80px" value="" onDblClick="fncopenpopup_fabricsupplier(1);"/>
		                        <input type="hidden" id="cbonominasupplier_1" name="cbonominasupplier_1" class="text_boxes" style="width:110px" value="" />
                                </td>
                            <td><?  echo create_drop_down( "cbowidthdiatype_1", 60, $fabric_typee,"", 1, "-- Select --", 1, "","","" ); ?></td>
                            <td>
                                <input type="text" id="txtgsmweight_1" name="txtgsmweight_1" class="text_boxes_numeric" style="width:32px" onBlur="sum_yarn_required()">
                                <input type="hidden" id="avgtxtgsmweight_1" name="avgtxtgsmweight_1" class="text_boxes_numeric" style="width:30px" onBlur="sum_yarn_required()">
                            </td>
                            <td><? echo create_drop_down( "txtgsmweighttype_1", 100, $fabric_weight_type,"", 1, "--Select--", $selected, "","","" ); ?></td>
                            <td>
							<? if($selected_sensivity!=""){?>
								<?=create_drop_down( "cbocolorsizesensitive_1", 100, $size_color_sensitive,"", 1, "-- Select --", $selected_sensivity, "control_color_field(1)",$variable_editable,"1,3" ); ?> </td>
							<? } else{ ?>
								<?  echo create_drop_down( "cbocolorsizesensitive_1", 100, $size_color_sensitive,"", 1, "-- Select --", 1, "control_color_field(1)","","1,3" ); ?>
							<? }?>
                            <td>
								<? if($selected_sensivity==3){?>
									<input type="text" id="txtcolor_1" name="txtcolor_1" class="text_boxes" style="width:65px"  onClick="open_color_popup(1)" value="<? //echo $row[csf("gsm_weight")];  ?>" /></td>
								<? } else{?>
									<input type="text" id="txtcolor_1" name="txtcolor_1" class="text_boxes" style="width:65px"  onClick="open_color_popup(1)" value="<? //echo $row[csf("gsm_weight")];  ?>"  disabled/></td>
								<?}?>
							
                            <td><? echo create_drop_down( "consumptionbasis_1", 70, $consumtion_basis,'', 0, '', '', "","","" ); ?></td>
                            <td><? echo create_drop_down( "uom_1", 50, $unit_of_measurement,'', 1, '-Select-','27', "",'',"1,12,23,27" ); ?></td>
                            <td>
                                <input type="text" id="txtconsumption_1" name="txtconsumption_1" onBlur="math_operation( 'txtamount_1', 'txtconsumption_1*txtrate_1', '*','',{dec_type:1,comma:0,currency:document.getElementById('cbo_currercy').value} );sum_yarn_required();set_sum_value( 'txtamount_sum', 'txtamount_','tbl_fabric_cost' )"  onDblClick="set_session_large_post_data('requires/pre_cost_entry_controller_v2.php?action=consumption_popup', 'Consumption Entry Form','txtbodypart_1','cbofabricnature_1','txtgsmweight_1','1','updateid_1')"    class="text_boxes_numeric" style="width:55px" placeholder="Browse" readonly  />
                                <input type="hidden" id="avgtxtconsumption_1" name="avgtxtconsumption_1" class="text_boxes_numeric" style="width:50px"  readonly/>
                            </td>
                            <td><input type="text" id="txtrate_1" onBlur="math_operation( 'txtamount_1', 'txtconsumption_1*txtrate_1', '*','',{dec_type:1,comma:0, currency:document.getElementById('cbo_currercy').value});set_sum_value( 'txtamount_sum', 'txtamount_' ,'tbl_fabric_cost') "  name="txtrate_1" class="text_boxes_numeric" style="width:40px" disabled="">  <input type="hidden" id="txtsourcingrate_1" name="txtsourcingrate_1"  class="text_boxes_numeric" style="width:40px" />
                            
                            </td>
                            <td><input type="text" id="txtamount_1"  onBlur="set_sum_value( 'txtamount_sum', 'txtamount_','tbl_fabric_cost') " disabled=""  name="txtamount_1" class="text_boxes_numeric" style="width:60px"></td>
                            <td>
                            	<input type="text" id="totalqty_1"  name="totalqty_1" class="text_boxes_numeric" style="width:60px" value="" placeholder="Click to Load" onClick="loadTotal(1,'fabric');" readonly />
                            </td>
                            <td><input type="text" id="totalamount_1"  name="totalamount_1" class="text_boxes_numeric" style="width:60px" value=""  readonly  />
                            <input type="hidden" id="budgeton_1" name="budgeton_1" value="<?=$fabricBudgetOn; ?>"  />
                            </td>
							<td><input type="text" id="txtremark_1" name="txtremark_1" class="text_boxes" style="width:60px" value=""/>
                            <td>
                                <input type="hidden" id="cbostatus_1" name="cbostatus_1" class="text_boxes" style="width:90px" value="1" readonly />
                                <input type="button" id="increase_1" style="width:25px" class="formbutton" value="+" onClick="add_break_down_tr(1,this);" />
                                <input type="button" id="decrease_1" style="width:25px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(1,'tbl_fabric_cost',this);" />
                                <input type="hidden" id="txtfinishconsumption_1" name="txtfinishconsumption_1" class="text_boxes_numeric" style="width:60px" readonly/>
                                <input type="hidden" id="txtavgprocessloss_1" name="txtavgprocessloss_1" class="text_boxes_numeric" style="width:60px"  readonly/>
                                <input type="hidden" id="consbreckdown_1" name="consbreckdown_1" value=""  class="text_boxes" style="width:90px" />
                                <input type="hidden" id="msmntbreackdown_1" name="msmntbreackdown_1" value="" class="text_boxes" style="width:90px" />
                                <input type="hidden" id="markerbreackdown_1" name="markerbreackdown_1" value="" class="text_boxes" style="width:90px" />
                                <input type="hidden" id="colorbreackdown_1" name="colorbreackdown_1" value="" class="text_boxes" style="width:90px" />
                                <input type="hidden" id="yarnbreackdown_1" name="yarnbreackdown_1" value="" class="text_boxes" style="width:90px" />
                                <input type="hidden" id="processlossmethod_1" name="processlossmethod_1"/>
                                <input type="hidden" id="updateid_1" name="updateid_1" value="" class="text_boxes" style="width:20px" />
                                <input type="hidden" id="prifabcostdtlsid_1" name="prifabcostdtlsid_1"  class="text_boxes" style="width:20px"  />
                                <input type="hidden" id="isclickedconsinput_1" name="isclickedconsinput_1"  class="text_boxes" style="width:20px" value="1"  />
                                <input type="hidden" id="plancutqty_1" name="plancutqty_1"  class="text_boxes" style="width:20px"/>
                                <input type="hidden" id="jobplancutqty_1" name="jobplancutqty_1"  class="text_boxes" style="width:20px"/>
                                <input type="hidden" id="precostapproved_1" name="precostapproved_1"  class="text_boxes" style="width:20px" value="0" readonly/>
                                <input type="hidden" id="isconspopupupdate_1" name="isconspopupupdate_1"  class="text_boxes" style="width:20px" value="0" readonly/>
                            </td>
						</tr>
					<? } ?>
                </tbody>
            </table>
            <br/>
            <table width="1530" cellspacing="0" class="rpt_table" border="0" rules="all" style="display:none">
                <tfoot>
                <?
				$yarn_needed=0;
				$data_array1=sql_select("select fab_yarn_req_kg, fab_woven_req_yds, fab_knit_req_kg,fab_woven_fin_req_yds,fab_knit_fin_req_kg, fab_amount,avg,pro_woven_grey_fab_req_yds,pro_knit_grey_fab_req_kg,pro_woven_fin_fab_req_yds,pro_knit_fin_fab_req_kg,pur_woven_grey_fab_req_yds,pur_knit_grey_fab_req_kg,pur_woven_fin_fab_req_yds,pur_knit_fin_fab_req_kg,woven_amount,knit_amount   from wo_pre_cost_sum_dtls where job_no='$data[0]' and status_active=1 and is_deleted=0 ");
				list($sum_data_array )=$data_array1;
				/*foreach ($data_array as $row)
				{*/
					$avg_value="";
					if($sum_data_array[csf("avg")]=="")$avg_value="Make AVG"; else $avg_value=$sum_data_array[csf("avg")];
				?>
                    	<tr>
                        	<th width="250">
                            <input type="button" id="avg" style="width:70px; display:none" class="formbutton" value="<? echo $avg_value; ?>" onClick="sum_yarn_required_avg(this.value)" /> &nbsp; Yarn Required(Kg)
                            <input type="text" id="tot_yarn_needed" name="tot_yarn_needed" class="text_boxes_numeric" style="width:50px;" value="<? echo $sum_data_array[csf("fab_yarn_req_kg")];$yarn_needed= $sum_data_array[csf("fab_yarn_req_kg")];?>" readonly/>
                            </th>
                            <th width="850">
                                Woven Grey Fab Req.(Yds)<input type="text" id="txtwoven_sum" name="txtwoven_sum" class="text_boxes_numeric" style="width:50px" value="<? echo $sum_data_array[csf("fab_woven_req_yds")] ?>" readonly />
                                Knit Grey Fab Req.(Kg)<input type="text" id="txtknit_sum"  name="txtknit_sum" class="text_boxes_numeric" style="width:50px" value="<? echo $sum_data_array[csf("fab_knit_req_kg")] ?>" readonly>
                                Woven Fin. Fab Req.(Yds)<input type="text" id="txtwoven_fin_sum" name="txtwoven_fin_sum" class="text_boxes_numeric" style="width:50px" value="<? echo $sum_data_array[csf("fab_woven_fin_req_yds")] ?>" readonly />
                                Knit Fin. Fab Req.(Kg) <input type="text" id="txtknit_fin_sum"  name="txtknit_fin_sum" class="text_boxes_numeric" style="width:50px" value="<? echo $sum_data_array[csf("fab_knit_fin_req_kg")] ?>"  readonly>
                            </th>
                            <th width="80">&nbsp;</th>
                            <th width="60">&nbsp;</th>
                            <th width="70"><input type="text" id="txtamount_sum" name="txtamount_sum" class="text_boxes_numeric" style="width:60px" value="<? echo $sum_data_array[csf("fab_amount")] ?>"  readonly></th>
                            <th width="70">&nbsp;</th>
                            <th width="70">&nbsp;</th>
                            <th>&nbsp;</th>
                        </tr>
                        <tr>
                            <th colspan="2">
                                Pro. Woven Grey Fab Req.(Yds)
                                <input type="text" id="txtwoven_sum_production" name="txtwoven_sum_production" class="text_boxes_numeric" style="width:60px" value="<? echo $sum_data_array[csf("pro_woven_grey_fab_req_yds")] ?>" readonly />
                                Pro. Knit Grey Fab Req.(Kg) <input type="text" id="txtknit_sum_production" name="txtknit_sum_production" class="text_boxes_numeric" style="width:60px" value="<? echo $sum_data_array[csf("pro_knit_grey_fab_req_kg")] ?>"  readonly>
                                Pro. Woven Fin. Fab Req.(Yds)
                                <input type="text" id="txtwoven_fin_sum_production" name="txtwoven_fin_sum_production" class="text_boxes_numeric" style="width:60px" value="<?  echo $sum_data_array[csf("pro_woven_fin_fab_req_yds")] ?>" readonly />
                                Pro. Knit Fin. Fab Req.(Kg) <input type="text" id="txtknit_fin_sum_production" name="txtknit_fin_sum_production" class="text_boxes_numeric" style="width:60px" value="<? echo $sum_data_array[csf("pro_knit_fin_fab_req_kg")] ?>" readonly>
                            </th>
                            <th width="80">&nbsp;</th>
                            <th width="60">&nbsp;</th>
                            <th>&nbsp;</th>
                            <th>&nbsp;</th>
                        </tr>
                        <tr>
                        	<th colspan="2">
                                Pur. Woven Grey Fab Req.(Yds)
                                <input type="text" id="txtwoven_sum_purchase" name="txtwoven_sum_purchase" class="text_boxes_numeric" style="width:60px" value="<? echo $sum_data_array[csf("pur_woven_grey_fab_req_yds")] ?>" readonly />
                                Pur. Knit Grey Fab Req.(Kg) <input type="text" id="txtknit_sum_purchase"  name="txtknit_sum_purchase" class="text_boxes_numeric" style="width:60px" value="<? echo $sum_data_array[csf("pur_knit_grey_fab_req_kg")] ?>"  readonly>
                                Pur. Woven Fin. Fab Req.(Yds)
                                <input type="text" id="txtwoven_fin_sum_purchase" name="txtwoven_fin_sum_purchase" class="text_boxes_numeric" style="width:60px" value="<?  echo $sum_data_array[csf("pur_woven_fin_fab_req_yds")] ?>" readonly />
                                Pur. Knit Fin. Fab Req.(Kg) <input type="text" id="txtknit_fin_sum_purchase"  name="txtknit_fin_sum_purchase" class="text_boxes_numeric" style="width:60px" value="<? echo $sum_data_array[csf("pur_knit_fin_fab_req_kg")] ?>"  readonly>
                            </th>
                            <th width="80">Woven  Amt</th>
                            <th width="60"><input type="text" id="txtwoven_amount_sum_purchase" name="txtwoven_amount_sum_purchase" class="text_boxes_numeric" style="width:55px" value="<? echo $sum_data_array[csf("woven_amount")] ?>"  readonly></th>
                            <th width="60">Kint  Amt</th>
                            <th width="70"><input type="text" id="txtkint_amount_sum_purchase" name="txtkint_amount_sum_purchase" class="text_boxes_numeric" style="width:55px" value="<? echo $sum_data_array[csf("knit_amount")] ?>"  readonly></th>
                            <th>&nbsp;</th>
                        </tr>
                        <? //}?>
                    </tfoot>
                </table>
                <table width="1490" cellspacing="0" class="" border="0">
                	<tr>
                        <td align="right" width="50%" class="button_container">
						<?
                            if ( count($data_array)>0)  
                            {
                                echo load_submit_buttons( $permission, "fnc_fabric_cost_dtls", $save_update,0,"fnc_fab_resetFrom()",3);
								//reset_form('fabriccost_3','','', 'cbofabricnature_,3,$i','$(\'#fabric_tbl_dtls_for  tr:not(:first)\').remove()')
                            }
                            else
                            {
                                echo load_submit_buttons( $permission, "fnc_fabric_cost_dtls", 0,0,"fnc_fab_resetFrom()",3);
                            }
                        ?>
                        </td>
                        <td align="left" width="50%" class="button_container" valign="top">
                        <?
                            if ( count($data_array)>0)
                            {
                                ?>
                                <input type="button" class="formbutton" style="width:100px" name="stripe_color" id="stripe_color" value="Stripe Color" onClick="open_stripe_color_popup();"/>
                                <input type="button" class="formbutton" style="width:80px; " name="add_img" id="add_img" value="Color Img" onClick="open_fabric_color_image_popup();" />
                                <?
                            }
						?>
                        </td>
                    </tr>
                </table>
            </form>
        </fieldset>
       </div>  
       <h3 style="width:790px;" align="left" class="accordion_h" onClick="show_hide_content('conversion_cost', '')">+Conversion Cost <? echo $approved_message; ?></h3>
       <div id="content_conversion_cost" style="display:none;" align="left">
    	<fieldset style="width:780px;">
        	<form id="conversionccost_5" autocomplete="off">
            	<table width="780" cellspacing="0" class="rpt_table" border="0" id="tbl_conversion_cost" rules="all">
                	<thead>
                    	<tr>
                        	<th width="235" style="color:#2A3FFF">Fabric Description</th>
                            <th width="110" style="color:#2A3FFF">Process</th>
                            <th width="50">Process Loss</th>
                            <th width="50" style="color:#2A3FFF">Req. Qty</th>
                            <th width="50">Avg.Req. Qty [Less Process Loss]</th>
                            <th width="50" style="color:#2A3FFF">Charge/ Unit</th>
                            <th width="70">Amount</th>
                            <th width="60">Status</th>
                            <th>&nbsp;</th>
                        </tr>
                    </thead>
                    <tbody>
                    <?
					$conversion_from_chart=return_field_value("conversion_from_chart", "variable_order_tracking", "company_name='$data[3]'  and variable_list=21 and status_active=1 and is_deleted=0");
					if($conversion_from_chart=="") $conversion_from_chart=2;

					if($conversion_from_chart==1) $readonly="readonly"; $readonly="";

					$fab_description=array();
					$fab_description_array=sql_select("select id, body_part_id, color_type_id, fabric_description from wo_pre_cost_fabric_cost_dtls where job_no='$data[0]' and  	fabric_source in(1,2) order by id");
					foreach( $fab_description_array as $row_fab_description_array )
					{
						$fab_description[$row_fab_description_array[csf("id")]]=	$body_part[$row_fab_description_array[csf("body_part_id")]].', '.$color_type[$row_fab_description_array[csf("color_type_id")]].', '.$row_fab_description_array[csf("fabric_description")];
					}

					$save_update=1;
					$data_array=sql_select("select id, job_no, fabric_description, cons_process, process_loss, req_qnty, avg_req_qnty, charge_unit, amount, color_break_down, charge_lib_id, is_apply_last_update, status_active from  wo_pre_cost_fab_conv_cost_dtls where job_no='$data[0]' and is_deleted=0 order by id");
					if(count($data_array)<1 && $data[2]==1)
					{
						$data_array=sql_select("select id, quotation_id, cost_head, cons_type,process_loss, req_qnty, charge_unit, amount, status_active from  wo_pri_quo_fab_conv_cost_dtls where quotation_id='$data[1]' and is_deleted=0");
					$save_update=0;
					}

					if ( count($data_array)>0)
					{
						$i=0;
						foreach( $data_array as $row )
						{
							$selected_fab_description="";
							if($row[csf("fabric_description")]!="") $selected_fab_description=$row[csf("fabric_description")];
							else $selected_fab_description=$row[csf("cost_head")];

							$selected_process="";
							if($row[csf("cons_process")]!="") $selected_process=$row[csf("cons_process")]; else $selected_process=$row[csf("cons_type")];
							$i++;

							if($approved==1) $disabled=1; else $disabled=0;
							if($component_approved==1)
							{
								$disabled=1; $btn_disabled=1;
							}
							else
							{
								$disabled=0; $btn_disabled=0;
							}
							
							$fabis_apply_last_update=$applyLastUpdateArr[$row[csf("fabric_description")]];
				 
							$is_apply_last_update=$row[csf("is_apply_last_update")];
							$is_last_app_msg=""; $changedmsgcolor="";
							if($is_apply_last_update==2 || $fabis_apply_last_update==2)
							{
								$is_last_app_msg="Color Size Changed.";
								$changedmsgcolor="Red";
							}

							?>
                            <tr id="conversion_1" align="center">
                                <td><? echo create_drop_down( "cbocosthead_".$i, 235, $fab_description, "",1," -- Select--", $selected_fab_description, "set_conversion_qnty(".$i.")",$disabled,"" ); ?></td>
                                <td><?  echo create_drop_down( "cbotypeconversion_".$i, 110, $conversion_cost_head_array,"", 1, "-- Select --", $selected_process, "set_conversion_charge_unit(".$i.",".$conversion_from_chart.")",$disabled,"" ); ?></td>
                                <td title="<?=$is_last_app_msg; ?>"><input type="text" id="txtprocessloss_<? echo $i; ?>" name="txtprocessloss_<? echo $i; ?>" class="text_boxes_numeric" style="width:38px; background-color:<?=$changedmsgcolor; ?>"  value="<? echo $row[csf("process_loss")];  ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> onChange="set_conversion_qnty(<? echo $i ?>)" readonly />
                                <input type="hidden" id="txtlastpdateid_<?=$i; ?>" name="txtlastpdateid_<?=$i; ?>" class="text_boxes" style="width:50px" value="<?=$row[csf("is_apply_last_update")]; ?>" /><input type="hidden" id="applastidchk_<?=$i; ?>" class="text_boxes" style="width:10px" value="<?=$row[csf("is_apply_last_update")]; ?>" readonly  />
                                
                                </td>
                               <td><input type="text" id="txtreqqnty_<? echo $i; ?>"  name="txtreqqnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:38px" onChange="calculate_conversion_cost( <? echo $i;?> )"  value="<? echo $row[csf("req_qnty")];  ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> readonly/></td>
                                <td><input type="text" id="txtavgreqqnty_<? echo $i; ?>"  name="txtavgreqqnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:38px" onChange="calculate_conversion_cost( <? echo $i;?> )"  value="<? echo $row[csf("avg_req_qnty")];  ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?>  readonly/></td>
                               <td><input type="text" id="txtchargeunit_<? echo $i; ?>"  name="txtchargeunit_<? echo $i; ?>" class="text_boxes_numeric" style="width:38px" onChange="calculate_conversion_cost( <? echo $i;?> )" onClick="set_conversion_charge_unit(<? echo $i;?>,<? echo $conversion_from_chart;?>)"  value="<? echo $row[csf("charge_unit")];?>"  <? if($disabled==0){echo "";}else{echo "disabled";}?> <? echo $readonly; ?>/></td>
                                <td><input type="text" id="txtamountconversion_<? echo $i; ?>" name="txtamountconversion_<? echo $i; ?>" class="text_boxes_numeric" style="width:58px" value="<? echo $row[csf("amount")]; ?>" readonly/></td>
                                <td><? echo create_drop_down( "cbostatusconversion_".$i, 60, $row_status,"", 0, "0", $row[csf("status_active")], '',$disabled,'' );  ?></td>
                                <td>
                                    <input type="button" id="increaseconversion_<? echo $i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_conversion_cost(<? echo $i; ?>,<? echo $conversion_from_chart;?> )" <? if($disabled==0){echo "";}else{echo "disabled";}?>/>
                                    <input type="button" id="decreaseconversion_<? echo $i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<? echo $i; ?> ,'tbl_conversion_cost',this);" <? if($disabled==0){echo "";}else{echo "disabled";}?>/>
                                    <input type="hidden" id="updateidcoversion_<? echo $i; ?>" name="updateidcoversion_<? echo $i; ?>"  class="text_boxes" style="width:20px" value="<?=$row[csf("id")]; ?>" />
                                    <input type="hidden" id="colorbreakdown_<? echo $i; ?>" name="colorbreakdown_<? echo $i; ?>"  class="text_boxes" style="width:20px" value="<?=$row[csf("color_break_down")]; ?>" />
                                    <input type="hidden" id="coversionchargelibraryid_<? echo $i; ?>" name="coversionchargelibraryid_<? echo $i; ?>"  class="text_boxes" style="width:20px" value="<? echo  $row[csf("charge_lib_id")]; ?>"   readonly />
                                 </td>
                            </tr>
                            <?
						}
					}
					else
					{
						$save_update=0;
						?>
						<tr id="conversion_1" align="center">
                            <td><? echo create_drop_down( "cbocosthead_1", 235, $fab_description, "",1," -- All Fabrics--", "", "set_conversion_qnty(1)","","" ); ?></td>
                            <td><? echo create_drop_down( "cbotypeconversion_1", 110, $conversion_cost_head_array,"", 1, "-- Select --", "", "set_conversion_charge_unit( 1,".$conversion_from_chart." )","","" ); ?></td>
                            <td><input type="text" id="txtprocessloss_1" name="txtprocessloss_1" class="text_boxes_numeric" style="width:38px"  value="" onChange="set_conversion_qnty(1)" readonly />
                            <input type="hidden" id="txtlastpdateid_1" name="txtlastpdateid_1" class="text_boxes" style="width:50px" value="" /><input type="hidden" id="applastidchk_1" class="text_boxes" style="width:10px" value="" readonly  />
                            </td>
                            <td><input type="text" id="txtreqqnty_1"  name="txtreqqnty_1" class="text_boxes_numeric" style="width:38px" onChange="calculate_conversion_cost( 1 )" value="" readonly /></td>
                            <td><input type="text" id="txtavgreqqnty_1"  name="txtavgreqqnty_1" class="text_boxes_numeric" style="width:38px" onChange="calculate_conversion_cost( 1 )" value="" readonly/></td>
                            <td><input type="text" id="txtchargeunit_1"  name="txtchargeunit_1" class="text_boxes_numeric" style="width:38px" onChange="calculate_conversion_cost( 1 )" onClick="set_conversion_charge_unit(1,<? echo $conversion_from_chart;?>)" <? echo $readonly; ?> value="" /></td>
                            <td><input type="text" id="txtamountconversion_1"  name="txtamountconversion_1" class="text_boxes_numeric" style="width:58px" value="" readonly /></td>
                            <td><?=create_drop_down( "cbostatusconversion_1", 60, $row_status,"", 0, "0", '', '','','' );  ?></td>
                            <td>
                                <input type="button" id="increaseconversion_1" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_conversion_cost(1,<?=$conversion_from_chart;?>)" />
                                <input type="button" id="decreaseconversion_1" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(1,'tbl_conversion_cost',this);" />
                                <input type="hidden" id="updateidcoversion_1" name="updateidcoversion_1"  class="text_boxes" style="width:20px" value=""  />
                                <input type="hidden" id="colorbreakdown_1" name="colorbreakdown_1"  class="text_boxes" style="width:20px" value=""  />
                                <input type="hidden" id="coversionchargelibraryid_1" name="coversionchargelibraryid_1"  class="text_boxes" style="width:20px" value="" readonly  />
                            </td>
                        </tr>
                <? } ?>
                </tbody>
            </table>
            <table width="780" cellspacing="0" class="rpt_table" border="0" rules="all">
            	<tfoot>
                    <tr>
                    	<th width="235">&nbsp;</th>
                        <th width="110">SUM:</th>
                            
                        <th width="50"><input type="text" id="txtconreqnty_sum" name="txtconreqnty_sum" class="text_boxes_numeric" style="width:38px" readonly /></th>
                        <th width="50"><input type="text" id="txtavgconreqnty_sum" name="txtavgconreqnty_sum" class="text_boxes_numeric" style="width:38px" readonly /></th>
                        <th width="50"><input type="text" id="txtconchargeunit_sum" name="txtconchargeunit_sum" class="text_boxes_numeric" style="width:38px" readonly /></th>
                        <th width="70"><input type="text" id="txtconamount_sum" name="txtconamount_sum" class="text_boxes_numeric" style="width:58px" readonly /></th>
                        <th width="60">&nbsp;</th>
                        <th>&nbsp;</th>
                    </tr>
                </tfoot>
            </table>
            <table width="780" cellspacing="0" class="" border="0">
                <tr>
                    <td align="center" width="100%" class="button_container">
                    <?
                    if ( count($data_array)>0)
                    {
                    	echo load_submit_buttons( $permission, "fnc_fabric_conversion_cost_dtls", $save_update,0,"reset_form('fabriccost_3','','',0)",5) ;
                    }
                    else
                    {
                    	echo load_submit_buttons( $permission, "fnc_fabric_conversion_cost_dtls", $save_update,0,"reset_form('fabriccost_3','','',0)",5) ;
                    }
                    ?>
                    </td>
                </tr>
            </table>
            </form>
        </fieldset>
    	</div>     
	<?
	exit();
}
if($action=="openpopup_emblsupplier")
{
	echo load_html_head_contents("Nominated Supplier PopUp","../../../", 1, 1, $unicode,'','');
	extract($_REQUEST);
	?>
    <script>
		function check_all_data() {
			var tbl_row_count = document.getElementById( 'supp_table' ).rows.length;
			tbl_row_count = tbl_row_count;
			if(document.getElementById('check_all').checked){
				for( var i = 1; i <= tbl_row_count; i++ ) {
				//js_set_value( i);
				document.getElementById( 'search' + i ).style.backgroundColor = 'yellow';
				if( jQuery.inArray( $('#txttrimsuppdata_' + i).val(), selected_name ) == -1 ) {
					selected_name.push($('#txttrimsuppdata_' + i).val());
				}
				else{
					for( var j = 0; j < selected_name.length; j++ ) {
						if( selected_name[j] == $('#txttrimsuppdata_' + i).val() ) break;
					}
					selected_name.splice( j,1 );
				}

				}
			}else{
				for( var i = 1; i <= tbl_row_count; i++ ) {
					if(i%2==0  ){
						document.getElementById('search'+i).style.backgroundColor = '#FFFFFF';
					}
					if(i%2!=0 ){
						document.getElementById('search'+i).style.backgroundColor = '#E9F3FF';
					}
					if( jQuery.inArray( $('#txttrimsuppdata_' + i).val(), selected_name ) == -1 ) {
						selected_name.push($('#txttrimsuppdata_' + i).val());
					}
					else{
						for( var j = 0; j < selected_name.length; j++ ) {
							if( selected_name[j] == $('#txttrimsuppdata_' + i).val() ) break;
						}
						selected_name.splice( j,1 );
					}
				}
			}
		}

		function toggle( x, origColor ) {
			var newColor = 'yellow';
			if ( x.style ) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}

		function onlyUnique(value, index, self) {
			return self.indexOf(value) === index;
		}

		var selected_name = new Array();
		var selected_cname = new Array();

		function js_set_value( str ) {
			if($("#search"+str).css("display") !='none'){
				if(str%2==0  ){
					toggle( document.getElementById( 'search' + str ), '#FFFFFF');
				}
				if(str%2!=0 ){
					toggle( document.getElementById( 'search' + str ), '#E9F3FF');
				}
				if( jQuery.inArray( $('#txttrimsuppdata_' + str).val(), selected_name ) == -1 ) {
					selected_name.push($('#txttrimsuppdata_' + str).val());
				}
				else{
					for( var i = 0; i < selected_name.length; i++ ) {
						if( selected_name[i] == $('#txttrimsuppdata_' + str).val() ) break;
					}
					selected_name.splice( i,1 );
				}
			}
			var trimgroupdata='';
			for( var i = 0; i < selected_name.length; i++ ) {
				trimgroupdata += selected_name[i] + ',';
			}
			trimgroupdata = trimgroupdata.substr( 0, trimgroupdata.length - 1 );

			$('#suppdata').val( trimgroupdata );
		}
		function js_set_value_company( str ) {
			if($("#comsearch"+str).css("display") !='none'){
				if(str%2==0  ){
					toggle( document.getElementById( 'comsearch' + str ), '#FFFFFF');
				}
				if(str%2!=0 ){
					toggle( document.getElementById( 'comsearch' + str ), '#E9F3FF');
				}
				if( jQuery.inArray( $('#txttrimcsuppdata_' + str).val(), selected_cname ) == -1 ) {
					//alert($('#txttrimcsuppdata_' + str).val());
					selected_cname.push($('#txttrimcsuppdata_' + str).val());
				}
				else{
					for( var i = 0; i < selected_cname.length; i++ ) {
						if( selected_cname[i] == $('#txttrimcsuppdata_' + str).val() ) break;
					}
					selected_cname.splice( i,1 );
				}
			}
			var trimgroupcdata='';
			for( var i = 0; i < selected_cname.length; i++ ) {
				trimgroupcdata += selected_cname[i] + ',';
			}
			trimgroupcdata = trimgroupcdata.substr( 0, trimgroupcdata.length - 1 );

			$('#comsuppdata').val( trimgroupcdata );
		}


		function close_supp_data()
		{
			var s=$('#suppdata').val();
			var c=$('#comsuppdata').val();
			//alert(c+'--'+s);
			parent.emailwindow.hide();
		}
	</script>
	</head>
	<body>
        <div align="center" style="width:100%;">
        <input type="hidden" id="gid" name="gid"/>
        <input type="hidden" id="suppdata" name="suppdata"/>
        <input type="hidden" id="comsuppdata" name="comsuppdata"/>
        <?
		//echo $cbogroup;
		$tag_buyer=return_field_value("tag_buyer as tag_buyer", "lib_supplier_tag_buyer", "tag_buyer=$buyer","tag_buyer");
		
		if($tag_buyer!='')
		{
			$supplier_library=return_library_array( "select a.supplier_name,a.id from lib_supplier a, lib_supplier_party_type b,lib_supplier_tag_buyer c where a.id=b.supplier_id and a.id=c.supplier_id and b.supplier_id=c.supplier_id and c.tag_buyer=$tag_buyer and b.party_type in(23) and a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
		}
		else
		{
			$supplier_library=return_library_array( "select a.supplier_name,a.id from  lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(23) and a.is_deleted=0 and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
		}
		$compnay_sql=sql_select(" select id, company_name from lib_company comp where status_active =1 and is_deleted=0  $company_cond order by company_name");
		?>
		<table width="420" cellspacing="0" class="rpt_table" border="0" rules="all">
            <thead>
            	<th width="40">SL</th>
                <th>Company Name</th>
            </thead>
        </table>
        <div style="width:420px; overflow-y:scroll; max-height:340px;" >
        <table width="400" cellspacing="0" class="rpt_table" border="0" rules="all" id="comsupp_table">
            <tbody>
				<?
				if($nominasupplier != '')
                {
					$nominatedcomarr=explode("_", $nominasupplier);
                	$nominatedcom_arr = explode(",", $nominatedcomarr[1]);
                }
                $k=1;
                foreach($compnay_sql as $row_data)
				{
					$str="";
					$str=$row_data[csf('id')].'***'.$row_data[csf('company_name')];
					if($k%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					?>
					<tr id="comsearch<?=$k;?>" onClick="js_set_value_company(<?=$k; ?>);" bgcolor="<?=$bgcolor; ?>" style="cursor:pointer">
						<td width="40"><?=$k; ?></td>
                        <td title=""><?= $row_data[csf('company_name')]; ?>
                        	<input type="hidden" name="txttrimcsuppdata_<?=$k; ?>" id="txttrimcsuppdata_<?=$k; ?>" value="<?=$str; ?>"/>
                        </td>
					</tr>
					<script type="text/javascript">
                        <?
                            if(in_array($row_data[csf('id')], $nominatedcom_arr)){
                                echo "var matchcom_data=1;\n";
                                echo "var comsequ=".$k.";\n";
                            }
                            else{
                                echo "var matchcom_data=2;\n";
                            }
                        ?>
                        if(matchcom_data==1)
                        {
							js_set_value_company(comsequ);
                        }
                    </script>
					<?
					$k++;
                }
                ?>
            </tbody>
        </table>
        </div>
        <table width="420" cellspacing="0" class="rpt_table" border="0" rules="all">
            <thead>
            	<th width="40">SL</th>
                <th>Supplier Name</th>
            </thead>
        </table>
        <div style="width:420px; overflow-y:scroll; max-height:340px;" >
        <table width="400" cellspacing="0" class="rpt_table" border="0" rules="all" id="supp_table">
            <tbody>
				<?
                $i=1;
				if($nominasupplier != '')
                {
					$nominatedsupparr=explode("_", $nominasupplier);
                	$nominatedsup_arr = explode(",", $nominatedsupparr[0]);
                }
                foreach($supplier_library as $sid=>$sname)
				{
					if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					//echo $supplier_library2[$sid].', ';
					
					$str="";
					$str=$sid.'***'.$sname;
					?>
					<tr id="search<?=$i;?>" onClick="js_set_value(<?=$i; ?>);" bgcolor="<?=$bgcolor; ?>" style="cursor:pointer">
						<td width="40"><?=$i; ?></td>
                        <td title="ItemRate=<?=$supplier_chk_arr[$sid];?>"><?=$sname; ?>
                        	<input type="hidden" name="txttrimsuppdata_<?=$i; ?>" id="txttrimsuppdata_<?=$i; ?>" value="<?=$str; ?>"/>
                        </td>
					</tr>
                    <script type="text/javascript">
                        <?
                            if(in_array($sid, $nominatedsup_arr)){
                                echo "var match_data=1;\n";
                                echo "var sequ=".$i.";\n";
                            }
                            else{
                                echo "var match_data=2;\n";
                            }
                        ?>
                        if(match_data==1)
                        {
                           js_set_value(sequ);
                        }
                    </script>
					<?
					$i++;
					//}
					 

                }

                ?>
            </tbody>
        </table>
        </div>
        <table width="420" cellspacing="0" cellpadding="0" style="border:none" align="center">
        <tr>
            <td align="center" height="30" valign="bottom">
                <div style="width:100%">
                    <div style="width:50%; float:left" align="left">
                    	<input type="checkbox" name="check_all" id="check_all" onClick="check_all_data();" /> Check / Uncheck All
                    </div>
                    <div style="width:50%; float:left" align="left">
                    	<input type="button" name="close" onClick="close_supp_data();" class="formbutton" value="Close" style="width:100px" />
                    </div>
                </div>
            </td>
        </tr>
	</table>
    </div>
    </body>
	<script>setFilterGrid('supp_table',-1);</script>
	<!--<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>-->
	</html>
	<?
	exit();
}
if($action=="openpopup_emblsupplier_old")
{
	echo load_html_head_contents("Nominated Supplier PopUp","../../../", 1, 1, $unicode,'','');
	extract($_REQUEST);
	?>
    <script>
		function check_all_data() {
			var tbl_row_count = document.getElementById( 'supp_table' ).rows.length;
			tbl_row_count = tbl_row_count;
			if(document.getElementById('check_all').checked){
				for( var i = 1; i <= tbl_row_count; i++ ) {
				//js_set_value( i);
				document.getElementById( 'search' + i ).style.backgroundColor = 'yellow';
				if( jQuery.inArray( $('#txttrimsuppdata_' + i).val(), selected_name ) == -1 ) {
					selected_name.push($('#txttrimsuppdata_' + i).val());
				}
				else{
					for( var j = 0; j < selected_name.length; j++ ) {
						if( selected_name[j] == $('#txttrimsuppdata_' + i).val() ) break;
					}
					selected_name.splice( j,1 );
				}

				}
			}else{
				for( var i = 1; i <= tbl_row_count; i++ ) {
					if(i%2==0  ){
						document.getElementById('search'+i).style.backgroundColor = '#FFFFFF';
					}
					if(i%2!=0 ){
						document.getElementById('search'+i).style.backgroundColor = '#E9F3FF';
					}
					if( jQuery.inArray( $('#txttrimsuppdata_' + i).val(), selected_name ) == -1 ) {
						selected_name.push($('#txttrimsuppdata_' + i).val());
					}
					else{
						for( var j = 0; j < selected_name.length; j++ ) {
							if( selected_name[j] == $('#txttrimsuppdata_' + i).val() ) break;
						}
						selected_name.splice( j,1 );
					}
				}
			}
		}

		function toggle( x, origColor ) {
			var newColor = 'yellow';
			if ( x.style ) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}

		function onlyUnique(value, index, self) {
			return self.indexOf(value) === index;
		}

		var selected_name = new Array();

		function js_set_value( str ) {
			if($("#search"+str).css("display") !='none'){
				//toggle( document.getElementById( 'search' + str ), '#FFFFCC' );
				if(str%2==0  ){
					toggle( document.getElementById( 'search' + str ), '#FFFFFF');
				}
				if(str%2!=0 ){
					toggle( document.getElementById( 'search' + str ), '#E9F3FF');
				}
				if( jQuery.inArray( $('#txttrimsuppdata_' + str).val(), selected_name ) == -1 ) {
					selected_name.push($('#txttrimsuppdata_' + str).val());
				}
				else{
					for( var i = 0; i < selected_name.length; i++ ) {
						if( selected_name[i] == $('#txttrimsuppdata_' + str).val() ) break;
					}
					selected_name.splice( i,1 );
				}
			}
			var trimgroupdata='';
			for( var i = 0; i < selected_name.length; i++ ) {
				trimgroupdata += selected_name[i] + ',';
			}
			trimgroupdata = trimgroupdata.substr( 0, trimgroupdata.length - 1 );

			$('#suppdata').val( trimgroupdata );
		}
		
		function close_supp_data()
		{
			var s=$('#suppdata').val();
			parent.emailwindow.hide();
		}
	</script>
	</head>
	<body>
        <div align="center" style="width:100%;">
        <input type="hidden" id="gid" name="gid"/>
        <input type="hidden" id="suppdata" name="suppdata"/>
        <?
		$tag_buyer=return_field_value("tag_buyer as tag_buyer", "lib_supplier_tag_buyer", "tag_buyer=$buyer","tag_buyer");
		if($tag_buyer!='')
		{
			$supplier_library=return_library_array( "select a.supplier_name,a.id from lib_supplier a, lib_supplier_party_type b,lib_supplier_tag_buyer c where a.id=b.supplier_id and a.id=c.supplier_id and b.supplier_id=c.supplier_id and c.tag_buyer=$tag_buyer and b.party_type in(23) and a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
		}
		else
		{
			$supplier_library=return_library_array( "select a.supplier_name,a.id from  lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(23) and a.is_deleted=0 and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
		}
		
		?>
        <table width="420" cellspacing="0" class="rpt_table" border="0" rules="all">
            <thead>
            	<th width="40">SL</th>
                <th>Supplier Name</th>
            </thead>
        </table>
        <div style="width:420px; overflow-y:scroll; max-height:340px;" >
        <table width="400" cellspacing="0" class="rpt_table" border="0" rules="all" id="supp_table">
            <tbody>
				<?
                $i=1;
                if($nominasupplier != '')
                {
                	$nominatedsup_arr = explode(",", $nominasupplier);
                }
                foreach($supplier_library as $sid=>$sname)
				{
					if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					$str="";
					$str=$sid.'***'.$sname;
					/*if(in_array($sid, $nominatedsup_arr)){
						$bgcolor = 'yellow';
					}*/
					?>
					<tr id="search<?=$i;?>" onClick="js_set_value(<?=$i; ?>);" bgcolor="<?=$bgcolor; ?>" style="cursor:pointer">
						<td width="40"><?=$i; ?></td>
                        <td><?=$sname; ?>
                        	<input type="hidden" name="txttrimsuppdata_<?=$i; ?>" id="txttrimsuppdata_<?=$i; ?>" value="<?=$str; ?>"/>
                        </td>
					</tr>
					<script type="text/javascript">
                        <?
                            if(in_array($sid, $nominatedsup_arr)){
                                echo "var match_data=1;\n";
                                echo "var sequ=".$i.";\n";
                            }
                            else{
                                echo "var match_data=2;\n";
                            }
                        ?>
                        if(match_data==1)
                        {
                           js_set_value(sequ);
                        }
                    </script>
					<?
					$i++;
                }
                ?>
            </tbody>
        </table>
        </div>
        <table width="420" cellspacing="0" cellpadding="0" style="border:none" align="center">
        <tr>
            <td align="center" height="30" valign="bottom">
                <div style="width:100%">
                    <div style="width:50%; float:left" align="left">
                    	<input type="checkbox" name="check_all" id="check_all" onClick="check_all_data();" /> Check / Uncheck All
                    </div>
                    <div style="width:50%; float:left" align="left">
                    	<input type="button" name="close" onClick="close_supp_data();" class="formbutton" value="Close" style="width:100px" />
                    </div>
                </div>
            </td>
        </tr>
	</table>
    </div>
    </body>
	<script>setFilterGrid('supp_table',-1);</script>
	<!--<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>-->
	</html>
	<?
	exit();
}
if($action=="openpopup_fabricsupplier")
{
	echo load_html_head_contents("Nominated Supplier PopUp","../../../", 1, 1, $unicode,'','');
	extract($_REQUEST);
	?>
    <script>
		function check_all_data() {
			var tbl_row_count = document.getElementById( 'supp_table' ).rows.length;
			tbl_row_count = tbl_row_count;
			if(document.getElementById('check_all').checked){
				for( var i = 1; i <= tbl_row_count; i++ ) {
				//js_set_value( i);
				document.getElementById( 'search' + i ).style.backgroundColor = 'yellow';
				if( jQuery.inArray( $('#txttrimsuppdata_' + i).val(), selected_name ) == -1 ) {
					selected_name.push($('#txttrimsuppdata_' + i).val());
				}
				else{
					for( var j = 0; j < selected_name.length; j++ ) {
						if( selected_name[j] == $('#txttrimsuppdata_' + i).val() ) break;
					}
					selected_name.splice( j,1 );
				}

				}
			}else{
				for( var i = 1; i <= tbl_row_count; i++ ) {
					if(i%2==0  ){
						document.getElementById('search'+i).style.backgroundColor = '#FFFFFF';
					}
					if(i%2!=0 ){
						document.getElementById('search'+i).style.backgroundColor = '#E9F3FF';
					}
					if( jQuery.inArray( $('#txttrimsuppdata_' + i).val(), selected_name ) == -1 ) {
						selected_name.push($('#txttrimsuppdata_' + i).val());
					}
					else{
						for( var j = 0; j < selected_name.length; j++ ) {
							if( selected_name[j] == $('#txttrimsuppdata_' + i).val() ) break;
						}
						selected_name.splice( j,1 );
					}
				}
			}
		}

		function toggle( x, origColor ) {
			var newColor = 'yellow';
			if ( x.style ) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}

		function onlyUnique(value, index, self) {
			return self.indexOf(value) === index;
		}

		var selected_name = new Array();

		function js_set_value( str ) {
			if($("#search"+str).css("display") !='none'){
				//toggle( document.getElementById( 'search' + str ), '#FFFFCC' );
				if(str%2==0  ){
					toggle( document.getElementById( 'search' + str ), '#FFFFFF');
				}
				if(str%2!=0 ){
					toggle( document.getElementById( 'search' + str ), '#E9F3FF');
				}
				if( jQuery.inArray( $('#txttrimsuppdata_' + str).val(), selected_name ) == -1 ) {
					selected_name.push($('#txttrimsuppdata_' + str).val());
				}
				else{
					for( var i = 0; i < selected_name.length; i++ ) {
						if( selected_name[i] == $('#txttrimsuppdata_' + str).val() ) break;
					}
					selected_name.splice( i,1 );
				}
			}
			var trimgroupdata='';
			for( var i = 0; i < selected_name.length; i++ ) {
				trimgroupdata += selected_name[i] + ',';
			}
			trimgroupdata = trimgroupdata.substr( 0, trimgroupdata.length - 1 );

			$('#suppdata').val( trimgroupdata );
		}
		
		function close_supp_data()
		{
			var s=$('#suppdata').val();
			parent.emailwindow.hide();
		}
	</script>
	</head>
	<body>
        <div align="center" style="width:100%;">
        <input type="hidden" id="gid" name="gid"/>
        <input type="hidden" id="suppdata" name="suppdata"/>
        <?
		$tag_buyer=return_field_value("tag_buyer as tag_buyer", "lib_supplier_tag_buyer", "tag_buyer=$buyer","tag_buyer");
		if($tag_buyer!='')
		{
			$supplier_library=return_library_array( "select a.supplier_name,a.id from lib_supplier a, lib_supplier_party_type b,lib_supplier_tag_buyer c where a.id=b.supplier_id and a.id=c.supplier_id and b.supplier_id=c.supplier_id and c.tag_buyer=$tag_buyer and b.party_type in(1,9) and a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
		}
		else
		{
			$supplier_library=return_library_array( "select a.supplier_name,a.id from  lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(1,9) and a.is_deleted=0 and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
		}
		
		?>
        <table width="420" cellspacing="0" class="rpt_table" border="0" rules="all">
            <thead>
            	<th width="40">SL</th>
                <th>Supplier Name</th>
            </thead>
        </table>
        <div style="width:420px; overflow-y:scroll; max-height:340px;" >
        <table width="400" cellspacing="0" class="rpt_table" border="0" rules="all" id="supp_table">
            <tbody>
				<?
                $i=1;
                if($nominasupplier != '')
                {
                	$nominatedsup_arr = explode(",", $nominasupplier);
                }
                foreach($supplier_library as $sid=>$sname)
				{
					if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					$str="";
					$str=$sid.'***'.$sname;
					/*if(in_array($sid, $nominatedsup_arr)){
						$bgcolor = 'yellow';
					}*/
					?>
					<tr id="search<?=$i;?>" onClick="js_set_value(<?=$i; ?>);" bgcolor="<?=$bgcolor; ?>" style="cursor:pointer">
						<td width="40"><?=$i; ?></td>
                        <td><?=$sname; ?>
                        	<input type="hidden" name="txttrimsuppdata_<?=$i; ?>" id="txttrimsuppdata_<?=$i; ?>" value="<?=$str; ?>"/>
                        </td>
					</tr>
					<script type="text/javascript">
                        <?
                            if(in_array($sid, $nominatedsup_arr)){
                                echo "var match_data=1;\n";
                                echo "var sequ=".$i.";\n";
                            }
                            else{
                                echo "var match_data=2;\n";
                            }
                        ?>
                        if(match_data==1)
                        {
                           js_set_value(sequ);
                        }
                    </script>
					<?
					$i++;
                }
                ?>
            </tbody>
        </table>
        </div>
        <table width="420" cellspacing="0" cellpadding="0" style="border:none" align="center">
        <tr>
            <td align="center" height="30" valign="bottom">
                <div style="width:100%">
                    <div style="width:50%; float:left" align="left">
                    	<input type="checkbox" name="check_all" id="check_all" onClick="check_all_data();" /> Check / Uncheck All
                    </div>
                    <div style="width:50%; float:left" align="left">
                    	<input type="button" name="close" onClick="close_supp_data();" class="formbutton" value="Close" style="width:100px" />
                    </div>
                </div>
            </td>
        </tr>
	</table>
    </div>
    </body>
	<script>setFilterGrid('supp_table',-1);</script>
	<!--<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>-->
	</html>
	<?
	exit();
}
if($action=="fabric_add_image_popup")
{
	echo load_html_head_contents("Add Image Info", "../../../", 1, 1,'','','');
	extract($_REQUEST);
	?>
	<script>
		function fnc_image_upload(i)
		{
				
				var img_ref_id = $("#img_ref_id_"+i).val();
				//	alert(img_ref_id);
					file_uploader ( '../../../', img_ref_id,'', 'fabric_color_img', 0,1);
		}
		   function window_close(){
		   parent.emailwindow.hide();
		   }
	</script>
    </head>
    <body>
    <div align="center">
        <form name="styleRef_form" id="styleRef_form">
		<fieldset>
             <table class="rpt_table" width="650" cellspacing="0" cellpadding="0" border="0" rules="all">
			   <caption><strong> Add Image Against Fabric Color </strong> </caption>

        <thead>
            <tr>
                <th width="30">SL No</th>
                <th width="200">Body Part</th>
                <th width="100">Gmts Color</th>
                <th width="100">Fabric Color</th>
                <th>Add Image</th>
            </tr>
       </thead>
   </table>
   <div id="" style="max-height:300px; width:650px; overflow-y:scroll">
   <table id="list_view" class="rpt_table" width="630" height="" cellspacing="0" cellpadding="0" border="1" rules="all">
        <tbody>
	<?
	$color_library=return_library_array("select id,color_name from lib_color where status_active=1 and is_deleted=0","id","color_name");
	//and a.color_size_sensitive=3
	 $contrast_color_data="select a.job_no,a.id,a.body_part_id,b.contrast_color_id,b.gmts_color_id from  wo_pre_cost_fabric_cost_dtls a,  wo_pre_cos_fab_co_color_dtls b where a.id=b.pre_cost_fabric_cost_dtls_id and a.job_no=b.job_no and  a.job_no= '$txt_job_no' and  a.is_deleted=0  and a.color_size_sensitive=3  group by a.job_no,a.id,a.body_part_id,b.contrast_color_id,b.gmts_color_id order by b.contrast_color_id";
	$result_contrast_data=sql_select($contrast_color_data);
	$contrast_color_img_arr=array();
	foreach($result_contrast_data as $row)
	{
		if($row[csf('contrast_color_id')]>0)
		{
		$contrast_color_img_arr[$row[csf('id')]][$row[csf('gmts_color_id')]]['contr_color']=$row[csf('contrast_color_id')];
		$contrast_color_img_arr[$row[csf('id')]][$row[csf('gmts_color_id')]]['body_part_id']=$row[csf('body_part_id')];
		$contrast_color_img_arr[$row[csf('id')]][$row[csf('gmts_color_id')]]['job_no']=$row[csf('job_no')];
		}
	}
	
	$sql_data="select a.job_no,a.id,a.body_part_id,b.color_number_id from  wo_pre_cost_fabric_cost_dtls a,  wo_pre_cos_fab_co_avg_con_dtls b where a.id=b.pre_cost_fabric_cost_dtls_id and a.job_no=b.job_no and  a.job_no= '$txt_job_no' and a.color_size_sensitive=1 and  a.is_deleted=0  group by a.job_no,a.id,a.body_part_id,b.color_number_id order by b.color_number_id";
	$result_data=sql_select($sql_data);
	foreach($result_data as $row)
	{
		$fabric_color_img_arr[$row[csf('id')]][$row[csf('color_number_id')]]['gmt_color']=$row[csf('color_number_id')];
		$fabric_color_img_arr[$row[csf('id')]][$row[csf('color_number_id')]]['body_part_id']=$row[csf('body_part_id')];
		$fabric_color_img_arr[$row[csf('id')]][$row[csf('color_number_id')]]['job_no']=$row[csf('job_no')];
	}
	$i=1;
	foreach($fabric_color_img_arr as $fab_id=>$fab_data)
	{
		foreach($fab_data as $color_id=>$val)
		{
		$img_ref=$fab_id.'_'.$color_id;
		if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
		?>
        <tr id="tr_<? echo $row[csf('id')] ?>" bgcolor="<? echo $bgcolor; ?>" height="20" style="cursor:pointer; word-break:break-all;" onClick="">
            <td width="30" style="background:#FFFFCC">
			<input type="hidden" name="img_ref_id_<? echo $i; ?>" id="img_ref_id_<? echo $i; ?>" class="text_boxes" value="<? echo $img_ref; ?>" style="width:20px" />
			<? echo $i; ?></td>
            <td width="200" align="left"><? echo $body_part[$val[('body_part_id')]]; ?></td>
            <td width="100" align="left"><? echo $color_library[$color_id]; ?></td>
            <td width="100" align="left"><? echo $color_library[$color_id]; ?></td>
            <td align="center"><p><input type="button" class="image_uploader" id="uploader" style="width:60px" value="ADD" onClick="fnc_image_upload(<? echo $i;?>);"></p></td>
        </tr>
		<?
        $i++;
		}
    }
	foreach($contrast_color_img_arr as $fab_id=>$fab_data)
	{
		foreach($fab_data as $color_id=>$val)
		{
		
		if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
		$img_ref=$fab_id.'_'.$val[('contr_color')];
		?>
        <tr id="tr_<? echo $row[csf('id')] ?>" bgcolor="<? echo $bgcolor; ?>" height="20" style="cursor:pointer; word-break:break-all;" onClick="">
            <td width="30" style="background:#CCFFFF">
			<input type="hidden" name="img_ref_id_<? echo $i; ?>" id="img_ref_id_<? echo $i; ?>" class="text_boxes" value="<? echo $img_ref; ?>" style="width:20px" />
			<? echo $i; ?></td>
            <td width="200" align="left"><? echo $body_part[$val[('body_part_id')]]; ?></td>
            <td width="100" align="left"><? echo $color_library[$color_id]; ?></td>
            <td width="100" align="left"><? echo $color_library[$val[('contr_color')]]; ?></td>
            <td align="center"><p><input type="button" class="image_uploader" id="uploader" style="width:60px" value="ADD" onClick="fnc_image_upload(<? echo $i;?>);"></p></td>
        </tr>
		<?
        $i++;
		}
    }
    ?>
        </tbody>
		
    </table>
	<br/>
	<table border="0" cellpadding="0" cellspacing="0" rules="all" width="600">
		<tr>
		<td colspan="5" align="center">
		
		<input type="button" name="close" class="formbutton" value="Close" id="main_close" onClick="window_close();" style="width:80px"/>
		
		</td>
		</tr>
	</table>
	</div>
		</fieldset>
	</form>
    </div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
	exit();
}

if($action=="body_part_popup")
{
	echo load_html_head_contents("Item Group Select","../../../", 1, 1, $unicode,'','');
	extract($_REQUEST);
	?>
	<script>
	function js_set_value(id, name,type)
	{
		document.getElementById('gid').value=id;
		document.getElementById('gname').value=name;
		document.getElementById('gtype').value=type;
		parent.emailwindow.hide();
	}
	</script>
	</head>
	<body>
        <div align="center" style="width:100%;">
        <input type="hidden" id="gid" name="gid"/>
        <input type="hidden" id="gname" name="gname"/>
        <input type="hidden" id="gtype" name="gtype"/>
        <?
        $sql_tgroup=sql_select( "select body_part_full_name,body_part_short_name,body_part_type,id from lib_body_part where  is_deleted=0  and  status_active=1 order by body_part_short_name");
        ?>
        <table width="420" cellspacing="0" class="rpt_table" border="0" rules="all">
            <thead>
            <th width="40">SL</th><th width="300">Item Group</th><th>Type</th>
            </thead>
        </table>
        <table width="420" cellspacing="0" class="rpt_table" border="0" rules="all" id="item_table">
            <tbody>
            <?
            $i=1;
            foreach($sql_tgroup as $row_tgroup)
			{
				if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
				?>
				<tr onClick="js_set_value(<? echo $row_tgroup[csf('id')]; ?>, '<? echo $row_tgroup[csf('body_part_full_name')]; ?>', '<? echo $row_tgroup[csf('body_part_type')]; ?>')" bgcolor="<? echo $bgcolor; ?>">
					<td width="40"><? echo $i; ?></td><td width="300"><? echo $row_tgroup[csf('body_part_full_name')]; ?></td><td width=""><? echo $body_part_type[$row_tgroup[csf('body_part_type')]]; ?></td>
				</tr>
				<?
				$i++;
            }
            ?>
            </tbody>
        </table>
        </div>
	</body>
	<script>
	setFilterGrid('item_table',-1)
	</script>
	<!--<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>-->
	</html>
	<?
	exit();
}
if($action=="preCostRpt4")//Cost Rpt4 Btn Id 3 ISD-23-21618 for Renaissance
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if($txt_job_no=="") $job_noCond=''; else $job_noCond=" and a.job_no=".$txt_job_no."";

	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and b.costing_date='".$txt_costing_date."'";

	//array for display name
	
	$comp=return_library_array("select id, company_short_name from lib_company",'id','company_short_name');
	$buyer_arr=return_library_array("select id, buyer_name from lib_buyer",'id','buyer_name');
	$brand_arr=return_library_array("select id, brand_name from lib_buyer_brand",'id','brand_name');
	$season_arr=return_library_array("select id, season_name from lib_buyer_season",'id','season_name');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");

	 $po_qty=0; $po_plun_cut_qty=0; $total_set_qnty=0; $job_in_orders = '';$pulich_ship_date='';$job_in_file = '';$job_in_ref = '';
	 $sql_po="select a.job_no, a.total_set_qnty, b.id, b.po_number, b.grouping, b.file_no, b.pub_shipment_date, c.item_number_id, c.country_id, c.color_number_id, c.size_number_id, c.order_quantity, c.plan_cut_qnty from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst  and b.id=c.po_break_down_id  and a.job_no =".$txt_job_no."   and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 order by b.id";
	$sql_po_data=sql_select($sql_po);
	foreach($sql_po_data as $sql_po_row){
		$po_qty+=$sql_po_row[csf('order_quantity')];
		$po_plun_cut_qty+=$sql_po_row[csf('plan_cut_qnty')];
		$total_set_qnty=$sql_po_row[csf('total_set_qnty')];
		
		$job_in_orders .= $val[csf('po_number')].", ";
		$pulich_ship_date = $val[csf('pub_shipment_date')];
		$job_in_file .= $val[csf('file_no')].",";
		$job_in_ref .= $val[csf('grouping')].",";
	}
	
	$job_in_orders = substr(trim($job_in_orders),0,-1);
	$job_ref=array_unique(explode(",",rtrim($job_in_ref,", ")));
	$job_file=array_unique(explode(",",rtrim($job_in_file,", ")));

	foreach ($job_ref as $ref){
		$ref_cond.=", ".$ref;
	}
	$file_con='';
	foreach ($job_file as $file){
		if($file_con=='') $file_cond=$file; else $file_cond.=", ".$file;
	}

	$gmtsitem_ratio_array=array();
	$gmtsitem_ratio_sql=sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no =".$txt_job_no."");// where job_no ='FAL-14-01157'
	foreach($gmtsitem_ratio_sql as $gmtsitem_ratio_sql_row){
		$gmtsitem_ratio_array[$gmtsitem_ratio_sql_row[csf('job_no')]][$gmtsitem_ratio_sql_row[csf('gmts_item_id')]]=$gmtsitem_ratio_sql_row[csf('set_item_ratio')];
	}
	
	$financial_para=array();
	$sql_std_para=sql_select("select interest_expense,income_tax,cost_per_minute,applying_period_date, applying_period_to_date from lib_standard_cm_entry where company_id=$cbo_company_name and status_active=1 and is_deleted=0 order by id");
	foreach($sql_std_para as $row )
	{
		$applying_period_date=change_date_format($row[csf('applying_period_date')],'','',1);
		$applying_period_to_date=change_date_format($row[csf('applying_period_to_date')],'','',1);
		$diff=datediff('d',$applying_period_date,$applying_period_to_date);
		for($j=0;$j<$diff;$j++)
		{
			//$newdate =change_date_format(add_date(str_replace("'","",$applying_period_date),$j),'','',1);
			$date_all=add_date(str_replace("'","",$applying_period_date),$j);
			$newdate =change_date_format($date_all,'','',1);
			$financial_para[$newdate][interest_expense]=$row[csf('interest_expense')];
			$financial_para[$newdate][income_tax]=$row[csf('income_tax')];
			$financial_para[$newdate][cost_per_minute]=$row[csf('cost_per_minute')];
		}
	}
	//print_r($financial_para);
	
	$job_no=str_replace("'","",$txt_job_no);
	
	$condition= new condition();
	if(str_replace("'","",$txt_job_no) !=''){
		$condition->job_no("=$txt_job_no");
	}
	if(str_replace("'",'',$txt_po_breack_down_id) !=""){
		$condition->po_id("in($txt_po_breack_down_id)");
	}
	$condition->init();
	$fabric= new fabric($condition);
	
	$trim= new trims($condition);
	$emblishment= new emblishment($condition);
	$wash= new wash($condition);
	$other= new other($condition);
	
	$commercial= new commercial($condition);
	$commision= new commision($condition);
	
	$fabric_costing_arr=$fabric->getAmountArray_by_job_knitAndwoven_greyAndfinish();
	$trims_costing_arr=$trim->getAmountArray_by_job();
	$emblishment_costing_arr=$emblishment->getAmountArray_by_job();
	$emblishment_costing_arr_wash=$wash->getAmountArray_by_job();
	
	$commercial_costing_arr=$commercial->getAmountArray_by_job();
	$commission_costing_arr=$commision->getAmountArray_by_job();
	$other_costing_arr=$other->getAmountArray_by_job();
	
	$ttl_cm_cost=$other_costing_arr[$job_no]['cm_cost'];
	
	$sql_dtls = "select job_no, fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent, wash_cost, wash_cost_percent, comm_cost, comm_cost_percent, commission, commission_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, freight, freight_percent, currier_pre_cost, currier_percent, certificate_pre_cost, certificate_percent, common_oh, common_oh_percent, depr_amor_pre_cost, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set, margin_pcs_set_percent, cm_for_sipment_sche
	from wo_pre_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array_new=sql_select($sql_dtls);
	
	$summary_data=array();
	foreach($data_array_new as $row_new ){
		$summary_data[price_dzn]=$row_new[csf("price_dzn")];
		$summary_data[price_dzn_job]=($po_qty/($total_set_qnty*$order_price_per_dzn))*$row_new[csf("price_dzn")];
		$summary_data[commission]=$row_new[csf("commission")];
		$summary_data[trims_cost]=$row_new[csf("trims_cost")];
		$summary_data[emb_cost]=$row_new[csf("embel_cost")];

		$summary_data[lab_test]=$row_new[csf("lab_test")];
		$summary_data[lab_test_job]=$other_costing_arr[$row_new[csf("job_no")]]['lab_test'];

		$summary_data[inspection]=$row_new[csf("inspection")];
		$summary_data[inspection_job]=$other_costing_arr[$row_new[csf("job_no")]]['inspection'];

		$summary_data[freight]=$row_new[csf("freight")];
		$summary_data[freight_job]=$other_costing_arr[$row_new[csf("job_no")]]['freight'];

		$summary_data[currier_pre_cost]=$row_new[csf("currier_pre_cost")];
		$summary_data[currier_pre_cost_job]=$other_costing_arr[$row_new[csf("job_no")]]['currier_pre_cost'];

		$summary_data[certificate_pre_cost]=$row_new[csf("certificate_pre_cost")];
		$summary_data[certificate_pre_cost_job]=$other_costing_arr[$row_new[csf("job_no")]]['certificate_pre_cost'];
		$summary_data[wash_cost]=$row_new[csf("wash_cost")];

		$summary_data[OtherDirectExpenses]=$row_new[csf("lab_test")]+$row_new[csf("inspection")]+$row_new[csf("freight")]+$row_new[csf("currier_pre_cost")]+$row_new[csf("certificate_pre_cost")]+$row_new[csf("wash_cost")];
		$summary_data[OtherDirectExpenses_job]=$summary_data[lab_test_job]+$summary_data[inspection_job]+$summary_data[freight_job]+$summary_data[currier_pre_cost_job]+$summary_data[certificate_pre_cost_job];

		$summary_data[cm_cost]=$row_new[csf("cm_cost")];
		$summary_data[cm_cost_job]=$other_costing_arr[$row_new[csf("job_no")]]['cm_cost'];
		$summary_data[comm_cost]=$row_new[csf("comm_cost")];
		$summary_data[common_oh]=$row_new[csf("common_oh")];
		$summary_data[common_oh_job]=$other_costing_arr[$row_new[csf("job_no")]]['common_oh'];
		$summary_data[depr_amor_pre_cost]=$row_new[csf("depr_amor_pre_cost")];
		$summary_data[depr_amor_pre_cost_job]=$other_costing_arr[$row_new[csf("job_no")]]['depr_amor_pre_cost'];
		$summary_data[margindzn]=$row_new[csf("margin_dzn")];
		$summary_data[fabric_percent]=$row_new[csf("fabric_cost_percent")];
		$summary_data[trims_percent]=$row_new[csf("trims_cost_percent")];
		$summary_data[wash_percent]=$row_new[csf("wash_cost_percent")];
		$summary_data[emb_percent]=$row_new[csf("embel_cost_percent")];
		$summary_data[commercial_percent]=$row_new[csf("comm_cost_percent")];
		$summary_data[currier_percent]=$row_new[csf("currier_percent")];
		$summary_data[commission_percent]=$row_new[csf("commission_percent")];
		$summary_data[lab_test_percent]=$row_new[csf("lab_test_percent")];
		$summary_data[freight_percent]=$row_new[csf("freight_percent")];
		$summary_data[margin_dzn_percent]=$row_new[csf("margin_dzn_percent")];
		$summary_data[cm_cost_percent]=$row_new[csf("cm_cost_percent")];
	}
	unset($data_array_new);

	$fab_knit_req_kg_avg=0; $fab_woven_req_yds_avg=0;
	
    $sql = "select a.job_no, a.company_name, a.buyer_name, a.brand_id, a.season_buyer_wise, a.style_ref_no, a.quotation_id, a.gmts_item_id, a.order_uom, a.job_quantity, a.avg_unit_price, b.costing_per, b.budget_minute, b.costing_date, b.incoterm, b.sew_smv, b.cut_smv, b.sew_effi_percent, b.cut_effi_percent, b.approved, c.fab_knit_req_kg, c.fab_knit_fin_req_kg, c.fab_woven_req_yds, c.fab_woven_fin_req_yds, c.fab_yarn_req_kg from wo_po_details_master a, wo_pre_cost_mst b left join wo_pre_cost_sum_dtls c on b.job_no=c.job_no where a.job_no=b.job_no and a.status_active=1 $job_noCond $company_name $cbo_buyer_name $txt_style_ref order by a.job_no";
	$data_array=sql_select($sql);
	$uom=""; $sew_smv=0; $cut_smv=0; $sew_effi_percent=0; $cut_effi_percent=0;
	foreach ($data_array as $row){
		$order_price_per_dzn=0; $order_job_qnty=0; $avg_unit_price=0;
		$sew_smv=$row[csf("sew_smv")];
	    $cut_smv=$row[csf("cut_smv")];
	    $sew_effi_percent=$row[csf("sew_effi_percent")];
	    $cut_effi_percent=$row[csf("cut_effi_percent")];
		$order_values = $row[csf("job_quantity")]*$row[csf("avg_unit_price")];
		$pre_costing_date=change_date_format($row[csf('costing_date')],'','',1);
		
		if($row[csf("costing_per")]==1){
            $order_price_per_dzn=12;
            $costing_for=" DZN";
        }
        else if($row[csf("costing_per")]==2){
            $order_price_per_dzn=1;
            $costing_for=" PCS";
        }
        else if($row[csf("costing_per")]==3){
            $order_price_per_dzn=24;
            $costing_for=" 2 DZN";
        }
        else if($row[csf("costing_per")]==4){
            $order_price_per_dzn=36;
            $costing_for=" 3 DZN";
        }
        else if($row[csf("costing_per")]==5){
            $order_price_per_dzn=48;
            $costing_for=" 4 DZN";
        }
		?>
        <style>
		.vl {
		  border-left: 3px solid green;
		  position: absolute;
		  left: 50%;
		  top: 0;
		}
		</style>
        <table style="width:930px">
        	<tr>
            	<td colspan="3" align="left" style="font-size:14px; font-family:'Calibri Light';">
                	<b>COST SHEET</b>
                    <br />
                    <b style="font-size:14px; font-family:'Calibri Light'; background-color:#FFFFCC">Cost Sheet Revised No: <?
						$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_pre_cost_mst a, approval_history b where a.id=b.mst_id and a.job_no=".$txt_job_no." and b.entry_form=46");
							if(isset($nameArray_approved[0][csf('approved_no')]) ){
								echo ($nameArray_approved[0][csf('approved_no')]-1)*1;
							}
							else{ echo 0; }
						 ?>
					</b>
                </td>
			    <?
                $image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id=$cbo_company_name","image_location");
                $path=($path)?$path:'../../';
                ?>
                <td colspan="3" align="right"><img src='<? echo $path.$image_location; ?>' height='40' width='100' /><br /><?=date("l\, jS \of F\, Y"); ?></td>
           </tr>
       </table>

       <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:930px" rules="all">
            <tr>
                <td width="120" style="font-size:14px; font-family:'Calibri Light';"><b>Company</b></td>
                <td width="150" style="font-size:14px; font-family:'Calibri Light';"><b><? echo $comp[$row[csf("company_name")]]; ?></b></td>
                <td width="130" style="font-size:14px; font-family:'Calibri Light';" ><b>SMV/<?=$costing_for; ?></b></td>
                <td width="150" style="font-size:14px; font-family:'Calibri Light';" colspan="2"><b><? echo $sew_smv; ?></b></td>
                <td rowspan="11">
                	<?
					// image show here  -------------------------------------------
					$sqlData = "select id,master_tble_id,image_location from common_photo_library where master_tble_id=".$txt_job_no."";
					$data_array_img=sql_select($sqlData);
					$path=($path)?$path:'../../';
					?>
					<div>
					<? foreach($data_array_img as $inf){ ?>
						<img  src='<? echo $path.$inf[csf("image_location")]; ?>' border="1" height='200px' width='150px' />
					<?  } ?>
					</div>
                </td>
            </tr>
            <tr>
            	<td style="font-size:14px; font-family:'Calibri Light';"><b>Job Number</b></td>
                <td style="font-size:14px; font-family:'Calibri Light';"><b><?=$row[csf("job_no")]; ?></b></td>
                <td style="font-size:14px; font-family:'Calibri Light';"><b>Planned Efficiency</b></td>
                <td style="font-size:14px; font-family:'Calibri Light';" colspan="2"><b><?=$sew_effi_percent; ?>%</b></td>
            </tr>
            <tr>
            	<td style="font-size:14px; font-family:'Calibri Light';"><b>Buyer</b></td>
                <td style="font-size:14px; font-family:'Calibri Light';"><b><?=$buyer_arr[$row[csf("buyer_name")]]; ?></b></td>
                <td style="font-size:14px; font-family:'Calibri Light';background-color:#FFC"><b>Margin/<?=$costing_for; ?></b></td>
                <td style="font-size:14px; font-family:'Calibri Light';background-color:#FFC" width="75"><b><?=$summary_data[margindzn]; ?></b></td>
                <td style="font-size:14px; font-family:'Calibri Light';background-color:#FFC" width="75" align="center"><b><?=$summary_data[margin_dzn_percent].' %'; ?></b></td>
            </tr>
            <tr>
            	<td style="font-size:14px; font-family:'Calibri Light';"><b>Brand</b></td>
                <td style="font-size:14px; font-family:'Calibri Light';"><b><?=$brand_arr[$row[csf("brand_id")]]; ?></b></td>
                <td style="font-size:14px; font-family:'Calibri Light';background-color:#FFC" ><b>CM/<?=$costing_for; ?></b></td>
                <td style="font-size:14px; font-family:'Calibri Light';background-color:#FFC" width="75"><b><?=$summary_data[cm_cost]; ?></b></td>
                <td style="font-size:14px; font-family:'Calibri Light';background-color:#FFC" width="75" align="center"><b><?=$summary_data[cm_cost_percent].' %'; ?></b></td>
            </tr>
            <tr>
            	<td style="font-size:14px; font-family:'Calibri Light';"><b>Costed Date</b></td>
                <td style="font-size:14px; font-family:'Calibri Light';"><b><?=change_date_format($pre_costing_date); ?></b></td>
                <td style="font-size:14px; font-family:'Calibri Light';"><b>EPM/<?=$costing_for; ?></b></td>
                <td style="font-size:14px; font-family:'Calibri Light';" colspan="2"><b><? $epm=$summary_data[cm_cost]/$sew_smv; echo fn_number_format($epm,3); ?></b></td>
            </tr>
            <tr>
            	<td style="font-size:14px; font-family:'Calibri Light';"><b>Season</b></td>
                <td style="font-size:14px; font-family:'Calibri Light';"><b><?=$season_arr[$row[csf("season_buyer_wise")]]; ?></b></td>
                <td style="font-size:14px; font-family:'Calibri Light';"><b>Order Qty</b></td>
                <td style="font-size:14px; font-family:'Calibri Light';" colspan="2"><b><?=$row[csf("job_quantity")]." ". $unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
            </tr>
            <tr>
            	<td style="font-size:14px; font-family:'Calibri Light';"><b>Garments Item</b></td>
                <?
                    $grmnt_items = "";
                    if($garments_item[$row[csf("gmts_item_id")]]=="")
                    {

                        $grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no=$txt_job_no");
                        foreach($grmts_sql as $key=>$val){
                            $grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].", ";
                        }
                        $grmnt_items = substr_replace($grmnt_items,"",-1,1);
                    }else{
                        $grmnt_items = $garments_item[$row[csf("gmts_item_id")]];
                    }
					
					$appStatus="No"; $appStatusTdColor="#FF7377";
					if($row[csf("approved")]==1 || $row[csf("approved")]==3) { $appStatus="Yes";  $appStatusTdColor="#90EE90"; }
                ?>
                <td style="font-size:14px; font-family:'Calibri Light';"><b><?=$grmnt_items; ?></b></td>
                <td style="font-size:14px; font-family:'Calibri Light';"><b>Plan Qty</b></td>
                <td style="font-size:14px; font-family:'Calibri Light';" colspan="2"><b><?=$po_plun_cut_qty/$total_set_qnty." ". $unit_of_measurement[$row[csf("order_uom")]];?></b></td>
            </tr>
            <tr>
            	<td style="font-size:14px; font-family:'Calibri Light';"><b>Buyer Style Ref. No</b></td>
                <td style="font-size:14px; font-family:'Calibri Light';"><b><?=$row[csf("style_ref_no")]; ?></b></td>
                <td style="font-size:14px; font-family:'Calibri Light';"><b>Price Per Piece</b></td>
                <td style="font-size:14px; font-family:'Calibri Light';" colspan="2"><b><?=$row[csf("avg_unit_price")]; ?> USD</b></td>
            </tr>
            <tr>
            	<td style="font-size:14px; font-family:'Calibri Light';"><b>Costing Per</b></td>
                <td style="font-size:14px; font-family:'Calibri Light';"><b><?=$costing_per[$row[csf("costing_per")]]; ?></b></td>
                <td style="font-size:14px; font-family:'Calibri Light';"><b>Total Value</b></td>
                <td style="font-size:14px; font-family:'Calibri Light';" colspan="2"><b><?=fn_number_format($order_values,3); ?> USD</b></td>
            </tr>
            <tr>
            	<td style="font-size:14px; font-family:'Calibri Light';"><b>Order Status</b></td>
                <td style="font-size:14px; font-family:'Calibri Light';"><b><? //=$costing_per[$row[csf("costing_per")]]; ?></b></td>
                <td style="font-size:14px; font-family:'Calibri Light';"><b>Cost Sheet Approved</b></td>
                <td style="font-size:14px; font-family:'Calibri Light'; background-color:<?=$appStatusTdColor; ?>" colspan="2"><b><?=$appStatus; ?></b></td>
            </tr>
             <tr>
            	<td style="font-size:14px; font-family:'Calibri Light';"><b>Terms</b></td>
                <td style="font-size:14px; font-family:'Calibri Light';"><b><?=$incoterm[$row[csf("incoterm")]]; ?></b></td>
                <td style="font-size:14px; font-family:'Calibri Light';"><b>Commercial Cost %</b></td>
                <td style="font-size:14px; font-family:'Calibri Light';" colspan="2"><b><?=$summary_data[commercial_percent]; ?></b></td>
            </tr>
        </table>
        <?
        $order_job_qnty=$row[csf("job_quantity")];
        $avg_unit_price=$row[csf("avg_unit_price")];
	}//end first foearch
	//start	all summary report here -------------------------------------------
	
	$fab_purchase_knit=array_sum($fabric_costing_arr['knit']['grey'][$job_no]);
	$fab_purchase_woven=array_sum($fabric_costing_arr['woven']['grey'][$job_no]);
	
	$fabricCost=$fab_purchase_knit+$fab_purchase_woven;
	?>
    <br />
    <div style="border:2px solid black; width:930px">
    <table cellpadding="1" cellspacing="1" style="width:920px">
    	<tr>
        	<td width="306" valign="top">
            	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:305px" rules="all">
                	<tr>
                    	<td style="font-size:14px; font-family:'Calibri Light';" colspan="3" align="center"><b>Materials Cost Summary</b></td>
                    </tr>
                	<tr>
                        <td width="120" style="font-size:14px; font-family:'Calibri Light';" align="center"><b>Item</b></td>
                        <td width="100" style="font-size:14px; font-family:'Calibri Light';" align="center"><b>Value</b></td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center"><b>%</b></td>
                    </tr>
                    <tr>
                        <td style="font-size:14px; font-family:'Calibri Light';">Fabric</td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center">$ <?=fn_number_format($fabricCost,3); ?></td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center"><?=$summary_data[fabric_percent]; ?></td>
                    </tr>
                    <tr>
                        <td style="font-size:14px; font-family:'Calibri Light';">Trims</td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center">$ <?=fn_number_format($trims_costing_arr[$job_no],3); ?></td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center"><?=$summary_data[trims_percent]; ?></td>
                    </tr>
                    <tr>
                        <td style="font-size:14px; font-family:'Calibri Light';">Wash</td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center">$ <?=fn_number_format($emblishment_costing_arr_wash[$job_no],3); ?></td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center"><?=$summary_data[wash_percent]; ?></td>
                    </tr>
                    <tr>
                        <td style="font-size:14px; font-family:'Calibri Light';">Embellishment</td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center">$ <?=fn_number_format($emblishment_costing_arr[$job_no],3); ?></td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center"><?=$summary_data[emb_percent]; ?></td>
                    </tr>
                    <tr>
                        <td style="font-size:14px; font-family:'Calibri Light';"><b>&nbsp;</b></td>
                        <td style="font-size:14px; font-family:'Calibri Light';"><b>&nbsp;</b></td>
                        <td style="font-size:14px; font-family:'Calibri Light';"><b>&nbsp;</b></td>
                    </tr>
                    <tr>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="right"><b>Total :</b></td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center"><b><? $totMaterialCost=$fabricCost+$trims_costing_arr[$job_no]+$emblishment_costing_arr_wash[$job_no]+$emblishment_costing_arr[$job_no]; echo fn_number_format($totMaterialCost,3); ?></b></td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center"><b><?=fn_number_format($summary_data[fabric_percent]+$summary_data[trims_percent]+$summary_data[wash_percent]+$summary_data[emb_percent],3); ?></b></td>
                    </tr>
                </table>
            </td>
            <td width="3">&nbsp;</td>
        	<td width="306" valign="top">
            	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:305px" rules="all">
                	<tr>
                    	<td style="font-size:14px; font-family:'Calibri Light';" colspan="3" align="center"><b>Other Costs Summary</b></td>
                    </tr>
                	<tr>
                        <td width="120" style="font-size:14px; font-family:'Calibri Light';" align="center"><b>Item</b></td>
                        <td width="100" style="font-size:14px; font-family:'Calibri Light';" align="center"><b>Value</b></td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center"><b>%</b></td>
                    </tr>
                    <tr>
                        <td style="font-size:14px; font-family:'Calibri Light';" >Commercial Cost</td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center">$ <?=fn_number_format($commercial_costing_arr[$job_no],3); ?></td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center"><?=$summary_data[commercial_percent]; ?></td>
                    </tr>
                    <tr>
                        <td style="font-size:14px; font-family:'Calibri Light';" >Courier Cost</td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center">$ <?=fn_number_format($other_costing_arr[$job_no]['currier_pre_cost'],3); ?></td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center"><?=$summary_data[currier_percent]; ?></td>
                    </tr>
                    <tr>
                        <td style="font-size:14px; font-family:'Calibri Light';" >Commission</td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center">$ <?=fn_number_format($commission_costing_arr[$job_no],3); ?></td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center"><?=$summary_data[commission_percent]; ?></td>
                    </tr>
                    <tr>
                        <td style="font-size:14px; font-family:'Calibri Light';" >Lab Test</td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center">$ <?=fn_number_format($other_costing_arr[$job_no]['lab_test'],3); ?></td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center"><?=$summary_data[lab_test_percent]; ?></td>
                    </tr>
                    <tr>
                        <td style="font-size:14px; font-family:'Calibri Light';" >Freight Cost</td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center">$ <?=fn_number_format($other_costing_arr[$job_no]['freight'],3); ?></td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center"><?=$summary_data[freight_percent]; ?></td>
                    </tr>
                    <tr>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="right"><b>Total :</b></td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center"><b><? $otherCost=$commercial_costing_arr[$job_no]+$other_costing_arr[$job_no]['currier_pre_cost']+$commission_costing_arr[$job_no]+$other_costing_arr[$job_no]['lab_test']+$other_costing_arr[$job_no]['freight']; echo fn_number_format($otherCost,3); ?></b></td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center"><b><?=fn_number_format($summary_data[commercial_percent]+$summary_data[currier_percent]+$summary_data[commission_percent]+$summary_data[lab_test_percent]+$summary_data[freight_percent],3); ?></b></td>
                    </tr>
                </table>
            </td>
            <td width="3">&nbsp;</td>
            <td valign="top">
            	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:296px" rules="all">
                	<tr>
                    	<td style="font-size:14px; font-family:'Calibri Light';" colspan="3" align="center"><b>Order Profitability Summary</b></td>
                    </tr>
                    <tr>
                        <td width="120" style="font-size:14px; font-family:'Calibri Light';" >Total FOB Value</td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center">$ <?=fn_number_format($order_values,3); ?></td>
                    </tr>
                    <tr>
                        <td style="font-size:14px; font-family:'Calibri Light';" >Materials Costs</td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center">$ <?='('.fn_number_format($totMaterialCost,3).')'; ?></td>
                    </tr>
                    <tr>
                        <td style="font-size:14px; font-family:'Calibri Light';" >Other Costs</td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center">$ <?='('.fn_number_format($otherCost,3).')'; ?></td>
                    </tr>
                    <tr>
                        <td style="font-size:14px; font-family:'Calibri Light';" >CM</td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center">$ <?='('.fn_number_format($summary_data[cm_cost_job],3).')'; ?></td>
                    </tr>
                    <tr>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="right"><b>Margin :</b></td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center"><b><? $totalMargin=$order_values-($totMaterialCost+$otherCost+$summary_data[cm_cost_job]); echo '('.fn_number_format($totalMargin,3).')'; ?></b></td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
    </div>
   
	<!--Fabric =====================-->
    <? if($zero_value==1) { ?>
    <div style="margin-top:15px">
    	<label style="font-size:14px; font-family:'Calibri Light'; background-color:#CCCCCC"><b>Fabric Cost Details</b></label>
    	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:930px;" rules="all">
        	<thead>
                <tr style="font-weight:bold; background-color:#FFC" align="center">
                    <th width="82" style="font-size:14px; font-family:'Calibri Light';" rowspan="<?=$i; ?>" >Fabric Nature</th>
                    <th width="80" style="font-size:14px; font-family:'Calibri Light';">Fabric Part</th>
                    <th width="200" style="font-size:14px; font-family:'Calibri Light';">Fabric Description</th>
                    <th width="50" style="font-size:14px; font-family:'Calibri Light';">UOM</th>
                    <th width="60" style="font-size:14px; font-family:'Calibri Light';">YY</th>
                    <th width="50" style="font-size:14px; font-family:'Calibri Light';">Wastage %</th>
                    <th width="60" style="font-size:14px; font-family:'Calibri Light';">Total YY</th>
                    
                    <th width="80" style="font-size:14px; font-family:'Calibri Light';">Req. Qty</th>
                    <th width="50" style="font-size:14px; font-family:'Calibri Light';">Rate</th>
                    <th width="50" style="font-size:14px; font-family:'Calibri Light';">Cost/<?=$costing_for; ?></th>
                    <th width="80" style="font-size:14px; font-family:'Calibri Light';">Total Value</th>
                    <th style="font-size:14px; font-family:'Calibri Light';">%</th>
                </tr>
          	</thead>
            <tbody>
			<?
            $fabric_req_qty_arr=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
            $fabric_req_amt_arr=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
            $sql_fabric = "select ID, JOB_NO, BODY_PART_ID, FAB_NATURE_ID, COLOR_TYPE_ID, FABRIC_DESCRIPTION, UOM, AVG_CONS, AVG_CONS_YARN, FABRIC_SOURCE, GSM_WEIGHT, RATE, AMOUNT, AVG_FINISH_CONS, AVG_PROCESS_LOSS from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no." and is_deleted=0 and status_active=1";
            $sql_fabricArr=sql_select($sql_fabric); $i=1; $fabamtTotDzn=$fabReqAmttotal=$fabPerTotal=0;
            foreach($sql_fabricArr as $frow)
            {
                $rowFabReqQty=$rowFabReqAmt=$fabric_per=0;
                $rowFabReqQty=$fabric_req_qty_arr['knit']['grey'][$frow["ID"]][$frow["UOM"]]+$fabric_req_qty_arr['woven']['grey'][$frow["ID"]][$frow["UOM"]];
                $rowFabReqAmt=$fabric_req_amt_arr['knit']['grey'][$frow["ID"]][$frow["UOM"]]+$fabric_req_amt_arr['woven']['grey'][$frow["ID"]][$frow["UOM"]];
                
                $fabric_per=($rowFabReqAmt/$order_values)*100;
                ?>
                <tr>
                    <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$item_category[$frow['FAB_NATURE_ID']]; ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$body_part[$frow["BODY_PART_ID"]]; ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$frow["FABRIC_DESCRIPTION"]; ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$unit_of_measurement[$frow["UOM"]]; ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($frow["AVG_FINISH_CONS"],3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($frow["AVG_PROCESS_LOSS"],2); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($frow["AVG_CONS"],3); ?></td>
                    
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($rowFabReqQty,3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($frow["RATE"],3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($frow["AMOUNT"],3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($rowFabReqAmt,3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($fabric_per,2); ?></td>
                </tr>
                <?	
				 $fabamtTotDzn+=$frow["AMOUNT"];
				 $fabReqAmttotal+=$rowFabReqAmt;
				 $fabPerTotal+=$fabric_per;
            }
            ?>
            </tbody>
            <tfoot>
            	<tr style="background-color:#CCFFFF">
                    <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all" colspan="7" align="right"><b>Total Fabric Cost</b></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right">&nbsp;</td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right">&nbsp;</td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($fabamtTotDzn,3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($fabReqAmttotal,3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($fabPerTotal,2); ?></td>
                </tr>
            </tfoot>
        </table>
    </div>
    <? } else { 
		if(($fabricCost*1)>0)
		{
			?>
            <div style="margin-top:15px">
                <label style="font-size:14px; font-family:'Calibri Light'; background-color:#CCCCCC"><b>Fabric Cost Details</b></label>
                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:930px;" rules="all">
                    <thead>
                        <tr style="font-weight:bold; background-color:#FFC" align="center">
                            <th width="82" style="font-size:14px; font-family:'Calibri Light';" rowspan="<?=$i; ?>" >Fabric Nature</th>
                            <th width="80" style="font-size:14px; font-family:'Calibri Light';">Fabric Part</th>
                            <th width="200" style="font-size:14px; font-family:'Calibri Light';">Fabric Description</th>
                            <th width="50" style="font-size:14px; font-family:'Calibri Light';">UOM</th>
                            <th width="60" style="font-size:14px; font-family:'Calibri Light';">YY</th>
                            <th width="50" style="font-size:14px; font-family:'Calibri Light';">Wastage %</th>
                            <th width="60" style="font-size:14px; font-family:'Calibri Light';">Total YY</th>
                            
                            <th width="80" style="font-size:14px; font-family:'Calibri Light';">Req. Qty</th>
                            <th width="50" style="font-size:14px; font-family:'Calibri Light';">Rate</th>
                            <th width="50" style="font-size:14px; font-family:'Calibri Light';">Cost/<?=$costing_for; ?></th>
                            <th width="80" style="font-size:14px; font-family:'Calibri Light';">Total Value</th>
                            <th style="font-size:14px; font-family:'Calibri Light';">%</th>
                        </tr>
                    </thead>
                    <tbody>
                    <?
                    $fabric_req_qty_arr=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
                    $fabric_req_amt_arr=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
                    $sql_fabric = "select ID, JOB_NO, BODY_PART_ID, FAB_NATURE_ID, COLOR_TYPE_ID, FABRIC_DESCRIPTION, UOM, AVG_CONS, AVG_CONS_YARN, FABRIC_SOURCE, GSM_WEIGHT, RATE, AMOUNT, AVG_FINISH_CONS, AVG_PROCESS_LOSS from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no." and is_deleted=0 and status_active=1";
                    $sql_fabricArr=sql_select($sql_fabric); $i=1; $fabamtTotDzn=$fabReqAmttotal=$fabPerTotal=0;
                    foreach($sql_fabricArr as $frow)
                    {
                        $rowFabReqQty=$rowFabReqAmt=$fabric_per=0;
                        $rowFabReqQty=$fabric_req_qty_arr['knit']['grey'][$frow["ID"]][$frow["UOM"]]+$fabric_req_qty_arr['woven']['grey'][$frow["ID"]][$frow["UOM"]];
                        $rowFabReqAmt=$fabric_req_amt_arr['knit']['grey'][$frow["ID"]][$frow["UOM"]]+$fabric_req_amt_arr['woven']['grey'][$frow["ID"]][$frow["UOM"]];
                        
                        $fabric_per=($rowFabReqAmt/$order_values)*100;
                        ?>
                        <tr>
                            <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$item_category[$frow['FAB_NATURE_ID']]; ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$body_part[$frow["BODY_PART_ID"]]; ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$frow["FABRIC_DESCRIPTION"]; ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$unit_of_measurement[$frow["UOM"]]; ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($frow["AVG_FINISH_CONS"],3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($frow["AVG_PROCESS_LOSS"],2); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($frow["AVG_CONS"],3); ?></td>
                            
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($rowFabReqQty,3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($frow["RATE"],3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($frow["AMOUNT"],3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($rowFabReqAmt,3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($fabric_per,2); ?></td>
                        </tr>
                        <?	
                         $fabamtTotDzn+=$frow["AMOUNT"];
                         $fabReqAmttotal+=$rowFabReqAmt;
                         $fabPerTotal+=$fabric_per;
                    }
                    ?>
                    </tbody>
                    <tfoot>
                        <tr style="background-color:#CCFFFF">
                            <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all" colspan="7" align="right"><b>Total Fabric Cost</b></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right">&nbsp;</td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right">&nbsp;</td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($fabamtTotDzn,3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($fabReqAmttotal,3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($fabPerTotal,2); ?></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <?
		}
	}
	?>
    
    <!--Trims =====================-->
    
    <?
	$sql_trim = "select a.ID, a.JOB_NO, a.TRIM_GROUP, a.DESCRIPTION, a.CONS_UOM, a.TOT_CONS, a.EX_PER, a.CONS_DZN_GMTS, a.RATE, a.AMOUNT, b.ITEM_NAME, b.TRIM_TYPE from wo_pre_cost_trim_cost_dtls a, lib_item_group b where a.TRIM_GROUP=b.id and a.job_no=".$txt_job_no." and a.status_active=1 and a.is_deleted=0 order by b.TRIM_TYPE, a.seq Asc";
	
	$data_array_trim=sql_select($sql_trim);
	
	$trim_qty_arr=$trim->getQtyArray_by_precostdtlsid();
	$trim_amount_arr=$trim->getAmountArray_precostdtlsid(); $trimsDataArr=array();
	foreach($data_array_trim as $trow)
	{
		$trimsDataArr[$trow["TRIM_TYPE"]][$trow["ID"]]['ITEM_NAME']=$trow["ITEM_NAME"];
		$trimsDataArr[$trow["TRIM_TYPE"]][$trow["ID"]]['DESCRIPTION']=$trow["DESCRIPTION"];
		$trimsDataArr[$trow["TRIM_TYPE"]][$trow["ID"]]['CONS_UOM']=$trow["CONS_UOM"];
		$trimsDataArr[$trow["TRIM_TYPE"]][$trow["ID"]]['NET_CONS']=$trow["TOT_CONS"];
		$trimsDataArr[$trow["TRIM_TYPE"]][$trow["ID"]]['EX_PER']=$trow["EX_PER"];
		$trimsDataArr[$trow["TRIM_TYPE"]][$trow["ID"]]['GCONS']=$trow["CONS_DZN_GMTS"];
		$trimsDataArr[$trow["TRIM_TYPE"]][$trow["ID"]]['RATE']=$trow["RATE"];
		$trimsDataArr[$trow["TRIM_TYPE"]][$trow["ID"]]['AMOUNT']=$trow["AMOUNT"];
	}
	unset($data_array_trim);
	if($zero_value==1) { 
	?>
    <div style="margin-top:15px">
    	<label style="font-size:14px; font-family:'Calibri Light'; background-color:#CCCCCC"><b>Trims Cost Details</b></label>
    	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:930px;" rules="all">
        	<thead>
                <tr style="font-weight:bold;background-color:#FFC" align="center">
                    <th width="130" style="font-size:14px; font-family:'Calibri Light';" rowspan="<?=$i; ?>" >Item Name</th>
                    <th width="230" style="font-size:14px; font-family:'Calibri Light';">Item Description</th>
                    <th width="50" style="font-size:14px; font-family:'Calibri Light';">UOM</th>
                    <th width="60" style="font-size:14px; font-family:'Calibri Light';">YY</th>
                    <th width="50" style="font-size:14px; font-family:'Calibri Light';">Wastage %</th>
                    <th width="60" style="font-size:14px; font-family:'Calibri Light';">Total YY</th>
                    <th width="80" style="font-size:14px; font-family:'Calibri Light';">Req. Qty</th>
                    <th width="50" style="font-size:14px; font-family:'Calibri Light';">Rate</th>
                    <th width="50" style="font-size:14px; font-family:'Calibri Light';">Cost /<?=$costing_for; ?></th>
                    <th width="80" style="font-size:14px; font-family:'Calibri Light';">Total Value</th>
                    <th style="font-size:14px; font-family:'Calibri Light';">%</th>
                </tr>
          	</thead>
            <tbody>
			<?
            
			$i=1; $trimamtTotDzn=$trimReqAmttotal=$trimPerTotal=0;
            foreach($trimsDataArr as $trimtype=>$trimtypedata)
            {
				?>
                <tr>
                    <td colspan="11" style="font-size:14px; font-family:'Calibri Light';word-break:break-all; background-color:#FFC"><b><?=$trim_type[$trimtype]; ?> Trims Details</b></td>
                </tr>
                <?
				$typeTrimsAmtDzn=$typeTrimsAmt=$typeTrimsAmtPer=0;
				foreach($trimtypedata as $trimid=>$trimdata)
				{
					$rowTrimReqQty=$rowTrimReqAmt=$trim_per=0;
					$rowTrimReqQty=$trim_qty_arr[$trimid];
					$rowTrimReqAmt=$trim_amount_arr[$trimid];
					
					$trim_per=($rowTrimReqAmt/$order_values)*100;
					?>
					<tr>
						<td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$trimdata['ITEM_NAME']; ?></td>
						<td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$trimdata['DESCRIPTION']; ?></td>
                        <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$unit_of_measurement[$trimdata['CONS_UOM']]; ?></td>
						<td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($trimdata["NET_CONS"],3); ?></td>
						<td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($trimdata["EX_PER"],2); ?></td>
						<td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($trimdata["GCONS"],3); ?></td>
						
						<td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($rowTrimReqQty,3); ?></td>
						<td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($trimdata["RATE"],3); ?></td>
						<td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($trimdata["AMOUNT"],3); ?></td>
						<td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($rowTrimReqAmt,3); ?></td>
						<td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($trim_per,2); ?></td>
					</tr>
					<?
						$typeTrimsAmtDzn+=$trimdata["AMOUNT"];
						$typeTrimsAmt+=$rowTrimReqAmt;
						$typeTrimsAmtPer+=$trim_per;
						
						$trimamtTotDzn+=$trimdata["AMOUNT"];
						$trimReqAmttotal+=$rowTrimReqAmt;
						$trimPerTotal+=$trim_per;
				}
				 ?>
                <tr style="background-color:#CCCCCC">
                    <td colspan="8" style="font-size:14px; font-family:'Calibri Light';word-break:break-all;" align="right"><b>Total <?=$trim_type[$trimtype]; ?> Trims Cost :</b></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($typeTrimsAmtDzn,3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($typeTrimsAmt,3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($typeTrimsAmtPer,2); ?></td>
                </tr>
                <?
            }
            ?>
            </tbody>
            <tfoot>
            	<tr style="background-color:#CCFFFF">
                    <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all" colspan="6" align="right"><b>Grand Total Trims Cost :</b></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right">&nbsp;</td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right">&nbsp;</td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($trimamtTotDzn,3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($trimReqAmttotal,3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($trimPerTotal,2); ?></td>
                </tr>
            </tfoot>
        </table>
    </div>
    <? } else {
		if(($trims_costing_arr[$job_no]*1)>0)
		{
			?>
            <div style="margin-top:15px">
                <label style="font-size:14px; font-family:'Calibri Light'; background-color:#CCCCCC"><b>Trims Cost Details</b></label>
                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:930px;" rules="all">
                    <thead>
                        <tr style="font-weight:bold;background-color:#FFC" align="center">
                            <th width="130" style="font-size:14px; font-family:'Calibri Light';" rowspan="<?=$i; ?>" >Item Name</th>
                            <th width="230" style="font-size:14px; font-family:'Calibri Light';">Item Description</th>
                            <th width="50" style="font-size:14px; font-family:'Calibri Light';">UOM</th>
                            <th width="60" style="font-size:14px; font-family:'Calibri Light';">YY</th>
                            <th width="50" style="font-size:14px; font-family:'Calibri Light';">Wastage %</th>
                            <th width="60" style="font-size:14px; font-family:'Calibri Light';">Total YY</th>
                            <th width="80" style="font-size:14px; font-family:'Calibri Light';">Req. Qty</th>
                            <th width="50" style="font-size:14px; font-family:'Calibri Light';">Rate</th>
                            <th width="50" style="font-size:14px; font-family:'Calibri Light';">Cost /<?=$costing_for; ?></th>
                            <th width="80" style="font-size:14px; font-family:'Calibri Light';">Total Value</th>
                            <th style="font-size:14px; font-family:'Calibri Light';">%</th>
                        </tr>
                    </thead>
                    <tbody>
                    <?
                    
                    $i=1; $trimamtTotDzn=$trimReqAmttotal=$trimPerTotal=0;
                    foreach($trimsDataArr as $trimtype=>$trimtypedata)
                    {
                        ?>
                        <tr>
                            <td colspan="11" style="font-size:14px; font-family:'Calibri Light';word-break:break-all; background-color:#FFC"><b><?=$trim_type[$trimtype]; ?> Trims Details</b></td>
                        </tr>
                        <?
                        $typeTrimsAmtDzn=$typeTrimsAmt=$typeTrimsAmtPer=0;
                        foreach($trimtypedata as $trimid=>$trimdata)
                        {
                            $rowTrimReqQty=$rowTrimReqAmt=$trim_per=0;
                            $rowTrimReqQty=$trim_qty_arr[$trimid];
                            $rowTrimReqAmt=$trim_amount_arr[$trimid];
                            
                            $trim_per=($rowTrimReqAmt/$order_values)*100;
                            ?>
                            <tr>
                                <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$trimdata['ITEM_NAME']; ?></td>
                                <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$trimdata['DESCRIPTION']; ?></td>
                                <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$unit_of_measurement[$trimdata['CONS_UOM']]; ?></td>
                                <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($trimdata["NET_CONS"],3); ?></td>
                                <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($trimdata["EX_PER"],2); ?></td>
                                <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($trimdata["GCONS"],3); ?></td>
                                
                                <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($rowTrimReqQty,3); ?></td>
                                <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($trimdata["RATE"],3); ?></td>
                                <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($trimdata["AMOUNT"],3); ?></td>
                                <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($rowTrimReqAmt,3); ?></td>
                                <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($trim_per,2); ?></td>
                            </tr>
                            <?
                                $typeTrimsAmtDzn+=$trimdata["AMOUNT"];
                                $typeTrimsAmt+=$rowTrimReqAmt;
                                $typeTrimsAmtPer+=$trim_per;
                                
                                $trimamtTotDzn+=$trimdata["AMOUNT"];
                                $trimReqAmttotal+=$rowTrimReqAmt;
                                $trimPerTotal+=$trim_per;
                        }
                         ?>
                        <tr style="background-color:#CCCCCC">
                            <td colspan="8" style="font-size:14px; font-family:'Calibri Light';word-break:break-all;" align="right"><b>Total <?=$trim_type[$trimtype]; ?> Trims Cost :</b></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($typeTrimsAmtDzn,3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($typeTrimsAmt,3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($typeTrimsAmtPer,2); ?></td>
                        </tr>
                        <?
                    }
                    ?>
                    </tbody>
                    <tfoot>
                        <tr style="background-color:#CCFFFF">
                            <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all" colspan="6" align="right"><b>Grand Total Trims Cost :</b></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right">&nbsp;</td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right">&nbsp;</td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($trimamtTotDzn,3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($trimReqAmttotal,3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($trimPerTotal,2); ?></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
			<?
		}
	}
	?>
    
    <!--Wash =====================-->
    <? if($zero_value==1) { ?>
    <div style="margin-top:15px">
    	<label style="font-size:14px; font-family:'Calibri Light'; background-color:#CCCCCC"><b>Wash Cost Details</b></label>
    	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:930px;" rules="all">
        	<thead>
                <tr style="font-weight:bold; background-color:#FFC" align="center">
                	<th width="130" style="font-size:14px; font-family:'Calibri Light';" rowspan="<?=$i; ?>" >Item</th>
                    <th width="230" style="font-size:14px; font-family:'Calibri Light';" rowspan="<?=$i; ?>" >Wash Type</th>
                    <th width="50" style="font-size:14px; font-family:'Calibri Light';">UOM</th>
                    <th width="60" style="font-size:14px; font-family:'Calibri Light';">YY</th>
                    <th width="50" style="font-size:14px; font-family:'Calibri Light';">Wastage %</th>
                    <th width="60" style="font-size:14px; font-family:'Calibri Light';">Total YY</th>
                    
                    <th width="80" style="font-size:14px; font-family:'Calibri Light';">Req. Qty</th>
                    <th width="50" style="font-size:14px; font-family:'Calibri Light';">Rate</th>
                    <th width="50" style="font-size:14px; font-family:'Calibri Light';">Cost /<?=$costing_for; ?></th>
                    <th width="80" style="font-size:14px; font-family:'Calibri Light';">Total Value</th>
                    <th style="font-size:14px; font-family:'Calibri Light';">%</th>
                </tr>
          	</thead>
            <tbody>
			<?
            $sql = "select ID, JOB_NO, EMB_NAME, EMB_TYPE, CONS_DZN_GMTS, RATE, AMOUNT from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name =3 and is_deleted=0 and status_active=1";
			$data_arrayWash=sql_select($sql);
			$wash_qty=$wash->getQtyArray_by_jobAndEmblishmentid();
			$wash_amount=$wash->getAmountArray_by_jobAndEmblishmentid();
            $washQtyTot=$washamtTotDzn=$washReqAmttotal=$washPerTotal=0;
            foreach($data_arrayWash as $wrow)
            {
                $rowWashReqQty=$rowWashReqAmt=$wash_per=0;
                $rowWashReqQty=$wash_qty[$wrow["JOB_NO"]][$wrow["ID"]];
                $rowWashReqAmt=$wash_amount[$wrow["JOB_NO"]][$wrow["ID"]];
                
                $wash_per=($rowWashReqAmt/$order_values)*100;
                ?>
                <tr>
                	<td style="font-size:14px; font-family:'Calibri Light';word-break:break-all">Wash</td>
                    <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$emblishment_wash_type[$wrow['EMB_TYPE']]; ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$costing_for; ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($wrow["CONS_DZN_GMTS"],3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><? //=fn_number_format($wrow["AVG_PROCESS_LOSS"],2); ?>&nbsp;</td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><? //=fn_number_format($wrow["AVG_CONS"],4); ?>&nbsp;</td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($rowWashReqQty,3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($wrow["RATE"],3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($wrow["AMOUNT"],3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($rowFabReqAmt,3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($fabric_per,2); ?></td>
                </tr>
                <?	
				$washQtyTot+=$rowWashReqQty;
				$washamtTotDzn+=$wrow["AMOUNT"];
				$washReqAmttotal+=$rowFabReqAmt;
				$washPerTotal+=$wash_per;
            }
            ?>
            </tbody>
            <tfoot>
            	<tr style="background-color:#CCFFFF">
                    <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all" colspan="6" align="right"><b>Total Wash Cost :</b></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($washQtyTot,3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right">&nbsp;</td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($washamtTotDzn,3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($washReqAmttotal,3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($washPerTotal,2); ?></td>
                </tr>
            </tfoot>
        </table>
    </div>
    <? } else {
		if(($emblishment_costing_arr_wash[$job_no]*1)>0)
		{
			?>
            <div style="margin-top:15px">
                <label style="font-size:14px; font-family:'Calibri Light'; background-color:#CCCCCC"><b>Wash Cost Details</b></label>
                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:930px;" rules="all">
                    <thead>
                        <tr style="font-weight:bold; background-color:#FFC" align="center">
                            <th width="130" style="font-size:14px; font-family:'Calibri Light';" rowspan="<?=$i; ?>" >Item</th>
                            <th width="230" style="font-size:14px; font-family:'Calibri Light';" rowspan="<?=$i; ?>" >Wash Type</th>
                            <th width="50" style="font-size:14px; font-family:'Calibri Light';">UOM</th>
                            <th width="60" style="font-size:14px; font-family:'Calibri Light';">YY</th>
                            <th width="50" style="font-size:14px; font-family:'Calibri Light';">Wastage %</th>
                            <th width="60" style="font-size:14px; font-family:'Calibri Light';">Total YY</th>
                            
                            <th width="80" style="font-size:14px; font-family:'Calibri Light';">Req. Qty</th>
                            <th width="50" style="font-size:14px; font-family:'Calibri Light';">Rate</th>
                            <th width="50" style="font-size:14px; font-family:'Calibri Light';">Cost /<?=$costing_for; ?></th>
                            <th width="80" style="font-size:14px; font-family:'Calibri Light';">Total Value</th>
                            <th style="font-size:14px; font-family:'Calibri Light';">%</th>
                        </tr>
                    </thead>
                    <tbody>
                    <?
                    $sql = "select ID, JOB_NO, EMB_NAME, EMB_TYPE, CONS_DZN_GMTS, RATE, AMOUNT from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name =3 and is_deleted=0 and status_active=1";
                    $data_arrayWash=sql_select($sql);
                    $wash_qty=$wash->getQtyArray_by_jobAndEmblishmentid();
                    $wash_amount=$wash->getAmountArray_by_jobAndEmblishmentid();
                    $washQtyTot=$washamtTotDzn=$washReqAmttotal=$washPerTotal=0;
                    foreach($data_arrayWash as $wrow)
                    {
                        $rowWashReqQty=$rowWashReqAmt=$wash_per=0;
                        $rowWashReqQty=$wash_qty[$wrow["JOB_NO"]][$wrow["ID"]];
                        $rowWashReqAmt=$wash_amount[$wrow["JOB_NO"]][$wrow["ID"]];
                        
                        $wash_per=($rowWashReqAmt/$order_values)*100;
                        ?>
                        <tr>
                            <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all">Wash</td>
                            <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$emblishment_wash_type[$wrow['EMB_TYPE']]; ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$costing_for; ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($wrow["CONS_DZN_GMTS"],3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><? //=fn_number_format($wrow["AVG_PROCESS_LOSS"],2); ?>&nbsp;</td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><? //=fn_number_format($wrow["AVG_CONS"],4); ?>&nbsp;</td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($rowWashReqQty,3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($wrow["RATE"],3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($wrow["AMOUNT"],3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($rowFabReqAmt,3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($fabric_per,2); ?></td>
                        </tr>
                        <?	
                        $washQtyTot+=$rowWashReqQty;
                        $washamtTotDzn+=$wrow["AMOUNT"];
        
                        $washReqAmttotal+=$rowFabReqAmt;
                        $washPerTotal+=$wash_per;
                    }
                    ?>
                    </tbody>
                    <tfoot>
                        <tr style="background-color:#CCFFFF">
                            <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all" colspan="6" align="right"><b>Total Wash Cost :</b></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($washQtyTot,3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right">&nbsp;</td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($washamtTotDzn,3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($washReqAmttotal,3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($washPerTotal,2); ?></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <?
		}
	}
	?>
    
    <!--Embellishment =====================-->
    <? if($zero_value==1) { ?>
    <div style="margin-top:15px">
    	<label style="font-size:14px; font-family:'Calibri Light'; background-color:#CCCCCC"><b>Embellishment Cost Details</b></label>
    	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:930px;" rules="all">
        	<thead>
                <tr style="font-weight:bold; background-color:#FFC" align="center">
                	<th width="130" style="font-size:14px; font-family:'Calibri Light';" rowspan="<?=$i; ?>" >Embellishment Name</th>
                    <th width="230" style="font-size:14px; font-family:'Calibri Light';">Embl. Type</th>
                    <th width="50" style="font-size:14px; font-family:'Calibri Light';">UOM</th>
                    <th width="60" style="font-size:14px; font-family:'Calibri Light';">YY</th>
                    <th width="50" style="font-size:14px; font-family:'Calibri Light';">Wastage %</th>
                    <th width="60" style="font-size:14px; font-family:'Calibri Light';">Total YY</th>
                    
                    <th width="80" style="font-size:14px; font-family:'Calibri Light';">Req. Qty</th>
                    <th width="50" style="font-size:14px; font-family:'Calibri Light';">Rate</th>
                    <th width="50" style="font-size:14px; font-family:'Calibri Light';">Cost/<?=$costing_for; ?></th>
                    <th width="80" style="font-size:14px; font-family:'Calibri Light';">Total Value</th>
                    <th style="font-size:14px; font-family:'Calibri Light';">%</th>
                </tr>
          	</thead>
            <tbody>
			<?
            $sql_emb = "select ID, JOB_NO, EMB_NAME, EMB_TYPE, CONS_DZN_GMTS, RATE, AMOUNT from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name !=3 and is_deleted=0 and status_active=1";
			$data_arrayEmb=sql_select($sql_emb);
			$emblishment_qty=$emblishment->getQtyArray_by_jobAndEmblishmentid();
			$emblishment_amount=$emblishment->getAmountArray_by_jobAndEmblishmentid();
            $embQtyTot=$embamtTotDzn=$embReqAmttotal=$embPerTotal=0;
            foreach($data_arrayEmb as $erow)
            {
				//$type_array=array(0=>$blank_array,1=>$emblishment_print_type,2=>$emblishment_embroy_type,3=>$emblishment_wash_type,4=>$emblishment_spwork_type,5=>$emblishment_gmts_type,6=>$blank_array,99=>$emblishment_other_type_arr);
				
				if($erow['EMB_NAME']==1) $type_array=$emblishment_print_type;
				else if($erow['EMB_NAME']==2) $type_array=$emblishment_embroy_type;
				else if($erow['EMB_NAME']==3) $type_array=$emblishment_wash_type;
				else if($erow['EMB_NAME']==4) $type_array=$emblishment_spwork_type;
				else if($erow['EMB_NAME']==5) $type_array=$emblishment_gmts_type;
				else if($erow['EMB_NAME']==99) $type_array=$emblishment_other_type_arr;
				else $type_array=$blank_array;
				
                $rowEmbReqQty=$rowEmbReqAmt=$emb_per=0;
                $rowEmbReqQty=$emblishment_qty[$erow["JOB_NO"]][$erow["ID"]];
                $rowEmbReqAmt=$emblishment_amount[$erow["JOB_NO"]][$erow["ID"]];
                
                $emb_per=($rowEmbReqAmt/$order_values)*100;
                ?>
                <tr>
                	<td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$emblishment_name_array[$erow['EMB_NAME']]; ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$type_array[$erow['EMB_TYPE']]; ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$costing_for; ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($erow["CONS_DZN_GMTS"],3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><? //=fn_number_format($wrow["AVG_PROCESS_LOSS"],2); ?>&nbsp;</td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><? //=fn_number_format($wrow["AVG_CONS"],4); ?>&nbsp;</td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($rowEmbReqQty,3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($erow["RATE"],3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($erow["AMOUNT"],3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($rowEmbReqAmt,3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($emb_per,2); ?></td>
                </tr>
                <?	
				$embQtyTot+=$rowWashReqQty;
				$embamtTotDzn+=$erow["AMOUNT"];
				$embReqAmttotal+=$rowEmbReqAmt;
				$embPerTotal+=$emb_per;
            }
            ?>
            </tbody>
            <tfoot>
            	<tr style="background-color:#CCFFFF">
                    <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all" colspan="6" align="right"><b>Total Embellishment Cost :</b></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($embQtyTot,3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right">&nbsp;</td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($embamtTotDzn,3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($embReqAmttotal,3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($embPerTotal,2); ?></td>
                </tr>
            </tfoot>
        </table>
    </div>
    <? } else {
		if(($emblishment_costing_arr[$job_no]*1)>0)
		{
			?>
            <div style="margin-top:15px">
                <label style="font-size:14px; font-family:'Calibri Light'; background-color:#CCCCCC"><b>Embellishment Cost Details</b></label>
                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:930px;" rules="all">
                    <thead>
                        <tr style="font-weight:bold; background-color:#FFC" align="center">
                            <th width="130" style="font-size:14px; font-family:'Calibri Light';" rowspan="<?=$i; ?>" >Embellishment Name</th>
                            <th width="230" style="font-size:14px; font-family:'Calibri Light';">Embl. Type</th>
                            <th width="50" style="font-size:14px; font-family:'Calibri Light';">UOM</th>
                            <th width="60" style="font-size:14px; font-family:'Calibri Light';">YY</th>
                            <th width="50" style="font-size:14px; font-family:'Calibri Light';">Wastage %</th>
                            <th width="60" style="font-size:14px; font-family:'Calibri Light';">Total YY</th>
                            
                            <th width="80" style="font-size:14px; font-family:'Calibri Light';">Req. Qty</th>
                            <th width="50" style="font-size:14px; font-family:'Calibri Light';">Rate</th>
                            <th width="50" style="font-size:14px; font-family:'Calibri Light';">Cost/<?=$costing_for; ?></th>
                            <th width="80" style="font-size:14px; font-family:'Calibri Light';">Total Value</th>
                            <th style="font-size:14px; font-family:'Calibri Light';">%</th>
                        </tr>
                    </thead>
                    <tbody>
                    <?
                    $sql_emb = "select ID, JOB_NO, EMB_NAME, EMB_TYPE, CONS_DZN_GMTS, RATE, AMOUNT from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name !=3 and is_deleted=0 and status_active=1";
                    $data_arrayEmb=sql_select($sql_emb);
                    $emblishment_qty=$emblishment->getQtyArray_by_jobAndEmblishmentid();
                    $emblishment_amount=$emblishment->getAmountArray_by_jobAndEmblishmentid();
                    $embQtyTot=$embamtTotDzn=$embReqAmttotal=$embPerTotal=0;
                    foreach($data_arrayEmb as $erow)
                    {
                        //$type_array=array(0=>$blank_array,1=>$emblishment_print_type,2=>$emblishment_embroy_type,3=>$emblishment_wash_type,4=>$emblishment_spwork_type,5=>$emblishment_gmts_type,6=>$blank_array,99=>$emblishment_other_type_arr);
                        
                        if($erow['EMB_NAME']==1) $type_array=$emblishment_print_type;
                        else if($erow['EMB_NAME']==2) $type_array=$emblishment_embroy_type;
                        else if($erow['EMB_NAME']==3) $type_array=$emblishment_wash_type;
                        else if($erow['EMB_NAME']==4) $type_array=$emblishment_spwork_type;
                        else if($erow['EMB_NAME']==5) $type_array=$emblishment_gmts_type;
                        else if($erow['EMB_NAME']==99) $type_array=$emblishment_other_type_arr;
                        else $type_array=$blank_array;
                        
                        $rowEmbReqQty=$rowEmbReqAmt=$emb_per=0;
                        $rowEmbReqQty=$emblishment_qty[$erow["JOB_NO"]][$erow["ID"]];
                        $rowEmbReqAmt=$emblishment_amount[$erow["JOB_NO"]][$erow["ID"]];
                        
                        $emb_per=($rowEmbReqAmt/$order_values)*100;
                        ?>
                        <tr>
                            <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$emblishment_name_array[$erow['EMB_NAME']]; ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$type_array[$erow['EMB_TYPE']]; ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$costing_for; ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($erow["CONS_DZN_GMTS"],3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><? //=fn_number_format($wrow["AVG_PROCESS_LOSS"],2); ?>&nbsp;</td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><? //=fn_number_format($wrow["AVG_CONS"],4); ?>&nbsp;</td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($rowEmbReqQty,3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($erow["RATE"],3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($erow["AMOUNT"],3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($rowEmbReqAmt,3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($emb_per,2); ?></td>
                        </tr>
                        <?	
                        $embQtyTot+=$rowWashReqQty;
                        $embamtTotDzn+=$erow["AMOUNT"];
                        $embReqAmttotal+=$rowEmbReqAmt;
                        $embPerTotal+=$emb_per;
                    }
                    ?>
                    </tbody>
                    <tfoot>
                        <tr style="background-color:#CCFFFF">
                            <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all" colspan="6" align="right"><b>Total Embellishment Cost :</b></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($embQtyTot,3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right">&nbsp;</td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($embamtTotDzn,3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($embReqAmttotal,3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($embPerTotal,2); ?></td>
                        </tr>
                    </tfoot>
                </table>
            </div>
            <?
		}
	}
	?>
    
    <!--Commercial =====================-->
    <? if($zero_value==1) { ?>
    <div style="margin-top:15px">
    	<label style="font-size:14px; font-family:'Calibri Light'; background-color:#CCCCCC"><b>Commercial Cost Details</b></label>
    	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:380px;" rules="all">
        	<thead>
                <tr style="font-weight:bold; background-color:#FFC" align="center">
                	<th width="120" style="font-size:14px; font-family:'Calibri Light';" rowspan="<?=$i; ?>" >Particulars</th>
                    <th width="50" style="font-size:14px; font-family:'Calibri Light';">Commercial %</th>
                    <th width="50" style="font-size:14px; font-family:'Calibri Light';">Cost/PCS</th>
                    <th width="80" style="font-size:14px; font-family:'Calibri Light';">Total Value</th>
                    <th style="font-size:14px; font-family:'Calibri Light';">%</th>
                </tr>
          	</thead>
            <tbody>
			<?
            $sql_comml = "select ID, JOB_NO, ITEM_ID, RATE, AMOUNT from  wo_pre_cost_comarci_cost_dtls  where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
			$data_arrayComer=sql_select($sql_comml);
			$commarcial_amount=$commercial->getAmountArray_by_jobAndPrecostdtlsid();
            foreach($data_arrayComer as $cmlrow)
            {
                $rowComlReqAmt=$coml_per=$commlAmt=0;
                $rowComlReqAmt=$commarcial_amount[$cmlrow["JOB_NO"]][$cmlrow["ID"]];
                $commlAmt=$rowComlReqAmt/$order_job_qnty;
                $coml_per=($rowComlReqAmt/$order_values)*100;
                ?>
                <tr>
                	<td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$camarcial_items[$cmlrow['ITEM_ID']]; ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($cmlrow["RATE"],3); ?></td>
                    
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($commlAmt,3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($rowComlReqAmt,3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($coml_per,2); ?></td>
                </tr>
                <?	
            }
            ?>
            </tbody>
        </table>
    </div>
    <? } else {
		if(($commercial_costing_arr[$job_no]*1)>0)
		{
			?>
            <div style="margin-top:15px">
                <label style="font-size:14px; font-family:'Calibri Light'; background-color:#CCCCCC"><b>Commercial Cost Details</b></label>
                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:380px;" rules="all">
                    <thead>
                        <tr style="font-weight:bold; background-color:#FFC" align="center">
                            <th width="120" style="font-size:14px; font-family:'Calibri Light';" rowspan="<?=$i; ?>" >Particulars</th>
                            <th width="50" style="font-size:14px; font-family:'Calibri Light';">Commercial %</th>
                            <th width="50" style="font-size:14px; font-family:'Calibri Light';">Cost/PCS</th>
                            <th width="80" style="font-size:14px; font-family:'Calibri Light';">Total Value</th>
                            <th style="font-size:14px; font-family:'Calibri Light';">%</th>
                        </tr>
                    </thead>
                    <tbody>
                    <?
                    $sql_comml = "select ID, JOB_NO, ITEM_ID, RATE, AMOUNT from  wo_pre_cost_comarci_cost_dtls  where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
                    $data_arrayComer=sql_select($sql_comml);
                    $commarcial_amount=$commercial->getAmountArray_by_jobAndPrecostdtlsid();
                    foreach($data_arrayComer as $cmlrow)
                    {
                        $rowComlReqAmt=$coml_per=$commlAmt=0;
                        $rowComlReqAmt=$commarcial_amount[$cmlrow["JOB_NO"]][$cmlrow["ID"]];
                        $commlAmt=$rowComlReqAmt/$order_job_qnty;
                        $coml_per=($rowComlReqAmt/$order_values)*100;
                        ?>
                        <tr>
                            <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$camarcial_items[$cmlrow['ITEM_ID']]; ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($cmlrow["RATE"],3); ?></td>
                            
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($commlAmt,3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($rowComlReqAmt,3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($coml_per,2); ?></td>
                        </tr>
                        <?	
                    }
                    ?>
                    </tbody>
                </table>
            </div>
            <?
		}
	}
	?>
    
    <!--Commission =====================-->
    <? if($zero_value==1) { ?>
    <div style="margin-top:15px">
    	<label style="font-size:14px; font-family:'Calibri Light'; background-color:#CCCCCC"><b>Commission Cost Details</b></label>
    	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:380px;" rules="all">
        	<thead>
                <tr style="font-weight:bold; background-color:#FFC" align="center">
                	<th width="120" style="font-size:14px; font-family:'Calibri Light';" rowspan="<?=$i; ?>" >Particulars</th>
                    <th width="50" style="font-size:14px; font-family:'Calibri Light';">Commission %</th>
                    <th width="50" style="font-size:14px; font-family:'Calibri Light';">Cost/PCS</th>
                    <th width="80" style="font-size:14px; font-family:'Calibri Light';">Total Value</th>
                    <th style="font-size:14px; font-family:'Calibri Light';">%</th>
                </tr>
          	</thead>
            <tbody>
			<?
			$sql_comm = "select ID, JOB_NO, PARTICULARS_ID, COMMISSION_BASE_ID, COMMISION_RATE, COMMISSION_AMOUNT from wo_pre_cost_commiss_cost_dtls where job_no=".$txt_job_no." and status_active=1";
			$data_arrayComi=sql_select($sql_comm);
			$commision_amount=$commision->getAmountArray_by_jobAndPrecostdtlsid();
            foreach($data_arrayComi as $cmmrow)
            {
                $rowCommReqAmt=$comm_per=$commAmt=0;
                $rowCommReqAmt=$commision_amount[$cmmrow["JOB_NO"]][$cmmrow["ID"]];
                $commAmt=$rowCommReqAmt/$order_job_qnty;
                $comm_per=($rowCommReqAmt/$order_values)*100;
                ?>
                <tr>
                	<td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$commission_particulars[$cmmrow['PARTICULARS_ID']]; ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($cmmrow["COMMISION_RATE"],4); ?></td>
                    
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($commAmt,3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($rowCommReqAmt,3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($comm_per,2); ?></td>
                </tr>
                <?	
            }
            ?>
            </tbody>
        </table>
    </div>
    <? } else { 
		if(($commission_costing_arr[$job_no]*1)>0)
		{
			?>
            <div style="margin-top:15px">
            <label style="font-size:14px; font-family:'Calibri Light'; background-color:#CCCCCC"><b>Commission Cost Details</b></label>
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:380px;" rules="all">
                <thead>
                    <tr style="font-weight:bold; background-color:#FFC" align="center">
                        <th width="120" style="font-size:14px; font-family:'Calibri Light';" rowspan="<?=$i; ?>" >Particulars</th>
                        <th width="50" style="font-size:14px; font-family:'Calibri Light';">Commission %</th>
                        <th width="50" style="font-size:14px; font-family:'Calibri Light';">Cost/PCS</th>
                        <th width="80" style="font-size:14px; font-family:'Calibri Light';">Total Value</th>
                        <th style="font-size:14px; font-family:'Calibri Light';">%</th>
                    </tr>
                </thead>
                <tbody>
                <?
                $sql_comm = "select ID, JOB_NO, PARTICULARS_ID, COMMISSION_BASE_ID, COMMISION_RATE, COMMISSION_AMOUNT from wo_pre_cost_commiss_cost_dtls where job_no=".$txt_job_no." and status_active=1";
                $data_arrayComi=sql_select($sql_comm);
                $commision_amount=$commision->getAmountArray_by_jobAndPrecostdtlsid();
                foreach($data_arrayComi as $cmmrow)
                {
                    $rowCommReqAmt=$comm_per=$commAmt=0;
                    $rowCommReqAmt=$commision_amount[$cmmrow["JOB_NO"]][$cmmrow["ID"]];
                    $commAmt=$rowCommReqAmt/$order_job_qnty;
                    $comm_per=($rowCommReqAmt/$order_values)*100;
                    ?>
                    <tr>
                        <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$commission_particulars[$cmmrow['PARTICULARS_ID']]; ?></td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($cmmrow["COMMISION_RATE"],4); ?></td>
                        
                        <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($commAmt,3); ?></td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($rowCommReqAmt,3); ?></td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($comm_per,2); ?></td>
                    </tr>
                    <?	
                }
                ?>
                </tbody>
            </table>
        </div>
            <?
		}
	}
	?>
    
    <!--Courier =====================-->
    <? if($zero_value==1) { ?>
    <div style="margin-top:15px">
    	<label style="font-size:14px; font-family:'Calibri Light'; background-color:#CCCCCC"><b>Courier Cost Details</b></label>
    	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:380px;" rules="all">
        	<thead>
                <tr style="font-weight:bold; background-color:#FFC" align="center">
                	<th width="120" style="font-size:14px; font-family:'Calibri Light';" rowspan="<?=$i; ?>" >Particulars</th>
                    <th width="50" style="font-size:14px; font-family:'Calibri Light';">Courier %</th>
                    <th width="50" style="font-size:14px; font-family:'Calibri Light';">Cost/PCS</th>
                    <th width="80" style="font-size:14px; font-family:'Calibri Light';">Total Value</th>
                    <th style="font-size:14px; font-family:'Calibri Light';">%</th>
                </tr>
          	</thead>
            <tbody>
			<?
                $rowCourierReqAmt=$courier_per=$courierAmt=0;
                $rowCourierReqAmt=$summary_data[currier_pre_cost_job];
                $courierAmt=$rowCourierReqAmt/$order_job_qnty;
                $courier_per=($rowCourierReqAmt/$order_values)*100;
           ?>
                <tr>
                	<td style="font-size:14px; font-family:'Calibri Light';word-break:break-all">Courier</td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($summary_data[currier_percent],3); ?></td>
                    
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($courierAmt,3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($rowCourierReqAmt,3); ?></td>
                    <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($courier_per,2); ?></td>
                </tr>
            </tbody>
        </table>
    </div>
    <? } else {
		if(($other_costing_arr[$job_no]['currier_pre_cost']*1)>0)
		{
			?>
            <div style="margin-top:15px">
                <label style="font-size:14px; font-family:'Calibri Light'; background-color:#CCCCCC"><b>Courier Cost Details</b></label>
                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:380px;" rules="all">
                    <thead>
                        <tr style="font-weight:bold; background-color:#FFC" align="center">
                            <th width="120" style="font-size:14px; font-family:'Calibri Light';" rowspan="<?=$i; ?>" >Particulars</th>
                            <th width="50" style="font-size:14px; font-family:'Calibri Light';">Courier %</th>
                            <th width="50" style="font-size:14px; font-family:'Calibri Light';">Cost/PCS</th>
                            <th width="80" style="font-size:14px; font-family:'Calibri Light';">Total Value</th>
                            <th style="font-size:14px; font-family:'Calibri Light';">%</th>
                        </tr>
                    </thead>
                    <tbody>
                    <?
                        $rowCourierReqAmt=$courier_per=$courierAmt=0;
                        $rowCourierReqAmt=$summary_data[currier_pre_cost_job];
                        $courierAmt=$rowCourierReqAmt/$order_job_qnty;
                        $courier_per=($rowCourierReqAmt/$order_values)*100;
                        ?>
                        <tr>
                            <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all">Courier</td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($summary_data[currier_percent],3); ?></td>
                            
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($courierAmt,3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($rowCourierReqAmt,3); ?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="right"><?=fn_number_format($courier_per,2); ?></td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <?
		}
	}
	?>
    <br/>
    <?
    $lib_designation_arr=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");
	$user_lib_designation_arr=return_library_array("SELECT id,designation from user_passwd", "id", "designation");
	$user_lib_name_arr=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");

	$mst_id=return_field_value("id as mst_id","wo_pre_cost_mst","job_no=$txt_job_no","mst_id");
	$unapprove_sql_data_array=sql_select("select b.approved_by, b.un_approved_by, b.approved_date, b.un_approved_reason, b.un_approved_date, b.approved_no,b.APPROVED,b.UN_APPROVED_REASON from approval_history b where b.mst_id=$mst_id and b.entry_form=46 order by b.id");


    foreach($unapprove_sql_data_array as $row){
        $unapprove_data_array[$row['APPROVED_BY']]=$row;
    }


	if(count($unapprove_data_array)>0)
	{
		$app_status_arr = array(0=>'Un App',1=>'Full App',2=>'Deny',3=>'Partial App');
        ?>
		<table width="930" class="rpt_table" border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
                <tr>
                	<th colspan="7" style="font-size:14px; font-family:'Calibri Light';word-break:break-all">Approval/Un Approval History</th>
                </tr>
                <tr>
                    <th width="30" style="font-size:14px; font-family:'Calibri Light';word-break:break-all">SL</th>
                    <th width="150" style="font-size:14px; font-family:'Calibri Light';word-break:break-all">Name</th>
                    <th width="120" style="font-size:14px; font-family:'Calibri Light';word-break:break-all">Designation</th>
                    <th width="60" style="font-size:14px; font-family:'Calibri Light';word-break:break-all">Approval Status</th>
                    <th width="60" style="font-size:14px; font-family:'Calibri Light';">Approval No</th>
                    <th width="120" style="font-size:14px; font-family:'Calibri Light';word-break:break-all">App. Date & Time</th>
                    <th style="font-size:14px; font-family:'Calibri Light';word-break:break-all">Reason For Un-Approval</th>
                </tr>
            </thead>
            <tbody>
				<?
                $i=1;
                foreach($unapprove_data_array as $row)
				{
					?>
					<tr>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center"><?=$i; ?></td>
                        <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$user_lib_name_arr[$row[csf('approved_by')]]; ?></td>
                        <td style="font-size:14px; font-family:'Calibri Light';"><?=$lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]]; ?></td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center"><?= $app_status_arr[$row['APPROVED']]; ?></td>
                        <td style="font-size:14px; font-family:'Calibri Light';" align="center"><?=$row[csf('approved_no')];?></td>
                        <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><? if($row[csf('approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); else echo ""; ?></td>
                        <td style="font-size:14px; font-family:'Calibri Light';"> &nbsp; <?= $row['UN_APPROVED_REASON']; ?></td>
					</tr>
					<?
					$i++;
					//$un_approved_date= explode(" ",$row[csf('un_approved_date')]);
					//$un_approved_date=$un_approved_date[0];
					//if($un_approved_date=="") $un_approved_date="";else $un_approved_date=$un_approved_date;

					if($un_approved_date!="")
					{
						if($row[csf('un_approved_by')]!==0)  $row[csf('approved_by')]=$row[csf('un_approved_by')];
						?>
						<tr>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="center"><?=$i;?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$user_lib_name_arr[$row[csf('approved_by')]];?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';"><?=$lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="center"><?='No';?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';" align="center"><?=$row[csf('approved_no')];?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><? if($row[csf('un_approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('un_approved_date')])); else echo "";?></td>
                            <td style="font-size:14px; font-family:'Calibri Light';word-break:break-all"><?=$unapproved_request_arr[$mst_id];?></td>
						</tr>
						<?
						$i++;
					}


                }
                ?>
            </tbody>
		</table>
		<?
	}
	?>
    <br>
    <table width="930" align="center">
            <tr>
            <div style="text-align:center;font-size:xx-large; font-style:italic; margin-top:20px; color:#FF0000;">
				<?
                if(count($approval_arr)>0)
                {
                    if($approved == 2 || $approved == 0){echo "Draft";}else{}
                }
                ?>
            </div>
            </tr>
    </table>
 	<?
	echo signature_table(109, $cbo_company_name, "930px",'','1','','');
	//signature_table($report_id, $company, $width, $template_id="", $padding_top = 70,$prepared_by='',$userSignatureArr=array(),$break_tr=7, $custom_style='')
	exit();
}

if($action=="fabric_description_popup")
{
	echo load_html_head_contents("Fabric Description Info", "../../../", 1, 1,'','','');
	extract($_REQUEST);
	?>

	<script>
		function js_set_value(data)
		{
			var data=data.split('_');
			if(data[1] == 2)
			{
				var fabric_yarn_description=return_global_ajax_value(data[0]+'**'+data[1], 'fabric_yarn_description', '', 'pre_cost_entry_controller_v2');
				var fabric_yarn_description_arr=fabric_yarn_description.split("**");
				var fabric_description=trim(data[2])+' '+trim(fabric_yarn_description_arr[0]);
				document.getElementById('fab_des_id').value=data[0];
				document.getElementById('fab_nature_id').value=data[1];
				document.getElementById('construction').value=trim(data[2]);
				document.getElementById('fab_gsm').value=trim(data[3]);
				document.getElementById('process_loss').value=trim(data[4]);
				document.getElementById('fab_desctiption').value=trim(fabric_description);
				document.getElementById('fab_desctiption_title').value=trim(fabric_description+','+fabric_yarn_description_arr[2]);
				document.getElementById('composition').value=trim(fabric_yarn_description_arr[0]);
				var yarn =fabric_yarn_description_arr[1].split("_");
				if(yarn[1]*1==0 || yarn[1]==""){
					alert("Composition not set in yarn count determination");
					return;
				}
				document.getElementById('yarn_desctiption').value=trim(fabric_yarn_description_arr[1]);
				parent.emailwindow.hide();
			}
			if(data[1] == 3)
			{
				var fabric_yarn_description=return_global_ajax_value(data[0]+'**'+data[1], 'fabric_yarn_description', '', 'pre_cost_entry_controller_v2');
				var fabric_yarn_description_arr=fabric_yarn_description.split("**");
				
				var rdFabref="";
				if(trim(data[7])!="" && trim(data[8])!="") rdFabref=trim(data[7])+', '+trim(data[8])+',';
				else if(trim(data[7])!="" && trim(data[8])=="") rdFabref=trim(data[7])+',';
				else if(trim(data[7])=="" && trim(data[8])!="") rdFabref=trim(data[8])+',';
				
				var fabric_description=trim(rdFabref)+' '+trim(data[4])+' '+trim(data[2])+' '+trim(data[5])+' '+trim(fabric_yarn_description_arr[0]);
				
				document.getElementById('fab_des_id').value=data[0];
				document.getElementById('fab_nature_id').value=data[1];
				document.getElementById('construction').value=trim(data[2]);
				document.getElementById('fab_gsm').value=trim(data[3]);
				document.getElementById('weight_type').value=trim(data[6]);
				document.getElementById('fab_desctiption').value=trim(fabric_description);
				document.getElementById('fab_desctiption_title').value=trim(fabric_description+','+fabric_yarn_description_arr[2]);
				document.getElementById('composition').value=trim(fabric_yarn_description_arr[0]);
				var yarn =fabric_yarn_description_arr[1].split("_");
				if(yarn[1]*1==0 || yarn[1]==""){
					alert("Composition not set in yarn count determination");
					return;
				}
				document.getElementById('yarn_desctiption').value=trim(fabric_yarn_description_arr[1]);
				parent.emailwindow.hide();
			}
			
		}
		function toggle( x, origColor )
		{
			var newColor = 'yellow';
			document.getElementById(x).style.backgroundColor = ( newColor == document.getElementById(x).style.backgroundColor )? origColor : newColor;
		}
		</script>
    </head>
    <body>
    <div align="center">
        <form name="styleRef_form" id="styleRef_form">
		<fieldset>
            <table cellspacing="0" cellpadding="0" border="1" rules="all" align="center" class="rpt_table" id="tbl_list">
                <thead>
                    <tr>
                    	<th colspan="4" align="center"><? echo create_drop_down( "cbo_string_search_type", 100, $string_search_type,'', 1, "-- Searching Type --" ); ?></th>
                    </tr>
                    <tr>
                    	<th>RD No</th>
                        <th>Construction</th>
                        <th>Ounce/Weight</th>
                        <th><input type="reset" name="button" class="formbutton" value="Reset" style="width:100px;" onClick="reset_form('styleRef_form','search_div','','','','');"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr class="general">
                    	<td align="center"><input type="text" style="width:80px" class="text_boxes" name="txt_rdno" id="txt_rdno" /></td>
                        <td align="center"><input type="text" style="width:130px" class="text_boxes" name="txt_construction" id="txt_construction" /></td>
                        <td align="center">	<input type="text" style="width:130px" class="text_boxes" name="txt_gsm_weight" id="txt_gsm_weight" /></td>
                        <td align="center">
                        	<input type="button" name="button" class="formbutton" value="Show" onClick="show_list_view ('<? echo $fabric_nature; ?>'+'**'+'<? echo $libyarncountdeterminationid; ?>'+'**'+document.getElementById('txt_construction').value+'**'+document.getElementById('txt_gsm_weight').value+'**'+document.getElementById('cbo_string_search_type').value+'**'+document.getElementById('txt_rdno').value, 'fabric_description_popup_search_list_view', 'search_div', 'pre_cost_entry_controller_v2', 'setFilterGrid(\'list_view\',-1)'); toggle( 'tr_'+'<? echo $libyarncountdeterminationid; ?>', '#FFFFCC');" style="width:100px;" />
                        </td>
                    </tr>
            	</tbody>
           	</table>
            <div style="margin-top:5px" id="search_div"></div>
		</fieldset>
	</form>
    </div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
	exit();
}

if($action=="fabric_description_popup_search_list_view")
{
	extract($_REQUEST);
	list($fabric_nature,$libyarncountdeterminationid,$construction,$gsm_weight,$string_search_type,$rdno)=explode('**',$data);
	$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count"  );
	$search_con='';
	$user_arr=return_library_array( "select user_full_name,id from user_passwd", "id", "user_full_name");
	if($string_search_type==1)
	{
		if($construction!='') {$search_con .= " and a.construction='".trim($construction)."'";}
		if($gsm_weight!='') {$search_con .= " and a.gsm_weight='".trim($gsm_weight)."'";}
		if($rdno!='') {$search_con .= " and a.rd_no='".trim($rdno)."'";}
	}
	else if($string_search_type==2)
	{
		if($construction!='') {$search_con .= " and a.construction like ('".trim($construction)."%')";}
		if($gsm_weight!='') {$search_con .= " and a.gsm_weight like ('".trim($gsm_weight)."%')";}
		if($rdno!='') {$search_con .= " and a.rd_no like ('".trim($rdno)."%')";}
	}
	else if($string_search_type==3)
	{
		if($construction!='') {$search_con .= " and a.construction like ('%".trim($construction)."')";}
		if($gsm_weight!='') {$search_con .= " and a.gsm_weight like ('%".trim($gsm_weight)."')";}
		if($rdno!='') {$search_con .= " and a.rd_no like ('%".trim($rdno)."')";}
	}
	else if($string_search_type==4 || $string_search_type==0)
	{
		if($construction!='') {$search_con .= " and a.construction like ('%".trim($construction)."%')";}
		if($gsm_weight!='') {$search_con .= " and a.gsm_weight like ('%".trim($gsm_weight)."%')";}
		if($rdno!='') {$search_con .= " and a.rd_no like ('%".trim($rdno)."%')";}
	}

?>
</head>
<body>

    <!-- <div> -->
        <form>
            <input type="hidden" id="fab_des_id" name="fab_des_id" />
            <input type="hidden" id="fab_nature_id" name="fab_des_id" />
            <input type="hidden" id="construction" name="construction" />
            <input type="hidden" id="composition" name="composition" />
            <input type="hidden" id="fab_gsm" name="fab_gsm" />
            <input type="hidden" id="process_loss" name="process_loss" />
            <input type="hidden" id="fab_desctiption" name="fab_desctiption" />
            <input type="hidden" id="fab_desctiption_title" name="fab_desctiption_title" />
            <input type="hidden" id="yarn_desctiption" name="yarn_desctiption" />
            <input type="hidden" id="weight_type" name="weight_type" />
        </form>
<?
	$composition_arr=array();
	$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count");
	$lib_group_short=return_library_array( "select id,group_short_name from lib_group where id=1 and status_active=1", "id", "group_short_name");
	$group_short_name=$lib_group_short[1];
	$arr=array (0=>$item_category, 3=>$color_range,6=>$composition,8=>$lib_yarn_count,9=>$yarn_type);
	if($fabric_nature == 2)
	{
		$sql="select a.fab_nature_id,a.construction,a.gsm_weight,a.color_range_id,a.stich_length,a.process_loss,b.copmposition_id,b.percent,b.count_id,b.type_id,a.id,b.id as bid,a.shrinkage_l,a.shrinkage_w from  lib_yarn_count_determina_mst a,  lib_yarn_count_determina_dtls b where a.id=b.mst_id and  b.is_deleted=0 and  b.is_deleted=0 and a.entry_form=184 order by a.id,b.id";
		$table_width='1030';
		$table_width2='1050';
	}
	if($fabric_nature == 3)
	{
		$sql="select a.fab_nature_id,a.construction,a.gsm_weight,a.color_range_id,a.stich_length,a.process_loss,b.copmposition_id,b.percent,b.count_id,b.type_id,a.id,b.id as bid,a.shrinkage_l,a.shrinkage_w from  lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and  a.is_deleted=0 and a.entry_form=426 order by a.id,b.id";
		$table_width='1130';
		$table_width2='1150';
	}
	
	$data_array=sql_select($sql);
	$sysCodeArr=array();
	if (count($data_array)>0)
	{
		foreach( $data_array as $row )
		{
			$compo_per="";
			if(($row[csf('percent')]*1)>0) $compo_per=$row[csf('percent')]."% "; else $compo_per="";
			if(array_key_exists($row[csf('id')],$composition_arr))
			{
				$composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('copmposition_id')]]." ".$compo_per.$lib_yarn_count[$row[csf('count_id')]]." ".$yarn_type[$row[csf('type_id')]].",";
			}
			else
			{
				$composition_arr[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$compo_per.$lib_yarn_count[$row[csf('count_id')]]." ".$yarn_type[$row[csf('type_id')]].",";
			}
			$sys_code=$group_short_name.'-'.$row[csf('id')];
			$sysCodeArr[$row[csf('id')]]=$sys_code;
			
		}
	}
?>
    <table class="rpt_table" width="<? echo $table_width?>" cellspacing="0" cellpadding="0" border="0" rules="all" style="position: sticky; top: 0;" >
        <thead>
        	<? if($fabric_nature == 2){        		
        		?>
            <tr>
                <th style="word-wrap: break-word;word-break: break-all;" width="25">SL No</th>                
                <th style="word-wrap: break-word;word-break: break-all;" width="80">Sequence<br>No</th>
                <th style="word-wrap: break-word;word-break: break-all;" width="100">Fab<br>Nature</th>
                <th style="word-wrap: break-word;word-break: break-all;" width="100">Construction</th>
                <th style="word-wrap: break-word;word-break: break-all;" width="100">Ounce/<br>Weight</th>
                <th style="word-wrap: break-word;word-break: break-all;" width="100">Color<br>Range</th>
                <th style="word-wrap: break-word;word-break: break-all;" width="90">Stich<br>Length</th>
                <th style="word-wrap: break-word;word-break: break-all;" width="50">Process<br>Loss</th>
                <th style="word-wrap: break-word;word-break: break-all;">Composition</th>
            </tr>
            <? }
            else if($fabric_nature == 3){  ?>
        	<tr>
        		<th style="word-wrap: break-word;word-break: break-all;" width="25">SL No</th>
	            <th style="word-wrap: break-word;word-break: break-all;" width="80">Fab<br>Nature</th>
                <th style="word-wrap: break-word;word-break: break-all;" width="80">RD No</th>
	            <th style="word-wrap: break-word;word-break: break-all;" width="80">Fabric<br>Ref</th>
	            <th style="word-wrap: break-word;word-break: break-all;" width="70">Type</th>
	            <th style="word-wrap: break-word;word-break: break-all;" width="100">Construction</th>
	            <th style="word-wrap: break-word;word-break: break-all;" width="80">Design</th>
	            <th style="word-wrap: break-word;word-break: break-all;" width="50">Ounce/<br>Weight</th>
	            <th style="word-wrap: break-word;word-break: break-all;" width="50">Weight<br>Type</th>
	            <th style="word-wrap: break-word;word-break: break-all;" width="50">Color<br>Range</th>
	            <th style="word-wrap: break-word;word-break: break-all;" width="50">Full<br>Width</th>
	            <th style="word-wrap: break-word;word-break: break-all;" width="50">Cutable<br>Width</th>
	            <th style="word-wrap: break-word;word-break: break-all;" width="55">Shrinkage<br>L</th>
	            <th style="word-wrap: break-word;word-break: break-all;" width="55">Shrinkage<br>W</th>
	            <th style="word-wrap: break-word;word-break: break-all;" width="190">Composition</th>          
        	</tr>
            <? } ?>
       </thead>
   </table>
   <!-- <div id="" style="max-height:300px; width:<? echo $table_width2; ?>px; overflow-y:scroll"> -->
   <table id="list_view" class="rpt_table" width="<? echo $table_width; ?>" height="" cellspacing="0" cellpadding="0" border="1" rules="all" style="max-height:300px; overflow-y:scroll">
        <tbody>
	<?
	if($fabric_nature == 2){
		$sql_data=sql_select("select a.fab_nature_id, a.construction, a.gsm_weight, a.color_range_id, a.stich_length, a.process_loss, a.id, a.sequence_no from  lib_yarn_count_determina_mst a,  lib_yarn_count_determina_dtls b where a.id=b.mst_id and  a.fab_nature_id= '$fabric_nature' and  a.is_deleted=0 and a.status_active=1 and  b.is_deleted=0 and  b.is_deleted=0 and entry_form=184 $search_con group by a.id,a.fab_nature_id,a.construction,a.gsm_weight,a.color_range_id,a.stich_length,a.process_loss,a.sequence_no order by a.id");
		$i=1;
		foreach($sql_data as $row)
		{
			if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
			?>
	            <tr id="tr_<? echo $row[csf('id')] ?>" bgcolor="<? echo $bgcolor; ?>" height="20" style="cursor:pointer; word-break:break-all;" onClick="js_set_value('<? echo $row[csf('id')]."_".$row[csf('fab_nature_id')]."_".$row[csf('construction')]."_".$row[csf('gsm_weight')]."_".$row[csf('process_loss')]."____"; ?>')">
	                <td style="word-wrap: break-word;word-break: break-all;" width="25"><? echo $i; ?></td>
	                <td style="word-wrap: break-word;word-break: break-all;" width="80" align="left"><? echo $row[csf('sequence_no')]; ?></td>
	                <td style="word-wrap: break-word;word-break: break-all;" width="100" align="left"><? echo $item_category[$row[csf('fab_nature_id')]]; ?></td>
	                <td style="word-wrap: break-word;word-break: break-all;" width="100" align="left"><? echo $row[csf('construction')]; ?></td>
	                <td style="word-wrap: break-word;word-break: break-all;" width="100" align="right"><? echo $row[csf('gsm_weight')]; ?></td>
	                <td style="word-wrap: break-word;word-break: break-all;" width="100" align="left"><? echo $color_range[$row[csf('color_range_id')]]; ?></td>
	                <td style="word-wrap: break-word;word-break: break-all;" width="90" align="right"><? echo $row[csf('stich_length')]; ?></td>
	                <td style="word-wrap: break-word;word-break: break-all;" width="50" align="right"><? echo $row[csf('process_loss')]; ?></td>
	                <td style="word-wrap: break-word;word-break: break-all;"><? echo $composition_arr[$row[csf('id')]]; ?></td>
	            </tr>

			<?
		    $i++;
	    }
	}
	if($fabric_nature == 3){
		$sql_data=sql_select("select a.id,a.fab_nature_id, a.type, a.construction, a.gsm_weight, a.weight_type, a.design, a.fabric_ref, a.color_range_id, a.rd_no, a.inserted_by, a.status_active, a.full_width, a.cutable_width,a.shrinkage_l,a.shrinkage_w from  lib_yarn_count_determina_mst a where a.is_deleted=0 and a.status_active=1 and a.entry_form=426 $search_con order by a.id");
		$i=1;
		foreach($sql_data as $row)
		{
			if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
			?>
	            <tr id="tr_<?=$row[csf('id')] ?>" bgcolor="<?=$bgcolor; ?>" height="20" style="cursor:pointer; word-break:break-all;" onClick="js_set_value('<?=$row[csf('id')]."_".$row[csf('fab_nature_id')]."_".$row[csf('construction')]."_".$row[csf('gsm_weight')]."_".$row[csf('type')]."_".$row[csf('design')]."_".$row[csf('weight_type')]."_".$row[csf('rd_no')]."_".$row[csf('fabric_ref')]; ?>')">
	                <td width="25" align="center"><?=$i; ?></td>
	                <td width="80" style="word-break:break-all"><?=$item_category[$row[csf('fab_nature_id')]]; ?></td>
                    <td width="80" style="word-break:break-all"><?=$row[csf('rd_no')]; ?></td>
	                <td width="80" style="word-break:break-all"><?=$row[csf('fabric_ref')]; ?></td>
	                <td width="70" style="word-break:break-all"><?=$row[csf('type')]; ?></td>
	                <td width="100" style="word-break:break-all"><?=$row[csf('construction')]; ?></td>
	                <td width="80" style="word-break:break-all"><?=$row[csf('design')]; ?></td>
	                <td width="50" style="word-break:break-all"><?=$row[csf('gsm_weight')]; ?></td>
	                <td width="50" style="word-break:break-all"><?=$fabric_weight_type[$row[csf('weight_type')]]; ?></td>
	                <td width="50" style="word-break:break-all"><?=$color_range[$row[csf('color_range_id')]]; ?></td>
	                <td width="50" style="word-break:break-all"><?=$row[csf('full_width')]; ?></td>
	                <td width="50" style="word-break:break-all"><?=$row[csf('cutable_width')]; ?></td>
	                <td width="55" style="word-break:break-all"><?=$row[csf('shrinkage_l')]; ?></td>
	                <td width="55" style="word-break:break-all"><?=$row[csf('shrinkage_w')]; ?></td>
	                <td width="190" style="word-break:break-all"><?=$composition_arr[$row[csf('id')]]; ?></td>
	            </tr>
			<?
		    $i++;
	    }
	}	
    ?>
        </tbody>
    </table>

</body>
</html>
<?
exit();
}

if($action =="fabric_yarn_description")
{
	$fab_description=""; $yarn_description="";
	$data_arr = explode("**", $data);
	$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count");
	$shinkage='';
	if($data_arr[1] == 2)
	{
		$sql="select a.fab_nature_id,a.construction,a.gsm_weight,a.color_range_id,a.stich_length,a.process_loss,b.copmposition_id,b.percent,b.count_id,b.type_id,a.id,a.shrinkage_l,a.shrinkage_w from  lib_yarn_count_determina_mst a,  lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id=$data_arr[0] and  a.is_deleted=0 and a.entry_form=184 order by a.id,b.id";

		$data_array=sql_select($sql);
		if (count($data_array)>0)
		{
			foreach( $data_array as $row )
			{
				$compo_per="";
				if(($row[csf('percent')]*1)>0) $compo_per=$row[csf('percent')]."% "; else $compo_per="";
				if($fab_description!="")
				{
					$fab_description=$fab_description." ".$composition[$row[csf('copmposition_id')]]." ".$compo_per;
				}
				else
				{
					$fab_description=$composition[$row[csf('copmposition_id')]]." ".$compo_per;
				}

				if($shinkage!="")
				{
					$shinkage=$shinkage.",".$row[csf('shrinkage_l')].",".$row[csf('shrinkage_w')];
				}
				else
				{
					$shinkage=$row[csf('shrinkage_l')].",".$row[csf('shrinkage_w')];
				}

				if($yarn_description!="")
				{
					$yarn_description=$yarn_description."__".$row[csf('count_id')]."_".$row[csf('copmposition_id')]."_100_".$row[csf('type_id')]."_".$row[csf('percent')];
				}
				else
				{
					$yarn_description=$row[csf('count_id')]."_".$row[csf('copmposition_id')]."_100_".$row[csf('type_id')]."_".$row[csf('percent')];
				}
			}
		}
	}
	if($data_arr[1] == 3)
	{
		$sql="SELECT a.id,a.fab_nature_id, a.type, a.construction, a.gsm_weight, a.weight_type, a.design, a.fabric_ref, a.color_range_id, a.inserted_by, a.status_active, b.copmposition_id, b.percent, b.count_id, b.type_id,a.shrinkage_l,a.shrinkage_w from  lib_yarn_count_determina_mst a join  lib_yarn_count_determina_dtls b on a.id=b.mst_id where a.id=$data_arr[0] and  a.is_deleted=0 and a.entry_form=426 order by a.id,b.id";
		$data_array=sql_select($sql);
		if (count($data_array)>0)
		{
			foreach( $data_array as $row )
			{
				$compo_per="";
				if(($row[csf('percent')]*1)>0) $compo_per=$row[csf('percent')]."% "; else $compo_per="";
				if($fab_description!="")
				{
					$fab_description=$fab_description." ".$composition[$row[csf('copmposition_id')]]." ".$compo_per;
				}
				else
				{
					$fab_description=$composition[$row[csf('copmposition_id')]]." ".$compo_per;
				}

				if($shinkage!="")
				{
					$shinkage=$shinkage.",".$row[csf('shrinkage_l')].",".$row[csf('shrinkage_w')];
				}
				else
				{
					$shinkage=$row[csf('shrinkage_l')].",".$row[csf('shrinkage_w')];
				}

				if($yarn_description!="")
				{
					$yarn_description=$yarn_description."__".$row[csf('count_id')]."_".$row[csf('copmposition_id')]."_100_".$row[csf('type_id')]."_".$row[csf('percent')];
				}
				else
				{
					$yarn_description=$row[csf('count_id')]."_".$row[csf('copmposition_id')]."_100_".$row[csf('type_id')]."_".$row[csf('percent')];
				}
			}
		}
	}
	echo $fab_description."**".$yarn_description."**".$shinkage;

}

if($action=="rate_amount")
{
	$result="";
	$data_array=sql_select("select rate,amount from  wo_pre_cost_fabric_cost_dtls where id='$data'");
	foreach( $data_array as $row )
	{
	  $result=$row["rate"]."_".$row["amount"];
	}
	echo $result;
}

if ($action=="consumption_popup")
{
    echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode,'','');
    extract($_REQUEST);
	$cons_breck_downn= $_SESSION['logic_erp']['cons_breck_downn'];
	$msmnt_breack_downn= $_SESSION['logic_erp']['msmnt_breack_downn'];
	$marker_breack_down= $_SESSION['logic_erp']['marker_breack_down'];
	$fabrication_data = sql_select("SELECT full_width, cutable_width from lib_yarn_count_determina_mst where id=$fid");
	foreach ($fabrication_data as $row) {
		$fabric_width = $row[csf('full_width')];
		$fabric_cwidth = $row[csf('cutable_width')];
	}

?>
<script>
	function copy_value(value,field_id,i)
	{
		//var copy_val=document.getElementById('copy_val').checked;
		var hid_fab_cons_in_quotation_variable=document.getElementById('hid_fab_cons_in_quotation_variable').value;
		var process_loss_method_id=document.getElementById('process_loss_method_id').value;
		//alert(hid_fab_cons_in_quotation_variable);
		var gmtssizesid=document.getElementById('gmtssizesid_'+i).value;
		var itemsizes=document.getElementById('itemsizes_'+i).value;
		var pocolorid=document.getElementById('pocolorid_'+i).value;
		var ponoid=document.getElementById('ponoid_'+i).value;
		var rowCount = $('#tbl_consmption_cost tr').length-1;
		var copy_basis=$('input[name="copy_basis"]:checked').val()
	    //alert(hid_fab_cons_in_quotation_variable+'='+copy_basis);
		if(hid_fab_cons_in_quotation_variable==1)
		{
			if(copy_basis=="no")  calculate_requirement(i)
			
			for(var j=i; j<=rowCount; j++)
			{
				var isDisabled = document.getElementById(field_id+j).disabled;
				if(isDisabled==false)
				{
					if(document.getElementById('approved_'+j).value==0)
					{
						if(field_id=='itemsizes_')
						{
							if(copy_basis==0){
								document.getElementById(field_id+j).value=value;
							}
							if(copy_basis==1)
							{
								if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value)
								{
									document.getElementById(field_id+j).value=value;
									//calculate_requirement(j)
								}
							}
							else if(copy_basis==2)
							{
								if( pocolorid==document.getElementById('pocolorid_'+j).value)
								{
									document.getElementById(field_id+j).value=value;
									//calculate_requirement(j)
								}
							}
							else if(copy_basis==3)
							{
								if( ponoid==document.getElementById('ponoid_'+j).value)
								{
									document.getElementById(field_id+j).value=value;
									//calculate_requirement(j)
								}
							}
						}
					
						if(field_id=='diawidth_' || field_id=='cons_' || field_id=='processloss_' || field_id=='remarks_')
						{
							//alert(copy_basis);
							if(copy_basis==0){
								document.getElementById(field_id+j).value=value;
							}
						
							if(copy_basis==1)
							{
								if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
							}
							else if(copy_basis==2)
							{
								if( pocolorid==document.getElementById('pocolorid_'+j).value) document.getElementById(field_id+j).value=value;
							}
							else if(copy_basis==4)//not used
							{
								if( pocolorid==document.getElementById('pocolorid_'+j).value && gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
							}
							else if(copy_basis==3)
							{
								if( ponoid==document.getElementById('ponoid_'+j).value) document.getElementById(field_id+j).value=value;
							}
						//if(field_id!='remarks_') calculate_requirement(j);
						}
						if(field_id=='rate_')
						{
							if(copy_basis==0){
								document.getElementById(field_id+j).value=value;
							}
								
						  if(copy_basis==1)
						  {
							if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0)
							{
							document.getElementById(field_id+j).value=value;
							//claculate_amount(j)
							}
						  }
						 else if(copy_basis==2)
						  {
							if( pocolorid==document.getElementById('pocolorid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0)
							{
							document.getElementById(field_id+j).value=value;
							//claculate_amount(j)
							}
						  }
						  else if(copy_basis==3)
						  {
							if( ponoid==document.getElementById('ponoid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0)
							{
							document.getElementById(field_id+j).value=value;
							//claculate_amount(j)
							}
						  }
						  /*else if(copy_val==true && (document.getElementById('requirement_'+j).value*1) >0)
						  {
							  document.getElementById(field_id+j).value=value;
							  
						  }
						  else if(copy_val==true && ((document.getElementById('requirement_'+j).value*1) ==0 || (document.getElementById('requirement_'+j).value*1)==''))
						  {
							  document.getElementById(field_id+j).value=value;
							 
						  }*/
						}				
						if(field_id=='finachar_')
						{
							if(copy_basis==0){
									document.getElementById(field_id+j).value=value;
								}
							if(copy_basis==1)
							{
								if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value)
								{
									document.getElementById(field_id+j).value=value;
									//calculate_requirement(j)
								}
							}
							else if(copy_basis==2)
							{
								if( pocolorid==document.getElementById('pocolorid_'+j).value)
								{
									document.getElementById(field_id+j).value=value;
									//calculate_requirement(j)
								}
							}
							else if(copy_basis==3)
							{
								if( ponoid==document.getElementById('ponoid_'+j).value)
								{
									document.getElementById(field_id+j).value=value;
									//calculate_requirement(j)
								}
							}
							
						}
						if(field_id!='remarks_' || field_id!='itemsizes_')
						{
							var cons=(document.getElementById('cons_'+j).value)*1;
							var processloss=(document.getElementById('processloss_'+j).value)*1;
							var WastageQty='';
							if(process_loss_method_id==1)
							{
								WastageQty=cons+cons*(processloss/100);
							}
							else if(process_loss_method_id==2)
							{
								var devided_val = 1-(processloss/100);
								var WastageQty=parseFloat(cons/devided_val);
							}
							else WastageQty=0;
							
							WastageQty= number_format_common( WastageQty, 6, 0) ;
							document.getElementById('processloss_'+j).value=processloss;
							document.getElementById('requirement_'+j).value= WastageQty;
						}
						var rate=document.getElementById('rate_'+j).value;
						var requirement=document.getElementById('requirement_'+j).value;
						var plan_cut_qty=document.getElementById('pcsgmts_'+j).value*1;
						var pcs=document.getElementById('pcs_'+j).value*1;
						var finachar=document.getElementById('finachar_'+i).value*1;
					
						var rowtotReq=(requirement/pcs)*plan_cut_qty;
						//var amount= requirement*rate;
						var amount = requirement*rate+((requirement*rate)*finachar/100); // New methos add for Ha-meem group
						var rowtotAmt=rowtotReq*rate;
						document.getElementById('amount_'+j).value=number_format_common(amount,6,0);
						document.getElementById('totqty_'+j).value=number_format_common(rowtotReq,6,0);
						document.getElementById('totamount_'+j).value=number_format_common(rowtotAmt,6,0);
					}
				}
			}
			set_sum_value( 'cons_sum', 'cons_');
			set_sum_value( 'processloss_sum', 'processloss_');
			set_sum_value( 'requirement_sum', 'requirement_');
			set_sum_value( 'pcs_sum', 'pcs_');
			set_sum_value( 'rate_sum', 'rate_');
			set_sum_value( 'amount_sum', 'amount_');
			set_sum_value( 'totReq_sum', 'totqty_');
			set_sum_value( 'totAmount_sum', 'totamount_');
			set_sum_value( 'finachar_sum', 'finachar_');
			claculate_avg();
		}
		if(hid_fab_cons_in_quotation_variable==2)
		{
			if(copy_basis=="no")  calculate_requirement(i)
			for(var j=i; j<=rowCount; j++)
			{
			  	if(document.getElementById('approved_'+j).value==0)
			  	{
			  		
						
						if(field_id=='itemsizes_')
						{
							if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value)
							{
								document.getElementById(field_id+j).value=value;
								calculate_measurement_top(j);
							}
						}
					
			  		if(field_id=='diawidth_' || field_id=='processloss_' || field_id=='remarks_' || field_id=='bodylength_' || field_id=='bodysewingmargin_' || field_id=='bodyhemmargin_' || field_id=='sleevelength_' || field_id=='sleevesewingmargin_' || field_id=='sleevehemmargin_' || field_id=='chestlenght_' || field_id=='chestsewingmargin_' || field_id=='frontriselength_' || field_id=='frontrisesewingmargin_' || field_id=='westbandlength_' || field_id=='westbandsewingmargin_' || field_id=='inseamlength_' || field_id=='inseamsewingmargin_' || field_id=='inseamhemmargin_' || field_id=='halfthailength_' || field_id=='halfthaisewingmargin_' || field_id=='finachar_')
					{
						if(copy_basis==0){
								document.getElementById(field_id+j).value=value;
							}
							
						if(copy_basis==1)
						{
							if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
						}
						else if(copy_basis==2)
						{
							if( pocolorid==document.getElementById('pocolorid_'+j).value) document.getElementById(field_id+j).value=value;
						}
						else if(copy_basis==3)
						{
							if( pocolorid==document.getElementById('pocolorid_'+j).value && gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
						}
						/*else if(copy_basis==4)
						{
							if( ponoid==document.getElementById('ponoid_'+j).value) document.getElementById(field_id+j).value=value;
						}*/
						//else if(copy_val==true) document.getElementById(field_id+j).value=value;
						
						if(field_id!='remarks_') calculate_requirement(j);
						if(field_id=='bodylength_' || field_id=='bodysewingmargin_' || field_id=='bodyhemmargin_' || field_id=='sleevelength_' || field_id=='sleevesewingmargin_' || field_id=='sleevehemmargin_' || field_id=='chestlenght_' || field_id=='chestsewingmargin_' || field_id=='frontriselength_' || field_id=='frontrisesewingmargin_' || field_id=='westbandlength_' || field_id=='westbandsewingmargin_' || field_id=='inseamlength_' || field_id=='inseamsewingmargin_' || field_id=='inseamhemmargin_' || field_id=='halfthailength_' || field_id=='halfthaisewingmargin_') calculate_measurement_top(j);
					}				
				}
			}
		}
		if(hid_fab_cons_in_quotation_variable==3)
		{

			if(copy_basis=="no")  calculate_requirement(i);
			for(var j=i; j<=rowCount; j++)
			{
				if(document.getElementById('approved_'+j).value==0)
				{
				  	
						if(field_id=='diawidth_' || field_id=='itemsizes_' || field_id=='itemsizes_')
						{
							if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;

							calculate_requirement(j);
						}
					
						if(field_id=='cons_' || field_id=='processloss_' || field_id=='remarks_')
						{
							if(copy_basis==0){
								document.getElementById(field_id+j).value=value;
							}
							if(copy_basis==1)
							{
								if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
							}
							else if(copy_basis==2)
							{
								if( pocolorid==document.getElementById('pocolorid_'+j).value) document.getElementById(field_id+j).value=value;
							}
							else if(copy_basis==3)
							{
								if( pocolorid==document.getElementById('pocolorid_'+j).value && gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
							}
							/*else if(copy_basis==4)
							{
								if( ponoid==document.getElementById('ponoid_'+j).value) document.getElementById(field_id+j).value=value;
							}*/
							//else if(copy_val==true) document.getElementById(field_id+j).value=value;
							
							if(field_id!='remarks_') calculate_requirement(j);
						}
					
				}
		  	}
		}
	}

	function check_width_is_null_or_not(i)
	{
		var cbofabricnature_id=document.getElementById('cbofabricnature_id').value;
		if(cbofabricnature_id==3)
		{
			 if(document.getElementById('diawidth_'+i).value=='' || document.getElementById('diawidth_'+i).value==0)
			 {
				 alert("Fill up Width")
				 document.getElementById('diawidth_'+i).focus();
			 }
		}
	}

	function fn_delete_down_tr(rowNo,table_id)
	{
		if(table_id=='tbl_consmption_cost')
		{
			var numRow = $('table#tbl_consmption_cost tbody tr').length;
			if(numRow==rowNo && rowNo!=1)
			{
				$('#tbl_consmption_cost tbody tr:last').remove();
				$('#tbl_msmnt_cost tbody tr:last').remove();
			}
			set_sum_value( 'cons_sum', 'cons_'  );
			set_sum_value( 'processloss_sum', 'processloss_'  );
			set_sum_value( 'requirement_sum', 'requirement_');
			set_sum_value( 'pcs_sum', 'pcs_');
		}
	}

	function set_sum_value(des_fil_id,field_id)
	{
		if(des_fil_id=='cons_sum')
		{
			var ddd={dec_type:5,comma:0};
		}
		if(des_fil_id=='processloss_sum')
		{
			var ddd={dec_type:5,comma:0};
		}

		if(des_fil_id=='requirement_sum')
		{
			var ddd={dec_type:5,comma:0};
		}
		if(des_fil_id=='pcs_sum')
		{
			var ddd={dec_type:6,comma:0};
		}
		if(des_fil_id=='amount_sum')
		{
			var ddd={dec_type:5,comma:0};
		}
		if(des_fil_id=='rate_sum')
		{
			var ddd={dec_type:5,comma:0};
		}
		if(des_fil_id=='totReq_sum')
		{
			var ddd={dec_type:5,comma:0};
		}
		if(des_fil_id=='totAmount_sum')
		{
			var ddd={dec_type:5,comma:0};
		}
		if(des_fil_id=='finachar_sum')
		{
			var ddd={dec_type:5,comma:0};
		}
		var rowCount = $('#tbl_consmption_cost tr').length-1;
		//var rowCount = $('#tbl_consmption_cost tr').length-3;
		math_operation( des_fil_id, field_id, '+', rowCount,ddd );
		/*document.getElementById('calculated_cons').value=(document.getElementById('requirement_sum').value*1)/rowCount;
		document.getElementById('avg_cons').value=(document.getElementById('cons_sum').value*1)/rowCount;
		document.getElementById('calculated_procloss').value=(document.getElementById('processloss_sum').value*1)/rowCount;
	    document.getElementById('calculated_pcs').value=(document.getElementById('pcs_sum').value*1)/rowCount;*/
		claculate_avg()
	}

	function js_set_value()
	{
		var body_part_id=document.getElementById('body_part_id').value;
		var cbofabricnature_id=document.getElementById('cbofabricnature_id').value;
		var cbofabricsource_id=document.getElementById('cbofabricsource_id').value;
		var hid_fab_cons_in_quotation_variable=document.getElementById('hid_fab_cons_in_quotation_variable').value;
		var rowCount = $('#tbl_consmption_cost tr').length-1;
		var cons_breck_down="";
		var msmnt_breack_down="";
		var marker_breack_down="";
		if(hid_fab_cons_in_quotation_variable==3)
		{
			if(form_validation('txt_marker_dia*txt_marker_yds*txt_marker_inch*txt_gmt_pcs*txt_marker_length_yds*txt_marker_gsm*txt_marker_net_fab_cons','Marker Dia*Marker Yds*Marker Inch*Gmt Pcs*Marker Length*Marker Gsm*Marker Net Fabric')==false)
			{
				return;
			}
			else
			{
				var txt_marker_dia=$('#txt_marker_dia').val();
				var txt_marker_yds=$('#txt_marker_yds').val();
				var txt_marker_inch=$('#txt_marker_inch').val();
				var txt_gmt_pcs=$('#txt_gmt_pcs').val();
				var txt_marker_length_yds=$('#txt_marker_length_yds').val();
				var txt_marker_net_fab_cons=$('#txt_marker_net_fab_cons').val();
				marker_breack_down+=txt_marker_dia+'_'+txt_marker_yds+'_'+txt_marker_inch+'_'+txt_gmt_pcs+'_'+txt_marker_length_yds+'_'+txt_marker_net_fab_cons;
			}
		}
		for(var i=1; i<=rowCount; i++)
		{
			var ponoid=$('#ponoid_'+i).val()
			if(ponoid=='')
			{
				 ponoid=0;
			}
			var pocolorid=$('#pocolorid_'+i).val()
			if(pocolorid=='')
			{
				pocolorid=0;
			}
			var gmtssizesid=$('#gmtssizesid_'+i).val()
			if(gmtssizesid=='')
			{
				 gmtssizesid=0;
			}
			var diawidth=$('#diawidth_'+i).val()
			if(diawidth=='')
			{
				 diawidth=0;
			}
			var itemsizes=$('#itemsizes_'+i).val();
			if(itemsizes=='')
			{
				 itemsizes=0;
			}
			var cons=$('#cons_'+i).val()
			if(cons=='')
			{
				 cons=0;
			}
			var processloss=$('#processloss_'+i).val()
			if(processloss=='')
			{
				 processloss=0;
			}
			var requirement=$('#requirement_'+i).val()
			if(requirement=='')
			{
				 requirement=0;
			}
		    var pcs=$('#pcs_'+i).val()
			if(pcs=='')
			{
				 pcs=0;
			}
		    var colorsizetableid=$('#colorsizetableid_'+i).val()
			if(colorsizetableid=='')
			{
				 colorsizetableid=0;
			}
			var rate=$('#rate_'+i).val()
			if(rate=='')
			{
				 rate=0;
			}
			var amount=$('#amount_'+i).val()
			if(amount=='')
			{
				 amount=0;
			}
			var remarks=$('#remarks_'+i).val()
			if(remarks=='')
			{
				 remarks='no remarks';
			}
			var finachar=$('#finachar_'+i).val()
			if(finachar=='')
			{
				finachar=0;
			}

				if(cbofabricnature_id==3 && diawidth !='' && cons=='' && processloss!=0 )
				{
					alert("Fill up  Cons")
					return;
				}
				if(cbofabricnature_id==3 && diawidth =='' && cons!='' && processloss!=0 )
				{
					alert("Fill up Width")
					return;
				}

				if(cbofabricnature_id==3 && diawidth =='' && cons=='' && processloss!=0 )
				{
					alert("Fill up  Cons and Width")
					return;
				}

				if(cbofabricnature_id==3 && diawidth !=0 && cons==0 && processloss!=0 )
				{
					alert("Fill up  Cons")
					return;
				}
				if(cbofabricnature_id==3 && diawidth ==0 && cons!=0 && processloss!=0 )
				{
					alert("Fill up Width")
					return;
				}
				if(cbofabricnature_id==3 && diawidth ==0 && cons==0 && processloss!=0 )
				{
					alert("Fill up  Cons and Width")
					return;
				}

				if(cbofabricnature_id==3 && diawidth ==0 && cons!=0 && processloss==0 )
				{
					alert("Fill up Width Process Loss")
					return;
				}
				//=======================================================


				if(cbofabricnature_id==2  && cons!='' && processloss=='')
				{
					alert("Fill up  Process Loss")
					return;
				}
				if(cbofabricnature_id==2  && cons=='' && (processloss*1)!='')
				{
					alert("Fill up Cons")
					return;
				}
				//========================================================
				if(cbofabricnature_id==2  && cons!=0 && (processloss*1) < 0 )
				{
					alert("Fill up  Process Loss")
					return;
				}
				if(cbofabricnature_id==2  && cons==0 && (processloss*1)!=0)
				{
					alert("Fill up Cons")
					return;
				}

				//======================================================

				if(cbofabricsource_id==2 && (cons*1) > 0 && rate==0){
					alert("Fill up Rate")
					return;
				}


				if(body_part_id==1 && hid_fab_cons_in_quotation_variable==2 && cons!='' && processloss!='' && form_validation('bodylength_'+i+'*bodysewingmargin_'+i+'*bodyhemmargin_'+i+'*sleevelength_'+i+'*sleevesewingmargin_'+i+'*sleevehemmargin_'+i+'*chestlenght_'+i+'*chestsewingmargin_'+i,'Body Length*Body Sewing Margin*Body Hem Margin*Sleeve Length*Sleeve Sewing Margin*Sleeve Hem Margin*Chest Length*Chest Sewing Margin')==false)
			    {
					return;
			     }
				 if(body_part_id==20 && hid_fab_cons_in_quotation_variable==2  && cons!='' && processloss!='' && form_validation('frontriselength_'+i+'*frontrisesewingmargin_'+i+'*westbandlength_'+i+'*westbandsewingmargin_'+i+'*inseamlength_'+i+'*inseamsewingmargin_'+i+'*inseamhemmargin_'+i+'*halfthailength_'+i+'*halfthaisewingmargin_'+i,'Front Rise Length*Front Rise Sewing Margin*West Band Length*West Band Sewing Margin*Inseam Length*Inseam Sewing Margin*Inseam Hem Margin*Half Thai Length* Half Thai Sewing Margin')==false )
			    {
					 return;
			    }
				//if(cons !="")
				//{
					if(cons_breck_down=="")
					{
						cons_breck_down+=ponoid+'_'+pocolorid+'_'+gmtssizesid+'_'+diawidth+'_'+itemsizes+'_'+cons+'_'+processloss+'_'+requirement+'_'+pcs+'_'+colorsizetableid+'_'+rate+'_'+amount+'_'+remarks+'_'+finachar;
					}
					else
					{
						cons_breck_down+="__"+ponoid+'_'+pocolorid+'_'+gmtssizesid+'_'+diawidth+'_'+itemsizes+'_'+cons+'_'+processloss+'_'+requirement+'_'+pcs+'_'+colorsizetableid+'_'+rate+'_'+amount+'_'+remarks+'_'+finachar;
					}
				//}

			if(hid_fab_cons_in_quotation_variable==2)
			{
				if(body_part_id==1)
				{
					var bodylength=$('#bodylength_'+i).val();
					if(bodylength=='')
					{
						bodylength=0;
					}
					var bodysewingmargin=$('#bodysewingmargin_'+i).val();
					if(bodysewingmargin=='')
					{
						bodysewingmargin=0;
					}
					var bodyhemmargin=$('#bodyhemmargin_'+i).val();
					if(bodyhemmargin=='')
					{
						bodyhemmargin=0;
					}
					var sleevelength=$('#sleevelength_'+i).val();
					if(sleevelength=='')
					{
						sleevelength=0;
					}
					var sleevesewingmargin=$('#sleevesewingmargin_'+i).val();
					if(sleevesewingmargin=='')
					{
						sleevesewingmargin=0;
					}
					var sleevehemmargin=$('#sleevehemmargin_'+i).val();
					if(sleevehemmargin=='')
					{
						sleevehemmargin=0;
					}
					var chestlenght=$('#chestlenght_'+i).val();
					if(chestlenght=='')
					{
						chestlenght=0;
					}
					var chestsewingmargin= $('#chestsewingmargin_'+i).val();
					if(chestsewingmargin=='')
					{
						chestsewingmargin=0;
					}
					var totalcons=$('#totalcons_'+i).val();
					if(totalcons=='')
					{
						totalcons=0;
					}
				}

				if(body_part_id==20)
				{
					var frontriselength= $('#frontriselength_'+i).val();
					if(frontriselength=='')
					{
						frontriselength=0;
					}
					var frontrisesewingmargin=$('#frontrisesewingmargin_'+i).val();
					if(frontrisesewingmargin=='')
					{
						frontrisesewingmargin=0;
					}
					var westbandlength=$('#westbandlength_'+i).val();
					if(westbandlength=='')
					{
						westbandlength=0;
					}
					var westbandsewingmargin=$('#westbandsewingmargin_'+i).val();
					if(westbandsewingmargin=='')
					{
						westbandsewingmargin=0;
					}
					var inseamlength=$('#inseamlength_'+i).val();
					if(inseamlength=='')
					{
						inseamlength=0;
					}
					var inseamsewingmargin=$('#inseamsewingmargin_'+i).val();
					if(inseamsewingmargin=='')
					{
						inseamsewingmargin=0;
					}
					var inseamhemmargin=$('#inseamhemmargin_'+i).val();
					if(inseamhemmargin=='')
					{
						inseamhemmargin=0;
					}
					var halfthailength=$('#halfthailength_'+i).val();
					if(halfthailength=='')
					{
						halfthailength=0;
					}
					var halfthaisewingmargin=$('#halfthaisewingmargin_'+i).val();
					if(halfthaisewingmargin=='')
					{
						halfthaisewingmargin=0;
					}
					var totalcons=$('#totalcons_'+i).val();
					if(totalcons=='')
					{
						totalcons=0;
					}
				}

				//if(cons !="")
				//{
				if(msmnt_breack_down=="")
				{

					if(body_part_id==1)
					{
					msmnt_breack_down+=bodylength+'_'+bodysewingmargin+'_'+bodyhemmargin+'_'+sleevelength+'_'+sleevesewingmargin+'_'+sleevehemmargin+'_'+chestlenght+'_'+chestsewingmargin+'_'+totalcons;
					}
					if(body_part_id==20)
					{
					msmnt_breack_down+=frontriselength+'_'+frontrisesewingmargin+'_'+westbandlength+'_'+westbandsewingmargin+'_'+inseamlength+'_'+inseamsewingmargin+'_'+inseamhemmargin+'_'+halfthailength+'_'+halfthaisewingmargin+'_'+totalcons;
					}
				}
				else
				{
					if(body_part_id==1)
					{
					msmnt_breack_down+="__"+bodylength+'_'+bodysewingmargin+'_'+bodyhemmargin+'_'+sleevelength+'_'+sleevesewingmargin+'_'+sleevehemmargin+'_'+chestlenght+'_'+chestsewingmargin+'_'+totalcons;
					}
					if(body_part_id==20)
					{
					msmnt_breack_down+="__"+frontriselength+'_'+frontrisesewingmargin+'_'+westbandlength+'_'+westbandsewingmargin+'_'+inseamlength+'_'+inseamsewingmargin+'_'+inseamhemmargin+'_'+halfthailength+'_'+halfthaisewingmargin+'_'+totalcons;
					}
				}
				//}
			}
		}
		document.getElementById('cons_breck_down').value=cons_breck_down;
		document.getElementById('msmnt_breack_down').value=msmnt_breack_down;
	    document.getElementById('marker_breack_down').value=marker_breack_down;

		//alert(cons_breck_down)
		claculate_avg();
		parent.emailwindow.hide();
	}

	function calculate_measurement_top(i)
	{
		var body_part_id=document.getElementById('body_part_id').value;
		var cbofabricnature_id=document.getElementById('cbofabricnature_id').value;
		var cbo_costing_per_id=document.getElementById('cbo_costing_per_id').value;
		if (cbo_costing_per_id==1) var dzn_mult=1*12;
		else if (cbo_costing_per_id==2) var dzn_mult=1*1;
		else if (cbo_costing_per_id==3) var dzn_mult=2*12;
		else if (cbo_costing_per_id==4) var dzn_mult=3*12;
		else if (cbo_costing_per_id==5) var dzn_mult=4*12;
		else dzn_mult=0;

		//------------------------------------Knit------------------------------------
		if(cbofabricnature_id==2)//Knit
		{
		var txt_required_gsm_top=(document.getElementById('txt_gsm').value)*1;
			if (body_part_id==1)//main fabric top
			{
				var txt_body_length_measurement_top=0;
				var txt_body_length_sewing_top=0;
				var txt_body_length_hem_top=0;
				var txt_sleeve_length_measurement_top=0;
				var txt_sleeve_length_sewing_top=0;
				var txt_sleeve_length_hem_top=0;
				var txt_chest_measurement_top=0;
				var txt_chest_sew_top=0;
				txt_body_length_measurement_top=(document.getElementById('bodylength_'+i).value)*1;
				txt_body_length_sewing_top=(document.getElementById('bodysewingmargin_'+i).value)*1;
				txt_body_length_hem_top=(document.getElementById('bodyhemmargin_'+i).value)*1;
				txt_sleeve_length_measurement_top=(document.getElementById('sleevelength_'+i).value)*1;
				txt_sleeve_length_sewing_top=(document.getElementById('sleevesewingmargin_'+i).value)*1;
				txt_sleeve_length_hem_top=(document.getElementById('sleevehemmargin_'+i).value)*1;
				txt_chest_measurement_top=(document.getElementById('chestlenght_'+i).value)*1;
				txt_chest_sew_top=(document.getElementById('chestsewingmargin_'+i).value)*1;
				//[{(Body Lentg +Sleeve Lenth + Sewing Margin + Hem) x (Half Chest + Sewing Margin)} x 2] x 12 x GSM / 10000000
				var dbl_total=(((txt_body_length_measurement_top +txt_sleeve_length_measurement_top+txt_body_length_sewing_top + txt_sleeve_length_sewing_top+txt_body_length_hem_top+txt_sleeve_length_hem_top) * (txt_chest_measurement_top + txt_chest_sew_top)) * 2) * 12 * txt_required_gsm_top / 10000000;

	            //var dbl_total=(((txt_body_length_measurement_top*1)+(txt_body_length_sewing_top*1)+(txt_body_length_hem_top*1)+(txt_sleeve_length_measurement_top*1)+(txt_sleeve_length_sewing_top*1)+(txt_sleeve_length_hem_top*1))*((txt_chest_measurement_top*1)+(txt_chest_sew_top*1))*2*(dzn_mult*1)*(txt_required_gsm_top*1))/10000000;
			}
			if (body_part_id==20)//main fabric bottom
			{
				var txt_front_rise_measurement_bottom=0;
				var txt_front_rise_sewing_bottom=0;
				var txt_west_band_measurement_bottom=0;
				var txt_west_band_sewing_bottom=0;
				var txt_in_seam_measurement_bottom=0;
				var txt_in_seam_sew_bottom=0;
				var txt_in_seam_hem_bottom=0;
				var txt_half_thai_measurement_bottom=0;
				var txt_half_thai_sew_bottom=0;
				var txt_front_rise_measurement_bottom=(document.getElementById('frontriselength_'+i).value)*1;
				var txt_front_rise_sewing_bottom=(document.getElementById('frontrisesewingmargin_'+i).value)*1;
				var txt_west_band_measurement_bottom=(document.getElementById('westbandlength_'+i).value)*1;
				var txt_west_band_sewing_bottom=(document.getElementById('westbandsewingmargin_'+i).value)*1;
				var txt_in_seam_measurement_bottom=(document.getElementById('inseamlength_'+i).value)*1;
				var txt_in_seam_sew_bottom=(document.getElementById('inseamsewingmargin_'+i).value)*1;
				var txt_in_seam_hem_bottom=document.getElementById('inseamhemmargin_'+i).value;
				var txt_half_thai_measurement_bottom=(document.getElementById('halfthailength_'+i).value)*1;
	 			var txt_half_thai_sew_bottom=(document.getElementById('halfthaisewingmargin_'+i).value)*1;
				//[{(Front Rise + In Seam + West Band + Sewing Margin + Hem) x (Half Thai + Sewing Margin)} x 4] x 12  x GSM / 10000000
				var dbl_total=(((txt_front_rise_measurement_bottom +txt_west_band_measurement_bottom +txt_in_seam_measurement_bottom+txt_front_rise_sewing_bottom + txt_west_band_sewing_bottom+txt_in_seam_sew_bottom+txt_in_seam_hem_bottom) * (txt_half_thai_measurement_bottom+txt_half_thai_sew_bottom)) * 4) * 12  * txt_required_gsm_top/ 10000000;
				//var dbl_total=(((txt_front_rise_measurement_bottom*1)+(txt_front_rise_sewing_bottom*1)+(txt_west_band_measurement_bottom*1)+(txt_west_band_sewing_bottom*1)+(txt_in_seam_measurement_bottom*1)+(txt_in_seam_sew_bottom*1)+(txt_in_seam_hem_bottom*1))*((txt_half_thai_measurement_bottom*1)+(txt_half_thai_sew_bottom*1))*4*(dzn_mult*1)*(txt_required_gsm_top*1))/10000000;
			}
		}
		//------------------------------------End Knit------------------------------------
		//----------------------------------- Woven---------------------------------------
		if(cbofabricnature_id==3)//woven
		{
		 var txt_required_weight_top=document.getElementById('diawidth_'+i).value;
			if (body_part_id==1)//main fabric top
			{
				var txt_body_length_measurement_top=0;
				var txt_body_length_sewing_top=0;
				var txt_body_length_hem_top=0;
				var txt_sleeve_length_measurement_top=0;
				var txt_sleeve_length_sewing_top=0;
				var txt_sleeve_length_hem_top=0;
				var txt_chest_measurement_top=0;
				var txt_chest_sew_top=0;
				txt_body_length_measurement_top=document.getElementById('bodylength_'+i).value;
				txt_body_length_sewing_top=document.getElementById('bodysewingmargin_'+i).value;
				txt_body_length_hem_top=document.getElementById('bodyhemmargin_'+i).value;
				txt_sleeve_length_measurement_top=document.getElementById('sleevelength_'+i).value;
				txt_sleeve_length_sewing_top=document.getElementById('sleevesewingmargin_'+i).value;
				txt_sleeve_length_hem_top=document.getElementById('sleevehemmargin_'+i).value;
				txt_chest_measurement_top=document.getElementById('chestlenght_'+i).value;
				txt_chest_sew_top=document.getElementById('chestsewingmargin_'+i).value;
				//[{(Body Lentg +Sleeve Lenth + Sewing Margin + Hem) x (Half Chest + Sewing Margin)} x 2] x 12 / (Width x 36)
				var dbl_total=(((txt_body_length_measurement_top*1)+(txt_body_length_sewing_top*1)+(txt_body_length_hem_top*1)+(txt_sleeve_length_measurement_top*1)+(txt_sleeve_length_sewing_top*1)+(txt_sleeve_length_hem_top*1))*((txt_chest_measurement_top*1)+(txt_chest_sew_top*1))*2*(dzn_mult*1))/((txt_required_weight_top*1)*36);

			}
			if (body_part_id==20)//main fabric bottom
			{
				var txt_front_rise_measurement_bottom=0;
				var txt_front_rise_sewing_bottom=0;
				var txt_west_band_measurement_bottom=0;
				var txt_west_band_sewing_bottom=0;
				var txt_in_seam_measurement_bottom=0;
				var txt_in_seam_sew_bottom=0;
				var txt_in_seam_hem_bottom=0;
				var txt_half_thai_measurement_bottom=0;
				var txt_half_thai_sew_bottom=0;
				var txt_front_rise_measurement_bottom=document.getElementById('frontriselength_'+i).value;
				var txt_front_rise_sewing_bottom=document.getElementById('frontrisesewingmargin_'+i).value;
				var txt_west_band_measurement_bottom=document.getElementById('westbandlength_'+i).value;
				var txt_west_band_sewing_bottom=document.getElementById('westbandsewingmargin_'+i).value;
				var txt_in_seam_measurement_bottom=document.getElementById('inseamlength_'+i).value;
				var txt_in_seam_sew_bottom=document.getElementById('inseamsewingmargin_'+i).value;
				var txt_in_seam_hem_bottom=document.getElementById('inseamhemmargin_'+i).value;
				var txt_half_thai_measurement_bottom=document.getElementById('halfthailength_'+i).value;
	 			var txt_half_thai_sew_bottom=document.getElementById('halfthaisewingmargin_'+i).value;
				//[{(Front Rise + In Seam + West Band + Sewing Margin + Hem) x (Half Thai + Sewing Margin)} x 4] x 12  / Width x 36
				var dbl_total=(((txt_front_rise_measurement_bottom*1)+(txt_front_rise_sewing_bottom*1)+(txt_west_band_measurement_bottom*1)+(txt_west_band_sewing_bottom*1)+(txt_in_seam_measurement_bottom*1)+(txt_in_seam_sew_bottom*1)+(txt_in_seam_hem_bottom*1))*((txt_half_thai_measurement_bottom*1)+(txt_half_thai_sew_bottom*1))*4*(dzn_mult*1))/((txt_required_weight_top*1)*36);

			}
		}
		//----------------------------------- End Woven---------------------------------------
	    dbl_total= number_format_common( dbl_total, 5, 0) ;
		document.getElementById('totalcons_'+i).value=dbl_total;
		document.getElementById('cons_'+i).value=dbl_total;
		set_sum_value( 'cons_sum', 'cons_'  );
		set_sum_value( 'requirement_sum', 'requirement_' )
		calculate_requirement(i)
		claculate_avg()

	}
	function calculate_requirement(i)
	{
		var process_loss_method_id=document.getElementById('process_loss_method_id').value;
		var cons=(document.getElementById('cons_'+i).value)*1;
		var processloss=(document.getElementById('processloss_'+i).value)*1;
		    var WastageQty='';
			if(process_loss_method_id==1)
			{
				WastageQty=cons+(cons*(processloss/100));
			}
			else if(process_loss_method_id==2)
			{
				var devided_val = 1-(processloss/100);
				var WastageQty=parseFloat(cons/devided_val);
			}
			else
			{
				WastageQty=0;
			}
			WastageQty= number_format_common( WastageQty, 6, 0) ;
			document.getElementById('processloss_'+i).value=processloss;
			document.getElementById('requirement_'+i).value= WastageQty;
			//set_sum_value( 'requirement_sum', 'requirement_' )
			//claculate_amount(i)
			//claculate_avg()
	}

	function claculate_avg()
	{
		var tot_plancut_qty=document.getElementById('tot_plancut_qty').value*1
		var item_ratio=document.getElementById('item_ratio').value*1
		var calculated_cons=0; var avg_cons=0; var plancutqty=0; var calculated_amount=0; var significant_row=0; var avg_finachar=0; var avg_rate=0;
		var rowCount = $('#tbl_consmption_cost tr').length-1;

		for(var j=1; j<=rowCount; j++){
			if(document.getElementById('cons_'+j).value =='' || document.getElementById('cons_'+j).value ==0){
				continue;
			}
			else{
				plancutqty+=document.getElementById('pcsgmts_'+j).value*1;
			}
		}

		for(var i=1; i<=rowCount; i++){
			if(document.getElementById('cons_'+i).value =='' || document.getElementById('cons_'+i).value ==0){
				continue;
			}
			else{
				significant_row=significant_row+1;
				var pcsgmts=document.getElementById('pcsgmts_'+i).value*1
				//var plan_cut_percent=(pcsgmts/plancutqty)*100;
				var plan_cut_percent=(pcsgmts/tot_plancut_qty)*100;

				var cons=document.getElementById('cons_'+i).value*1
				var avg_cons_percent=(cons*plan_cut_percent)/100;
				avg_cons+=avg_cons_percent;

				var requirement=document.getElementById('requirement_'+i).value*1
				var calculated_cons_percent=(requirement*plan_cut_percent)/100;
				calculated_cons+=calculated_cons_percent;

				var amount=document.getElementById('amount_'+i).value*1
				var calculated_amount_percent=(amount*plan_cut_percent)/100;
				
				calculated_amount+=calculated_amount_percent;
			}
		}
		var calculated_procloss=(document.getElementById('processloss_sum').value*1)/significant_row;
		avg_finachar=(document.getElementById('finachar_sum').value*1)/significant_row;

		avg_rate=(document.getElementById('rate_sum').value*1)/significant_row;
	    var calculated_pcs=(document.getElementById('pcs_sum').value*1)/significant_row;
		//console.log(avg_rate+'--'+significant_row);
		document.getElementById('calculated_cons').value=number_format_common(calculated_cons, 6, 0);
		document.getElementById('avg_cons').value=number_format_common(avg_cons, 6, 0);
		document.getElementById('calculated_procloss').value=number_format_common(calculated_procloss, 5, 0);
	    document.getElementById('calculated_pcs').value=calculated_pcs;
		document.getElementById('calculated_plancutqty').value=plancutqty;
		document.getElementById('calculated_finachar').value=avg_finachar;
		document.getElementById('calculated_amount').value=number_format_common(calculated_amount, 6, 0);
		document.getElementById('calculated_rate').value=number_format_common(calculated_amount/calculated_cons, 6, 0);
		//document.getElementById('calculated_rate').value=number_format_common(avg_rate, 5, 0);
	}

	function calculate_marker_length()
	{
		var cbo_costing_per_id=document.getElementById('cbo_costing_per_id').value;
		
		if (cbo_costing_per_id==1) var dzn_mult=1*12;
		else if (cbo_costing_per_id==2) var dzn_mult=1*1;
		else if (cbo_costing_per_id==3) var dzn_mult=2*12;
		else if (cbo_costing_per_id==4) var dzn_mult=3*12;
		else if (cbo_costing_per_id==5) var dzn_mult=4*12;
		else dzn_mult=0;
		
		var txt_marker_yds= (document.getElementById('txt_marker_yds').value)*1;
		var txt_marker_inch= (document.getElementById('txt_marker_inch').value)*1;
		var txt_gmt_pcs= (document.getElementById('txt_gmt_pcs').value)*1;
		var txt_marker_dia= (document.getElementById('txt_marker_dia').value)*1;
		var txt_marker_gsm= (document.getElementById('txt_marker_gsm').value)*1;
		var txt_marker_length_yds=(txt_marker_inch/36)+txt_marker_yds;
		var txt_marker_length_yds2=(txt_marker_length_yds/txt_gmt_pcs)*dzn_mult;
		txt_marker_length_yds3= number_format_common( txt_marker_length_yds2, 5, 0) ;
	    document.getElementById('txt_marker_length_yds').value=txt_marker_length_yds3;
		var txt_marker_net_fab_cons=((txt_marker_length_yds3*36*2.54)/dzn_mult)*(txt_marker_dia*2*2.54*dzn_mult*txt_marker_gsm);
		var txt_marker_net_fab_cons2=txt_marker_net_fab_cons/10000000;
		document.getElementById('txt_marker_net_fab_cons').value=number_format_common(txt_marker_net_fab_cons2,5,0);
		copy_value(number_format_common(txt_marker_net_fab_cons2,5,0),'cons_',1);
	}

	function claculate_amount(i){
		var rate=document.getElementById('rate_'+i).value;
		var requirement=document.getElementById('requirement_'+i).value;
		var plan_cut_qty=document.getElementById('pcsgmts_'+i).value*1;
		var pcs=document.getElementById('pcs_'+i).value*1;
		var finachar=document.getElementById('finachar_'+i).value*1;

		var rowtotReq=(requirement/pcs)*plan_cut_qty;
		//var amount= requirement*rate;
		var amount = requirement*rate+((requirement*rate)*finachar/100); // New methos add for Ha-meem group
		var rowtotAmt=rowtotReq*rate;
		document.getElementById('amount_'+i).value=number_format_common(amount,6,0);
		document.getElementById('totqty_'+i).value=number_format_common(rowtotReq,6,0);
		document.getElementById('totamount_'+i).value=number_format_common(rowtotAmt,6,0);
		set_sum_value( 'amount_sum', 'amount_' );
		set_sum_value( 'totReq_sum', 'totqty_');
		set_sum_value( 'totAmount_sum', 'totamount_');
		claculate_avg();
	}
	function fnc_check_copy_button(type) //Not used
	{
		var copy_val=document.getElementById('copy_val').checked;
		var copy_basis_id=document.getElementById('copy_basis').checked;
		var copy_basis=$('input[name="copy_basis"]:checked').val();
		 // alert(copy_val+'='+copy_basis_id);
		if(copy_basis_id==true && type==1)
		{
			//alert(2);
			 document.getElementById("copy_val").checked = false;
		}
		else if(copy_val==true && type==2)
		{
			 document.getElementById("copy_basis").checked = false;
			 document.getElementById("copy_val").checked = true;
		}
	}
</script>
</head>
<body>
<div align="center" style="width:99%;" >
	<fieldset>
    	<legend><?=$body_part_id.'.'.$body_part[$body_part_id].' Costing '.$costing_per[$cbo_costing_per]; ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<?=create_drop_down( "cbo_string_search_type", 150, $string_search_type,'', 1, "-- Searching Type --" ); ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <b>Copy</b> : <input type="radio" name="copy_basis"   id="copy_basis"  value="on" > <b>No Copy: </b>
            <input type="radio" id="copy_basis"  name="copy_basis" value="0" checked /> <b>Copy to all</b> :
            
            <input type="radio" name="copy_basis"  id="copy_basis" value="1">Size Wise
            <input type="radio" name="copy_basis"  id="copy_basis" value="2">Color Wise
            <input type="radio" name="copy_basis"  id="copy_basis" value="3">Po Wise
            <input type="reset" value="Reset">
        </legend>
        <form id="consumptionform_1" autocomplete="off">
            <input type="hidden" id="cbo_company_id" name="cbo_company_id" value="<? echo $cbo_company_id; ?>"/>
            <input type="hidden" id="cbo_costing_per_id" name="cbo_costing_per_id" value="<? echo $cbo_costing_per; ?>"/>
            <input type="hidden" id="hid_fab_cons_in_quotation_variable" name="hid_fab_cons_in_quotation_variable" value="<? echo $hid_fab_cons_in_quotation_variable; ?>" width="500" />
            <input type="hidden" id="body_part_id" name="body_part_id" value="<? echo $body_part_id; ?>"/>
            <input type="hidden" id="cbofabricnature_id" name="cbofabricnature_id" value="<? echo $cbofabricnature_id; ?>"/>
            <input type="hidden" id="cbofabricsource_id" name="cbofabricsource_id" value="<? echo $cbofabricsource; ?>"/>
            <input type="hidden" id="cons_breck_down" name="cons_breck_down"  width="500"  value="<? echo $cons_breck_downn;?>"/>
            <input type="hidden" id="msmnt_breack_down" name="msmnt_breack_down"  value="<? echo $msmnt_breack_downn;?>"/>
            <input type="hidden" id="marker_breack_down" name="marker_breack_down"  value="<? echo $marker_breack_down;?>"/>
            <input type="hidden" id="txt_gsm" name="txt_gsm" value="<? echo $txtgsmweight; ?>"/>
			<?
			//$approved=return_field_value("approved", "wo_pre_cost_mst", "job_no='$txt_job_no'");
			$component_approved=0;
			$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=1 and job_no='$txt_job_no'");
			foreach($sql as $row){
				if($row[csf('approved')]==1) { $component_approved=1; }
			}
			$arr_bo_app_po=array();
			$sql_bo_app_po=sql_select("select a.is_approved, b.pre_cost_fabric_cost_dtls_id, b.po_break_down_id from wo_booking_mst a, wo_booking_dtls b where  a.booking_no=b.booking_no and  b.job_no='$txt_job_no' and a.booking_type=1 and a.is_short=2 and a.is_approved=1  and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 group by b.pre_cost_fabric_cost_dtls_id,a.is_approved,b.po_break_down_id");
			foreach($sql_bo_app_po as $row_bo_app_po)
			{
				$arr_bo_app_po[$row_bo_app_po[csf('po_break_down_id')]][$row_bo_app_po[csf('pre_cost_fabric_cost_dtls_id')]]	=$row_bo_app_po[csf('is_approved')];
			}

			$pcs_value=0;
			$set_item_ratio=return_field_value("set_item_ratio", "wo_po_details_mas_set_details", "job_no='$txt_job_no'  and gmts_item_id='$cbogmtsitem'");
			if($set_item_ratio==0 || $set_item_ratio=="") $set_item_ratio=1;

			if($cbo_costing_per==1) $pcs_value=1*12*$set_item_ratio;
			else if($cbo_costing_per==2) $pcs_value=1*1*$set_item_ratio;
			else if($cbo_costing_per==3) $pcs_value=2*12*$set_item_ratio;
			else if($cbo_costing_per==4) $pcs_value=3*12*$set_item_ratio;
			else if($cbo_costing_per==5) $pcs_value=4*12*$set_item_ratio;
			
			if($body_part_id==3) $pcs_value=$pcs_value*2;

			$tot_plancut_qty=0; $job_plancut_qty=0;
			$data_array_tot_po_qty=sql_select("SELECT b.id, b.po_number, b.po_quantity, b.shipment_date, min(c.id) as color_size_table_id, min(color_order) as color_order, min(size_order) as size_order, c.color_number_id, c.size_number_id, sum(c.plan_cut_qnty) as plan_cut_qnty, sum(c.order_quantity) as order_quantity from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and b.job_no_mst='$txt_job_no' and c.item_number_id='$cbogmtsitem' and a.garments_nature='$garments_nature' and a.status_active=1 and b.status_active=1 and c.status_active=1 and c.is_deleted=0 group by b.id, b.po_number, b.po_quantity, b.shipment_date, c.color_number_id, c.size_number_id order by b.id, color_order, size_order");
			foreach($data_array_tot_po_qty as $rowpo)
			{
				if($budgeton==1)
				{
					$tot_plancut_qty+=$rowpo[csf('order_quantity')];
					$job_plancut_qty+=$rowpo[csf('order_quantity')];
				}
				else
				{
					$tot_plancut_qty+=$rowpo[csf('plan_cut_qnty')];
					$job_plancut_qty+=$rowpo[csf('plan_cut_qnty')];
				}
				$po_no_library[$rowpo[csf('id')]]=$rowpo[csf('po_number')];
			}
			unset($data_array_tot_po_qty);


			$process_loss_method=return_field_value("process_loss_method", "variable_order_tracking", "company_name=$cbo_company_id  and variable_list=18 and item_category_id=$cbofabricnature_id and status_active=1 and is_deleted=0");
            ?>
           <input type="hidden" id="process_loss_method_id" name="process_loss_method_id" value="<? echo $process_loss_method; ?>"/>
           <input type="hidden" id="tot_plancut_qty" name="tot_plancut_qty" value="<? echo $tot_plancut_qty; ?>"/>
           <input type="hidden" id="job_plancut_qty" name="job_plancut_qty" value="<? echo $job_plancut_qty; ?>"/>
           <input type="hidden" id="item_ratio" name="item_ratio" value="<? echo $set_item_ratio; ?>"/>
           <? //echo $hid_fab_cons_in_quotation_variable;
		   if($hid_fab_cons_in_quotation_variable==3){
		   ?>
	          <table width="800" cellspacing="0" class="rpt_table" border="0" id="tbl_marker_cost" rules="all">
	              <thead>
	                    <tr>
	                        <th  width="100"  rowspan="2">Marker Dia (Inch)</th><th  width="100" colspan="2">Marker Length</th><th  width="110"  rowspan="2">Gmts. Size Ratio (Pcs)</th><th width="90"  rowspan="2">Marker Length -Yds (1Dzn Gmts)</th><th width="110"  rowspan="2">GSM</th><th width="110"  rowspan="2">Net Fab Cons</th><th></th>
	                    </tr>
	                    <tr>
	                        <th  width="100">Yds</th><th width="100">Inch</th><th></th>
	                    </tr>
	              </thead>
	              <tbody>
	              <?
				  $marker_breack_down_arr=explode("_",$marker_breack_down);
				  ?>
	              <tr>
	              <td><input type="text" id="txt_marker_dia"  name="txt_marker_dia" class="text_boxes_numeric" style="width:90px" onChange="calculate_marker_length()"  value="<? echo $marker_breack_down_arr[0];  ?>"> </td>
	              <td><input type="text" id="txt_marker_yds"  name="txt_marker_yds" class="text_boxes_numeric" style="width:90px"  onChange="calculate_marker_length()" value="<? echo $marker_breack_down_arr[1];  ?>"></td>
	              <td><input type="text" id="txt_marker_inch"  name="txt_marker_inch" class="text_boxes_numeric" style="width:90px" onChange="calculate_marker_length()"  value="<? echo $marker_breack_down_arr[2];  ?>"></td>
	              <td><input type="text" id="txt_gmt_pcs"  name="txt_gmt_pcs" class="text_boxes_numeric" style="width:110px" onChange="calculate_marker_length()"  value="<? echo $marker_breack_down_arr[3];  ?>"></td>
	              <td><input type="text" id="txt_marker_length_yds"  name="txt_marker_length_yds" class="text_boxes_numeric" style="width:110px" readonly  value="<? echo $marker_breack_down_arr[4];  ?>"></td>
	              <td><input type="text" id="txt_marker_gsm"  name="txt_marker_gsm" class="text_boxes_numeric" readonly style="width:110px"  value="<? echo $txtgsmweight; ?>"></td>
	              <td><input type="text" id="txt_marker_net_fab_cons"  name="txt_marker_net_fab_cons" class="text_boxes_numeric" style="width:110px"  value="<? echo $marker_breack_down_arr[5];  ?>"></td>
	              <td></td>
	              </tr>
	              </tbody>
	          </table>
           <?
		   }
		   ?>
           <br/>
            <table width="1200" cellspacing="0" class="rpt_table" border="0" id="tbl_consmption_cost" rules="all">
                <thead style="position: sticky;position: -webkit-sticky;top: 0;z-index: 999;">
                    <tr>
                        <th width="30">SL</th>
                        <th width="120">PO NO</th>
                        <th width="90">Color</th>
                        <th width="60">Gmts. Size</th>
                        <th width="70" style="color:#2A3FFF"><? if($cbofabricnature_id==2){ echo "Dia"; }else{ echo "Width";}?></th>
                        <th width="60">Cutable Width</th>
                        <th width="70" style="color:#2A3FFF">Finish Cons <?="[". $unit_of_measurement[$uom]."]"; ?></th>
                        <th width="60">Wast. %</th>
                        <th width="70" style="color:#2A3FFF">Final Cons <?="[". $unit_of_measurement[$uom]."]"; ?></th>
                        <th width="60">Rate</th>
                        <th width="60">Fina. Char</th>
                        <th width="80">Amount</th>
                        <th width="50">Pcs</th>
                        <th width="80">Total Fabric Qty</th>
                        <th width="80">Total Amount</th>
                        <th>Remarks</th>
                    </tr>
                </thead>
                <tbody>
				<?
				$color_library=return_library_array("select id,color_name from lib_color where status_active=1 and is_deleted=0","id","color_name");
				$size_library=return_library_array("select id,size_name from lib_size where status_active=1 and is_deleted=0","id","size_name");
				//echo $cons_breck_downn;
                //$po_no_library=return_library_array( "select id,po_number from wo_po_break_down where job_no_mst ='$txt_job_no'", "id", "po_number");
                $data_array=explode("__",$cons_breck_downn);
                if($data_array[0]=="")
                {
                    $data_array=array();
                }
				//echo $cost_control_source.'='.$pre_cost_fabric_cost_dtls_id.'='.$pri_fab_cost_dtls_id;
				if($cost_control_source==2 && $pre_cost_fabric_cost_dtls_id=="")//Price Quotation
				{
					if($pri_fab_cost_dtls_id!="")
					{
						$sql_price_quatation=sql_select("select gmts_sizes, dia_width, cons, process_loss_percent, requirment, rate, amount from  wo_pri_quo_fab_co_avg_con_dtls where wo_pri_quo_fab_co_dtls_id=$pri_fab_cost_dtls_id");
						
						foreach($sql_price_quatation as $row)
						{
							$price_quatation_dia[$row[csf('gmts_sizes')]]=$row[csf('dia_width')];
							$price_quatation_cons[$row[csf('gmts_sizes')]]=$row[csf('cons')];
							$price_quatation_cons_process_loss[$row[csf('gmts_sizes')]]=$row[csf('process_loss_percent')];
							$price_quatation_requirment[$row[csf('gmts_sizes')]]=$row[csf('requirment')];
							$price_quatation_rate[$row[csf('gmts_sizes')]]=$row[csf('rate')];
							$price_quatation_amount[$row[csf('gmts_sizes')]]=$row[csf('amount')];
						}
						unset($sql_price_quatation);
					}
				}
				else if($cost_control_source==4 && $pri_fab_cost_dtls_id!="" && $pre_cost_fabric_cost_dtls_id=="")//Quick Costing [WVN] 
				{
					$qcConsRateArr=array();
					if($pri_fab_cost_dtls_id!="")
					{
						$sqlQc=sql_select("select consumption, ex_percent, tot_cons, rate, fc_per, value from qc_cons_rate_dtls where id=$pri_fab_cost_dtls_id");
						//echo "select consumption, ex_percent, tot_cons, rate, value from qc_cons_rate_dtls where id=$pri_fab_cost_dtls_id";
						foreach($sqlQc as $row)
						{
							$qcConsRateArr['cons']=$row[csf('consumption')];
							$qcConsRateArr['ex_percent']=$row[csf('ex_percent')];
							$qcConsRateArr['tot_cons']=$row[csf('tot_cons')];
							$qcConsRateArr['rate']=$row[csf('rate')];
							$qcConsRateArr['fc_per']=$row[csf('fc_per')];
							$qcConsRateArr['value']=$row[csf('value')];
						}
						unset($sqlQc);
					}
				}
				
                //Oracle
                $data_array=sql_select("SELECT b.id, b.po_number, b.po_quantity, b.shipment_date, min(c.id) as color_size_table_id, min(color_order) as color_order, min(size_order) as size_order, c.color_number_id, c.size_number_id, sum(c.plan_cut_qnty) as plan_cut_qnty, sum(c.order_quantity) as order_quantity from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and b.job_no_mst='$txt_job_no' and c.item_number_id='$cbogmtsitem' and a.garments_nature='$garments_nature' and a.status_active=1 and b.status_active=1 and c.status_active=1  and c.is_deleted=0 group by b.id, b.po_number, b.po_quantity, b.shipment_date, c.color_number_id, c.size_number_id order by b.id, color_order, size_order");
                //=======================================
             
				if($pre_cost_fabric_cost_dtls_id != "")
                {
                    $data_arr=sql_select("select pre_cost_fabric_cost_dtls_id, po_break_down_id,gmts_color_id from wo_booking_dtls where job_no ='$txt_job_no' and pre_cost_fabric_cost_dtls_id='$pre_cost_fabric_cost_dtls_id' and booking_type='1' and status_active=1 and is_deleted=0 group by pre_cost_fabric_cost_dtls_id,po_break_down_id,gmts_color_id");
                    if(count($data_arr) > 0){
                        foreach ($data_arr as  $value) {
                            $is_booking[$value[csf('po_break_down_id')]][$value[csf('gmts_color_id')]] = $value[csf('po_break_down_id')];
                        }
                        unset($data_arr);
                    }
                    
                    $wo_pre_cos_fab_co_avg_con_dtls_data=sql_select("select  id, po_break_down_id, color_number_id, gmts_sizes, dia_width, item_size, cons, process_loss_percent, requirment, pcs, color_size_table_id, rate, amount, remarks,fina_char from wo_pre_cos_fab_co_avg_con_dtls where job_no='$txt_job_no' and pre_cost_fabric_cost_dtls_id=$pre_cost_fabric_cost_dtls_id order by id");
					//echo "select  id, po_break_down_id, color_number_id, gmts_sizes, dia_width, item_size, cons, process_loss_percent, requirment, pcs, color_size_table_id, rate, amount, remarks,fina_char from wo_pre_cos_fab_co_avg_con_dtls where job_no='$txt_job_no' and pre_cost_fabric_cost_dtls_id=$pre_cost_fabric_cost_dtls_id order by id";
					$colorWiseDataArr=array();
					
                    foreach($wo_pre_cos_fab_co_avg_con_dtls_data as $pre_avg_row)
                    {
                        $data_array_cons[$pre_avg_row[csf('color_size_table_id')]]=$pre_avg_row[csf('po_break_down_id')]."_".$pre_avg_row[csf('color_number_id')]."_".$pre_avg_row[csf('gmts_sizes')]."_".$pre_avg_row[csf('dia_width')]."_".$pre_avg_row[csf('item_size')]."_".$pre_avg_row[csf('cons')]."_".$pre_avg_row[csf('process_loss_percent')]."_".$pre_avg_row[csf('requirment')]."_".$pre_avg_row[csf('pcs')]."_".$pre_avg_row[csf('color_size_table_id')]."_".$pre_avg_row[csf('rate')]."_".$pre_avg_row[csf('amount')]."_".$pre_avg_row[csf('remarks')]."_".$pre_avg_row[csf('fina_char')];
						
						$colorWiseDataArr[$pre_avg_row[csf('color_number_id')]]['copyConsdata']=$pre_avg_row[csf('cons')]."_".$pre_avg_row[csf('process_loss_percent')]."_".$pre_avg_row[csf('requirment')]."_".$pre_avg_row[csf('rate')]."_".$pre_avg_row[csf('amount')]."_".$pre_avg_row[csf('fina_char')]."_".$pre_avg_row[csf('dia_width')]."_".$pre_avg_row[csf('item_size')];
                    }
                    unset($wo_pre_cos_fab_co_avg_con_dtls_data);
                }
                if($pre_cost_fabric_cost_dtls_id== "")
                {
                    $data_array_cons=explode("__",$cons_breck_downn);
                }
				//=======================================
				if ( count($data_array)>0)
				{
					$i=0;
					foreach( $data_array as $row )
					{
						$cons_up=0;
						if($pre_cost_fabric_cost_dtls_id != "") $data=explode('_',$data_array_cons[$row[csf('color_size_table_id')]]); 
						else $data=explode('_',$data_array_cons[$i]);
						if($precostapproved==1 || $arr_bo_app_po[$row[csf('id')]][$pre_cost_fabric_cost_dtls_id]==1 || $component_approved==1 || count($is_booking[$row[csf('id')]][$row[csf('color_number_id')]])>0)
						{
							$disabled=1; if(count($is_booking[$row[csf('id')]])>0) $cons_up=1;
						}
						else $disabled=0;
						//echo $pre_cost_fabric_cost_dtls_id;
						if($cost_control_source==2 && $pre_cost_fabric_cost_dtls_id=="")//Price Quotation
						{
							if ($data[5]==""){
								if($price_quatation_cons[$row[csf('size_number_id')]] != '') $cons_value =  $price_quatation_cons[$row[csf('size_number_id')]];
								else $cons_value = 0;
							}
							else $cons_value = $data[5];
							
							if ($data[6]=="")
							{
								if($price_quatation_cons_process_loss[$row[csf('size_number_id')]] !='') $processloss_value = $price_quatation_cons_process_loss[$row[csf('size_number_id')]];
								else $processloss_value = 0;
							}
							else{
								$processloss_value = $data[6];
							}
							
							if ($data[7]=="")
							{
								if($price_quatation_requirment[$row[csf('size_number_id')]] != '') $data[7]= $price_quatation_requirment[$row[csf('size_number_id')]];
								else $data[7]=0;
							}
							
							if ($data[10]=="" || $data[10]==0)
							{
								if($price_quatation_rate[$row[csf('size_number_id')]]!='') $data[10]=$price_quatation_rate[$row[csf('size_number_id')]];
							}
							//echo "A";
						}
						else if($cost_control_source==4 && $pre_cost_fabric_cost_dtls_id=="")//Quick Costing [WVN]--ISD-21-33976
						{
							if ($data[5]==""){ $cons_value=$qcConsRateArr['cons']; }
							if ($data[6]=="") $processloss_value = $qcConsRateArr['ex_percent'];
							if ($data[7]=="") $data[7]= $qcConsRateArr['tot_cons'];
							if ($data[10]=="" || $data[10]==0) $data[10]=$qcConsRateArr['rate'];
							if ($data[13]=="" || $data[13]==0) $data[13]=$qcConsRateArr['fc_per'];
							if ($data[11]=="" || $data[11]==0) $data[11]=$qcConsRateArr['value'];
							//echo "B";
						}
						else if($cost_control_source==4 || $cost_control_source==3 || $data[5]==0 || $data[5]=="" )//Color Wise Copy
						{
							$cons_value=0;	$processloss_value=0;
							if($pre_cost_fabric_cost_dtls_id!="" && $data[9]=="")//Color Wise Copy
							{
								$excopyConsdata=explode("_",$colorWiseDataArr[$row[csf('color_number_id')]]['copyConsdata']);
								if ($data[3]=="" || $data[3]==0){ $data[3]=$excopyConsdata[6]; }
								if ($data[4]=="" || $data[4]==0){ $data[4]=$excopyConsdata[7]; }
								if ($data[5]=="" || $data[5]==0){ $cons_value=$excopyConsdata[0]; } else $cons_value=$data[5];
								if ($data[6]=="" || $data[6]==0) $processloss_value = $excopyConsdata[1]; else $processloss_value = $data[6];
								if ($data[7]=="" || $data[7]==0) $data[7]=$excopyConsdata[2];
								if ($data[10]=="" || $data[10]==0) $data[10]=$excopyConsdata[3];
								if ($data[13]=="" || $data[13]==0) $data[13]=$excopyConsdata[5];
								if ($data[11]=="" || $data[11]==0) $data[11]=$excopyConsdata[4];
							}
							else
							{
								$cons_value=0; $processloss_value=0;
								$cons_value= $data[5];
								//$cons_value = $data[5];
								$processloss_value = $data[6];
								$data[7] = $data[7];
							}
						}
						else 
						{
							$cons_value= $data[5];
							//$cons_value = $data[5];
							$processloss_value = $data[6];
							$data[7] = $data[7];
								//echo $cons_value.'='.$data[7];
							/*$cons_value = $data[5];
							$processloss_value = $data[6];
							$data[7] = $data[7];*/
							//echo "A";
						}
						// echo $data[7].'-bbb-'.$pcs_value.'-bbb-'.$row[csf('order_quantity')];die;
						$i++;
						
						$planPoQty=0;
							
						if($budgeton==1) $planPoQty=$row[csf('order_quantity')]; else $planPoQty=$row[csf('plan_cut_qnty')];
						
						$RowtotReq=0; $RowtotAmt=0;
						
						$RowtotReq=number_format(($data[7]/$pcs_value)*$planPoQty,4,".","");						
						$totReq+=$RowtotReq;
						$RowtotAmt=number_format($RowtotReq*$data[10],4,".","");
						$totAmt+=$RowtotAmt;
						//$hid_fab_cons_in_quotation_variable==$hid_fab_cons_in_quotation_variable=2;
						//echo $hid_fab_cons_in_quotation_variable.'='.$hid_fab_cons_in_quotation_variable.'='.$body_part_id.'='.$cons_value.',';
						?>
						<tr id="break_<?=$i;?>" align="center">
							<td><?=$i; ?></td>
							<td>
								<input type="text" id="pono_<? echo $i;?>"  name="pono_<? echo $i;?>" class="text_boxes" style="width:108px" value="<? echo $row[csf('po_number')]; ?>" readonly />
								<input type="hidden" id="ponoid_<? echo $i;?>"  name="ponoid_<? echo $i;?>" class="text_boxes" style="width:85px" value="<? echo $row[csf('id')]; ?>" readonly />
							</td>
							<td title="Color Id=<? echo $row[csf('color_number_id')];?>">
								<input type="text" id="pocolor_<? echo $i;?>"  name="pocolor_<? echo $i;?>" class="text_boxes" style="width:78px" value="<? echo $color_library[$row[csf('color_number_id')]]; ?>" readonly />
								<input type="hidden" id="pocolorid_<? echo $i;?>"  name="pocolorid_<? echo $i;?>" class="text_boxes" style="width:75px" value="<?=$row[csf('color_number_id')]; ?>" readonly/>
							</td>
							<td>
								<input type="text" id="gmtssizes_<? echo $i;?>"  name="gmtssizes_<? echo $i;?>" class="text_boxes" style="width:48px" value="<? echo $size_library[$row[csf('size_number_id')]]; ?>" readonly>
								<input type="hidden" id="gmtssizesid_<? echo $i;?>"  name="gmtssizesid_<? echo $i;?>" class="text_boxes" style="width:45px" value="<? echo $row[csf('size_number_id')]; ?>" readonly />
							</td>
							<td>
								<? if($data[3]==""){
									if($price_quatation_dia[$row[csf('size_number_id')]] != '') $diawidth_value = $price_quatation_dia[$row[csf('size_number_id')]];
									else $diawidth_value = ( $fabric_width != '') ?  $fabric_width : 0;

								} else $diawidth_value = $data[3]?>
								<input type="text" id="diawidth_<?=$i; ?>"  value="<? echo $diawidth_value ?>"  name="diawidth_<? echo $i;?>"  class="<? if($cbofabricnature_id==2){echo "text_boxes"; }else{ echo "text_boxes_numeric";}?>" style="width:58px" onChange="<? if($hid_fab_cons_in_quotation_variable==2){ echo "calculate_measurement_top( $i)";} ?>;copy_value(this.value,'diawidth_',<? echo $i;?>)" <? if($disabled==1){ echo "disabled";} else{ echo "";} ?> />
							</td>
							<td>
								<?
									if($data[4] !='') $cutable_width = $data[4];
									else $cutable_width = $fabric_cwidth;
								?>
								<input type="text" id="itemsizes_<? echo $i;?>"  name="itemsizes_<? echo $i;?>" class="text_boxes" style="width:48px" onChange="copy_value(this.value,'itemsizes_',<? echo $i;?>)" value="<? echo $cutable_width; ?>" <? if($disabled==1){ echo "disabled";} else{ echo "";} ?> >
							</td>
							<td>
								<input type="text" id="cons_<?=$i;?>" onBlur="set_sum_value( 'cons_sum', 'cons_' ); set_sum_value( 'totReq_sum', 'totqty_'); set_sum_value( 'totAmount_sum', 'totamount_');" onChange="set_sum_value( 'cons_sum', 'cons_' ); set_sum_value( 'requirement_sum', 'requirement_' ); calculate_requirement(<?=$i; ?>); copy_value(this.value,'cons_',<?=$i; ?>)" name="cons_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" <? if(($hid_fab_cons_in_quotation_variable==2 || $hid_fab_cons_in_quotation_variable==3) && ($body_part_id==1 || $body_part_id==20)){ echo "readonly";} else{ echo "";} ?> value="<?=$cons_value ?>" <? if($cons_up==1 || $disabled==1) { echo "disabled";} else{ echo "";} ?> />
							</td>
							<td>
								<input type="text" id="processloss_<? echo $i;?>" onBlur="set_sum_value( 'processloss_sum', 'processloss_' ) "  name="processloss_<? echo $i;?>" class="text_boxes_numeric" style="width:48px" onChange="calculate_requirement(<? echo $i;?>);set_sum_value( 'processloss_sum', 'processloss_' );set_sum_value( 'requirement_sum', 'requirement_' );copy_value(this.value,'processloss_',<? echo $i;?>) " value="<? echo $processloss_value ?>" <? if($disabled==1){ echo "disabled";} else{ echo "";} ?> />
							</td>
							<td>
								<input type="text" id="requirement_<?=$i;?>" onBlur="set_sum_value( 'requirement_sum', 'requirement_');" onChange="set_sum_value('requirement_sum', 'requirement_');" name="requirement_<?=$i;?>" class="text_boxes_numeric" style="width:58px" value="<?=$data[7]; ?>" readonly />
							</td>
							<td>
								<input type="text" id="rate_<?=$i;?>" name="rate_<?=$i;?>" onChange="claculate_amount(<?=$i;?>); copy_value(this.value,'rate_',<?=$i; ?>)" onBlur="set_sum_value( 'rate_sum', 'rate_');" class="text_boxes_numeric" style="width:48px" value="<?=$data[10]; ?>" <? if($cons_up==1 || $disabled==1) { echo "disabled";} else{ echo "";}  ?> />
							</td>
							<td><input type="text" id="finachar_<?=$i;?>"  name="finachar_<?=$i;?>" onChange="claculate_amount(<?=$i;?>);copy_value(this.value,'finachar_',<?=$i;?>)" onBlur="set_sum_value( 'finachar_sum', 'finachar_');" class="text_boxes_numeric" style="width:48px"  value="<?=$data[13]; ?>" <? if($cons_up==1 || $disabled==1) { echo "disabled";} else{ echo "";}  ?> />
							</td>                                    
							<td><input type="text" id="amount_<?=$i;?>"  name="amount_<?=$i;?>" class="text_boxes_numeric" style="width:68px"  value="<? if($data[11]==""){echo $price_quatation_amount[$row[csf('size_number_id')]];} else { echo $data[11];} ?>" readonly />
							</td>
							<td>
								<input type="text" id="pcs_<? echo $i;?>"  name="pcs_<? echo $i;?>"  onBlur="set_sum_value( 'pcs_sum', 'pcs_' ) " class="text_boxes_numeric" style="width:38px"  value="<? echo $pcs_value; ?>" readonly>
								<input type="hidden" id="pcsgmts_<? echo $i;?>"  name="pcsgmts_<? echo $i;?>"  onBlur="set_sum_value( 'pcs_sum', 'pcs_' ) " class="text_boxes_numeric" style="width:35px"  value="<? echo $planPoQty; ?>">
							</td>
							<td><input type="text" id="totqty_<?=$i;?>" name="totqty_<?=$i;?>" class="text_boxes_numeric" style="width:68px" value="<?=$RowtotReq; ?>" readonly /></td>
							<td><input type="text" id="totamount_<?=$i;?>" name="totamount_<?=$i;?>" class="text_boxes_numeric" style="width:68px" value="<?=$RowtotAmt; ?>" readonly /></td>
							<td>
                                <input type="text" id="remarks_<?=$i;?>" name="remarks_<?=$i;?>" onChange="copy_value(this.value,'remarks_',<?=$i;?>);" class="text_boxes" style="width:88px" value="<?=$data[12]; ?>" <? if($disabled==1){ echo "readonly";} else{ echo "";} ?> >
                                <input type="hidden" id="colorsizetableid_<? echo $i;?>"  name="colorsizetableid_<? echo $i;?>" class="text_boxes" style="width:25px" value="<? echo $row[csf('color_size_table_id')]; ?>" readonly/>
								<input type="hidden" id="decreaserow_<? echo $i;?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_delete_down_tr(<? echo $i;?>,'tbl_consmption_cost');" disabled/>
								<input type="hidden" id="approved_<? echo $i;?>"  name="approved_<? echo $i;?>"  class="text_boxes_numeric" style="width:25px"  value="<? echo $disabled; ?>">
							</td>
						</tr>
					<?
					}
				}
			?>
                </tbody>
            </table>
            <table width="1200" cellspacing="0" class="rpt_table" border="0" rules="all">
                <tfoot>
                    	<tr>
                        	<th width="30">&nbsp;</th>
                            <th width="120">&nbsp;</th>
                            <th width="90">&nbsp;</th>
                            <th width="60">&nbsp;</th>
                            <th width="70">&nbsp;</th>
                        	<th width="60">SUM:</th>
                            <th width="70"><input type="text" id="cons_sum" name="cons_sum" class="text_boxes_numeric" style="width:58px" readonly></th>
                            <th width="60"><input type="text" id="processloss_sum" name="processloss_sum" class="text_boxes_numeric" style="width:48px" readonly></th>
                            <th width="70"><input type="text" id="requirement_sum" name="requirement_sum" class="text_boxes_numeric" style="width:58px" readonly></th>
                            <th width="60"><input type="text" id="rate_sum" name="rate_sum" class="text_boxes_numeric" style="width:48px" readonly></th>
                            <th width="60"><input type="text" id="finachar_sum" name="finachar_sum" class="text_boxes_numeric" style="width:48px" readonly></th>
                            <th width="80"><input type="text" id="amount_sum" name="amount_sum" class="text_boxes_numeric" style="width:68px" readonly></th>
                            <th width="50">
                            <input type="text" id="pcs_sum"    name="pcs_sum" class="text_boxes_numeric" style="width:38px" readonly>
                            <input type="hidden" id="plancutqty_sum"    name="plancutqty_sum" class="text_boxes_numeric" style="width:25px" readonly>
                            </th>
                            <th width="80"><input type="text" id="totReq_sum" name="totReq_sum" class="text_boxes_numeric" style="width:68px" readonly></th>
                            <th width="80"><input type="text" id="totAmount_sum" name="totAmount_sum" class="text_boxes_numeric" style="width:68px" readonly></th>
                            <th width="100">&nbsp;</th>
                            <th>&nbsp;</th>
                        </tr>
                        <tr>
                        	<th width="30">&nbsp;</th>
                            <th width="120">&nbsp;</th>
                            <th width="90">&nbsp;</th>
                            <th width="60">&nbsp;</th>
                            <th width="70">&nbsp;</th>
                        	<th width="60">AVG:</th>
                            <th width="70"><input type="text" id="avg_cons" name="avg_cons" class="text_boxes_numeric" style="width:58px" value="" readonly></th>
                            <th width="60"><input type="text" id="calculated_procloss"  name="calculated_procloss" class="text_boxes_numeric" style="width:48px" readonly></th>
                           	<th width="70"><input type="text" id="calculated_cons" name="calculated_cons" class="text_boxes_numeric" style="width:58px" value="<? echo $calculated_conss;?>" readonly></th>
                            <th width="60"><input type="text" id="calculated_rate"   name="calculated_rate" class="text_boxes_numeric" style="width:48px" readonly></th>
                            <th width="60"><input type="text" id="calculated_finachar"   name="calculated_finachar" class="text_boxes_numeric" style="width:48px" readonly></th>
                            <th width="80"><input type="text" id="calculated_amount" name="calculated_amount" class="text_boxes_numeric" style="width:68px" readonly></th>
                            <th width="50">
                                <input type="text" id="calculated_pcs"    name="calculated_pcs" class="text_boxes_numeric" style="width:38px" readonly>
                                <input type="hidden" id="calculated_plancutqty"    name="calculated_plancutqty" class="text_boxes_numeric" style="width:25px" readonly>
                            </th>
                            <th width="80"><input type="text" id="AtotReq_sum" name="AtotReq_sum" class="text_boxes_numeric" style="width:68px" readonly></th>
                            <th width="80"><input type="text" id="AtotAmount_sum" name="AtotAmount_sum" class="text_boxes_numeric" style="width:68px" readonly></th>
                            <th width="100">&nbsp;</th>
                            <th>&nbsp;</th>
                        </tr>
                    </tfoot>
                </table>
				<script>
                set_sum_value( 'cons_sum', 'cons_'  );
                set_sum_value( 'processloss_sum', 'processloss_'  );
                set_sum_value( 'requirement_sum', 'requirement_');
                set_sum_value( 'pcs_sum', 'pcs_');
				set_sum_value( 'rate_sum', 'rate_');
				set_sum_value( 'finachar_sum', 'finachar_');
				set_sum_value( 'amount_sum', 'amount_');
				set_sum_value( 'totReq_sum', 'totqty_');
				set_sum_value( 'totAmount_sum', 'totamount_');
                </script>
            </form>
        </fieldset>
   </div>
<?
if ($hid_fab_cons_in_quotation_variable==2)
{
	if ($body_part_id==1)
    {
	?>
        <div align="center" style="width:100%;" >
        <fieldset>
        	<form id="fabriccost_3" autocomplete="off">
            	<table width="810" cellspacing="0" class="rpt_table" border="0" id="tbl_msmnt_cost" rules="all">
                	<thead>
                        <tr>
                        	<th  colspan="3">Body</th><th colspan="3">Sleeve </th><th colspan="2">1/2 Chest</th><th width="">Total</th>
                        </tr>
                    	<tr>
                        	<th width="80">Length</th><th  width="80">Sewing Margin</th><th  width="80">Hem Margin</th><th width="80"> Length</th><th width="80">Sewing Margin</th><th width="80">Hem Margin</th><th width="80">Length</th><th width="80">Sewing Margin</th> <th width="">Total</th>

                        </tr>
                    </thead>
                    <tbody>
                    <?
					$data_array_msn=explode('__',$msmnt_breack_downn);
					if($cbo_approved_status!=1) $cbo_approved_status=$component_approved;

				//Oracle
				$data_array=sql_select("select b.id, b.po_number,b.po_quantity,b.shipment_date,c.color_number_id,c.size_number_id,min(c.id) as color_size_table_id,min(color_order) as color_order,min(size_order) as size_order from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id   and b.job_no_mst='$txt_job_no' and c.item_number_id='$cbogmtsitem'   and a.garments_nature='$garments_nature' and a.status_active=1 and b.status_active=1 and c.status_active=1 group by b.id, b.po_number,b.po_quantity,b.shipment_date,c.color_number_id,c.size_number_id  order by b.id");

					if (count($data_array)>0)
					{
						$i=0;
						foreach( $data_array as $row )
						{
							$data=explode('_',$data_array_msn[$i]);
							$i++;
							?>
                            	<tr id="break_1" align="center">
                                    <td>
                                    <input type="text" id="bodylength_<? echo $i;?>"  name="bodylength_<? echo $i;?>" class="text_boxes_numeric" style="width:65px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'bodylength_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[0]; ?>"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> />
                                    </td>
                                    <td>
                                    <input type="text" id="bodysewingmargin_<? echo $i;?>"    name="bodysewingmargin_<? echo $i;?>"  class="text_boxes_numeric" style="width:65px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'bodysewingmargin_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[1]; ?>"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>/>
                                    </td>
                                    <td>
                                    <input type="text" id="bodyhemmargin_<? echo $i;?>" name="bodyhemmargin_<? echo $i;?>" class="text_boxes_numeric" style="width:65px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'bodyhemmargin_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value=" <? echo $data[2]; ?> "  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>/>
                                    </td>
                                    <td>
                                    <input type="text" id="sleevelength_<? echo $i;?>"  name="sleevelength_<? echo $i;?>" class="text_boxes_numeric" style="width:65px"  onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'sleevelength_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[3]; ?>"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>/>
                                    </td>
                                    <td>
                                    <input type="text" id="sleevesewingmargin_<? echo $i;?>"  name="sleevesewingmargin_<? echo $i;?>" class="text_boxes_numeric" style="width:65px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'sleevesewingmargin_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[4]; ?>"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> />
                                    </td>
                                    <td>
                                    <input type="text" id="sleevehemmargin_<? echo $i;?>"  name="sleevehemmargin_<? echo $i;?>" class="text_boxes_numeric" style="width:65px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'sleevehemmargin_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[5]; ?>"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> />
                                    </td>
                                    <td>
                                    <input type="text" id="chestlenght_<? echo $i;?>"  name="chestlenght_<? echo $i;?>" class="text_boxes_numeric" style="width:65px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'chestlenght_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[6]; ?>"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> />
                                    </td>
                                    <td>
                                    <input type="text" id="chestsewingmargin_<? echo $i;?>"  name="chestsewingmargin_<? echo $i;?>" class="text_boxes_numeric" style="width:65px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'chestsewingmargin_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[7]; ?>"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> />
                                    </td>
                                    <td>
                                    <input type="text" id="totalcons_<? echo $i;?>"  name="totalcons_<? echo $i;?>" class="text_boxes_numeric" style="width:150px" readonly value="<? echo $data[8]; ?>" />
                                    </td>
                                </tr>
                            <?
						}
					}
					?>
                </tbody>
                </table>
            </form>
        </fieldset>
        </div>
        <?
	}
	if($body_part_id==20)
	{
		?>
		<div align="center" style="width:100%;" >
<fieldset>
        	<form id="fabriccost_3" autocomplete="off">
            	<table width="810" cellspacing="0" class="rpt_table" border="0" id="tbl_msmnt_cost" rules="all">
                	<thead>
                        <tr>
                        	<th  colspan="2">Front Rise</th><th colspan="2">West Band</th><th colspan="3">In Seam</th><th colspan="2"> Half Thai</th><th >Total</th>
                        </tr>
                    	<tr>
                        	<th width="70">Length</th><th  width="70">Sewing Margin</th><th  width="70">Length</th><th width="70"> Sewing Margin</th><th width="70">Length</th><th width="70">Sewing Margin</th><th width="70">Hem Margin</th><th width="70">Length</th> <th width="70">Sewing Margin</th><th width="">Total</th>

                        </tr>
                    </thead>
                    <tbody>
                    <?
					if($cbo_approved_status!=1) $cbo_approved_status=$component_approved;
					$data_array_msn=explode('__',$msmnt_breack_downn);
				//Oracle
					$data_array=sql_select("select b.id, b.po_number,b.po_quantity,b.shipment_date,c.color_number_id,c.size_number_id,min(c.id) as color_size_table_id,min(color_order) as color_order,min(size_order) as size_order from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id   and b.job_no_mst='$txt_job_no' and c.item_number_id='$cbogmtsitem'   and a.garments_nature='$garments_nature' and a.status_active=1 and b.status_active=1 and c.status_active=1 group by b.id, b.po_number,b.po_quantity,b.shipment_date,c.color_number_id,c.size_number_id  order by b.id");
					if (count($data_array)>0)
					{
						$i=0;
						foreach( $data_array as $row )
						{
							$data=explode('_',$data_array_msn[$i]);
							$i++;
							?>
                            	<tr id="break_1" align="center">
                                    <td>
                                    <input type="text" id="frontriselength_<? echo $i;?>"  name="frontriselength_<? echo $i;?>" class="text_boxes_numeric" style="width:55px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'frontriselength_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[0]; ?>"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> />
                                    </td>
                                    <td>
                                    <input type="text" id="frontrisesewingmargin_<? echo $i;?>"    name="frontrisesewingmargin_<? echo $i;?>"  class="text_boxes_numeric" style="width:55px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'frontrisesewingmargin_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[1]; ?>"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> />
                                    </td>
                                    <td>
                                    <input type="text" id="westbandlength_<? echo $i;?>" name="westbandlength_<? echo $i;?>" class="text_boxes_numeric" style="width:55px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'westbandlength_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[2]; ?>"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> />
                                    </td>
                                    <td>
                                    <input type="text" id="westbandsewingmargin_<? echo $i;?>"  name="westbandsewingmargin_<? echo $i;?>" class="text_boxes_numeric" style="width:55px"  onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'westbandsewingmargin_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[3]; ?>"   <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>/ >
                                    </td>
                                    <td>
                                    <input type="text" id="inseamlength_<? echo $i;?>"  name="inseamlength_<? echo $i;?>" class="text_boxes_numeric" style="width:55px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'inseamlength_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[4]; ?>"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> />
                                    </td>
                                    <td>
                                    <input type="text" id="inseamsewingmargin_<? echo $i;?>"  name="inseamsewingmargin_<? echo $i;?>" class="text_boxes_numeric" style="width:55px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'inseamsewingmargin_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[5]; ?>"   <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>/>
                                    </td>
                                    <td>
                                    <input type="text" id="inseamhemmargin_<? echo $i;?>"  name="inseamhemmargin_<? echo $i;?>" class="text_boxes_numeric" style="width:55px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'inseamhemmargin_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[6]; ?>"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> />
                                    </td>
                                    <td>
                                    <input type="text" id="halfthailength_<? echo $i;?>"  name="halfthailength_<? echo $i;?>" class="text_boxes_numeric" style="width:55px" onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'halfthailength_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[7]; ?>"   <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>/>
                                    </td>
                                    <td>
                                    <input type="text" id="halfthaisewingmargin_<? echo $i;?>"  name="halfthaisewingmargin_<? echo $i;?>" class="text_boxes_numeric" style="width:55px"   onChange="calculate_measurement_top(<? echo $i;?>);copy_value(this.value,'halfthaisewingmargin_',<? echo $i;?>)" onClick="check_width_is_null_or_not(<? echo $i;?>)" value="<? echo $data[8]; ?>"   <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>/>
                                    </td>
                                    <td>
                                    <input type="text" id="totalcons_<? echo $i;?>"  name="totalcons_<? echo $i;?>" class="text_boxes_numeric" style="width:55px" readonly value="<? echo $data[9]; ?>">
                                    </td>
                                </tr>
                            <?
						}
					}
					?>
                </tbody>
                </table>
            </form>
        </fieldset>
       </div>
       <?
        }
    }
    ?>
    <div align="center" style="width:100%;" >
    	<fieldset>
            <table width="810" cellspacing="0" class="" border="0" rules="all">
                 <tr>
                    <td align="center" width="100%" class="button_container"> <input type="button" class="formbutton" value="Close" onClick="js_set_value();"/> </td>
                </tr>
            </table>
        </fieldset>
   </div>
</body>
<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
</html>
<?
exit();
}


if($action=="open_color_list_view")
{
echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode,'','');
extract($_REQUEST);
?>
<script>
function js_set_value_color()
{
	var rowCount = $('#tbl_color_details tr').length-1;
	var color_breck_down="";
	for(var i=1; i<=rowCount; i++)
	{
		/*if (form_validation('concolor_'+i,'Contrast Color')==false)
		{
			return;
		}*/
		    var concolor=$('#concolor_'+i).val()
			if(concolor=='')
			{
				 concolor=$('#gmtscolor_'+i).val();
			}
		if(color_breck_down=="")
		{
			//color_breck_down=$('#gmtscolorid_'+i).val()+'_'+$('#gmtscolor_'+i).val()+'_'+$('#concolor_'+i).val();
			color_breck_down=$('#gmtscolorid_'+i).val()+'_'+$('#gmtscolor_'+i).val()+'_'+concolor;
		}
		else
		{
			//color_breck_down+="__"+$('#gmtscolorid_'+i).val()+'_'+$('#gmtscolor_'+i).val()+'_'+$('#concolor_'+i).val();
			color_breck_down+="__"+$('#gmtscolorid_'+i).val()+'_'+$('#gmtscolor_'+i).val()+'_'+concolor;
		}
	}
	document.getElementById('color_breck_down').value=color_breck_down;
	parent.emailwindow.hide();
}
function color_select_popup(buyer_name,texbox_id)
{
	//var page_link='requires/sample_booking_non_order_controller.php?action=color_popup'
	//alert(texbox_id)
	emailwindow=dhtmlmodal.open('EmailBox', 'iframe', 'pre_cost_entry_controller_v2.php?action=color_popup&buyer_name='+buyer_name, 'Color Select Pop Up', 'width=250px,height=450px,center=1,resize=1,scrolling=0','../../')
	emailwindow.onclose=function()
	{
		var theform=this.contentDoc.forms[0];
		var color_name=this.contentDoc.getElementById("color_name");
		if (color_name.value!="")
		{
			$('#'+texbox_id).val(color_name.value);
		}
	}
}
</script>
</head>
<body>
       <div id="color_details"  align="center">
    	<fieldset>
        	<form id="contrastcolor_1" autocomplete="off">
            <input type="hidden" id="color_breck_down" />
            <input type="hidden" id="item_id" />
            <table width="350" cellspacing="0" class="rpt_table" border="0" id="tbl_color_details" rules="all">
                	<thead>
                    	<tr>
                        	<th width="200">Gmts Color</th><th>Contrast Color</th>
                        </tr>
                    </thead>
                    <tbody>
                    <?
					/*$tot_set_qnty=0;
					$data_array=explode("__",$color_breck_down);

					if($data_array[0]=="")
					{
						$data_array=array();
					}
					if ( count($data_array)>0)
					{
						$i=0;
						foreach( $data_array as $row )
						{
							$i++;
							$data=explode('_',$row);
							$tot_set_qnty=$tot_set_qnty+$data[1];
							?>
                            	<tr id="color_1" align="center">
                                    <td>
                                    <input type="hidden" id="gmtscolorid_<? echo $i;?>"   name="gmtscolorid_<? echo $i;?>" style="width:50px"  class="text_boxes"   value="<? echo $data[0]; ?>"  readonly/>
									<input type="text" id="gmtscolor_<? echo $i;?>"   name="gmtscolor_<? echo $i;?>" style="width:150px"  class="text_boxes"   value="<? echo $data[1]; ?>"  readonly/>

                                    </td>
                                    <td>
                                    <input type="text" id="concolor_<? echo $i;?>"   name="concolor_<? echo $i;?>" style="width:130px"  class="text_boxes"   value="<? echo $data[2]; ?>"  />
                                    </td>

                                </tr>

                            <?

						}
					}*/

					//else
					//{
						$color_library=return_library_array("select id,color_name from lib_color where status_active=1 and is_deleted=0","id","color_name");
						$arr_bo_app=array();
						$sql_bo_app=sql_select("select a.is_approved,a.is_short,a.entry_form, b.gmts_color_id,b.pre_cost_fabric_cost_dtls_id from wo_booking_mst a, wo_booking_dtls b where   a.booking_no=b.booking_no and  b.job_no='$txt_job_no' and b.pre_cost_fabric_cost_dtls_id=$pre_cost_fabric_cost_dtls_id  and a.booking_type=1   and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 ");
						
						foreach($sql_bo_app as $row_bo_app) //271,275 ,====Issue Id=ISD-23-14053
						{
							$is_approved=$row_bo_app[csf('is_approved')];
							$is_shortId=$row_bo_app[csf('is_short')];
							$entry_formId=$row_bo_app[csf('entry_form')];
							if($is_approved==1 && $is_shortId==2)
							{
								$arr_bo_app[$row_bo_app[csf('pre_cost_fabric_cost_dtls_id')]]	=$row_bo_app[csf('is_approved')];
							}
							if($entry_formId==271 || $entry_formId==275) //partial N Short Fabric Booking
							{
								$gmts_colorChkArr[$row_bo_app[csf('gmts_color_id')]]=$row_bo_app[csf('gmts_color_id')];
							}
						
						}

						if($precostapproved==1 || $arr_bo_app[$pre_cost_fabric_cost_dtls_id]) $disabled=1; else $disabled=0;
						

						$color_from_library=return_field_value("color_from_library", "variable_order_tracking", "company_name=$cbo_company_id  and variable_list=23  and status_active=1 and is_deleted=0");
						if($color_from_library==1)
						{
							$readonly="readonly='readonly'";
							$plachoder="placeholder='Click'";
							$onClick="onClick='color_select_popup($cbo_buyer_name,this.id)'";
						}
						else
						{
							$readonly=""; $plachoder=""; $onClick="";
						}
						$data_array_color=explode("__",$color_breck_down);

					//Oracle
					$data_array=sql_select("select a.color_number_id from  wo_po_color_size_breakdown a, wo_po_break_down b where a.job_id=b.job_id and a.po_break_down_id=b.id and a.job_no_mst='$txt_job_no' and a.item_number_id='$cbogmtsitem' and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 group by a.color_number_id order by a.color_number_id");

						if ( count($data_array)>0)
						{
							$i=0;
							foreach( $data_array as $row )
							{
								$gmts_color_found=$gmts_colorChkArr[$row[csf('color_number_id')]];
								//echo $gmts_color_found.'DDD';
								$contrat_cond="";
								if($gmts_color_found>0)
								{
								$contrat_cond="readonly";	
								}
								

								$data=explode('_',$data_array_color[$i]);
								//print_r($data);
								$i++;

						?>
						<tr id="color_1" align="center">
									   <td>
										<input type="hidden" id="gmtscolorid_<? echo $i;?>"   name="gmtscolorid_<? echo $i;?>" style="width:50px"  class="text_boxes"   value="<? echo $row[csf('color_number_id')]; ?>"  readonly/>
										<input type="text" id="gmtscolor_<? echo $i;?>"   name="gmtscolor_<? echo $i;?>" style="width:150px"  class="text_boxes"   value="<? echo $color_library[$row[csf('color_number_id')]]; ?>"  readonly/>
										</td>
										 <td>
										<input type="text" id="concolor_<? echo $i;?>" name="concolor_<? echo $i;?> " style="width:130px" class="text_boxes" value="<? echo $data[2]; ?>" <? echo $readonly." ".$onClick." ".$plachoder?>  <? if($disabled==1){ echo "disabled";} else{ echo "";} ?><?=$contrat_cond;?> />
										 </td>
									</tr>
						<?
							}
						}
					//}
					?>
                </tbody>
                </table>
                <table width="350" cellspacing="0" class="" border="0">

                	<tr>
                        <td align="center" height="15" width="100%"> </td>
                    </tr>
                	<tr>
                        <td align="center" width="100%" class="button_container">

						        <input type="button" class="formbutton" value="Close" onClick="js_set_value_color()"/>

                        </td>
                    </tr>
                </table>

            </form>
        </fieldset>
        </div>
 </body>
<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
</html>
<?
exit();
}

if($action=="color_popup")
{
echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode);
extract($_REQUEST);
?>
<script>
function js_set_value(data)
{
	document.getElementById('color_name').value=data;
    parent.emailwindow.hide();
}
</script>
</head>
<body>
<body>
<div align="center">
<form>
<input type="hidden" id="color_name" name="color_name" />
<?
if($buyer_name=="" || $buyer_name=="")
{
    $sql="select color_name,id FROM lib_color  WHERE status_active=1 and is_deleted=0";
}
else
{
	$sql="select a.color_name,a.id FROM lib_color a, lib_color_tag_buyer b  WHERE a.id=b.color_id and b.buyer_id=$buyer_name and  status_active=1 and is_deleted=0";
}
	echo  create_list_view("list_view", "Color Name", "160","210","420",0, $sql , "js_set_value", "color_name", "", 1, "0", $arr , "color_name", "requires/sample_booking_non_order_controller",'setFilterGrid("list_view",-1);','0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,2') ;
	?>
    </form>
    </div>
    </body>
    </html>
    <?
	exit();
}

if($action=="conversion_chart_popup")
{
echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode);
extract($_REQUEST);

?>
<script>
function js_set_value(id,rate)
{
	//var data=data.split("_");
	document.getElementById('charge_id').value=id;
	document.getElementById('charge_value').value=rate;
	parent.emailwindow.hide();

}
function toggle( x, origColor )
		{
			var newColor = 'yellow';
			document.getElementById(x).style.backgroundColor = ( newColor == document.getElementById(x).style.backgroundColor )? origColor : newColor;
		}
</script>
</head>
<body>
<div align="center">
<form>
<input type="hidden" id="charge_id" name="charge_id" />
<input type="hidden" id="charge_value" name="charge_value" />



<?
if($cbotypeconversion==1)
{
	 $company_arr=return_library_array( "select id, company_name from lib_company",'id','company_name');
	 //$buyer_arr=return_library_array("select id, buyer_name from lib_buyer",'id','buyer_name');
	 $arr=array (0=>$company_arr,1=>$body_part,5=>$unit_of_measurement,7=>$row_status);
	// echo  create_list_view ( "list_view", "Company Name,Body Part,Construction & Composition,GSM,Yarn Description,UOM,In-House Rate,Status", "150,120,180,60,150,70,100,60","980","220",1, "select id,comapny_id,body_part,const_comp,gsm,yarn_description,in_house_rate,uom_id,status_active from lib_subcon_charge where status_active=1 and is_deleted=0 and rate_type_id=2 and comapny_id=$cbo_company_name", "js_set_value", "id,in_house_rate","", 1, "comapny_id,body_part,0,0,0,uom_id,0,status_active", $arr , "comapny_id,body_part,const_comp,gsm,yarn_description,uom_id,in_house_rate,status_active", "../sub_contract_bill/requires/lib_subcontract_knitting_controller", 'setFilterGrid("list_view",-1);','0,0,0,2,0,0,2,0' ) ;
	 ?>
     <table width="963" class="rpt_table" border="1" rules="all" cellpadding="0" cellspacing="0">
     <thead>
     <th width="50">SL</th>
     <th width="150">Company Name</th>
     <th width="120">Body Part</th>
     <th width="180">Construction & Composition</th>
     <th width="60">GSM</th>
     <th width="150">Yarn Description</th>
     <th width="70">UOM</th>
     <th width="100">In-House Rate</th>
     <th>Status</th>
     </thead>
     </table>
     <div style=" width:980; overflow:scroll-y; max-height:300px">
     <table width="963" class="rpt_table" border="1" rules="all" id="list_view" cellpadding="0" cellspacing="0">
     <?
	 $sql_data=sql_select("select id,comapny_id,body_part,const_comp,gsm,yarn_description,in_house_rate,uom_id,status_active from lib_subcon_charge where status_active=1 and is_deleted=0 and rate_type_id=2 and comapny_id=$cbo_company_name");
	 $i=1;
	 foreach($sql_data as $row)
	 {
		 if ($i%2==0)
		$bgcolor="#E9F3FF";
		else
		$bgcolor="#FFFFFF";

	 ?>
     <tr bgcolor="<? echo $bgcolor; ?>" onClick="js_set_value(<? echo $row[csf("id")]?>, <? echo $row[csf("in_house_rate")]; ?>)" id="tr_<? echo $row[csf("id")];  ?>">
     <td width="50"><? echo $i; ?></td>
     <td width="150"><? echo $company_arr[$row[csf("comapny_id")]]; ?></td>
     <td width="120"><? echo $body_part[$row[csf("body_part")]]; ?></td>
     <td width="180"><? echo $row[csf("const_comp")]; ?></td>
     <td width="60"><? echo $row[csf("gsm")]; ?></td>
     <td width="150"><? echo $row[csf("yarn_description")]; ?></td>
     <td width="70"><? echo $unit_of_measurement[$row[csf("uom_id")]]; ?></td>
     <td width="100"><? echo $row[csf("in_house_rate")]; ?></td>
     <td><? echo $row_status[$row[csf("status_active")]]; ?></td>
     </tr>
     <?
	  $i++;
	 }
	 ?>
     <script>
	 setFilterGrid("list_view",-1)
	 toggle( "tr_"+"<? echo $coversionchargelibraryid ?>", '#FFFFCC');
	 </script>
     </table>
     </div>

     <?
}
else
{
	$company_arr=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$color_library_arr=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	$arr=array (0=>$company_arr,2=>$process_type,3=>$conversion_cost_head_array,4=>$color_library_arr,5=>$fabric_typee,7=>$unit_of_measurement,8=>$production_process,9=>$row_status);
	//echo "select id,comapny_id,const_comp,process_type_id,process_id,color_id,width_dia_id,in_house_rate,uom_id,rate_type_id,status_active from lib_subcon_charge where status_active=1 and is_deleted=0 and rate_type_id in (3,4,8) and process_id=$cbotypeconversion and comapny_id=$cbo_company_name";
	//echo  create_list_view ( "list_view", "Company Name,Const. Compo.,Process Type,Process Name,Color,Width/Dia type,In House Rate,UOM,Rate type,Status", "100,150,70,70,70,80,60,80,60,50","900","250",1, "select id,comapny_id,const_comp,process_type_id,process_id,color_id,width_dia_id,in_house_rate,uom_id,rate_type_id,status_active from lib_subcon_charge where status_active=1 and is_deleted=0 and rate_type_id in (3,4,7,8) and process_id=$cbotypeconversion and comapny_id=$cbo_company_name", "js_set_value", "id,in_house_rate","", 1, "comapny_id,0,process_type_id,process_id,color_id,width_dia_id,0,uom_id,rate_type_id,status_active", $arr, "comapny_id,const_comp,process_type_id,process_id,color_id,width_dia_id,in_house_rate,uom_id,rate_type_id,status_active","requires/lib_subcontract_dyeing_controller", 'setFilterGrid("list_view",-1);','0,0,0,0,0,0,2,0,0,0' );
	?>
    <table width="900" class="rpt_table" border="1" rules="all" cellpadding="0" cellspacing="0">
     <thead>
     <th width="50">SL</th>
     <th width="100">Company Name</th>
     <th width="150">Const. Compo.</th>
     <th width="70">Process Type</th>
     <th width="70">Process Name</th>
     <th width="70">Color</th>
     <th width="80">Width/Dia type</th>

     <th width="60">In House Rate</th>
     <th width="80">UOM</th>
     <th width="60">Rate type</th>
     <th>Status</th>
     </thead>
     </table>
     <div style=" width:917; overflow:scroll-y; max-height:300px">
     <table width="900" class="rpt_table" border="1" rules="all" id="list_view" cellpadding="0" cellspacing="0">
     <?
	 $sql_data=sql_select("select id,comapny_id,const_comp,process_type_id,process_id,color_id,width_dia_id,in_house_rate,uom_id,rate_type_id,status_active from lib_subcon_charge where status_active=1 and is_deleted=0 and rate_type_id in (3,4,7,8) and process_id=$cbotypeconversion and comapny_id=$cbo_company_name");
	 $i=1;
	 foreach($sql_data as $row)
	 {
		 if ($i%2==0)
		$bgcolor="#E9F3FF";
		else
		$bgcolor="#FFFFFF";

	 ?>
     <tr bgcolor="<? echo $bgcolor; ?>" onClick="js_set_value(<? echo $row[csf("id")]?>, <? echo $row[csf("in_house_rate")]; ?>)" id="tr_<? echo $row[csf("id")];  ?>">
     <td width="50"><? echo $i; ?></td>
     <td width="100"><? echo $company_arr[$row[csf("comapny_id")]]; ?></td>
     <td width="150"><? echo $row[csf("const_comp")]; ?></td>
     <td width="70"><? echo $process_type[$row[csf("process_type_id")]]; ?></td>
      <td width="70"><? echo $conversion_cost_head_array[$row[csf("process_id")]]; ?></td>
     <td width="70"><? echo $color_library_arr[$row[csf("color_id")]]; ?></td>
     <td width="80"><? echo $fabric_typee[$row[csf("width_dia_id")]]; ?></td>

     <td width="60"><? echo $row[csf("in_house_rate")]; ?></td>
     <td width="80"><? echo $unit_of_measurement[$row[csf("uom_id")]]; ?></td>
     <td width="60"><? echo $production_process[$row[csf("rate_type_id")]]; ?></td>
     <td><? echo $row_status[$row[csf("status_active")]]; ?></td>
     </tr>
     <?
	  $i++;
	 }
	 ?>
     <script>
	 setFilterGrid("list_view",-1)
	 toggle( "tr_"+"<? echo $coversionchargelibraryid ?>", '#FFFFCC');
	 </script>
     </table>
     </div>
    <?
}
?>
</form>
</div>
</body>
</html>
<?

}

if ($action=="set_conversion_charge"){
	//extract($_REQUEST);
	$rate=return_field_value("rate", "lib_cost_component", "cost_component_name=$data");
	echo $rate; die;
}

if ($action=="set_conversion_qnty"){
	$data=explode("_",$data);
	$lib_yarn_count_deter_id=return_field_value("lib_yarn_count_deter_id", "wo_pre_cost_fabric_cost_dtls", "id=$data[0]");
	$processloss=return_field_value("process_loss", "conversion_process_loss", "mst_id=$lib_yarn_count_deter_id and process_id=$data[1]");
	$processloss_from_library=1;
	if(!$processloss){
		$processloss=$data[2];
		$processloss_from_library=0;
	}
	if($data[3]){// update mode
		$processloss=$data[2];
	}
	if($data[1]==30){
		$sql=sql_select("select sum(fabreq) as fabreq from  wo_pre_stripe_color where pre_cost_fabric_cost_dtls_id=$data[0] and yarn_dyed=1");
		$avg_cons= $sql[0][csf('fabreq')];
		$avg_cons=$avg_cons-($avg_cons*$processloss)/100;
		$avg_cons_yarn=$avg_cons-($avg_cons*$processloss)/100;
	}
	else{
		$avg_cons=return_field_value("avg_cons", "wo_pre_cost_fabric_cost_dtls", "id=$data[0]");
		$avg_cons=$avg_cons-($avg_cons*$processloss)/100;
	    //$avg_cons_yarn=return_field_value("avg_cons_yarn", "wo_pre_cost_fabric_cost_dtls", "id=$data[0]");
		$avg_cons_yarn=return_field_value("avg_cons", "wo_pre_cost_fabric_cost_dtls", "id=$data[0]");
	    $avg_cons_yarn=$avg_cons_yarn-($avg_cons_yarn*$processloss)/100;
		if($avg_cons_yarn==''){
			$avg_cons_yarn=$avg_cons;
		}
	}
	echo trim($avg_cons)."_".trim($avg_cons_yarn)."_".trim($processloss)."_".trim($processloss_from_library);
	die;
}


if($action=="conversion_color_popup"){
	echo load_html_head_contents("Popup Info","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
<script>
var costype=<? echo $cbotypeconversion ?>;
function set_conversion_charge_unit(i,conversion_from_chart){
	//if(costype==31){
		if(conversion_from_chart==1){
			document.getElementById('unitcharge_'+i).readOnly=true
			set_conversion_charge_unit_pop_up(i)
		}
		else{
			document.getElementById('unitcharge_'+i).readOnly=false
		}
	//}
}

function set_conversion_charge_unit_pop_up(i){
    var cbo_company_name=document.getElementById('cbo_company_name').value;
	var cbotypeconversion=document.getElementById('cbotypeconversion').value
	var txt_exchange_rate=document.getElementById('txt_exchange_rate').value
	var coversionchargelibraryid=document.getElementById('coversionchargelibraryid_'+i).value
	if(cbo_company_name==0){
		alert("Select Company");
		return;
	}
	if(cbotypeconversion==0){
		alert("Select Process");
		return;
	}
	if(txt_exchange_rate==0 || txt_exchange_rate==""){
		alert("Select Exchange Rate");
		return;
	}
	else{
	var page_link='pre_cost_entry_controller_v2.php?action=conversion_chart_popup&cbo_company_name='+cbo_company_name+'&cbotypeconversion='+cbotypeconversion+'&coversionchargelibraryid='+coversionchargelibraryid;
	emailwindow=dhtmlmodal.open('EmailBox', 'iframe', page_link, 'Conversion Chart', 'width=1060px,height=450px,center=1,resize=1,scrolling=0','../')
	emailwindow.onclose=function(){
			var charge_id=this.contentDoc.getElementById("charge_id");
			var charge_value=this.contentDoc.getElementById("charge_value");
			document.getElementById('coversionchargelibraryid_'+i).value=charge_id.value;
			document.getElementById('unitcharge_'+i).value=number_format_common(charge_value.value/txt_exchange_rate,5,0,document.getElementById('cbo_currercy').value);
			calculate_amount(i)
			claculate_avg()
		}
	}
}

function js_set_value_color(){
	var rowCount = $('#tbl_color_details tr').length-3;
	var color_breck_down="";
	var coversionchargelibraryid_baeck_down="";
	for(var i=1; i<=rowCount; i++){
		var unitcharge = $('#unitcharge_'+i).val();
		if(trim(unitcharge) ==''){
			unitcharge=0;
		}
		var coversionchargelibraryid= $('#coversionchargelibraryid_'+i).val();
		if(coversionchargelibraryid==''){
			coversionchargelibraryid=0;
		}
		if(color_breck_down==""){
			color_breck_down=$('#gmtscolorid_'+i).val()+'_'+trim(unitcharge)+'_'+coversionchargelibraryid+'_'+$('#fabriccolorid_'+i).val()+'_'+$('#cons_'+i).val();
		}
		else{
			color_breck_down+="__"+$('#gmtscolorid_'+i).val()+'_'+trim(unitcharge)+'_'+coversionchargelibraryid+'_'+$('#fabriccolorid_'+i).val()+'_'+$('#cons_'+i).val();
		}

		if(coversionchargelibraryid_baeck_down==""){
			coversionchargelibraryid_baeck_down=$('#coversionchargelibraryid_'+i).val()
		}
		else{
			coversionchargelibraryid_baeck_down+="_"+$('#coversionchargelibraryid_'+i).val();
		}
	}
	document.getElementById('color_breck_down').value=color_breck_down;
	document.getElementById('chargelibid_breck_down').value=coversionchargelibraryid_baeck_down;
	parent.emailwindow.hide();
}

function claculate_avg_old(){
	var significant_row=0;
	var total_value=0;
	var rowCount = $('#tbl_color_details tr').length-3;
	for(var i=1; i<=rowCount; i++){
		if(document.getElementById('unitcharge_'+i).value =='' || document.getElementById('unitcharge_'+i).value ==0){
			continue;
		}
		else{
			significant_row=significant_row+1;
			total_value+=(document.getElementById('unitcharge_'+i).value)*1
		}
	}
	var avg_total_value=total_value/significant_row;
	document.getElementById('total_value').value=total_value
	document.getElementById('avg_total_value').value=number_format_common(avg_total_value, 1, 0);
}
function claculate_avg(){
	//var significant_row=0;
	var totalunitcharge=0;
	var total_value=0;
	var total_amount=0;
	var totalreqqty=0;
	var rowCount = $('#tbl_color_details tr').length-3;
	for(var i=1; i<=rowCount; i++){
		if(document.getElementById('unitcharge_'+i).value =='' || document.getElementById('unitcharge_'+i).value ==0){
			continue;
		}
		else{
			//significant_row=significant_row+1;
			var reqqty =document.getElementById('reqqty_'+i).value*1;
			//alert(reqqty);
			totalreqqty+=reqqty;
			var unitcharge=document.getElementById('unitcharge_'+i).value*1;
			totalunitcharge+=unitcharge;
			var value=unitcharge*reqqty;
			total_value+=value;
			var cons =document.getElementById('cons_'+i).value*1;
			var amount=unitcharge*cons;
			total_amount+=amount;
		}
	}
	var orderQty=document.getElementById('orderQty').value*1
	var itemRatio=document.getElementById('itemRatio').value*1
	var avg_total_value=total_value/totalreqqty;
	var avg_total_cons=(totalreqqty/orderQty)*costPer*itemRatio
	var avg_total_amount=(total_value/orderQty)*costPer*itemRatio
	document.getElementById('total_value').value=totalunitcharge
	document.getElementById('total_amount').value=total_amount
	document.getElementById('avg_total_value').value=number_format_common(avg_total_value, 5, 0);
	document.getElementById('avg_total_cons').value=number_format_common(avg_total_cons, 5, 0);
	document.getElementById('avg_total_amount').value=number_format_common(avg_total_amount, 5, 0);
}
function calculate_amount(i){
	//alert(i);
	var cons=document.getElementById('cons_'+i).value*1
	var unitcharge=document.getElementById('unitcharge_'+i).value*1
	var amount= cons*unitcharge;
	document.getElementById('amount_'+i).value=number_format_common(amount, 5, 0);
}




</script>
</head>
<body>
    <?
	$condition= new condition();
	if(str_replace("'","",$job_no) !=''){
		$condition->job_no("='$job_no'");
	}
	$condition->init();
	$GmtsitemRatioArr=$condition->getGmtsitemRatioArr();
	$CostingPerArr=$condition->getCostingPerArr();
	$CostPerQty= $CostingPerArr[str_replace("'","",$job_no)];
	//$GmtsitemRatio=$GmtsitemRatioArr[str_replace("'","",$job_no)][$cbogmtsitem];

	$fabric= new fabric($condition);
	$fabric_costing_arr=$fabric->getQtyArray_by_FabriccostidAndGmtscolor_knitAndwoven_greyAndfinish();

	/*echo '<pre>';
	print_r($fabric_costing_arr); die;*/

	$data_array_update=array();
    $data_array=explode("__",$colorbreakdown);
	if($data_array[0]=="")
	{
		$data_array=array();
	}
	if ( count($data_array)>0)
	{
		$i=0;
		$total_value=0;
		foreach( $data_array as $row )
		{
			$i++;
			$data=explode('_',$row);
			$data_array_update[$data[0]][$data[3]][unitcharge]=$data[1];
			$data_array_update[$data[0]][$data[3]][coversionchargelibraryid]=$data[2];
		}
	}
	if($cbocosthead !=0)
	{

	$GmtsitemRatio=0;
	$plan_cut_qntyarray=array();
	$sql_data=sql_select("select a.job_no,c.color_number_id,c.plan_cut_qnty,d.color_size_sensitive,d.item_number_id,f.contrast_color_id AS fabric_color  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_fabric_cost_dtls d,wo_pre_cos_fab_co_avg_con_dtls e left join wo_pre_cos_fab_co_color_dtls f on e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.gmts_color_id  where 1=1  and d.id='$cbocosthead' and a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no  and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and  c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes   and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1");//and e.cons !=0

	foreach($sql_data as $row){
		$plan_cut_qnty+=$row[csf('plan_cut_qnty')];
		$plan_cut_qntyarray[$row[csf('color_number_id')]]+=$row[csf('plan_cut_qnty')];
		$GmtsitemRatio=$GmtsitemRatioArr[$row[csf('job_no')]][$row[csf('item_number_id')]];
	}

		$tdColor="Color";
		$color_size_sensitive=return_field_value("color_size_sensitive", "wo_pre_cost_fabric_cost_dtls", "id=$cbocosthead");
		$color_type_id=return_field_value("color_type_id", "wo_pre_cost_fabric_cost_dtls", "id=$cbocosthead");

		if($color_type_id !=2 && $color_type_id !=3 && $color_type_id !=4 && $color_type_id !=6 && $color_type_id !=31  && $color_type_id !=32 && $color_type_id !=33 && $color_type_id !=34 && $color_type_id !=71)
		{
			//$data_array=sql_select("select distinct a.color_number_id from  wo_po_color_size_breakdown a,wo_pre_cos_fab_co_avg_con_dtls b  where a.id=b.color_size_table_id and b.pre_cost_fabric_cost_dtls_id='$cbocosthead' and a.status_active=1 and  a.is_deleted=0 ");
			$data_array=sql_select("select c.color_number_id,d.color_size_sensitive,f.contrast_color_id AS fabric_color  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_fabric_cost_dtls d,wo_pre_cos_fab_co_avg_con_dtls e left join wo_pre_cos_fab_co_color_dtls f on e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.gmts_color_id  where 1=1  and d.id='$cbocosthead' and a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no  and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and  c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes    and e.cons !=0   and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 group by c.color_number_id,f.contrast_color_id,d.color_size_sensitive ");
			$tdColor="Gmts Color";
		}
		else if($cbotypeconversion==30 && ($color_type_id ==2 || $color_type_id ==3 || $color_type_id ==4 || $color_type_id ==6 || $color_type_id ==31 || $color_type_id ==32 || $color_type_id ==33 || $color_type_id ==34 || $color_type_id ==71))
		{
			//$data_array=sql_select("select  stripe_color as color_number_id , fabreqtotkg as req_qty from wo_pre_stripe_color where pre_cost_fabric_cost_dtls_id='$cbocosthead' and status_active=1 and  is_deleted=0");

			$data_array=sql_select("select c.color_number_id,d.color_size_sensitive,f.id,f.stripe_color AS fabric_color ,f.fabreq as  fabreq, f.fabreqtotkg as req_qty from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_fabric_cost_dtls d,wo_pre_cos_fab_co_avg_con_dtls e left join wo_pre_stripe_color f on e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.color_number_id and f.yarn_dyed=1  where 1=1  and d.id='$cbocosthead' and a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no  and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and  c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes    and e.cons !=0   and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 group by c.color_number_id,d.color_size_sensitive,f.id ,f.stripe_color,f.fabreq,f.fabreqtotkg  order by c.color_number_id");
			$tdColor="Stripe Color";
			if(count($data_array) <=0){
				//$data_array=sql_select("select distinct a.color_number_id from  wo_po_color_size_breakdown a,wo_pre_cos_fab_co_avg_con_dtls b  where a.id=b.color_size_table_id and b.pre_cost_fabric_cost_dtls_id='$cbocosthead' and a.status_active=1  and  a.is_deleted=0 ");
				$data_array=sql_select("select c.color_number_id,d.color_size_sensitive,f.contrast_color_id AS fabric_color  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_fabric_cost_dtls d,wo_pre_cos_fab_co_avg_con_dtls e left join wo_pre_cos_fab_co_color_dtls f on e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.gmts_color_id  where 1=1  and d.id='$cbocosthead' and a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no  and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and  c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes    and e.cons !=0   and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 group by c.color_number_id,f.contrast_color_id,d.color_size_sensitive");
				$tdColor="Stripe Color";
			}
		}
		else{

			$data_array=sql_select("select c.color_number_id,d.color_size_sensitive,f.contrast_color_id AS fabric_color  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_fabric_cost_dtls d,wo_pre_cos_fab_co_avg_con_dtls e left join wo_pre_cos_fab_co_color_dtls f on e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.gmts_color_id  where 1=1  and d.id='$cbocosthead' and a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no  and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and  c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes    and e.cons !=0   and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 group by c.color_number_id,f.contrast_color_id,d.color_size_sensitive");
			$tdColor="Gmts Color";
		}
		$color_library=return_library_array("select id,color_name from lib_color where status_active=1 and is_deleted=0","id","color_name");
		?>
        <script>
		var costPer=<? echo $CostPerQty; ?>
		</script>
        <form id="contrastcolor_1" autocomplete="off">
            <input type="hidden" id="color_breck_down" />
            <input type="hidden" id="chargelibid_breck_down" />
            <input type="hidden" id="cbo_company_name" value="<? echo $cbo_company_name;?>" />
            <input type="hidden" id="cbotypeconversion" value="<? echo $cbotypeconversion;?>" />
            <input type="hidden" id="txt_exchange_rate" value="<? echo $txt_exchange_rate;?>" />
            <input type="hidden" id="cbo_currercy" value="<? echo $cbo_currercy;?>" />
            <input type="hidden" id="orderQty" value="<? echo $plan_cut_qnty;?>" />
            <input type="hidden" id="itemRatio" value="<? echo $GmtsitemRatio;?>" />
            <table width="300" cellspacing="0" class="rpt_table" border="0" id="tbl_color_details" rules="all">
                <thead>
                <tr>
                <th width="30">Sl</th>
                <th width="120" title="<? echo $tdColor; ?>">Gmts Color</th>
                <th width="120" title="<? echo $tdColor; ?>">Fabric Color</th>
                <th width="60">Cons</th>
                <th>Charge/Unit</th>
                <!--<th>Amount</th>-->
                </tr>
                </thead>
                <tbody>
		<?
		$i=0;
		$avg_num=0;
		$totalCons=0;
		$total_value=0;
		//print_r($data_array);
		foreach( $data_array as $row ){

			$i++;
			//echo $row[csf('color_size_sensitive')];
			$colorreqqty=0;
			if($color_size_sensitive==1 && $color_type_id !=2 && $color_type_id !=3 && $color_type_id !=4 && $color_type_id !=6 && $color_type_id !=31 && $color_type_id !=32 && $color_type_id !=33 && $color_type_id !=34){
				$colorreqqty=array_sum($fabric_costing_arr['woven']['grey'][$cbocosthead][$row[csf('color_number_id')]]);
			}
			else if($color_size_sensitive==1 && $cbotypeconversion==30 && ($color_type_id ==2 || $color_type_id ==3 || $color_type_id ==4 || $color_type_id ==6 || $color_type_id ==31 || $color_type_id ==32 || $color_type_id ==33 || $color_type_id ==34)){
				$colorreqqty=$row[csf('req_qty')];
				if($row[csf('req_qty')]==""){
					$colorreqqty=array_sum($fabric_costing_arr['woven']['grey'][$cbocosthead][$row[csf('color_number_id')]]);
				}
			}
			else if($color_size_sensitive==3){
				$colorreqqty=array_sum($fabric_costing_arr['woven']['grey'][$cbocosthead][$row[csf('gmts_color_id')]]);
			}
			else{
				$colorreqqty=array_sum($fabric_costing_arr['woven']['grey'][$cbocosthead][$row[csf('color_number_id')]]);
			}

			//echo $row[csf('color_size_sensitive')]."=".$cbotypeconversion."<br/>";
			$fab_colo=$row[csf('fabric_color')];
			if($row[csf('color_size_sensitive')]==1 && $cbotypeconversion !=30){
				$fab_colo=$row[csf('color_number_id')];
			}

			if($cbotypeconversion !=30){
				$colorreqqty=array_sum($fabric_costing_arr['woven']['grey'][$cbocosthead][$row[csf('color_number_id')]]);
				$DznGreyreq=(array_sum($fabric_costing_arr['woven']['grey'][$cbocosthead][$row[csf('color_number_id')]])/$plan_cut_qntyarray[$row[csf('color_number_id')]])*$CostPerQty*$GmtsitemRatio;
			}
			if($cbotypeconversion ==30){
				$colorreqqty=$row[csf('req_qty')];
				$DznGreyreq=$row[csf('fabreq')];
			}

			$unitcharge=0;
			if($data_array_update[$row[csf('color_number_id')]][$fab_colo][unitcharge]==""){
				$unitcharge=$conversion_qnty;
			}
			else{
				$unitcharge=$data_array_update[$row[csf('color_number_id')]][$fab_colo][unitcharge];
			}
			$total_value+=$unitcharge;
			if($unitcharge > 0){
				$avg_num+=1;
			}
				$totalCons+=$DznGreyreq;;
			/*if($row[csf('color_size_sensitive')]==1 $cbotypeconversion !=30){
				$fab_colo=$row[csf('color_number_id')];
			}*/
	?>
            <tr>
                <td><? echo $i; ?></td>
                <td>
                <input type="hidden" id="gmtscolorid_<? echo $i;?>"   name="gmtscolorid_<? echo $i;?>" style="width:50px"  class="text_boxes"   value="<? echo $row[csf('color_number_id')]; ?>"  readonly/>
                <input type="hidden" id="reqqty_<? echo $i;?>"   name="reqqty_<? echo $i;?>" style="width:50px"  class="text_boxes"   value="<? echo $colorreqqty; ?>"  readonly/>
                <input type="text" id="gmtscolor_<? echo $i;?>"   name="gmtscolor_<? echo $i;?>" style="width:120px"  class="text_boxes"   value="<? echo $color_library[$row[csf('color_number_id')]]; ?>"   readonly/>

                </td>
                 <td>
                <input type="hidden" id="fabriccolorid_<? echo $i;?>"   name="fabriccolorid_<? echo $i;?>" style="width:50px"  class="text_boxes"   value="<? echo $fab_colo; ?>"  readonly/>
                <input type="text" id="fabriccolor_<? echo $i;?>"   name="fabriccolor_<? echo $i;?>" style="width:120px"  class="text_boxes"   value="<? echo $color_library[$fab_colo]; ?>"   readonly/>

                </td>
                  <td>
                <input type="text" id="cons_<? echo $i;?>"   name="cons_<? echo $i;?>" value="<? echo $DznGreyreq; ?>" style="width:150px"  class="text_boxes_numeric" readonly/>
                </td>
                <td>
                <input type="text" id="unitcharge_<? echo $i;?>"   name="unitcharge_<? echo $i;?>" value="<? echo trim($unitcharge); ?>"  onChange="claculate_avg();calculate_amount(<? echo $i; ?>)" onClick="set_conversion_charge_unit(<? echo $i; ?>,<? echo $conversion_from_chart; ?>)" style="width:150px"  class="text_boxes_numeric"/>
                <input type="hidden" id="coversionchargelibraryid_<? echo $i;?>"   name="coversionchargelibraryid_<? echo $i;?>" value="<? echo $data_array_update[$row[csf('color_number_id')]][coversionchargelibraryid]; ?>"  readonly/>
                                <input type="hidden" id="amount_<? echo $i;?>"   name="amount_<? echo $i;?>" value="<? //echo $DznGreyreq; ?>" style="width:150px"  class="text_boxes_numeric" readonly/>

                </td>
                <!--<td>
                </td>-->
            </tr>
		<?
        }
        }
        else
        {
            $color_array=array();
            $color_size_sensitive_array=sql_select("select  id,color_size_sensitive  from wo_pre_cost_fabric_cost_dtls where job_no='".$job_no."' and fabric_source=1");
            foreach( $color_size_sensitive_array as $color_size_sensitive_row ){
                if($color_size_sensitive_row[csf('color_size_sensitive')]==1){
                    $data_array1=sql_select("select distinct a.color_number_id as color_number_id  from  wo_po_color_size_breakdown a,wo_pre_cos_fab_co_avg_con_dtls b  where a.id=b.color_size_table_id and b.pre_cost_fabric_cost_dtls_id='".$color_size_sensitive_row[csf('id')]."' and a.status_active=1 and  a.is_deleted=0 ");
                    //echo "select distinct a.color_number_id as color_number_id  from  wo_po_color_size_breakdown a,wo_pre_cos_fab_co_avg_con_dtls b  where a.id=b.color_size_table_id and b.pre_cost_fabric_cost_dtls_id='".$color_size_sensitive_row[csf('id')]."' and a.status_active=1 and  a.is_deleted=0 ";
                    foreach( $data_array1 as $row1 ){
                        if (array_key_exists($row1[csf('color_number_id')], $color_array)) {
                            continue;
                        }
                        else{
                            $color_array[$row1[csf('color_number_id')]]=$row1[csf('color_number_id')];
                        }
                    }


                }
                if($color_size_sensitive_row[csf('color_size_sensitive')]==3)
                {

                    $data_array2=sql_select("select  contrast_color_id as color_number_id  from wo_pre_cos_fab_co_color_dtls where pre_cost_fabric_cost_dtls_id='".$color_size_sensitive_row[csf('id')]."'");
                    //echo "select  contrast_color_id as color_number_id  from wo_pre_cos_fab_co_color_dtls where id='".$color_size_sensitive_row[csf('id')]."'";
                    foreach( $data_array2 as $row2 )
                    {
                        if (array_key_exists($row2[csf('color_number_id')], $color_array))
                        {
                            continue;
                        }
                        else
                        {
                            $color_array[$row2[csf('color_number_id')]]=$row2[csf('color_number_id')];
                        }
                    }

                }
                if($color_size_sensitive_row[csf('color_size_sensitive')]==0)
                {
                    $data_array3=sql_select("select  color as color_number_id  from wo_pre_cost_fabric_cost_dtls where id='".$color_size_sensitive_row[csf('id')]."'");
                    foreach( $data_array3 as $row3 )
                    {
                        if (array_key_exists($row3[csf('color_number_id')], $color_array))
                        {
                            continue;
                        }
                        else
                        {
                            $color_array[$row3[csf('color_number_id')]]=$row3[csf('color_number_id')];
                        }
                    }
                }
            }
            $i=0;
            $avg_num=0;
            $total_value=0;
            foreach( $color_array as $key=>$value )
            {
            $unitcharge=0;
            if($data_array_update[$value][unitcharge]=="")
            {
            $unitcharge=$conversion_qnty;
            }
            else
            {
            $unitcharge=$data_array_update[$value][unitcharge];
            }
            $total_value+=$unitcharge;

            if($unitcharge > 0)
            {
            $avg_num+=1;
            }

            $i++;
		?>
            <tr>
                <td><? echo $i; ?></td>
                <td> <input type="hidden" id="gmtscolorid_<? echo $i;?>"   name="gmtscolorid_<? echo $i;?>" style="width:50px"  class="text_boxes"   value="<? echo $value; ?>"  readonly/>
                <input type="text" id="gmtscolor_<? echo $i;?>"   name="gmtscolor_<? echo $i;?>" style="width:120px"  class="text_boxes"   value="<? echo $color_library[$value]; ?>"  readonly/></td>
                <td> <input type="hidden" id="fabriccolorid_<? echo $i;?>"   name="fabriccolorid_<? echo $i;?>" style="width:50px"  class="text_boxes"   value="<? echo $value; ?>"  readonly/>
                <input type="text" id="fabriccolor_<? echo $i;?>"   name="fabriccolor_<? echo $i;?>" style="width:120px"  class="text_boxes"   value="<? echo $color_library[$value]; ?>"  readonly/></td>
                 <td>
                <input type="text" id="cons_<? echo $i;?>"   name="cons_<? echo $i;?>" value="<? //echo $unitcharge; ?>" style="width:150px"  class="text_boxes_numeric"/>
                                <input type="hidden" id="amount_<? echo $i;?>"   name="amount_<? echo $i;?>" value="<? //echo $DznGreyreq; ?>" style="width:150px"  class="text_boxes_numeric" readonly/>

                </td>

                <td>
                <input type="text" id="unitcharge_<? echo $i;?>"   name="unitcharge_<? echo $i;?>" style="width:150px" onChange="claculate_avg()" onClick="set_conversion_charge_unit(<? echo $i; ?>,<? echo $conversion_from_chart; ?>)" value="<? echo trim($unitcharge); ?>"  class="text_boxes_numeric"/>
                <input type="hidden" id="coversionchargelibraryid_<? echo $i;?>"   name="coversionchargelibraryid_<? echo $i;?>" value="<? echo $data_array_update[$row[csf('color_number_id')]][coversionchargelibraryid]; ?>"  readonly/>
                </td>
                <!--<td>
                </td>-->
            </tr>

			<?
            }
        }
        //}
        ?>
</tbody>
<tfoot>
<tr>
			<th><? echo $avg_num;  ?></th>
			<th>
            Total
			</th>
            <th>

			</th>
            <th>
            <input type="text" id="total_cons"   name="total_cons" style="width:150px" value="<? echo $totalCons; ?>"  class="text_boxes_numeric"/>
			</th>
			<th>
            <input type="text" id="total_value"   name="total_value" style="width:150px" value="<? echo $total_value; ?>"  class="text_boxes_numeric"/>
            <input type="hidden" id="total_amount"   name="total_amount" style="width:150px" value="<? echo def_number_format(($total_value/$avg_num),$cbo_currercy,0); ?>"  class="text_boxes_numeric"/>
            </th>
            <!--<th>

            </th>-->
		</tr>
        <tr>
			<th></th>
			<th>
            Avg Total
			</th>
            <th>

			</th>
            <th>
            <input type="text" id="avg_total_cons"   name="avg_total_cons" style="width:150px" value="<? //echo $total_value; ?>"  class="text_boxes_numeric"/>
			</th>
			<th><input type="text" id="avg_total_value"   name="avg_total_value" style="width:150px" value="<? //echo def_number_format(($total_value/$avg_num),$cbo_currercy,0); ?>"  class="text_boxes_numeric"/>
                        <input type="hidden" id="avg_total_amount"   name="avg_total_amount" style="width:150px" value="<? //echo def_number_format(($total_value/$avg_num),$cbo_currercy,0); ?>"  class="text_boxes_numeric"/>
</th>
           <!-- <th>
			</th>-->
		</tr>
</tfoot>
</table>
 <table width="300" cellspacing="0" class="" border="0">

                	<tr>
                        <td align="center" height="15" width="100%"> </td>
                    </tr>
                	<tr>
                        <td align="center" width="100%" class="button_container">

						        <input type="button" class="formbutton" value="Close" onClick="js_set_value_color()"/>

                        </td>
                    </tr>
                </table>
</form>
</body>
<script>
claculate_avg();
</script>
<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
</html>

    <?
}

if($action=="conversion_color_popup_old")
{
	echo load_html_head_contents("Popup Info","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
    <script>
	/*function set_checkvalue()
	{
		if(document.getElementById('chk_job_wo_po').value==0) document.getElementById('chk_job_wo_po').value=1;
		else document.getElementById('chk_job_wo_po').value=0;
	}*/


	function set_conversion_charge_unit(i,conversion_from_chart)
	{
		if(conversion_from_chart==1)
		{
			document.getElementById('unitcharge_'+i).readOnly=true
		    set_conversion_charge_unit_pop_up(i)
		}
		else
		{
		document.getElementById('unitcharge_'+i).readOnly=false
		}


	}
function set_conversion_charge_unit_pop_up(i)
{
    var cbo_company_name=document.getElementById('cbo_company_name').value;
	var cbotypeconversion=document.getElementById('cbotypeconversion').value
	var txt_exchange_rate=document.getElementById('txt_exchange_rate').value
	var coversionchargelibraryid=document.getElementById('coversionchargelibraryid_'+i).value
	if(cbo_company_name==0)
	{
	alert("Select Company");
	return;
	}
	if(cbotypeconversion==0)
	{
	alert("Select Process");
	return;
	}
	if(txt_exchange_rate==0 || txt_exchange_rate=="")
	{
	alert("Select Exchange Rate");
	return;
	}

	else
	{
	var page_link='pre_cost_entry_controller_v2.php?action=conversion_chart_popup&cbo_company_name='+cbo_company_name+'&cbotypeconversion='+cbotypeconversion+'&coversionchargelibraryid='+coversionchargelibraryid;
	emailwindow=dhtmlmodal.open('EmailBox', 'iframe', page_link, 'Conversion Chart', 'width=1060px,height=450px,center=1,resize=1,scrolling=0','../')
	emailwindow.onclose=function()
		{
			var charge_id=this.contentDoc.getElementById("charge_id");
			var charge_value=this.contentDoc.getElementById("charge_value");

			document.getElementById('coversionchargelibraryid_'+i).value=charge_id.value;
			document.getElementById('unitcharge_'+i).value=number_format_common(charge_value.value/txt_exchange_rate,5,0,document.getElementById('cbo_currercy').value);
			claculate_avg()

		}
	}
}



	function js_set_value_color()
	{
		var rowCount = $('#tbl_color_details tr').length-3;
		var color_breck_down="";
		var coversionchargelibraryid_baeck_down="";
		for(var i=1; i<=rowCount; i++)
		{
			/*if (form_validation('unitcharge_'+i,'Charge Unit')==false)
			{
				return;
			}*/
			var unitcharge = $('#unitcharge_'+i).val();
				if(trim(unitcharge) =='')
				{
					unitcharge=0;
				}

			var coversionchargelibraryid= $('#coversionchargelibraryid_'+i).val();
				if(coversionchargelibraryid=='')
				{
					coversionchargelibraryid=0;
				}

			if(color_breck_down=="")
			{
				///alert($('#unitcharge_'+i).val())

				color_breck_down=$('#gmtscolorid_'+i).val()+'_'+unitcharge+'_'+coversionchargelibraryid;
			}
			else
			{
				color_breck_down+="__"+$('#gmtscolorid_'+i).val()+'_'+unitcharge+'_'+coversionchargelibraryid;
			}

			if(coversionchargelibraryid_baeck_down=="")
			{
				coversionchargelibraryid_baeck_down=$('#coversionchargelibraryid_'+i).val()
			}
			else
			{
				coversionchargelibraryid_baeck_down+="_"+$('#coversionchargelibraryid_'+i).val();
			}
		}
		//alert()
		document.getElementById('color_breck_down').value=color_breck_down;
		document.getElementById('chargelibid_breck_down').value=coversionchargelibraryid_baeck_down;

		parent.emailwindow.hide();
	}

function claculate_avg()
{
	var significant_row=0;
	var total_value=0;
	var rowCount = $('#tbl_color_details tr').length-3;
	for(var i=1; i<=rowCount; i++)
	{
		if(document.getElementById('unitcharge_'+i).value =='' || document.getElementById('unitcharge_'+i).value ==0)
		{
			continue;
		}
		else
		{
			significant_row=significant_row+1;
			total_value+=(document.getElementById('unitcharge_'+i).value)*1
		}

	}
	var avg_total_value=total_value/significant_row;
	document.getElementById('total_value').value=total_value
	document.getElementById('avg_total_value').value=number_format_common(avg_total_value, 1, 0);
}



    </script>

</head>

<body>

<form id="contrastcolor_1" autocomplete="off">
            <input type="hidden" id="color_breck_down" />
            <input type="hidden" id="chargelibid_breck_down" />
             <input type="hidden" id="cbo_company_name" value="<? echo $cbo_company_name;?>" />
              <input type="hidden" id="cbotypeconversion" value="<? echo $cbotypeconversion;?>" />
               <input type="hidden" id="txt_exchange_rate" value="<? echo $txt_exchange_rate;?>" />
               <input type="hidden" id="cbo_currercy" value="<? echo $cbo_currercy;?>" />
            <table width="300" cellspacing="0" class="rpt_table" border="0" id="tbl_color_details" rules="all">
<thead>
    <tr>
        <th width="30">Sl</th><th width="120">Color</th><th>Charge/Unit</th>
    </tr>
    </thead>
    <tbody>
    <?
	$data_array=explode("__",$colorbreakdown);
	if($data_array[0]=="")
	{
		$data_array=array();
	}
	$color_library=return_library_array("select id,color_name from lib_color where status_active=1 and is_deleted=0","id","color_name");
	if ( count($data_array)>0)
	{
		$i=0;
		$total_value=0;
		foreach( $data_array as $row )
		{
			$i++;
			$data=explode('_',$row);
			$total_value+=$data[1];
		?>
		<tr>
			<td><? echo $i; ?></td>
			<td>
            <input type="hidden" id="gmtscolorid_<? echo $i;?>"   name="gmtscolorid_<? echo $i;?>" style="width:50px"  class="text_boxes"   value="<? echo $data[0]; ?>"  readonly/>
			<input type="text" id="gmtscolor_<? echo $i;?>"   name="gmtscolor_<? echo $i;?>" style="width:120px"  class="text_boxes"   value="<? echo $color_library[$data[0]]; ?>"  readonly/>
            </td>
			<td><input type="text" id="unitcharge_<? echo $i;?>"   name="unitcharge_<? echo $i;?>" value="<? echo $data[1]; ?>"  onChange="claculate_avg()" onClick="set_conversion_charge_unit(<? echo $i; ?>,<? echo $conversion_from_chart; ?>)" style="width:150px"  class="text_boxes_numeric"/>
            <input type="hidden" id="coversionchargelibraryid_<? echo $i;?>"   name="coversionchargelibraryid_<? echo $i;?>" value="<? echo $data[2]; ?>"  readonly/>
            </td>
		</tr>
        <?
		}
	}
	else
	{
	if($cbocosthead !=0)
	{
		$color_size_sensitive=return_field_value("color_size_sensitive", "wo_pre_cost_fabric_cost_dtls", "id=$cbocosthead");
		if($color_size_sensitive==1)
		{
			$data_array=sql_select("select distinct a.color_number_id from  wo_po_color_size_breakdown a,wo_pre_cos_fab_co_avg_con_dtls b  where a.id=b.color_size_table_id and b.pre_cost_fabric_cost_dtls_id='$cbocosthead' and a.status_active=1 and  a.is_deleted=0 ");
		}
		if($color_size_sensitive==3)
		{
			//echo "select distinct contrast_color_id from wo_pre_cos_fab_co_color_dtls where pre_cost_fabric_cost_dtls_id='$cbocosthead'";
		 	$data_array=sql_select("select  contrast_color_id as color_number_id from wo_pre_cos_fab_co_color_dtls where pre_cost_fabric_cost_dtls_id='$cbocosthead'");

		}
		if($color_size_sensitive==0)
		{
			$data_array=sql_select("select  color as color_number_id  from wo_pre_cost_fabric_cost_dtls where id='$cbocosthead'");
		}
	$i=0;
	$total_value=0;
	foreach( $data_array as $row )
	{
		$i++;
		$total_value+=$conversion_qnty;
	?>
		<tr>
			<td><? echo $i; ?></td>
			<td>
            <input type="hidden" id="gmtscolorid_<? echo $i;?>"   name="gmtscolorid_<? echo $i;?>" style="width:50px"  class="text_boxes"   value="<? echo $row[csf('color_number_id')]; ?>"  readonly/>
			<input type="text" id="gmtscolor_<? echo $i;?>"   name="gmtscolor_<? echo $i;?>" style="width:120px"  class="text_boxes"   value="<? echo $color_library[$row[csf('color_number_id')]]; ?>"  readonly/>
            </td>
			<td><input type="text" id="unitcharge_<? echo $i;?>"   name="unitcharge_<? echo $i;?>" value="<? echo $conversion_qnty; ?>"  onChange="claculate_avg()" onClick="set_conversion_charge_unit(<? echo $i; ?>,<? echo $conversion_from_chart; ?>)" style="width:150px"  class="text_boxes_numeric"/>
            <input type="hidden" id="coversionchargelibraryid_<? echo $i;?>"   name="coversionchargelibraryid_<? echo $i;?>" value=""  readonly/>
            </td>
		</tr>
    <?
	}
	}
	else
	{
		$color_array=array();
		$color_size_sensitive_array=sql_select("select  id,color_size_sensitive  from wo_pre_cost_fabric_cost_dtls where job_no='".$job_no."' and fabric_source=1");
		foreach( $color_size_sensitive_array as $color_size_sensitive_row )
		{
			if($color_size_sensitive_row[csf('color_size_sensitive')]==1)
			{
				$data_array1=sql_select("select distinct a.color_number_id as color_number_id  from  wo_po_color_size_breakdown a,wo_pre_cos_fab_co_avg_con_dtls b  where a.id=b.color_size_table_id and b.pre_cost_fabric_cost_dtls_id='".$color_size_sensitive_row[csf('id')]."' and a.status_active=1 and  a.is_deleted=0 ");
				foreach( $data_array1 as $row1 )
				{
					if (array_key_exists($row1[csf('color_number_id')], $color_array))
					{
						continue;
					}
					else
					{
						$color_array[$row1[csf('color_number_id')]]=$row1[csf('color_number_id')];
					}
				}


			}
			if($color_size_sensitive_row[csf('color_size_sensitive')]==3)
			{

				$data_array2=sql_select("select  contrast_color_id as color_number_id  from wo_pre_cos_fab_co_color_dtls where pre_cost_fabric_cost_dtls_id='".$color_size_sensitive_row[csf('id')]."'");
				//echo "select  contrast_color_id as color_number_id  from wo_pre_cos_fab_co_color_dtls where id='".$color_size_sensitive_row[csf('id')]."'";
				foreach( $data_array2 as $row2 )
				{
					if (array_key_exists($row2[csf('color_number_id')], $color_array))
					{
						continue;
					}
					else
					{
						$color_array[$row2[csf('color_number_id')]]=$row2[csf('color_number_id')];
					}
				}

			}
			if($color_size_sensitive_row[csf('color_size_sensitive')]==0)
			{
				$data_array3=sql_select("select  color as color_number_id  from wo_pre_cost_fabric_cost_dtls where id='".$color_size_sensitive_row[csf('id')]."'");
				foreach( $data_array3 as $row3 )
				{
					if (array_key_exists($row3[csf('color_number_id')], $color_array))
					{
						continue;
					}
					else
					{
						$color_array[$row3[csf('color_number_id')]]=$row3[csf('color_number_id')];
					}
				}
			}
		}
		$i=0;
		$total_value=0;
		foreach( $color_array as $key=>$value )
		{
			$i++;
			$total_value+=$conversion_qnty;
		?>
        <tr>
			<td><? echo $i; ?></td>
			<td> <input type="hidden" id="gmtscolorid_<? echo $i;?>"   name="gmtscolorid_<? echo $i;?>" style="width:50px"  class="text_boxes"   value="<? echo $value; ?>"  readonly/>
			<input type="text" id="gmtscolor_<? echo $i;?>"   name="gmtscolor_<? echo $i;?>" style="width:120px"  class="text_boxes"   value="<? echo $color_library[$value]; ?>"  readonly/></td>
			<td><input type="text" id="unitcharge_<? echo $i;?>"   name="unitcharge_<? echo $i;?>" style="width:150px" onChange="claculate_avg()" onClick="set_conversion_charge_unit(<? echo $i; ?>,<? echo $conversion_from_chart; ?>)" value="<? echo $conversion_qnty; ?>"  class="text_boxes_numeric"/>
            <input type="hidden" id="coversionchargelibraryid_<? echo $i;?>"   name="coversionchargelibraryid_<? echo $i;?>" value=""  readonly/>
            </td>
		</tr>

        <?
		}
	}
	}
	?>
</tbody>
<tfoot>
<tr>
			<th></th>
			<th>
            Total
			</th>
			<th><input type="text" id="total_value"   name="total_value" style="width:150px" value="<? echo $total_value; ?>"  class="text_boxes_numeric"/></th>
		</tr>
        <tr>
			<th></th>
			<th>
            Avg Total
			</th>
			<th><input type="text" id="avg_total_value"   name="avg_total_value" style="width:150px" value="<? echo def_number_format(($total_value/$i),$cbo_currercy,0); ?>"  class="text_boxes_numeric"/></th>
		</tr>
</tfoot>
</table>
 <table width="300" cellspacing="0" class="" border="0">

                	<tr>
                        <td align="center" height="15" width="100%"> </td>
                    </tr>
                	<tr>
                        <td align="center" width="100%" class="button_container">

						        <input type="button" class="formbutton" value="Close" onClick="js_set_value_color()"/>

                        </td>
                    </tr>
                </table>
</form>
</body>
<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
</html>

    <?
}

/*if($action=="check_is_booking_insert")
{
	//echo $data;
	$fabric_booking_no_sql=sql_select("select distinct booking_no
							FROM
						    wo_booking_dtls
						    WHERE
						    pre_cost_fabric_cost_dtls_id =$data
						    and  	booking_type=1 and  status_active=1 and  is_deleted=0");


	$fabric_booking_no="";
	foreach($fabric_booking_no_sql as $fabric_booking_no_sql_row)
	{
		$fabric_booking_no.=$fabric_booking_no_sql_row[booking_no].",";
	}

	$service_booking_no_sql=sql_select("select distinct booking_no
						FROM
						wo_booking_dtls a, wo_pre_cost_fab_conv_cost_dtls b
						WHERE
						a.pre_cost_fabric_cost_dtls_id =b.id and
						b.fabric_description =$data and
						a.booking_type=3 and  a.status_active=1 and  a.is_deleted=0 and  b.status_active=1 and  b.is_deleted=0");
	$service_booking_no="";
	foreach($service_booking_no_sql as $service_booking_no_sql_row)
	{
		$service_booking_no.=$service_booking_no_sql_row[booking_no].",";
	}

	echo  $fabric_booking_no."_".$service_booking_no;

}*/
if ($action=="show_lab_test_listview")
{
	$data=explode("**",$data);
	$permission=$data[6];
	$approved=return_field_value("approved", "wo_pre_cost_mst", "job_no='$data[0]'");
	$quotation_id=return_field_value("quotation_id", "wo_po_details_master", "job_no='$data[0]'");
	if($approved==3) $approved=1;
	
	if($approved==1)
	{
		$disabled=1; $txt_disabled="disabled";
	}
	else
	{
		$disabled=0; $txt_disabled="";
	}
	//$lab_test_agent;

	?>
	<h3 style="width:530px;" align="left" class="accordion_h">+Lab Test</h3>
	<div id="content_lab_test_cost"  align="left">
	<fieldset style="width:530px;">

	<form id="labtest_6" autocomplete="off">
        <table width="510" cellspacing="0" class="rpt_table" border="0" id="tbl_lab_test_cost" rules="all">
            <thead>
                <tr>
                	<th width="150">Brand Name</th>
                    <th width="60">Rate</th>
                    <th width="100">Status</th>
                     <th width="60">&nbsp;</th>
                </tr>
            </thead>
            <tbody id="lab_tbl_dtls_for">
            <?
            $save_update=1;
            $data_array=sql_select("SELECT id, job_no, brand_name, rate, status_active from  wo_pre_cost_lab_test_dtls where job_no='$data[0]' order by  id");
            //echo "SELECT id, quotation_id, brand_name, rate, status_active from  wo_pre_cost_lab_test_dtls where job_no='$data[0]' order by  id"; die;

            if(count($data_array) == 0)
			{
				//unset($data_array);
				$data_array=sql_select("SELECT id, quotation_id, brand_name, rate, status_active from  wo_pri_quo_lab_test_dtls where quotation_id='$data[1]' order by  id");
				$save_update=0;
			}
			if(count($data_array)<1 && $data[2]==1 && $data[5]==4){
				$data_array=sql_select("select id, cost_sheet_id as quotation_id, 1 as brand_name, sum(lab_amount) as rate from  qc_confirm_dtls where cost_sheet_id='$quotation_id' group by id, cost_sheet_id order by id");
				$save_update=0;
			}


            if (count($data_array)>0)
            {
				$i=0;
				foreach( $data_array as $row )
				{
					$i++;
					?>
					<tr id="labtest_<? echo $i;?>" align="center">
                        <td><?=create_drop_down( "cbobrandname_".$i,150, $lab_test_agent, "", 1, '-Select-', $row[csf("brand_name")],"check_duplicate_brand(".$i.",this.id)",$disabled,"" ); ?></td>
                        <td><input type="text" id="txtrate_<? echo $i; ?>" name="txtrate_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $row[csf("rate")];  ?>" <? echo $txt_disabled; ?> onChange="calculate_lab_test(<?=$i;?>);" /></td>
                        <td><? asort($row_status); echo create_drop_down( "cbolabteststatus_".$i, 100, $row_status,"", 0, "0", $row[csf("status_active")], "set_sum_value( 'txtratelabtest_sum', 'txtrate_', 'tbl_lab_test_cost' );",$disabled,'' );  ?></td>
                        <td>
                            <input type="button" id="increaselabtest_<? echo $i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_lab_test(<?=$i; ?> );" <? if($disabled==0){echo "";}else{echo "disabled";}?> />
                            <input type="button" id="decreaselabtest_<? echo $i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<?=$i; ?> ,'tbl_lab_test_cost',this);" <? if($disabled==0){echo "";}else{echo "disabled";}?> />
                            <input type="hidden" id="updateidlabtest_<? echo $i; ?>" name="updateidlabtest_<? echo $i; ?>"  class="text_boxes" style="width:20px" value="<? echo  $row[csf("id")]; ?>"  />
                        </td>
					</tr>
					<?
				}

            } else{

				$lab_cond=count($lab_test_agent);
				$i=1;
				?>
				<tr id="labtest_<?=$i;?>" align="center">
					<td><?=create_drop_down("cbobrandname_".$i,150, $lab_test_agent,"",1,'-Select-',1,"check_duplicate_brand(".$i.",this.id);",$disabled,"" ); ?></td>
					<td><input type="text" id="txtrate_<?=$i; ?>" name="txtrate_<?=$i; ?>" class="text_boxes_numeric" style="width:60px" value="" <?=$txt_disabled; ?> onChange="calculate_lab_test(<?=$i;?>);" /></td>
					<td><? asort($row_status); echo create_drop_down( "cbolabteststatus_".$i, 100, $row_status,"", 0, "0", "", "set_sum_value( 'txtratelabtest_sum', 'txtrate_', 'tbl_lab_test_cost' );",$disabled,'' );  ?></td>
					<td>
						<input type="button" id="increaselabtest_<?=$i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_lab_test(<?=$i; ?>);" <? if($disabled==0){echo "";}else{echo "disabled";}?> />
						<input type="button" id="decreaselabtest_<?=$i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<?=$i; ?> ,'tbl_lab_test_cost',this);"  <? if($disabled==0){echo "";}else{echo "disabled";}?> />
						<input type="hidden" id="updateidlabtest_<?=$i; ?>" name="updateidlabtest_<?=$i; ?>"  class="text_boxes" style="width:20px" value=""  />
					</td>
				</tr>
				<?
			}
            ?>
            </tbody>
        </table>
        <table width="510" cellspacing="0" class="rpt_table" border="0" rules="all">
            <tfoot>
                <tr>
                    <td width="150" align="right">Sum</td>
                    <td width="60" align="center">
                    <input type="text" id="txtratelabtest_sum" name="txtratelabtest_sum" class="text_boxes_numeric"  readonly style="width: 60px;" />
                     </td>
                     <td width="100">&nbsp;</td>
                     <td width="60">&nbsp;</td>
                </tr>
            </tfoot>
        </table>

        <table width="510" cellspacing="0" class="" border="0">
            <tr>
                <td align="center" width="100%" class="button_container"> 
                <?
                	//echo count($data_array); die;
					if ( count($data_array)>0)
					{
						//echo load_submit_buttons( $permission, "fnc_lab_test_dtls", $save_update,0,"reset_form('labtest_6','','',0)",6) ;
						 echo load_submit_buttons($permission, "fnc_lab_test_dtls", $save_update, 0, "fnc_resetfrom_lab()", 6);
					}
					else
					{
						echo load_submit_buttons( $permission, "fnc_lab_test_dtls", $save_update,0,"fnc_resetfrom_lab()",6) ;
					}
					exit;
                ?>
                </td>
            </tr>
        </table>
	</form>
	</fieldset>
	</div>
	<?
	exit();
}

if ($action=="save_update_delete_lab_test")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if($update_id){
		$approved=0;
		$sql=sql_select("select approved from wo_pre_cost_mst where job_no='$update_id'");
		foreach($sql as $row){
		$approved=$row[csf('approved')];
		}
		if($approved==1){
		echo "approved**".str_replace("'","",$update_id);
		 disconnect($con);die;
		}
	}
	if($operation==0)
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		//echo $_SESSION['menu_id']; die;
		 if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0";  disconnect($con);die;}
		 $id=return_next_id( "id", "wo_pre_cost_lab_test_dtls", 1 ) ;
		 $field_array="id, job_id, job_no, brand_name, rate, status_active,inserted_by,insert_date";
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cbobrandname="cbobrandname_".$i;
			 $rate="txtrate_".$i;
			 $status="cbolabteststatus_".$i;
			 $updateidlabtest="updateidlabtest_".$i;
			 if ($i!=1) $data_array .=",";
			 $data_array .="(".$id.",".$hidd_job_id.",'".$update_id."',".$$cbobrandname.",".$$rate.",".$$status.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."')";
			 $id=$id+1;
		 }
		 //echo "10**INSERT INTO wo_pre_cost_lab_test_dtls (".$field_array.") VALUES ".$data_array.""; die;
		 $rID=sql_insert("wo_pre_cost_lab_test_dtls",$field_array,$data_array,0);

		 //=======================sum=================
		$wo_pre_cost_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_dtls where job_no ='$update_id'";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_dtls_job_no=="")
		{
			$wo_pre_cost_dtls_id=return_next_id( "id", "wo_pre_cost_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, lab_test, lab_test_percent";
			$data_array2="(".$wo_pre_cost_dtls_id.",".$hidd_job_id.",".$update_id.",".$rate.",".$lab_test_percent.")";
			$rID2=sql_insert("wo_pre_cost_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_dtls_job_no!="")
		{
			//$wo_pre_cost_dtls_id=return_next_id( "id", "wo_pre_cost_dtls", 1 ) ;
			$field_array2="lab_test*lab_test_percent";
			$data_array2="(".$rate."*".$lab_test_percent.")";
			$rID2=sql_update("wo_pre_cost_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		//=======================sum End =================
		 check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "0**".$update_id."**".$rID;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$update_id."**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "0**".$update_id."**".$rID;
			}
			else{
				oci_rollback($con);
				echo "10**".$update_id."**".$rID;
			}
		}
		disconnect($con);
		die;
	}
	else if($operation==1)
	{
		$con = connect();
 		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		 if( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**1";  disconnect($con);die;}
 		 $field_array_up="job_no*brand_name*rate*status_active*updated_by*update_date";
		 $field_array="id, job_id, job_no, brand_name, rate, status_active, inserted_by, insert_date";

		 $add_co=0;
		 $id=return_next_id( "id","wo_pre_cost_lab_test_dtls", 1 );
		 $previous_lab_test_sql="SELECT id from wo_pre_cost_lab_test_dtls where job_no='".$update_id."' and status_active=1";
		 foreach(sql_select( $previous_lab_test_sql) as $vals)
		 {
		 	$previous_lab_test_arr[$vals[csf("id")]]=$vals[csf("id")];
		 }

		 $col_lab=0;

		 for ($i=1;$i<=$total_row;$i++)
		 {
		 	$cbobrandname="cbobrandname_".$i;
		 	$rate="txtrate_".$i;
		 	$status="cbolabteststatus_".$i;
		 	$updateidlabtest="updateidlabtest_".$i;
			if(str_replace("'",'',$$updateidlabtest)!="")
			{
				if( in_array( str_replace("'",'',$$updateidlabtest) ,$previous_lab_test_arr))
				{
					unset($previous_lab_test_arr[str_replace("'",'',$$updateidlabtest)]);
				}
                $id_arr[]=str_replace("'",'',$$updateidlabtest);
				$data_array_up[str_replace("'",'',$$updateidlabtest)] =explode(",",("'".$update_id."',".$$cbobrandname.",".$$rate.",".$$status.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."'"));
			}
			if(str_replace("'",'',$$updateidlabtest)=="")
			{
				if ($data_array) $data_array .=",";
				$data_array .="(".$id.",".$hidd_job_id.",'".$update_id."',".$$cbobrandname.",".$$rate.",".$$status.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."')";
			   $id=$id+1;
			   $col_lab++;

			}
		 }
		 $previous_lab_test_ids=implode(",", $previous_lab_test_arr);
		 //echo $previous_lab_test_ids; die;
		 $delete_lab_test=execute_query("delete from wo_pre_cost_lab_test_dtls where id in( $previous_lab_test_ids)");
		 //var_dump($data_array_up); die;
 		 $rID_up=execute_query(bulk_update_sql_statement( "wo_pre_cost_lab_test_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
		 if($data_array !="")
		 {
		  $rID=sql_insert("wo_pre_cost_lab_test_dtls",$field_array,$data_array,0);
		 }
		  //=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no ='".$update_id."'";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id,job_id,job_no,lab_test,lab_test_percent";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$rate.",".$lab_test_percent.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="lab_test*lab_test_percent";
			$data_array2="(".$rate."*".$lab_test_percent.")";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		//=======================sum End =================
 		 check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{

			if($rID_up ){
				mysql_query("COMMIT");
				echo "1**".$update_id."**".$rID_up;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$update_id."**".$rID_up;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID_up ){
				oci_commit($con);
				echo "1**".$update_id."**".$rID_up;
			}
			else{
				oci_rollback($con);
				echo "10**".$update_id."**".$rID_up;
			}
		}
		disconnect($con);
		die;
	}
}

if($action=="delete_row_fabric_cost")
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}

	$sql_quo_fab_dtls_del="insert into wo_pre_cost_fabric_dtls_del( id, job_id, job_no, item_number_id, body_part_id, fab_nature_id, color_type_id, lib_yarn_count_deter_id, construction, composition, fabric_description, gsm_weight, color_size_sensitive, color, avg_cons, fabric_source, rate, amount, avg_finish_cons, avg_process_loss, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, company_id, costing_per, consumption_basis, process_loss_method, cons_breack_down, msmnt_break_down, color_break_down, yarn_breack_down, marker_break_down, width_dia_type, avg_cons_yarn, gsm_weight_yarn, plan_cut_qty, job_plan_cut_qty, is_apply_last_update, uom, body_part_type, deleted_by, delete_date)
select
	id, job_id, job_no, item_number_id, body_part_id, fab_nature_id, color_type_id, lib_yarn_count_deter_id, construction, composition, fabric_description, gsm_weight, color_size_sensitive, color, avg_cons, fabric_source, rate, amount, avg_finish_cons, avg_process_loss, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, company_id, costing_per, consumption_basis, process_loss_method, cons_breack_down, msmnt_break_down, color_break_down, yarn_breack_down, marker_break_down, width_dia_type, avg_cons_yarn, gsm_weight_yarn, plan_cut_qty, job_plan_cut_qty, is_apply_last_update, uom, body_part_type, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."' from wo_pre_cost_fabric_cost_dtls where id=".$data."";

	$rID_de1=execute_query($sql_quo_fab_dtls_del,0);

	$sql_quo_yarn_dtls_del="insert into wo_pre_cost_fab_yarn_dtls_del( id, job_id, fabric_cost_dtls_id, job_no, count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, cons_ratio, cons_qnty, rate, amount, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, avg_cons_qnty, supplier_id, color, deleted_by, delete_date)
select
	id, job_id, fabric_cost_dtls_id, job_no, count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, cons_ratio, cons_qnty, rate, amount, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, avg_cons_qnty, supplier_id, color, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."' from wo_pre_cost_fab_yarn_cost_dtls where fabric_cost_dtls_id=".$data."";

	$rID_de1=execute_query($sql_quo_yarn_dtls_del,0);

	$sql_quo_conv_dtls_del="insert into wo_pre_cost_fab_conv_dtls_del( id, job_id, job_no, fabric_description, cons_process, req_qnty, charge_unit, amount, color_break_down, charge_lib_id, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, avg_req_qnty, process_loss, deleted_by, delete_date)
select
	id, job_id, job_no, fabric_description, cons_process, req_qnty, charge_unit, amount, color_break_down, charge_lib_id, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, avg_req_qnty, process_loss, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."' from wo_pre_cost_fab_conv_cost_dtls where fabric_description=".$data."";

	$rID_de1=execute_query($sql_quo_conv_dtls_del,0);

	/*$rID_de1=execute_query( "delete from  wo_pre_cost_fabric_cost_dtls where  id =".$data."",0);
	$rID_de1=execute_query( "delete from  wo_pre_cos_fab_co_avg_con_dtls where  pre_cost_fabric_cost_dtls_id =".$data."",0);
	$rID_de1=execute_query( "delete from  wo_pre_cos_fab_co_color_dtls where  pre_cost_fabric_cost_dtls_id =".$data."",0);
	$rID_de1=execute_query( "delete from  wo_pre_cost_fab_yarn_cost_dtls where  fabric_cost_dtls_id =".$data."",0);
	$rID_de1=execute_query( "delete from  wo_pre_cost_fab_yarnbreakdown where  fabric_cost_dtls_id =".$data."",0);
	$rID_de1=execute_query( "delete from  wo_pre_cost_fab_conv_cost_dtls where  fabric_description =".$data."",0);
	if($db_type==0)
	{
		if($rID_de1) mysql_query("COMMIT"); else mysql_query("ROLLBACK");
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($rID_de1) oci_commit($con); else oci_rollback($con);
	}*/
	$flag=1;
	
	$rID=execute_query( "update wo_pre_cost_fabric_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1  where id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID==1 && $flag==1) $flag=1; else $flag=0;
	
	$rID0=execute_query( "update wo_pre_cos_fab_co_avg_con_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", status_active=0, is_deleted=1 where pre_cost_fabric_cost_dtls_id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID0==1 && $flag==1) $flag=1; else $flag=0;
	
	$rID1=execute_query( "update wo_pre_cos_fab_co_color_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where pre_cost_fabric_cost_dtls_id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID1==1 && $flag==1) $flag=1; else $flag=0;
	
	$rID2=execute_query( "update wo_pre_cost_fab_yarn_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where fabric_cost_dtls_id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID2==1 && $flag==1) $flag=1; else $flag=0;
	
	$rID3=execute_query( "update wo_pre_cost_fab_yarnbreakdown set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where fabric_cost_dtls_id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID3==1 && $flag==1) $flag=1; else $flag=0;
	
	$rID4=execute_query( "update wo_pre_cost_fab_conv_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where fabric_description ='$data' and status_active=1 and is_deleted=0",1);
	if($rID4==1 && $flag==1) $flag=1; else $flag=0;

	$rID5=execute_query( "update wo_pre_stripe_color set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where pre_cost_fabric_cost_dtls_id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID5==1 && $flag==1) $flag=1; else $flag=0;

	if($db_type==0)
	{
		if($flag==1) mysql_query("COMMIT"); else mysql_query("ROLLBACK");
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($flag==1) oci_commit($con); else oci_rollback($con);
	}
	disconnect($con);
}

if($action=="delete_row_yarn_cost")
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}

	$sql_quo_yarn_dtls_del="insert into wo_pre_cost_fab_yarn_dtls_del( id, job_id, fabric_cost_dtls_id, job_no, count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, cons_ratio, cons_qnty, rate, amount, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, avg_cons_qnty, supplier_id, color, deleted_by, delete_date)
select
	id, job_id, fabric_cost_dtls_id, job_no, count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, cons_ratio, cons_qnty, rate, amount, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, avg_cons_qnty, supplier_id, color, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."' from wo_pre_cost_fab_yarn_cost_dtls where id=".$data."";

	$rID_de1=execute_query($sql_quo_yarn_dtls_del,0);

//	$rID_de1=execute_query( "delete from  wo_pre_cost_fab_yarn_cost_dtls where  id =".$data."",0);
	$flag=1;
	$rID2=execute_query( "update wo_pre_cost_fab_yarn_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID2==1 && $flag==1) $flag=1; else $flag=0;
	if($db_type==0)
	{
		if($flag==1) mysql_query("COMMIT"); else mysql_query("ROLLBACK");
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($flag==1) oci_commit($con); else oci_rollback($con);
	}
	disconnect($con);
}

if($action=="conversion_from_chart")
{
	$conversion_from_chart=return_field_value("conversion_from_chart", "variable_order_tracking", "company_name='$data'  and variable_list=21 and status_active=1 and is_deleted=0");
	if($conversion_from_chart=="")
	{
		$conversion_from_chart=2;
	}
	echo trim($conversion_from_chart);
}

if($action=="delete_row_conversion_cost")
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}

	$sql_quo_conv_dtls_del="insert into wo_pre_cost_fab_conv_dtls_del( id, job_id, job_no, fabric_description, cons_process, req_qnty, charge_unit, amount, color_break_down, charge_lib_id, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, avg_req_qnty, process_loss, deleted_by, delete_date)
select
	id, job_id, job_no, fabric_description, cons_process, req_qnty, charge_unit, amount, color_break_down, charge_lib_id, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, avg_req_qnty, process_loss, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."' from wo_pre_cost_fab_conv_cost_dtls where id=".$data."";

	$rID_de1=execute_query($sql_quo_conv_dtls_del,0);

	//$rID_de1=execute_query( "delete from  wo_pre_cost_fab_conv_cost_dtls where  id =".$data."",0);
	$flag=1;
	$rID4=execute_query( "update wo_pre_cost_fab_conv_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where id ='$data' and status_active=1 and is_deleted=0",1);
	
	$rID5=execute_query( "update wo_pre_cos_conv_color_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where conv_cost_dtls_id='$data' and status_active=1 and is_deleted=0",1);
	
	if($rID4==1 && $flag==1) $flag=1; else $flag=0;
	if($db_type==0)
	{
		if($flag==1) mysql_query("COMMIT");  else mysql_query("ROLLBACK");
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($flag==1) oci_commit($con); else oci_rollback($con);
	}
	disconnect($con);
}

if($action=="check_available_booking")
{
	$exdata=explode("__",$data);
	if (is_duplicate_field( "pre_cost_fabric_cost_dtls_id", "wo_booking_dtls", "pre_cost_fabric_cost_dtls_id='$exdata[0]' and booking_type='$exdata[1]' and is_deleted=0 and status_active=1" ) == 1)
	{
		echo "11"; die;
	}
}

if($action=="delete_row_trim_cost")
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}
	if (is_duplicate_field( "pre_cost_fabric_cost_dtls_id", "wo_booking_dtls", "pre_cost_fabric_cost_dtls_id=$data and booking_type=2 and is_deleted=0 and status_active=1" ) == 1)
	{
		echo "11"; die;
	}

	$sql_quo_trim_dtls_del="insert into wo_pre_cost_trim_dtls_del( id, job_id, job_no, trim_group, description, brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, cons_breack_down, remark, country, calculatorstring, unit_price, inco_term, add_price, seq, deleted_by, delete_date)
select
	id, job_id, job_no, trim_group, description, brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, cons_breack_down, remark, country, calculatorstring, unit_price, inco_term, add_price, seq, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."' from wo_pre_cost_trim_cost_dtls where id=".$data."";

	$rID_de1=execute_query($sql_quo_trim_dtls_del,0);

	//$rID_de1=execute_query( "delete from  wo_pre_cost_trim_cost_dtls where  id =".$data."",0);
//	$rID_de1=execute_query( "delete from  wo_pre_cost_trim_co_cons_dtls where  wo_pre_cost_trim_cost_dtls_id =".$data."",0);
	$flag=1;
	$rID5=execute_query( "update wo_pre_cost_trim_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID5==1 && $flag==1) $flag=1; else $flag=0;
	
	$rID6=execute_query( "update wo_pre_cost_trim_co_cons_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where wo_pre_cost_trim_cost_dtls_id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID6==1 && $flag==1) $flag=1; else $flag=0;
	if($db_type==0)
	{
		if($flag==1) mysql_query("COMMIT"); else mysql_query("ROLLBACK");
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($flag==1) oci_commit($con); else oci_rollback($con);
	}
	disconnect($con);
}
if($action=="delete_row_lab_cost")
{
	$con = connect();
	$data_arr=explode("***", $data);
	if (is_duplicate_field( "JOB_NO", "wo_labtest_dtls", "JOB_NO=$data_arr[1] and is_deleted=0 and status_active=1" ) == 1)
	{
		echo "11"; die;
	}
	$rID_de1=execute_query("Update wo_pre_cost_lab_test_dtls set is_deleted=1 , status_active=0 where  id =".$data_arr[0]."",0);
	if($rID_de1) oci_commit($con); else oci_rollback($con);
	disconnect($con);
}

if($action=="delete_row_embellishment_cost")
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}

	$sql_quo_emb_dtls_del="insert into wo_pre_cost_embe_dtls_del( id, job_id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount, charge_lib_id, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, budget_on, supplier_id, country, deleted_by, delete_date)
select
	id, job_id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount, charge_lib_id, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, budget_on, supplier_id, country, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."' from wo_pre_cost_embe_cost_dtls where id=".$data."";

	$rID_de1=execute_query($sql_quo_emb_dtls_del,0);

	//$rID_de1=execute_query( "delete from  wo_pre_cost_embe_cost_dtls where  id =".$data."",0);
	$flag=1;
	$rID7=execute_query( "update wo_pre_cost_embe_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID7==1 && $flag==1) $flag=1; else $flag=0;
	
	$rID8=execute_query( "update wo_pre_cos_emb_co_avg_con_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where pre_cost_emb_cost_dtls_id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID8==1 && $flag==1) $flag=1; else $flag=0;
	if($db_type==0)
	{
		if($flag==1) mysql_query("COMMIT"); else mysql_query("ROLLBACK");
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($flag==1) oci_commit($con); else oci_rollback($con);
	}
	disconnect($con);
}

if($action=="delete_row_wash_cost")
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}
	$sql_quo_wash_dtls_del="insert into wo_pre_cost_embe_dtls_del( id, job_id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount, charge_lib_id, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, budget_on, supplier_id, country, deleted_by, delete_date)
select
	id, job_id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount, charge_lib_id, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, budget_on, supplier_id, country, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."' from wo_pre_cost_embe_cost_dtls where id=".$data."";

	$rID_de1=execute_query($sql_quo_wash_dtls_del,0);
	//$rID_de1=execute_query("delete from  wo_pre_cost_embe_cost_dtls where  id =".$data."",0);
	$flag=1;
	$rID7=execute_query( "update wo_pre_cost_embe_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID7==1 && $flag==1) $flag=1; else $flag=0;
	
	$rID8=execute_query( "update wo_pre_cos_emb_co_avg_con_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where pre_cost_emb_cost_dtls_id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID8==1 && $flag==1) $flag=1; else $flag=0;
	
	if($db_type==0)
	{
		if($flag==1) mysql_query("COMMIT"); else mysql_query("ROLLBACK");
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($flag==1) oci_commit($con); else oci_rollback($con);
	}
	disconnect($con);
}
if($action=="delete_row_comarcial_cost")
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}

	$sql_quo_coml_dtls_del="insert into wo_pre_cost_comarci_dtls_del( id, job_id, job_no, item_id, rate, amount, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, deleted_by, delete_date)
select
	id, job_id, job_no, item_id, rate, amount, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."' from wo_pre_cost_comarci_cost_dtls where id=".$data."";

	$rID_de1=execute_query($sql_quo_coml_dtls_del,0);

	//$rID_de1=execute_query( "delete from  wo_pre_cost_comarci_cost_dtls where  id =".$data."",0);
	$flag=1;
	$rID9=execute_query( "update wo_pre_cost_comarci_cost_dtls set updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."', status_active=0, is_deleted=1 where id ='$data' and status_active=1 and is_deleted=0",1);
	if($rID9==1 && $flag==1) $flag=1; else $flag=0;
	
	if($db_type==0)
	{
		if($flag==1) mysql_query("COMMIT"); else mysql_query("ROLLBACK");
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($flag==1) oci_commit($con); else oci_rollback($con);
	}
	disconnect($con);
}

if ($action=="save_update_delet_fabric_cost_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$con = connect();
	$sql=sql_select("select approval_need from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
	$app_nessity=2;
	foreach($sql as $row){
		$app_nessity=$row[csf('approval_need')];
	}

	$sql=sql_select("select approved from wo_price_quotation  where id=$txt_quotation_id");
	$quatation_approved=2;
	foreach($sql as $row){
		$quatation_approved=$row[csf('approved')];
	}

	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	//echo "10**",$is_copy_quatation."**". $app_nessity."**".$quatation_approved;
	//die;
	if($is_copy_quatation==1 && $app_nessity==1){
		if($quatation_approved==2 || $quatation_approved==0){
			echo "quataNotApp**".str_replace("'","",$txt_job_no);
			 disconnect($con);die;
		}
	}
	
	$component_approved=return_field_value("current_approval_status", "co_com_pre_costing_approval", "job_no=$update_id and cost_component_id=1");
	if($component_approved==3){
		$component_approved=1;
	}
	
	$approved=0; $ready_to_approve=0;
	$sql=sql_select("select approved, ready_to_approved from wo_pre_cost_mst where job_no=$update_id and status_active=1 and is_deleted=0");
	foreach($sql as $row){
		//if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
		$approved=$row[csf('approved')];
		$ready_to_approve=$row[csf('ready_to_approved')];
	}
	if($approved==1 || $component_approved==1){
		echo "approved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($approved==3){
		echo "papproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	
	if($ready_to_approve==1){
		echo "readyapproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	$stripeColorArr=array(); $new_array_color=array();
	for ($i=1; $i<=$total_row; $i++)
	{
		$txtcolor="txtcolor_".$i;
		$cbocolorsizesensitive="cbocolorsizesensitive_".$i;
		$colorbreackdown="colorbreackdown_".$i;
		
		if(str_replace("'",'',$$colorbreackdown)!="")
		{
			$colorbreckdown_array=explode('__',str_replace("'",'',$$colorbreackdown));
			for($c=0; $c < count($colorbreckdown_array); $c++)
			{
				$counter++;
				$colorbreckdownarr=explode('_',$colorbreckdown_array[$c]);
				if(str_replace("'","",$colorbreckdownarr[2])=='0') $colorbreckdownarr[2]="";
				if(str_replace("'","",$colorbreckdownarr[2])!="")
				{
					$fab_colorName=str_replace("'","",$colorbreckdownarr[2]);
					//$fab_colorName="'".trim($fab_colorName)."'";
					//echo $colorbreckdownarr[2].'<br>';
					if(str_replace("'","",$colorbreckdownarr[2])!="")
					{
						if (!in_array(str_replace("'","",$colorbreckdownarr[2]),$new_array_color, TRUE))
						{
							 $color_id = return_id( str_replace("'","",$colorbreckdownarr[2]), $color_library, "lib_color", "id,color_name","425");
							 $new_array_color[$color_id]=str_replace("'","",$colorbreckdownarr[2]);
							 $stripeColorArr[trim($colorbreckdownarr[2])]=$color_id;
						}
						else 
						{
							$color_id =  array_search(str_replace("'","",$colorbreckdownarr[2]), $new_array_color);
							$stripeColorArr[trim($colorbreckdownarr[2])]=$color_id;
						}
					}
					else $color_id=0;
					$stripeColorArr[trim($colorbreckdownarr[2])]=$color_id;
				}
			}
		}
	}
	disconnect($con);
	
	//die;

	if($operation==0)
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		
		if ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0"; disconnect($con);; die;}
		
		$field_array="id, job_id, job_no, seq, item_number_id, body_part_id, fab_nature_id, color_type_id, lib_yarn_count_deter_id, construction, composition, fabric_description, gsm_weight, gsm_weight_type, color_size_sensitive, avg_cons, fabric_source, nominated_supp_multi, rate, amount, avg_finish_cons, avg_process_loss, inserted_by, insert_date, status_active, is_deleted, company_id, costing_per, consumption_basis, process_loss_method, cons_breack_down, msmnt_break_down, color_break_down, yarn_breack_down, marker_break_down, width_dia_type, avg_cons_yarn, gsm_weight_yarn, plan_cut_qty, job_plan_cut_qty, uom, body_part_type, quotdtlsid, budget_on, source_id,remarks";

		$field_array1="id, job_id, pre_cost_fabric_cost_dtls_id, job_no, po_break_down_id, color_number_id, gmts_sizes, dia_width, item_size, cons, process_loss_percent, requirment, pcs, color_size_table_id, rate, amount, remarks, body_length, body_sewing_margin, body_hem_margin, sleeve_length, sleeve_sewing_margin, sleeve_hem_margin, half_chest_length, half_chest_sewing_margin, front_rise_length, front_rise_sewing_margin, west_band_length, west_band_sewing_margin, in_seam_length, in_seam_sewing_margin, in_seam_hem_margin, half_thai_length, half_thai_sewing_margin, total, marker_dia, marker_yds, marker_inch, gmts_pcs, marker_length, net_fab_cons, fina_char, inserted_by, insert_date, status_active, is_deleted";

		$field_array2="id, job_id, pre_cost_fabric_cost_dtls_id, job_no, gmts_color_id, gmts_color, contrast_color_id";
		$field_supp_arr="id, job_id, job_no, fabric_id, supplier_id, inserted_by, insert_date, status_active, is_deleted";

		$id=return_next_id( "id", "wo_pre_cost_fabric_cost_dtls", 1);
		$id1=return_next_id( "id", "wo_pre_cos_fab_co_avg_con_dtls", 1);
		$idfabric=return_next_id( "id", "wo_pre_cost_fabric_supplier", 1);
		$wo_pre_cos_fab_co_color_dtls_id=return_next_id( "id", "wo_pre_cos_fab_co_color_dtls", 1);
		$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1);
		
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id and status_active=1";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		
		$data_array=""; $rIDsupp=1; $rID=1; $rID1=1; $rID_id5=1; $flag=1;
		for ($i=1;$i<=$total_row;$i++)
		{
			$seq="seq_".$i;
			$cbogmtsitem="cbogmtsitem_".$i;
			$txtbodypart="txtbodypart_".$i;
			$cbofabricnature="cbofabricnature_".$i;
			$cbocolortype="cbocolortype_".$i;
			$libyarncountdeterminationid="libyarncountdeterminationid_".$i;
			$construction="construction_".$i;
			$composition="composition_".$i;
			$fabricdescription="fabricdescription_".$i;
			$txtgsmweight="txtgsmweight_".$i;
			$txtgsmweighttype="txtgsmweighttype_".$i;
			$cbocolorsizesensitive="cbocolorsizesensitive_".$i;
			$txtcolor="txtcolor_".$i;
			$txtconsumption="txtconsumption_".$i;
			$cbofabricsource="cbofabricsource_".$i;
			$cbonominasupplier="cbonominasupplier_".$i;
			$txtrate="txtrate_".$i;
			$txtamount="txtamount_".$i;
			$txtfinishconsumption="txtfinishconsumption_".$i;
			$txtavgprocessloss="txtavgprocessloss_".$i;
			//$cbostatus="cbostatus_".$i;
			$consbreckdown="consbreckdown_".$i;
			$msmntbreackdown="msmntbreackdown_".$i;
			$processlossmethod="processlossmethod_".$i;
			$colorbreackdown="colorbreackdown_".$i;
			$yarnbreackdown="yarnbreackdown_".$i;
			$consumptionbasis="consumptionbasis_".$i;
			$markerbreackdown="markerbreackdown_".$i;
            $cbowidthdiatype="cbowidthdiatype_".$i;
			$avgtxtconsumption="avgtxtconsumption_".$i;
			$avgtxtgsmweight="avgtxtgsmweight_".$i;
			$plancutqty="plancutqty_".$i;
			$jobplancutqty="jobplancutqty_".$i;
			$uom="uom_".$i;
			$txtbodyparttype="txtbodyparttype_".$i;
			$prifabcostdtlsid="prifabcostdtlsid_".$i;
			$budget_on="budgeton_".$i;
			$source_id="cbomsource_".$i;
			$remark="remark_".$i;
			$remark_pre=str_replace("'","",$$remark);
			$remark_str=special_chars_clean($remark_pre);
			
			$cons_breckdown=substr(str_replace("'","",$$consbreckdown),0,100);
			
			$data_array.="INTO wo_pre_cost_fabric_cost_dtls (".$field_array.") VALUES(".$id.",".$hidd_job_id.",".$update_id.",".$$seq.",".$$cbogmtsitem.",".$$txtbodypart.",".$$cbofabricnature.",".$$cbocolortype.",".$$libyarncountdeterminationid.",".$$construction.",".$$composition.",".$$fabricdescription.",".$$txtgsmweight.",".$$txtgsmweighttype.",".$$cbocolorsizesensitive.",".$$txtconsumption.",".$$cbofabricsource.",".$$cbonominasupplier.",".$$txtrate.",".$$txtamount.",".$$txtfinishconsumption.",".$$txtavgprocessloss.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0,".$cbo_company_name.",".$cbo_costing_per.",".$$consumptionbasis.",".$$processlossmethod.",'".$cons_breckdown."',".$$msmntbreackdown.",".$$colorbreackdown.",".$$yarnbreackdown.",".$$markerbreackdown.",".$$cbowidthdiatype.",".$$avgtxtconsumption.",".$$avgtxtgsmweight.",".$$plancutqty.",".$$jobplancutqty.",".$$uom.",".$$txtbodyparttype.",".$$prifabcostdtlsid.",".$$budget_on.",".$$source_id.",'".$remark_str."')";

			$cbonominasupplier=explode(",",str_replace("'",'',$$cbonominasupplier));
			foreach($cbonominasupplier as $sid)
			{
				if($sid>0)
				{
					$dataSuppArr="";
					$dataSuppArr="INSERT INTO wo_pre_cost_fabric_supplier (".$field_supp_arr.") VALUES(".$idfabric.",".$hidd_job_id.",".$update_id.",'".$id."','".$sid."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
					$idfabric++;
					
					$rIDsupp=execute_query($dataSuppArr);
					if ($rIDsupp==1 && $flag==1) { $flag=1; }
					else { echo "10**fabSupp-".$dataSuppArr; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
				}
			}

			//	msmnt break down===============================================================================================
			$consbreckdown_array=explode('__',str_replace("'",'',$$consbreckdown));
			$msmntbreackdown_array=explode('__',str_replace("'",'',$$msmntbreackdown));
			$markerbreackdownarr=explode('_',str_replace("'",'',$$markerbreackdown));
			$counter=0;
			for($c=0; $c < count($consbreckdown_array); $c++)
			{
				$counter++;
				$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
				$msmntbreackdownarr=explode('_',$msmntbreackdown_array[$c]);
				$consbreckdownarr[3]=strtoupper($consbreckdownarr[3]);
				$str_rep=array("+", "&", "*", "(", ")", "=","'","\r", "\n",'"','#');
				$data_array1="";
				if(str_replace("'",'',$$txtbodypart)*1==1)
				{
					$data_array1="INSERT INTO wo_pre_cos_fab_co_avg_con_dtls (".$field_array1.") VALUES(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".$consbreckdownarr[10]."','".$consbreckdownarr[11]."','".$consbreckdownarr[12]."','".$msmntbreackdownarr[0]."','".$msmntbreackdownarr[1]."','".$msmntbreackdownarr[2]."','".$msmntbreackdownarr[3]."','".$msmntbreackdownarr[4]."','".$msmntbreackdownarr[5]."','".$msmntbreackdownarr[6]."','".$msmntbreackdownarr[7]."',0,0,0,0,0,0,0,0,0,'".$msmntbreackdownarr[8]."','".$markerbreackdownarr[0]."','".$markerbreackdownarr[1]."','".$markerbreackdownarr[2]."','".$markerbreackdownarr[3]."','".$markerbreackdownarr[4]."','".$markerbreackdownarr[5]."','".$consbreckdownarr[13]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
				}
				else if(str_replace("'",'',$$txtbodypart)*1==20)
				{
					$data_array1="INSERT INTO wo_pre_cos_fab_co_avg_con_dtls (".$field_array1.") VALUES(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".$consbreckdownarr[10]."','".$consbreckdownarr[11]."','".$consbreckdownarr[12]."',0,0,0,0,0,0,0,0,'".$msmntbreackdownarr[0]."','".$msmntbreackdownarr[1]."','".$msmntbreackdownarr[2]."','".$msmntbreackdownarr[3]."','".$msmntbreackdownarr[4]."','".$msmntbreackdownarr[5]."','".$msmntbreackdownarr[6]."','".$msmntbreackdownarr[7]."','".$msmntbreackdownarr[8]."','".$msmntbreackdownarr[9]."','".$markerbreackdownarr[0]."','".$markerbreackdownarr[1]."','".$markerbreackdownarr[2]."','".$markerbreackdownarr[3]."','".$markerbreackdownarr[4]."','".$markerbreackdownarr[5]."','".$consbreckdownarr[13]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
				}
				else
				{
					$data_array1="INSERT INTO wo_pre_cos_fab_co_avg_con_dtls (".$field_array1.") VALUES(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".$consbreckdownarr[10]."','".$consbreckdownarr[11]."','".$consbreckdownarr[12]."',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,'".$markerbreackdownarr[0]."','".$markerbreackdownarr[1]."','".$markerbreackdownarr[2]."','".$markerbreackdownarr[3]."','".$markerbreackdownarr[4]."','".$markerbreackdownarr[5]."','".$consbreckdownarr[13]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
				}

				$id1=$id1+1;
				$rID=execute_query($data_array1);
				if ($rID==1) { $flag=1; }
				else { echo "10**fabcons-".$data_array1; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
			}
			//Msmnt break down end===============================================================================================
			
			// Color break down ==================================================================================================
			if(str_replace("'",'',$$colorbreackdown)!="")
			{
				$colorbreckdown_array=explode('__',str_replace("'",'',$$colorbreackdown));
				for($c=0;$c < count($colorbreckdown_array);$c++)
				{
					$counter++;
					$colorbreckdownarr=explode('_',$colorbreckdown_array[$c]);
					if(str_replace("'","",$colorbreckdownarr[2])=='0') $colorbreckdownarr[2]='';
					
					$stripecolor_id=$stripeColorArr[trim($colorbreckdownarr[2])];
					if($stripecolor_id=="") $stripecolor_id=0;
					
					$data_array5="";
					
					$data_array5="INSERT INTO wo_pre_cos_fab_co_color_dtls (".$field_array2.") VALUES(".$wo_pre_cos_fab_co_color_dtls_id.",".$hidd_job_id.",".$id.",".$update_id.",".$colorbreckdownarr[0].",'".$colorbreckdownarr[1]."','".$stripecolor_id."')";
					$wo_pre_cos_fab_co_color_dtls_id=$wo_pre_cos_fab_co_color_dtls_id+1;
					
					$rID5=execute_query($data_array5);
					if ($rID5==1 && $flag==1) { $flag=1; }
					else { echo "10**coColor-".$data_array5; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
				}
			}//color break down end ===============================================================================================
			$id=$id+1;
		}// end master for loop
		
		$queryfab="INSERT ALL ".$data_array." SELECT * FROM dual";
		$rID1=execute_query($queryfab);
		if($rID1==1 && $flag==1) $flag=1; else $flag=0;
		//=======================sum=================
		
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$field_array5="id, job_id, job_no, fab_yarn_req_kg, fab_woven_req_yds, fab_knit_req_kg, fab_woven_fin_req_yds, fab_knit_fin_req_kg, fab_amount, avg, pro_woven_grey_fab_req_yds, pro_knit_grey_fab_req_kg, pro_woven_fin_fab_req_yds, pro_knit_fin_fab_req_kg, pur_woven_grey_fab_req_yds, pur_knit_grey_fab_req_kg, pur_woven_fin_fab_req_yds, pur_knit_fin_fab_req_kg, woven_amount, knit_amount";
			$data_array5="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$tot_yarn_needed.",".$txtwoven_sum.",".$txtknit_sum.",".$txtwoven_fin_sum.",".$txtknit_fin_sum.",".$txtamount_sum.",".$avg.",".$txtwoven_sum_production.",".$txtknit_sum_production.",".$txtwoven_fin_sum_production.",".$txtknit_fin_sum_production.",".$txtwoven_sum_purchase.",".$txtknit_sum_purchase.",".$txtwoven_fin_sum_purchase.",".$txtknit_fin_sum_purchase.",".$txtwoven_amount_sum_purchase.",".$txtkint_amount_sum_purchase.")";
			$rID_id5=sql_insert("wo_pre_cost_sum_dtls",$field_array5,$data_array5,0);
			if($rID_id5==1 && $flag==1) $flag=1; else $flag=0;
		}

		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			$field_array5="fab_yarn_req_kg*fab_woven_req_yds*fab_knit_req_kg*fab_woven_fin_req_yds*fab_knit_fin_req_kg*fab_amount*avg*pro_woven_grey_fab_req_yds*pro_knit_grey_fab_req_kg*pro_woven_fin_fab_req_yds*pro_knit_fin_fab_req_kg*pur_woven_grey_fab_req_yds*pur_knit_grey_fab_req_kg*pur_woven_fin_fab_req_yds*pur_knit_fin_fab_req_kg*woven_amount*knit_amount";
			$data_array5 ="".$tot_yarn_needed."*".$txtwoven_sum."*".$txtknit_sum."*".$txtwoven_fin_sum."*".$txtknit_fin_sum."*".$txtamount_sum."*".$avg."*".$txtwoven_sum_production."*".$txtknit_sum_production."*".$txtwoven_fin_sum_production."*".$txtknit_fin_sum_production."*".$txtwoven_sum_purchase."*".$txtknit_sum_purchase."*".$txtwoven_fin_sum_purchase."*".$txtknit_fin_sum_purchase."*".$txtwoven_amount_sum_purchase."*".$txtkint_amount_sum_purchase."";
			$rID_in5=sql_update("wo_pre_cost_sum_dtls",$field_array5,$data_array5,"job_no","".$update_id."",0);
			if($rID_id5==1 && $flag==1) $flag=1; else $flag=0;
		}
		if($flag==1) $tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);
		//=======================sum End =================
		//echo "10**". $rIDsupp.'--'.$rID.'--'.$rID1.'--'.$rID_id5.'--'.$flag; oci_rollback($con);check_table_status( $_SESSION['menu_id'],0);disconnect($con);die;

		if($db_type==0)
		{
			if($flag==1)
			{
				mysql_query("COMMIT");
				echo "0**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($flag==1)
			{
				oci_commit($con);
				echo "0**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else
			{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		check_table_status( $_SESSION['menu_id'],0);
		disconnect($con);
		die;
	} //Insert end ====================================================================================
	else if($operation==1)// Update here ====================================================================================
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
//=======Sourcing Cost Sheet =======	 
	$avg_cons_sql="select b.pre_cost_fabric_cost_dtls_id as fabdtl_id,b.po_break_down_id as poid,b.color_size_table_id as sizemstId,b.rate,b.amount,b.sourcing_rate,b.sourcing_amount from wo_pre_cost_mst a,wo_pre_cos_fab_co_avg_con_dtls b where a.job_id=b.job_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.sourcing_rate>0 and  a.approved in(0,2) and b.job_no='".str_replace("'", "", $update_id)."'";
	$avg_cons_result=sql_select($avg_cons_sql);
	foreach($avg_cons_result as $row)
	{
		
		$sourcingFabAvgSizeid_Arr[$row[csf('poid')]][$row[csf('fabdtl_id')]][$row[csf('sizemstId')]]['rate']=$row[csf('sourcing_rate')];
		$sourcingFabAvgSizeid_Arr[$row[csf('poid')]][$row[csf('fabdtl_id')]][$row[csf('sizemstId')]]['amount']=$row[csf('sourcing_amount')];
	}
			
//===========End=====================
		$condition= new condition();
		if(str_replace("'","",$update_id) !=''){
			$condition->job_no("=$update_id");
		}

		$condition->init();
		$fabric= new fabric($condition);
		$fabric_qty=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
		$is_sequence_validation=return_field_value("season_mandatory", "variable_order_tracking", "company_name=$cbo_company_name and variable_list=63");
		$booking_qty_arr=array();
		if($is_sequence_validation==1)
		{
			$booking_sql="select pre_cost_fabric_cost_dtls_id, sum(grey_fab_qnty) as grey_fab_qnty from wo_booking_dtls where job_no=$update_id and booking_type=1 and is_short=2 and status_active=1 and is_deleted=0 group by pre_cost_fabric_cost_dtls_id";
			$booking_sql_res=sql_select($booking_sql);
			foreach($booking_sql_res as $row)
			{
				$booking_qty_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]]=$row[csf('grey_fab_qnty')];
			}
			unset($booking_sql_res);
		}

		if( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**1"; disconnect($con); die;}

		

		$booking_cons_arr=array();
		if($is_sequence_validation==1)
		{
			$booking_sql="select pre_cost_fabric_cost_dtls_id, color_size_table_id, booking_no, precons from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_type=1 and job_no=".$update_id."";
			$booking_sql_res=sql_select($booking_sql);
			foreach($booking_sql_res as $row)
			{
				$booking_cons_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('color_size_table_id')]]=$row[csf('precons')];
			}
			unset($booking_sql_res);
		}

		$msg="Booking Grey Cons (Kg) is over then Budget.";
		for ($i=1; $i<=$total_row; $i++)
		{
			$updateid="updateid_".$i;
			$consbreckdown="consbreckdown_".$i;
			$pre_cost_fabric_cost_dtls_id=str_replace("'","",$$updateid);

			$cons_breckdown=substr(str_replace("'","",$$consbreckdown),0,100);
			$consbreckdown_array=explode('__',str_replace("'",'',$$consbreckdown));
			$counter=0;
			for($c=0;$c < count($consbreckdown_array);$c++)
			{
				$counter++;
				$consbreckdownarr=explode('_',$consbreckdown_array[$c]);

				$color_size_table_id=$consbreckdownarr[9];
				$po_break_down_id=$consbreckdownarr[0];
				if($consbreckdownarr[7] !=''){
					$cons_req=$consbreckdownarr[7];
				}
				$booking_cons=$booking_cons_arr[$pre_cost_fabric_cost_dtls_id][$color_size_table_id];
				if($cons_req<$booking_cons)
				{
					echo "6**".$msg;
					check_table_status( $_SESSION['menu_id'],0); 
					disconnect($con);
					return;
				}
			}
		}
		unset($booking_cons_arr);

		$field_array="id, job_id, job_no, seq, item_number_id, body_part_id, fab_nature_id, color_type_id, lib_yarn_count_deter_id, construction, composition, fabric_description, gsm_weight, gsm_weight_type, color_size_sensitive, avg_cons, fabric_source,nominated_supp_multi, rate, amount, avg_finish_cons,	avg_process_loss, inserted_by, insert_date, status_active, is_deleted, company_id, costing_per, consumption_basis, process_loss_method, cons_breack_down, msmnt_break_down, color_break_down, yarn_breack_down, marker_break_down, width_dia_type, avg_cons_yarn, gsm_weight_yarn, plan_cut_qty, job_plan_cut_qty, is_apply_last_update, uom, body_part_type, quotdtlsid, budget_on, source_id, remarks";
		
		$field_array_up="seq*job_id*item_number_id*body_part_id*fab_nature_id*color_type_id*lib_yarn_count_deter_id*construction*composition*fabric_description*gsm_weight*gsm_weight_type*color_size_sensitive*avg_cons*fabric_source*nominated_supp_multi*rate*amount*avg_finish_cons*avg_process_loss*updated_by*update_date*costing_per*consumption_basis*process_loss_method*cons_breack_down*msmnt_break_down*color_break_down*yarn_breack_down*marker_break_down*width_dia_type*avg_cons_yarn*gsm_weight_yarn*plan_cut_qty*job_plan_cut_qty*is_apply_last_update*uom*body_part_type*source_id*is_synchronized*remarks";

		$field_array1="id, job_id, pre_cost_fabric_cost_dtls_id, job_no, po_break_down_id, color_number_id, gmts_sizes, dia_width, item_size, cons, process_loss_percent, requirment, pcs, color_size_table_id, rate, amount, remarks, body_length, body_sewing_margin, body_hem_margin, sleeve_length, sleeve_sewing_margin, sleeve_hem_margin, half_chest_length, half_chest_sewing_margin, front_rise_length,	front_rise_sewing_margin, west_band_length, west_band_sewing_margin, in_seam_length, in_seam_sewing_margin, in_seam_hem_margin, half_thai_length, half_thai_sewing_margin, total, marker_dia, marker_yds, marker_inch, gmts_pcs, marker_length, net_fab_cons, fina_char, inserted_by, insert_date, status_active, is_deleted";

		$field_array2="id, job_id, pre_cost_fabric_cost_dtls_id, job_no, gmts_color_id, gmts_color, contrast_color_id";
		$field_supp_arr="id, job_id, job_no, fabric_id, supplier_id, inserted_by, insert_date, status_active, is_deleted";
		
		$id=return_next_id( "id", "wo_pre_cost_fabric_cost_dtls", 1);
		$id1=return_next_id( "id", "wo_pre_cos_fab_co_avg_con_dtls", 1);
		$wo_pre_cos_fab_co_color_dtls_id=return_next_id( "id", "wo_pre_cos_fab_co_color_dtls", 1);
		$idfabric=return_next_id( "id", "wo_pre_cost_fabric_supplier", 1);
		$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1);
		
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id  and status_active=1";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
			$wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		
		$rIDConsDe1=1; $rID=1; $rIDStColor=1; $rID5=1; $rIDSupp=1; $rID1=1; $rID_up=1; $rIDSuppDe1=1; $rID_in5=1; $flag=1;
		for ($i=1;$i<=$total_row;$i++)
		{
			$seq="seq_".$i;
			$cbogmtsitem="cbogmtsitem_".$i;
			$txtbodypart="txtbodypart_".$i;
			$cbofabricnature="cbofabricnature_".$i;
			$cbocolortype="cbocolortype_".$i;
			$libyarncountdeterminationid="libyarncountdeterminationid_".$i;
            $construction="construction_".$i;
			$composition="composition_".$i;
			$fabricdescription="fabricdescription_".$i;
			$txtgsmweight="txtgsmweight_".$i;
			$txtgsmweighttype="txtgsmweighttype_".$i;
			$cbocolorsizesensitive="cbocolorsizesensitive_".$i;
			$txtcolor="txtcolor_".$i;
			$txtconsumption="txtconsumption_".$i;
			$cbofabricsource="cbofabricsource_".$i;
			$cbonominasupplier="cbonominasupplier_".$i;
			$txtrate="txtrate_".$i;
			$txtsourcingrate="txtsourcingrate_".$i;
			$txtamount="txtamount_".$i;
			$txtfinishconsumption="txtfinishconsumption_".$i;
			$txtavgprocessloss="txtavgprocessloss_".$i;
			//$cbostatus="cbostatus_".$i;
			$consbreckdown="consbreckdown_".$i;
			$msmntbreackdown="msmntbreackdown_".$i;
			$updateid="updateid_".$i;
			$processlossmethod="processlossmethod_".$i;
			$colorbreackdown="colorbreackdown_".$i;
			$yarnbreackdown="yarnbreackdown_".$i;
			$consumptionbasis="consumptionbasis_".$i;
			$markerbreackdown="markerbreackdown_".$i;
			$cbowidthdiatype="cbowidthdiatype_".$i;
			$avgtxtconsumption="avgtxtconsumption_".$i;
			$avgtxtgsmweight="avgtxtgsmweight_".$i;
			$plancutqty="plancutqty_".$i;
			$jobplancutqty="jobplancutqty_".$i;
			$isclickedconsinput="isclickedconsinput_".$i;
			$oldlibyarncountdeterminationid="oldlibyarncountdeterminationid_".$i;
			$isconspopupupdate="isconspopupupdate_".$i;
			$uom="uom_".$i;
			$txtbodyparttype="txtbodyparttype_".$i;
			$prifabcostdtlsid="prifabcostdtlsid_".$i;
			$budget_on="budgeton_".$i;
			$source_id="cbomsource_".$i;
			$txtsourcingrate="txtsourcingrate_".$i;
			$remark="remark_".$i;
			$remark_pre=str_replace("'","",$$remark);
			$remark_str=special_chars_clean($remark_pre);

            
			
			//echo "10**".$$fabricdescription; check_table_status( $_SESSION['menu_id'],0); die;

			$budget_grey_qty=0; $booking_qty=0;
			$budget_grey_qty=$fabric_qty['knit']['grey'][str_replace("'",'',$$updateid)][str_replace("'",'',$$uom)];
			$booking_qty=$booking_qty_arr[str_replace("'",'',$$updateid)];
			
			$isconspopupupdateId=str_replace("'",'',$$isconspopupupdate);
			$sourcingrate=str_replace("'",'',$$txtsourcingrate);//For Sourcing Pre cost v2
			$is_synchronized=1;
			if($sourcingrate>0 && $isconspopupupdateId==1) //For Sourcing
			{
				$isconspopupupdateId_chk=str_replace("'",'',$$isconspopupupdate);
				$is_synchronized=2;	
			}
			
			$cons_breckdown=substr(str_replace("'","",$$consbreckdown),0,100);

			if(str_replace("'",'',$$updateid)!="")
			{
				$id_arr[]=str_replace("'",'',$$updateid);
				$data_array_up[str_replace("'",'',$$updateid)] =explode("*",("".$$seq."*".$hidd_job_id."*".$$cbogmtsitem."*".$$txtbodypart."*".$$cbofabricnature."*".$$cbocolortype."*".$$libyarncountdeterminationid."*".$$construction."*".$$composition."*".$$fabricdescription."*".$$txtgsmweight."*".$$txtgsmweighttype."*".$$cbocolorsizesensitive."*".$$txtconsumption."*".$$cbofabricsource."*".$$cbonominasupplier."*".$$txtrate."*".$$txtamount."*".$$txtfinishconsumption."*".$$txtavgprocessloss."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*".$cbo_costing_per."*".$$consumptionbasis."*".$$processlossmethod."*'".$cons_breckdown."'*".$$msmntbreackdown."*".$$colorbreackdown."*".$$yarnbreackdown."*".$$markerbreackdown."*".$$cbowidthdiatype."*".$$avgtxtconsumption."*".$$avgtxtgsmweight."*".$$plancutqty."*".$$jobplancutqty."*".$$isclickedconsinput."*".$$uom."*".$$txtbodyparttype."*".$$source_id."*".$is_synchronized."*'".$remark_str."'"));

				// msmnt break down ==================================================================================================
				if(str_replace("'",'',$$isconspopupupdate)==1)
				{
					$rIDConsDe1=execute_query( "delete from wo_pre_cos_fab_co_avg_con_dtls where pre_cost_fabric_cost_dtls_id =".$$updateid."",0);
					if ($rIDConsDe1==1 && $flag==1) { $flag=1; }
					else { echo "10**consAvgDelUp-"; $flag=0; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
					
					$consbreckdown_array=explode('__',str_replace("'",'',$$consbreckdown));
					$msmntbreackdown_array=explode('__',str_replace("'",'',$$msmntbreackdown));
					$markerbreackdownarr=explode('_',str_replace("'",'',$$markerbreackdown));
					$counter=0;
					for($c=0; $c < count($consbreckdown_array); $c++)
					{
						$counter++;
						$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
						$msmntbreackdownarr=explode('_',$msmntbreackdown_array[$c]);
						$consbreckdownarr[3]=strtoupper($consbreckdownarr[3]);
						$data_array1="";
						if(str_replace("'",'',$$txtbodypart)*1==1)
						{
							$data_array1="INSERT INTO wo_pre_cos_fab_co_avg_con_dtls (".$field_array1.") VALUES(".$id1.",".$hidd_job_id.",".$$updateid.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".$consbreckdownarr[10]."','".$consbreckdownarr[11]."','".$consbreckdownarr[12]."','".$msmntbreackdownarr[0]."','".$msmntbreackdownarr[1]."','".$msmntbreackdownarr[2]."','".$msmntbreackdownarr[3]."','".$msmntbreackdownarr[4]."','".$msmntbreackdownarr[5]."','".$msmntbreackdownarr[6]."','".$msmntbreackdownarr[7]."',0,0,0,0,0,0,0,0,0,'".$msmntbreackdownarr[8]."','".$markerbreackdownarr[0]."','".$markerbreackdownarr[1]."','".$markerbreackdownarr[2]."','".$markerbreackdownarr[3]."','".$markerbreackdownarr[4]."','".$markerbreackdownarr[5]."','".$consbreckdownarr[13]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
						}
						else if(str_replace("'",'',$$txtbodypart)*1==20)
						{
							$data_array1="INSERT INTO wo_pre_cos_fab_co_avg_con_dtls (".$field_array1.") VALUES(".$id1.",".$hidd_job_id.",".$$updateid.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".$consbreckdownarr[10]."','".$consbreckdownarr[11]."','".$consbreckdownarr[12]."',0,0,0,0,0,0,0,0,'".$msmntbreackdownarr[0]."','".$msmntbreackdownarr[1]."','".$msmntbreackdownarr[2]."','".$msmntbreackdownarr[3]."','".$msmntbreackdownarr[4]."','".$msmntbreackdownarr[5]."','".$msmntbreackdownarr[6]."','".$msmntbreackdownarr[7]."','".$msmntbreackdownarr[8]."','".$msmntbreackdownarr[9]."','".$markerbreackdownarr[0]."','".$markerbreackdownarr[1]."','".$markerbreackdownarr[2]."','".$markerbreackdownarr[3]."','".$markerbreackdownarr[4]."','".$markerbreackdownarr[5]."','".$consbreckdownarr[13]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
						}
						else
						{
							$data_array1="INSERT INTO wo_pre_cos_fab_co_avg_con_dtls (".$field_array1.") VALUES(".$id1.",".$hidd_job_id.",".$$updateid.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".$consbreckdownarr[10]."','".$consbreckdownarr[11]."','".$consbreckdownarr[12]."',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,'".$markerbreackdownarr[0]."','".$markerbreackdownarr[1]."','".$markerbreackdownarr[2]."','".$markerbreackdownarr[3]."','".$markerbreackdownarr[4]."','".$markerbreackdownarr[5]."','".$consbreckdownarr[13]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
					    }
						$id1=$id1+1;
						$rID=execute_query($data_array1);
						if ($rID==1) { $flag=1; }
						else { echo "10**fabconsup-".$data_array1; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
					}
				}
				// msmnt break down end ==================================================================================================
				
				// Color break down =====================================================================================================
				if(str_replace("'",'',$$colorbreackdown)!="")
				{
					$rIDStColor=execute_query( "delete from wo_pre_cos_fab_co_color_dtls where pre_cost_fabric_cost_dtls_id =".$$updateid."",0);
					if ($rIDStColor==1 && $flag==1) { $flag=1; }
					else { echo "10**stripeColorDelUp-"; $flag=0; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
					
					$colorbreckdown_array=explode('__',str_replace("'",'',$$colorbreackdown));
					for($c=0;$c < count($colorbreckdown_array);$c++)
					{
						$counter++;
						$colorbreckdownarr=explode('_',$colorbreckdown_array[$c]);
						// color ID
						
						if(str_replace("'","",$colorbreckdownarr[2])=='0') $colorbreckdownarr[2]='';
						$stripecolor_id=$stripeColorArr[trim($colorbreckdownarr[2])];
						if($stripecolor_id=="") $stripecolor_id=0;
						
						$data_array5="";
						$data_array5="INSERT INTO wo_pre_cos_fab_co_color_dtls (".$field_array2.") VALUES(".$wo_pre_cos_fab_co_color_dtls_id.",".$hidd_job_id.",".$$updateid.",".$update_id.",".$colorbreckdownarr[0].",'".$colorbreckdownarr[1]."','".$stripecolor_id."')";
						$wo_pre_cos_fab_co_color_dtls_id=$wo_pre_cos_fab_co_color_dtls_id+1;
						
						$rID5=execute_query($data_array5);
						if ($rID5==1 && $flag==1) { $flag=1; }
						else { echo "10**coColorup-".$data_array5; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
					}
				}
				// Color break down end====================================
				$cbonominasupplier=explode(",",str_replace("'",'',$$cbonominasupplier));
				$uid=str_replace("'",'',$$updateid);		
				foreach($cbonominasupplier as $sid)
				{
					if($sid>0)
					{
						$rIDSuppDe1=execute_query( "delete from wo_pre_cost_fabric_supplier where fabric_id ='".$upid."'",0);
						if ($rIDSuppDe1==1 && $flag==1) { $flag=1; }
						else { echo "10**suppUp-"; $flag=0; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
						
						$dataSuppArr ="";
						
						$dataSuppArr="INSERT INTO wo_pre_cost_fabric_supplier (".$field_supp_arr.") VALUES(".$idfabric.",".$hidd_job_id.",".$update_id.",'".$uid."','".$sid."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
						$idfabric++;
						$rIDSupp=execute_query($dataSuppArr);
						if ($rIDSupp==1 && $flag==1) { $flag=1; }
						else { echo "10**suppUp-".$dataSuppArr; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
					}
				}
			}// end if(str_replace("'",'',$$updateid)!="")

			if(str_replace("'",'',$$updateid)=="")
			{
				$data_array.="INTO wo_pre_cost_fabric_cost_dtls (".$field_array.") VALUES(".$id.",".$hidd_job_id.",".$update_id.",".$$seq.",".$$cbogmtsitem.",".$$txtbodypart.",".$$cbofabricnature.",".$$cbocolortype.",".$$libyarncountdeterminationid.",".$$construction.",".$$composition.",".$$fabricdescription.",".$$txtgsmweight.",".$$txtgsmweighttype.",".$$cbocolorsizesensitive.",".$$txtconsumption.",".$$cbofabricsource.",".$$cbonominasupplier.",".$$txtrate.",".$$txtamount.",".$$txtfinishconsumption.",".$$txtavgprocessloss.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0,".$cbo_company_name.",".$cbo_costing_per.",".$$consumptionbasis.",".$$processlossmethod.",'".$cons_breckdown."',".$$msmntbreackdown.",".$$colorbreackdown.",".$$yarnbreackdown.",".$$markerbreackdown.",".$$cbowidthdiatype.",".$$avgtxtconsumption.",".$$avgtxtgsmweight.",".$$plancutqty.",".$$jobplancutqty.",".$$isclickedconsinput.",".$$uom.",".$$txtbodyparttype.",".$$prifabcostdtlsid.",".$$budget_on.",".$$source_id.",'".$remark_str."')";
	           // $id=$id+1;
				// msmnt break down=================================================================================
				$consbreckdown_array=explode('__',str_replace("'",'',$$consbreckdown));
				$msmntbreackdown_array=explode('__',str_replace("'",'',$$msmntbreackdown));
				$markerbreackdownarr=explode('_',str_replace("'",'',$$markerbreackdown));
				for($c=0;$c < count($consbreckdown_array);$c++)
				{
					$counter++;
					$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
					$msmntbreackdownarr=explode('_',$msmntbreackdown_array[$c]);
					$consbreckdownarr[3]=strtoupper($consbreckdownarr[3]);
					$data_array1="";
					if(str_replace("'",'',$$txtbodypart)*1==1)
					{
						$data_array1="INSERT INTO wo_pre_cos_fab_co_avg_con_dtls (".$field_array1.") VALUES(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".$consbreckdownarr[10]."','".$consbreckdownarr[11]."','".$consbreckdownarr[12]."','".$msmntbreackdownarr[0]."','".$msmntbreackdownarr[1]."','".$msmntbreackdownarr[2]."','".$msmntbreackdownarr[3]."','".$msmntbreackdownarr[4]."','".$msmntbreackdownarr[5]."','".$msmntbreackdownarr[6]."','".$msmntbreackdownarr[7]."',0,0,0,0,0,0,0,0,0,'".$msmntbreackdownarr[8]."','".$markerbreackdownarr[0]."','".$markerbreackdownarr[1]."','".$markerbreackdownarr[2]."','".$markerbreackdownarr[3]."','".$markerbreackdownarr[4]."','".$markerbreackdownarr[5]."','".$consbreckdownarr[13]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
					}
					else if(str_replace("'",'',$$txtbodypart)*1==20)
					{
						$data_array1="INSERT INTO wo_pre_cos_fab_co_avg_con_dtls (".$field_array1.") VALUES(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".$consbreckdownarr[10]."','".$consbreckdownarr[11]."','".$consbreckdownarr[12]."',0,0,0,0,0,0,0,0,'".$msmntbreackdownarr[0]."','".$msmntbreackdownarr[1]."','".$msmntbreackdownarr[2]."','".$msmntbreackdownarr[3]."','".$msmntbreackdownarr[4]."','".$msmntbreackdownarr[5]."','".$msmntbreackdownarr[6]."','".$msmntbreackdownarr[7]."','".$msmntbreackdownarr[8]."','".$msmntbreackdownarr[9]."','".$markerbreackdownarr[0]."','".$markerbreackdownarr[1]."','".$markerbreackdownarr[2]."','".$markerbreackdownarr[3]."','".$markerbreackdownarr[4]."','".$markerbreackdownarr[5]."','".$consbreckdownarr[13]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
					}
					else
					{
						$data_array1="INSERT INTO wo_pre_cos_fab_co_avg_con_dtls (".$field_array1.") VALUES(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".$consbreckdownarr[10]."','".$consbreckdownarr[11]."','".$consbreckdownarr[12]."',0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,'".$markerbreackdownarr[0]."','".$markerbreackdownarr[1]."','".$markerbreackdownarr[2]."','".$markerbreackdownarr[3]."','".$markerbreackdownarr[4]."','".$markerbreackdownarr[5]."','".$consbreckdownarr[13]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
					}
					
					$id1=$id1+1;
					$rID=execute_query($data_array1);
					if ($rID==1) { $flag=1; }
					else { echo "10**fabconsins-".$data_array1; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
				}
				// msmnt break down end =================================================================================
				
				// color break down ==================================================================================================
				if(str_replace("'",'',$$colorbreackdown)!="")
				{
					$colorbreckdown_array=explode('__',str_replace("'",'',$$colorbreackdown));
					for($c=0;$c < count($colorbreckdown_array);$c++)
					{
						$counter++;
						$colorbreckdownarr=explode('_',$colorbreckdown_array[$c]);
						
						if(str_replace("'","",$colorbreckdownarr[2])=='0') $colorbreckdownarr[2]='';
						$stripecolor_id=$stripeColorArr[trim($colorbreckdownarr[2])];
						if($stripecolor_id=="") $stripecolor_id=0;
						 
						$data_array5="";
					
						$data_array5="INSERT INTO wo_pre_cos_fab_co_color_dtls (".$field_array2.") VALUES(".$wo_pre_cos_fab_co_color_dtls_id.",".$hidd_job_id.",".$id.",".$update_id.",".$colorbreckdownarr[0].",'".$colorbreckdownarr[1]."','".$stripecolor_id."')";
						$wo_pre_cos_fab_co_color_dtls_id=$wo_pre_cos_fab_co_color_dtls_id+1;
						
						$rID5=execute_query($data_array5);
						if ($rID5==1 && $flag==1) { $flag=1; }
						else { echo "10**coColor-".$data_array5; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
					}
				}

				// color break down end ==========================================================
				$cbonominasupplier=explode(",",str_replace("'",'',$$cbonominasupplier));			
				foreach($cbonominasupplier as $sid)
				{
					if($sid>0)
					{
						$dataSuppArr ="";
						
						$dataSuppArr="INSERT INTO wo_pre_cost_fabric_supplier (".$field_supp_arr.") VALUES(".$idfabric.",".$hidd_job_id.",".$update_id.",'".$id."','".$sid."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
						$idfabric++;
						$rIDSupp=execute_query($dataSuppArr);
						if ($rIDSupp==1 && $flag==1) { $flag=1; }
						else { echo "10**suppUp-".$dataSuppArr; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
					}
				}
			 	$id=$id+1;
			}//if(str_replace("'",'',$$updateid)=="")
		}// end master for loop
 
		//echo bulk_update_sql_statement( "wo_pre_cost_fabric_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ); die;
		$rID_up=execute_query(bulk_update_sql_statement( "wo_pre_cost_fabric_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
		if($rID_up==1 && $flag==1) $flag=1; else $flag=0;
		
		if ($data_array!="")
		{
			$queryfab="INSERT ALL ".$data_array." SELECT * FROM dual";
			$rID1=execute_query($queryfab);
			if($rID1==1 && $flag==1) $flag=1; else $flag=0;
		}
		//=======================sum=================
		 
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$field_array5="id, job_id, job_no, fab_yarn_req_kg, fab_woven_req_yds, fab_knit_req_kg, fab_woven_fin_req_yds, fab_knit_fin_req_kg, fab_amount, avg, pro_woven_grey_fab_req_yds, pro_knit_grey_fab_req_kg, pro_woven_fin_fab_req_yds, pro_knit_fin_fab_req_kg, pur_woven_grey_fab_req_yds, pur_knit_grey_fab_req_kg, pur_woven_fin_fab_req_yds, pur_knit_fin_fab_req_kg, woven_amount, knit_amount";
			$data_array5="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$tot_yarn_needed.",".$txtwoven_sum.",".$txtknit_sum.",".$txtwoven_fin_sum.",".$txtknit_fin_sum.",".$txtamount_sum.",".$avg.",".$txtwoven_sum_production.",".$txtknit_sum_production.",".$txtwoven_fin_sum_production.",".$txtknit_fin_sum_production.",".$txtwoven_sum_purchase.",".$txtknit_sum_purchase.",".$txtwoven_fin_sum_purchase.",".$txtknit_fin_sum_purchase.",".$txtwoven_amount_sum_purchase.",".$txtkint_amount_sum_purchase.")";
			$rID_in5=sql_insert("wo_pre_cost_sum_dtls",$field_array5,$data_array5,1);
			if($rID_in5==1 && $flag==1) $flag=1; else $flag=0;
		}

		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			$field_array5="fab_yarn_req_kg*fab_woven_req_yds*fab_knit_req_kg*fab_woven_fin_req_yds*fab_knit_fin_req_kg*fab_amount*avg*pro_woven_grey_fab_req_yds*pro_knit_grey_fab_req_kg*pro_woven_fin_fab_req_yds*pro_knit_fin_fab_req_kg*pur_woven_grey_fab_req_yds*pur_knit_grey_fab_req_kg*pur_woven_fin_fab_req_yds*pur_knit_fin_fab_req_kg*woven_amount*knit_amount";
			$data_array5 ="".$tot_yarn_needed."*".$txtwoven_sum."*".$txtknit_sum."*".$txtwoven_fin_sum."*".$txtknit_fin_sum."*".$txtamount_sum."*".$avg."*".$txtwoven_sum_production."*".$txtknit_sum_production."*".$txtwoven_fin_sum_production."*".$txtknit_fin_sum_production."*".$txtwoven_sum_purchase."*".$txtknit_sum_purchase."*".$txtwoven_fin_sum_purchase."*".$txtknit_fin_sum_purchase."*".$txtwoven_amount_sum_purchase."*".$txtkint_amount_sum_purchase."";
			$rID_in5=sql_update("wo_pre_cost_sum_dtls",$field_array5,$data_array5,"job_no","".$update_id."",1);
			if($rID_in5==1 && $flag==1) $flag=1; else $flag=0;
		}
		
		//echo "10**".$rIDConsDe1.'--'.$rID.'--'.$rIDStColor.'--'.$rID5.'--'.$rIDSupp.'--'.$rID1.'--'.$rID_up.'--'.$rIDSuppDe1.'--'.$rID_in5.'--'.$flag; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; 
		if($flag==1) $tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);
		 
		if($isconspopupupdateId_chk==1 && $flag==1) //For Sourcing page 
		{
			execute_query( "update wo_pre_cost_mst set sourcing_ready_to_approved=2 where job_no =".$update_id."   ",1);//and sourcing_approved !=1
		}
		//iSsue Id-29071 Yr-23
		if(count($sourcingFabAvgSizeid_Arr)>0) //Sourcing
		{
			foreach($sourcingFabAvgSizeid_Arr as $poId=>$PoData)
				{
					foreach($PoData as $fabId=>$fabData)
					{
						foreach($fabData as $sizeMstid=>$val)
						{
							$souring_amount=$val['amount'];
							$souring_rate=$val['rate'];
							$up_avg_rID=execute_query( "update  wo_pre_cos_fab_co_avg_con_dtls set sourcing_rate='".$souring_rate."',sourcing_amount='".$souring_amount."',sourcing_updated_by=".$_SESSION['logic_erp']['user_id'].",sourcing_update_date='".$pc_date_time."' where po_break_down_id =".$poId." and color_size_table_id =".$sizeMstid." and pre_cost_fabric_cost_dtls_id =".$fabId." and status_active=1  ",0);
							if($flag==1) 
							{
							if($up_avg_rID) $flag=1; else $flag=0;
							}
						}
					}
			}
		}
		

		execute_query( "update  wo_booking_mst set is_apply_last_update=2  where  job_no =".$update_id." and booking_type=1 and is_approved !=1 and is_short=2 ",1);
		//=======================sum End =================
		check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($flag==1)
			{
				mysql_query("COMMIT");
				echo "1**".$new_job_no[0]."**".$rID_up."**".$tot_com_amount;
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID_up."**".$tot_com_amount;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($flag==1)
			{
				oci_commit($con);
				echo "1**".$new_job_no[0]."**".$rID_up."**".$tot_com_amount;
			}
			else
			{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID_up."**".$tot_com_amount;
			}
		}
		disconnect($con);
		die;
	}
// Update End ==========================================================================================
}

if ($action=="save_update_delet_fabric_conversion_cost_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$sql=sql_select("select approval_need from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
	$app_nessity=2;
	foreach($sql as $row){
		$app_nessity=$row[csf('approval_need')];
	}

	$sql=sql_select("select approved from wo_price_quotation  where id=$txt_quotation_id");
	$quatation_approved=2;
	foreach($sql as $row){
		$quatation_approved=$row[csf('approved')];
	}

	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	//echo "10**",$is_copy_quatation."**". $app_nessity."**".$quatation_approved;
	//die;
	if($is_copy_quatation==1 && $app_nessity==1){
		if($quatation_approved==2 || $quatation_approved==0){
			echo "quataNotApp**".str_replace("'","",$txt_job_no);
			 disconnect($con);die;
		}
	}
	$component_approved=return_field_value("current_approval_status", "co_com_pre_costing_approval", "job_no=$update_id and cost_component_id=1");
	$approved=0; $ready_to_approve=0;
	$sql=sql_select("select approved, ready_to_approved from wo_pre_cost_mst where job_no=$update_id and status_active=1 and is_deleted=0");
	foreach($sql as $row){
		//if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
		$approved=$row[csf('approved')];
		$ready_to_approve=$row[csf('ready_to_approved')];
	}
	if($approved==1 || $component_approved==1){
		echo "approved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($approved==3){
		echo "papproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($ready_to_approve==1){
		echo "readyapproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($operation==0)
	{
	    $con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		 if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0"; disconnect($con); die;}
		 
		 $id=return_next_id( "id", "wo_pre_cost_fab_conv_cost_dtls", 1 ) ;
		 $field_array="id, job_id, job_no, fabric_description, cons_process, process_loss, req_qnty, avg_req_qnty, charge_unit, amount, color_break_down, charge_lib_id, inserted_by, insert_date, status_active, is_deleted";

		 $field_array_dtls="id, job_id,job_no,fabric_cost_dtls_id,conv_cost_dtls_id,convchargelibraryid,gmts_color_id,fabric_color_id ,cons,unit_charge,inserted_by, insert_date";		 
		 $add_comma=0;
		 $id1=return_next_id( "id", "wo_pre_cos_conv_color_dtls", 1);
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cbocosthead="cbocosthead_".$i;
			 $cbotypeconversion="cbotypeconversion_".$i;
			 $txtprocessloss="txtprocessloss_".$i;
			 $txtreqqnty="txtreqqnty_".$i;
			 $txtavgreqqnty="txtavgreqqnty_".$i;
			 $txtchargeunit="txtchargeunit_".$i;
			 $txtamountconversion="txtamountconversion_".$i;
			 $cbostatusconversion="cbostatusconversion_".$i;
			 $updateidcoversion="updateidcoversion_".$i;
			 $colorbreakdown="colorbreakdown_".$i;
			 $coversionchargelibraryid="coversionchargelibraryid_".$i;

			 $cons_breckdown=substr(str_replace("'","",$$colorbreakdown),0,3999);

			if ($i!=1) $data_array .=",";
			$data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cbocosthead.",".$$cbotypeconversion.",".$$txtprocessloss.",".$$txtreqqnty.",".$$txtavgreqqnty.",".$$txtchargeunit.",".$$txtamountconversion.",'".$cons_breckdown."',".$$coversionchargelibraryid.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbostatusconversion.",0)";

			//===========Color Wise CONS break down=========================================

			if(str_replace("'",'',$$colorbreakdown) !='')
			{
				
				$consbreckdown_array=explode('__',str_replace("'",'',$$colorbreakdown));
				$counter=0;
				for($c=0;$c < count($consbreckdown_array);$c++)
				{
					$counter++;
					$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
					if ($add_comma!=0) $data_array_dtls .=",";
					$data_array_dtls .="(".$id1.",".$hidd_job_id.",".$update_id.",".$$cbocosthead.",'".$id."','".$consbreckdownarr[2]."','".$consbreckdownarr[0]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[1]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."')";

					$id1=$id1+1;
					$add_comma++;					
				}
			}

			$id=$id+1;
		 }
		 //echo "10**Insert into wo_pre_cost_fab_conv_cost_dtls ($field_array) values $data_array"; die;
		 $rID=sql_insert("wo_pre_cost_fab_conv_cost_dtls",$field_array,$data_array,0);
		 if($data_array_dtls!="")
		 {
		 $rID2=sql_insert("wo_pre_cos_conv_color_dtls",$field_array_dtls,$data_array_dtls,0);
		 }
		 //=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array1="id, job_id, job_no, conv_req_qnty, conv_charge_unit, conv_amount";
			$data_array1="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtconreqnty_sum.",".$txtconchargeunit_sum.",".$txtconamount_sum.")";
			$rID1=sql_insert("wo_pre_cost_sum_dtls",$field_array1,$data_array1,1);
		}

		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array1="conv_req_qnty*conv_charge_unit*conv_amount";
			$data_array1 ="".$txtconreqnty_sum."*".$txtconchargeunit_sum."*".$txtconamount_sum."";
			$rID1=sql_update("wo_pre_cost_sum_dtls",$field_array1,$data_array1,"job_no","".$update_id."",1);
		}
		//=======================sum End =================
		 check_table_status( $_SESSION['menu_id'],0);


		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "0**".$new_job_no[0]."**".$rID;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "0**".$new_job_no[0]."**".$rID;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		disconnect($con);
		die;
	}
	else if($operation==1)
	{
	    $con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		
		
		if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**1"; disconnect($con); die;}
		$field_array_up ="job_no*fabric_description*cons_process*process_loss*is_apply_last_update*req_qnty*avg_req_qnty*charge_unit*amount*color_break_down*charge_lib_id*updated_by*update_date*status_active*is_deleted";
		$field_array="id, job_id, job_no, fabric_description, cons_process, process_loss, req_qnty, avg_req_qnty, charge_unit, amount, color_break_down, charge_lib_id, inserted_by, insert_date, status_active, is_deleted";
		$field_array1="id, job_id,job_no,fabric_cost_dtls_id,conv_cost_dtls_id,convchargelibraryid,gmts_color_id,fabric_color_id ,cons,unit_charge,inserted_by, insert_date";
		$add_comma=0;$add_comma2=0;
		$id=return_next_id( "id", "wo_pre_cost_fab_conv_cost_dtls", 1 ) ;
		$id1=return_next_id( "id", "wo_pre_cos_conv_color_dtls", 1);
		 for ($i=1;$i<=$total_row;$i++)
		 {
			$cbocosthead="cbocosthead_".$i;
			$cbotypeconversion="cbotypeconversion_".$i;
			$txtprocessloss="txtprocessloss_".$i;
			$txtreqqnty="txtreqqnty_".$i;
			$txtavgreqqnty="txtavgreqqnty_".$i;
			$txtchargeunit="txtchargeunit_".$i;
			$txtamountconversion="txtamountconversion_".$i;
			$cbostatusconversion="cbostatusconversion_".$i;
			$updateidcoversion="updateidcoversion_".$i;
			$colorbreakdown="colorbreakdown_".$i;
			$coversionchargelibraryid="coversionchargelibraryid_".$i;
			$lastappidchk="lastappidchk_".$i;
			$updateidcoversionId=str_replace("'",'',$$updateidcoversion);			
			$cbotypeconversionId=str_replace("'",'',$$cbotypeconversion);
			if($cbotypeconversionId==30 || $cbotypeconversionId==31)
			{
				if(str_replace("'",'',$$colorbreakdown) !='')
				{
				$consbreckdown= $$colorbreakdown;
				}
				else
				{
					$consbreckdown="'".create_consbreak_down_conv($update_id,str_replace("'",'',$$hidd_job_id),str_replace("'",'',$$cbocosthead),str_replace("'",'',$$cbotypeconversion),str_replace("'",'',$$updateidcoversion))."'";
				}
			}
			$lastappidchkId=1;
			if(str_replace("'",'',$$updateidcoversion)!="")
			{
				$cons_breckdown=substr(str_replace("'","",$consbreckdown),0,3999);
				$id_arr[]=str_replace("'",'',$$updateidcoversion);
				$data_array_up[str_replace("'",'',$$updateidcoversion)] =explode(",",("".$update_id.",".$$cbocosthead.",".$$cbotypeconversion.",".$$txtprocessloss.",".$lastappidchkId.",".$$txtreqqnty.",".$$txtavgreqqnty.",".$$txtchargeunit.",".$$txtamountconversion.",'".$cons_breckdown."',".$$coversionchargelibraryid.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbostatusconversion.",0"));

				//===========Color Wise CONS break down=========================================

				if(str_replace("'",'',$consbreckdown) !='')
				{
					$rID_de1_dtls=execute_query( "delete from wo_pre_cos_conv_color_dtls where  conv_cost_dtls_id =".$$updateidcoversion." and  fabric_cost_dtls_id =".$$cbocosthead." ",0);
					
					$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
					$counter=0;
					for($c=0;$c < count($consbreckdown_array);$c++)
					{
						$counter++;
						$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
						
						if ($add_comma2!=0) $data_array1 .=",";
						$data_array1 .="(".$id1.",".$hidd_job_id.",".$update_id.",".$$cbocosthead.",".$$updateidcoversion.",'".$consbreckdownarr[2]."','".$consbreckdownarr[0]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[1]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."')";

						$id1=$id1+1;
						$add_comma2++;
						
					}
				}
			}
			if(str_replace("'",'',$$updateidcoversion)=="")
			{
				$cons_breckdown=substr(str_replace("'","",$consbreckdown),0,3999);
				if ($add_comma!=0) $data_array .=",";
				$data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cbocosthead.",".$$cbotypeconversion.",".$$txtprocessloss.",".$$txtreqqnty.",".$$txtavgreqqnty.",".$$txtchargeunit.",".$$txtamountconversion.",'".$cons_breckdown."',".$$coversionchargelibraryid.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbostatusconversion.",0)";
				
				//===========Color Wise CONS break down=========================================

				if(str_replace("'",'',$consbreckdown) !='')
				{
					$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
					for($c=0;$c < count($consbreckdown_array);$c++)
					{
						$counter++;
						$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
						
						if ($add_comma2!=0) $data_array1 .=",";
						$data_array1 .="(".$id1.",".$hidd_job_id.",".$update_id.",".$$cbocosthead.",'".$id."','".$consbreckdownarr[2]."','".$consbreckdownarr[0]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[1]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."')";
						$id1=$id1+1;
						$add_comma2++;
						
					}
				}
				$id=$id+1;
				$add_comma++;
			}
		 }
		 $rID=execute_query(bulk_update_sql_statement( "wo_pre_cost_fab_conv_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
		 if($data_array !="")
		 {
			 $rID1=sql_insert("wo_pre_cost_fab_conv_cost_dtls",$field_array,$data_array,0);
		 }
		 if($data_array1!="")
		 {
			 $rID2=sql_insert("wo_pre_cos_conv_color_dtls",$field_array1,$data_array1,0);
		 }

 		//=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, conv_req_qnty, conv_charge_unit, conv_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtconreqnty_sum.",".$txtconchargeunit_sum.",".$txtconamount_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="conv_req_qnty*conv_charge_unit*conv_amount";
			$data_array2 ="".$txtconreqnty_sum."*".$txtconchargeunit_sum."*".$txtconamount_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		//=======================sum End =================
		check_table_status( $_SESSION['menu_id'],0);

		if($db_type==0)
		{

			if($rID ){
				mysql_query("COMMIT");
				echo "1**".$new_job_no[0]."**".$rID;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "1**".$new_job_no[0]."**".$rID;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		disconnect($con);
		die;
	}
}

function create_consbreak_down_conv($job_no,$job_id,$cbocosthead,$cbotypeconversion,$updateidcoversion)
{
	$data_array=sql_select("select  a.id,b.convchargelibraryid,b.conv_cost_dtls_id,b.fabric_cost_dtls_id,b.gmts_color_id,b.fabric_color_id,b.cons,b.unit_charge from wo_pre_cost_fab_conv_cost_dtls a, wo_pre_cos_conv_color_dtls b  where a.id=b.conv_cost_dtls_id and a.fabric_description=b.fabric_cost_dtls_id  and b.job_no=$job_no and b.conv_cost_dtls_id=$updateidcoversion  and a.status_active=1 and b.status_active=1  order by a.id");
	if ( count($data_array)>0)
	{
		$cons_breck_down="";		 
		foreach( $data_array as $row )
		{			 
			if($cons_breck_down=="") //convchargelibraryid
			{
				$cons_breck_down.=$row[csf('gmts_color_id')].'_'.$row[csf('unit_charge')].'_'.$row[csf('convchargelibraryid')].'_'.$row[csf('fabric_color_id')].'_'.$row[csf('cons')];
			}
			else
			{
				$cons_breck_down.="__".$row[csf('gmts_color_id')].'_'.$row[csf('unit_charge')].'_'.$row[csf('convchargelibraryid')].'_'.$row[csf('fabric_color_id')].'_'.$row[csf('cons')];
			}
		}
		return $cons_breck_down;
	}
}

//**************************************Fabric Cost  and conversion cost End ***********************************************
if ($action=="load_drop_down_supplier_rate")
{
	$data=explode("_",$data);
	echo create_drop_down( "cbonominasupplier_".$data[1],90, "select a.supplier_name,a.id from  lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(1,3,4,5,8,9,23) and a.is_deleted=0  and a.status_active=1  group by a.id,a.supplier_name order by a.supplier_name", "id,supplier_name", 1, '-Select-', "","set_trim_rate_amount(this.value,".$data[1].",'supplier_change')",$disabled,"" );
	
	exit();
}

//*************************************************Trim Cost Start ***********************************************
if ($action == "show_trim_cost_listview")
{
    $supplier_library = return_library_array("select a.supplier_name,a.id from  lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(1,3,4,5,8,9,23) and a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");

    $data = explode("**", $data);
    $trim_variable = 1;$permission=$data[6];
    $trim_variable_sql = sql_select("select trim_rate from  variable_order_tracking where company_name='$data[3]' and variable_list=35 order by id");
    foreach ($trim_variable_sql as $trim_variable_row) {
        $trim_variable = $trim_variable_row[csf('trim_rate')];
    }
    if ($trim_variable == 2 || $trim_variable == 3 || $trim_variable == 4) $readonly_rate = "readonly"; else $readonly_rate = "";
    $component_approved = 0; 
    $sql = sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=2 and job_no='$data[0]'");
    foreach($sql as $row){
		if($row[csf('approved')]==1 || $row[csf('approved')]==3) { $component_approved=1; $approved_message="<marquee width='500'><p style='color:#f00; text-align:center;'> Approved</p></marquee>";}
	}
    $approved=return_field_value("approved", "wo_pre_cost_mst", "job_no='$data[0]'");
	if($approved==3){
		$approved=1;
	}
	if($approved==1 || $component_approved==1)
	{
		$disabled=1; $txt_disabled="disabled"; $cons_gmts="disabled";
	}
	else
	{
		$disabled=0; $txt_disabled=""; $cons_gmts="";
	}

    $supplier_lib_with_rate_arr = array();
	

    ?>
    <h3 align="left" class="accordion_h">+Trim Cost <?=$approved_message; ?></h3>
    <div id="content_trim_cost" align="center">
    <fieldset>
    <input type="hidden" id="trim_rate_variable" value="<?=$trim_variable; ?>"/>
    <form id="trimccost_6" autocomplete="off">
    <table width="1430" cellspacing="0" class="rpt_table" border="0"  rules="all" >
    	<thead>
    	    <tr>
    	        <th width="30" style="color:#2A3FFF">Seq.</th>
    	        <th width="100" style="color:#2A3FFF">Group</th>
    	        <th width="90">Country</th>
    	        <th width="200">Description</th>
    	        <th width="90">Brand/Sup Ref</th>
    	        <th width="110">Remarks/Placement</th>  
    	        <th width="80">Source</th>      
    	        <th width="80">Material Source</th>       
    	        <th width="90">Nominated Supp</th>
    	        <th width="50" style="color:#2A3FFF">Cons UOM</th>
    	        <th width="45" style="color:#2A3FFF">Cons /Unit Gmts</th>
    	        <th width="45" style="color:#2A3FFF">Rate</th>
    	        <th width="55">Amount</th>
    	        <th width="55">Total Qty</th>
    	        <th width="55">Total Amount</th>
    	        <th width="40">Apvl Req.</th>
    	        <th width="50">Item Print</th>
    	        <th width="40">Image</th>
    	        <th>&nbsp;</th>
    	    </tr>
    	</thead>
    </table>
    <div style="width: 1430px;max-height: 250px;overflow-y:scroll;">
	    <table width="1410" cellspacing="0" class="rpt_table" border="0" id="tbl_trim_cost" rules="all" >
	        <thead>
	            <tr>
	                <td width="30" ></td>
	                <td width="100" ></td>
	                <td width="90"></td>
	                <td width="200"></td>
	                <td width="90"></td>
	                <td width="110"></td>  
	                <td width="80"></td>      
	                <td width="80"></td>       
	                <td width="90"></td>
	                <td width="50" ></td>
	                <td width="45" ></td>
	                <td width="45" ></td>
	                <td width="55"></td>
	                <td width="55"></td>
	                <td width="55"></td>
	                <td width="40"></td>
                    <td width="50"></td>
	                <td width="40"></td>
	                <td></td>
	            </tr>
	        </thead>
	        <tbody id="trim_tbl_dtls_for">
	        <?
	        $total_Amount=0;
	        //print_r($totalamountarray_arr);
	        $lib_item_group_arr = return_library_array("select item_name,id from lib_item_group where item_category=4 order by item_name", "id", "item_name");
			$country_library=return_library_array("select id,country_name from lib_country","id","country_name");
			
			$gmtsItemOrdCri=sql_select("select gmts_item_id, order_criteria, order_uom from wo_po_details_master where job_no='$data[0]'");
				
			$orderCriteriaId=$gmtsItemOrdCri[0][csf('order_criteria')];
			$job_order_uom=$gmtsItemOrdCri[0][csf('order_uom')];
			$deFabSource=2;
			if($orderCriteriaId==3) $deFabSource=3;//ISD-22-05229 by Kausar
	    
	        $save_update = 1;
	        $data_array = sql_select("SELECT id, quotdtlsid as qid, remark, job_no, trim_group, description, brand_sup_ref, cons_uom, cons_dzn_gmts, tot_cons as total_cons, ex_per as excess_per, rate, amount, apvl_req, nominated_supp, cons_breack_down, country, calculatorstring, seq, status_active, nominated_supp_multi, sourcing_rate,material_source,source_id,is_apply_last_update, item_print, supplier_rate_id from wo_pre_cost_trim_cost_dtls where job_no='$data[0]' and is_deleted=0 order by seq");// quotation_id='$data'
	    
	        $is_booking_arr = array();
	        if (count($data_array) > 0) {
	            $data_arr = sql_select("SELECT trim_group,pre_cost_fabric_cost_dtls_id from wo_booking_dtls where job_no ='$data[0]' and booking_type='2' and status_active=1 and is_deleted=0 group by pre_cost_fabric_cost_dtls_id,trim_group");
	            foreach ($data_arr as $row) {
	                $is_booking_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('trim_group')]] = $row[csf('pre_cost_fabric_cost_dtls_id')];
	            }
	            unset($data_arr);
	        }
	        if (count($data_array) < 1 && $data[2]==1 && $data[5]==2)//Price Quotation
	        {
	            $data_array = sql_select("SELECT id as qid, seq, quotation_id, trim_group, description, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp as nominated_supp_multi, sup_ref, status_active, cons_dzn_gmts as total_cons, excess_per, ex_cons, total_cons as cons_dzn_gmts, material_source, 0 as item_print, 0 as is_apply_last_update, 0 as supplier_rate_id  from wo_pri_quo_trim_cost_dtls where quotation_id='$data[1]' and status_active=1 and is_deleted=0 order by seq");
	            $save_update = 0;
	        }
	        
	        if ($data[2]==1 && $data[5]==4 )//Quick Costing [WVN]
	        {
	            $qc_no=$data[1];//return_field_value("qc_no", "wo_po_details_master a, qc_mst b", "job_no='$data[0]' and a.inquiry_id=b.inquery_id and b.is_deleted=0 and b.status_active=1");
	            $dataQc = sql_select("SELECT id as qid, '' as seq, mst_id as quotation_id, particular_type_id as trim_group, description, 0 as cons_uom, tot_cons as cons_dzn_gmts, rate, value as amount, 0 as apvl_req, nominated_supp_multi as nominated_supp_multi, supp_ref as sup_ref, status_active, ex_percent as excess_per, consumption as total_cons, tot_cons as ex_cons, 0 as material_source, 0 as item_print, 0 as is_apply_last_update, 0 as supplier_rate_id from qc_cons_rate_dtls where mst_id='$qc_no' and type=4 and tot_cons>0 and status_active=1 and is_deleted=0 order by id");
	            $trimID=""; $qcDataArr=array();
	            foreach( $dataQc as $trow)
	            {
	                if($trimID=="") $trimID=$trow[csf('trim_group')]; else $trimID.=','.$trow[csf('trim_group')];
	                $qcDataArr[$trow[csf('qid')]]=$trow[csf('ex_cons')].'__'.$trow[csf('excess_per')].'__'.$trow[csf('total_cons')].'__'.$trow[csf('rate')].'__'.$trow[csf('amount')];
	            }
	            if (count($data_array) < 1)//Quick Costing [WVN]
	            {
	                $trimGroup_arr=array();
	                if($trimID!="")
	                {
	                    $sqlTgroup=sql_select("select id, trim_uom from lib_item_group where item_category=4 and is_deleted=0 and status_active=1 and id in ($trimID)");
	                    if (count($sqlTgroup)>0)
	                    {
	                        foreach( $sqlTgroup as $row )
	                        {
	                            $trimGroup_arr[$row[csf('id')]]['trim_uom']=$row[csf('trim_uom')];
	                        }
	                        unset($sqlTgroup);
	                    }
	                }
	                $data_array=$dataQc;
	                $save_update=0;
	            }
	        }
	    
	        if (count($data_array) > 0)
	        {
	            $i = 0;
	            foreach ($data_array as $row)
	            {
	                $i++;
	                if($save_update==0 && $data[5]==4)
	                {
	                    $row[csf("cons_uom")]=$trimGroup_arr[$row[csf('trim_group')]]['trim_uom'];
	                }
	    
	                $country_text = "";
	                $countryarr = explode(",", $row[csf("country")]);
	                for ($cu = 0; $cu < count($countryarr); $cu++) {
	                    $country_text .= $country_library[trim($countryarr[$cu])] . ",";
	                }
	                $country_text = rtrim($country_text, ",");
	    
	                $seq = 0;
	                if ($save_update == 0) {
	                    if ($row[csf("seq")] == "") $seq = $i; else $seq = $row[csf("seq")];
	                } else {
	                    if ($row[csf("seq")] == "") $seq = $i; else $seq = $row[csf("seq")];
	                }
	                $dis = 0;
	                $txt_dis = '';
	                if ($disabled != 1) {
	                    if ($is_booking_arr[$row[csf('id')]][$row[csf('trim_group')]] != "") {
	                        $dis = 1;
	                        $txt_dis = "disabled";
	                    } else {
	                        $dis = 0;
	                        $txt_dis = '';
	                    }
	                }
	                $nominated_supp_str="";
	                 $exnominated_supp=explode(",",$row[csf('nominated_supp_multi')]);
	                 foreach($exnominated_supp as $supp)
	                 {
	                    if($trim_variable==1) { if($nominated_supp_str=="") $nominated_supp_str=$supplier_library[$supp]; else $nominated_supp_str.=','.$supplier_library[$supp]; }
	                    else { if($nominated_supp_str=="") $nominated_supp_str=$supplier_library[$supp]; else $nominated_supp_str.=','.$supplier_library[$supp]; }
	                 }
					
					// echo $is_cs_approved.'D';
	                 $material_source=$row[csf("material_source")];
	                 if($material_source==0 || empty($material_source))
	                 {
	                 	$material_source=2;
	                 }
					if($row[csf("excess_per")] != '') $excess_per = $row[csf("excess_per")]; else $excess_per=0;
					if($row[csf("ex_cons")] != '') $ex_cons = $row[csf("ex_cons")]; else $ex_cons=0;
					if($row[csf("cons_pcs_gmts")] != '') $total_cons = $row[csf("cons_pcs_gmts")]; else $total_cons=0;
					if($row[csf("total_cons")] != ''){
						$total_cons = $row[csf("total_cons")]; 
					}					
					if($save_update==0)
					{
						$row[csf("fabric_source")]=$deFabSource;
						if($deFabSource==3) $sourceDis="1";
					}
					else
					{
						if($deFabSource==3) $sourceDis="1";
					}
					if($disabled==1) $sourceDis=$disabled;
					
					$is_apply_last_update=$row[csf('is_apply_last_update')];
					 $msg_app=""; $changedcolor="";
					 if($is_apply_last_update==2)
					 {
						 $msg_app="Color Size Changed.";
						 $changedcolor="red";
					 }
					 $nomi_supplier_disabled='';
					 if($trim_variable==4 && $row[csf('supplier_rate_id')]>0){
						$nomi_supplier_disabled="disabled";
					 }
					
	                ?>
	                <tr id="trim_<?=$i; ?>" title="G" align="center" onClick="toggle(this.id, '#FFFFFF')">
	                    <td><input type="hidden" id="cbotrimstatus_<?=$i; ?>" name="cbotrimstatus_<?=$i; ?>" class="text_boxes" style="width:18px" value="1"/>
	                        <input type="text" id="seq_<?=$i; ?>" name="seq_<?=$i; ?>" class="text_boxes_numeric" style="width:18px" value="<?=$seq; ?>" <?=$txt_disabled; echo $txt_dis; ?> />
	                    </td>
	                    <td title="<? echo $msg_app;?>" >
	                        <input placeholder="Browse" title="<?=$msg_app.' '.$lib_item_group_arr[$row[csf("trim_group")]]; ?>" readonly type="text" id="cbogrouptext_<?=$i; ?>" name="cbogrouptext_<?=$i; ?>" class="text_boxes" style="width:88px; background-color:<?=$changedcolor; ?>" value="<?=$lib_item_group_arr[$row[csf("trim_group")]]; ?>" <?=$txt_disabled; echo $txt_dis; ?> onDblClick="openpopup_itemgroup(<?=$i; ?>);"/>
	                        <input type="hidden" id="cbogroup_<?=$i; ?>" name="cbogroup_<?=$i; ?>" class="text_boxes" style="width:50px" value="<?=$row[csf("trim_group")]; ?>"/>
                            
                            <input type="hidden" id="lastappidchk_<? echo $i; ?>" name="lastappidchk_<? echo $i; ?>" class="text_boxes" style="width:10px" value="<?=$row[csf("is_apply_last_update")]; ?>" readonly  />
	                    </td>
	                    <td>
	                        <input type="text" id="countrytext_<?=$i; ?>" name="countrytext_<?=$i; ?>" class="text_boxes" style="width:78px" value="<?=$country_text; ?>" <?=$txt_disabled; ?> onDblClick="open_country_popup(<?=$i; ?>,<?=$dis; ?>);" placeholder="Browse" readonly/>
	                        <input type="hidden" id="country_<?=$i; ?>" name="country_<?=$i; ?>" class="text_boxes" style="width:70px" value="<?=$row[csf("country")]; ?>"/>
	                    </td>
	                    <td>
						<input type="text" placeholder="Browse" id="txtdescription_<?=$i; ?>" name="txtdescription_<?=$i; ?>" class="text_boxes" style="width:188px" value="<?=$row[csf("description")]; ?>" <?=$txt_disabled; echo $txt_dis; echo $readonly_rate?> onDblClick="trims_description_popup(<?=$i; ?>);"/>
						<input type="hidden" id="supplierwiserate_<?= $i?>" value="<?= $row[csf('supplier_rate_id')] ?>">
						</td>
	                    <td>
	                        <? if($row[csf("brand_sup_ref")]=="") $row[csf("brand_sup_ref")]=$row[csf("sup_ref")]; ?>
	                        <input type="text" id="txtsupref_<?=$i; ?>" name="txtsupref_<?=$i; ?>" maxlength="20" class="text_boxes" style="width:78px" value="<?=$row[csf("brand_sup_ref")]; ?>" <?=$txt_disabled; echo $txt_dis; ?> />
	                    </td>
	                    <td><input class="text_boxes" type="text" style="width:98px;" name="txtremark_<?=$i; ?>" id="txtremark_<?=$i; ?>" value="<?=$row[csf("remark")]; ?>" maxlength="500" title="Maximum 500 Character" <?=$txt_disabled; echo $txt_dis; ?> /></td>
	                     <td><? asort($commission_particulars); echo create_drop_down( "cbosourceid_".$i, 70, $commission_particulars, "", 1, "-Select-", $row[csf("source_id")], "","","" ); ?></td>
	                     <td>
	                        <? asort($fabric_source);
	                            echo create_drop_down( "cbomaterialsource_".$i, 80, $fabric_source, "", 0, "", $material_source, "",$sourceDis,"2,3,4,5" );
	                        ?>
	                    </td>
	                    <td id="tdsupplier_<?=$i; ?>">
                            <input readonly type="text" id="txtnominasupplier_<?=$i; ?>" name="txtnominasupplier_<?=$i; ?>" class="text_boxes" placeholder="Browse" style="width:78px" value="<?=$nominated_supp_str; ?>" <?=$txt_disabled; echo $txt_dis; echo $nomi_supplier_disabled; ?> onDblClick="fncopenpopup_trimsupplier(<?=$i; ?>);"/>
                            <input type="hidden" id="cbonominasupplier_<?=$i; ?>" name="cbonominasupplier_<?=$i; ?>" class="text_boxes" style="width:60px" value="<?=$row[csf("nominated_supp_multi")]; ?>" />
	                    </td>
	                    <td><?=create_drop_down("cboconsuom_" . $i, 50, $unit_of_measurement, "", 1, "-- Select --", $row[csf("cons_uom")], "", 1, ""); ?></td>
	                    <td><input type="text" id="txtconsdzngmts_<?=$i; ?>" name="txtconsdzngmts_<?=$i; ?>" class="text_boxes_numeric" style="width:33px" value="<? echo $row[csf("cons_dzn_gmts")]; ?>" onChange="calculate_trim_cost(<?=$i; ?>);" onDblClick="set_session_large_post_data_trim('requires/pre_cost_entry_controller_v2.php?action=consumption_popup_trim', 'Consumption Entry Form','<?=$i; ?>');" readonly <?=$txt_disabled; echo $cons_gmts; ?> /></td>
	                    <td>
	                        <input type="text" id="txttrimrate_<?=$i; ?>" name="txttrimrate_<?=$i; ?>" class="text_boxes_numeric" style="width:33px" value="<?=$row[csf("rate")]; ?>" onChange="calculate_trim_cost(<?=$i; ?>);" disabled onDblClick="trim_rate_popup(<?=$i; ?>);"/>
	                        
	                        <input type="hidden" name="excessper_<?=$i; ?>" id="excessper_<?=$i; ?>" value="<?=$excess_per ?>">
	                        <input type="hidden" name="excons_<?=$i; ?>" id="excons_<?=$i; ?>" qcdata="<?=$qcDataArr[$row[csf("qid")]]; ?>" value="<?=$ex_cons ?>">
	                        <input type="hidden" name="totalcons_<?=$i; ?>" id="totalcons_<?=$i; ?>" value="<?=$total_cons; ?>">
                            <input type="hidden" id="txtsourcingrate_<?=$i; ?>" name="txtsourcingrate_<?=$i; ?>"  class="text_boxes_numeric" style="width:40px" value="<?=$row[csf("sourcing_rate")]; ?>"/>
	                    </td>
	                    <td><input type="text" id="txttrimamount_<?=$i; ?>" name="txttrimamount_<?=$i; ?>" class="text_boxes_numeric" style="width:43px" value="<?=$row[csf("amount")]; ?>" readonly <?=$txt_disabled; echo $txt_dis; ?>/></td>
	                    <td>
	                        <? $total_qty += $totalqtyarray_arr[$data[0]][$row[csf("id")]]; ?>
	                        <input type="text" id="totalqty_<?=$i; ?>" name="totalqty_<?=$i; ?>" class="text_boxes_numeric" style="width:43px" value="" readonly placeholder="Click to Load" onClick="loadTotal(<?=$i; ?>,'trim');" />
	                    </td>
	                    <td>
	                        <? $total_Amount += $totalamountarray_arr[$data[0]][$row[csf("id")]]; ?>
	                        <input type="text" id="totalamount_<?=$i; ?>" name="totalamount_<?=$i; ?>" class="text_boxes_numeric" style="width:43px" value="" readonly/>
	                    </td>
	                    <td><?=create_drop_down("cboapbrequired_" . $i, 40, $yes_no, "", 0, "0", $row[csf("apvl_req")], '', $disabled, ''); ?></td>
	                    <td><?=create_drop_down( "cboitemprint_".$i, 50, $itemPrintArr,"", 1, "-Select-", $row[csf("item_print")], '',$disabled,'' ); ?></td>
	                    <td><input type="button" class="image_uploader" style="width:40px" id="btnimg_<?=$i; ?>" value="IMG" onClick="file_uploader ( '../../', '<?=$row[csf("id")]; ?>','', 'pre_cost_trimsv2', 0 ,1)"/></td>
	                    <td>
                         	<input type="hidden" id="isconspopupupdate_<?=$i; ?>" name="isconspopupupdate_<?=$i; ?>" class="text_boxes" style="width:20px" value="0" disabled/>
	                        <input type="button" id="increasetrim_<?=$i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_trim_cost(<?=$i; ?> );" <?=$txt_disabled; ?> />
	                        <input type="button" id="decreasetrim_<?=$i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<?=$i; ?> ,'tbl_trim_cost',this);" <?=$txt_disabled; ?> />
	                        <input type="hidden" id="updateidtrim_<?=$i; ?>" name="updateidtrim_<?=$i; ?>" style="width:20px" value="<?=$row[csf("id")]; ?>"/>
	                        <input type="hidden" id="quotdtlsidtrim_<?=$i; ?>" name="quotdtlsidtrim_<?=$i; ?>" style="width:20px" value="<?=$row[csf("qid")]; ?>"/>
	                        <input type="hidden" id="consbreckdown_<?=$i; ?>" name="consbreckdown_<?=$i; ?>"  style="width:20px" value="<? //echo  $cons_breack_down; ?>"/>
	                        <input type="hidden" id="calculatorstring_<?=$i; ?>" name="calculatorstring_<?=$i; ?>" style="width:20px" value="<?=$row[csf("calculatorstring")]; ?>"/>
	                    </td>
	                </tr>
	                <?
	            }
	        }
	        else {
	            $gmts_item_sql = sql_select("select gmts_item_id, set_item_ratio from wo_po_details_mas_set_details where job_no='$data[0]'");
	            foreach ($gmts_item_sql as $gmts_item_row) {
	                $item_ratio_arr[$gmts_item_row[csf('gmts_item_id')]] = $gmts_item_row[csf('set_item_ratio')];
	            }
	    
	            $totitem = count($item_ratio_arr);
	            $trim_rate_from_library = return_library_array("select a.id, min(b.rate) as rate from lib_item_group a, lib_item_group_rate b where a.id=b.mst_id and a.item_category=4 and a.status_active=1 and	a.is_deleted=0 group by a.id", "id", "rate");
	            $save_update = 0;
	            $data_array = sql_select("select min(a.id) as id, a.trims_group, a.cons_uom, a.sup_ref, a.cons_dzn_gmts, a.purchase_rate, a.amount, a.apvl_req, a.supplyer ,a.item_description from  lib_trim_costing_temp a,lib_trim_costing_temp_dtls b  where a.id=b.lib_trim_costing_temp_id and b.buyer_id='$data[1]' and a.status_active=1 and  a.is_deleted=0 and and b.buyer_id>0 group by a.id,a.trims_group, a.cons_uom,a.sup_ref, a.cons_dzn_gmts, a.purchase_rate, a.amount, a.apvl_req, a.supplyer,a.item_description order by a.id");
	            if (count($data_array) > 0) {
	                $i = 0;
	                foreach ($data_array as $row) {
	                    $rate = $trim_rate_from_library[$row[csf('trims_group')]];
	                    $amount = $row[csf('cons_dzn_gmts')] * $trim_rate_from_library[$row[csf('trims_group')]];
	                    if ($rate == "" || $rate == 0) {
	                        $rate = $row[csf('purchase_rate')];
	                        $amount = $row[csf('amount')];
	                    }
	                    $i++;
						if($save_update==0)
						{
							$row[csf("fabric_source")]=$deFabSource;
							if($deFabSource==3) $sourceDis="1";
						}
						else
						{
							if($deFabSource==3) $sourceDis="1";
						}
						if($disabled==1) $sourceDis=$disabled;
						
	                    ?>
	                    <tr id="trim_<?=$i; ?>" align="center">
	                        <td><input type="hidden" id="cbotrimstatus_<?=$i; ?>" name="cbotrimstatus_<?=$i; ?>" class="text_boxes" style="width:18px" value="1"/> <input type="text" id="seq_<?=$i; ?>" name="seq_<?=$i; ?>" class="text_boxes_numeric" style="width:18px" value="<?=$i; ?>"/></td>
	                        <td>
	                            <input placeholder="Browse" type="text" title="<?=$lib_item_group_arr[$row[csf("trims_group")]]; ?>" readonly id="cbogrouptext_<?=$i; ?>" name="cbogroup_<?=$i; ?>" class="text_boxes" style="width:88px" value="<?=$lib_item_group_arr[$row[csf("trims_group")]]; ?>" <?=$txt_disabled; ?> onDblClick="openpopup_itemgroup(<?=$i; ?>);"/>
	                            <input type="hidden" id="cbogroup_<?=$i; ?>" name="cbogroup_<?=$i; ?>" class="text_boxes" style="width:60px" value="<?=$row[csf("trims_group")]; ?>" <?=$txt_disabled; ?> />
                                <input type="hidden" id="lastappidchk_<?=$i; ?>" name="lastappidchk_<?=$i; ?>" class="text_boxes" style="width:10px" value="" readonly  />
	                        </td>
	                        <td>
	                            <input type="text" id="countrytext_<?=$i; ?>" name="countrytext_<?=$i; ?>" class="text_boxes" style="width:78px" value="" <?=$txt_disabled; ?> onDblClick="open_country_popup(<?=$i; ?>,0);" placeholder="Browse" readonly/>
	                            <input type="hidden" id="country_<?=$i; ?>" name="country_<?=$i; ?>" class="text_boxes" style="width:75px" value="" <?=$txt_disabled; ?> />
	                        </td>
	                        <td><input type="text" placeholder="Browse" id="txtdescription_<?=$i; ?>" name="txtdescription_<?=$i; ?>" class="text_boxes" style="width:188px" value="<?=$row[csf("item_description")]; ?>" <?= $txt_disabled; echo $readonly_rate ?> onDblClick="trims_description_popup(<?=$i; ?>);"/>
							<input type="hidden" id="supplierwiserate_<?= $i?>" value="0">
							</td>
	                        <td><input type="text" id="txtsupref_<?=$i; ?>" name="txtsupref_<?=$i; ?>" maxlength="20" class="text_boxes" style="width:78px" value="<?=$row[csf("sup_ref")]; ?>" <?=$txt_disabled; ?> /></td>
	                        <td><input class="text_boxes" type="text" style="width:98px;" name="txtremark_<?=$i; ?>" id="txtremark_<?=$i; ?>" maxlength="500" title="Maximum 500 Character" <?=$txt_disabled; ?> /></td>
	                        <td><? asort($commission_particulars); echo create_drop_down( "cbosourceid_".$i, 70, $commission_particulars, "", 1, "-Select-", $row[csf("source_id")], "","","" ); ?></td>
	                        <td>
	                            <? asort($fabric_source);
	                                echo create_drop_down( "cbomaterialsource_".$i, 80, $fabric_source, "", 0, "", $deFabSource, "",$sourceDis,"2,3,4,5" );
	                            ?>
	                        </td>
	                        <td id="tdsupplier_<?=$i; ?>">
	                            <input readonly type="text" id="txtnominasupplier_<?=$i; ?>" name="txtnominasupplier_<?=$i; ?>" class="text_boxes" placeholder="Browse" style="width:78px" value="<?=$nominated_supp_str; ?>" <?=$txt_disabled; echo $txt_dis; ?> onDblClick="fncopenpopup_trimsupplier(<?=$i; ?>);"/>
	                            <input type="hidden" id="cbonominasupplier_<?=$i; ?>" name="cbonominasupplier_<?=$i; ?>" class="text_boxes" style="width:60px" value="<?=$row[csf("nominated_supp_multi")]; ?>" />
	                    </td>
	                        
	                        <td><?=create_drop_down("cboconsuom_" . $i, 50, $unit_of_measurement, "", 1, "-- Select --", $row[csf("cons_uom")], "", 1, ""); ?></td>
	                        <td><input type="text" id="txtconsdzngmts_<?=$i; ?>" name="txtconsdzngmts_<?=$i; ?>" class="text_boxes_numeric" style="width:33px" value="<?= number_format($row[csf("cons_dzn_gmts")]*$totitem, 4); ?>" onChange="calculate_trim_cost(<?=$i; ?>);" onDblClick="set_session_large_post_data_trim('requires/pre_cost_entry_controller_v2.php?action=consumption_popup_trim', 'Consumption Entry Form','<?=$i; ?>');" readonly/></td>
	                        <td>
	                            <input type="text" id="txttrimrate_<?=$i; ?>" name="txttrimrate_<?=$i; ?>" class="text_boxes_numeric" style="width:33px" value="<?=number_format($rate,4); ?>" onChange="calculate_trim_cost(<?=$i; ?>);" disabled onDblClick="trim_rate_popup(<?=$i; ?>);"/>
	                            <input type="hidden" name="excessper_<?=$i; ?>" id="excessper_<?=$i; ?>" value="">
	                            <input type="hidden" name="excons_<?=$i; ?>" id="excons_<?=$i; ?>" value="">
	                            <input type="hidden" name="totalcons_<?=$i; ?>" id="totalcons_<?=$i; ?>" value="">
                                 <input type="hidden" id="txtsourcingrate_<?=$i; ?>" name="txtsourcingrate_<?=$i; ?>"  class="text_boxes_numeric" style="width:40px" value=""/>
	                        </td>
	                        <td><input type="text" id="txttrimamount_<?=$i; ?>" name="txttrimamount_<?=$i; ?>" class="text_boxes_numeric" style="width:43px" value="<?= number_format($amount*$totitem,4); ?>" readonly/></td>
	                        <td><input type="text" id="totalqty_<?=$i; ?>" name="totalqty_<?=$i; ?>" class="text_boxes_numeric" style="width:43px" value="" readonly placeholder="click to load" onClick="loadTotal(<?=$i; ?>,'trim');"/></td>
	                        <td><input type="text" id="totalamount_<?=$i; ?>" name="totalamount_<?=$i; ?>" class="text_boxes_numeric" style="width:43px" value="" readonly/></td>
	                        <td><?=create_drop_down("cboapbrequired_".$i, 40, $yes_no, "", 0, "0", $row[csf("apvl_req")], '', '', ''); ?></td>
	                        <td><?=create_drop_down( "cboitemprint_".$i, 50, $itemPrintArr,"", 1, "-Select-", $selected, '',$disabled,'' ); ?></td>
	                        <td>&nbsp;</td>
	                        <td>
                             <input type="hidden" id="isconspopupupdate_<?=$i; ?>" name="isconspopupupdate_<?=$i; ?>" class="text_boxes" style="width:20px" value="0" disabled/>
	                            <input type="button" id="increasetrim_<?=$i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_trim_cost(<?=$i; ?>);"/>
	                            <input type="button" id="decreasetrim_<?=$i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<?=$i; ?>,'tbl_trim_cost',this);"/>
	                            <input type="hidden" id="updateidtrim_<?=$i; ?>" name="updateidtrim_<?=$i; ?>" class="text_boxes" style="width:20px" value=""/>
	                            <input type="hidden" id="quotdtlsidtrim_<?=$i; ?>" name="quotdtlsidtrim_<?=$i; ?>" style="width:20px" value=""/>
	                            <input type="hidden" id="consbreckdown_<?=$i; ?>" name="consbreckdown_<?=$i; ?>" class="text_boxes" style="width:20px" value=""/>
	                            <input type="hidden" id="calculatorstring_<?=$i; ?>" name="calculatorstring_<?=$i; ?>" class="text_boxes" style="width:20px" value=""/>
	                        </td>
	                    </tr>
	                    <?
	                }
	            } else {
	                $save_update = 0;
					if($save_update==0)
					{
						$row[csf("fabric_source")]=$deFabSource;
						if($deFabSource==3) $sourceDis="1";
					}
					else
					{
						if($deFabSource==3) $sourceDis="1";
					}
					if($disabled==1) $sourceDis=$disabled;
	                ?>
	                <tr id="trim_1" align="center">
	                    <td><input type="hidden" id="cbotrimstatus_1" name="cbotrimstatus_1" class="text_boxes" style="width:18px" value="1"/> <input type="text" id="seq_1" name="seq_1" class="text_boxes_numeric" style="width:18px" value="1"/>
	                    </td>
	                    <td>
	                        <input placeholder="Browse" title="<?=$lib_item_group_arr[$row[csf("trims_group")]]; ?>" type="text" readonly id="cbogrouptext_1" name="cbogroup_1" class="text_boxes" style="width:88px" value="" onDblClick="openpopup_itemgroup(1);"/>
	                        <input type="hidden" id="cbogroup_1" name="cbogroup_1" class="text_boxes" style="width:60px" value=""/>
                            <input type="hidden" id="lastappidchk_1" name="lastappidchk_1" class="text_boxes" style="width:10px" value="" readonly  />
	                    </td>
	                    <td>
	                        <input type="text" id="countrytext_1" name="countrytext_1" class="text_boxes" style="width:78px" value="" placeholder="Browse" <?=$txt_disabled; ?> onDblClick="open_country_popup(1,0);" readonly/>
	                        <input type="hidden" id="country_1" name="country_1" class="text_boxes" style="width:70px" value="" <?=$txt_disabled; ?> />
	                    </td>
	                    <td><input type="text" placeholder="Browse" id="txtdescription_1" name="txtdescription_1" class="text_boxes" style="width:188px" value="" <?=$txt_disabled; echo $readonly_rate ?>  onDblClick="trims_description_popup(1);"/>
						<input type="hidden" id="supplierwiserate_1" value="0">
						</td>
	                    <td><input type="text" id="txtsupref_1" name="txtsupref_1" maxlength="20" class="text_boxes" style="width:78px" value="" <?=$txt_disabled; ?> /></td>
	                    <td><input class="text_boxes" type="text" style="width:98px;" name="txtremark_1" id="txtremark_1" maxlength="500" title="Maximum 500 Character" <?=$txt_disabled; ?> /></td>
	                     <td><? asort($commission_particulars); echo create_drop_down( "cbosourceid_1", 70, $commission_particulars, "", 1, "-Select-", "", "","","" ); ?></td>
	                    <td>
	                        <? asort($fabric_source);
	                            echo create_drop_down( "cbomaterialsource_1", 80, $fabric_source, "", 0, "", $deFabSource, "",$sourceDis,"2,3,4,5" );
	                        ?>
	                    </td>
	                    <td id="tdsupplier_1">
	                        <input readonly type="text" id="txtnominasupplier_1" name="txtnominasupplier_1" class="text_boxes" placeholder="Browse" style="width:78px" value="" onDblClick="fncopenpopup_trimsupplier(1);"/>
	                        <input type="hidden" id="cbonominasupplier_1" name="cbonominasupplier_1" class="text_boxes" style="width:60px" value="" />
	                    </td>
	                    <td><?=create_drop_down("cboconsuom_1", 50, $unit_of_measurement, "", 1, "-- Select --", '', "", 1, ""); ?></td>
	                    <td><input type="text" id="txtconsdzngmts_1" name="txtconsdzngmts_1" class="text_boxes_numeric" placeholder="Browse" style="width:33px" value="<?=$row[csf("cons_dzn_gmts")]; ?>" onChange="calculate_trim_cost(1);" onDblClick="set_session_large_post_data_trim('requires/pre_cost_entry_controller_v2.php?action=consumption_popup_trim', 'Consumption Entry Form',1);" readonly/></td>
	                    <td>
	                        <input type="text" id="txttrimrate_1" name="txttrimrate_1" class="text_boxes_numeric" style="width:33px" value="" onChange="calculate_trim_cost(1);" disabled onDblClick="trim_rate_popup(1);"/>
	                        <input type="hidden" name="excessper_1" id="excessper_1" value="0">
	                        <input type="hidden" name="excons_1" id="excons_1" value="0" qcdata="0">
	                        <input type="hidden" name="totalcons_1" id="totalcons_1" value="0">
                             <input type="hidden" id="txtsourcingrate_1" name="txtsourcingrate_1"  class="text_boxes_numeric" style="width:40px" value="0"/>
	                    </td>
	                    <td><input type="text" id="txttrimamount_1" name="txttrimamount_1" class="text_boxes_numeric" style="width:43px" value="" readonly/></td>
	                    <td><input type="text" id="totalqty_1" name="totalqty_1" class="text_boxes_numeric" style="width:43px" readonly placeholder="Click to Load" onClick="loadTotal(1,'trim');"/></td>
	                    <td><input type="text" id="totalamount_1" name="totalamount_1" class="text_boxes_numeric" style="width:43px" readonly/></td>
	                    <td><?=create_drop_down("cboapbrequired_1", 40, $yes_no, "", 0, "0", $row[csf("apvl_req")], '', '', ''); ?></td>
	                    <td><?=create_drop_down( "cboitemprint_1", 50, $itemPrintArr,"", 1, "-Select-", $selected, '',$disabled,'' ); ?></td>
	                    <td>&nbsp;</td>
	                    <td>
                         <input type="hidden" id="isconspopupupdate_1" name="isconspopupupdate_1" class="text_boxes" style="width:20px" value="0" disabled/>
	                        <input type="button" id="increasetrim_1" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_trim_cost(1);"/>
	                        <input type="button" id="decreasetrim_1" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(1,'tbl_trim_cost',this );"/>
	                        <input type="hidden" id="updateidtrim_1" name="updateidtrim_1" class="text_boxes" style="width:20px" value=""/>
	                        <input type="hidden" id="quotdtlsidtrim_1" name="quotdtlsidtrim_1" style="width:20px" value=""/>
	                        <input type="hidden" id="consbreckdown_1" name="consbreckdown_1" class="text_boxes" style="width:20px" value=""/>
	                        <input type="hidden" id="calculatorstring_1" name="calculatorstring_1" class="text_boxes" style="width:20px" value=""/>
	                    </td>
	                </tr>
	                <?
	            }
	        }
	        ?>
	        </tbody>
	    </table>
	</div>
    <table width="1430" cellspacing="0" class="rpt_table" border="0" rules="all">
        <tfoot>
            <tr>
                <th width="30">&nbsp;</th>
                <th width="100">&nbsp;</th>
                <th width="90">&nbsp;</th>
                <th width="200">&nbsp;</th>
                <th width="90">&nbsp;</th>
                <th width="110">&nbsp;</th>
                <th width="80">&nbsp;</th>
                <th width="80">&nbsp;</th>
                <th width="90">&nbsp;</th>
                <th width="50">Sum:</th>
    
                <th width="45"><input type="text" id="txtconsdzntrim_sum" name="txtconsdzntrim_sum" class="text_boxes_numeric" style="width:33px" readonly/></th>
                <th width="45"><input type="text" id="txtratetrim_sum" name="txtratetrim_sum" class="text_boxes_numeric" style="width:33px" readonly/></th>
                <th width="55"><input type="text" id="txttrimamount_sum" name="txttrimamount_sum" class="text_boxes_numeric" style="width:43px" readonly/></th>
                <th width="55"><input type="text" id="totalqty_sum" name="totalqty_sum" class="text_boxes_numeric" style="width:43px" readonly/></th>
                <th width="55"><input type="text" id="totalamount_sum" name="totalamount_sum" class="text_boxes_numeric" style="width:43px" value="<?=number_format($total_Amount, 4, ".", ""); ?>" readonly/></th>
                <th width="40">&nbsp;</th>
                <th width="50">&nbsp;</th>
                <th width="40">&nbsp;</th>
                <th>&nbsp;</th>
            </tr>
        </tfoot>
    </table>
    <table width="1430" cellspacing="0" border="0">
        <tr>
            <td align="center" width="100%" class="button_container">
                <?
                if (count($data_array) > 0) {
                    echo load_submit_buttons($permission, "fnc_trim_cost_dtls", $save_update, 0, "fnc_resetfrom()", 6);
					//reset_form('trimccost_6','','',0,'$(\'#trim_tbl_dtls_for  tr:not(:first)\').remove()')
                } else {
                    echo load_submit_buttons($permission, "fnc_trim_cost_dtls", $save_update, 0, "fnc_resetfrom()", 6);
                }
                ?>
            </td>
        </tr>
    </table>
    </form>
    </fieldset>
    </div>
    <?
    exit();
}
	
if($action=="openpopup_trimsupplier")
{
	echo load_html_head_contents("Nominated Supplier PopUp","../../../", 1, 1, $unicode,'','');
	extract($_REQUEST);
	?>
    <script>
		function check_all_data() {
			var tbl_row_count = document.getElementById( 'supp_table' ).rows.length;
			tbl_row_count = tbl_row_count;
			if(document.getElementById('check_all').checked){
				for( var i = 1; i <= tbl_row_count; i++ ) {
				//js_set_value( i);
				document.getElementById( 'search' + i ).style.backgroundColor = 'yellow';
				if( jQuery.inArray( $('#txttrimsuppdata_' + i).val(), selected_name ) == -1 ) {
					selected_name.push($('#txttrimsuppdata_' + i).val());
				}
				else{
					for( var j = 0; j < selected_name.length; j++ ) {
						if( selected_name[j] == $('#txttrimsuppdata_' + i).val() ) break;
					}
					selected_name.splice( j,1 );
				}

				}
			}else{
				for( var i = 1; i <= tbl_row_count; i++ ) {
					if(i%2==0  ){
						document.getElementById('search'+i).style.backgroundColor = '#FFFFFF';
					}
					if(i%2!=0 ){
						document.getElementById('search'+i).style.backgroundColor = '#E9F3FF';
					}
					if( jQuery.inArray( $('#txttrimsuppdata_' + i).val(), selected_name ) == -1 ) {
						selected_name.push($('#txttrimsuppdata_' + i).val());
					}
					else{
						for( var j = 0; j < selected_name.length; j++ ) {
							if( selected_name[j] == $('#txttrimsuppdata_' + i).val() ) break;
						}
						selected_name.splice( j,1 );
					}
				}
			}
		}

		function toggle( x, origColor ) {
			var newColor = 'yellow';
			if ( x.style ) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}

		function onlyUnique(value, index, self) {
			return self.indexOf(value) === index;
		}

		var selected_name = new Array();

		function js_set_value( str ) {
			if($("#search"+str).css("display") !='none'){
				//toggle( document.getElementById( 'search' + str ), '#FFFFCC' );
				if(str%2==0  ){
					toggle( document.getElementById( 'search' + str ), '#FFFFFF');
				}
				if(str%2!=0 ){
					toggle( document.getElementById( 'search' + str ), '#E9F3FF');
				}
				if( jQuery.inArray( $('#txttrimsuppdata_' + str).val(), selected_name ) == -1 ) {
					selected_name.push($('#txttrimsuppdata_' + str).val());
				}
				else{
					for( var i = 0; i < selected_name.length; i++ ) {
						if( selected_name[i] == $('#txttrimsuppdata_' + str).val() ) break;
					}
					selected_name.splice( i,1 );
				}
			}
			var trimgroupdata='';
			for( var i = 0; i < selected_name.length; i++ ) {
				trimgroupdata += selected_name[i] + ',';
			}
			trimgroupdata = trimgroupdata.substr( 0, trimgroupdata.length - 1 );

			$('#suppdata').val( trimgroupdata );
		}
		
		function close_supp_data()
		{
			var s=$('#suppdata').val();
			//alert(s)
			parent.emailwindow.hide();
		}
	</script>
	</head>
	<body>
        <div align="center" style="width:100%;">
        <input type="hidden" id="gid" name="gid"/>
        <input type="hidden" id="suppdata" name="suppdata"/>
        <?
		$tag_buyer=return_field_value("tag_buyer as tag_buyer", "lib_supplier_tag_buyer", "tag_buyer=$buyer","tag_buyer");
	
		if($tag_buyer!='')
		{
			$supplier_library=return_library_array( "select a.supplier_name,a.id from lib_supplier a, lib_supplier_party_type b,lib_supplier_tag_buyer c where a.id=b.supplier_id and a.id=c.supplier_id and b.supplier_id=c.supplier_id and c.tag_buyer=$tag_buyer and b.party_type in(4,5) and a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
		}
		else
		{
			$supplier_library=return_library_array( "select a.supplier_name,a.id from  lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(4,5) and a.is_deleted=0 and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
		}
		
		?>
        <table width="420" cellspacing="0" class="rpt_table" border="0" rules="all">
            <thead>
            	<th width="40">SL</th>
                <th>Supplier Name</th>
            </thead>
        </table>
        <div style="width:420px; overflow-y:scroll; max-height:340px;" >
        <table width="400" cellspacing="0" class="rpt_table" border="0" rules="all" id="supp_table">
            <tbody>
				<?
                $i=1;
                if($nominasupplier != '')
                {
                	$nominatedsup_arr = explode(",", $nominasupplier);
                }
                foreach($supplier_library as $sid=>$sname)
				{
					if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					$str="";
					$str=$sid.'***'.$sname;
					/*if(in_array($sid, $nominatedsup_arr)){
						$bgcolor = 'yellow';
					}*/
					?>
					<tr id="search<?=$i;?>" onClick="js_set_value(<?=$i; ?>);" bgcolor="<?=$bgcolor; ?>" style="cursor:pointer">
						<td width="40"><?=$i; ?></td>
                        <td><?=$sname; ?>
                        	<input type="hidden" name="txttrimsuppdata_<?=$i; ?>" id="txttrimsuppdata_<?=$i; ?>" value="<?=$str; ?>"/>
                        </td>
					</tr>
					<script type="text/javascript">
                        <?
                            if(in_array($sid, $nominatedsup_arr)){
                                echo "var match_data=1;\n";
                                echo "var sequ=".$i.";\n";
                            }
                            else{
                                echo "var match_data=2;\n";
                            }
                        ?>
                        if(match_data==1)
                        {
                           js_set_value(sequ);
                        }
                    </script>
					<?
					$i++;
                }
                ?>
            </tbody>
        </table>
        </div>
        <table width="420" cellspacing="0" cellpadding="0" style="border:none" align="center">
        <tr>
            <td align="center" height="30" valign="bottom">
                <div style="width:100%">
                    <div style="width:50%; float:left" align="left">
                    	<input type="checkbox" name="check_all" id="check_all" onClick="check_all_data();" /> Check / Uncheck All
                    </div>
                    <div style="width:50%; float:left" align="left">
                    	<input type="button" name="close" onClick="close_supp_data();" class="formbutton" value="Close" style="width:100px" />
                    </div>
                </div>
            </td>
        </tr>
	</table>
    </div>
    </body>
	<script>setFilterGrid('supp_table',-1);</script>
	<!--<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>-->
	</html>
	<?
	exit();
}

if ($action=="trims_description_popup")
{
	echo load_html_head_contents("Description","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	$data=$data;
	if($rate_variable==4){
	?>
	<script>
        var selected_name = new Array();
        function check_all_data() {
            var tbl_row_count = document.getElementById( 'item_table' ).rows.length;
            tbl_row_count = tbl_row_count-1;
            if(document.getElementById('check_all').checked){
                for( var i = 1; i <= tbl_row_count; i++ ) {
                    document.getElementById( 'search' + i ).style.backgroundColor = 'yellow';
                    if( jQuery.inArray( $('#txttrimgroupdata_' + i).val(), selected_name ) == -1 ) {
                        selected_name.push($('#txttrimgroupdata_' + i).val());
                    }
                }
                var trimgroupdata='';
                for( var i = 0; i < selected_name.length; i++ ) {
                    trimgroupdata += selected_name[i] + '__';
                }
                trimgroupdata = trimgroupdata.substr( 0, trimgroupdata.length - 2 );
                $('#itemdata').val( trimgroupdata );
            }else{
                for( var i = 1; i <= tbl_row_count; i++ ) {
                    if(i%2==0  ){
                        document.getElementById('search'+i).style.backgroundColor = '#FFFFFF';
                    }
                    if(i%2!=0 ){
                        document.getElementById('search'+i).style.backgroundColor = '#E9F3FF';
                    }
                    for( var j = 0; j < selected_name.length; j++ ) {
                            if( selected_name[j] == $('#txttrimgroupdata_' + i).val() ) break;
                    }
                    selected_name.splice( j,1 );
                }
                var trimgroupdata='';
                for( var i = 0; i < selected_name.length; i++ ) {
                    trimgroupdata += selected_name[i] + '__';
                }
                trimgroupdata = trimgroupdata.substr( 0, trimgroupdata.length - 2 );
                $('#itemdata').val( trimgroupdata );

            }

        }

        function toggle( x, origColor ) {
            var newColor = 'yellow';
            if ( x.style ) {
                x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
            }
        }

        function onlyUnique(value, index, self) {
            return self.indexOf(value) === index;
        }

        //var selected_name = new Array();

        function js_set_value( str ) {
            var tbl_row_count = document.getElementById( 'item_table' ).rows.length;
            tbl_row_count = tbl_row_count-1;
            if($("#search"+str).css("display") !='none'){
                //toggle( document.getElementById( 'search' + str ), '#FFFFCC' );
                if(str%2==0  ){
                    toggle( document.getElementById( 'search' + str ), '#FFFFFF');
                }
                if(str%2!=0 ){
                    toggle( document.getElementById( 'search' + str ), '#E9F3FF');
                }
                if( jQuery.inArray( $('#txttrimgroupdata_' + str).val(), selected_name ) == -1 ) {
                    selected_name.push($('#txttrimgroupdata_' + str).val());
                }
                else{
                    for( var i = 0; i < selected_name.length; i++ ) {
                        if( selected_name[i] == $('#txttrimgroupdata_' + str).val() ) break;
                    }
                    selected_name.splice( i,1 );
                }
            }
            var trimgroupdata='';
            for( var i = 0; i < selected_name.length; i++ ) {
                trimgroupdata += selected_name[i] + '__';
            }
            if(selected_name.length == tbl_row_count){
                document.getElementById("check_all").checked = true;
            }
            else{
                document.getElementById("check_all").checked = false;
            }
            trimgroupdata = trimgroupdata.substr( 0, trimgroupdata.length - 2 );

            $('#itemdata').val( trimgroupdata );
        }
    </script>
	<? } else{ ?>
    <script>
		$( document ).ready(function() {
			document.getElementById("description").value='<? echo $data; ?>';
		});		
    </script>
	<? } ?>
    <body>
		<div align="center" style="width:100%;">
		<input type="hidden" id="itemdata" name="itemdata"/>
        <? echo load_freeze_divs ("../../",$permission,1); ?>
			<?
			if($rate_variable==4){
				$pc_date_time=explode(" ",$pc_date_time);

				$sql_data = sql_select("SELECT distinct lsw.id , lsw.supplier_id, lsw.item_group_id,lsw.item_details_id,lsw.rate,lsw.effective_from, lsw.supplier_code, lsw.remarks, lib_item_group.item_name, lib_item_group.order_uom,lib_item_details.tag_buyer, lib_item_group.trim_uom as cons_uom,lib_supplier.supplier_name, lib_item_group.conversion_factor ,lib_item_details.item_code,lib_item_details.item_description from lib_supplier_wise_rate lsw left join (SELECT item_details_id,supplier_id,max(effective_from) as effectivedate from lib_supplier_wise_rate  where trunc(effective_from) <= to_date('$pc_date_time[0]','DD-MM-YYYY' ) and item_group_id = $item group by supplier_id,item_details_id) last_rate on lsw.supplier_id = last_rate.supplier_id left outer join lib_item_details on lib_item_details.id = lsw.item_details_id left outer join lib_supplier on lib_supplier.id = lsw.supplier_id left outer join lib_item_group on lib_item_group.id = lsw.item_group_id  where lsw.effective_from = last_rate.effectivedate and lsw.item_group_id = $item and lib_item_details.item_description is not null order by lib_supplier.supplier_name asc");
				?>
				<table width="800" cellspacing="0" class="rpt_table" border="0" rules="all">
					<thead>
						<th width="40">SL</th>
						<th  width="80">Item Group</th>
						<th width="150">Description</th>
						<th width="50">Item Code</th>
						<th width="120">Supplier Name</th>
						<th width="80">Supplier Code</th>
						<th width="50">Order UOM</th>
						<th width="50">Order Rate($)</th>
						<th width="60">Effective Date</th>
						<th width="80">Remarks</th>
					</thead>
				</table>
				<table width="800" cellspacing="0" class="rpt_table" border="0" rules="all" id="item_table">
					<tbody>
					<?
					$i=1;
					foreach($sql_data as $row)
					{
						if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
						$str="";
						$str=$row[csf('item_group_id')].'***'.$row[csf('item_name')].'***'.$row[csf('item_description')].'***'.$row[csf('order_uom')].'***'.$row[csf('rate')].'***'.$row[csf('supplier_id')].'***'.$row[csf('supplier_name')].'***'.$row[csf('id')];
						?>
						<tr id="search<? echo $i;?>" onClick="js_set_value(<? echo $i; ?>)" bgcolor="<? echo $bgcolor; ?>">
							<td width="40"><? echo $i; ?></td>
							<td  width="80"><? echo $row[csf('item_name')]; ?>
								<input type="hidden" name="txttrimgroupdata_<? echo $i; ?>" id="txttrimgroupdata_<? echo $i; ?>" value="<? echo $str; ?>"/>
							</td>
							<td width="150"><? echo $row[csf('item_description')]; ?></td>
							<td width="50" align="center"><? echo $row[csf('item_code')]; ?></td>
							<td width="120"><? echo $row[csf('supplier_name')]; ?></td>
							<td width="80" align="center"><? echo $row[csf('supplier_code')]; ?></td>
							<td width="50" align="center"><? echo $unit_of_measurement[$row[csf('order_uom')]]; ?></td>
							<td width="50" align="right"><? echo $row[csf('rate')]; ?></td>
							<td width="60" align="center"><? echo change_date_format($row[csf('effective_from')]); ?></td>
							<td width="80"><p><? echo $row[csf('remarks')]; ?></p></td>
						</tr>
						<?
						$i++;
					}
					?>
					</tbody>
				</table>
				<table width="800" cellspacing="0" cellpadding="0" style="border:none" align="center">
					<tr>
						<td align="center" height="30" valign="bottom">
							<div style="width:100%">
								<div style="width:50%; float:left" align="left">
									<input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
								</div>
								<div style="width:50%; float:left" align="left">
									<input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
								</div>
							</div>
						</td>
					</tr>
				</table>
			<? } else{?>
			<form>
				<fieldset style="width:450px;">
				<table align="center" cellspacing="0" width="450" class="rpt_table" border="1" rules="all" id="size_tbl" >
					<tr id="row_1">
						<td width="150" align="center" >
							<textarea name="description" id="description" class="text_area" style="width:430px; height:100px;" maxlength="500" title="Maximum 500 Character"></textarea>
						</td>
					</tr>
				</table>

				<table align="center" cellspacing="0" width="450" class="rpt_table" border="1" rules="all" id="" >
					<tr>
						<td align="center">
						<input type="hidden" name="hidden_appv_cause" id="hidden_appv_cause" class="text_boxes /">
							<input type="button" name="close" class="formbutton" value="Close" id="main_close" onClick="parent.emailwindow.hide();" style="width:100px" />
						</td>
					</tr>
				</table>
				</fieldset>
			</form>
			<? } ?>
        </div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    <script>
		$( "#description" ).focus();
	</script>
	<? if($rate_variable==4){ ?>
		<script>setFilterGrid('item_table',-1);</script>
	<? } ?>
    </html>
    <?
	exit();
}

if($action=="load_total_qtyAmount")
{
	$exdata=explode("__",$data);
	$condition= new condition();
	if(str_replace("'","",$exdata[0]) !=''){
		$condition->job_no("='$exdata[0]'");
	}
	$condition->init();
	if($exdata[1]=="trim")
	{
		$trim= new trims($condition);
		//echo $trim->getQuery(); die;
		$totalamountarray_arr=$trim->getAmountArray_by_jobAndPrecostdtlsid();
		$totalqtyarray_arr=$trim->getQtyArray_by_jobAndPrecostdtlsid();
		//$totalamountarray_arr=$trim->getAmountArray_by_jobAndPrecostdtlsid_consAndTotcons();
		//$totalqtyarray_arr=$trim->getQtyArray_by_jobAndPrecostdtlsid_consAndTotcons();
		//echo "<pre>";
		//print_r($totalqtyarray_arr);
		$response=array();
		foreach($totalqtyarray_arr as $job=>$PrecostdtlsidArr){
			foreach($PrecostdtlsidArr as $Precostdtlsid=> $value){
				$response['qty'][$Precostdtlsid]=number_format($totalqtyarray_arr[$job][$Precostdtlsid],2,".","");
				$response['amt'][$Precostdtlsid]=number_format($totalamountarray_arr[$job][$Precostdtlsid],2,".","");
			}
		}
	}
	if($exdata[1]=="fabric")
	{
		$fabric= new fabric($condition);
		//echo $fabric->getQuery(); die;
		$fabric_qty_arr=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
		$fabric_amount_arr=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();

		//$totalamountarray_arr=$trim->getAmountArray_by_jobAndPrecostdtlsid();
		//$totalqtyarray_arr=$trim->getQtyArray_by_jobAndPrecostdtlsid();
		$response=array();


		if($fabric_qty_arr['knit']['grey'] > 0){
			foreach($fabric_qty_arr['knit']['grey'] as $precostdtls_id=>$uomval){
				foreach($uomval as $uom=>$value){
					$response['qty'][$precostdtls_id]=number_format($value,4,".","");
					$response['amt'][$precostdtls_id]=number_format($fabric_amount_arr['knit']['grey'][$precostdtls_id][$uom],4,".","");
				}
			}
		}
		if($fabric_qty_arr['woven']['grey'] > 0){
			foreach($fabric_qty_arr['woven']['grey'] as $precostdtls_id=>$uomval){
				foreach($uomval as $uom=>$value){
					$response['qty'][$precostdtls_id]=number_format($value,4,".","");
					$response['amt'][$precostdtls_id]=number_format($fabric_amount_arr['woven']['grey'][$precostdtls_id][$uom],4,".","");
				}
			}
		}
	}
	echo json_encode($response);
}

if ($action=="trims_description")
{
	//extract($_REQUEST);
	//echo "select description from  wo_pre_cost_trim_cost_dtls where trim_group=$data  group by description";
	//die;
	echo substr(return_library_autocomplete("select description from  wo_pre_cost_trim_cost_dtls where trim_group=$data  group by description", "description" ), 0, -1);
}
if ($action=="set_cons_uom")
{
	//extract($_REQUEST);
	$cons_uom=return_field_value("trim_uom", "lib_item_group", "id=$data");
	echo $cons_uom; die;
}
if ($action=="rate_from_library")
{
	$data=explode("_",$data);

	$rate=0;
	if($data[1]==0)
	{

	$trim_rate_from_library=sql_select( "select a.id, min(b.rate) as rate from lib_item_group a, lib_item_group_rate b where a.id=b.mst_id and a.id=$data[0]  and a.item_category=4 and a.status_active=1 and	a.is_deleted=0 group by a.id");
	}
	else
	{
		//echo "select a.id, b.rate as rate from lib_item_group a, lib_item_group_rate b where a.id=b.mst_id and a.id=$data[0] and b.supplier_id=$data[1] and a.item_category=4 and a.status_active=1 and	a.is_deleted=0 ";
	$trim_rate_from_library=sql_select( "select a.id, b.rate as rate from lib_item_group a, lib_item_group_rate b where a.id=b.mst_id and a.id=$data[0] and b.supplier_id=$data[1] and a.item_category=4 and a.status_active=1 and	a.is_deleted=0 ");
	}

	foreach($trim_rate_from_library as $trim_rate_from_library_row)
	{
	    if($trim_rate_from_library_row[csf('rate')] !="")
		{
	     $rate=$trim_rate_from_library_row[csf('rate')];
		}
	}
	echo trim($rate); die;
}

if($action=="openpopup_itemgroup")
{
	echo load_html_head_contents("Item Group Select","../../../", 1, 1, $unicode,'','');
	extract($_REQUEST);
	?>
    <script>
		var selected_name = new Array();
		function check_all_data() {
			var tbl_row_count = document.getElementById( 'item_table' ).rows.length;
			tbl_row_count = tbl_row_count-1;
			if(document.getElementById('check_all').checked){
				for( var i = 1; i <= tbl_row_count; i++ ) {
					document.getElementById( 'search' + i ).style.backgroundColor = 'yellow';
					if( jQuery.inArray( $('#txttrimgroupdata_' + i).val(), selected_name ) == -1 ) {
						selected_name.push($('#txttrimgroupdata_' + i).val());
					}
				}
				var trimgroupdata='';
                for( var i = 0; i < selected_name.length; i++ ) {
                    trimgroupdata += selected_name[i] + '__';
                }
                trimgroupdata = trimgroupdata.substr( 0, trimgroupdata.length - 2 );
                $('#itemdata').val( trimgroupdata );
			}else{
				for( var i = 1; i <= tbl_row_count; i++ ) {
					if(i%2==0  ){
						document.getElementById('search'+i).style.backgroundColor = '#FFFFFF';
					}
					if(i%2!=0 ){
						document.getElementById('search'+i).style.backgroundColor = '#E9F3FF';
					}
					for( var j = 0; j < selected_name.length; j++ ) {
							if( selected_name[j] == $('#txttrimgroupdata_' + i).val() ) break;
					}
					selected_name.splice( j,1 );
				}
				var trimgroupdata='';
                for( var i = 0; i < selected_name.length; i++ ) {
                    trimgroupdata += selected_name[i] + '__';
                }
                trimgroupdata = trimgroupdata.substr( 0, trimgroupdata.length - 2 );
                $('#itemdata').val( trimgroupdata );

			}

		}

		function toggle( x, origColor ) {
			var newColor = 'yellow';
			if ( x.style ) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}

		function onlyUnique(value, index, self) {
			return self.indexOf(value) === index;
		}

		//var selected_name = new Array();

		function js_set_value( str ) {
			var tbl_row_count = document.getElementById( 'item_table' ).rows.length;
			tbl_row_count = tbl_row_count-1;
			if($("#search"+str).css("display") !='none'){
				//toggle( document.getElementById( 'search' + str ), '#FFFFCC' );
				if(str%2==0  ){
					toggle( document.getElementById( 'search' + str ), '#FFFFFF');
				}
				if(str%2!=0 ){
					toggle( document.getElementById( 'search' + str ), '#E9F3FF');
				}
				if( jQuery.inArray( $('#txttrimgroupdata_' + str).val(), selected_name ) == -1 ) {
					selected_name.push($('#txttrimgroupdata_' + str).val());
				}
				else{
					for( var i = 0; i < selected_name.length; i++ ) {
						if( selected_name[i] == $('#txttrimgroupdata_' + str).val() ) break;
					}
					selected_name.splice( i,1 );
				}
			}
			var trimgroupdata='';
			for( var i = 0; i < selected_name.length; i++ ) {
				trimgroupdata += selected_name[i] + '__';
			}
			if(selected_name.length == tbl_row_count){
                document.getElementById("check_all").checked = true;
            }
            else{
                document.getElementById("check_all").checked = false;
            }
			trimgroupdata = trimgroupdata.substr( 0, trimgroupdata.length - 2 );

			$('#itemdata').val( trimgroupdata );
		}
	</script>
	</head>
	<body>
        <div align="center" style="width:100%;">
        <input type="hidden" id="gid" name="gid"/>
        <input type="hidden" id="itemdata" name="itemdata"/>
        <? $sql_tgroup=sql_select( "select id, item_name, order_uom,trim_uom,trim_type from lib_item_group where item_category=4 and is_deleted=0 and status_active=1 order by item_name"); ?>
        <table width="470" cellspacing="0" class="rpt_table" border="0" rules="all">
            <thead>
            	<th width="40">SL</th>
            	<th  width="190">Item Group</th>
                <th width="50">Order Uom</th>
                 <th width="50">Cons Uom</th>
                <th width="">Trims Type</th>
            </thead>
        </table>
        <div style="width:470px; overflow-y:scroll; max-height:340px;" >
        <table width="450" cellspacing="0" class="rpt_table" border="0" rules="all" id="item_table">
            <tbody>
				<?
                $i=1;
                foreach($sql_tgroup as $row_tgroup)
				{
					if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					$str="";
					$str=$row_tgroup[csf('id')].'***'.$row_tgroup[csf('item_name')].'***'.$row_tgroup[csf('trim_uom')];
					?>
					<tr id="search<? echo $i;?>" onClick="js_set_value(<? echo $i; ?>)" bgcolor="<? echo $bgcolor; ?>">
						<td width="40"><? echo $i; ?></td>
						<td  width="190"><? echo $row_tgroup[csf('item_name')]; ?>
                        	<input type="hidden" name="txttrimgroupdata_<? echo $i; ?>" id="txttrimgroupdata_<? echo $i; ?>" value="<? echo $str; ?>"/>
                        </td>
                        <td width="50"><? echo $unit_of_measurement[$row_tgroup[csf('order_uom')]]; ?></td>
                         <td width="50"><? echo $unit_of_measurement[$row_tgroup[csf('trim_uom')]]; ?></td>
                        <td width=""><p><? echo $trim_type[$row_tgroup[csf('trim_type')]]; ?></p></td>

					</tr>
					<?
					$i++;
                }
                ?>
            </tbody>
        </table>
        </div>
        <table width="420" cellspacing="0" cellpadding="0" style="border:none" align="center">
        <tr>
            <td align="center" height="30" valign="bottom">
                <div style="width:100%">
                    <div style="width:50%; float:left" align="left">
                    	<input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                    </div>
                    <div style="width:50%; float:left" align="left">
                    	<input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                    </div>
                </div>
            </td>
        </tr>
	</table>
    </div>
    </body>
	<script>setFilterGrid('item_table',-1);</script>
	<!--<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>-->
	</html>
	<?
	exit();
}

if($action=="save_post_session_trim"){
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$_SESSION['logic_erp']['cons_breck_downn_trim']="";
	$_SESSION['logic_erp']['cons_breck_downn_trim']=$cons_breck_downn_trim;
	echo 1;
	die;
}

if($action=="rate_calculator_parameter_popup")
{
	echo load_html_head_contents("Country","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
		var rate_calculator_parameter = '<? echo $rate_calculator_parameter; ?>';

		function fnc_totRateCal()
		{
			var all_data="";

			if(rate_calculator_parameter==2)
			{
				all_data=$('#txtlength_1').val()+'~~'+$('#txtwidth_1').val()+'~~'+$('#txtheight_1').val()+'~~'+$('#txtrate_1').val()+'~~'+$('#txtcartonrate_1').val()+'~~'+$('#txtlength_2').val()+'~~'+$('#txtwidth_2').val()+'~~'+$('#txtheight_2').val()+'~~'+$('#txtrate_2').val()+'~~'+$('#txtcartonrate_2').val()+'~~'+$('#txtfinalrate').val();

				$('#hidden_all_data').val(all_data);

				var finalRate=0;
				var ply7_1_actual_ctn=($('#txtlength_1').val()*1)+($('#txtwidth_1').val()*1)+6;
				var ply7_2_actual_ctn=($('#txtwidth_1').val()*1)+($('#txtheight_1').val()*1)+4;

				var ctn7Rate=(((((ply7_1_actual_ctn*1)*(ply7_2_actual_ctn*1))*2)/10000)*($('#txtrate_1').val()*1));
				$('#txtcartonrate_1').val( number_format(ctn7Rate,4) );

				var ply3_actual_ctn=($('#txtlength_2').val()*1)*($('#txtwidth_2').val()*1);

				var ctn3Rate=((ply3_actual_ctn/10000)*($('#txtrate_2').val()*1));
				$('#txtcartonrate_2').val( number_format(ctn3Rate,4) );
				finalRate=ctn7Rate+(ctn3Rate);
				$('#txtfinalrate').val( number_format(finalRate,4) );
			}
			else if(rate_calculator_parameter==4)
			{

			}
		}

		function js_set_value()
		{
			fnc_totRateCal();
			document.getElementById('txtfinalrate').value;
			document.getElementById('hidden_all_data').value;
			var description = $('#txtlength_1').val()+'x'+$('#txtwidth_1').val()+'x'+$('#txtheight_1').val();
			var rate_description = $('#hidden_rate_des').val();
			$('#hidden_description').val(rate_description +'@'+description);
			parent.emailwindow.hide();
		}

		function fnc_assign_all_data()
		{
			var all_data=$('#hidden_all_data').val();
			var exData=all_data.split("~~");
			if(rate_calculator_parameter==2)
			{
				$('#txtlength_1').val(exData[0]);
				$('#txtwidth_1').val(exData[1]);
				$('#txtheight_1').val(exData[2]);
				$('#txtrate_1').val(exData[3]);
				$('#txtcartonrate_1').val(exData[4]);

				$('#txtlength_2').val(exData[5]);
				$('#txtwidth_2').val(exData[6]);
				$('#txtheight_2').val(exData[7]);
				$('#txtrate_2').val(exData[8]);
				$('#txtcartonrate_2').val(exData[9]);
				$('#txtfinalrate').val(exData[10]);
			}
			else if(rate_calculator_parameter==4)
			{

			}
		}
		function supp_trim_rate_popup(i)
		{
			var cbogroup=document.getElementById('cbogroup').value;
			var txtdescription=document.getElementById('txtdescription').value;
			var cbonominasupplier=document.getElementById('cbonominasupplier').value;
			var page_link="pre_cost_entry_controller_v2.php?cbogroup="+trim(cbogroup)+"&txtdescription="+trim(txtdescription)+"&cbonominasupplier="+trim(cbonominasupplier)+"&action=supp_trim_rate_popup_page";
			emailwindow=dhtmlmodal.open('EmailBox', 'iframe', page_link, 'Rate', 'width=1000px,top=0px,height=400px,center=1,resize=1,scrolling=0;','../../')
			emailwindow.onclose=function(){
				var txt_selected_supllier=this.contentDoc.getElementById("txt_selected_supllier");
				var txt_selected_rate=this.contentDoc.getElementById("txt_selected_rate");
				var txt_selected_description=this.contentDoc.getElementById("txt_selected_description");
				var txt_uom=this.contentDoc.getElementById("txt_uom");
				document.getElementById('txtrate_'+i).value=txt_selected_rate.value;
				document.getElementById('hidden_rate_des').value=txt_selected_description.value;
				document.getElementById('hidden_carton_supplier').value=txt_selected_supllier.value;
				fnc_totRateCal()
			}
		}

	</script>
	</head>
    <body>
    <div align="center">
    <input type="hidden" name="hidden_all_data" id="hidden_all_data" value=""/>
    <input type="hidden" name="hidden_description" id="hidden_description" value=""/>
    <input type="hidden" name="hidden_rate_des" id="hidden_rate_des" value=""/>
    <input type="hidden" name="hidden_carton_supplier" id="hidden_carton_supplier" value=""/>
    <form>
		<? $sql_data=sql_select("select country_id  from wo_po_color_size_breakdown   WHERE job_no_mst='$txthidden_job' and  status_active=1 and is_deleted=0 group by country_id"); ?>

			<?
			$company_name = return_field_value("company_name", "wo_po_details_master", "job_no='$txthidden_job'");
			$country_library=return_library_array("select id,country_name from lib_country","id","country_name");
			$trim_variable=1;
			$trim_variable_sql=sql_select("select trim_rate from  variable_order_tracking where company_name='$company_name' and variable_list=35 order by id");
		//echo $txthidden_job."select trim_rate from  variable_order_tracking where company_name='$company_name' and variable_list=35 order by id";
			foreach($trim_variable_sql as $trim_variable_row)
			{
				$trim_variable=	$trim_variable_row[csf('trim_rate')];
			}
			if($trim_variable==1 || $trim_variable==0)
			{
				$trim_rate_popup="";
			}
			else
			{
				$trim_rate_popup="  onClick='supp_trim_rate_popup(1)' placeholder='Click' readonly";//onClick="supp_trim_rate_popup(1)" readonly
			}

			$item_groupArr=return_library_array( "select id, item_name from lib_item_group", "id", "item_name");

			if($rate_calculator_parameter==2)
			{
				 $rate_cal=explode('~~',$rate_cal_data);
				?>
                <table width="500" cellspacing="0" class="rpt_table" border="1" id="tbl_list_search" rules="all">
                    <thead>
                    	<tr>
                        	<th colspan="6"><? echo $item_groupArr[$item_group]; ?> (Square Mtr)</th>
                        </tr>
                    	<tr>
                            <th width="130">Details</th>
                            <th width="80">L</th>
                            <th width="80">W</th>
                            <th width="80">H</th>
                            <th width="80">Rate ($)</th>
                            <th title="(((((L+W+6)+(W+H+4))*2)/10000)*Rate ($))">Carton Rate</th>
                            <input type="hidden" id="cbogroup" name="cbogroup" value="<? echo $cbogroup ?>">
							<input type="hidden" id="cbonominasupplier" name="cbonominasupplier" value="<? echo $supplier ?>">
							<input type="hidden" id="txtdescription" name="txtdescription" value="<? echo $txtdescription ?>">
							<input type="hidden" id="cboconsuom" name="cboconsuom" value="<? echo $cboconsuom ?>">
                        </tr>
                    </thead>
                    <tr>
                        <td>MEAS IN INCH</td>
                        <td><input type="text" name="txtlength_1" id="txtlength_1" class="text_boxes_numeric" style="width:70px;" value="<? echo $rate_cal[0] ?>" onBlur="fnc_totRateCal();"/></td>
                        <td><input type="text" name="txtwidth_1" id="txtwidth_1" class="text_boxes_numeric" style="width:70px;" value="<? echo $rate_cal[1] ?>" onBlur="fnc_totRateCal();"/></td>
                        <td><input type="text" name="txtheight_1" id="txtheight_1" class="text_boxes_numeric" style="width:70px;" value="<? echo $rate_cal[2] ?>" onBlur="fnc_totRateCal();"/></td>
                        <td><input type="text" name="txtrate_1" id="txtrate_1" class="text_boxes_numeric" style="width:70px;" value="<? echo $rate_cal[3] ?>"  onBlur="fnc_totRateCal();" <? echo $trim_rate_popup;?> /></td>
                        <td><input type="text" name="txtcartonrate_1" id="txtcartonrate_1" class="text_boxes_numeric" style="width:70px;" value="<? echo $rate_cal[4] ?>" onBlur="fnc_totRateCal();"/></td>
                    </tr>
                </table>
                <br>
                <table width="500" cellspacing="0" class="rpt_table" border="1" id="tbl_list_search" rules="all" style="display: none;">
                    <thead>
                    	<tr>
                        	<th colspan="6">Top/Btm</th>
                        </tr>
                    	<tr>
                            <th width="130">Details</th>
                            <th width="80">L</th>
                            <th width="80">W</th>
                            <th width="80">H</th>
                            <th width="80">Rate ($)</th>
                            <th title="(((L*W)/10000)*Rate ($))">Top/Btm Rate</th>
                        </tr>
                    </thead>
                    <tr>
                        <td>MEAS IN INCH</td>
                        <td><input type="text" name="txtlength_2" id="txtlength_2" class="text_boxes_numeric" style="width:70px;" value="<? echo $rate_cal[5] ?>" onBlur="fnc_totRateCal();"/></td>
                        <td><input type="text" name="txtwidth_2" id="txtwidth_2" class="text_boxes_numeric" style="width:70px;" value="<? echo $rate_cal[6] ?>" onBlur="fnc_totRateCal();"/></td>
                        <td><input type="text" name="txtheight_2" id="txtheight_2" class="text_boxes_numeric" style="width:70px;" value="<? echo $rate_cal[7] ?>" onBlur="fnc_totRateCal();" disabled/></td>
                        <td>TT<input type="text" name="txtrate_2" id="txtrate_2" class="text_boxes_numeric" style="width:70px;" value="<? echo $rate_cal[8] ?>" onBlur="fnc_totRateCal();" <? echo $trim_rate_popup;?>/></td>
                        <td><input type="text" name="txtcartonrate_2" id="txtcartonrate_2" class="text_boxes_numeric" style="width:70px;" value="<? echo $rate_cal[9] ?>" onBlur="fnc_totRateCal();"/></td>
                    </tr>
                    <tr>
                    	<td colspan="6">&nbsp;</td>
                    </tr>
                    <tr>
                    	<td colspan="5" align="right" title="Carton Rate 7 Ply+(Carton Rate 3Ply Top/Btm *2)"><b>Final Rate :</b></td>
                        <td><input type="text" name="txtfinalrate" id="txtfinalrate" class="text_boxes_numeric" style="width:70px;" value="<? echo $rate_cal[10] ?>" readonly/></td>
                    </tr>
                </table>
                <table width="500" cellspacing="0" class="" border="0" align="center">
                    <tr>
                        <td align="center" width="100%" class="button_container"><input type="button" class="formbutton" value="Close" onClick="js_set_value()"/></td>
                    </tr>
                </table>
				<?
			}
			else if ($rate_calculator_parameter==4)
			{
				?>
                <table width="500" cellspacing="0" class="" border="0" align="center">
                    <tr>
                        <td align="center" width="100%" class="button_container"><input type="button" class="formbutton" value="Close" onClick="js_set_value()"/></td>
                    </tr>
                </table>
                <?
			}

			die;
            $couArr=array();
            $i=1;
            foreach($sql_data as $row)
            {
                $couArr['id'][trim($row[csf('country_id')])]=trim($row[csf('country_id')]);
                $couArr['name'][trim($row[csf('country_id')])]= $country_library[trim($row[csf('country_id')])];
                if ($i%2==0)  $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                ?>
                <tr bgcolor="<? echo $bgcolor;  ?>" style="text-decoration:none; cursor:pointer" id="search<? echo trim($row[csf('country_id')]);?>" onClick="js_set_value(<? echo trim($row[csf('country_id')]);?>)">
                    <td width="50"><? echo $i ?></td>
                    <td width="100">
                    <input type="hidden" name="txt_individual_id" id="txt_individual_id<?php echo trim($row[csf('country_id')]); ?>" value="<? echo trim($row[csf('country_id')]); ?>"/>
                    <input type="hidden" name="txt_individual_name" id="txt_individual_name<?php echo trim($row[csf('country_id')]); ?>" value="<? echo $country_library[trim($row[csf('country_id')])]; ?>"/>
                    <? echo $country_library[$row[csf('country_id')]]; ?>
                    </td>
                    <td width="100"><? echo $country_library_short[$row[csf('country_id')]]; ?></td>
                </tr>
                <?
                $i++;
            }
            $nIdcouSArr=array(); $nNamecouSArr=array();
            $couSArr=explode(",",trim($txt_country));
            foreach($couSArr as $key=>$value){
                if (in_array(trim($value), $couArr['id'])) {
                    $nIdcouSArr[]=trim($value);
                    $nNamecouSArr[]=$country_library[trim($value)];
                }
            }
            ?>
        </table>
        <table width="500" cellspacing="0" cellpadding="0" style="border:none" align="center">
            <tr>
                <td align="center" height="30" valign="bottom">
                    <div style="width:100%">
                        <div style="width:50%; float:left" align="left">
                            <input type="hidden" id="txt_selected_id" name="txt_selected_id" value="<? if(count($nIdcouSArr)>0){echo implode(",",$nIdcouSArr);}?>" />
                            <input type="hidden" id="txt_selected_name" name="txt_selected_name" value="<?  if(count($nIdcouSArr)>0){echo implode(",",$nNamecouSArr);}?> " />
                            <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                        </div>
                        <div style="width:50%; float:left" align="left">
                        	<input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                        </div>
                    </div>
                </td>
            </tr>
        </table>
    </form>
    </div>
    </body>
    <script>
		var txt_country='<? if(count($nIdcouSArr)>0){echo implode(",",$nIdcouSArr);}?> '
		var txt_country_name='<?  if(count($nIdcouSArr)>0){echo implode(",",$nNamecouSArr);}?>'

		if(trim(txt_country) !=""){
			selected_id=trim(txt_country).split(",");
			selected_name=txt_country_name.split(",");
		}
		for(var i=0; i<selected_id.length;i++){
		   if(trim(selected_id[i]) !=""){
				toggle( document.getElementById( 'search' + trim(selected_id[i]) ), '#FFFFCC' );
		   }
		}
    </script>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
	exit();
}

if ($action=="consumption_popup_trim")
{
  echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode,'','');
  extract($_REQUEST);
  $cons_breck_downn_trim= $_SESSION['logic_erp']['cons_breck_downn_trim'];
  //echo "zakaria".$cons_breck_downn_trim;
?>
<script>
	function copy_value(value,field_id,i)
	{
		var gmtssizesid=document.getElementById('gmtssizesid_'+i).value;
		var pocolorid=document.getElementById('pocolorid_'+i).value;
		var cbogmtsitem=document.getElementById('cbogmtsitem_'+i).value;
		var ponoid=document.getElementById('ponoid_'+i).value;
		//var rowCount = $('#tbl_consmption_cost tr').length-1;
		var rowCount = $('#total_trims_row').val();
		var copy_basis=$('input[name="copy_basis"]:checked').val();
		var pcs= (document.getElementById('pcs').value)*1;
		
		var tot_plancut_qty=pcsgmts=plan_cut_percent=cons=avg_cons_percent=avg_cons=requirement=calculated_cons_percent=calculated_cons=amount=calculated_amount_percent=calculated_amount=0;  var sumtotcons=totReqQty=sumamount=totRate=0; var sumcons=totReqAmt=0;
		//var tot_plancut_qty=pcsgmts=plan_cut_percent=cons=avg_cons_percent=requirement=calculated_cons_percent=amount=calculated_amount_percent=0;
		if(copy_basis=="no")  calculate_tot_cons(i);
		for(var j=i; j<=rowCount; j++)
		{
			var isDisabled = document.getElementById(field_id+j).disabled;
			if(isDisabled==false)
			{
				if(field_id=='txtitemcolor_' || field_id=='itemsizes_' || field_id=='cons_' || field_id=='exper_' || field_id=='totcons_' ||field_id=='hidRateCalStr_' || field_id=='amount_' || field_id=='place_' || field_id=='amount_' || field_id=='rate_')
				{
					var supplier_rate=$('#supplier_rate').val();
					var trim_rate_variable=$('#trim_rate_variable').val();
					if(field_id=='rate_' && trim_rate_variable==4){
						if(value>supplier_rate){
							alert("Budget Rate Can Not Greate then Supplier Rate");
							//$('#rate_'+j).val(supplier_rate);
							//return;
							value=supplier_rate;
						}
					}
				
					if(copy_basis==0){
						document.getElementById(field_id+j).value=value;
					}
					if(copy_basis==1){
						if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
					}
					else if(copy_basis==2){
						if( pocolorid==document.getElementById('pocolorid_'+j).value) document.getElementById(field_id+j).value=value;
					}
					else if(copy_basis==3){
						if( cbogmtsitem==document.getElementById('cbogmtsitem_'+j).value) document.getElementById(field_id+j).value=value;
					}
					else if(copy_basis==4){
						if( ponoid==document.getElementById('ponoid_'+j).value) document.getElementById(field_id+j).value=value;
					}
				}
			}
		}
		
		for(var j=1; j<=rowCount; j++)
		{
			var isDisabled = document.getElementById(field_id+j).disabled;
			if(isDisabled==false)
			{
				if(field_id=='cons_' || field_id=='exper_' || field_id=='rate_')
				{
					//calculate_tot_cons(j);				
					var itemratiogmts= (document.getElementById('itemratiogmts_'+j).value)*1;
					var tot_plancut_qty=document.getElementById('itempcsgmts_'+j).value*1;
					var pcsgmts=document.getElementById('pcsgmts_'+j).value*1;
					var plan_cut_percent=(pcsgmts/tot_plancut_qty)*100;
					
					var cons=document.getElementById('cons_'+j).value*1;
					var exper=document.getElementById('exper_'+j).value*1;
					
					var avg_cons_percent=(cons*plan_cut_percent)/100;
					avg_cons+=avg_cons_percent;
					
					var totexper=number_format_common((cons*exper/100),6,0)*1;
					var totcons=number_format_common(totexper+cons,6,0);
					
					var calculated_cons_percent=(totcons*plan_cut_percent)/100;
					calculated_cons+=calculated_cons_percent;
					
					document.getElementById('totcons_'+j).value=totcons;
					document.getElementById('totexper_'+j).value=totexper;
					sumcons+=cons*1;
					sumtotcons+=totcons*1;					
					var dznGmts=(pcsgmts/itemratiogmts);
					var RowtotReq=dznGmts*(totcons/pcs);
					document.getElementById('totqty_'+j).value=RowtotReq;
					totReqQty+=RowtotReq*1;
					var rate=document.getElementById('rate_'+j).value*1;
					//if(rate!=0)
					//{
						var RowtotAmt= RowtotReq*rate;
						var amount=number_format_common(totcons*rate,6,0);
						var calculated_amount_percent=(amount*plan_cut_percent)/100;
						calculated_amount+=calculated_amount_percent;
						
						document.getElementById('amount_'+j).value=amount;
						document.getElementById('totamount_'+j).value=RowtotAmt;
						sumamount+=amount*1;
						totReqAmt+=RowtotAmt*1;
						totRate+=rate*1;
					//}
					if(rate==0)
					{
						set_sum_value( 'rate_sum', 'rate_' );
					}
				}
			}
		}
		
		if(field_id=='cons_' || field_id=='exper_' || field_id=='rate_')
		{
			//alert(sumcons)
			$('#cons_sum').val( number_format_common(sumcons,6,0) );
			$('#totcons_sum').val( number_format_common(sumtotcons,6,0) );
			$('#rate_sum').val( number_format_common(totRate,6,0) );
			$('#amount_sum').val( number_format_common(sumamount,6,0) );
			
			$('#totReq_sum').val( number_format_common(totReqQty,6,0) );
			$('#totAmount_sum').val( number_format_common(totReqAmt,6,0) );
			$('#AtotReq_sum').val( number_format_common(totReqQty,6,0) );
			$('#AtotAmount_sum').val( number_format_common(totReqAmt,6,0) );
			document.getElementById('avg_cons').value=number_format_common(avg_cons, 6, 0);
			document.getElementById('avg_totcons').value=number_format_common(calculated_cons, 6, 0);
			document.getElementById('avg_amountcons').value=number_format_common(calculated_amount, 6, 0);
			document.getElementById('avg_ratecons').value=number_format_common(calculated_amount/calculated_cons, 6, 0);
		}
	}
	
	function fn_delete_down_tr(rowNo,table_id)
	{
		if(table_id=='tbl_consmption_cost')
		{
			var numRow = $('table#tbl_consmption_cost tbody tr').length;
			if(numRow==rowNo && rowNo!=1)
			{
				$('#tbl_consmption_cost tbody tr:last').remove();
			}
			set_sum_value( 'cons_sum', 'cons_'  );
			set_sum_value( 'exper_sum', 'exper_'  );
			set_sum_value( 'totcons_sum', 'totcons_'  );
			set_sum_value( 'rate_sum', 'rate_'  );
			set_sum_value( 'amount_sum', 'amount_'  );
			set_sum_value( 'pcs_sum', 'pcs_');
		}
	}
	
	function set_sum_value(des_fil_id,field_id)
	{
		if(des_fil_id=='cons_sum') var ddd={dec_type:6,comma:0};
		if(des_fil_id=='exper_sum') var ddd={dec_type:6,comma:0};
		if(des_fil_id=='totcons_sum') var ddd={dec_type:6,comma:0};
		if(des_fil_id=='rate_sum') var ddd={dec_type:6,comma:0};
		if(des_fil_id=='amount_sum') var ddd={dec_type:6,comma:0};
		if(des_fil_id=='pcs_sum') var ddd={dec_type:6,comma:0};
		if(des_fil_id=='totReq_sum') var ddd={dec_type:6,comma:0};
		if(des_fil_id=='AtotReq_sum') var ddd={dec_type:6,comma:0};
		if(des_fil_id=='totAmount_sum') var ddd={dec_type:6,comma:0};
		if(des_fil_id=='AtotAmount_sum') var ddd={dec_type:6,comma:0};

		//var rowCount = $('#tbl_consmption_cost tr').length-1;
		var rowCount = $('#total_trims_row').val();
		math_operation( des_fil_id, field_id, '+', rowCount,ddd );
		claculate_avg();
	}
	
	function js_set_value()
	{
		//var rowCount = $('#tbl_consmption_cost tr').length-1;
		var rowCount = $('#total_trims_row').val();
		var cons_breck_down="";
		for(var i=1; i<=rowCount; i++)
		{
			var ponoid=$('#ponoid_'+i).val();
			if(ponoid=='') ponoid=0;
			var itemsizes=$('#itemsizes_'+i).val();
			if(itemsizes=='') itemsizes=0;
			var cons=$('#cons_'+i).val();
			if(cons=='') cons=0;
			var place=$('#place_'+i).val();
			if(place=='') place=0;
			var pcs=$('#pcs_'+i).val();
			if(pcs=='') pcs=0;
			var cbocountry=$('#cbocountry_'+i).val();
			if(cbocountry=='') cbocountry=0;

			var exper=$('#exper_'+i).val();
			if(exper=='') exper=0;
			var totcons=$('#totcons_'+i).val();
			if(totcons=='') totcons=0;
			var totexper=$('#totexper_'+i).val();
			if(totexper=='') totexper=0;

			var cbogmtsitem=$('#cbogmtsitem_'+i).val();
			if(cbogmtsitem=='') cbogmtsitem=0;
			var pocolorid=$('#pocolorid_'+i).val();
			if(pocolorid=='') pocolorid=0;
			var gmtssizesid=$('#gmtssizesid_'+i).val();
			if(gmtssizesid=='') gmtssizesid=0;

			var rate=$('#rate_'+i).val();
			if(rate=='') rate=0;
			var amount=$('#amount_'+i).val();
			if(amount=='') amount=0;
			var colorsizetableid=$('#colorsizetableid_'+i).val();
			if(colorsizetableid=='') colorsizetableid=0;

			var hidRateCalStr=$('#hidRateCalStr_'+i).val();
			if(hidRateCalStr=='') hidRateCalStr=0;
			var itemcolor=$('#txtitemcolor_'+i).val(); 				if(itemcolor=='') itemcolor=0;

			if(cons_breck_down=="")
			{
				cons_breck_down+=ponoid+'_'+itemsizes+'_'+cons+'_'+place+'_'+pcs+'_'+cbocountry+'_'+exper+'_'+totcons+'_'+totexper+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+rate+'_'+amount+'_'+colorsizetableid+'_'+hidRateCalStr+'_'+itemcolor;
			}
			else
			{
				cons_breck_down+="__"+ponoid+'_'+itemsizes+'_'+cons+'_'+place+'_'+pcs+'_'+cbocountry+'_'+exper+'_'+totcons+'_'+totexper+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+rate+'_'+amount+'_'+colorsizetableid+'_'+hidRateCalStr+'_'+itemcolor;
			}
		}
		//alert(cons_breck_down)
		var avg_exper=document.getElementById('avg_exper').value;
		var avg_cons=document.getElementById('avg_cons').value;
		//alert(avg_exper);
		
		var calculator_string='';
		var calculator_parameter=document.getElementById('calculator_parameter').value;
		if(calculator_parameter==1){

			var txt_cons_per_gmts=document.getElementById('txt_cons_per_gmts').value;
			var txt_cons_for_mtr=document.getElementById('txt_cons_for_mtr').value;
			var txt_cons_length=document.getElementById('txt_cons_length').value;
			var txt_caculated_value=document.getElementById('txt_caculated_value').value;
			calculator_string=txt_cons_per_gmts+"_"+txt_cons_for_mtr+"_"+txt_cons_length+"_"+txt_caculated_value;
		}
		if(calculator_parameter==2){
			var txt_gmts_per_catton=document.getElementById('txt_gmts_per_catton').value;
			var txt_cost_for=document.getElementById('txt_cost_for').value;
			var txt_caculated_value=document.getElementById('txt_caculated_value').value;
			calculator_string=txt_gmts_per_catton+"_"+txt_cost_for+"_"+txt_caculated_value;
		}
		if(calculator_parameter==3){
			var txt_stiker_per_catton=document.getElementById('txt_stiker_per_catton').value;
			var txt_req_carton=document.getElementById('txt_req_carton').value;
			var txt_caculated_value=document.getElementById('txt_caculated_value').value;
			calculator_string=txt_stiker_per_catton+"_"+txt_req_carton+"_"+txt_caculated_value;
		}
		if(calculator_parameter==4){
			var txt_gmts_per_catton=document.getElementById('txt_gmts_per_catton').value;
			var txt_cost_for=document.getElementById('txt_cost_for').value;
			var txt_caculated_value=document.getElementById('txt_caculated_value').value;
			calculator_string=txt_gmts_per_catton+"_"+txt_cost_for+"_"+txt_caculated_value;
		}
		if(calculator_parameter==5){
			var txt_cons_per_gmts=document.getElementById('txt_cons_per_gmts').value;
			var txt_cons_length=document.getElementById('txt_cons_length').value;
			var txt_caculated_value=document.getElementById('txt_caculated_value').value;
			calculator_string=txt_cons_per_gmts+"_"+txt_cons_length+"_"+txt_caculated_value;
		}
		if(calculator_parameter==6){
			var txt_cons_per_gmts=document.getElementById('txt_cons_per_gmts').value;
			var txt_pcs_per_carton=document.getElementById('txt_pcs_per_carton').value;
			var txt_cons_length=document.getElementById('txt_cons_length').value;
			var txt_caculated_value=document.getElementById('txt_caculated_value').value;
			calculator_string=txt_cons_per_gmts+"_"+txt_pcs_per_carton+"_"+txt_cons_length+"_"+txt_caculated_value;
		}
		if(calculator_parameter==7){
			var txt_cons_per_gmts=document.getElementById('txt_cons_per_gmts').value;
			var txt_cons_length=document.getElementById('txt_cons_length').value;
			var txt_caculated_value=document.getElementById('txt_caculated_value').value;
			calculator_string=txt_cons_per_gmts+"_"+txt_cons_length+"_"+txt_caculated_value;
		}
		if(calculator_parameter==8){
			var txt_cons_per_gmts=document.getElementById('txt_cons_per_gmts').value;
			var txt_cons_length=document.getElementById('txt_cons_length').value;
			var txt_caculated_value=document.getElementById('txt_caculated_value').value;
			calculator_string=txt_cons_per_gmts+"_"+txt_cons_length+"_"+txt_caculated_value;

		}
		if(calculator_parameter==9){
			var qty_per_gmts=(document.getElementById('txt_qty_per_gmts').value)*1;
			var qty_per_grs=document.getElementById('txt_qty_per_grs').value;
			var txt_caculated_value=document.getElementById('txt_caculated_value').value;
			calculator_string=qty_per_gmts+"_"+qty_per_grs+"_"+txt_caculated_value;
		}
		if(calculator_parameter==10){
			var txt_cons_per_gmts=document.getElementById('txt_cons_per_gmts').value;
			var txt_cons_length=document.getElementById('txt_cons_length').value;
			var txt_caculated_value=document.getElementById('txt_caculated_value').value;
			calculator_string=txt_cons_per_gmts+"_"+txt_cons_length+"_"+txt_caculated_value;
		}
		if(calculator_parameter==11){
			var txt_cons_per_gmts=document.getElementById('txt_cons_per_gmts').value;
			var txt_cons_length=document.getElementById('txt_cons_length').value;
			var txt_caculated_value=document.getElementById('txt_caculated_value').value;
			calculator_string=txt_cons_per_gmts+"_"+txt_cons_length+"_"+txt_caculated_value;
		}
		document.getElementById('cons_breck_down').value=cons_breck_down;
		document.getElementById('calculator_string').value=calculator_string;
		claculate_avg();
		parent.emailwindow.hide();
	}
	
	//calculated_rate
	function claculate_avg(){
		var item_ratio=document.getElementById('item_ratio').value*1;
		var calculated_cons=0; var avg_cons=0; var plancutqty=0; var calculated_amount=0; var significant_row_cal=0; var avg_ex_cons_per=0;
		//var rowCount = $('#tbl_consmption_cost tr').length-1;
		var rowCount = $('#total_trims_row').val();
		//alert(rowCount)

		for(var i=1; i<=rowCount; i++){
			if(document.getElementById('cons_'+i).value =='' || document.getElementById('cons_'+i).value ==0){
				continue;
			}
			else{
				var tot_plancut_qty=document.getElementById('itempcsgmts_'+i).value*1;
				var pcsgmts=document.getElementById('pcsgmts_'+i).value*1;
				var plan_cut_percent=(pcsgmts/tot_plancut_qty)*100;

				var ex_cons_per=document.getElementById('exper_'+i).value*1;
				avg_ex_cons_per+=ex_cons_per;
				
				var cons=document.getElementById('cons_'+i).value*1;
				var avg_cons_percent=(cons*plan_cut_percent)/100;
				avg_cons+=avg_cons_percent;
				var requirement=document.getElementById('totcons_'+i).value*1;
				var calculated_cons_percent=(requirement*plan_cut_percent)/100;
				calculated_cons+=calculated_cons_percent;

				var amount=document.getElementById('amount_'+i).value*1;
				var calculated_amount_percent=(amount*plan_cut_percent)/100;
				significant_row_cal=significant_row_cal+1;
				
				calculated_amount+=calculated_amount_percent;

			}
		}
		document.getElementById('avg_cons').value=number_format_common(avg_cons, 6, 0);
		document.getElementById('avg_totcons').value=number_format_common(calculated_cons, 6, 0);
		document.getElementById('avg_amountcons').value=number_format_common(calculated_amount, 6, 0);
		document.getElementById('avg_ratecons').value=number_format_common(calculated_amount/calculated_cons, 6, 0);
		
		document.getElementById('exper_sum').value=number_format_common(avg_ex_cons_per, 6, 0);
		var calculated_exper=(document.getElementById('exper_sum').value*1)/significant_row_cal;
		//alert(significant_row_cal);
		
		document.getElementById('avg_exper').value=number_format_common(calculated_exper, 6, 0);
	}
	
	function clculate_cons_for_mtr()
	{
		var txt_cons_per_gmts=(document.getElementById('txt_cons_per_gmts').value)*1;
		var txt_costing_per=document.getElementById('txt_costing_per').value;
		if(txt_costing_per==1) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*12;
		if(txt_costing_per==2) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*1;
		if(txt_costing_per==3) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*2*12;
		if(txt_costing_per==4) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*3*12;
		if(txt_costing_per==5) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*4*12;

		var txt_cons_for_mtr= (document.getElementById('txt_cons_for_mtr').value)*1;
		var txt_cons_length= (document.getElementById('txt_cons_length').value)*1;
		document.getElementById('txt_caculated_value').value=txt_cons_for_mtr/txt_cons_length;
	}
	
	function clculate_req_eyelet()
	{
		var qty_per_gmts=(document.getElementById('txt_qty_per_gmts').value)*1;
		var qty_per_grs=document.getElementById('txt_qty_per_grs').value;
		var txt_caculated_value=(12*qty_per_gmts)/qty_per_grs;
		document.getElementById('txt_caculated_value').value= number_format_common(txt_caculated_value,6,0);
	}
	
	function clculate_req_carton()
	{
		var txt_gmts_per_catton=(document.getElementById('txt_gmts_per_catton').value)*1;
		var txt_cost_for=document.getElementById('txt_cost_for').value;
		var txt_caculated_value=(1/txt_gmts_per_catton)*txt_cost_for;
		document.getElementById('txt_caculated_value').value= number_format_common(txt_caculated_value,6,0);
	}
	
	function clculate_req_carton_stiker()
	{
		var txt_stiker_per_catton=(document.getElementById('txt_stiker_per_catton').value)*1;
		var txt_req_carton=document.getElementById('txt_req_carton').value;
		var txt_caculated_value=txt_stiker_per_catton*txt_req_carton;
		document.getElementById('txt_caculated_value').value= number_format_common(txt_caculated_value,6,0);
	}
	
	function clculate_elastic()
	{
		var txt_costing_per=document.getElementById('txt_costing_per').value;
		var txt_cons_per_gmts=(document.getElementById('txt_cons_per_gmts').value)*1;
		var txt_cons_length= (document.getElementById('txt_cons_length').value)*1;
		var cons_dzn=0;
		if(txt_costing_per==1) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*12;
		if(txt_costing_per==2) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*1;
		if(txt_costing_per==3) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*24;
		if(txt_costing_per==4) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*36;
		if(txt_costing_per==5) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*48;

		document.getElementById('txt_caculated_value').value=number_format_common(cons_dzn,6,0);
	}
	
	function clculate_gumtap()
	{
		var txt_costing_per=document.getElementById('txt_costing_per').value;
		var txt_cons_per_gmts=(document.getElementById('txt_cons_per_gmts').value)*1;
		var txt_pcs_per_carton=(document.getElementById('txt_pcs_per_carton').value)*1;
		var txt_cons_length= (document.getElementById('txt_cons_length').value)*1;
		var cons_dzn=0;
		if(txt_costing_per==1)
		{
			cons_dzn=(txt_cons_per_gmts/txt_pcs_per_carton);
			cons_dzn=(cons_dzn/txt_cons_length)*12;
		}
		if(txt_costing_per==2)
		{
			cons_dzn=(txt_cons_per_gmts/txt_pcs_per_carton);
			cons_dzn=(cons_dzn/txt_cons_length)*1;
		}
		if(txt_costing_per==3)
		{
			cons_dzn=(txt_cons_per_gmts/txt_pcs_per_carton);
			cons_dzn=(cons_dzn/txt_cons_length)*24;
		}
		if(txt_costing_per==4)
		{
			cons_dzn=(txt_cons_per_gmts/txt_pcs_per_carton);
			cons_dzn=(cons_dzn/txt_cons_length)*36;
		}
		if(txt_costing_per==5)
		{
			cons_dzn=(txt_cons_per_gmts/txt_pcs_per_carton);
			cons_dzn=(cons_dzn/txt_cons_length)*48;
		}
		document.getElementById('txt_caculated_value').value=number_format_common(cons_dzn,6,0);
	}
	
	function clculate_tagpin()
	{
		var txt_costing_per=document.getElementById('txt_costing_per').value;
		var txt_cons_per_gmts=(document.getElementById('txt_cons_per_gmts').value)*1;
		var txt_cons_length= (document.getElementById('txt_cons_length').value)*1;
		var cons_dzn=0;
		if(txt_costing_per==1) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*12;
		if(txt_costing_per==2) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*1;
		if(txt_costing_per==3) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*24;
		if(txt_costing_per==4) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*36;
		if(txt_costing_per==5) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*48;

		document.getElementById('txt_caculated_value').value=number_format_common(cons_dzn,5,0);
	}
	function clculate_sequines()
	{
		var txt_costing_per=document.getElementById('txt_costing_per').value;
		var txt_cons_per_gmts=(document.getElementById('txt_cons_per_gmts').value)*1;
		var txt_cons_length= (document.getElementById('txt_cons_length').value)*1;
		var cons_dzn=0;
		if(txt_costing_per==1) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*12;
		if(txt_costing_per==2) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*1;
		if(txt_costing_per==3) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*24;
		if(txt_costing_per==4) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*36;
		if(txt_costing_per==5) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*48;

		document.getElementById('txt_caculated_value').value=number_format_common(cons_dzn,6,0);
	}
	function calculator_value_set(i)
	{
		var txt_caculated_value=document.getElementById('txt_caculated_value').value;
		document.getElementById('tr_order').value=i;
		if(txt_caculated_value !='')
		{
			document.getElementById('cons_'+i).value=txt_caculated_value;
			copy_value(txt_caculated_value,'cons_',i);
			//calculate_tot_cons(i)
		}
	}
	
	function open_country_popup(i)
	{
		var txt_po_id=document.getElementById('ponoid_'+i).value;
		var txt_country=document.getElementById('cbocountry_'+i).value;
		var txt_country_name=document.getElementById('cbocountryname_'+i).value;
		var page_link='pre_cost_entry_controller_v2.php?action=open_country_popup';
		var title='Country';
		page_link=page_link+'&txt_po_id='+txt_po_id+'&txt_country='+txt_country+'&txt_country_name='+txt_country_name;
		emailwindow=dhtmlmodal.open('EmailBox', 'iframe', page_link, title, 'width=420px,height=350px,center=1,resize=0,scrolling=0','../')
		emailwindow.onclose=function()
		{
			var theform=this.contentDoc.forms[0];
			var theemail=this.contentDoc.getElementById("txt_selected_id");
			var theemailname=this.contentDoc.getElementById("txt_selected_name");
			document.getElementById('cbocountry_'+i).value=trim(theemail.value);
			document.getElementById('cbocountryname_'+i).value=trim(theemailname.value);
		}
	}
	
	function calculate_tot_cons(i)
	{
		var cons=document.getElementById('cons_'+i).value*1;
		var exper=document.getElementById('exper_'+i).value*1;
		var totexper=number_format_common((cons*exper/100),6,0)*1;
		var totcons=number_format_common(totexper+cons,6,0);
		document.getElementById('totcons_'+i).value=totcons;
		document.getElementById('totexper_'+i).value=totexper;
		set_sum_value('totcons_sum', 'totcons_');
		var rate=document.getElementById('rate_'+i).value*1;
		if(rate!=0) calculate_amount(i);
		else row_tot(i);
	}
	
	function calculate_amount(i)
	{
		var totcons=document.getElementById('totcons_'+i).value*1;
		var rate=document.getElementById('rate_'+i).value*1;		
		var amount=number_format_common(totcons*rate,6,0);
		document.getElementById('amount_'+i).value=amount;
		row_tot(i);
	}
	
	function calculate_rate(i)
	{
		var rate =0;
		var totcons=document.getElementById('totcons_'+i).value*1;
		var amount=document.getElementById('amount_'+i).value*1;
		if(totcons !='')
		{
			rate=number_format_common(amount/totcons,6,0);
		}
		document.getElementById('rate_'+i).value=rate;
	}
	
	function row_tot(i){
		var itemratiogmts= (document.getElementById('itemratiogmts_'+i).value)*1;
		var pcsgmts= (document.getElementById('pcsgmts_'+i).value)*1;
		var pcs= (document.getElementById('pcs').value)*1;
		var totcons= (document.getElementById('totcons_'+i).value)*1;
		var rate= (document.getElementById('rate_'+i).value)*1;
		var dznGmts=(pcsgmts/itemratiogmts);
		var RowtotReq= dznGmts*(totcons/pcs);
		var RowtotAmt= RowtotReq*rate;
		document.getElementById('totqty_'+i).value=RowtotReq;
		document.getElementById('totamount_'+i).value=RowtotAmt;
		set_sum_value('totReq_sum', 'totqty_');
		set_sum_value('totAmount_sum', 'totamount_');
		set_sum_value('AtotReq_sum', 'totqty_');
		set_sum_value('AtotAmount_sum', 'totamount_');
	}
	
	function copy_rate(value,field_id,i){
		//var rowCount = $('#tbl_consmption_cost tr').length-1;
		var rowCount = $('#total_trims_row').val();
		for(var j=i; j<=rowCount; j++)
		{
			document.getElementById(field_id+j).value=value;
			calculate_amount(j);
			row_tot(j);
		}
		set_sum_value('cons_sum', 'cons_');
		set_sum_value('exper_sum', 'exper_');
		set_sum_value('totcons_sum', 'totcons_');
		set_sum_value('rate_sum', 'rate_');
		set_sum_value('amount_sum', 'amount_');
		set_sum_value('pcs_sum', 'pcs_');
	}
	
	function supp_trim_rate_popup(i,type){
		var cbogroup=document.getElementById('cbogroup').value;
		var txtdescription=document.getElementById('txtdescription').value;
		var cbonominasupplier=document.getElementById('cbonominasupplier').value;
		var txthidden_job=document.getElementById('txthidden_job').value;
		var page_link="pre_cost_entry_controller_v2.php?cbogroup="+trim(cbogroup)+"&txtdescription="+trim(txtdescription)+"&cbonominasupplier="+trim(cbonominasupplier)+"&txthidden_job="+trim(txthidden_job)+"&action=supp_trim_rate_popup_page";
		emailwindow=dhtmlmodal.open('EmailBox', 'iframe', page_link, 'Rate', 'width=1000px,top=0px,height=400px,center=1,resize=1,scrolling=0','../../')
		emailwindow.onclose=function(){
			var txt_selected_supllier=this.contentDoc.getElementById("txt_selected_supllier");
			var txt_selected_rate=this.contentDoc.getElementById("txt_selected_rate");
			var txt_selected_description=this.contentDoc.getElementById("txt_selected_description");
			var txt_uom=this.contentDoc.getElementById("txt_uom");
			document.getElementById('cbonominasupplier').value=txt_selected_supllier.value;
			document.getElementById('txtdescription').value=txt_selected_description.value;
			document.getElementById('cboconsuom').value=txt_uom.value;
			document.getElementById('rate_'+i).value=txt_selected_rate.value;
			set_sum_value('rate_sum', 'rate_');
			copy_rate(txt_selected_rate.value,'rate_',i);
			calculate_amount(i)
			row_tot(i);
		}
	}
	
	function fnc_ratecal_parameter(inc,item_group,rate_calculator_parameter)
	{
		var str_data=$('#hidRateCalStr_'+inc).val();
		var cbogroup=$('#cbogroup').val();
		var txthidden_job=$('#txthidden_job').val();
		//alert(txthidden_job);
		var cbonominasupplier=$('#cbonominasupplier').val();
		var txtdescription=$('#txtdescription').val();
		var cboconsuom=$('#cboconsuom').val();
		var page_link='pre_cost_entry_controller_v2.php?action=rate_calculator_parameter_popup';
		var title='Rate Cal Parameter';
		page_link=page_link+'&inc='+inc+'&item_group='+item_group+'&rate_calculator_parameter='+rate_calculator_parameter+'&rate_cal_data='+str_data+'&cbogroup='+cbogroup+'&cbonominasupplier='+cbonominasupplier+'&txtdescription='+txtdescription+'&cboconsuom='+cboconsuom+'&txthidden_job='+txthidden_job;
		emailwindow=dhtmlmodal.open('EmailBox', 'iframe', page_link, title, 'width=1100px,height=350px,center=1,resize=0,scrolling=0','../../')
		emailwindow.onclose=function()
		{
			var theform=this.contentDoc.forms[0];
			var rateValue=this.contentDoc.getElementById("txtfinalrate").value;
			var strData=this.contentDoc.getElementById("hidden_all_data").value;
			var description=this.contentDoc.getElementById("hidden_description").value;
			var cbonominasupplier=this.contentDoc.getElementById("hidden_carton_supplier").value;

			document.getElementById('rate_'+inc).value=trim(rateValue);
			document.getElementById('hidRateCalStr_'+inc).value=trim(strData);
			document.getElementById('carton_description').value=trim(description);
			document.getElementById('cbonominasupplier').value=trim(cbonominasupplier);
			
			copy_value(strData,'hidRateCalStr_',inc);
			copy_value(rateValue,'rate_',inc);
		}
	}
	
</script>
</head>
<body>
<div align="center" style="width:100%;">
<?
	if($cbo_costing_per==1) $pcs_value=1*12;
	else if($cbo_costing_per==2) $pcs_value=1*1;
	else if($cbo_costing_per==3) $pcs_value=2*12;
	else if($cbo_costing_per==4) $pcs_value=3*12;
	else if($cbo_costing_per==5) $pcs_value=4*12;

	$job_order_uom=return_field_value("order_uom","wo_po_details_master","job_no='$txt_job_no'");
	$sqlcal_parameter=sql_select("select cal_parameter, rate_cal_parameter from lib_item_group where id='$cbogroup'");
	$calculator_parameter=trim($sqlcal_parameter[0][csf('cal_parameter')]);
	$rate_calculator_parameter=trim($sqlcal_parameter[0][csf('rate_cal_parameter')]);
	$calculatorstringarr=explode("_",$calculatorstring);
	
	$sql_vari_lib=sql_select("select a.excut_source from variable_order_tracking a, wo_po_details_master b where   a.company_name=b.company_name and  a.item_category_id=4  and a.variable_list=72 and b.status_active=1  and a.status_active=1 and b.job_no='$txt_job_no'");
	//$result_vari_lib=sql_select($sql_vari_lib);
	$source_from_fab_wvn=0;//$woven_category_id=0;
	foreach($sql_vari_lib as $row)
	{
		if($row[csf('excut_source')]>0)
		{
			$source_from_fab_wvn=$row[csf('excut_source')];
		}
	}
	//echo $source_from_fab_wvn.'D';
	$supplierIds=implode(",",array_unique(explode(",",$supplier)));
	unset($sql_vari_lib);
  if($source_from_fab_wvn==4) //Booking Supplier and Rate
  {
	   $sql_csapp="SELECT a.id,a.approved, a.sys_number, b.item_group_id, d.id as dtls_id,d.supp_id,d.last_approval_rate as neg_price,a.req_item_no, a.company_id,b.item_category_id, b.item_description, b.detarmination_id 
			  from req_comparative_mst a, req_comparative_dtls b,wo_po_details_master c,req_comparative_supp_dtls d
			  where a.id=b.mst_id and b.id=d.dtls_id and d.mst_id=a.id and c.style_ref_no=a.req_item_no and a.entry_form=482 and c.job_no='$txt_job_no'   and a.ready_to_approved=1 and a.approved in(1,3) and d.approved in(1,3) and b.item_group_id=$cbogroup and d.supp_id in($supplierIds)   and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0  and d.status_active=1 and d.is_deleted=0 and d.last_approval_rate>0  order by a.id,d.id,b.detarmination_id  asc";
		$sql_cs_app=sql_select($sql_csapp);
		//cbogroup  
		$is_cs_approved=0;
	  foreach($sql_cs_app as $row)
	  {
		  if($row[csf('supp_id')]!='')
		  {	 
			  $is_cs_approved=1;
		  }
	  }
	//   if($source_from_fab_wvn==4)
	//   {
	// 	  $cs_disable="disabled";
	//   }
	//   else
	//   {
	// 	  $cs_disable='';
	//   }
	  
  }
   
if($is_cs_approved==1)
{
	$cs_disable="disabled";
}
else  $cs_disable='';
//echo $cs_disable.'=A';
?>
	<fieldset>
    <div style="font-size:16px; font-weight:bold"><?=$cbogrouptext.';'; ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<?=create_drop_down( "cbo_string_search_type", 150, $string_search_type,'', 1, "-- Searching Type --" ); ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <input type="radio" name="copy_basis" value="no" >No Copy 
        <input type="radio" name="copy_basis" value="0" checked>Copy to All
        <input type="radio" name="copy_basis" value="1">Copy Gmts Size Wise
        <input type="radio" name="copy_basis" value="2">Copy Gmts Color Wise
        <input type="radio" name="copy_basis" value="3">Copy Gmts Item Wise
        <input type="radio" name="copy_basis" value="4">Copy Po Wise
        <input type="reset" value="Reset">
    </div>
    <table class="rpt_table" border="0" rules="all">
        <tr>
            <td><?
				if($calculator_parameter==1){
					$txt_cons_length=$calculatorstringarr[2];
					if($txt_cons_length=="" || $txt_cons_length==0){
						$txt_cons_length=4000;
					}
					?>
                    <legend>Sewing Thread-Comsumption Calculator</legend>
                    <table cellpadding="0" cellspacing="0" align="center" width="1020">
                        <tr>
                            <td width="100">Cons Per Garment</td>
                            <td><input type="text" id="txt_cons_per_gmts" name="txt_cons_per_gmts" class="text_boxes_numeric" onChange="clculate_cons_for_mtr();" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> style="width:100px"  value="<?=$calculatorstringarr[0]; ?>"/> Mtr</td>
                            <td width="100">Cons <?=$costing_per[$cbo_costing_per]; ?></td>
                            <td><input type="text" id="txt_cons_for_mtr" name="txt_cons_for_mtr" class="text_boxes_numeric" style="width:100px" value="<?=$calculatorstringarr[1]  ?>" readonly/> Mtr</td>
                            <td width="100">Cone Length</td>
                            <td><input type="text" id="txt_cons_length" name="txt_cons_length" class="text_boxes_numeric" onChange="clculate_cons_for_mtr();"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> style="width:100px" value="<?=$txt_cons_length; ?>"/> Mtr</td>
                            <td width="100">Cons  <?=$costing_per[$cbo_costing_per]; ?></td>
                            <td>
                                <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" style="width:100px" readonly value="<?=$calculatorstringarr[3]; ?>" /> Cone
                                <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<?=$cbo_costing_per; ?>" readonly /> 						
                                <input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" readonly />
                            </td>
                        </tr>
                    </table>
				<? 
				}
				else if($calculator_parameter==2){ ?>
                    <legend>Carton-Comsumption Calculator</legend>
                    <table cellpadding="0" cellspacing="0" align="center" width="1020">
                        <tr>
                            <td width="120">Gmts Per Carton</td>
                            <td><input type="text" id="txt_gmts_per_catton" name="txt_gmts_per_catton" class="text_boxes_numeric" onChange="clculate_req_carton()" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>  value="<?=$calculatorstringarr[0]; ?>"/></td>
                            <td>Costting <?=$costing_per[$cbo_costing_per]; ?></td>
                            <td><input type="text" id="txt_cost_for" name="txt_cost_for" class="text_boxes_numeric" value="<?=$pcs_value; ?>" readonly/></td>
                            <td>Required Carton</td>
                            <td>
                                <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" readonly value="<?=$calculatorstringarr[2]; ?>" />
                                <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<?=$cbo_costing_per; ?>" readonly /> 										
                                <input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
                            </td>
                        </tr>
                    </table>
				<? }
				else if($calculator_parameter==3){
					$data_array=sql_select("select a.cons_dzn_gmts from wo_pre_cost_trim_cost_dtls a,lib_item_group b where a.trim_group=b.id and b.cal_parameter=2 and a.job_no='$txt_job_no' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
					$total_row=count($data_array);
					$req_carton=0;
					if($total_row==1)
					{
						list($data)	= $data_array;
						$req_carton=$data[csf('cons_dzn_gmts')];
					}
					?>
                    <legend>Carton Stiker-Comsumption Calculator</legend>
                    <table cellpadding="0" cellspacing="0" align="center" width="1020">
                        <tr>
                            <td width="120">Stiker Per Carton</td>
                            <td><input type="text" id="txt_stiker_per_catton" name="txt_stiker_per_catton" class="text_boxes_numeric" onChange="clculate_req_carton_stiker();" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> value="<?=$calculatorstringarr[0]; ?>"/></td>
                            <td>Req Car  <?= $costing_per[$cbo_costing_per]; ?></td>
                            <td><input type="text" id="txt_req_carton" name="txt_req_carton" class="text_boxes_numeric" onChange="clculate_req_carton_stiker();" value="<?=$req_carton; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> /></td>
                            <td>Required Stiker</td>
                            <td>
                                <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" readonly value="<?=$calculatorstringarr[2]; ?>" />
                                <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<?= $cbo_costing_per; ?>" readonly /> 										
                                <input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" readonly />
                            </td>
                        </tr>
                    </table>
				<? }
				else if($calculator_parameter==4){ ?>
                    <legend>Poly-Comsumption Calculator</legend>
                    <table cellpadding="0" cellspacing="0" align="center" width="1020">
                        <tr>
                            <td width="120">Gmts Per Poly</td>
                            <td><input type="text" id="txt_gmts_per_catton" name="txt_gmts_per_catton" class="text_boxes_numeric" onChange="clculate_req_carton()" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>  value="<?=$calculatorstringarr[0]; ?>"/></td>
                            <td>Costting <?=$costing_per[$cbo_costing_per]; ?></td>
                            <td><input type="text" id="txt_cost_for" name="txt_cost_for" class="text_boxes_numeric" value="<?=$pcs_value; ?>" readonly/></td>
                            <td>Required Poly</td>
                            <td>
                                <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" readonly value="<?=$calculatorstringarr[2]; ?>" />
                                <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<?=$cbo_costing_per; ?>" readonly /> 										
                                <input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
                            </td>
                        </tr>
                    </table>
				<? }
				else if($calculator_parameter==5){
					$RollLength=$calculatorstringarr[1];
					if($RollLength == "" || $RollLength==0){
						$RollLength=48;
					}
					?>
                    <legend>Elastic Calculator</legend>
                    <table cellpadding="0" cellspacing="0" align="center" width="1020">
                        <tr>
                            <td width="100">Cons Per Garment</td>
                            <td><input type="text" id="txt_cons_per_gmts" name="txt_cons_per_gmts" class="text_boxes_numeric" onChange="clculate_elastic()" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> style="width:100px" value="<?=$calculatorstringarr[0]; ?>" /> Yds</td>
                            <td width="100">Roll Length</td>
                            <td><input type="text" id="txt_cons_length" name="txt_cons_length" class="text_boxes_numeric"  onChange="clculate_elastic();" value="<?=$RollLength; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> style="width:100px"/> Yds</td>
                            <td width="100">Cons  <?=$costing_per[$cbo_costing_per]; ?></td>
                            <td>
                                <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" style="width:100px" readonly value="<?=$calculatorstringarr[2]; ?>" /> Roll
                                <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<?=$cbo_costing_per; ?>" readonly /> 										
                                <input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
                            </td>
                        </tr>
                    </table>
				<? }
				else if($calculator_parameter==6){
					$RollLength=$calculatorstringarr[2];
					if($RollLength == "" || $RollLength==0){
						$RollLength=48;
					}
					?>
                    <legend>Gum Tap Calculator</legend>
                    <table cellpadding="0" cellspacing="0" align="center" width="1020">
                        <tr>
                            <td width="100">Cons Per Carton</td>
                            <td><input type="text" id="txt_cons_per_gmts" name="txt_cons_per_gmts" class="text_boxes_numeric" onChange="clculate_gumtap();" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>  style="width:100px" value="<?=$calculatorstringarr[0]; ?>"/> Yds</td>
                            <td width="100">Gmt. Per Carton</td>
                            <td><input type="text" id="txt_pcs_per_carton" name="txt_pcs_per_carton" class="text_boxes_numeric" onChange="clculate_gumtap();" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> style="width:100px" value="<?=$calculatorstringarr[1]; ?>"/> Pcs</td>
                            <td width="100">Roll Length</td>
                            <td><input type="text" id="txt_cons_length" name="txt_cons_length" class="text_boxes_numeric" onChange="clculate_gumtap();" value="<?=$RollLength; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> style="width:100px"/> Yds</td>
                            <td width="100">Cons  <?=$costing_per[$cbo_costing_per]; ?>=</td>
                            <td>
                                <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" style="width:100px" readonly value="<?=$calculatorstringarr[3]; ?>"/> Roll
                                <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<?=$cbo_costing_per; ?>" readonly /> 										
                                <input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" readonly />
                            </td>
                        </tr>
                    </table>
				<? }
				else if($calculator_parameter==7){
					$QtyPerBox=$calculatorstringarr[1];
					if($QtyPerBox=="" || $QtyPerBox== 0){
						$QtyPerBox=4800;
					}
					?>
                        <legend>Tag Pin Calculator</legend>
                        <table cellpadding="0" cellspacing="0" align="center" width="1020">
                            <tr>
                                <td width="120">Cons Per Garments</td>
                                <td><input type="text" id="txt_cons_per_gmts" name="txt_cons_per_gmts" class="text_boxes_numeric" onChange="clculate_tagpin();" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>  value="<?=$calculatorstringarr[0]; ?>"/> Pcs</td>
                                <td>Qty Per Box</td>
                                <td><input type="text" id="txt_cons_length" name="txt_cons_length" class="text_boxes_numeric"  onChange="clculate_tagpin();" value="<?=$QtyPerBox; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>/> Pcs</td>
                                <td>Cons  <?=$costing_per[$cbo_costing_per]; ?></td>
                                <td>
                                    <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" readonly value="<?=$calculatorstringarr[2]; ?>"/> Box
                                    <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<?=$cbo_costing_per; ?>" readonly /> 										
                                    <input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" readonly />
                                </td>
                            </tr>
                        </table>
				<? }
				else if($calculator_parameter==8){
					$RollLength=$calculatorstringarr[1];
					if($RollLength== "" || $RollLength==0){
						$RollLength=10000;
					}
					?>
                        <legend>Sequines Calculator</legend>
                        <table cellpadding="0" cellspacing="0" align="center" width="1020">
                            <tr>
                                <td width="120">Cons Per Garments</td>
                                <td><input type="text" id="txt_cons_per_gmts" name="txt_cons_per_gmts" class="text_boxes_numeric" onChange="clculate_sequines();" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> value="<?=$calculatorstringarr[0]; ?>" /> Yds</td>
                                <td>Roll Length</td>
                                <td><input type="text" id="txt_cons_length" name="txt_cons_length" class="text_boxes_numeric"  onChange="clculate_sequines();" value="<?=$RollLength; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>/> Yds</td>
                                <td>Cons  <?=$costing_per[$cbo_costing_per]; ?></td>
                                <td>
                                    <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" readonly value="<?=$calculatorstringarr[2]; ?>"/> Roll
                                    <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<?=$cbo_costing_per; ?>" readonly /> 										
                                    <input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" readonly />
                                </td>
                            </tr>
                        </table>
				<? } 
				else if($calculator_parameter==9){
					$qtyPerGrs=$calculatorstringarr[1];
					if($qtyPerGrs== "" || $qtyPerGrs==0)$qtyPerGrs=144;
					?>
                    <legend>Eyelet Calculator</legend>
                    <table cellpadding="0" cellspacing="0" align="center" width="1020">
                        <tr>
                            <td width="120">Qty per Garments</td>
                            <td><input type="text" id="txt_qty_per_gmts" name="txt_qty_per_gmts" class="text_boxes_numeric" onChange="clculate_req_eyelet();" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>  value="<?=$calculatorstringarr[0]; ?>"/> Pcs.
                            </td>
                            <td>Qty per Grs</td>
                            <td><input type="text" id="txt_qty_per_grs" name="txt_qty_per_grs" class="text_boxes_numeric" onChange="clculate_req_eyelet();" value="<? echo $qtyPerGrs;?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> /> Pcs. </td>
                            <td>Qty per 1 Dzn Garments</td>
                            <td>
                                <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" readonly value="<?=$calculatorstringarr[2]; ?>" /> Grs.
                                <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<?=$cbo_costing_per; ?>" readonly /> 	
                                <input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" readonly />
                            </td>
                        </tr>
                    </table>
					<?
				}
				else if($calculator_parameter==10)
				{
					$QtyPerBox=$calculatorstringarr[1];
					if($QtyPerBox=="" || $QtyPerBox== 0) $QtyPerBox=1728;
					?>
					<fieldset>
	                    <legend>Button GG</legend>
	                    <table cellpadding="0" cellspacing="0" align="center" width="1020">
	                        <tr>
	                            <td width="120">Cons Per Garments</td>
	                            <td><input type="text" id="txt_cons_per_gmts" name="txt_cons_per_gmts" class="text_boxes_numeric" onChange="clculate_tagpin()" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>  value="<? echo $calculatorstringarr[0] ?>"/> Pcs</td>
	                            <td>Qty Per GG</td>
	                            <td><input type="text" id="txt_cons_length" name="txt_cons_length" class="text_boxes_numeric"  onChange="clculate_tagpin()" value="<? echo $QtyPerBox; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>/> Pcs</td>
	                            <td>Cons  <? echo $costing_per[$cbo_costing_per];?></td>
	                            <td>
	                                <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" readonly value="<? echo $calculatorstringarr[2] ?>"/> GG
	                                <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<? echo $cbo_costing_per; ?>" readonly /> 										<input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
	                            </td>
	                        </tr>
	                    </table>
					</fieldset>
					<?
				}
				else if($calculator_parameter==11){
					$QtyPerBox=$calculatorstringarr[1];
					if($QtyPerBox=="" || $QtyPerBox== 0) $QtyPerBox=144;
					?>
                    <legend>Button Gross</legend>
                    <table cellpadding="0" cellspacing="0" align="center" width="1020">
                        <tr>
                            <td width="120">Cons Per Garments</td>
                            <td><input type="text" id="txt_cons_per_gmts" name="txt_cons_per_gmts" class="text_boxes_numeric" onChange="clculate_tagpin();" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>  value="<?=$calculatorstringarr[0]; ?>"/> Pcs</td>
                            <td>Qty Per Gross</td>
                            <td><input type="text" id="txt_cons_length" name="txt_cons_length" class="text_boxes_numeric"  onChange="clculate_tagpin();" value="<?=$QtyPerBox; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>/> Pcs</td>
                            <td>Cons  <? echo $costing_per[$cbo_costing_per];?></td>
                            <td>
                                <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" readonly value="<?=$calculatorstringarr[2]; ?>"/> Gross
                                <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<?=$cbo_costing_per; ?>" readonly /> 										
                                <input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" readonly />
                            </td>
                        </tr>
                    </table>
				<? } 
				else if($calculator_parameter==13){ ?>
                    <legend>Carton Board-Comsumption Calculator</legend>
                        <table cellpadding="0" cellspacing="0" align="center" width="1020">
                            <tr>
                                <td width="120">Gmts Per Carton Board</td>
                                <td><input type="text" id="txt_gmts_per_catton" name="txt_gmts_per_catton" class="text_boxes_numeric" onChange="clculate_req_carton()" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>  value="<?=$calculatorstringarr[0]; ?>"/></td>
                                <td>Costting <?=$costing_per[$cbo_costing_per]; ?></td>
                                <td><input type="text" id="txt_cost_for" name="txt_cost_for" class="text_boxes_numeric" value="<?=$pcs_value; ?>" readonly/></td>
                                <td>Required Carton Board</td>
                                <td>
                                    <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" readonly value="<?=$calculatorstringarr[2]; ?>" />
                                    <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<?=$cbo_costing_per; ?>" readonly /> 										
                                    <input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
                                </td>
                            </tr>
                        </table>
				<? } ?>
                <input type="hidden" id="pcs" name="pcs" class="text_boxes_numeric" style="width:75px"  value="<?=$pcs_value; ?>"> 
                <input type="hidden" id="tr_order" name="tr_order" class="text_boxes_numeric" style="width:75px"  value="" /> 
                <input type="hidden" id="cons_breck_down" name="cons_breck_down" class="text_boxes_numeric" style="width:75px"  value="" />
                <input type="hidden" id="item_ratio" name="item_ratio" class="text_boxes_numeric" style="width:75px" value="<?=$tot_set_qnty; ?>" />
                <input type="hidden" id="calculator_parameter" name="calculator_parameter" class="text_boxes_numeric" value="<?=$calculator_parameter; ?>" />
                <input type="hidden" id="calculator_string"  name="calculator_string"  class="text_boxes_numeric" style="width:75px" readonly />
                <input type="hidden" id="txt_caculated_value" name="txt_caculated_value"/>
            </td>
        </tr>
        <tr>
            <td>
                <table width="1200" cellspacing="0" class="rpt_table" border="0" rules="all">
                    <thead style="position: sticky;position: -webkit-sticky;top: 0;z-index: 999;">
                        <tr>
                            <th width="30">SL</th>
                            <th width="100">PO NO</th>
                            <th width="120">Gmts.Item</th>
                            <th width="80">Country</th>
                            <th width="100">Gmts. Color</th>
                            <th width="70">Gmts. Size</th>
							<th width="70">Item Color</th>
                            <th width="50">Item. Size</th>
                            <th width="50" style="color:#2A3FFF">Cons</th>
                            <th width="50">Ex. %</th>
                            <th width="50" style="color:#2A3FFF">Tot. Cons</th>
                            <th width="50" style="color:#2A3FFF">Rate</th>
                            <th width="50">Amount</th>
                            <th width="70">Total Qty</th>
                            <th width="70">Total Amount</th>
                            <th width="50">Placement</th>
                            <th width="50"><? if ($job_order_uom==1){ echo "Pcs";} if($job_order_uom==58){echo "Set";} ?></th>
                            <th>
                                <input type="hidden" id="cbogroup" name="cbogroup" value="<?=$cbogroup; ?>">
                                <input type="hidden" id="cbonominasupplier" name="cbonominasupplier" value="<?=$supplier; ?>">
                                <input type="hidden" id="txtdescription" name="txtdescription" value="<?=$txtdescription; ?>">
                                <input type="hidden" id="cboconsuom" name="cboconsuom" value="">
                                <input type="hidden" id="carton_description" name="carton_description" value="">
                                <input type="hidden" id="txthidden_job" name="txthidden_job" value="<?=$txt_job_no; ?>">
                            </th>
                        </tr>
                    </thead>
                 </table>
                <div style="max-height:260px; overflow-y:scroll; width:1200px" align="left" id="scroll_body">
                 <table width="1182" cellspacing="0" class="rpt_table" border="0" id="tbl_consmption_cost" rules="all">
                    <tbody>
                    <?
                    if($cbo_costing_per==1) $pcs_value=1*12;
                    if($cbo_costing_per==2) $pcs_value=1*1;
                    if($cbo_costing_per==3) $pcs_value=2*12;
                    if($cbo_costing_per==4) $pcs_value=3*12;
                    if($cbo_costing_per==5) $pcs_value=4*12;
                    $component_approved=0;
				
                    $sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=2 and job_no='$txt_job_no'");
                    foreach($sql as $row){
                        if($row[csf('approved')]==1) { $component_approved=1; }
                    }
                    unset($sql);
                    $company_name = return_field_value("company_name", "wo_po_details_master", "job_no='$txt_job_no'");
                    $trim_variable=1;
                    $trim_variable_sql=sql_select("select variable_list, trim_rate, copy_quotation, cost_control_source from variable_order_tracking where company_name='$company_name' and variable_list in (20,35,53)");
					$copy_quotation=$cost_control_source=0;
                    foreach($trim_variable_sql as $trim_variable_row)
                    {
                        if($trim_variable_row[csf('variable_list')]==20) $copy_quotation=$trim_variable_row[csf('copy_quotation')];
						if($trim_variable_row[csf('variable_list')]==35) $trim_variable=$trim_variable_row[csf('trim_rate')];
						if($trim_variable_row[csf('variable_list')]==53) $cost_control_source=$trim_variable_row[csf('cost_control_source')];
                    }
                    unset($trim_variable_sql);
					$supplier_rate=0;
					if($trim_variable==4 && $txtdescription !=''){
						$sql_des = sql_select("select id from lib_item_details where item_description  LIKE '%$txtdescription' and item_group_id = $cbogroup");
						foreach ($sql_des as $row) {
							$outval[]= $row[csf('id')];
						}
						$des_id = implode(",",$outval);
						$pcdatetime=explode(" ",$pc_date_time);
						$sql_data = sql_select("SELECT distinct lsw.id , lsw.supplier_id, lsw.item_group_id,lsw.item_details_id,lsw.rate,lsw.effective_from, lsw.supplier_code, lsw.remarks, lib_item_group.order_uom, lib_item_group.trim_uom as cons_uom,lib_supplier.supplier_name, lib_item_group.conversion_factor ,lib_item_details.tag_buyer,lib_item_details.item_code,lib_item_details.item_description from lib_supplier_wise_rate lsw left join (SELECT item_details_id,supplier_id,max(effective_from) as effectivedate from lib_supplier_wise_rate  where trunc(effective_from) <= to_date('$pcdatetime[0]','DD-MM-YYYY' ) and item_group_id = $cbogroup and item_details_id in ($des_id) and supplier_id in ($supplier) group by supplier_id,item_details_id) last_rate on lsw.supplier_id = last_rate.supplier_id left outer join lib_item_details on lib_item_details.id = lsw.item_details_id left outer join lib_supplier on lib_supplier.id = lsw.supplier_id left outer join lib_item_group on lib_item_group.id = lsw.item_group_id  where lsw.effective_from = last_rate.effectivedate and lsw.item_group_id = $cbogroup and lsw.item_details_id in ($des_id) and lsw.supplier_id in ($supplier) order by lib_supplier.supplier_name asc");
						foreach($sql_data as $row){
							$supplier_rate=$row[csf('rate')];
						}
					}

					$color_library=return_library_array("select id,color_name from lib_color where status_active=1 and is_deleted=0","id","color_name");
					$size_library=return_library_array("select id,size_name from lib_size where status_active=1 and is_deleted=0","id","size_name");
					$country_library=return_library_array("select id,country_name from lib_country","id","country_name");
                    $item_ratio_arr=array();
                    $gmts_item_sql=sql_select("SELECT gmts_item_id, set_item_ratio from wo_po_details_mas_set_details where job_no='$txt_job_no'");
                    foreach($gmts_item_sql as $gmts_item_row)
                    {
                        $item_ratio_arr[$gmts_item_row[csf('gmts_item_id')]] = $gmts_item_row[csf('set_item_ratio')];
                    }
                    $country=rtrim($country,",");
                    if($country=="") $country_cond=""; else $country_cond=" and c.country_id in($country)";
                    
                    $country_array=array(); $itemqty_array=array();
                    $data_country=sql_select("SELECT b.id, b.po_number, c.item_number_id, c.color_number_id, c.size_number_id, c.country_id, c.plan_cut_qnty, c.order_quantity  from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and b.job_no_mst='$txt_job_no' $country_cond and a.status_active=1 and b.status_active=1 and c.status_active=1 and c.is_deleted=0");
                    foreach($data_country as $data_country_row){
                        $country_array[$data_country_row[csf('id')]][$data_country_row[csf('item_number_id')]][$data_country_row[csf('color_number_id')]][$data_country_row[csf('size_number_id')]]['country_id'][$data_country_row[csf('country_id')]]=$data_country_row[csf('country_id')];
                        $country_array[$data_country_row[csf('id')]][$data_country_row[csf('item_number_id')]][$data_country_row[csf('color_number_id')]][$data_country_row[csf('size_number_id')]]['country_name'][$data_country_row[csf('country_id')]]=$country_library[$data_country_row[csf('country_id')]];
						
						$itemqty_array[$data_country_row[csf('item_number_id')]]+=$data_country_row[csf('order_quantity')];
                    }
                    unset($data_country);
                    
                    $data_array=sql_select("select b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id ,min(c.id)as color_size_table_id, min(color_order) as color_order, min(size_order) as size_order, sum(plan_cut_qnty) as plan_cut_qnty,sum(order_quantity) as order_quantity from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c  where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id  and b.job_no_mst='$txt_job_no' $country_cond   and a.status_active=1 and b.status_active=1 and c.status_active=1 and c.is_deleted=0 group by b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id order by b.id,c.item_number_id,color_order,size_order");
                    
                    if($updateidtrim != ""){
                        $row_arr_data=""; $cons_breck_downnarr=array(); $colorWiseDataArr=array();
						if($trim_variable==4){
							$trim_cost_data=sql_select("SELECT supplier_rate_id from wo_pre_cost_trim_cost_dtls where id=$updateidtrim and status_active=1 and is_deleted=0");
							foreach($trim_cost_data as $row){
								$previous_supplier_id=$row[csf('supplier_rate_id')];
							}
						}
						
                        $wo_pre_cos_fab_co_avg_con_dtls_data=sql_select("select id, wo_pre_cost_trim_cost_dtls_id, job_no, po_break_down_id, item_number_id, color_number_id, size_number_id, item_size, item_color_number_id, country_id, place, cons, excess_per, tot_cons, ex_cons, rate, amount, pcs, gmts_pcs, color_size_table_id ,rate_cal_data from wo_pre_cost_trim_co_cons_dtls where job_no='$txt_job_no' and wo_pre_cost_trim_cost_dtls_id=$updateidtrim");
                        
                        foreach($wo_pre_cos_fab_co_avg_con_dtls_data as $trims_cons_row)
                        {
							if($trims_cons_row[csf('item_color_number_id')]=='') $trims_cons_row[csf('item_color_number_id')]=0;
                            $consBreakDownnarr[$trims_cons_row[csf('color_size_table_id')]]=$trims_cons_row[csf('po_break_down_id')]."_".$trims_cons_row[csf('item_size')]."_".$trims_cons_row[csf('tot_cons')]."_".$trims_cons_row[csf('place')]."_".$trims_cons_row[csf('pcs')]."_".$trims_cons_row[csf('country_id')]."_".$trims_cons_row[csf('excess_per')]."_".$trims_cons_row[csf('cons')]."_".$trims_cons_row[csf('ex_cons')]."_".$trims_cons_row[csf('item_number_id')]."_".$trims_cons_row[csf('color_number_id')]."_".$trims_cons_row[csf('size_number_id')]."_".$trims_cons_row[csf('rate')]."_".$trims_cons_row[csf('amount')]."_".$trims_cons_row[csf('color_size_table_id')]."_".$trims_cons_row[csf('rate_cal_data')]."_".$trims_cons_row[csf('item_color_number_id')];
							if($trims_cons_row[csf('tot_cons')]!=0 && $trims_cons_row[csf('rate')]!=0)
							{
								$colorWiseDataArr[$trims_cons_row[csf('item_number_id')]][$trims_cons_row[csf('color_number_id')]]['copyConsdata']=$trims_cons_row[csf('tot_cons')]."_".$trims_cons_row[csf('excess_per')]."_".$trims_cons_row[csf('ex_cons')]."_".$trims_cons_row[csf('cons')]."_".$trims_cons_row[csf('rate')]."_".$trims_cons_row[csf('amount')];
								$itemWiseDataArr[$trims_cons_row[csf('item_number_id')]]['copyConsdata']=$trims_cons_row[csf('tot_cons')]."_".$trims_cons_row[csf('excess_per')]."_".$trims_cons_row[csf('ex_cons')]."_".$trims_cons_row[csf('cons')]."_".$trims_cons_row[csf('rate')]."_".$trims_cons_row[csf('amount')];
							}
                        }
						//print_r( $colorWiseDataArr);
                    }
                    if($updateidtrim == ""){
                        //$cons_breck_downn_trim =
                        $cons_breck_downnarr=explode("__",$cons_breck_downn_trim);
                    }
                   
                    if($cbo_approved_status!=1) $cbo_approved_status=$component_approved;
                    $cons_fld=0;
                    $is_booking = array();
                    if($cbo_approved_status!=1)
                    {
                        $data_arr=sql_select("select po_break_down_id, pre_cost_fabric_cost_dtls_id from wo_booking_dtls where pre_cost_fabric_cost_dtls_id ='$updateidtrim' and booking_type='2' and status_active=1 and is_deleted=0 group by pre_cost_fabric_cost_dtls_id, po_break_down_id");
                        if (count($data_arr)>0){
                            foreach ($data_arr as $value) {
                                $is_booking[$value[csf('pre_cost_fabric_cost_dtls_id')]][$value[csf('po_break_down_id')]] = $value[csf('po_break_down_id')];
                            }
                        }
                    }
                    
                    if ( count($data_array)>0)
                    {
                        $i=0;
                        foreach( $data_array as $row )
                        {
                            if(count($is_booking[$updateidtrim][$row[csf('id')]]) > 0 ) $cons_fld=1; else $cons_fld=0;
                           // echo $consBreakDownnarr[$row[csf('color_size_table_id')]];
                            if($updateidtrim!= "") $data=explode('_',$consBreakDownnarr[$row[csf('color_size_table_id')]]); else if($updateidtrim == "") $data=explode('_',$cons_breck_downnarr[$i]);
							//echo $data[12].'DSDS';;
                            $i++;
                            $country_string=implode(",",$country_array[$row[csf('id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['country_id']);
                            $country_string_name=implode(",",$country_array[$row[csf('id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['country_name']);
                            
                            $po_country_arr=explode(",",$country_string);
                        
                            $countrydata=explode(",",$data[5]);
                            $arr_d=array_diff($countrydata, $po_country_arr);
                            $arr_d2=array_diff($countrydata, $arr_d);
                            $country_name="";
                            
                            for($countryindex=0; $countryindex < count($arr_d2);$countryindex++){
                                $country_name.=	$country_library[$countrydata[$countryindex]].",";
                            }
                            $country_idstring=implode(",",$arr_d2);
                            
                            if(count($arr_d)>0 && count($countrydata)>0 ){
                                $country_name_pre="";
                                for($countryindex=0; $countryindex < count($arr_d);$countryindex++){
                                    $country_name_pre.=	$country_library[$countrydata[$countryindex]].",";
                                }
                                $title="Country have Changed in po entry, you have to update this field, Previous Country was ".rtrim($country_name_pre,",")."";
                                if(rtrim($country_name_pre,",")!=""){
                                    $bgc="#D41F00";
                                }
                            }
                            else{
                                $title=""; $bgc="#FFFFFF";
                            }

							$exqcqty=""; $colorWiseCount=0;
							if($updateidtrim!= "" && $copy_quotation==1 && $cost_control_source==4 && ($data[7]*1)==0 && $consBreakDownnarr[$row[csf('color_size_table_id')]]=="")//ISD-21-03976 Qc Update mode And color wise cons copy //Color Size Check by issue id ISD-23-26080
							{
								$exqcqty=explode("_",$colorWiseDataArr[$row[csf('item_number_id')]][$row[csf('color_number_id')]]['copyConsdata']);
								$data[2]=$exqcqty[0]; //cons
								$data[6]=$exqcqty[1]; //exper
								$data[8]=$exqcqty[2]; //ex_cons
								
								$data[7]=$exqcqty[3]; //totcons
								$data[12]=$exqcqty[4]; //rate
								$data[13]=$exqcqty[5]; //amount
								if(($data[7]*1)==0) $colorWiseCount=1;
								//echo "A";
							}
							/* if($updateidtrim!= "" && $cost_control_source==3 && ($data[7]*1)==0)//ISD-21-20681 color wise cons copy
							{
								$exqcqty=explode("_",$colorWiseDataArr[$row[csf('color_number_id')]]['copyConsdata']);
								//print_r($exqcqty);
								//$colorWiseCount=count();
								$data[2]=$exqcqty[0]; //cons
								$data[6]=$exqcqty[1]; //exper
								$data[8]=$exqcqty[2]; //ex_cons
								
								$data[7]=$exqcqty[3]; //totcons
								$data[12]=$exqcqty[4]; //rate
								$data[13]=$exqcqty[5]; //amount
								if(($data[7]*1)==0) $colorWiseCount=1;
								//echo $data[2]."B";
							} */ 
							//ISD-22-14253 comment above code with mr.kause & mr.saeed permission
							else if($updateidtrim=="" && $copy_quotation==1 && $cost_control_source==4 && ($data[7]*1)==0 && $qc_qty!="")//Qc Save  Mode
							{
								//1.09__9__1__.21__.2289
								$exqcqty=explode("__",$qc_qty);
								$data[2]=$exqcqty[2]; //cons
								$data[6]=$exqcqty[1]; //exper
								$data[8]=number_format(($exqcqty[0]*($exqcqty[1]/100)),6); //ex_cons
								$data[7]=$exqcqty[0]; //totcons
								$data[12]=$exqcqty[3]; //rate
								$data[13]=$exqcqty[4]; //amount
								if(($data[7]*1)==0) $colorWiseCount=1;
								//echo "C";
								
							}
							else if($copy_quotation==1 && $cost_control_source==2 && ($data[7]*1)==0)// Price Quot
							{
								$data[2] = $totalcons;
                                $data[6] = $excessper;
								if(($data[7]*1)==0) $colorWiseCount=1;
								//echo $data[2].'D';
							}
                          
                            $rate=$data[12];
                            if($rate=="") $rate=$txttrimrate;
							if($colorWiseCount!=1 && $data[14]=="") //
							{
								$exitemqty=explode("_",$itemWiseDataArr[$row[csf('item_number_id')]]['copyConsdata']);
								if($exitemqty[3]!=""){
									$data[2]=$exitemqty[0]; //cons
									$data[6]=$exitemqty[1]; //exper
									$data[8]=$exitemqty[2]; //ex_cons
									
									$data[7]=$exitemqty[3]; //totcons
									$data[12]=$exitemqty[4]; //rate
									$data[13]=$exitemqty[5]; //amount
									//if(($data[7]*1)==0) $colorWiseCount=1;
								}
								else{
									if($data[2]=="" || $data[2]==0) $data[2]=$totalcons;
									if($data[7]=="" || $data[7]==0) $data[7]=$txtconsdzngmts;
									
									if($data[6]=="")
									{
										$data[6]=$excessper;
										$data[7]=$data[2]+(($data[2]*$excessper)/100);
									}
								}
							}
							
							if($copy_quotation!=1 && $cost_control_source!=2) // Issue Id=29407
							{
								//echo "E";
								if($data[6]=="")
								{
									$data[6]=$excessper;
									$data[7]=$data[2]+(($data[2]*$excessper)/100);
								}
							}
							//if($updateidtrim!= "" 
							if($updateidtrim=="" && $data[6]=="") $data[6]=$excessper;
								// echo $data[2].'='.$data[6].'=AA';
                            
                            if($data[10] != $row[csf('color_number_id')] && $data[10] !=""){
                                $title_color="Color have Changed in po entry, you have to update this field, Previous Color was ".$color_library[$data[10]]."";
                                $bgc_color="#D41F00";
                            }
                            else{
                                $title_color=""; $bgc_color="#FFFFFF";
                            }
                            
                            if($data[11]!= $row[csf('size_number_id')] && $data[11]!=""){
                                $title_size="Size have Changed in po entry, you have to update this field, Previous Size was ".$size_library[$data[11]]."";
                                $bgc_size="#D41F00";
                            }
                            else{
                                $title_size=""; $bgc_size="#FFFFFF";
                            }
                            $item_size=$data[1];
                            if($item_size=="") $item_size=$size_library[$row[csf('size_number_id')]];
                            
                            $pcs=$pcs_value * $item_ratio_arr[$row[csf('item_number_id')]];
                            if($data[7]!='') $RowtotReq=number_format(($row[csf('order_quantity')]/$item_ratio_arr[$row[csf('item_number_id')]])*($data[7]/$pcs_value),6,".","");
                            else $RowtotReq=number_format(($row[csf('order_quantity')]/$item_ratio_arr[$row[csf('item_number_id')]])*($totalcons/$pcs_value),6,".","");
                            
                            
                            if($rate_calculator_parameter==2 || $rate_calculator_parameter==4) $rate_calculator_cond=" readonly onClick='fnc_ratecal_parameter($i,$cbogroup,$rate_calculator_parameter);'";

                            if($trim_variable==1 || $trim_variable==0 || $trim_variable==4) $trim_rate_popup=""; else $trim_rate_popup=" readonly onClick='supp_trim_rate_popup($i)'";

							if($trim_variable==4 && $updateidtrim=="" && ($rate=='' || $rate==0)){
								$rate=$supplier_rate;
							}
							//echo $previous_supplier_id.'-'.$supp_rate_id.'-'.$updateidtrim.'-'.$trim_variable.'-'.$supplier_rate; die;
							if($previous_supplier_id>0 && $supp_rate_id>0 && $updateidtrim!="" && $trim_variable==4 && $previous_supplier_id!=$supp_rate_id){
								$rate=$supplier_rate;
								$data[13]=$data[7]*$rate;
							}

                            $totReq+=$RowtotReq;
                            $RowtotAmt=number_format($RowtotReq*$rate,6,".","");
                            $totAmt+=$RowtotAmt;
                            ?>
                            <tr id="break_<?=$i; ?>" align="center">
                                <td width="30"><?=$i; ?></td>
                                <td width="100" style="word-break:break-all"><?=$row[csf('po_number')]; ?><input type="hidden" id="ponoid_<?=$i; ?>" name="ponoid_<?=$i; ?>" class="text_boxes" style="width:65px" value="<?=$row[csf('id')]; ?>"  readonly/></td>
                                <td width="120" style="word-break:break-all"><?=$garments_item[$row[csf('item_number_id')]]; ?><input type="hidden" id="cbogmtsitem_<?=$i; ?>" name="cbogmtsitem_<?=$i; ?>" style="width:68px" value="<?=$row[csf('item_number_id')]; ?>" readonly /></td>
                                <td width="80" style="word-break:break-all; background-color:<?=$bgc; ?>" onClick="open_country_popup(<?=$i; ?>,0);"><?=$country_string_name; ?><input type="hidden" id="cbocountry_<?=$i; ?>" name="cbocountry_<?=$i; ?>" class="text_boxes_numeric" style="width:68px" value="<?= $country_string; ?>" readonly /></td>
                                <td width="100" style="word-break:break-all; background-color:<?=$bgc_color; ?>"><?=$color_library[$row[csf('color_number_id')]]; ?><input type="hidden" id="pocolorid_<?=$i; ?>" name="pocolorid_<?=$i; ?>" class="text_boxes" style="width:80px" value="<?=$row[csf('color_number_id')]; ?>" readonly/></td>
                                <td width="70" style="word-break:break-all; background-color:<?=$bgc_size; ?>"><?=$size_library[$row[csf('size_number_id')]]; ?><input type="hidden" id="gmtssizesid_<?=$i; ?>" name="gmtssizesid_<?=$i; ?>" class="text_boxes" style="width:50px" value="<?=$row[csf('size_number_id')]; ?>" readonly /></td>
								<td width="70"><input type="text" id="txtitemcolor_<?=$i;?>" name="txtitemcolor_<?=$i;?>" class="text_boxes" style="width:58px" onChange="copy_value(this.value,'txtitemcolor_',<?=$i;?>);" value="<?=$color_library[$data[16]]; ?>" <? if ($cons_fld==1) { echo "disabled";} else { if($cbo_approved_status==1){echo "disabled";} else { echo "";}} ?> /></td>
                                <td width="50"><input type="text" id="itemsizes_<?=$i; ?>" name="itemsizes_<?=$i; ?>" class="text_boxes" style="width:38px" onChange="copy_value(this.value,'itemsizes_',<?=$i; ?>);" value="<?=$item_size; ?>" <? if($cbo_approved_status==1 || $cons_fld==1){echo "disabled";} else { echo "";}?> /></td>
                                <td width="50"><input type="text" id="cons_<?=$i;?>" onChange="set_sum_value('cons_sum', 'cons_'); copy_value(this.value,'cons_',<?=$i; ?>); calculate_tot_cons(<?=$i; ?>);" name="cons_<?=$i; ?>" onClick="calculator_value_set(<?=$i; ?>);" class="text_boxes_numeric" style="width:38px" value="<?=$data[2]; ?>" <? if($cbo_approved_status==1 || $cons_fld==1){echo "disabled";}  else { echo "";} ?> /></td>
                                <td width="50">
                                    <input type="text" id="exper_<?=$i; ?>" onChange="set_sum_value( 'exper_sum', 'exper_' ); copy_value(this.value,'exper_',<?=$i; ?>); calculate_tot_cons(<?=$i;?>);" name="exper_<?=$i; ?>" class="text_boxes_numeric" style="width:38px" value="<?=$data[6]; ?>" <? if($cbo_approved_status==1 || $cons_fld==1){echo "disabled";} else { echo "";}?> />
                                    <input type="hidden" id="totexper_<?=$i; ?>" name="totexper_<?=$i; ?>" class="text_boxes_numeric" style="width:30px" value="<?=$data[8]; ?>" />
                                </td>
                                <td width="50">
                                    <input type="text" id="totcons_<?=$i; ?>" onChange="set_sum_value( 'totcons_sum', 'totcons_' ); copy_value(this.value,'totcons_',<?=$i;?>);" name="totcons_<?=$i; ?>" onClick="calculator_value_set(<?=$i; ?>);" class="text_boxes_numeric" style="width:38px" value="<? if($data[6]!='') { echo number_format(($data[2]*($data[6]/100)+$data[2]),6,".","");} else echo $data[7]; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>  readonly /></td>
                                <td width="50"><input type="text" id="rate_<?=$i; ?>" onChange="set_sum_value( 'rate_sum', 'rate_' ); copy_value(this.value,'rate_',<?=$i; ?>);calculate_amount(<?=$i; ?>); row_tot(<?=$i; ?>);" name="rate_<?=$i; ?>" class="text_boxes_numeric" style="width:38px" value="<?=$rate; ?>" <? if($cbo_approved_status==1 || $cons_fld==1){echo "disabled";} else { echo "";} echo $cs_disable;  ?><? echo $rate_calculator_cond; echo $trim_rate_popup; ?>   />
                                <input type="hidden" id="hidRateCalStr_<?=$i;?>" name="hidRateCalStr_<?=$i;?>" style="width:30px" value="<?=$data[15]; ?>" />
                                </td>
                                <td width="50"><input type="text" id="amount_<?=$i;?>" onChange="set_sum_value( 'amount_sum', 'amount_' ); copy_value(this.value,'amount_',<?=$i; ?>); calculate_rate(<?=$i;?>);row_tot(<?=$i;?>);" name="amount_<?=$i;?>" class="text_boxes_numeric" style="width:38px" value="<? if($data[13]=='') { echo ($data[2]*($data[6]/100)+$data[2])*$rate ;} else echo $data[13]; ?>" /></td>
                                <td width="70"><input type="text" id="totqty_<?=$i; ?>" name="totqty_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="<?=$RowtotReq; ?>" readonly /></td>
                                <td width="70"><input type="text" id="totamount_<?=$i; ?>" name="totamount_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="<?=$RowtotAmt; ?>" readonly /></td>
                                <td width="50"><input type="text" id="place_<?=$i; ?>" name="place_<?=$i; ?>" class="text_boxes" style="width:38px" onChange="copy_value(this.value,'place_',<?=$i; ?>);" value="<?=$data[3]; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> /></td>
                                <td width="50">
                                    <input type="text" id="pcs_<?=$i;?>" name="pcs_<?=$i;?>" onBlur="set_sum_value( 'pcs_sum', 'pcs_' );" class="text_boxes_numeric" style="width:38px" value="<?=$pcs; ?>" readonly />
                                    <input type="hidden" id="pcsgmts_<?=$i;?>" name="pcsgmts_<?=$i;?>" onBlur="set_sum_value( 'pcs_sum', 'pcs_' );" class="text_boxes_numeric" style="width:30px" value="<?=$row[csf('order_quantity')]; ?>">
                                    <input type="hidden" id="itempcsgmts_<?=$i; ?>" name="itempcsgmts_<?=$i;?>" onBlur="set_sum_value( 'pcs_sum', 'pcs_' );" class="text_boxes_numeric" style="width:30px" value="<?=$itemqty_array[$row[csf('item_number_id')]]; ?>">
                                    <input type="hidden" id="itemratiogmts_<?=$i; ?>" name="itemratiogmts_<?=$i; ?>" onBlur="set_sum_value( 'pcs_sum', 'pcs_' );" class="text_boxes_numeric" style="width:30px" value="<?=$item_ratio_arr[$row[csf('item_number_id')]]; ?>">
                                    <? $jobqty+=$row[csf('order_quantity')]; ?>
                                    <input type="hidden" id="colorsizetableid_<?=$i; ?>" name="colorsizetableid_<?=$i; ?>" class="text_boxes" style="width:30px" value="<?=$row[csf('color_size_table_id')]; ?>" readonly/>
                                </td>
                                <td id="add_<?=$i; ?>"><input type="button" id="decreaserow_<?=$i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_delete_down_tr(<?=$i;?>,'tbl_consmption_cost');" /> </td>
                            </tr>
                            <?
                        }
                    }
                    ?>
                    </tbody>
                </table>
                </div>
                <table width="1200" cellspacing="0" class="rpt_table" border="0" rules="all">
                    <tfoot>
                        <tr>
                            <th width="30">
							<input type="hidden" id="total_trims_row" value="<?= $i ?>">
							<input type="hidden" id="supplier_rate" value="<?= $supplier_rate ?>">
							<input type="hidden" id="trim_rate_variable" value="<?= $trim_variable ?>">
							</th>
                            <th width="100">&nbsp;</th>
                            <th width="120">&nbsp;</th>
                            <th width="80">&nbsp;</th>
                            <th width="100">&nbsp;</th>
                            <th width="70">&nbsp;</th>
                            <th width="70">&nbsp;</th>
                            <th width="50">Sum:</th>
                            <th width="50"><input type="text" id="cons_sum" name="cons_sum" class="text_boxes_numeric" style="width:38px" readonly></th>
                            <th width="50"><input type="text" id="exper_sum" name="exper_sum" class="text_boxes_numeric" style="width:38px" readonly></th>
                            <th width="50"><input type="text" id="totcons_sum" name="totcons_sum" class="text_boxes_numeric" style="width:38px" readonly></th>
                            <th width="50"><input type="text" id="rate_sum" name="rate_sum" class="text_boxes_numeric" style="width:38px" readonly></th>
                            <th width="50"><input type="text" id="amount_sum" name="amount_sum" class="text_boxes_numeric" style="width:38px" readonly></th>
                            <th width="70"><input type="text" id="totReq_sum" name="totReq_sum" class="text_boxes_numeric" style="width:58px" value="<?=$totReq; ?>" readonly></th>
                            <th width="70"><input type="text" id="totAmount_sum" name="totAmount_sum" class="text_boxes_numeric" style="width:58px" value="<?=$totAmt; ?>" readonly></th>
                            <th width="50">&nbsp;</th>
                            <th width="50"><input type="text" id="pcs_sum" name="pcs_sum" class="text_boxes_numeric" style="width:38px" readonly><input type="hidden" id="job_qty"    name="job_qty" class="text_boxes_numeric" style="width:40px" value="<?=$jobqty; ?>" readonly></th>
                            <th>&nbsp;</th>
                        </tr>
                        <tr>
                            <th width="30">&nbsp;</th>
                            <th width="100">&nbsp;</th>
                            <th width="120">&nbsp;</th>
                            <th width="80">&nbsp;</th>
							<th width="100">&nbsp;</th>
                            <th width="70">&nbsp;</th>                            
                            <th width="70">&nbsp;</th>
                            <th width="50">Avg:</th>
                            <th width="50"><input type="text" id="avg_cons" name="avg_cons" class="text_boxes_numeric" style="width:38px" value="" readonly></th>
                            <th width="50"><input type="text" id="avg_exper" name="avg_exper" class="text_boxes_numeric" style="width:38px" value="" readonly></th>
                            <th width="50"><input type="text" id="avg_totcons" name="avg_totcons" class="text_boxes_numeric" style="width:38px" value="" readonly></th>
                            <th width="50"><input type="text" id="avg_ratecons" name="avg_ratecons" class="text_boxes_numeric" style="width:38px" value="" readonly></th>
                            <th width="50"><input type="text" id="avg_amountcons" name="avg_amountcons" class="text_boxes_numeric" style="width:38px" value="" readonly></th>
                            <th width="70"><input type="text" id="AtotReq_sum" name="AtotReq_sum" class="text_boxes_numeric" style="width:58px" value="<?=$totReq; ?>" readonly></th>
                            <th width="70"><input type="text" id="AtotAmount_sum" name="AtotAmount_sum" class="text_boxes_numeric" style="width:58px" value="<?=$totAmt; ?>" readonly></th>
                            <th width="50">&nbsp;</th>
                            <th width="50"><input type="text" id="calculated_pcs" name="calculated_pcs" class="text_boxes_numeric" style="width:38px" readonly></th>
                            <th>&nbsp;</th>
                        </tr>
                    </tfoot>
                </table>
                <script>
					$(document).ready(function(e) {		
						var tableFilters =
						{
							col_6: "none",col_7: "none",col_8: "none",col_9: "none",col_10: "none",col_11: "none",col_12: "none",col_13: "none",col_14: "none",col_15: "none",col_16: "none",col_17: "none",             
								col_operation: {
							}
						}
						setFilterGrid('tbl_consmption_cost',-1,tableFilters);
					});
					set_sum_value('cons_sum', 'cons_');
					set_sum_value('exper_sum', 'exper_');
					set_sum_value('totcons_sum', 'totcons_');
					set_sum_value('rate_sum', 'rate_');
					set_sum_value('amount_sum', 'amount_');
					set_sum_value('pcs_sum', 'pcs_');
                </script>
             	<div align="center" style="width:100%;" >
                    <table width="1140" cellspacing="0" border="0" rules="all">
                         <tr>
                            <td align="center" width="100%" class="button_container"><input type="button" class="formbutton" value="Close" onClick="js_set_value();"/></td>
                        </tr>
                    </table>
           		</div>
           </td>
       <tr>
    </table>
    </fieldset>
    </div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
	exit();
}

if($action=="supp_trim_rate_popup_page")
{
    echo load_html_head_contents("Supplier Wise Rate","../../../", 1, 1, $unicode);
    extract($_REQUEST);
	//echo $txthidden_job.'D';
    if($txtdescription != '')
    {
        //echo "select id from lib_item_details where item_description  LIKE '%$txtdescription%' and item_group_id = $cbogroup"; die;
        if($txtdescription != '')
        {
        	$data = explode('@', $txtdescription);
        	if(count($data)>0)
        	{
        		$txtdescription = $data[0];
        	}
        	else
        	{
        		$txtdescription = $txtdescription;
        	}

        }
        $sql_des = sql_select("select id from lib_item_details where item_description  LIKE '%$txtdescription' and item_group_id = $cbogroup");
        foreach ($sql_des as $row) {
            $outval[]= $row[csf('id')];
        }
        $des_id = implode(",",$outval);
        //echo $des_id; die;
        if($des_id != ""){
            $des_cond = "and item_details_id in ($des_id)";
            $des_cond2 = "and lsw.item_details_id in ($des_id)";
        }
        else{
            $des_cond = "and item_details_id is null";
            $des_cond2 = "and lsw.item_details_id is null";
        }
    }

    if($cbonominasupplier != 0){
        $supp_cond = "and supplier_id in ($cbonominasupplier) ";
        $supp_cond2 = "and lsw.supplier_id in ($cbonominasupplier)";
    }
    else {
        $supp_cond = "";
        $supp_cond2 = "";
    }
    ?>
    <script>
    function js_set_value(data)
    {
    	var data=data.split('_');
    	console.log(data);
    	document.getElementById('txt_selected_supllier').value=data[0];
    	document.getElementById('txt_selected_rate').value=data[1];
        document.getElementById('txt_selected_description').value=data[2];
        document.getElementById('txt_uom').value=data[3];
        parent.emailwindow.hide();
    }
    </script>
    </head>
    <body>
    <body>
    <div align="center">
    <form>
    <input type="hidden" id="txt_selected_supllier" name="txt_selected_supllier" value=" " />
    <input type="hidden" id="txt_selected_rate" name="txt_selected_rate" value="" />
    <input type="hidden" id="txt_selected_description" name="txt_selected_description" value="" />
    <input type="hidden" id="txt_uom" name="txt_uom" value="" />
        <?
		//$company_name = return_field_value("company_name", "wo_po_details_master", "job_no='$txthidden_job'");
		$sql_job=sql_select("select company_name,buyer_name from wo_po_details_master where job_no='$txthidden_job'");
		foreach($sql_job as $row)
		{
			$company_name=$row[csf('company_name')];
			$buyer_name=$row[csf('buyer_name')];
		}
		$trim_variable=1;
		$trim_variable_sql=sql_select("select variable_list, trim_rate, copy_quotation, cost_control_source from variable_order_tracking where company_name='$company_name' and variable_list in (35)");
		//echo "select trim_rate from  variable_order_tracking where company_name='$company_name' and variable_list=35 order by id";
		$copy_quotation=$cost_control_source=0;
		foreach($trim_variable_sql as $trim_variable_row)
		{
			if($trim_variable_row[csf('variable_list')]==35) $trim_variable=$trim_variable_row[csf('trim_rate')];
		}
		//echo $trim_variable.'D';
		unset($trim_variable_sql);
		

        $supplier_library=return_library_array( "select supplier_name,id from  lib_supplier ", "id", "supplier_name");
        $pc_date_time=explode(" ",$pc_date_time);

        $sql_data = sql_select("SELECT distinct lsw.id , lsw.supplier_id, lsw.item_group_id,lsw.item_details_id,lsw.rate,lsw.effective_from, lsw.supplier_code, lsw.remarks, lib_item_group.order_uom,lib_item_details.tag_buyer, lib_item_group.trim_uom as cons_uom,lib_supplier.supplier_name, lib_item_group.conversion_factor ,lib_item_details.item_code,lib_item_details.item_description from lib_supplier_wise_rate lsw left join (SELECT item_details_id,supplier_id,max(effective_from) as effectivedate from lib_supplier_wise_rate  where trunc(effective_from) <= to_date('$pc_date_time[0]','DD-MM-YYYY' ) and item_group_id = $cbogroup $des_cond  $supp_cond group by supplier_id,item_details_id) last_rate on lsw.supplier_id = last_rate.supplier_id left outer join lib_item_details on lib_item_details.id = lsw.item_details_id left outer join lib_supplier on lib_supplier.id = lsw.supplier_id left outer join lib_item_group on lib_item_group.id = lsw.item_group_id  where lsw.effective_from = last_rate.effectivedate and lsw.item_group_id = $cbogroup $des_cond2 $supp_cond2 order by lib_supplier.supplier_name asc");

		 
	 


        ?>
    <table class="rpt_table" width="950" cellpadding="0" cellspacing="0" border="1" rules="all" style="margin-top: 20px">
        <thead>
            <input type="hidden" id="hidden_item_group_id" name="hidden_item_group_id" value="<? echo $cbogroup ?>">
            <input type="hidden" id="hidden_supplier" name="hidden_supplier" value="<? echo $cbonominasupplier ?>">
            <? if($txtdescription != ''){ $disabled = "disabled" ?>
            <input type="hidden" id="item_description" name="item_description" value="<? echo $txtdescription ?>">
            <? } else $disabled = "" ?>
            <th>Description: <input type="text" id="item_description" name="description" class="text_boxes" <? echo $disabled; ?>/> <input type="button" name="button2" class="formbutton" value="Show" style="width:100px;" onClick="show_list_view ( document.getElementById('hidden_item_group_id').value+'_'+document.getElementById('hidden_supplier').value+'_'+document.getElementById('item_description').value+'_'+'<?=$txthidden_job;?>', 'create_supplier_wise_rate_list_view', 'supplier_rate_list_view', 'pre_cost_entry_controller_v2', 'setFilterGrid(\'supplier_rate_list_view\',-1)')" /> </th>
        </thead>
    </table>
    <table class="rpt_table" width="950" cellpadding="0" cellspacing="0" border="1" rules="all" >
    				<thead>
    					<th width="50">SL</th>
    					<th width="100">Supplier</th>
                        <th width="100">Supplier Code</th>
                        <th width="100">Item Code</th>
                        <th width="100">Description</th>
                        <th width="50">Order UOM</th>
    					<th width="60">Order Rate(&#36;)</th>
                        <th width="50">Cons UOM</th>
                        <th width="60">Cons Rate(&#36;)</th>
                        <th width="100">Effective Date</th>
                        <th width="150">Remarks</th>
    				</thead>
    			</table>
    <table width="950" cellspacing="0" class="rpt_table" border="0" rules="all" id="supplier_rate_list_view">
    <?
    $i=1;
    if(count($sql_data) > 0)
    {
        foreach($sql_data as $row)
        {
			if($trim_variable==3) //Supplier//Buyer
			{
				$tag_buyerArr=explode(",",$row[csf('tag_buyer')]);
				if(in_array($buyer_name,$tag_buyerArr))
				{
					 
				if ($i%2==0)
				$bgcolor="#E9F3FF";
				else
					$bgcolor="#FFFFFF";
				$cons_rate = $row[csf('rate')]/$row[csf('conversion_factor')];

				?>
				<tr bgcolor="<? echo $bgcolor;  ?>" style="text-decoration:none; cursor:pointer" onClick="js_set_value('<? echo $row[csf('supplier_id')]."_".number_format($cons_rate,4)."_".$row[csf('item_description')]."_".$row[csf('cons_uom')]."_".$supplier_library[$row[csf('supplier_id')]];?>')">
				<td width="50"><? echo $i ?></td>
				<td width="100"><? echo $row[csf('supplier_name')]; ?></td>
				<td width="100"><? echo $row[csf('supplier_code')]; ?></td>
				<td width="100"><? echo $row[csf('item_code')]; ?></td>
				<td width="100"><? echo $row[csf('item_description')]; ?></td>
				<td width="50"><? echo $unit_of_measurement[$row[csf('order_uom')]]; ?></td>
				<td width="60"><? echo $row[csf('rate')]; ?></td>
				<td width="50"><? echo $unit_of_measurement[$row[csf('cons_uom')]]; ?></td>
				<td width="60"><? echo number_format($cons_rate,4); ?></td>
				<td width="100"><? echo change_date_format($row[csf('effective_from')], "yyyy-mm-dd", "-",1)?></td>
				<td width="150"><? echo $row[csf('remarks')]; ?></td>
				</tr>
				<?
				$i++;
				}
			}
			else
			{
				 
				if ($i%2==0)
				$bgcolor="#E9F3FF";
				else
					$bgcolor="#FFFFFF";
				$cons_rate = $row[csf('rate')]/$row[csf('conversion_factor')];

				?>
				<tr bgcolor="<? echo $bgcolor;  ?>" style="text-decoration:none; cursor:pointer" onClick="js_set_value('<? echo $row[csf('supplier_id')]."_".number_format($cons_rate,4)."_".$row[csf('item_description')]."_".$row[csf('cons_uom')]."_".$supplier_library[$row[csf('supplier_id')]];?>')">
				<td width="50"><? echo $i ?></td>
				<td width="100"><? echo $row[csf('supplier_name')]; ?></td>
				<td width="100"><? echo $row[csf('supplier_code')]; ?></td>
				<td width="100"><? echo $row[csf('item_code')]; ?></td>
				<td width="100"><? echo $row[csf('item_description')]; ?></td>
				<td width="50"><? echo $unit_of_measurement[$row[csf('order_uom')]]; ?></td>
				<td width="60"><? echo $row[csf('rate')]; ?></td>
				<td width="50"><? echo $unit_of_measurement[$row[csf('cons_uom')]]; ?></td>
				<td width="60"><? echo number_format($cons_rate,4); ?></td>
				<td width="100"><? echo change_date_format($row[csf('effective_from')], "yyyy-mm-dd", "-",1)?></td>
				<td width="150"><? echo $row[csf('remarks')]; ?></td>
				</tr>
		<?
			}
        }
    }
    else{ ?>
            <tr bgcolor="<? echo $bgcolor;  ?>" style="text-align: center;" >
                <td colspan="4" width="350"><span style="color: red; font-size: 20px; font-weight: bold;">No data found matching the criteria.</span></td>
            </tr>
        <? }
    ?>
    </table>
    </form>
    </div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    <script>
          setFilterGrid("supplier_rate_list_view",-1)
    </script>
    </html>
 <?
}

if($action == "create_supplier_wise_rate_list_view")//create_supplier_wise_rate_list_view
{
   $data = explode('_',$data);
   $txtdescription = $data[2];
   $cbonominasupplier = $data[1];
   $cbogroup = $data[0];
   $job_no = $data[3];
   //echo  $job_no.'D';
   if($txtdescription != '')
    {

        $sql_des = sql_select("select id from lib_item_details where item_description  LIKE '%$txtdescription' and item_group_id = $cbogroup");
        foreach ($sql_des as $row) {
            $outval[]= $row[csf('id')];
        }
        $des_id = implode(",",$outval);

        if($des_id != ""){
            //$des_cond = "and a.item_details_id in ($des_id)";
            $des_cond = "and item_details_id in ($des_id)";
            $des_cond2 = "and lsw.item_details_id in ($des_id)";
        }
        else{
            //$des_cond = "and a.item_details_id is null";
            $des_cond = "and item_details_id is null";
            $des_cond2 = "and lsw.item_details_id is null";
        }
    }

    if($cbonominasupplier != 0){
        //$supp_cond = "and a.supplier_id = $cbonominasupplier";
        $supp_cond = "and supplier_id in ($cbonominasupplier)";
        $supp_cond2 = "and lsw.supplier_id in ($cbonominasupplier)";
    }
    else {
        $supp_cond = "";
        $supp_cond2 = "";
    }
	$sql_job=sql_select("select company_name,buyer_name from wo_po_details_master where job_no='$job_no'");
		foreach($sql_job as $row)
		{
			$company_name=$row[csf('company_name')];
			$buyer_name=$row[csf('buyer_name')];
		}
		$trim_variable=1;
		$trim_variable_sql=sql_select("select variable_list, trim_rate, copy_quotation, cost_control_source from variable_order_tracking where company_name='$company_name' and variable_list in (35)");
		//echo "select trim_rate from  variable_order_tracking where company_name='$company_name' and variable_list=35 order by id";
		$copy_quotation=$cost_control_source=0;
		foreach($trim_variable_sql as $trim_variable_row)
		{
			if($trim_variable_row[csf('variable_list')]==35) $trim_variable=$trim_variable_row[csf('trim_rate')];
		}
		//echo $trim_variable.'D';
		unset($trim_variable_sql);

    $supplier_library=return_library_array( "select supplier_name,id from  lib_supplier ", "id", "supplier_name");
    $pc_date_time=explode(" ",$pc_date_time);
    //$sql_data = sql_select("SELECT distinct lsw.id , lsw.supplier_id, lsw.item_group_id,lsw.item_details_id,lsw.rate,lsw.effective_from,lsw.supplier_code, lsw.remarks, lib_item_group.order_uom,lib_item_group.trim_uom as cons_uom,lib_supplier.supplier_name, lib_item_group.conversion_factor,lib_item_details.item_code,lib_item_details.item_description from lib_supplier_wise_rate lsw left outer join lib_item_details on lib_item_details.id = lsw.item_details_id left outer join lib_supplier on lib_supplier.id = lsw.supplier_id left outer join lib_item_group on lib_item_group.id = lsw.item_group_id  where lsw.is_deleted = 0 and lsw.item_group_id = $cbogroup $des_cond2  $supp_cond2 order by lib_supplier.supplier_name asc");
    $sql_data = sql_select("SELECT distinct lsw.id , lsw.supplier_id, lsw.item_group_id,lsw.item_details_id,lsw.rate,lsw.effective_from, lsw.supplier_code, lsw.remarks, lib_item_group.order_uom, lib_item_group.trim_uom as cons_uom,lib_supplier.supplier_name, lib_item_group.conversion_factor ,lib_item_details.tag_buyer,lib_item_details.item_code,lib_item_details.item_description from lib_supplier_wise_rate lsw left join (SELECT item_details_id,supplier_id,max(effective_from) as effectivedate from lib_supplier_wise_rate  where trunc(effective_from) <= to_date('$pc_date_time[0]','DD-MM-YYYY' ) and item_group_id = $cbogroup $des_cond  $supp_cond group by supplier_id,item_details_id) last_rate on lsw.supplier_id = last_rate.supplier_id left outer join lib_item_details on lib_item_details.id = lsw.item_details_id left outer join lib_supplier on lib_supplier.id = lsw.supplier_id left outer join lib_item_group on lib_item_group.id = lsw.item_group_id  where lsw.effective_from = last_rate.effectivedate and lsw.item_group_id = $cbogroup $des_cond2 $supp_cond2 order by lib_supplier.supplier_name asc");

   ?>
    <table width="850" cellspacing="0" class="rpt_table" border="0" rules="all" id="supplier_rate_list_view">
    <?
    $i=1;
    if(count($sql_data) > 0)
    {
        foreach($sql_data as $row)
        {
			if($trim_variable==3) //Supplier//Buyer
			{
				$tag_buyerArr=explode(",",$row[csf('tag_buyer')]);
				if(in_array($buyer_name,$tag_buyerArr))
				{
				if ($i%2==0)
				$bgcolor="#E9F3FF";
				else
				$bgcolor="#FFFFFF";
				$cons_rate = $row[csf('rate')]/$row[csf('conversion_factor')];
				?>
				<tr bgcolor="<? echo $bgcolor;  ?>" style="text-decoration:none; cursor:pointer" onClick="js_set_value('<? echo $row[csf('supplier_id')]."_".number_format($cons_rate,4)."_".$description[$row[csf('item_details_id')]]."_".$row[csf('cons_uom')]."_".$supplier_library[$row[csf('supplier_id')]];?>')">
					<td width="50"><? echo $i ?></td>
					<td width="100"><? echo $row[csf('supplier_name')]; ?></td>
					<td width="100"><? echo $row[csf('supplier_code')]; ?></td>
					<td width="100"><? echo $row[csf('item_code')]; ?></td>
					<td width="100"><?echo $row[csf('item_description')]; ?></td>
					<td width="50"><? echo $unit_of_measurement[$row[csf('order_uom')]]; ?></td>
					<td width="60"><? echo $row[csf('rate')]; ?></td>
					<td width="50"><? echo $unit_of_measurement[$row[csf('cons_uom')]]; ?></td>
					<td width="60"><? echo number_format($cons_rate,4); ?></td>
					<td width="100"><? echo change_date_format($row[csf('effective_from')], "yyyy-mm-dd", "-",1)?></td>
					<td width="150"><? echo $row[csf('remarks')]; ?></td>
				</tr>
            <?
				 $i++;
				}
		  }// ====end
		  else 
		  {
			   
					if ($i%2==0)
				$bgcolor="#E9F3FF";
				else
				$bgcolor="#FFFFFF";
				$cons_rate = $row[csf('rate')]/$row[csf('conversion_factor')];
				?>
				<tr bgcolor="<? echo $bgcolor;  ?>" style="text-decoration:none; cursor:pointer" onClick="js_set_value('<? echo $row[csf('supplier_id')]."_".number_format($cons_rate,4)."_".$description[$row[csf('item_details_id')]]."_".$row[csf('cons_uom')]."_".$supplier_library[$row[csf('supplier_id')]];?>')">
					<td width="50"><? echo $i ?></td>
					<td width="100"><? echo $row[csf('supplier_name')]; ?></td>
					<td width="100"><? echo $row[csf('supplier_code')]; ?></td>
					<td width="100"><? echo $row[csf('item_code')]; ?></td>
					<td width="100"><?echo $row[csf('item_description')]; ?></td>
					<td width="50"><? echo $unit_of_measurement[$row[csf('order_uom')]]; ?></td>
					<td width="60"><? echo $row[csf('rate')]; ?></td>
					<td width="50"><? echo $unit_of_measurement[$row[csf('cons_uom')]]; ?></td>
					<td width="60"><? echo number_format($cons_rate,4); ?></td>
					<td width="100"><? echo change_date_format($row[csf('effective_from')], "yyyy-mm-dd", "-",1)?></td>
					<td width="150"><? echo $row[csf('remarks')]; ?></td>
				</tr>
					<?
					 $i++;
				 

		  }
				

		} 
         
    }
    else{ ?>
        <tr bgcolor="<? echo $bgcolor;  ?>" style="text-align: center;" >
            <td colspan="4" width="350"><span style="color: red; font-size: 20px; font-weight: bold;">No data found matching the criteria.</span></td>
        </tr>
    <? }

    ?>

    </table>
   <?
}
if($action=="calculator_parameter")
{
	extract($_REQUEST);
	$cal_parameter_type=return_field_value("cal_parameter", "lib_item_group", "id='$data'");
	echo trim($cal_parameter_type); die;
}

if($action=="calculator_type")
{
   extract($_REQUEST);
   echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode);
?>
<script>
function clculate_cons_for_mtr()
{
  var txt_cons_per_gmts=(document.getElementById('txt_cons_per_gmts').value)*1;
  var txt_costing_per=document.getElementById('txt_costing_per').value;
  if(txt_costing_per==1)
  {
  document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*12;
  }
  if(txt_costing_per==2)
  {
  document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*1;
  }
  if(txt_costing_per==3)
  {
  document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*2*12;
  }
  if(txt_costing_per==4)
  {
  document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*3*12;
  }
  if(txt_costing_per==5)
  {
  document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*4*12;
  }
  var txt_cons_for_mtr= (document.getElementById('txt_cons_for_mtr').value)*1
  var txt_cons_length= (document.getElementById('txt_cons_length').value)*1
  document.getElementById('txt_cons_for_cone').value=txt_cons_for_mtr/txt_cons_length;
}
function js_set_value_calculator(type)
{
	if(type=='sewing_thread')
	{
		var clacolator_param_value=document.getElementById('txt_cons_per_gmts').value+'*'+document.getElementById('txt_cons_for_mtr').value+'*'+document.getElementById('txt_cons_length').value+'*'+document.getElementById('txt_cons_for_cone').value+'*'+document.getElementById('txt_costing_per').value;

		document.getElementById('txt_clacolator_param_value').value=clacolator_param_value;

	}

		parent.emailwindow.hide();


}
</script>
</head>
<body>
<?
	if($calculator_parameter==1)
	{

		?>
        <fieldset>
        <legend>Sewing Thread</legend>
        <table cellpadding="0" cellspacing="2" align="center" width="300">
        <tr>
        <td width="120">
        Cons Per Garment
        </td>
        <td width="">
        <input type="text" id="txt_cons_per_gmts" name="txt_cons_per_gmts" class="text_boxes_numeric" onChange="clculate_cons_for_mtr()" /> Mtr
        </td>
        </tr>
        <tr>
        <td>
        Cons <? echo $costing_per[$cbo_costing_per];?>
        </td>
        <td>
        <input type="text" id="txt_cons_for_mtr" name="txt_cons_for_mtr" class="text_boxes_numeric"  readonly/> Mtr
        </td>
        </tr>
        <tr>
        <td>
        Cone Length
        </td>
        <td>
        <input type="text" id="txt_cons_length" name="txt_cons_length" class="text_boxes_numeric"  onChange="clculate_cons_for_mtr()" value="4000"/> Mtr
        </td>
        </tr>
        <tr>
        <td>
        Cons  <? echo $costing_per[$cbo_costing_per];?>
        </td>
        <td>
        <input type="text" id="txt_cons_for_cone" name="txt_cons_for_cone" class="text_boxes_numeric" readonly /> Cone
        </td>
        </tr>
         <tr>

        <td colspan="3" align="center">
        <input type="button" class="formbutton" value="Close" onClick="js_set_value_calculator('sewing_thread')"/>
        <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<? echo $cbo_costing_per; ?>" readonly />
        <input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
        </td>
        </tr>
        </table>
        </fieldset>
        <?
	}
	?>
 </body>
<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
</html>
<?
exit();
}

if($action=="trim_rate_popup_page")
{
echo load_html_head_contents("Country","../../../", 1, 1, $unicode);
extract($_REQUEST);
?>
<script>
function js_set_value(data)
{
	var data=data.split('_');
	document.getElementById('txt_selected_supllier').value=data[0];
	document.getElementById('txt_selected_rate').value=data[1];
    parent.emailwindow.hide();
}
</script>
</head>
<body>

<div align="center">
<form>
<input type="hidden" id="txt_selected_supllier" name="txt_selected_supllier" value=" " />
<input type="hidden" id="txt_selected_rate" name="txt_selected_rate" value="" />
<?
$supplier_library=return_library_array( "select a.supplier_name,a.id from  lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(4,5) and a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
$sql_data=sql_select("select a.id, b.supplier_id, b.rate  from lib_item_group a, lib_item_group_rate b where a.id=b.mst_id and a.item_category=4 and a.id='$cbogroup' and    b.rate>0 and a.status_active=1 and	a.is_deleted=0 group by a.id, b.supplier_id, b.rate order by b.rate");

?>
<table class="rpt_table" width="500" cellpadding="0" cellspacing="0" border="1" rules="all">
				<thead>
					<th width="50">SL</th>
					<th width="100">Supplier</th>
					<th width="100">Rate</th>
				</thead>
			</table>
<table width="500" cellspacing="0" class="rpt_table" border="0" id="tbl_list_search" rules="all">
<?
$i=1;
foreach($sql_data as $row)
{
	if ($i%2==0)
	$bgcolor="#E9F3FF";
else
	$bgcolor="#FFFFFF";
?>
<tr bgcolor="<? echo $bgcolor;  ?>" style="text-decoration:none; cursor:pointer" onClick="js_set_value('<? echo $row[csf('supplier_id')]."_".$row[csf('rate')];?>')">

<td width="50"><? echo $i ?></td>
<td width="100">
<? echo $supplier_library[$row[csf('supplier_id')]]; ?>
</td>
<td width="100">
<? echo $row[csf('rate')]; ?>
</td>
</tr>
<?
$i++;
}
?>
</table>
</form>
</div>
</body>
<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
</html>
 <?
 exit();
}

if($action=="open_country_popup")
{
	echo load_html_head_contents("Country","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	//echo $isbooking;
	?>
	<script>
		var isbooking='<?=$isbooking; ?>';
		var selected_id = new Array, selected_name = new Array();
		function check_all_data() {
				$("#tbl_list_search tr").each(function() {
					var valTP=$(this).attr("id");
					$("#"+valTP).click();
			});
		}
	
		function toggle( x, origColor ) {
			var newColor = 'yellow';
			if ( x.style ) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}
	
		function js_set_value( str ) {
			toggle( document.getElementById( 'search' + str ), '#FFFFCC' );
	
			if( jQuery.inArray( $('#txt_individual_id' + str).val(), selected_id ) == -1 ) {
				selected_id.push( $('#txt_individual_id' + str).val() );
				selected_name.push( $('#txt_individual_name' + str).val() );
			}
			else {
				for( var i = 0; i < selected_id.length; i++ ) {
					if( selected_id[i] == $('#txt_individual_id' + str).val() ) break;
				}
				selected_id.splice( i, 1 );
				selected_name.splice( i, 1 );
			}
			var id = ''; var name='';
			for( var i = 0; i < selected_id.length; i++ ) {
				id += trim(selected_id[i]) + ',';
				name += trim(selected_name[i]) + ',';
			}
			id = id.substr( 0, id.length - 1 );
			name = name.substr( 0, name.length - 1 );
	
			//alert(id)
			$('#txt_selected_id').val( trim(id) );
			$('#txt_selected_name').val( trim(name) );
		}
	</script>
	</head>
	<body>
	<div align="center">
    <form>
    <table width="400" cellspacing="0" class="rpt_table" border="0" id="" rules="all">
        <thead>
            <th width="20">SL</th>
            <th width="200">Country Name</th>
            <th width="80">Country Short</th>
            <th>Region</th>
        </thead>
    </table>
    <div style="width:400px; overflow-y:scroll; max-height:340px;" >
        <table width="380" cellspacing="0" class="rpt_table" border="0" rules="all" id="tbl_list_search">
			<?
            $sql_data=sql_select("select country_id from wo_po_color_size_breakdown WHERE job_no_mst='$txt_job_no' and status_active=1 and is_deleted=0 group by country_id");
            $couArr=array();
            $sql_country=sql_select("select id, country_name, short_name, region from lib_country where status_active=1");
			foreach($sql_country as $row)
            {
				$country_library[$row[csf('id')]]=$row[csf('country_name')];
				$country_short_library[$row[csf('id')]]=$row[csf('short_name')];
				$country_region_library[$row[csf('id')]]=$row[csf('region')];
			}
            $i=1;
            foreach($sql_data as $row)
            {
                $couArr['id'][trim($row[csf('country_id')])]=trim($row[csf('country_id')]);
                $couArr['name'][trim($row[csf('country_id')])]= $country_library[trim($row[csf('country_id')])];
                if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
				
				$bookingfound=0;
				$countrySArr=explode(",",trim($txt_country));
				if(in_array($row[csf('country_id')], $countrySArr))
				{
					if($isbooking==1) $bookingfound=1;
				}
				if($bookingfound!=1) $jssetvalue=" js_set_value(".trim($row[csf('country_id')]).") "; else $jssetvalue="";
				
                ?>
                <tr bgcolor="<?=$bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="search<?=trim($row[csf('country_id')]);?>" onClick="<?=$jssetvalue; ?>">
                    <td width="20"><?=$i; ?><!--js_set_value(<?//=trim($row[csf('country_id')]);?>)--></td>
                    <td width="200" style="word-break:break-all">
                        <input type="hidden" name="txt_individual_id" id="txt_individual_id<?=trim($row[csf('country_id')]); ?>" value="<?=trim($row[csf('country_id')]); ?>"/>
                        <input type="hidden" name="txt_individual_name" id="txt_individual_name<?=trim($row[csf('country_id')]); ?>" value="<?=$country_library[trim($row[csf('country_id')])]; ?>"/>
                        <?=$country_library[$row[csf('country_id')]]; ?>
                    </td>
                    <td width="80" style="word-break:break-all"><?=$country_short_library[$row[csf('country_id')]]; ?></td>
                    <td style="word-break:break-all"><?=$country_region_library[$row[csf('country_id')]]; ?></td>
                </tr>
                <?
                $i++;
            }
            $nIdcouSArr=array(); $nNamecouSArr=array();
            $couSArr=explode(",",trim($txt_country));
            foreach($couSArr as $key=>$value){
                if (in_array(trim($value), $couArr['id'])) {
                    $nIdcouSArr[]=trim($value);
                    $nNamecouSArr[]=$country_library[trim($value)];
                }
            }
            ?>
        </table>
    </div>
    <table width="400" cellspacing="0" cellpadding="0" style="border:none" align="center">
        <tr>
            <td align="center" height="30" valign="bottom">
            <div style="width:100%">
                <div style="width:50%; float:left" align="left">
                    <input type="hidden" id="txt_selected_id" name="txt_selected_id" value="<? if(count($nIdcouSArr)>0){echo implode(",",$nIdcouSArr);}?>" />
                    <input type="hidden" id="txt_selected_name" name="txt_selected_name" value="<? if(count($nIdcouSArr)>0){echo implode(",",$nNamecouSArr);}?> " />
                    <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data();" /> Check / Uncheck All
                </div>
                <div style="width:50%; float:left" align="left">
                    <input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                </div>
            </div>
            </td>
        </tr>
    </table>
    </form>
    </div>
    </body>
    <script>setFilterGrid('tbl_list_search',-1);</script>
    <script>
		var txt_country='<? if(count($nIdcouSArr)>0){echo implode(",",$nIdcouSArr);}?> '
		var txt_country_name='<? if(count($nIdcouSArr)>0){echo implode(",",$nNamecouSArr);}?>'
		
		if(trim(txt_country) !=""){
			selected_id=trim(txt_country).split(",");
			selected_name=txt_country_name.split(",");
		}
		for(var i=0; i<selected_id.length;i++){
		   if(trim(selected_id[i]) !=""){
				toggle( document.getElementById( 'search' + trim(selected_id[i]) ), '#FFFFCC' );
		   }
		}
    </script>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
	exit();
}

function create_consbreak_down($job_no,$cons_value,$rate,$amount,$country,$excess_per,$ex_cons,$total_cons)
{
	$cbo_costing_per=return_field_value("costing_per", "wo_pre_cost_mst", "job_no=$job_no");
	$size_library_arr=return_library_array( "select id,size_name from lib_size", "id", "size_name");
	$country_library=return_library_array("select id,country_name from lib_country","id","country_name");
	$item_ratio_arr=array();

	$gmts_item_sql=sql_select("select gmts_item_id, set_item_ratio from  wo_po_details_mas_set_details  where job_no=$job_no");
	foreach($gmts_item_sql as $gmts_item_row)
	{
		$item_ratio_arr[$gmts_item_row[csf('gmts_item_id')]]=$gmts_item_row[csf('set_item_ratio')];
	}

	$country=rtrim($country,",");
	if($country=="") $country_cond=""; else $country_cond=" and c.country_id in($country)";
	$country_array=array();
	$data_country=sql_select("select b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id ,c.country_id from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c  where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id  and b.job_no_mst=$job_no $country_cond   and a.status_active=1 and b.status_active=1 and c.status_active=1");
	foreach($data_country as $data_country_row){
		$country_array[$data_country_row[csf('id')]][$data_country_row[csf('item_number_id')]][$data_country_row[csf('color_number_id')]][$data_country_row[csf('size_number_id')]]['country_id'][$data_country_row[csf('country_id')]]=$data_country_row[csf('country_id')];
		$country_array[$data_country_row[csf('id')]][$data_country_row[csf('item_number_id')]][$data_country_row[csf('color_number_id')]][$data_country_row[csf('size_number_id')]]['country_name'][$data_country_row[csf('country_id')]]=$country_library[$data_country_row[csf('country_id')]];
	}	

	$data_array=sql_select("select avg(a.total_set_qnty) as total_set_qnty,b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id ,min(c.id)as color_size_table_id, min(color_order) as color_order, min(size_order) as size_order, sum(plan_cut_qnty) as plan_cut_qnty,sum(order_quantity) as order_quantity from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c  where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id  and b.job_no_mst=$job_no $country_cond   and a.status_active=1 and b.status_active=1 and c.status_active=1 group by a.gmts_item_id,a.total_set_qnty,b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id order by b.id,c.item_number_id,color_order,size_order");
	 
	if ( count($data_array)>0)
	{
		$cons_breck_down="";
		if($cbo_costing_per==1) $pcs_value=1*12;
		if($cbo_costing_per==2) $pcs_value=1*1;
		if($cbo_costing_per==3) $pcs_value=2*12;
		if($cbo_costing_per==4) $pcs_value=3*12;
		if($cbo_costing_per==5) $pcs_value=4*12;
		$placement=1;
		foreach( $data_array as $row )
		{
			$cons_value=def_number_format($cons_value/$row[csf('total_set_qnty')],8,"");
			$totitem=count($item_ratio_arr);
			$cons = $total_cons*1;
			$totexper=$cons_value*($excess_per/100);
			$pcs=$pcs_value*$item_ratio_arr[$row[csf('item_number_id')]];
			$country_string=implode(",",$country_array[$row[csf('id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['country_id']);
			if($country_string==""){
			$country_string=0;
			}
			$rate_cal_data = 0;
			if($rate =="")
			{
				$rate=0;
			}
			 
			if($ex_cons =="") $ex_cons=0;if($placement =="") $placement=0;if($pcs =="") $pcs=0;if($country_string =="") $country_string=0;
			if($country_string =="") $country_string=0;if($totexper =="") $totexper=0;
			if($excess_per =="") $excess_per=0;if($cons_value =="") $cons_value=0;if($amount =="") $amount=0; 
			if($cons_breck_down=="")
			{
				$cons_breck_down.=$row[csf('id')].'_'.$size_library_arr[$row[csf('size_number_id')]].'_'.$ex_cons.'_'.$placement.'_'.$pcs.'_'.$country_string.'_'.$excess_per.'_'.$cons_value.'_'.$totexper.'_'.$row[csf('item_number_id')].'_'.$row[csf('color_number_id')].'_'.$row[csf('size_number_id')].'_'.$rate.'_'.$amount.'_'.$row[csf('color_size_table_id')].'_'.$rate_cal_data.'_0';//ISD-23-24786 remove .$row[csf('color_number_id')]
			}
			else
			{
				$cons_breck_down.="__".$row[csf('id')].'_'.$size_library_arr[$row[csf('size_number_id')]].'_'.$ex_cons.'_'.$placement.'_'.$pcs.'_'.$country_string.'_'.$excess_per.'_'.$cons_value.'_'.$totexper.'_'.$row[csf('item_number_id')].'_'.$row[csf('color_number_id')].'_'.$row[csf('size_number_id')].'_'.$rate.'_'.$amount.'_'.$row[csf('color_size_table_id')].'_'.$rate_cal_data.'_0';//ISD-23-24786 remove .$row[csf('color_number_id')]
			}
			$placement++;
		}
		 //echo "10**".$cons_breck_down; die;

		return $cons_breck_down;
	}
}

if ($action=="save_update_delet_trim_cost_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$sql=sql_select("select approval_need from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
	$app_nessity=2;
	foreach($sql as $row){
		$app_nessity=$row[csf('approval_need')];
	}

	$sql=sql_select("select approved from wo_price_quotation  where id=$txt_quotation_id");
	$quatation_approved=2;
	foreach($sql as $row){
		$quatation_approved=$row[csf('approved')];
	}

	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	if($is_copy_quatation==1 && $app_nessity==1){
		if($quatation_approved==2 || $quatation_approved==0){
			echo "quataNotApp**".str_replace("'","",$txt_job_no);
			 disconnect($con);die;
		}
	}
	$component_approved=return_field_value("current_approval_status", "co_com_pre_costing_approval", "job_no=$update_id and cost_component_id=2");
	$approved=0; $ready_to_approve=0;
	$sql=sql_select("select approved, ready_to_approved from wo_pre_cost_mst where job_no=$update_id and status_active=1 and is_deleted=0");
	foreach($sql as $row){
		//if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
		$approved=$row[csf('approved')];
		$ready_to_approve=$row[csf('ready_to_approved')];
	}
	if($approved==1 || $component_approved==1){
		echo "approved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($approved==3){
		echo "papproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($ready_to_approve==1){
		echo "readyapproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	$str_rep=array("<?","?>","::","_","&", "*", "(", ")", "=","  ","'","\r", "\n",'"','#');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	$itemColorArr=array(); $consPopupArr=array(); $new_array_itemcolor=array();
	//echo "10**=A";
	$con = connect();
	for ($i=1; $i<=$total_row; $i++) //For Item Color check
	{
		$txtconsdzngmts="txtconsdzngmts_".$i;
		$txttrimrate="txttrimrate_".$i;
		$txttrimamount="txttrimamount_".$i; 
		$country="country_".$i;
		$excess_per="excessper_".$i;
		$ex_cons="excons_".$i;
		$total_cons="totalcons_".$i;
		 
		$consbreckdown="consbreckdown_".$i;
		if(str_replace("'",'',$$consbreckdown) !='')
		{
			$consbreckdown= $$consbreckdown;
		}
		else
		{
			$consbreckdown="'".create_consbreak_down($update_id,str_replace("'",'',$$txtconsdzngmts),str_replace("'",'',$$txttrimrate),str_replace("'",'',$$txttrimamount),str_replace("'",'',$$country),str_replace("'",'',$$excess_per),str_replace("'",'',$$ex_cons),str_replace("'",'',$$total_cons))."'";
			
			$consPopupArr[str_replace("'",'',$$txtconsdzngmts)][str_replace("'",'',$$txttrimrate)][str_replace("'",'',$$txttrimamount)]=$consbreckdown;
		}
		//echo 'B='.$consbreckdown.'<br>';
		$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
		$counter=0;
		for($c=0;$c < count($consbreckdown_array);$c++)
		{
			$counter++;
			$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
			if(str_replace("'","",$consbreckdownarr[16])=='0') $consbreckdownarr[16]='';
			if(str_replace("'","",$consbreckdownarr[16])!="")
			{
				 $item_colorName=str_replace("'","",$consbreckdownarr[16]);
				 $item_colorName="'".trim($item_colorName)."'";
				// $itemColorArr[$item_colorName]=$item_colorName;
				 
				if (!in_array(str_replace("'","",$consbreckdownarr[16]),$new_array_itemcolor,TRUE))
				{
					$itemcolor_id = return_id( str_replace("'","",$consbreckdownarr[16]), $color_library, "lib_color", "id,color_name","425");
					$new_array_itemcolor[$itemcolor_id]=str_replace("'","",$consbreckdownarr[16]);
					
					$itemColorArr[trim($consbreckdownarr[16])]=$itemcolor_id;
				}
				else $itemcolor_id =  array_search(str_replace("'","",$consbreckdownarr[16]), $new_array_itemcolor);
				$itemColorArr[trim($consbreckdownarr[16])]=$itemcolor_id;
			} 
			else
			{
				$itemcolor_id=0; 
				$itemColorArr[trim($consbreckdownarr[16])]=$itemcolor_id;
			}
		}
	 }
	 disconnect($con);
	 //check_table_status( $_SESSION['menu_id'],0); disconnect($con); die;
	if($operation==0)
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		
		$id=return_next_id( "id", "wo_pre_cost_trim_cost_dtls", 1);
		$id1=return_next_id( "id", "wo_pre_cost_trim_co_cons_dtls", 1);
		$idsup=return_next_id( "id", "wo_pre_cost_trim_supplier", 1);
		$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1);
		
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
		foreach ($nameArray as $result)
		{
			$wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		
		$field_array="id, job_id, job_no, remark,source_id, trim_group, description, brand_sup_ref, cons_uom, cons_dzn_gmts, ex_per, tot_cons, rate, amount, apvl_req, material_source, nominated_supp_multi, cons_breack_down, country, calculatorstring, quotdtlsid, seq, inserted_by, insert_date, item_print, supplier_rate_id, status_active, is_deleted";
		
		$field_supp_arr="id, job_id, job_no, trimid, supplier_id, inserted_by, insert_date, status_active, is_deleted";
		
		$field_array1="id, job_id, wo_pre_cost_trim_cost_dtls_id, job_no, po_break_down_id, item_size, cons, place, pcs, country_id, excess_per, tot_cons, ex_cons, item_number_id, color_number_id, size_number_id, rate, amount, color_size_table_id, item_color_number_id, rate_cal_data, inserted_by, insert_date, status_active, is_deleted";
		
		$flag=1; $rIDSupp=$rID=$rID1=$rID2=1;
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cbogroup="cbogroup_".$i;
			 $txtremark="txtremark_".$i;
			 $cbosourceid="cbosourceid_".$i;
			 $txtdescription="txtdescription_".$i;
			 $txtsupref="txtsupref_".$i;
			 $cboconsuom="cboconsuom_".$i;
			 $txtconsdzngmts="txtconsdzngmts_".$i;
			 $txttrimrate="txttrimrate_".$i;
			 $txttrimamount="txttrimamount_".$i;
			 $cboapbrequired="cboapbrequired_".$i;
			 $cbonominasupplier="cbonominasupplier_".$i; 
			 $cbotrimstatus="cbotrimstatus_".$i;
			 $updateidtrim="updateidtrim_".$i;
			 $consbreckdown="consbreckdown_".$i;
			 $country="country_".$i;
			 $calculatorstring="calculatorstring_".$i;
			 $seq="seq_".$i;
			 $excess_per="excessper_".$i;
			 $ex_cons="excons_".$i;
			 $total_cons="totalcons_".$i;
			 $cbomaterialsource="cbomaterialsource_".$i;
			 $quotdtlsidtrim="quotdtlsidtrim_".$i;
			 $cboitemprint="cboitemprint_".$i;
			 $supplierrateid="supplierrateid_".$i;
			 
			 $txtdescription=str_replace("'",'',$$txtdescription);
			 $txttrimdescription=str_replace($str_rep,' ',$txtdescription);
			 $txtsupref=str_replace("'",'',$$txtsupref);
			 $txttrimsupref='';
			 $txttrimsupref=str_replace($str_rep,' ',$txtsupref);

			 $txtremark=str_replace("'",'',$$txtremark);
			 $txttrimremark='';
			 $txttrimremark=str_replace($str_rep,' ',$txtremark);
			 if(str_replace("'",'',$$consbreckdown) !='')
			 {
				$consbreckdown= $$consbreckdown;
			 }
			 else
			 {
				$consbreckdown="'".$consPopupArr[str_replace("'",'',$$txtconsdzngmts)][str_replace("'",'',$$txttrimrate)][str_replace("'",'',$$txttrimamount)]."'";
			 }
			//echo "10**".$consbreckdown; die;
			$cons_breckdown=substr(str_replace("'","",$consbreckdown),0,3999);

			$data_array.="INTO wo_pre_cost_trim_cost_dtls (".$field_array.") VALUES(".$id.",".$hidd_job_id.",".$update_id.",'".$txttrimremark."',".$$cbosourceid.",".$$cbogroup.",'".$txttrimdescription."','".$txttrimsupref."',".$$cboconsuom.",".$$txtconsdzngmts.",".$$excess_per.",".$$total_cons.",".$$txttrimrate.",".$$txttrimamount.",".$$cboapbrequired.",".$$cbomaterialsource.",".$$cbonominasupplier.",'".$cons_breckdown."',".$$country.",".$$calculatorstring.",".$$quotdtlsidtrim.",".$$seq.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cboitemprint.",".$$supplierrateid.",1,0)";
			//Nominated Supp $idsup
			$cbonominasupplier=explode(",",str_replace("'",'',$$cbonominasupplier));
			
			foreach($cbonominasupplier as $sid)
			{
				if($sid>0)
				{
					$dataSuppArr ="";
					$dataSuppArr="INSERT INTO wo_pre_cost_trim_supplier (".$field_supp_arr.") VALUES(".$idsup.",".$hidd_job_id.",".$update_id.",'".$id."','".$sid."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
					$idsup++;
					$rIDSupp=execute_query($dataSuppArr);
					if ($rIDSupp==1 && $flag==1) { $flag=1; }
					else { echo "10**trimSuppInsert-".$dataSuppArr; $flag=0; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
				}
			}
			//echo "10**".$consbreckdown; die;
			if(str_replace("'",'',$consbreckdown) !='')
			{
				$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));

				$counter=0;
				for($c=0;$c < count($consbreckdown_array);$c++)
				{
					$counter++;
					$consbreckdownarr=explode('_',$consbreckdown_array[$c]);

					$consbreckdownarr[7]=$consbreckdownarr[7];
					if($consbreckdownarr[7]=='' || $consbreckdownarr[7]==0)
					{
						$consbreckdownarr[7]=$consbreckdownarr[2];
					}
					if(str_replace("'","",$consbreckdownarr[16])=='0') $consbreckdownarr[16]='';
					
					$itemcolor_id=$itemColorArr[trim($consbreckdownarr[16])];
					if($itemcolor_id=="") $itemcolor_id=0;

					$data_array1 ="";
					
					$data_array1="INSERT INTO wo_pre_cost_trim_co_cons_dtls (".$field_array1.") VALUES(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[7]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[2]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".$consbreckdownarr[10]."','".$consbreckdownarr[11]."','".$consbreckdownarr[12]."','".$consbreckdownarr[13]."','".$consbreckdownarr[14]."','".$itemcolor_id."','".$consbreckdownarr[15]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
					
					$id1=$id1+1;
					$rID=execute_query($data_array1);
					if ($rID==1 && $flag==1) { $flag=1; }
					else { echo "10**trimConsInsert-".$data_array1; $flag=0; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
				}
			}
	   		$id=$id+1;
		 }
		$querytrim="INSERT ALL ".$data_array." SELECT * FROM dual";
		//echo "10**".$querytrim; die;
		$rID1=execute_query($querytrim);
		if($rID1==1 && $flag==1) $flag=1; else $flag=0;
		
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$field_array2="id, job_id, job_no, trim_cons, trim_rate, trim_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtconsdzntrim_sum.",".$txtratetrim_sum.",".$txttrimamount_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
			if($rID2==1 && $flag==1) $flag=1; else $flag=0;
		}

		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			$field_array2="trim_cons*trim_rate*trim_amount";
			$data_array2 ="".$txtconsdzntrim_sum."*".$txtratetrim_sum."*".$txttrimamount_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
			if($rID2==1 && $flag==1) $flag=1; else $flag=0;
		}
		//echo "10**".$flag.'--'.$rIDSupp.'--'.$rID.'--'.$rID1.'--'.$rID2; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die;
		if($flag==1) $tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);

		check_table_status( $_SESSION['menu_id'],0);
		//=======================sum End =================
		if($db_type==0)
		{
			if($flag==1){
				mysql_query("COMMIT");
				echo "0**".$update_id."**".$rID."**".$tot_com_amount;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$update_id."**".$rID."**".$tot_com_amount;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($flag==1){
				oci_commit($con);
				echo "0**".$update_id."**".$rID."**".$tot_com_amount;
			}
			else{
				oci_rollback($con);
				echo "10**".$update_id."**".$rID."**".$tot_com_amount;
			}
		}
		disconnect($con);
		die;
	}
	else if($operation==1)
	{
	    $con = connect();
		if($db_type==0) mysql_query("BEGIN");
		//---For Sourcing Cost Sheet----------------------
		 
		$avg_cons_sql="select b.id,b.wo_pre_cost_trim_cost_dtls_id as dtlid,b.po_break_down_id as poid,b.color_size_table_id as sizemstId,b.rate,b.amount,b.sourcing_rate,b.sourcing_amount from wo_pre_cost_trim_co_cons_dtls b,wo_pre_cost_mst a where a.job_id=b.job_id and b.sourcing_rate>0 and b.status_active=1 and b.is_deleted=0  and  a.approved in(0,2) and b.job_no='".str_replace("'", "", $update_id)."'";
		$avg_cons_result=sql_select($avg_cons_sql);
		foreach($avg_cons_result as $row)
		{
		$SourcingTrimArr[$row[csf('poid')]][$row[csf('dtlid')]][$row[csf('sizemstId')]]['rate']=$row[csf('sourcing_rate')];
		$SourcingTrimArr[$row[csf('poid')]][$row[csf('dtlid')]][$row[csf('sizemstId')]]['amount']=$row[csf('sourcing_amount')];
		}
	//----------end----------------------------//

		$is_sequence_validation=return_field_value("season_mandatory", "variable_order_tracking", "company_name=$cbo_company_name and variable_list=63");

		$booking_cons_arr=array();
		if($is_sequence_validation==1)
		{
			$booking_sql="select pre_cost_fabric_cost_dtls_id, booking_no, pre_req_amt from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_type=2 and job_no=".$update_id."";
			$booking_sql_res=sql_select($booking_sql);
			foreach($booking_sql_res as $row)
			{
				$booking_cons_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]]=$row[csf('pre_req_amt')];
			}
			unset($booking_sql_res);
		}

		$msg="Booking Amount is over than Budget.";
		for ($i=1; $i<=$total_row; $i++)
		{
			$updateidtrim="updateidtrim_".$i;
			$txttrimamount="txttrimamount_".$i;

			$pre_cost_trim_cost_dtls_id=str_replace("'","",$$updateidtrim);
			$pretrimamount=str_replace("'","",$$txttrimamount);
			if($pre_cost_trim_cost_dtls_id!="")
			{
				$booking_amt=$booking_cons_arr[$pre_cost_trim_cost_dtls_id];
				if($pretrimamount<$booking_amt)
				{
					echo "6**".$msg;
					 disconnect($con);return;
				}
			}
		}
		unset($booking_cons_arr);

		//if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**1"; die;}
		$field_array_up="job_no*remark*source_id*trim_group*is_apply_last_update*description*brand_sup_ref*cons_uom*cons_dzn_gmts*ex_per*tot_cons*rate*amount*apvl_req*material_source*nominated_supp_multi*cons_breack_down*country*calculatorstring*seq*is_synchronized*item_print*supplier_rate_id*updated_by*update_date";

		$field_array="id, job_id, job_no, remark,source_id, trim_group, description, brand_sup_ref, cons_uom, cons_dzn_gmts, ex_per, tot_cons, rate, amount, apvl_req, material_source, nominated_supp_multi, cons_breack_down, country, calculatorstring, quotdtlsid, seq, inserted_by, insert_date, item_print, status_active, is_deleted";
		 
		$field_supp_arr="id, job_id, job_no, trimid, supplier_id, inserted_by, insert_date, status_active, is_deleted";
		
		$field_array1="id, job_id, wo_pre_cost_trim_cost_dtls_id, job_no, po_break_down_id, item_size, cons, place, pcs, country_id, excess_per, tot_cons, ex_cons, item_number_id, color_number_id, size_number_id, rate, amount, color_size_table_id, item_color_number_id, rate_cal_data, inserted_by, insert_date, status_active, is_deleted";

		$id=return_next_id( "id","wo_pre_cost_trim_cost_dtls", 1);
		$id1=return_next_id( "id", "wo_pre_cost_trim_co_cons_dtls", 1);
		$idsup=return_next_id( "id", "wo_pre_cost_trim_supplier", 1);
		$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1);
		
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		
		$flag=$rIDSupp=$rIDConsDe1=$rIDCons=$rID=$rID1=$rID2=$rIDSuppDe1=1;
		for ($i=1;$i<=$total_row;$i++)
		{
			$cbogroup="cbogroup_".$i;
			$lastappidchk="lastappidchk_".$i;
			$txtremark="txtremark_".$i;
			$cbosourceid="cbosourceid_".$i;
			$txtdescription="txtdescription_".$i;
			$txtsupref="txtsupref_".$i;
			$cboconsuom="cboconsuom_".$i;
			$txtconsdzngmts="txtconsdzngmts_".$i;
			$txttrimrate="txttrimrate_".$i;
			$txttrimamount="txttrimamount_".$i;
			$cboapbrequired="cboapbrequired_".$i;
			$cbonominasupplier="cbonominasupplier_".$i;
			$cbotrimstatus="cbotrimstatus_".$i;
			$updateidtrim="updateidtrim_".$i;
			$consbreckdown="consbreckdown_".$i;
			$country="country_".$i;
			$calculatorstring="calculatorstring_".$i;
			$seq="seq_".$i;
			$excess_per="excessper_".$i;
			$txtsourcingrate="txtsourcingrate_".$i;
			$ex_cons="excons_".$i;
			$total_cons="totalcons_".$i;
			$cbomaterialsource="cbomaterialsource_".$i;
			$quotdtlsidtrim="quotdtlsidtrim_".$i;
			$isconspopupupdate="isconspopupupdate_".$i;
			$cboitemprint="cboitemprint_".$i;
			$supplierrateid="supplierrateid_".$i;
			$isconspopupupdateId=str_replace("'",'',$$isconspopupupdate);
			$itemId=str_replace("'",'',$$cbogroup);
			
			$sourcingrate=str_replace("'",'',$$txtsourcingrate);//For Sourcing Pre cost v2
			$is_synchronized=1;
			if($sourcingrate>0 && $isconspopupupdateId==1)
			{
				$isconspopupupdateId_chk==1;
				$is_synchronized=2;	
			}
			// echo "10**A=".$i.'='.$$txtdescription.'='.str_replace("'",'',$$updateidtrim).'<br>';
			 
			$txtdescription=str_replace("'",'',$$txtdescription);
			$txttrimdescription=str_replace($str_rep,' ',$txtdescription);

			$txtsupref=str_replace("'",'',$$txtsupref);
			$txttrimsupref='';
			$txttrimsupref=str_replace($str_rep,' ',$txtsupref);
			
			$txtremark=str_replace("'",'',$$txtremark);
			$txttrimremark='';
			$txttrimremark=str_replace($str_rep,' ',$txtremark);

			if(str_replace("'",'',$$updateidtrim)!="")
			{
				$cons_breckdown=substr(str_replace("'","",$$consbreckdown),0,100);
				$id_arr[]=str_replace("'",'',$$updateidtrim);
				$data_array_up[str_replace("'",'',$$updateidtrim)] =explode("*",("".$update_id."*'".$txttrimremark."'*".$$cbosourceid."*".$$cbogroup."*".$$lastappidchk."*'".$txttrimdescription."'*'".$txttrimsupref."'*".$$cboconsuom."*".$$txtconsdzngmts."*".$$excess_per."*".$$total_cons."*".$$txttrimrate."*".$$txttrimamount."*".$$cboapbrequired."*".$$cbomaterialsource."*".$$cbonominasupplier."*'".$cons_breckdown."'*".$$country."*".$$calculatorstring."*".$$seq."*".$is_synchronized."*".$$cboitemprint."*".$$supplierrateid."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'"));
				//Nominated Supp 
				$cbonominasupplier=explode(",",str_replace("'",'',$$cbonominasupplier));
				$upidtrim=str_replace("'",'',$$updateidtrim);			
				foreach($cbonominasupplier as $sid)
				{
					$rIDSuppDe1=execute_query( "delete from wo_pre_cost_trim_supplier where trimid ='".$upidtrim."'",0);
					if ($rIDSuppDe1==1 && $flag==1) { $flag=1; }
					else { echo "10**suppUp-"; $flag=0; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
					if($sid>0)
					{
						$dataSuppArr ="";
						$dataSuppArr="INSERT INTO wo_pre_cost_trim_supplier (".$field_supp_arr.") VALUES(".$idsup.",".$hidd_job_id.",".$update_id.",'".$upidtrim."','".$sid."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
						$idsup++;
						$rIDSupp=execute_query($dataSuppArr);
						if ($rIDSupp==1 && $flag==1) { $flag=1; }
						else { echo "10**trimSuppUp-".$dataSuppArr; $flag=0; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
					}
				}
				//	CONS break down===============================================================================================
				if(str_replace("'",'',$$consbreckdown) !='')
				{
					$rIDConsDe1=execute_query("delete from wo_pre_cost_trim_co_cons_dtls where wo_pre_cost_trim_cost_dtls_id =".$$updateidtrim."",0);
					if ($rIDConsDe1==1 && $flag==1) { $flag=1; }
					else { echo "10**consAvgDelUp-"; $flag=0; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
					$consbreckdown_array=explode('__',str_replace("'",'',$$consbreckdown));
					for($c=0;$c < count($consbreckdown_array);$c++)
					{
						$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
						$consbreckdownarr[7]=$consbreckdownarr[7];
						if($consbreckdownarr[7]=='' || $consbreckdownarr[7]==0)
						{
							$consbreckdownarr[7]=$consbreckdownarr[2];
						}

						if(str_replace("'","",$consbreckdownarr[16])=='0') $consbreckdownarr[16]='';						
						$itemcolor_id=$itemColorArr[trim($consbreckdownarr[16])];						
						if($itemcolor_id=="") $itemcolor_id=0;

						$data_array1 ="";
						$data_array1="INSERT INTO wo_pre_cost_trim_co_cons_dtls (".$field_array1.") VALUES(".$id1.",".$hidd_job_id.",".$$updateidtrim.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[7]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[2]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".$consbreckdownarr[10]."','".$consbreckdownarr[11]."','".$consbreckdownarr[12]."','".$consbreckdownarr[13]."','".$consbreckdownarr[14]."','".$itemcolor_id."','".$consbreckdownarr[15]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
						//echo "10**".$data_array1; die;
						$id1=$id1+1;						
						$rIDCons=execute_query($data_array1);
						if ($rIDCons==1) { $flag=1; }
						else { echo "10**trimUpConsInsert-".$data_array1; $flag=0; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
					}
				}//CONS break down end===============================================================================================
			}
			if(str_replace("'",'',$$updateidtrim)=="")
			{
				if(str_replace("'",'',$$consbreckdown) !='')
				 {
					$consbreck_down= $$consbreckdown;
				 }
				 else
				 {
					 $consbreck_down="'".$consPopupArr[str_replace("'",'',$$txtconsdzngmts)][str_replace("'",'',$$txttrimrate)][str_replace("'",'',$$txttrimamount)]."'";
				 }
				

				$cons_breckdown=substr(str_replace("'","",$consbreck_down),0,3999);
				
				$data_array.="INTO wo_pre_cost_trim_cost_dtls (".$field_array.") VALUES(".$id.",".$hidd_job_id.",".$update_id.",'".$txttrimremark."',".$$cbosourceid.",".$$cbogroup.",'".$txttrimdescription."','".$txttrimsupref."',".$$cboconsuom.",".$$txtconsdzngmts.",".$$excess_per.",".$$total_cons.",".$$txttrimrate.",".$$txttrimamount.",".$$cboapbrequired.",".$$cbomaterialsource.",".$$cbonominasupplier.",'".$cons_breckdown."',".$$country.",".$$calculatorstring.",".$$quotdtlsidtrim.",".$$seq.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cboitemprint.",1,0)";
				if(str_replace("'",'',$consbreck_down) !='')
				{
					$consbreckdown_array=explode('__',str_replace("'",'',$consbreck_down));
					for($c=0;$c < count($consbreckdown_array);$c++)
					{
						$counter++;
						$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
						$consbreckdownarr[7]=$consbreckdownarr[7];
						if($consbreckdownarr[7]=='' || $consbreckdownarr[7]==0)
						{
							$consbreckdownarr[7]=$consbreckdownarr[2];
						}
						
						if(str_replace("'","",$consbreckdownarr[16])=='0') $consbreckdownarr[16]='';						
						$itemcolor_id=$itemColorArr[trim($consbreckdownarr[16])];						
						if($itemcolor_id=="") $itemcolor_id=0;
						
						$data_array1="";
						$data_array1="INSERT INTO wo_pre_cost_trim_co_cons_dtls (".$field_array1.") VALUES(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[7]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[2]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".$consbreckdownarr[10]."','".$consbreckdownarr[11]."','".$consbreckdownarr[12]."','".$consbreckdownarr[13]."','".$consbreckdownarr[14]."','".$itemcolor_id."','".$consbreckdownarr[15]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
						//  $data_array1_all.="INTO wo_pre_cost_trim_co_cons_dtls (".$field_array1.") VALUES(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[7]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[2]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".$consbreckdownarr[10]."','".$consbreckdownarr[11]."','".$consbreckdownarr[12]."','".$consbreckdownarr[13]."','".$consbreckdownarr[14]."','".$itemcolor_id."','".$consbreckdownarr[15]."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";

						$id1=$id1+1;
						//echo "10**=A=".$consbreck_down; check_table_status( $_SESSION['menu_id'],0); disconnect($con); die;
						$rIDCons=execute_query($data_array1);
						//if($itemId==780)  echo "10**trimConsInsert-".$data_array1;  check_table_status( $_SESSION['menu_id'],0); disconnect//($con); die;
						if ($rIDCons==1) { $flag=1; }
						else { echo "10**trimConsInsert-".$data_array1; $flag=0; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
					}
				}
				$cbonominasupplier=explode(",",str_replace("'",'',$$cbonominasupplier));		
				foreach($cbonominasupplier as $sid)
				{
					if($sid>0)
					{
						$dataSuppArr ="";
						$dataSuppArr="INSERT INTO wo_pre_cost_trim_supplier (".$field_supp_arr.") VALUES(".$idsup.",".$hidd_job_id.",".$update_id.",'".$id."','".$sid."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
						$idsup++;
						$rIDSupp=execute_query($dataSuppArr);
						if ($rIDSupp==1 && $flag==1) { $flag=1; }
						else { echo "10**trimSuppIns-".$dataSuppArr; $flag=0; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
					}
				}
	          	//CONS break down end
			    $id=$id+1;
			}
		}
		$rID=execute_query(bulk_update_sql_statement( "wo_pre_cost_trim_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
		if($rID==1 && $flag==1) $flag=1; else $flag=0;
		
		if($data_array != "")
		{
			//$rID1=sql_insert("wo_pre_cost_trim_cost_dtls",$field_array,$data_array,0);
			//$querytrim_dtls="INSERT ALL ".$data_array1_all." SELECT * FROM dual";
			//echo "10**A=".$querytrim_dtls;oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; 

			$querytrim="INSERT ALL ".$data_array." SELECT * FROM dual";
			$rID1=execute_query($querytrim);
			if($rID1==1 && $flag==1) $flag=1; else $flag=0;
		}
 		//=======================sum=================
		
		if($wo_pre_cost_sum_dtls_job_no == "")
		{
			$field_array2="id, job_id, job_no, trim_cons, trim_rate, trim_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtconsdzntrim_sum.",".$txtratetrim_sum.",".$txttrimamount_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
			if($rID2==1 && $flag==1) $flag=1; else $flag=0;
		}

		if($wo_pre_cost_sum_dtls_job_no != "")
		{
			$field_array2="trim_cons*trim_rate*trim_amount";
			$data_array2 ="".$txtconsdzntrim_sum."*".$txtratetrim_sum."*".$txttrimamount_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
			if($rID2==1 && $flag==1) $flag=1; else $flag=0;
		}
		
		//echo "10**".$flag.'='.$rIDSupp.'='.$rIDConsDe1.'='.$rIDCons.'='.$rID.'='.$rID1.'='.$rID2.'='.$rIDSuppDe1; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die;
		if($isconspopupupdateId_chk==1) //For Sourcing page 
		{
			execute_query( "update wo_pre_cost_mst set sourcing_ready_to_approved=2 where job_no =".$update_id." ",1);//and sourcing_approved !=1
		}
		//====Sourcing post cost Sheet=====
		if(count($SourcingTrimArr)>0) //Sourcing
		{
			foreach($SourcingTrimArr as $poId=>$PoData)
				{
					foreach($PoData as $trimId=>$trimData)
					{
						foreach($trimData as $sizeMstid=>$val)
						{
							$souring_amount=$val['amount'];
							$souring_rate=$val['rate'];
							$up_avg_rID=execute_query( "update  wo_pre_cost_trim_co_cons_dtls set sourcing_rate='".$souring_rate."',sourcing_amount='".$souring_amount."',sourcing_updated_by=".$_SESSION['logic_erp']['user_id'].",sourcing_update_date='".$pc_date_time."' where po_break_down_id =".$poId." and color_size_table_id =".$sizeMstid." and wo_pre_cost_trim_cost_dtls_id =".$trimId." and status_active=1  ",0);
							if($flag==1) 
							{
							if($up_avg_rID) $flag=1; else $flag=0;
							}
						}
					}
			}
		}
		
		if($flag==1) $tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);
		//=======================sum End =================
		check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($flag==1)
			{
				mysql_query("COMMIT");
				echo "1**".$update_id."**".$rID."**".$tot_com_amount;
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "10**".$update_id."**".$rID."**".$tot_com_amount;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($flag==1)
			{
				oci_commit($con);
				echo "1**".$update_id."**".$rID."**".$tot_com_amount;
			}
			else
			{
				oci_rollback($con);
				echo "10**".$update_id."**".$rID."**".$tot_com_amount;
			}
		}
		disconnect($con);
		die;
	}
}
//*************************************************Trim Cost End ***********************************************
//****************************************Embellishment Cost Start ********************************************
if ($action=="show_embellishment_cost_listview")
{
	$data=explode("**",$data);
	$permission=$data[6];
	$supplier_arr=return_library_array( "select a.id, a.supplier_name from lib_supplier a,lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(23) and a.is_deleted=0 and a.status_active=1 group by a.id, a.supplier_name order by a.supplier_name", "id", "supplier_name");

	$header_td="";
	$costing_per=return_field_value("costing_per", "wo_pre_cost_mst", "job_no ='$data[0]'");
	if($costing_per==1) $header_td="Cons/ 1 Dzn Gmts";
	else if($costing_per==2) $header_td="Cons/ 1 Pcs Gmts";
	else if($costing_per==3) $header_td="Cons/ 2 Dzn Gmts";
	else if($costing_per==4) $header_td="Cons/ 3 Dzn Gmts";
	else if($costing_per==5) $header_td="Cons/ 4 Dzn Gmts";

	$variArr=array();
	$sqlvari=sql_select("select embellishment_id,embellishment_budget_id from variable_order_tracking where company_name='$data[3]' and variable_list=56 and status_active=1 and is_deleted=0");
	foreach($sqlvari as $vari_row)
	{
		//$is_manula_approved=$sql_row[csf('pre_cost_approval')];
		$variArr[$vari_row[csf('embellishment_id')]]=$vari_row[csf('embellishment_budget_id')]?$vari_row[csf('embellishment_budget_id')]:2;
	}
	$component_approved=0;
	$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=3 and job_no='$data[0]'");
	foreach($sql as $row){
		if($row[csf('approved')]==1 || $row[csf('approved')]==3) { $component_approved=1; $approved_message="<marquee width='500'><p style='color:#f00; text-align:center;'> Approved</p></marquee>";}
	}
	 $company_arr=return_library_array( "select id, company_name from lib_company",'id','company_name');
	?>

	<h3 style="width:960px;" align="left" id="accordion_h1" class="accordion_h">+Embellishment Cost <?=$approved_message; ?></h3>
       <div id="content_embellishment_cost" align="left">
    	<fieldset style="width:960px">
        	<form id="embellishment_7" autocomplete="off">
            	<table width="960" cellspacing="0" class="rpt_table" border="0" id="tbl_embellishment_cost" rules="all">
                	<thead>
                    	<tr>
                        	<th width="120" style="color:#2A3FFF">Name</th>
                            <th width="100">Type</th>
                            <th width="100">Body Part</th>
                            <th width="90">Country</th>
                            <th width="120">Emb. Supplier</th>
                            <th width="80" style="color:#2A3FFF"><?=$header_td; ?></th>
                            <th width="70" style="color:#2A3FFF">Rate</th>
                            <th width="80">Amount</th>
                            <th width="80">Status</th>
                            <th>&nbsp;</th>
                        </tr>
                    </thead>
                    <tbody id="emblish_tbl_dtls_for">
                    <?
					$country_library=return_library_array("select id,country_name from lib_country","id","country_name");
					$save_update=1;
					$approved=return_field_value("approved", "wo_pre_cost_mst", "job_no='$data[0]'");
					if($approved==3){
						$approved=1;
					}
					if($approved==1 || $component_approved==1) $disabled=1; else $disabled=0;

					$is_booking_arr=array();
					if($disabled!=1)
					{
						$data_arr=sql_select("select pre_cost_fabric_cost_dtls_id from wo_booking_dtls where job_no ='$data[0]' and booking_type='6' and status_active=1 and is_deleted=0 group by pre_cost_fabric_cost_dtls_id");
						foreach ($data_arr as $row)
						{
							$is_booking_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]]=$row[csf('pre_cost_fabric_cost_dtls_id')];
						}
						unset($data_arr);
					}

					$data_array=sql_select("select id, job_no, quotdtlsid as pri_id, emb_name, emb_type, body_part_id, country, nominated_supp_multi as nominated_supp_multi, is_apply_last_update, cons_dzn_gmts, rate, amount, status_active, budget_on, sourcing_rate from wo_pre_cost_embe_cost_dtls where emb_name!=3 and job_no='$data[0]' and is_deleted=0 order by id");//and status_active=1 ISD-22-07146
					if(count($data_array)<1 && $data[2]==1 && $data[5]==2)//Price Quotation
					{
						$data_array=sql_select("select id as pri_id, quotation_id, emb_name, emb_type, cons_dzn_gmts, rate, amount, status_active from  wo_pri_quo_embe_cost_dtls where emb_name!=3 and quotation_id='$data[1]' and status_active=1 and is_deleted=0 order by id");// quotation_id='$data'
						$save_update=0;
					}
					
					if ($data[2]==1 && $data[5]==4 )//Quick Costing [WVN]
					{
						$qc_no=$data[1];//return_field_value("qc_no", "wo_po_details_master a, qc_mst b", "job_no='$data[0]' and a.inquiry_id=b.inquery_id and b.is_deleted=0 and b.status_active=1");
						$dataQc=sql_select("select id as pri_id, mst_id as quotation_id, particular_type_id as emb_name, fab_id as emb_type, body_part_id, consumption, ex_percent, tot_cons as cons_dzn_gmts, rate, value as amount, status_active from qc_cons_rate_dtls where mst_id='$qc_no' and type=2 and tot_cons>0 and status_active=1 and is_deleted=0 order by id");
						$qcDataArr=array();
						foreach($dataQc as $erow)
						{
							$qcDataArr[$erow[csf('pri_id')]]=$erow[csf('cons_dzn_gmts')].'__'.$erow[csf('excess_per')].'__'.$erow[csf('consumption')].'__'.$erow[csf('rate')].'__'.$erow[csf('amount')];
						}
						if (count($data_array) < 1)//Quick Costing [WVN]
						{
							$data_array=$dataQc;
							$save_update=0;
						}
					}
					
					if( count($data_array)>0)
					{
						$i=0;
						$type_array=array(0=>$blank_array,1=>$emblishment_print_type,2=>$emblishment_embroy_type,3=>$emblishment_wash_type,4=>$emblishment_spwork_type,5=>$emblishment_gmts_type,6=>$blank_array,99=>$emblishment_other_type_arr);

						foreach( $data_array as $row )
						{
							$i++;
							$country_text="";
							$countryarr=explode(",",$row[csf("country")]);
							//print_r($countryarr);
							for($cu=0 ;$cu< count($countryarr); $cu++){
								//echo "mmmm";
								$country_text.= $country_library[trim($countryarr[$cu])].",";
							}
							$country_text=rtrim($country_text,",");
							if($disabled!=1)
							{
								$booking_id='';
								$booking_id=$is_booking_arr[$row[csf('id')]];
								 $txt_dis=""; $dis=0;
								if($booking_id!="") { $dis=1; $txt_dis="disabled"; }
							}
							else $dis=$disabled;
							//if($row[csf("nominated_supp_multi")]=="") $row[csf("nominated_supp_multi")]=0;
							/*$nominated_supp_str="";
							 $exnominated_supp=explode(",",$row[csf("nominated_supp_multi")]);
							 foreach($exnominated_supp as $supp)
							 {
								if($nominated_supp_str=="") $nominated_supp_str=$supplier_arr[$supp]; else $nominated_supp_str.=','.$supplier_arr[$supp];
							 }*/
							  $nominated_supp_str="";
						 //echo $trim_variable;
							 $exnominated_supp=explode("_",$row[csf('nominated_supp_multi')]);
							 foreach($exnominated_supp as $key=>$suppdata)
							 {
								if($key==0){
									$suppdataarr=explode(",",$suppdata);
									foreach($suppdataarr as $supp){
										//if($trim_variable==1) { if($nominated_supp_str=="") $nominated_supp_str=$supplier_library[$supp]; else $nominated_supp_str.=','.$supplier_library[$supp]; }
										//else { if($nominated_supp_str=="") $nominated_supp_str=$supplier_lib_with_rate_arr[$row[csf('trim_group')]][$supp]; else $nominated_supp_str.=','.$supplier_lib_with_rate_arr[$row[csf('trim_group')]][$supp]; }
										if($nominated_supp_str=="") $nominated_supp_str=$supplier_arr[$supp]; else $nominated_supp_str.=','.$supplier_arr[$supp];
									}
								}
								else{
									$comdataarr=explode(",",$suppdata);
									foreach($comdataarr as $comid){
										if($nominated_supp_str=="") $nominated_supp_str=$company_arr[$comid]; else $nominated_supp_str.=','.$company_arr[$comid];
									}
								}
	
							 }
							 
							 if($row[csf("status_active")]!=1) $statustd="red"; else $statustd="";
							 
							 $is_apply_last_update=$row[csf("is_apply_last_update")];
							
							 $msg_app=""; $changedmsgcolor="";
							 if($is_apply_last_update==2)
							 {
								 $msg_app="Color Size changed.";
								 $changedmsgcolor="red";
							 }
							?>
                            <tr id="embellishment_<?=$i;?>" align="center">
                                <td id="cboembnametd_<? echo $i;?>"><? echo create_drop_down( "cboembname_".$i, 120, $emblishment_name_array, "",1," --Select Item--", $row[csf("emb_name")], "cbotype_loder(".$i.")",$dis,'1,2,4,5,6,99' ); ?></td>
                                <td id="embtypetd_<? echo $i;?>"><?  echo create_drop_down( "cboembtype_".$i, 100, $type_array[$row[csf("emb_name")]],"", 1, "--Select--", $row[csf("emb_type")], "check_duplicate(".$i.")",$dis,"" ); ?></td>
                                <td><? echo create_drop_down( "cboembbodypart_".$i, 100, $body_part,"", 1, "--Select--", $row[csf("body_part_id")], "check_duplicate(".$i.")",$dis,"" ); ?></td>
                                <td title="<?=$msg_app; ?>">
                                    <input title="<?=$msg_app; ?>" type="text" id="countrytext_<?=$i; ?>" name="countrytext_<?=$i; ?>" class="text_boxes" style="width:78px; background-color:<?=$changedmsgcolor; ?>" value="<?=$country_text; ?>" <? if($dis==0){echo "";}else{echo "disabled";}?> onDblClick="open_country_popup(<?=$i; ?>,0)" placeholder="Browse" readonly/>
                                    <input type="hidden" id="country_<?=$i; ?>" name="country_<?=$i; ?>" class="text_boxes" style="width:75px" value="<? echo $row[csf("country")]; ?>" />
                                    <input type="hidden" id="lastappidchk_<?=$i; ?>" name="lastappidchk_<?=$i; ?>" class="text_boxes" style="width:75px" value="<?= $row[csf("is_apply_last_update")]; ?>" />
                            	</td>
                                <td>
								<input type="text" name="txtembsupplier_<?=$i; ?>" id="txtembsupplier_<?=$i; ?>" class="text_boxes" style="width:108px;" value="<?=$nominated_supp_str; ?>" <? if($dis==0){echo "";}else{echo "disabled";} ?> onDblClick="fncopenpopup_emblsupplier(<?=$i; ?>);" placeholder="Browse" readonly/>
                                 
                                <input type="hidden" name="cboembsupplierid_<? echo $i;?>" id="cboembsupplierid_<? echo $i;?>" class="text_boxes" style="width:40px;" value="<? echo $row[csf('nominated_supp_multi')]; ?>" /></td>
                                <td id="txtembconsdzngmtstd_<?=$i; ?>">
                                	<input type="text" id="txtembconsdzngmts_<?=$i; ?>" name="txtembconsdzngmts_<?=$i; ?>" class="text_boxes_numeric" style="width:68px" value="<?=$row[csf("cons_dzn_gmts")]; ?>" onChange="calculate_emb_cost(<?=$i; ?>);" onDblClick="set_session_large_post_data_emb( 'requires/pre_cost_entry_controller_v2.php?action=consumption_popup_emb', 'Consumption Entry Form', <?=$i;?>);" qcdata="<?=$qcDataArr[$row[csf('pri_id')]]; ?>" readonly/></td>
                                <td id="txtembratetd_<? echo $i;?>">
                                	<input type="text" id="txtembrate_<? echo $i; ?>"  name="txtembrate_<? echo $i; ?>" class="text_boxes_numeric" style="width:58px" value="<? echo $row[csf("rate")];  ?>" onChange="calculate_emb_cost( <? echo $i;?> )" <? if($dis==0){echo "";}else{echo "disabled";}?> readonly/>
                                     <input type="hidden" id="txtsourcingrate_<?=$i; ?>" name="txtsourcingrate_<?=$i; ?>"  class="text_boxes_numeric" style="width:40px" value="<?=$row[csf("sourcing_rate")]; ?>"/>
                                </td>
                                <td id="txtembamounttd_<? echo $i;?>">
                                	<input type="text" id="txtembamount_<? echo $i; ?>" name="txtembamount_<? echo $i; ?>" class="text_boxes_numeric" style="width:68px" value="<? echo $row[csf("amount")]; ?>" <? if($dis==0){echo "";}else{echo "disabled";}?> readonly/>
                                </td>
                                <td bgcolor="<?=$statustd; ?>" id="cboembstatustd_<?=$i; ?>"><?=create_drop_down( "cboembstatus_".$i, 80, $row_status,"", 0, "0", $row[csf("status_active")], "set_sum_value( 'txtamountemb_sum', 'txtembamount_', 'tbl_embellishment_cost' );",$dis,'' );  ?></td>
                                <td id="buttontd_<?=$i; ?>">
                                    <input type="button" id="increaseemb_<?=$i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_embellishment_cost(<?=$i; ?>);"  <? if($disabled==0){echo "";}else{echo "disabled";}?>/>
                                    <input type="button" id="decreaseemb_<?=$i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<?=$i; ?> ,'tbl_embellishment_cost',this);" <? if($disabled==0){echo "";}else{echo "disabled";}?> />
                                    <input type="hidden" id="isconspopupupdate_<?=$i; ?>" name="isconspopupupdate_<?=$i; ?>" class="text_boxes" style="width:20px" value="0" disabled/>
                                    <input type="hidden" id="embupdateid_<?=$i; ?>" name="embupdateid_<?=$i; ?>" class="text_boxes" style="width:20px" value="<?=$row[csf("id")]; ?>" />
                                    <input type="hidden" id="quotdtlsidemb_<?=$i; ?>" name="quotdtlsidemb_<?=$i; ?>" class="text_boxes" style="width:20px" value="<?=$row[csf("pri_id")]; ?>" />
                                    <input type="hidden" id="consbreckdownemb_<? echo $i; ?>" name="consbreckdownemb_<? echo $i; ?>"  class="text_boxes" style="width:20px" value="<? //echo  $row[csf("id")]; ?>"  />
                                    <input type="hidden" id="empbudgeton_<? echo $i; ?>" name="empbudgeton_<? echo $i; ?>"  class="text_boxes" style="width:20px" value="<? if($row[csf("budget_on")]){echo  $row[csf("budget_on")];} else{echo $variArr[$row[csf("emb_name")]]; }?>"  />
                                </td>
                            </tr>
                            <?
						}
					}
					else
					{
						$save_update=0;
						$type_array=array(0=>$blank_array,1=>$emblishment_print_type,2=>$emblishment_embroy_type,3=>$emblishment_wash_type,4=>$emblishment_spwork_type,5=>$emblishment_gmts_type,6=>$blank_array,99=>$emblishment_other_type_arr);
						$i=0;
						foreach( $emblishment_name_array as $row => $value )
						{
							$i++;
							if($i==3) continue;
							else if($i==1)//ISD-21-04075
							{
								if($i>3) $i=$i-1;
								//echo $i;
								?>
								<tr id="embellishment_<? echo $i;?>" align="center">
                                    <td id="cboembnametd_<? echo $i;?>"><? echo create_drop_down( "cboembname_".$i, 120, $emblishment_name_array, "",0,"", $row, "cbotype_loder(".$i.")",'','1,2,4,5,6,99' ); ?></td>
                                    <td id="embtypetd_<? echo $i;?>"><? echo create_drop_down( "cboembtype_".$i, 100, $type_array[$row],"", 1, "-- Select --", "", "check_duplicate(".$i.")","","" ); ?></td>
                                    <td><? echo create_drop_down( "cboembbodypart_".$i, 100, $body_part,"", 1, "--Select--", '', "check_duplicate(".$i.")",'',"" ); ?></td>
                                     <td>
                                        <input  type="text" id="countrytext_<? echo $i; ?>" name="countrytext_<? echo $i; ?>" class="text_boxes" style="width:78px" value="" onDblClick="open_country_popup('<? echo $i.'_2'; ?>',0);" placeholder="Browse" readonly/>
                                        <input type="hidden" id="country_<? echo $i; ?>" name="country_<? echo $i; ?>" class="text_boxes" style="width:75px" value="" />
                                        <input type="hidden" id="lastappidchk_<?=$i; ?>" name="lastappidchk_<?=$i; ?>" class="text_boxes" style="width:75px" value="" />
                                    </td>
                                    <td id="">
										<input type="text" name="txtembsupplier_<? echo $i;?>" id="txtembsupplier_<? echo $i;?>" style="width:108px" placeholder="Browse" class="text_boxes" onDblClick="fncopenpopup_emblsupplier(<?=$i; ?>);" value="" />
                                        
                                        <input type="hidden" name="cboembsupplierid_<? echo $i;?>" id="cboembsupplierid_<? echo $i;?>" class="text_boxes" style="width:40px;" value="" />
									</td>
                                    <td id="txtembconsdzngmtstd_<? echo $i;?>">
                                    	<input type="text" id="txtembconsdzngmts_<? echo $i; ?>"  name="txtembconsdzngmts_<? echo $i; ?>" class="text_boxes_numeric" style="width:68px" value="" onChange="calculate_emb_cost( <? echo $i;?> )" onDblClick="set_session_large_post_data_emb('requires/pre_cost_entry_controller_v2.php?action=consumption_popup_emb', 'Consumption Entry Form',<? echo $i;?>)" qcdata="" readonly/>
                                    </td>
                                    <td id="txtembratetd_<? echo $i;?>">
                                    	<input type="text" id="txtembrate_<? echo $i; ?>"  name="txtembrate_<? echo $i; ?>" class="text_boxes_numeric" style="width:58px" value="" onChange="calculate_emb_cost( <? echo $i;?> )" readonly/>
                                         <input type="hidden" id="txtsourcingrate_<?=$i; ?>" name="txtsourcingrate_<?=$i; ?>"  class="text_boxes_numeric" style="width:40px" value=""/>
                                    </td>
                                    <td id="txtembamounttd_<? echo $i;?>"><input type="text" id="txtembamount_<? echo $i; ?>"  name="txtembamount_<? echo $i; ?>" class="text_boxes_numeric" style="width:68px" value="" readonly />
                                    </td>
                                    
                                    <td bgcolor="<?=$statustd; ?>" id="cboembstatustd_<?=$i; ?>"><?=create_drop_down( "cboembstatus_".$i, 80, $row_status,"", 0, "0", $selected, "set_sum_value( 'txtamountemb_sum', 'txtembamount_', 'tbl_embellishment_cost' );",'','' );  ?></td>
                                    <td id="buttontd_<?=$i; ?>">
                                      <input type="hidden" id="isconspopupupdate_<?=$i; ?>" name="isconspopupupdate_<?=$i; ?>" class="text_boxes" style="width:20px" value="0" disabled/>
                                        <input type="button" id="increaseemb_<?=$i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_embellishment_cost(<?=$i; ?>);" />
                                        <input type="button" id="decreaseemb_<?=$i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<?=$i; ?> ,'tbl_embellishment_cost',this);" />
                                        <input type="hidden" id="embupdateid_<?=$i; ?>" name="embupdateid_<?=$i; ?>"  class="text_boxes" style="width:20px" value=""  />            
                                        <input type="hidden" id="quotdtlsidemb_<?=$i; ?>" name="quotdtlsidemb_<?=$i; ?>" class="text_boxes" style="width:20px" value="" />                        	
                                        <input type="hidden" id="consbreckdownemb_<?=$i; ?>" name="consbreckdownemb_<?=$i; ?>"  class="text_boxes" style="width:20px" value="" />
                                        <input type="hidden" id="empbudgeton_<?=$i; ?>" name="empbudgeton_<?=$i; ?>"  class="text_boxes" style="width:20px" value="<?=$variArr[$row]; ?>"  />
                                    </td>
								</tr>
								<?
								if($i==3 || $i==4 || $i==5) $i++;
							}
						}
					}
					?>
                </tbody>
            </table>
            <table width="960" cellspacing="0" class="rpt_table" border="0" rules="all">
                <tfoot>
                	<tr>
                        <th width="120">&nbsp;</th>
                        <th width="100">&nbsp;</th>
                        <th width="100">&nbsp;</th>
                        <th width="90">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="80">&nbsp;</th>
                        <th width="70">Sum:</th>
                        <th width="80"><input type="text" id="txtamountemb_sum"  name="txtamountemb_sum" class="text_boxes_numeric" style="width:68px" readonly /></th>
                        <th width="80">&nbsp;</th>
                        <th>&nbsp;</th>
                    </tr>
                </tfoot>
            </table>
            <table width="960" cellspacing="0" class="" border="0">
                <tr>
                    <td align="center" width="100%" class="button_container">
                    <?
                    if ( count($data_array)>0)
                    {
                    	echo load_submit_buttons( $permission, "fnc_embellishment_cost_dtls", $save_update,0,"fnc_emb_resetFrom()",7) ;
						 
                    }
                    else
                    {
                    	echo load_submit_buttons( $permission, "fnc_embellishment_cost_dtls", $save_update,0,"fnc_emb_resetFrom()",7) ;
                    }
                    ?>
                    </td>
                </tr>
            </table>
        </form>
        </fieldset>
    </div>
	<?
	exit();
}

if ($action=="load_drop_down_embtype")
{
	/*$data=explode('_',$data);
	if($data[0]==1)
	{
		echo create_drop_down( "cboembtype_".$data[1], 97,$emblishment_print_type,"", 1, "-- Select --", "", "check_duplicate(".$data[1].")","","" );
		die;
	}
	if($data[0]==2)
	{
		echo create_drop_down( "cboembtype_".$data[1], 97,$emblishment_embroy_type,"", 1, "-- Select --", "", "check_duplicate(".$data[1].")","","" );
		die;
	}
	if($data[0]==3)
	{
		echo create_drop_down( "cboembtype_".$data[1], 97,$emblishment_wash_type,"", 1, "-- Select --", "", "check_duplicate(".$data[1].")","","" );
		die;
	}
	if($data[0]==4)
	{
		echo create_drop_down( "cboembtype_".$data[1], 97,$emblishment_spwork_type,"", 1, "-- Select --", "", "check_duplicate(".$data[1].")","","" );
		die;
	}
	if($data[0]==5)
	{
		echo create_drop_down( "cboembtype_".$data[1], 97,$emblishment_gmts_type,"", 1, "-- Select --", "", "","","" );
		die;
	}
	if($data[0]==99)
	{
		echo create_drop_down( "cboembtype_".$data[1], 97,$blank_array,"", 1, "-- Select --", "", "","","" );
		die;
	}*/

	$data=explode('_',$data);
	$variArr=array();
	$sqlvari=sql_select("select embellishment_id,embellishment_budget_id from variable_order_tracking where company_name='$data[2]' and variable_list=56 and status_active=1 and is_deleted=0");
	foreach($sqlvari as $vari_row)
	{
		//$is_manula_approved=$sql_row[csf('pre_cost_approval')];
		$variArr[$vari_row[csf('embellishment_id')]]=$vari_row[csf('embellishment_budget_id')]?$vari_row[csf('embellishment_budget_id')]:2;
	}
	$cboembtype="";
	$budget_on=2;
	if($data[0]==1)
	{
		$cboembtype= create_drop_down( "cboembtype_".$data[1], 97,$emblishment_print_type,"", 1, "-- Select --", "", "check_duplicate(".$data[1].")","","" );
	}
	else if($data[0]==2)
	{
		$cboembtype= create_drop_down( "cboembtype_".$data[1], 97,$emblishment_embroy_type,"", 1, "-- Select --", "", "check_duplicate(".$data[1].")","","" );

	}
	else if($data[0]==3)
	{
		asort($emblishment_wash_type);
		$cboembtype= create_drop_down( "cboembtype_".$data[1], 97,$emblishment_wash_type,"", 1, "-- Select --", "", "check_duplicate(".$data[1].")","","" );

	}
	else if($data[0]==4)
	{
		$cboembtype= create_drop_down( "cboembtype_".$data[1], 97,$emblishment_spwork_type,"", 1, "-- Select --", "", "check_duplicate(".$data[1].")","","" );

	}
	else if($data[0]==5)
	{
		$cboembtype= create_drop_down( "cboembtype_".$data[1], 97,$emblishment_gmts_type,"", 1, "-- Select --", "", "","","" );

	}
	else if($data[0]==99)
	{
		$cboembtype= create_drop_down( "cboembtype_".$data[1], 97,$emblishment_other_type_arr,"", 1, "-- Select --", "", "","","" );

	}else{
		$cboembtype= create_drop_down( "cboembtype_".$data[1], 97,$blank_array,"", 1, "-- Select --", "", "","","" );
	}
	echo "document.getElementById('embtypetd_".$data[1]."').innerHTML = '".$cboembtype."';\n";
	echo "document.getElementById('empbudgeton_".$data[1]."').value = '".$variArr[$data[0]]."';\n";
}

if($action=="save_post_session_emb"){
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$_SESSION['logic_erp']['cons_breck_downn_emb']="";
	$_SESSION['logic_erp']['cons_breck_downn_emb']=$cons_breck_downn_emb;
	echo 1;
	die;
}

if($action=="consumption_popup_emb"){
    echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode,'','');
    extract($_REQUEST);
	$cons_breck_downn= $_SESSION['logic_erp']['cons_breck_downn_emb'];
	$itemqty_array=array();
	$job_plancut_qty=0;

	$country=rtrim($country,",");
	 if($country==""){
		 $country_cond="";
	 }else{
		 $country_cond=" and c.country_id in($country)";
	 }
	 $color_library=return_library_array("select id,color_name from lib_color where status_active=1 and is_deleted=0","id","color_name");
	 $size_library=return_library_array("select id,size_name from lib_size where status_active=1 and is_deleted=0","id","size_name");
	 $country_library=return_library_array("select id,country_name from lib_country","id","country_name");

	$data_array_tot_job_qty=sql_select("select b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id ,min(c.id) as color_size_table_id,min(color_order) as color_order,min(size_order) as size_order,sum(plan_cut_qnty) as plan_cut_qnty, sum(c.order_quantity) as order_quantity from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id  and b.job_no_mst='$txt_job_no'  $country_cond  and a.garments_nature='$garments_nature' and a.status_active=1 and b.status_active=1 and c.status_active=1 group by b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id order by b.id,c.item_number_id,color_order,size_order");
	foreach($data_array_tot_job_qty as $data_array_tot_job_qty_row ){
		if($empbudgeton==1){
			$itemqty_array[$data_array_tot_job_qty_row[csf('item_number_id')]]+=$data_array_tot_job_qty_row[csf('order_quantity')];
			$job_plancut_qty+=$data_array_tot_job_qty_row[csf('order_quantity')];
		}
		else if($empbudgeton==2){
			$itemqty_array[$data_array_tot_job_qty_row[csf('item_number_id')]]+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
			$job_plancut_qty+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
		}else{
			$itemqty_array[$data_array_tot_job_qty_row[csf('item_number_id')]]+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
		    $job_plancut_qty+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
		}

		$po_no_library[$data_array_tot_job_qty_row[csf('id')]]=$data_array_tot_job_qty_row[csf('po_number')];
	}
       $item_idarr=explode(",",$item_id);
       $total_item=count($item_idarr);
	?>
	<script>
		function copy_value(value,field_id,i)
		{
			//var copy_val=document.getElementById('copy_val').checked;
			var gmtssizesid=document.getElementById('gmtssizesid_'+i).value;
			var pocolorid=document.getElementById('pocolorid_'+i).value;
			var ponoid=document.getElementById('ponoid_'+i).value;
			var cbogmtsitem=document.getElementById('cbogmtsitem_'+i).value;
			var rowCount = $('#tbl_consmption_cost tr').length-1;
			var copy_basis=$('input[name="copy_basis"]:checked').val()
			for(var j=i; j<=rowCount; j++){
				if(document.getElementById('approved_'+j).value==0){
					if(field_id=='rate_'){
						if(copy_basis==0){
							document.getElementById(field_id+j).value=value;
							//claculate_amount(j)
						}
						else if(copy_basis==1){
							if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0){
								document.getElementById(field_id+j).value=value;
								//claculate_amount(j)
							}
						}
						else if(copy_basis==2){
							if( pocolorid==document.getElementById('pocolorid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0){
								document.getElementById(field_id+j).value=value;
								//claculate_amount(j)
							}
						}
						else if(copy_basis==3){
							if( cbogmtsitem==document.getElementById('cbogmtsitem_'+j).value && (document.getElementById('requirement_'+j).value*1) >0){
								document.getElementById(field_id+j).value=value;
								//claculate_amount(j)
							}
						}
						else if(copy_basis==4){
							if( ponoid==document.getElementById('ponoid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0){
								document.getElementById(field_id+j).value=value;
								//claculate_amount(j)
							}
						}
					}
					if(field_id=='requirement_'){
						if(copy_basis==0){
							document.getElementById(field_id+j).value=value;
							//claculate_amount(j)
						}
						else if(copy_basis==1){
							if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value){
								document.getElementById(field_id+j).value=value;
								//claculate_amount(j)
							}
						}
						else if(copy_basis==2){
							if( pocolorid==document.getElementById('pocolorid_'+j).value){
								document.getElementById(field_id+j).value=value;
								//claculate_amount(j)
							}
						}
						else if(copy_basis==3){
							if( cbogmtsitem==document.getElementById('cbogmtsitem_'+j).value){
								document.getElementById(field_id+j).value=value;
								//claculate_amount(j)
							}
						}
						else if(copy_basis==4){
							if( ponoid==document.getElementById('ponoid_'+j).value){
								document.getElementById(field_id+j).value=value;
								//claculate_amount(j)
							}
						}
					}
				}//if(var approved=document.getElementById('approved_'+j).value==0)
				var rate=document.getElementById('rate_'+j).value;
				var requirement=document.getElementById('requirement_'+j).value;
				var amount= requirement*rate;
				document.getElementById('amount_'+j).value=number_format_common(amount,5,0);
			}
			set_sum_value('amount_sum', 'amount_');
			claculate_avg();
		}

		function fn_delete_down_tr(rowNo,table_id)
		{
			if(table_id=='tbl_consmption_cost')
			{
				var numRow = $('table#tbl_consmption_cost tbody tr').length;
				if(numRow==rowNo && rowNo!=1)
				{
					$('#tbl_consmption_cost tbody tr:last').remove();
					$('#tbl_msmnt_cost tbody tr:last').remove();
				}
				set_sum_value( 'requirement_sum', 'requirement_');
				set_sum_value( 'rate_sum', 'rate_');
				set_sum_value( 'amount_sum', 'amount_');
			}
		}

		function set_sum_value(des_fil_id,field_id){
			if(des_fil_id=='requirement_sum'){
			var ddd={dec_type:5,comma:0};
			}

			if(des_fil_id=='amount_sum'){
				var ddd={dec_type:5,comma:0};
			}

			if(des_fil_id=='rate_sum'){
				var ddd={dec_type:5,comma:0};
			}
			var rowCount = $('#tbl_consmption_cost tr').length-1;
			math_operation( des_fil_id, field_id, '+', rowCount,ddd );
			claculate_avg();
		}

		function js_set_value(){
			var rowCount = $('#tbl_consmption_cost tr').length-1;
			var cons_breck_down="";
			for(var i=1; i<=rowCount; i++){
				var ponoid=$('#ponoid_'+i).val()
				if(ponoid==''){ ponoid=0; }
				var cbogmtsitem=$('#cbogmtsitem_'+i).val()
				if(cbogmtsitem==''){ cbogmtsitem=0; }

				var pocolorid=$('#pocolorid_'+i).val()
				if(pocolorid==''){ pocolorid=0; }
				var gmtssizesid=$('#gmtssizesid_'+i).val()
				if(gmtssizesid==''){ gmtssizesid=0; }
				var requirement=$('#requirement_'+i).val()
				if(requirement==''){ requirement=0; }
				var colorsizetableid=$('#colorsizetableid_'+i).val()
				if(colorsizetableid==''){ colorsizetableid=0; }
				var rate=$('#rate_'+i).val()
				if(rate==''){ rate=0; }
				var amount=$('#amount_'+i).val()
				if(amount==''){ amount=0; }
				var countyid=$('#cbocountry_'+i).val()
				if(countyid==''){ countyid=0; }

				if(cons_breck_down==""){
					cons_breck_down+=ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid+'_'+countyid;
				}
				else{
					cons_breck_down+="__"+ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid+'_'+countyid;
				}
			}
			document.getElementById('cons_breck_down').value=cons_breck_down;
			claculate_avg();
			parent.emailwindow.hide();
		}

		function claculate_avg(){
			//var tot_plancut_qty=document.getElementById('job_plancut_qty').value*1
			var item_ratio=document.getElementById('item_ratio').value*1
			var total_item=document.getElementById('total_item').value*1
			var calculated_cons=0; var avg_cons=0; var plancutqty=0; var calculated_amount=0;
			var rowCount = $('#tbl_consmption_cost tr').length-1;

			/*for(var j=1; j<=rowCount; j++){
				if(document.getElementById('requirement_'+j).value =='' || document.getElementById('requirement_'+j).value ==0){
					continue;
				}
				else{
					//plancutqty+=document.getElementById('pcsgmts_'+j).value*1;
				}
			}*/

			for(var i=1; i<=rowCount; i++){
				if(document.getElementById('requirement_'+i).value =='' || document.getElementById('requirement_'+i).value ==0){
					continue;
				}
				else{

					var tot_plancut_qty=document.getElementById('itempcsgmts_'+i).value*1
					var pcsgmts=document.getElementById('pcsgmts_'+i).value*1
					var plan_cut_percent=(pcsgmts/tot_plancut_qty)*100;
					var requirement=document.getElementById('requirement_'+i).value*1
					var calculated_cons_percent=(requirement*plan_cut_percent)/100;
					calculated_cons+=calculated_cons_percent;
					var amount=document.getElementById('amount_'+i).value*1
					var calculated_amount_percent=(amount*plan_cut_percent)/100;
					calculated_amount+=calculated_amount_percent;
				}
			}
			document.getElementById('calculated_cons').value=number_format_common(calculated_cons,5, 0);
			document.getElementById('calculated_amount').value=number_format_common(calculated_amount,5, 0);
			document.getElementById('calculated_rate').value=number_format_common((calculated_amount/calculated_cons), 5, 0);
			//document.getElementById('calculated_cons').value=number_format_common(calculated_cons,5, 0);
			//document.getElementById('calculated_amount').value=number_format_common(calculated_amount,5, 0);
			//document.getElementById('calculated_rate').value=number_format_common(((calculated_cons*item_ratio)/total_item)/((calculated_amount/calculated_cons)/total_item), 5, 0);
		}

		function claculate_amount(i){
			var rate=document.getElementById('rate_'+i).value;
			var requirement=document.getElementById('requirement_'+i).value;
			var amount= requirement*rate;
			document.getElementById('amount_'+i).value=number_format_common(amount,5,0);
			set_sum_value( 'amount_sum', 'amount_' );
			claculate_avg()
		}
    </script>
	</head>
	<body>
    <div align="center" style="width:99%;" >
    	<fieldset>
            <legend><? echo $body_part_id.'.'.$body_part[$body_part_id].' Costing '.$costing_per[$cbo_costing_per] ;?></legend>
        	<form id="consumptionform_1" autocomplete="off">
                <input type="hidden" id="cbo_company_id" name="cbo_company_id" value="<? echo $cbo_company_id; ?>"/>
                <input type="hidden" id="cbo_costing_per_id" name="cbo_costing_per_id" value="<? echo $cbo_costing_per; ?>"/>
                <input type="hidden" id="cons_breck_down" name="cons_breck_down"  width="500"  value="<? echo $cons_breck_downn;?>"/>
                <input type="hidden" id="job_plancut_qty" name="job_plancut_qty" value="<? echo $job_plancut_qty; ?>"/>
                <input type="hidden" id="item_ratio" name="item_ratio" value="<? echo $tot_set_qnty; ?>"/>
                <input type="hidden" id="total_item" name="item_ratio" value="<? echo $total_item; ?>"/>

                <!--<b>Copy</b> : <input type="checkbox" id="copy_val" name="copy_val" checked/>  -->
                <input type="radio" name="copy_basis" value="0" checked>Copy To  All
                <input type="radio" name="copy_basis" value="1">Copy Size Wise
                <input type="radio" name="copy_basis" value="2">Copy Color Wise
                <input type="radio" name="copy_basis" value="3">Copy Item Wise
                <input type="radio" name="copy_basis" value="4">Copy Po Wise
                <input type="reset" value="Reset">
            </form>
            <table width="930" cellspacing="0" class="rpt_table" border="0" id="tbl_consmption_cost" rules="all">
                <thead>
                    <tr>
                    	<th width="30">SL</th>
                        <th width="130">PO NO</th>
                        <th width="110">Country</th>
                        <th width="130">Gmts. Item</th>
                        <th width="100">Gmts. Color</th>
                        <th width="100">Gmts. Size</th>
                        <th width="65" style="color:#2A3FFF">Cons</th>
                        <th width="60" style="color:#2A3FFF">Rate</th>
                        <th width="90">Amount</th>
                        <th>&nbsp;</th>
                    </tr>
                </thead>
                <tbody>
					<?
                    $component_approved=0;
                    $sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=3 and job_no='$txt_job_no'");
                    foreach($sql as $row){
						if($row[csf('approved')]==1 || $row[csf('approved')]==3) { $component_approved=1; }
					}
					$data_array=explode("__",$cons_breck_downn);
					if($data_array[0]==""){
						$data_array=array();
                    }
					
					$copy_variable_sql=sql_select("select variable_list, copy_quotation, cost_control_source from variable_order_tracking where company_name='$cbo_company_id' and variable_list in (20,53)");
                    //echo "select trim_rate from  variable_order_tracking where company_name='$company_name' and variable_list=35 order by id";
					$copy_quotation=$cost_control_source=0;
                    foreach($copy_variable_sql as $emb_variable_row)
                    {
                        if($emb_variable_row[csf('variable_list')]==20) $copy_quotation=$emb_variable_row[csf('copy_quotation')];
						if($emb_variable_row[csf('variable_list')]==53) $cost_control_source=$emb_variable_row[csf('cost_control_source')];
                    }
                    unset($trim_variable_sql);

					$country_array=array();
					$data_country=sql_select("select b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id ,c.country_id from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and b.job_no_mst='$txt_job_no' $country_cond   and a.status_active=1 and b.status_active=1 and c.status_active=1");
					foreach($data_country as $cou_row){
						 $country_array[$cou_row[csf('id')]][$cou_row[csf('item_number_id')]][$cou_row[csf('color_number_id')]][$cou_row[csf('size_number_id')]]['country_id'][$cou_row[csf('country_id')]]=$cou_row[csf('country_id')];
						 $country_array[$cou_row[csf('id')]][$cou_row[csf('item_number_id')]][$cou_row[csf('color_number_id')]][$cou_row[csf('size_number_id')]]['country_name'][$cou_row[csf('country_id')]]=$country_library[$cou_row[csf('country_id')]];
					}
					//print_r ($country_array);
                    $data_array=sql_select("select b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id ,min(c.id) as color_size_table_id,min(color_order) as color_order,min(size_order) as size_order,sum(plan_cut_qnty) as plan_cut_qnty, sum(c.order_quantity) as order_quantity from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c  where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id  and b.job_no_mst='$txt_job_no' $country_cond and a.garments_nature='$garments_nature' and a.status_active=1 and b.status_active=1 and c.status_active=1 group by b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id order by b.id,c.item_number_id,color_order,size_order");
                    //=======================================
					if($db_type==0) $booking_qty="IFNULL(wo_qnty,0)"; else if ($db_type==2) $booking_qty="nvl(wo_qnty,0)";
					$is_booking_arr=array();
                    if($embupdateid != ""){
						$is_booking_arr=array();
						/*if($cbo_approved_status!=1)
						{*/
							$data_arr=sql_select("select po_break_down_id, pre_cost_fabric_cost_dtls_id from wo_booking_dtls where pre_cost_fabric_cost_dtls_id ='$embupdateid' and booking_type='6' and status_active=1 and is_deleted=0 and $booking_qty>0 group by po_break_down_id, pre_cost_fabric_cost_dtls_id");
							foreach($data_arr as $row)
							{
								$is_booking_arr[$row[csf('po_break_down_id')]]=$row[csf('pre_cost_fabric_cost_dtls_id')];
							}
							unset($data_arr);
						//}

						$row_arr_data="";
						$wo_pre_cos_fab_co_avg_con_dtls_data=sql_select("select id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id, item_number_id, color_number_id, size_number_id, requirment, rate, amount, color_size_table_id, country_id from wo_pre_cos_emb_co_avg_con_dtls where job_no='$txt_job_no' and pre_cost_emb_cost_dtls_id=$embupdateid order by id"); $embConsArr=array(); $colorWiseDataArr=array();
						foreach($wo_pre_cos_fab_co_avg_con_dtls_data as $emb_con_row){
							if($emb_con_row[csf('country_id')]=="") $emb_con_row[csf('country_id')]=0;
							$embConsArr[$emb_con_row[csf('color_size_table_id')]]=$emb_con_row[csf('po_break_down_id')]."_".$emb_con_row[csf('item_number_id')]."_".$emb_con_row[csf('color_number_id')]."_".$emb_con_row[csf('size_number_id')]."_".$emb_con_row[csf('requirment')]."_".$emb_con_row[csf('rate')]."_".$emb_con_row[csf('amount')]."_".$emb_con_row[csf('color_size_table_id')]."_".$emb_con_row[csf('country_id')];
							if($emb_con_row[csf('requirment')]!=0 && $emb_con_row[csf('rate')]!=0)
								$colorWiseDataArr[$emb_con_row[csf('color_number_id')]]['copyConsdata']=$emb_con_row[csf('requirment')]."_".$emb_con_row[csf('rate')]."_".$emb_con_row[csf('amount')];
						}
                    }
					//print_r($colorWiseDataArr);

                    if($embupdateid == "") $data_array_cons=explode("__",$cons_breck_downn);

                    if($precostapproved==1 || $component_approved==1) $disabled=1; else $disabled=0;
					/*$cons_up=0;
					if(count($data_arr)>0 &&  $disabled!=1)
					{
						$disabled=1; $cons_up=1;
					}*/
					//echo $copy_quotation.'='.$cost_control_source.'='.($data[4]*1).'='.$embupdateid;
                    //=======================================
                    if ( count($data_array)>0){
						$i=0;
						$pcsgmts=0;
						foreach( $data_array as $row )
						{
							if($embupdateid != "") $data=explode('_',$embConsArr[$row[csf('color_size_table_id')]]);
							else $data=explode('_',$data_array_cons[$i]);
							$i++;
							if($empbudgeton==1) $pcsgmts=$row[csf('order_quantity')];
							else if($empbudgeton==2) $pcsgmts=$row[csf('plan_cut_qnty')];
							else $pcsgmts=$row[csf('plan_cut_qnty')];

							$country_string=implode(",",$country_array[$row[csf('id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['country_id']);
							$country_string_name=implode(",",$country_array[$row[csf('id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['country_name']);

							$po_country_arr=explode(",",$country_string);

							$countrydata=explode(",",$data[8]);
							$arr_d=array_diff($countrydata, $po_country_arr);
							$arr_d2=array_diff($countrydata, $arr_d);
							$country_name="";

							for($countryindex=0; $countryindex < count($arr_d2);$countryindex++){
								$country_name.=	$country_library[$countrydata[$countryindex]].",";
							}
							$country_idstring=implode(",",$arr_d2);

							if(count($arr_d)>0 && count($countrydata)>0 )
							{
								$country_name_pre="";
								for($countryindex=0; $countryindex < count($arr_d);$countryindex++){
									$country_name_pre.=	$country_library[$countrydata[$countryindex]].",";
								}
								$title="Country have Changed in po entry, you have to update this field, Previous Country was ".rtrim($country_name_pre,",")."";
								if(rtrim($country_name_pre,",")!=""){
									$bgc="#D41F00";
								}
							}
							else{
								$title=""; $bgc="#FFFFFF";
							}
							$cons_fld=0;
							if($disabled!=1)
							{
								//echo $is_booking_arr[$row[csf('id')]];
								if($is_booking_arr[$row[csf('id')]]!="" || $is_booking_arr[$row[csf('id')]]!=0) $cons_fld=1;
							}
							?>
							<tr id="break_<?=$i; ?>" align="center">
                                <td align="center"><?=$i; ?></td>
                                <td>
                                    <input type="text" id="pono_<?=$i; ?>" name="pono_<?=$i; ?>" class="text_boxes" style="width:118px" value="<?=$row[csf('po_number')]; ?>" readonly />
                                    <input type="hidden" id="ponoid_<?=$i; ?>" name="ponoid_<?=$i; ?>" class="text_boxes" style="width:85px" value="<?=$row[csf('id')]; ?>" readonly />
                                </td>
                                <td>
                                    <input type="hidden" id="cbocountry_<? echo $i;?>" name="cbocountry_<? echo $i;?>" style="width:75px" value="<? echo $country_string; ?>" readonly />
                                    <input type="text" id="cbocountryname_<? echo $i;?>" name="cbocountryname_<? echo $i;?>" onClick="open_country_popup('<? echo $i.'_2'; ?>',0)" class="text_boxes" style="width:98px; background-color:<? echo $bgc; ?>" value="<? echo $country_string_name; ?>" readonly title="<? echo $title; ?>" disabled />
                                </td>
                                <td><? echo create_drop_down( "cbogmtsitem_".$i, 130, $garments_item,"", 0, "",$row[csf('item_number_id')], "",1); ?></td>
                                <td>
                                    <input type="text" id="pocolor_<? echo $i;?>"  name="pocolor_<? echo $i;?>" class="text_boxes" style="width:88px" value="<? echo $color_library[$row[csf('color_number_id')]]; ?>" readonly />
                                    <input type="hidden" id="pocolorid_<? echo $i;?>"  name="pocolorid_<? echo $i;?>" class="text_boxes" style="width:55px" value="<? echo $row[csf('color_number_id')]; ?>" readonly/>
                                </td>
                                <td>
                                    <input type="text" id="gmtssizes_<? echo $i;?>"  name="gmtssizes_<? echo $i;?>" class="text_boxes" style="width:88px" value="<? echo $size_library[$row[csf('size_number_id')]]; ?>" readonly>
                                    <input type="hidden" id="gmtssizesid_<? echo $i;?>"  name="gmtssizesid_<? echo $i;?>" class="text_boxes" style="width:50px" value="<? echo $row[csf('size_number_id')]; ?>" readonly />
                                </td>
                                <td>
                                	<?
									if($copy_quotation==1 && $cost_control_source==4 && ($data[4]*1)==0 && $embupdateid!="")//issue id ISD-21-03976
									{
										$exqcqty=explode("_",$colorWiseDataArr[$row[csf('color_number_id')]]['copyConsdata']);
										//echo $row[csf('color_number_id')];
										$data[4]=$exqcqty[0]; //Tot cons
										$data[5]=$exqcqty[1]; //rate
										$data[6]=$exqcqty[2]; //amount
									}
									if($cost_control_source==3 && ($data[4]*1)==0 && $embupdateid!="")//issue id ISD-21-20681 Color Wise Cons Copy
									{
										$exqcqty=explode("_",$colorWiseDataArr[$row[csf('color_number_id')]]['copyConsdata']);
										//echo $row[csf('color_number_id')];
										$data[4]=$exqcqty[0]; //Tot cons
										$data[5]=$exqcqty[1]; //rate
										$data[6]=$exqcqty[2]; //amount
									}
									else if($copy_quotation==1 && $cost_control_source==4 && ($data[4]*1)==0 && $embupdateid=="" && $qcdata!="")
									{
										$exqcqty=explode("__",$qcdata);
										$data[4]=$exqcqty[0]; //Tot cons
										$data[5]=$exqcqty[3]; //rate
										$data[6]=$exqcqty[4]; //amount
									}
									?>
                                    <input type="text" id="requirement_<?=$i; ?>" onChange="claculate_amount(<?=$i; ?>);copy_value(this.value,'requirement_',<?=$i; ?>);set_sum_value('requirement_sum', 'requirement_');" name="requirement_<?=$i; ?>" class="text_boxes_numeric" style="width:53px" value="<? if ($data[4]==""){ echo $price_quatation_requirment[$row[csf('size_number_id')]];} else { echo $data[4]; } ?>" <?  if($cons_fld==1) echo "disabled "; if($disabled==1){ echo "disabled";} else{ echo "";} ?> />
                                </td>
                                <td><input type="text" id="rate_<?=$i; ?>" name="rate_<?=$i; ?>" onChange="claculate_amount(<?=$i; ?>);copy_value(this.value,'rate_',<?=$i; ?>);" onBlur="set_sum_value( 'rate_sum', 'rate_');" class="text_boxes_numeric" style="width:48px"  value="<?=$data[5]; ?>" <? if($cons_fld==1) echo "disabled "; if($disabled==1){ echo "disabled";} else{ echo "";} ?>/></td>
                                <td><input type="text" id="amount_<?=$i; ?>" name="amount_<?=$i; ?>" class="text_boxes_numeric" style="width:78px" value="<?=$data[6]; ?>" readonly />
                                </td>
                                <td id="add_<?=$i; ?>">
                                    <input type="hidden" id="pcsgmts_<?=$i; ?>" name="pcsgmts_<?=$i;?>" onBlur="set_sum_value('pcs_sum', 'pcs_');" class="text_boxes_numeric" style="width:55px" value="<?=$pcsgmts; ?>">
                                    <input type="hidden" id="itempcsgmts_<?=$i; ?>" name="itempcsgmts_<?=$i; ?>" onBlur="set_sum_value('pcs_sum', 'pcs_');" class="text_boxes_numeric" style="width:55px"  value="<?=$itemqty_array[$row[csf('item_number_id')]]; ?>">
                                    <input type="hidden" id="colorsizetableid_<?=$i; ?>" name="colorsizetableid_<?=$i; ?>" class="text_boxes" style="width:55px" value="<?=$row[csf('color_size_table_id')]; ?>" readonly/>
                                    <input type="button" id="decreaserow_<?=$i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_delete_down_tr(<?=$i; ?>,'tbl_consmption_cost');" disabled/>
                                    <input type="hidden" id="approved_<?=$i; ?>" name="approved_<?=$i; ?>" class="text_boxes_numeric" style="width:55px" value="<?=$disabled; ?>">
                                </td>
							</tr>
							<?
						}
                    }
                    ?>
                </tbody>
            </table>
            <table width="930" cellspacing="0" class="rpt_table" border="0" rules="all">
                <tfoot>
                    <tr>
                    	<th width="30">&nbsp;</th>
                        <th width="130">&nbsp;</th>
                        <th width="110">&nbsp;</th>
                        <th width="130">&nbsp;</th>
                        <th width="100">&nbsp;</th>
                        <th width="100">SUM:</th>
                        <th width="65"><input type="text" id="requirement_sum"  name="requirement_sum" class="text_boxes_numeric" style="width:53px" readonly></th>
                        <th width="60"><input type="text" id="rate_sum"    name="rate_sum" class="text_boxes_numeric" style="width:48px" readonly></th>
                        <th width="90">
                            <input type="text" id="amount_sum"    name="amount_sum" class="text_boxes_numeric" style="width:78px" readonly>
                            <input type="hidden" id="plancutqty_sum"    name="plancutqty_sum" class="text_boxes_numeric" style="width:70px" readonly>
                        </th>
                        <th>&nbsp;</th>
                    </tr>
                    <tr>
                    	<th width="30">&nbsp;</th>
                        <th width="130">&nbsp;</th>
                        <th width="110">&nbsp;</th>
                        <th width="130">&nbsp;</th>
                        <th width="100">&nbsp;</th>
                        <th width="100">AVG:</th>
                        <th width="65"><input type="text" id="calculated_cons" name="calculated_cons" class="text_boxes_numeric" style="width:53px" value="<? echo $calculated_conss;?>" readonly></th>
                        <th width="60"><input type="text" id="calculated_rate"   name="calculated_rate" class="text_boxes_numeric" style="width:48px" readonly></th>
                        <th width="90">
                            <input type="text" id="calculated_amount" name="calculated_amount" class="text_boxes_numeric" style="width:78px" readonly>
                            <input type="hidden" id="calculated_plancutqty"    name="calculated_plancutqty" class="text_boxes_numeric" style="width:70px" readonly>
                        </th>
                        <th>&nbsp;</th>
                    </tr>
                </tfoot>
            </table>
			<script>
				set_sum_value( 'requirement_sum', 'requirement_');
				set_sum_value( 'rate_sum', 'rate_');
				set_sum_value( 'amount_sum', 'amount_');
            </script>
        </form>
        </fieldset>
    </div>
    <div align="center" style="width:100%;" >
        <fieldset>
            <table width="910" cellspacing="0" class="" border="0" rules="all">
                 <tr>
                    <td align="center" width="100%" class="button_container"> <input type="button" class="formbutton" value="Close" onClick="js_set_value();"/> </td>
                </tr>
            </table>
        </fieldset>
    </div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
    exit();
}

function create_consbreak_down_emb($job_no,$cons_value,$rate,$amount,$country="")
{
	$cbo_costing_per=return_field_value("costing_per", "wo_pre_cost_mst", "job_no=$job_no");
	$size_library_arr=return_library_array( "select id,size_name from lib_size", "id", "size_name"  );

	$item_ratio_arr=array();
	$gmts_item_sql=sql_select("select gmts_item_id, set_item_ratio from  wo_po_details_mas_set_details  where job_no=$job_no");
	foreach($gmts_item_sql as $gmts_item_row){
		$item_ratio_arr[$gmts_item_row[csf('gmts_item_id')]]=$gmts_item_row[csf('set_item_ratio')];
	}
	$country_cond ="";

	$data_array=sql_select("select a.gmts_item_id, a.total_set_qnty, b.id, b.po_number, c.item_number_id, c.color_number_id, c.size_number_id, min(c.id) as color_size_table_id, min(color_order) as color_order, min(size_order) as size_order, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id  and b.job_no_mst=$job_no $country_cond and a.status_active=1 and b.status_active=1 and c.status_active=1 group by a.gmts_item_id,a.total_set_qnty,b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id order by b.id, c.item_number_id, color_order, size_order");

	if ( count($data_array)>0)
	{
		$cons_breck_down="";
		if($cbo_costing_per==1) $pcs_value=1*12;
		if($cbo_costing_per==2) $pcs_value=1*1;
		if($cbo_costing_per==3) $pcs_value=2*12;
		if($cbo_costing_per==4) $pcs_value=3*12;
		if($cbo_costing_per==5) $pcs_value=4*12;
		$oth=0;
		$totitem=0;$cons=0;$amount=0;$pcs=0;
		foreach( $data_array as $row )
		{
			$totitem=count($item_ratio_arr);
			$cons=def_number_format($cons_value/$totitem,5,"");
			$amount=def_number_format($cons*$rate,5,"");
			$pcs=$pcs_value*$item_ratio_arr[$row[csf('item_number_id')]];

			if($cons_breck_down=="")
			{
				$cons_breck_down.=$row[csf('id')].'_'.$row[csf('item_number_id')].'_'.$row[csf('color_number_id')].'_'.$row[csf('size_number_id')].'_'.$cons.'_'.$rate.'_'.$amount.'_'.$row[csf('color_size_table_id')].'_0';
			}
			else
			{
				$cons_breck_down.="__".$row[csf('id')].'_'.$row[csf('item_number_id')].'_'.$row[csf('color_number_id')].'_'.$row[csf('size_number_id')].'_'.$cons.'_'.$rate.'_'.$amount.'_'.$row[csf('color_size_table_id')].'_0';
			}
		}
		return $cons_breck_down;
		//echo '10**'.$cons_breck_down; die;
	}
}

if ($action=="save_update_delet_embellishment_cost_dtls") 
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$sql=sql_select("select approval_need from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
	$app_nessity=2;
	foreach($sql as $row){
		$app_nessity=$row[csf('approval_need')];
	}

	$sql=sql_select("select approved from wo_price_quotation  where id=$txt_quotation_id");
	$quatation_approved=2;
	foreach($sql as $row){
		$quatation_approved=$row[csf('approved')];
	}

	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	//echo "10**",$is_copy_quatation."**". $app_nessity."**".$quatation_approved;
	//die;
	if($is_copy_quatation==1 && $app_nessity==1){
		if($quatation_approved==2 || $quatation_approved==0){
			echo "quataNotApp**".str_replace("'","",$txt_job_no);
			 disconnect($con);die;
		}
	}
	$component_approved=return_field_value("current_approval_status", "co_com_pre_costing_approval", "job_no=$update_id and cost_component_id=3");
	if($component_approved==3){
		$component_approved=1;
	}
	
	$approved=0; $ready_to_approve=0;
	$sql=sql_select("select approved, ready_to_approved from wo_pre_cost_mst where job_no=$update_id and status_active=1 and is_deleted=0");
	foreach($sql as $row){
		//if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
		$approved=$row[csf('approved')];
		$ready_to_approve=$row[csf('ready_to_approved')];
	}
	if($approved==1 || $component_approved==1){
		echo "approved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($approved==3){
		echo "papproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($ready_to_approve==1){
		echo "readyapproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($operation==0)
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		
		if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0";  disconnect($con);die;}
		$add_comma=0;
		$fail1=0;
		$id=return_next_id( "id", "wo_pre_cost_embe_cost_dtls", 1 ) ;

		$id1=return_next_id( "id", "wo_pre_cos_emb_co_avg_con_dtls", 1 ) ;

		$field_array="id, job_id, job_no, quotdtlsid, emb_name, emb_type, body_part_id, country, nominated_supp_multi, cons_dzn_gmts, rate, amount, budget_on, inserted_by, insert_date, status_active, is_deleted";
		$field_array1="id, job_id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id, item_number_id, color_number_id, size_number_id, requirment, rate, amount, color_size_table_id, country_id";
		$field_supp_arr="id, job_id, job_no, emb_id, supplier_id,is_company, inserted_by, insert_date, status_active, is_deleted";
		$idembSupp=return_next_id( "id", "wo_pre_cost_emb_supplier", 1);
		for ($i=1;$i<=$total_row;$i++)
		{
			$cboembname="cboembname_".$i;
			$cboembtype="cboembtype_".$i;
			$cboembbodypart="cboembbodypart_".$i;
			$countryid="country_".$i;
			$cboembsupplierid="cboembsupplierid_".$i;
			$txtembconsdzngmts="txtembconsdzngmts_".$i;
			$txtembrate="txtembrate_".$i;
			$txtembamount="txtembamount_".$i;
			$cboembstatus="cboembstatus_".$i;
			$embupdateid="embupdateid_".$i;
			$consbreckdownemb="consbreckdownemb_".$i;
			$empbudgeton="empbudgeton_".$i;
			$quotdtlsidemb="quotdtlsidemb_".$i;
			//if(str_replace("'",'',$$cboembsupplierid) == '') $$cboembsupplierid = 0;

			if ($i!=1) $data_array .=",";
			$data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$quotdtlsidemb.",".$$cboembname.",".$$cboembtype.",".$$cboembbodypart.",".$$countryid.",".$$cboembsupplierid.",".$$txtembconsdzngmts.",".$$txtembrate.",".$$txtembamount.",".$$empbudgeton.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cboembstatus.",0)";
			//multi supplier
				/*$cbonominasupplier=explode(",",str_replace("'",'',$$cboembsupplierid));
				$uid=str_replace("'",'',$$embupdateid);
				$q=1;		
				foreach($cbonominasupplier as $sid)
				{
					$rID_de1=execute_query( "delete from wo_pre_cost_emb_supplier where emb_id ='".$uid."'",0);
					if($sid>0)
					{
						if ($q!=1) $dataSuppArr .=",";
						$dataSuppArr.="(".$idembSupp.",".$hidd_job_id.",".$update_id.",'".$id."','".$sid."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
						$idembSupp++; $q++;
					}
				}*/
				//Nominated Supp $idsup
			$cbonominasupplier=str_replace("'",'',$$cboembsupplierid);
			if(trim($cbonominasupplier)!="")
			{
				$cbonominasupplierarr=explode("_",$cbonominasupplier);
				foreach($cbonominasupplierarr as $key=>$supplierdata)
				{
					$is_compleate=($key == 0 ? 2 : 1);
					$supplierdataarr=explode(",",$supplierdata);
					foreach($supplierdataarr as $sid){
						if($sid>0)
						{
							/*if ($q!=1) $dataSuppArr .=",";
							$dataSuppArr.="(".$idsup.",".$hidd_job_id.",".$update_id.",'".$id."','".$sid."',$is_compleate,".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
							$idsup++; $q++;*/


							$dataSuppArr ="";
							$dataSuppArr="INSERT INTO wo_pre_cost_emb_supplier (".$field_supp_arr.") VALUES(".$idembSupp.",".$hidd_job_id.",".$update_id.",'".$id."','".$sid."',$is_compleate,".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
							$idembSupp++;
							$rIDSupp=execute_query($dataSuppArr);
							//echo "10**=$flag-";oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die;
							if ($rIDSupp==1) { $flag=1; }
							else { echo "10**EmbSuppInsert-".$dataSuppArr; $flag=0; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
						}
					}
				}
			}
			
			//	CONS break down===============================================================================================

			if(str_replace("'",'',$$consbreckdownemb) != '')
			{
				$consbreckdown= $$consbreckdownemb;
			}
			else
			{
				$consbreckdown="'".create_consbreak_down_emb($update_id,str_replace("'",'',$$txtembconsdzngmts),str_replace("'",'',$$txtembrate),str_replace("'",'',$$txtembamount))."'";
			}

			if(str_replace("'",'',$consbreckdown) !='')
			{
				$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
				$counter=0;
				for($c=0;$c < count($consbreckdown_array);$c++)
				{
					$counter++;
					$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
					//"id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id,item_number_id, color_number_id, size_number_id, requirment,rate,amount,color_size_table_id"
					//ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid;
					if ($add_comma!=0) $data_array1 .=",";
					$data_array1 .="(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."')";

					$id1=$id1+1;
					$add_comma++;
					if ($data_array1!="" && $counter==100)
					{
						$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
						$counter=0;
						$data_array1="";
						$add_comma=0;
						if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
					}
				}
				if ($data_array1!="" && $counter!=100)
				{
					$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
					$counter=0;
					$data_array1="";
					$add_comma=0;
					if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
				}
			}
			//CONS break down end===============================================================================================
			$id=$id+1;
		}
		//echo "INSERT INTO wo_pre_cost_embe_cost_dtls (".$field_array.") VALUES $data_array"; die;
		$rID=sql_insert("wo_pre_cost_embe_cost_dtls",$field_array,$data_array,0);
		//=======================supplier=================
		if ($dataSuppArr!="")
		{
			//echo "10**delete from wo_pre_cost_fabric_supplier where job_id =".$hidd_job_id.""; die;
			//$rID_de1=execute_query( "delete from wo_pre_cost_emb_supplier where job_id =".$hidd_job_id."",0);
		//	$rID_in2=sql_insert("wo_pre_cost_emb_supplier",$field_supp_arr,$dataSuppArr,1);
			//echo sql_insert("wo_pre_cost_emb_supplier",$field_supp_arr,$dataSuppArr,1);
			/*if($flag==1) 
			{
				if($rID_in2) $flag=1;else $flag=0;
			}*/
			if( $rID_in2 && $fail1==0) { $rID_in2=1;  } else { $rID_in2=0; $fail1=1; }
		}
		
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, emb_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtamountemb_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="emb_amount";
			$data_array2 ="".$txtamountemb_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		check_table_status( $_SESSION['menu_id'],0);
		//=======================sum End =================
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "0**".$new_job_no[0]."**".$rID;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "0**".$new_job_no[0]."**".$rID;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		disconnect($con);
		die;
	}
	else if($operation==1)
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		//=====Sourcing====================
		$avg_cons_sql="select b.id,b.pre_cost_emb_cost_dtls_id as dtlid,b.po_break_down_id as poid,b.color_size_table_id as sizemstId,b.sourcing_rate,b.sourcing_amount from wo_pre_cost_mst a,wo_pre_cos_emb_co_avg_con_dtls b,wo_pre_cost_embe_cost_dtls c where  a.job_id=b.job_id and c.id=b.pre_cost_emb_cost_dtls_id and a.job_id=c.job_id  and b.sourcing_rate>0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and c.emb_name!=3 and  a.approved in(0,2)  and b.sourcing_rate>0  and b.job_no='".str_replace("'", "", $update_id)."'";
		$avg_cons_result=sql_select($avg_cons_sql);
			foreach($avg_cons_result as $row)
			{
			 $SourcingEmbArr[$row[csf('poid')]][$row[csf('dtlid')]][$row[csf('sizemstId')]]['rate']=$row[csf('sourcing_rate')];
			 $SourcingEmbArr[$row[csf('poid')]][$row[csf('dtlid')]][$row[csf('sizemstId')]]['amount']=$row[csf('sourcing_amount')];
			}
			//=======End================
		
		//if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**1"; die;}
		$field_array_up="job_no*emb_name*emb_type*body_part_id*country*is_apply_last_update*nominated_supp_multi*cons_dzn_gmts*rate*amount*budget_on*is_synchronized*updated_by*update_date*status_active*is_deleted";
		$field_array="id, job_id, job_no, quotdtlsid, emb_name, emb_type, body_part_id, country, nominated_supp_multi, cons_dzn_gmts, rate, amount, budget_on, inserted_by, insert_date, status_active, is_deleted";
		$field_array1="id, job_id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id, item_number_id, color_number_id, size_number_id, requirment, rate, amount, color_size_table_id, country_id";
		$field_supp_arr="id, job_id, job_no, emb_id, supplier_id,is_company, inserted_by, insert_date, status_active, is_deleted";

		$add_co=0; $add_comma=0; $fail1=0;$isconspopupupdateId_chk=0;
		$id=return_next_id( "id", "wo_pre_cost_embe_cost_dtls", 1) ;
		$id1=return_next_id( "id", "wo_pre_cos_emb_co_avg_con_dtls", 1) ;
		$idembSupp=return_next_id( "id", "wo_pre_cost_emb_supplier", 1);
		for ($i=1;$i<=$total_row;$i++)
		{
			$cboembname="cboembname_".$i;
			$cboembtype="cboembtype_".$i;
			$cboembbodypart="cboembbodypart_".$i;
			$countryid="country_".$i;
			$lastappidchk="lastappidchk_".$i;
			$cboembsupplierid="cboembsupplierid_".$i;
			$txtembconsdzngmts="txtembconsdzngmts_".$i;
			$txtembrate="txtembrate_".$i;
			$txtembamount="txtembamount_".$i;
			$cboembstatus="cboembstatus_".$i;
			$embupdateid="embupdateid_".$i;
			$consbreckdownemb="consbreckdownemb_".$i;
			$empbudgeton="empbudgeton_".$i;
			$quotdtlsidemb="quotdtlsidemb_".$i;
			$txtsourcingrate="txtsourcingrate_".$i;
			$isconspopupupdate="isconspopupupdate_".$i;
			$sourcingrate=str_replace("'",'',$$txtsourcingrate);//For Sourcing Pre cost v2
			$isconspopupupdateId=str_replace("'",'',$$isconspopupupdate);//For Sourcing Pre cost v2
			$is_synchronized=1;
			if($sourcingrate>0 && $isconspopupupdateId==1)
			{
				$isconspopupupdateId_chk=$isconspopupupdateId;
				$is_synchronized=2;	
			}
			
			//if(str_replace("'",'',$$cboembsupplierid) == '') $$cboembsupplierid = 0;
			if(str_replace("'",'',$$embupdateid)!="")
			{
				$id_arr[]=str_replace("'",'',$$embupdateid);

				$data_array_up[str_replace("'",'',$$embupdateid)] =explode("*",("".$update_id."*".$$cboembname."*".$$cboembtype."*".$$cboembbodypart."*".$$countryid."*".$$lastappidchk."*".$$cboembsupplierid."*".$$txtembconsdzngmts."*".$$txtembrate."*".$$txtembamount."*".$$empbudgeton."*".$is_synchronized."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*".$$cboembstatus."*0"));

				//	CONS break down===============================================================================================
				if(str_replace("'",'',$$consbreckdownemb) !='')
				{
					$consbreckdown= $$consbreckdownemb;
				}
				else
				{
					//$consbreckdown="'".create_consbreak_down_emb( $update_id,str_replace("'",'', $$txtembconsdzngmts), str_replace( "'",'',$$txtembrate), str_replace("'",'',$$txtembamount))."'";
					$consbreckdown="";
				}
				if(str_replace("'",'',$consbreckdown) !='')
				{
					//echo "delete from wo_pre_cos_emb_co_avg_con_dtls where  pre_cost_emb_cost_dtls_id =".$$embupdateid."";
					$rID_de1=execute_query( "delete from wo_pre_cos_emb_co_avg_con_dtls where  pre_cost_emb_cost_dtls_id =".$$embupdateid."",0);
					$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
					$counter=0;
					for($c=0;$c < count($consbreckdown_array);$c++)
					{
						$counter++;
						$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
						//"id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id,item_number_id, color_number_id, size_number_id, requirment,rate,amount,color_size_table_id"
						//ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid;
						if ($add_comma!=0) $data_array1 .=",";
						$data_array1 .="(".$id1.",".$hidd_job_id.",".str_replace("'",'',$$embupdateid).",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."')";

						$id1=$id1+1;
						$add_comma++;
						if ($data_array1!="" && $counter==100)
						{
							//echo "insert into wo_pre_cos_emb_co_avg_con_dtls (".$field_array1.") values ".$data_array1;
							$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
							$counter=0;
							$data_array1="";
							$add_comma=0;
							if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
						}
					}

					if ($data_array1!="" && $counter!=100)
					{
						//echo "insert into wo_pre_cos_emb_co_avg_con_dtls (".$field_array1.") values ".$data_array1;
						$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
						$counter=0;
						$data_array1="";
						$add_comma=0;
						if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
					}
				}
				//CONS break down end===============================================================================================
			}
			if(str_replace("'",'',$$embupdateid)=="")
			{
				if ($add_co!=0) $data_array .=",";
				$data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$quotdtlsidemb.",".$$cboembname.",".$$cboembtype.",".$$cboembbodypart.",".$$countryid.",".$$cboembsupplierid.",".$$txtembconsdzngmts.",".$$txtembrate.",".$$txtembamount.",".$$empbudgeton.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cboembstatus.",0)";
				//	CONS break down===============================================================================================
				if(str_replace("'",'',$$consbreckdownemb) !='')
				{
					$consbreckdown= $$consbreckdownemb;
				}
				else
				{
					$consbreckdown="'".create_consbreak_down_emb($update_id,str_replace("'",'',$$txtembconsdzngmts),str_replace("'",'',$$txtembrate),str_replace("'",'',$$txtembamount))."'";
				}
				if(str_replace("'",'',$consbreckdown) !='')
				{
					$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
					//$counter=0;
					for($c=0;$c < count($consbreckdown_array);$c++)
					{
						$counter++;
						$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
						//"id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id,item_number_id, color_number_id, size_number_id, requirment,rate,amount,color_size_table_id"
						//ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid;
						if ($add_comma!=0) $data_array1 .=",";
						$data_array1 .="(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."')";

						$id1=$id1+1;
						$add_comma++;
						if ($data_array1!="" && $counter==100)
						{
							$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
							$counter=0;
							$data_array1="";
							$add_comma=0;
							if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
						}
					}
					if ($data_array1!="" && $counter!=100)
					{
						$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
						$counter=0;
						$data_array1="";
						$add_comma=0;
						if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
					}
				}
				//CONS break down end===============================================================================================
				$id=$id+1;
				$add_co++;
			}
			
			/*$cbonominasupplier=explode(",",str_replace("'",'',$$cboembsupplierid));
				$upid=str_replace("'",'',$$embupdateid);
				$q=1;		
				foreach($cbonominasupplier as $sid)
				{
					$rID_de1=execute_query( "delete from wo_pre_cost_emb_supplier where emb_id ='".$upid."'",0);
					if($sid>0)
					{
						if ($q!=1) $dataSuppArr .=",";
						$dataSuppArr.="(".$idembSupp.",".$hidd_job_id.",".$update_id.",'".$upid."','".$sid."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
						$idembSupp++; $q++;
					}
				}*/

					//Nominated Supp $idsup
			$cbonominasupplier=str_replace("'",'',$$cboembsupplierid);
			if(trim($cbonominasupplier)!="")
			{
				$q=1;
				$cbonominasupplierarr=explode("_",$cbonominasupplier);
				foreach($cbonominasupplierarr as $key=>$supplierdata)
				{
					$is_compleate=($key == 0 ? 2 : 1);
					$supplierdataarr=explode(",",$supplierdata);
					foreach($supplierdataarr as $sid){
						$upid=str_replace("'",'',$$embupdateid);
						if($upid) $upid=$upid;else $upid=$id; 
				
							if ($q!=1) $dataSuppArr .=",";
							$dataSuppArr.="(".$idembSupp.",".$hidd_job_id.",".$update_id.",'".$upid."','".$sid."',$is_compleate,".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
							$idembSupp++; $q++;
	
					}
				}
			}

		}
		//echo "10**".bulk_update_sql_statement( "wo_pre_cost_embe_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ); die;
		$rID=execute_query(bulk_update_sql_statement( "wo_pre_cost_embe_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
		if($data_array !="")
		{
			$rID1=sql_insert("wo_pre_cost_embe_cost_dtls",$field_array,$data_array,0);
		}
			//Supplier
			if ($dataSuppArr!="")
				{
					//echo "10**delete from wo_pre_cost_fabric_supplier where job_id =".$hidd_job_id.""; die;
					$rID_de1=execute_query( "delete from wo_pre_cost_emb_supplier where job_id =".$hidd_job_id."",0);
					$rID_in2=sql_insert("wo_pre_cost_emb_supplier",$field_supp_arr,$dataSuppArr,1);
					//echo sql_insert("wo_pre_cost_emb_supplier",$field_supp_arr,$dataSuppArr,1);
					//if( $rID_in2 && $fail1==0) { $rID_in2=1;  } else { $rID_in2=0; $fail1=1; }
				}
		 //=======================sum=================
		 
		 //for Sourcing 
		if($isconspopupupdateId_chk==1) //For Sourcing page 
		{
			execute_query( "update  wo_pre_cost_mst set sourcing_ready_to_approved=2  where  job_no =".$update_id."   ",1);//and sourcing_approved !=1
		}
		//====Sourcing post cost Sheet=====
		if(count($SourcingEmbArr)>0) //Sourcing
		{
			foreach($SourcingEmbArr as $poId=>$PoData)
				{
					foreach($PoData as $EmbId=>$trimData)
					{
						foreach($trimData as $sizeMstid=>$val)
						{
							$souring_amount=$val['amount'];
							$souring_rate=$val['rate'];
							$up_avg_rID=execute_query( "update  wo_pre_cos_emb_co_avg_con_dtls set sourcing_rate='".$souring_rate."',sourcing_amount='".$souring_amount."',sourcing_updated_by=".$_SESSION['logic_erp']['user_id'].",sourcing_update_date='".$pc_date_time."' where po_break_down_id =".$poId." and color_size_table_id =".$sizeMstid." and pre_cost_emb_cost_dtls_id =".$EmbId." and status_active=1  ",0);
							if($flag==1) 
							{
							if($up_avg_rID) $flag=1; else $flag=0;
							}
						}
					}
			}
		}
		//===============End Sourcing post cost Sheet=====
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, emb_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtamountemb_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="emb_amount";
			$data_array2 ="".$txtamountemb_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		//=======================sum End =================
        check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{

			if($rID ){
				mysql_query("COMMIT");
				echo "1**".$new_job_no[0]."**".$rID;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "1**".$new_job_no[0]."**".$rID;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		disconnect($con);
		die;
	}
}
//*************************************************Embellishment Cost End ****************************************

//*************************************************Wash Cost Start ***********************************************

if ($action=="show_wash_cost_listview")
{
	$data=explode("**",$data);
	//$data=explode("_",$data);
	$header_td="";$permission=$data[6];
	$costing_per=return_field_value("costing_per", "wo_pre_cost_mst", "job_no ='$data[0]'");
	if($costing_per==1) $header_td="Cons/ 1 Dzn Gmts";
	else if($costing_per==2) $header_td="Cons/ 1 Pcs Gmts";
	else if($costing_per==3) $header_td="Cons/ 2 Dzn Gmts";
	else if($costing_per==4) $header_td="Cons/ 3 Dzn Gmts";
	else if($costing_per==5) $header_td="Cons/ 4 Dzn Gmts";

	$conversion_from_chart=return_field_value("conversion_from_chart", "variable_order_tracking", "company_name='$data[3]'  and variable_list=21 and status_active=1 and is_deleted=0");
	$supplier_arr=return_library_array( "select a.id, a.supplier_name from lib_supplier a,lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(23) and a.is_deleted=0 and a.status_active=1 group by a.id, a.supplier_name order by a.supplier_name", "id", "supplier_name");
	if($conversion_from_chart=="")
	{
		$conversion_from_chart=2;
	}
	$component_approved=0;
	$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=4 and job_no='$data[0]'");
	foreach($sql as $row){
		if($row[csf('approved')]==1 || $row[csf('approved')]==3) { $component_approved=1; $approved_message="<marquee width='500'><p style='color:#f00; text-align:center;'> Approved</p></marquee>";}
	}
	
	$variArr=array();
	$sqlvari=sql_select("select embellishment_id,embellishment_budget_id from variable_order_tracking where company_name='$data[3]' and variable_list=56 and embellishment_id=3 and status_active=1 and is_deleted=0");
	foreach($sqlvari as $vari_row)
	{
		$variArr[$vari_row[csf('embellishment_id')]]=$vari_row[csf('embellishment_budget_id')]?$vari_row[csf('embellishment_budget_id')]:2;
	}
	?>
    <h3 style="width:910px;" align="left" class="accordion_h" >+Wash Cost <? echo $approved_message; ?></h3>
	<div id="content_embellishment_cost">
        <fieldset style="width:910px">
            <form id="wash_7" autocomplete="off">
            <table width="910" cellspacing="0" class="rpt_table" border="0" id="tbl_wash_cost" rules="all">
                <thead>
                    <tr>
                    	<th width="120" style="color:#2A3FFF">Name</th>
                        <th width="100">Type</th>
                        <th width="90">Country</th>
                        <th width="100">Supplier</th>
                        <th width="70" style="color:#2A3FFF"><?=$header_td; ?></th>
                        <th width="60" style="color:#2A3FFF">Rate</th>
                        <th width="90">Amount</th>
                        <th width="80">Status</th>
                        <th>&nbsp;</th>
                    </tr>
                </thead>
                <tbody id="emblish_wash_tbl_dtls_for">
					<?
                    $save_update=1;
                    $approved=return_field_value("approved", "wo_pre_cost_mst", "job_no='$data[0]'");
					if($approved==3) $approved=1;
					$country_library=return_library_array("select id,country_name from lib_country","id","country_name");
					$company_arr=return_library_array( "select id, company_name from lib_company",'id','company_name');
//echo  $approved.'='.$component_approved.'=A';
                    if($approved==1 || $component_approved==1) $disabled=1; else $disabled=0;
                    $data_array=sql_select("select id, quotdtlsid as pri_id, job_no, emb_name, emb_type, country, nominated_supp_multi, cons_dzn_gmts, rate,sourcing_rate, amount, is_apply_last_update, status_active, budget_on from wo_pre_cost_embe_cost_dtls where emb_name=3 and job_no='$data[0]' and is_deleted=0 order by id"); //and status_active=1 ISD-22-07146

					$is_booking_arr=array();
					if($disabled!=1)
					{
						$data_arr=sql_select("select pre_cost_fabric_cost_dtls_id from wo_booking_dtls where job_no ='$data[0]' and booking_type='6' and status_active=1 and is_deleted=0 group by pre_cost_fabric_cost_dtls_id");
						foreach ($data_arr as $row)
						{
							$is_booking_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]]=$row[csf('pre_cost_fabric_cost_dtls_id')];
						}
						unset($data_arr);
					}

                    if(count($data_array)<1 && $data[2]==1 && $data[5]==2)//Price Quotation
                    {
						$data_array=sql_select("select id as pri_id, quotation_id, emb_name, emb_type, cons_dzn_gmts, rate, amount, status_active from wo_pri_quo_embe_cost_dtls where emb_name=3 and quotation_id='$data[1]' and status_active=1 and is_deleted=0 order by id");// quotation_id='$data'
						$save_update=0;
                    }
					if ($data[2]==1 && $data[5]==4 )//Quick Costing [WVN]
					{
						$qc_no=$data[1];//return_field_value("qc_no", "wo_po_details_master a, qc_mst b", "job_no='$data[0]' and a.inquiry_id=b.inquery_id and b.is_deleted=0 and b.status_active=1");
						$dataQc=sql_select("select id as pri_id, mst_id as quotation_id, 3 as emb_name, particular_type_id as emb_type, consumption, ex_percent, tot_cons as cons_dzn_gmts, rate, value as amount, status_active from qc_cons_rate_dtls where mst_id='$qc_no' and type=3 and tot_cons>0 and status_active=1 and is_deleted=0 order by id");
						//echo "select id as pri_id, mst_id as quotation_id, 3 as emb_name, particular_type_id as emb_type, consumption, ex_percent, tot_cons as cons_dzn_gmts, rate, value as amount, status_active from qc_cons_rate_dtls where mst_id='$qc_no' and type=3 and tot_cons>0 and status_active=1 and is_deleted=0 order by id";
						$qcDataArr=array();
						foreach($dataQc as $erow)
						{
							$qcDataArr[$erow[csf('pri_id')]]=$erow[csf('cons_dzn_gmts')].'__'.$erow[csf('ex_percent')].'__'.$erow[csf('consumption')].'__'.$erow[csf('rate')].'__'.$erow[csf('amount')];
						}
						if (count($data_array) < 1)//Quick Costing [WVN]
						{
							$data_array=$dataQc;
							$save_update=0;
						}
					}
                    if( count($data_array)>0)
                    {
						$i=0;
						foreach( $data_array as $row )
						{
							$i++;
							$country_text="";
							$countryarr=explode(",",$row[csf("country")]);
							//print_r($countryarr);
							for($cu=0 ;$cu< count($countryarr); $cu++){
								$country_text.= $country_library[trim($countryarr[$cu])].",";
							}
							$country_text=rtrim($country_text,",");

							if($disabled!=1)
							{
								$booking_id='';
								$booking_id=$is_booking_arr[$row[csf('id')]];
								$txt_dis=""; $dis=0;
								if($booking_id!="") { $dis=1; $txt_dis="disabled"; }
							}
							else $dis=$disabled;
							//echo $booking_id.'='.$dis;
							/*$nominated_supp_str="";
							$exnominated_supp=explode(",",$row[csf("nominated_supp_multi")]);
							foreach($exnominated_supp as $supp)
							{
								if($nominated_supp_str=="") $nominated_supp_str=$supplier_arr[$supp]; else $nominated_supp_str.=','.$supplier_arr[$supp];
							}*/
							$nominated_supp_str="";
						 //echo $trim_variable;
							 $exnominated_supp=explode("_",$row[csf('nominated_supp_multi')]);
							 foreach($exnominated_supp as $key=>$suppdata)
							 {
								if($key==0){
									$suppdataarr=explode(",",$suppdata);
									foreach($suppdataarr as $supp){
										//if($trim_variable==1) { if($nominated_supp_str=="") $nominated_supp_str=$supplier_library[$supp]; else $nominated_supp_str.=','.$supplier_library[$supp]; }
										//else { if($nominated_supp_str=="") $nominated_supp_str=$supplier_lib_with_rate_arr[$row[csf('trim_group')]][$supp]; else $nominated_supp_str.=','.$supplier_lib_with_rate_arr[$row[csf('trim_group')]][$supp]; }
										if($nominated_supp_str=="") $nominated_supp_str=$supplier_arr[$supp]; else $nominated_supp_str.=','.$supplier_arr[$supp];
									}
								}
								else{
									$comdataarr=explode(",",$suppdata);
									foreach($comdataarr as $comid){
										if($nominated_supp_str=="") $nominated_supp_str=$company_arr[$comid]; else $nominated_supp_str.=','.$company_arr[$comid];
									}
								}
	
							 }
							 
							$is_apply_last_update=$row[csf("is_apply_last_update")];
							$is_last_app_msg=""; $changedmsgcolor="";
							if($is_apply_last_update==2)
							{
								$is_last_app_msg="Color Size Changed.";
								$changedmsgcolor="red";
							}
							
							if($row[csf("status_active")]!=1) $statustd="red"; else $statustd="";
							?>
							<tr id="embellishment_<?=$i; ?>" align="center">
                                <td id="cboembnametd_<?=$i; ?>"><?=create_drop_down( "cboembname_".$i, 120, $emblishment_name_array, "",1," -Select Item-", $row[csf("emb_name")], "",1,'' ); ?></td>
                                <td id="embtypetd_<?=$i; ?>"><?=create_drop_down( "cboembtype_".$i, 100, $emblishment_wash_type,"", 1, "-Select-", $row[csf("emb_type")], "check_duplicate_wash(".$i.")",$dis,"" ); ?></td>
                                <td title="<?=$is_last_app_msg; ?>">
                                    <input title="<?=$is_last_app_msg; ?>" type="text" id="countrytext_<?=$i; ?>" name="countrytext_<?=$i; ?>" class="text_boxes" style="width:78px; background-color:<?=$changedmsgcolor; ?>" value="<?=$country_text; ?>" <? if($dis==0){echo "";}else{echo "disabled";} ?> onDblClick="open_country_popup('<?=$i; ?>',0)" placeholder="Browse" readonly/>
                                    <input type="hidden" id="country_<?=$i; ?>" name="country_<?=$i; ?>" class="text_boxes" style="width:75px" value="<?=$row[csf("country")]; ?>" />
                                    <input type="hidden" id="lastappidchk_<?=$i; ?>" name="lastappidchk_<?=$i; ?>" class="text_boxes" style="width:70px" value="<?= $row[csf("is_apply_last_update")]; ?>" />
                            	</td>
                                <td>
                                    <input type="text" name="txtembsupplier_<?=$i; ?>" id="txtembsupplier_<?=$i; ?>" class="text_boxes" style="width:88px;" value="<?=$nominated_supp_str; ?>" <? if($dis==0){echo "";}else{echo "disabled";}?> onDblClick="fncopenpopup_emblsupplier(<?=$i; ?>);" placeholder="Browse" readonly/>
                                    <input type="hidden" name="cboembsupplierid_<?=$i; ?>" id="cboembsupplierid_<?=$i; ?>" class="text_boxes" style="width:40px;" value="<?=$row[csf('nominated_supp_multi')]; ?>" /></td>
                                
                                <td id="txtembconsdzngmtstd_<?=$i; ?>">
                                <input type="text" id="txtembconsdzngmts_<?=$i; ?>" name="txtembconsdzngmts_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="<?=$row[csf("cons_dzn_gmts")]; ?>" onChange="calculate_wash_cost(<?=$i; ?>);" onDblClick="set_session_large_post_data_wash('requires/pre_cost_entry_controller_v2.php?action=consumption_popup_wash', 'Consumption Entry Form', <?=$i; ?>);" placeholder="Browse" qcdata="<?=$qcDataArr[$row[csf('pri_id')]]; ?>" readonly/></td>
                                <td id="txtembratetd_<?=$i; ?>"><input type="text" id="txtembrate_<?=$i; ?>" name="txtembrate_<?=$i; ?>" class="text_boxes_numeric" style="width:48px" value="<?=$row[csf("rate")]; ?>" onChange="calculate_wash_cost(<?=$i; ?>)" <? if($dis==0){echo "";}else{echo "disabled";}?> readonly/>
                                 <input type="hidden" id="txtsourcingrate_<?=$i; ?>" name="txtsourcingrate_<?=$i; ?>"  class="text_boxes_numeric" style="width:40px" value="<?=$row[csf("sourcing_rate")]; ?>"/>
                                </td>
                                <td id="txtembamounttd_<?=$i; ?>"><input type="text" id="txtembamount_<?=$i; ?>" name="txtembamount_<?=$i; ?>" class="text_boxes_numeric" style="width:78px" value="<?=$row[csf("amount")]; ?>" <? if($dis==0){echo "";}else{echo "disabled";}?> readonly/></td>
                                <td bgcolor="<?=$statustd; ?>" id="cboembstatustd_<?=$i; ?>"><?=create_drop_down( "cboembstatus_".$i, 90, $row_status,"", 0, "0", $row[csf("status_active")], "set_sum_value( 'txtamountemb_sum', 'txtembamount_', 'tbl_wash_cost');",$dis,'' );  ?></td>
                                <td id="buttontd_<?=$i; ?>">
                                <input type="hidden" id="isconspopupupdate_<?=$i; ?>" name="isconspopupupdate_<?=$i; ?>" class="text_boxes" style="width:20px" value="0" disabled/>
                                  
                                <input type="button" id="increaseemb_<?=$i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_wash_cost(<?=$i; ?>,<?=$conversion_from_chart; ?>);"  <? if($disabled==0){echo "";}else{echo "disabled";}?>/>
                                <input type="button" id="decreaseemb_<?=$i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<?=$i; ?>,'tbl_wash_cost',this);" <? if($disabled==0){echo "";}else{echo "disabled";}?> />
                                <input type="hidden" id="embupdateid_<?=$i; ?>" name="embupdateid_<?=$i; ?>" class="text_boxes" style="width:20px" value="<?=$row[csf("id")]; ?>" />
                                <input type="hidden" id="quotdtlsidemb_<?=$i; ?>" name="quotdtlsidemb_<?=$i; ?>" class="text_boxes" style="width:20px" value="<?=$row[csf("pri_id")]; ?>"  />
                                <input type="hidden" id="embratelibid_<?=$i; ?>" name="embratelibid_<?=$i; ?>" class="text_boxes" style="width:20px" value="<?=$row[csf("charge_lib_id")]; ?>"  />
                                <input type="hidden" id="consbreckdownwash_<?=$i; ?>" name="consbreckdownwash_<?=$i; ?>" class="text_boxes" style="width:20px" value=""  />
                                <input type="hidden" id="empbudgeton_<?=$i; ?>" name="empbudgeton_<?=$i; ?>" class="text_boxes" style="width:20px" value="<? if($row[csf("budget_on")]){echo  $row[csf("budget_on")];}else{ echo $variArr[3]; } ?>"  />
                                </td>
                            </tr>
                            <?
						}
                    }
                    else
                    {
						$save_update=0; $i=0;
						$i++;
						?>
						<tr id="embellishment_<?=$i; ?>" align="center">
                            <td id="cboembnametd_<?=$i; ?>"><?=create_drop_down( "cboembname_".$i, 120, $emblishment_name_array, "",1,"--Select--", 3, "",1,''); ?></td>
                            <td id="embtypetd_<?=$i; ?>"><?=create_drop_down( "cboembtype_".$i, 100, $emblishment_wash_type,"", 1, "-- Select --", "", "check_duplicate_wash(".$i.");","","" ); ?></td>
                            <td>
                                <input  type="text" id="countrytext_<?=$i; ?>" name="countrytext_<?=$i; ?>" class="text_boxes" style="width:78px" value="" onDblClick="open_country_popup('<?=$i.'_1'; ?>',0)" placeholder="Browse" readonly/>
                                <input type="hidden" id="country_<?=$i; ?>" name="country_<?=$i; ?>" class="text_boxes" style="width:75px" value="" />
                                <input type="hidden" id="lastappidchk_<?=$i; ?>" name="lastappidchk_<?=$i; ?>" class="text_boxes" style="width:70px" value="" />
                            </td>
                             <td id="">
								<input type="text" name="txtembsupplier_<? echo $i;?>" id="txtembsupplier_<? echo $i;?>" class="text_boxes"   style="width:88px;"  value="" onDblClick="fncopenpopup_emblsupplier(<?=$i; ?>);"  placeholder="Browse" />
                                 
                                <input type="hidden" name="cboembsupplierid_<? echo $i;?>" id="cboembsupplierid_<? echo $i;?>" class="text_boxes" style="width:40px;" value="" /></td>
                            <td id="txtembconsdzngmtstd_<?=$i;?>">
                            	<input type="text" id="txtembconsdzngmts_<?=$i; ?>" name="txtembconsdzngmts_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="" onChange="calculate_wash_cost(<?=$i; ?>);" onDblClick="set_session_large_post_data_wash('requires/pre_cost_entry_controller_v2.php?action=consumption_popup_wash', 'Consumption Entry Form',<?=$i; ?>)" placeholder="Browse" qcdata="" readonly />
                            </td>
                            <td id="txtembratetd_<?=$i; ?>">
                            	<input type="text" id="txtembrate_<?=$i; ?>" name="txtembrate_<?=$i; ?>" class="text_boxes_numeric" style="width:48px" value="" onChange="calculate_wash_cost(<?=$i;?>)" readonly />
                                <input type="hidden" id="txtsourcingrate_<?=$i; ?>" name="txtsourcingrate_<?=$i; ?>"  class="text_boxes_numeric" style="width:40px" value=""/>
                            </td>
                            <td id="txtembamounttd_<?=$i;?>"><input type="text" id="txtembamount_<? echo $i; ?>"  name="txtembamount_<? echo $i; ?>" class="text_boxes_numeric" style="width:78px" value="" readonly /></td>
                            <td bgcolor="<?=$statustd; ?>" id="cboembstatustd_<?=$i; ?>"><?=create_drop_down( "cboembstatus_".$i, 90, $row_status,"", 0, "0", $selected, "set_sum_value( 'txtamountemb_sum', 'txtembamount_', 'tbl_wash_cost');","",'' );  ?></td>
                            <td id="buttontd_<?=$i;?>">
                              <input type="hidden" id="isconspopupupdate_<?=$i; ?>" name="isconspopupupdate_<?=$i; ?>" class="text_boxes" style="width:20px" value="0" disabled/>
                                <input type="button" id="increaseemb_<?=$i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_wash_cost(<?=$i; ?>,<?=$conversion_from_chart; ?>);" />
                                <input type="button" id="decreaseemb_<?=$i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<?=$i; ?> ,'tbl_wash_cost',this);" />
                                <input type="hidden" id="embupdateid_<?=$i; ?>" name="embupdateid_<?=$i; ?>"  class="text_boxes" style="width:20px" value=""  />
                                <input type="hidden" id="embratelibid_<?=$i; ?>" name="embratelibid_<?=$i; ?>"  class="text_boxes" style="width:20px"  readonly/>
                                <input type="hidden" id="consbreckdownwash_<?=$i; ?>" name="consbreckdownwash_<?=$i; ?>" class="text_boxes" style="width:20px" value="" />
                                 <input type="hidden" id="quotdtlsidemb_<?=$i; ?>" name="quotdtlsidemb_<?=$i; ?>" class="text_boxes" style="width:20px" value="0"  />
                                <input type="hidden" id="empbudgeton_<?=$i; ?>" name="empbudgeton_<?=$i; ?>"  class="text_boxes" style="width:20px" value="<?=$variArr[3]; ?>"  />
                            </td>
						</tr>
						<?
                    }
                    ?>
                </tbody>
            </table>
            <table width="910" cellspacing="0" class="rpt_table" border="0" rules="all">
                <tfoot>
                    <tr>
                    	<th width="120">&nbsp;</th>
                        <th width="100">&nbsp;</th>
                        <th width="90">&nbsp;</th>
                        <th width="100">&nbsp;</th>
                        <th width="70">&nbsp;</th>
                        <th width="60">Sum :</th>
                        <th width="90"><input type="text" id="txtamountemb_sum" name="txtamountemb_sum" class="text_boxes_numeric" style="width:78px" readonly /></th>
                        <th width="80">&nbsp;</th>
                        <th>&nbsp;</th>
                    </tr>
                </tfoot>
            </table>
            <table width="910" cellspacing="0" class="" border="0">
                <tr>
                    <td align="center" width="100%" class="button_container">
                    <?
                    if ( count($data_array)>0)
                    {
                        echo load_submit_buttons( $permission, "fnc_wash_cost_dtls", $save_update,0,"fnc_wash_resetFrom()",7) ;
                    }
                    else
                    {
                        echo load_submit_buttons( $permission, "fnc_wash_cost_dtls", $save_update,0,"fnc_wash_resetFrom()",7) ;
                    }
                    ?>
                    </td>
                </tr>
            </table>
            </form>
        </fieldset>
	</div>
	<?
	exit();
}

if($action=="wash_chart_popup")
{
	echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
		function js_set_value(id,rate)
		{
			//var data=data.split("_");
			document.getElementById('charge_id').value=id;
			document.getElementById('charge_value').value=rate;
			parent.emailwindow.hide();
		}

		function toggle( x, origColor )
		{
			var newColor = 'yellow';
			document.getElementById(x).style.backgroundColor = ( newColor == document.getElementById(x).style.backgroundColor )? origColor : newColor;
		}
	</script>
	</head>
	<body>
        <div align="center">
        	<form>
                <input type="hidden" id="charge_id" name="charge_id" />
                <input type="hidden" id="charge_value" name="charge_value" />
                <?
					$company_arr=return_library_array( "select id, company_name from lib_company",'id','company_name');
					$color_library_arr=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
					$arr=array (0=>$company_arr,2=>$process_type,3=>$conversion_cost_head_array,4=>$color_library_arr,5=>$fabric_typee,7=>$unit_of_measurement,8=>$production_process,9=>$row_status);
                ?>
                <table width="900" class="rpt_table" border="1" rules="all" cellpadding="0" cellspacing="0">
                    <thead>
                        <th width="50">SL</th>
                        <th width="100">Company Name</th>
                        <th width="150">Const. Compo.</th>
                        <th width="70">Process Type</th>
                        <th width="70">Process Name</th>
                        <th width="70">Color</th>
                        <th width="80">Width/Dia type</th>
                        <th width="60">In House Rate</th>
                        <th width="80">UOM</th>
                        <th width="60">Rate type</th>
                        <th>Status</th>
                    </thead>
                </table>
                <div style=" width:917; overflow:scroll-y; max-height:300px">
                    <table width="900" class="rpt_table" border="1" rules="all" id="list_view" cellpadding="0" cellspacing="0">
						<?
                        $sql_data=sql_select("select id, comapny_id, const_comp, process_type_id, process_id, color_id, width_dia_id, in_house_rate, uom_id, rate_type_id, status_active from lib_subcon_charge where status_active=1 and is_deleted=0 and rate_type_id =7 and comapny_id=$cbo_company_name");

                        $i=1;
                        foreach($sql_data as $row)
                        {
							if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
							?>
							<tr bgcolor="<? echo $bgcolor; ?>" onClick="js_set_value(<? echo $row[csf("id")]?>, <? echo $row[csf("in_house_rate")]; ?>)" id="tr_<? echo $row[csf("id")]; ?>">
                                <td width="50"><? echo $i; ?></td>
                                <td width="100"><? echo $company_arr[$row[csf("comapny_id")]]; ?></td>
                                <td width="150"><? echo $row[csf("const_comp")]; ?></td>
                                <td width="70"><? echo $process_type[$row[csf("process_type_id")]]; ?></td>
                                <td width="70"><? echo $conversion_cost_head_array[$row[csf("process_id")]]; ?></td>
                                <td width="70"><? echo $color_library_arr[$row[csf("color_id")]]; ?></td>
                                <td width="80"><? echo $fabric_typee[$row[csf("width_dia_id")]]; ?></td>
                                <td width="60"><? echo $row[csf("in_house_rate")]; ?></td>
                                <td width="80"><? echo $unit_of_measurement[$row[csf("uom_id")]]; ?></td>
                                <td width="60"><? echo $production_process[$row[csf("rate_type_id")]]; ?></td>
                                <td><? echo $row_status[$row[csf("status_active")]]; ?></td>
							</tr>
							<?
							$i++;
                        }
                        ?>
                        <script>
							setFilterGrid("list_view",-1)
							toggle( "tr_"+"<? echo $ratelibid ?>", '#FFFFCC');
                        </script>
                    </table>
                </div>
            </form>
        </div>
	</body>
	</html>
	<?
	exit();
}

if($action=="save_post_session_wash"){
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$_SESSION['logic_erp']['cons_breck_downn_wash']="";
	$_SESSION['logic_erp']['cons_breck_downn_wash']=$cons_breck_downn_wash;
	echo 1;
	die;
}

if($action=="consumption_popup_wash")
{
	echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode,'','');
	extract($_REQUEST);
	$color_library=return_library_array("select id,color_name from lib_color where status_active=1 and is_deleted=0","id","color_name");
	$size_library=return_library_array("select id,size_name from lib_size where status_active=1 and is_deleted=0","id","size_name");
	$country_library=return_library_array("select id,country_name from lib_country","id","country_name");
	$cons_breck_downn= $_SESSION['logic_erp']['cons_breck_downn_wash'];
	$itemqty_array=array();
	$job_plancut_qty=0;
	$country=rtrim($country,",");
	if($country=="") $country_cond=""; else $country_cond=" and c.country_id in($country)";

	$data_array_tot_job_qty=sql_select("select b.id, b.po_number, c.item_number_id, c.color_number_id, c.size_number_id, min(c.id) as color_size_table_id, min(color_order) as color_order, min(size_order) as size_order, sum(plan_cut_qnty) as plan_cut_qnty, sum(c.order_quantity) as order_quantity from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id  and b.job_no_mst='$txt_job_no' and a.garments_nature='$garments_nature' and a.status_active=1 and b.status_active=1 and c.status_active=1 $country_cond group by b.id, b.po_number, c.item_number_id, c.color_number_id, c.size_number_id order by b.id, c.item_number_id, color_order, size_order");
	foreach($data_array_tot_job_qty as $data_array_tot_job_qty_row )
	{
		//$itemqty_array[$data_array_tot_job_qty_row[csf('item_number_id')]]+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
		//$job_plancut_qty+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
		//$po_no_library[$data_array_tot_job_qty_row[csf('id')]]=$data_array_tot_job_qty_row[csf('po_number')];
		if($empbudgeton==1){
			$itemqty_array[$data_array_tot_job_qty_row[csf('item_number_id')]]+=$data_array_tot_job_qty_row[csf('order_quantity')];
			$job_plancut_qty+=$data_array_tot_job_qty_row[csf('order_quantity')];
		}
		else if($empbudgeton==2){
			$itemqty_array[$data_array_tot_job_qty_row[csf('item_number_id')]]+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
			$job_plancut_qty+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
		}else{
			$itemqty_array[$data_array_tot_job_qty_row[csf('item_number_id')]]+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
			$job_plancut_qty+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
		}
		$po_no_library[$data_array_tot_job_qty_row[csf('id')]]=$data_array_tot_job_qty_row[csf('po_number')];
	}
	$item_idarr=explode(",",$item_id);
	$total_item=count($item_idarr);
	if($israte_popup==2)
	{
		$conversion_from_chart=return_field_value("conversion_from_chart", "variable_order_tracking", "company_name=$cbo_company_id and variable_list=21 and status_active=1 and is_deleted=0");
	}
	else $conversion_from_chart=2;

	$country_array=array();
	$data_country=sql_select("select b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id ,c.country_id from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and b.job_no_mst='$txt_job_no' $country_cond and a.status_active=1 and b.status_active=1 and c.status_active=1");
	foreach($data_country as $cou_row){
		 $country_array[$cou_row[csf('id')]][$cou_row[csf('item_number_id')]][$cou_row[csf('color_number_id')]][$cou_row[csf('size_number_id')]]['country_id'][$cou_row[csf('country_id')]]=$cou_row[csf('country_id')];
		 $country_array[$cou_row[csf('id')]][$cou_row[csf('item_number_id')]][$cou_row[csf('color_number_id')]][$cou_row[csf('size_number_id')]]['country_name'][$cou_row[csf('country_id')]]=$country_library[$cou_row[csf('country_id')]];
	}
	?>
	<script>
		var conversion_from_chart = '<? echo $conversion_from_chart*1; ?>';
		function copy_value(value,field_id,i)
		{
			//var copy_val=document.getElementById('copy_val').checked;
			var gmtssizesid=document.getElementById('gmtssizesid_'+i).value;
			var pocolorid=document.getElementById('pocolorid_'+i).value;
			var ponoid=document.getElementById('ponoid_'+i).value;
			var cbogmtsitem=document.getElementById('cbogmtsitem_'+i).value;
			var librateid=document.getElementById('ratelibid_'+i).value;
			//alert(librateid);
			var rowCount = $('#tbl_consmption_cost tr').length-1;
			var copy_basis=$('input[name="copy_basis"]:checked').val()
			for(var j=i; j<=rowCount; j++)
			{
				if(document.getElementById('approved_'+j).value==0){
					if(field_id=='rate_'){
						if(copy_basis==0){
							document.getElementById(field_id+j).value=value;
							document.getElementById('ratelibid_'+j).value=librateid;
							//claculate_amount(j);
						}
						else if(copy_basis==1){
							if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0){
								document.getElementById(field_id+j).value=value;
								document.getElementById('ratelibid_'+j).value=librateid;
								//claculate_amount(j);
							}
						}
						else if(copy_basis==2){
							if( pocolorid==document.getElementById('pocolorid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0){
								document.getElementById(field_id+j).value=value;
								document.getElementById('ratelibid_'+j).value=librateid;
								//claculate_amount(j);
							}
						}
						else if(copy_basis==3){
							if( cbogmtsitem==document.getElementById('cbogmtsitem_'+j).value && (document.getElementById('requirement_'+j).value*1) >0){
								document.getElementById(field_id+j).value=value;
								document.getElementById('ratelibid_'+j).value=librateid;
								//claculate_amount(j);
							}
						}
						else if(copy_basis==4){
							if( ponoid==document.getElementById('ponoid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0){
								document.getElementById(field_id+j).value=value;
								document.getElementById('ratelibid_'+j).value=librateid;
								//claculate_amount(j);
							}
						}
					}

					if(field_id=='requirement_'){
						if(copy_basis==0){
							document.getElementById(field_id+j).value=value;
							//claculate_amount(j) ;
						}
						else if(copy_basis==1){
							if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value){
								document.getElementById(field_id+j).value=value;
								//claculate_amount(j);
							}
						}
						else if(copy_basis==2){
							if( pocolorid==document.getElementById('pocolorid_'+j).value){
								document.getElementById(field_id+j).value=value;
								//claculate_amount(j);
							}
						}
						else if(copy_basis==3){
							if( cbogmtsitem==document.getElementById('cbogmtsitem_'+j).value){
								document.getElementById(field_id+j).value=value;
								//claculate_amount(j);
							}
						}
						else if(copy_basis==4){
							if( ponoid==document.getElementById('ponoid_'+j).value){
								document.getElementById(field_id+j).value=value;
								//claculate_amount(j);
							}
						}
					}
				}//if(var approved=document.getElementById('approved_'+j).value==0)
				var rate=document.getElementById('rate_'+j).value;
				var requirement=document.getElementById('requirement_'+j).value;
				var amount= requirement*rate;
				document.getElementById('amount_'+j).value=number_format_common(amount,5,0);
			}
			set_sum_value( 'amount_sum', 'amount_');
			claculate_avg();
		}

		function fn_delete_down_tr(rowNo,table_id)
		{
			if(table_id=='tbl_consmption_cost')
			{
				var numRow = $('table#tbl_consmption_cost tbody tr').length;
				if(numRow==rowNo && rowNo!=1)
				{
					$('#tbl_consmption_cost tbody tr:last').remove();
					$('#tbl_msmnt_cost tbody tr:last').remove();
				}
				set_sum_value( 'requirement_sum', 'requirement_');
				set_sum_value( 'rate_sum', 'rate_');
				set_sum_value( 'amount_sum', 'amount_');
			}
		}

		function set_sum_value(des_fil_id,field_id)
		{
			if(des_fil_id=='requirement_sum') var ddd={dec_type:5,comma:0};
			if(des_fil_id=='amount_sum') var ddd={dec_type:5,comma:0};
			if(des_fil_id=='rate_sum') var ddd={dec_type:5,comma:0};

			var rowCount = $('#tbl_consmption_cost tr').length-1;
			math_operation( des_fil_id, field_id, '+', rowCount,ddd );
			claculate_avg();
		}

		function js_set_value()
		{
			var rowCount = $('#tbl_consmption_cost tr').length-1;
			var cons_breck_down="";
			for(var i=1; i<=rowCount; i++)
			{
				var ponoid=$('#ponoid_'+i).val(); if(ponoid=='') ponoid=0;
				var cbogmtsitem=$('#cbogmtsitem_'+i).val(); if(cbogmtsitem=='') cbogmtsitem=0;
				var pocolorid=$('#pocolorid_'+i).val(); if(pocolorid=='') pocolorid=0;
				var gmtssizesid=$('#gmtssizesid_'+i).val(); if(gmtssizesid=='') gmtssizesid=0;
				var requirement=$('#requirement_'+i).val(); if(requirement=='') requirement=0;
				var colorsizetableid=$('#colorsizetableid_'+i).val(); if(colorsizetableid=='') colorsizetableid=0;
				var rate=$('#rate_'+i).val(); if(rate=='') rate=0;
				var amount=$('#amount_'+i).val(); if(amount=='') amount=0;
				var ratelibid=$('#ratelibid_'+i).val(); if(ratelibid=='') ratelibid=0;
				var cbocountry=$('#cbocountry_'+i).val(); if(cbocountry=='') cbocountry=0;

				if(cons_breck_down=="")
				{
					cons_breck_down+=ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid+'_'+ratelibid+'_'+cbocountry;
				}
				else
				{
					cons_breck_down+="__"+ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid+'_'+ratelibid+'_'+cbocountry;
				}
			}
			document.getElementById('cons_breck_down').value=cons_breck_down;
			claculate_avg();
			parent.emailwindow.hide();
		}

		function claculate_avg()
		{
			//var tot_plancut_qty=document.getElementById('job_plancut_qty').value*1;
			var item_ratio=document.getElementById('item_ratio').value*1;
			//var total_item=document.getElementById('total_item').value*1;
			var calculated_cons=0; var avg_cons=0; var plancutqty=0; var calculated_amount=0;
			var rowCount = $('#tbl_consmption_cost tr').length-1;

			/*for(var j=1; j<=rowCount; j++){
			if(document.getElementById('requirement_'+j).value =='' || document.getElementById('requirement_'+j).value ==0){
			continue;
			}
			else{
			//plancutqty+=document.getElementById('pcsgmts_'+j).value*1;
			}
			}*/

			for(var i=1; i<=rowCount; i++)
			{
				if(document.getElementById('requirement_'+i).value =='' || document.getElementById('requirement_'+i).value ==0){
					continue;
				}
				else{
					var tot_plancut_qty=document.getElementById('itempcsgmts_'+i).value*1;
					var pcsgmts=document.getElementById('pcsgmts_'+i).value*1;
					var plan_cut_percent=(pcsgmts/tot_plancut_qty)*100;
					var requirement=document.getElementById('requirement_'+i).value*1;
					var calculated_cons_percent=(requirement*plan_cut_percent)/100;
					calculated_cons+=calculated_cons_percent;
					var amount=document.getElementById('amount_'+i).value*1;
					var calculated_amount_percent=(amount*plan_cut_percent)/100;
					calculated_amount+=calculated_amount_percent;
				}
			}
			document.getElementById('calculated_cons').value=number_format_common(calculated_cons, 5, 0);
			document.getElementById('calculated_amount').value=number_format_common(calculated_amount, 5, 0);
			document.getElementById('calculated_rate').value=number_format_common(calculated_amount/calculated_cons, 5, 0);
		}

		function claculate_amount(i)
		{
			var rate=document.getElementById('rate_'+i).value;
			var requirement=document.getElementById('requirement_'+i).value;
			var amount= requirement*rate;
			document.getElementById('amount_'+i).value=number_format_common(amount,5,0);
			set_sum_value( 'amount_sum', 'amount_' );
			claculate_avg();
		}

		function fnc_conversion_from_chart()
		{
			var rowCount = $('#tbl_consmption_cost tr').length-1;
			for(var i=1; i<=rowCount; i++)
			{
				if(conversion_from_chart==1)
				{
					$('#rate_'+i).removeAttr("onDblClick").attr("onDblClick","set_wash_charge_unit_pop_up("+i+")");
					$('#rate_'+i).attr("placeholder","Browse");
					$('#rate_'+i).attr('readonly','readonly');
				}
				else
				{
					$('#rate_'+i).removeAttr("onDblClick");
					$('#rate_'+i).attr("placeholder","Write");
					$('#rate_'+i).removeAttr('readonly','readonly');
				}
			}
		}

		function set_wash_charge_unit_pop_up(i)
		{
			var cbo_company_name=document.getElementById('cbo_company_id').value;
			//var cbotypeconversion=document.getElementById('cbotypeconversion_'+i).value
			var txt_exchange_rate=document.getElementById('txt_exchange_rate').value;
			var ratelibid=document.getElementById('ratelibid_'+i).value;


			if(txt_exchange_rate==0 || txt_exchange_rate=="")
			{
				alert("Select Exchange Rate");
				return;
			}
			else
			{
				var page_link='pre_cost_entry_controller_v2.php?action=wash_chart_popup&cbo_company_name='+cbo_company_name+'&ratelibid='+ratelibid;;
				emailwindow=dhtmlmodal.open('EmailBox', 'iframe', page_link, 'Conversion Chart', 'width=1060px,height=450px,center=1,resize=1,scrolling=0','')
				emailwindow.onclose=function()
				{
					var charge_id=this.contentDoc.getElementById("charge_id");
					var charge_value=this.contentDoc.getElementById("charge_value");

					document.getElementById('ratelibid_'+i).value=charge_id.value;
					document.getElementById('rate_'+i).value=number_format_common(charge_value.value/txt_exchange_rate,5,0,document.getElementById('cbo_currercy').value);
					claculate_amount( i );
					var rate=$('#rate_'+i).val();
					copy_value(rate,'rate_',i);
				}
			}
		}
	</script>
	</head>
	<body>
        <div align="center" style="width:99%;" >
        <fieldset>
        <legend><? echo $body_part_id.'.'.$body_part[$body_part_id].'   Costing '.$costing_per[$cbo_costing_per] ;?></legend>
            <form id="consumptionform_1" autocomplete="off">
                <input type="hidden" id="cbo_company_id" name="cbo_company_id" value="<? echo $cbo_company_id; ?>"/>
                <input type="hidden" id="cbo_costing_per_id" name="cbo_costing_per_id" value="<? echo $cbo_costing_per; ?>"/>
                <input type="hidden" id="cons_breck_down" name="cons_breck_down"  width="500"  value="<? echo $cons_breck_downn;?>"/>
                <input type="hidden" id="job_plancut_qty" name="job_plancut_qty" value="<? echo $job_plancut_qty; ?>"/>
                <input type="hidden" id="item_ratio" name="item_ratio" value="<? echo $tot_set_qnty; ?>"/>
                <input type="hidden" id="txt_exchange_rate" name="txt_exchange_rate" value="<? echo $txt_exchange_rate; ?>"/>
                <input type="hidden" id="cbo_currercy" name="cbo_currercy" value="<? echo $cbo_currercy; ?>"/>
                <!-- <b>Copy</b> : <input type="checkbox" id="copy_val" name="copy_val" checked/>  -->
                <input type="radio" name="copy_basis" value="0" checked>Copy To All
                <input type="radio" name="copy_basis" value="1">Copy Size Wise
                <input type="radio" name="copy_basis" value="2">Copy Color Wise
                <input type="radio" name="copy_basis" value="3">Copy Item Wise
                <input type="radio" name="copy_basis" value="4">Copy Po Wise
                <input type="reset" value="Reset">
            </form>
            <table width="820" cellspacing="0" class="rpt_table" border="0" id="tbl_consmption_cost" rules="all">
                <thead>
                    <tr>
                    	<th width="20">SL</th>
                        <th width="120">PO NO</th>
                        <th width="120">Country</th>
                        <th width="120">Gmts.Item</th>
                        <th width="80">Gmts Color</th>
                        <th width="80">Gmts Size</th>
                        <th width="65" style="color:#2A3FFF">Cons</th>
                        <th width="50" style="color:#2A3FFF">Rate</th>
                        <th width="90">Amount</th>
                    	<th>&nbsp;</th>
                    </tr>
                </thead>
                <tbody>
					<?
					$component_approved=0;
					$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=1 and job_no='$txt_job_no'");
					foreach($sql as $row){
						if($row[csf('approved')]==1 || $row[csf('approved')]==3) { $component_approved=1; }
					}
					
					$copy_variable_sql=sql_select("select variable_list, copy_quotation, cost_control_source from variable_order_tracking where company_name='$cbo_company_id' and variable_list in (20,53)");
                    //echo "select trim_rate from  variable_order_tracking where company_name='$company_name' and variable_list=35 order by id";
					$copy_quotation=$cost_control_source=0;
                    foreach($copy_variable_sql as $emb_variable_row)
                    {
                        if($emb_variable_row[csf('variable_list')]==20) $copy_quotation=$emb_variable_row[csf('copy_quotation')];
						if($emb_variable_row[csf('variable_list')]==53) $cost_control_source=$emb_variable_row[csf('cost_control_source')];
                    }
                    unset($trim_variable_sql);
					
                    $data_array=explode("__",$cons_breck_downn);
                    if($data_array[0]==""){
                    	$data_array=array();
                    }
					 
                    $data_array=sql_select("select b.id, b.po_number, c.item_number_id, c.color_number_id, c.size_number_id, min(c.id) as color_size_table_id, min(color_order) as color_order, min(size_order) as size_order, sum(plan_cut_qnty) as plan_cut_qnty, sum(c.order_quantity) as order_quantity from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id  and b.job_no_mst='$txt_job_no' and a.garments_nature='$garments_nature' and a.status_active=1 and b.status_active=1 and c.status_active=1 $country_cond group by b.id, b.po_number, c.item_number_id, c.color_number_id, c.size_number_id order by b.id, c.item_number_id, color_order, size_order");
                    //=======================================
                    if($embupdateid != "")
					{
						$is_booking_arr=array();
						$data_arr=sql_select("select po_break_down_id, pre_cost_fabric_cost_dtls_id from wo_booking_dtls where pre_cost_fabric_cost_dtls_id ='$embupdateid' and booking_type='6' and status_active=1 and is_deleted=0 group by po_break_down_id, pre_cost_fabric_cost_dtls_id");
						foreach($data_arr as $row)
						{
							$is_booking_arr[$row[csf('po_break_down_id')]]=$row[csf('pre_cost_fabric_cost_dtls_id')];
						}
						unset($data_arr);

						$washConsArr=array();
						$wo_pre_cos_fab_co_avg_con_dtls_data=sql_select("select id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id, item_number_id, color_number_id, size_number_id, requirment, rate, amount, color_size_table_id, rate_lib_id, country_id from wo_pre_cos_emb_co_avg_con_dtls where job_no='$txt_job_no' and pre_cost_emb_cost_dtls_id=$embupdateid order by id");
						foreach($wo_pre_cos_fab_co_avg_con_dtls_data as $wrow)
						{
							if($wrow[csf('country_id')] =='') $wrow[csf('country_id')]=0;
							
							$washConsArr[$wrow[csf('color_size_table_id')]]=$wrow[csf('po_break_down_id')]."_".$wrow[csf('item_number_id')]."_".$wrow[csf('color_number_id')]."_".$wrow[csf('size_number_id')]."_".$wrow[csf('requirment')]."_".$wrow[csf('rate')]."_".$wrow[csf('amount')]."_".$wrow[csf('color_size_table_id')]."_".$wrow[csf('rate_lib_id')]."_".$wrow[csf('country_id')];
							if($wrow[csf('requirment')]!=0 && $wrow[csf('rate')]!=0)
								$colorWiseDataArr[$wrow[csf('color_number_id')]]['copyConsdata']=$wrow[csf('requirment')]."_".$wrow[csf('rate')]."_".$wrow[csf('amount')];
						}
                    }

                    if($embupdateid == ""){
						$data_array_cons=explode("__",$cons_breck_downn);
						//print_r($data_array_cons);
                    }
                    //echo $row_arr_data;

                    if($precostapproved==1 || $component_approved==1) $disabled=1; else $disabled=0;
                    //=======================================
                    if ( count($data_array)>0)
					{
						$i=0;
						foreach( $data_array as $row )
						{
							if($embupdateid != "") $data=explode('_',$washConsArr[$row[csf('color_size_table_id')]]);
							else $data=explode('_',$data_array_cons[$i]);
							//print_r($data);
							$i++;
							if($empbudgeton==1) $pcsgmts=$row[csf('order_quantity')]; else if($empbudgeton==2) $pcsgmts=$row[csf('plan_cut_qnty')]; else $pcsgmts=$row[csf('plan_cut_qnty')];
							$country_string=implode(",",$country_array[$row[csf('id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['country_id']);
							$country_string_name=implode(",",$country_array[$row[csf('id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['country_name']);

							$po_country_arr=explode(",",$country_string);

							$countrydata=explode(",",$data[9]);
							$arr_d=array_diff($countrydata, $po_country_arr);
							$arr_d2=array_diff($countrydata, $arr_d);
							$country_name="";

							for($countryindex=0; $countryindex < count($arr_d2);$countryindex++){
								$country_name.=	$country_library[$countrydata[$countryindex]].",";
							}
							$country_idstring=implode(",",$arr_d2);

							if(count($arr_d)>0 && count($countrydata)>0 )
							{
								$country_name_pre="";
								for($countryindex=0; $countryindex < count($arr_d);$countryindex++){
									$country_name_pre.=	$country_library[$countrydata[$countryindex]].",";
								}
								$title="Country have Changed in po entry, you have to update this field, Previous Country was ".rtrim($country_name_pre,",")."";
								if(rtrim($country_name_pre,",")!=""){
									$bgc="#D41F00";
								}
							}
							else{
								$title=""; $bgc="#FFFFFF";
							}

							$cons_fld=0;
							if($disabled!=1)
							{
								//echo $is_booking_arr[$row[csf('id')]];
								if($is_booking_arr[$row[csf('id')]]!="" || $is_booking_arr[$row[csf('id')]]!=0) $cons_fld=1;
							}

							?>
							<tr id="break_<?=$i; ?>" align="center">
                                <td align="center"><?=$i; ?></td>
                                <td>
                                    <input type="text" id="pono_<?=$i; ?>" name="pono_<?=$i; ?>" class="text_boxes" style="width:108px" value="<?=$row[csf('po_number')]; ?>" readonly />
                                    <input type="hidden" id="ponoid_<?=$i; ?>" name="ponoid_<?=$i; ?>" class="text_boxes" style="width:108px" value="<?=$row[csf('id')]; ?>" readonly />
                                </td>
                                <td>
                                    <input type="hidden" id="cbocountry_<? echo $i;?>" name="cbocountry_<? echo $i;?>" style="width:75px" value="<? echo $country_string; ?>" readonly />
                                    <input type="text" id="cbocountryname_<? echo $i;?>" name="cbocountryname_<? echo $i;?>" onClick="open_country_popup('<? echo $i.'_2'; ?>',0)" class="text_boxes" style="width:108px; background-color:<? echo $bgc; ?>" value="<? echo $country_string_name; ?>" readonly title="<? echo $title; ?>" disabled />
                                </td>
                                <td><? echo create_drop_down( "cbogmtsitem_".$i, 120, $garments_item,"", 0, "",$row[csf('item_number_id')], "","1"); ?></td>
                                <td>
                                    <input type="text" id="pocolor_<? echo $i;?>" name="pocolor_<? echo $i;?>" class="text_boxes" style="width:68px" value="<? echo $color_library[$row[csf('color_number_id')]]; ?>" readonly />
                                    <input type="hidden" id="pocolorid_<? echo $i;?>" name="pocolorid_<? echo $i;?>" class="text_boxes" style="width:50px" value="<?=$row[csf('color_number_id')]; ?>" readonly/>
                                </td>
                                <td>
                                    <input type="text" id="gmtssizes_<? echo $i;?>" name="gmtssizes_<? echo $i;?>" class="text_boxes" style="width:68px" value="<? echo $size_library[$row[csf('size_number_id')]]; ?>" readonly>
                                    <input type="hidden" id="gmtssizesid_<? echo $i;?>" name="gmtssizesid_<? echo $i;?>" class="text_boxes" style="width:50px" value="<? echo $row[csf('size_number_id')]; ?>" readonly />
                                </td>
                                <td>
                                <?
									if($copy_quotation==1 && $cost_control_source==4 && ($data[4]*1)==0 && $embupdateid!="")//issue id ISD-21-03976
									{
										$exqcqty=explode("_",$colorWiseDataArr[$row[csf('color_number_id')]]['copyConsdata']);
										$data[4]=$exqcqty[0]; //Tot cons
										$data[5]=$exqcqty[1]; //rate
										$data[6]=$exqcqty[2]; //amount
									}
									else if($cost_control_source==3 && ($data[4]*1)==0 && $embupdateid!="")//issue id ISD-21-20681 Color Wise Cons Copy
									{
										$exqcqty=explode("_",$colorWiseDataArr[$row[csf('color_number_id')]]['copyConsdata']);
										$data[4]=$exqcqty[0]; //Tot cons
										$data[5]=$exqcqty[1]; //rate
										$data[6]=$exqcqty[2]; //amount
									}
									else if($copy_quotation==1 && $cost_control_source==4 && ($data[4]*1)==0 && $qcdata!="" && $embupdateid=="")
									{
										$exqcqty=explode("__",$qcdata);
										$data[4]=$exqcqty[0]; //Tot cons
										$data[5]=$exqcqty[3]; //rate
										$data[6]=$exqcqty[4]; //amount
									}
									?>
                                	<input type="text" id="requirement_<? echo $i;?>" onChange="claculate_amount(<? echo $i;?>);copy_value(this.value,'requirement_',<? echo $i;?>);set_sum_value( 'requirement_sum', 'requirement_' )"  name="requirement_<? echo $i;?>" class="text_boxes_numeric" style="width:53px" value="<? if ($data[4]==""){ echo $price_quatation_requirment[$row[csf('size_number_id')]];} else { echo $data[4]; } ?>" <? if($disabled==1 || $cons_fld==1){ echo "disabled";} else{ echo "";} ?> />
                                </td>
                                <td>
                                	<input type="text" id="rate_<? echo $i;?>" name="rate_<? echo $i;?>" onChange="claculate_amount(<? echo $i;?>); copy_value(this.value,'rate_',<? echo $i;?>)" onBlur="set_sum_value( 'rate_sum', 'rate_') " class="text_boxes_numeric" style="width:38px"  value="<? echo $data[5]; ?>" <? if($disabled==1 || $cons_fld==1){ echo "disabled";} else{ echo "";} ?>/>
                                    <input type="hidden" id="ratelibid_<? echo $i;?>" name="ratelibid_<? echo $i;?>" value="<? echo $row[csf('rate_lib_id')]; ?>"/>
                                </td>
                                <td>
                                	<input type="text" id="amount_<? echo $i;?>"  name="amount_<? echo $i;?>"   class="text_boxes_numeric" style="width:78px"  value="<? echo $data[6]; ?>" readonly />
                                </td>
                                <td id="add_1">
                                    <input type="hidden" id="pcsgmts_<? echo $i;?>" name="pcsgmts_<? echo $i;?>"  onBlur="set_sum_value( 'pcs_sum', 'pcs_' ) " class="text_boxes_numeric" style="width:55px"  value="<? echo $pcsgmts; ?>">
                                    <input type="hidden" id="itempcsgmts_<? echo $i;?>"  name="itempcsgmts_<? echo $i;?>"  onBlur="set_sum_value( 'pcs_sum', 'pcs_' ) " class="text_boxes_numeric" style="width:55px"  value="<? echo $itemqty_array[$row[csf('item_number_id')]]; ?>">
                                    <input type="hidden" id="colorsizetableid_<? echo $i;?>"  name="colorsizetableid_<? echo $i;?>" class="text_boxes" style="width:55px" value="<?=$row[csf('color_size_table_id')]; ?>" readonly/>
                                    <input type="button" id="decreaserow_<? echo $i;?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_delete_down_tr(<? echo $i;?>,'tbl_consmption_cost');" disabled/>
                                    <input type="hidden" id="approved_<? echo $i;?>"  name="approved_<? echo $i;?>"  class="text_boxes_numeric" style="width:75px"  value="<?=$disabled; ?>">
                                </td>
							</tr>
							<?
						}
                    }
                    ?>
                </tbody>
            </table>
            <table width="820" cellspacing="0" class="rpt_table" border="0" rules="all">
                <tfoot>
                    <tr>
                        <th width="20">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="80">&nbsp;</th>
                        <th width="80">SUM:</th>
                        <th width="65"><input type="text" id="requirement_sum"  name="requirement_sum" class="text_boxes_numeric" style="width:53px" readonly></th>
                        <th width="50"><input type="text" id="rate_sum"    name="rate_sum" class="text_boxes_numeric" style="width:38px" readonly></th>
                        <th width="90">
                            <input type="text" id="amount_sum"    name="amount_sum" class="text_boxes_numeric" style="width:78px" readonly>
                            <input type="hidden" id="plancutqty_sum"    name="plancutqty_sum" class="text_boxes_numeric" style="width:70px" readonly>
                        </th>
                        <th>&nbsp;</th>
                    </tr>
                    <tr>
                        <th width="20">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="80">&nbsp;</th>
                        <th width="80">AVG:</th>
                        <th width="65"><input type="text" id="calculated_cons" name="calculated_cons" class="text_boxes_numeric" style="width:53px" value="<? echo $calculated_conss;?>" readonly></th>
                        <th width="50"><input type="text" id="calculated_rate"   name="calculated_rate" class="text_boxes_numeric" style="width:38px" readonly></th>
                        <th width="90">
                            <input type="text" id="calculated_amount" name="calculated_amount" class="text_boxes_numeric" style="width:78px" readonly>
                            <input type="hidden" id="calculated_plancutqty"    name="calculated_plancutqty" class="text_boxes_numeric" style="width:70px" readonly>
                        </th>
                        <th>&nbsp;</th>
                    </tr>
                </tfoot>
            </table>
            <script>
				set_sum_value( 'requirement_sum', 'requirement_');
				set_sum_value( 'rate_sum', 'rate_');
				set_sum_value( 'amount_sum', 'amount_');
				fnc_conversion_from_chart();
            </script>
        </form>
        </fieldset>
        </div>
        <div align="center" style="width:100%;" >
        <fieldset>
            <table width="810" cellspacing="0" class="" border="0" rules="all">
                <tr>
                	<td align="center" width="100%" class="button_container"> <input type="button" class="formbutton" value="Close" onClick="js_set_value()"/> </td>
                </tr>
            </table>
        </fieldset>
        </div>
	</body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}

if ($action=="save_update_delet_wash_cost_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$sql=sql_select("select approval_need from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
	$app_nessity=2;
	foreach($sql as $row){
		$app_nessity=$row[csf('approval_need')];
	}

	$sql=sql_select("select approved from wo_price_quotation  where id=$txt_quotation_id");
	$quatation_approved=2;
	foreach($sql as $row){
		$quatation_approved=$row[csf('approved')];
	}

	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	//echo "10**",$is_copy_quatation."**". $app_nessity."**".$quatation_approved;
	//die;
	if($is_copy_quatation==1 && $app_nessity==1){
		if($quatation_approved==2 || $quatation_approved==0){
			echo "quataNotApp**".str_replace("'","",$txt_job_no);
			 disconnect($con);die;
		}
	}
	$component_approved=return_field_value("current_approval_status", "co_com_pre_costing_approval", "job_no=$update_id and cost_component_id=4");
	if($component_approved==3) $component_approved=1;
	
	$approved=0; $ready_to_approve=0;
	$sql=sql_select("select approved, ready_to_approved from wo_pre_cost_mst where job_no=$update_id and status_active=1 and is_deleted=0");
	foreach($sql as $row){
		//if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
		$approved=$row[csf('approved')];
		$ready_to_approve=$row[csf('ready_to_approved')];
	}
	if($approved==1 || $component_approved==1){
		echo "approved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($approved==3){
		echo "papproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($ready_to_approve==1){
		echo "readyapproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($operation==0)
	{
		$con = connect();
		if($db_type==0) mysql_query("BEGIN");
		if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0";  disconnect($con);die;}
		
		 $add_comma=0;
		 $fail1=0;
		 $id=return_next_id( "id", "wo_pre_cost_embe_cost_dtls", 1 ) ;
		 $id1=return_next_id( "id", "wo_pre_cos_emb_co_avg_con_dtls", 1 ) ;
		 $field_array="id, job_id, job_no, quotdtlsid, emb_name, emb_type, country, nominated_supp_multi, cons_dzn_gmts, rate, amount, charge_lib_id, budget_on, inserted_by, insert_date, status_active, is_deleted";
		 $field_array1="id, job_id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id, item_number_id, color_number_id, size_number_id, requirment, rate, amount, color_size_table_id, rate_lib_id, country_id";
		$field_supp_arr="id, job_id, job_no, wash_id, supplier_id,is_company, inserted_by, insert_date, status_active, is_deleted";
		$idembSupp=return_next_id( "id", "wo_pre_cost_wash_supplier", 1);
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cboembname="cboembname_".$i;
			 $cboembtype="cboembtype_".$i;
			 $country="country_".$i;
			 $txtembconsdzngmts="txtembconsdzngmts_".$i;
			 $txtembrate="txtembrate_".$i; 
			 $cboembsupplierid="cboembsupplierid_".$i;
			 $txtembamount="txtembamount_".$i;
			 $cboembstatus="cboembstatus_".$i;
			 $embupdateid="embupdateid_".$i;
			 $embratelibid="embratelibid_".$i;
			 $consbreckdownwash="consbreckdownwash_".$i;
			 $empbudgeton="empbudgeton_".$i;
			 $quotdtlsidemb="quotdtlsidemb_".$i;
			

			if ($i!=1) $data_array .=",";
			$data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$quotdtlsidemb.",".$$cboembname.",".$$cboembtype.",".$$country.",".$$cboembsupplierid.",".$$txtembconsdzngmts.",".$$txtembrate.",".$$txtembamount.",".$$embratelibid.",".$$empbudgeton.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cboembstatus.",0)";
			
			/*$cbonominasupplier=explode(",",str_replace("'",'',$$cboembsupplierid));
				$uid=str_replace("'",'',$$embupdateid);
				$q=1;		
				foreach($cbonominasupplier as $sid)
				{
					$rID_de1=execute_query( "delete from wo_pre_cost_wash_supplier where wash_id ='".$uid."'",0);
					if($sid>0)
					{
						if ($q!=1) $dataSuppArr .=",";
						$dataSuppArr.="(".$idembSupp.",".$hidd_job_id.",".$update_id.",'".$id."','".$sid."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
						$idembSupp++; $q++;
					}
				}*/
				 $cbonominasupplier=str_replace("'",'',$$cboembsupplierid);
			if(trim($cbonominasupplier)!="")
			{
				$cbonominasupplierarr=explode("_",$cbonominasupplier);
				foreach($cbonominasupplierarr as $key=>$supplierdata)
				{
					$is_compleate=($key == 0 ? 2 : 1);
					$supplierdataarr=explode(",",$supplierdata);
					foreach($supplierdataarr as $sid){
						if($sid>0)
						{
							$dataSuppArr ="";
							$dataSuppArr="INSERT INTO wo_pre_cost_wash_supplier (".$field_supp_arr.") VALUES(".$idembSupp.",".$hidd_job_id.",".$update_id.",'".$id."','".$sid."',$is_compleate,".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
							$idembSupp++;
							$rIDSupp=execute_query($dataSuppArr);
							//echo "10**=$flag-";oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die;
							if ($rIDSupp==1) { $flag=1; }
							else { echo "10**EmbSuppInsert-".$dataSuppArr; $flag=0; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
						}
					}
				}
			}
				
			//	CONS break down===============================================================================================
			if(str_replace("'",'',$$consbreckdownwash) !='')
			 {
				$consbreckdown= $$consbreckdownwash;
			 }
			 else
			 {
				 $consbreckdown="'".create_consbreak_down_emb($update_id,str_replace("'",'',$$txtembconsdzngmts),str_replace("'",'',$$txtembrate),str_replace("'",'',$$txtembamount))."'";
				 // $consbreckdown="";
			 }
			if(str_replace("'",'',$consbreckdown) !='')
			{
				$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
				$counter=0;
				for($c=0;$c < count($consbreckdown_array);$c++)
				{
					$counter++;
					$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
					if ($add_comma!=0) $data_array1 .=",";
					//$field_array1="id, job_id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id, item_number_id, color_number_id, size_number_id, requirment, rate, amount, color_size_table_id, rate_lib_id, country_id";
					$data_array1 .="(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."')";

					$id1=$id1+1;
					$add_comma++;
					if ($data_array1!="" && $counter==100)
					{
						$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
						$counter=0;
						$data_array1="";
						$add_comma=0;
						if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
					}
				}
				if ($data_array1!="" && $counter!=100)
				{
					//echo "10**Insert into wo_pre_cos_emb_co_avg_con_dtls ($field_array1) values $data_array1"; die;
					$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
					$counter=0;
					$data_array1="";
					$add_comma=0;
					if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
				}
			}
           //CONS break down end===============================================================================================
			$id=$id+1;
		}
		$rID=sql_insert("wo_pre_cost_embe_cost_dtls",$field_array,$data_array,0);
		//=======================supplier=================
		if ($dataSuppArr!="")
		{
			//echo "10**delete from wo_pre_cost_fabric_supplier where job_id =".$hidd_job_id.""; die;
			//$rID_de1=execute_query( "delete from wo_pre_cost_wash_supplier where job_id =".$hidd_job_id."",0);
			//$rID_in2=sql_insert("wo_pre_cost_wash_supplier",$field_supp_arr,$dataSuppArr,1);
			//echo sql_insert("wo_pre_cost_emb_supplier",$field_supp_arr,$dataSuppArr,1);
			/*if($flag==1) 
			{
				if($rID_in2) $flag=1;else $flag=0;
			}*/
			if( $rID_in2 && $fail1==0) { $rID_in2=1;  } else { $rID_in2=0; $fail1=1; }
		}
		
		//=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, emb_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtamountemb_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="emb_amount";
			$data_array2 ="".$txtamountemb_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		check_table_status( $_SESSION['menu_id'],0);
		//=======================sum End =================
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "0**".$new_job_no[0]."**".$rID;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID;
				//echo "10**".$new_job_no[0]."**insert into wo_pre_cost_embe_cost_dtls (".$field_array.") values ".$data_array; die;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "0**".$new_job_no[0]."**".$rID;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID;
				//echo "10**".$new_job_no[0]."**insert into wo_pre_cost_embe_cost_dtls (".$field_array.") values ".$data_array; die;
			}
		}
		disconnect($con);
		die;
	}
	else if($operation==1)
	{
		$con = connect();
		 if($db_type==0)
		 {
			mysql_query("BEGIN");
		 }
		
		if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**1"; die;}
		//=====Sourcing====================
		$avg_cons_sql="select b.id,b.pre_cost_emb_cost_dtls_id as dtlid,b.po_break_down_id as poid,b.color_size_table_id as sizemstId,b.sourcing_rate,b.sourcing_amount from wo_pre_cost_mst a,wo_pre_cos_emb_co_avg_con_dtls b,wo_pre_cost_embe_cost_dtls c where  a.job_id=b.job_id and a.job_id=c.job_id  and c.id=b.pre_cost_emb_cost_dtls_id  and b.sourcing_rate>0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and c.emb_name=3 and  a.approved in(0,2)  and b.sourcing_rate>0  and b.job_no='".str_replace("'", "", $update_id)."'";
		$avg_cons_result=sql_select($avg_cons_sql);
			foreach($avg_cons_result as $row)
			{
			 $SourcingWashArr[$row[csf('poid')]][$row[csf('dtlid')]][$row[csf('sizemstId')]]['rate']=$row[csf('sourcing_rate')];
			 $SourcingWashArr[$row[csf('poid')]][$row[csf('dtlid')]][$row[csf('sizemstId')]]['amount']=$row[csf('sourcing_amount')];
			}
			//=======End================

		 $field_array_up="job_no*emb_name*emb_type*country*is_apply_last_update*nominated_supp_multi*cons_dzn_gmts*rate*amount*charge_lib_id*budget_on*is_synchronized*updated_by*update_date*status_active*is_deleted";
		 $field_array="id, job_id, job_no, quotdtlsid, emb_name, emb_type, country,nominated_supp_multi, cons_dzn_gmts, rate, amount, charge_lib_id, budget_on, inserted_by, insert_date, status_active, is_deleted";
		 $field_array1="id, job_id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id, item_number_id, color_number_id, size_number_id, requirment, rate, amount, color_size_table_id, rate_lib_id, country_id";

		 $add_co=0; $add_comma=0; $fail1=0;$isconspopupupdateId_chk=0;
		 $id=return_next_id( "id", "wo_pre_cost_embe_cost_dtls", 1 ) ;
		 $id1=return_next_id( "id", "wo_pre_cos_emb_co_avg_con_dtls", 1 ) ;
		$field_supp_arr="id, job_id, job_no, wash_id, supplier_id,is_company, inserted_by, insert_date, status_active, is_deleted";
		$idembSupp=return_next_id( "id", "wo_pre_cost_wash_supplier", 1);
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cboembname="cboembname_".$i;
			 $cboembtype="cboembtype_".$i;
			 $country="country_".$i;
			 $lastappidchk="lastappidchk_".$i;
			 $txtembconsdzngmts="txtembconsdzngmts_".$i;
			 $txtembrate="txtembrate_".$i;
			 $txtembamount="txtembamount_".$i;
			 $cboembstatus="cboembstatus_".$i;
			 $cboembsupplierid="cboembsupplierid_".$i;
			 $embupdateid="embupdateid_".$i;
			 $embratelibid="embratelibid_".$i;
			 $consbreckdownwash="consbreckdownwash_".$i;
			 $empbudgeton="empbudgeton_".$i;
			 $quotdtlsidemb="quotdtlsidemb_".$i;
			 $txtsourcingrate="txtsourcingrate_".$i;
			 $isconspopupupdate="isconspopupupdate_".$i;
			 
			 $sourcingrate=str_replace("'",'',$$txtsourcingrate);//For Sourcing Pre cost v2
			 $isconspopupupdateId=str_replace("'",'',$$isconspopupupdate);//For Sourcing Pre cost v2
			$is_synchronized=1;
			if($sourcingrate>0 && $isconspopupupdateId==1)
			{
				$isconspopupupdateId_chk=$isconspopupupdateId;
				$is_synchronized=2;	
			}
			
			 $cbonominasupplierArr=explode(",",str_replace("'",'',$$cboembsupplierid));
			$upid=str_replace("'",'',$$embupdateid);
			/*$q=1;		
			foreach($cbonominasupplierArr as $sid)
			{
				$rID_de1=execute_query( "delete from wo_pre_cost_wash_supplier where wash_id ='".$upid."'",0);
				if($sid>0)
				{
					if ($q!=1) $dataSuppArr .=",";
					$dataSuppArr.="(".$idembSupp.",".$hidd_job_id.",".$update_id.",'".$upid."','".$sid."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
					$idembSupp++; $q++;
				}
			}*/
					//Nominated Supp $idsup
			$cbonominasupplier=str_replace("'",'',$$cboembsupplierid);
			if(trim($cbonominasupplier)!="")
			{
				$q=1;
				$cbonominasupplierarr=explode("_",$cbonominasupplier);
				foreach($cbonominasupplierarr as $key=>$supplierdata)
				{
					$is_compleate=($key == 0 ? 2 : 1);
					$supplierdataarr=explode(",",$supplierdata);
					foreach($supplierdataarr as $sid){
						$upid=str_replace("'",'',$$embupdateid);
						if($upid) $upid=$upid;else $upid=$id; 
				
							if ($q!=1) $dataSuppArr .=",";
							$dataSuppArr.="(".$idembSupp.",".$hidd_job_id.",".$update_id.",'".$upid."','".$sid."',$is_compleate,".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
							$idembSupp++; $q++;
	
					}
				}
			}
				
			if(str_replace("'",'',$$embupdateid)!="")
			{
                $id_arr[]=str_replace("'",'',$$embupdateid);
				$data_array_up[str_replace("'",'',$$embupdateid)] =explode("*",("".$update_id."*".$$cboembname."*".$$cboembtype."*".$$country."*".$$lastappidchk."*".$$cboembsupplierid."*".$$txtembconsdzngmts."*".$$txtembrate."*".$$txtembamount."*".$$embratelibid."*".$$empbudgeton."*".$is_synchronized."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*".$$cboembstatus."*0"));
				//	CONS break down===============================================================================================
				if(str_replace("'",'',$$consbreckdownwash) !='')
				{
					$consbreckdown= $$consbreckdownwash;
				}
				else
				{
					 //$consbreckdown="'".create_consbreak_down_emb($update_id,str_replace("'",'',$$txtembconsdzngmts),str_replace("'",'',$$txtembrate),str_replace("'",'',$$txtembamount))."'";
					$consbreckdown="";
				}

				if(str_replace("'",'',$consbreckdown) !='')
				{
					//echo "delete from wo_pre_cos_emb_co_avg_con_dtls where  pre_cost_emb_cost_dtls_id =".$$embupdateid."";
					$rID_de1=execute_query( "delete from wo_pre_cos_emb_co_avg_con_dtls where  pre_cost_emb_cost_dtls_id =".$$embupdateid."",0);
					$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
					$counter=0;
					for($c=0;$c < count($consbreckdown_array);$c++)
					{
						$counter++;
						$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
						//"id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id,item_number_id, color_number_id, size_number_id, requirment,rate,amount,color_size_table_id"
						//ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid;
						if ($add_comma!=0) $data_array1 .=",";
						$data_array1 .="(".$id1.",".$hidd_job_id.",".str_replace("'",'',$$embupdateid).",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."')";
	
						$id1=$id1+1;
						$add_comma++;
						if ($data_array1!="" && $counter==100)
						{
							//echo "insert into wo_pre_cos_emb_co_avg_con_dtls (".$field_array1.") values ".$data_array1;
							$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
							$counter=0;
							$data_array1="";
							$add_comma=0;
							if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
						}
					}
	
					if ($data_array1!="" && $counter!=100)
					{
						
						$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
						$counter=0;
						$data_array1="";
						$add_comma=0;
						if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
					}
				}
			   //CONS break down end===============================================================================================
			}
			if(str_replace("'",'',$$embupdateid)=="")
			{

				if ($add_co!=0) $data_array .=",";
				$data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$quotdtlsidemb.",".$$cboembname.",".$$cboembtype.",".$$country.",".$$cboembsupplierid.",".$$txtembconsdzngmts.",".$$txtembrate.",".$$txtembamount.",".$$embratelibid.",".$$empbudgeton.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cboembstatus.",0)";
				//	CONS break down===============================================================================================
				if(str_replace("'",'',$$consbreckdownwash) !='')
				 {
					$consbreckdown= $$consbreckdownwash;
				 }
				 else
				 {
					 $consbreckdown="'".create_consbreak_down_emb($update_id,str_replace("'",'',$$txtembconsdzngmts),str_replace("'",'',$$txtembrate),str_replace("'",'',$$txtembamount))."'";
					  //$consbreckdown="";
				 }
				if(str_replace("'",'',$consbreckdown) !='')
				{
					$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
					//$counter=0;
					for($c=0;$c < count($consbreckdown_array);$c++)
					{
						$counter++;
						$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
						//"id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id,item_number_id, color_number_id, size_number_id, requirment,rate,amount,color_size_table_id"
						//ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid;
						if ($add_comma!=0) $data_array1 .=",";
						$data_array1 .="(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."')";
	
						$id1=$id1+1;
						$add_comma++;
						if ($data_array1!="" && $counter==100)
						{
							$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
							$counter=0;
							$data_array1="";
							$add_comma=0;
							if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
						}
					}
					if ($data_array1!="" && $counter!=100)
					{
						$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
						$counter=0;
						$data_array1="";
						$add_comma=0;
						if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
					}
				}
			   //CONS break down end===============================================================================================
				$id=$id+1;
				$add_co++;
			}
		 }		 
		 $rID=execute_query(bulk_update_sql_statement( "wo_pre_cost_embe_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
		 //echo "10**".$data_array; die;
		 if($data_array !="")
		 {
		 	//echo "10**insert into wo_pre_cost_embe_cost_dtls (".$field_array.") values ".$data_array; die;
			 $rID1=sql_insert("wo_pre_cost_embe_cost_dtls",$field_array,$data_array,0);
		 }
		 //=======================supplier=================
		 
		if ($dataSuppArr!="")
		{
			//echo "10**delete from wo_pre_cost_fabric_supplier where job_id =".$hidd_job_id.""; die;
			$rID_de1=execute_query( "delete from wo_pre_cost_wash_supplier where job_id =".$hidd_job_id."",0);
			$rID_in2=sql_insert("wo_pre_cost_wash_supplier",$field_supp_arr,$dataSuppArr,1);
			//echo sql_insert("wo_pre_cost_emb_supplier",$field_supp_arr,$dataSuppArr,1);
			/*if($flag==1) 
			{
				if($rID_in2) $flag=1;else $flag=0;
			}*/
			if( $rID_in2 && $fail1==0) { $rID_in2=1;  } else { $rID_in2=0; $fail1=1; }
		}
		// For Sourcing 
		if($isconspopupupdateId_chk==1) //For Sourcing page 
		{
			execute_query( "update  wo_pre_cost_mst set sourcing_ready_to_approved=2  where  job_no =".$update_id."   ",1);//and sourcing_approved !=1
		}
		//====Sourcing post cost Sheet=====
		if(count($SourcingWashArr)>0) //Sourcing
		{
			foreach($SourcingWashArr as $poId=>$PoData)
				{
					foreach($PoData as $EmbId=>$embData)
					{
						foreach($embData as $sizeMstid=>$val)
						{
							$souring_amount=$val['amount'];
							$souring_rate=$val['rate'];
							$up_avg_rID=execute_query( "update  wo_pre_cos_emb_co_avg_con_dtls set sourcing_rate='".$souring_rate."',sourcing_amount='".$souring_amount."',sourcing_updated_by=".$_SESSION['logic_erp']['user_id'].",sourcing_update_date='".$pc_date_time."' where po_break_down_id =".$poId." and color_size_table_id =".$sizeMstid." and pre_cost_emb_cost_dtls_id =".$EmbId." and status_active=1  ",0);
							if($flag==1) 
							{
							if($up_avg_rID) $flag=1; else $flag=0;
							}
						}
					}
			}
		}
		//===============End Sourcing post cost Sheet=====
       // bulk_update_sql_statement( "wo_pre_cost_embe_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr );
		 //=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, emb_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtamountemb_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="emb_amount";
			$data_array2 ="".$txtamountemb_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		//=======================sum End =================
        check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "1**".$new_job_no[0]."**".$rID;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "1**".$new_job_no[0]."**".$rID;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		disconnect($con);
		die;
	}
}
//**************************************************************************Wash Cost End**********************************************
//*************************************************Commision Cost Start ***********************************************
if ($action=="show_commission_cost_listview")
{
	$data=explode("**",$data);
	$component_approved=0;$permission=$data[6];
	$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=5 and job_no='$data[0]'");
	foreach($sql as $row){
		if($row[csf('approved')]==1) { $component_approved=1; $approved_message="<marquee width='500'><p style='color:#f00; text-align:center;'> Approved</p></marquee>";}
	}

?>
<h3 align="left" class="accordion_h">+Commission Cost <? echo $approved_message; ?></h3>
       <div id="content_commission_cost" align="center">
    	<fieldset>
        	<form id="commission_8" autocomplete="off">
            	<table width="580" cellspacing="0" class="rpt_table" border="0" id="tbl_commission_cost" rules="all">
                	<thead>
                    	<tr>
                        	<th width="150">Particulars</th> <th width="100">Commn. Base</th> <th width="90">Commn Rate</th> <th width="110">Amount</th> <th width="">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                    <?
					$save_update=1;
					$approved=return_field_value("approved", "wo_pre_cost_mst", "job_no='$data[0]'");
					$quotation_id=return_field_value("quotation_id", "wo_po_details_master", "job_no='$data[0]'");
					if($approved==1 || $component_approved==1) $disabled=1; else $disabled=0;

					$data_array=sql_select("select id, job_no, particulars_id, commission_base_id, commision_rate,commission_amount,status_active from  wo_pre_cost_commiss_cost_dtls where job_no='$data[0]' and status_active=1 order by id");// quotation_id='$data'
					if(count($data_array)<1 && $data[2]==1)
					{
						$data_array=sql_select("select id, quotation_id, particulars_id, commission_base_id, commision_rate,commission_amount,status_active from  wo_pri_quo_commiss_cost_dtls where quotation_id='$data[1]' order by id");// quotation_id='$data'
						$save_update=0;
					}
					if(count($data_array)<1 && $data[2]==1 && $data[5]==4){
						$data_array=sql_select("select b.cost_sheet_id as quotation_id, 1 as particulars_id, 1 as commission_base_id, sum(b.comm_amount) as commission_amount, sum(a.commision_per) as commision_rate from qc_tot_cost_summary a, qc_confirm_dtls b where a.mst_id=b.cost_sheet_id and b.cost_sheet_id='$quotation_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.cost_sheet_id");
						$save_update=0;
					}
					if ( count($data_array)>0)
					{
						$i=0;
						foreach( $data_array as $row )
						{
							$i++;
							?>
                            <tr id="commissiontr_<?=$i; ?>" align="center">
                                <td><?=create_drop_down( "cboparticulars_".$i, 150, $commission_particulars, "",1," -- Select Item --", $row[csf("particulars_id")], "",$disabled,'' ); ?></td>
                                <td><?=create_drop_down( "cbocommissionbase_".$i, 100, $commission_base_array,"", 1, "-- Select --", $row[csf("commission_base_id")], "calculate_commission_cost(".$i.")",$disabled,"" ); ?></td>

                               	<td><input type="text" id="txtcommissionrate_<?=$i; ?>" name="txtcommissionrate_<?=$i; ?>" class="text_boxes_numeric" style="width:90px" value="<?=$row[csf("commision_rate")]; ?>" onChange="calculate_commission_cost(<?=$i; ?>);" <? if($disabled==0){echo "";}else{echo "disabled";}?> /></td>
                                <td><input type="text" id="txtcommissionamount_<?=$i; ?>" name="txtcommissionamount_<?=$i; ?>" class="text_boxes_numeric" style="width:110px" value="<?=$row[csf("commission_amount")]; ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> readonly /></td>
                                <td>
                                <?=create_drop_down("cbocommissionstatus_".$i, 95, $row_status,"", 0, "0", $row[csf("status_active")], '',$disabled,'' ); ?>
                                <input type="hidden" id="commissionupdateid_<?=$i; ?>" name="commissionupdateid_<?=$i; ?>"  class="text_boxes" style="width:20px" value="<?=$row[csf("id")]; ?>" />
                                </td>
                            </tr>
                            <?
						}
					}
					else
					{
						$save_update=0;
						?>
						<tr id="commissiontr_1" align="center">
                           <td><?=create_drop_down( "cboparticulars_1", 150, $commission_particulars, "",0,"", 1, '','','' ); ?></td>
                           <td><?=create_drop_down( "cbocommissionbase_1", 100, $commission_base_array,"", 1, "-- Select --","","calculate_commission_cost(1);","","" ); ?></td>
                           <td><input type="text" id="txtcommissionrate_1" name="txtcommissionrate_1" class="text_boxes_numeric" style="width:90px" value="" onChange="calculate_commission_cost(1);"/></td>
                           <td><input type="text" id="txtcommissionamount_1" name="txtcommissionamount_1" class="text_boxes_numeric" style="width:110px" value="" readonly /></td>
                           <td>
							   <?=create_drop_down( "cbocommissionstatus_1", 95, $row_status,"", 0, "0", '', '','','' );  ?>
                               <input type="hidden" id="commissionupdateid_1" name="commissionupdateid_1"  class="text_boxes" style="width:20px" value=""  />
                           </td>
                        </tr>
                        <tr id="commissiontr_2" align="center">
                           <td><?=create_drop_down( "cboparticulars_2", 150, $commission_particulars, "",0,"", 2, '','','' ); ?></td>
                           <td><?=create_drop_down( "cbocommissionbase_2", 100, $commission_base_array,"", 1, "-- Select --", "", "calculate_commission_cost(2)","","" ); ?></td>
                           <td><input type="text" id="txtcommissionrate_2" name="txtcommissionrate_2" class="text_boxes_numeric" style="width:90px" value="" onChange="calculate_commission_cost(2);"/></td>
                           <td><input type="text" id="txtcommissionamount_2" name="txtcommissionamount_2" class="text_boxes_numeric" style="width:110px" value="" /></td>
                           <td>
							   <?=create_drop_down( "cbocommissionstatus_2", 95, $row_status,"", 0, "0", '', '','','' );  ?>
                               <input type="hidden" id="commissionupdateid_2" name="commissionupdateid_2"  class="text_boxes" style="width:20px" value=""  />
                           </td>
                        </tr>
                    <?
					}
					?>
                </tbody>
            </table>
            <table width="580" cellspacing="0" class="rpt_table" border="0" rules="all">
                <tfoot>
                    <tr>
                        <th width="150" style="border:none"></th>
                        <th width="100" align="right" style="border:none">SUM</th>
                        <th width="90"><input type="text" id="txtratecommission_sum" name="txtratecommission_sum" class="text_boxes_numeric" style="width:90px" readonly /></th>
                        <th width="110"><input type="text" id="txtamountcommission_sum"  name="txtamountcommission_sum" class="text_boxes_numeric" style="width:110px" readonly /></th>
                        <th>&nbsp;</th>
                    </tr>
                </tfoot>
            </table>

            <table width="580" cellspacing="0" class="" border="0">
                <tr>
                    <td align="center" height="15" width="100%"> </td>
                </tr>
                <tr>
                    <td align="center" width="100%" class="button_container">
                    <?
                    if ( count($data_array)>0)
                    {
                    	echo load_submit_buttons( $permission, "fnc_commission_cost_dtls", $save_update,0,"reset_form('commission_8','','',0)",7) ;
                    }
                    else
                    {
                    	echo load_submit_buttons( $permission, "fnc_commission_cost_dtls", $save_update,0,"reset_form('commission_8','','',0)",7) ;
                    }
                    ?>
                    </td>
                </tr>
            </table>
        </form>
    </fieldset>
    </div>
	<?
	exit();
}

if ($action=="save_update_delet_commission_cost_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$sql=sql_select("select approval_need from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
	$app_nessity=2;
	foreach($sql as $row){
		$app_nessity=$row[csf('approval_need')];
	}

	$sql=sql_select("select approved from wo_price_quotation  where id=$txt_quotation_id");
	$quatation_approved=2;
	foreach($sql as $row){
		$quatation_approved=$row[csf('approved')];
	}

	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	//echo "10**",$is_copy_quatation."**". $app_nessity."**".$quatation_approved;
	//die;
	if($is_copy_quatation==1 && $app_nessity==1){
		if($quatation_approved==2 || $quatation_approved==0){
			echo "quataNotApp**".str_replace("'","",$txt_job_no);
			 disconnect($con);die;
		}
	}
	$component_approved=return_field_value("current_approval_status", "co_com_pre_costing_approval", "job_no=$update_id and cost_component_id=5");
	if($component_approved==3) $component_approved=1;
	
	$approved=0; $ready_to_approve=0;
	$sql=sql_select("select approved, ready_to_approved from wo_pre_cost_mst where job_no=$update_id and status_active=1 and is_deleted=0");
	foreach($sql as $row){
		//if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
		$approved=$row[csf('approved')];
		$ready_to_approve=$row[csf('ready_to_approved')];
	}
	if($approved==1 || $component_approved==1){
		echo "approved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($approved==3){
		echo "papproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($ready_to_approve==1){
		echo "readyapproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($operation==0)
	{
	    $con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		
		 if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0"; die;}
		 $id=return_next_id( "id", "wo_pre_cost_commiss_cost_dtls", 1 ) ;
		 $field_array="id, job_id, job_no, particulars_id, commission_base_id, commision_rate, commission_amount, inserted_by, insert_date, status_active, is_deleted ";
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cboparticulars="cboparticulars_".$i;
			 $cbocommissionbase="cbocommissionbase_".$i;
			 $txtcommissionrate="txtcommissionrate_".$i;
			 $txtcommissionamount="txtcommissionamount_".$i;
			 $cbocommissionstatus="cbocommissionstatus_".$i;
			 $commissionupdateid="commissionupdateid_".$i;
			if ($i!=1) $data_array .=",";
			$data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cboparticulars.",".$$cbocommissionbase.",".$$txtcommissionrate.",".$$txtcommissionamount.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbocommissionstatus.",0)";
			$id=$id+1;
		 }
		 $rID=sql_insert("wo_pre_cost_commiss_cost_dtls",$field_array,$data_array,0);
		 //=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, commis_rate, commis_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtratecommission_sum.",".$txtamountcommission_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="commis_rate*commis_amount";
			$data_array2 ="".$txtratecommission_sum."*".$txtamountcommission_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		//=======================sum End =================
		$tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name,$txtamountcommission_sum);
		check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "0**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "0**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		disconnect($con);
		die;
	}
	else if($operation==1)
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		
		 if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**1"; die;}
		 $field_array_up="particulars_id*commission_base_id*commision_rate*commission_amount*updated_by*update_date*status_active*is_deleted ";
		 $field_array="id, job_id, job_no, particulars_id, commission_base_id, commision_rate, commission_amount, inserted_by, insert_date, status_active, is_deleted ";
		 $add_comma=0;
		 $id=return_next_id( "id", "wo_pre_cost_commiss_cost_dtls", 1 ) ;
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cboparticulars="cboparticulars_".$i;
			 $cbocommissionbase="cbocommissionbase_".$i;
			 $txtcommissionrate="txtcommissionrate_".$i;
			 $txtcommissionamount="txtcommissionamount_".$i;
			 $cbocommissionstatus="cbocommissionstatus_".$i;
			 $commissionupdateid="commissionupdateid_".$i;
			if(str_replace("'",'',$$commissionupdateid)!="")
			{
				$id_arr[]=str_replace("'",'',$$commissionupdateid);
			    $data_array_up[str_replace("'",'',$$commissionupdateid)]=explode(",",("".$$cboparticulars.",".$$cbocommissionbase.",".$$txtcommissionrate.",".$$txtcommissionamount.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbocommissionstatus.",0"));
			}
			if(str_replace("'",'',$$commissionupdateid)=="")
			{
			    if ($add_comma!=0) $data_array .=",";
			    $data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cboparticulars.",".$$cbocommissionbase.",".$$txtcommissionrate.",".$$txtcommissionamount.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbocommissionstatus.",0)";
			    $id=$id+1;
				$add_comma++;
			}
		 }
         $rID=execute_query(bulk_update_sql_statement( "wo_pre_cost_commiss_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
		 if($data_array !="")
		 {
			 $rID=sql_insert("wo_pre_cost_commiss_cost_dtls",$field_array,$data_array,0);
		 }
 		 //=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, commis_rate, commis_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtratecommission_sum.",".$txtamountcommission_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="commis_rate*commis_amount";
			$data_array2 ="".$txtratecommission_sum."*".$txtamountcommission_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		//=======================sum End =================
		$tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);


		check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{

			if($rID ){
				mysql_query("COMMIT");
				echo "1**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "1**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		disconnect($con);
		die;
	}
}

//*************************************************Commision Cost End ***********************************************
//*************************************************Comarcial Cost Start ***********************************************

if ($action=="curreir_cost_method")
{
	$data=explode("_",$data);
	$job_no=$data[0];
	$company_id=$data[1];
	$fabric_pre_cost=$data[2];
	$price_dzn=$data[3];
	$commission_pre_cost=$data[4];

	$sql_job=sql_select("select BUYER_NAME, BRAND_ID from WO_PO_DETAILS_MASTER where job_no='$job_no'");
	
	$buyerid=$sql_job[0]["BUYER_NAME"];
	$brandid=$sql_job[0]["BRAND_ID"];
	
	$currier_result=sql_select("select commercial_cost_method, commercial_cost_percent, editable, copy_quotation as based_on from variable_order_tracking where company_name=".$company_id."  and variable_list=57 and tna_integrated='$buyerid' and profit_calculative='$brandid' and status_active=1 and is_deleted=0");
	if(count($currier_result)<1)
	{
		$currier_result=sql_select("select commercial_cost_method, commercial_cost_percent, editable, copy_quotation as based_on from variable_order_tracking where company_name=".$company_id."  and variable_list=57 and tna_integrated='$buyerid' and profit_calculative='0' and status_active=1 and is_deleted=0");
	}
	if(count($currier_result)<1)
	{
		$currier_result=sql_select("select commercial_cost_method, commercial_cost_percent, editable from variable_order_tracking where company_name=".$company_id."  and variable_list=57 and status_active=1 and is_deleted=0");
	}
	//$currier_result=sql_select($sql_currier_data);
	foreach($currier_result as $row)
	{
		$currier_cost_percent=0; $currier_cost_method=1;
		if($row[csf("based_on")]==2) $fixamount=$row[csf("commercial_cost_percent")]; 
		else 
		{
			$fixamount=0;
			$currier_cost_method=$row[csf("commercial_cost_method")];
			if($currier_cost_method=="" || $currier_cost_method==0) $currier_cost_percent=1; else $currier_cost_percent=$currier_cost_percent;
			$currier_cost_percent=$row[csf("commercial_cost_percent")];
			if($currier_cost_percent=="" || $currier_cost_percent==0) $currier_cost_percent=0; else  $currier_cost_percent=$currier_cost_percent;
		}

		$editable=$row[csf("editable")];
		$based_on=$row[csf("based_on")];
		//if($editable)
	}

   $fob_value=$price_dzn-$commission_pre_cost;
   $amount=0;
	if($currier_cost_method==1)
	{
		$data_array=sql_select("select (fab_amount+yarn_amount+trim_amount) as amount from wo_pre_cost_sum_dtls where job_no='$job_no' and status_active=1 and is_deleted=0");
		foreach( $data_array as $row )
		{
			$amount=def_number_format($row[csf("amount")],5,"");
		}
	}
	if($currier_cost_method==2)
	{
		$amount=def_number_format($price_dzn,5,"");
	}
	if($currier_cost_method==3) //On Net Selling
	{
		$amount=def_number_format($fob_value,5,"");
	}
	$currier_amount=def_number_format(($amount*($currier_cost_percent/100)),5,"");
	echo $currier_cost_method.'**'.$currier_amount.'**'.$editable.'**'.$based_on.'**'.$fixamount;
	exit();
} //Currier Cost Method end

if($action == 'commercial_cost_method_value')
{
	$ex_data=explode("_",$data);
	$fab_amount=0;
	$sql_fab=sql_select("SELECT sum(amount) as amount from wo_pre_cost_fabric_cost_dtls WHERE job_no='$ex_data[0]' and fabric_source=2 and status_active=1 and is_deleted=0");
	if(count($sql_fab) > 0){
		$fab_amount = $sql_fab[0][csf('amount')];
	}
	$pre_cost_dtls = sql_select("SELECT fabric_cost, trims_cost, embel_cost, wash_cost, lab_test, inspection, cm_cost, freight, currier_pre_cost, certificate_pre_cost, design_cost, studio_cost, common_oh from wo_pre_cost_dtls WHERE job_no='$ex_data[0]' ");
	foreach ($pre_cost_dtls as $row) {
		if($ex_data[1]==5)
		{
			$other_amount = $row[csf('trims_cost')] + $row[csf('embel_cost')] + $row[csf('wash_cost')] + $row[csf('lab_test')] +$row[csf('inspection')] + $row[csf('cm_cost')] + $row[csf('freight')] + $row[csf('currier_pre_cost')] + $row[csf('certificate_pre_cost')] + $row[csf('design_cost')] + $row[csf('studio_cost')] + $row[csf('common_oh')];
		}
		else if ($ex_data[1]==6)
		{
			$other_amount = $row[csf('trims_cost')] + $row[csf('embel_cost')] + $row[csf('wash_cost')] + $row[csf('lab_test')] +$row[csf('inspection')] + $row[csf('freight')] + $row[csf('currier_pre_cost')] + $row[csf('certificate_pre_cost')] + $row[csf('design_cost')] + $row[csf('studio_cost')] + $row[csf('common_oh')];
		}
		else if ($ex_data[1]==7)
		{
			$other_amount = $row[csf('fabric_cost')] +$row[csf('trims_cost')] + $row[csf('embel_cost')] + $row[csf('wash_cost')] + $row[csf('lab_test')] +$row[csf('inspection')] + $row[csf('freight')] + $row[csf('currier_pre_cost')] + $row[csf('certificate_pre_cost')] + $row[csf('design_cost')] + $row[csf('studio_cost')] + $row[csf('common_oh')];
		}
		else if ($ex_data[1]==9)
		{
			$other_amount = $row[csf('fabric_cost')] +$row[csf('trims_cost')] + $row[csf('embel_cost')] + $row[csf('wash_cost')];
		}
	}
	if ($ex_data[1]==7 || $ex_data[1]==9) $total_amount = $other_amount;
	else $total_amount = $fab_amount + $other_amount;
	$amount=def_number_format($total_amount,5,"");
	echo $amount;
	exit;
}

if ($action=="show_comarcial_cost_listview")
{
	$data=explode("**",$data);
	
	$permission=$data[6];
	
	$sql_job=sql_select("select BUYER_NAME, BRAND_ID from WO_PO_DETAILS_MASTER where job_no='$data[0]'");
	
	$buyerid=$sql_job[0]["BUYER_NAME"];
	$brandid=$sql_job[0]["BRAND_ID"];
	
	if($brandid==0 || $brandid=="") $brandCond="and profit_calculative='0'"; else $brandCond="and profit_calculative='$brandid'";
	
	$commercial_cost_methodSql=sql_select("select commercial_cost_method, commercial_cost_percent, editable from variable_order_tracking where company_name=".$data[3]."  and variable_list=27 and tna_integrated='$buyerid' $brandCond and status_active=1 and is_deleted=0");
	
	if(count($commercial_cost_methodSql)<1)
	{
		$commercial_cost_methodSql=sql_select("select commercial_cost_method, commercial_cost_percent, editable from variable_order_tracking where company_name=".$data[3]."  and variable_list=27 and tna_integrated='$buyerid' and profit_calculative='0' and status_active=1 and is_deleted=0");
		//echo "select commercial_cost_method, commercial_cost_percent, editable from variable_order_tracking where company_name=".$data[3]."  and variable_list=27 and tna_integrated='$buyerid' and profit_calculative='0' and status_active=1 and is_deleted=0";
	}
	if(count($commercial_cost_methodSql)<1)
	{
		$commercial_cost_methodSql=sql_select("select commercial_cost_method, commercial_cost_percent, editable from variable_order_tracking where company_name=".$data[3]."  and variable_list=27 and tna_integrated='0' and profit_calculative='0' and status_active=1 and is_deleted=0");
	}
	
	$commercial_cost_method=1; $commercial_cost_percent=0; $editable=0;
	foreach( $commercial_cost_methodSql as $row )
	{
		if($row[csf("commercial_cost_method")]>0) $commercial_cost_method=$row[csf("commercial_cost_method")];
		if($row[csf("commercial_cost_percent")]>0) $commercial_cost_percent=$row[csf("commercial_cost_percent")];
		if($row[csf("editable")]>0) $editable=$row[csf("editable")];
	}
	
	$otherVariableSql=sql_select("select variable_list, copy_quotation, cost_control_source, commercial_cost_method, commercial_cost_percent, editable from variable_order_tracking where company_name=".$data[3]."  and variable_list in(20,53) and status_active=1 and is_deleted=0");
	 $copy_quotation=0; $cost_control_source=0;
	foreach( $otherVariableSql as $row )
	{
		if($row[csf('variable_list')]==20){
			if($row[csf("copy_quotation")]>0) $copy_quotation=$row[csf("copy_quotation")];
		}
		if($row[csf('variable_list')]==53){
			if($row[csf("cost_control_source")]>0) $cost_control_source=$row[csf("cost_control_source")];
		}		
	}

	$price_dzn=$data[4];
	$fob_value=$data[4]-$data[5];
	$amount=0;
	if($commercial_cost_method==1)
	{
		$data_array=sql_select("select (fab_amount+yarn_amount+trim_amount) as amount from wo_pre_cost_sum_dtls where job_no='$data[0]' and status_active=1 and is_deleted=0");
		foreach( $data_array as $row )
		{
			$amount=def_number_format($row[csf("amount")],8,"");
		}
	}
	else if($commercial_cost_method==2) $amount=def_number_format($price_dzn,8,"");
	else if($commercial_cost_method==3) $amount=def_number_format($fob_value,8,"");
	else if($commercial_cost_method == 5 || $commercial_cost_method == 6 || $commercial_cost_method == 7 || $commercial_cost_method == 9){
		$fab_amount=0;
		$sql_fab=sql_select("SELECT sum(amount) as amount from wo_pre_cost_fabric_cost_dtls WHERE job_no='$data[0]' and fabric_source=2 and status_active=1 and is_deleted=0");
		if(count($sql_fab) > 0){
			$fab_amount = $sql_fab[0][csf('amount')];
		}
		$pre_cost_dtls = sql_select("SELECT fabric_cost, trims_cost, embel_cost, wash_cost, lab_test, inspection, cm_cost, freight, currier_pre_cost, certificate_pre_cost, design_cost, studio_cost, common_oh from wo_pre_cost_dtls WHERE job_no='$data[0]' ");
		foreach ($pre_cost_dtls as $row) {
			if($commercial_cost_method == 5)
			{
				$other_amount = $row[csf('trims_cost')] + $row[csf('embel_cost')] + $row[csf('wash_cost')] + $row[csf('lab_test')] +$row[csf('inspection')] + $row[csf('cm_cost')] + $row[csf('freight')] + $row[csf('currier_pre_cost')] + $row[csf('certificate_pre_cost')] + $row[csf('design_cost')] + $row[csf('studio_cost')] + $row[csf('common_oh')];
			}
			else if($commercial_cost_method == 6)
			{
				$other_amount = $row[csf('trims_cost')] + $row[csf('embel_cost')] + $row[csf('wash_cost')] + $row[csf('lab_test')] +$row[csf('inspection')] + $row[csf('freight')] + $row[csf('currier_pre_cost')] + $row[csf('certificate_pre_cost')] + $row[csf('design_cost')] + $row[csf('studio_cost')] + $row[csf('common_oh')];
			}
			else if($commercial_cost_method == 7)
			{
				$other_amount = $row[csf('fabric_cost')] +$row[csf('trims_cost')] + $row[csf('embel_cost')] + $row[csf('wash_cost')] + $row[csf('lab_test')] +$row[csf('inspection')] + $row[csf('freight')] + $row[csf('currier_pre_cost')] + $row[csf('certificate_pre_cost')] + $row[csf('design_cost')] + $row[csf('studio_cost')] + $row[csf('common_oh')];
			}
			else if($commercial_cost_method == 9)
			{
				$other_amount = $row[csf('fabric_cost')] +$row[csf('trims_cost')] + $row[csf('embel_cost')] + $row[csf('wash_cost')];
			}
		}
		if($commercial_cost_method == 7 || $commercial_cost_method == 9) $total_amount = $other_amount;
		else $total_amount = $fab_amount + $other_amount;
		$amount=def_number_format($total_amount,8,"");
		//echo $amount;
	}

	$com_amount=def_number_format(($amount*($commercial_cost_percent/100)),8,"");
		//echo $com_amount;
	//echo $commercial_cost_method.'=='.$com_amount;

	$component_approved=0;
	$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=6 and job_no='$data[0]'");
	foreach($sql as $row){
		if($row[csf('approved')]==1 || $row[csf('approved')]==3) { $component_approved=1; $approved_message="<marquee width='500'><p style='color:#f00; text-align:center;'> Approved</p></marquee>";}
	}

?>
<h3 align="left" class="accordion_h" >+Commercial Cost <?=$approved_message; ?></h3>
       <div id="content_comarcial_cost">
    	<fieldset>
        	<form id="comarcial_9" autocomplete="off">
            <input type="hidden" id="txt_commercial_cost_method" value="<?=$commercial_cost_method;?>"/>
            	<table width="540" cellspacing="0" class="rpt_table" border="0" id="tbl_comarcial_cost" rules="all">
                	<thead>
                    	<tr>
                        	<th width="150">Item</th><th width="90"> Rate In %</th><th width="110">Amount</th><!-- <th width="95">Status</th> --><th width=""></th>
                        </tr>
                    </thead>
                    <tbody id="commercial_tbl_dtls_for">
                    <?
					$save_update=1;
					$approved=return_field_value("approved", "wo_pre_cost_mst", "job_no='$data[0]'");
					$quotation_id=return_field_value("quotation_id", "wo_po_details_master", "job_no='$data[0]'");
					if($approved==3){
						$approved=1;
					}
					if($approved==1 || $component_approved==1) $disabled=1; else $disabled=0;

					if($editable==1) $readonly=0; else $readonly=1	;

					$data_array=sql_select("select id, job_no, item_id, rate,amount,status_active from  wo_pre_cost_comarci_cost_dtls where job_no='$data[0]'  and  status_active!=0 order by id");
					if(count($data_array)<1 && $data[2]==1)
					{
						$data_array=sql_select("select id, quotation_id, item_id, rate,amount,status_active from  wo_pri_quo_comarcial_cost_dtls where quotation_id='$data[1]' order by id");
						$save_update=0;
					}
					//echo $copy_quotation.'--'.$cost_control_source; die;
					if(count($data_array)<1 && $copy_quotation==1 && $cost_control_source==4 && ($commercial_cost_percent*1)==0){
						$data_array=sql_select("select  b.cost_sheet_id as quotation_id, 4 as item_id, sum(a.commercial_per) as rate, sum(b.commercial_cost) as amount from  qc_tot_cost_summary a, qc_confirm_dtls b where a.mst_id=b.cost_sheet_id and b.cost_sheet_id='$quotation_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.cost_sheet_id");
						//echo "select  b.cost_sheet_id as quotation_id, 4 as item_id, sum(a.commercial_per) as rate, sum(b.commercial_cost) as amount from  qc_tot_cost_summary a, qc_confirm_dtls b where a.mst_id=b.cost_sheet_id and b.cost_sheet_id='$quotation_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.cost_sheet_id";
						$save_update=0;
					}
					if(count($data_array)>0)
					{
						$i=0;
						foreach( $data_array as $row )
						{
							$i++;
							//if($save_update==0 && ($commercial_cost_percent*1)>0) $row[csf("rate")]=$commercial_cost_percent;
							?>
                            <tr id="comarcialtr_<?=$i; ?>" align="center">
                               <td><?=create_drop_down( "cboitem_".$i, 150, $camarcial_items, "",1," -- Select Item --", $row[csf("item_id")], "",$disabled,'' ); ?></td>
                               <td><input type="text" id="txtcomarcialrate_<?=$i; ?>" name="txtcomarcialrate_<?=$i; ?>" class="text_boxes_numeric" style="width:90px" value="<?=$row[csf("rate")]; ?>" onChange="calculate_comarcial_cost(<?=$i;?>,'cal_amount');" <? if($disabled==0){echo "";}else{echo "disabled";}?> <? if($readonly==0){echo "";}else{echo "readonly";}?> /></td>
                               <td><input type="text" id="txtcomarcialamount_<?=$i; ?>" name="txtcomarcialamount_<?=$i; ?>" class="text_boxes_numeric" style="width:110px" value="<?=$row[csf("amount")]; ?>" onChange="calculate_comarcial_cost(<?=$i;?>,'cal_rate');" <? if($disabled==0){echo "";}else{echo "disabled";}?>  <? if($readonly==0){echo "";}else{echo "readonly";}?> /></td>
                               <td style="display: none"><?=create_drop_down( "cbocomarcialstatus_".$i, 95, $row_status,"", 0, "0", $row[csf("status_active")], '',$disabled,'' );  ?></td>
                               <td>
                                   <input type="button" id="synchronize_<?=$i; ?>" style="width:80px" class="formbutton" value="Syn. Amount" onClick="calculate_comarcial_cost(<?=$i; ?>,'cal_amount');" />
                                   <input type="button" id="increasecomarcial_<?=$i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_comarcial_cost(<?=$i; ?>);" <? if($disabled==0){echo "";}else{echo "disabled";}?> />
                                   <input type="button" id="decreasecomarcial_<?=$i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<?=$i; ?>,'tbl_comarcial_cost',this);" <? if($disabled==0){echo "";}else{echo "disabled";}?>/>
                                   <input type="hidden" id="comarcialupdateid_<?=$i; ?>" name="comarcialupdateid_<?=$i; ?>"  class="text_boxes" style="width:20px" value="<?=$row[csf("id")]; ?>"  />
                               </td>
                           </tr>
                           <?
						}
					}
					else
					{
						$save_update=0;
						//echo $com_amount; die;
						?>
						<tr id="comarcialtr_1" align="center">
                           <td><?=create_drop_down( "cboitem_1", 150, $camarcial_items, "",0,"", 4, '','','' ); ?></td>
                           <td><input type="text" id="txtcomarcialrate_1"  name="txtcomarcialrate_1" class="text_boxes_numeric" style="width:90px" onChange="calculate_comarcial_cost(1,'cal_amount');" value="<? echo $commercial_cost_percent; ?>" <? if($readonly==0){echo "";}else{echo "readonly";}?> /></td>
                            <td><input type="text" id="txtcomarcialamount_1"  name="txtcomarcialamount_1" class="text_boxes_numeric" style="width:110px" onChange="calculate_comarcial_cost(1,'cal_rate');" value="<? echo $com_amount; ?>" <? if($readonly==0){echo "";}else{echo "readonly";}?> /></td>

                            <td width="95" style="display: none"><?=create_drop_down( "cbocomarcialstatus_1", 95, $row_status,"", 0, "0", '', '','','' );  ?></td>
                            <td>
                                <input type="button" id="synchronize_1" style="width:80px" class="formbutton" value="Syn. Amount" onClick="calculate_comarcial_cost(1,'cal_amount')" />
                                <input type="button" id="increasecomarcial_1" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_comarcial_cost(1 )" />
                                <input type="button" id="decreasecomarcial_1" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(1 ,'tbl_comarcial_cost',this);" />
                                <input type="hidden" id="comarcialupdateid_1" name="comarcialupdateid_1"  class="text_boxes" style="width:20px" value=""  />
                            </td>
                        </tr>
                    	<?
					}
					?>
                </tbody>
            </table>
            <table width="540" cellspacing="0" class="rpt_table" border="0" rules="all">
                <tfoot>
                    <tr>
                        <th width="150">Sum</th>
                        <th width="90"><input type="text" id="txtratecomarcial_sum" name="txtratecomarcial_sum" class="text_boxes_numeric" style="width:90px" readonly /></th>
                        <th width="110"><input type="text" id="txtamountcomarcial_sum" name="txtamountcomarcial_sum" class="text_boxes_numeric" style="width:110px" readonly /></th>
                        <th width="95" style="border:none"></th>
                        <th width="" style="border:none"></th>
                    </tr>
                </tfoot>
            </table>
            <table width="540" cellspacing="0" class="" border="0">
                <tr>
                    <td align="center" height="15" width="100%"> </td>
                </tr>
                <tr>
                    <td align="center" width="100%" class="button_container">
                    <?
                    if(count($data_array)>0)
                    {
                        echo load_submit_buttons( $permission, "fnc_comarcial_cost_dtls", $save_update,0,"fnc_commer_resetFrom()",9) ;
                    }
                    else
                    {
                        echo load_submit_buttons( $permission, "fnc_comarcial_cost_dtls", $save_update,0,"fnc_commer_resetFrom()",9) ;
                    }
                    ?>
                    </td>
                </tr>
            </table>
            </form>
        </fieldset>
        </div>
	<?
	exit();
}

if($action=="sum_fab_yarn_trim_value")
{
	$amount=0;
	$data_array=sql_select("select (fab_amount+yarn_amount+trim_amount) as amount from wo_pre_cost_sum_dtls where job_no ='$data' and status_active=1 and is_deleted=0");
	foreach( $data_array as $row )
	{
		$amount=$row[csf("amount")];
	}
	echo $amount;
	die;
}

if ($action=="save_update_delet_comarcial_cost_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$sql=sql_select("select approval_need from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
	$app_nessity=2;
	foreach($sql as $row){
		$app_nessity=$row[csf('approval_need')];
	}

	$sql=sql_select("select approved from wo_price_quotation  where id=$txt_quotation_id");
	$quatation_approved=2;
	foreach($sql as $row){
		$quatation_approved=$row[csf('approved')];
	}

	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	//echo "10**",$is_copy_quatation."**". $app_nessity."**".$quatation_approved;
	//die;
	if($is_copy_quatation==1 && $app_nessity==1){
		if($quatation_approved==2 || $quatation_approved==0){
			echo "quataNotApp**".str_replace("'","",$txt_job_no);
			 disconnect($con);die;
		}
	}
	$component_approved=return_field_value("current_approval_status", "co_com_pre_costing_approval", "job_no=$update_id and cost_component_id=6");
	if($component_approved==3) $component_approved=1;
	
	$approved=0; $ready_to_approve=0;
	$sql=sql_select("select approved, ready_to_approved from wo_pre_cost_mst where job_no=$update_id and status_active=1 and is_deleted=0");
	foreach($sql as $row){
		//if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
		$approved=$row[csf('approved')];
		$ready_to_approve=$row[csf('ready_to_approved')];
	}
	if($approved==1 || $component_approved==1){
		echo "approved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($approved==3){
		echo "papproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($ready_to_approve==1){
		echo "readyapproved**".str_replace("'","",$update_id);
		disconnect($con);die;
	}
	if($operation==0)
	{
	    $con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		$approved=0;
			$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$update_id");
			foreach($sql as $row){
				$approved=$row[csf('approved')];
			}
			if($approved==1){
				echo "approved**".str_replace("'","",$update_id);
				 disconnect($con);die;
			}

		 if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0"; die;}
		 $id=return_next_id( "id", "wo_pre_cost_comarci_cost_dtls", 1 ) ;
		 $field_array="id, job_id, job_no, item_id, rate, amount, inserted_by, insert_date, status_active, is_deleted ";
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cboitem="cboitem_".$i;
			 $txtcomarcialrate="txtcomarcialrate_".$i;
			 $txtcomarcialamount="txtcomarcialamount_".$i;
			 $cbocomarcialstatus="cbocomarcialstatus_".$i;
			 $comarcialupdateid="comarcialupdateid_".$i;
			 if ($i!=1) $data_array .=",";
			 $data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cboitem.",".$$txtcomarcialrate.",".$$txtcomarcialamount.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbocomarcialstatus.",0)";
			 $id=$id+1;
		 }
		 $rID=sql_insert("wo_pre_cost_comarci_cost_dtls",$field_array,$data_array,0);
		 //=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, comar_rate, comar_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtratecomarcial_sum.",".$txtamountcomarcial_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="comar_rate*comar_amount";
			$data_array2 ="".$txtratecomarcial_sum."*".$txtamountcomarcial_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		//=======================sum End =================
		check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID )
			{
				mysql_query("COMMIT");
				echo "0**".$new_job_no[0]."**".$rID;
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID )
			{
				oci_commit($con);
				echo "0**".$new_job_no[0]."**".$rID;
			}
			else
			{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		disconnect($con);
		die;
	}
	else if($operation==1)
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		$component_approved=return_field_value("current_approval_status", "co_com_pre_costing_approval", "job_no=$update_id and cost_component_id=6");
		$approved=0;
		$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$update_id");
		foreach($sql as $row){
			$approved=$row[csf('approved')];
		}
		if($approved==1 || $approved==3 ||$component_approved==1){
			echo "approved**".str_replace("'","",$update_id);
			 disconnect($con);die;
		}
		 if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**1"; die;}
		 $field_array_up="item_id*rate*amount*updated_by*update_date*status_active*is_deleted ";
		 $field_array="id, job_id, job_no, item_id, rate, amount, inserted_by, insert_date, status_active, is_deleted ";
		 $add_comma=0;
		 $id=return_next_id( "id", "wo_pre_cost_comarci_cost_dtls", 1 ) ;
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cboitem="cboitem_".$i;
			 $txtcomarcialrate="txtcomarcialrate_".$i;
			 $txtcomarcialamount="txtcomarcialamount_".$i;
			 $cbocomarcialstatus="cbocomarcialstatus_".$i;
			 $comarcialupdateid="comarcialupdateid_".$i;
			if(str_replace("'",'',$$comarcialupdateid)!="")
			{
				$id_arr[]=str_replace("'",'',$$comarcialupdateid);
			    $data_array_up[str_replace("'",'',$$comarcialupdateid)] =explode(",",("".$$cboitem.",".$$txtcomarcialrate.",".$$txtcomarcialamount.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbocomarcialstatus.",0"));
			}
			if(str_replace("'",'',$$comarcialupdateid)=="")
			{
			    if ($add_comma!=0) $data_array .=",";
			    $data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cboitem.",".$$txtcomarcialrate.",".$$txtcomarcialamount.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbocomarcialstatus.",0)";
			    $id=$id+1;
			    $add_comma++;
			}
		 }
         $rID=execute_query(bulk_update_sql_statement( "wo_pre_cost_comarci_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
		 if($data_array !="")
		 {
			 $rID=sql_insert("wo_pre_cost_comarci_cost_dtls",$field_array,$data_array,0);
		 }
 		 //=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, comar_rate, comar_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtratecomarcial_sum.",".$txtamountcomarcial_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="comar_rate*comar_amount";
			$data_array2 ="".$txtratecomarcial_sum."*".$txtamountcomarcial_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		//=======================sum End =================
		check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID )
			{
				mysql_query("COMMIT");
				echo "1**".$new_job_no[0]."**".$rID;
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID )
			{
				oci_commit($con);
				echo "1**".$new_job_no[0]."**".$rID;
			}
			else
			{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		disconnect($con);
		die;
	}
}

if($action=="budgete_cost_validate")
{
	$exData=explode("_",$data);
	$cost_sheet_id=$exData[0];
	$jobNo=$exData[1];
	$str_data="";
	$qc_no=0;
	/*if($jobNo!="")
	{
		//echo "select b.qc_no from wo_po_details_master a, qc_mst b where a.job_no='$jobNo' and a.inquiry_id=b.inquery_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.inquiry_id<>0";
		$qc_noSql=sql_select("select b.qc_no from wo_po_details_master a, qc_mst b where a.job_no='$jobNo' and a.inquiry_id=b.inquery_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.inquiry_id<>0");
		$qc_no=$qc_noSql[0][csf('qc_no')];
	}*/
	$qc_no=$cost_sheet_id;	
	if($qc_no*1!=0)
	{
		$sql="select fab_cons_kg, fab_cons_yds, fab_amount, sp_oparation_amount, acc_amount, fright_amount, lab_amount, inspection_cost, operating_exp, other_amount, commercial_cost, lc_cost, comm_amount, fob_amount, cm_amount, courier_amount, wash_amount, rmg_ratio from qc_confirm_dtls where cost_sheet_id='$qc_no' and status_active=1 and is_deleted=0";
		$dataArr=sql_select($sql);
		$fab_cons_kg=$fab_cons_yds=$fab_amount=$sp_oparation_amount=$acc_amount=$fright_amount=$lab_amount=$inspection_amount=$other_amount=$commercial_cost=$comm_amount=$fob_amount=$cm_amount=$courier_amount=$wash_amount=$dlc_amount=$operating_amount=$rmg_ratio=0;

		foreach($dataArr as $row)
		{
			$fab_cons_kg+=$row[csf("fab_cons_kg")];
			$fab_cons_yds+=$row[csf("fab_cons_yds")];
			$fab_amount+=$row[csf("fab_amount")];
			$sp_oparation_amount+=$row[csf("sp_oparation_amount")];
			$acc_amount+=$row[csf("acc_amount")];
			$fright_amount+=$row[csf("fright_amount")];
			$lab_amount+=$row[csf("lab_amount")];
			$inspection_amount+=$row[csf("inspection_cost")];
			$other_amount+=$row[csf("other_amount")];
			$commercial_cost+=$row[csf("commercial_cost")];
			$comm_amount+=$row[csf("comm_amount")];
			$fob_amount+=$row[csf("fob_amount")];
			$cm_amount+=$row[csf("cm_amount")];
			$courier_amount+=$row[csf("courier_amount")];
			$rmg_ratio+=$row[csf("rmg_ratio")];
			$wash_amount+=$row[csf("wash_amount")];
			$dlc_amount+=$row[csf("lc_cost")];
			$operating_amount+=$row[csf("operating_exp")];
		}
		$str_data=number_format($fab_cons_kg,4)."##".number_format($fab_cons_yds,4)."##".number_format($fab_amount,4)."##".number_format($sp_oparation_amount,4)."##".number_format($acc_amount,4)."##".number_format($fright_amount,4)."##".number_format($lab_amount,4)."##".number_format($inspection_amount,4)."##".number_format($other_amount,4)."##".number_format($comm_amount,4)."##".number_format($fob_amount,4)."##".number_format($cm_amount,4)."##".number_format($rmg_ratio,4)."##".number_format($courier_amount,4)."##".number_format($wash_amount,4)."##".number_format($commercial_cost,4)."##".number_format($dlc_amount,4)."##".number_format($operating_amount,4);
	}
	echo $str_data;
	exit();
}

if($action=="cost_control_source")
{
	$company_id=$data;
	$cost_control_source=0;
	if($company_id!=0)
	{
		$sql="select id, cost_control_source from variable_order_tracking where company_name='$company_id' and variable_list=53 order by id";
		$dataArr=sql_select($sql);
		$cost_control_source=$dataArr[0][csf('cost_control_source')];
	}
	echo $cost_control_source;
	exit();
}

if ($action == "supplier_name")
{
	$sql = "select c.id, c.supplier_name as label from lib_supplier_tag_company a, lib_supplier_party_type b, lib_supplier c where c.id=b.supplier_id and a.supplier_id = b.supplier_id and a.tag_company='$data' and b.party_type =23 and c.status_active=1 and c.is_deleted=0 group by c.id, c.supplier_name order by supplier_name";
	$result = sql_select($sql);
	$supplierArr = array();
	foreach($result as $key => $val){
		$supplierArr[$key]["id"]=$val[csf("id")];
		$supplierArr[$key]["label"]=$val[csf("label")];
	}
	echo json_encode($supplierArr);
    exit();
}

if($action=="validate_is_booking_create")
{
	$exdata=explode("__", $data);
	$upid=$exdata[0]; $booking_type=$exdata[1];
	$amount=0;
	$data_array=sql_select("select booking_no from wo_booking_dtls where pre_cost_fabric_cost_dtls_id ='$upid' and booking_type='$booking_type' and status_active=1 and is_deleted=0 group by booking_no");
	$booking_no='';
	foreach( $data_array as $row )
	{
		if($booking_no=="") $booking_no=$row[csf("booking_no")]; else $booking_no.=', '.$row[csf("booking_no")];
	}

	if (count($data_array)>0) echo "1***".$booking_no; else echo "0***".$booking_no;
	die;
}

if ($action=="unapp_request_popup")
{
	$menu_id=$_SESSION['menu_id'];
	$user_id=$_SESSION['logic_erp']['user_id'];

	echo load_html_head_contents("Un Approval Request","../../../", 1, 1, $unicode);
	extract($_REQUEST);

	$data_all=explode('_',$data);
	$job_no=$data_all[0];
	$unapp_request=$data_all[1];

	$precost_id=return_field_value("id", "wo_pre_cost_mst", "job_no='$job_no' and status_active=1 and is_deleted=0");

	if($unapp_request=="")
	{
		$sql_request="select MAX(id) as id from fabric_booking_approval_cause where entry_form=46 and user_id='$user_id' and booking_id='$precost_id' and approval_type=2 and status_active=1 and is_deleted=0";//page_id='$menu_id' and

		$nameArray_request=sql_select($sql_request);
		foreach($nameArray_request as $row)
		{
			$unapp_request=return_field_value("approval_cause", "fabric_booking_approval_cause", "id='".$row[csf('id')]."' and status_active=1 and is_deleted=0");
		}
	}
	?>
    <script>

		$( document ).ready(function() {
			document.getElementById("unappv_request").value='<? echo preg_replace('/[\r\n]+/','\n',$unapp_request); ?>';
		});

		var permission='<? echo $permission; ?>';

		function fnc_appv_entry(operation)
		{
			var unappv_request = $('#unappv_request').val();

			if (form_validation('unappv_request','Un Approval Request')==false)
			{
				if (unappv_request=='')
				{
					alert("Please write request.");
				}
				return;
			}
			else
			{

				var data="action=save_update_delete_unappv_request&operation="+operation+get_submitted_data_string('unappv_request*precost_id*page_id*user_id',"../../../");
				//alert (data);return;
				freeze_window(operation);
				http.open("POST","pre_cost_entry_controller_v2.php",true);
				http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
				http.send(data);
				http.onreadystatechange=fnc_appv_entry_Reply_info;
			}
		}

		function fnc_appv_entry_Reply_info()
		{
			if(http.readyState == 4)
			{


				var reponse=trim(http.responseText).split('**');
				show_msg(reponse[0]);

				set_button_status(1, permission, 'fnc_appv_entry',1);
				release_freezing();

				var returnValue=return_global_ajax_value(reponse[2], 'weven_gmts_pre_cost_unapproved_mail', '', '../../../auto_mail/pre_cost_unapproved_mail_notification');


			}
		}

		function fnc_close()
		{
			unappv_request= $("#unappv_request").val();
			document.getElementById('hidden_appv_cause').value=unappv_request;
			parent.emailwindow.hide();
		}

    </script>
    <body>
		<div align="center" style="width:100%;">
        <? echo load_freeze_divs ("../../",$permission,1); ?>
        <form name="size_1" id="size_1">
			<fieldset style="width:450px;">
            <table align="center" cellspacing="0" width="450" class="rpt_table" border="1" rules="all" id="size_tbl" >
                <tr id="row_1">
                    <td width="150" align="center" >
                    	<textarea name="unappv_request" id="unappv_request" class="text_area" style="width:430px; height:100px;" maxlength="500" title="Maximum 500 Character"></textarea>
                        <Input type="hidden" name="precost_id" class="text_boxes" ID="precost_id" value="<? echo $precost_id; ?>" style="width:30px" />
                        <Input type="hidden" name="page_id" class="text_boxes" ID="page_id" value="<? echo $menu_id; ?>" style="width:30px" />
                        <Input type="hidden" name="user_id" class="text_boxes" ID="user_id" value="<? echo $user_id; ?>" style="width:30px" />
                    </td>
                </tr>
            </table>

            <table align="center" cellspacing="0" width="450" class="rpt_table" border="1" rules="all" id="" >
                <tr>
                    <td align="center" class="button_container">
                        <?
						//print_r ($id_up_all);
                            if($id_up!='')
                            {
                                echo load_submit_buttons($permission, "fnc_appv_entry", 1,0,"reset_form('size_1','','','','','');",1);
                            }
                            else
                            {
                                echo load_submit_buttons($permission, "fnc_appv_entry", 0,0,"reset_form('size_1','','','','','');",1);
                            }
                        ?>
                        <input type="hidden" name="hidden_appv_cause" id="hidden_appv_cause" class="text_boxes /">

                    </td>
                </tr>
                <tr>
                    <td align="center">
                        <input type="button" name="close" class="formbutton" value="Close" id="main_close" onClick="fnc_close();" style="width:100px" />
                    </td>
                </tr>
            </table>
            </fieldset>
            </form>
        </div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
	exit();
}

if ($action=="save_update_delete_unappv_request")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));

	//echo "shajjad_".$unappv_request.'_'.$wo_id.'_'.$page_id.'_'.$user_id; die;

	if ($operation==0)  // Insert Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		$approved_no=return_field_value("MAX(approved_no) as approved_no","approval_history","entry_form=46 and mst_id=$precost_id","approved_no")+1;

		$unapproved_request=return_field_value("APPROVAL_CAUSE","fabric_booking_approval_cause","entry_form=46 and user_id=$user_id and booking_id=$precost_id and approval_type=2 and approval_no='$approved_no'");//page_id=$page_id and

		if($unapproved_request=="")
		{
			$id_mst=return_next_id( "id", "fabric_booking_approval_cause", 1 ) ;

			$field_array="id,page_id,entry_form,user_id,booking_id,approval_type,approval_no,approval_cause,inserted_by,insert_date,status_active,is_deleted";
			$data_array="(".$id_mst.",".$page_id.",15,".$user_id.",".$precost_id." ,2,'".$approved_no."',".$unappv_request.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
			//echo "10**";
			//echo "INSERT INTO fabric_booking_approval_cause (".$field_array.") VALUES ".$data_array; die;
			$rID=sql_insert("fabric_booking_approval_cause",$field_array,$data_array,0);
			//echo $rID; die;

			if($db_type==0)
			{
				if($rID )
				{
					mysql_query("COMMIT");
					echo "0**".$rID."**".str_replace("'","",$precost_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					mysql_query("ROLLBACK");
					echo "10**".$rID;
				}
			}
			else if($db_type==2)
			{
				if($rID )
				{
					oci_commit($con);
					echo "0**".$rID."**".str_replace("'","",$precost_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					oci_rollback($con);
					echo "10**".$rID;
				}
			}
			disconnect($con);
			die;
		}
		else
		{
			$con = connect();
			if($db_type==0)
			{
				mysql_query("BEGIN");
			}

			$field_array="page_id*entry_form*user_id*booking_id*approval_type*approval_no*approval_cause*updated_by*update_date*status_active*is_deleted";
			$data_array="".$page_id."*15*".$user_id."*".$precost_id."*2*'".$approved_no."'*".$unappv_request."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*1*0";

			$rID=sql_update("fabric_booking_approval_cause",$field_array,$data_array,"id","".$unapproved_request."",0);

			if($db_type==0)
			{
				if($rID )
				{
					mysql_query("COMMIT");
					echo "1**".$rID."**".str_replace("'","",$precost_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					mysql_query("ROLLBACK");
					echo "10**".$rID;
				}
			}
			else if($db_type==2)
			{
				if($rID )
				{
					oci_commit($con);
					echo "1**".$rID."**".str_replace("'","",$precost_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					oci_rollback($con);
					echo "10**".$rID;
				}
			}

			disconnect($con);
			die;
		}
	}
	else if ($operation==1)  // Update Here
	{

	}

}
if($action=="validate_is_job_pre_cost")
{
	$ready_to_approved=return_field_value("ready_to_approved", "wo_pre_cost_mst", "job_no='$data'");
	$job_no="";
	if($ready_to_approved==1)
	{
		//$job_sql="select a.job_no from wo_po_details_master a, wo_pre_cost_mst b where a.job_no=b.job_no and a.quotation_id='$data' and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1";
		$job_sql="select job_no wo_pre_cost_mst where job_no='$data' and is_deleted=0 and status_active=1 and is_deleted=0 and status_active=1";
		$job_sql_res=sql_select($job_sql);
		foreach($job_sql_res as $row)
		{
			if($job_no=="") $job_no=$row[csf("job_no")]; else $job_no.=', '.$row[csf("job_no")];
		}
		if (count($job_sql_res)>0) echo "1***".$job_no; else echo "0***".$job_no;
	}
	else echo "0***".$job_no;
	 disconnect($con);die;
}
if($action == "update_previous_trims_data")
{
    $con = connect();
    if($db_type==0)
        {
            mysql_query("BEGIN");
        }
    $field_array="updated_by*update_date*is_deleted";
    $data_array="".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*1";
    $rID_up = sql_update("wo_pre_cost_trim_cost_dtls",$field_array,$data_array,"job_no",$data,0);
    if($db_type==0)
        {
            if($rID_up ){
                mysql_query("COMMIT");
                echo "0**".$rID_up;
            }
            else{
                mysql_query("ROLLBACK");
                echo "10**".$rID_up;
            }
        }
    if($db_type==2 || $db_type==1 )
        {
            if($rID_up ){
                oci_commit($con);
                echo "0**".$rID_up;
            }
            else{
                oci_rollback($con);
                echo "10**".$rID_up;
            }
        }
        disconnect($con);
        die;

}
if($action == "check_trims_data"){
     $trims_cost=sql_select("select id from wo_pre_cost_trim_cost_dtls where job_no='$data' and status_active=1 and is_deleted=0");
        if(count($trims_cost) > 0 ){
            echo 1;
            exit();
        }
        else{
            echo 0;
            exit();
        }
}

if($action == "get_template_data")
{
    $trim_variable=1;
    $trim_variable_sql=sql_select("select trim_rate from  variable_order_tracking where company_name='$data[4]' and variable_list=35 order by id");
    foreach($trim_variable_sql as $trim_variable_row)
    {
        $trim_variable= $trim_variable_row[csf('trim_rate')];
    }
    $lib_item_group_arr=return_library_array( "select item_name,id from lib_item_group where item_category=4 and is_deleted=0 and status_active=1 order by item_name", "id", "item_name");
    $trim_rate_from_library=return_library_array( "select a.id, min(b.rate) as rate from lib_item_group a, lib_item_group_rate b where a.id=b.mst_id and a.item_category=4 and a.status_active=1 and    a.is_deleted=0 group by a.id", "id", "rate");
    $supplier_library=return_library_array( "select a.supplier_name, a.id from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(4,5) and a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
    $data_array=sql_select("SELECT * from wo_lib_trim_cost_temp where template_name='$data' and status_active=1 and is_deleted=0 order by id");
    $i=1;
	//CONS_DZN_GMTS
    foreach( $data_array as $row )
    {
        $rate=$trim_rate_from_library[$row[csf('trims_group')]];
        $amount=$row[csf('cons_dzn_gmts')]*$trim_rate_from_library[$row[csf('trims_group')]];
        if($rate=="" || $rate==0)
        {
            $rate=$row[csf('purchase_rate')];
            $amount=$row[csf('amount')];
        }
        if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
        $str="";
        $str=$lib_item_group_arr[$row[csf("trims_group")]].'***'.$row[csf('user_code')].'***'.$row[csf('trims_group')].'***'.$row[csf('cons_uom')].'***'.$row[csf('cons_dzn_gmts')].'***'.$row[csf('purchase_rate')].'***'.$row[csf('amount')].'***'.$row[csf('apvl_req')].'***'.$row[csf('supplyer')].'***'.$row[csf('sup_ref')].'***'.$row[csf('item_description')].'***'.$row[csf('ex_per')].'***'.$row[csf('tot_cons')].'***'.$supplier_library[$row[csf("supplyer")]];
     ?>
        <tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="search<? echo $i;?>" class="itemdata" onClick="js_set_value(<? echo $i; ?>)" >
        	<td width="50"><?=$i; ?></td>
            <td width="100">
                <? echo $row[csf("user_code")]; ?>
                <input type="hidden" name="txttemplatedata_<? echo $i; ?>" id="txttemplatedata_<? echo $i; ?>" value="<? echo $str; ?>"/>
                </td>
            <td width="100"><? echo $lib_item_group_arr[$row[csf("trims_group")]]; ?></td>
            <td width="100"><? echo $row[csf("item_description")];?></td>
            <td width="100"><? echo $row[csf("sup_ref")]; ?></td>
            <td width="100"><? echo $supplier_library[$row[csf("supplyer")]]; ?></td>
            <td width="80"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
            <td width="70"><? echo $yes_no[$row[csf("apvl_req")]]; ?></td>
        </tr>

    <?  $i++; } ?>
    <script type="text/javascript">
        setFilterGrid("template_data_tbl",-1);
    </script>
    <?
    exit();
}

if($action == "trims_cost_template_name_popup")
{
	extract($_REQUEST);
    echo load_html_head_contents("Popup Info", "../../../", 1, 1, $unicode);?>
    <script>
        var selected_name = new Array();
    	function fnc_close(data) {
            var data=data.split('_');
            var check_trims_data = return_global_ajax_value( data[1], 'check_trims_data', '', 'quotation_entry_controller');
            if(check_trims_data == 1)
            {
                 var r=confirm("If you want to replace previous data then press Ok, otherwise press Cancel");
                if(r==false)
                {
                    parent.emailwindow.hide();
                    return;
                }
                else
                {
                    document.getElementById('hidden_template_name').value=data[0];
                    parent.emailwindow.hide();
                }
            }
            else
            {
                document.getElementById('hidden_template_name').value=data[0];
                parent.emailwindow.hide();
            }

        }
        function insert_template_data(data,id)
        {
            var template_data=return_global_ajax_value( data, 'get_template_data', '', 'pre_cost_entry_controller_v2');
            var template_data=trim(template_data) ;
            var tbl_row_count = document.getElementById( 'template_name_tbl' ).rows.length;
            tbl_row_count = tbl_row_count-1;
            for(var i=0; i<tbl_row_count; i++){
                var color = document.getElementById( 'tempname'+i ).style.backgroundColor;
                if(color == "yellow"){
                   if(id%2==0  ){
                    toggle( document.getElementById( 'tempname' + i ), '#FFFFFF');
                    }
                    if(id%2!=0 ){
                    toggle( document.getElementById( 'tempname' + i ), '#E9F3FF');
                    }
                }
            }
            if(template_data)
            {
            	if(id%2==0  ){
                    toggle( document.getElementById( 'tempname' + id ), '#FFFFFF');
                }
                if(id%2!=0 ){
                    toggle( document.getElementById( 'tempname' + id ), '#E9F3FF');
                }
                $("tbody#template_date").html('');
                $("tbody#template_date").append(template_data);
                $('#check_all_tbl').css('display','block');
            }
        }
        function check_all_data() {
            var tbl_row_count = document.getElementById( 'template_data_tbl' ).rows.length-1;
            tbl_row_count = tbl_row_count;
			//alert(tbl_row_count);

            if(document.getElementById('check_all').checked){
                for( var i = 1; i <= tbl_row_count; i++ ) {
	                document.getElementById( 'search' + i ).style.backgroundColor = 'yellow';
	                if( jQuery.inArray( $('#txttemplatedata_' + i).val(), selected_name ) == -1 ) {
	                    selected_name.push($('#txttemplatedata_' + i).val());
	                }
                }
                var templatedata='';
                for( var i = 0; i < selected_name.length; i++ ) {
                    templatedata += selected_name[i] + ',';
                }
                templatedata = templatedata.substr( 0, templatedata.length - 1 );
                $('#select_template_data').val( templatedata );
            }else{
                for( var i = 1; i <= tbl_row_count; i++ ) {
                    if(i%2==0  ){
                        document.getElementById('search'+i).style.backgroundColor = '#FFFFFF';
                    }
                    if(i%2!=0 ){
                        document.getElementById('search'+i).style.backgroundColor = '#E9F3FF';
                    }
                    for( var j = 0; j < selected_name.length; j++ ) {
                        if( selected_name[j] == $('#txttemplatedata_' + i).val() ) break;
                    }
                    selected_name.splice( j,1 );

                }
                var templatedata='';
                for( var i = 0; i < selected_name.length; i++ ) {
                    templatedata += selected_name[i] + ',';
                }
                templatedata = templatedata.substr( 0, templatedata.length - 1 );
                $('#select_template_data').val( templatedata );

            }

        }

        function toggle( x, origColor) {
            var newColor = 'yellow';
            if ( x.style ) {
                x.style.backgroundColor = (newColor == x.style.backgroundColor)? origColor : newColor;

            }
        }

        function onlyUnique(value, index, self) {
            return self.indexOf(value) === index;
        }

        function js_set_value( str) {
        	var tbl_row_count = document.getElementById( 'template_data_tbl' ).rows.length;
            tbl_row_count = tbl_row_count-1;
            if($("#search"+str).css("display") !='none'){
                if(str%2==0  ){
                    toggle( document.getElementById( 'search' + str ), '#FFFFFF');
                }
                if(str%2!=0 ){
                    toggle( document.getElementById( 'search' + str ), '#E9F3FF');
                }
                if( jQuery.inArray( $('#txttemplatedata_' + str).val(), selected_name ) == -1 ) {
                    selected_name.push($('#txttemplatedata_' + str).val());
                }
                else{
                    for( var i = 0; i < selected_name.length; i++ ) {
                        if( selected_name[i] == $('#txttemplatedata_' + str).val() ) break;
                    }
                    selected_name.splice( i,1 );
                }
            }
            var templatedata='';
            for( var i = 0; i < selected_name.length; i++ ) {
                templatedata += selected_name[i] + ',';
            }
            if(selected_name.length == tbl_row_count){
				document.getElementById("check_all").checked = true;
			}
			else{
				document.getElementById("check_all").checked = false;
			}
            templatedata = templatedata.substr( 0, templatedata.length - 1 );
            $('#select_template_data').val( templatedata );
        }
    </script>
    <?
    $template_name_sql=sql_select("select a.template_name from wo_lib_trim_cost_temp a,wo_lib_trim_cost_temp_dtls b where a.id=b.lib_trim_costing_temp_id and b.buyer_id =$buyer_name and a.is_deleted=0 group by  a.template_name");
      ?>
    </head>
    <body>
    <div align="center" style="width:100%;">
    	<div style="width:200px; float: left">
	    	<table cellspacing="0" cellpadding="0" border="1" rules="all" width="200" class="rpt_table" align="left">
	    		<tr>
	    			<input id="hidden_template_name" type="hidden" name="hidden_template_name">
	    			<th width="100"><h3>Template Name</h3></th>
	    		</tr>
	    	</table>
            <table cellspacing="0" cellpadding="0" border="1" rules="all" class="rpt_table" align="left" width="200" id="template_name_tbl">
	    		<?
	    		$i=0;
	    		foreach ($template_name_sql as $row){
	    		if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF"; ?>
	    		<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" onClick="insert_template_data('<? echo $row[csf("template_name")] ?>',<?echo $i ?>)" id="tempname<? echo $i; ?>">
	    			<td width="100" align="center"><span style="font-size: 14px"><? echo $row[csf("template_name")]; ?></span></td>
	    		</tr>
	    		<? $i++; } ?>

	    	</table>
    	</div>
        <table id="trmplate_data_tbl" cellspacing="0" cellpadding="0" border="1" rules="all" width="850" class="rpt_table">
            <input type="hidden" id="select_template_data" name="select_template_data"/>
            <thead>
                <tr>
                	<th width="50">SL</th>
                    <th width="100">User Code</th>
                    <th width="100">Group</th>
                    <th width="100">Description</th>
                    <th width="100">Brand/Sup Ref.</th>
                    <th width="100">Nominated Supp</th>
                    <th width="70">Cons UOM</th>
                    <th width="80">Apvl Req.</th>
                </tr>
            </thead>
        </table>
        <table id="template_data_tbl" cellspacing="0" cellpadding="0" border="1" rules="all" width="850" class="rpt_table">
            <tbody id="template_date">
            </tbody>
        </table>
        <table width="420" id="check_all_tbl" cellspacing="0" cellpadding="0" style="border:none; display: none; margin-top: 10px" align="center">
        <tr>
            <td align="center" height="30" width="200" valign="bottom">
                <div style="width:300px">
                    <div style="width:150px; float:left" align="left">
                        <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                    </div>
                    <div style="width:150px; float:left" align="left">
                        <input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                    </div>
                </div>
            </td>
        </tr>
    </table>
    </div>
    </body>
    <script type="text/javascript">
        setFilterGrid("template_name_tbl",-1);
    </script>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
    exit();
}

//generate_report BOM--------------------------------------------------------------

if($action == "mail_body_pre_cost_vs_price_quatation") //Pre-cost vs Price Quatation
{
   	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if($txt_job_no==""){
		$job_no='';
	}else{
		$job_no=" and a.job_no=".$txt_job_no."";
	}

	if($cbo_company_name=="") {
		$company_name='';
	} else {
		 $company_name=" and a.company_name=".$cbo_company_name."";
	}

	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$user_passArr=return_library_array( "select id, user_name from user_passwd",'id','user_name');


$ship_date=sql_select("select pub_shipment_date from wo_po_break_down where JOB_NO_MST=$txt_job_no and status_active=1 order by pub_shipment_date desc");

// echo $ship_date[0][csf('pub_shipment_date')];
$job_data=sql_select("select b.id, b.job_no, b.fabric_cost, b.fabric_cost_percent, b.trims_cost, b.trims_cost_percent, b.embel_cost, b.embel_cost_percent, b.wash_cost, b.wash_cost_percent, b.comm_cost, b.comm_cost_percent, b.commission, b.commission_percent, b.lab_test, b.lab_test_percent, b.inspection, b.inspection_percent, b.cm_cost, b.cm_cost_percent, b.freight, b.freight_percent, b.currier_pre_cost, b.currier_percent, b.certificate_pre_cost, b.certificate_percent, b.common_oh, b.common_oh_percent, b.depr_amor_pre_cost, b.depr_amor_po_price, b.total_cost, b.total_cost_percent, b.price_dzn, b.price_dzn_percent, b.margin_dzn, b.margin_dzn_percent, b.cost_pcs_set, b.cost_pcs_set_percent, b.price_pcs_or_set, b.price_pcs_or_set_percent, b.margin_pcs_set, b.margin_pcs_set_percent, b.cm_for_sipment_sche, b.deffdlc_cost, b.deffdlc_percent, b.interest_cost, b.interest_percent, b.incometax_cost, b.incometax_percent, b.design_cost, b.design_percent, b.studio_cost, b.studio_percent,c.job_no_prefix_num, c.buyer_name, c.style_ref_no,c.job_quantity, c.quotation_id from wo_pre_cost_mst a ,wo_pre_cost_dtls b,wo_po_details_master c where a.job_no=b.job_no and  a.job_no=c.job_no and a.job_no=$txt_job_no and  a.ready_to_approved =1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0");

$job_material_cost=$job_data[0][csf('fabric_cost')]+$job_data[0][csf('trims_cost')];
$job_other_cost=$job_data[0]['LAB_TEST']+$job_data[0]['INSPECTION']+$job_data[0]['FREIGHT']+$job_data[0]['CURRIER_PRE_COST']+$job_data[0]['CERTIFICATE_PRE_COST']+$job_data[0]['DESIGN_COST']+$job_data[0]['STUDIO_COST']+$job_data[0]['DEPR_AMOR_PRE_COST']+$job_data[0]['INTEREST_COST']+$job_data[0]['INCOMETAX_COST']+$job_data[0]['COMMON_OH'];
$quotation_id=$job_data[0][csf('quotation_id')];
// echo "<pre>";
// print_r($job_data);
// +$job_data[0]['COMM_COST']
//=======================================================================================================================


//======================================================Price Quatation ==============================================
$pq_sql = "select pq.company_id,pqc.cm_cost,pqc.fabric_cost,pqc.trims_cost,pqc.embel_cost,pqc.wash_cost,PQC.total_cost, pqc.margin_dzn_percent,pqc.lab_test,pqc.inspection,pqc.freight,pqc.currier_pre_cost,pqc.certificate_pre_cost,pqc.design_pre_cost,pqc.studio_pre_cost,pqc.comm_cost,pqc.common_oh,pqc.depr_amor_pre_cost,pqc.interest_pre_cost,pqc.income_tax_pre_cost, pqc.price_with_commn_dzn fob,pq.id price_quotation_id, company.company_name, buyer.buyer_name ,pq.style_ref,pq.style_desc, pq.pord_dept,pq.offer_qnty, pq.est_ship_date, pqc.margin_dzn 	from lib_buyer buyer join wo_price_quotation pq on buyer.id = pq.buyer_id  join lib_company company on company.id = pq.company_id 	left join wo_price_quotation_costing_mst pqc on pq.id = pqc.quotation_id where pq.status_active = 1 and pq.is_deleted = 0 and pq.ready_to_approved =1 and pq.id=$quotation_id";
 
$pq_data =  sql_select($pq_sql);
$material_cost=$pq_data[0]['FABRIC_COST']+$pq_data[0]['TRIMS_COST'];	

$other_cost=$pq_data[0]['LAB_TEST']+$pq_data[0]['INSPECTION']+$pq_data[0]['FREIGHT']+$pq_data[0]['CURRIER_PRE_COST']+$pq_data[0]['CERTIFICATE_PRE_COST']+$pq_data[0]['DESIGN_PRE_COST']+$pq_data[0]['STUDIO_PRE_COST']+$pq_data[0]['COMM_COST']+$pq_data[0]['DEPR_AMOR_PRE_COST']+$pq_data[0]['INTEREST_PRE_COST']+$pq_data[0]['INCOME_TAX_PRE_COST']+$pq_data[0]['COMMON_OH'];
 //===========================================End===========Price Quatation ============================================

		ob_start();
		
		?>
		<p>Dear Sir,</p>
		<p>Attached please find the cost break ups:</p>
		<table cellpadding="1"  class="rpt_table" border="1" rules="all">
			<tr>
				<td><b>Particulars</b></td><th>:</th>
				<td>PQ Cost</td>
				<td>Budget Cost</td>
			</tr>
			<tr>
				<td><b>PQ/Job</b></td><th>:</th>
				<td><?=$pq_data[0]['PRICE_QUOTATION_ID'];?></td>
				<td><?=$job_data[0][csf('job_no_prefix_num')];?></td>
			</tr>
			<tr>
				<td><b>Buyer Name</b></td><th>:</th>
				<td><?= $pq_data[0]['BUYER_NAME'];?></td>
				<td><?= $buyer_arr[$job_data[0][csf('buyer_name')]];?></td>
			</tr>
			<tr>
				<td><b>Style Ref</b></td><th>:</th>
				<td><?= $pq_data[0]['STYLE_REF'];?></td>
				<td><?=$job_data[0][csf('style_ref_no')];?></td>
			</tr>
			<tr>
				<td><b>Style Qty.(Pcs)</b></td><th>:</th>
				<td><?=$pq_data[0]['OFFER_QNTY'];?></td>
				<td><?=$job_data[0][csf('job_quantity')];?></td>
			</tr>
			<tr>
				<td><b>Delivery</b></td><th>:</th>
				<td><?=$pq_data[0]['EST_SHIP_DATE'];?></td>
				<td><?=$ship_date[0][csf('pub_shipment_date')];?></td>
			</tr>
			<tr>
				<td><b>Material Cost</b></td><th>:</th>
				<td><?=number_format($material_cost, 4,'.','');?></td>
				<td><?=number_format($job_material_cost, 4,'.','');?></td>
			</tr>
			<tr>
				<td><b>Embellishment Cost</b></td><th>:</th>
				<td><?=number_format($pq_data[0]['EMBEL_COST'], 4,'.','');?></td>
				<td><?=number_format($job_data[0][csf('embel_cost')], 4,'.','');?></td>
			</tr>
			<tr>
				<td><b>Wash Cost</b></td><th>:</th>
				<td><?=number_format($pq_data[0]['WASH_COST'], 4,'.','');?></td>
				<td><?=number_format($job_data[0][csf('wash_cost')], 4,'.','');?></td>
			</tr>
			<tr>
				<td><b>Other Cost</b></td><th>:</th>
				<td><?=number_format($other_cost, 4,'.','');?></td>
				<td><?=number_format($job_other_cost, 4,'.','');?></td>
			</tr>	
			<tr>
				<td><b>CM Cost</b></td><th>:</th>
				<td><?=number_format($pq_data[0]['CM_COST'], 4,'.','');?></td>
				<td><?=number_format($job_data[0][csf('cm_cost')], 4,'.','');?></td>
			</tr>
			<tr>
				<td><b>Total Cost</b></td><th>:</th>
				<td><?=number_format($pq_data[0]['TOTAL_COST'], 4,'.','');?></td>
				<td><?=number_format($job_data[0][csf('total_cost')], 4,'.','');?></td>
			</tr>
			<tr>
				<td><b>FOB Price/Pcs</b></td><th>:</th>
				<td><?=number_format($pq_data[0]['FOB'], 4,'.','');?></td>
				<td><?=number_format($job_data[0][csf('price_dzn')], 4,'.','');?></td>
			</tr>
			<tr>
				<td><b>Margin Value</b></td><th>:</th>
				<td><?=number_format($pq_data[0]['MARGIN_DZN'], 4,'.','');?></td>
				<td><?=number_format($job_data[0][csf('margin_dzn')], 4,'.','');?></td>
			</tr>
			<tr>
				<td><b>Margin (%)</b></td><th>:</th>
				<td><?=number_format($pq_data[0]['MARGIN_DZN_PERCENT'], 4,'.','');?></td>
				<td><?=number_format($job_data[0][csf('margin_dzn_percent')], 4,'.','');?></td>
			</tr>
		</table>	
		<br>Kindly review and advise approval please.<br><br><br>
		Thanks.<br>

		
     
    <?
	echo "Kind regards<br>";
	$mailBody=ob_get_contents();
	ob_clean();
	echo $mailBody;

	//Mail send------------------------------------------
	list($msil_address,$is_mail_send,$mail_body)=explode('**',$mail_data);
	if($is_mail_send==1){
	
		require_once('../../../mailer/class.phpmailer.php');
		require_once('../../../auto_mail/setting/mail_setting.php');
		
		$mailBody = preg_replace("/<img[^>]+\>/i", " ", $mailBody); 	
		$mailToArr=array();
		if($msil_address){$mailToArr[]=$msil_address;}
			
		$mailSql = "SELECT c.TEAM_LEADER_EMAIL, d.USER_EMAIL FROM wo_po_details_master  a,  wo_pre_cost_mst b, lib_marketing_team c, USER_PASSWD d
 WHERE a.job_no = b.job_no  AND a.TEAM_LEADER = c.id AND b.INSERTED_BY = d.id AND a.status_active = 1  AND a.job_no=$txt_job_no";
		
		//echo $mailSql;die;
		
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows['TEAM_LEADER_EMAIL']){$mailToArr[$rows['TEAM_LEADER_EMAIL']]=$rows['TEAM_LEADER_EMAIL'];}
			if($rows['USER_EMAIL']){$mailToArr[$rows['USER_EMAIL']]=$rows['USER_EMAIL'];}
		}
		
		
		$elcetronicSql = "SELECT a.BUYER_ID,a.SEQUENCE_NO,a.BYPASS,b.USER_EMAIL  from electronic_approval_setup a join user_passwd b on a.user_id=b.id where b.valid=1  AND a.page_id in(428,1717,2150) and a.company_id=$cbo_company_name order by a.SEQUENCE_NO"; //and a.
		
		$elcetronicSqlRes=sql_select($elcetronicSql);
		foreach($elcetronicSqlRes as $rows){

			
			if($rows[BUYER_ID]!=''){
				foreach(explode(',',$rows[BUYER_ID]) as $bi){
					if($rows['USER_EMAIL']!='' && $bi==$buyer_name_id){$mailToArr[$rows['USER_EMAIL']]=$rows['USER_EMAIL'];}
					if($rows['BYPASS']==2){break;}
				}
			}
			else{
				if($rows['USER_EMAIL']){$mailToArr[$rows['USER_EMAIL']]=$rows['USER_EMAIL'];}
				if($rows['BYPASS']==2){break;}
			}

		}
		
		//print_r($mailToArr);die;

		//Un-approve request mail......................................................
		$user_id=$_SESSION['logic_erp']['user_id'];
		$job_id=return_field_value("id", "wo_pre_cost_mst", "job_no='".str_replace("'","",$txt_job_no)."'");
		$approved_no=return_field_value("MAX(approved_no) as approved_no","approval_history","entry_form=46 and mst_id=$job_id","approved_no")+1;
		$unapproved_request=return_field_value("APPROVAL_CAUSE","fabric_booking_approval_cause","entry_form=46 and user_id=$user_id and booking_id=$job_id and approval_type=2 and approval_no='$approved_no'");//page_id=$page_id and
		if($unapproved_request){
			$mailToArr=array();
			if($msil_address){$mailToArr[]=$msil_address;}
			$final_app_user_mail=return_field_value("USER_EMAIL","user_passwd","id in(select APPROVED_BY from APPROVAL_HISTORY where id in(select max(id) from APPROVAL_HISTORY where mst_id=$job_id and ENTRY_FORM=46 and CURRENT_APPROVAL_STATUS=1))");
			$mailToArr[]= $final_app_user_mail;
		}
		$mailBody=$mail_body."<br>".$unapproved_request."<br>".$mailBody;
		//......................................................Un-approve request mail;		
		$to=implode(',',$mailToArr);
		//echo $to;die;
		$to=implode(',',$mailToArr);
		
		$sql2 = "SELECT c.email_address FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=78 and b.mail_user_setup_id=c.id and a.company_id=$cbo_company_name";
		$addto="";
		$mail_sql2=sql_select($sql2);
		foreach($mail_sql2 as $row)
		{
			if ($addto=="") {
				$addto=$row[csf('email_address')];
			}  else{
				 $addto=$addto.",".$row[csf('email_address')];
			}
	
		}
		$to.=",".$addto;


		
		//Att file....
		$imgSql="select IMAGE_LOCATION,REAL_FILE_NAME from common_photo_library where is_deleted=0  and MASTER_TBLE_ID=$txt_job_no and file_type=1";
		$imgSqlResult=sql_select($imgSql);
		foreach($imgSqlResult as $rows){
			$att_file_arr[]='../../../'.$rows['IMAGE_LOCATION'].'**'.$rows['REAL_FILE_NAME'];
		}
		
		$subject="Pre-Cost Vs Price Quatation Report";
		$header=mailHeader();
		echo sendMailMailer( "$to", $subject, $mailBody, $from_mail,$att_file_arr );
	}
	//------------------------------------End;
	exit();
}

if ($action=="margin_pcs_as_bom")
{
	 //echo $data; die;
	$txt_job_no="'".$data."'";
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";
 	
	$sql_po = "SELECT a.job_no, a.total_set_qnty, (b.plan_cut) as plan_cut, (b.po_quantity) as ord_qty, b.po_total_price
			from 
				wo_po_details_master a, 
				wo_po_break_down b, 
				wo_pre_cost_mst c 
			where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no 
				and a.status_active=1 and a.is_deleted =0 and b.status_active=1 
				and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 $job_no"; 

	$po_data_array=sql_select($sql_po);
	$total_po_value=$total_po_qty=0;
	foreach($po_data_array as $row)
	{
		$job_no=$row[csf("job_no")];
		$po_value=0; $po_qty=0;
		$po_value=$row[csf("po_total_price")];//*$row[csf("total_set_qnty")]
		$po_qty=$row[csf("ord_qty")];//*$row[csf("total_set_qnty")]
		$total_po_value+=$po_value;
		$total_po_qty+=$po_qty;
	}
	$condition= new condition();
	if(str_replace("'","",$txt_job_no) !=''){
		  $condition->job_no("=$txt_job_no");
	}
	$condition->init();
	$fabric= new fabric($condition);
    $yarn= new yarn($condition);
	$conversion= new conversion($condition);
	$trims= new trims($condition);
	$emblishment= new emblishment($condition);
	$wash= new wash($condition);
	$commercial= new commercial($condition);
	$commission= new commision($condition);
	$other= new other($condition);
	
	//2 Fabric Cost part here------------------------------------------- 	   	
	$sql = "SELECT id, job_no,item_number_id,gsm_weight, uom,body_part_id, fab_nature_id, color_type_id, fabric_description, avg_cons, fabric_source, rate, amount, avg_finish_cons, status_active from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted =0";// and fabric_source =2   ISD-24-03941

	$data_array=sql_select($sql);
	$fabric_amount=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$knit_subtotal_amount=0;
	$woven_subtotal_amount=0;
	foreach( $data_array as $row )
	{
		if($row[csf("fab_nature_id")]==2)//knit fabrics
		{
			//$knit_subtotal_amount+=$row[csf("amount")];
			$knit_subtotal_amount+=$fabric_amount['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];
		}			
		if($row[csf("fab_nature_id")]==3)//woven fabrics
		{
			//$woven_subtotal_amount+=$row[csf("amount")];
			$woven_subtotal_amount+=$fabric_amount['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
		}
	}
	unset($data_array);	
	//echo $knit_subtotal_amount; die;	          		
	//end 	All Fabric Cost part report-------------------------------------------
	$sql = "SELECT min(id) as id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, color,type_id, min(cons_ratio) as cons_ratio, sum(cons_qnty) as cons_qnty, rate, sum(amount) as amount 
		from wo_pre_cost_fab_yarn_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted =0 group by count_id, copm_one_id, percent_one, copm_two_id, percent_two, color,type_id, rate";
	 
	$data_array=sql_select($sql); 
	$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
	//print_r($yarn_data_array);
		
	$total_yarn_amount = 0;
	foreach( $data_array as $row )
	{ 
		$rowamount = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];
	
		$total_yarn_amount +=$rowamount;
	}
	unset($data_array);	

		
	//start	Conversion Cost to Fabric report here -------------------------------------------
	$sql = "select a.id, b.uom from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id where a.job_no=".$txt_job_no." and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted =0 order by  a.cons_process";
	$data_array=sql_select($sql);
	//echo $sql; die;
	//$conv_data_qty=$conversion->getQtyArray_by_conversionid();
	$conv_data_amt=$conversion->getAmountArray_by_conversionid();
	$total_conversion_cost=0;
	foreach( $data_array as $row )
	{ 
		$conversion_cost=$conv_data_amt[$row[csf('id')]][$row[csf('uom')]];
		$grand_total_conversion_cost+= $conversion_cost;
	}

	unset($data_array);	
	$all_fab_cost=$knit_subtotal_amount+$woven_subtotal_amount+$total_yarn_amount+$grand_total_conversion_cost;
           
	//Start Trims Cost Part report here -------------------------------------------
    $sql = "select id, job_no, trim_group, description, brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp, status_active from wo_pre_cost_trim_cost_dtls  where job_no=".$txt_job_no." and status_active =1 and is_deleted=0";
	$data_array=sql_select($sql);

	//$trim_qty_arr=$trims->getQtyArray_by_precostdtlsid();
	//print_r($trim_qty);
	$trim_amount_arr=$trims->getAmountArray_precostdtlsid();
	$total_trims_cost=0;
	foreach( $data_array as $row )
	{ 
		$pre_trims_amount=$trim_amount_arr[$row[csf("id")]];           	 
	
		$total_trims_cost += $pre_trims_amount;
	}

	unset($data_array);	
	//start Embellishment Details part report here -------------------------------------------
	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and status_active =1 and is_deleted=0";
	$data_array=sql_select($sql);
	
	//$emblishment_qty_arr=$emblishment->getQtyArray_by_jobAndEmblishmentid();
	$emblishment_amount_arr=$emblishment->getAmountArray_by_jobAndEmblishmentid();
	//$wash_qty_arr=$wash->getQtyArray_by_jobAndEmblishmentid();
	$wash_amount_arr=$wash->getAmountArray_by_jobAndEmblishmentid();
	
	$total_embellishment_amt=0;
	foreach( $data_array as $row )
	{
		if($row[csf("emb_name")] !=3){
			$embl_amount=$emblishment_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
		}
		else if($row[csf("emb_name")] ==3){
			$embl_amount=$wash_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
		}
		$total_embellishment_amt += $embl_amount;
	}
    unset($data_array);	        
	//start	Commercial Cost part report here -------------------------------------------
   	$sql = "select id, job_no, item_id, rate, amount, status_active from  wo_pre_cost_comarci_cost_dtls  where job_no=".$txt_job_no." and status_active =1 and is_deleted=0";
	$data_array=sql_select($sql);
	
	$commarcial_amount=$commercial->getAmountArray_by_jobAndPrecostdtlsid();
	$total_commercial_cost=0;
	foreach( $data_array as $row )
	{ 
		$amount = $commarcial_amount[$row[csf("job_no")]][$row[csf("id")]];;
		$total_commercial_cost += $amount;
	}
    unset($data_array);       
	//End Commercial Cost Part report here -------------------------------------------	
  
  	//start	Commission Cost part report here -------------------------------------------
   	$sql = "select id, job_no, particulars_id, commission_base_id, commision_rate, commission_amount, status_active from wo_pre_cost_commiss_cost_dtls where job_no=".$txt_job_no."  and status_active =1 and is_deleted=0";
	$data_array=sql_select($sql);
	
	$commission_amount_arr=$commission->getAmountArray_by_jobAndPrecostdtlsid();
	$total_commission_cost=0;
	foreach( $data_array as $row )
	{ 
		$commission_amount = $commission_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
		$total_commission_cost += $commission_amount;
	}
    unset($data_array);        
	//start	Other Components part report here -------------------------------------------
	$sql = "select id, job_no, depr_amor_pre_cost, deffdlc_cost, incometax_cost, interest_cost, lab_test, inspection, cm_cost, freight, common_oh, currier_pre_cost, certificate_pre_cost, price_dzn,design_cost,studio_cost from wo_pre_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	$other_costing_arr=$other->getAmountArray_by_job();
	$total_other_components=0;
	$lab_test_cost=$inspection_cost=$cm_cost=$freight_cost=$currier_cost=$certificate_cost=$deffdlc_cost=$common_oh=$depr_amor_pre_cost=$interest_cost=$incometax_cost=$design_cost=$studio_cost=0;
	foreach( $data_array as $row )
	{ 
		$job_no=$row[csf("job_no")];
		
		$lab_test_cost=$other_costing_arr[$job_no]['lab_test'];
		$inspection_cost=$other_costing_arr[$job_no]['inspection'];
		$cm_cost=$other_costing_arr[$row[csf("job_no")]]['cm_cost'];
		$freight_cost=$other_costing_arr[$job_no]['freight'];
		$currier_cost=$other_costing_arr[$job_no]['currier_pre_cost'];
		$certificate_cost=$other_costing_arr[$job_no]['certificate_pre_cost'];
		$deffdlc_cost=$other_costing_arr[$job_no]['deffdlc_cost'];
		$common_oh=$other_costing_arr[$job_no]['common_oh'];
		$depr_amor_pre_cost=$other_costing_arr[$job_no]['depr_amor_pre_cost'];
		$interest_cost=$other_costing_arr[$job_no]['interest_cost'];
		$incometax_cost=$other_costing_arr[$job_no]['incometax_cost'];
		$design_cost=$other_costing_arr[$job_no]['design_cost'];
		$studio_cost=$other_costing_arr[$job_no]['studio_cost'];

		
		$total_other_components =$lab_test_cost+$inspection_cost+$cm_cost+$freight_cost+$currier_cost+$certificate_cost+$deffdlc_cost+$interest_cost+$incometax_cost+$common_oh+$depr_amor_pre_cost+$design_cost+$studio_cost;
		$price_dzn=$row[csf("price_dzn")];
	}
	unset($data_array);	 
	//echo $lab_test_cost.'+'.$inspection_cost.'+'.$cm_cost.'+'.$freight_cost.'+'.$currier_cost.'+'.$certificate_cost.'+'.$deffdlc_cost.'+'.$interest_cost.'+'.$incometax_cost.'+'.$common_oh.'+'.$depr_amor_pre_cost.'+'.$design_cost.'+'.$studio_cost; die; 
	//echo $total_trims_cost.'+'.$all_fab_cost.'+'.$total_embellishment_amt.'+'.$total_other_components.'+'.$total_commercial_cost.'+'.$total_commission_cost; die;
	$total_job_cost=$total_trims_cost+$all_fab_cost+$total_embellishment_amt+$total_other_components+$total_commercial_cost+$total_commission_cost;
    //echo  $total_po_value.'--'.$total_job_cost; die;    
	$total_margin_val = $total_po_value-$total_job_cost;
	//echo $total_margin_val.'=='.$total_po_qty; die;
	$margin_dzn=($total_margin_val/$total_po_qty)*12;
	$margin_pcs=$margin_dzn/12;
	
	$job_po_rate=$total_po_value/$total_po_qty;
	 
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}
	$margin_pcs_bom=fn_number_format($margin_dzn/12,4, '.', '');
	$margin_bom_per=fn_number_format(($margin_pcs/$job_po_rate)*100,2, '.', '');
	$rid=execute_query( "update wo_pre_cost_dtls set margin_pcs_bom='$margin_pcs_bom', margin_bom_per='$margin_bom_per' where job_no =".$txt_job_no."",1);
	//echo "update wo_pre_cost_dtls set margin_pcs_bom='$margin_pcs_bom', margin_bom_per='$margin_bom_per' where job_no =".$txt_job_no."";
	
	if($db_type==0 && $rid==1)
	{
		mysql_query("COMMIT");
		if($margin_pcs_bom=="") $margin_pcs_bom=0; else $margin_pcs_bom=fn_number_format($margin_pcs_bom,4);
		if($margin_bom_per=="") $margin_bom_per=0; else $margin_bom_per=fn_number_format($margin_bom_per,2);
		echo "1***".$margin_pcs_bom."***".$margin_bom_per;
	}
	else if($db_type==2 && $rid==1)
	{
		oci_commit($con);
		if($margin_pcs_bom=="") $margin_pcs_bom=0; else $margin_pcs_bom=fn_number_format($margin_pcs_bom,4);
		if($margin_bom_per=="") $margin_bom_per=0; else $margin_bom_per=fn_number_format($margin_bom_per,2);
		echo "1***".$margin_pcs_bom."***".$margin_bom_per;
	}
	exit();
}

if($action == "bom_epm_woven") //BOM EPM BTN 1
{
   	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if($txt_job_no==""){
		$job_no='';
	}else{
		$job_no=" and a.job_no=".$txt_job_no."";
	}

	if($cbo_company_name=="") {
		$company_name='';
	} else {
		 $company_name=" and a.company_name=".$cbo_company_name."";
	}

	if($cbo_buyer_name==""){
		 $cbo_buyer_name='';
	} else {
		$cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	}

	if($txt_style_ref==""){
		 $txt_style_ref='';
	} else {
		$txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	}

	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($txt_costing_date=="") {
		$txt_costing_date='';
	} else {
		$txt_costing_date=" and b.costing_date='".$txt_costing_date."'";
	}
	$txt_po_breack_down_id=str_replace("'",'',$txt_po_breack_down_id);
	if(str_replace("'",'',$txt_po_breack_down_id)==""){
		$txt_po_breack_down_id_cond='';
	}
	else{
		$txt_po_breack_down_id_cond=" and d.id in(".$txt_po_breack_down_id.")";
	}
    //if($txt_quotation_date=="") $txt_quotation_date=''; else $txt_quotation_date=" and a.quot_date ='".$txt_quotation_date."'";
	$imge_arr=return_library_array( "select master_tble_id,image_location from common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	

    $buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
    $season_name_arr=return_library_array( "select id, season_name from lib_buyer_season",'id','season_name');
    $comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	 $user_passArr=return_library_array( "select id, user_name from user_passwd",'id','user_name');
	 $brand_arr=return_library_array( "select id, brand_name from  lib_buyer_brand where status_active=1 and is_deleted=0",'id','brand_name');
	 $color_library=return_library_array("select id,color_name from lib_color where status_active=1 and is_deleted=0","id","color_name");
	 //pro_ex_factory_mst 
	 $sql_ex="select max(ex_factory_date) as ex_factory_date from pro_ex_factory_mst b,wo_po_break_down d where d.id=b.po_break_down_id and d.job_no_mst=$txt_job_no and d.status_active=1";
	  $exf_data_array=sql_select($sql_ex);
	 foreach( $exf_data_array as $row)
	 {
		 	$ex_factory_date=$row[csf("ex_factory_date")];
	 }
	 $excess_cut=0;
	  $sql_excess="select b.excess_cut_perc from wo_po_color_size_breakdown b,wo_po_break_down d where d.id=b.po_break_down_id and d.job_no_mst=$txt_job_no and b.status_active=1 and d.status_active=1";
	  $excess_data_array=sql_select($sql_excess);
	 foreach( $excess_data_array as $row)
	 {
		 $excess_cut=$row[csf("excess_cut_perc")];
	 }
	 
	$sql_po="select  a.total_set_qnty as ratio,d.po_number,(d.po_quantity) as po_qnty,d.plan_cut, d.excess_cut,d.unit_price, d.pub_shipment_date,d.po_received_date,d.pack_handover_date  from wo_po_break_down d,wo_po_details_master a where   d.job_no_mst=a.job_no and d.job_no_mst=$txt_job_no and d.status_active=1 $txt_po_breack_down_id_cond";
	 $po_data_array=sql_select($sql_po);
	 	$order_job_qnty=0;$plan_cut=0;$leadtime_days_remian_cal="";
	 foreach( $po_data_array as $row)
	 {
		 	$po_received_dateArr.=$row[csf("po_received_date")].',';
			$pack_handover_dateArr.=$row[csf("pack_handover_date")].',';
			$order_job_qnty+=$row[csf("po_qnty")];
			 
			$plan_cut+=$row[csf("plan_cut")];
			$days_tot=datediff('d',$row[csf("po_received_date")],$row[csf("pub_shipment_date")])-1;
			 $leadtime_days_remian_cal.=$days_tot.',';
	 }
	  $leadtime_days_remian_calArr=rtrim($leadtime_days_remian_cal,',');
	 $leadtime_days_remian_calArr=explode(",",$leadtime_days_remian_calArr);
	 $leadtime_days_remian=max($leadtime_days_remian_calArr);
	  
	  
	 $po_received_dateArr=rtrim($po_received_dateArr,',');
	 $po_received_dateArr=explode(",",$po_received_dateArr);
	  $po_received_date=max($po_received_dateArr);
	 $pack_handover_dateArr=rtrim($pack_handover_dateArr,',');
	 $pack_handover_dateArr=explode(",",$pack_handover_dateArr);
	 $pack_handover_date=max($pack_handover_dateArr);
	 
	// $leadtime_days_remian=datediff('d',$po_received_date,$ex_factory_date)-1;
	 
	 $sql = "SELECT a.job_no,a.company_name,a.buyer_name,a.quotation_id,a.remarks,a.set_break_down,a.order_uom,a.season_buyer_wise,a.season_year,a.brand_id,a.style_ref_no,a.set_smv, a.gmts_item_id, a.order_uom, a.job_quantity, a.avg_unit_price,b.costing_date,b.sourcing_date, b.approved,b.costing_per, c.fab_knit_req_kg, c.fab_woven_req_yds, c.fab_yarn_req_kg, a.total_set_qnty as ratio, a.working_company_id, a.body_wash_color, a.style_description,a.product_dept from wo_po_details_master a, wo_pre_cost_mst b,wo_pre_cost_sum_dtls c  where a.id=b.job_id and b.job_id=c.job_id and a.status_active=1 and a.job_no=$txt_job_no $company_name $cbo_buyer_name $txt_style_ref";
           //  echo $sql;
    $data_array=sql_select($sql);
	$working_company_arr=return_library_array("SELECT id,company_name from lib_company ","id","company_name");  
	$working_company='';
	foreach ($data_array as $row)
			{
				$working_company=$working_company_arr[$row[csf("working_company_id")]];
			}
    if(empty($path))
    {
    	$path="../../";
    }
    else{
    	$path=str_replace("'", "", $path);
    }
    //echo $path;

	ob_start();
    ?>
    <div style="width:1320px" align="center">  
      <style>
	 /* p{ padding:0px !important; margin:0px !important;}*/
	</style>
      <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black">
           <tr>
               <td width="100"> 
               <img src='<? echo $path .''. $imge_arr[str_replace("'","",$cbo_company_name)]; ?>' height='100%' width='100%' />
               </td>
               <td width="1250">                                     
                    <table width="100%" cellpadding="0" cellspacing="0" >
                        <tr>
                            <td align="center" style="font-size:20px;">
                            <b>  <?php      
                                    echo 'BOM Pre Cost Report';
                              ?>
                              </b>
                            </td>
                        </tr>
                      </table>
					  <br>
					  <table width="100%" cellpadding="0" cellspacing="0">
                        <tr align="center">
                            <td> <b style="font-size:21px;"> PO Rec Unit: </b><span style="font-size:19px;"><?  echo $comp[str_replace("'","",$cbo_company_name)];?> </span></td>
							
							<td ><b style="font-size:21px;">Prod Unit: </b><span style="font-size:19px;"><?echo $working_company;?></span></td>
							
                        </tr>
                      </table>
                </td>       
            </tr>
       </table>
       <br>
            <?
             $order_price_per_dzn=0;
		
			foreach ($data_array as $row)
			{
				
				$avg_unit_price=$row[csf("avg_unit_price")];
				$sourcing_date=$row[csf("sourcing_date")];
				$buyer_name_id=$row[csf("buyer_name")];
				$set_break_down=$row[csf("set_break_down")];
				$approved=$row[csf("approved")];
			
			 
				$order_values = $order_job_qnty*$avg_unit_price;
				 if($row[csf("costing_per")]==1){$order_price_per_dzn=12;$costing_val=" DZN";}
					else if($row[csf("costing_per")]==2){$order_price_per_dzn=1;$costing_val=" PCS";}
					else if($row[csf("costing_per")]==3){$order_price_per_dzn=24;$costing_val=" 2 DZN";}
					else if($row[csf("costing_per")]==4){$order_price_per_dzn=36;$costing_val=" 3 DZN";}
					else if($row[csf("costing_per")]==5){$order_price_per_dzn=48;$costing_val=" 4 DZN";}
				
					$quot_id=$row[csf("quotation_id")];
					$sew_smv=$row[csf("set_smv")];
					$ratio=$row[csf("ratio")];
					$order_uom=$row[csf("order_uom")];
					$remarks=$row[csf("remarks")];
					$inserted_by=$user_passArr[$row[csf("inserted_by")]];
					$style_description='';
					if($row[csf("style_description")]!=''){
						$style_description=" (".$row[csf("style_description")].")";
					}
				?>
						<table align="left" border="0" cellpadding="0" cellspacing="0" style="width:550px; margin:5px;">
                        <tr>
                        <td>
                        
                        <table align="left" border="1" cellpadding="1" cellspacing="1" style="width:550px; margin:5px;" rules="all">
							<tr>
								<td width="80">Job No</td>
								<td width="80"><b><? echo $row[csf("job_no")]; ?></b></td>
								<td width="90">Costing </td>
								
								</tr>
							<tr>
                            <tr>
								<td width="80">Body/Wash Color</td>
								<td width="80"><b><? echo $color_library[$row[csf("body_wash_color")]]; ?></b></td>
								<td width="100"><b><? echo $costing_per[$row[csf("costing_per")]]; ?></b></td>
							</tr>
                            <tr>
							<td> Costing Date :  </td>
							<td colspan="2"><b><? echo $row[csf("costing_date")]; ?></b></td>
							</tr>
                             
							<tr>
								<td>Buyer </td>
								<td colspan="2"><b><? echo $buyer_arr[$row[csf("buyer_name")]];
								
								if($row[csf("brand_id")]>0)
								{
									echo '('.$brand_arr[$row[csf("brand_id")]].')';
								}
								if($row[csf("product_dept")]>0)
								{
									echo '('.$product_dept[$row[csf("product_dept")]].')';
								}
								
								
								?></b></td>
							 </tr> 
							 <tr>
								<td>Style </td>
								<td colspan="2"><b><? echo $row[csf("style_ref_no")].$style_description; ?></b></td>
							 </tr>
							<tr>
								<td width="80">Item</td>
								<?
									$set_break_downArr=explode("__",$set_break_down);
									$smv_arr=array();
										foreach($set_break_downArr as $keyitemData)
										{
											$keyitemDataArr=explode("_",$keyitemData);
											$item_id=$keyitemDataArr[0];
											$smv=$keyitemDataArr[2];
											$smv_arr[$item_id]=$smv;
											
											
										}
										//print_r($smv_arr);
									if($row[csf("order_uom")]==1)
									{
									  $grmnt_items=$garments_item[$row[csf("gmts_item_id")]].' ('.$smv_arr[$row[csf("gmts_item_id")]].')';
									}
									else
									{
										$gmt_item=explode(',',$row[csf("gmts_item_id")]);
										foreach($gmt_item as $key=>$val)
										{
											$grmnt_items .=$garments_item[$val].' ('.$smv_arr[$val].')'.", ";
										}
									}
								?>
								<td width="100" colspan="2"><b><? echo rtrim($grmnt_items,', '); ?></b></td>
							</tr>
							<tr>
								<td>Season</td>
								<td colspan="2"><b><? echo $season_name_arr[$row[csf('season_buyer_wise')]].'-'.substr( $row[csf('season_year')], -2);  ?></b></td>
							 </tr>
							<tr>
								<td>P.O. Qnty</td>
								<td><b><?  echo $order_job_qnty.' '.$unit_of_measurement[$order_uom];
								$po_qty_dzn=$order_job_qnty/$order_price_per_dzn;
								 ?></b></td>
								<td  title="<? echo $offer_qty_dzn;?>"><b><? echo number_format($po_qty_dzn,0).' '.$costing_val; ?></b></td>
							</tr>
							
							  <tr>
								<td>Plan Cut Qnty(<? echo $excess_cut.'%';?>)</td>
								<td><b><? echo $plan_cut.' '.$unit_of_measurement[$order_uom];
								$offer_qty_dzn=$plan_cut/$order_price_per_dzn;
								 ?></b></td>
								<td  title="<? echo $offer_qty_dzn;?>"><b><? echo number_format($offer_qty_dzn,0).' '.$costing_val; ?></b></td>
							</tr>
                             <tr>
								<td>Remarks</td>
								<td colspan="2"><b><? echo $remarks;
								 
								 ?></b></td>
								 
							</tr>
						</table>
                        </td>
              <?
			} //master part end
		//	die;
		//echo $ratio.'D';
           $condition= new condition();
			if(str_replace("'","",$txt_job_no) !=''){
				$condition->job_no("=$txt_job_no");
			}
			if(str_replace("'",'',$txt_po_breack_down_id) !="")
			{
				$condition->po_id("in($txt_po_breack_down_id)");
			}
			$condition->init();
			$fabric= new fabric($condition);
			$trim= new trims($condition);
			$wash= new wash($condition);
			$emblishment= new emblishment($condition);
			//echo $fabric->getQuery();die;
			$fabric_qty_arr=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
			//print_r($fabric_qty_arr);
			$fabric_amount_arr=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
			
			$trim_amount_arr=$trim->getAmountArray_precostdtlsid();
			$trim_qty_arr=$trim->getQtyArray_by_precostdtlsid();
			
			$emblishment_qtyArr=$emblishment->getQtyArray_by_jobAndEmblishmentid();
			$emblishment_amountArr=$emblishment->getAmountArray_by_jobAndEmblishmentid();
			$wash_qtyArr=$wash->getQtyArray_by_jobAndEmblishmentid();
			
		//print_r($wash_qtyArr);
			$wash_amountArr=$wash->getAmountArray_by_jobAndEmblishmentid();
	           
			$sql_determin=sql_select("select a.id,a.type from lib_yarn_count_determina_mst a where  a.status_active=1  and a.entry_form=426");
			foreach($sql_determin as $row)
			{
				$determin_type_arr[$row[csf('id')]]=$row[csf('type')];	
			}
			
			
			// $pri_fab_arr="select a.quotation_id,b.fabric_source,b.lib_yarn_count_deter_id as deter_min_id,b.fabric_description as fab_desc,b.fabric_description,b.body_part_id,b.gsm_weight,b.uom, a.rate,a.amount, (a.requirment) as requirment,a.cons, (a.pcs) as pcs,a.process_loss_percent as p_loss from wo_pri_quo_fab_co_avg_con_dtls a,wo_pri_quo_fabric_cost_dtls  b where a.wo_pri_quo_fab_co_dtls_id=b.id and a.quotation_id=b.quotation_id  and b.status_active=1 and b.is_deleted=0 and a.quotation_id=$quot_id ";//and b.fabric_source=2
			//$pri_fab_result=sql_select($pri_fab_arr);
			
			  $pre_fab_arr="select  b.id, b.job_no,b.body_part_id,b.lib_yarn_count_deter_id as deter_min_id, b.fab_nature_id, b.color_type_id, b.fabric_description as fab_desc,b.uom,b.avg_cons,b.avg_cons_yarn, b.avg_process_loss,b.construction,b.composition,b.fabric_source,b.gsm_weight, b.rate,b.amount,b.avg_finish_cons,b.sourcing_rate,b.sourcing_nominated_supp from wo_pre_cost_fabric_cost_dtls  b where  b.status_active=1 and b.is_deleted=0 and b.job_no=$txt_job_no order by b.id ";//and b.fabric_source=2
			  //echo $pre_fab_arr; die;
			$pre_fab_result=sql_select($pre_fab_arr);
			
			$summ_fob_pcs=0;$summ_fob_gross_value_amt=$summ_sourcing_tot_budget_dzn_val=0;
			foreach($pre_fab_result as $row)
			{
				$determin_type=$determin_type_arr[$row[csf('deter_min_id')]];
				$body_partId=$body_part[$row[csf('body_part_id')]];
				//$fab_desc=$body_partId.','.$row[csf('fab_desc')];
				$fab_desc=$body_partId.','.$row[csf('fab_desc')];
				//echo $determin_type.'d';
				$tot_amt=$row[csf('avg_cons')]*$row[csf('rate')];
				$fab_req_qty=$fabric_qty_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]]+$fabric_qty_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$fab_req_amount=$fabric_amount_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]]+$fabric_amount_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$fab_cost_dtls_id=$row[csf('id')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['req_qty']+=$fab_req_qty;
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['req_amount']+=$fab_req_amount;
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['cons']+=$row[csf('avg_finish_cons')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['tot_cons']+=$row[csf('avg_cons')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['amount']+=$row[csf('amount')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['p_loss']=$row[csf('avg_process_loss')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['sourcing_nominated_supp']=$row[csf('sourcing_nominated_supp')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['sourcing_rate']=$row[csf('sourcing_rate')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['fabric_source']=$row[csf('fabric_source')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['fab_desc']=$row[csf('construction')].','.$row[csf('composition')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['uom']=$unit_of_measurement[$row[csf('uom')]];
				$p_fab_precost_tot_row+=1;	
				//Summary
				$summ_fob_pcs+=$row[csf('amount')];
			//	$summ_sourcing_tot_budget_dzn_val+=$fab_req_qty*$row[csf('sourcing_rate')];
				
				$summ_fob_gross_value_amt+=$fab_req_amount;
			}
		  $pre_trim_consarr="select b.id,c.trim_type,c.item_name,b.description,b.trim_group,b.cons_dzn_gmts,b.seq,b.cons_uom as uom,avg(d.excess_per) as  excess_per from wo_pre_cost_trim_cost_dtls b,lib_item_group c,wo_pre_cost_trim_co_cons_dtls d where  c.id=b.trim_group and b.id=d.wo_pre_cost_trim_cost_dtls_id and c.trim_type in(1,2) and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and b.job_no=$txt_job_no group by b.id,c.trim_type,c.item_name,b.description,b.trim_group,b.cons_dzn_gmts,b.cons_uom,b.seq order by b.seq";
		$pre_trim_cons_result=sql_select($pre_trim_consarr);
			foreach($pre_trim_cons_result as $row)
			{
				$trims_type=$row[csf('trim_type')];
				
				
				$description=$row[csf('description')];
				if($description!="") $descriptionCond=", ".$description; else $descriptionCond="";
				$item_id=$row[csf('item_name')].$descriptionCond;
				if($trims_type==1) //Sewing
				{
						$p_sew_trim_precost_excess_arr[$item_id]['p_loss']+=$row[csf('excess_per')];
				}
				else
				{
						$p_fin_trim_precost_excess_arr[$item_id]['p_loss']+=$row[csf('excess_per')];;
				}
				
			}
			
			
			 $pre_trim_arr="select b.seq,b.id,c.trim_type,c.item_name,b.description,b.trim_group,b.tot_cons,b.ex_per ,b.cons_dzn_gmts,b.cons_uom as uom, b.rate,b.amount,b.sourcing_rate,b.sourcing_nominated_supp from wo_pre_cost_trim_cost_dtls b,lib_item_group c where  c.id=b.trim_group and c.trim_type in(1,2) and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and b.job_no=$txt_job_no order by b.seq";//and b.fabric_source=2
			$pre_trim_result=sql_select($pre_trim_arr);
			
			$p_sew_trim_precost_arr=$p_fin_trim_precost_arr=array();
			foreach($pre_trim_result as $row)
			{
				$trims_type=$row[csf('trim_type')];
				
				
				$description=$row[csf('description')];
				if($description!="") $descriptionCond=", ".$description; else $descriptionCond="";
				$item_id=$row[csf('item_name')].$descriptionCond;
				//$item_name_arr[$item_id]=$row[csf('item_name')].$descriptionCond;
				$req_amt=$row[csf('cons_dzn_gmts')]*$row[csf('rate')];
				if($trims_type==1) //Sewing
				{
				$p_sew_loss=$row[csf('ex_per')];
				$ex_tot=$row[csf('cons_dzn_gmts')]+(($row[csf('cons_dzn_gmts')]*$p_sew_loss)/100);
				
					$trim_req_qty=$trim_qty_arr[$row[csf('id')]];
				$trim_req_amount=$trim_amount_arr[$row[csf('id')]];
				$p_sew_trim_precost_arr[$item_id]['req_qty']+=$trim_req_qty;
				$p_sew_trim_precost_arr[$item_id]['req_amount']+=$trim_req_amount;
				$p_sew_trim_precost_arr[$item_id]['cons']+=$row[csf('tot_cons')];
				$p_sew_trim_precost_arr[$item_id]['tot_cons']+=$row[csf('cons_dzn_gmts')];
				$p_sew_trim_precost_arr[$item_id]['amount']+=$row[csf('amount')];
				$p_sew_trim_precost_arr[$item_id]['sourcing_rate']=$row[csf('sourcing_rate')];
				$p_sew_trim_precost_arr[$item_id]['sourcing_nominated_supp']=$row[csf('sourcing_nominated_supp')];
				$p_sew_trim_precost_arr[$item_id]['p_loss']=$p_sew_loss;
				//$p_sew_trim_precost_arr[$item_id]['tot_row']+=1;
				$p_sew_trim_tot_row+=1;
				$p_sew_trim_precost_arr[$item_id]['uom']=$unit_of_measurement[$row[csf('uom')]];
				$summ_fob_pcs+=$row[csf('amount')];	
				$summ_sourcing_tot_budget_dzn_val+=$trim_req_qty*$row[csf('sourcing_rate')];
				$summ_fob_gross_value_amt+=$trim_req_amount;
				}
				else //packing/Finish
				{
					$p_fin_loss=$row[csf('ex_per')];
					$ex_tot=$row[csf('cons_dzn_gmts')]+(($row[csf('cons_dzn_gmts')]*$p_fin_loss)/100);
					
				$trim_fin_req_qty=$trim_qty_arr[$row[csf('id')]];
				$trim_fin_req_amount=$trim_amount_arr[$row[csf('id')]];
				//echo $trim_fin_req_qty.'='.$row[csf('sourcing_rate')];
				$p_fin_trim_precost_arr[$item_id]['req_qty']+=$trim_fin_req_qty;
				$p_fin_trim_precost_arr[$item_id]['req_amount']+=$trim_fin_req_amount;
				$p_fin_trim_precost_arr[$item_id]['cons']+=$row[csf('tot_cons')];
				$p_fin_trim_precost_arr[$item_id]['tot_cons']+=$row[csf('cons_dzn_gmts')];
				$p_fin_trim_precost_arr[$item_id]['amount']+=$row[csf('amount')];
				if($row[csf('sourcing_rate')]>0)
				{
				$p_fin_trim_precost_arr[$item_id]['fin_sourcing_rate']=$row[csf('sourcing_rate')];
				}
				$p_fin_trim_precost_arr[$item_id]['sourcing_nominated_supp']=$row[csf('sourcing_nominated_supp')];
				$p_fin_trim_precost_arr[$item_id]['p_loss']=$p_fin_loss;
				$p_fin_trim_tot_row+=1;
				$p_fin_trim_precost_arr[$item_id]['uom']=$unit_of_measurement[$row[csf('uom')]];	
				$summ_fob_pcs+=$row[csf('amount')];
				$summ_sourcing_tot_budget_dzn_val+=$trim_fin_req_qty*$row[csf('sourcing_rate')];
				$summ_fob_gross_value_amt+=$trim_fin_req_amount;
				}
				//$summ_fob_value_pcs+=$row[csf('amount')]*$order_price_per_dzn;
				
			}
			//print_r($p_sew_trim_precost_arr2);
			
		
			 $pre_wash_arr="select b.job_no,b.id,b.emb_name,b.emb_type,b.cons_dzn_gmts, b.rate,b.amount,b.sourcing_rate,b.sourcing_nominated_supp from wo_pre_cost_embe_cost_dtls  b where  b.status_active=1 and b.is_deleted=0  and b.job_no=$txt_job_no  order by b.emb_name";//and b.fabric_source=2
			$pre_wash_result=sql_select($pre_wash_arr);
			
		//	$summ_sourcing_tot_budget_dzn_val=0;
		 
			foreach($pre_wash_result as $row)
			{
				$emb_name_id=$row[csf('emb_name')];
				$emb_type=$row[csf('emb_type')];
			
				//emblishment_embroy_type_arr
				if($emb_name_id==1) //Print type
				{
					if($emb_type>0) $emb_typeCond=", ".$emblishment_print_type[$emb_type];else $emb_typeCond="";
					$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
				}
				else if($emb_name_id==2) //embro type
				{
					if($emb_type>0) $emb_typeCond=", ".$emblishment_embroy_type_arr[$emb_type];else $emb_typeCond="";
					$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
				}
				else if($emb_name_id==4) //Special type
				{
					if($emb_type>0) $emb_typeCond=", ".$emblishment_spwork_type[$emb_type];else $emb_typeCond="";
					$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
				}
				else if($emb_name_id==5) //GMT type
				{
					if($emb_type>0) $emb_typeCond=", ".$emblishment_gmts_type[$emb_type];else $emb_typeCond="";
					$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
				}
				 

				$wash_req_amount=$emb_req_amount=0;
				if($row[csf('emb_name')]==3) //Wash
				{
					
						
				if($row[csf('emb_type')]>0) $wash_emb_typeCond=", ".$emblishment_wash_type[$row[csf('emb_type')]];else $wash_emb_typeCond="";
				$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$wash_emb_typeCond;
				$wash_req_qty=$wash_qtyArr[$row[csf('job_no')]][$row[csf('id')]];
				$wash_req_amount=$wash_amountArr[$row[csf('job_no')]][$row[csf('id')]];
						// echo $emb_name.'='.$wash_emb_typeCond.' <br>';
					 
				$p_wash_precost_arr[$emb_name]['req_qty']+=$wash_req_qty;
				$p_wash_precost_arr[$emb_name]['req_amount']+=$wash_req_amount;
				$p_wash_precost_arr[$emb_name]['cons']+=$row[csf('cons_dzn_gmts')];
				//$p_wash_precost_arr[$emb_name]['tot_cons']+=$row[csf('cons_dzn_gmts')];
				$p_wash_precost_arr[$emb_name]['amount']+=$row[csf('amount')];
				$p_wash_precost_arr[$emb_name]['p_loss']=$row[csf('p_loss')];
				$p_wash_precost_arr[$emb_name]['sourcing_rate']=$row[csf('sourcing_rate')];
				$p_wash_precost_arr[$emb_name]['pre_rate']=$row[csf('rate')];
				$p_wash_precost_arr[$emb_name]['sourcing_nominated_supp']=$row[csf('sourcing_nominated_supp')];
				$p_wash_precost_arr[$emb_name]['uom']=$unit_of_measurement[$row[csf('uom')]];
				$summ_fob_pcs+=$row[csf('amount')];
				$summ_sourcing_tot_budget_dzn_val+=$wash_req_qty*$row[csf('sourcing_rate')];
				$p_wash_tot_row+=1;	
				}
				else
				{
				$emb_req_qty=$emblishment_qtyArr[$row[csf('job_no')]][$row[csf('id')]];
				$emb_req_amount=$emblishment_amountArr[$row[csf('job_no')]][$row[csf('id')]];
				$p_embro_precost_arr[$emb_name]['req_qty']+=$emb_req_qty;
				$p_embro_precost_arr[$emb_name]['req_amount']+=$emb_req_amount;
				$p_embro_precost_arr[$emb_name]['cons']+=$row[csf('cons_dzn_gmts')];
				//$p_wash_precost_arr[$emb_name]['tot_cons']+=$row[csf('cons_dzn_gmts')];
				$p_embro_precost_arr[$emb_name]['amount']+=$row[csf('amount')];
				$p_embro_precost_arr[$emb_name]['p_loss']=$row[csf('p_loss')];
				$p_embro_precost_arr[$emb_name]['pre_rate']=$row[csf('rate')];
				if($row[csf('sourcing_rate')]>0)
				{
				$p_embro_precost_arr[$emb_name]['sourcing_rate']=$row[csf('sourcing_rate')];
				}
				$p_embro_precost_arr[$emb_name]['sourcing_nominated_supp']=$row[csf('sourcing_nominated_supp')];
				$p_embro_precost_arr[$emb_name]['uom']=$unit_of_measurement[$row[csf('uom')]];
				$summ_fob_pcs+=$row[csf('amount')];
				$summ_sourcing_tot_budget_dzn_val+=$emb_req_qty*$row[csf('sourcing_rate')];
				$p_embro_tot_row+=1;	
				}
				//$summ_fob_value_pcs+=$row[csf('amount')]/$order_price_per_dzn;
				$summ_fob_gross_value_amt+=$emb_req_amount+$wash_req_amount;
			}
			//echo $summ_fob_gross_value_amt.'=';
				//echo $summ_fob_pcs.'A';
				//echo $summ_fob_value_pcs.'C,';
			//wo_pri_quo_comarcial_cost_dtls 
			$sql_other = "select fabric_cost, trims_cost, embel_cost, wash_cost, comm_cost, commission, lab_test, inspection, cm_cost, freight, currier_pre_cost, certificate_pre_cost, design_cost, studio_cost, common_oh, depr_amor_pre_cost, interest_cost, incometax_cost, total_cost from wo_pre_cost_dtls where  job_no=$txt_job_no  and status_active=1 and  is_deleted=0";
			$pre_other_result=sql_select($sql_other);//$summ_fob_value_pcs=0;
			 foreach( $pre_other_result as $row )
			{
				$lab_test=($row[csf('lab_test')]/$order_price_per_dzn)*$order_job_qnty;
				//echo $row[csf('lab_test')].'='.$order_job_qnty.'='.$order_price_per_dzn.'='.$ratio.'<br>';
				$currier_pre_cost=($row[csf('currier_pre_cost')]/$order_price_per_dzn)*$order_job_qnty;
				$inspection=($row[csf('inspection')]/$order_price_per_dzn)*$order_job_qnty;
				$comarcial=($row[csf('comm_cost')]/$order_price_per_dzn)*$order_job_qnty;
				
				$freight=($row[csf('freight')]/$order_price_per_dzn)*$order_job_qnty;
				$certificate_pre_cost=($row[csf('certificate_pre_cost')]/$order_price_per_dzn)*$order_job_qnty;
				$design_pre_cost=($row[csf('design_cost')]/$order_price_per_dzn)*$order_job_qnty;
				$studio_pre_cost=($row[csf('studio_cost')]/$order_price_per_dzn)*$order_job_qnty;
				$common_oh=($row[csf('common_oh')]/$order_price_per_dzn)*$order_job_qnty;
				$depr_amor_pre_cost=($row[csf('depr_amor_pre_cost')]/$order_price_per_dzn)*$order_job_qnty;
				$interest_pre_cost=($row[csf('interest_cost')]/$order_price_per_dzn)*$order_job_qnty;
				$income_tax_pre_cost=($row[csf('incometax_cost')]/$order_price_per_dzn)*$order_job_qnty;
				
				$tot_other_for_fob_value=$lab_test+$currier_pre_cost+$inspection+$comarcial+$freight+$certificate_pre_cost+$design_pre_cost+$studio_pre_cost+$common_oh+$interest_pre_cost+$income_tax_pre_cost+$depr_amor_pre_cost;
				//echo $tot_other_for_fob_value;
				$lab_test_dzn=$row[csf('lab_test')];
				$fob_pcs=$row[csf('price_with_commn_pcs')];
				$currier_pre_cost_dzn=$row[csf('currier_pre_cost')];
				$inspection_dzn=$row[csf('inspection')];
				$comarcial_dzn=$row[csf('comm_cost')];
				
				$common_oh_dzn=$row[csf('common_oh')];
				$studio_pre_cost_dzn=$row[csf('studio_cost')];
				$design_pre_cost_dzn=$row[csf('design_cost')];
				$certificate_pre_cost_dzn=$row[csf('certificate_pre_cost')];
				
				$freight_dzn=$row[csf('freight')];
				//$comm_cost_dzn=$row[csf('comm_cost')];
				$depr_amor_pre_cost_dzn=$row[csf('depr_amor_pre_cost')];
				$income_tax_pre_cost_dzn=$row[csf('incometax_cost')];
				$interest_pre_cost_dzn=$row[csf('interest_cost')];
				
				$cm_cost_dzn=$row[csf('cm_cost')];
				$cm_cost_pcs=$row[csf('cm_cost')]/$order_price_per_dzn;
				$cm_cost_req=($row[csf('cm_cost')]/$order_price_per_dzn)*$order_job_qnty;
				$tot_cm_qty_dzn=$row[csf('cm_cost')]*$po_qty_dzn;
				//$lab_test_dzn=$row[csf('lab_test')];
				
				$tot_other_cost_dzn=$common_oh_dzn+$studio_pre_cost_dzn+$design_pre_cost_dzn+$certificate_pre_cost_dzn+$freight_dzn+$depr_amor_pre_cost_dzn+$income_tax_pre_cost_dzn+$interest_pre_cost_dzn;
				
				$tot_other_cost=($tot_other_cost_dzn/$order_price_per_dzn)*$order_job_qnty;
				//$summ_fob_value_pcs+=($tot_other_cost_dzn+$currier_pre_cost_dzn+$lab_test_dzn+$inspection_dzn+$comarcial_dzn)*$order_price_per_dzn+$cm_cost_pcs;
				
				// echo $tot_other_for_fob_value.'m';
				$summ_fob_gross_value_amt+=$tot_other_for_fob_value+$tot_cm_qty_dzn ;
				
				$summ_fob_pcs+=$tot_other_cost_dzn+$lab_test_dzn+$currier_pre_cost_dzn+$inspection_dzn+$comarcial_dzn+$cm_cost_dzn;
				
				$summ_sourcing_tot_budget_dzn_val+=$tot_other_for_fob_value;
				 
			}
			
		$sql_commi = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls  where job_no=".$txt_job_no." and status_active=1";
		$result_commi=sql_select($sql_commi);
		 foreach( $result_commi as $row )
			{
				$commission_type_id=$row[csf('particulars_id')];
				$com_type_id=$row[csf('commission_base_id')];
				
				$commission_arr[$commission_type_id]['commi_req_amt']=($row[csf('commission_amount')]/$order_price_per_dzn)*$order_job_qnty;
				$commission_arr[$commission_type_id]['commi_amt']=$row[csf('commission_amount')];
				$commission_arr[$commission_type_id]['commi_amt_pcs']=$row[csf('commission_amount')]*$order_price_per_dzn;
				//$summ_fob_value_pcs+=$row[csf('commission_amount')]/$order_price_per_dzn;
				$summ_fob_gross_value_amt+=($row[csf('commission_amount')]/$order_price_per_dzn)*$order_job_qnty;
				$summ_fob_pcs+=$row[csf('commission_amount')];
				$summ_sourcing_tot_budget_dzn_val+=($row[csf('commission_amount')]/$order_price_per_dzn)*$order_job_qnty;
			} 
			$summ_sourcing_fob_pcs=$summ_sourcing_tot_budget_dzn_val/$order_job_qnty;
			$summ_tot_final_cm=($summ_fob_gross_value_amt-$summ_sourcing_tot_budget_dzn_val)/$offer_qty_dzn;
			$tot_summ_fob_pcs=$summ_fob_pcs/$order_price_per_dzn;
			
			 $supplier_library_arr=return_library_array( "select a.short_name, a.id from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id   and a.is_deleted=0  and a.status_active=1 group by a.id,a.short_name order by a.short_name", "id", "short_name");

				?>
                        <td valign="top">
                        	 <table align="left" border="1" cellpadding="1" cellspacing="1" style="width:250px; margin:5px;" rules="all">
                             <caption> <b>Summary </b></caption>
							<tr>
								<td width="80"><b>Header </b></td>
                                <td width="80"><b>Pre Cost</b> </td>
								 
								
							</tr>
                            <tr>
								<td>PO Qty  <?=$unit_of_measurement[$order_uom]; ?></td>
								<td title="=<? echo $order_job_qnty;?>"><b><? 
								//$fob_pcs=$fob_pcs;//$summ_fob_gross_value_amt/$offer_qty_dzn;
								echo  number_format($order_job_qnty,0); ?></b></td>
							 </tr> 
                             
                              <tr>
								<td>Unit Price/ <?=$unit_of_measurement[$order_uom]; ?></td>
								<td title="Price=<? echo $avg_unit_price;?>"><b><? 
								//$fob_pcs=$fob_pcs;//$summ_fob_gross_value_amt/$offer_qty_dzn;
								echo  number_format($avg_unit_price,4); ?></b></td>
							 </tr> 
                             <tr>
								<td>SMV/<?=$unit_of_measurement[$order_uom]; ?></td>
								<td title="=<? //echo $summ_fob_gross_value_amt;?>"><b><? 
								echo  number_format($sew_smv,4); ?></b></td>
							 </tr> 
							<tr>
								<td>FOB/<?=$unit_of_measurement[$order_uom]; ?></td>
								<td  title="FOBValue=<? echo $summ_fob_pcs;?>"><b><? 
								echo  number_format($tot_summ_fob_pcs,4); ?></b></td>
                               
							 </tr> 
                             <tr>
								<td>Margin/<?=$unit_of_measurement[$order_uom]; ?>(USD)</td>
								<td  title="Avg Rate-FoB Pcs=<? //echo $summ_fob_gross_value_amt;?>"><b><? 
								 $margin_pre=$avg_unit_price-$tot_summ_fob_pcs;
								 $margin_final=$avg_unit_price-$summ_sourcing_fob_pcs;
								echo  number_format($margin_pre,6); ?></b></td>
                              
							 </tr> 
							<tr>
								<td>CM/Dzn(USD)</td> 
								<td><b><? echo number_format($cm_cost_dzn,6); ?></b></td>
							 </tr> 
                             <tr>
								<td>E.P.M(USD)</td>
								<td title="CM/Costing Per/Sew SMV"><b><? echo number_format($cm_cost_dzn/$order_price_per_dzn/$sew_smv,6); ?></b></td>
							 </tr> 
						</table>
                        </td>
                        <td valign="top">
                        <?
                        $nameArray_imge =sql_select("SELECT image_location,real_file_name FROM common_photo_library where master_tble_id=".$txt_job_no." and file_type=1");
						?>
                <table width="210">
                <tr>
                <?
				 
				$img_counter = 0;
                foreach($nameArray_imge as $result_imge)
				{
				     

					?>
					<td>
						<!--<img src="../../<? //echo $result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />-->
                        <img src="<? echo $path .''. $result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />
                       <?
					  
					   ?>
					</td>
					<?

					$img_counter++;
				}
				?>
               	 </tr>
                    <tr>
                    <td colspan="2" align="center"><b style="color: #F00; font-size:24px;">
                    <? if( $approved==1)
                    {
                    echo "Approved";
                    }
                    else if( $approved==3)
                    {
                    echo "Partial Approved";
                    }
                    else echo " Un-Approved";
                    ?></b></td>
                    </tr> 
           		</table>
                        </td>
                        </tr>
                       
                        </table>
					<?
			
			 //end first foearch
			
			 
			
			?>
            <table align="left" border="1" cellpadding="0" cellspacing="0"  width="100%" style="margin:5px;" rules="all"> 
              <tr>
             <td  width="100%">
             	<table align="left" border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px;" rules="all"> 
                <tr>
                <th colspan="11" style="background-color:#963;font-size:20px;"> <b>Merchandiser's Part</b></th>
               
                </tr>
                 <tr>
                    <th  width="20">SL </th>
                    <th  width="100" title="Fabric">ITEM DESCRIPTION </th>
                    <th  width="70">Cons/Dzn</th>
                    <th  width="70">Wast % </th>
                    <th  width="70">Total Cons/Dzn</th>
                    <th  width="50">UOM </th>
                    <th  width="70">Req. Qty</th>
                    <th  width="70">Rate(USD)</th>
                    <th  width="70">Cost/Dzn</th>
                    <th  width="70">Cost/Pc</th>
                    <th  width="70">Total Budget</th>
                    
                   
                   
                    </tr>
                    
                    <?
					$f=1;$tot_fab_amount=$tot_fab_amount_pcs=$tot_fab_req_amount=0;$ff=1;$tot_fab_req_sourcing_amount=$tot_fab_req_sourcing_bal_amount=0;
                    foreach($p_fab_precost_arr as $fabriccost_dtls_id=>$fabriccost_dtls_data)
					{
						foreach ($fabriccost_dtls_data as  $fab_type=>$fab_data) 
						{
							 foreach($fab_data as $fab_desc=>$row)
							{
							if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";

							$stock='';
							 if($row[('fabric_source')]==4)
							 {
								$stock="<b style='color:red'> (Stock Fabric) </b>";
							 }
							
							$nominated_supp_str=""; 
							 $exnominated_supp=explode(",",$row[('sourcing_nominated_supp')]);
							 foreach($exnominated_supp as $supp)
							 {
								if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_arr[$supp]; else $nominated_supp_str.=','.$supplier_library_arr[$supp];
							 }	
	                    ?>
	                	<tr bgcolor="<? echo $bgcolor;?>">
	                   
	                    <td width="20" align="center"><p><? echo $f; ?></p></td>
	                   
	                    <td width="100"><div style="word-break:break-all"><? echo $fab_desc.$stock; //echo $fab_type.','.$fab_desc; ?></div></td>
	                    <td width="70" align="right"><p><? echo number_format($row['cons'],6); ?></p></td>
	                    <td width="70" align="right"><p><? echo number_format($row[('p_loss')],6); ?></p></td>
	                    <td width="70" align="right"><p><? echo number_format($row[('tot_cons')],6); ?></p></td>
	                    <td width="50"><p><? echo $row[('uom')]; ?></p></td>
	                    <td width="70" align="right"><p><? echo number_format($row[('req_qty')],6); ?></p></td>
	                    <td width="70" align="right"><p><? echo number_format($row[('req_amount')]/$row[('req_qty')],6); ?></p></td>
	                    <td width="70"align="right"><p><? echo number_format($row[('amount')],6); ?></p></td>
	                    <td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,6); ?></p></td>
	                    <td width="70" align="right"><p><? echo number_format($row[('req_amount')],6); ?></p></td>
	                    
	                  
	                   
	                    </tr>
						<?
							$f++;$ff++;
							$tot_fab_amount+=$row[('amount')];
							$tot_fab_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
							$tot_fab_req_amount+=$row[('req_amount')];
							$tot_fab_req_sourcing_amount+=$row[('sourcing_rate')]*$row[('req_qty')];
							$tot_fab_req_sourcing_bal_amount+=$bal_sourcing_amount;
							}
						}
					}
					?>
                     
                    <tfoot>
                      <tr style="font-size:18px; background-color:#CCC">
                        <td colspan="8"> <b style="float:left">A Total Fabric Cost</b></td>
                        <td  align="right"><b><? echo number_format($tot_fab_amount,6); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_fab_amount_pcs,6); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_fab_req_amount,6); ?></b></td>
                      
                        
                    </tr>
                    </tfoot>
                </table>
                <br>
                <?
               // die;
				?>
                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1"  width="98%" style="text-align:center;margin:5px;" rules="all">
                
                 <thead>
                 <tr>
                 	
                    <th  width="20">SL </th>
                    <th  width="100" title="Trim sew">ITEM DESCRIPTION </th>
                    <th  width="70">Cons/Dzn</th>
                    <th  width="70">Wast % </th>
                    <th  width="70">Total Cons/Dzn</th>
                    <th  width="50">UOM </th>
                    <th  width="70">Req. Qty</th>
                    <th  width="70">Rate(USD)</th>
                    <th  width="70">Cost/Dzn</th>
                    <th  width="70">Cost/Pc</th>
                    <th  width="70">Total Budget</th>
                  
                   
                    
                    </tr>
                    </thead>
                     
                    <?
					$ts=1;$tot_sew_amount=$tot_amount_pcs=$tot_sew_amount_pcs=$tot_sew_req_amount=0;$ttts=1;$tot_sew_req_sourcing_amount=$tot_sew_req_sourcing_bal_amount=0;
                    foreach($p_sew_trim_precost_arr as $item_id=>$row)
					{
						
						if($ts%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
						$nominated_supp_str=""; 
						 $exnominated_supp=explode(",",$row[('sourcing_nominated_supp')]);
						 foreach($exnominated_supp as $supp)
						 {
							if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_arr[$supp]; else $nominated_supp_str.=','.$supplier_library_arr[$supp];
						 }		
                    ?>
                	<tr bgcolor="<? echo $bgcolor;?>">
                   
                    <td width="20" align="center"><p><? echo $ts; ?></p></td>
                    <td width="100" ><div style="word-break:break-all"><? echo $item_id; ?></div></td> 
                    <td width="70" align="right"><p><? echo number_format($row['cons'],6); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('p_loss')],6); ?></p></td>
                    <td width="70" align="right"><p><?  echo number_format($row[('tot_cons')],6); ?></p></td>
                    <td width="50" align="left"><p><? echo $row[('uom')]; ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('req_qty')],6); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('req_amount')]/$row[('req_qty')],6); ?></p></td>
                    <td width="70"align="right"><p><? echo number_format($row[('amount')],6); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,6); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('req_amount')],6); ?></p></td>
                     
                    </tr>
					<?
						$ts++;$ttts++;
						$tot_sew_amount+=$row[('amount')];
						$tot_sew_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
						$tot_sew_req_amount+=$row[('req_amount')];
						$tot_sew_req_sourcing_amount+=$row[('sourcing_rate')]*$row[('req_qty')];
						$tot_sew_req_sourcing_bal_amount+=$bal_sourcing_amout;
						
					}
					?>
                     
                     <tfoot>
                    <tr style="font-size:18px; background-color:#CCC">
                        <td colspan="8" align="left"><b>B-SubTotal for Sewing Trims Cost:</b></td>
                        <td  align="right"><b><? echo number_format($tot_sew_amount,6); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_sew_amount_pcs,6); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_sew_req_amount,6); ?></b></td>
                        
                    </tr>
                    </tfoot>
                     
                </table>
                 <br>
                <table align="left" border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px;" rules="all"> 
                 <tr>
                 	
                    <th width="20">SL </th>
                    <th  width="100" title="Trim Fin">ITEM DESCRIPTION </th>
                    <th  width="70">Cons/Dzn</th>
                    <th width="70">Wast % </th>
                    <th width="70">Total Cons/Dzn</th>
                    <th width="50">UOM </th>
                    <th width="70">Req. Qty</th>
                    <th width="70">Rate(USD)</th>
                    <th width="70">Cost/Dzn</th>
                    <th width="70">Cost/Pc</th>
                    <th width="70">Total Budget</th>
                    </tr>
                     
                    <?
					$tf=1;$tot_fin_amount=$tot_fin_amount_pcs=$tot_fin_req_amount=0;$tttf=1;$tot_fin_req_sourcing_amount=$tot_fin_req_sourcing_bal_amount=0;
                    foreach($p_fin_trim_precost_arr as $item_id=>$row)
					{
						
						if($tf%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
						$nominated_supp_str=""; 
						 $exnominated_supp=explode(",",$row[('sourcing_nominated_supp')]);
						 foreach($exnominated_supp as $supp)
						 {
							if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_arr[$supp]; else $nominated_supp_str.=','.$supplier_library_arr[$supp];
						 }			
                    ?>
                	<tr bgcolor="<? echo $bgcolor;?>">                     
                    <td width="20" align="center"><p><? echo $tf; ?></p></td>
                    <td width="100"><div style="word-break:break-all"><? echo  $item_id; ?></div></td> 
                    
                    <td width="70" align="right"><p><? echo number_format($row[('cons')],6); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('p_loss')],6); ?></p></td>
                    <td width="70" align="right"><p><?  echo number_format($row[('tot_cons')],6); ?></p></td>
                    <td width="50"><p><? echo $row[('uom')]; ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('req_qty')],6); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('req_amount')]/$row[('req_qty')],6); ?></p></td>
                    <td width="70"align="right"><p><? echo number_format($row[('amount')],6); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,6); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('req_amount')],6); ?></p></td>
                    </tr>
                    
                    
					<?
						$tf++;$tttf++;
						$tot_fin_amount+=$row[('amount')];
						$tot_fin_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
						$tot_fin_req_amount+=$row[('req_amount')];
						$tot_fin_req_sourcing_amount+=$fin_sourcing_amount;
						$tot_fin_req_sourcing_bal_amount+=$fin_bal_sourcing_amout;
						
					}
					?>
                     
                    <tfoot>
                     <tr style="font-size:18px; background-color:#CCC">
                      
                        <td colspan="8"> <b>C-Sub Total for Finishing & Packing Trims Cost:</b></td>
                        <td  align="right"><b><? echo number_format($tot_fin_amount,6); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_fin_amount_pcs,6); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_fin_req_amount,6); ?></b></td>
                       
                        
                        
                    </tr>
                    
                    <tr style="font-size:18px; background-color:#CCC">
                       
                        <td colspan="8"><b>Total Trims Cost [B+C]:</b></td>
                        <td  align="right"><b><? $trim_sew_fin_amt=$tot_sew_amount+$tot_fin_amount;echo number_format($trim_sew_fin_amt,6); ?></b></td>
                        <td  align="right"><b><? $trim_sew_fin_amt_pcs=$tot_sew_amount_pcs+$tot_fin_amount_pcs; echo number_format($trim_sew_fin_amt_pcs,6); ?></b></td>
                        <td  align="right"><b><? $trim_fin_req_amount=$tot_sew_req_amount+$tot_fin_req_amount; echo number_format($trim_fin_req_amount,6); ?></b></td>
                      
                       
                        
                    </tr>
                  </tfoot>
                </table>
                <br>
                 <?
                // die;
				 ?>
                <table align="left" border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px;" rules="all"> 
                <caption><b style="float:left">Gmts Wash</b></caption>
                 <tr>
                  
                    <th width="20">SL </th>
                    <th width="100" title="Wash ">ITEM DESCRIPTION </th>
                    <th width="70">Cons/Dzn</th>
                    <th width="70">Wast % </th>
                    <th width="70">Total Cons/Dzn</th>
                    <th width="50">UOM </th>
                    <th width="70">Req. Qty</th>
                    <th width="70"> Rate(USD)</th>
                    <th width="70">Cost/Dzn</th>
                    <th width="70">Cost/Pc</th>
                    <th width="70">Total Budget</th>
                    </tr>
                    
                    <?
					$w=1;$tot_wash_amount=$tot_wash_amount_pcs=$tot_wash_req_amount=$tot_wash_sourcing_req_amount=$tot_wash_sourcing_req_amount_bal=0;$ws=1;
                    foreach($p_wash_precost_arr as $embname_id=>$row)
					{
						
						if($w%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
						$wash_nominated_supp_str=""; 
						 $exnominated_suppArr=explode(",",$row[('sourcing_nominated_supp')]);
						 foreach($exnominated_suppArr as $supp)
						 {
							if($wash_nominated_supp_str=="") $wash_nominated_supp_str=$supplier_library_arr[$supp]; else $wash_nominated_supp_str.=','.$supplier_library_arr[$supp];
						 }		
                    ?>
                	<tr bgcolor="<? echo $bgcolor;?>">
                    
                    <td width="20" align="center"><p><? echo $w; ?></p></td>
                    <td width="100"><div style="word-break:break-all"><? $embname_id=explode(", ",$embname_id);echo $embname_id[1]; ?></div></td> 
                    
                    <td width="70" align="right"><p><? echo number_format($row[('cons')],6); ?></p></td>
                    <td width="70" align="right"><p><? //echo $row[('p_loss')]; ?></p></td>
                    <td width="70" align="right"><p><?  echo number_format($row[('cons')],6) ?></p></td>
                    <td width="50"><p><? echo 'Dzn'; ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('req_qty')],6); ?></p></td>
                    <td width="70" align="right" title="Rate=<? echo $row[('pre_rate')];?>"><p><? echo number_format($row[('pre_rate')],6); ?></p></td>
                    <td width="70"align="right"><p><? echo number_format($row[('amount')],6); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,6); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('req_qty')]*$row[('pre_rate')],6); ?></p></td>
                    
                    </tr>
                    
                    
					<?
						$w++;$ws++;
						$tot_wash_amount+=$row[('amount')];
						$tot_wash_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
						$tot_wash_req_amount+=$row[('req_qty')]*$row[('pre_rate')];
						$tot_wash_sourcing_req_amount+=$sourcing_tot_amount;
						$tot_wash_sourcing_req_amount_bal+=$sourcing_tot_amount_bal;
						
					}
					?>
                     
                    <tfoot>
                    <tr style="font-size:20px; background-color:#CCC">
                         
                        <td colspan="8"> <b>D-Total Wash Cost :</b></td>
                        <td  align="right"><b><? echo number_format($tot_wash_amount,6); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_wash_amount_pcs,6); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_wash_req_amount,6); ?></b></td>
                      
                        
                    </tr>
                    
                   
                  </tfoot>
                </table>
                <br>
               
                <table align="left" border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px;" rules="all"> 
                <caption><b style="float:left">Embellishment Cost</b></caption>
                 <tr>
                 	 
                    <th width="20">SL </th>
                    <th width="100" title="">ITEM DESCRIPTION </th>
                    <th width="70">Cons/Dzn</th>
                    <th width="70">Wast % </th>
                    <th width="70">Total Cons/Dzn</th>
                    <th width="50">UOM </th>
                    <th width="70">Req. Qty</th>
                    <th width="70">Rate(USD)</th>
                    
                    <th width="70">Cost/Dzn</th>
                    <th width="70">Cost/Pc</th>
                    <th width="70">Total Budget</th>
                   
                    
                    </tr>
                      
                    <?
					$em=1;$tot_embro_amount=$tot_embro_amount_pcs=$tot_embro_req_amount=$tot_emb_sourcing_req_amount=$tot_emb_sourcing_req_amount_bal=0;$emb=1;
                    foreach($p_embro_precost_arr as $embname_id=>$row)
					{
						
						if($w%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
						$emb_nominated_supp_str=""; 
						 $emb_exnominated_suppArr=explode(",",$row[('sourcing_nominated_supp')]);
						 foreach($emb_exnominated_suppArr as $supp)
						 {
							if($emb_nominated_supp_str=="") $emb_nominated_supp_str=$supplier_library_arr[$supp]; else $emb_nominated_supp_str.=','.$supplier_library_arr[$supp];
						 }		
                    ?>
                	<tr bgcolor="<? echo $bgcolor;?>">
                     
                    <td width="20" align="center"><p><? echo $em; ?></p></td>
                    <td width="100"><div style="word-break:break-all"><? echo $embname_id; ?></div></td> 
                    
                    <td width="70" align="right"><p><? echo number_format($row[('cons')],6); ?></p></td>
                    <td width="70" align="right"><p><? //echo $row[('p_loss')]; ?></p></td>
                    <td width="70" align="right"><p><?  echo number_format($row[('cons')],6); ?></p></td>
                    <td width="50"><p><? echo 'Dzn'; ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('req_qty')],6); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('req_amount')]/$row[('req_qty')],6); ?></p></td>
                    <td width="70"align="right"><p><? echo number_format($row[('amount')],6); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,6); ?></p></td>
                    <td width="70" align="right"><b><? echo number_format($row[('req_amount')],6); ?></b></td>
                    
                   
                    
                      
                    </tr>
					<?
						$em++;$emb++;
						$tot_embro_amount+=$row[('amount')];
						$tot_embro_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
						$tot_embro_req_amount+=$row[('req_amount')];
						$tot_emb_sourcing_req_amount+=$emb_sourcing_tot_amount;
						$tot_emb_sourcing_req_amount_bal+=$emb_sourcing_tot_amount_bal;
						
					}
					?>
                     
                    <tfoot>
                     <tr style="font-size:20px; background-color:#CCC">
                         
                        <td colspan="8"> <b>E-Total Embellishment Cost:</b></td>
                        <td  align="right"><b><? echo number_format($tot_embro_amount,6); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_embro_amount_pcs,6); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_embro_req_amount,6); ?></b></td>
                       
                    </tr>
                  </tfoot>
                </table>
                <br>
                 
                <table align="left" border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px;" rules="all"> 
                <caption><b style="float:left">Others Components</b></caption>
                 <tr>
                 	 
                    <th width="20">SL </th>
                    <th title="520"><b>Others Components</b> </th>
                   
                    <th width="70"><b>Cost/Dzn</b></th>
                    <th width="70"><b>Cost/Pc</b></th>
                    <th width="70"><b>Total Budget</b></th>
                    
                  
                    </tr>
                    <tbody> 
                    <?
					//$em=1;$tot_embro_amount=$tot_embro_amount_pcs=$tot_embro_req_amount=0;$emb=1;
						$bgcolor="#E9F3FF";
						$bgcolor2="#FFFFFF";//currier_pre_cost_dzn
					 
                      
                   // $tot_other_cost=0;
					$tot_other_cost_first=$tot_other_cost+$comarcial+$inspection+$currier_pre_cost+$lab_test;
					
						$total_other_cost_dzn=$tot_other_cost_dzn+$comarcial_dzn+$inspection_dzn+$lab_test_dzn+$currier_pre_cost_dzn;
						 $tot_other_cost_pcs=$tot_other_cost_dzn/$order_price_per_dzn;
						 $tot_comarcial_dzn_pcs=$comarcial_dzn/$order_price_per_dzn;
						 $tot_inspection_dzn_pcs=$inspection_dzn/$order_price_per_dzn;
						  $currier_pre_cost_dzn_pcs=$currier_pre_cost_dzn/$order_price_per_dzn;
						  $tot_lab_test_dzn_pcs=$lab_test_dzn/$order_price_per_dzn;
						 
						$total_other_cost_pcs=$tot_other_cost_pcs+$tot_comarcial_dzn_pcs+$tot_lab_test_dzn_pcs+$tot_inspection_dzn_pcs+$currier_pre_cost_dzn_pcs;
						
						
						
						$tot_other_cost_req_amount=$tot_other_cost_first;
						
					
					?>
                	<tr bgcolor="<? echo $bgcolor;?>">
                    
                    <td width="20" align="center"><p>1</p></td>
                    <td width="520" align="" ><b>Test Charge</b></td> 
                    <td width="70"align="right"><p><? echo number_format($lab_test_dzn,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><?   echo number_format($tot_lab_test_dzn_pcs,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($lab_test,6); ?>&nbsp;</p></td>
                    
                    
                    
                    </tr>
                     <td width="20" align="center" ><p>2</p></td>
                    <td width="520"><b>Courier Charge</b></td> 
                    <td width="70"align="right"><p><? echo number_format($currier_pre_cost_dzn,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><?  echo number_format($currier_pre_cost_dzn_pcs,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($currier_pre_cost,6); ?>&nbsp;</p></td>
                   
                    </tr>
                    
                    <tr bgcolor="<? echo $bgcolor2;?>">
                    
                    <td width="20" align="center" ><p>3</p></td>
                    <td width="520"><b>Inspection Charge</b></td> 
                    <td width="70"align="right"><p><? echo number_format($inspection_dzn,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($tot_inspection_dzn_pcs,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($inspection,6); ?>&nbsp;</p></td>
                   
                     
                    </tr>
                    
                    <tr bgcolor="<? echo $bgcolor;?>">
                    
                    <td width="20" align="center" ><p>4</p></td>
                    <td width="520"><b>Commercial Charge</b></td> 
                    <td width="70"align="right"><p><? echo number_format($comarcial_dzn,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><?  echo number_format($tot_comarcial_dzn_pcs,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($comarcial,6); ?>&nbsp;</p></td>
                  
                       
                    </tr>
                    <tr bgcolor="<? echo $bgcolor2;?>">
                     
                    <td width="20" align="center"><p>5</p></td>
                    <td width="520" title="Freight+Certif.Cost+Design Cost+Studio Cost+Deprec.&Amort.+Operating Expenses+Deprec.&Amort.+Interest+Income Tax">
                    <b>Others Charge</b></td> 
                   
                     <td width="70"align="right"><p><? echo number_format($tot_other_cost_dzn,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($tot_other_cost_pcs,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($tot_other_cost,6); ?>&nbsp;</p></td>
                   
                     
                    </tr>
					
                    </tbody>
                    <tfoot>
                     <tr style="font-size:20px; background-color:#CCC">
                         
                        <td colspan="2"> <b>F-Total Others Cost:</b></td>
                        <td  align="right"><b><? echo number_format($total_other_cost_dzn,6); ?>&nbsp;</b></td>
                        <td  align="right"><b><? echo number_format($total_other_cost_pcs,6); ?>&nbsp;</b></td>
                        <td  align="right"><b><? echo number_format($tot_other_cost_req_amount,6); ?>&nbsp;</b></td>
                        
                        
                     
                        
                    </tr>
                  </tfoot>
                </table>
                <br>
             
                 <table align="left" border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px;" rules="all"> 
                <caption><b style="float:left"> Commission Cost:</b></caption>
                   <tr>
                 	 
                    <th  width="20">SL </th>
                    <th width="520" title="">Commission Cost </th>
                    <th width="70">Cost/Dzn</th>
                    <th  width="70">Cost/Pc</th>
                    <th  width="70">Total Budget</th>
                    
                   
                    
                    
                     
                    </tr>
                    <tbody> 
                    <?
                     
						$tot_commission_amount=$commission_arr[1]['commi_amt']+$commission_arr[2]['commi_amt'];
						$tot_commission_amount_pcs=($commission_arr[1]['commi_amt']/$order_price_per_dzn)+($commission_arr[2]['commi_amt']/$order_price_per_dzn);
						$tot_commision_req_amount=$commission_arr[1]['commi_req_amt']+$commission_arr[2]['commi_req_amt'];
						
					
					?>
					 
                   <tr bgcolor="<? echo $bgcolor;?>">
                    
                    <td width="20" align="center"><p>1</p></td>
                    <td width="520"  title="Local"><b>UK Office Commission</b></td> 
                    <td width="70"align="right"><p><? echo number_format($commission_arr[2]['commi_amt'],6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($commission_arr[2]['commi_amt']/$order_price_per_dzn,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($commission_arr[2]['commi_req_amt'],6); ?>&nbsp;</p></td>
                    
                     
                     
                    </tr>
                    <tr bgcolor="<? echo $bgcolor2;?>">
                     
                    <td width="20" align="center"><p>2</p></td>
                    <td width="520"><b>Buying Commission</b></td> 
                    <td width="70"align="right"><p><? echo number_format($commission_arr[1]['commi_amt'],6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($commission_arr[1]['commi_amt']/$order_price_per_dzn,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($commission_arr[1]['commi_req_amt'],6); ?>&nbsp;</p></td>
                    
                     
                    </tr>
					
                    </tbody>
                    <tfoot>
                    <tr>
                         
                        <td colspan="2"> <b>G-Total Commission Cost:</b></td>
                        <td  align="right"><b><? echo number_format($tot_commission_amount,6); ?>&nbsp;</b></td>
                        <td  align="right"><b><? echo number_format($tot_commission_amount_pcs,6); ?>&nbsp;</b></td>
                        <td  align="right"><b><? echo number_format($tot_commision_req_amount,6); ?>&nbsp;</b></td>
                       
                        
                    </tr>
                    
                    <tr bgcolor="<? echo $bgcolor;?>">
                    
                    <td width="20" align="center"><p>1</p></td>
                    <td width="520"><b>H-Total CM Cost</b></td> 
                    <td width="70"align="right"><b><? echo number_format($cm_cost_dzn,6); ?>&nbsp;</b></td>
                    <td width="70" align="right"><b><? $tot_cm_cost_pcs=$cm_cost_dzn/$order_price_per_dzn;echo number_format($tot_cm_cost_pcs,6); ?>&nbsp;</b></td>
                    <td width="70" title="CM Dzn*PO Qty Dzn" align="right"><b><? echo number_format($tot_cm_qty_dzn,6); ?>&nbsp;</b></td>
                  
                    </tr>
                    
                    <tr bgcolor="<? echo $bgcolor;?>">
                    <td width="520" colspan="2"><p> <b>Gross FOB Value [A+B+C+D+E+F+G+H]</b></p></td> 
                    <td width="70"align="right"><b><?  //tot_embro_amount_pcs tot_embro_req_amount
					$gross_fob_value_dzn=$tot_fab_amount+$trim_sew_fin_amt+$tot_wash_amount+$tot_embro_amount+$tot_other_cost_dzn+$tot_commission_amount+$cm_cost_dzn;
					$gross_fob_value_pcs=$tot_fab_amount_pcs+$trim_sew_fin_amt_pcs+$tot_wash_amount_pcs+$tot_embro_amount_pcs+$tot_other_cost_pcs+$tot_commission_amount_pcs+$tot_cm_cost_pcs;
					//echo $tot_fab_amount_pcs.'=='.$trim_sew_fin_amt_pcs.'=='.$tot_wash_amount_pcs.'=='.$tot_embro_amount_pcs.'=='.$tot_commission_amount_pcs.'=='.$tot_cm_cost_pcs;
					//$gross_fob_value_req=$tot_fab_req_amount+$trim_fin_req_amount+$tot_wash_req_amount+$tot_embro_req_amount+$tot_commision_req_amount+$tot_other_cost_req_amount+$cm_cost_req;
					
					$gross_fob_value_req=$tot_fab_req_amount+$trim_fin_req_amount+$tot_wash_req_amount+$tot_embro_req_amount+$tot_other_cost_req_amount+$tot_commision_req_amount+$tot_cm_qty_dzn;

					
					 //---fob value
					 $total_fob_gross_pcs=$tot_fab_amount_pcs+$trim_sew_fin_amt_pcs+$tot_wash_amount_pcs+$tot_embro_amount_pcs+$tot_other_cost_pcs+$tot_commission_amount_pcs+$tot_cm_cost_pcs;
		$total_fob_gross_dzn=$tot_fab_amount+$trim_sew_fin_amt+$tot_wash_amount+$tot_embro_amount+$total_other_cost_dzn+$tot_commission_amount+$cm_cost_dzn;
					$tot_gross_fob_pcs=$total_fob_gross_dzn/$order_price_per_dzn;
					 $gross_fob_value_dzn_without_commi=$total_fob_gross_dzn-$tot_commission_amount;
					$gross_fob_value_pcs_without_commi=$tot_gross_fob_pcs-$tot_commission_amount_pcs;
					$gross_fob_value_req_without_commi=$gross_fob_value_req-$tot_commision_req_amount;
					
					echo number_format($total_fob_gross_dzn,6); ?>&nbsp;</b></td>
                    <td width="70" align="right"><b><? echo number_format($tot_gross_fob_pcs,6); ?>&nbsp;</b></td>
                    <td width="70" align="right"><b><? echo number_format($gross_fob_value_req,6); ?>&nbsp;</b></td>
                   
                    </tr>
                    <?
                   
					?>
                     <tr bgcolor="<? echo $bgcolor2;?>">
                    <td width="520" colspan="2"><b>Net FOB Value (Without Commission)</b></td> 
                    <td width="70"align="right"><b><? echo number_format($gross_fob_value_dzn_without_commi,6); ?> </b></td>
                    <td width="70" align="right"><b><? echo number_format($gross_fob_value_pcs_without_commi,6); ?> </b></td>
                    <td width="70" align="right"><b><? echo number_format($gross_fob_value_req_without_commi,6); ?> </b></td>
                   
                    </tr>
                   
                  </tfoot>
                </table>
                
             </td>
              </tr>
              
           </table>
          
           <div style="float:left" align="left">  <b> &nbsp;&nbsp;&nbsp;&nbsp; <? //echo $inserted_by;?> </b></div>
           <div style="clear:both"></div>
           <? 
		   

			$cbo_company_name=str_replace("'","",$cbo_company_name);
			//echo signature_table(219, $cbo_company_name, "1320px"); 
			if ($cbo_template_id != '') {
				$template_id = " and a.template_id=$cbo_template_id ";
			}
			$sql = sql_select("SELECT a.designation, a.name, a.user_id, a.prepared_by, b.sequence_no FROM    variable_settings_signature a LEFT JOIN electronic_approval_setup b ON a.user_id = b.user_id and b.page_id=1717 and b.entry_form=46 and b.company_id=a.company_id and b.is_deleted=0 WHERE a.report_id = 218 AND a.company_id = '$cbo_company_name' $template_id group by a.designation, a.name, a.user_id, a.prepared_by, b.sequence_no ORDER BY a.sequence_no");
			$user_information=array();
			
			foreach($sql as $row)
			{
				$user_information[$row[csf('user_id')]]['name']=$row[csf('name')];
				$user_information[$row[csf('user_id')]]['designation']=$row[csf('designation')];
				$user_information[$row[csf('user_id')]]['prepared_by']=$row[csf('prepared_by')];
			}
		$inserted_by=return_field_value("inserted_by", "wo_pre_cost_mst", "job_no='".str_replace("'","",$txt_job_no)."'");
		
	   $ssql="SELECT a.user_id as user_id,b.sequence_no  from variable_settings_signature a, electronic_approval_setup b,approval_history c,wo_pre_cost_mst d where a.user_id=b.user_id and a.user_id=c.approved_by and c.mst_id=d.id and d.job_no='".str_replace("'","",$txt_job_no)."'  and a.report_id=218 and a.company_id='$cbo_company_name' and a.template_id=$cbo_template_id and b.page_id=1717 and b.entry_form=46 and b.company_id=$cbo_company_name and c.entry_form=46 group by a.user_id,b.sequence_no";
	   $signature_photo = sql_select("SELECT c.master_tble_id as MASTER_TBLE_ID,c.image_location as IMAGE_LOCATION  from common_photo_library c where c.form_name='user_signature' group by c.master_tble_id,c.image_location");
	   	//echo $ssql;
	   $signature_sql = sql_select($ssql);
	    $isApprovedUser=array();
	    foreach($signature_sql as $row)
	    {
	    	$isApprovedUser[$row[csf('user_id')]]=$row[csf('sequence_no')];
	    }
		$signature_location=array();
		foreach($signature_photo as $row)
		{
			$signature_location[$row['MASTER_TBLE_ID']]=$row['IMAGE_LOCATION'];
		}
		if($sql[0][csf("prepared_by")]==1){
			list($prepared_by,$activities)=explode('**',$prepared_by);
			$sql_2[100] = array ( DESIGNATION => 'Prepared By' ,NAME => $prepared_by, ACTIVITIES =>$activities, PREPARED_BY => 0 );
			//$sql=$sql_2+$sql;
			$sql=$sql_2+$sql;
			//print_r($sql);
		}
		$count = count($sql);
		
		$td_width = floor(1000 / $count);
		$standard_width = $count * 150;
		if ($standard_width > 1000) {
			$td_width = 150;
		}
		$i = 1;
		if ($count == 0) { echo "<b>Note: This is Software Generated Copy , Signature is not Required.</b>";}
		else
		{
			echo '<table id="signatureTblId" width="1000" style="padding-top:50px;"><tr><td width="100%" height="50" colspan="' . $count . '">' . $message . '</td></tr><tr>';
			foreach ($sql as $key=>$row) {
				echo '<td width="' . $td_width . '" align="center" valign="bottom">';
				//check isApproved
				$sequence_no='';
				$sequence_no=$isApprovedUser[$row[csf('user_id')]];
				if($signature_location[$row[csf('user_id')]]!='' && $sequence_no==$row[csf('sequence_no')] && $key!=100)
				{
					echo '<strong><img src="../../'.$signature_location[$row[csf('user_id')]].'" height="60" width="90" ></strong><br>';
					
				}
				else if($key==100 && $signature_location[$inserted_by]!='')
				{
					echo '<strong><img src="../../'.$signature_location[$inserted_by].'" height="60" width="90" ></strong><br>';
				}
				else
				{
					echo '<span style="height:60px;width:90px;"></span><br>';
				}
				echo '<strong style="text-decoration:overline">' . $row[csf("designation")] . "</strong><br>" . $row[csf("name")] . '</td>';
				//echo '<strong style="text-decoration:overline">' . $user_information[$row[csf('user_id')]]['designation']. "</strong><br>" . $user_information[$row[csf('user_id')]]['name'] . '</td>';
				$i++;
			}
			echo '</tr></table>';
		}
 
			
 
		?>            
     </div>
    
      <div style="clear:both"></div>
     
    <?
	$mailBody=ob_get_contents();
	ob_clean();
	echo $mailBody;

	//Mail send------------------------------------------
	list($msil_address,$is_mail_send,$mail_body)=explode('**',$mail_data);
	if($is_mail_send==1){
	
		require_once('../../../mailer/class.phpmailer.php');
		require_once('../../../auto_mail/setting/mail_setting.php');
		
		$mailBody = preg_replace("/<img[^>]+\>/i", " ", $mailBody); 	
		$mailToArr=array();
		if($msil_address){$mailToArr[]=$msil_address;}
			
		$mailSql = "SELECT c.TEAM_LEADER_EMAIL, d.USER_EMAIL
  FROM wo_po_details_master  a,  wo_pre_cost_mst b, lib_marketing_team c, USER_PASSWD d
 WHERE a.job_no = b.job_no  AND a.TEAM_LEADER = c.id AND b.INSERTED_BY = d.id AND a.status_active = 1  AND a.job_no=$txt_job_no";
		
		//echo $mailSql;die;
		
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows['TEAM_LEADER_EMAIL']){$mailToArr[$rows['TEAM_LEADER_EMAIL']]=$rows['TEAM_LEADER_EMAIL'];}
			if($rows['USER_EMAIL']){$mailToArr[$rows['USER_EMAIL']]=$rows['USER_EMAIL'];}
		}
		
		//$elcetronicSql = "SELECT a.SEQUENCE_NO,a.BYPASS,b.USER_EMAIL  from electronic_approval_setup a join user_passwd b on a.user_id=b.id where b.valid=1 and a.page_id=2150 and a.entry_form=46 and a.company_id=$cbo_company_name order by a.SEQUENCE_NO";
		
		$elcetronicSql = "SELECT a.BUYER_ID,a.SEQUENCE_NO,a.BYPASS,b.USER_EMAIL  from electronic_approval_setup a join user_passwd b on a.user_id=b.id where b.valid=1  AND a.page_id in(428,1717,2150) and a.company_id=$cbo_company_name order by a.SEQUENCE_NO"; //and a.page_id=2150 and a.entry_form=46
		//echo $elcetronicSql;die;
		
		$elcetronicSqlRes=sql_select($elcetronicSql);
		foreach($elcetronicSqlRes as $rows){
			
			/*if($rows[BUYER_ID]!=''){
				 
				foreach(explode(',',$rows[BUYER_ID]) as $bi){
					if($rows[USER_EMAIL]!='' && $rows[BYPASS]==2 && $bi==$buyer_name_id){
						$mailToArr[100]=$rows[USER_EMAIL];break;
					}
				}
			}
			else{
			
				if($rows[SEQUENCE_NO]==1 && $rows[BYPASS]==2){
					if($rows[USER_EMAIL]){$mailToArr[100]=$rows[USER_EMAIL];}
				}
			}
			
			$elecDataArr[$rows[BYPASS]][]=$rows[USER_EMAIL];*/
			
			if($rows[BUYER_ID]!=''){
				foreach(explode(',',$rows[BUYER_ID]) as $bi){
					if($rows['USER_EMAIL']!='' && $bi==$buyer_name_id){$mailToArr[$rows['USER_EMAIL']]=$rows['USER_EMAIL'];}
					if($rows[BYPASS]==2){break;}
				}
			}
			else{
				if($rows['USER_EMAIL']){$mailToArr[$rows['USER_EMAIL']]=$rows['USER_EMAIL'];}
				if($rows[BYPASS]==2){break;}
			}

		}
		
		//print_r($mailToArr);die;
		
		//if($elecDataArr[1][0] && $mailToArr[100]==""){$mailToArr[]=$elecDataArr[1][0];}
		//elseif($elecDataArr[2][0] && $mailToArr[100]==""){$mailToArr[]=$elecDataArr[2][0];}
		//Un-approve request mail......................................................
		$user_id=$_SESSION['logic_erp']['user_id'];
		$job_id=return_field_value("id", "wo_pre_cost_mst", "job_no='".str_replace("'","",$txt_job_no)."'");
		$approved_no=return_field_value("MAX(approved_no) as approved_no","approval_history","entry_form=46 and mst_id=$job_id","approved_no")+1;
		$unapproved_request=return_field_value("APPROVAL_CAUSE","fabric_booking_approval_cause","entry_form=46 and user_id=$user_id and booking_id=$job_id and approval_type=2 and approval_no='$approved_no'");//page_id=$page_id and
		if($unapproved_request){
			$mailToArr=array();
			//if($msil_address){$mailToArr[]=$msil_address;}
			$final_app_user_mail=return_field_value("USER_EMAIL","user_passwd","id in(select APPROVED_BY from APPROVAL_HISTORY where id in(select max(id) from APPROVAL_HISTORY where mst_id=$job_id and ENTRY_FORM=46 and CURRENT_APPROVAL_STATUS=1))");
			$mailToArr[]= $final_app_user_mail;
		}
		$mailBody=$mail_body."<br>".$unapproved_request."<br>".$mailBody;
		//......................................................Un-approve request mail;
		$to=implode(',',$mailToArr);
		// echo $to;die;
		 
		
		//Att file....
		$imgSql="select IMAGE_LOCATION,REAL_FILE_NAME from common_photo_library where is_deleted=0  and MASTER_TBLE_ID=$txt_job_no and file_type=1";
		$imgSqlResult=sql_select($imgSql);
		foreach($imgSqlResult as $rows){
			$att_file_arr[]='../../../'.$rows['IMAGE_LOCATION'].'**'.$rows['REAL_FILE_NAME'];
		}
		
		$subject="BOM Pre Cost Report";
		$header=mailHeader();
		echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
		
	}
	
	//------------------------------------End;
	
	exit();
}

if($action=="preCostRpt2")//Cost Rpt2 BTN 2
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";

	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	$costing_date=str_replace("'","",$txt_costing_date);
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and b.costing_date='".$txt_costing_date."'";
	$poBreackDownId=str_replace("'","",$txt_po_breack_down_id);
	if($poBreackDownId==""){$poId_cond='';$poId_cond2='';}else{$poId_cond=" and id in ($poBreackDownId)"; $poId_cond2=" and b.id in ($poBreackDownId)";}
	

	//array for display name txt_po_breack_down_id
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');


	if($db_type==0) $group_gsm="group_concat( distinct b.gsm_weight) AS gsm_weight";
	if($db_type==2) $group_gsm="listagg(b.gsm_weight ,',') within group (order by b.gsm_weight) AS gsm_weight";

	$gsm_weight_top=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and a.body_part_type=1","gsm_weight");
	$gsm_weight_bottom=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and a.body_part_type=20 ","gsm_weight");

	/*$weight_type= sql_select("SELECT gsm_weight_type from  wo_pre_cost_fabric_cost_dtls where job_no=$txt_job_no");
	foreach ($weight_type as $row) {
		$fabric_weight_type[$row[csf('gsm_weight_type')]] = $fabric_weight_type[$row[csf('gsm_weight_type')]];
	}*/

	 $po_qty=0;
	 $po_plun_cut_qty=0;
	 $total_set_qnty=0;
	 $sql_po="SELECT a.job_no,a.total_set_qnty,b.id,c.item_number_id,c.country_id,c.color_number_id,c.size_number_id,c.order_quantity ,c.plan_cut_qnty  
	 from wo_po_details_master a, 
	 	wo_po_break_down b,
	 	wo_po_color_size_breakdown c 
	where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst   and b.id=c.po_break_down_id  and a.job_no =".$txt_job_no." $poId_cond2   and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 order by b.id";
	$sql_po_data=sql_select($sql_po);
	foreach($sql_po_data as $sql_po_row){
		$po_qty+=$sql_po_row[csf('order_quantity')];
		$po_plun_cut_qty+=$sql_po_row[csf('plan_cut_qnty')];
		$total_set_qnty=$sql_po_row[csf('total_set_qnty')];
		$po_id_arr[$sql_po_row[csf('id')]]=$sql_po_row[csf('id')];
	}
	$po_id_str= implode( ",",$po_id_arr);
	
	$sales_contract_sql=sql_select("SELECT a.contract_no,b.wo_po_break_down_id from com_sales_contract a join com_sales_contract_order_info b on a.id=b.com_sales_contract_id where a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.wo_po_break_down_id in ($po_id_str) group by a.contract_no, b.wo_po_break_down_id");
	$sales_contract_arr=array();
	if(count($sales_contract_sql)>0)
	{
		foreach ($sales_contract_sql as $key => $row) {
			$sales_contract_arr[$row[csf('wo_po_break_down_id')]]=$row[csf('contract_no')];
		}
	}

	$export_lc_sql=sql_select("SELECT a.export_lc_no,b.wo_po_break_down_id from com_export_lc a join com_export_lc_order_info b on a.id=b.com_export_lc_id where a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.wo_po_break_down_id in ($po_id_str) group by a.export_lc_no,b.wo_po_break_down_id");
	$export_lc_arr=array();
	if(count($export_lc_sql)>0)
	{
		foreach ($export_lc_sql as $key => $row) {
			$export_lc_arr[$row[csf('wo_po_break_down_id')]]=$row[csf('export_lc_no')];
		}
	}
	$sc_lc_no="";
	if(count($sales_contract_arr)>0)

	{
		$sc_lc_no=implode(",", $sales_contract_arr);
	}
	if(count($export_lc_arr)>0)
	{
		$sc_lc_no=implode(",", $export_lc_arr);
	}

	//echo $po_qty;

	$gmtsitem_ratio_array=array();
	$gmtsitem_ratio_sql=sql_select("SELECT job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no =".$txt_job_no."");// where job_no ='FAL-14-01157'
	foreach($gmtsitem_ratio_sql as $gmtsitem_ratio_sql_row){
	$gmtsitem_ratio_array[$gmtsitem_ratio_sql_row[csf('job_no')]][$gmtsitem_ratio_sql_row[csf('gmts_item_id')]]=$gmtsitem_ratio_sql_row[csf('set_item_ratio')];
	}
	$costing_per_arr=return_library_array( "SELECT job_no,costing_per from wo_pre_cost_mst where job_no =".$txt_job_no."", "job_no", "costing_per");// where job_no ='FAL-14-01157'
	$financial_para=array();
	$sql_std_para=sql_select("SELECT applying_period_date,applying_period_to_date,interest_expense,income_tax,cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and status_active=1 and	is_deleted=0 order by id desc");
	foreach($sql_std_para as $sql_std_row){
		//$financial_para[interest_expense]=$sql_std_row[csf('interest_expense')];
		//$financial_para[income_tax]=$sql_std_row[csf('income_tax')];
		//$financial_para[cost_per_minute]=$sql_std_row[csf('cost_per_minute')];
		$applying_period_date=change_date_format($sql_std_row[csf('applying_period_date')],'','',1);
		$applying_period_to_date=change_date_format($sql_std_row[csf('applying_period_to_date')],'','',1);
		$diff=datediff('d',$applying_period_date,$applying_period_to_date);
		for($j=0;$j<$diff;$j++)
		{
			$date_all=add_date(str_replace("'","",$applying_period_date),$j);
			$newdate =change_date_format($date_all,'','',1);
			$financial_para[$newdate][interest_expense]=$sql_std_row[csf('interest_expense')];
			$financial_para[$newdate][income_tax]=$sql_std_row[csf('income_tax')];
			$financial_para[$newdate][cost_per_minute]=$sql_std_row[csf('cost_per_minute')];
		}
	}
	$pre_costing_date=change_date_format($costing_date,'','',1);

	$fab_knit_req_kg_avg=0;
	$fab_woven_req_yds_avg=0;
	if($db_type==0){
	//$sql = "select a.job_no, a.company_name, a.buyer_name, a.style_ref_no, a.quotation_id, a.gmts_item_id, a.order_uom, a.job_quantity, a.avg_unit_price, b.costing_per, b.budget_minute, b.sew_smv, b.cut_smv, b.sew_effi_percent, b.cut_effi_percent, b.approved, c.fab_knit_req_kg, c.fab_knit_fin_req_kg, c.fab_woven_req_yds, c.fab_woven_fin_req_yds, c.fab_yarn_req_kg from wo_po_details_master a, wo_pre_cost_mst b left join wo_pre_cost_sum_dtls c on b.job_no=c.job_no where a.job_no=b.job_no  and a.status_active=1 $job_no $company_name $cbo_buyer_name $txt_style_ref $txt_costing_date order by a.job_no";
	}
	if($db_type==2){
   // $sql = "select a.job_no, a.company_name, a.buyer_name, a.style_ref_no, a.quotation_id, a.gmts_item_id, a.order_uom, a.job_quantity, a.avg_unit_price, b.costing_per, b.budget_minute, b.sew_smv, b.cut_smv, b.sew_effi_percent, b.cut_effi_percent, b.approved, c.fab_knit_req_kg, c.fab_knit_fin_req_kg, c.fab_woven_req_yds, c.fab_woven_fin_req_yds, c.fab_yarn_req_kg from wo_po_details_master a, wo_pre_cost_mst b left join wo_pre_cost_sum_dtls c on b.job_no=c.job_no where a.job_no=b.job_no  and a.status_active=1 $job_no $company_name $cbo_buyer_name $txt_style_ref order by a.job_no";
	}
	$sql = "SELECT a.job_no, a.company_name, a.buyer_name, a.style_ref_no, a.quotation_id, a.gmts_item_id, a.order_uom, a.job_quantity, a.avg_unit_price, b.costing_per, b.budget_minute,b.costing_date, b.sew_smv, b.cut_smv, b.sew_effi_percent, b.cut_effi_percent, b.approved, c.fab_knit_req_kg, c.fab_knit_fin_req_kg, c.fab_woven_req_yds, c.fab_woven_fin_req_yds, c.fab_yarn_req_kg, d.margin_pcs_bom, d.cost_pcs_set 
	from wo_po_details_master a 
		join wo_pre_cost_mst b on a.id=b.job_id 
		join wo_pre_cost_dtls d on a.id=d.job_id 
		left join wo_pre_cost_sum_dtls c on a.id=c.job_id and c.status_active=1 and c.is_deleted=0 where b.status_active=1 and b.is_deleted=0  and a.status_active=1 and b.status_active=1 and b.is_deleted=0 $job_no $company_name $cbo_buyer_name $txt_style_ref order by a.job_no";
	//echo __LINE__.$db_type; die;
	$data_array=sql_select($sql);
	
	$condition= new condition();
	if(str_replace("'","",$txt_job_no) !=''){
		$condition->job_no("=$txt_job_no");
	}
	if(str_replace("'",'',$txt_po_breack_down_id) !=""){
		$condition->po_id("in($selected_po_breack_down_id)");
	}

	$condition->init();
	$fabric= new fabric($condition);
	
	$trim= new trims($condition);
	//$emblishment= new emblishment($condition);
	//$wash= new wash($condition);
	//$other= new other($condition);
	//$other_cost=$other->getAmountArray_by_job();
	//$trims_cost_arr=$trim->getQtyArray_by_orderAndItemidTypeid();
	//print_r($trims_cost_arr);
	//$commercial= new commercial($condition);
	//$commision= new commision($condition);


	//Fabric =====================
	$fabric_qty=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$fabric_amount=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$sql_fabric = "SELECT id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description,uom, avg_cons,avg_cons_yarn, fabric_source,gsm_weight, rate, amount, avg_finish_cons, status_active from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_arr_fabric=sql_select($sql_fabric);
	$summary_data=array();
	foreach($data_arr_fabric as $fab_row)
	{
		$summary_data[fabric_cost][$fab_row[csf("id")]]=$fab_row[csf("amount")];
		$summary_data[fabric_cost_job]+=$fabric_amount['knit']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		$summary_data[fabric_cost_job]+=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
	}
	
	//start	Trims Cost part report here -------------------------------------------
		$sql_trim = "SELECT id, job_no, trim_group,description,brand_sup_ref,remark, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,status_active,seq
		from wo_pre_cost_trim_cost_dtls
		where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 order by seq";
		$data_array_trim=sql_select($sql_trim);
		$trim_amount_arr=$trim->getAmountArray_precostdtlsid();
		$trim_qty_arr=$trim->getQtyArray_by_precostdtlsid();
		//$trim_type_qty_arr=$trim->getQtyArray_by_orderAndTrimsTypeid();
		//print_r($trim_type_qty_arr);
		$totTrim=0;
		$TrimData=array();
		foreach( $data_array_trim as $row_trim )
		{
			$trim_qty=$trim_qty_arr[$row_trim[csf("id")]];
			$trim_amount=$trim_amount_arr[$row_trim[csf("id")]];
			$summary_data[trims_cost_job]+=$trim_amount;
			/*$TrimData[$row_trim[csf('id')]]['trim_group']=$row_trim[csf('trim_group')];
			$TrimData[$row_trim[csf('id')]]['description']=$row_trim[csf('description')];
			$TrimData[$row_trim[csf('id')]]['brand_sup_ref']=$row_trim[csf('brand_sup_ref')];
			$TrimData[$row_trim[csf('id')]]['remark']=$row_trim[csf('remark')];
			$TrimData[$row_trim[csf('id')]]['cons_uom']=$row_trim[csf('cons_uom')];
			$TrimData[$row_trim[csf('id')]]['cons_dzn_gmts']=$row_trim[csf('cons_dzn_gmts')];
			$TrimData[$row_trim[csf('id')]]['rate']=$row_trim[csf('rate')];
			$TrimData[$row_trim[csf('id')]]['amount']=$row_trim[csf('amount')];
			$TrimData[$row_trim[csf('id')]]['apvl_req']=$row_trim[csf('apvl_req')];
			$TrimData[$row_trim[csf('id')]]['nominated_supp']=$row_trim[csf('nominated_supp')];
			$TrimData[$row_trim[csf('id')]]['tot_cons']=$trim_qty;
			$TrimData[$row_trim[csf('id')]]['tot_amount']=$trim_amount;*/
			//$totTrim+=$row_trim[csf('cons_dzn_gmts')];
		}

	//Fabric End======================
	 
	$uom=""; $sew_smv=0; $cut_smv=0; $sew_effi_percent=0; $cut_effi_percent=0;
	foreach ($data_array as $row){
		$order_price_per_dzn=0;
		$order_job_qnty=0;
		$avg_unit_price=0;
		$sew_smv=$row[csf("sew_smv")];
	    $cut_smv=$row[csf("cut_smv")];
	    $sew_effi_percent=$row[csf("sew_effi_percent")];
	    $cut_effi_percent=$row[csf("cut_effi_percent")];
		$order_values = $row[csf("job_quantity")]*$row[csf("avg_unit_price")];
		$result =sql_select("SELECT po_number,grouping,file_no,pub_shipment_date from wo_po_break_down where job_no_mst=$txt_job_no $poId_cond and status_active=1 and is_deleted=0 order by pub_shipment_date DESC");
		$job_in_orders = '';$pulich_ship_date='';$job_in_file = '';$job_in_ref = '';
		foreach ($result as $val){
			$job_in_orders .= $val[csf('po_number')].", ";
			$pulich_ship_date = $val[csf('pub_shipment_date')];
			$job_in_file .= $val[csf('file_no')].",";
			$job_in_ref .= $val[csf('grouping')].",";
		}
		$job_in_orders = substr(trim($job_in_orders),0,-1);
		$job_ref=array_unique(explode(",",rtrim($job_in_ref,", ")));
		$job_file=array_unique(explode(",",rtrim($job_in_file,", ")));

		foreach ($job_ref as $ref){
			$ref_cond.=", ".$ref;
		}
		$file_con='';
		foreach ($job_file as $file){
			if($file_con=='') $file_cond=$file; else $file_cond.=", ".$file;
		}

		
		$path =str_replace("'","",$path);
		$path =($path)?$path:"../../";
		
		
		?>
            	
                <table style="width:850px" ><tr><td colspan="6" align="center">
                   <?
				   	$image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id='".str_replace("'","",$cbo_company_name)."'","image_location");
					?>
                    <img  src='<?=$path.$image_location; ?>' height='70' align="left" />
                    <b style="font-size:25px;"><?=$comp[str_replace("'","",$cbo_company_name)]; ?></b><br>
                    <b style="font-size:14px;">Pre- Costing</b>
                </td></tr></table>

                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
                	<tr>
                    	<td width="140">Job Number</td>
                        <td width="130"><b><? echo $row[csf("job_no")]; ?></b></td>
                        <td width="140">Buyer</td>
                        <td width="180"><b><? echo $buyer_arr[$row[csf("buyer_name")]]; ?></b></td>
                        <td colspan="2" align="center"><b>Material Cost</b></td>
                    </tr>
                    <tr>
                    	<td>Garments Item</td>
                        <?
							$grmnt_items = "";
							if($garments_item[$row[csf("gmts_item_id")]]=="")
							{

								$grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no=$txt_job_no");
								foreach($grmts_sql as $key=>$val){
									$grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].", ";
								}
								$grmnt_items = substr_replace($grmnt_items,"",-1,1);
							}else{
								$grmnt_items = $garments_item[$row[csf("gmts_item_id")]];
							}
						?>
                        <td><b><? echo $grmnt_items; ?></b></td>
                    	<td>Style Ref. No </td>
                        <td colspan=""><b><? echo $row[csf("style_ref_no")]; ?></b></td>
                        <td width="120"><b>Fabric Purchase</b></td>
			    		<td align="right" style="word-break:break-all"><b><? echo fn_number_format($summary_data[fabric_cost_job],4); ?></b></td>
                    </tr>
                    <tr>
                    	<td>Job Qty.</td>
                        <td><b><? $uom=$row[csf("order_uom")]; echo $row[csf("job_quantity")]." ". $unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
                        <td>Plan Cut Qty.</td>
                        <td><b><? echo $po_plun_cut_qty/$total_set_qnty." ". $unit_of_measurement[$row[csf("order_uom")]];?></b></td>
                        <td><b>Accessories</b></td>
						<td align="right" style="word-break:break-all"><b><? echo fn_number_format($summary_data[trims_cost_job],4)?></b></td>
                    </tr>
                    <tr>
                    	<td>Order Numbers</td>
                        <td colspan="3"><? echo $job_in_orders; ?></td>
                        <td><b>Total</b></td>
						<td align="right" style="word-break:break-all"><b><? echo fn_number_format($summary_data[fabric_cost_job]+$summary_data[trims_cost_job],4); ?></b></td>
                    </tr>
                    <tr>
                    	<td>Knit Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_knit_req_kg")];$fab_knit_req_kg_avg+=$row[csf("fab_knit_req_kg")]; ?> </b></td>
                        <td>Woven Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_woven_req_yds")];$fab_woven_req_yds_avg+= $row[csf("fab_woven_req_yds")];?> </b></td>
                        <td>Price Per <?= $unit_of_measurement[$row[csf("order_uom")]] ?></td>
						<td align="right"><b><? echo number_format($row[csf("avg_unit_price")],4); ?></b></td>
                    </tr>
                    <tr>
                        <td>Shipment Date </td>
                        <td><b><? echo change_date_format($pulich_ship_date); ?></b></td>
                        <td>Quotation ID</td>
                        <td><b><? echo $row[csf("quotation_id")] ?></b></td>
                        <td>Costing Per <?= $unit_of_measurement[$row[csf("order_uom")]] ?></td>
						<td align="right" title="Price Per &nbsp; <? echo $unit_of_measurement[$row[csf("order_uom")]].'-Margin Per &nbsp;'.$unit_of_measurement[$row[csf("order_uom")]];?>"><b><? echo number_format($row[csf("avg_unit_price")]-$row[csf("margin_pcs_bom")],4);?></b></td>
                    </tr>
                     <tr>
                    	<td>Internal Ref</td>
                        <td><b><? echo ltrim($ref_cond,", "); ?></b></td>
                        <td>Costing Per</td>
                        <td><b><? echo $costing_per[$row[csf("costing_per")]];?></b></td>
                        <td>Margin Per <?= $unit_of_measurement[$row[csf("order_uom")]] ?></td>
						<td align="right"><b><? echo $row[csf("margin_pcs_bom")];?></b></td>
                     </tr>
                     <tr>   
                     	<td>Sc/Lc No</td>
                        <td><b><? echo $sc_lc_no; ?> </b></td>
                        <td>File No</td>
                        <td><b><? echo $file_cond; ?> </b></td>
                        <td align="center" height="10" colspan="2" valign="middle" id="app_sms" style="font-size:20px;"><font color="#FF0000"><? if( $row[csf("approved")]==1){echo "This Job is Approved ";} else {echo "";} ?> </font> </td>
                    </tr>
                </table>
            <?
			if($row[csf("costing_per")]==1){
				$order_price_per_dzn=12;
				$costing_for=" DZN";
			}
			else if($row[csf("costing_per")]==2){
				$order_price_per_dzn=1;
				$costing_for=" PCS";
			}
			else if($row[csf("costing_per")]==3){
				$order_price_per_dzn=24;
				$costing_for=" 2 DZN";
			}
			else if($row[csf("costing_per")]==4){
				$order_price_per_dzn=36;
				$costing_for=" 3 DZN";
			}
			else if($row[csf("costing_per")]==5){
				$order_price_per_dzn=48;
				$costing_for=" 4 DZN";
			}
			$order_job_qnty=$row[csf("job_quantity")];
			$avg_unit_price=$row[csf("avg_unit_price")];

	}//end first foearch
 	?>
      <?
		//start	all summary report here -------------------------------------------
	$condition= new condition();
	if(str_replace("'","",$txt_job_no) !=''){
		$condition->job_no("=$txt_job_no");
	}
	$txt_po_breack_down_id=str_replace("'",'',$txt_po_breack_down_id);
	if(str_replace("'",'',$txt_po_breack_down_id) !=""){
		$condition->po_id("in($txt_po_breack_down_id)");
	}
	$condition->init();
	$fabric= new fabric($condition);
	$yarn= new yarn($condition);
	$conversion= new conversion($condition);
	$trim= new trims($condition);
	$emblishment= new emblishment($condition);
	$wash= new wash($condition);
	$other= new other($condition);
	$other_cost=$other->getAmountArray_by_job();
	$commercial= new commercial($condition);
	$commision= new commision($condition);


	 $sql_new = "SELECT job_no, fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent, wash_cost, wash_cost_percent, comm_cost, comm_cost_percent, commission, commission_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, freight, freight_percent, currier_pre_cost, currier_percent, certificate_pre_cost, certificate_percent, common_oh, common_oh_percent, depr_amor_pre_cost, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set, margin_pcs_set_percent, cm_for_sipment_sche, design_cost, design_percent, studio_cost, studio_percent
			from wo_pre_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
			$data_array_new=sql_select($sql_new);
			$summary_data=array();

            foreach( $data_array_new as $row_new ){
				$summary_data[price_dzn]=$row_new[csf("price_dzn")];
				$summary_data[price_dzn_job]=($po_qty/($total_set_qnty*$order_price_per_dzn))*$row_new[csf("price_dzn")];
			    $summary_data[commission]=$row_new[csf("commission")];
				$summary_data[trims_cost]=$row_new[csf("trims_cost")];
				$summary_data[emb_cost]=$row_new[csf("embel_cost")];

				$summary_data[lab_test]=$row_new[csf("lab_test")];
				$summary_data[lab_test_job]=$other_cost[$row_new[csf("job_no")]]['lab_test'];

				$summary_data[inspection]=$row_new[csf("inspection")];
				$summary_data[inspection_job]=$other_cost[$row_new[csf("job_no")]]['inspection'];

				$summary_data[freight]=$row_new[csf("freight")];
				$summary_data[freight_job]=$other_cost[$row_new[csf("job_no")]]['freight'];

				$summary_data[design]=$row_new[csf("design_cost")];
				$summary_data[design_job]=$row_new[csf("design_cost")]/$order_price_per_dzn*$po_qty;

				$summary_data[studio]=$row_new[csf("studio_cost")];
				$summary_data[studio_job]=$row_new[csf("studio_cost")]/$order_price_per_dzn*$po_qty;

				$summary_data[currier_pre_cost]=$row_new[csf("currier_pre_cost")];
				$summary_data[currier_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['currier_pre_cost'];

				$summary_data[certificate_pre_cost]=$row_new[csf("certificate_pre_cost")];
				$summary_data[certificate_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['certificate_pre_cost'];
				$summary_data[wash_cost]=$row_new[csf("wash_cost")];

				$summary_data[OtherDirectExpenses]=$row_new[csf("lab_test")]+$row_new[csf("inspection")]+$row_new[csf("design_cost")]+$row_new[csf("studio_cost")]+$row_new[csf("freight")]+$row_new[csf("currier_pre_cost")]+$row_new[csf("certificate_pre_cost")]+$row_new[csf("wash_cost")];

				$summary_data[OtherDirectExpenses_job]=$summary_data[lab_test_job]+$summary_data[inspection_job]+$summary_data[design_job]+$summary_data[studio_job]+$summary_data[freight_job]+$summary_data[currier_pre_cost_job]+$summary_data[certificate_pre_cost_job];

				$summary_data[cm_cost]=$row_new[csf("cm_cost")];
				$summary_data[cm_cost_job]=$other_cost[$row_new[csf("job_no")]]['cm_cost'];

				$summary_data[comm_cost]=$row_new[csf("comm_cost")];

				$summary_data[common_oh]=$row_new[csf("common_oh")];
				$summary_data[common_oh_job]=$other_cost[$row_new[csf("job_no")]]['common_oh'];
				$summary_data[depr_amor_pre_cost]=$row_new[csf("depr_amor_pre_cost")];
				$summary_data[depr_amor_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['depr_amor_pre_cost'];
			}

		//Fabric =====================
		$fabric_qty=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
		$fabric_amount=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
		$sql_fabric = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description,uom, avg_cons,avg_cons_yarn, fabric_source,gsm_weight, rate, amount, avg_finish_cons, status_active  from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no."";
		$data_arr_fabric=sql_select($sql_fabric);
		foreach($data_arr_fabric as $fab_row){
			$summary_data[fabric_cost][$fab_row[csf("id")]]=$fab_row[csf("amount")];
			$summary_data[fabric_cost_job]+=$fabric_amount['knit']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
			$summary_data[fabric_cost_job]+=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		}



		//Fabric End======================

	// Yarn===========================
	$totYarn=0;
	$YarnData=array();
	$yarn_data_array=$yarn->get_By_Precostdtlsid_YarnQtyAmountArray();
	$sql_yarn="SELECT f.id as yarn_id,f.cons_ratio,f.cons_qnty,f.avg_cons_qnty,f.rate,f.amount,count_id,copm_one_id,percent_one,color,type_id   from wo_pre_cost_fab_yarn_cost_dtls f where     f.job_no =".$txt_job_no." and f.is_deleted=0 and f.status_active=1  order by f.id";
	$data_arr_yarn=sql_select($sql_yarn);
	foreach($data_arr_yarn as $yarn_row){
		$yarnrate=$yarn_row[csf("rate")];
		$summary_data[yarn_cost][$yarn_row[csf("yarn_id")]]=$yarn_row[csf("amount")];
		$summary_data[yarn_cost_job]+=$yarn_data_array[$yarn_row[csf("yarn_id")]]['amount'];

		$index="'".$yarn_row[csf("count_id")]."_".$yarn_row[csf("copm_one_id")]."_".$yarn_row[csf("percent_one")]."_".$yarn_row[csf("type_id")]."_".$yarn_row[csf("color")]."_".$yarnrate."'";
		$YarnData[$index]['qty']+=$yarn_data_array[$yarn_row[csf("yarn_id")]]['qty'];
		$YarnData[$index]['amount']+=$yarn_data_array[$yarn_row[csf("yarn_id")]]['amount'];
		$YarnData[$index]['dznqty']+=$yarn_row[csf("cons_qnty")];
		$YarnData[$index]['dznamount']+=$yarn_row[csf("amount")];
		$totYarn+=$yarn_data_array[$yarn_row[csf("yarn_id")]]['qty'];
	}
	// Yarn End============================
	// Conversion
	$totConv=0;
	$ConvData=array();
	$conv_data=array();
	$conv_amount_arr=$conversion->getAmountArray_by_conversionid();
	$conv_qty_arr=$conversion->getQtyArray_by_conversionid();
	$sql_conv = "SELECT a.id as con_id, a.fabric_description as fabric_description_id, a.job_no, a.cons_process, a.req_qnty,a.avg_req_qnty, a.charge_unit, a.amount, a.status_active,b.body_part_id,b.fab_nature_id,b.color_type_id,b.fabric_description,b.uom  from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id where a.job_no=".$txt_job_no." and a.is_deleted=0 and a.status_active=1";
	$data_arr_conv=sql_select($sql_conv);
	foreach($data_arr_conv as $conv_row){
		$convamount=$conv_amount_arr[$conv_row[csf('con_id')]][$conv_row[csf('uom')]];
		$convQty=$conv_qty_arr[$conv_row[csf('con_id')]][$conv_row[csf('uom')]];

		$conv_data[cons_process][$conv_row[csf('con_id')]]=$conv_row[csf('cons_process')];
		$conv_data[amount][$conv_row[csf('con_id')]]=$conv_row[csf('amount')];
		$conv_data[amount_job][$conv_row[csf('con_id')]]+=$convamount;
		$summary_data[conver_cost_job]+=$convamount;

		$index=$conv_row[csf('con_id')];
		$ConvData[$index]['item_descrition']=$body_part[$conv_row[csf("body_part_id")]].", ".$color_type[$conv_row[csf("color_type_id")]].", ".$conv_row[csf("fabric_description")];
		$ConvData[$index]['cons_process']=$conv_row[csf("cons_process")];
		$ConvData[$index]['req_qnty']=$conv_row[csf("req_qnty")];
		$ConvData[$index]['uom']=$conv_row[csf("uom")];
		$ConvData[$index]['charge_unit']=$conv_row[csf("charge_unit")];
		$ConvData[$index]['amount']=$conv_row[csf("amount")];
		$ConvData[$index]['tot_req_qnty']=$convQty;
		$ConvData[$index]['tot_amount']=$convamount;
		$totConv+=$conv_row[csf("req_qnty")];
	}
	//Conversion End

	//start	Trims Cost part report here -------------------------------------------
	$sql_trim = "select id, job_no, trim_group,description,brand_sup_ref,remark, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,status_active,seq
	from wo_pre_cost_trim_cost_dtls
	where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 order by seq";
	$data_array_trim=sql_select($sql_trim);
	$trim_amount_arr=$trim->getAmountArray_precostdtlsid();
	$trim_qty_arr=$trim->getQtyArray_by_precostdtlsid();

	$totTrim=0;
	$TrimData=array();
	foreach( $data_array_trim as $row_trim ){
		$trim_qty=$trim_qty_arr[$row_trim[csf("id")]];
		$trim_amount=$trim_amount_arr[$row_trim[csf("id")]];
		$summary_data[trims_cost_job]+=$trim_amount;
		$TrimData[$row_trim[csf('id')]]['trim_group']=$row_trim[csf('trim_group')];
		$TrimData[$row_trim[csf('id')]]['description']=$row_trim[csf('description')];
		$TrimData[$row_trim[csf('id')]]['brand_sup_ref']=$row_trim[csf('brand_sup_ref')];
		$TrimData[$row_trim[csf('id')]]['remark']=$row_trim[csf('remark')];
		$TrimData[$row_trim[csf('id')]]['cons_uom']=$row_trim[csf('cons_uom')];
		$TrimData[$row_trim[csf('id')]]['cons_dzn_gmts']=$row_trim[csf('cons_dzn_gmts')];
		$TrimData[$row_trim[csf('id')]]['rate']=$row_trim[csf('rate')];
		$TrimData[$row_trim[csf('id')]]['amount']=$row_trim[csf('amount')];
		$TrimData[$row_trim[csf('id')]]['apvl_req']=$row_trim[csf('apvl_req')];
		$TrimData[$row_trim[csf('id')]]['nominated_supp']=$row_trim[csf('nominated_supp')];
		$TrimData[$row_trim[csf('id')]]['tot_cons']=$trim_qty;
		$TrimData[$row_trim[csf('id')]]['tot_amount']=$trim_amount;
		$totTrim+=$row_trim[csf('cons_dzn_gmts')];
	}
	//End	Trims Cost part report here -------------------------------------------
	//Emb cost Cost part report here -------------------------------------------

	$sql = "SELECT id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name in(1,2,4,5) and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	$emblishment_qty=$emblishment->getQtyArray_by_jobAndEmblishmentid();
	$emblishment_amount=$emblishment->getAmountArray_by_jobAndEmblishmentid();

	$totEmb=0;
	$EmbData=array();

	foreach( $data_array as $row ){
	$embqty=$emblishment_qty[$row[csf("job_no")]][$row[csf("id")]];
	$embamount=$emblishment_amount[$row[csf("job_no")]][$row[csf("id")]];
	$summary_data[emb_cost_job]+=$embamount;
	$EmbData[$row[csf("id")]]['emb_name']=$row[csf("emb_name")];
	$EmbData[$row[csf("id")]]['emb_type']=$row[csf("emb_type")];
	$EmbData[$row[csf("id")]]['cons_dzn_gmts']=$row[csf("cons_dzn_gmts")];
	$EmbData[$row[csf("id")]]['rate']=$row[csf("rate")];
	$EmbData[$row[csf("id")]]['amount']=$row[csf("amount")];
	$EmbData[$row[csf("id")]]['tot_cons']=$embqty;
	$EmbData[$row[csf("id")]]['tot_amount']=$embamount;
	$totEmb+=$row[csf("cons_dzn_gmts")];
	}
	//End Emb cost Cost part report here -------------------------------------------
	//Wash cost Cost part report here -------------------------------------------
	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name =3";
	$data_array=sql_select($sql);
	$wash_qty=$wash->getQtyArray_by_jobAndEmblishmentid();
	$wash_amount=$wash->getAmountArray_by_jobAndEmblishmentid();
	foreach( $data_array as $row ){
	$washqty=$wash_qty[$row[csf("job_no")]][$row[csf("id")]];
	$washamount=$wash_amount[$row[csf("job_no")]][$row[csf("id")]];
	$summary_data[wash_cost_job]+=$washamount;
	$summary_data[OtherDirectExpenses_job]+=$washamount;
	$EmbData[$row[csf("id")]]['emb_name']=$row[csf("emb_name")];
	$EmbData[$row[csf("id")]]['emb_type']=$row[csf("emb_type")];
	$EmbData[$row[csf("id")]]['cons_dzn_gmts']=$row[csf("cons_dzn_gmts")];
	$EmbData[$row[csf("id")]]['rate']=$row[csf("rate")];
	$EmbData[$row[csf("id")]]['amount']=$row[csf("amount")];
	$EmbData[$row[csf("id")]]['tot_cons']=$washqty;
	$EmbData[$row[csf("id")]]['tot_amount']=$washamount;
	$totEmb+=$row[csf("cons_dzn_gmts")];
	}
	//End Wash cost Cost part report here -------------------------------------------
	//Commision cost Cost part report here -------------------------------------------
	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls  where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	$commision_amount=$commision->getAmountArray_by_jobAndPrecostdtlsid();
	$totCommi=0;
	$CommiData=array();
	foreach( $data_array as $row ){
		$commisionamount=$commision_amount[$row[csf("job_no")]][$row[csf("id")]];
		$summary_data[commission_job]+=$commisionamount;
		$CommiData[$row[csf("id")]]['particulars_id']=$row[csf("particulars_id")];
		$CommiData[$row[csf("id")]]['commission_base_id']=$row[csf("commission_base_id")];
		$CommiData[$row[csf("id")]]['commision_rate']=$row[csf("commision_rate")];
		$CommiData[$row[csf("id")]]['commission_amount']=$row[csf("commission_amount")];
		$CommiData[$row[csf("id")]]['tot_commission_amount']=$commisionamount;
		$totCommi+=$row[csf("commission_amount")];
	}
	//End Commision cost Cost part report here -------------------------------------------

	//Commarcial cost Cost part report here -------------------------------------------
	$sql = "select id, job_no, item_id, rate, amount, status_active from  wo_pre_cost_comarci_cost_dtls  where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	$commarcial_amount=$commercial->getAmountArray_by_jobAndPrecostdtlsid();

	$totCommar=0;
	$CommarData=array();
	foreach( $data_array as $row ){
	$commarcialamount=$commarcial_amount[$row[csf("job_no")]][$row[csf("id")]];
	$summary_data[comm_cost_job]+=$commarcialamount;
	$CommarData[$row[csf("id")]]['item_id']=$row[csf("item_id")];
	$CommarData[$row[csf("id")]]['rate']=$row[csf("rate")];
	$CommarData[$row[csf("id")]]['amount']=$row[csf("amount")];
	$CommarData[$row[csf("id")]]['tot_amount']=$commarcialamount;
	$totCommar+=$row[csf("amount")];
	}
	//End Commarcial cost Cost part report here -------------------------------------------
		?>
		<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
			<tr style="font-weight:bold">
								<td width="380" colspan="5">Order Profitability </td>

							</tr>
							<tr style="font-weight:bold">
								<td width="80">Line Items</td>
								<td width="380">Particulars</td>
								<td width="100">Amount (USD)/<? echo $costing_for; ?></td>
								<td width="100">Total Value</td>
								<td width="100">%</td>
							</tr>
							<tr>
								<td width="80">1</td>
								<td width="380" align="left" style="font-weight:bold">Gross FOB Value</td>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format($summary_data[price_dzn],4); ?></td>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format($summary_data[price_dzn_job],4); ?></td>
								<td width="180" align="right" style="font-weight:bold"><? echo number_format(($summary_data[price_dzn_job]/$summary_data[price_dzn_job])*100,4);?></td>
							</tr>
							<tr>
								<td width="80">2</td>
								<td width="380" align="left" style=" padding-left:15px">Less: commission</td>
								<td width="100" align="right"><? echo number_format($summary_data[commission],4); ?></td>
								<td width="100" align="right"><? echo number_format($summary_data[commission_job],4); ?></td>
								<td width="180" align="right"><? echo number_format(($summary_data[commission_job]/$summary_data[price_dzn_job])*100,4);?></td>
							</tr>
							<tr>
							<td width="80">3</td>
								<?
								$NetFOBValue=$summary_data[price_dzn]-$summary_data[commission];
								$NetFOBValue_job=$summary_data[price_dzn_job]-$summary_data[commission_job];
								?>
								<td width="380" align="left" style="font-weight:bold"><b>Net FOB Value (1-2)</b></td>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format($NetFOBValue,4); ?></td>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format($NetFOBValue_job,4); ?></td>
								<td width="180" align="right" style="font-weight:bold"><? echo number_format(($NetFOBValue_job/$summary_data[price_dzn_job])*100,4);?></td>
							</tr>
							<tr>
								<td width="80">4</td>
								<td width="380" align="left" style="font-weight:bold"><b>Less: Cost of Material & Services (5+6+7+8+9) </b></td>
								<?
								$Less_Cost_Material_Services=array_sum($summary_data[fabric_cost])+array_sum($conv_data[amount])+$summary_data[trims_cost]+$summary_data[emb_cost]+$summary_data[lab_test]+$summary_data[inspection]+$summary_data[design]+$summary_data[studio]+$summary_data[freight]+$summary_data[currier_pre_cost]+$summary_data[certificate_pre_cost]+$summary_data[wash_cost];
								//array_sum($summary_data[yarn_cost])+

								$Less_Cost_Material_Services_job=$summary_data[yarn_cost_job]+$summary_data[fabric_cost_job]+$summary_data[conver_cost_job]+$summary_data[trims_cost_job]+$summary_data[emb_cost_job]+$summary_data[OtherDirectExpenses_job];
								?>
								<td width="100" align="right" style="font-weight:bold"> <? echo number_format($Less_Cost_Material_Services,4); ?></td>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format($Less_Cost_Material_Services_job,4); ?></td>
								<td width="180" align="right" style="font-weight:bold"><? echo number_format(($Less_Cost_Material_Services_job/$summary_data[price_dzn_job])*100,4);?></td>
							</tr>
							<tr>
								<td width="80">5</td>
								<td width="380" align="left" style=" padding-left:100px;font-weight:bold">Fabric Purchase Cost</td>
								<td width="100" align="right" style="font-weight:bold"> <? echo number_format(array_sum($summary_data[fabric_cost]),4); ?></td>
								<td width="100" align="right" style="font-weight:bold"> <? echo number_format($summary_data[fabric_cost_job],4); ?></td>
								<td width="180" align="right" style="font-weight:bold"><? echo number_format(($summary_data[fabric_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
							</tr>
							<tr>
								<td width="80" valign="top">6</td>
								<td width="380" align="left" style=" padding-left:100px">

								<table>
								<tr>
								<td width="180" style="font-weight:bold">Conversion Cost</td>

								</tr>
								</table>

								<table border="1" class="rpt_table" rules="all">
								<? foreach($conv_data[cons_process] as $key => $value){ ?>
								<tr>
								<td width="180" align="left"><? echo $conversion_cost_head_array[$conv_data[cons_process][$key]]; ?></td>

								</tr>
								<? }?>
								</table>
								</td>
								<td width="100" align="right" valign="top">
								<? //echo number_format(array_sum($conv_data[amount]),4); ?>

								<table>
								<tr>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format(array_sum($conv_data[amount]),4); ?></td>
								</tr>
								</table>

								<table border="1" class="rpt_table" rules="all">
								<? foreach($conv_data[cons_process] as $key => $value){ ?>
								<tr>

								<td width="100" align="right"><? echo number_format($conv_data[amount][$key],4);?></td>
								</tr>
								<? }?>
								</table>
								</td>
								<td width="100" align="right" valign="top">

								<table>
								<tr>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format($summary_data[conver_cost_job],4); ?></td>
								</tr>
								</table>

								<table border="1" class="rpt_table" rules="all">
								<? foreach($conv_data[cons_process] as $key => $value){ ?>
								<tr>

								<td width="100" align="right"><? echo number_format($conv_data[amount_job][$key],4);?></td>
								</tr>
								<? }?>
								</table>
								</td>
								<td width="180" align="right" valign="top">

								<table>
								<tr>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format(($summary_data[conver_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
								</tr>
								</table>

								<table border="1" class="rpt_table" rules="all">
								<? foreach($conv_data[cons_process] as $key => $value){ ?>
								<tr>

								<td width="180" align="right"><? echo number_format(($conv_data[amount_job][$key]/$summary_data[price_dzn_job])*100,4);?></td>
								</tr>
								<? }?>
								</table>
								</td>
							</tr>

							<tr>
								<td width="80">7</td>
								<td width="380" align="left" style=" padding-left:100px;font-weight:bold" ><b>Trim Cost </b></td>
								<td width="100" align="right" style="font-weight:bold"> <? echo number_format($summary_data[trims_cost],4); ?></td>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format($summary_data[trims_cost_job],4)?></td>
								<td width="180" align="right" style="font-weight:bold"><? echo number_format(($summary_data[trims_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
							</tr>
							<tr>
								<td width="80">8</td>
								<td width="380" align="left" style=" padding-left:100px;font-weight:bold"><b>Embelishment Cost </b></td>
								<td width="100" align="right" style="font-weight:bold"> <? echo number_format($summary_data[emb_cost],4); ?></td>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format($summary_data[emb_cost_job],4); ?></td>
								<td width="180" align="right" style="font-weight:bold"><? echo number_format(($summary_data[emb_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
							</tr>
							<tr>
								<td width="80" valign="top">9</td>
								<td width="380" align="left" style=" padding-left:100px">

								<table>
								<tr>
								<td width="180" style="font-weight:bold">Other Direct Expenses</td>

								</tr>
								</table>


								<table border="1" class="rpt_table" rules="all">

								<tr>
									<td width="180" align="left">Lab Test</td>
								</tr>
								<tr>
									<td width="180" align="left">Inspection</td>
								</tr>
								<tr>
									<td width="180" align="left">Design Cost</td>
								</tr>
								<tr>
									<td width="180" align="left">Studio Cost</td>
								</tr>


								<tr>
								<td width="180" align="left">Freight Cost</td>

								</tr>

								<tr>
								<td width="180" align="left">Courier Cost</td>

								</tr>

								<tr>
								<td width="180" align="left">Certificate Cost</td>

								</tr>

								<tr>
								<td width="180" align="left">Garments Wash Cost</td>

								</tr>

								</table>
								</td>
								<td width="100" align="right" valign="top">
								<table>
								<tr>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format($summary_data[OtherDirectExpenses],4); ?></td>
								</tr>
								</table>
								<table border="1" class="rpt_table" rules="all">

								<tr>

								<td width="100" align="right"><? echo number_format($summary_data[lab_test],4);?></td>
								</tr>

								<tr>
									<td width="100" align="right"><? echo number_format($summary_data[inspection],4);?></td>
								</tr>

								<tr>
									<td width="100" align="right"><? echo number_format($summary_data[design],4);?></td>
								</tr>
								<tr>
									<td width="100" align="right"><? echo number_format($summary_data[studio],4);?></td>
								</tr>

								<tr>

								<td width="100" align="right"><? echo number_format($summary_data[freight],4);?></td>
								</tr>

								<tr>

								<td width="100" align="right"><? echo number_format($summary_data[currier_pre_cost],4);?></td>
								</tr>

								<tr>

								<td width="100" align="right"><? echo number_format($summary_data[certificate_pre_cost],4);?></td>
								</tr>

								<tr>

								<td width="100" align="right"><? echo number_format($summary_data[wash_cost],4);?></td>
								</tr>

								</table>
								</td>


								<td width="100" align="right" valign="top">
								<? //echo number_format($summary_data[OtherDirectExpenses_job],4); ?>
								<table>
								<tr>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format($summary_data[OtherDirectExpenses_job],4); ?></td>
								</tr>
								</table>
								<table border="1" class="rpt_table" rules="all">

								<tr>

								<td width="100" align="right"><? echo number_format($summary_data[lab_test_job],4);?></td>
								</tr>

								<tr>
								<td width="100" align="right"><? echo number_format($summary_data[inspection_job],4);?></td>
								</tr>

								<tr>
								<td width="100" align="right"><? echo number_format($summary_data[design_job],4);?></td>
								</tr>

								<tr>
								<td width="100" align="right"><? echo number_format($summary_data[studio_job],4);?></td>
								</tr>

								<tr>

								<td width="100" align="right"><? echo number_format($summary_data[freight_job],4);?></td>
								</tr>

								<tr>

								<td width="100" align="right"><? echo number_format($summary_data[currier_pre_cost_job],4);?></td>
								</tr>

								<tr>

								<td width="100" align="right"><? echo number_format($summary_data[certificate_pre_cost_job],4);?></td>
								</tr>

								<tr>

								<td width="100" align="right"><? echo number_format($summary_data[wash_cost_job],4);?></td>
								</tr>

								</table>
								</td>
								<td width="180" align="right" valign="top">

								<table>
								<tr>
								<td width="180" align="right" style="font-weight:bold"><? echo number_format(($summary_data[OtherDirectExpenses_job]/$summary_data[price_dzn_job])*100,4);?></td>
								</tr>
								</table>
								<table border="1" class="rpt_table" rules="all">

								<tr>

								<td width="180" align="right"><? echo number_format(($summary_data[lab_test_job]/$summary_data[price_dzn_job])*100,4);?></td>
								</tr>

								<tr>
								<td width="180" align="right"><? echo number_format(($summary_data[inspection_job]/$summary_data[price_dzn_job])*100,4);?></td>
								</tr>

								<tr>
								<td width="180" align="right"><? echo number_format(($summary_data[design_job]/$summary_data[price_dzn_job])*100,4);?></td>
								</tr>

								<tr>
								<td width="180" align="right"><? echo number_format(($summary_data[studio_job]/$summary_data[price_dzn_job])*100,4);?></td>
								</tr>

								<tr>

								<td width="180" align="right"><? echo number_format(($summary_data[freight_job]/$summary_data[price_dzn_job])*100,4);?></td>
								</tr>

								<tr>

								<td width="180" align="right"><? echo number_format(($summary_data[currier_pre_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
								</tr>

								<tr>

								<td width="180" align="right"><? echo number_format(($summary_data[certificate_pre_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
								</tr>

								<tr>

								<td width="180" align="right"><? echo number_format(($summary_data[wash_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
								</tr>

								</table>
								</td>
							</tr>
							<tr>
								<td width="80">10</td>
								<td width="380" align="left" style="font-weight:bold">Contributions/Value Additions (3-4)</td>
								<?
								$Contribution_Margin=$NetFOBValue-$Less_Cost_Material_Services;
								$Contribution_Margin_job=$NetFOBValue_job-$Less_Cost_Material_Services_job;
								?>
								<td width="100" align="right" style="font-weight:bold"> <? echo number_format($Contribution_Margin,4); ?></td>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format($Contribution_Margin_job,4); ?></td>
								<td width="180" align="right" style="font-weight:bold"><? echo number_format(($Contribution_Margin_job/$summary_data[price_dzn_job])*100,4);?></td>

							</tr>
							<tr>
								<td width="80">11</td>
								<td width="380" align="left" style=" padding-left:15px">Less: CM Cost </td>
								<td width="100" align="right"><? echo number_format($summary_data[cm_cost],4); ?> </td>
								<td width="100" align="right"><? echo number_format($summary_data[cm_cost_job],4); ?></td>
								<td width="180" align="right"><? echo number_format(($summary_data[cm_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
							</tr>
							<tr>
								<td width="80">12</td>
								<td width="380" align="left" style="font-weight:bold">Gross Profit (10-11)</td>
								<?
								$Gross_Profit=$Contribution_Margin-$summary_data[cm_cost];
								$Gross_Profit_job=$Contribution_Margin_job-$summary_data[cm_cost_job];
								?>
								<td width="100" align="right" style="font-weight:bold"> <? echo number_format($Gross_Profit,4); ?></td>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format($Gross_Profit_job,4); ?></td>
								<td width="180" align="right" style="font-weight:bold"><? echo number_format(($Gross_Profit_job/$summary_data[price_dzn_job])*100,4);?></td>
							</tr>

							<tr>
								<td width="80">13</td>
								<td width="380" align="left" style=" padding-left:15px">Less: Commercial Cost</td>

								<td width="100" align="right"> <? echo number_format( $summary_data[comm_cost],4); ?></td>
								<td width="100" align="right"><? echo number_format( $summary_data[comm_cost_job],4); ?></td>
								<td width="180" align="right"><? echo number_format(($summary_data[comm_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
							</tr>
							<tr>
								<td width="80">14</td>
								<td width="380" align="left" style=" padding-left:15px">Less: Operating Expensees</td>

								<td width="100" align="right"><? echo number_format( $summary_data[common_oh],4); ?> </td>
								<td width="100" align="right"><? echo number_format( $summary_data[common_oh_job],4); ?> </td>
								<td width="180" align="right"><? echo number_format(($summary_data[common_oh_job]/$summary_data[price_dzn_job])*100,4);?></td>
							</tr>

							<tr >
								<td width="80">15</td>
								<td width="380" align="left" style="font-weight:bold">Operating Profit/ Loss (12-(13+14))</td>
								<?
								$OperatingProfitLoss=$Gross_Profit-($summary_data[comm_cost]+$summary_data[common_oh]);
								$OperatingProfitLoss_job=$Gross_Profit_job-($summary_data[comm_cost_job]+$summary_data[common_oh_job]);
								?>
								<td width="100" align="right" style="font-weight:bold"> <? echo number_format($OperatingProfitLoss,4); ?></td>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format($OperatingProfitLoss_job,4); ?></td>
								<td width="180" align="right" style="font-weight:bold"><? echo number_format(($OperatingProfitLoss_job/$summary_data[price_dzn_job])*100,4);?></td>
							</tr>
							<tr>
								<td width="80">16</td>
								<td width="380" align="left" style=" padding-left:15px">Less: Depreciation & Amortization </td>

								<td width="100" align="right"> <? echo number_format( $summary_data[depr_amor_pre_cost],4); ?></td>
								<td width="100" align="right"><? echo number_format( $summary_data[depr_amor_pre_cost_job],4); ?></td>
								<td width="180" align="right"><? echo number_format(($summary_data[depr_amor_pre_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
							</tr>
							<tr>
							<?
							$interest_expense=$NetFOBValue*$financial_para[$pre_costing_date][interest_expense]/100;
							$income_tax=$NetFOBValue*$financial_para[$pre_costing_date][income_tax]/100;
							$interest_expense_job=$NetFOBValue_job*$financial_para[$pre_costing_date][interest_expense]/100;
							$income_tax_job=$NetFOBValue_job*$financial_para[$pre_costing_date][income_tax]/100;
							?>
								<td width="80">17</td>
								<td width="380" align="left" style=" padding-left:15px">Less: Interest </td>

								<td width="100" align="right"> <? echo number_format( $interest_expense,4); ?></td>
								<td width="100" align="right"><? echo number_format( $interest_expense_job,4); ?></td>
								<td width="180" align="right"><? echo number_format(($interest_expense_job/$summary_data[price_dzn_job])*100,4);?></td>
							</tr>
							<tr>
								<td width="80">18</td>
								<td width="380" align="left" style=" padding-left:15px">Less: Income Tax</td>

								<td width="100" align="right"> <? echo number_format( $income_tax,4); ?></td>
								<td width="100" align="right"><? echo number_format( $income_tax_job,4); ?></td>
								<td width="180" align="right"><? echo number_format(($income_tax_job/$summary_data[price_dzn_job])*100,4);?></td>
							</tr>
							<tr>
								<?
								$Netprofit=$OperatingProfitLoss-($summary_data[depr_amor_pre_cost]+$interest_expense+$income_tax);
								$Netprofit_job=$OperatingProfitLoss_job-($summary_data[depr_amor_pre_cost_job]+$interest_expense_job+$income_tax_job);
								?>
								<td width="80">19</td>
								<td width="380" align="left" style="font-weight:bold">Net Profit/Loss (15-(16+17+18))</td>

								<td width="100" align="right" style="font-weight:bold"><? echo number_format( $Netprofit,4); ?> </td>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format( $Netprofit_job,4); ?></td>
								<td width="180" align="right" style="font-weight:bold"><? echo number_format(($Netprofit_job/$summary_data[price_dzn_job])*100,4);?></td>
							</tr>
							</table>
			</div>
		<?
		//End all summary report here -------------------------------------------



		//2	All Fabric Cost part here-------------------------------------------
			$sql = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description,uom, avg_cons,avg_cons_yarn, fabric_source,gsm_weight, rate, amount,avg_finish_cons,status_active,gsm_weight_type
			from wo_pre_cost_fabric_cost_dtls
			where job_no=".$txt_job_no." and is_deleted=0 and status_active=1";
			$data_array=sql_select($sql);

			$knit_fab="";
			$woven_fab="";
			$knit_fab_dtls="";

			$knit_subtotal_avg_cons=0;
			$knit_subtotal_amount=0;
			$woven_subtotal_avg_cons=0;
			$woven_subtotal_amount=0;
			$grand_total_amount=0;

			$i=1;
			$j=1;
			foreach( $data_array as $row ) {
				$uom=$unit_of_measurement[$row[csf("uom")]];
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")].", ".$fabric_weight_type[$row[csf("gsm_weight_type")]].", ".$row[csf("gsm_weight")];

				if($row[csf("fab_nature_id")]==2){//knit fabrics
					$i++;
					$totalConsKnit=$fabric_qty['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];
					$totalAmountKnit=$fabric_amount['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];
					$amount=$row[csf("avg_cons")]*$row[csf("rate")];

					$knit_fab_dtls .= '<tr>
						<td align="left">'.$item_descrition.'</td>
						<td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
						<td align="right">'.number_format($row[csf("avg_cons")],4).'</td>
						<td align="right">'.number_format($totalConsKnit,4).'</td>
						<td align="left">'.$uom.'</td>
						<td align="right">'.number_format($row[csf("rate")],4).'</td>
						<td align="right">'.number_format($amount,4).'</td>
						<td align="right">'.number_format($totalAmountKnit,4).'</td>
					</tr>';
					if($row[csf("uom")]==1){
						$DznConsKnitSubTotalPcs += $row[csf("avg_cons")];
						$TotalConsKnitSubTotalPcs += $totalConsKnit;
						$DznAmountKnitSubTotalPcs+=$amount;
						$TotalAmountKnitSubTotalPcs+=$totalAmountKnit;
					}
					if($row[csf("uom")]==12){
						$DznConsKnitSubTotalKg += $row[csf("avg_cons")];
						$TotalConsKnitSubTotalKg += $totalConsKnit;
						$DznAmountKnitSubTotalKg+=$amount;
						$TotalAmountKnitSubTotalKg+=$totalAmountKnit;
					}
					if($row[csf("uom")]==23){
						$DznConsKnitSubTotalMtr += $row[csf("avg_cons")];
						$TotalConsKnitSubTotalMtr += $totalConsKnit;
						$DznAmountKnitSubTotalMtr+=$amount;
						$TotalAmountKnitSubTotalMtr+=$totalAmountKnit;
					}
					if($row[csf("uom")]==27){
						$DznConsKnitSubTotalYds += $row[csf("avg_cons")];
						$TotalConsKnitSubTotalYds += $totalConsKnit;
						$DznAmountKnitSubTotalYds+=$amount;
						$TotalAmountKnitSubTotalYds+=$totalAmountKnit;
					}
					$GrandtotalDznAmount+=$amount;
					$GrandtotalAmount+=$totalAmountKnit;

					$GrandTotalFabricDznAmount+=$amount;
					$GrandTotalFabricAmount+=$totalAmountKnit;


				}

				if($row[csf("fab_nature_id")]==3){//woven fabrics
					$j++;
					$totalConsWoven=$fabric_qty['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
					$totalAmountWoven=$fabric_amount['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];

					$amount=$row[csf("avg_cons")]*$row[csf("rate")];

					$woven_fab .= '<tr>
						<td align="left">'.$item_descrition.'</td>
						<td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
						<td align="right">'.number_format($row[csf("avg_cons")],4).'</td>
						<td align="right">'.number_format($totalConsWoven,4).'</td>
						<td align="left">'.$uom.'</td>
						<td align="right">'.number_format($row[csf("rate")],4).'</td>
						<td align="right">'.number_format($amount,4).'</td>
						<td align="right">'.number_format($totalAmountWoven,4).'</td>
					</tr>';

					if($row[csf("uom")]==1){
						$DznConsWovenSubTotalPcs += $row[csf("avg_cons")];
						$TotalConsWovenSubTotalPcs += $totalConsWoven;
						$DznAmountWovenSubTotalPcs+=$amount;
						$TotalAmountWovenSubTotalPcs+=$totalAmountWoven;
					}
					if($row[csf("uom")]==12){
						$DznConsWovenSubTotalKg += $row[csf("avg_cons")];
						$TotalConsWovenSubTotalKg += $totalConsWoven;
						$DznAmountWovenSubTotalKg+=$amount;
						$TotalAmountWovenSubTotalKg+=$totalAmountWoven;
					}
					if($row[csf("uom")]==23){
						$DznConsWovenSubTotalMtr += $row[csf("avg_cons")];
						$TotalConsWovenSubTotalMtr += $totalConsWoven;
						$DznAmountWovenSubTotalMtr+=$amount;
						$TotalAmountWovenSubTotalMtr+=$totalAmountWoven;
					}
					if($row[csf("uom")]==27){
						$DznConsWovenSubTotalYds += $row[csf("avg_cons")];
						$TotalConsWovenSubTotalYds += $totalConsWoven;
						$DznAmountWovenSubTotalYds+=$amount;
						$TotalAmountWovenSubTotalYds+=$totalAmountWoven;
					}
					$GrandtotalDznAmount+=$amount;
					$GrandtotalAmount+=$totalAmountWoven;

					$GrandTotalFabricDznAmount+=$amount;
					$GrandTotalFabricAmount+=$totalAmountWoven;
				}
			}
			if($DznConsKnitSubTotalPcs>0){
					$i++;
			}
			if($DznConsKnitSubTotalKg>0){
					$i++;

			}
			if($DznConsKnitSubTotalMtr>0){
					$i++;
			}
			if($DznConsKnitSubTotalYds>0){
					$i++;
			}

			if($DznConsWovenSubTotalPcs>0){
				$j++;
			}
			if($DznConsWovenSubTotalKg>0){
				$j++;
			}
			if($DznConsWovenSubTotalMtr>0){
				$j++;
			}
			if($DznConsWovenSubTotalYds>0){
				$j++;
			}
			$knit_fab= '<div style="margin-top:15px">
					<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
						<label><b>All Fabric Cost  </b></label>
							<tr style="font-weight:bold"  align="center">
								<td width="80"  ><div class=""><b>Fabric Nature</b></div></td>
								<td width="350">Description</td>
								<td width="100">Source</td>
								<td width="100">Fab. Cons/'.$costing_for.'</td>
								<td width="100">Total Cons</td>
								<td width="100">UOM</td>
								<td width="100">Rate (USD)</td>
								<td width="100">Amount (USD)/'.$costing_for.'</td>
								<td width="100">Tot.Amount (USD)</td>
							</tr>';
			if($DznConsKnitSubTotalPcs>0 || $DznConsKnitSubTotalKg>0 || $DznConsKnitSubTotalMtr>0 || $DznConsKnitSubTotalYds>0){
				$knit_fab.='<tr><td width="80" rowspan="'.$i.'"><div class="verticalText"><b>Knit Fabric</b></div></td></tr>'.$knit_fab_dtls;
			}			
			
			
			if($DznConsWovenSubTotalPcs>0 || $DznConsWovenSubTotalKg>0 || $DznConsWovenSubTotalMtr>0 || $DznConsWovenSubTotalYds>0){
				if($knit_fab_dtls!="")
				{
					$woven_fab= '<tr><td colspan="9">&nbsp;</td></tr><tr>
							<td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;
				}
				else{
					$woven_fab= '<tr><td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;
				}
			
			}

			//knit fabrics table here
			if($DznConsKnitSubTotalPcs>0){
				$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
								<td colspan="2" align="left">Sub Total(Pcs)</td>
								<td align="right">'.number_format($DznConsKnitSubTotalPcs,4).'</td>
								<td align="right">'.number_format($TotalConsKnitSubTotalPcs,4).'</td>
								<td></td>
								<td></td>
								<td align="right">'.number_format($DznAmountKnitSubTotalPcs,4).'</td>
								<td align="right">'.number_format($TotalAmountKnitSubTotalPcs,4).'</td>
							</tr>';
			}
			if($DznConsKnitSubTotalKg>0){
				$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
								<td colspan="2" align="left">Sub Total(Kg)</td>
								<td align="right">'.number_format($DznConsKnitSubTotalKg,4).'</td>
								<td align="right">'.number_format($TotalConsKnitSubTotalKg,4).'</td>
								<td></td>
								<td></td>
								<td align="right">'.number_format($DznAmountKnitSubTotalKg,4).'</td>
								<td align="right">'.number_format($TotalAmountKnitSubTotalKg,4).'</td>
							</tr>';
			}
			if($DznConsKnitSubTotalMtr>0){
				$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
								<td colspan="2" align="left">Sub Total(Mtr)</td>
								<td align="right">'.number_format($DznConsKnitSubTotalMtr,4).'</td>
								<td align="right">'.number_format($TotalConsKnitSubTotalMtr,4).'</td>
								<td></td>
								<td></td>
								<td align="right">'.number_format($DznAmountKnitSubTotalMtr,4).'</td>
								<td align="right">'.number_format($TotalAmountKnitSubTotalMtr,4).'</td>
							</tr>';
			}
			if($DznConsKnitSubTotalYds>0){
				$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
								<td colspan="2" align="left">Sub Total(Yds)</td>
								<td align="right">'.number_format($DznConsKnitSubTotalYds,4).'</td>
								<td align="right">'.number_format($TotalConsKnitSubTotalYds,4).'</td>
								<td></td>
								<td></td>
								<td align="right">'.number_format($DznAmountKnitSubTotalYds,4).'</td>
								<td align="right">'.number_format($TotalAmountKnitSubTotalYds,4).'</td>
							</tr>';
			}
			if($zero_value==1){
			echo $knit_fab;
			}
			else{
				if($row[csf("avg_cons")]>0){
					echo $knit_fab;
				}
				else{
					echo "";
				}
			}


			//woven fabrics table here
			if($DznConsWovenSubTotalPcs>0){
			$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
							<td colspan="2" align="left">Sub Total(Pcs)</td>
							<td align="right">'.number_format($DznConsWovenSubTotalPcs,4).'</td>
							<td align="right">'.number_format($TotalConsWovenSubTotalPcs,4).'</td>
							<td></td>
							<td></td>
							<td align="right">'.number_format($DznAmountWovenSubTotalPcs,4).'</td>
							<td align="right">'.number_format($TotalAmountWovenSubTotalPcs,4).'</td>
						</tr>';
			}
			if($DznConsWovenSubTotalKg>0){
			$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
							<td colspan="2" align="left">Sub Total(Kg)</td>
							<td align="right">'.number_format($DznConsWovenSubTotalKg,4).'</td>
							<td align="right">'.number_format($TotalConsWovenSubTotalKg,4).'</td>
							<td></td>
							<td></td>
							<td align="right">'.number_format($DznAmountWovenSubTotalKg,4).'</td>
							<td align="right">'.number_format($TotalAmountWovenSubTotalKg,4).'</td>
						</tr>';
			}
			if($DznConsWovenSubTotalMtr>0){

			$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
							<td colspan="2" align="left">Sub Total(Mtr)</td>
							<td align="right">'.number_format($DznConsWovenSubTotalMtr,4).'</td>
							<td align="right">'.number_format($TotalConsWovenSubTotalMtr,4).'</td>
							<td></td>
							<td></td>
							<td align="right">'.number_format($DznAmountWovenSubTotalMtr,4).'</td>
							<td align="right">'.number_format($TotalAmountWovenSubTotalMtr,4).'</td>
						</tr>';
			}
			if($DznConsWovenSubTotalYds>0){
			$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
							<td colspan="2" align="left">Sub Total(Yds)</td>
							<td align="right">'.number_format($DznConsWovenSubTotalYds,4).'</td>
							<td align="right">'.number_format($TotalConsWovenSubTotalYds,4).'</td>
							<td></td>
							<td></td>
							<td align="right">'.number_format($DznAmountWovenSubTotalYds,4).'</td>
							<td align="right">'.number_format($TotalAmountWovenSubTotalYds,4).'</td>
						</tr>';
			}

			$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
							<td colspan="4" align="left">Total</td>
							<td align="right"></td>
							<td></td>
							<td></td>
							<td align="right">'.number_format(($GrandtotalDznAmount),4).'</td>
							<td align="right">'.number_format(($GrandtotalAmount),4).'</td>
						</tr></table></div>';
			if($zero_value==1){
				echo $woven_fab;
			}
			else{
				if($row[csf("avg_cons")]>0){
					echo $woven_fab;
				}
				else{
					echo "";
				}
			}
			//end 	All Fabric Cost part report-------------------------------------------


		//start	Conversion Cost to Fabric report here -------------------------------------------

		if($zero_value==1)
		{
		?>

			<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
					<tr style="font-weight:bold">
						<td width="80" rowspan="<? echo count($ConvData)+3; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
						<td width="350">Particulars</td>
						<td width="100">Process</td>
						<td width="100">Cons/<? echo $costing_for; ?></td>
						<td width="100">Total Cons</td>
						<td width="100">Uom</td>
						<td width="100">Rate (USD)</td>
						<td width="100">Amount (USD)</td>
						<td width="100">Total Amount (USD)</td>
					</tr>
				<?
				$TotalDznAmount =0;
				$TotalAmount =0;
				foreach( $ConvData as $index=>$row ){

				?>
					<tr>
						<td align="left"><? echo $row['item_descrition']; ?></td>
						<td align="left"><? echo $conversion_cost_head_array[$row["cons_process"]]; ?></td>
						<td align="right"><? echo number_format($row["req_qnty"],4); ?></td>

						<td align="right"><? echo number_format($row["tot_req_qnty"],4); ?></td>
						<td align=""><? echo $unit_of_measurement[$row["uom"]]; ?></td>
						<td align="right"><? echo number_format($row["charge_unit"],4); ?></td>
						<td align="right"><? echo number_format($row["amount"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
					</tr>
				<?
					$TotalDznAmount += $row["amount"];
					$TotalAmount += $row["tot_amount"];

					$GrandTotalFabricDznAmount+=$row["amount"];
					$GrandTotalFabricAmount+=$row["tot_amount"];
				}
				?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td  align="left" colspan="6">Total</td>
						<td align="right"><? echo $TotalDznAmount; ?></td>
						<td align="right"><? echo $TotalAmount; ?></td>
					</tr>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td align="left" colspan="6">Total Fabric Cost</td>
						<td align="right"><? echo number_format($GrandTotalFabricDznAmount,4); ?></td>
						<td align="right"><? echo number_format($GrandTotalFabricAmount,4); ?></td>
					</tr>
				</table>
		</div>
		<?
		}
		else{
			if($totConv>0){
		?>
		<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
					<tr style="font-weight:bold">
						<td width="80" rowspan="<? echo count($ConvData)+3; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
						<td width="350">Particulars</td>
						<td width="100">Process</td>
						<td width="100">Cons/<? echo $costing_for; ?></td>
						<td width="100">Total Cons</td>
						<td width="100">Uom</td>
						<td width="100">Rate (USD)</td>
						<td width="100">Amount (USD)</td>
						<td width="100">Total Amount (USD)</td>
					</tr>
				<?
			$TotalDznAmount =0;
			$TotalAmount =0;
				foreach( $ConvData as $index=>$row){

				?>
					<tr>
						<td align="left"><? echo $row['item_descrition']; ?></td>
						<td align="left"><? echo $conversion_cost_head_array[$row["cons_process"]]; ?></td>
						<td align="right"><? echo number_format($row["req_qnty"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_req_qnty"],4); ?></td>
						<td align=""><? echo $unit_of_measurement[$row["uom"]]; ?></td>
						<td align="right"><? echo number_format($row["charge_unit"],4); ?></td>
						<td align="right"><? echo number_format($row["amount"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
					</tr>
				<?
					$TotalDznAmount += $row["amount"];
					$TotalAmount += $row["tot_amount"];

					$GrandTotalFabricDznAmount+=$row["amount"];
					$GrandTotalFabricAmount+=$row["tot_amount"];
				}
				?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td align="left" colspan="6">Total</td>
						<td align="right"><? echo $TotalDznAmount; ?></td>
						<td align="right"><? echo $TotalAmount; ?></td>
					</tr>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td align="left" colspan="6">Total Fabric Cost</td>
						<td align="right"><? echo number_format($GrandTotalFabricDznAmount,4); ?></td>
						<td align="right"><? echo number_format($GrandTotalFabricAmount,4); ?></td>
					</tr>
				</table>
		</div>
		<?
			}
			else{
				echo "";
			}
		}
		//End Conversion Cost to Fabric report here -------------------------------------------



		//start	Trims Cost part report here -------------------------------------------

		if($zero_value==1)
		{
		?>


			<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<label><b>Trims Cost</b></label>
					<tr style="font-weight:bold">
						<td width="50">SL</td>
						<td width="150">Item Group</td>
						<td width="150">Description</td>
						<td width="150">Brand/Supp Ref</td>
						<td width="150">Remarks</td>
						<td width="100">UOM</td>
						<td width="100">Cons/<? echo $costing_for; ?></td>
						<td width="100">Tot. Cons</td>
						<td width="100">Rate (USD)</td>
						<td width="100">Amount (USD)</td>
						<td width="100">Tot. Amount</td>
					</tr>
				<?
				$TotalDznAmount=0;
				$TotalAmount=0;
				$i=1;
				foreach( $TrimData as $index=>$row )
				{
					$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row["trim_group"], "id", "item_name"  );

				?>
					<tr>
						<td align="left"><? echo $i; ?></td>
						<td align="left"><? echo $trim_group[$row["trim_group"]]; ?></td>
						<td align="left"><? echo $row["description"]; ?></td>
						<td align="left"><? echo $row["brand_sup_ref"]; ?></td>
						<td align="left"><? echo $row["remark"]; ?></td>
						<td align="left"><? echo $unit_of_measurement[$row["cons_uom"]]; ?></td>
						<td align="right"><? echo number_format($row["cons_dzn_gmts"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_cons"],4); ?></td>
						<td align="right"><? echo number_format($row["rate"],4); ?></td>
						<td align="right"><? echo number_format($row["amount"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
					</tr>
				<?
					$TotalDznAmount += $row["amount"];
					$TotalAmount += $row["tot_amount"];
					$Totalcons += $row["tot_cons"];
					$Totalrate += $row["rate"];
					$i++;
				}
				?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="7" align="left">Total</td>
						<td align="right"><? echo number_format($Totalcons,4); ?></td>
						<td align="right"><? echo number_format($Totalrate,4); ?></td>
						<td align="right"><? echo number_format($TotalDznAmount,4); ?></td>
						<td align="right"><? echo number_format($TotalAmount,4); ?></td>
					</tr>
				</table>
		</div>
		<?
		}
		else
		{
			if($totTrim>0)
			{
		?>
		<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<label><b>Trims Cost</b></label>
					<tr style="font-weight:bold">
						<td width="50">SL</td>
						<td width="150">Item Group</td>
						<td width="150">Description</td>
						<td width="150">Brand/Supp Ref</td>
						<td width="150">Remarks</td>
						<td width="100">UOM</td>
						<td width="100">Cons/<? echo $costing_for; ?></td>
						<td width="100">Tot. Cons</td>
						<td width="100">Rate (USD)</td>
						<td width="100">Amount (USD)</td>
						<td width="100">Tot. Amount</td>
					</tr>
				<?
				$TotalDznAmount=0;
				$TotalAmount=0;
				foreach( $TrimData as $index=>$row)
				{
					$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row["trim_group"], "id", "item_name"  );

				?>
					<tr>
						<td align="left"><? echo $i; ?></td>
						<td align="left"><? echo $trim_group[$row["trim_group"]]; ?></td>
						<td align="left"><? echo $row["description"]; ?></td>
						<td align="left"><? echo $row["brand_sup_ref"]; ?></td>
						<td align="left"><? echo $row["remark"]; ?></td>
						<td align="left"><? echo $unit_of_measurement[$row["cons_uom"]]; ?></td>
						<td align="right"><? echo number_format($row["cons_dzn_gmts"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_cons"],4); ?></td>
						<td align="right"><? echo number_format($row["rate"],4); ?></td>
						<td align="right"><? echo number_format($row["amount"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
					</tr>
				<?
					$TotalDznAmount += $row["amount"];
					$TotalAmount += $row["tot_amount"];
					$i++;
				}
				?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="9" align="left">Total</td>
						<td align="right"><? echo number_format($TotalDznAmount,4); ?></td>

						<td align="right"><? echo number_format($TotalAmount,4); ?></td>
					</tr>
				</table>
		</div>
		<?
			}
			else
			{
			echo "";
			}
		}
		//End Trims Cost Part report here -------------------------------------------



		//start	Embellishment Details part report here -------------------------------------------

		if($zero_value==1)
		{
		?>


			<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<label><b>Embellishment Details</b></label>
					<tr style="font-weight:bold">
						<td width="150">Particulars</td>
						<td width="150">Type</td>
						<td width="150">Cons/<? echo $costing_for; ?></td>
						<td width="150">Tot.Cons</td>
						<td width="100">Rate (USD)</td>
						<td width="100">Amount (USD)</td>
						<td width="100">Tot. Amount</td>
					</tr>
				<?
				$TotalDznAmount=0;
				$TotalAmount =0;
				foreach( $EmbData as $index=>$row )
				{
					$em_type ="";
					//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
					if($row["emb_name"]==1)$em_type = $emblishment_print_type[$row["emb_type"]];
					else if($row["emb_name"]==2)$em_type = $emblishment_embroy_type[$row["emb_type"]];
					else if($row["emb_name"]==3)$em_type = $emblishment_wash_type[$row["emb_type"]];
					else if($row["emb_name"]==4)$em_type = $emblishment_spwork_type[$row["emb_type"]];
					else if($row["emb_name"]==5)$em_type = $emblishment_gmts_type[$row["emb_type"]];
					else if($row["emb_name"]==99)$em_type = $emblishment_other_type_arr[$row["emb_type"]];


				?>
					<tr>
						<td align="left"><? echo $emblishment_name_array[$row["emb_name"]]; ?></td>
						<td align="left"><? echo $em_type; ?></td>
						<td align="right"><? echo number_format($row["cons_dzn_gmts"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_cons"],4); ?></td>
						<td align="right"><? echo number_format($row["rate"],4); ?></td>
						<td align="right"><? echo number_format($row["amount"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
					</tr>
				<?
					$TotalDznAmount += $row["amount"];
					$TotalAmount += $row["tot_amount"];
				}
				?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="5" align="left">Total</td>
						<td align="right"><? echo number_format($TotalDznAmount,4); ?></td>
						<td align="right"><? echo number_format($TotalAmount,4); ?></td>
					</tr>
				</table>
		</div>
		<?
		}
		else
		{
			if($totEmb>0)
			{
		?>
		<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<label><b>Embellishment Details</b></label>
					<tr style="font-weight:bold">
						<td width="150">Particulars</td>
						<td width="150">Type</td>
						<td width="150">Cons/Dzn</td>
						<td width="150">Tot.Cons</td>
						<td width="100">Rate (USD)</td>
						<td width="100">Amount (USD)</td>
						<td width="100">Tot. Amount</td>
					</tr>
				<?
			$TotalDznAmount=0;
			$TotalAmount =0;
				foreach( $EmbData as $index=>$row  )
				{
					$em_type ="";
					if($row["emb_name"]==1)$em_type = $emblishment_print_type[$row["emb_type"]];
					else if($row["emb_name"]==2)$em_type = $emblishment_embroy_type[$row["emb_type"]];
					else if($row["emb_name"]==3)$em_type = $emblishment_wash_type[$row["emb_type"]];
					else if($row["emb_name"]==4)$em_type = $emblishment_spwork_type[$row["emb_type"]];
					else if($row["emb_name"]==5)$em_type = $emblishment_gmts_type[$row["emb_type"]];
					else if($row["emb_name"]==99 )$em_type = $emblishment_other_type_arr[$row["emb_type"]];


				?>
					<tr>
						<td align="left"><? echo $emblishment_name_array[$row["emb_name"]]; ?></td>
						<td align="left"><? echo $em_type; ?></td>
						<td align="right"><? echo number_format($row["cons_dzn_gmts"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_cons"],4); ?></td>
						<td align="right"><? echo number_format($row["rate"],4); ?></td>
						<td align="right"><? echo number_format($row["amount"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
					</tr>
				<?
					$TotalDznAmount += $row["amount"];
					$TotalAmount += $row["tot_amount"];
				}
				?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="5" align="left">Total</td>
						<td align="right"><? echo number_format($TotalDznAmount,4); ?></td>
						<td align="right"><? echo number_format($TotalAmount,4); ?></td>
					</tr>
				</table>
		</div>
		<?

			}
			else
			{
				echo "";
			}
		}
		//End Embellishment Details Part report here -------------------------------------------


		//start	Commercial Cost part report here -------------------------------------------

		if($zero_value==1)
		{
		?>

			<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<label><b>Commercial Cost</b></label>
					<tr style="font-weight:bold">
						<td width="150">Particulars</td>
						<td width="100">Rate In %</td>
						<td width="100">Amount (USD)</td>
						<td width="100">Tot.Amount</td>
					</tr>
				<?
			$TotalDznAount=0;
			$TotalAount =0;
				foreach( $CommarData as $index=>$row )
				{
				?>
					<tr>
						<td align="left"><? echo $camarcial_items[$row["item_id"]]; ?></td>
						<td align="right"><? echo number_format($row["rate"],4); ?></td>
						<td align="right"><? echo number_format($row["amount"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
					</tr>
				<?
					$TotalDznAount += $row["amount"];
					$TotalAount += $row["tot_amount"];
				}
				?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Total</td>
						<td align="right"><? echo number_format($TotalDznAount,4); ?></td>
						<td align="right"><? echo number_format($TotalAount,4); ?></td>
					</tr>
				</table>
		</div>
		<?
		}
		else
		{
			if($totCommar>0)
			{
			?>
			<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<label><b>Commercial Cost</b></label>
					<tr style="font-weight:bold">
						<td width="150">Particulars</td>
						<td width="100">Rate (USD)</td>
						<td width="100">Amount (USD)</td>
						<td width="100">Tot.Amount</td>
					</tr>
				<?
			$TotalDznAount=0;
			$TotalAount =0;
				foreach( $CommarData as $index=>$row  )
				{
				?>
					<tr>
						<td align="left"><? echo $camarcial_items[$row["item_id"]]; ?></td>
						<td align="right"><? echo number_format($row["rate"],4); ?></td>
						<td align="right"><? echo number_format($row["amount"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
					</tr>
				<?
					$TotalDznAount += $row["amount"];
					$TotalAount += $row["tot_amount"];
				}
				?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Total</td>
						<td align="right"><? echo number_format($TotalDznAount,4); ?></td>
						<td align="right"><? echo number_format($TotalAount,4); ?></td>
					</tr>
				</table>
		</div>
			<?
			}
			else
			{
				echo "";
			}

		}
		//End Commercial Cost Part report here -------------------------------------------


		//start	Commission Cost part report here -------------------------------------------
		if($zero_value==1)
		{
		?>


			<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<label><b>Commission Cost</b></label>
					<tr style="font-weight:bold">
						<td width="150">Particulars</td>
						<td width="150">Commission Basis</td>
						<td width="100">Rate (USD)</td>
						<td width="100">Amount (USD)</td>
						<td width="100">Tot. Amount</td>
					</tr>
				<?
				$TotalDznAount = 0;
				$TotalAount = 0;
				foreach( $CommiData as $index=>$row )
				{
				?>
					<tr>
						<td align="left"><? echo $commission_particulars[$row["particulars_id"]]; ?></td>
						<td align="left"><? echo $commission_base_array[$row["commission_base_id"]]; ?></td>
						<td align="right"><? echo number_format($row["commision_rate"],4); ?></td>
						<td align="right"><? echo number_format($row["commission_amount"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_commission_amount"],4); ?></td>
					</tr>
				<?
					$TotalDznAount += $row["commission_amount"];
					$TotalAount += $row["tot_commission_amount"];
				}
				?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="3" align="left">Total</td>
						<td align="right"><? echo number_format($TotalDznAount,4); ?></td>
						<td align="right"><? echo number_format($TotalAount,4); ?></td>
					</tr>
				</table>
		</div>
		<?
		}
		else
		{
			if($totCommi>0)
			{
				$TotalDznAount = 0;
				$TotalAount = 0;
			?>
			<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<label><b>Commission Cost</b></label>
					<tr style="font-weight:bold">
						<td width="150">Particulars</td>
						<td width="150">Commission Basis</td>
						<td width="100">Rate (USD)</td>
						<td width="100">Amount (USD)</td>
						<td width="100">Tot. Amount</td>
					</tr>
				<?
				$total_amount=0;
				foreach( $CommiData as $index=>$row )
				{
				?>
					<tr>
					<td align="left"><? echo $commission_particulars[$row["particulars_id"]]; ?></td>
						<td align="left"><? echo $commission_base_array[$row["commission_base_id"]]; ?></td>
						<td align="right"><? echo number_format($row["commision_rate"],4); ?></td>
						<td align="right"><? echo number_format($row["commission_amount"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_commission_amount"],4); ?></td>
					</tr>
				<?
					$TotalDznAount += $row["commission_amount"];
					$TotalAount += $row["tot_commission_amount"];
				}
				?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="3" align="left">Total</td>
						<td align="right"><? echo number_format($TotalDznAount,4); ?></td>
						<td align="right"><? echo number_format($TotalAount,4); ?></td>
					</tr>
				</table>
		</div>
			<?
			}
			else
			{
			echo "";
			}

		}
		//End Commission Cost Part report here -------------------------------------------


		?>
		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:300px; display: block;" rules="all">
				<label><b>CM Details</b></label>
					<tr>
						<td width="150">CPM (TK)</td>
						<td width="150"><? echo $financial_para[$pre_costing_date][cost_per_minute] ?></td>

					</tr>
					<tr>
						<td width="150">SMV</td>
						<td width="150"><? echo $sew_smv .", ".$cut_smv ?></td>
					</tr>
					<tr>
						<td width="150">EFF %</td>
						<td width="150"><? echo $sew_effi_percent .", ".$cut_effi_percent; ?></td>
					</tr>

	</table>
			<?
			// image show here  -------------------------------------------
			$sqlData = "select id,master_tble_id,image_location
					from common_photo_library
					where master_tble_id=".$txt_job_no."";
			$data_array_img=sql_select($sqlData);
		?>
			<div style=" margin-left:310px;margin-top:-70px; display: block;" >
				<? foreach($data_array_img AS $inf){ ?>
					<img  src='<? echo $path.$inf[csf("image_location")]; ?>' border="1" height='97' width='89' />
				<?  } ?>
			</div>
		<br/><br/><br/> <br/>

		<?
		$lib_designation_arr=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");
		$user_lib_designation_arr=return_library_array("SELECT id,designation from user_passwd", "id", "designation");
		$user_lib_name_arr=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");

		$mst_id=return_field_value("id as mst_id","wo_pre_cost_mst","job_no=$txt_job_no","mst_id");
		//and b.un_approved_date is null
		//echo "select b.approved_by, min(b.approved_date) as approved_date from  approval_history b where b.mst_id=$mst_id and b.entry_form=15 group by  b.approved_by order by b.sequence_no asc";
		$approve_data_array=sql_select("select b.approved_by, min(b.approved_date) as approved_date from  approval_history b where b.mst_id=$mst_id and b.entry_form=46 group by  b.approved_by order by b.approved_by asc");
		$unapprove_data_array=sql_select("select b.approved_by, b.un_approved_by, b.approved_date, b.un_approved_reason, b.un_approved_date, b.approved_no from approval_history b where b.mst_id=$mst_id and b.entry_form=46 order by b.approved_date, b.approved_by");
		// echo "select b.approved_by,b.approved_date,b.un_approved_reason,b.un_approved_date,b.approved_no from   approval_history b where b.mst_id=$mst_id and b.entry_form=15  order by b.approved_no";
		if(count($approve_data_array)>0)
		{
			?>
			<table  width="850" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
				<thead>
					<tr style="border:1px solid black;">
						<th colspan="5" style="border:1px solid black;">Approval Status</th>
					</tr>
					<tr style="border:1px solid black;">
						<th width="3%" style="border:1px solid black;">Sl</th>
						<th width="40%" style="border:1px solid black;">Name</th>
						<th width="30%" style="border:1px solid black;">Designation</th>
						<th width="27%" style="border:1px solid black;">Approval Date</th>
					</tr>
				</thead>
				<tbody>
				<?
				$i=1;
				foreach($approve_data_array as $row)
				{
					?>
					<tr style="border:1px solid black;">
					<td width="3%" style="border:1px solid black;"><? echo $i;?></td>
					<td width="40%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
					<td width="30%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
					<td width="27%" style="border:1px solid black;text-align:center"><? echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')]));?></td>
					</tr>
					<?
					$i++;
				}
				?>
				</tbody>
			</table>
			<?
		}
		?>
		<br/>
		<?
		$sql_unapproved=sql_select("select booking_id,approval_cause from fabric_booking_approval_cause where entry_form=46 and approval_type=2 and is_deleted=0 and status_active=1 and booking_id=$mst_id");
		//echo "select booking_id,approval_cause from fabric_booking_approval_cause where  entry_form=15 and approval_type=2 and is_deleted=0 and status_active=1 and booking_id=$mst_id";
		$unapproved_request_arr=array();
		foreach($sql_unapproved as $rowu)
		{
			$unapproved_request_arr[$rowu[csf('booking_id')]]=$rowu[csf('approval_cause')];
		}

		if(count($unapprove_data_array)>0)
		{
			?>
			<table  width="850" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
				<thead>
					<tr style="border:1px solid black;">
						<th colspan="6" style="border:1px solid black;">Approval/Un Approval History</th>
					</tr>
					<tr style="border:1px solid black;">
						<th width="3%" style="border:1px solid black;">Sl</th>
						<th width="30%" style="border:1px solid black;">Name</th>
						<th width="20%" style="border:1px solid black;">Designation</th>
						<th width="5%" style="border:1px solid black;">Approval Status</th>
						<th width="20%" style="border:1px solid black;">Reason For Un Approval</th>
						<th width="22%" style="border:1px solid black;"> Date</th>
					</tr>
				</thead>
				<tbody>
					<?
					$i=1;
					foreach($unapprove_data_array as $row)
					{
						?>
						<tr style="border:1px solid black;">
							<td width="3%" style="border:1px solid black;"><? echo $i;?></td>
							<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
							<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
							<td width="5%" style="border:1px solid black; text-align:center"><? echo 'Yes';?></td>
							<td width="20%" style="border:1px solid black;"><? echo '';?></td>
							<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); else echo "";?></td>
						</tr>
						<?
						$i++;
						$un_approved_date= explode(" ",$row[csf('un_approved_date')]);
						$un_approved_date=$un_approved_date[0];
						if($db_type==0) //Mysql
						{
							if($un_approved_date=="" || $un_approved_date=="0000-00-00") $un_approved_date="";else $un_approved_date=$un_approved_date;
						}
						else
						{
							if($un_approved_date=="") $un_approved_date="";else $un_approved_date=$un_approved_date;
						}

						if($un_approved_date!="")
						{
							if($row[csf('un_approved_by')]!=0) $row[csf('approved_by')]=$row[csf('un_approved_by')];
							?>
							<tr style="border:1px solid black;">
								<td width="3%" style="border:1px solid black;"><? echo $i;?></td>
								<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
								<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
								<td width="5%" style="border:1px solid black;text-align:center;"><? echo 'No';?></td>
								<td width="20%" style="border:1px solid black;text-align:center"><? echo $unapproved_request_arr[$mst_id];?></td>
								<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('un_approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('un_approved_date')])); else echo "";?></td>
							</tr>

							<?
							$i++;
						}
					}
					?>
				</tbody>
			</table>
			<?
		}
		echo signature_table(109, $cbo_company_name, "860px");
		exit();
}

if($action=="preCostRptWoven")//Cost Woven Btn 7
	{
		$process = array( &$_POST );
		extract(check_magic_quote_gpc( $process ));
		if($txt_job_no==""){
			$job_no='';
		}else{
			$job_no=" and a.job_no=".$txt_job_no."";
		}

		if($cbo_company_name=="") {
			$company_name='';
		} else {
			$company_name=" and a.company_name=".$cbo_company_name."";
		}

		if($cbo_buyer_name==""){
			$cbo_buyer_name='';
		} else {
			$cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
		}

		if($txt_style_ref==""){
			$txt_style_ref='';
		} else {
			$txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
		}

		$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
		if($txt_costing_date=="") {
			$txt_costing_date='';
		} else {
			$txt_costing_date=" and b.costing_date='".$txt_costing_date."'";
		}
		$txt_po_breack_down_id=str_replace("'",'',$txt_po_breack_down_id);

		if(str_replace("'",'',$txt_po_breack_down_id)==""){
			$txt_po_breack_down_id_cond='';
		}
		else{
			$txt_po_breack_down_id_cond=" and b.id in(".$txt_po_breack_down_id.")";
		}

		$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
		$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
		$supplier_name_arr=return_library_array( "select id, supplier_name from  lib_supplier",'id','supplier_name');
		$color_library=return_library_array("select id,color_name from lib_color where status_active=1 and is_deleted=0","id","color_name");

		$poNumber=array();
		$pubShipDate=array();
		$po_qty=0;
		$po_plun_cut_qty=0;
		$total_set_qnty=0;
		$avg_unit_price=0;
		$sql_po="select a.job_no,a.total_set_qnty,a.avg_unit_price,b.id,b.po_number,b.pub_shipment_date,c.item_number_id,c.country_id,c.color_number_id,c.size_number_id,c.order_quantity,c.order_total ,c.plan_cut_qnty  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst   and b.id=c.po_break_down_id  and a.job_no =".$txt_job_no." $txt_po_breack_down_id_cond and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 order by b.id";
		$sql_po_data=sql_select($sql_po);
		$po_qty=$po_amt=0;
		foreach($sql_po_data as $sql_po_row){
			$po_qty+=$sql_po_row[csf('order_quantity')];
			$po_amt+=$sql_po_row[csf('order_total')];
			$po_plun_cut_qty+=$sql_po_row[csf('plan_cut_qnty')];
			$total_set_qnty=$sql_po_row[csf('total_set_qnty')];
			$poNumber[$sql_po_row[csf('po_number')]]=$sql_po_row[csf('po_number')];
			$pubShipDate[$sql_po_row[csf('po_number')]]=change_date_format($sql_po_row[csf('pub_shipment_date')],"dd-mm-yyyy","-");
			//$avg_unit_price=$sql_po_row[csf('avg_unit_price')];
		}
		$avg_unit_price=$po_amt/$po_qty;
		$po_no=""; $po_no=implode(", ",$poNumber);
		$poQtyUom=$po_qty/$total_set_qnty;
		$poPlunCutQtyUom=$po_plun_cut_qty/$total_set_qnty;
		$excessQty=$poPlunCutQtyUom-$poQtyUom;
		$excessPer=(100*$excessQty)/$poQtyUom;

		$gmtsItem=array();
		$gmtsitem_ratio_array=array();
		$gmtsitem_ratio_sql=sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no =".$txt_job_no."");
		foreach($gmtsitem_ratio_sql as $gmtsitem_ratio_sql_row){
			$gmtsitem_ratio_array[$gmtsitem_ratio_sql_row[csf('job_no')]][$gmtsitem_ratio_sql_row[csf('gmts_item_id')]]=$gmtsitem_ratio_sql_row[csf('set_item_ratio')];
			$gmtsItem[$gmtsitem_ratio_sql_row[csf('gmts_item_id')]]=$garments_item[$gmtsitem_ratio_sql_row[csf("gmts_item_id")]];
		}

		$financial_para=array();
		$sql_std_para=sql_select("select interest_expense,income_tax,cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and status_active=1 and	is_deleted=0 order by id");
		foreach($sql_std_para as $sql_std_row){
			$financial_para[interest_expense]=$sql_std_row[csf('interest_expense')];
			$financial_para[income_tax]=$sql_std_row[csf('income_tax')];
			$financial_para[cost_per_minute]=$sql_std_row[csf('cost_per_minute')];
		}


		$sql = "select a.job_no, a.company_name, a.buyer_name, a.style_ref_no, a.gmts_item_id, a.order_uom, a.job_quantity, a.avg_unit_price, b.costing_per, b.budget_minute, b.sew_smv, b.cut_smv,b.sew_effi_percent,b.cut_effi_percent,b.approved,b.id from wo_po_details_master a, wo_pre_cost_mst b where a.job_no=b.job_no  and a.status_active=1 $job_no $company_name $cbo_buyer_name $txt_style_ref order by a.job_no";
		$data_array=sql_select($sql);
		$uom="";
		$jobNo="";
		$buyerName="";
		$styleRefNo="";
		$costingPer="";
		$pre_cost_id = "";

		foreach ($data_array as $row){
			$uom=$row[csf("order_uom")];
			$jobNo=$row[csf("job_no")];
			$buyerName=$buyer_arr[$row[csf("buyer_name")]];
			$styleRefNo=$row[csf("style_ref_no")];
			$costingPer=$row[csf("costing_per")];
			$pre_cost_id=$row[csf("id")];

			$order_price_per_dzn=0;
			if($costingPer==1){
				$order_price_per_dzn=12;
				$costing_for=" DZN";
			}
			else if($costingPer==2){
				$order_price_per_dzn=1;
				$costing_for=" PCS";
			}
			else if($costingPer==3){
				$order_price_per_dzn=24;
				$costing_for=" 2 DZN";
			}
			else if($costingPer==4){
				$order_price_per_dzn=36;
				$costing_for=" 3 DZN";
			}
			else if($costingPer==5){
				$order_price_per_dzn=48;
				$costing_for=" 4 DZN";
			}
		}

		//start	all summary report here -------------------------------------------
		$condition= new condition();
		if(str_replace("'","",$txt_job_no) !=''){
			$condition->job_no("=$txt_job_no");
		}
		if(str_replace("'",'',$txt_po_breack_down_id) !=""){
			$condition->po_id("in($txt_po_breack_down_id)");
		}
		$condition->init();
		$fabric= new fabric($condition);
		$trim= new trims($condition);
		$emblishment= new emblishment($condition);
		$wash= new wash($condition);
		$other= new other($condition);
		$other_cost=$other->getAmountArray_by_job();
		$commercial= new commercial($condition);
		$commision= new commision($condition);


		$sql_new = "select job_no,fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,wash_cost,wash_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,currier_pre_cost,currier_percent,certificate_pre_cost,certificate_percent,common_oh,common_oh_percent,depr_amor_pre_cost,total_cost , total_cost_percent, price_dzn, price_dzn_percent, margin_dzn,margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche from wo_pre_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
		$data_array_new=sql_select($sql_new);
		$summary_data=array();

		foreach( $data_array_new as $row_new ){
			$summary_data[price_dzn]=$row_new[csf("price_dzn")];
			$summary_data[price_dzn_job]=($po_qty/($total_set_qnty*$order_price_per_dzn))*$row_new[csf("price_dzn")];
			$summary_data[price_dzn_job_per]=($summary_data[price_dzn_job]/$summary_data[price_dzn_job])*100;

			$summary_data[commission]=$row_new[csf("commission")];
			$summary_data[trims_cost]=$row_new[csf("trims_cost")];
			$summary_data[emb_cost]=$row_new[csf("embel_cost")];

			$summary_data[lab_test]=$row_new[csf("lab_test")];
			$summary_data[lab_test_job]=$other_cost[$row_new[csf("job_no")]]['lab_test'];

			$summary_data[inspection]=$row_new[csf("inspection")];
			$summary_data[inspection_job]=$other_cost[$row_new[csf("job_no")]]['inspection'];

			$summary_data[freight]=$row_new[csf("freight")];
			$summary_data[freight_job]=$other_cost[$row_new[csf("job_no")]]['freight'];

			$summary_data[currier_pre_cost]=$row_new[csf("currier_pre_cost")];
			$summary_data[currier_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['currier_pre_cost'];

			$summary_data[certificate_pre_cost]=$row_new[csf("certificate_pre_cost")];
			$summary_data[certificate_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['certificate_pre_cost'];
			$summary_data[wash_cost]=$row_new[csf("wash_cost")];

			$summary_data[OtherDirectExpenses]=$row_new[csf("lab_test")]+$row_new[csf("inspection")]+$row_new[csf("freight")]+$row_new[csf("currier_pre_cost")]+$row_new[csf("certificate_pre_cost")]+$row_new[csf("wash_cost")];

			$summary_data[OtherDirectExpenses_job]=$summary_data[lab_test_job]+$summary_data[inspection_job]+$summary_data[freight_job]+$summary_data[currier_pre_cost_job]+$summary_data[certificate_pre_cost_job];

			$summary_data[cm_cost]=$row_new[csf("cm_cost")];
			$summary_data[cm_cost_job]=$other_cost[$row_new[csf("job_no")]]['cm_cost'];

			$summary_data[comm_cost]=$row_new[csf("comm_cost")];

			$summary_data[common_oh]=$row_new[csf("common_oh")];
			$summary_data[common_oh_job]=$other_cost[$row_new[csf("job_no")]]['common_oh'];
			$summary_data[depr_amor_pre_cost]=$row_new[csf("depr_amor_pre_cost")];
			$summary_data[depr_amor_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['depr_amor_pre_cost'];
		}

	//Fabric =====================
	$fabric_qty=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$fabric_amount=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$sql_fabric = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description,uom, avg_cons,avg_cons_yarn, fabric_source,gsm_weight, rate, amount, avg_finish_cons, status_active,nominated_supp_multi from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no."";
	$data_arr_fabric=sql_select($sql_fabric);
	$totFabQty=0;
	$totFabAmt=0;
	$FabricData=array();
	foreach($data_arr_fabric as $fab_row){
		$summary_data[fabric_cost][$fab_row[csf("id")]]=$fab_row[csf("amount")];
		if($fab_row[csf("fab_nature_id")] == 3)
		{
			$summary_data[fabric_cost_job]+=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		}
		if($fab_row[csf("fab_nature_id")] == 2)
		{
			$summary_data[fabric_cost_job]+=$fabric_amount['knit']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		}
		$totFabQty+=$fabric_qty['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		$totFabAmt+=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];

		$FabricData[$fab_row[csf("id")]]['description']=$body_part[$fab_row[csf("body_part_id")]].", ".$color_type[$fab_row[csf("color_type_id")]].", ".$fab_row[csf("fabric_description")].", ".$fab_row[csf("gsm_weight")];
		$FabricData[$fab_row[csf("id")]]['fabric_source']=$fabric_source[$fab_row[csf("fabric_source")]];
		//$FabricData[$fab_row[csf("id")]]['nominated_supp']=$supplier_name_arr[$fab_row[csf("nominated_supp")]];
		$FabricData[$fab_row[csf("id")]]['nominated_supp']=$fab_row[csf("nominated_supp_multi")];
		$FabricData[$fab_row[csf("id")]]['avg_cons']=$fab_row[csf("avg_cons")];
		if($fab_row[csf("fab_nature_id")] == 3){
			$FabricData[$fab_row[csf("id")]]['totalConsWoven']=$fabric_qty['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
			$FabricData[$fab_row[csf("id")]]['totalAmountWoven']=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		}
		if($fab_row[csf("fab_nature_id")] == 2){
			$FabricData[$fab_row[csf("id")]]['totalConsWoven']=$fabric_qty['knit']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
			$FabricData[$fab_row[csf("id")]]['totalAmountWoven']=$fabric_amount['knit']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		}
		$FabricData[$fab_row[csf("id")]]['uom']=$unit_of_measurement[$fab_row[csf("uom")]];
		$FabricData[$fab_row[csf("id")]]['rate']=$fab_row[csf("rate")];
		$FabricData[$fab_row[csf("id")]]['amount']=$fab_row[csf("rate")]*$fab_row[csf("avg_cons")];
	}
	$totFabQtyAsCostPer=($totFabQty/$poPlunCutQtyUom)*$order_price_per_dzn;
	//Fabric End======================
	//start	Trims Cost part report here -------------------------------------------
	$sql_trim = "select id, job_no, trim_group,description,brand_sup_ref,remark, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp_multi, status_active, seq
	from wo_pre_cost_trim_cost_dtls
	where job_no=".$txt_job_no." and is_deleted= 0 order by seq";
	$data_array_trim=sql_select($sql_trim);
	$trim_amount_arr=$trim->getAmountArray_by_jobAndPrecostdtlsid();
	$trim_qty_arr=$trim->getQtyArray_by_jobAndPrecostdtlsid();
	//$trim_amount_arr=$trim->getAmountArray_by_jobAndPrecostdtlsid_consAndTotcons();
	//$trim_qty_arr=$trim->getQtyArray_by_jobAndPrecostdtlsid_consAndTotcons();
	$totTrim=0;
	$TrimData=array();
	foreach( $data_array_trim as $row_trim ){
		$trim_qty=$trim_qty_arr[$row_trim[csf("job_no")]][$row_trim[csf("id")]];
		$trim_amount=$trim_amount_arr[$row_trim[csf("job_no")]][$row_trim[csf("id")]];
		$summary_data[trims_cost_job]+=$trim_amount;
		$TrimData[$row_trim[csf('id')]]['trim_group']=$row_trim[csf('trim_group')];
		$TrimData[$row_trim[csf('id')]]['description']=$row_trim[csf('description')];
		$TrimData[$row_trim[csf('id')]]['brand_sup_ref']=$row_trim[csf('brand_sup_ref')];
		$TrimData[$row_trim[csf('id')]]['nominated_supp']=$row_trim[csf('nominated_supp_multi')];
		$TrimData[$row_trim[csf('id')]]['remark']=$row_trim[csf('remark')];
		$TrimData[$row_trim[csf('id')]]['cons_uom']=$row_trim[csf('cons_uom')];
		$TrimData[$row_trim[csf('id')]]['cons_dzn_gmts']=$row_trim[csf('cons_dzn_gmts')];
		$TrimData[$row_trim[csf('id')]]['rate']=$row_trim[csf('rate')];
		$TrimData[$row_trim[csf('id')]]['amount']=$row_trim[csf('amount')];
		$TrimData[$row_trim[csf('id')]]['apvl_req']=$row_trim[csf('apvl_req')];
		//$TrimData[$row_trim[csf('id')]]['nominated_supp']=$row_trim[csf('nominated_supp')];
		$TrimData[$row_trim[csf('id')]]['tot_cons']=$trim_qty;
		$TrimData[$row_trim[csf('id')]]['tot_amount']=$trim_amount;
		$totTrim+=$row_trim[csf('cons_dzn_gmts')];
	}
	//End	Trims Cost part report here -------------------------------------------
	//Emb cost Cost part report here -------------------------------------------

	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name in(1,2,4,5)";
	$data_array=sql_select($sql);
	$emblishment_qty=$emblishment->getQtyArray_by_jobAndEmblishmentid();
	$emblishment_amount=$emblishment->getAmountArray_by_jobAndEmblishmentid();

	$totEmb=0;
	$EmbData=array();

	foreach( $data_array as $row ){
	$embqty=$emblishment_qty[$row[csf("job_no")]][$row[csf("id")]];
	$embamount=$emblishment_amount[$row[csf("job_no")]][$row[csf("id")]];
	$summary_data[emb_cost_job]+=$embamount;
	$EmbData[$row[csf("id")]]['emb_name']=$row[csf("emb_name")];
	$EmbData[$row[csf("id")]]['emb_type']=$row[csf("emb_type")];
	$EmbData[$row[csf("id")]]['cons_dzn_gmts']=$row[csf("cons_dzn_gmts")];
	$EmbData[$row[csf("id")]]['rate']=$row[csf("rate")];
	$EmbData[$row[csf("id")]]['amount']=$row[csf("amount")];
	$EmbData[$row[csf("id")]]['tot_cons']=$embqty;
	$EmbData[$row[csf("id")]]['tot_amount']=$embamount;
	$totEmb+=$row[csf("cons_dzn_gmts")];
	}
	//End Emb cost Cost part report here -------------------------------------------
	//Wash cost Cost part report here -------------------------------------------
	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name =3";
	$data_array=sql_select($sql);
	$wash_qty=$wash->getQtyArray_by_jobAndEmblishmentid();
	$wash_amount=$wash->getAmountArray_by_jobAndEmblishmentid();
	foreach( $data_array as $row ){
		$washqty=$wash_qty[$row[csf("job_no")]][$row[csf("id")]];
		$washamount=$wash_amount[$row[csf("job_no")]][$row[csf("id")]];
		$summary_data[wash_cost_job]+=$washamount;
		$summary_data[OtherDirectExpenses_job]+=$washamount;
		$EmbData[$row[csf("id")]]['emb_name']=$row[csf("emb_name")];
		$EmbData[$row[csf("id")]]['emb_type']=$row[csf("emb_type")];
		$EmbData[$row[csf("id")]]['cons_dzn_gmts']=$row[csf("cons_dzn_gmts")];
		$EmbData[$row[csf("id")]]['rate']=$row[csf("rate")];
		$EmbData[$row[csf("id")]]['amount']=$row[csf("amount")];
		$EmbData[$row[csf("id")]]['tot_cons']=$washqty;
		$EmbData[$row[csf("id")]]['tot_amount']=$washamount;
		$totEmb+=$row[csf("cons_dzn_gmts")];
	}
	//End Wash cost Cost part report here -------------------------------------------

	//Commision cost Cost part report here -------------------------------------------
	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls  where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	$commision_amount=$commision->getAmountArray_by_jobAndPrecostdtlsid();
	$totCommi=0;
	$CommiData=array();
	foreach( $data_array as $row ){
		$CommiData[$row[csf("id")]]['particulars_id']=$row[csf("particulars_id")];
		$CommiData[$row[csf("id")]]['commission_base_id']=$row[csf("commission_base_id")];
		$CommiData[$row[csf("id")]]['commision_rate']=$row[csf("commision_rate")];
		$CommiData[$row[csf("id")]]['commission_amount']=$row[csf("commission_amount")];
		$CommiData[$row[csf("id")]]['tot_commission_amount']=$commision_amount[$row[csf("job_no")]][$row[csf("id")]];
		$totCommi+=$row[csf("commission_amount")];
		$summary_data[commission_job]+=$commision_amount[$row[csf("job_no")]][$row[csf("id")]];
	}
	$summary_data[commission_job_per]=($summary_data[commission_job]/$summary_data[price_dzn_job])*100;
	//End Commision cost Cost part report here -------------------------------------------

	//Commarcial cost Cost part report here -------------------------------------------
	$sql = "select id, job_no, item_id, rate, amount, status_active from  wo_pre_cost_comarci_cost_dtls  where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	$commarcial_amount=$commercial->getAmountArray_by_jobAndPrecostdtlsid();

	$totCommar=0;
	$CommarData=array();
	foreach( $data_array as $row ){
		$commarcialamount=$commarcial_amount[$row[csf("job_no")]][$row[csf("id")]];
		$summary_data[comm_cost_job]+=$commarcialamount;
		$CommarData[$row[csf("id")]]['item_id']=$row[csf("item_id")];
		$CommarData[$row[csf("id")]]['rate']=$row[csf("rate")];
		$CommarData[$row[csf("id")]]['amount']=$row[csf("amount")];
		$CommarData[$row[csf("id")]]['tot_amount']=$commarcialamount;
		$totCommar+=$row[csf("amount")];
	}
	//End Commarcial cost Cost part report here -------------------------------------------
	$NetFOBValue=$summary_data[price_dzn]-$summary_data[commission];
	$NetFOBValue_job=$summary_data[price_dzn_job]-$summary_data[commission_job];

	$Less_Cost_Material_Services=array_sum($summary_data[fabric_cost])+$summary_data[trims_cost]+$summary_data[emb_cost]+$summary_data[lab_test]+$summary_data[inspection]+$summary_data[freight]+$summary_data[currier_pre_cost]+$summary_data[certificate_pre_cost]+$summary_data[wash_cost];
	$Less_Cost_Material_Services_job=$summary_data[fabric_cost_job]+$summary_data[trims_cost_job]+$summary_data[emb_cost_job]+$summary_data[OtherDirectExpenses_job];

	$Contribution_Margin=$NetFOBValue-$Less_Cost_Material_Services;
	$Contribution_Margin_job=$NetFOBValue_job-$Less_Cost_Material_Services_job;

	$Gross_Profit=$Contribution_Margin-$summary_data[cm_cost];
	$Gross_Profit_job=$Contribution_Margin_job-$summary_data[cm_cost_job];

	$OperatingProfitLoss=$Gross_Profit-($summary_data[comm_cost]+$summary_data[common_oh]);
	$OperatingProfitLoss_job=$Gross_Profit_job-($summary_data[comm_cost_job]+$summary_data[common_oh_job]);

	$interest_expense=$NetFOBValue*$financial_para[interest_expense]/100;
	$income_tax=$NetFOBValue*$financial_para[income_tax]/100;
	$interest_expense_job=$NetFOBValue_job*$financial_para[interest_expense]/100;
	$income_tax_job=$NetFOBValue_job*$financial_para[income_tax]/100;
	$Netprofit=$OperatingProfitLoss-($summary_data[depr_amor_pre_cost]+$interest_expense+$income_tax);
	$Netprofit_job=$OperatingProfitLoss_job-($summary_data[depr_amor_pre_cost_job]+$interest_expense_job+$income_tax_job);


	?>
		<div style="width:852px; margin:0 auto">
		<div style="width:850px; font-size:20px; font-weight:bold" align="center"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></div>
		<div style="width:850px; font-size:14px; font-weight:bold" align="center">Pre- Costing</div>
		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
			<tr>
				<td width="80">Job Number</td>
				<td width="80"><b><? echo $jobNo; ?></b></td>
				<td width="90">Buyer</td>
				<td width="100"><b><? echo $buyerName; ?></b></td>
				<td width="80">Garments Item</td>
				<td width="100"><b><? echo implode(",",$gmtsItem); ?></b></td>
			</tr>
			<tr>
				<td>Order Qty </td>
				<td colspan=""><b><? echo $poQtyUom; ?></b></td>
				<td>Excess Cut %</td>
				<td><b><?  echo number_format($excessPer,2) ?></b></td>
				<td>Plan Cut Qty</td>
				<td><b><? echo $poPlunCutQtyUom." ". $unit_of_measurement[$uom];?></b></td>
			</tr>
			<tr>
				<td>Style Ref. No </td>
				<td colspan=""><b><? echo $styleRefNo; ?></b></td>
				<td>Costing Per</td>
				<td><b><? echo $costing_per[$costingPer];?></b></td>
				<td>Price Per Unit</td>
				<td><b><? echo number_format($avg_unit_price,4); ?></b></td>
			</tr>
			<tr>
				<td>Order Numbers</td>
				<td colspan="5"><p><? echo $po_no; ?></p></td>
			</tr>
			<tr>
				<td>Shipment Date </td>
				<td colspan="3"><b><? echo implode(", ",$pubShipDate); ?></b></td>
				<td>Fabric Cons</td>
				<td><b><? echo number_format($totFabQtyAsCostPer,2); ?></b></td>
			</tr>
		</table>
		<?
		$approved_sql=sql_select("SELECT  mst_id, approved_by ,approved_date  from approval_history where entry_form=46 AND  mst_id =$pre_cost_id and un_approved_date is null ");
		$user_lib_name=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");
		$user_lib_desg=return_library_array("SELECT id,designation from user_passwd", "id", "designation");
		$designation_lib=return_library_array("SELECT id,custom_designation from lib_designation", "id", "custom_designation");
		if(count($approved_sql) > 0){ $sl=1; ?>
			<div style="margin-top:15px">
					<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
					<label><b>Pre-Cost Approval Status </b></label>
						<tr style="font-weight:bold">
							<th width="20">SL</th>
							<th width="250">Name</th>
							<th width="200">Designation</th>
							<th width="100">Approval Date</th>
						</tr>
						<? foreach ($approved_sql as $key => $value) { ?>
							<tr>
							<td width="20"><? echo $sl; ?></td>
							<td width="250"><? echo $user_lib_name[$value[csf("approved_by")]]; ?></td>
							<td width="200"><? echo $designation_lib[$user_lib_desg[$value[csf("approved_by")]]]; ?></td>
							<td width="100"><? echo change_date_format($value[csf("approved_date")]); ?></td>
						</tr>
						<? $sl++; }  ?>

					</table>
			</div>
		<? } ?>
		<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
			<tr style="font-weight:bold">

								<td width="380" colspan="5">Order Profitability </td>

							</tr>
							<tr style="font-weight:bold">
								<td width="80">Line Items</td>
								<td width="380">Particulars</td>
								<td width="100">Amount (USD)/<? echo $costing_for; ?></td>
								<td width="100">Total Value</td>
								<td width="100">%</td>
							</tr>
							<tr>
								<td width="80">1</td>
								<td width="380" align="left" style="font-weight:bold">Gross FOB Value</td>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format($summary_data[price_dzn],4); ?></td>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format($summary_data[price_dzn_job],4); ?></td>
								<td width="180" align="right" style="font-weight:bold"><? echo number_format($summary_data[price_dzn_job_per],2);?></td>
							</tr>
							<tr>
								<td width="80">2</td>
								<td width="380" align="left" style=" padding-left:15px">Less: commission</td>

								<td width="100" align="right"><? echo number_format($summary_data[commission],4); ?></td>
								<td width="100" align="right"><? echo number_format($summary_data[commission_job],4); ?></td>
								<td width="180" align="right"><? echo number_format($summary_data[commission_job_per],2);?></td>
							</tr>
							<tr>
							<td width="80">3</td>
								<td width="380" align="left" style="font-weight:bold"><b>Net FOB Value (1-2)</b></td>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format($NetFOBValue,4); ?></td>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format($NetFOBValue_job,4); ?></td>
								<td width="180" align="right" style="font-weight:bold"><? echo number_format(($NetFOBValue_job/$summary_data[price_dzn_job])*100,2);?></td>
							</tr>
							<tr>
								<td width="80">4</td>
								<td width="380" align="left" style="font-weight:bold"><b>Less: Cost of Material & Services (5+6+7+8) </b></td>
								<td width="100" align="right" style="font-weight:bold"> <? echo number_format($Less_Cost_Material_Services,4); ?></td>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format($Less_Cost_Material_Services_job,4); ?></td>
								<td width="180" align="right" style="font-weight:bold"><? echo number_format(($Less_Cost_Material_Services_job/$summary_data[price_dzn_job])*100,2);?></td>
							</tr>
							<tr>
								<td width="80">5</td>
								<td width="380" align="left" style=" padding-left:100px;font-weight:bold">Fabric Purchase Cost</td>
								<td width="100" align="right" style="font-weight:bold"> <? echo number_format(array_sum($summary_data[fabric_cost]),4); ?></td>
								<td width="100" align="right" style="font-weight:bold"> <? echo number_format($summary_data[fabric_cost_job],4); ?></td>
								<td width="180" align="right" style="font-weight:bold"><? echo number_format(($summary_data[fabric_cost_job]/$summary_data[price_dzn_job])*100,2);?></td>
							</tr>
							<tr>
								<td width="80">6</td>
								<td width="380" align="left" style=" padding-left:100px;font-weight:bold" ><b>Trim Cost </b></td>
								<td width="100" align="right" style="font-weight:bold"> <? echo number_format($summary_data[trims_cost],4); ?></td>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format($summary_data[trims_cost_job],4)?></td>
								<td width="180" align="right" style="font-weight:bold"><? echo number_format(($summary_data[trims_cost_job]/$summary_data[price_dzn_job])*100,2);?></td>
							</tr>
							<tr>
								<td width="80">7</td>
								<td width="380" align="left" style=" padding-left:100px;font-weight:bold"><b>Embelishment Cost </b></td>
								<td width="100" align="right" style="font-weight:bold"> <? echo number_format($summary_data[emb_cost],4); ?></td>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format($summary_data[emb_cost_job],4); ?></td>
								<td width="180" align="right" style="font-weight:bold"><? echo number_format(($summary_data[emb_cost_job]/$summary_data[price_dzn_job])*100,2);?></td>
							</tr>
							<tr>
								<td width="80" valign="top">8</td>
								<td width="380" align="left" style=" padding-left:100px">

								<table>
									<tr>
									<td width="180" style="font-weight:bold">Other Direct Expenses</td>

									</tr>
								</table>
								<table border="1" class="rpt_table" rules="all">
									<tr>
									<td width="180" align="left">Lab Test</td>
									</tr>

									<tr>
									<td width="180" align="left">Inspection</td>

									</tr>

									<tr>
									<td width="180" align="left">Freight Cost</td>

									</tr>

									<tr>
									<td width="180" align="left">Courier Cost</td>

									</tr>

									<tr>
									<td width="180" align="left">Certificate Cost</td>

									</tr>

									<tr>
									<td width="180" align="left">Garments Wash Cost</td>

									</tr>

								</table>
								</td>
								<td width="100" align="right" valign="top">
								<table>
								<tr>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format($summary_data[OtherDirectExpenses],4); ?></td>
								</tr>
								</table>
								<table border="1" class="rpt_table" rules="all">

								<tr>

								<td width="100" align="right"><? echo number_format($summary_data[lab_test],4);?></td>
								</tr>

								<tr>

								<td width="100" align="right"><? echo number_format($summary_data[inspection],4);?></td>
								</tr>

								<tr>

								<td width="100" align="right"><? echo number_format($summary_data[freight],4);?></td>
								</tr>

								<tr>

								<td width="100" align="right"><? echo number_format($summary_data[currier_pre_cost],4);?></td>
								</tr>

								<tr>

								<td width="100" align="right"><? echo number_format($summary_data[certificate_pre_cost],4);?></td>
								</tr>

								<tr>

								<td width="100" align="right"><? echo number_format($summary_data[wash_cost],4);?></td>
								</tr>

								</table>
								</td>


								<td width="100" align="right" valign="top">
								<table>
								<tr>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format($summary_data[OtherDirectExpenses_job],4); ?></td>
								</tr>
								</table>
								<table border="1" class="rpt_table" rules="all">

								<tr>

								<td width="100" align="right"><? echo number_format($summary_data[lab_test_job],4);?></td>
								</tr>

								<tr>

								<td width="100" align="right"><? echo number_format($summary_data[inspection_job],4);?></td>
								</tr>

								<tr>

								<td width="100" align="right"><? echo number_format($summary_data[freight_job],4);?></td>
								</tr>

								<tr>

								<td width="100" align="right"><? echo number_format($summary_data[currier_pre_cost_job],4);?></td>
								</tr>

								<tr>

								<td width="100" align="right"><? echo number_format($summary_data[certificate_pre_cost_job],4);?></td>
								</tr>

								<tr>

								<td width="100" align="right"><? echo number_format($summary_data[wash_cost_job],4);?></td>
								</tr>

								</table>
								</td>
								<td width="180" align="right" valign="top">

								<table>
								<tr>
								<td width="180" align="right" style="font-weight:bold"><? echo number_format(($summary_data[OtherDirectExpenses_job]/$summary_data[price_dzn_job])*100,2);?></td>
								</tr>
								</table>
								<table border="1" class="rpt_table" rules="all">

								<tr>

								<td width="180" align="right"><? echo number_format(($summary_data[lab_test_job]/$summary_data[price_dzn_job])*100,2);?></td>
								</tr>

								<tr>

								<td width="180" align="right"><? echo number_format(($summary_data[inspection_job]/$summary_data[price_dzn_job])*100,2);?></td>
								</tr>

								<tr>

								<td width="180" align="right"><? echo number_format(($summary_data[freight_job]/$summary_data[price_dzn_job])*100,2);?></td>
								</tr>

								<tr>

								<td width="180" align="right"><? echo number_format(($summary_data[currier_pre_cost_job]/$summary_data[price_dzn_job])*100,2);?></td>
								</tr>

								<tr>

								<td width="180" align="right"><? echo number_format(($summary_data[certificate_pre_cost_job]/$summary_data[price_dzn_job])*100,2);?></td>
								</tr>

								<tr>

								<td width="180" align="right"><? echo number_format(($summary_data[wash_cost_job]/$summary_data[price_dzn_job])*100,2);?></td>
								</tr>

								</table>
								</td>
							</tr>
							<tr>
								<td width="80">9</td>
								<td width="380" align="left" style="font-weight:bold">Contributions/Value Additions (3-4)</td>
								<?

								?>
								<td width="100" align="right" style="font-weight:bold"> <? echo number_format($Contribution_Margin,4); ?></td>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format($Contribution_Margin_job,4); ?></td>
								<td width="180" align="right" style="font-weight:bold"><? echo number_format(($Contribution_Margin_job/$summary_data[price_dzn_job])*100,2);?></td>
							</tr>
							<tr>
								<td width="80">10</td>
								<td width="380" align="left" style=" padding-left:15px">Less: CM Cost </td>
								<td width="100" align="right"><? echo number_format($summary_data[cm_cost],4); ?> </td>
								<td width="100" align="right"><? echo number_format($summary_data[cm_cost_job],4); ?></td>
								<td width="180" align="right"><? echo number_format(($summary_data[cm_cost_job]/$summary_data[price_dzn_job])*100,2);?></td>
							</tr>
							<tr>
								<td width="80">11</td>
								<td width="380" align="left" style="font-weight:bold">Gross Profit (9-10)</td>

								<td width="100" align="right" style="font-weight:bold"> <? echo number_format($Gross_Profit,4); ?></td>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format($Gross_Profit_job,4); ?></td>
								<td width="180" align="right" style="font-weight:bold"><? echo number_format(($Gross_Profit_job/$summary_data[price_dzn_job])*100,2);?></td>
							</tr>

							<tr>
								<td width="80">12</td>
								<td width="380" align="left" style=" padding-left:15px">Less: Commercial Cost</td>

								<td width="100" align="right"> <? echo number_format( $summary_data[comm_cost],4); ?></td>
								<td width="100" align="right"><? echo number_format( $summary_data[comm_cost_job],4); ?></td>
								<td width="180" align="right"><? echo number_format(($summary_data[comm_cost_job]/$summary_data[price_dzn_job])*100,2);?></td>
							</tr>
							<tr>
								<td width="80">13</td>
								<td width="380" align="left" style=" padding-left:15px">Less: Operating Expensees</td>

								<td width="100" align="right"><? echo number_format( $summary_data[common_oh],4); ?> </td>
								<td width="100" align="right"><? echo number_format( $summary_data[common_oh_job],4); ?> </td>
								<td width="180" align="right"><? echo number_format(($summary_data[common_oh_job]/$summary_data[price_dzn_job])*100,2);?></td>
							</tr>

							<tr >
								<td width="80">14</td>
								<td width="380" align="left" style="font-weight:bold">Operating Profit/ Loss (11-(12+13))</td>
								<td width="100" align="right" style="font-weight:bold"> <? echo number_format($OperatingProfitLoss,4); ?></td>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format($OperatingProfitLoss_job,4); ?></td>
								<td width="180" align="right" style="font-weight:bold"><? echo number_format(($OperatingProfitLoss_job/$summary_data[price_dzn_job])*100,2);?></td>
							</tr>
							<tr>
								<td width="80">15</td>
								<td width="380" align="left" style=" padding-left:15px">Less: Depreciation & Amortization </td>

								<td width="100" align="right"> <? echo number_format( $summary_data[depr_amor_pre_cost],4); ?></td>
								<td width="100" align="right"><? echo number_format( $summary_data[depr_amor_pre_cost_job],4); ?></td>
								<td width="180" align="right"><? echo number_format(($summary_data[depr_amor_pre_cost_job]/$summary_data[price_dzn_job])*100,2);?></td>
							</tr>

							<tr>

								<td width="80">16</td>
								<td width="380" align="left" style=" padding-left:15px">Less: Interest </td>

								<td width="100" align="right"> <? echo number_format( $interest_expense,4); ?></td>
								<td width="100" align="right"><? echo number_format( $interest_expense_job,4); ?></td>
								<td width="180" align="right"><? echo number_format(($interest_expense_job/$summary_data[price_dzn_job])*100,2);?></td>
							</tr>
							<tr>
								<td width="80">17</td>
								<td width="380" align="left" style=" padding-left:15px">Less: Income Tax</td>

								<td width="100" align="right"> <? echo number_format( $income_tax,4); ?></td>
								<td width="100" align="right"><? echo number_format( $income_tax_job,4); ?></td>
								<td width="180" align="right"><? echo number_format(($income_tax_job/$summary_data[price_dzn_job])*100,2);?></td>
							</tr>
							<tr>
								<td width="80">18</td>
								<td width="380" align="left" style="font-weight:bold">Net Profit (14-(15+16+17))</td>

								<td width="100" align="right" style="font-weight:bold"><? echo number_format( $Netprofit,4); ?> </td>
								<td width="100" align="right" style="font-weight:bold"><? echo number_format( $Netprofit_job,4); ?></td>
								<td width="180" align="right" style="font-weight:bold"><? echo number_format(($Netprofit_job/$summary_data[price_dzn_job])*100,2);?></td>
							</tr>
							</table>
			</div>
		<?
		//End all summary report here -------------------------------------------
		//2	All Fabric Cost part here-------------------------------------------
			?>
			<div style="margin-top:15px">
					<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
						<label><b> Fabric Cost  </b></label>
							<tr style="font-weight:bold"  align="center">
								<td width="350">Description</td>
								<td width="80">Source</td>
								<td width="100">Nominated Supp</td>
								<td width="100">Fab. Cons/<? echo $costing_for;?></td>
								<td width="100">Total Cons</td>
								<td width="50">UOM</td>
								<td width="50">Rate (USD)</td>
								<td width="100">Amount (USD)/<? echo $costing_for;?></td>
								<td width="100">Tot.Amount (USD)</td>
							</tr>
			<?
			foreach( $FabricData as $index=>$row ) {
					$uom=$row["uom"];
					$item_descrition =$row['description'];
					$totalConsWoven=$row["totalConsWoven"];
					$totalAmountWoven=$row["totalAmountWoven"];
					$amount=$row["amount"];
					?>
					<tr>
						<td align="left"><?  echo $item_descrition;?></td>
						<td align="left"><?  echo $row["fabric_source"];?></td>
						<td align="left">
						<?  
							$nominated_supp_str="";
							$exnominated_supp=explode(",",$row['nominated_supp']);
							foreach($exnominated_supp as $supp)
							{
								if($nominated_supp_str=="") $nominated_supp_str=$supplier_name_arr[$supp]; else $nominated_supp_str.=','.$supplier_name_arr[$supp];
							}
							echo $nominated_supp_str;
							//echo $row["nominated_supp"];
						?>
							
						</td>
						<td align="right"><? echo number_format($row["avg_cons"],4);?></td>
						<td align="right"><? echo number_format($totalConsWoven,4);?></td>
						<td align="left"><?  echo $uom; ?></td>
						<td align="right"><? echo number_format($row["rate"],4);?></td>
						<td align="right"><? echo number_format($amount,4);?></td>
						<td align="right"><? echo number_format($totalAmountWoven,4);?></td>
					</tr>
					<?
					$GrandtotalConsWoven+=$totalConsWoven;
					$GrandtotalDznAmount+=$amount;
					$GrandtotalAmount+=$totalAmountWoven;
			}
			?>
				<tr class="rpt_bottom" style="font-weight:bold">
				<td colspan="4" align="left">Total</td>
				<td align="right"><? echo number_format(($GrandtotalConsWoven),4);?></td>
				<td></td>
				<td></td>
				<td align="right"><? echo number_format(($GrandtotalDznAmount),4);?></td>
				<td align="right"><? echo number_format(($GrandtotalAmount),4);?></td>
				</tr>
				</table>
				</div>
			<?
			if($zero_value==1){
				echo $woven_fab;
			}
			else{
				if($row[csf("avg_cons")]>0){
					echo $woven_fab;
				}
				else{
					echo "";
				}
			}
			//end 	All Fabric Cost part report-------------------------------------------
		//start	Trims Cost part report here -------------------------------------------
		$trim_group=return_library_array( "select item_name,id from  lib_item_group", "id", "item_name"  );
		if($zero_value==1)
		{
		?>


			<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<label><b>Trims Cost</b></label>
					<tr style="font-weight:bold">
						<td width="150">Item Group</td>
						<td width="150">Description</td>
						<td width="100">Brand/Supp Ref</td>
						<td width="150">Nominated Supp</td>
						<!-- <td width="100">Remarks</td> -->
						<td width="50">UOM</td>
						<td width="100">Cons/<? echo $costing_for;?></td>
						<td width="100">Tot. Cons</td>
						<td width="50">Rate (USD)</td>
						<td width="80">Amount (USD)</td>
						<td width="100">Tot. Amount</td>
					</tr>
				<?
				$TotalDznAmount=0;
				$TotalAmount=0;
				foreach( $TrimData as $index=>$row )
				{

				?>
					<tr>
						<td align="left"><? echo $trim_group[$row["trim_group"]]; ?></td>
						<td align="left"><? echo $row["description"]; ?></td>
						<td align="left"><? echo $row["brand_sup_ref"]; ?></td>
						<td align="left">
						<? 
							$nominated_supp_str="";
							$exnominated_supp=explode(",",$row['nominated_supp']);
							foreach($exnominated_supp as $supp)
							{
								if($nominated_supp_str=="") $nominated_supp_str=$supplier_name_arr[$supp]; else $nominated_supp_str.=','.$supplier_name_arr[$supp];
							}
							echo $nominated_supp_str;
							//echo $row["nominated_supp"]; 
						?>
							
						</td>
						<!-- <td align="left"><? echo $row["remark"]; ?></td> -->
						<td align="left"><? echo $unit_of_measurement[$row["cons_uom"]]; ?></td>
						<td align="right"><? echo number_format($row["cons_dzn_gmts"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_cons"],4); ?></td>
						<td align="right"><? echo number_format($row["rate"],4); ?></td>
						<td align="right"><? echo number_format($row["amount"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
					</tr>
				<?
					$TotalDznAmount += $row["amount"];
					$TotalAmount += $row["tot_amount"];
				}
				?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="8" align="left">Total</td>
						<td align="right"><? echo number_format($TotalDznAmount,4); ?></td>
						<td align="right"><? echo number_format($TotalAmount,4); ?></td>
					</tr>
				</table>
		</div>
		<?
		}
		else
		{
			if($totTrim>0)
			{
		?>
		<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<label><b>Trims Cost</b></label>
					<tr style="font-weight:bold">
						<td width="150">Item Group</td>
						<td width="150">Description</td>
						<td width="100">Brand/Supp Ref</td>
						<td width="150">Nominated Supp</td>
						<!-- <td width="100">Remarks</td> -->
						<td width="50">UOM</td>
						<td width="100">Cons/<? echo $costing_for;?></td>
						<td width="100">Tot. Cons</td>
						<td width="50">Rate (USD)</td>
						<td width="50">Amount (USD)</td>
						<td width="100">Tot. Amount</td>
					</tr>
				<?
				$TotalDznAmount=0;
				$TotalAmount=0;
				foreach( $TrimData as $index=>$row)
				{
					$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row["trim_group"], "id", "item_name"  );

				?>
					<tr>
						<td align="left"><? echo $trim_group[$row["trim_group"]]; ?></td>
						<td align="left"><? echo $row["description"]; ?></td>
						<td align="left"><? echo $row["brand_sup_ref"]; ?></td>
						<td align="left">
						<? 
							$nominated_supp_str="";
							$exnominated_supp=explode(",",$row['nominated_supp']);
							foreach($exnominated_supp as $supp)
							{
								if($nominated_supp_str=="") $nominated_supp_str=$supplier_name_arr[$supp]; else $nominated_supp_str.=','.$supplier_name_arr[$supp];
							}
							echo $nominated_supp_str;
							//echo $row["nominated_supp"]; 
						?>
							
						</td>
						<!--  <td align="left"><? echo $row["remark"]; ?></td> -->
						<td align="left"><? echo $unit_of_measurement[$row["cons_uom"]]; ?></td>
						<td align="right"><? echo number_format($row["cons_dzn_gmts"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_cons"],4); ?></td>
						<td align="right"><? echo number_format($row["rate"],4); ?></td>
						<td align="right"><? echo number_format($row["amount"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
					</tr>
				<?
					$TotalDznAmount += $row["amount"];
					$TotalAmount += $row["tot_amount"];
				}
				?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="8" align="left">Total</td>
						<td align="right"><? echo number_format($TotalDznAmount,4); ?></td>
						<td align="right"><? echo number_format($TotalAmount,4); ?></td>
					</tr>
				</table>
		</div>
		<?
			}
			else
			{
			echo "";
			}
		}
		/*echo '<pre>';
		print_r($TrimData); die;*/
		$nominated_supp_arr = array();
		foreach ($TrimData as $value) {
			$exnominated_supp=explode(",",$value['nominated_supp']);
			foreach($exnominated_supp as $supp)
			{
				$nominated_supp_arr[$supp][] = $value['tot_amount'];
			}
			
		}
		/*echo '<pre>';
		print_r($nominated_supp_arr); die;*/
		//End Trims Cost Part report here -------------------------------------------
		// Supplier wise amount
		?>
			<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
					<label><b>Supplier Wise Amount</b></label>
					<tr>
						<th width="150">Supplier Name</th>
						<th width="150">Total Amount(USD)</th>
					</tr>
					<?	$supplier_wise_amount = 0;
						foreach ($nominated_supp_arr as $supplier => $amount) {
							$total_amount= array_sum($amount);
							$supplier_wise_amount += $total_amount;
						?>
							<tr>
								<td><? echo $supplier_name_arr[$supplier] ?></td>
								<td><? echo number_format($total_amount,4);?></td>
							</tr>
						<? }
					?>
					<tr>
						<th>Total</th>
						<th><? echo number_format($supplier_wise_amount,4);?></th>
					</tr>
				</table>
			</div>
		<?
		// End supplier wise amount
		//start	Embellishment Details part report here -------------------------------------------
		if($zero_value==1)
		{
		?>


			<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<label><b>Embellishment Details</b></label>
					<tr style="font-weight:bold">
						<td width="150">Particulars</td>
						<td width="150">Type</td>
						<td width="150">Cons/<? echo $costing_for;?></td>
						<td width="150">Tot.Cons</td>
						<td width="100">Rate (USD)</td>
						<td width="100">Amount (USD)</td>
						<td width="100">Tot. Amount</td>
					</tr>
				<?
				$TotalDznAmount=0;
				$TotalAmount =0;
				foreach( $EmbData as $index=>$row )
				{
					$em_type ="";
					if($row["emb_name"]==1)$em_type = $emblishment_print_type[$row["emb_type"]];
					else if($row["emb_name"]==2)$em_type = $emblishment_embroy_type[$row["emb_type"]];
					else if($row["emb_name"]==3)$em_type = $emblishment_wash_type[$row["emb_type"]];
					else if($row["emb_name"]==4)$em_type = $emblishment_spwork_type[$row["emb_type"]];
					else if($row["emb_name"]==5)$em_type = $emblishment_gmts_type[$row["emb_type"]];
					else if($row["emb_name"]==99)$em_type = $emblishment_other_type_arr[$row["emb_type"]];
				?>
					<tr>
						<td align="left"><? echo $emblishment_name_array[$row["emb_name"]]; ?></td>
						<td align="left"><? echo $em_type; ?></td>
						<td align="right"><? echo number_format($row["cons_dzn_gmts"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_cons"],4); ?></td>
						<td align="right"><? echo number_format($row["rate"],4); ?></td>
						<td align="right"><? echo number_format($row["amount"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
					</tr>
				<?
					$TotalDznAmount += $row["amount"];
					$TotalAmount += $row["tot_amount"];
				}
				?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="5" align="left">Total</td>
						<td align="right"><? echo number_format($TotalDznAmount,4); ?></td>
						<td align="right"><? echo number_format($TotalAmount,4); ?></td>
					</tr>
				</table>
		</div>
		<?
		}
		else
		{
			if($totEmb>0)
			{
		?>
		<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<label><b>Embellishment Details</b></label>
					<tr style="font-weight:bold">
						<td width="150">Particulars</td>
						<td width="150">Type</td>
						<td width="150">Cons/<? echo $costing_for;?></td>
						<td width="150">Tot.Cons</td>
						<td width="100">Rate (USD)</td>
						<td width="100">Amount (USD)</td>
						<td width="100">Tot. Amount</td>
					</tr>
				<?
			$TotalDznAmount=0;
			$TotalAmount =0;
				foreach( $EmbData as $index=>$row  )
				{
					$em_type ="";
					if($row["emb_name"]==1)$em_type = $emblishment_print_type[$row["emb_type"]];
					else if($row["emb_name"]==2)$em_type = $emblishment_embroy_type[$row["emb_type"]];
					else if($row["emb_name"]==3)$em_type = $emblishment_wash_type[$row["emb_type"]];
					else if($row["emb_name"]==4)$em_type = $emblishment_spwork_type[$row["emb_type"]];
					else if($row["emb_name"]==5)$em_type = $emblishment_gmts_type[$row["emb_type"]];
					else if($row["emb_name"]==99)$em_type = $emblishment_other_type_arr[$row["emb_type"]];



				?>
					<tr>
						<td align="left"><? echo $emblishment_name_array[$row["emb_name"]]; ?></td>
						<td align="left"><? echo $em_type; ?></td>
						<td align="right"><? echo number_format($row["cons_dzn_gmts"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_cons"],4); ?></td>
						<td align="right"><? echo number_format($row["rate"],4); ?></td>
						<td align="right"><? echo number_format($row["amount"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
					</tr>
				<?
					$TotalDznAmount += $row["amount"];
					$TotalAmount += $row["tot_amount"];
				}
				?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="5" align="left">Total</td>
						<td align="right"><? echo number_format($TotalDznAmount,4); ?></td>
						<td align="right"><? echo number_format($TotalAmount,4); ?></td>
					</tr>
				</table>
		</div>
		<?

			}
			else
			{
				echo "";
			}
		}
		//End Embellishment Details Part report here -------------------------------------------


		//start	Commercial Cost part report here -------------------------------------------
		if($zero_value==1)
		{
		?>

			<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<label><b>Commercial Cost</b></label>
					<tr style="font-weight:bold">
						<td width="150">Particulars</td>
						<td width="100">Rate In %</td>
						<td width="100">Amount (USD)</td>
						<td width="100">Tot.Amount</td>
					</tr>
				<?
			$TotalDznAount=0;
			$TotalAount =0;
				foreach( $CommarData as $index=>$row )
				{
				?>
					<tr>
						<td align="left"><? echo $camarcial_items[$row["item_id"]]; ?></td>
						<td align="right"><? echo number_format($row["rate"],4); ?></td>
						<td align="right"><? echo number_format($row["amount"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
					</tr>
				<?
					$TotalDznAount += $row["amount"];
					$TotalAount += $row["tot_amount"];
				}
				?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Total</td>
						<td align="right"><? echo number_format($TotalDznAount,4); ?></td>
						<td align="right"><? echo number_format($TotalAount,4); ?></td>
					</tr>
				</table>
		</div>
		<?
		}
		else
		{
			if($totCommar>0)
			{
			?>
			<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<label><b>Commercial Cost</b></label>
					<tr style="font-weight:bold">
						<td width="150">Particulars</td>
						<td width="100">Rate (USD)</td>
						<td width="100">Amount (USD)</td>
						<td width="100">Tot.Amount</td>
					</tr>
				<?
			$TotalDznAount=0;
			$TotalAount =0;
				foreach( $CommarData as $index=>$row  )
				{
				?>
					<tr>
						<td align="left"><? echo $camarcial_items[$row["item_id"]]; ?></td>
						<td align="right"><? echo number_format($row["rate"],4); ?></td>
						<td align="right"><? echo number_format($row["amount"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
					</tr>
				<?
					$TotalDznAount += $row["amount"];
					$TotalAount += $row["tot_amount"];
				}
				?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Total</td>
						<td align="right"><? echo number_format($TotalDznAount,4); ?></td>
						<td align="right"><? echo number_format($TotalAount,4); ?></td>
					</tr>
				</table>
		</div>
			<?
			}
			else
			{
				echo "";
			}

		}
		//End Commercial Cost Part report here -------------------------------------------


		//start	Commission Cost part report here -------------------------------------------

		if($zero_value==1)
		{
		?>


			<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<label><b>Commission Cost</b></label>
					<tr style="font-weight:bold">
						<td width="150">Particulars</td>
						<td width="150">Commission Basis</td>
						<td width="100">Rate (USD)</td>
						<td width="100">Amount (USD)</td>
						<td width="100">Tot. Amount</td>
					</tr>
				<?
				$TotalDznAount = 0;
				$TotalAount = 0;
				foreach( $CommiData as $index=>$row )
				{
				?>
					<tr>
						<td align="left"><? echo $commission_particulars[$row["particulars_id"]]; ?></td>
						<td align="left"><? echo $commission_base_array[$row["commission_base_id"]]; ?></td>
						<td align="right"><? echo number_format($row["commision_rate"],4); ?></td>
						<td align="right"><? echo number_format($row["commission_amount"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_commission_amount"],4); ?></td>
					</tr>
				<?
					$TotalDznAount += $row["commission_amount"];
					$TotalAount += $row["tot_commission_amount"];
				}
				?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="3" align="left">Total</td>
						<td align="right"><? echo number_format($TotalDznAount,4); ?></td>
						<td align="right"><? echo number_format($TotalAount,4); ?></td>
					</tr>
				</table>
		</div>
		<?
		}
		else
		{
			if($totCommi>0)
			{
				$TotalDznAount = 0;
				$TotalAount = 0;
			?>
			<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
				<label><b>Commission Cost</b></label>
					<tr style="font-weight:bold">
						<td width="150">Particulars</td>
						<td width="150">Commission Basis</td>
						<td width="100">Rate (USD)</td>
						<td width="100">Amount (USD)</td>
						<td width="100">Tot. Amount</td>
					</tr>
				<?
				$total_amount=0;
				foreach( $CommiData as $index=>$row )
				{
				?>
					<tr>
					<td align="left"><? echo $commission_particulars[$row["particulars_id"]]; ?></td>
						<td align="left"><? echo $commission_base_array[$row["commission_base_id"]]; ?></td>
						<td align="right"><? echo number_format($row["commision_rate"],4); ?></td>
						<td align="right"><? echo number_format($row["commission_amount"],4); ?></td>
						<td align="right"><? echo number_format($row["tot_commission_amount"],4); ?></td>
					</tr>
				<?
					$TotalDznAount += $row["commission_amount"];
					$TotalAount += $row["tot_commission_amount"];
				}
				?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="3" align="left">Total</td>
						<td align="right"><? echo number_format($TotalDznAount,4); ?></td>
						<td align="right"><? echo number_format($TotalAount,4); ?></td>
					</tr>
				</table>
		</div>
			<?
			}
			else
			{
			echo "";
			}

		}
		//End Commission Cost Part report here -------------------------------------------
		echo signature_table(109, $cbo_company_name, "860px");
		?>
		</div>
		<?
		exit();

}

if($action=="bomRptWoven")//Bom Woven btn 8
{

	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and c.costing_date='".$txt_costing_date."'";
	if(str_replace("'",'',$txt_po_breack_down_id)=="")
	{
		$txt_po_breack_down_id_cond='';
		$txt_po_breack_down_id_cond1='';
		$txt_po_breack_down_id_cond2='';
		$txt_po_breack_down_id_cond3='';
	}
	else
	{
		$poIDs=str_replace("'",'',$txt_po_breack_down_id);
		$txt_po_breack_down_id_cond=" and b.id in(".$poIDs.")";
		$txt_po_breack_down_id_cond1=" and id in(".$poIDs.")";
		$txt_po_breack_down_id_cond2=" and po_break_down_id in(".$poIDs.")";
		$txt_po_breack_down_id_cond3=" and b.id in(".$poIDs.")";
	}

	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$supplier_name_arr=return_library_array( "select id, supplier_name from  lib_supplier",'id','supplier_name');
	$color_library=return_library_array("select id,color_name from lib_color where status_active=1 and is_deleted=0","id","color_name");

	$poNumber=array();
	$pubShipDate=array();
	$po_qty=0;
	$po_plun_cut_qty=0;
	$total_set_qnty=0;
	$avg_unit_price=0;
	 $sql_po="select a.job_no,a.total_set_qnty,a.avg_unit_price,b.id,b.po_number,b.pub_shipment_date,c.item_number_id,c.country_id,c.color_number_id,c.size_number_id,c.order_quantity,c.order_total,c.plan_cut_qnty,b.id  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.id=b.job_id and a.id=c.job_id and b.id=c.po_break_down_id  and a.job_no =".$txt_job_no." $txt_po_breack_down_id_cond and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 order by b.id";
	 $order_values=$order_qty=0;
	$sql_po_data=sql_select($sql_po);
	foreach($sql_po_data as $sql_po_row){
		$po_qty+=$sql_po_row[csf('order_quantity')];
		$order_values+=$sql_po_row[csf('order_total')];
		$order_qty+=$sql_po_row[csf('order_quantity')];
		$po_plun_cut_qty+=$sql_po_row[csf('plan_cut_qnty')];
		$total_set_qnty=$sql_po_row[csf('total_set_qnty')];
		$poNumber[$sql_po_row[csf('po_number')]]=$sql_po_row[csf('po_number')];
		$pubShipDate[$sql_po_row[csf('po_number')]]=change_date_format($sql_po_row[csf('pub_shipment_date')],"dd-mm-yyyy","-");
		$avg_unit_price=$sql_po_row[csf('avg_unit_price')];
		$po_id_arr[$sql_po_row[csf('id')]]=$sql_po_row[csf('id')];
	}

	$poQtyUom=$po_qty/$total_set_qnty;
	$poPlunCutQtyUom=$po_plun_cut_qty/$total_set_qnty;
	$excessQty=$poPlunCutQtyUom-$poQtyUom;
	$excessPer=(100*$excessQty)/$poQtyUom;

	$gmtsItem=array();
	$gmtsitem_ratio_array=array();
	$gmtsitem_ratio_sql=sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no =".$txt_job_no."");
	foreach($gmtsitem_ratio_sql as $gmtsitem_ratio_sql_row){
		$gmtsitem_ratio_array[$gmtsitem_ratio_sql_row[csf('job_no')]][$gmtsitem_ratio_sql_row[csf('gmts_item_id')]]=$gmtsitem_ratio_sql_row[csf('set_item_ratio')];
		$gmtsItem[$gmtsitem_ratio_sql_row[csf('gmts_item_id')]]=$garments_item[$gmtsitem_ratio_sql_row[csf("gmts_item_id")]];
	}

	$financial_para=array();
	$sql_std_para=sql_select("select interest_expense,income_tax,cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and status_active=1 and	is_deleted=0 order by id");
	foreach($sql_std_para as $sql_std_row){
		$financial_para[interest_expense]=$sql_std_row[csf('interest_expense')];
		$financial_para[income_tax]=$sql_std_row[csf('income_tax')];
		$financial_para[cost_per_minute]=$sql_std_row[csf('cost_per_minute')];
	}

	$po_id_str= implode( ",",$po_id_arr);
	
	$sales_contract_sql=sql_select("SELECT a.contract_no,b.wo_po_break_down_id from com_sales_contract a join com_sales_contract_order_info b on a.id=b.com_sales_contract_id where a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.wo_po_break_down_id in ($po_id_str) group by a.contract_no, b.wo_po_break_down_id");
	$sales_contract_arr=array();
	if(count($sales_contract_sql)>0)
	{
		foreach ($sales_contract_sql as $key => $row) {
			$sales_contract_arr[$row[csf('wo_po_break_down_id')]].=$row[csf('contract_no')].',';
		}
	}

	$export_lc_sql=sql_select("SELECT a.export_lc_no,b.wo_po_break_down_id from com_export_lc a join com_export_lc_order_info b on a.id=b.com_export_lc_id where a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.wo_po_break_down_id in ($po_id_str) group by a.export_lc_no,b.wo_po_break_down_id");
	$export_lc_arr=array();
	if(count($export_lc_sql)>0)
	{
		foreach ($export_lc_sql as $key => $row) {
			$export_lc_arr[$row[csf('wo_po_break_down_id')]]=$row[csf('export_lc_no')];
		}
	}
	$sc_no="";$lc_no="";
	if(count($sales_contract_arr)>0)

	{
		//$sc_lc_no=implode(",", $sales_contract_arr);
		//$sc_lc_no=implode(",",array_unique(explode(",",$sales_contract_arr)));
		$sc_no=implode(",",array_filter(array_unique(explode(",",$sales_contract_arr[$row[csf('wo_po_break_down_id')]]))));
	}
	 if(count($export_lc_arr)>0)
	{
		$lc_no=implode(",", $export_lc_arr);
	} 
	/* $sc_lc_no="";
	if(count($sales_contract_arr)>0)
	{
		$sc_lc_no=implode(",", $sales_contract_arr);
		//$sc_lc_no=implode(",",array_unique(explode(",",$sales_contract_arr)));
	}
	if(count($export_lc_arr)>0)
	{
		//$sc_lc_no=implode(",", $export_lc_arr);
		$lc_no=implode(",",array_unique(explode(",",$export_lc_arr)));
	} */
	

	$sql = "select a.job_no, a.company_name, a.buyer_name, a.style_ref_no, a.gmts_item_id, a.order_uom, a.job_quantity, a.avg_unit_price, b.costing_per, b.budget_minute, b.sew_smv, b.cut_smv,b.sew_effi_percent,b.cut_effi_percent,b.approved,b.id from wo_po_details_master a, wo_pre_cost_mst b where a.job_no=b.job_no  and a.status_active=1 $job_no $company_name $cbo_buyer_name $txt_style_ref order by a.job_no";
	$data_array=sql_select($sql);
	$uom="";
	$jobNo="";
	$buyerName="";
	$styleRefNo="";
	$costingPer="";
	$pre_cost_id="";

	foreach ($data_array as $row){
		$uom=$row[csf("order_uom")];
		$jobNo=$row[csf("job_no")];
		$buyerName=$buyer_arr[$row[csf("buyer_name")]];
		$styleRefNo=$row[csf("style_ref_no")];
		$costingPer=$row[csf("costing_per")];
		$pre_cost_id=$row[csf("id")];

		$order_price_per_dzn=0;
		if($costingPer==1){
			$order_price_per_dzn=12;
			$costing_for=" DZN";
		}
		else if($costingPer==2){
			$order_price_per_dzn=1;
			$costing_for=" PCS";
		}
		else if($costingPer==3){
			$order_price_per_dzn=24;
			$costing_for=" 2 DZN";
		}
		else if($costingPer==4){
			$order_price_per_dzn=36;
			$costing_for=" 3 DZN";
		}
		else if($costingPer==5){
			$order_price_per_dzn=48;
			$costing_for=" 4 DZN";
		}
	}
	//start	all summary report here -------------------------------------------
	$po_id=str_replace("'","",$txt_po_breack_down_id);
	$condition= new condition();
	if(str_replace("'","",$txt_job_no) !=''){
		$condition->job_no("=$txt_job_no");
	}
	if(str_replace("'",'',$txt_po_breack_down_id) !=""){
		$condition->po_id("in($po_id)");
	}
	$condition->init();
	$fabric= new fabric($condition);
	//echo $fabric->getQuery();die;
	$conversion= new conversion($condition);
	$trim= new trims($condition);
	$emblishment= new emblishment($condition);
	$wash= new wash($condition);
	$other= new other($condition);
	$other_cost=$other->getAmountArray_by_job();
	$commercial= new commercial($condition);
	$commision= new commision($condition);


	 $sql_new = "select job_no,fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,wash_cost,wash_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,currier_pre_cost,currier_percent,certificate_pre_cost,certificate_percent,common_oh,common_oh_percent,depr_amor_pre_cost,total_cost , total_cost_percent, price_dzn, price_dzn_percent, margin_dzn,margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche from wo_pre_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array_new=sql_select($sql_new);
	$summary_data=array();
$others_cost_value=0;
	foreach( $data_array_new as $row_new ){
		$summary_data[price_dzn]=$row_new[csf("price_dzn")];
		$summary_data[price_dzn_job]=($po_qty/($total_set_qnty*$order_price_per_dzn))*$row_new[csf("price_dzn")];
		$summary_data[price_dzn_job_per]=($summary_data[price_dzn_job]/$summary_data[price_dzn_job])*100;

		$summary_data[commission]=$row_new[csf("commission")];
		$summary_data[trims_cost]=$row_new[csf("trims_cost")];
		$summary_data[emb_cost]=$row_new[csf("embel_cost")];

		$summary_data[lab_test]=$row_new[csf("lab_test")];
		$summary_data[lab_test_job]=$other_cost[$row_new[csf("job_no")]]['lab_test'];

		$summary_data[inspection]=$row_new[csf("inspection")];
		$summary_data[inspection_job]=$other_cost[$row_new[csf("job_no")]]['inspection'];

		$summary_data[freight]=$row_new[csf("freight")];
		$summary_data[freight_job]=$other_cost[$row_new[csf("job_no")]]['freight'];

		$summary_data[currier_pre_cost]=$row_new[csf("currier_pre_cost")];
		$summary_data[currier_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['currier_pre_cost'];

		$summary_data[certificate_pre_cost]=$row_new[csf("certificate_pre_cost")];
		$summary_data[certificate_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['certificate_pre_cost'];
		$summary_data[wash_cost]=$row_new[csf("wash_cost")];

		$summary_data[OtherDirectExpenses]=$row_new[csf("lab_test")]+$row_new[csf("inspection")]+$row_new[csf("freight")]+$row_new[csf("currier_pre_cost")]+$row_new[csf("certificate_pre_cost")]+$row_new[csf("wash_cost")];

		$summary_data[OtherDirectExpenses_job]=$summary_data[lab_test_job]+$summary_data[inspection_job]+$summary_data[freight_job]+$summary_data[currier_pre_cost_job]+$summary_data[certificate_pre_cost_job];

		$summary_data[cm_cost]=$row_new[csf("cm_cost")];
		$summary_data[cm_cost_job]=$other_cost[$row_new[csf("job_no")]]['cm_cost'];

		$summary_data[comm_cost]=$row_new[csf("comm_cost")];

		$summary_data[common_oh]=$row_new[csf("common_oh")];
		$summary_data[common_oh_job]=$other_cost[$row_new[csf("job_no")]]['common_oh'];
		$summary_data[depr_amor_pre_cost]=$row_new[csf("depr_amor_pre_cost")];
		$summary_data[depr_amor_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['depr_amor_pre_cost'];
		
		//$others_cost_value=$row_new[csf("total_cost")]-$row_new[csf("cm_cost")]-$row_new[csf("freight")]-$row_new[csf("comm_cost")]-$row_new[csf("commission")];
		$cm_cost_dzn=$row_new[csf("cm_cost")];
	}

	//Fabric =====================
	$fabric_qty=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$fabric_amount=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	 $sql_fabric = "SELECT id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description,uom, avg_cons,avg_cons_yarn, fabric_source,gsm_weight, rate, amount, avg_finish_cons, status_active,nominated_supp_multi  from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no."";

	$data_arr_fabric=sql_select($sql_fabric);
	$totFabQty=0;
	$totFabAmt=0;
	$FabricData=array();
	foreach($data_arr_fabric as $fab_row){
		$summary_data[fabric_cost][$fab_row[csf("id")]]=$fab_row[csf("amount")];
		if($fab_row[csf("fab_nature_id")] == 3)
		{
			$summary_data[fabric_cost_job]+=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		}
		if($fab_row[csf("fab_nature_id")] == 2)
		{
			$summary_data[fabric_cost_job]+=$fabric_amount['knit']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		}
		$totFabQty+=$fabric_qty['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		$totFabAmt+=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];

		$FabricData[$fab_row[csf("id")]]['description']=$body_part[$fab_row[csf("body_part_id")]].", ".$color_type[$fab_row[csf("color_type_id")]].", ".$fab_row[csf("fabric_description")].", ".$fab_row[csf("gsm_weight")];
		$FabricData[$fab_row[csf("id")]]['fabric_source']=$fabric_source[$fab_row[csf("fabric_source")]];
		$FabricData[$fab_row[csf("id")]]['nominated_supp']=$fab_row[csf("nominated_supp_multi")];
		$FabricData[$fab_row[csf("id")]]['avg_cons']=$fab_row[csf("avg_cons")];
		if($fab_row[csf("fab_nature_id")] == 3){
			$FabricData[$fab_row[csf("id")]]['totalConsWoven']=$fabric_qty['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
			$FabricData[$fab_row[csf("id")]]['totalAmountWoven']=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		}
		if($fab_row[csf("fab_nature_id")] == 2){
			$FabricData[$fab_row[csf("id")]]['totalConsWoven']=$fabric_qty['knit']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
			$FabricData[$fab_row[csf("id")]]['totalAmountWoven']=$fabric_amount['knit']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		}
		//$FabricData[$fab_row[csf("id")]]['totalConsWoven']=$fabric_qty['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		$FabricData[$fab_row[csf("id")]]['uom']=$unit_of_measurement[$fab_row[csf("uom")]];
		$FabricData[$fab_row[csf("id")]]['rate']=$fab_row[csf("rate")];
		$FabricData[$fab_row[csf("id")]]['amount']=$fab_row[csf("rate")]*$fab_row[csf("avg_cons")];
		//$FabricData[$fab_row[csf("id")]]['totalAmountWoven']=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		
		//$tot_fabric_cost+=$fabric_amount['knit']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
	}
	$totFabQtyAsCostPer=($totFabQty/$poPlunCutQtyUom)*$order_price_per_dzn;
	//Fabric End======================
	//start	Trims Cost part report here -------------------------------------------
	$sql_trim = "select id, job_no, trim_group,description,brand_sup_ref,remark, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp_multi,status_active,seq
	from wo_pre_cost_trim_cost_dtls
	where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 order by seq";
	$data_array_trim=sql_select($sql_trim);
	$trim_amount_arr=$trim->getAmountArray_by_jobAndPrecostdtlsid();
	$trim_qty_arr=$trim->getQtyArray_by_jobAndPrecostdtlsid();
	//$trim_amount_arr=$trim->getAmountArray_by_jobAndPrecostdtlsid_consAndTotcons();
	//$trim_qty_arr=$trim->getQtyArray_by_jobAndPrecostdtlsid_consAndTotcons();
	$totTrim=0;
	$TrimData=array();
	foreach( $data_array_trim as $row_trim ){
	    $trim_qty=$trim_qty_arr[$row_trim[csf("job_no")]][$row_trim[csf("id")]];
		$trim_amount=$trim_amount_arr[$row_trim[csf("job_no")]][$row_trim[csf("id")]];
		$summary_data[trims_cost_job]+=$trim_amount;

		$TrimData[$row_trim[csf('id')]]['trim_group']=$row_trim[csf('trim_group')];
		$TrimData[$row_trim[csf('id')]]['description']=$row_trim[csf('description')];
		$TrimData[$row_trim[csf('id')]]['brand_sup_ref']=$row_trim[csf('brand_sup_ref')];
		$TrimData[$row_trim[csf('id')]]['remark']=$row_trim[csf('remark')];
		$TrimData[$row_trim[csf('id')]]['cons_uom']=$row_trim[csf('cons_uom')];
		$TrimData[$row_trim[csf('id')]]['cons_dzn_gmts']=$row_trim[csf('cons_dzn_gmts')];
		$TrimData[$row_trim[csf('id')]]['rate']=$row_trim[csf('rate')];
		$TrimData[$row_trim[csf('id')]]['amount']=$row_trim[csf('amount')];
		$TrimData[$row_trim[csf('id')]]['apvl_req']=$row_trim[csf('apvl_req')];
		$TrimData[$row_trim[csf('id')]]['nominated_supp']=$row_trim[csf('nominated_supp_multi')];
		$TrimData[$row_trim[csf('id')]]['tot_cons']=$trim_qty;
		$TrimData[$row_trim[csf('id')]]['tot_amount']=$trim_amount;
		$totTrim+=$row_trim[csf('cons_dzn_gmts')];
	}
	//End	Trims Cost part report here -------------------------------------------
	//Emb cost Cost part report here -------------------------------------------

	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name in(1,2,4,5)";
	$data_array=sql_select($sql);
	$emblishment_qty=$emblishment->getQtyArray_by_jobAndEmblishmentid();
	$emblishment_amount=$emblishment->getAmountArray_by_jobAndEmblishmentid();


	$totEmb=0;
	$EmbData=array();

	foreach( $data_array as $row ){
	$embqty=$emblishment_qty[$row[csf("job_no")]][$row[csf("id")]];
	$embamount=$emblishment_amount[$row[csf("job_no")]][$row[csf("id")]];
	$summary_data[emb_cost_job]+=$embamount;
	$EmbData[$row[csf("id")]]['emb_name']=$row[csf("emb_name")];
	$EmbData[$row[csf("id")]]['emb_type']=$row[csf("emb_type")];
	$EmbData[$row[csf("id")]]['cons_dzn_gmts']=$row[csf("cons_dzn_gmts")];
	$EmbData[$row[csf("id")]]['rate']=$row[csf("rate")];
	$EmbData[$row[csf("id")]]['amount']=$row[csf("amount")];
	$EmbData[$row[csf("id")]]['tot_cons']=$embqty;
	$EmbData[$row[csf("id")]]['tot_amount']=$embamount;
	$totEmb+=$row[csf("cons_dzn_gmts")];
	}
	//End Emb cost Cost part report here -------------------------------------------
	//Wash cost Cost part report here -------------------------------------------
	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name =3";
	$data_array=sql_select($sql);
	$wash_qty=$wash->getQtyArray_by_jobAndEmblishmentid();
	$wash_amount=$wash->getAmountArray_by_jobAndEmblishmentid();
	foreach( $data_array as $row ){
	$washqty=$wash_qty[$row[csf("job_no")]][$row[csf("id")]];
	$washamount=$wash_amount[$row[csf("job_no")]][$row[csf("id")]];
	$summary_data[wash_cost_job]+=$washamount;
	$summary_data[OtherDirectExpenses_job]+=$washamount;
	$EmbData[$row[csf("id")]]['emb_name']=$row[csf("emb_name")];
	$EmbData[$row[csf("id")]]['emb_type']=$row[csf("emb_type")];
	$EmbData[$row[csf("id")]]['cons_dzn_gmts']=$row[csf("cons_dzn_gmts")];
	$EmbData[$row[csf("id")]]['rate']=$row[csf("rate")];
	$EmbData[$row[csf("id")]]['amount']=$row[csf("amount")];
	$EmbData[$row[csf("id")]]['tot_cons']=$washqty;
	$EmbData[$row[csf("id")]]['tot_amount']=$washamount;
	$totEmb+=$row[csf("cons_dzn_gmts")];
	}
	//End Wash cost Cost part report here -------------------------------------------

	//Commision cost Cost part report here -------------------------------------------
	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls  where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	$commision_amount=$commision->getAmountArray_by_jobAndPrecostdtlsid();
	$totCommi=0;
	$CommiData=array();
	foreach( $data_array as $row ){
	$CommiData[$row[csf("id")]]['particulars_id']=$row[csf("particulars_id")];
	$CommiData[$row[csf("id")]]['commission_base_id']=$row[csf("commission_base_id")];
	$CommiData[$row[csf("id")]]['commision_rate']=$row[csf("commision_rate")];
	$CommiData[$row[csf("id")]]['commission_amount']=$row[csf("commission_amount")];
	$CommiData[$row[csf("id")]]['tot_commission_amount']=$commision_amount[$row[csf("job_no")]][$row[csf("id")]];
	$totCommi+=$row[csf("commission_amount")];
	$summary_data[commission_job]+=$commision_amount[$row[csf("job_no")]][$row[csf("id")]];
	$commission_costing_arr[$row[csf("job_no")]]+=$commision_amount[$row[csf("job_no")]][$row[csf("id")]];
	}
	$summary_data[commission_job_per]=($summary_data[commission_job]/$summary_data[price_dzn_job])*100;
	//End Commision cost Cost part report here -------------------------------------------

	//Commarcial cost Cost part report here -------------------------------------------
	$sql = "select id, job_no, item_id, rate, amount, status_active from  wo_pre_cost_comarci_cost_dtls  where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	$commarcial_amount=$commercial->getAmountArray_by_jobAndPrecostdtlsid();

	$totCommar=0;
	$CommarData=array();
	foreach( $data_array as $row ){
	$commarcialamount=$commarcial_amount[$row[csf("job_no")]][$row[csf("id")]];
	$summary_data[comm_cost_job]+=$commarcialamount;
	$CommarData[$row[csf("id")]]['item_id']=$row[csf("item_id")];
	$CommarData[$row[csf("id")]]['rate']=$row[csf("rate")];
	$CommarData[$row[csf("id")]]['amount']=$row[csf("amount")];
	$CommarData[$row[csf("id")]]['tot_amount']=$commarcialamount;
	$totCommar+=$row[csf("amount")];
	$commercial_costing_arr[$row[csf("job_no")]]+=$commarcial_amount[$row[csf("job_no")]][$row[csf("id")]];
	}
	?>        
    <table style="width:850px" ><tr><td colspan="6" align="center">
		   <?
            $image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id=$cbo_company_name","image_location");
            ?>
            <img  src='../../<? echo $image_location; ?>' height='70' align="left" />
            <b style="font-size:25px;"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></b><br>
            <b style="font-size:14px;">BOM Report</b>
        </td></tr></table>

        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
        <tr>
            <td width="80">Job Number</td>
            <td width="80"><b><? echo $jobNo; ?></b></td>
            <td width="90">Buyer</td>
            <td width="100"><b><? echo $buyerName; ?></b></td>
            <td width="80">Garments Item</td>
            <td width="100"><b><? echo implode(",",$gmtsItem); ?></b></td>
        </tr>

        <tr>
            <td>Order Qnty </td>
            <td colspan=""><b><? echo $poQtyUom; ?></b></td>
            <td>Excess Cut %</td>
            <td><b><?  echo number_format($excessPer,2) ?></b></td>
            <td>Plan Cut Qty</td>
            <td><b><? echo $poPlunCutQtyUom." ". $unit_of_measurement[$uom];?></b></td>
        </tr>

        <tr>
            <td>Style Ref. No </td>
            <td colspan=""><b><? echo $styleRefNo; ?></b></td>
            <td>Costing Per</td>
            <td><b><? echo $costing_per[$costingPer];?></b></td>
            <td>Price Per Unit</td>
            <td><b><? echo number_format($avg_unit_price,4); ?></b></td>
        </tr>

        <tr>
            <td>Order Numbers</td>
            <td colspan="5"><? echo implode(", ",$poNumber); ?></td>
        </tr>

        <tr>
            <td>Shipment Date </td>
            <td colspan="3"><b>  <? echo implode(", ",$pubShipDate); ?></b></td>
             <td>Fabric Cons</td>
            <td><b><? echo number_format($totFabQtyAsCostPer,2); ?></b></td>
        </tr>
		<tr>   
			<td>SC No</td>
			<td colspan="2"><b><? 
			
				echo $sc_no;
				?> </b></td>
			<td>LC No</td>
			<td colspan="2"><b><? 
			
				echo $lc_no;
			
			
			 ?> </b></td>
        </tr>
    </table>
       <?
    $approved_sql=sql_select("SELECT  mst_id, approved_by ,approved_date  from approval_history where entry_form=46 AND  mst_id =$pre_cost_id and un_approved_date is null ");
    $user_lib_name=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");
    $user_lib_desg=return_library_array("SELECT id,designation from user_passwd", "id", "designation");
    $designation_lib=return_library_array("SELECT id,custom_designation from lib_designation", "id", "custom_designation");
    $supplier_name_arr=return_library_array( "select id, supplier_name from  lib_supplier",'id','supplier_name');
    
	
	if(count($approved_sql) > 0){ $sl=1; ?>
        <div style="margin-top:15px">
                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <label><b>Pre-Cost Approval Status </b></label>
                    <tr style="font-weight:bold">
                        <th width="20">SL</th>
                        <th width="250">Name</th>
                        <th width="200">Designation</th>
                        <th width="100">Approval Date</th>
                    </tr>
                    <? foreach ($approved_sql as $key => $value) { ?>
                        <tr>
                        <td width="20"><? echo $sl; ?></td>
                        <td width="250"><? echo $user_lib_name[$value[csf("approved_by")]]; ?></td>
                        <td width="200"><? echo $designation_lib[$user_lib_desg[$value[csf("approved_by")]]]; ?></td>
                        <td width="100"><? echo change_date_format($value[csf("approved_date")]); ?></td>
                    </tr>
                    <? $sl++; }  ?>

                </table>
        </div>
    <? } ?>
	<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
					<label><b> Fabric Cost  </b></label>
						<tr style="font-weight:bold"  align="center">
							<td width="350">Description</td>
							<td width="100">Source</td>
							<td width="100">Nominated Supp</td>
							<td width="100">Fab. Cons/<? echo $costing_for ?></td>
							<td width="100">Total Cons</td>
							<td width="50">UOM</td>
							<td width="50">Rate (USD)</td>
							<td width="100">Amount (USD)/<? echo $costing_for ?></td>
							<td width="100">Tot.Amount (USD)</td>
						</tr>
        <?
        /*echo '<pre>';
        print_r($FabricData); die;*/
		foreach( $FabricData as $index=>$row ) {
			    $uom=$row["uom"];
			    $item_descrition =$row['description'];
			    $totalConsWoven=$row["totalConsWoven"];
				$totalAmountWoven=$row["totalAmountWoven"];
				$amount=$row["amount"];
				?>
                <tr>
                    <td align="left"><?  echo $item_descrition;?></td>
                    <td align="left"><?  echo $row["fabric_source"];?></td>
                    <td align="left">
                    <?  
                    	 $exnominated_supp=explode(",",$row['nominated_supp']);
                    	 $nominated_supp_str='';
						 foreach($exnominated_supp as $supp)
						 {
							if($nominated_supp_str=="") $nominated_supp_str=$supplier_name_arr[$supp]; else $nominated_supp_str.=','.$supplier_name_arr[$supp];
						 }
						 echo $nominated_supp_str;
                    	//echo $row["nominated_supp"];
                    ?>
                    	
                    </td>
                    <td align="right"><? echo number_format($row["avg_cons"],4);?></td>
					<td align="right"><? echo number_format($totalConsWoven,4);?></td>
					<td align="left"><?  echo $uom; ?></td>
                    <td align="right"><? echo number_format($row["rate"],4);?></td>
                    <td align="right"><? echo number_format($amount,4);?></td>
					<td align="right"><? echo number_format($totalAmountWoven,4);?></td>
                </tr>
                <?
				 $GrandtotalConsWoven+=$totalConsWoven;
				 $GrandtotalDznAmount+=$amount;
				 $GrandtotalAmount+=$totalAmountWoven;
        }
		?>
            <tr class="rpt_bottom" style="font-weight:bold">
            <td colspan="4" align="left">Total</td>
            <td align="right"><? echo number_format(($GrandtotalConsWoven),4);?></td>
            <td></td>
            <td></td>
            <td align="right"><? echo number_format(($GrandtotalDznAmount),4);?></td>
            <td align="right"><? echo number_format(($GrandtotalAmount),4);?></td>
            </tr>
            </table>
            </div>
		<?
		if($zero_value==1){
			echo $woven_fab;
		}
		else{
			if($row[csf("avg_cons")]>0){
				echo $woven_fab;
			}
			else{
				echo "";
			}
		}

		//Conversion
	$totConv=0;
	$ConvData=array();
	$conv_data=array();
	$conv_amount_arr=$conversion->getAmountArray_by_conversionid();
	$conv_qty_arr=$conversion->getQtyArray_by_conversionid();
	$sql_conv = "select a.id as con_id, a.fabric_description as fabric_description_id, a.job_no, a.cons_process, a.req_qnty,a.avg_req_qnty, a.charge_unit, a.amount, a.status_active,b.body_part_id,b.fab_nature_id,b.color_type_id,b.fabric_description,b.uom  from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id and b.status_active=1 and b.is_deleted=0 where a.job_no=".$txt_job_no."  and a.id>0 and a.is_deleted =0 and a.status_active=1 ";
	$data_arr_conv=sql_select($sql_conv);
	foreach($data_arr_conv as $conv_row)
	{
		$convamount=array_sum($conv_amount_arr[$conv_row[csf('con_id')]]);
		$convQty=array_sum($conv_qty_arr[$conv_row[csf('con_id')]]);
		$conv_data[cons_process][$conv_row[csf('con_id')]]=$conv_row[csf('cons_process')];
		$conv_data[amount][$conv_row[csf('con_id')]]=$conv_row[csf('amount')];
		$conv_data[amount_job][$conv_row[csf('con_id')]]+=$convamount;
		$summary_data[conver_cost_job]+=$convamount;
	
		$index=$conv_row[csf('con_id')];
		$ConvData[$index]['item_descrition']=$body_part[$conv_row[csf("body_part_id")]].", ".$color_type[$conv_row[csf("color_type_id")]].", ".$conv_row[csf("fabric_description")];
		$ConvData[$index]['cons_process']=$conv_row[csf("cons_process")];
		$ConvData[$index]['req_qnty']=$conv_row[csf("req_qnty")];
		$ConvData[$index]['uom']=$conv_row[csf("uom")];
		$ConvData[$index]['charge_unit']=$conv_row[csf("charge_unit")];
		$ConvData[$index]['amount']=$conv_row[csf("amount")];
		$ConvData[$index]['tot_req_qnty']=$convQty;
		$ConvData[$index]['tot_amount']=$convamount;
		$totConv+=$conv_row[csf("req_qnty")];
	}
	//Conversion End

	if($zero_value==1)
	{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($ConvData)+3; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Total Cons</td>
                    <td width="100">Uom</td>
                    <td width="100">Rate (USD)</td>
                    <td width="150">Amount (USD)/<? echo $costing_for; ?></td>
                    <td width="100">Tot. Amount (USD)</td>
                </tr>
				<?
                $TotalDznAmount =0; $TotalAmount =0;
                foreach( $ConvData as $index=>$row )
                {
                    ?>
                    <tr>
                        <td align="left"><? echo $row['item_descrition']; ?></td>
                        <td align="left"><? echo $conversion_cost_head_array[$row["cons_process"]]; ?></td>
                        <td align="right"><? echo fn_number_format($row["req_qnty"],4); ?></td>
                        <td align="right"><? echo fn_number_format($row["tot_req_qnty"],4); ?></td>
                        <td align=""><? echo $unit_of_measurement[$row["uom"]]; ?></td>
                        <td align="right"><? echo fn_number_format($row["charge_unit"],4); ?></td>
                        <td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
                        <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                    </tr>
                    <?
                     $TotalDznAmount += $row["amount"];
                     $TotalAmount += $row["tot_amount"];
    
                     $GrandTotalFabricDznAmount+=$row["amount"];
                     $GrandTotalFabricAmount+=$row["tot_amount"];
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td  align="left" colspan="6">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="6">Total Fabric Cost</td>
                    <td align="right"><? echo fn_number_format($GrandtotalDznAmount + $GrandTotalFabricDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($GrandtotalAmount+ $GrandTotalFabricAmount,4); ?></td>
                </tr>
            </table>
        </div>
        <?
	}
	else
	{
		if($totConv>0)
		{
			?>
			 <div style="margin-top:15px">
                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                    <tr style="font-weight:bold">
                        <td width="80" rowspan="<? echo count($ConvData)+3; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                        <td width="350">Particulars</td>
                        <td width="100">Process</td>
                        <td width="100">Cons/<? echo $costing_for; ?></td>
                        <td width="100">Total Cons</td>
                         <td width="100">Uom</td>
                        <td width="100">Rate (USD)</td>
                        <td width="150">Amount (USD)/<? echo $costing_for; ?></td>
                         <td width="100">Tot. Amount (USD)</td>
                    </tr>
					<?
				    $TotalDznAmount =0; $TotalAmount =0;
					foreach( $ConvData as $index=>$row)
					{
						?>
						<tr>
							<td align="left"><? echo $row['item_descrition']; ?></td>
							<td align="left"><? echo $conversion_cost_head_array[$row["cons_process"]]; ?></td>
							<td align="right"><? echo fn_number_format($row["req_qnty"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["tot_req_qnty"],4); ?></td>
							<td align=""><? echo $unit_of_measurement[$row["uom"]]; ?></td>
							<td align="right"><? echo fn_number_format($row["charge_unit"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["amount"],4); ?></td>
							<td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
						</tr>
						<?
						 $TotalDznAmount += $row["amount"];
						 $TotalAmount += $row["tot_amount"];
		
						 $GrandTotalFabricDznAmount+=$row["amount"];
						 $GrandTotalFabricAmount+=$row["tot_amount"];
					}
					?>
                    <tr class="rpt_bottom" style="font-weight:bold">
                        <td align="left" colspan="6">Total</td>
                        <td align="right"><? echo  fn_number_format($TotalDznAmount,4); ?></td>
                        <td align="right"><? echo  fn_number_format($TotalAmount,4); ?></td>
                    </tr>
                    <tr class="rpt_bottom" style="font-weight:bold">
                        <td align="left" colspan="6">Total Fabric Cost</td>
                        <td align="right"><? echo fn_number_format($GrandtotalDznAmount + $GrandTotalFabricDznAmount,4); ?></td>
                        <td align="right"><? echo fn_number_format($GrandtotalAmount + $GrandTotalFabricAmount,4); ?></td>
                    </tr>
                </table>
			  </div>
			  <?
		}
		else echo "";
	}
		//end 	All Fabric Cost part report-------------------------------------------
	//start	Trims Cost part report here -------------------------------------------
	$trim_group=return_library_array( "select item_name,id from  lib_item_group", "id", "item_name"  );
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="150">Nominated Supp</td>
                    <td width="150">Remarks</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/<? echo $costing_for ?></td>
                    <td width="100">Tot. Cons</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                </tr>
            <?
            $TotalDznAmountTrim=0;
			$TotalAmountTrim=0;	
			/*echo '<pre>';
			print_r($TrimData); die;*/		
            foreach( $TrimData as $index=>$row )
            {

			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row["trim_group"]]; ?></td>
                    <td align="left"><? echo $row["description"]; ?></td>
                    <td align="left"><? echo $row["brand_sup_ref"]; ?></td>
                    <td align="left">
                    <? 
	                	 $exnominated_supp=explode(",",$row['nominated_supp']);
	                	 $nominated_supp_str ='';
						 foreach($exnominated_supp as $supp)
						 {
							if($nominated_supp_str=="") $nominated_supp_str=$supplier_name_arr[$supp]; else $nominated_supp_str.=','.$supplier_name_arr[$supp];
						 }
                    	//echo $supplier_name_arr[$row["nominated_supp"]]; 
						 echo $nominated_supp_str;
                    ?>
                    	
                    </td>
                     <td align="left"><? echo $row["remark"]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row["cons_uom"]]; ?></td>
                    <td align="right"><? echo number_format($row["cons_dzn_gmts"],4); ?></td>
                     <td align="right"><? echo number_format($row["tot_cons"],4); ?></td>
                    <td align="right"><? echo number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmountTrim += $row["amount"];
				 $TotalAmountTrim += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="9" align="left">Total</td>
                    <td align="right"><? echo number_format($TotalDznAmountTrim,4); ?></td>
                    <td align="right"><? echo number_format($TotalAmountTrim,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($totTrim>0)
		{
	?>
    <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="150">Nominated Supp</td>
                     <td width="150">Remarks</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/<? echo $costing_for ?></td>
                    <td width="100">Tot. Cons</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                     <td width="100">Tot. Amount</td>
                </tr>
            <?
            $TotalDznAmountTrim=0;
			$TotalAmountTrim=0;
            foreach( $TrimData as $index=>$row)
            {

			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row["trim_group"]]; ?></td>
                    <td align="left"><? echo $row["description"]; ?></td>
                    <td align="left"><? echo $row["brand_sup_ref"]; ?></td>
                    <td align="left">
                    <? 
                    	$exnominated_supp=explode(",",$row['nominated_supp']);
                    	$nominated_supp_str='';
						 foreach($exnominated_supp as $supp)
						 {
							if($nominated_supp_str=="") $nominated_supp_str=$supplier_name_arr[$supp]; else $nominated_supp_str.=','.$supplier_name_arr[$supp];
						 }
						 echo $nominated_supp_str;
                    ?>
                    	
                    </td>
                     <td align="left"><? echo $row["remark"]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row["cons_uom"]]; ?></td>
                    <td align="right"><? echo number_format($row["cons_dzn_gmts"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_cons"],4); ?></td>
                    <td align="right"><? echo number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmountTrim += $row["amount"];
				 $TotalAmountTrim += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="8" align="left">Total</td>
                    <td align="right"><? echo number_format($TotalDznAmountTrim,4); ?></td>
                    <td align="right"><? echo number_format($TotalAmountTrim,4); ?></td>
                </tr>
            </table>
      </div>
	<?
		}
		else
		{
		   echo "";
		}
	}
	 //End Trims Cost Part report here -------------------------------------------

	 //End Trims Cost Part report here -------------------------------------------
	 // Supplier wise amount
	 $nominated_supp_arr = array();
	 foreach ($TrimData as $value) {
		 $exnominated_supp=explode(",",$value['nominated_supp']);
		 foreach($exnominated_supp as $supp)
		 {
			 $nominated_supp_arr[$supp][] = $value['tot_amount'];
		 }
		 
	 }
	 ?>
       			<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
					<label><b>Supplier Wise Amount</b></label>
					<tr>
						<th width="150">Nominated Supp</th>
						<th width="150">Tot. Amount</th>
					</tr>
					<?	$supplier_wise_amount = 0;
						foreach ($nominated_supp_arr as $supplier => $amount) {
							$total_amount= array_sum($amount);
							$supplier_wise_amount += $total_amount;
						?>
							<tr>
								<td><? echo $supplier_name_arr[$supplier] ?></td>
								<td><? echo number_format($total_amount,4);?></td>
							</tr>
						<? }
					?>
					<tr>
						<th>Total</th>
						<th><? echo number_format($supplier_wise_amount,4);?></th>
					</tr>
				</table>
			</div>
      <?
	 // End supplier wise amount
	 //start	Embellishment Details part report here -------------------------------------------
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/<? echo $costing_for ?></td>
                    <td width="150">Tot.Cons</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
            <?
            $TotalDznAmountEmb=0;
		    $TotalAmountEmb =0;
            foreach( $EmbData as $index=>$row )
            {
				$em_type ='';
 				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row["emb_name"]==1)$em_type = $emblishment_print_type[$row["emb_type"]];
				else if($row["emb_name"]==2)$em_type = $emblishment_embroy_type[$row["emb_type"]];
				else if($row["emb_name"]==3)$em_type = $emblishment_wash_type[$row["emb_type"]];
				else if($row["emb_name"]==4)$em_type = $emblishment_spwork_type[$row["emb_type"]];
				else if($row["emb_name"]==5)$em_type = $emblishment_gmts_type[$row["emb_type"]];
				else if($row["emb_name"]==99)$em_type = $emblishment_other_type_arr[$row["emb_type"]];


			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row["emb_name"]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo number_format($row["cons_dzn_gmts"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_cons"],4); ?></td>
                    <td align="right"><? echo number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmountEmb += $row["amount"];
				 $TotalAmountEmb += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="5" align="left">Total</td>
                    <td align="right"><? echo number_format($TotalDznAmountEmb,4); ?></td>
                    <td align="right"><? echo number_format($TotalAmountEmb,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($totEmb>0)
		{
	?>
     <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/<? echo $costing_for ?></td>
                    <td width="150">Tot.Cons</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
            <?
            $TotalDznAmountEmb=0;
		    $TotalAmountEmb =0;
            foreach( $EmbData as $index=>$row  )
            {
				$em_type ='';
 				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row["emb_name"]==1)$em_type = $emblishment_print_type[$row["emb_type"]];
				else if($row["emb_name"]==2)$em_type = $emblishment_embroy_type[$row["emb_type"]];
				else if($row["emb_name"]==3)$em_type = $emblishment_wash_type[$row["emb_type"]];
				else if($row["emb_name"]==4)$em_type = $emblishment_spwork_type[$row["emb_type"]];
				else if($row["emb_name"]==5)$em_type = $emblishment_gmts_type[$row["emb_type"]];
				else if($row["emb_name"]==99)$em_type = $emblishment_other_type_arr[$row["emb_type"]];


			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row["emb_name"]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo number_format($row["cons_dzn_gmts"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_cons"],4); ?></td>
                    <td align="right"><? echo number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmountEmb += $row["amount"];
				 $TotalAmountEmb += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="5" align="left">Total</td>
                    <td align="right"><? echo number_format($TotalDznAmountEmb,4); ?></td>
                    <td align="right"><? echo number_format($TotalAmountEmb,4); ?></td>
                </tr>
            </table>
      </div>
    <?

		}
		else
		{
			echo "";
		}
	}
	 //End Embellishment Details Part report here -------------------------------------------



	 //start	Commercial Cost part report here -------------------------------------------
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate In %</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot.Amount</td>
                 </tr>
            <?
           $TotalDznAountComr=0;
		   $TotalAountComr =0;
            foreach( $CommarData as $index=>$row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row["item_id"]]; ?></td>
                    <td align="right"><? echo number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAountComr += $row["amount"];
				 $TotalAountComr += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2" align="left">Total</td>
                    <td align="right"><? echo number_format($TotalDznAountComr,4); ?></td>
                    <td align="right"><? echo number_format($TotalAountComr,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($totCommar>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot.Amount</td>
                 </tr>
            <?
           $TotalDznAountComr=0;
		   $TotalAountComr =0;
            foreach( $CommarData as $index=>$row  )
            {
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row["item_id"]]; ?></td>
                    <td align="right"><? echo number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAountComr += $row["amount"];
				 $TotalAountComr += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2" align="left">Total</td>
                     <td align="right"><? echo number_format($TotalDznAountComr,4); ?></td>
                    <td align="right"><? echo number_format($TotalAountComr,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
			echo "";
		}

	}
	 //End Commercial Cost Part report here -------------------------------------------


  	//start	Commission Cost part report here -------------------------------------------

	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission / Service Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
            <?
            $TotalDznAountCommi = 0;
		    $TotalAountCommi = 0;
            foreach( $CommiData as $index=>$row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row["particulars_id"]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row["commission_base_id"]]; ?></td>
                    <td align="right"><? echo number_format($row["commision_rate"],4); ?></td>
                    <td align="right"><? echo number_format($row["commission_amount"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_commission_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAountCommi += $row["commission_amount"];
				 $TotalAountCommi += $row["tot_commission_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3" align="left">Total</td>
                    <td align="right"><? echo number_format($TotalDznAountCommi,4); ?></td>
                    <td align="right"><? echo number_format($TotalAountCommi,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($totCommi>0)
		{
			$TotalDznAountCommi = 0;
		    $TotalAountCommi = 0;
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
            <?
            foreach( $CommiData as $index=>$row )
            {
  			?>
                <tr>
                   <td align="left"><? echo $commission_particulars[$row["particulars_id"]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row["commission_base_id"]]; ?></td>
                    <td align="right"><? echo number_format($row["commision_rate"],4); ?></td>
                    <td align="right"><? echo number_format($row["commission_amount"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_commission_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAountCommi += $row["commission_amount"];
				 $TotalAountCommi += $row["tot_commission_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3" align="left">Total</td>
                    <td align="right"><? echo number_format($TotalDznAountCommi,4); ?></td>
                    <td align="right"><? echo number_format($TotalAountCommi,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
		   echo "";
		}

	}
	 //End Commission Cost Part report here -------------------------------------------


	//start	Other Components part report here -------------------------------------------
			$net_fob_value_dzn=$summary_data[price_dzn]-$summary_data[commission];
			$interest_expense_dzn=$net_fob_value_dzn*$financial_para['interest_expense']/100;
			$income_tax_dzn=$net_fob_value_dzn*$financial_para['income_tax']/100;

			$net_fob_value_tot=$summary_data[price_dzn_job]-$TotalAountCommi;
			$interest_expense_tot=$net_fob_value_tot*$financial_para['interest_expense']/100;
			$income_tax_tot=$net_fob_value_tot*$financial_para['income_tax']/100;

			$total_other_components += $summary_data[lab_test_job]+$summary_data[inspection_job]+$summary_data[freight_job]+$summary_data[currier_pre_cost_job]+$summary_data[certificate_pre_cost_job]+$summary_data[common_oh_job]+$summary_data[depr_amor_pre_cost_job]+$interest_expense_tot+$income_tax_tot+$TotalAountCommi+$TotalAountComr;
			$dzn_other_components += $summary_data[lab_test]+$summary_data[inspection]+$summary_data[freight]+$summary_data[currier_pre_cost]+$summary_data[certificate_pre_cost]+$summary_data[common_oh]+$summary_data[depr_amor_pre_cost]+$interest_expense_dzn+$income_tax_dzn+$summary_data[commission]+$summary_data[comm_cost];
            ?>
      <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>CM Cost - IE</b></label>
                <tr style="font-weight:bold">
                    <td width="100">Amount /<? echo $costing_for ?></td>
                    <td width="100">Amount</td>
                 </tr>
                 <tr>
                    <td width="100" align="right"><? echo number_format($summary_data[cm_cost],4);  ?></td>
                    <td width="100" align="right"><? echo number_format($summary_data[cm_cost_job],4);  ?></td>
                 </tr>
                 </table>
      </div>


        <div style="margin-top:15px">
         <table>
         <tr>
         <td>
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:450px;text-align:center;" rules="all">
            <label><b>Others Components</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount</td>
                 </tr>

                <tr>
                    <td align="left"s>Lab Test </td>
                    <td align="right"><? echo number_format($summary_data[lab_test_job],4); ?></td>
                </tr>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo number_format($summary_data[inspection_job],4); ?></td>
                </tr>

                <tr>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo number_format($summary_data[freight_job],4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Currier Cost </td>
                    <td align="right"><? echo number_format($summary_data[currier_pre_cost_job],4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Certificate Cost </td>
                    <td align="right"><? echo number_format($summary_data[certificate_pre_cost_job],4); ?></td>
                </tr>
                <tr>
                    <td align="left">Commercial Cost </td>
                    <td align="right"><? echo number_format($TotalAountComr,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Operating Expenses</td>
                    <td align="right"><? echo number_format($summary_data[common_oh_job],4); ?></td>
                </tr>
                  <tr>
                    <td align="left">Commission </td>
                    <td align="right"><? echo number_format($TotalAountCommi,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Depreciation & Amortization </td>
                    <td align="right"><? echo number_format($summary_data[depr_amor_pre_cost_job],4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Interest</td>
                    <td align="right"><? echo number_format($interest_expense_tot,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Income Tax</td>
                    <td align="right"><? echo number_format($income_tax_tot,4); ?></td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo number_format($total_other_components,4); ?></td>
                </tr>
            </table>
            </td>
            <td valign="top" rowspan="2">

            <?
			$job_no=str_replace("'","",$txt_job_no);
     	 // image show here  -------------------------------------------
		 $sql = "select id,master_tble_id,image_location
				from common_photo_library
				where master_tble_id=$txt_job_no limit 1";
		$data_array=sql_select($sql);
 	  ?>
          <div style="margin:15px 5px;float:right;width:500px" >
          	<? foreach($data_array AS $inf){ ?>
                <img  src='../../<? echo $inf[csf("image_location")]; ?>' height='400' width='300' />
            <?  } ?>
          </div>
          </td>
          </tr>
          <tr>
          <td>
			<?
            $total_summary_amount = $GrandtotalAmount+$TotalAmountTrim+$TotalAmountEmb+$summary_data[cm_cost_job]+$total_other_components;
            ?>
	 <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:450px;text-align:center" rules="all">
            <label><b>Summary</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Cost Summary</td>
                    <td width="100">Cost/<? echo $costing_for ?></td>
                    <td width="100">Total</td>
					<td width="100">%</td>
                 </tr>
                <tr>
                    <td align="left"> Fabric Cost</td>
                    <td align="right"><? echo number_format($GrandtotalDznAmount,4); ?></td>
                    <td align="right"><? echo number_format($GrandtotalAmount,4); ?></td>
					<td align="left"><?=fn_number_format((($GrandtotalAmount/$order_values)*100),2); ?></td>
                </tr>
                <tr>
                    <td align="left">Trims</td>
                    <td align="right"><? echo number_format($TotalDznAmountTrim,4); ?></td>
                    <td align="right"><? echo number_format($TotalAmountTrim,4); ?></td>
					<td align="left"><?=fn_number_format((($TotalAmountTrim/$order_values)*100),2);?></td>
                </tr>
                <tr>
                    <td align="left">Embellishment</td>
                    <td align="right"><? echo number_format($TotalDznAmountEmb,4); ?></td>
                    <td align="right"><? echo number_format($TotalAmountEmb,4); ?></td>
					<td align="left"><?=fn_number_format((($TotalAmountEmb/$order_values)*100),2);?></td>
                </tr>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo number_format($summary_data[cm_cost],4); ?></td>
                    <td align="right"><? echo number_format($summary_data[cm_cost_job],4); ?></td>
					<td align="left"><?=fn_number_format((($summary_data[cm_cost_job]/$order_values)*100),2);?></td>
                </tr>
                  <tr>
                    <td align="left">Others Components Cost</td>
                    <td align="right"><? echo number_format($dzn_other_components,4); ?></td>
                    <td align="right"><? echo number_format($total_other_components,4); ?></td>
					<td align="left"><?=fn_number_format((($total_other_components/$order_values)*100),2);?></td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="right" colspan="2">Total</td>
                    <td align="right"><? echo number_format($total_summary_amount,4); ?></td>
					<td align="left"><?=fn_number_format((($total_summary_amount/$order_values)*100),2)?></td>
                </tr>
            </table>
          </td>
          </tr>
          </table>
      </div>
      <br>
       
       <div style="margin-top:15px">
        <div style="float:left">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
            <label><b>CM on Net Order Value</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">%</td>
                </tr>
                <tr>
                    <td align="left">Order Value </td>
                    <td align="right"><?  echo fn_number_format($order_values,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Commission </td>
                    <td align="right"><? $less_commission=$commission_costing_arr[$job_no];//$less_commission = $row[csf("commission")]/$order_price_per_dzn*$order_job_qnty;
					echo fn_number_format($less_commission,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Commercial Cost </td>
                    <td align="right"><? $less_commercial=$commercial_costing_arr[$job_no];//$less_commercial = $row[csf("comm_cost")]/$order_price_per_dzn*$order_job_qnty;
					 echo fn_number_format($less_commercial,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Freight</td> 
                    <td align="right"><? $less_freight=$other_cost[$job_no]['freight'];//$less_freight = $row[csf("freight")]/$order_price_per_dzn*$order_job_qnty;
					echo fn_number_format($less_freight,4); ?></td>
                    <td align="right">&nbsp;</td>

                </tr>
                <tr>
                    <td align="left">Net Order Value</td>
                    <td align="right"><? $order_net_value=$order_values-($less_commission+$less_commercial+$less_freight);echo fn_number_format($order_net_value,4); ?></td>
                    <td align="center"><? echo fn_number_format($order_net_value/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">Other Cost</td>
                    <td align="right">
					<?
					//$all_tot_cost=$GrandtotalAmount+$GrandTotalFabricAmount+$TotalAmountTrim+$TotalAmountEmb+$TotalAountComr+$TotalAountCommi+$summary_data[cm_cost_job]+$total_other_components;
					//$others_cost_value=$all_tot_cost-($summary_data[cm_cost_job]+$summary_data[freight_job]+$TotalAountComr+$TotalAountCommi);
					
					$all_tot_cost=$GrandtotalAmount+$GrandTotalFabricAmount+$TotalAmountTrim+$TotalAmountEmb+$summary_data[cm_cost_job]+$total_other_components;
					$others_cost_value=$all_tot_cost-($summary_data[cm_cost_job]+$summary_data[freight_job]+$TotalAountComr+$TotalAountCommi);
					
					//$others_cost_value=$all_total_cost-$cm_cost-$freight-$commercial_cost-$commission;
					//echo $others_cost_value;
					$otherCost=$others_cost_value;
					//	$otherCost=$others_cost_value/$order_price_per_dzn*$order_job_qnty;
					echo fn_number_format($otherCost,4);
					?>
                    </td>
                    <td align="center"><? echo fn_number_format($otherCost/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">CM(Contribution Margin)</td>
                    <td align="right"><? $cmValue = $order_net_value-$otherCost; echo fn_number_format($cmValue,4); ?></td>
                    <td align="center"><? echo fn_number_format($cmValue/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">CM /<? echo $costing_for; ?></td>
                    <td align="right" title="CM/PO Qty(<? echo $order_qty;?>)*Costing Per"><? $cmPerDzn=$cmValue/$order_qty*$order_price_per_dzn; echo fn_number_format($cmPerDzn,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td align="left">CM Cost /<? echo $costing_for; ?></td>
                    <td align="right"><?
					$cm_cost=$cm_cost_dzn;//$other_costing_arr[$job_no]['cm_cost'];
					echo fn_number_format($cm_cost,4); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Margin /<? echo $costing_for; ?></td>
                    <td align="right"><? echo fn_number_format($cmPerDzn-$cm_cost,4); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>

            </table>
      </div>
      <div style="margin-left:5px;float:left;">
      		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
            <label><b>Cost Summary for order quantity</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">%</td>
                </tr>
                <tr>
                    <td align="left">Total Order Value </td>
                    <td align="right"><? $total_order_val = $order_values;//$order_job_qnty*$avg_unit_price;
					 echo fn_number_format($total_order_val,4); ?></td>
                    <td align="center"><? echo fn_number_format($total_order_val/$total_order_val*100,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Total Cost </td>
                    <td align="right"><?  $total_cost = $total_summary_amount;//$all_total_cost;
					echo fn_number_format($total_cost,4);//$total_cost = $row[csf("total_cost")]/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($total_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format($total_cost/$total_order_val*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Margin </td>
                    <td align="right"><? $margin_val = $total_order_val-$total_cost; echo fn_number_format($margin_val,4); ?></td>
                    <td align="center"><? echo fn_number_format($margin_val/$total_order_val*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Margin /<? echo $costing_for; ?> </td>
                    <td align="right"><? echo fn_number_format($margin_val/$order_qty*$order_price_per_dzn,2); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>
           </table>
      
       <br/>

 	<?=signature_table(109, $cbo_company_name, "850px");?>
	</div>
	 <?
	 exit();
}

if($action=="preCostRpt3")//Cost Rpt3 Btn 9
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if($db_type==0)
	{
		$costing_date=change_date_format(str_replace("'","",$txt_costing_date), "yyyy-mm-dd", "-");
		$limit_cond="LIMIT 1";
		$group_gsm="group_concat( distinct b.gsm_weight)";
	}
	else if($db_type==2)
	{
		$costing_date=change_date_format(str_replace("'","",$txt_costing_date), "yyyy-mm-dd", "-",1);
		$limit_cond="";
		$group_gsm="listagg(b.gsm_weight ,',') within group (order by b.gsm_weight)";
	}
	
	$poBreackDownId=str_replace("'","",$txt_po_breack_down_id);
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and b.costing_date='".$txt_costing_date."'";
	if($poBreackDownId==""){$poId_cond='';$poId_cond2='';}else{$poId_cond=" and id in ($poBreackDownId)"; $poId_cond2=" and b.id in ($poBreackDownId)";}

	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	
	$cpm_based_sql=sql_select( "select cm_cost_method_based_on from variable_order_tracking where variable_list=22 and company_name=$cbo_company_name");
	$cpm_based_on=0;
	foreach($cpm_based_sql as $row)
	{
		$cpm_based_on=$row[csf('cm_cost_method_based_on')];
	}
	unset($cpm_based_sql);
	//echo $cpm_based_on;
	
	$cpmdate=sql_select("select min(pub_shipment_date) as min_pub_shipment_date, max(pub_shipment_date) as max_pub_shipment_date, min(shipment_date) as min_shipment_date, max(shipment_date) as max_shipment_date from  wo_po_break_down where job_no_mst=".$txt_job_no." $poId_cond and is_deleted=0 and status_active=1");
	$min_pub_shipment_date="";
	$max_pub_shipment_date="";
	$min_shipment_date="";
	$max_shipment_date="";
	foreach($cpmdate as $row){
		$min_pub_shipment_date=$row[csf('min_pub_shipment_date')];
		$max_pub_shipment_date=$row[csf('max_pub_shipment_date')];
		$min_shipment_date=$row[csf('min_shipment_date')];
		$max_shipment_date=$row[csf('max_shipment_date')];
	}
	unset($cpmdate);
	
	$cpm_date_cond="";
	if($cpm_based_on==2) $cpm_date_cond=$min_shipment_date;
	else if($cpm_based_on==3) $cpm_date_cond=$max_shipment_date;
	else if($cpm_based_on==4) $cpm_date_cond=$min_pub_shipment_date;
	else if($cpm_based_on==5) $cpm_date_cond=$max_pub_shipment_date;
	else $cpm_date_cond=$costing_date;
	
	//echo "select cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and '$cpm_date_cond' between applying_period_date and applying_period_to_date and status_active=1 and is_deleted=0 $limit_cond"; die;

	$sqlcpm=sql_select("select cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and '$cpm_date_cond' between applying_period_date and applying_period_to_date and status_active=1 and is_deleted=0 $limit_cond");

	$cpm='';
	foreach($sqlcpm as $sqlcpmrow){
		$cpm=$sqlcpmrow[csf('cost_per_minute')];
	}
	unset($sqlcpm);

	$po_qty=0; $po_plun_cut_qty=0;
	$sql_po="select a.job_no, a.buyer_name, a.gmts_item_id, a.style_ref_no, a.total_set_qnty, a.set_smv, a.company_name, a.order_uom, a.job_quantity, a.avg_unit_price, b.id, b.po_number, b.pub_shipment_date, c.item_number_id, c.country_id, c.color_number_id, c.size_number_id, c.order_quantity, c.plan_cut_qnty

	from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c

	where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and a.job_no =".$txt_job_no." $poId_cond2 and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 order by b.id";
	//echo $sql_po;
	$sql_po_data=sql_select($sql_po); $job_data_arr=array(); $po_data_arr=array(); $uom=0;
	foreach($sql_po_data as $jrow)
	{
		$job_data_arr[$jrow[csf('job_no')]]['jdata']=$jrow[csf('buyer_name')].'___'.$jrow[csf('gmts_item_id')].'___'.$jrow[csf('style_ref_no')].'___'.$jrow[csf('total_set_qnty')].'___'.$jrow[csf('set_smv')].'___'.$jrow[csf('company_name')].'___'.$jrow[csf('order_uom')].'___'.$jrow[csf('job_quantity')].'___'.$jrow[csf('avg_unit_price')];

		$po_data_arr[$jrow[csf('job_no')]][$jrow[csf('id')]]['pdata']=$jrow[csf('po_number')].'___'.$jrow[csf('pub_shipment_date')];

		$po_qty+=$jrow[csf('order_quantity')];
		$po_plun_cut_qty+=$jrow[csf('plan_cut_qnty')];
		$uom=$jrow[csf('order_uom')];
	}
	unset($sql_po_data);

	$mst_sql = "select a.job_no, a.costing_date, a.costing_per, a.budget_minute, a.approved, a.sew_smv, a.sew_effi_percent, a.exchange_rate, a.inserted_by, a.incoterm, c.fab_knit_req_kg, c.fab_knit_fin_req_kg, c.fab_woven_req_yds, c.fab_woven_fin_req_yds, c.fab_yarn_req_kg from wo_pre_cost_mst a left join wo_pre_cost_sum_dtls c on a.job_no=c.job_no where a.status_active=1 and a.job_no=".$txt_job_no."";

	$mst_sql_res=sql_select($mst_sql); $pre_mst_arr=array();
	foreach($mst_sql_res as $mrow)
	{
		$pre_mst_arr[$mrow[csf('job_no')]]['mdata']=$mrow[csf('costing_date')].'___'.$mrow[csf('costing_per')].'___'.$mrow[csf('budget_minute')].'___'.$mrow[csf('approved')].'___'.$mrow[csf('sew_effi_percent')].'___'.$mrow[csf('inserted_by')].'___'.$mrow[csf('sew_smv')].'___'.$mrow[csf('exchange_rate')].'___'.$mrow[csf('incoterm')];
		$pre_mst_arr[$mrow[csf('job_no')]]['knit_req_kg']+=$mrow[csf('fab_knit_req_kg')];
		$pre_mst_arr[$mrow[csf('job_no')]]['fin_req_kg']+=$mrow[csf('fab_knit_fin_req_kg')];
		$pre_mst_arr[$mrow[csf('job_no')]]['woven_req_yds']+=$mrow[csf('fab_woven_req_yds')];
		$pre_mst_arr[$mrow[csf('job_no')]]['woven_fin_req_yds']+=$mrow[csf('fab_woven_fin_req_yds')];
		$pre_mst_arr[$mrow[csf('job_no')]]['yarn_req_kg']+=$mrow[csf('fab_yarn_req_kg')];
	}
	unset($mst_sql_res);

	$job_no=str_replace("'","",$txt_job_no);

	$exjob_data=explode("___",$job_data_arr[$job_no]['jdata']);

	$buyer_id=$exjob_data[0];
	$gmts_item_id=$exjob_data[1];
	$style_ref_no=$exjob_data[2];
	$total_set_qnty=$exjob_data[3];
	$set_smv=$exjob_data[4];
	$company_name=$exjob_data[5];
	$order_uom=$exjob_data[6];
	$job_qty=$exjob_data[7];
	$avg_unit_price=$exjob_data[8];

	$po_id=''; $po_no=""; $pubship_date='';

	foreach($po_data_arr[$job_no] as $pid=>$podata)
	{
		$ex_po=0;
		//echo $podata['pdata'].'==';
		$ex_po=explode("___",$podata['pdata']);
		if($po_id=="") $po_id=$pid; else $po_id.=', '.$pid;
		if($po_no=="") $po_no=$ex_po[0]; else $po_no.=', '.$ex_po[0];
		if($pubship_date=="") $pubship_date=change_date_format($ex_po[1]); else $pubship_date.=', '.change_date_format($ex_po[1]);
	}

	$exmst_data=explode("___",$pre_mst_arr[$job_no]['mdata']);

	$costing_date=$exmst_data[0];
	$costing_per=$exmst_data[1];
	$budget_minute=$exmst_data[2];
	$approved=$exmst_data[3];
	$sew_effi_percent=$exmst_data[4];
	$inserted_by=$exmst_data[5];
	$pre_sew_smv=$exmst_data[6];
	$exchange_rate=$exmst_data[7];
	$incoterm=$exmst_data[8];

	$gsm_sql="select $group_gsm AS gsm_weight from lib_body_part a, wo_pre_cost_fabric_cost_dtls b where a.id=b.body_part_id and b.job_no='$job_no' and a.body_part_type in (1,20) and b.status_active=1 and b.is_deleted=0";
	$gsm_sql_res=sql_select($gsm_sql); $gsm_weight='';
	foreach($gsm_sql_res as $grow)
	{
		if($gsm_weight=="") $gsm_weight=$grow[csf('gsm_weight')]; else $gsm_weight.=','.$grow[csf('gsm_weight')];
	}
	unset($gsm_sql_res);

	$imge_arr=return_library_array( "select master_tble_id, image_location from common_photo_library where form_name='company_details' and file_type=1 and master_tble_id='$company_name'",'master_tble_id','image_location');
    $image_location=return_field_value("image_location","common_photo_library","master_tble_id='$job_no'");
	ob_start();//part 0;

	if($presentation_type==2) $path="../../../"; else $path="../../";

	?>
    <div style="width:850px;">
        <table width="100%" border="0">
            <tr>
                <td rowspan="3" width="25%">
					<? if ($img_path) { ?> <img  src='<? echo $img_path.$imge_arr[$company_name]; ?>' height='80' />
                    <? } else { ?> <img  src='<? echo $path.$imge_arr[$company_name]; ?>' height='80' />
                    <? } ?>
                </td>
                <td align="center"><b style="font-size:20px;"><? echo $comp[$company_name]; ?></b></td>
                <td rowspan="3" width="25%" align="right">
					<? if ($img_path) { ?> <img  src='<? echo $img_path.$image_location; ?>' height='80' />
                    <? } else { ?> <img  src='<? echo $path.$image_location; ?>' height='80' />
                    <? } ?>
                </td>
            </tr>
            <tr><td align="center"><b style="font-size:14px;">PRE-COSTING SHEET</b></td></tr>
            <tr>
                <td align="center">
                	<? if( $approved==1 || $approved==3){echo "<div style='font-size:18px; color:#F00; background:#CCC;'>THIS COST SHEET IS APPROVED </div>"; } else {echo "&nbsp;";} ?>
                </td>
            </tr>
        </table>
    </div>
    <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
        <tr>
            <td width="130">Job No.</td><td width="140"><b><? echo $job_no; ?></b></td>
            <td width="130">Buyer</td><td width="140"><b><? echo $buyer_arr[$buyer_id];?></b></td>
            <td width="130">Garments Item</td>
				<?
					$grmnt_items = "";
					$ex_gmt_id=explode(",",$gmts_item_id);
					foreach($ex_gmt_id as $gmt_id)
					{
						if($grmnt_items=="") $grmnt_items=$garments_item[$gmt_id]; else $grmnt_items.=', '.$garments_item[$gmt_id];
					}
                ?>
            <td><b><? echo $grmnt_items; ?></b></td>
        </tr>
        <tr>
            <td>Style Ref. No</td><td><b><? echo $style_ref_no; ?></b></td>
            <td>Costing Date</td><td><? echo change_date_format($costing_date);?></td>
            <td>Job Qty</td><td><b><? echo fn_number_format($job_qty)." ". $unit_of_measurement[$order_uom]; ?></b></td>
        </tr>
        <tr>
            <td>Order No.</td><td colspan="3"><? echo $po_no; ?></td>
            <td>Plan Cut Qty [Cut % <? echo fn_number_format((($po_plun_cut_qty/$total_set_qnty-$job_qty)/$job_qty)*100,2);?>]</td>
            <td><b><? echo fn_number_format($po_plun_cut_qty/$total_set_qnty)." ". $unit_of_measurement[$order_uom]; ?></b></td>
        </tr>
        <tr>
            <td>Knit Fabric Cons</td>
            <td><b><? echo $pre_mst_arr[$job_no]['knit_req_kg']; $fab_knit_req_kg_avg+=$pre_mst_arr[$job_no]['knit_req_kg']; ?> <? echo $costing_for; ?></b></td>
            <td>Woven Fabric Cons</td>
            <td><b><? echo $pre_mst_arr[$job_no]['woven_req_yds']; $fab_woven_req_yds_avg+=$pre_mst_arr[$job_no]['woven_req_yds']; ?> <? echo $costing_for; ?></b></td>
            <td>Price Per Unit</td><td><b><? echo fn_number_format($avg_unit_price,2); ?> USD</b></td>
        </tr>
        <tr>
            <td>Avg Yarn Req</td><td><b><? echo $pre_mst_arr[$job_no]['yarn_req_kg']; ?> <? echo $costing_for; ?></b></td>
            <td>Woven Fin Fabric Cons</td><td><b><? echo $pre_mst_arr[$job_no]['woven_fin_req_yds']; ?><? echo $costing_for; ?></b></td>
            <td>Order Value</td><td><b><? $order_value=$job_qty*$avg_unit_price; echo fn_number_format($order_value,2); ?></b></td>
        </tr>
        <tr>
            <td>Knit Fin Fabric Cons</td><td><b><? echo $pre_mst_arr[$job_no]['fin_req_kg']; ?><? echo $costing_for; ?></b></td>
            <td>Costing Per</td><td><b><? echo $costing_per[$costing_per]; ?></b></td>
            <td>Incoterm</td><td><b><? echo $incoterm[$incoterm]; ?></b></td>
        </tr>
        <tr>
            <td>GSM</td><td><b><? echo $gsm_weight; ?></b></td>
            <td>SMV</td><td><b><? echo fn_number_format($pre_sew_smv,2); ?> </b></td>
            <td>Efficiency %</td><td><b><? echo $sew_effi_percent; ?> </b></td>
        </tr>
        <tr>
            <td>Exchange Rate</td><td><b><? echo $exchange_rate; ?></b></td>
            <td>Budget SAH</td><td><b><? echo fn_number_format(($pre_sew_smv*$job_qty)/60,2); ?></b></td>
            <td>Shipment Date</td><td><b><? echo $pubship_date;?></b></td>
        </tr>
    </table>
    <?
	if($costing_per==1) { $order_price_per_dzn=12; $costing_for=" DZN"; }
	else if($costing_per==2) { $order_price_per_dzn=1; $costing_for=" PCS"; }
	else if($costing_per==3) { $order_price_per_dzn=24;$costing_for=" 2 DZN"; }
	else if($costing_per==4) { $order_price_per_dzn=36;$costing_for=" 3 DZN"; }
	else if($costing_per==5) { $order_price_per_dzn=48;$costing_for=" 4 DZN"; }

	$dtlssql = "select fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent, wash_cost, wash_cost_percent, comm_cost, comm_cost_percent, commission, commission_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, freight, freight_percent, currier_pre_cost, currier_percent, certificate_pre_cost, certificate_percent, common_oh, common_oh_percent, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set, margin_pcs_set_percent, cm_for_sipment_sche, interest_cost, interest_percent, incometax_cost, incometax_percent, deffdlc_cost, deffdlc_percent, margin_pcs_bom, margin_bom_per from wo_pre_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0";
	$dtlssql_res=sql_select($dtlssql);

	$fabric_cost=$trims_cost=$embel_cost=$wash_cost=$comm_cost=$commission=$lab_test=$inspection=$cm_cost=$freight=$currier_pre_cost=$certificate_pre_cost=$common_oh=$total_cost=$price_dzn=$margin_dzn=$price_pcs_or_set=$margin_pcs_set=$cm_for_sipment_sche=$interest_cost=$incometax_cost=$deffdlc_cost=0;

	$fabric_cost_percent=$trims_cost_percent=$embel_cost_percent=$embel_cost_percent=$wash_cost_percent=$comm_cost_percent=$commission_percent=$lab_test_percent=$inspection_percent=$cm_cost_percent=$freight_percent=$currier_percent=$certificate_percent=$common_oh_percent=$total_cost_percent=$price_dzn_percent=$margin_dzn_percent=$price_pcs_or_set=$price_pcs_or_set_percent=$margin_pcs_set_percent=$interest_percent=$incometax_percent=$deffdlc_percent=$margin_pcs_bom=$margin_bom_per=0;

	$fabric_cost=$dtlssql_res[0][csf('fabric_cost')];
	$fabric_cost_percent=$dtlssql_res[0][csf('fabric_cost_percent')];
	$trims_cost=$dtlssql_res[0][csf('trims_cost')];
	$trims_cost_percent=$dtlssql_res[0][csf('trims_cost_percent')];
	$embel_cost=$dtlssql_res[0][csf('embel_cost')];

	$embel_cost_percent=$dtlssql_res[0][csf('embel_cost_percent')];
	$wash_cost=$dtlssql_res[0][csf('wash_cost')];
	$wash_cost_percent=$dtlssql_res[0][csf('wash_cost_percent')];
	$comm_cost=$dtlssql_res[0][csf('comm_cost')];
	$comm_cost_percent=$dtlssql_res[0][csf('comm_cost_percent')];
	$commission=$dtlssql_res[0][csf('commission')];
	$commission_percent=$dtlssql_res[0][csf('commission_percent')];
	$lab_test=$dtlssql_res[0][csf('lab_test')];
	$lab_test_percent=$dtlssql_res[0][csf('lab_test_percent')];
	$inspection=$dtlssql_res[0][csf('inspection')];
	$inspection_percent=$dtlssql_res[0][csf('inspection_percent')];
	$cm_cost=$dtlssql_res[0][csf('cm_cost')];
	$cm_cost_percent=$dtlssql_res[0][csf('cm_cost_percent')];
	$freight=$dtlssql_res[0][csf('freight')];
	$freight_percent=$dtlssql_res[0][csf('freight_percent')];
	$currier_pre_cost=$dtlssql_res[0][csf('currier_pre_cost')];
	$currier_percent=$dtlssql_res[0][csf('currier_percent')];
	$certificate_pre_cost=$dtlssql_res[0][csf('certificate_pre_cost')];
	$certificate_percent=$dtlssql_res[0][csf('certificate_percent')];
	$common_oh=$dtlssql_res[0][csf('common_oh')];
	$common_oh_percent=$dtlssql_res[0][csf('common_oh_percent')];

	$total_cost=$dtlssql_res[0][csf('total_cost')];
	$total_cost_percent=$dtlssql_res[0][csf('total_cost_percent')];
	$price_dzn=$dtlssql_res[0][csf('price_dzn')];
	$price_dzn_percent=$dtlssql_res[0][csf('price_dzn_percent')];
	$margin_dzn=$dtlssql_res[0][csf('margin_dzn')];
	$margin_dzn_percent=$dtlssql_res[0][csf('margin_dzn_percent')];
	$price_pcs_or_set=$dtlssql_res[0][csf('price_pcs_or_set')];
	$price_pcs_or_set_percent=$dtlssql_res[0][csf('price_pcs_or_set_percent')];
	$margin_pcs_set=$dtlssql_res[0][csf('margin_pcs_set')];
	$margin_pcs_set_percent=$dtlssql_res[0][csf('margin_pcs_set_percent')];
	$cm_for_sipment_sche=$dtlssql_res[0][csf('cm_for_sipment_sche')];
	$interest_cost=$dtlssql_res[0][csf('interest_cost')];
	$interest_percent=$dtlssql_res[0][csf('interest_percent')];
	$incometax_cost=$dtlssql_res[0][csf('incometax_cost')];
	$incometax_percent=$dtlssql_res[0][csf('incometax_percent')];
	$deffdlc_cost=$dtlssql_res[0][csf('deffdlc_cost')];
	$deffdlc_percent=$dtlssql_res[0][csf('deffdlc_percent')];
	
	$margin_pcs_bom=$dtlssql_res[0][csf('margin_pcs_bom')];
	$margin_bom_per=$dtlssql_res[0][csf('margin_bom_per')];
	unset($dtlssql_res);
	$others_cost_value=0; $costOfFabriTrimsEmbWash=0;
	$others_cost_value=$total_cost-$cm_cost-$freight-$comm_cost-$commission;
	$costOfFabriTrimsEmbWash=($fabric_cost+$trims_cost+$embel_cost+$wash_cost);
	
	//echo $margin_pcs_bom.'='.$margin_bom_per;
	$sl=1;
	?>
    <div style="margin-top:15px">
        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px; text-align:center;" rules="all">
            <tr style="font-weight:bold">

                <td width="80">SL</td>
                <td width="300">Particulars</td>
                <td width="100">Cost</td>
                <td width="100">Amount (USD)</td>
                <td>% to Ord. Value</td>
            </tr>
            <? if($zero_value==1) { ?>
                <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left">Gross FOB Value/ <? echo $costing_for; ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo $grfobv_dzn=fn_number_format($avg_unit_price*12,2) ; ?></td>
                    <td align="right">100.00%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: Commision/<? echo $costing_for; ?></td>
                    <td align="right"><? echo fn_number_format($commission,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo fn_number_format(($commission/$grfobv_dzn)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Net FOB Value (1-2)</td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? $net_fob_value=$grfobv_dzn-$commission; echo fn_number_format($net_fob_value,2); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">All Fabric Cost</td>
                    <td align="right"><? echo fn_number_format($fabric_cost,4); ?></td>
                    <td align="right" rowspan="13">&nbsp;</td>
                    <td align="right"><? echo fn_number_format($fabric_cost_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Trims Cost</td>
                    <td align="right"><? echo fn_number_format($trims_cost,4); ?></td>
                    <td align="right"><? echo fn_number_format($trims_cost_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Embellishment Cost</td>
                    <td align="right"><? echo fn_number_format($embel_cost,4); ?></td>
                    <td align="right"><? echo fn_number_format($embel_cost_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Gmts Wash</td>
                    <td align="right"><? echo fn_number_format($wash_cost,4); ?></td>
                    <td align="right"><? echo fn_number_format($wash_cost_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commercial Cost</td>
                    <td align="right"><? echo fn_number_format($comm_cost,4); ?></td>
                    <td align="right"><? echo fn_number_format($comm_cost_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo fn_number_format($lab_test,4); ?></td>
                    <td align="right"><? echo fn_number_format($lab_test_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($inspection,4); ?></td>
                    <td align="right"><? echo fn_number_format($inspection_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Gmts Freight Cost</td>
                    <td align="right"><? echo fn_number_format($freight,4); ?></td>
                    <td align="right"><? echo fn_number_format($freight_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Currier Cost</td>
                    <td align="right"><? echo fn_number_format($currier_pre_cost,4); ?></td>
                    <td align="right"><? echo fn_number_format($currier_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Certificate Cost </td>
                    <td align="right"><? echo fn_number_format($certificate_pre_cost,4); ?></td>
                    <td align="right"><? echo fn_number_format($certificate_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Deffd.Lc.Cost (<? echo fn_number_format($deffdlc_percent,2); ?>%)</td>
                    <td align="right"><? echo fn_number_format($deffdlc_cost,4); ?></td>
                    <td align="right"><? echo fn_number_format($deffdlc_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Tax (<? echo fn_number_format($incometax_percent,2); ?>%)</td>
                    <td align="right"><? echo fn_number_format($incometax_cost,4); ?></td>
                    <td align="right"><? echo fn_number_format($incometax_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Finance Charge (<? echo fn_number_format($interest_percent,2); ?>% )</td>
                    <td align="right"><? echo fn_number_format($interest_cost,4); ?></td>
                    <td align="right"><? echo fn_number_format($interest_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"><b>Total Material & Service Cost (4:16)</b></td>
                    <td>&nbsp;</td>
                    <td align="right"><b><?
                        $total_material_cost=$fabric_cost+$trims_cost+$embel_cost+$wash_cost+$comm_cost+$lab_test+$inspection+$freight+$currier_pre_cost+$certificate_pre_cost+$interest_cost+$incometax_cost+$deffdlc_cost;

                        $total_material_cost_percent=$fabric_cost_percent+$trims_cost_percent+$embel_cost_percent+$wash_cost_percent+$comm_cost_percent+$lab_test_percent+$inspection_percent+$freight_percent+$currier_percent+$certificate_percent+$interest_percent+$incometax_percent+$deffdlc_percent;

                        echo fn_number_format($total_material_cost,2); ?></b></td>
                    <td align="right"><b><? echo fn_number_format($total_material_cost_percent,2); ?>%</b></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Contribution Margin/<? echo $costing_for; ?> (3-17)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? $cm_value_contribution_margine=$net_fob_value-$total_material_cost; echo fn_number_format($cm_value_contribution_margine,2); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td><?  echo ++$sl; ?></td>
                    <td align="left">Factory Overhead (FOH)/<? echo $costing_for; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? $foh=$cm_cost; echo fn_number_format($foh,2); ?></td>
                    <td align="right"><? echo fn_number_format($cm_cost_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?> (18-19)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? $margin_dozon=$cm_value_contribution_margine-$foh; echo fn_number_format($margin_dozon,3); ?></td>
                    <td align="right"><b><? $margin_dzn_percent=($margin_dozon/$grfobv_dzn)*100; echo fn_number_format($margin_dzn_percent,2); ?>%</b></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $unit_of_measurement[$uom]; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? $margin_pcs=$margin_dozon/12; echo fn_number_format($margin_pcs,3); ?></td>
                    <td align="right"><? echo fn_number_format($margin_pcs/($grfobv_dzn/12)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">BOM Margin/<? echo $unit_of_measurement[$uom]; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($margin_pcs_bom,4); ?></td>
                    <td align="right"><? echo fn_number_format($margin_bom_per,2); ?>%</td>
                </tr>
                <tr bgcolor="#CCCCCC">
                    <td><? echo ++$sl; ?></td>
                    <td align="left">EPM (Per Pcs CM/SMV)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? $margin_pcs=fn_number_format(($cm_value_contribution_margine/12)/$pre_sew_smv,3); echo $margin_pcs; ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr bgcolor="#CCCCCC">
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CPM (Cost Per Minute)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format((($cpm/$exchange_rate)/$sew_effi_percent)*100,3); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr bgcolor="#CCCCCC">
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Contribution Margin %</td>
                    <td>&nbsp;</td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo fn_number_format($cm_value_contribution_margine/$net_fob_value*100,2); ?>%</td>
                </tr>
            <? } else { ?>
                <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left">Gross FOB Value/ <? echo $costing_for; ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo $grfobv_dzn=fn_number_format($avg_unit_price*12,4); ?></td>
                    <td align="right">100.00%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: Commision/ <? echo $costing_for; ?></td>
                    <td align="right"><? echo fn_number_format($commission,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo fn_number_format(($commission/$grfobv_dzn)*100,2);?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Net FOB Value (1-2)</td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo $net_fob_value=$grfobv_dzn-$commission; ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <?
                if($fabric_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">All Fabric Cost</td>
                        <td align="right"><? echo fn_number_format($fabric_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo fn_number_format($fabric_cost_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($trims_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Trims Cost</td>
                        <td align="right"><? echo fn_number_format($trims_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo fn_number_format($trims_cost_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($embel_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Embellishment Cost</td>
                        <td align="right"><? echo fn_number_format($embel_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo fn_number_format($embel_cost_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($wash_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Gmts Wash</td>
                        <td align="right"><? echo fn_number_format($wash_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo fn_number_format($wash_cost_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($comm_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Commercial Cost</td>
                        <td align="right"><? echo fn_number_format($comm_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo fn_number_format($comm_cost_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($commission!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Commission Cost</td>
                        <td align="right"><? echo fn_number_format($commission,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo fn_number_format($commission_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($lab_test!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Lab Test</td>
                        <td align="right"><? echo fn_number_format($lab_test,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo fn_number_format($lab_test_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($inspection!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Inspection Cost</td>
                        <td align="right"><? echo fn_number_format($inspection,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo fn_number_format($inspection_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($freight!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Gmts Freight Cost</td>
                        <td align="right"><? echo fn_number_format($freight,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo fn_number_format($freight_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($currier_pre_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Currier Cost</td>
                        <td align="right"><? echo fn_number_format($currier_pre_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="right"><? echo fn_number_format($currier_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($certificate_pre_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Certificate Cost</td>
                        <td align="right"><? echo fn_number_format($certificate_pre_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="right"><? echo fn_number_format($certificate_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($deffdlc_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Deffd.Lc.Cost (<? echo fn_number_format($deffdlc_percent,2); ?>%)</td>
                        <td align="right"><? echo fn_number_format($deffdlc_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="right"><? echo fn_number_format($deffdlc_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($incometax_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Tax (<? echo fn_number_format($incometax_percent,2); ?>%)</td>
                        <td align="right"><? echo fn_number_format($incometax_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="right"><? echo fn_number_format($incometax_percent,2); ?>%</td>
					</tr>
					<?
                }
                ?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Tax (<? echo fn_number_format($interest_percent,2); ?>%)</td>
                    <td align="right"><? echo fn_number_format($interest_cost,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo fn_number_format($interest_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"><b>Total Material & Service Cost (4:14)</b></td>
                    <td>&nbsp;</td>
                    <td align="right"><b><?
						$total_material_cost=($fabric_cost+$trims_cost+$embel_cost+$wash_cost+$comm_cost+$lab_test+$inspection+$freight+$currier_pre_cost+$certificate_pre_cost+$interest_cost+$incometax_cost+$deffdlc_cost);
						echo fn_number_format($total_material_cost,2); ?></b></td>
                    <td align="center"><b><?
						$total_material_cost_percent=$fabric_cost_percent+$trims_cost_percent+$embel_cost_percent+$wash_cost_percent+$comm_cost_percent+$lab_test_percent+$inspection_percent+$freight_percent+$currier_percent+$certificate_percent+$interest_percent+$incometax_percent+$deffdlc_percent;
						echo fn_number_format($total_material_cost_percent,2); ?>%</b></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Contribution Margin/<? echo $costing_for; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? $cm_value_contribution_margine=$price_dzn-$total_material_cost; echo fn_number_format($cm_value_contribution_margine,2); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>
                <?
                if($cm_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Factory Overhead (FOH)/<? echo $costing_for; ?></td>
                        <td>&nbsp;</td>
                        <td align="right"><? echo fn_number_format($cm_cost,2); ?></td>
                        <td align="center"><? echo fn_number_format($cm_cost_percent,2); ?>%</td>
					</tr>
					<?
                }
                ?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?> (16-17)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? $margin_dozon=$cm_value_contribution_margine-$foh;echo  fn_number_format($margin_dozon,2);?></td>
                    <td align="right"><b><? $margin_dzn_percent=($margin_dozon/$grfobv_dzn)*100; echo fn_number_format($margin_dzn_percent,2); ?>%</b></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $unit_of_measurement[$uom]; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($margin_pcs_set,2); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">BOM Margin/<? echo $unit_of_measurement[$uom]; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($margin_pcs_bom,4); ?></td>
                    <td align="right"><? echo fn_number_format($margin_bom_per,2); ?>%</td>
                </tr>
                <tr style="background:#CCCCCC;">
                    <td><? echo ++$sl; ?></td>
                    <td align="left">EPM (Per Pcs CM/SMV)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo $margin_pcs=fn_number_format(($cm_value_contribution_margine/12)/$sew_smv,3); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr style="background:#CCCCCC;">
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CPM (Cost Per Minute)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format((($cpm/$exchange_rate)/$sew_effi_percent)*100,3); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr style="background:#CCCCCC;">
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Contribution Margin %</td>
                    <td>&nbsp;</td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo fn_number_format($cm_value_contribution_margine/$net_fob_value*100,2); ?>%</td>
                </tr>
                <?
				}
				?>
            </table>
    </div>
	<?
    $sql_fab = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description, avg_cons, avg_cons_yarn, fabric_source, gsm_weight, rate, amount, avg_finish_cons, status_active from wo_pre_cost_fabric_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0";

    $sql_fab_res=sql_select($sql_fab);

	$i=2;$j=2;
	foreach( $sql_fab_res as $row )
	{
		if($row[csf("fab_nature_id")]==2)//knit fabrics
		{
			$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")].", ".$row[csf("gsm_weight")];
			if($row[csf("fabric_source")] !=2){
				$amount=$row[csf("avg_cons_yarn")]*$row[csf("rate")];
			}
			else{
				$amount=$row[csf("avg_cons")]*$row[csf("rate")];
			}
			$percent_to_order_value=$amount/$price_dzn*100;
			$i++;
			$knit_fab .= '<tr>
					<td align="left">'.$item_descrition.'</td>
					<td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
					<td align="right">'.fn_number_format($row[csf("avg_cons")],4).'</td>
					<td align="right">'.fn_number_format($row[csf("avg_cons_yarn")],4).'</td>
					<td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
					<td align="right">'.fn_number_format($amount,2).'</td>
					<td align="right">'.fn_number_format($percent_to_order_value,2).'%</td>
				</tr>';

			$knit_subtotal_avg_cons += $row[csf("avg_cons")];
			$knit_subtotal_avg_cons_yarn += $row[csf("avg_cons_yarn")];
			if($row[csf("fabric_source")] !=2){
				$knit_subtotal_amount += $row[csf("avg_cons_yarn")]*$row[csf("rate")];
			}
			else{
				$knit_subtotal_amount += $row[csf("avg_cons")]*$row[csf("rate")];
			}
		}

		if($row[csf("fab_nature_id")]==3)//woven fabrics
		{
			$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")].", ".$row[csf("gsm_weight")];
			$amount=$row[csf("avg_cons")]*$row[csf("rate")];
			$percent_to_order_value=$amount/$price_dzn*100;
			$j++;
			$woven_fab .= '<tr>
				<td align="left">'.$item_descrition.'</td>
				<td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
				<td align="right">'.fn_number_format($row[csf("avg_cons")],4).'</td>
				<td align="right">'.fn_number_format($row[csf("avg_cons_yarn")],4).'</td>
				<td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
				<td align="right">'.fn_number_format($amount,2).'</td>
				<td align="right">'.fn_number_format($percent_to_order_value,2).'%</td>
			</tr>';

			$woven_subtotal_avg_cons += $row[csf("avg_cons")];
			$woven_subtotal_avg_cons_yarn += $row[csf("avg_cons_yarn")];
			$woven_subtotal_amount += $row[csf("avg_cons")]*$row[csf("rate")];
		}
	}
	unset($sql_fab_res);
	$knit_fab= '<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
					<label><b>All Fabric Cost  </b></label>
						<tr style="font-weight:bold"  align="center">
							<td width="80" rowspan="'.$i.'" ><div class="verticalText"><b>Knit Fabric</b></div></td>
							<td width="350">Description</td>
							<td width="100">Source</td>
							<td width="100">Fab. Cons/PCS</td>
							<td width="100">Avg. Fab. Cons/PCS</td>
							<td width="100">Rate (USD)</td>
							<td width="100">Amount (USD)</td>
							<td width="100">% to Ord. Value</td>
						</tr>'.$knit_fab;
	$woven_fab= '<tr><td colspan="7">&nbsp;</td></tr><tr>
					<td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;
	//knit fabrics table here
	$fab_knit_req_kg_avg_amount=$knit_subtotal_amount/$knit_subtotal_avg_cons*$fab_knit_req_kg_avg;
	$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2" align="left">Sub Total</td>
					<td align="right">'.fn_number_format($knit_subtotal_avg_cons,4).'</td>
					<td align="right">'.fn_number_format($knit_subtotal_avg_cons_yarn,4).'</td>
					<td></td>
					<td align="right">'.fn_number_format($knit_subtotal_amount,2).'</td>
					<td align="right">'.fn_number_format($knit_subtotal_amount/$price_dzn*100,2).'%</td>
				</tr>';
				if($zero_value==1) echo $knit_fab;
				else
				{
					if($row[csf("avg_cons")]>0) echo $knit_fab; else echo "";
				}

	//woven fabrics table here
	$fab_woven_req_yds_avg_amount=$woven_subtotal_amount/$woven_subtotal_avg_cons*$fab_woven_req_yds_avg;
	$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2" align="left">Sub Total</td>
					<td align="right">'.fn_number_format($woven_subtotal_avg_cons,4).'</td>
					<td align="right">'.fn_number_format($woven_subtotal_avg_cons_yarn,4).'</td>
					<td></td>
					<td align="right">'.fn_number_format($woven_subtotal_amount,2).'</td>
					<td align="right">'.fn_number_format($woven_subtotal_amount/$price_dzn*100,2).'%</td>
				</tr>';

	$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
		<td colspan="4" align="left">Total</td>
		<td align="right"></td>
		<td></td>
		<td align="right">'.fn_number_format(($woven_subtotal_amount+$knit_subtotal_amount),2).'</td>
		<td align="right">'.fn_number_format((($woven_subtotal_amount+$knit_subtotal_amount)/$price_dzn*100),2).'%</td>
	</tr></table></div>';

	if($zero_value==1) echo $woven_fab;
	else
	{
		if($row[csf("avg_cons")]>0) echo $woven_fab; else echo "";
	}
	$grand_total_amount = $knit_subtotal_amount+$woven_subtotal_amount;

	$lib_yarn_count=return_library_array( "select yarn_count, id from lib_yarn_count", "id", "yarn_count"  );

	$sql_yarn = "select min(id) as id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, color, type_id, min(cons_ratio) as cons_ratio, sum(cons_qnty) as cons_qnty, sum(avg_cons_qnty) as avg_cons_qnty, rate, sum(amount) as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0 group by count_id, copm_one_id, percent_one, copm_two_id, percent_two,color, type_id, rate";
	$sql_yarn_res=sql_select($sql_yarn);

	if($zero_value==1)
	{
		?>
		<div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="70" rowspan="<? echo count($sql_yarn_res)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
                    <td width="350">Yarn Desc</td>
                    <td width="100">Yarn Qnty</td>
                    <td width="100">Avg.Yarn Qnty</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td>% to Ord. Value</td>
                </tr>
                <?
                $total_qnty=0; $total_avg_qnty=0; $total_amount=0;
                foreach( $sql_yarn_res as $row )
                {
					if($row[csf("percent_one")]==100)
						$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
					else
						$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];

					?>
					<tr>
                        <td align="left"><? echo $item_descrition; ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("cons_qnty")],4); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("avg_cons_qnty")],4); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("amount")],2); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
					</tr>
					<?
					$total_qnty += $row[csf("cons_qnty")];
					$total_avg_qnty += $row[csf("avg_cons_qnty")];
					$total_amount += $row[csf("amount")];
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_qnty,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_avg_qnty,4); ?></td>
                    <td></td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
		</div>
		<?
		$grand_total_amount +=$total_amount;
	}
	else
	{
		if($fabric_cost>0)
		{
			?>
			<div style="margin-top:15px">
                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                    <tr style="font-weight:bold">
                        <td width="70" rowspan="<? echo count($sql_yarn_res)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
                        <td width="350">Yarn Desc</td>
                        <td width="100">Yarn Qnty</td>
                        <td width="100">Avg.Yarn Qnty</td>
                        <td width="100">Rate (USD)</td>
                        <td width="100">Amount (USD)</td>
                        <td>% to Ord. Value</td>
                    </tr>
                    <?
                    $total_qnty=0;$total_amount=0;
                    foreach( $sql_yarn_res as $row )
                    {
						if($row[csf("percent_one")]==100)
							$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
						else
							$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];

						?>
						<tr>
                            <td align="left"><? echo $item_descrition; ?></td>
                            <td align="right"><? echo fn_number_format($row[csf("cons_qnty")],4); ?></td>
                            <td align="right"><? echo fn_number_format($row[csf("avg_cons_qnty")],4); ?></td>
                            <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                            <td align="right"><? echo fn_number_format($row[csf("amount")],2); ?></td>
                            <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
						</tr>
						<?
						$total_qnty += $row[csf("cons_qnty")];
						$total_avg_qnty += $row[csf("avg_cons_qnty")];
						$total_amount += $row[csf("amount")];
                    }
                    ?>
                    <tr class="rpt_bottom" style="font-weight:bold">
                        <td>Total</td>
                        <td align="right"><? echo fn_number_format($total_qnty,4); ?></td>
                        <td align="right"><? echo fn_number_format($total_avg_qnty,4); ?></td>
                        <td></td>
                        <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                        <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                    </tr>
                </table>
			</div>
			<?
			$grand_total_amount +=$total_amount;
		}
		else
		{
			echo "";
		}
	}
	unset($sql_yarn_res);
	//End Yarn Cost part report here -------------------------------------------
	//start	Conversion Cost to Fabric report here -------------------------------------------
   	$sql_conv = "select a.id, a.fabric_description as fabric_description_id, a.job_no, a.cons_process, a.req_qnty, a.avg_req_qnty, a.charge_unit, a.amount, a.status_active, b.body_part_id, b.fab_nature_id, b.color_type_id, b.fabric_description from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id where a.job_no='$job_no' and b.status_active=1 and b.is_deleted=0 ";
	$sql_conv_res=sql_select($sql_conv);
	$conData=array();
	$totPro=array();
	foreach($sql_conv_res as $rows){
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['fabric_description_id']=$rows[csf('fabric_description_id')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['job_no']=$rows[csf('job_no')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['cons_process']=$rows[csf('cons_process')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['req_qnty']=$rows[csf('req_qnty')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['avg_req_qnty']=$rows[csf('avg_req_qnty')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['charge_unit']=$rows[csf('charge_unit')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['amount']=$rows[csf('amount')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['status_active']=$rows[csf('status_active')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['body_part_id']=$rows[csf('body_part_id')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['fab_nature_id']=$rows[csf('fab_nature_id')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['color_type_id']=$rows[csf('color_type_id')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['fabric_description']=$rows[csf('fabric_description')];
		$totPro[$rows[csf('cons_process')]]=$rows[csf('cons_process')];
	}
	//unset($sql_conv_res);
	if($zero_value==1)
	{
		?>
        <div style="margin-top:15px">
        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <tr style="font-weight:bold">
                <td width="80" rowspan="<? echo count($sql_conv_res)+3+count($totPro); ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                <td width="350">Particulars</td>
                <td width="100">Process</td>
                <td width="100">Cons/PCS</td>
                <td width="100">Avg. Cons/PCS</td>
                <td width="100">Rate (USD)</td>
                <td width="100">Amount (USD)</td>
                <td>% to Ord. Value</td>
            </tr>
            <?
            $total_amount=0;
            $total_req_qnty=0;
            $total_avg_req_qnty=0;
            $total_charge_unit=0;
            foreach( $conData as $processId=>$idArr )
            {
				$sub_total_amount=0;
				$sub_total_req_qnty=0;
				$sub_total_avg_req_qnty=0;
				$sub_total_charge_unit=0;
				foreach( $idArr as $id=>$row )
				{
					if($row['fabric_description_id']!=0)
					{
						$item_descrition = $body_part[$row["body_part_id"]].", ".$color_type[$row["color_type_id"]].", ".$row["fabric_description"];
					}
					else
					{
						$item_descrition = "All Fabrics";
					}
					?>
					<tr>
                        <td align="left"><? echo $item_descrition; ?></td>
                        <td align="left"><? echo $conversion_cost_head_array[$row["cons_process"]]; ?></td>
                        <td align="right"><? echo fn_number_format($row["req_qnty"],4); ?></td>
                        <td align="right"><? echo fn_number_format($row["avg_req_qnty"],4); ?></td>
                        <td align="right"><? echo fn_number_format($row["charge_unit"],4); ?></td>
                        <td align="right"><? echo fn_number_format($row["amount"],2); ?></td>
                        <td align="right"><? echo fn_number_format($row["amount"]/$price_dzn*100,2); ?>%</td>
					</tr>
					<?
					$sub_total_amount+= $row["amount"];
					$sub_total_req_qnty+= $row["req_qnty"];
					$sub_total_avg_req_qnty+= $row["avg_req_qnty"];
					$sub_total_charge_unit+= $row["charge_unit"];

					$total_amount += $row["amount"];
					$total_req_qnty+= $row["req_qnty"];
					$total_avg_req_qnty+= $row["avg_req_qnty"];
					$total_charge_unit+= $row["charge_unit"];
				}
				?>
				<tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Sub Total</td>
                    <td align="right"><? echo  fn_number_format( $sub_total_req_qnty,4);?></td>
                    <td align="right"><? echo fn_number_format($sub_total_avg_req_qnty,4); ?></td>
                    <td align="right"><? //echo  fn_number_format($sub_total_charge_unit,4);?></td>
                    <td align="right"><? echo fn_number_format($sub_total_amount,2); ?></td>
                    <td align="right"><? echo  fn_number_format($sub_total_amount/$price_dzn*100,2);?>%</td>
				</tr>
				<?
            }
            ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="2">Conversion Total Cost</td>
                <td align="right"><? //echo fn_number_format($total_req_qnty,4);?></td>
                <td align="right"><? //echo fn_number_format($total_avg_req_qnty,4); ?></td>
                <td align="right"><? //echo fn_number_format($total_charge_unit,4);?></td>
                <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2);?>%</td>
            </tr>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td align="left" colspan="5">Total Fabric Cost</td>
                <td align="right"><? echo fn_number_format(($grand_total_amount+$total_amount),2); ?></td>
                <td align="right"><? echo fn_number_format((($grand_total_amount+$total_amount)/$price_dzn*100),2); ?>%</td>
            </tr>
        </table>
        </div>
        <?
	}
	else
	{
		if($fabric_cost>0)
		{
			?>
			<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($sql_conv_res)+3+count($totPro); ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Cons/PCS</td>
                    <td width="100">Avg. Cons/PCS</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td>% to Ord. Value</td>
                </tr>
                <?
                $total_amount=0;
                $total_req_qnty=0;
                $total_avg_req_qnty=0;
                $total_charge_unit=0;
                foreach( $conData as $processId=>$idArr )
                {
					$sub_total_amount=0;
					$sub_total_req_qnty=0;
					$sub_total_avg_req_qnty=0;
					$sub_total_charge_unit=0;
					foreach( $idArr as $id=>$row )
					{
						if($row["fabric_description_id"] !=0)
						{
							$item_descrition = $body_part[$row["body_part_id"]].", ".$color_type[$row["color_type_id"]].", ".$row["fabric_description"];
						}
						else
						{
							$item_descrition = "All Fabrics";
						}
						?>
						<tr>
                            <td align="left"><? echo $item_descrition; ?></td>
                            <td align="left"><? echo $conversion_cost_head_array[$row["cons_process"]]; ?></td>
                            <td align="right"><? echo fn_number_format($row["req_qnty"],4); ?></td>
                            <td align="right"><? echo fn_number_format($row["avg_req_qnty"],4); ?></td>
                            <td align="right"><? echo fn_number_format($row["charge_unit"],4); ?></td>
                            <td align="right"><? echo fn_number_format($row["amount"],2); ?></td>
                            <td align="right"><? echo fn_number_format($row["amount"]/$price_dzn*100,2); ?>%</td>
						</tr>
						<?
						$sub_total_amount+= $row["amount"];
						$sub_total_req_qnty+= $row["req_qnty"];
						$sub_total_avg_req_qnty+= $row["avg_req_qnty"];
						$sub_total_charge_unit+= $row["charge_unit"];

						$total_amount += $row["amount"];
						$total_req_qnty+= $row["req_qnty"];
						$total_avg_req_qnty+= $row["avg_req_qnty"];
						$total_charge_unit+= $row["charge_unit"];
					}
					?>
                    <tr class="rpt_bottom" style="font-weight:bold">
                        <td colspan="2">Sub Total</td>
                        <td align="right"><? echo  fn_number_format( $sub_total_req_qnty,4);?></td>
                        <td align="right"><? echo fn_number_format($sub_total_avg_req_qnty,4); ?></td>
                        <td align="right"><? //echo  fn_number_format($sub_total_charge_unit,4);?></td>
                        <td align="right"><? echo fn_number_format($sub_total_amount,2); ?></td>
                        <td align="right"><? echo  fn_number_format($sub_total_amount/$price_dzn*100,2);?>%</td>
                    </tr>
                    <?
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? //echo fn_number_format($total_req_qnty,4);?></td>
                    <td align="right"><? //echo fn_number_format($total_avg_req_qnty,4); ?></td>
                    <td align="right"><? //echo fn_number_format($total_charge_unit,4);?></td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2);?>%</td>
                </tr>
                    <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="5">Total Fabric Cost</td>
                    <td align="right"><? echo fn_number_format(($grand_total_amount+$total_amount),2); ?></td>
                    <td align="right"><? echo fn_number_format((($grand_total_amount+$total_amount)/$price_dzn*100),2); ?>%</td>
                </tr>
			</table>
			</div>
			<?
		}
		else
		{
			echo "";
		}
	}
	unset($sql_conv_res);
	//End Conversion Cost to Fabric report here -------------------------------------------
	//start	Trims Cost part report here -------------------------------------------
	$trim_group=return_library_array( "select item_name,id from  lib_item_group", "id", "item_name");
   	$sql_trim = "select id, job_no, trim_group, description, brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp, status_active from wo_pre_cost_trim_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0 ";
	$sql_trim_res=sql_select($sql_trim);
	if($zero_value==1)
	{
		?>
		<div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/PCS</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td>% to Ord. Value</td>
                </tr>
                <?
                $total_amount=0;
                foreach( $sql_trim_res as $row )
                {
					?>
					<tr>
                        <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                        <td align="left"><? echo $row[csf("description")]; ?></td>
                        <td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                        <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("amount")],2); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
					</tr>
					<?
					$total_amount += $row[csf("amount")];
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="6">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
		</div>
		<?
	}
	else
	{
		if($trims_cost>0)
		{
			?>
			<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/PCS</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
                <?
                $total_amount=0;
                foreach( $sql_trim_res as $row )
                {
					?>
					<tr>
                        <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                        <td align="left"><? echo $row[csf("description")]; ?></td>
                        <td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                        <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("amount")],2); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                    </tr>
                    <?
                    $total_amount += $row[csf("amount")];
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="6">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
			</div>
			<?
		}
		else
		{
			echo "";
		}
	}
	unset($sql_trim_res);
	//End Trims Cost Part report here -------------------------------------------
	//start	Embellishment Details part report here -------------------------------------------
    $sql_emb = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount, status_active from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0 and emb_name !=3";
	$sql_emb_res=sql_select($sql_emb);
	if($zero_value==1)
	{
		?>
		<div style="margin-top:15px">
		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
		<label><b>Embellishment Details</b></label>
            <tr style="font-weight:bold">
                <td width="150">Particulars</td>
                <td width="150">Type</td>
                <td width="150">Cons/PCS</td>
                <td width="100">Rate (USD)</td>
                <td width="100">Amount (USD)</td>
                <td>% to Ord. Value</td>
            </tr>
            <?
            $total_amount=0;
            foreach( $sql_emb_res as $row )
            {
				$em_type ='';
				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
				if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==99)$em_type = $emblishment_other_type_arr[$row[csf("emb_type")]];
				?>
				<tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],2); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
				</tr>
				<?
				$total_amount += $row[csf("amount")];
            }
            ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="4">Total</td>
                <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
            </tr>
		</table>
		</div>
		<?
	}
	else
	{
		if($embel_cost>0)
		{
			?>
			<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
			<label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/PCS</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td>% to Ord. Value</td>
                </tr>
                <?
                $total_amount=0;
                foreach( $sql_emb_res as $row )
                {
					$em_type ="";
					//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
					if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
					else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
					else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
					else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
					else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
					else if($row[csf("emb_name")]==99)$em_type = $emblishment_other_type_arr[$row[csf("emb_type")]];
					?>
					<tr>
                        <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                        <td align="left"><? echo $em_type; ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("amount")],2); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
					</tr>
					<?
					$total_amount += $row[csf("amount")];
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
			</table>
			</div>
			<?
		}
		else
		{
			echo "";
		}
	}
	unset($sql_emb_res);
	//End Embellishment Details Part report here -------------------------------------------
	//start	Commercial Cost part report here -------------------------------------------
   	$sql_commarcial = "select id, job_no, item_id, rate, amount, status_active from  wo_pre_cost_comarci_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0 ";
	$sql_commarcial_res=sql_select($sql_commarcial);
	if($zero_value==1)
	{
		?>
        <div style="margin-top:15px">
        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
        <label><b>Commercial Cost</b></label>
            <tr style="font-weight:bold">
                <td width="250">Particulars</td>
                <td width="100">Rate In %</td>
                <td width="100">Amount (USD)</td>
                <td>% to Ord. Value</td>
            </tr>
            <?
            $total_amount=0;
            foreach( $sql_commarcial_res as $row )
            {
				?>
				<tr>
                    <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],2); ?></td>
                    <td align="right"><? $ccp=($row[csf("amount")]/$grfobv_dzn)*100; echo fn_number_format($ccp,2); ?>%</td>
				</tr>
				<?
				$total_amount += $row[csf("amount")];
				$tot_ccp+=$ccp;
            }
            ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="2">Total</td>
                <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                <td align="right"><? echo fn_number_format($tot_ccp,2); ?></td>
            </tr>
        </table>
        </div>
        <?
	}
	else
	{
		if($comm_cost>0)
		{
			?>
			<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
			<label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="250">Particulars</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td>% to Ord. Value</td>
                </tr>
                <?
                $total_amount=0;
                foreach( $sql_commarcial_res as $row )
                {
					?>
					<tr>
                        <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("amount")],2); ?></td>
                        <td align="right"><? $ccp=($row[csf("amount")]/$grfobv_dzn)*100; echo fn_number_format($ccp,2);?>%</td>
					</tr>
					<?
					$total_amount += $row[csf("amount")];
					$tot_ccp+=$ccp;
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($tot_ccp,2); ?></td>
                </tr>
			</table>
			</div>
			<?
		}
		else
		{
			echo "";
		}
	}
	unset($sql_commarcial_res);
	//End Commercial Cost Part report here -------------------------------------------
	//start	Commission Cost part report here -------------------------------------------
   	$sql_commission = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0";
	$sql_commission_res=sql_select($sql_commission);
	if($zero_value==1)
	{
		?>
		<div style="margin-top:15px">
		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
		<label><b>Commission Cost</b></label>
            <tr style="font-weight:bold">
                <td width="150">Particulars</td>
                <td width="150">Commission Basis</td>
                <td width="100">Rate (USD)</td>
                <td width="100">Amount (USD)</td>
                <td>% to Ord. Value</td>
            </tr>
            <?
            $total_amount=0;
            foreach( $sql_commission_res as $row )
            {
				?>
				<tr>
                    <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commision_rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commission_amount")],2); ?></td>
                    <td align="right"><? $cca=($row[csf("commission_amount")]/$grfobv_dzn)*100; echo fn_number_format($cca,2); ?>%</td>
				</tr>
				<?
				$total_amount += $row[csf("commission_amount")];
				$total_cca += $cca;
            }
            ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="3">Total</td>
                <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                <td align="right"><? echo fn_number_format($total_cca,2); ?></td>
            </tr>
		</table>
		</div>
		<?
	}
	else
	{
		if($commission>0)
		{
			?>
			<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
			<label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
                <?
                $total_amount=0;
                foreach( $sql_commission_res as $row )
                {
					?>
					<tr>
                        <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                        <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                        <td align="right"><? echo fn_number_format($row[csf("commision_rate")],4); ?></td>

                        <td align="right"><? echo fn_number_format($row[csf("commission_amount")],2); ?></td>
                        <td align="right"><? $cca=($row[csf("commission_amount")]/$grfobv_dzn)*100; echo fn_number_format($cca,2); ?>%</td>
					</tr>
					<?
					$total_amount += $row[csf("commission_amount")];
					$total_cca += $cca;
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_cca,2); ?></td>
                </tr>
			</table>
			</div>
			<?
		}
		else
		{
		   echo "";
		}
	}
	unset($sql_commission_res);
	//End Commission Cost Part report here -------------------------------------------
	//start	Other Components part report here -------------------------------------------

	if($zero_value==1)
	{
		?>
		<div style="margin-top:15px">
		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
		<label><b>Others Components</b></label>
            <tr style="font-weight:bold">
                <td width="250">Particulars</td>
                <td width="100">Amount (USD)</td>
                <td width="100">% to Ord. Value</td>
            </tr>
            <tr>
                <td align="left"s>Gmts Wash</td>
                <td align="right"><? echo fn_number_format($wash_cost,2); ?></td>
                <td align="right"><? $ogw=($wash_cost/$grfobv_dzn)*100; echo fn_number_format($ogw,2); ?>%</td>
            </tr>
            <tr>
                <td align="left"s>Lab Test </td>
                <td align="right"><? echo fn_number_format($lab_test,2); ?></td>
                <td align="right"><? $olt=($lab_test/$grfobv_dzn)*100; echo fn_number_format($olt,2); ?>%</td>
            </tr>
            <tr>
                <td align="left">Inspection Cost</td>
                <td align="right"><? echo fn_number_format($inspection,2); ?></td>
                <td align="right"><? $oic=($inspection/$grfobv_dzn)*100; echo fn_number_format($oic,2); ?>%</td>
            </tr>
            <tr>
                <td align="left">Factory Overhead (FOH)/<? echo $costing_for; ?></td>
                <td align="right"><? echo fn_number_format($cm_cost,2); ?></td>
                <td align="right"><? $ofoh=($cm_cost/$grfobv_dzn)*100; echo fn_number_format($ofoh,2); ?>%</td>
            </tr>
            <tr>
                <td align="left">Gmts Freight Cost</td>
                <td align="right"><? echo fn_number_format($freight,2); ?></td>
                <td align="right"><? $ogfc=($freight/$grfobv_dzn)*100; echo fn_number_format($ogfc,2); ?>%</td>
            </tr>
            <tr>
                <td align="left">Currier Cost</td>
                <td align="right"><? echo fn_number_format($currier_pre_cost,2); ?></td>
                <td align="right"><? $ocrc=($currier_pre_cost/$grfobv_dzn)*100; echo fn_number_format($ocrc,2); ?>%</td>
            </tr>
            <tr>
                <td align="left">Certificate Cost</td>
                <td align="right"><? echo fn_number_format($certificate_pre_cost,2); ?></td>
                <td align="right"><? $ocfc=($certificate_pre_cost/$grfobv_dzn)*100; echo fn_number_format($ocfc,2); ?>%</td>
            </tr>
            <tr>
                <td align="left">Deffd.Lc.Cost Charge (<? echo fn_number_format($deffdlc_percent,2); ?>%)</td>
                <td align="right"><? echo fn_number_format($deffdlc_cost,2); ?></td>
                <td align="right"><? echo fn_number_format($deffdlc_percent,2); ?>%</td>
            </tr>
            <tr>
                <td align="left">Finance Charge (<? echo fn_number_format($interest_percent,2); ?>%)</td>
                <td align="right"><? echo fn_number_format($interest_cost,2); ?></td>
                <td align="right"><? echo fn_number_format($interest_percent,2); ?>%</td>

            </tr>
            <tr>
                <td align="left">Tax(<? echo fn_number_format($incometax_percent,2); ?>%)</td>
                <td align="right"><? echo fn_number_format($incometax_cost,2); ?></td>
                <td align="right"><? echo fn_number_format($incometax_percent,2); ?>%</td>
            </tr>
				<?
                	$total_amount += $wash_cost+$lab_test+$inspection+($cm_cost)+$freight+$currier_pre_cost+$certificate_pre_cost+$deffdlc_cost+$interest_cost+$incometax_cost;
                	$total_parcent += $ogw+$olt+$oic+$ofoh+$ogfc+$ocrc+$ocfc+$deffdlc_percent+$interest_percent+$incometax_percent;
                ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td>Total</td>
                <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                <td align="right"><? echo fn_number_format($total_parcent,2);?>%</td>
            </tr>
		</table>
		</div>
		<?
	}
	else
	{
		if($lab_test>0 || $inspection>0 || $cm_cost>0 || $freight>0 || $common_oh>0)
		{
			?>
			<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
			<label><b>Others Components</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
                <?
                if($wash_cost>0)
                {
					?>
					<tr>
                        <td align="left"s>Gmts Wash</td>
                        <td align="right"><? echo fn_number_format($wash_cost,2); ?></td>
                        <td align="right"><? $ogw=($wash_cost/$grfobv_dzn)*100; echo fn_number_format($ogw,2); ?>%</td>
					</tr>
					<?
                }
                if($lab_test>0)
                {
                ?>
                <tr>
                    <td align="left"s>Lab Test </td>
                    <td align="right"><? echo fn_number_format($lab_test,2); ?></td>
                    <td align="right"><? $olt=($lab_test/$grfobv_dzn)*100; echo fn_number_format($olt,2); ?>%</td>
                </tr>
                <?
                }
                if($inspection>0)
                {
					?>
					<tr>
                        <td align="left">Inspection Cost</td>
                        <td align="right"><? echo fn_number_format($inspection,2); ?></td>
                        <td align="right"><? $oic=($inspection/$grfobv_dzn)*100; echo fn_number_format($oic,2); ?>%</td>
					</tr>
					<?
                }
                if($cm_cost>0)
                {
					?>
					<tr>
                        <td align="left">Factory Overhead (FOH)/<? echo $costing_for; ?></td>
                        <td align="right"><? echo fn_number_format($cm_cost,2); ?></td>
                        <td align="right"><? $ofoh=($cm_cost/$grfobv_dzn)*100; echo fn_number_format($ofoh,2); ?>%</td>
					</tr>
					<?
                }
                if($freight>0)
                {
					?>
					<tr>
                        <td align="left">Gmts Freight Cost</td>
                        <td align="right"><? echo fn_number_format($freight,2); ?></td>
                        <td align="right"><? $ogfc=($freight/$grfobv_dzn)*100; echo fn_number_format($ogfc,2); ?>%</td>
					</tr>
					<?
                }
                if($currier_pre_cost>0)
                {
					?>
					<tr>
                        <td align="left">Currier Cost</td>
                        <td align="right"><? echo fn_number_format($currier_pre_cost,2); ?></td>
                        <td align="right"><? $ocrc=($currier_pre_cost/$grfobv_dzn)*100; echo fn_number_format($ocrc,2); ?>%</td>
					</tr>
					<?
                }
                if($certificate_pre_cost>0)
                {
					?>
					<tr>
                        <td align="left">Certificate Cost</td>
                        <td align="right"><? echo fn_number_format($certificate_pre_cost,2); ?></td>
                        <td align="right"><? $ocfc=($certificate_pre_cost/$grfobv_dzn)*100; echo fn_number_format($ocfc,2); ?>%</td>
					</tr>
					<?
                }
                if($common_oh>0)
                {
					?>
					<?
                }
                if($deffdlc_cost>0)
                {
					?>
					<tr>
                        <td align="left">Deffd.Lc.Cost Charge (<? echo fn_number_format($deffdlc_percent,2); ?>%)</td>
                        <td align="right"><? echo fn_number_format($deffdlc_cost,2); ?></td>
                        <td align="right"><? echo fn_number_format($deffdlc_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($interest_cost>0)
                {
					?>
					<tr>
                        <td align="left">Finance Charge (<? echo fn_number_format($interest_percent,2); ?>%)</td>
                        <td align="right"><? echo fn_number_format($interest_cost,2); ?></td>
                        <td align="right"><? echo fn_number_format($interest_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($incometax_cost>0)
                {
					?>
					<tr>
                        <td align="left">Tax(<? echo fn_number_format($incometax_percent,2); ?>%)</td>
                        <td align="right"><? echo fn_number_format($incometax_cost,2); ?></td>
                        <td align="right"><? echo fn_number_format($incometax_percent,2); ?>%</td>
					</tr>
					<?
                }
                $total_amount += $wash_cost+$lab_test+$inspection+$cm_cost+$freight+$currier_pre_cost+$certificate_pre_cost+$deffdlc_cost+$interest_cost+$incometax_cost;
                $total_parcent += $ogw+$olt+$oic+$ofoh+$ogfc+$ocrc+$ocfc+$deffdlc_percent+$interest_percent+$incometax_percent;

                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,2); ?></td>
                    <td align="right"><? echo fn_number_format($total_parcent,2);?>%</td>
                </tr>
			</table>
			</div>
			<?
		}
		else
		{
			echo "";
		}
	}
	//End Other Components  Part report here -------------------------------------------
	//start	CM on Net Order Value part report here -------------------------------------------
	$order_net_value = 0;
	?>
    <div style="margin-top:15px">
    <div style="float:left">
        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
        <label><b>CM on Net Order Value</b></label>
            <tr style="font-weight:bold">
                <td width="150">Particulars</td>
                <td width="100">Amount (USD)</td>
                <td width="100">%</td>
            </tr>
            <tr>
                <td align="left">Order Value </td>
                <td align="right"><? echo fn_number_format($order_value,2); ?></td>
                <td align="right">&nbsp;</td>
            </tr>
            <tr>
                <td align="left">Less Commission </td>
                <td align="right"><? $less_commission = $commission/$order_price_per_dzn*$job_qty; echo fn_number_format($less_commission,2); ?></td>
                <td align="right">&nbsp;</td>
            </tr>
            <tr>
                <td align="left">Less Commercial Cost </td>
                <td align="right"><? $less_commercial = $comm_cost/$order_price_per_dzn*$job_qty; echo fn_number_format($less_commercial,2); ?></td>
                <td align="right">&nbsp;</td>
            </tr>
            <tr>
                <td align="left">Less Freight</td>
                <td align="right"><? $less_freight = $freight/$order_price_per_dzn*$job_qty; echo fn_number_format($less_freight,2); ?></td>
                <td align="right">&nbsp;</td>
            </tr>
            <tr>
                <td align="left">Net Order Value</td>
                <td align="right"><? $order_net_value=$order_value-($less_commission+$less_commercial+$less_freight);echo fn_number_format($order_net_value,2); ?></td>
                <td align="right"><? echo fn_number_format($order_net_value/$order_net_value*100,2); ?></td>
            </tr>
            <tr>
                <td align="left">Other Cost</td>
                <td align="right"><? $otherCost=$others_cost_value/$order_price_per_dzn*$job_qty; echo fn_number_format($otherCost,2); ?></td>
                <td align="right"><? echo fn_number_format($otherCost/$order_net_value*100,2); ?></td>
            </tr>
            <tr>
                <td align="left">CM(Contribution Margin)</td>
                <td align="right"><? $cmValue = $order_net_value-$otherCost; echo fn_number_format($cmValue,2); ?></td>
                <td align="right"><? echo fn_number_format($cmValue/$order_net_value*100,2); ?></td>
            </tr>
            <tr>
                <td align="left">CM /<? echo $costing_for; ?></td>
                <td align="right"><? $cmPerDzn=$cmValue/$job_qty*$order_price_per_dzn; echo fn_number_format($cmPerDzn,4); ?></td>
                <td align="center"></td>
            </tr>
            <tr>
                <td align="left">FOH/<? echo $costing_for; ?></td>
                <td align="right"><? echo fn_number_format($cm_cost,2); ?></td>
                <td align="center">&nbsp;</td>
            </tr>
            <tr>
                <td align="left">Margin /<? echo $costing_for; ?></td>
                <td align="right"><? echo fn_number_format($cmPerDzn-$cm_cost,2); ?></td>
                <td align="center">&nbsp;</td>
            </tr>
        </table>
  </div>
  <div style="margin-left:5px;float:left;">
        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
        <label><b>Cost Summary for order quantity</b></label>
            <tr style="font-weight:bold">
                <td width="150">Particulars</td>
                <td width="100">Amount (USD)</td>
                <td width="100">%</td>
            </tr>
            <tr>
                <td align="left">Total Order Value </td>
                <td align="right"><? $total_order_val = $job_qty*$avg_unit_price; echo fn_number_format($total_order_val,2); ?></td>
                <td align="right"><? echo fn_number_format($total_order_val/$total_order_val*100,2); ?></td>
            </tr>
             <tr>
                <td align="left">Total Cost </td>
                <td align="right"><?  $total_cost = $total_cost/$order_price_per_dzn*$job_qty; echo fn_number_format($total_cost,2); ?></td>
                <td align="right"><? echo fn_number_format($total_cost/$total_order_val*100,2); ?></td>
            </tr>
             <tr>
                <td align="left">Margin </td>
                <td align="right"><? $margin_val = $total_order_val-$total_cost; echo fn_number_format($margin_val,2); ?></td>
                <td align="right"><? echo fn_number_format($margin_val/$total_order_val*100,2); ?></td>
            </tr>
             <tr>
                <td align="left">Margin /<? echo $costing_for; ?> </td>
                <td align="right"><? echo fn_number_format($margin_val/$job_qty*$order_price_per_dzn,2); ?></td>
                <td align="right">&nbsp;</td>
            </tr>
       </table>
    </div>
        <div style="clear:both"></div>
    </div>
    <?
    echo "<br /><b>Note: Other Cost = Fabric Cost + Trims Cost + Embellishment Cost + Gmts Wash + Lab Test + Inspection + Currier Cost + <br />Certificate Cost + Finance Charge+ Deffd.Lc.Cost+Tax</b>";

    $user_sql = "select a.id, a.user_full_name, b.custom_designation from user_passwd a, lib_designation b where a.valid=1 and b.id=a.designation";

    $user_data_array=sql_select($user_sql);
    foreach($user_data_array as $row){
        $user_arr[$row[csf(id)]]=$row[csf(user_full_name)].'<br><span style="font-size:10px;">('.$row[csf(custom_designation)].')</span>';
    }
    unset($user_data_array);

	$sql="select bypass, buyer_id, sequence_no, user_id FROM electronic_approval_setup where company_id='$company_name' and FIND_IN_SET(buyer_id, $buyer_id)>0 and page_id=869 and is_deleted=0 order by sequence_no asc";
	$data_array=sql_select($sql);
	foreach($data_array as $row){
		$electronic_data[$row[csf(sequence_no)]] = $row[csf(user_id)];
		$user_wise_sequence[$row[csf(user_id)]] = $row[csf(sequence_no)];
	}
	unset($data_array);
	$startSequence = min($user_wise_sequence);
	$endSequence = max($user_wise_sequence);

	$sql="select min(b.current_approval_status) as cstatus, b.approved_by, b.mst_id FROM co_com_pre_costing_approval b where b.job_no='$job_no' and b.approved_by not in (".$electronic_data[$endSequence].") group by b.mst_id,b.approved_by";

	$data_array=sql_select($sql);
	foreach($data_array as $row){
		if($row[csf(cstatus)]!=0){$check_app_data[$row[csf(approved_by)]] = $row[csf(approved_by)];}
		$mst_id = $row[csf(mst_id)];//for Higher Auth Check;
		$higher_auth_id = $row[csf(approved_by)];//for Higher Auth Check;
	}
	unset($data_array);


	$sql="select min(b.current_approval_status) as cstatus, b.approved_by FROM co_com_pre_costing_approval b where b.job_no='$job_no' and b.approved_by in (".$electronic_data[$endSequence].") group by b.approved_by";

	$data_array=sql_select($sql);
	foreach($data_array as $row){
		if($row[csf(cstatus)]!=0){$last_app_data = $row[csf(approved_by)];}
	}
	unset($data_array);

//---------------------------------------------Higher Auth Check;
	$app_history_data=return_library_array( "select sequence_no, approved_by from approval_history where mst_id=$mst_id and entry_form=46",'sequence_no','approved_by');

	if(count($check_app_data)==1 && (!in_array($higher_auth_id,$app_history_data))){
		$last_app_data=$app_history_data[$endSequence];
		$check_app_data=array();
		foreach($app_history_data as $sec=>$user){
			if($sec!=$endSequence){$check_app_data[$user] =$user;}
		}
		$align='center';
	}
	else
	{
		$higher_auth_id	=0;
		$align='right';
	}
	//--------------------------------------------------------
	?>
    <br /><br />
	<table class="rpt_table" border="0" cellpadding="1" cellspacing="1" style="text-align:center;" rules="all" width="850">
		<tr>
        	<td style="border:none; line-height:13px;" align="left"><? echo $user_arr[$prepared_app_data]; ?></td>
            <?
			foreach($check_app_data as $check_user){
				echo '<td style="border:none; line-height:13px;" align="center">'.$user_arr[$check_user].'</td>';
			}
			?>
            <td style="border:none; line-height:13px;" align="<? echo $align;?>"><? echo $user_arr[$last_app_data]; ?></td>
       		<?
			if($higher_auth_id!=0){
				echo '<td style="border:none; line-height:13px;" align="right">'.$user_arr[$higher_auth_id].'</td>';
			}
			?>

        </tr>
		<tr style="alignment-baseline:baseline;">
        	<td width="" style="text-decoration:overline; border:none" align="left">Prepared By</td>
            <?
			foreach($check_app_data as $check_user){
				echo '<td width="" style="text-decoration:overline; border:none" align="center">Checked By</td>';
			}
			?>
            <td width="" style="text-decoration:overline; border:none" align="<? echo $align;?>">Approved By</td>
       		<?
			if($higher_auth_id!=0){
				echo '<td width="" style="text-decoration:overline; border:none" align="right">Unapproved/Approved</td>';
			}
			?>
        </tr>
    </table>
 	<?
	exit();
}

if($action=="checkListRpt")//BOM Dtls BTN 12
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and c.costing_date='".$txt_costing_date."'";
	$txt_po_breack_down_id=str_replace("'",'',$txt_po_breack_down_id);
	if(str_replace("'",'',$txt_po_breack_down_id)=="")
	{
		$txt_po_breack_down_id_cond='';
		$txt_po_breack_down_id_cond1='';
		$txt_po_breack_down_id_cond2='';
		$txt_po_breack_down_id_cond3='';
	}
	else
	{
		$txt_po_breack_down_id_cond=" and b.id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond1=" and id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond2=" and po_break_down_id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond3=" and b.id in(".$txt_po_breack_down_id.")";
	}

	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$supplier_name_arr=return_library_array( "select id, supplier_name from  lib_supplier",'id','supplier_name');
	$color_library=return_library_array("select id,color_name from lib_color where status_active=1 and is_deleted=0","id","color_name");


	$result =sql_select("select id,po_number,pub_shipment_date,po_received_date,file_no,grouping from wo_po_break_down where job_no_mst=$txt_job_no $txt_po_breack_down_id_cond1 and status_active=1 and is_deleted=0 order by pub_shipment_date DESC");
	$job_in_orders = array();
	$pulich_ship_date='';$po_received_date='';
	$job_in_ref = array();
	$job_in_file = array();
	foreach ($result as $val){
		$job_in_orders[$val[csf('id')]]= $val[csf('po_number')];
		$pulich_ship_date = $val[csf('pub_shipment_date')];
		$job_in_ref[$val[csf('id')]]= $val[csf('grouping')];
	    $job_in_file[$val[csf('id')]]= $val[csf('file_no')];
		if($po_received_date=='') $po_received_date = change_date_format($val[csf('po_received_date')]);else $po_received_date.=",".change_date_format($val[csf('po_received_date')]);
	}
	$ref_cond=implode(",",array_unique($job_in_ref));
	$po_received_dates=implode(",",array_unique(explode(",",$po_received_date)));
	$file_con=implode(",",$job_in_file);
	$job_in_orders=implode(", ",$job_in_orders);

	$gmtsitem_ratio_array=array();
	$grmnt_items = "";
    $grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no=$txt_job_no");
	foreach($grmts_sql as $key=>$val)
	{
		$grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].",";
		$gmtsitem_ratio_array[$val[csf('job_no')]][$val[csf('gmts_item_id')]]=$val[csf('set_item_ratio')];
	}
	$grmnt_items = rtrim($grmnt_items,",");

	if($db_type==0){
	   $sql = "select a.job_no, a.company_name, a.buyer_name, a.style_ref_no, a.quotation_id, a.ship_mode, a.gmts_item_id, a.order_uom, a.avg_unit_price, a.order_repeat_no, a.repeat_job_no, sum(b.plan_cut) as job_quantity, sum(b.po_quantity) as ord_qty, c.costing_date, c.costing_per, c.budget_minute, c.approved, d.fab_knit_req_kg, d.fab_woven_req_yds, d.fab_yarn_req_kg from wo_po_details_master a, wo_po_break_down b, wo_pre_cost_mst c left join wo_pre_cost_sum_dtls d on   c.job_no=d.job_no and d.status_active=1 and d.is_deleted=0 where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no  and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref $txt_costing_date group by a.job_no, a.company_name, a.buyer_name, a.style_ref_no, a.quotation_id, a.ship_mode, a.gmts_item_id, a.order_uom, a.avg_unit_price, a.order_repeat_no, a.repeat_job_no, c.costing_date, c.costing_per, c.approved, c.budget_minute, d.fab_knit_req_kg, d.fab_woven_req_yds, d.fab_yarn_req_kg order by a.job_no";
	}
	if($db_type==2){
	    $sql = "select a.job_no, a.company_name, a.buyer_name, a.style_ref_no, a.quotation_id, a.ship_mode, a.gmts_item_id, a.order_uom, a.avg_unit_price, a.order_repeat_no, a.repeat_job_no, sum(b.plan_cut) as job_quantity, sum(b.po_quantity) as ord_qty, c.costing_date, c.costing_per, c.budget_minute, c.approved, d.fab_knit_req_kg, d.fab_woven_req_yds, d.fab_yarn_req_kg from wo_po_details_master a,wo_po_break_down b, wo_pre_cost_mst c left join  wo_pre_cost_sum_dtls d on  c.job_no=d.job_no and d.status_active=1 and d.is_deleted=0 where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no  and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref group by a.job_no, a.company_name, a.buyer_name, a.style_ref_no, a.quotation_id, a.gmts_item_id, a.order_uom, a.ship_mode, a.avg_unit_price, a.order_repeat_no, a.repeat_job_no, c.costing_date, c.costing_per, c.approved, c.budget_minute, d.fab_knit_req_kg, d.fab_woven_req_yds, d.fab_yarn_req_kg order by a.job_no";
	}
	$data_array=sql_select($sql);
	?>
    <div style="width:852px; margin:0 auto">
    <div style="width:850px; font-size:20px; font-weight:bold" align="center"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></div>
    <div style="width:850px; font-size:14px; font-weight:bold" align="center">BOM Details</div>
	<?

	$order_job_qnty=0;
	$ord_qty=0;
	$avg_unit_price=0;
	$order_values=0;
	$order_price_per_dzn=0;
	$costing_for='';
	foreach ($data_array as $row){
	    $order_job_qnty=$row[csf("job_quantity")];
		$ord_qty=$row[csf("ord_qty")];
		$avg_unit_price=$row[csf("avg_unit_price")];
		$order_values = $row[csf("job_quantity")]*$row[csf("avg_unit_price")];

		if($row[csf("costing_per")]==1){$order_price_per_dzn=12;$costing_for=" DZN";}
		else if($row[csf("costing_per")]==2){$order_price_per_dzn=1;$costing_for=" PCS";}
		else if($row[csf("costing_per")]==3){$order_price_per_dzn=24;$costing_for=" 2 DZN";}
		else if($row[csf("costing_per")]==4){$order_price_per_dzn=36;$costing_for=" 3 DZN";}
		else if($row[csf("costing_per")]==5){$order_price_per_dzn=48;$costing_for=" 4 DZN";}
		?>
        <div style="font-family:'Arial Narrow';">
        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
            <tr>
                <td width="80">Job Number</td>
                <td width="80"><b><? echo $row[csf("job_no")]; ?></b></td>
                <td width="90">Buyer</td>
                <td width="100"><b><? echo $buyer_arr[$row[csf("buyer_name")]]; ?></b></td>
                <td width="80">Plan Cut Qnty</td>
                <td width="100"><b><? echo $row[csf("job_quantity")]." ".$unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
            </tr>
            <tr>
                <td>Order Qty</td>
                <td><b><? echo $row[csf("ord_qty")]." ".$unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
                <td>Style Ref. No</td>
                <td><b><? echo $row[csf("style_ref_no")]; ?></b></td>
                <td>Price Per Unit</td>
                <td><b><? echo $row[csf("avg_unit_price")]; ?></b></td>
            </tr>
            <tr>
                <td>Order Numbers</td>
                <td colspan="5"><? echo $job_in_orders; ?></td>
                </tr>
                <tr>
                <td>Garments Item</td>
                <td colspan="3"><b><? echo $grmnt_items; ?></b></td>
                <td>Shipment Date</td>
                <td><b><? echo change_date_format($pulich_ship_date); ?></b></td>
            </tr>
            <tr>
                <td>Budget Minute</td>
                <td><b><? echo $row[csf("budget_minute")] ?> </b></td>
                <td align="center" height="10" colspan="2" valign="top" id="app_sms" style="font-size:18px;">
                <font color="#FF0000"><? if( $row[csf("approved")]==1){echo "This Job is Approved ";} else {echo "";} ?></font>
                </td>
                  <td>PO Recv. Date</td>
                <td><b><? echo $po_received_dates; ?> </b></td>

            </tr>
            <tr>
                <td>Internal Ref</td>
                <td colspan="2"><b><? echo ltrim($ref_cond,", "); ?></b></td>
                <td>File No</td>
                <td colspan="2"><b><? echo $file_cond; ?></b></td>
            </tr>
             <tr>
                <td>Costing Date</td>
                <td><b><? echo change_date_format($row[csf("costing_date")]); ?></b></td>
                <td>Ship Mode</td>
                <td><b><? echo $shipment_mode[$row[csf("ship_mode")]]; ?></b></td>
                <td>Quotation ID</td>
                <td><b><? echo $row[csf("quotation_id")]; ?></b></td>
            </tr>
            <tr>
                <td colspan="3">Order Repeat No, Order Repeat Job No</td>
                <td colspan="3"><b>
                	<?
                		if($row[csf("repeat_job_no")] !="")
                		{
                			$repeat_job_no=	" , ".$row[csf("repeat_job_no")];
                		}
                		else
                		{
							$repeat_job_no="";
                		}
                		echo $row[csf("order_repeat_no")].$repeat_job_no;

                	?>
                </b></td>

            </tr>
        </table>
            <?
	}//end first foearch

	//2 Fabric Cost part here-------------------------------------------
	$condition= new condition();
	if(str_replace("'","",$txt_job_no) !=''){
		$condition->job_no("=$txt_job_no");
	}
	$txt_po_breack_down_id=str_replace("'",'',$txt_po_breack_down_id);
	if(str_replace("'",'',$txt_po_breack_down_id) !="")
	{
		$condition->po_id("in($txt_po_breack_down_id)");
	}
	$condition->init();
	$fabric= new fabric($condition);
	$fabric_qty=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$fabric_amount=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$yarn= new yarn($condition);
	$conversion= new conversion($condition);
	$trim= new trims($condition);
	$emblishment= new emblishment($condition);
	$wash= new wash($condition);


	$sql = "select id, job_no,item_number_id, body_part_id,gsm_weight, fab_nature_id, color_type_id, fabric_description, avg_cons,uom, fabric_source, rate, amount, avg_finish_cons, status_active from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);

		$knit_fab="";
		$knit_subtotal_amount=0;
		$knit_subtotal_amount_dzn=0;

		$woven_fab="";
		$woven_subtotal_amount=0;
		$woven_subtotal_amount_dzn=0;

        $i=5;$j=2;
		foreach( $data_array as $row ){
			$uom=$unit_of_measurement[$row[csf("uom")]];
			$knit_cost_dzn=$row[csf("amount")];
			$woven_cost_dzn=$row[csf("amount")];
			//knit fabrics=============
			$gsm_weight='';
			if($row[csf("fab_nature_id")]==2){
				$gsm_weight.=$row[csf("gsm_weight")].',';
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")].", ".$gsm_weight;
				$fincons=$fabric_qty['knit']['finish'][$row[csf("id")]][$row[csf("uom")]];
			    $greycons=$fabric_qty['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$amount=$fabric_amount['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];

 				$i++;
                $knit_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.number_format($greycons,4).'</td>
 					<td align="right">'.number_format($fincons,4).'</td>
					<td align="left">'.$uom.'</td>
                    <td align="right">'.number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.number_format($amount,4).'</td>
                </tr>';
				if($row[csf("uom")]==12){
					$knit_subtotal_avg_cons+=$greycons;
					$knit_subtotal_avg_finish_cons+=$fincons;
					$knit_subtotal_amount+=$amount;
					$knit_subtotal_amount_dzn+=$knit_cost_dzn;
				}
				else if($row[csf("uom")]==27){
					$knit_subtotal_avg_cons_yds+=$greycons;
					$knit_subtotal_avg_finish_cons_yds+=$fincons;
					$knit_subtotal_amount_yds+=$amount;
					$knit_subtotal_amount_dzn_yds+=$knit_cost_dzn;
				}
				else if($row[csf("uom")]==1){
					$knit_subtotal_avg_cons_pcs+=$greycons;
					$knit_subtotal_avg_finish_cons_pcs+=$fincons;
					$knit_subtotal_amount_pcs+=$amount;
					$knit_subtotal_amount_dzn_pcs+=$knit_cost_dzn;
				}
				else if($row[csf("uom")]==23){
					$knit_subtotal_avg_cons_mtr+=$greycons;
					$knit_subtotal_avg_finish_cons_mtr+=$fincons;
					$knit_subtotal_amount_mtr+=$amount;
					$knit_subtotal_amount_dzn_mtr+=$knit_cost_dzn;
				}
			}
			//woven fabrics======================
			$gsm_weights='';
			if($row[csf("fab_nature_id")]==3){
				$fincons=$fabric_qty['woven']['finish'][$row[csf("id")]][$row[csf("uom")]];
			    $greycons=$fabric_qty['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$amount=$fabric_amount['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$gsm_weights.=$row[csf("gsm_weight")].',';
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")].", ".$gsm_weights;
				$j++;
                 $woven_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.number_format($greycons,4).'</td>
 					<td align="right">'.number_format($fincons,4).'</td>
					<td align="left">'.$uom.'</td>
                    <td align="right">'.number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.number_format($amount,4).'</td>
                </tr>';
				$woven_subtotal_avg_cons+=$greycons;
				$woven_subtotal_avg_finish_cons+=$fincons;
				$woven_subtotal_amount+=$amount;
				$woven_subtotal_amount_dzn+=$woven_cost_dzn;
			}
        }

	 	if(0>=$knit_subtotal_avg_finish_cons) $i=$i-1;
		if(0>=$knit_subtotal_avg_finish_cons_yds) $i=$i-1;
		if(0>=$knit_subtotal_avg_finish_cons_pcs) $i=$i-1;
		if(0>=$knit_subtotal_avg_finish_cons_mtr) $i=$i-1;

		//$woven_subtotal_avg_finish_cons
		$knit_fab= '<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
						<tr style="font-weight:bold"  align="center">
							<td width="80" rowspan="'.$i.'" ><div class="verticalText"><b>Knit Fabric</b></div></td>
							<td width="300">Description</td>
							<td width="100">Source</td>
							<td width="100">Gray Fabric Qnty</td>
							<td width="100">Finish Fab Qnty</td>
							<td width="50">UOM</td>
 							<td width="50">Rate</td>
							<td width="50">Amount</td>
						</tr>'.$knit_fab;
		$woven_fab = '<tr><td colspan="8">&nbsp;</td></tr><tr>
						<td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;

		//knit fabrics table here
		if($knit_subtotal_avg_finish_cons>0)
		{
			$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
							<td colspan="2">Total (kg)</td>
							<td align="right">'.number_format($knit_subtotal_avg_cons,4).'</td>
							<td align="right">'.number_format($knit_subtotal_avg_finish_cons,4).'</td>
							<td align="right"></td>
							<td align="right">'.number_format($knit_subtotal_amount/$knit_subtotal_avg_cons,4).'</td>
							<td align="right">'.number_format($knit_subtotal_amount,4).'</td>
						</tr>';
		}

		if($knit_subtotal_avg_finish_cons_yds>0)
		{
			$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
							<td colspan="2">Total (Yds)</td>
							<td align="right">'.number_format($knit_subtotal_avg_cons_yds,4).'</td>
							<td align="right">'.number_format($knit_subtotal_avg_finish_cons_yds,4).'</td>
							<td align="right"></td>
							<td align="right">'.number_format($knit_subtotal_amount_yds/$knit_subtotal_avg_cons_yds,4).'</td>
							<td align="right">'.number_format($knit_subtotal_amount_yds,4).'</td>
						</tr>';
		}
		if($knit_subtotal_avg_finish_cons_pcs>0)
		{
			$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
							<td colspan="2">Total (Pcs)</td>
							<td align="right">'.number_format($knit_subtotal_avg_cons_pcs,4).'</td>
							<td align="right">'.number_format($knit_subtotal_avg_finish_cons_pcs,4).'</td>
							<td align="right"></td>
							<td align="right">'.number_format($knit_subtotal_amount_pcs/$knit_subtotal_avg_cons_pcs,4).'</td>
							<td align="right">'.number_format($knit_subtotal_amount_pcs,4).'</td>
						</tr>';
		}
		if($knit_subtotal_avg_finish_cons_mtr>0)
		{
			$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
							<td colspan="2">Total (Mtr)</td>
							<td align="right">'.number_format($knit_subtotal_avg_cons_mtr,4).'</td>
							<td align="right">'.number_format($knit_subtotal_avg_finish_cons_mtr,4).'</td>
							<td align="right"></td>
							<td align="right">'.number_format($knit_subtotal_amount_mtr/$knit_subtotal_avg_cons_mtr,4).'</td>
							<td align="right">'.number_format($knit_subtotal_amount_mtr,4).'</td>
						</tr>';
		}
  		echo $knit_fab;

		//woven fabrics table here

		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2">Total</td>
						<td align="right">'.number_format($woven_subtotal_avg_cons,4).'</td>
						<td align="right">'.number_format($woven_subtotal_avg_finish_cons,4).'</td>
						<td align="right">'.number_format($woven_subtotal_amount/$woven_subtotal_avg_cons,4).'</td>
						<td align="right"></td>
						<td align="right">'.number_format($woven_subtotal_amount,4).'</td>
					</tr>
   					</table></div>';
        echo $woven_fab;

		//end 	All Fabric Cost part report-------------------------------------------

		//Start	Yarn Cost part report here -------------------------------------------
		$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
		$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count");
		$sql = "select min(id) as id, count_id, copm_one_id, percent_one,  color,type_id, min(cons_ratio) as cons_ratio, sum(cons_qnty) as cons_qnty, rate, sum(amount) as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no=".$txt_job_no." group by count_id, copm_one_id, percent_one,  color,type_id, rate";
		$data_array=sql_select($sql);
		?>
        <div style="margin-top:15px">
        	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="70" rowspan="<? echo count($data_array)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
                    <td width="350">Yarn Desc</td>
                    <td width="100">Yarn Qnty</td>
                    <td width="100">Avg.Yarn Qnty</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                </tr>
			<?
			$total_yarn_qty = 0;
            $total_yarn_amount = 0; $total_yarn_cost_dzn=0; $total_yarn_cost_kg=0; $total_yarn_avg_cons_qty=0;
			foreach( $data_array as $row )
            {
				$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
				$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
				$rowavgcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
				$rowamount = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];
			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="right"><? echo number_format($rowcons_qnty,4); ?></td>
                    <td align="right"><? echo number_format($rowavgcons_qnty,4); ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo number_format($rowamount,4); ?></td>
                </tr>
            <?
			      $total_yarn_qty+=$rowcons_qnty;
				  $total_avg_yarn_qty+=$rowavgcons_qnty;
				  $total_yarn_amount +=$rowamount;
				  $total_yarn_cost_dzn+=$row[csf("amount")];
				  $total_yarn_avg_cons_qty+=$rowavgcons_qnty;
				  $total_yarn_cost_kg=$total_yarn_amount/$total_yarn_qty;
            }
            ?>
            	<tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo number_format($total_yarn_qty,4); ?></td>
                    <td align="right"><? echo number_format($total_avg_yarn_qty,4); ?></td>
                    <td></td>
                    <td align="right"><? echo number_format($total_yarn_amount,4); ?></td>
                </tr>
        	</table>
      </div>
      <?

	//End Yarn Cost part report here -------------------------------------------

	//start	Conversion Cost to Fabric report here -------------------------------------------
    $conv_data['conv_qnty']=$conversion->getQtyArray_by_conversionid();
	$conv_data['conv_amount']=$conversion->getAmountArray_by_conversionid();
	$sql_count = "select a.cons_process as cons_process, b.uom from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id where a.job_no=".$txt_job_no." group by a.cons_process, b.uom order by  a.cons_process";
	$tot_data_array=sql_select($sql_count); $uom_arr=array();
	foreach( $tot_data_array as $row ){
			 $process_id=$row[csf("cons_process")];
			 $process_row+=count($row[csf("cons_process")]);
			 $uom_arr[$row[csf("uom")]]=$row[csf("uom")];
	 }
	 $sql = "select a.id,a.fabric_description as pre_cost_fabric_cost_dtls_id, a.job_no, a.cons_process, a.req_qnty, a.charge_unit,a.amount,a.color_break_down, a.status_active,b.body_part_id,b.fab_nature_id,b.color_type_id,b.fabric_description,b.item_number_id,b.uom from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id where a.job_no=".$txt_job_no." order by  a.cons_process";
	 $data_array=sql_select($sql);


 	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($data_array)+(count($uom_arr))+($process_row*count($uom_arr))+1; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Required</td>
                    <td width="100">UOM</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                </tr>
            <?
            $total_conversion_cost=0;
			$total_conversion_cost_dzn=0;
			$total_conversion_cost_kg=0;
			$total_convsion_qty=0;
			$total_avg_convsion_qty=0;
			$grand_total_conv_qnty=0;
			$grand_total_avg_convsion_qty=0;
			$grand_total_conversion_cost=0;

			$total_conversion_cost_yds=0;
			$total_conversion_cost_dzn_yds=0;
			$total_conversion_cost_kg_yds=0;
			$total_convsion_qty_yds=0;
			$total_avg_convsion_qty_yds=0;
			$grand_total_conv_qnty_yds=0;
			$grand_total_avg_convsion_qty_yds=0;
			$grand_total_conversion_cost_yds=0;

			$process_array_check=array();
			$k=1;
            foreach( $data_array as $row )
            {
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				$process_id=$row[csf("cons_process")];
				if (!in_array($process_id,$process_array_check) ){
					if($k!=1){
						if($total_convsion_qty>0)
						{
						?>
					    <tr>
							<td>&nbsp;</td>
							<td><strong>Sub. Total (Kg): </strong></td>
							<td align="right"><strong><? echo number_format($total_convsion_qty,4); ?></strong></td>
							<td align="right"><strong><? //echo number_format($total_avg_convsion_qty,4); ?></strong></td>
							<td>&nbsp;</td>
							<td align="right"><strong><? echo number_format($total_conversion_cost,4); ?></strong></td>
						</tr>
                        <? }
						if($total_convsion_qty_yds>0) { ?>
                        <tr>
							<td>&nbsp;</td>
							<td><strong>Sub. Total (Yds): </strong></td>
							<td align="right"><strong><? echo number_format($total_convsion_qty_yds,4); ?></strong></td>
							<td align="right"><strong><? //echo number_format($total_avg_convsion_qty,4); ?></strong></td>
							<td>&nbsp;</td>
							<td align="right"><strong><? echo number_format($total_conversion_cost_yds,4); ?></strong></td>
						</tr>
                        <? }
						if($total_convsion_qty_pcs>0) { ?>
                        <tr>
							<td>&nbsp;</td>
							<td><strong>Sub. Total (Pcs): </strong></td>
							<td align="right"><strong><? echo number_format($total_convsion_qty_pcs,4); ?></strong></td>
							<td align="right"><strong><? //echo number_format($total_avg_convsion_qty,4); ?></strong></td>
							<td>&nbsp;</td>
							<td align="right"><strong><? echo number_format($total_conversion_cost_pcs,4); ?></strong></td>
						</tr>
                        <? }
						if($total_convsion_qty_mtr>0) { ?>
                        <tr>
							<td>&nbsp;</td>
							<td><strong>Sub. Total (Mtr): </strong></td>
							<td align="right"><strong><? echo number_format($total_convsion_qty_mtr,4); ?></strong></td>
							<td align="right"><strong><? //echo number_format($total_avg_convsion_qty,4); ?></strong></td>
							<td>&nbsp;</td>
							<td align="right"><strong><? echo number_format($total_conversion_cost_mtr,4); ?></strong></td>
						</tr>
						<?
						}
					}
					unset($total_convsion_qty);
					unset($total_avg_convsion_qty);
					unset($total_conversion_cost);
					unset($total_convsion_qty_yds);
					unset($total_avg_convsion_qty_yds);
					unset($total_conversion_cost_yds);

					unset($total_convsion_qty_pcs);
					unset($total_avg_convsion_qty_pcs);
					unset($total_conversion_cost_pcs);
					unset($total_convsion_qty_mtr);
					unset($total_avg_convsion_qty_mtr);
					unset($total_conversion_cost_mtr);
					$process_array_check[]=$process_id;
					$k++;
				}
			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>

                    <td align="left"><? echo $conversion_cost_head_array[$row[csf("cons_process")]]; ?></td>
                    <td align="right"><? echo number_format($conv_data['conv_qnty'][$row[csf('id')]][$row[csf('uom')]],4); ?></td>
                    <td align=""><? echo $unit_of_measurement[$row[csf("uom")]]; //number_format($conv_data['conv_qnty'][$row[csf('id')]][$row[csf('uom')]],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("charge_unit")],4); ?></td>
                    <td align="right"><? echo number_format($conv_data['conv_amount'][$row[csf('id')]][$row[csf('uom')]],4); ?></td>
                </tr>
            <?
			if($row[csf('uom')]==12){
				$total_convsion_qty+=$conv_data['conv_qnty'][$row[csf('id')]][$row[csf('uom')]];
				$total_conversion_cost += $conv_data['conv_amount'][$row[csf('id')]][$row[csf('uom')]];

				$grand_total_conv_qnty+=$conv_data['conv_qnty'][$row[csf('id')]][$row[csf('uom')]];
				$grand_total_conversion_cost+= $conv_data['conv_amount'][$row[csf('id')]][$row[csf('uom')]];

				$total_conversion_cost_dzn+=$row[csf('amount')];
				$total_conversion_cost_kg=$grand_total_conversion_cost/$total_avg_yarn_qty;
			}
			if($row[csf('uom')]==27){
				$total_convsion_qty_yds+=$conv_data['conv_qnty'][$row[csf('id')]][$row[csf('uom')]];
				$total_conversion_cost_yds += $conv_data['conv_amount'][$row[csf('id')]][$row[csf('uom')]];

				$grand_total_conv_qnty_yds+=$conv_data['conv_qnty'][$row[csf('id')]][$row[csf('uom')]];
				$grand_total_conversion_cost_yds+= $conv_data['conv_amount'][$row[csf('id')]][$row[csf('uom')]];

				$total_conversion_cost_dzn_yds+=$row[csf('amount')];
				$total_conversion_cost_kg_yds=$grand_total_conversion_cost_yds/$total_avg_yarn_qty_yds;
			}
			if($row[csf('uom')]==1){
				$total_convsion_qty_pcs+=$conv_data['conv_qnty'][$row[csf('id')]][$row[csf('uom')]];
				$total_conversion_cost_pcs += $conv_data['conv_amount'][$row[csf('id')]][$row[csf('uom')]];

				$grand_total_conv_qnty_pcs+=$conv_data['conv_qnty'][$row[csf('id')]][$row[csf('uom')]];
				$grand_total_conversion_cost_yds+= $conv_data['conv_amount'][$row[csf('id')]][$row[csf('uom')]];

				$total_conversion_cost_dzn_pcs+=$row[csf('amount')];
				$total_conversion_cost_kg_pcs=$grand_total_conversion_cost_pcs/$total_avg_yarn_qty_pcs;
			}
			if($row[csf('uom')]==23){
				$total_convsion_qty_mtr+=$conv_data['conv_qnty'][$row[csf('id')]][$row[csf('uom')]];
				$total_conversion_cost_mtr += $conv_data['conv_amount'][$row[csf('id')]][$row[csf('uom')]];

				$grand_total_conv_qnty_mtr+=$conv_data['conv_qnty'][$row[csf('id')]][$row[csf('uom')]];
				$grand_total_conversion_cost_mtr+= $conv_data['conv_amount'][$row[csf('id')]][$row[csf('uom')]];

				$total_conversion_cost_dzn_mtr+=$row[csf('amount')];
				$total_conversion_cost_kg_mtr=$grand_total_conversion_cost_pcs/$total_avg_yarn_qty_mtr;
			}
            }
			if($total_convsion_qty>0)
			{
				?>
				<tr class="rpt_bottom" style="font-weight:bold">
					<td>&nbsp;</td>
					<td align="right">Sub. Total (Kg)</td>
					<td align="right"><? echo number_format($total_convsion_qty,4); ?></td>
					<td align="right"><? // echo number_format($total_avg_convsion_qty,4); ?></td>
					<td>&nbsp;</td>
					<td align="right"><? echo number_format($total_conversion_cost,4); ?></td>
				</tr>
            <? }
            if($total_convsion_qty_yds>0)
			{ ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td>&nbsp;</td>
                <td align="right">Sub. Total (Yds)</td>
                <td align="right"><? echo number_format($total_convsion_qty_yds,4); ?></td>
                <td align="right"><? // echo number_format($total_avg_convsion_qty,4); ?></td>
                <td>&nbsp;</td>
                <td align="right"><? echo number_format($total_conversion_cost_yds,4); ?></td>
            </tr>
             <? }
            if($total_convsion_qty_pcs>0)
			{ ?>
           <tr class="rpt_bottom" style="font-weight:bold">
                <td>&nbsp;</td>
                <td align="right">Sub. Total (Pcs)</td>
                <td align="right"><? echo number_format($total_convsion_qty_pcs,4); ?></td>
                <td align="right"><? // echo number_format($total_avg_convsion_qty,4); ?></td>
                <td>&nbsp;</td>
                <td align="right"><? echo number_format($total_conversion_cost_pcs,4); ?></td>
            </tr>
            <? }
            if($total_convsion_qty_mtr>0)
			{ ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td>&nbsp;</td>
                <td align="right">Sub. Total (Mtr)</td>
                <td align="right"><? echo number_format($total_convsion_qty_mtr,4); ?></td>
                <td align="right"><? // echo number_format($total_avg_convsion_qty,4); ?></td>
                <td>&nbsp;</td>
                <td align="right"><? echo number_format($total_conversion_cost_mtr,4); ?></td>
            </tr>
            <? }
            if($grand_total_conv_qnty>0)
			{ ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="2" align="right">Grand Total(Kg)</td>
                <td align="right"><? echo number_format($grand_total_conv_qnty,4); ?></td>
                <td align="right"><? //echo number_format($grand_total_avg_convsion_qty,4); ?></td>
                <td>&nbsp;</td>
                <td align="right"><? echo number_format($grand_total_conversion_cost,4); ?></td>
            </tr>
            <? }
            if($grand_total_conv_qnty_yds>0)
			{ ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="2" align="right">Grand Total (Yds)</td>
                <td align="right"><? echo number_format($grand_total_conv_qnty_yds,4); ?></td>
                <td align="right"><? //echo number_format($grand_total_avg_convsion_qty,4); ?></td>
                <td>&nbsp;</td>
                <td align="right"><? echo number_format($grand_total_conversion_cost_yds,4); ?></td>
            </tr>
             <? }
            if($grand_total_conv_qnty_pcs>0)
			{ ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="2" align="right">Grand Total (Pcs)</td>
                <td align="right"><? echo number_format($grand_total_conv_qnty_pcs,4); ?></td>
                <td align="right"><? //echo number_format($grand_total_avg_convsion_qty,4); ?></td>
                <td>&nbsp;</td>
                <td align="right"><? echo number_format($grand_total_conversion_cost_pcs,4); ?></td>
            </tr>
            <? }
            if($grand_total_conv_qnty_mtr>0)
			{ ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="2" align="right">Grand Total (Mtr)</td>
                <td align="right"><? echo number_format($grand_total_conv_qnty_mtr,4); ?></td>
                <td align="right"><? //echo number_format($grand_total_avg_convsion_qty,4); ?></td>
                <td>&nbsp;</td>
                <td align="right"><? echo number_format($grand_total_conversion_cost_mtr,4); ?></td>
            </tr>
            <? } ?>
            </table>
      </div>
      <?
	//End Conversion Cost to Fabric report here -----------------------------------



	//start	Trims Cost part report here -------------------------------------------

	$sql ="select b.id as po, a.job_quantity,d.id, d.job_no, d.trim_group,d.description,d.nominated_supp, d.cons_uom, d.cons_dzn_gmts, d.rate as avgrate,d.amount,d.remark,e.excess_per,a.total_set_qnty ,e.cons,e.tot_cons,e.wo_pre_cost_trim_cost_dtls_id from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_trim_cost_dtls d, wo_pre_cost_trim_co_cons_dtls e where a.job_no =".$txt_job_no." and a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no and b.id=c.po_break_down_id and b.id=e.po_break_down_id and d.id=e.wo_pre_cost_trim_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and c.item_number_id= e.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.size_number_id and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 group by a.job_quantity,d.id, d.job_no, d.trim_group,d.description,d.nominated_supp, d.cons_uom, d.cons_dzn_gmts,  d.amount,d.remark,e.excess_per,a.total_set_qnty ,e.cons,e.tot_cons,e.wo_pre_cost_trim_cost_dtls_id,d.rate,b.id order by a.job_quantity,d.id, d.job_no, d.trim_group,d.description,d.nominated_supp, d.cons_uom, d.cons_dzn_gmts,  d.amount,d.remark,e.excess_per,a.total_set_qnty ,e.cons,e.tot_cons,e.wo_pre_cost_trim_cost_dtls_id";


	$item_size_sql=sql_select( "select b.job_no_mst,b.size_number_id,b.order_quantity from wo_po_color_size_breakdown b where b.job_no_mst=".$txt_job_no." group by b.size_number_id,b.job_no_mst,b.order_quantity");
	$item_size_array=array();
	$lib_size=return_library_array( "select size_name,id from lib_size", "id", "size_name");
	foreach($item_size_sql as $row)
	{

		$item_size_array[$row[csf("job_no_mst")]].=$row[csf("size_number_id")].",";
	}

	$rate_size_sql=sql_select("select wo_pre_cost_trim_cost_dtls_id,job_no,size_number_id,rate from wo_pre_cost_trim_co_cons_dtls where job_no=".$txt_job_no."");

	$rate_size_array=array();
	foreach($rate_size_sql as $row)
	{

		$rate_size_array[$row[csf("wo_pre_cost_trim_cost_dtls_id")]][$row[csf("size_number_id")]]=$row[csf("size_number_id")].'='.$row[csf("rate")];
	}

    	$sql = "select id, job_no, trim_group,description,brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,remark,status_active,seq from wo_pre_cost_trim_cost_dtls  where job_no=".$txt_job_no." order by seq";
		$data_array=sql_select($sql);
 	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                	<td width="20">SL.</td>
                    <td width="80">Accessories</td>
                    <td width="80">Description</td>
                    <td width="80">Supplier</td>
                    <td width="30">UOM</td>
                    <td width="70">Cons. QTY</td>
                    <td width="50">Ex. %</td>
                    <td width="50">Ex. Qnty</td>
                    <td width="80">Total Qnty</td>
                    <td width="150">Rate</td>
                    <td width="50">Amount</td>
                    <td width="150">Accessories Details</td>
                    <td width="80">Remarks</td>
                </tr>
            <?
			$trim_qty=$trim->getQtyArray_by_precostdtlsid_consAndTotcons();
			$trim_amount=$trim->getAmountArray_precostdtlsid();
			$trim_detail=$trim->getQtyArray_by_precostdtlsidAndGmtssize_consAndTotcons();
			$trim_detail_amount=$trim->getAmountArray_by_precostdtlsidAndGmtssize_consAndTotcons();
			//print_r($trim_qty);
            $total_trims_cost=0;
			$total_trims_qty=0;
			$total_trims_cost_dzn=0;
			$total_trims_cost_kg=0;
			$i=1;
			$cbo_costing_per=str_replace("'",'',$cbo_costing_per);

			if($cbo_costing_per==1)
				{

					$costing_per=12;
				}
				else if($cbo_costing_per==2)
				{

					$costing_per=1;
				}
				else if($cbo_costing_per==3)
				{

					$costing_per=24;
				}
				else if($cbo_costing_per==4)
				{

					$costing_per=36;
				}
				else
				{

					$costing_per=48;
				}

            foreach( $data_array as $row ){
				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row[csf("trim_group")], "id", "item_name" );
				$totcons=$trim_qty[$row[csf("id")]]['totcons'];
				$cons=$trim_qty[$row[csf("id")]]['cons'];
				$excess=$cons-$totcons;
				$excessper=$excess/$totcons*100;
				$amount=$trim_amount[$row[csf("id")]];
			?>
                <tr>
                	<td><? echo $i;?></td>
                    <td align="left" style="word-break: break-all;word-wrap: break-word;"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                    <td align="left" style="word-break: break-all;word-wrap: break-word;"><? echo $row[csf("description")]; ?></td>
                    <td align="left" style="word-break: break-all;word-wrap: break-word;"><? echo $supplier_name_arr[$row[csf("nominated_supp")]]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                    <td align="right"><?  echo number_format($totcons,4); ?></td>
                    <td align="right"><? echo number_format($excessper,0); ?></td>
                    <td align="right"><? echo number_format($excess,4);  ?></td>
                    <td align="right"><?  echo  number_format($cons,4) ?></td>
                    <td align="right">
					  <table>
                    <?
					foreach ($trim_detail[$row[csf("id")]] as $key=>$value){
						$size_amount=$trim_detail_amount[$row[csf("id")]][$key]['cons'];
					?>
                    <tr>
                    <td align="right"><? echo $lib_size[$key].":".number_format($size_amount/$value['cons'],4);?></td>
                    </tr>
                     <?
					}
					?>
                    </table>
                    </td>
                    <td align="right"><?  echo  number_format($amount,4); ?></td>
                    <td align="right">
                    <table>
                    <?
					foreach ($trim_detail[$row[csf("id")]] as $key=>$value){
					?>
                    <tr>
                    <td align="right"> <? echo $lib_size[$key].":".number_format($value['cons'],4);?></td>
                    </tr>
                     <?
					}
					?>
                    </table>
                     </td>
                    <td style="word-break: break-all;word-wrap: break-word;"><? echo $row[csf("remark")]; ?></td>
                </tr>
            <?
                 $total_trims_cost+= $amount;
				 $total_trims_qty += $cons;
				 $i++;
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="10" align="right">Total &nbsp; </td>
                    <td align="right"><? echo number_format($total_trims_cost,4); ?></td>
                </tr>
                 <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="10" align="right">Avg Price Of Accessories &nbsp;</td>
                    <td align="right"><? echo number_format($total_trims_cost/$ord_qty,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	 //End Trims Cost Part report here -------------------------------------------



	 //start	Embellishment Details part report here -------------------------------------------
		$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no."";
		$data_array=sql_select($sql);
	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Gmts. Qnty (<? echo $costing_for; ?>)</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                 </tr>
            <?
			$emblishment_qty=$emblishment->getQtyArray_by_jobAndEmblishmentid();
			$emblishment_amount=$emblishment->getAmountArray_by_jobAndEmblishmentid();
			$wash_qty=$wash->getQtyArray_by_jobAndEmblishmentid();
			$wash_amount=$wash->getAmountArray_by_jobAndEmblishmentid();
            $total_embellishment_amt=0;
			$total_embellishment_amt_dzn=0;
            foreach( $data_array as $row )
            {

				$em_type ="";
 				if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==99)$em_type = $emblishment_other_type_arr[$row[csf("emb_type")]];
				if($row[csf("emb_name")] !=3){
				$cons_dzn_gmts=$emblishment_qty[$row[csf("job_no")]][$row[csf("id")]];
				$amount=$emblishment_amount[$row[csf("job_no")]][$row[csf("id")]];
				}
				else if($row[csf("emb_name")] ==3){
				$cons_dzn_gmts=$wash_qty[$row[csf("job_no")]][$row[csf("id")]];
				$amount=$wash_amount[$row[csf("job_no")]][$row[csf("id")]];
				}
				$total_embellishment_amt_dzn += $row[csf("amount")];

			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo number_format($cons_dzn_gmts); ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo number_format($amount,4); ?></td>
                </tr>
            <?
                 $total_embellishment_amt += $amount;
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo number_format($total_embellishment_amt,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	 //End Embellishment Details Part report here -------------------------------------------



	 //start	Commercial Cost part report here -------------------------------------------
   	$sql = "select id, job_no, item_id, rate, amount, status_active
			from  wo_pre_cost_comarci_cost_dtls
			where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                 </tr>
            <?
            $total_commercial_cost=0;$total_commercial_cost_dzn=0;
            foreach( $data_array as $row )
            {
				$total_commercial_cost_dzn+= $row[csf("amount")];

				$amount = $row[csf("amount")]/$order_price_per_dzn*$ord_qty;
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo number_format($amount,4); ?></td>
                </tr>
            <?
                 $total_commercial_cost += $amount;

            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? echo number_format($total_commercial_cost,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	 //End Commercial Cost Part report here -------------------------------------------


  	//start	Commission Cost part report here -------------------------------------------
   	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls  where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                 </tr>
            <?
            $total_commission_cost=0;   $total_commission_cost_dzn=0;
            foreach( $data_array as $row )
            {
				$commission_amount = $row[csf("commission_amount")]/$order_price_per_dzn*$ord_qty;
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                    <td align="right"><? echo number_format($row[csf("commision_rate")],4); ?></td>
                    <td align="right"><? echo number_format($commission_amount,4); ?></td>
                </tr>
            <?
                 $total_commission_cost += $commission_amount;
				 $total_commission_cost_dzn+=$row[csf("commission_amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3">Total</td>
                    <td align="right"><? echo number_format($total_commission_cost,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	//End Commission Cost Part report here -------------------------------------------


	//start	Other Components part report here -------------------------------------------
   	$sql = "select id, job_no, costing_per_id, order_uom_id, fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent, comm_cost, comm_cost_percent, commission, commission_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, freight, freight_percent, common_oh, common_oh_percent, currier_pre_cost, currier_percent, certificate_pre_cost, certificate_percent, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set, margin_pcs_set_percent, cm_for_sipment_sche, design_cost, design_percent, studio_cost, studio_percent from wo_pre_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	?>

        <div style="margin-top:15px">
         <table>
         <tr>
         <td>
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:450px;text-align:center;" rules="all">
            <label><b>Others Components</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount</td>
                 </tr>
            <?
            $total_other_components=0; $lab_test_dzn=0; $lab_test = 0; $inspection = 0; $cm_cost = 0; $freight = 0; $common_oh = 0; $design_cost =0; $studio_cost =0;
            foreach( $data_array as $row )
            {
				$lab_test = $row[csf("lab_test")]/$order_price_per_dzn*$ord_qty;
				$inspection = $row[csf("inspection")]/$order_price_per_dzn*$ord_qty;
				$cm_cost = $row[csf("cm_cost")]/$order_price_per_dzn*$ord_qty;
				$freight = $row[csf("freight")]/$order_price_per_dzn*$ord_qty;
				$common_oh = $row[csf("common_oh")]/$order_price_per_dzn*$ord_qty;
				$currier_pre_cost = $row[csf("currier_pre_cost")]/$order_price_per_dzn*$ord_qty;
				$certificate_pre_cost = $row[csf("certificate_pre_cost")]/$order_price_per_dzn*$ord_qty;
				$design_cost =$row[csf("design_cost")]/$order_price_per_dzn*$ord_qty;
				$studio_cost =$row[csf("studio_cost")]/$order_price_per_dzn*$ord_qty;

				$lab_test_dzn=$row[csf("lab_test")];
				$inspection_dzn=$row[csf("inspection")];
				$cm_cost_dzn =$row[csf("cm_cost")];

				$design_cost_dzn =$row[csf("design_cost")];
				$studio_cost_dzn =$row[csf("studio_cost")];
				$common_oh_dzn =$row[csf("common_oh")];
				$freight_dzn =$row[csf("freight")];
				$currier_pre_cost_dzn = $row[csf("currier_pre_cost")];
				$certificate_pre_cost_dzn = $row[csf("certificate_pre_cost")];
   			?>
                <tr>
                    <td align="left"s>Lab Test </td>
                    <td align="right"><? echo number_format($lab_test,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo number_format($inspection,4); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo number_format($cm_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Design Cost</td>
                    <td align="right"><? echo number_format($design_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Studio Cost</td>
                    <td align="right"><? echo number_format($studio_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo number_format($freight,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Currier Cost </td>
                    <td align="right"><? echo number_format($currier_pre_cost,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Certificate Cost </td>
                    <td align="right"><? echo number_format($certificate_pre_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Office OH</td>
                    <td align="right"><? echo number_format($common_oh,4); ?></td>
                </tr>
            <?
                 $total_other_components += $lab_test+$inspection+$cm_cost+$design_cost+$studio_cost+$freight+$currier_pre_cost+$certificate_pre_cost+$common_oh;
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo number_format($total_other_components,4); ?></td>
                </tr>
            </table>
            </td>
            <td valign="top" rowspan="2">

            <?
     	 // image show here  -------------------------------------------
		 $sql = "select id,master_tble_id,image_location
				from common_photo_library
				where master_tble_id=$txt_job_no limit 1";
		$data_array=sql_select($sql);
 	  ?>
          <div style="margin:15px 5px;float:right;width:500px" >
          	<? foreach($data_array AS $inf){ ?>
                <img  src='../../<? echo $inf[csf("image_location")]; ?>' height='400' width='300' />
            <?  } ?>
          </div>
          </td>
          </tr>
          <tr>
          <td>
			<?
            $total_summary_amount = 0;
            $total_summary_amount = $total_commission_cost+$total_commercial_cost+$total_embellishment_amt+$total_trims_cost+$design_cost+$studio_cost+$grand_total_conversion_cost+$total_yarn_amount +$woven_subtotal_amount+$knit_subtotal_amount+$lab_test+$inspection+$cm_cost+$freight+$currier_pre_cost+$certificate_pre_cost+$common_oh;
            ?>
	 <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:500px;text-align:center" rules="all">
            <label><b>Summary</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Cost Summary</td>
                    <td width="100">Cost/<? echo $costing_for; ?></td>
                    <td width="100">Cost/Kg</td>
                    <td width="100">Total</td>
                 </tr>
                 <tr>
                    <td align="left">Knit Fabric (Purchase) (kg) </td>
                    <td align="right"><? echo number_format($knit_subtotal_amount_dzn,4); ?></td>
                    <td align="right"><? echo number_format($knit_subtotal_amount/$knit_subtotal_avg_cons,4); ?></td>
                    <td align="right"><? echo number_format($knit_subtotal_amount,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Knit Fabric (Purchase) (Yds)</td>
                    <td align="right"><? echo number_format($knit_subtotal_amount_dzn_yds,4); ?></td>
                    <td align="right"><? echo number_format($knit_subtotal_amount_yds/$knit_subtotal_avg_cons_yds,4); ?></td>
                    <td align="right"><? echo number_format($knit_subtotal_amount_yds,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Knit Fabric (Purchase) (Pcs)</td>
                    <td align="right"><? echo number_format($knit_subtotal_amount_dzn_pcs,4); ?></td>
                    <td align="right"><? echo number_format($knit_subtotal_amount_pcs/$knit_subtotal_avg_cons_pcs,4); ?></td>
                    <td align="right"><? echo number_format($knit_subtotal_amount_pcs,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Knit Fabric (Purchase) (Mtr)</td>
                    <td align="right"><? echo number_format($knit_subtotal_amount_dzn_mtr,4); ?></td>
                    <td align="right"><? echo number_format($knit_subtotal_amount_mtr/$knit_subtotal_avg_cons_mtr,4); ?></td>
                    <td align="right"><? echo number_format($knit_subtotal_amount_mtr,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Woven Fabric (Purchase)</td>
                    <td align="right"><? echo number_format($woven_subtotal_amount_dzn,4); ?></td>
                    <td align="right"><? echo number_format($woven_subtotal_amount/$woven_subtotal_avg_cons,4); ?></td>
                    <td align="right"><? echo number_format($woven_subtotal_amount,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Yarn</td>
                    <td align="right"><? echo number_format($total_yarn_cost_dzn,4); ?></td>
                    <td align="right"><? echo number_format($total_yarn_cost_kg,4); ?></td>
                    <td align="right"><? echo number_format($total_yarn_amount,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Conversion to Fabric (Kg)</td>
                    <td align="right"><? echo number_format($total_conversion_cost_dzn,4); ?></td>
                    <td align="right"><? echo number_format($total_conversion_cost_kg,4); ?></td>
                    <td align="right"><? echo number_format($grand_total_conversion_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Conversion to Fabric (Yds)</td>
                    <td align="right"><? echo number_format($total_conversion_cost_dzn_yds,4); ?></td>
                    <td align="right"><? echo number_format($total_conversion_cost_kg_yds,4); ?></td>
                    <td align="right"><? echo number_format($grand_total_conversion_cost_yds,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Trims</td>
                    <td align="right"><? echo number_format($total_trims_cost_dzn,4); ?></td>
                    <td align="right" rowspan="13"><? //echo number_format($total_trims_cost_kg,4); ?></td>
                    <td align="right"><? echo number_format($total_trims_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Design Cost</td>
                    <td align="right"><? echo number_format($design_cost_dzn,4); ?></td>
                    <td align="right"><? echo number_format($design_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Studio Cost</td>
                    <td align="right"><? echo number_format($studio_cost_dzn,4); ?></td>
                    <td align="right"><? echo number_format($studio_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Embellishment</td>
                    <td align="right"><? echo number_format($total_embellishment_amt_dzn,4); ?></td>
                    <td align="right"><? echo number_format($total_embellishment_amt,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Commercial</td>
                    <td align="right"><? echo number_format($total_commercial_cost_dzn,4); ?></td>
                    <td align="right"><? echo number_format($total_commercial_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Commission</td>
                    <td align="right"><? echo number_format($total_commission_cost_dzn,4); ?></td>
                    <td align="right"><? echo number_format($total_commission_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo number_format($lab_test_dzn,4); ?></td>
                    <td align="right"><? echo number_format($lab_test,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo number_format($inspection_dzn,4); ?></td>
                    <td align="right"><? echo number_format($inspection,4); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo number_format($cm_cost_dzn,4); ?></td>
                    <td align="right"><? echo number_format($cm_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo number_format($freight_dzn,4); ?></td>
                    <td align="right"><? echo number_format($freight,4); ?></td>
                </tr>

                 <tr>
                    <td align="left">Currier Cost </td>
                    <td align="right"><? echo number_format($currier_pre_cost_dzn,4); ?></td>
                    <td align="right"><? echo number_format($currier_pre_cost,4); ?></td>
                </tr>

                 <tr>
                    <td align="left">Certificate Cost </td>
                    <td align="right"><? echo number_format($certificate_pre_cost_dzn,4); ?></td>
                    <td align="right"><? echo number_format($certificate_pre_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Office OH</td>
                    <td align="right"><? echo number_format($common_oh_dzn,4); ?></td>
                    <td align="right"><? echo number_format($common_oh,4); ?></td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="right" colspan="3">Total</td>
                    <td align="right"><? echo number_format($total_summary_amount,4); ?></td>
                </tr>
            </table>
          </td>
          </tr>
          </table>
      </div>

	</div>
     <?  echo signature_table(109, $cbo_company_name, "870px");?>
    </div>
	 <?
	 exit();
}

if($action=="basic_cost")//Basic Cost Btn 15
{ 

	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and c.costing_date='".$txt_costing_date."'";

	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$company_arr=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$supplier_name_arr=return_library_array( "select id, supplier_name from  lib_supplier where status_active=1 and is_deleted=0",'id','supplier_name');
	$season_name_arr=return_library_array( "select id, season_name from  lib_buyer_season where status_active=1 and is_deleted=0",'id','season_name');
	$brand_name_arr=return_library_array( "select id, brand_name from  lib_buyer_brand where status_active=1 and is_deleted=0",'id','brand_name');
	$trim_group=return_library_array( "select item_name,id from  lib_item_group", "id", "item_name"  );
	$color_library=return_library_array("select id,color_name from lib_color where status_active=1 and is_deleted=0","id","color_name");

	$order_size_range = sql_select("select min(size_order) as min_size, max(size_order) as max_size from wo_po_color_size_breakdown where job_no_mst=$txt_job_no and status_active!=0 and is_deleted=0");
	foreach ($order_size_range as $row) {
		$size_range = $row[csf('min_size')].'-'.$row[csf('max_size')];
	}
	$master_data = sql_select("SELECT a.company_name,a.buyer_name, a.style_ref_no, a.currency_id, a.gmts_item_id, a.brand_id, a.season_buyer_wise, a.style_description, a.job_quantity,b.sew_smv, b.remarks, b.costing_date, b.costing_per as costing_per_id , a.avg_unit_price,a.total_price from wo_po_details_master a join wo_pre_cost_mst b on a.id=b.job_id where a.job_no=$txt_job_no and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
	$master_attribute = array('company_name','buyer_name', 'style_ref_no', 'currency_id', 'gmts_item_id', 'brand_id', 'season_buyer_wise', 'style_description','costing_date', 'costing_per_id', 'job_quantity', 'remarks', 'avg_unit_price', 'total_price','sew_smv');
	foreach ($master_data as $row) {
		foreach ($master_attribute as $attr) {
			$$attr = $row[csf($attr)];
		}
	}
	$remarks_arr = explode(",", $remarks);
	$order_price_per_dzn=0;
	if($costing_per_id==1){
		$order_price_per_dzn=12;
		$costing_for=" DZN";
	}
	else if($costing_per_id==2){
		$order_price_per_dzn=1;
		$costing_for=" PCS";
	}
	else if($costing_per_id==3){
		$order_price_per_dzn=24;
		$costing_for=" 2 DZN";
	}
	else if($costing_per_id==4){
		$order_price_per_dzn=36;
		$costing_for=" 3 DZN";
	}
	else if($costing_per_id==5){
		$order_price_per_dzn=48;
		$costing_for=" 4 DZN";
	}

	$all_cost_arr = sql_select("SELECT cm_cost, trims_cost, wash_cost, embel_cost, comm_cost, lab_test, inspection,freight, common_oh, price_dzn, currier_pre_cost, certificate_pre_cost, depr_amor_pre_cost, interest_cost, incometax_cost, deffdlc_cost, design_cost, studio_cost from wo_pre_cost_dtls where job_no=$txt_job_no and status_active=1 and is_deleted=0");
	$total_cost_attr = array('cm_cost', 'trims_cost', 'wash_cost', 'embel_cost','price_dzn');
	$others_cost_attr = array('comm_cost','lab_test','inspection','freight','common_oh','currier_pre_cost', 'certificate_pre_cost', 'depr_amor_pre_cost', 'interest_cost', 'incometax_cost', 'deffdlc_cost', 'design_cost', 'studio_cost');
	foreach ($all_cost_arr as $row) {
		foreach ($total_cost_attr as $attr) {
			$$attr = $row[csf($attr)];
		}
		foreach ($others_cost_attr as $att) {
			$total_other_cost += $row[csf($att)];			
		}
	}

	$po_result =sql_select("select po_number,grouping,file_no,pub_shipment_date from wo_po_break_down where job_no_mst=$txt_job_no and status_active=1 and is_deleted=0 order by pub_shipment_date DESC");
	foreach ($po_result as $row) {
		$internal_ref[$row[csf('grouping')]] = $row[csf('grouping')];
	}

	//echo $total_other_cost; die;

	$condition= new condition();
	if(str_replace("'","",$txt_job_no) !=''){
		$condition->job_no("=$txt_job_no");
	}
	$txt_po_breack_down_id=str_replace("'",'',$txt_po_breack_down_id);
	if(str_replace("'",'',$txt_po_breack_down_id) !=""){
		$condition->po_id("in($txt_po_breack_down_id)");
	}
	$condition->init();
	$fabric= new fabric($condition);
	$yarn= new yarn($condition);
	$conversion= new conversion($condition);
	$trim= new trims($condition);
	$emblishment= new emblishment($condition);
	$wash= new wash($condition);
	$other= new other($condition);
	$other_cost_amount=$other->getAmountArray_by_job();
	$commercial= new commercial($condition);
	$commision= new commision($condition);

	$fabric_qty_arr=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$fabric_amount_arr=$fabric->getAmountArray_by_job_knitAndwoven_greyAndfinish();
	$get_commercial_amount = $commercial->getAmountArray_by_job();
	$get_amount_emb = $emblishment->getAmountArray_by_job();
	foreach ($other_cost_amount as $value) {
		foreach ($value as $key => $amount) {
			if($key != 'cm_cost')
			{
				$other_cost_value += $amount;
			}
			else
			{
				$cm_cost_amount = $amount;
			}
		}		
	}
	//echo $total_other_cost_amount.'-'.$cm_cost_amount; die;
	//Fabric part
	$fabric_data_arr = sql_select("SELECT a.id as fabric_cost_id, a.job_no, a.item_number_id, a.uom, a.body_part_id, a.fab_nature_id,  a.color_type_id, a.fabric_description, a.avg_cons, a.fabric_source, a.rate, a.amount, a.avg_finish_cons, a.lib_yarn_count_deter_id, a.job_plan_cut_qty,  b.dia_width, b.item_size, b.fina_char from wo_pre_cost_fabric_cost_dtls a join wo_pre_cos_fab_co_avg_con_dtls b on a.id=b.pre_cost_fabric_cost_dtls_id where a.job_no=".$txt_job_no." and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.cons<>0 group by a.id, a.job_no, a.item_number_id, a.uom, a.body_part_id, a.fab_nature_id,  a.color_type_id, a.fabric_description, a.avg_cons, a.fabric_source, a.rate, a.amount, a.avg_finish_cons, a.lib_yarn_count_deter_id, a.job_plan_cut_qty, b.dia_width,b.item_size,b.fina_char order by a.id ASC");

	$fabric_description_data=sql_select("SELECT a.fab_nature_id,a.construction,a.gsm_weight,a.weight_type,a.color_range_id,a.stich_length,a.process_loss,b.copmposition_id,b.percent,b.count_id,b.type_id,a.id,b.id as bid,a.fabric_ref, a.rd_no,a.shrinkage_l,a.shrinkage_w from  lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and  a.is_deleted=0 and a.entry_form=426 order by a.id,b.id");
	if (count($fabric_description_data)>0)
	{
		foreach( $fabric_description_data as $row )
		{
			$compo_per="";
			if(($row[csf('percent')]*1)>0) $compo_per=$row[csf('percent')]."% "; else $compo_per="";
			if(array_key_exists($row[csf('id')],$composition_arr))
			{
				$composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('copmposition_id')]]." ".$compo_per.$lib_yarn_count[$row[csf('count_id')]]." ".$yarn_type[$row[csf('type_id')]].",";
			}
			else
			{
				$composition_arr[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$compo_per.$lib_yarn_count[$row[csf('count_id')]]." ".$yarn_type[$row[csf('type_id')]].",";
			}
		}
	}
	if(count($fabric_description_data)>0)
	{
		foreach ($fabric_description_data as $row) {
			$fabric_description[$row[csf('id')]]['weight'] =  $row[csf('gsm_weight')].','.$fabric_weight_type[$row[csf('weight_type')]];
			$fabric_description[$row[csf('id')]]['rd_ref'] =  $row[csf('rd_no')].','.$row[csf('fabric_ref')];
			$fabric_description[$row[csf('id')]]['shrinkage'] =  $row[csf('shrinkage_l')].','.$row[csf('shrinkage_w')];
			$fabric_description[$row[csf('id')]]['shrinkage_l'] =  $row[csf('shrinkage_l')];
			$fabric_description[$row[csf('id')]]['shrinkage_w'] =  $row[csf('shrinkage_w')];
		}		
	}
	if($fabric_qty_arr['woven']['grey'] > 0){
		foreach($fabric_qty_arr['woven']['grey'] as $precostdtls_id=>$uomval){
			foreach($uomval as $uom=>$value){
				$fabric_req_qty[$precostdtls_id] += $value;
			}
		}
	}
	if($fabric_amount_arr['woven']['grey'] > 0){
		foreach($fabric_amount_arr['woven']['grey'] as $precostdtls_id=>$uomval){
			foreach($uomval as $uom=>$value){
				$fabric_req_amount += $value;
			}
		}
	}
	//Trims cost
	$sql_trim = "SELECT id, job_no, trim_group, description, brand_sup_ref, remark, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp, status_active, seq from wo_pre_cost_trim_cost_dtls where job_no=".$txt_job_no." order by seq";
	$data_array_trim=sql_select($sql_trim);
	$trim_amount_arr=$trim->getAmountArray_precostdtlsid();
	$trim_qty_arr=$trim->getQtyArray_by_precostdtlsid();
	$totTrim=0;
	$TrimData=array();
	foreach( $data_array_trim as $row_trim ){
	    $trim_qty=$trim_qty_arr[$row_trim[csf("id")]];
		$trim_amount=$trim_amount_arr[$row_trim[csf("id")]];
		$TrimData[$row_trim[csf('id')]]['trim_group']=$row_trim[csf('trim_group')];
		$TrimData[$row_trim[csf('id')]]['description']=$row_trim[csf('description')];
		$TrimData[$row_trim[csf('id')]]['brand_sup_ref']=$row_trim[csf('brand_sup_ref')];
		$TrimData[$row_trim[csf('id')]]['remark']=$row_trim[csf('remark')];
		$TrimData[$row_trim[csf('id')]]['cons_uom']=$row_trim[csf('cons_uom')];
		$TrimData[$row_trim[csf('id')]]['cons_dzn_gmts']=$row_trim[csf('cons_dzn_gmts')];
		$TrimData[$row_trim[csf('id')]]['rate']=$row_trim[csf('rate')];
		$TrimData[$row_trim[csf('id')]]['amount']=$row_trim[csf('amount')];
		$TrimData[$row_trim[csf('id')]]['apvl_req']=$row_trim[csf('apvl_req')];
		$TrimData[$row_trim[csf('id')]]['nominated_supp']=$row_trim[csf('nominated_supp')];
		$TrimData[$row_trim[csf('id')]]['tot_cons']=$trim_qty;
		$TrimData[$row_trim[csf('id')]]['tot_amount']=$trim_amount;
		$totTrim+=$row_trim[csf('cons_dzn_gmts')];
		$totTrimAmount+=$trim_amount;
	}
	//Wash Cost
	$sql_wash = "SELECT id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name =3 and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql_wash);
	$wash_qty=$wash->getQtyArray_by_jobAndEmblishmentid();
	$wash_amount=$wash->getAmountArray_by_jobAndEmblishmentid();
	foreach( $data_array as $row ){
		$washqty=$wash_qty[$row[csf("job_no")]][$row[csf("id")]];
		$washamount=$wash_amount[$row[csf("job_no")]][$row[csf("id")]];
		$EmbData[$row[csf("id")]]['emb_name']=$row[csf("emb_name")];
		$EmbData[$row[csf("id")]]['emb_type']=$row[csf("emb_type")];
		$EmbData[$row[csf("id")]]['cons_dzn_gmts']=$row[csf("cons_dzn_gmts")];
		$EmbData[$row[csf("id")]]['rate']=$row[csf("rate")];
		$EmbData[$row[csf("id")]]['amount']=$row[csf("amount")];
		$EmbData[$row[csf("id")]]['tot_cons']=$washqty;
		$EmbData[$row[csf("id")]]['tot_amount']=$washamount;
		$totWashAmount+=$washamount;
	}
	$image_location = sql_select("SELECT image_location from common_photo_library where file_type=1 and form_name='knit_order_entry' and master_tble_id=$txt_job_no and rownum <=2");

	?>
		<table width="100%">
			<tr><th style="text-align: center;">BASIC COST SHEET</th></tr>
			<tr><th style="text-align: center;"><? echo $buyer_arr[$buyer_name].' '.$style_description ?> </th></tr>
		</table>
		<table width="100%">
			<tr>
				<td>Master Style</td>
				<td>:</td>
				<td><? echo implode(",", $internal_ref) ?></td>
				<td>Season</td>
				<td>:</td>
				<td><? echo $season_name_arr[$season_buyer_wise] ?></td>
				<td>Costing Date</td>
				<td>:</td>
				<td><? echo change_date_format($costing_date,'yyyy-mm-dd','-'); ?></td>
			</tr>
			<tr>
				<td>Merch Style NO.</td>
				<td>:</td>
				<td><? echo $style_ref_no ?></td>
				<td>Brand</td>
				<td>:</td>
				<td><? echo $brand_name_arr[$brand_id] ?></td>
				<td>Currency</td>
				<td>:</td>
				<td><? echo $currency[$currency_id] ?></td>
			</tr>
			<tr>
				<td>Size Range</td>
				<td>:</td>
				<td><? echo $size_range ?></td>
				<td>Item</td>
				<td>:</td>
				<td><? echo $garments_item[$gmts_item_id] ?></td>
				<td>Vendor Name</td>
				<td>:</td>
				<td><? echo $company_arr[$company_name] ?></td>
			</tr>
			<tr>
				<td>Costing Per</td>
				<td>:</td>
				<td><? echo $costing_per[$costing_per_id] ?></td>
				<td>Order Qty.</td>
				<td>:</td>
				<td><? echo $job_quantity ?></td>
				<td title="Job Qty*SMV">Budget Minute</td>
				<td>:</td>
				<td><? echo number_format($job_quantity*$sew_smv,4,'.','') ?></td>
			</tr>
		</table>
		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:1350px; margin-top: 10px" rules="all">
			<tr>
				<th width="590">Fabrication</th>
				<th width="100">Fabric Usage</th>
				<th width="60">Full Width</th>
				<th width="60">Cutable Width</th>
				<th width="60">Shrinkage L</th>
				<th width="60">Shrinkage W</th>
				<th width="50">Price/ Yds</th>
				<th width="50">Fina. Char</th>
				<th width="60" title="(Tot Req qty/tot plan Qty)* Costing per">Cons. (Yds)</th>
				<th width="60">Actual Fab Cost</th>
				<th width="60">Total Fabric Price</th>
				<th width="60">CM</th>
				<th width="60">TTL Trims Cost</th>
				<th width="60">Wash</th>
				<th width="60">Emb.</th>
				<th width="60">Others</th>
				<th width="60">Total Cost/ <?= $costing_for ?></th>
				<th width="50">FOB/ <?= $costing_for ?></th>
				<th width="50">Mergin/ <?= $costing_for ?></th>
			</tr>
			<? 
			foreach ($fabric_data_arr as $row){
				$fin_char=$row[csf('fina_char')];
				$cons_yds = ($fabric_req_qty[$row[csf('fabric_cost_id')]]/$job_quantity)*$order_price_per_dzn;
				$total_fabric_cost += $cons_yds*$row[csf('rate')]+(($cons_yds*$row[csf('rate')])*$fin_char/100);
			}
			$k=1;
			$colSpan=count($fabric_data_arr)+1;
			foreach ($fabric_data_arr as $row) {
				$fabric_des = $composition_arr[$row[csf('lib_yarn_count_deter_id')]].', '.$row[csf('dia_width')].', '.$fabric_description[$row[csf('lib_yarn_count_deter_id')]]['weight'].', '.$unit_of_measurement[$row[csf('uom')]].', '.$fabric_description[$row[csf('lib_yarn_count_deter_id')]]['rd_ref'];
				$fin_char=$row[csf('fina_char')];
				$cons_yds = ($fabric_req_qty[$row[csf('fabric_cost_id')]]/$job_quantity)*$order_price_per_dzn;
				$fabric_price = $cons_yds*$row[csf('rate')]+(($cons_yds*$row[csf('rate')])*$fin_char/100);
				
				?>
				<tr>
					<td width="590"><? echo $fabric_des.",".$fabric_description[$row[csf('lib_yarn_count_deter_id')]]['shrinkage'] ?></td>
					<td width="100"><? echo $body_part[$row[csf('body_part_id')]] ?></td>
					<td width="60" align="center"><? echo $row[csf('dia_width')] ?></td>
					<td width="60" align="center"><? echo $row[csf('item_size')] ?></td>
					<td width="60" align="center"><? echo $fabric_description[$row[csf('lib_yarn_count_deter_id')]]['shrinkage_l'] ?></td>
					<td width="60" align="center"><? echo $fabric_description[$row[csf('lib_yarn_count_deter_id')]]['shrinkage_w'] ?></td>
					<td width="50" align="right"><? echo number_format($row[csf('rate')],4) ?></td>
					<td width="50" align="right"><? echo $fin_char; ?>&percnt;</td>
					<td width="60" align="right"><? echo number_format($cons_yds,4) ?></td>
					<td width="60" align="right"><? echo number_format($cons_yds*$row[csf('rate')],4); ?></td>
					<td width="60" align="right"><? echo number_format($fabric_price,4) ?></td>
					<? if($k==1){ 
						$total_cost=$total_fabric_cost+$cm_cost+$trims_cost+$wash_cost+$embel_cost+$total_other_cost;
						?>
					<td width="60" rowspan="<?= $colSpan ?>" align="right"><? echo number_format($cm_cost,4) ?></td>
					<td width="60" rowspan="<?= $colSpan ?>" align="right"><? echo number_format($trims_cost,4) ?></td>
					<td width="60" rowspan="<?= $colSpan ?>" align="right"><? echo number_format($wash_cost,4) ?></td>
					<td width="60" rowspan="<?= $colSpan ?>" align="right"><? echo number_format($embel_cost,4) ?></td>
					<td width="60" rowspan="<?= $colSpan ?>" align="right"><? echo number_format($total_other_cost,4) ?></td>
					<td width="60" rowspan="<?= $colSpan ?>" align="right"><? echo number_format($total_cost,4) ?></td>
					<td width="50" rowspan="<?= $colSpan ?>" align="right"><? echo number_format($price_dzn,4) ?></td>
					<td width="50" rowspan="<?= $colSpan ?>" align="right"><? echo number_format($price_dzn-$total_cost,4) ?></td>
					<? } ?>
				</tr><?
				$k++;
				$total_fabric_total += number_format($fabric_price,4);
			}
			 ?>
			 <tr>
			 	<th colspan="8" align="center">Total Fabrics Cost</th>
			 	<th align="right"><? echo number_format($total_fabric_total,4) ?></th>
			 </tr>
					
		</table>
		<div style="width: 1250px; margin-top: 10px; margin-bottom: 10px">
			<div style="width: 400px; float: left;">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:400px;" rules="all">
					<tr>
						<th colspan="6">Wash Cost Break Up</th>
					</tr>
					<tr>
						<th colspan="5" align="center">Stable</th>
						<th>Cost</th>
					</tr>
					<? foreach ($EmbData as $index => $row) { ?>						
						<tr>
							<td width="200"><?= $emblishment_wash_type[$row["emb_type"]]  ?></td>
							<td width="40"></td>
							<td width="40"></td>
							<td width="40"></td>
							<td width="40"></td>
							<td width="40"><? echo number_format($row["amount"],4); ?></td>
						</tr>						
					<?
						$totaldznamount += $row["amount"];
					 } 
					 ?>
					<tr>
						<th colspan="5" align="center">Total Wash Cost</th>
						<th align="right"><?= number_format($totaldznamount,4)  ?></th>
					</tr>			
				</table>
			</div>
			<div style="width: 400px; float: left;">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:400px;" rules="all">
					<tr>
						<th colspan="2">Sketch</th>
					</tr>
					<tr>
						<? foreach ($image_location as $row) { ?>
							<td width="200"><img  src='../../<? echo $row[csf("image_location")]; ?>' height='200' width='190' /></td>
						<? } ?>
					</tr>			
				</table>
			</div>
			<div style="width: 450px; float: left;">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:450px;" rules="all">
					<tr>
						<th colspan="6">TRIMS DETAILS COST</th>
					</tr>
					<tr>
						<th width="40">Sl</th>
						<th width="200">Items Description</th>
						<th width="50">Uom</th>
						<th width="50">Cons/Pcs</th>
						<th width="50">Unit Price</th>
						<th width="50">TTL Cost</th>
					</tr>
					<?
						$i=1;
						foreach ($TrimData as $index => $row) { ?>
							<tr>
								<td width="40"><?= $i; ?></td>
								<td width="200"><?= $trim_group[$row["trim_group"]]  ?></td>
								<td width="50"><?= $unit_of_measurement[$row["cons_uom"]];  ?></td>
								<td width="50"><?= number_format($row["cons_dzn_gmts"],4);?></td>
								<td width="50"><?= number_format($row["rate"],4);  ?></td>
								<td width="50"><?= number_format($row["amount"],4); ?></td>
							</tr>
						<? 
							$i++;
							$totalAmount += $row["amount"];
						}
					?>
					<tr>
						<th colspan="5" align="center">Trims Total</th>
						<th width="50"><?= number_format($totalAmount,4); ?></th>
					</tr>			
				</table>
			</div>	
		</div>
		<br>
		<br>
		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:950px; margin-top: 10px; margin-bottom: 10px" rules="all">
			<tr>
				<th rowspan="3" width="200">Cost Summary</th>
				<th colspan="11">Cost Detials</th>
			</tr>
			<tr>
				<td>Order Qty, Pcs</td>
				<td>Avg Price/ Pcs</td>
				<td>Order Value</td>
				<td>Fabric Cost</td>
				<td>CM</td>
				<td>TTL Trims Cost</td>
				<td>Wash</td>
				<td>Emb.</td>
				<td>Others</td>
				<td>Total Cost</td>
				<td>Mergin</td>
			</tr>
			<tr>
				<? $total_cost = $fabric_req_amount + $cm_cost_amount + $totTrimAmount + $totWashAmount + $get_amount_emb[str_replace("'","",$txt_job_no)] + $other_cost_value + $get_commercial_amount[str_replace("'","",$txt_job_no)]; ?>
				<td align="right"><? echo $job_quantity ?></td>
				<td align="right"><? echo number_format($avg_unit_price,2,'.','') ?></td>
				<td align="right"><? echo number_format($total_price,2,'.','') ?></td>
				<td align="right"><? echo number_format($fabric_req_amount,2,'.','') ?></td>
				<td align="right"><? echo number_format($cm_cost_amount,2,'.','') ?></td>
				<td align="right"><? echo number_format($totTrimAmount,2,'.',''); ?></td>
				<td align="right"><? echo number_format($totWashAmount,2,'.','') ?></td>
				<td align="right"><? echo number_format($get_amount_emb[str_replace("'","",$txt_job_no)],2,'.','')  ?></td>
				<td align="right"><? echo number_format($other_cost_value + $get_commercial_amount[str_replace("'","",$txt_job_no)],2,'.',''); ?></td>
				<td align="right"><? echo number_format($total_cost,2,'.','') ?></td>
				<td align="right"><? echo number_format($total_price-$total_cost,2,'.','') ?></td>
			</tr>
		</table>
		<br>
		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:550px; margin-top: 10px; margin-bottom: 10px" rules="all">
			<tr><th colspan="2">Special Notes</th></tr>
			<tr>
				<th width="50">Sl</th>
				<th width="450">Note</th>
			</tr>
			<? foreach ($remarks_arr as $key => $value) { ?>
				<tr>
					<td><?= $key+1  ?></td>
					<td><?= $value ?></td>
				</tr>
			<? } ?>
		</table>			
	<?
	echo signature_table(109, $cbo_company_name, "850px");
}

if($action == "mkt_source_cost") //MKT Vs Source BTN 16
{
   	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if($txt_job_no==""){
		$job_no='';
	}else{
		$job_no=" and a.job_no=".$txt_job_no."";
	}

	if($cbo_company_name=="") {
		$company_name='';
	} else {
		 $company_name=" and a.company_name=".$cbo_company_name."";
	}

	if($cbo_buyer_name==""){
		 $cbo_buyer_name='';
	} else {
		$cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	}

	if($txt_style_ref==""){
		 $txt_style_ref='';
	} else {
		$txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	}

	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($txt_costing_date=="") {
		$txt_costing_date='';
	} else {
		$txt_costing_date=" and b.costing_date='".$txt_costing_date."'";
	}
$txt_po_breack_down_id=str_replace("'",'',$txt_po_breack_down_id);
	if(str_replace("'",'',$txt_po_breack_down_id)==""){
		$txt_po_breack_down_id_cond='';
	}
	else{
		$txt_po_breack_down_id_cond=" and d.id in(".$txt_po_breack_down_id.")";
	}
    //if($txt_quotation_date=="") $txt_quotation_date=''; else $txt_quotation_date=" and a.quot_date ='".$txt_quotation_date."'";
	$imge_arr=return_library_array( "select master_tble_id,image_location from common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	

    $buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
    $season_name_arr=return_library_array( "select id, season_name from lib_buyer_season",'id','season_name');
    $comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$user_passArr=return_library_array( "select id, user_name from user_passwd",'id','user_name');
	$color_library=return_library_array("select id,color_name from lib_color where status_active=1 and is_deleted=0","id","color_name");
	 //pro_ex_factory_mst 
	$sql_ex="select max(ex_factory_date) as ex_factory_date from pro_ex_factory_mst b,wo_po_break_down d where d.id=b.po_break_down_id and d.job_no_mst=$txt_job_no and d.status_active=1";
	$exf_data_array=sql_select($sql_ex);
	 foreach( $exf_data_array as $row)
	 {
		 	$ex_factory_date=$row[csf("ex_factory_date")];
	 }
	  	
	$excess_cut=0;
	  $sql_excess="select b.excess_cut_perc from wo_po_color_size_breakdown b,wo_po_break_down d where d.id=b.po_break_down_id and d.job_no_mst=$txt_job_no and b.status_active=1 and d.status_active=1";
	  $excess_data_array=sql_select($sql_excess);
	 foreach( $excess_data_array as $row)
	 {
		 $excess_cut=$row[csf("excess_cut_perc")];
	 }
	  
	$sql_po="select  a.total_set_qnty as ratio,d.po_number,(d.po_quantity) as po_qnty,d.plan_cut, d.unit_price, d.pub_shipment_date,d.shipment_date,d.po_received_date,d.pack_handover_date  from wo_po_break_down d,wo_po_details_master a where   d.job_no_mst=a.job_no and d.job_no_mst=$txt_job_no and d.status_active=1 $txt_po_breack_down_id_cond";
	 $po_data_array=sql_select($sql_po);
	 	$order_job_qnty=0;$plan_cut=0;
		$leadtime_days_remian_cal="";
	 foreach( $po_data_array as $row)
	 {
		 	$po_received_dateArr.=$row[csf("po_received_date")].',';
			$pack_handover_dateArr.=$row[csf("pack_handover_date")].',';
			$shipment_date_dateArr.=$row[csf("shipment_date")].',';
			$order_job_qnty+=$row[csf("po_qnty")];
			$plan_cut+=$row[csf("plan_cut")];
			$days_tot=datediff('d',$row[csf("po_received_date")],$row[csf("pub_shipment_date")])-1;
			
			 $leadtime_days_remian_cal.=$days_tot.',';
	 }
	$leadtime_days_remian_calArr=rtrim($leadtime_days_remian_cal,',');
	$leadtime_days_remian_calArr=explode(",",$leadtime_days_remian_calArr);
	$leadtime_days_remian=max($leadtime_days_remian_calArr);
		//  echo $leadtime_days_remian_cal;
	 $po_received_dateArr=rtrim($po_received_dateArr,',');
	 $po_received_dateArr=explode(",",$po_received_dateArr);
	  $po_received_date=max($po_received_dateArr);
	 $pack_handover_dateArr=rtrim($pack_handover_dateArr,',');
	 $pack_handover_dateArr=explode(",",$pack_handover_dateArr);
	 $pack_handover_date=max($pack_handover_dateArr);
	 
	  $shipment_date_dateArr=rtrim($shipment_date_dateArr,',');
	 $shipment_date_dateActual=explode(",",$shipment_date_dateArr);
	//   $shipment_dateActual=max($shipment_date_dateActual);
	  $shipment_dateActual=min($shipment_date_dateActual);
	  $brand_arr=return_library_array( "select id, brand_name from  lib_buyer_brand where status_active=1 and is_deleted=0",'id','brand_name');
	// $leadtime_days_remian=datediff('d',$po_received_date,$shipment_dateActual)-1;
	 
	$approv_sql = "select a.job_no,a.company_name,a.body_wash_color,a.buyer_name,a.total_set_qnty,a.style_description,a.remarks,a.set_break_down,a.quotation_id,a.season_buyer_wise,a.season_year,a.brand_id,a.style_ref_no,a.set_smv, a.gmts_item_id, a.order_uom, a.job_quantity, a.avg_unit_price,b.sourcing_approved as approved,b.costing_date,b.sourcing_date, b.costing_per, c.fab_knit_req_kg, c.fab_woven_req_yds, c.fab_yarn_req_kg, a.total_set_qnty as ,a.working_company_id from wo_po_details_master a, wo_pre_cost_mst b,wo_pre_cost_sum_dtls c  where a.job_no=b.job_no and b.job_no=c.job_no and a.status_active=1 and a.job_no=$txt_job_no $company_name $cbo_buyer_name $txt_style_ref";
	$approv_data_array=sql_select($approv_sql);
	foreach ($approv_data_array as $row)
	{
		$approved=$row[csf("approved")];
	}

	 $sql = "SELECT a.job_no,a.company_name,a.total_set_qnty,a.buyer_name,a.remarks,a.quotation_id,a.set_break_down,a.season_buyer_wise,a.season_year,a.brand_id,a.style_ref_no,a.set_smv, a.gmts_item_id, a.order_uom, a.job_quantity, a.avg_unit_price,b.approved,b.costing_date,b.sourcing_date, b.costing_per, c.fab_knit_req_kg, c.fab_woven_req_yds, c.fab_yarn_req_kg ,a.working_company_id, a.body_wash_color, a.style_description,a.product_dept from wo_po_details_master a, wo_pre_cost_mst b,wo_pre_cost_sum_dtls c  where a.job_no=b.job_no and b.job_no=c.job_no and a.status_active=1 and a.job_no=$txt_job_no $company_name $cbo_buyer_name $txt_style_ref";
          // echo $sql; order_uom,total_set_qnty
    $data_array=sql_select($sql);
	$working_company_arr=return_library_array("SELECT id,company_name from lib_company ","id","company_name");  
	$short_company_arr=return_library_array("SELECT id,company_short_name from lib_company ","id","company_short_name"); 
	$working_company='';
	foreach ($data_array as $row)
			{
				$working_company=$working_company_arr[$row[csf("working_company_id")]];
			}
$path="../../";
	ob_start();
    ?>
    <div style="width:1320px" align="center">  
     <style type="text/css" media="print">
   			table { page-break-inside:auto }
		
		/* p{ padding:0px !important; margin:0px !important;}*/

		</style>
      <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black">
           <tr>
               <td width="100"> 
               <img src='<? echo $path .''. $imge_arr[str_replace("'","",$cbo_company_name)]; ?>' height='100%' width='100%' />
               </td>
               <td width="1250">                                     
                    <table width="100%" cellpadding="0" cellspacing="0" >
                        <tr>
                            <td align="center" style="font-size:20px;">
                            <b>  <?php      
                                    echo 'Sourcing Post Cost Report';
                              ?>
                              </b>
                            </td>
                        </tr>
                      </table>
					  <br>
					  <table width="100%" cellpadding="0" cellspacing="0">
                        <tr align="center">
                            <td> <b style="font-size:21px;"> PO Rec Unit: </b><span style="font-size:19px;"><?  echo $comp[str_replace("'","",$cbo_company_name)];?> </span></td>
							
							<td ><b style="font-size:21px;">Prod Unit: </b><span style="font-size:19px;"><?echo $working_company;?></span></td>
							
                        </tr>
                      </table>
                </td>       
            </tr>
       </table>
       <br>
            <?
             $order_price_per_dzn=0;
		
			foreach ($data_array as $row)
			{
				
				$avg_unit_price=$row[csf("avg_unit_price")];
				$sourcing_date=$row[csf("sourcing_date")];
				$buyer_name_id=$row[csf("buyer_name")];
				$total_set_qnty=$row[csf("total_set_qnty")];
				$set_break_down=$row[csf("set_break_down")];
				
				//order_uom,total_set_qnty
				$order_uom=$row[csf("order_uom")];$remarks=$row[csf("remarks")];
				//$total_set_qnty=$row[csf("total_set_qnty")];
				//echo $order_uom.'d'.$total_set_qnty;
				$order_values = $order_job_qnty*$avg_unit_price;
				 if($row[csf("costing_per")]==1){$order_price_per_dzn=12;$costing_val=" DZN";}
					else if($row[csf("costing_per")]==2){$order_price_per_dzn=1;$costing_val=" PCS";}
					else if($row[csf("costing_per")]==3){$order_price_per_dzn=24;$costing_val=" 2 DZN";}
					else if($row[csf("costing_per")]==4){$order_price_per_dzn=36;$costing_val=" 3 DZN";}
					else if($row[csf("costing_per")]==5){$order_price_per_dzn=48;$costing_val=" 4 DZN";}
				
					$quot_id=$row[csf("quotation_id")];
					$sew_smv=$row[csf("set_smv")];
					$inserted_by=$user_passArr[$row[csf("inserted_by")]];
					$style_description='';
					if($row[csf('style_description')]!=''){
						$style_description=" (".$row[csf('style_description')].")";
					}
				?>
						<table align="left" border="0" cellpadding="0" cellspacing="0" style="width:450px; margin:5px;">
                        <tr>
                        <td>
                        
                        <table align="left" border="1" cellpadding="1" cellspacing="1" style="width:550px; margin:5px;" rules="all">
							<tr>
								<td width="80">Job No</td>
								<td width="80"><b><? echo $row[csf("job_no")]; ?></b></td>
								<td width="90">Costing</td>
								
								</tr>
							<tr>
                            <tr>
								<td width="80">Body/Wash Color</td>
								<td width="80"><b><? echo $color_library[$row[csf("body_wash_color")]]; ?></b></td>
								<td width="100"><b><? echo $costing_per[$row[csf("costing_per")]]; ?></b></td>
							</tr>
                            <tr>
							<td> Costing Date :  </td>
							<td colspan="2"><b><? echo $row[csf("costing_date")]; ?></b></td>
							</tr>
                             
							<tr>
								<td>Buyer </td>
								<td colspan="2"><b><? echo $buyer_arr[$row[csf("buyer_name")]];
								if($row[csf("brand_id")]>0)
								{
									echo '('.$brand_arr[$row[csf("brand_id")]].')';
								}
								if($row[csf("product_dept")]>0)
								{
									echo '('.$product_dept[$row[csf("product_dept")]].')';
								}
								?></b></td>
							 </tr> 
							 <tr>
								<td>Style </td>
								<td colspan="2"><b><? echo $row[csf("style_ref_no")].$style_description; ?></b></td>
							 </tr>
							<tr>
								<td width="80">Item</td>
								<?
									$set_break_downArr=explode("__",$set_break_down);
									$smv_arr=array();
										foreach($set_break_downArr as $keyitemData)
										{
											$keyitemDataArr=explode("_",$keyitemData);
											$item_id=$keyitemDataArr[0];
											$smv=$keyitemDataArr[2];
											$smv_arr[$item_id]=$smv;
										}
									if($row[csf("order_uom")]==1)
									{
									  $grmnt_items=$garments_item[$row[csf("gmts_item_id")]].' ('.$smv_arr[$row[csf("gmts_item_id")]].')';
									}
									else
									{
										$gmt_item=explode(',',$row[csf("gmts_item_id")]);
										foreach($gmt_item as $key=>$val)
										{
											$grmnt_items .=$garments_item[$val].' ('.$smv_arr[$val].')'.", ";
										}
									}
								?>
								<td width="100" colspan="2"><b><? echo rtrim($grmnt_items,', '); ?></b></td>
							</tr>
							<tr>
								<td>Season</td>
								<td colspan="2"><b><? //echo $season_name_arr[$row[csf("season_buyer_wise")]];
								
								echo $season_brand = $season_name_arr[$row[csf('season_buyer_wise')]].'-'.substr( $row[csf('season_year')], -2); ?></b></td>
							 </tr>
							<tr>
								<td>P.O. Qnty</td>
								<td><b><?  echo $order_job_qnty.' '.$unit_of_measurement[$order_uom];
								$offer_qty_dzn=$order_job_qnty/$order_price_per_dzn;
								 ?></b></td>
								<td  title="<? echo $offer_qty_dzn;?>"><b><? echo number_format($offer_qty_dzn,0).' '.$costing_val; ?></b></td>
							</tr>
							
							  <tr>
								<td>Plan Cut Qnty(<? echo $excess_cut.'%';?>)</td>
								<td><b><? echo $plan_cut.' '.$unit_of_measurement[$order_uom];
								$plan_offer_qty_dzn=$plan_cut/$order_price_per_dzn;
								 ?></b></td>
								<td  title="<? echo $plan_offer_qty_dzn;?>"><b><? echo number_format($plan_offer_qty_dzn,0).' '.$costing_val; ?></b></td>
							</tr>
                            <tr>
								<td>Remarks</td>
								<td colspan="2"><b><? echo  $remarks; ?></b></td>
								 
							</tr>
						</table>
                        </td>
              <?
			} //master part end
		//	die;
           $condition= new condition();
			if(str_replace("'","",$txt_job_no) !=''){
				$condition->job_no("=$txt_job_no");
			}
			if(str_replace("'",'',$txt_po_breack_down_id) !="")
			{
				$condition->po_id("in($txt_po_breack_down_id)");
			}
			$condition->init();
			$fabric= new fabric($condition);
			$trim= new trims($condition);
			$wash= new wash($condition);
			$emblishment= new emblishment($condition);
			//echo $fabric->getQuery();die;
			$fabric_qty_arr=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
			//print_r($fabric_qty_arr);
			$fabric_amount_arr=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
			$sourcing_fabric_amount_arr=$fabric->getAmountArray_by_FabriccostidSourcing_knitAndwoven_greyAndfinish();
			//print_r($sourcing_fabric_amount_arr);
			$trim_amount_arr=$trim->getAmountArray_precostdtlsid();
			$trim_amountSourcing_arr=$trim->getAmountArray_precostdtlsidSourcing();
			//print_r($trim_amountSourcing_arr);
			$trim_qty_arr=$trim->getQtyArray_by_precostdtlsid();
			
			$emblishment_qtyArr=$emblishment->getQtyArray_by_jobAndEmblishmentid();
			$emblishment_amountArr=$emblishment->getAmountArray_by_jobAndEmblishmentid();
			$wash_qtyArr=$wash->getQtyArray_by_jobAndEmblishmentid();
		//	print_r($wash_qtyArr);
			$wash_amountArr=$wash->getAmountArray_by_jobAndEmblishmentid();
	           
			$sql_determin=sql_select("select a.id,a.type from lib_yarn_count_determina_mst a where  a.status_active=1  and a.entry_form=426");
			foreach($sql_determin as $row)
			{
				$determin_type_arr[$row[csf('id')]]=$row[csf('type')];	
			}
			
			
			// $pri_fab_arr="select a.quotation_id,b.fabric_source,b.lib_yarn_count_deter_id as deter_min_id,b.fabric_description as fab_desc,b.fabric_description,b.body_part_id,b.gsm_weight,b.uom, a.rate,a.amount, (a.requirment) as requirment,a.cons, (a.pcs) as pcs,a.process_loss_percent as p_loss from wo_pri_quo_fab_co_avg_con_dtls a,wo_pri_quo_fabric_cost_dtls  b where a.wo_pri_quo_fab_co_dtls_id=b.id and a.quotation_id=b.quotation_id  and b.status_active=1 and b.is_deleted=0 and a.quotation_id=$quot_id ";//and b.fabric_source=2
			//$pri_fab_result=sql_select($pri_fab_arr);
			
			  $pre_fab_arr="select  b.id, b.job_no,b.body_part_id,b.lib_yarn_count_deter_id as deter_min_id, b.fab_nature_id, b.color_type_id, b.fabric_description as fab_desc,b.uom,b.avg_cons,b.avg_cons_yarn, b.avg_process_loss,b.construction,b.composition,b.fabric_source,b.gsm_weight, b.rate,b.amount,b.avg_finish_cons,b.sourcing_rate,b.sourcing_nominated_supp from wo_pre_cost_fabric_cost_dtls  b where  b.status_active=1 and b.is_deleted=0 and b.job_no=$txt_job_no order by id";//and b.fabric_source=2
			$pre_fab_result=sql_select($pre_fab_arr);
			
			$summ_fob_pcs=0;$summ_fob_gross_value_amt=$summ_sourcing_tot_budget_dzn_val=0;
			foreach($pre_fab_result as $row)
			{
				$determin_type=$determin_type_arr[$row[csf('deter_min_id')]];
				$body_partId=$body_part[$row[csf('body_part_id')]];
				//$fab_desc=$body_partId.','.$row[csf('fab_desc')];
				$fab_desc=$body_partId.','.$row[csf('fab_desc')];
				//echo $determin_type.'d';
				//sourcig_fabric_amount_arr
				$tot_amt=$row[csf('avg_cons')]*$row[csf('rate')];
				$fab_req_qty=$fabric_qty_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]]+$fabric_qty_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$fab_req_amount=$fabric_amount_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]]+$fabric_amount_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$sourcing_fab_req_amount=$sourcing_fabric_amount_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]]+$sourcing_fabric_amount_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$fab_cost_dtls_id=$row[csf('id')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['req_qty']+=$fab_req_qty;
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['req_amount']+=$fab_req_amount;
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['sourcing_req_amount']+=$sourcing_fab_req_amount;
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['cons']+=$row[csf('avg_finish_cons')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['tot_cons']+=$row[csf('avg_cons')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['amount']+=$row[csf('amount')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['p_loss']=$row[csf('avg_process_loss')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['sourcing_nominated_supp']=$row[csf('sourcing_nominated_supp')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['sourcing_rate']=$row[csf('sourcing_rate')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['fabric_source']=$row[csf('fabric_source')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['fab_desc']=$row[csf('construction')].','.$row[csf('composition')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['uom']=$unit_of_measurement[$row[csf('uom')]];
				$p_fab_precost_tot_row+=1;	
				//Summary
				$summ_fob_pcs+=$row[csf('amount')];
				$summ_sourcing_tot_budget_dzn_val+=$fab_req_qty*$row[csf('sourcing_rate')];
				
				$summ_fob_gross_value_amt+=$fab_req_amount;
			}
			//echo $summ_sourcing_tot_budget_dzn_val.', ';
		 $pre_trim_consarr="select b.id,c.trim_type,c.item_name,b.description,b.seq,b.trim_group,b.cons_dzn_gmts,b.cons_uom as uom,avg(d.excess_per) as  excess_per from wo_pre_cost_trim_cost_dtls b,lib_item_group c,wo_pre_cost_trim_co_cons_dtls d where  c.id=b.trim_group and b.id=d.wo_pre_cost_trim_cost_dtls_id and c.trim_type in(1,2) and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and b.job_no=$txt_job_no group by b.id,c.trim_type,c.item_name,b.description,b.trim_group,b.cons_dzn_gmts,b.cons_uom,b.seq order by b.seq";
		$pre_trim_cons_result=sql_select($pre_trim_consarr);
			foreach($pre_trim_cons_result as $row)
			{
				$trims_type=$row[csf('trim_type')];
				
				
				$description=$row[csf('description')];
				if($description!="") $descriptionCond=", ".$description; else $descriptionCond="";
				$item_id=$row[csf('item_name')].$descriptionCond;
				if($trims_type==1) //Sewing
				{
						$p_sew_trim_precost_excess_arr[$item_id]['p_loss']+=$row[csf('excess_per')];
				}
				else
				{
						$p_fin_trim_precost_excess_arr[$item_id]['p_loss']+=$row[csf('excess_per')];;
				}
				
			}
		//	print_r($p_sew_trim_precost_excess_arr);
		
			//$summ_sourcing_tot_budget_dzn_val=0;
			$pre_trim_arr="select b.seq,b.id,c.trim_type,c.item_name,b.description,b.trim_group,b.tot_cons,b.ex_per,b.cons_dzn_gmts,b.cons_uom as uom, b.rate,b.amount,b.sourcing_rate,b.sourcing_nominated_supp from wo_pre_cost_trim_cost_dtls b,lib_item_group c where  c.id=b.trim_group and c.trim_type in(1,2) and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and b.job_no=$txt_job_no order by b.seq";//and b.fabric_source=2
			$pre_trim_result=sql_select($pre_trim_arr);
			
			$p_sew_trim_precost_arr=$p_fin_trim_precost_arr=array();
			foreach($pre_trim_result as $row)
			{
				$trims_type=$row[csf('trim_type')];
				
				
				$description=$row[csf('description')];
				if($description!="") $descriptionCond=", ".$description; else $descriptionCond="";
				$item_id=$row[csf('item_name')].$descriptionCond;
				//$item_name_arr[$item_id]=$row[csf('item_name')].$descriptionCond;
				$req_amt=$row[csf('cons_dzn_gmts')]*$row[csf('rate')];
				if($trims_type==1) //Sewing
				{
					$p_sew_loss=$row[csf('ex_per')];
					$ex_tot=$row[csf('cons_dzn_gmts')]+(($row[csf('cons_dzn_gmts')]*$p_sew_loss)/100);
					
					$trim_req_qty=$trim_qty_arr[$row[csf('id')]];
					//$trim_amountSourcing_arr
				$trim_req_amount=$trim_amount_arr[$row[csf('id')]];
				$trim_req_amountSourcing=$trim_amountSourcing_arr[$row[csf('id')]];
				$p_sew_trim_precost_arr[$item_id]['req_qty']+=$trim_req_qty;
				$p_sew_trim_precost_arr[$item_id]['req_amount']+=$trim_req_amount;
				$p_sew_trim_precost_arr[$item_id]['req_amount_sourcing']+=$trim_req_amountSourcing;
				$p_sew_trim_precost_arr[$item_id]['cons']+=$row[csf('tot_cons')];
				$p_sew_trim_precost_arr[$item_id]['tot_cons']+=$row[csf('cons_dzn_gmts')];
				$p_sew_trim_precost_arr[$item_id]['amount']+=$row[csf('amount')];
				$p_sew_trim_precost_arr[$item_id]['sourcing_rate']=$row[csf('sourcing_rate')];
				$p_sew_trim_precost_arr[$item_id]['sourcing_nominated_supp']=$row[csf('sourcing_nominated_supp')];
				$p_sew_trim_precost_arr[$item_id]['p_loss']=$p_sew_loss;
				//$p_sew_trim_precost_arr[$item_id]['tot_row']+=1;
				$p_sew_trim_tot_row+=1;
				$p_sew_trim_precost_arr[$item_id]['uom']=$unit_of_measurement[$row[csf('uom')]];
				$summ_fob_pcs+=$row[csf('amount')];	
				$summ_sourcing_tot_budget_dzn_val+=$trim_req_amountSourcing;
				$summ_fob_gross_value_amt+=$trim_req_amount;
				}
				else //packing/Finish
				{
					$p_fin_loss=$row[csf('ex_per')];
				//	$ex_tot=$row[csf('cons_dzn_gmts')]+(($row[csf('cons_dzn_gmts')]*$p_fin_loss)/100);
				$trim_fin_req_qty=$trim_qty_arr[$row[csf('id')]];
				$trim_fin_req_amount=$trim_amount_arr[$row[csf('id')]];
				$trim_fin_req_amountSourcing=$trim_amountSourcing_arr[$row[csf('id')]];
				//echo $trim_fin_req_qty.'='.$row[csf('sourcing_rate')];
				$p_fin_trim_precost_arr[$item_id]['req_qty']+=$trim_fin_req_qty;
				$p_fin_trim_precost_arr[$item_id]['req_amount']+=$trim_fin_req_amount;
				$p_fin_trim_precost_arr[$item_id]['req_fin_amount_sourcing']+=$trim_fin_req_amountSourcing;
				$p_fin_trim_precost_arr[$item_id]['cons']+=$row[csf('tot_cons')];
				$p_fin_trim_precost_arr[$item_id]['tot_cons']+=$row[csf('cons_dzn_gmts')];
				$p_fin_trim_precost_arr[$item_id]['amount']+=$row[csf('amount')];
				if($row[csf('sourcing_rate')]>0)
				{
				$p_fin_trim_precost_arr[$item_id]['fin_sourcing_rate']=$row[csf('sourcing_rate')];
				}
				$p_fin_trim_precost_arr[$item_id]['sourcing_nominated_supp']=$row[csf('sourcing_nominated_supp')];
				$p_fin_trim_precost_arr[$item_id]['p_loss']=$p_fin_loss;
				$p_fin_trim_tot_row+=1;
				$p_fin_trim_precost_arr[$item_id]['uom']=$unit_of_measurement[$row[csf('uom')]];	
				$summ_fob_pcs+=$row[csf('amount')];
				$summ_sourcing_tot_budget_dzn_val+=$trim_fin_req_amountSourcing; 
				$summ_fob_gross_value_amt+=$trim_fin_req_amount;
				}
				//$summ_fob_value_pcs+=$row[csf('amount')]*$order_price_per_dzn;
				
			}
			//print_r($p_sew_trim_precost_arr2);
			//echo $summ_sourcing_tot_budget_dzn_val.', ';
			
		
			 $pre_wash_arr="select b.job_no,b.id,b.emb_name,b.emb_type,b.cons_dzn_gmts, b.rate,b.amount,b.sourcing_rate,b.sourcing_nominated_supp as sourcing_nominated_supp from wo_pre_cost_embe_cost_dtls  b where  b.status_active=1 and b.is_deleted=0  and b.job_no=$txt_job_no  order by b.emb_name";//and b.fabric_source=2
			$pre_wash_result=sql_select($pre_wash_arr);
			
		//	$summ_sourcing_tot_budget_dzn_val=0;
		 
			foreach($pre_wash_result as $row)
			{
				$emb_name_id=$row[csf('emb_name')];
				$emb_type=$row[csf('emb_type')];
			
				//emblishment_embroy_type_arr
				if($emb_name_id==1) //Print type
				{
					if($emb_type>0) $emb_typeCond=", ".$emblishment_print_type[$emb_type];else $emb_typeCond="";
					$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
				}
				else if($emb_name_id==2) //embro type
				{
					if($emb_type>0) $emb_typeCond=", ".$emblishment_embroy_type_arr[$emb_type];else $emb_typeCond="";
					$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
				}
				else if($emb_name_id==4) //Special type
				{
					if($emb_type>0) $emb_typeCond=", ".$emblishment_spwork_type[$emb_type];else $emb_typeCond="";
					$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
				}
				else if($emb_name_id==5) //GMT type
				{
					if($emb_type>0) $emb_typeCond=", ".$emblishment_gmts_type[$emb_type];else $emb_typeCond="";
					$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
				}
				else if($emb_name_id==99) //GMT type
				{
					if($emb_type>0) $emb_typeCond=", ".$emblishment_other_type_arr[$emb_type];else $emb_typeCond="";
					$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
				}
				 
				$wash_req_amount=$emb_req_amount=0;
				if($row[csf('emb_name')]==3) //Wash
				{
					
				
				if($row[csf('emb_type')]>0) $wash_emb_typeCond=", ".$emblishment_wash_type[$row[csf('emb_type')]];else $wash_emb_typeCond="";
				$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$wash_emb_typeCond;
				$wash_req_qty=$wash_qtyArr[$row[csf('job_no')]][$row[csf('id')]];
				$wash_req_amount=$wash_amountArr[$row[csf('job_no')]][$row[csf('id')]];
						// echo $emb_name.'='.$wash_emb_typeCond.' <br>';
					 
				$p_wash_precost_arr[$emb_name]['req_qty']+=$wash_req_qty;
				$p_wash_precost_arr[$emb_name]['req_amount']+=$wash_req_amount;
				$p_wash_precost_arr[$emb_name]['cons']+=$row[csf('cons_dzn_gmts')];
				//$p_wash_precost_arr[$emb_name]['tot_cons']+=$row[csf('cons_dzn_gmts')];
				$p_wash_precost_arr[$emb_name]['amount']+=$row[csf('amount')];
				$p_wash_precost_arr[$emb_name]['p_loss']=$row[csf('p_loss')];
				$p_wash_precost_arr[$emb_name]['sourcing_rate']=$row[csf('sourcing_rate')];
				$p_wash_precost_arr[$emb_name]['pre_rate']=$row[csf('rate')];
				if($row[csf('sourcing_nominated_supp')])
				{
					$p_wash_precost_arr[$emb_name]['sourcing_nominated_supp']=$row[csf('sourcing_nominated_supp')];
				}
				
				$p_wash_precost_arr[$emb_name]['uom']=$unit_of_measurement[$row[csf('uom')]];
				$summ_fob_pcs+=$row[csf('amount')];
				$summ_sourcing_tot_budget_dzn_val+=$wash_req_qty*$row[csf('sourcing_rate')];
				$p_wash_tot_row+=1;	
				}
				else
				{
				$emb_req_qty=$emblishment_qtyArr[$row[csf('job_no')]][$row[csf('id')]];
				$emb_req_amount=$emblishment_amountArr[$row[csf('job_no')]][$row[csf('id')]];
				$p_embro_precost_arr[$emb_name]['req_qty']+=$emb_req_qty;
				$p_embro_precost_arr[$emb_name]['req_amount']+=$emb_req_amount;
				$p_embro_precost_arr[$emb_name]['cons']+=$row[csf('cons_dzn_gmts')];
				//$p_wash_precost_arr[$emb_name]['tot_cons']+=$row[csf('cons_dzn_gmts')];
				$p_embro_precost_arr[$emb_name]['amount']+=$row[csf('amount')];
				$p_embro_precost_arr[$emb_name]['pre_rate']+=$row[csf('rate')];
				$p_embro_precost_arr[$emb_name]['p_loss']=$row[csf('p_loss')];
				if($row[csf('sourcing_rate')]>0)
				{
				$p_embro_precost_arr[$emb_name]['sourcing_rate']=$row[csf('sourcing_rate')];
				}
				if($row[csf('sourcing_nominated_supp')])
				{
				$p_embro_precost_arr[$emb_name]['sourcing_nominated_supp']=$row[csf('sourcing_nominated_supp')];
				}
				$p_embro_precost_arr[$emb_name]['uom']=$unit_of_measurement[$row[csf('uom')]];
				$summ_fob_pcs+=$row[csf('amount')];
				$summ_sourcing_tot_budget_dzn_val+=$emb_req_qty*$row[csf('sourcing_rate')];
				$p_embro_tot_row+=1;	
				}
				//$summ_fob_value_pcs+=$row[csf('amount')]/$order_price_per_dzn;
				$summ_fob_gross_value_amt+=$emb_req_amount+$wash_req_amount;
			}
			//echo $summ_fob_gross_value_amt.'=';
				//echo $summ_fob_pcs.'A';
				//echo $summ_fob_value_pcs.'C,';
			//wo_pri_quo_comarcial_cost_dtls 
			$sql_other = "select fabric_cost, trims_cost, embel_cost, wash_cost, comm_cost, commission, lab_test, inspection, cm_cost, freight, currier_pre_cost, certificate_pre_cost, design_cost, studio_cost, common_oh, depr_amor_pre_cost, interest_cost, incometax_cost, total_cost from wo_pre_cost_dtls where  job_no=$txt_job_no  and status_active=1 and  is_deleted=0";
			$pre_other_result=sql_select($sql_other);//$summ_fob_value_pcs=0;
			 foreach( $pre_other_result as $row )
			{
				$lab_test=($row[csf('lab_test')]/$order_price_per_dzn)*$order_job_qnty;
				$currier_pre_cost=($row[csf('currier_pre_cost')]/$order_price_per_dzn)*$order_job_qnty;
				$inspection=($row[csf('inspection')]/$order_price_per_dzn)*$order_job_qnty;
				$comarcial=($row[csf('comm_cost')]/$order_price_per_dzn)*$order_job_qnty;
				
				$freight=($row[csf('freight')]/$order_price_per_dzn)*$order_job_qnty;
				$certificate_pre_cost=($row[csf('certificate_pre_cost')]/$order_price_per_dzn)*$order_job_qnty;
				$design_pre_cost=($row[csf('design_cost')]/$order_price_per_dzn)*$order_job_qnty;
				$studio_pre_cost=($row[csf('studio_cost')]/$order_price_per_dzn)*$order_job_qnty;
				$common_oh=($row[csf('common_oh')]/$order_price_per_dzn)*$order_job_qnty;
				$depr_amor_pre_cost=($row[csf('depr_amor_pre_cost')]/$order_price_per_dzn)*$order_job_qnty;
				$interest_pre_cost=($row[csf('interest_cost')]/$order_price_per_dzn)*$order_job_qnty;
				$income_tax_pre_cost=($row[csf('incometax_cost')]/$order_price_per_dzn)*$order_job_qnty;
				
				$tot_other_for_fob_value=$lab_test+$currier_pre_cost+$inspection+$comarcial+$freight+$certificate_pre_cost+$design_pre_cost+$studio_pre_cost+$common_oh+$interest_pre_cost+$income_tax_pre_cost+$depr_amor_pre_cost;
				//echo $tot_other_for_fob_value;
				$lab_test_dzn=$row[csf('lab_test')];
				$fob_pcs=$row[csf('price_with_commn_pcs')];
				$currier_pre_cost_dzn=$row[csf('currier_pre_cost')];
				$inspection_dzn=$row[csf('inspection')];
				$comarcial_dzn=$row[csf('comm_cost')];
				
				$common_oh_dzn=$row[csf('common_oh')];
				$studio_pre_cost_dzn=$row[csf('studio_cost')];
				$design_pre_cost_dzn=$row[csf('design_cost')];
				$certificate_pre_cost_dzn=$row[csf('certificate_pre_cost')];
				
				$freight_dzn=$row[csf('freight')];
				//$comm_cost_dzn=$row[csf('comm_cost')];
				$depr_amor_pre_cost_dzn=$row[csf('depr_amor_pre_cost')];
				$income_tax_pre_cost_dzn=$row[csf('incometax_cost')];
				$interest_pre_cost_dzn=$row[csf('interest_cost')];
				
				$cm_cost_dzn=$row[csf('cm_cost')];
				$cm_cost_pcs=$row[csf('cm_cost')]/$order_price_per_dzn;
				$cm_cost_req=($row[csf('cm_cost')]/$order_price_per_dzn)*$order_job_qnty;
				$tot_cm_qty_dzn=$row[csf('cm_cost')]*$offer_qty_dzn;
				//$lab_test_dzn=$row[csf('lab_test')];
				
				$tot_other_cost_dzn=$common_oh_dzn+$studio_pre_cost_dzn+$design_pre_cost_dzn+$certificate_pre_cost_dzn+$freight_dzn+$depr_amor_pre_cost_dzn+$income_tax_pre_cost_dzn+$interest_pre_cost_dzn;
				
				$tot_other_cost=($tot_other_cost_dzn/$order_price_per_dzn)*$order_job_qnty;
				//$summ_fob_value_pcs+=($tot_other_cost_dzn+$currier_pre_cost_dzn+$lab_test_dzn+$inspection_dzn+$comarcial_dzn)*$order_price_per_dzn+$cm_cost_pcs;
				// echo $tot_other_for_fob_value.'m';
				$summ_fob_gross_value_amt+=$tot_other_for_fob_value+$tot_cm_qty_dzn ;
				$summ_fob_pcs+=$tot_other_cost_dzn+$lab_test_dzn+$currier_pre_cost_dzn+$inspection_dzn+$comarcial_dzn+$cm_cost_dzn;
				$summ_sourcing_tot_budget_dzn_val+=$tot_other_for_fob_value;
				 
			}
			
			//echo $summ_fob_pcs.'S';
		 	//echo $summ_fob_gross_value_amt.'H';
			//echo $common_oh_dzn.'='.$studio_pre_cost_dzn.'='.$design_pre_cost_dzn.'='.$certificate_pre_cost_dzn.'='.$freight_dzn.'='.$depr_amor_pre_cost_dzn.'='.$income_tax_pre_cost_dzn.'='.$interest_pre_cost_dzn; 
			$sql_commi = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls  where job_no=".$txt_job_no." and status_active=1";
		$result_commi=sql_select($sql_commi);
		 foreach( $result_commi as $row )
			{
				$commission_type_id=$row[csf('particulars_id')];
				$com_type_id=$row[csf('commission_base_id')];
				
				$commission_arr[$commission_type_id]['commi_req_amt']=($row[csf('commission_amount')]/$order_price_per_dzn)*$order_job_qnty;
				$commission_arr[$commission_type_id]['commi_amt']=$row[csf('commission_amount')];
				$commission_arr[$commission_type_id]['commi_amt_pcs']=$row[csf('commission_amount')]*$order_price_per_dzn;
				//$summ_fob_value_pcs+=$row[csf('commission_amount')]/$order_price_per_dzn;
				$summ_fob_gross_value_amt+=($row[csf('commission_amount')]/$order_price_per_dzn)*$order_job_qnty;
				$summ_fob_pcs+=$row[csf('commission_amount')];
				$summ_sourcing_tot_budget_dzn_val+=($row[csf('commission_amount')]/$order_price_per_dzn)*$order_job_qnty;
			} 
		//	$summ_fob_pcs=$summ_fob_pcs/$order_price_per_dzn;
				//echo $summ_fob_pcs.'S';
			$tot_summ_fob_pcs=$summ_fob_pcs/$order_price_per_dzn;
			//echo $summ_fob_gross_value_amt.'='.$summ_sourcing_tot_budget_dzn_val.'='.$offer_qty_dzn.'d';;
			$summ_tot_final_cm=($summ_fob_gross_value_amt-$summ_sourcing_tot_budget_dzn_val)/$offer_qty_dzn;
			$summ_sourcing_fob_pcs=($summ_sourcing_tot_budget_dzn_val+$tot_cm_qty_dzn)/$order_job_qnty;
			//echo $summ_tot_final_cm.'='.$tot_cm_qty_dzn.'='.$summ_sourcing_tot_budget_dzn_val;
			
			 $supplier_library_arr=return_library_array( "select a.short_name, a.id from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id   and a.is_deleted=0  and a.status_active=1 group by a.id,a.short_name order by a.short_name", "id", "short_name");

				?>
                        <td valign="top">
                        	 <table align="left" border="1" cellpadding="1" cellspacing="1" style="width:270px; margin:5px;" rules="all">
                             <caption> <b>Summary </b></caption>
							<tr>
								<td width="80"><b>Header </b></td>
                                <td width="80"><b>Pre Cost</b> </td>
								<td width="80"><b>Final Cost</b></td>
								
							</tr>
                            <tr>
								<td>Po Qty <?=$unit_of_measurement[$order_uom];?></td>
								<td colspan="3" title="=<? echo $order_job_qnty.' '.$order_cond;?>"><b><? 
								//$fob_pcs=$fob_pcs;//$summ_fob_gross_value_amt/$offer_qty_dzn;
								echo  number_format($order_job_qnty,0); ?></b></td>
							 </tr> 
                             
                              <tr>
								<td>Unit Price/<?=$unit_of_measurement[$order_uom];?></td>
								<td colspan="3" title="Price=<? echo $avg_unit_price;?>"><b><? 
								//$fob_pcs=$fob_pcs;//$summ_fob_gross_value_amt/$offer_qty_dzn;
								echo  number_format($avg_unit_price,4); ?></b></td>
							 </tr> 
                             <tr>
								<td>SMV/<?=$unit_of_measurement[$order_uom];?></td>
								<td colspan="3" title="=<? //echo $summ_fob_gross_value_amt;?>"><b><? 
								//$fob_pcs=$fob_pcs;//$summ_fob_gross_value_amt/$offer_qty_dzn;
								echo  number_format($sew_smv,4); ?></b></td>
							 </tr> 
							<tr>
								<td>FOB/<?=$unit_of_measurement[$order_uom];?></td>
								<td  title="FOBValue=<? echo $summ_fob_pcs;?>"><b><? 
								//$fob_pcs=$fob_pcs;//$summ_fob_gross_value_amt/$offer_qty_dzn;
								echo  number_format($tot_summ_fob_pcs,4); ?></b></td>
                                <td  title="Total value(<? echo $summ_sourcing_tot_budget_dzn_val+$tot_cm_qty_dzn;?>)/PO Qty <?=$unit_of_measurement[$order_uom];?>"><b><? 
								//$fob_pcs=$fob_pcs;//$summ_fob_gross_value_amt/$offer_qty_dzn;
							//	echo  number_format($summ_sourcing_fob_pcs,4); ?></b></td>
							 </tr> 
                             <tr>
								<td>Margin/<?=$unit_of_measurement[$order_uom];?>(USD)</td>
								<td  title="Avg Rate-FoB Pcs=<? //echo $summ_fob_gross_value_amt;?>"><b><? 
								 $margin_pre=$avg_unit_price-$tot_summ_fob_pcs;
								 $margin_final=$avg_unit_price-$summ_sourcing_fob_pcs;
								echo  number_format($margin_pre,6); ?></b></td>
                                <td  title="Avg Rate-Sourcing FoB Pcs=<? //echo $summ_fob_gross_value_amt;?>"><b><? 
								//$fob_pcs=$fob_pcs;//$summ_fob_gross_value_amt/$offer_qty_dzn;
								//echo  number_format($margin_final,4); ?></b></td>
							 </tr> 
							<tr>
								<td>CM/Dzn(USD)</td>  
								<td><b><? echo number_format($cm_cost_dzn,6); ?></b></td>
                                <td title="Gross Fob-Sourcing Budget Dzn/PO Qty Dzn"><b><? echo number_format($summ_tot_final_cm,6); ?></b></td>
							 </tr> 
                             <tr>
								<td>E.P.M(USD)</td>
								<td title="CM/Costing Per/Sew SMV"><b><? echo number_format($cm_cost_dzn/$order_price_per_dzn/$sew_smv,6); ?></b></td>
                                <td title="CM Final /Costing Per/Sew SMV"><b><? echo number_format($summ_tot_final_cm/$order_price_per_dzn/$sew_smv,6); ?></b></td>
							 </tr> 
						</table>
                        </td>
                        <td valign="top">
                        <?
                        $nameArray_imge =sql_select("SELECT image_location,real_file_name FROM common_photo_library where master_tble_id=".$txt_job_no." and file_type=1");
						//echo "SELECT image_location,real_file_name FROM common_photo_library where master_tble_id=".$txt_job_no." and file_type=1";
						?>
                <table width="210">
                <tr>
                <?
				 $path="../../";
				$img_counter = 0;
                foreach($nameArray_imge as $result_imge)
				{
				     

					?>
					<td>
						<!--<img src="../../<? //echo $result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />-->
                        <img src="<? echo $path .''. $result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />
                       <?
					  
					   ?>
					</td>
					<?

					$img_counter++;
				}
				?>
               	 </tr>
           		</table>
                        </td>
                         <td valign="top">
                        	 <table align="left" border="1" cellpadding="1" cellspacing="1" style="width:260px; margin:1px;" rules="all">
                            
                            <tr>
								<td>Order Confirmation Date	</td>
								 <td><b><? echo $po_received_date; ?></b></td>
							 </tr> 
                             
                              <tr>
								<td>Sourcing Rcvd Date	</td>
								<td><b><? echo $sourcing_date; ?></b></td>
							 </tr> 
                              <tr>
								<td>Pack Handover Date</td>
								 <td><b><? echo $pack_handover_date; ?></b></td>
							 </tr> 
                              <tr>
								<td title="Ship Date">Garments Delivery Date	</td>
								<td><b><? echo $shipment_dateActual; ?></b></td>
							 </tr> 
                              <tr>
								<td>Total Garment Lead Time	</td>
								<td><b><? if($shipment_dateActual!="") echo $leadtime_days_remian.' Days';else echo " "; ?></b></td>
							 </tr> 
                              <tr>
								 
								<td colspan="2" align="center"><b style="color: #F00; font-size:24px;">
											<? if( $approved==1)
											{
													echo "Approved";
											}
											else if( $approved==3)
											{
													echo "Partial Approved";
											}
											else echo " Un-Approved";
								  ?></b></td>
							 </tr> 
                             
						</table>
                        </td>
                        </tr>
                      
                        </table>
                        <style>
						#td_boder{ border-right:solid 3px;};
						</style>
					<?
			
			 //end first foearch
			
			 
			
			?>
            <div style="">
             	<table align="left" border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px;" rules="all"> 
                <tr>
                <th colspan="11" style="background-color:#963;font-size:20px;" id="td_boder"> <b>Merchandiser's Part</b></th>
                 <th colspan="4"  style="background-color: #996;font-size:20px;"> <b>Budget- Sourcing Part</b></th>
                </tr>
                 <tr>
                    <th  width="20">SL </th>
                    <th  width="100" title="Fabric">ITEM DESCRIPTION </th>
                    <th  width="70">Cons/Dzn</th>
                    <th  width="70">Wast % </th>
                    <th  width="70">Total Cons/Dzn</th>
                    <th  width="50">UOM </th>
                    <th  width="70">Req. Qty</th>
                    <th  width="70">Rate(USD)</th>
                    <th  width="70">Cost/Dzn</th>
                    <th  width="70">Cost/Pc</th>
                    <th  width="70" id="td_boder">Total <br>Budget</th>
                    
                    <th  width="70">Rate(USD)</th>
                    <th  width="70">Total Budget</th>
                    <th  width="70">Balance /<br>Excess</th>
                    <th  width="70">Supplier</th>
                   
                    </tr>
                    
                    <?
					$f=1;$tot_fab_amount=$tot_fab_amount_pcs=$tot_fab_req_amount=0;$ff=1;$tot_fab_req_sourcing_amount=$tot_fab_req_sourcing_bal_amount=0;
                    foreach($p_fab_precost_arr as $fab_cost_dtls_id=>$fab_cost_dtls_data)
					{
						foreach ($fab_cost_dtls_data as $fab_type=>$fab_data) 
						{
							 foreach($fab_data as $fab_desc=>$row)
							{
							if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
							
							$nominated_supp_str=""; 
							 $exnominated_supp=explode(",",$row[('sourcing_nominated_supp')]);
							 foreach($exnominated_supp as $supp)
							 {
								if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_arr[$supp]; else $nominated_supp_str.=','.$supplier_library_arr[$supp];
							 }	
							 $stock='';
							 if($row[('fabric_source')]==4)
							 {
								$stock="<b style='color:red'> (Stock Fabric) </b>";
								 
							 }
							 
							 //$sourcing_req_amount=$;
	                    ?>
	                	<tr bgcolor="<? echo $bgcolor;?>">
	                   
	                    <td width="20" align="center"><p><? echo $f; ?></p></td>
	                   
	                    <td width="100"><div style="word-break:break-all"><? echo $fab_desc.$stock;//echo $fab_type.','.$fab_desc; ?></div></td>
	                    <td width="70" align="right"><p><? echo number_format($row[('cons')],6); ?></p></td>
	                    <td width="70" align="right"><p><? echo number_format($row[('p_loss')],6); ?></p></td>
	                    <td width="70" align="right"><p><? echo number_format($row[('tot_cons')],6); ?></p></td>
	                    <td width="50"><p><? echo $row[('uom')]; ?></p></td>
	                    <td width="70" align="right"><p><? echo number_format($row[('req_qty')],6); ?></p></td>
	                    <td width="70" align="right"><p><? echo number_format($row[('req_amount')]/$row[('req_qty')],6); ?></p></td>
	                    <td width="70"align="right"><p><? echo number_format($row[('amount')],6); ?></p></td>
	                    <td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,6); ?></p></td>
	                    <td width="70"  id="td_boder" align="right"><p><? echo number_format($row[('req_amount')],6); ?></p></td>
	                    
	                    <td width="70" align="right"><p><? echo number_format($row[('sourcing_req_amount')]/$row[('req_qty')],6); ?></p></td>
	                    <td width="70"align="right" title="S.Rate=<? echo $row[('sourcing_rate')];?>"><p><? $sourcing_amount=$row[('sourcing_req_amount')];;echo number_format($sourcing_amount,6); ?></p></td>
	                    <td width="70" align="right" title="Marchandiser Amount-Sourcing Amount"><p><?  $bal_sourcing_amount=$row[('req_amount')]-$sourcing_amount;echo number_format($bal_sourcing_amount,6); ?></p></td>
	                    <td width="70" align="center"><div style="word-break:break-all"><?  echo $nominated_supp_str; ?></div></td>
	                   
	                    </tr>
						<?
							$f++;$ff++;
							$tot_fab_amount+=$row[('amount')];
							$tot_fab_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
							$tot_fab_req_amount+=$row[('req_amount')];
							$tot_fab_req_sourcing_amount+=$row[('sourcing_req_amount')];
							$tot_fab_req_sourcing_bal_amount+=$bal_sourcing_amount;
							}
						}
					}
					?>
                     
                   
                      <tr style="font-size:17px; background-color:#CCC">
                        <td colspan="8"> <b style="float:left">A Total Fabric Cost</b></td>
                        <td  align="right"><b><? echo number_format($tot_fab_amount,6); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_fab_amount_pcs,6); ?></b></td>
                        <td  align="right" id="td_boder"><b><? echo number_format($tot_fab_req_amount,6); ?></b></td>
                        <td  align="right"><b><? //echo number_format($tot_fab_amount,6); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_fab_req_sourcing_amount,6); ?></b></td>
                        <td  align="right"><b><?  echo number_format($tot_fab_req_sourcing_bal_amount,6); ?></b></td>
                        <td  align="right"><b><? //echo number_format($tot_fab_req_amount,6); ?></b></td>
                        
                    </tr>
                     
                </table>
                <br>
                <?
               // die;
				?>
                <table class="rpt_table" align="left" border="1" cellpadding="1" cellspacing="1"  width="98%" style="margin:5px;" rules="all">
                
                 <thead>
                 <tr>
                 	
                    <th  width="20">SL </th>

                    <th  width="100" title="Trim sew">ITEM DESCRIPTION </th>
                    <th  width="70">Cons/Dzn</th>
                    <th  width="70">Wast % </th>
                    <th  width="70">Total Cons/Dzn</th>
                    <th  width="50">UOM </th>
                    <th  width="70">Req. Qty</th>
                    <th  width="70">Rate(USD)</th>
                    <th  width="70">Cost/Dzn</th>
                    <th  width="70">Cost/Pc</th>
                    <th  width="70" id="td_boder">Total Budget</th>
                  
                    <th  width="70">Rate(USD)</th>
                    <th  width="70">Total Budget</th>
                    <th  width="70">Balance /<br>Excess</th>
                    <th  width="70">Supplier</th>
                    
                    </tr>
                    </thead>
                     
                    <?
					$ts=1;$tot_sew_amount=$tot_amount_pcs=$tot_sew_amount_pcs=$tot_sew_req_amount=0;$ttts=1;$tot_sew_req_sourcing_amount=$tot_sew_req_sourcing_bal_amount=0;
                    foreach($p_sew_trim_precost_arr as $item_id=>$row)
					{
						
						if($ts%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
						$nominated_supp_str=""; 
						 $exnominated_supp=explode(",",$row[('sourcing_nominated_supp')]);
						 foreach($exnominated_supp as $supp)
						 {
							if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_arr[$supp]; else $nominated_supp_str.=','.$supplier_library_arr[$supp];
						 }		
						 $req_amountSourcing=$row[('req_amount_sourcing')];
                    ?>
                	<tr bgcolor="<? echo $bgcolor;?>">
                   
                    <td width="20" align="center"><p><? echo $ts; ?></p></td>
                    <td width="100" ><div style="word-break:break-all"><? echo $item_id; ?></div></td> 
                    <td width="70" align="right"><p><? echo number_format($row[('cons')],6); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('p_loss')],6); ?></p></td>
                    <td width="70" align="right"><p><?  if($row[('p_loss')]>0) echo number_format($row[('tot_cons')],6);else echo number_format($row[('cons')],6);?></p></td>
                    <td width="50" align="left"><p><? echo $row[('uom')]; ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('req_qty')],6); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('req_amount')]/$row[('req_qty')],6); ?></p></td>
                    <td width="70"align="right"><p><? echo number_format($row[('amount')],6); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,6); ?></p></td>
                    <td width="70" id="td_boder" align="right"><p><? echo number_format($row[('req_amount')],6); ?></p></td>
                    
                    <td width="70" align="right"><p><? echo number_format($req_amountSourcing/$row[('req_qty')],6); ?></p></td>
                    <td width="70"align="right"  title="SouringAmt=<? echo $req_amountSourcing.', Rate'.$row[('sourcing_rate')];?>"><p><? $sourcing_amount=$req_amountSourcing;echo number_format($sourcing_amount,6); ?></p></td>
                    <td width="70" align="right"><p><?  $bal_sourcing_amout=$row[('req_amount')]-$sourcing_amount;echo number_format($bal_sourcing_amout,6); ?></p></td>
                    <td width="70" align="center"><div style="word-break:break-all"><? echo $nominated_supp_str; ?></div></td>
                     
                    </tr>
					<?
						$ts++;$ttts++;
						$tot_sew_amount+=$row[('amount')];
						$tot_sew_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
						$tot_sew_req_amount+=$row[('req_amount')];
						$tot_sew_req_sourcing_amount+=$sourcing_amount;//$row[('sourcing_rate')]*$row[('req_qty')];
						$tot_sew_req_sourcing_bal_amount+=$bal_sourcing_amout;
						
					}
					?>
                     

                     
                    <tr style="font-size:17px; background-color:#CCC">
                        <td colspan="8" align="left"><b>B-SubTotal for Sewing Trims Cost:</b></td>
                        <td  align="right"><b><? echo number_format($tot_sew_amount,6); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_sew_amount_pcs,6); ?></b></td>
                        <td  align="right" id="td_boder"><b><? echo number_format($tot_sew_req_amount,6); ?></b></td>
                        
                         <td  align="right"><b><? //echo number_format($tot_sew_amount,6); ?></b></td>
                          <td  align="right"><b><? echo number_format($tot_sew_req_sourcing_amount,6); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_sew_req_sourcing_bal_amount,6); ?></b></td>
                        <td  align="right"><b><? //echo number_format($tot_sew_req_amount,6); ?></b></td>
                       
                        
                    </tr>
                    
                     
                </table>
                 <br>
                <table align="left" border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px;" rules="all"> 
                 <tr>
                 	
                    <th width="20">SL </th>
                    <th  width="100" title="Trim Fin">ITEM DESCRIPTION </th>
                    <th  width="70">Cons/Dzn</th>
                    <th width="70">Wast % </th>
                    <th width="70">Total Cons/Dzn</th>
                    <th width="50">UOM </th>
                    <th width="70">Req. Qty</th>
                    <th width="70">Rate(USD)</th>
                    <th width="70">Cost/Dzn</th>
                    <th width="70">Cost/Pc</th>
                    <th width="70" id="td_boder">Total Budget</th>
                    
                    <th  width="70">Rate(USD)</th>
                    <th  width="70">Total Budget</th>
                    <th  width="70">Balance /Excess</th>
                    <th  width="70">Supplier</th>
                    </tr>
                     
                    <?
					$tf=1;$tot_fin_amount=$tot_fin_amount_pcs=$tot_fin_req_amount=0;$tttf=1;$tot_fin_req_sourcing_amount=$tot_fin_req_sourcing_bal_amount=0;
                    foreach($p_fin_trim_precost_arr as $item_id=>$row)
					{
						
						if($tf%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
						// $nominated_supp_str=""; 
						//  $exnominated_supp=explode(",",$row[('sourcing_nominated_supp')]); 
						//  foreach($exnominated_supp as $supp)
						//  {
						// 	if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_arr[$supp]; else $nominated_supp_str.=','.$supplier_library_arr[$supp];
						//  }
						$exnominated_supp=explode("_",$row[('sourcing_nominated_supp')]);
						foreach($exnominated_supp as $key=>$suppdata)
						{
						   if($key==0){
							   $suppdataarr=explode(",",$suppdata);
							   foreach($suppdataarr as $supp){
								  
								   if($nominated_supp_str=="") $nominated_supp_str=$supplier_arr[$supp]; else $nominated_supp_str.=','.$supplier_library_arr[$supp];
							   }
						   }
						   else{
							   $comdataarr=explode(",",$suppdata);
							   foreach($comdataarr as $comid){
								   if($nominated_supp_str=="") $nominated_supp_str=$working_company_arr[$comid]; else $nominated_supp_str.=','.$working_company_arr[$comid];
							   }
						   }

						}	
						  $req_fin_amountSourcing=$row[('req_fin_amount_sourcing')];		
                    ?>
                	<tr bgcolor="<? echo $bgcolor;?>">                     
                    <td width="20" align="center"><p><? echo $tf; ?></p></td>
                    <td width="100"><div style="word-break:break-all"><? echo  $item_id; ?></div></td> 
                    
                    <td width="70" align="right"><p><? echo number_format($row[('cons')],6); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('p_loss')],6); ?></p></td>
                    <td width="70" align="right"><p><?   if($row[('p_loss')]>0) echo number_format($row[('tot_cons')],6);else echo number_format($row[('cons')],6); //echo number_format($row[('tot_cons')],6); ?></p></td>
                    <td width="50"><p><? echo $row[('uom')]; ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('req_qty')],6); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('req_amount')]/$row[('req_qty')],6); ?></p></td>
                    <td width="70"align="right"><p><? echo number_format($row[('amount')],6); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,6); ?></p></td>
                    <td width="70" align="right" id="td_boder"><p><? echo number_format($row[('req_amount')],6); ?></p></td>
                    
                    <td width="70" align="right" title="Amt=<? echo $req_fin_amountSourcing.',Rate'.$row[('fin_sourcing_rate')];?>"><p><? echo number_format($req_fin_amountSourcing/$row[('req_qty')],6); ?></p></td>
                     <td width="70"align="right"><p><? $fin_sourcing_amount=$req_fin_amountSourcing;//$row[('fin_sourcing_rate')]*$row[('req_qty')];
					 echo number_format($fin_sourcing_amount,6); ?></p></td>
                    <td width="70" align="right"><p><?  $fin_bal_sourcing_amout=$row[('req_amount')]-$fin_sourcing_amount;echo number_format($fin_bal_sourcing_amout,6); ?></p></td>
                    <td width="70" align="center"><div style="word-break:break-all"><? echo $nominated_supp_str; ?></div></td>
                     
                    </tr>
                    
                    
					<?
						$tf++;$tttf++;
						$tot_fin_amount+=$row[('amount')];
						$tot_fin_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
						$tot_fin_req_amount+=$row[('req_amount')];
						$tot_fin_req_sourcing_amount+=$fin_sourcing_amount;
						$tot_fin_req_sourcing_bal_amount+=$fin_bal_sourcing_amout;
						
					}
					?>
                     
                    
                     <tr style="font-size:17px; background-color:#CCC">
                      
                        <td colspan="8"> <b>C-Sub Total for Finishing & Packing Trims Cost:</b></td>
                        <td  align="right"><b><? echo number_format($tot_fin_amount,6); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_fin_amount_pcs,6); ?></b></td>
                        <td  align="right" id="td_boder"><b><? echo number_format($tot_fin_req_amount,6); ?></b></td>
                        <td  align="right"><b><? //echo ($row[('req_amount')]); ?></b></td>
                      
                        <td  align="right"><b><? echo number_format($tot_fin_req_sourcing_amount,6); ?></b></td>
                        <td  align="right"><b><?  echo number_format($tot_fin_req_sourcing_bal_amount,6); ?></b></td>
                        <td  align="right"><b><? //echo number_format($tot_fin_req_amount,6); ?></b></td>
                        
                        
                    </tr>
                    
                    <tr style="font-size:17px; background-color:#CCC">
                       
                        <td colspan="8"><b>Total Trims Cost [B+C]:</b></td>
                        <td  align="right"><b><? $trim_sew_fin_amt=$tot_sew_amount+$tot_fin_amount;echo number_format($trim_sew_fin_amt,6); ?></b></td>
                        <td  align="right"><b><? $trim_sew_fin_amt_pcs=$tot_sew_amount_pcs+$tot_fin_amount_pcs; echo number_format($trim_sew_fin_amt_pcs,6); ?></b></td>
                        <td  align="right" id="td_boder"><b><? $trim_fin_req_amount=$tot_sew_req_amount+$tot_fin_req_amount; echo number_format($trim_fin_req_amount,6); ?></b></td>
                        <td  align="right"><b><? //echo ($row[('req_amount')]); ?></b></td>
                        
                        <td  align="right"><b><? $tot_sourcing_trim_sew_fin_amount=$tot_fin_req_sourcing_amount+$tot_sew_req_sourcing_amount; echo number_format($tot_sourcing_trim_sew_fin_amount,6); ?></b></td>
                        <td  align="right"><b><?  $tot_trim_source_amount_bal=$trim_fin_req_amount-$tot_sourcing_trim_sew_fin_amount;echo number_format($tot_trim_source_amount_bal,6); ?></b></td>
                        <td  align="right"><b><? //$trim_fin_req_amount=$tot_sew_req_amount+$tot_fin_req_amount; echo number_format($trim_fin_req_amount,4); ?></b></td>
                       
                        
                    </tr>
                  
                </table>
                <br>
                 <?
                // die;
				 ?>
                <table align="left" border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px;" rules="all"> 
                <caption><b style="float:left">Gmts Wash</b></caption>
                 <tr>
                  
                    <th width="20">SL </th>
                    <th width="100" title="Wash ">ITEM DESCRIPTION </th>
                    <th width="70">Cons/Dzn</th>
                    <th width="70">Wast % </th>
                    <th width="70">Total Cons/Dzn</th>
                    <th width="50">UOM </th>
                    <th width="70">Req. Qty</th>
                    <th width="70"> Rate(USD)</th>
                    <th width="70">Cost/Dzn</th>
                    <th width="70">Cost/Pc</th>
                    <th width="70" id="td_boder">Total Budget</th>
                    
                    <th  width="70">Rate(USD)</th>
                    <th  width="70">Total Budget</th>
                    <th  width="70">Balance /Excess</th>
                    <th  width="70">Supplier</th>
                    
                    </tr>
                    
                    <?
					$w=1;$tot_wash_amount=$tot_wash_amount_pcs=$tot_wash_req_amount=$tot_wash_sourcing_req_amount=$tot_wash_sourcing_req_amount_bal=0;$ws=1;
                    foreach($p_wash_precost_arr as $embname_id=>$row)
					{
						
						if($w%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
						  $wash_nominated_supp_str=""; 
						//  $exnominated_suppArr=explode(",",$row[('sourcing_nominated_supp')]);
						//  foreach($exnominated_suppArr as $supp)
						//  {
						// 	if($wash_nominated_supp_str=="") $wash_nominated_supp_str=$supplier_library_arr[$supp]; else $wash_nominated_supp_str.=','.$supplier_library_arr[$supp];
						//  }	
					//	echo $row[('sourcing_nominated_supp')].'DDDDDDDDDDDDDDDDDDDDDDDDDDDDDDD';
						$exnominated_supp=explode("_",$row[('sourcing_nominated_supp')]);
						foreach($exnominated_supp as $key=>$suppdata)
						{
						   if($key==0){
							   $suppdataarr=explode(",",$suppdata);
							   foreach($suppdataarr as $supp){
								  
								   if($wash_nominated_supp_str=="") $wash_nominated_supp_str=$supplier_library_arr[$supp]; else $wash_nominated_supp_str.=','.$supplier_library_arr[$supp];
							   }
						   }
						   else{
							   $comdataarr=explode(",",$suppdata);
							   foreach($comdataarr as $comid){
								   if($wash_nominated_supp_str=="") $wash_nominated_supp_str=$short_company_arr[$comid]; else $wash_nominated_supp_str.=','.$short_company_arr[$comid];
							   }
						   }

						}		
                    ?>
                	<tr bgcolor="<? echo $bgcolor;?>">
                    
                    <td width="20" align="center"><p><? echo $w; ?></p></td>
                    <td width="100"><div style="word-break:break-all"><? $embname_id=explode(", ",$embname_id);echo $embname_id[1]; ?></div></td> 
                    
                    <td width="70" align="right"><p><? echo number_format($row[('cons')],6); ?></p></td>
                    <td width="70" align="right"><p><? //echo $row[('p_loss')]; ?></p></td>
                    <td width="70" align="right"><p><?  echo number_format($row[('cons')],6) ?></p></td>
                    <td width="50"><p><? echo 'Dzn'; ?></p></td>
                    <td width="70" align="right" title="<? echo $row[('req_qty')];?>"><p><? echo number_format($row[('req_qty')],6); ?></p></td>
                    <td width="70" align="right" title="Rate=<? //echo $row[('req_amount')]/$row[('req_qty')];?>"><p><? echo $row[('pre_rate')]; //number_format($row[('req_amount')]/$row[('req_qty')],4); ?></p></td>
                    <td width="70"align="right"><p><? echo number_format($row[('amount')],6); ?></p></td>
                    <td width="70" align="right"  ><p><? echo number_format($row[('amount')]/$order_price_per_dzn,6); ?></p></td>
                    <td width="70" align="right" id="td_boder"><p><? echo number_format($row[('pre_rate')]*$row[('req_qty')],6); ?></p></td>
                    
                    <td width="70" align="right" title="S.Rate=<? echo $row[('sourcing_rate')];?>"><p><? echo number_format($row[('sourcing_rate')],6); ?></p></td>
                    <td width="70"align="right"><p><? $sourcing_tot_amount=$row[('req_qty')]*$row[('sourcing_rate')]; echo number_format($sourcing_tot_amount,6); ?></p></td>
                    <td width="70" align="right"><p><? $sourcing_tot_amount_bal=($row[('pre_rate')]*$row[('req_qty')])-$sourcing_tot_amount;echo number_format($sourcing_tot_amount_bal,6); ?></p></td>
                    <td width="70" align="center"><div style="word-break:break-all"><? echo rtrim($wash_nominated_supp_str,','); ?></div></td>
                   
                    </tr>
                    
                    
					<?
						$w++;$ws++;
						$tot_wash_amount+=$row[('amount')];
						$tot_wash_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
						$tot_wash_req_amount+=$row[('pre_rate')]*$row[('req_qty')];//$row[('req_amount')];
						$tot_wash_sourcing_req_amount+=$sourcing_tot_amount;
						$tot_wash_sourcing_req_amount_bal+=$sourcing_tot_amount_bal;
						
					}
					?>
                     
                     
                    <tr style="font-size:17px; background-color:#CCC">
                         
                        <td colspan="8"> <b>D-Total Wash Cost :</b></td>
                        <td  align="right"><b><? echo number_format($tot_wash_amount,6); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_wash_amount_pcs,6); ?></b></td>
                        <td  align="right" id="td_boder"><b><? echo number_format($tot_wash_req_amount,6); ?></b></td>
                        <td  align="right"><b><? //echo ($row[('req_amount')]); ?></b></td>
                        
                         <td  align="right"><b><? echo number_format($tot_wash_sourcing_req_amount,6); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_wash_sourcing_req_amount_bal,6); ?>&nbsp;</b></td>
                        <td  align="right"><b><? //echo number_format($tot_wash_req_amount,6); ?></b></td>
                        
                    </tr>
                </table>

                <br>
               
                <table align="left" border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px;" rules="all"> 
                <caption><b style="float:left">Embellishment Cost</b></caption>
                 <tr>
                 	 
                    <th width="20">SL </th>
                    <th width="100" title="">ITEM DESCRIPTION </th>
                    <th width="70">Cons/Dzn</th>
                    <th width="70">Wast % </th>
                    <th width="70">Total Cons/Dzn</th>
                    <th width="50">UOM </th>
                    <th width="70">Req. Qty</th>
                    <th width="70">Rate(USD)</th>
                    
                    <th width="70">Cost/Dzn</th>
                    <th width="70">Cost/Pc</th>
                    <th width="70" id="td_boder">Total Budget</th>
                    
                    <th  width="70">Rate(USD)</th>
                    <th  width="70">Total Budget</th>
                    <th  width="70">Balance /Excess</th>
                    <th  width="70">Supplier</th>
                    
                    </tr>
                      
                    <?
					$em=1;$tot_embro_amount=$tot_embro_amount_pcs=$tot_embro_req_amount=$tot_emb_sourcing_req_amount=$tot_emb_sourcing_req_amount_bal=0;$emb=1;
                    foreach($p_embro_precost_arr as $embname_id=>$row)
					{
						
						if($w%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
						$emb_nominated_supp_str=""; 
						// $emb_nominated_supp_str=""; 
						//  $emb_exnominated_suppArr=explode(",",$row[('sourcing_nominated_supp')]);
						//  foreach($emb_exnominated_suppArr as $supp)
						//  {
						// 	if($emb_nominated_supp_str=="") $emb_nominated_supp_str=$supplier_library_arr[$supp]; else $emb_nominated_supp_str.=','.$supplier_library_arr[$supp];
						//  }	
						//echo $row[('sourcing_nominated_supp')].'=DDD';
						$exnominated_supp=explode("_",$row[('sourcing_nominated_supp')]);
						foreach($exnominated_supp as $key=>$suppdata)
						{
						 // echo $key.'=A';
							if($key==0){
							   $suppdataarr=explode(",",$suppdata);
							   foreach($suppdataarr as $supp){
								  
								   if($emb_nominated_supp_str=="") $emb_nominated_supp_str=$supplier_library_arr[$supp]; else $emb_nominated_supp_str.=','.$supplier_library_arr[$supp];
							   }
						   }
						   else{
							   $comdataarr=explode(",",$suppdata);
							   foreach($comdataarr as $comid){
								   if($emb_nominated_supp_str=="") $emb_nominated_supp_str=$short_company_arr[$comid]; else $emb_nominated_supp_str.=','.$short_company_arr[$comid];
							   }
						   }

						}		
                    ?>
                	<tr bgcolor="<? echo $bgcolor;?>">
                     
                    <td width="20" align="center"><p><? echo $em; ?></p></td>
                    <td width="100"><div style="word-break:break-all"><? echo $embname_id; ?></div></td> 
                    
                    <td width="70" align="right"><p><? echo number_format($row[('cons')],6); ?></p></td>
                    <td width="70" align="right"><p><? //echo $row[('p_loss')]; ?></p></td>
                    <td width="70" align="right"><p><?  echo number_format($row[('cons')],6); ?></p></td>
                    <td width="50"><p><? echo 'Dzn'; ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('req_qty')],6); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('req_amount')]/$row[('req_qty')],6); ?></p></td>
                    
                    <td width="70"align="right"><p><? echo number_format($row[('amount')],6); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,6); ?></p></td>
                    <td width="70" align="right" id="td_boder"><b><? echo number_format($row[('req_amount')],6); ?></b></td>
                    
                     <td width="70" align="right"><p><? echo number_format($row[('sourcing_rate')],6); ?></p></td>
                    <td width="70"align="right"><p><? $emb_sourcing_tot_amount=$row[('req_qty')]*$row[('sourcing_rate')]; echo number_format($emb_sourcing_tot_amount,6); ?></p></td>
                    <td width="70" align="right"><p><? $emb_sourcing_tot_amount_bal=$row[('req_amount')]-$emb_sourcing_tot_amount;echo number_format($emb_sourcing_tot_amount_bal,6); ?></p></td>
                    <td width="70" align="center"><div style="word-break:break-all"><? echo rtrim($emb_nominated_supp_str,','); ?></div></td>
                    
                      
                    </tr>
					<?
						$em++;$emb++;
						$tot_embro_amount+=$row[('amount')];
						$tot_embro_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
						$tot_embro_req_amount+=$row[('req_amount')];
						$tot_emb_sourcing_req_amount+=$emb_sourcing_tot_amount;
						$tot_emb_sourcing_req_amount_bal+=$emb_sourcing_tot_amount_bal;
						
					}
					?>
                     
                     
                     <tr style="font-size:17px; background-color:#CCC">
                         
                        <td colspan="8"> <b>E-Total Embellishment Cost:</b></td>
                        <td  align="right"><b><? echo number_format($tot_embro_amount,6); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_embro_amount_pcs,6); ?></b></td>
                        <td  align="right" id="td_boder"><b><? echo number_format($tot_embro_req_amount,6); ?></b></td>
                        
                        <td  align="right"><b><? //echo number_format($tot_embro_amount,6); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_emb_sourcing_req_amount,6); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_emb_sourcing_req_amount_bal,6); ?></b></td>
                        <td  align="right"><b><? //echo number_format($tot_wash_req_amount,6); ?></b></td>
                    </tr>
                   
                </table>
                <br>
                 
                <table align="left" border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px;" rules="all"> 
               		 <caption><b style="float:left">Others Components</b></caption>
                 <tr>
                 	 
                    <th width="20">SL </th>
                    <th title="520"><b>Others Components</b> </th>
                   
                    <th width="70"><b>Cost/Dzn</b></th>
                    <th width="70"><b>Cost/Pc</b></th>
                    <th width="70" id="td_boder"><b>Total Budget</b></th>
                    
                    <th  width="70">Rate(USD)</th>
                    <th  width="70">Total Budget</th>
                    <th  width="70">Balance /Excess</th>
                    <th  width="70">&nbsp;</th>
                    </tr>
                    
                    <?
					//$em=1;$tot_embro_amount=$tot_embro_amount_pcs=$tot_embro_req_amount=0;$emb=1;
						$bgcolor="#E9F3FF";
						$bgcolor2="#FFFFFF";//currier_pre_cost_dzn
					 
                      
                   // $tot_other_cost=0;
					$tot_other_cost_first=$tot_other_cost+$comarcial+$inspection+$currier_pre_cost+$lab_test;
					
						$total_other_cost_dzn=$tot_other_cost_dzn+$comarcial_dzn+$inspection_dzn+$lab_test_dzn+$currier_pre_cost_dzn;
						 $tot_other_cost_pcs=$tot_other_cost_dzn/$order_price_per_dzn;
						 $tot_comarcial_dzn_pcs=$comarcial_dzn/$order_price_per_dzn;
						 $tot_inspection_dzn_pcs=$inspection_dzn/$order_price_per_dzn;
						  $currier_pre_cost_dzn_pcs=$currier_pre_cost_dzn/$order_price_per_dzn;
						  $tot_lab_test_dzn_pcs=$lab_test_dzn/$order_price_per_dzn;
						 
						$total_other_cost_pcs=$tot_other_cost_pcs+$tot_comarcial_dzn_pcs+$tot_lab_test_dzn_pcs+$tot_inspection_dzn_pcs+$currier_pre_cost_dzn_pcs;
						
						
						
						$tot_other_cost_req_amount=$tot_other_cost_first;
						
					
					?>
                	<tr bgcolor="<? echo $bgcolor;?>">
                    
                    <td width="20" align="center"><p>1</p></td>
                    <td width="520" align="" ><b>Test Charge</b></td> 
                    <td width="70"align="right"><p><? echo number_format($lab_test_dzn,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><?   echo number_format($tot_lab_test_dzn_pcs,6); ?>&nbsp;</p></td>
                    <td width="70" align="right" id="td_boder"><p><? echo number_format($lab_test,6); ?>&nbsp;</p></td>
                    
                    <td width="70" align="right"><p><? //echo number_format($lab_test,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($lab_test,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo '0'; ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? //echo number_format($lab_test,6); ?>&nbsp;</p></td>
                     
                    
                    </tr>
                    <tr>
                     <td width="20" align="center" ><p>2</p></td>
                    <td width="520"><b>Courier Charge</b></td> 
                    <td width="70"align="right"><p><? echo number_format($currier_pre_cost_dzn,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><?  echo number_format($currier_pre_cost_dzn_pcs,6); ?>&nbsp;</p></td>
                    <td width="70" align="right" id="td_boder"><p><? echo number_format($currier_pre_cost,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? //echo number_format($lab_test,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($currier_pre_cost,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><?  echo '0'; ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? //echo number_format($currier_pre_cost,6); ?>&nbsp;</p></td>
                      
                    </tr>
                    
                    <tr bgcolor="<? echo $bgcolor2;?>">
                    
                    <td width="20" align="center" ><p>3</p></td>
                    <td width="520"><b>Inspection Charge</b></td> 
                    <td width="70"align="right"><p><? echo number_format($inspection_dzn,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($tot_inspection_dzn_pcs,6); ?>&nbsp;</p></td>
                    <td width="70" align="right" id="td_boder"><p><? echo number_format($inspection,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? //echo number_format($lab_test,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($inspection,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><?  echo '0'; ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? //echo number_format($inspection,6); ?>&nbsp;</p></td>
                     
                    </tr>
                    
                    <tr bgcolor="<? echo $bgcolor;?>">
                    
                    <td width="20" align="center" ><p>4</p></td>
                    <td width="520"><b>Commercial Charge</b></td> 
                    <td width="70"align="right"><p><? echo number_format($comarcial_dzn,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><?  echo number_format($tot_comarcial_dzn_pcs,6); ?>&nbsp;</p></td>
                    <td width="70" align="right" id="td_boder"><p><? echo number_format($comarcial,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? //echo number_format($lab_test,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($comarcial,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo '0'; ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? //echo number_format($comarcial,6); ?>&nbsp;</p></td>
                       
                    </tr>
                    <tr bgcolor="<? echo $bgcolor2;?>">
                     
                    <td width="20" align="center"><p>5</p></td>
                    <td width="520" title="Freight+Certif.Cost+Design Cost+Studio Cost+Deprec.&Amort.+Operating Expenses+Deprec.&Amort.+Interest+Income Tax">
                    <b>Others Charge</b></td> 
                   
                     <td width="70"align="right"><p><? echo number_format($tot_other_cost_dzn,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($tot_other_cost_pcs,6); ?>&nbsp;</p></td>
                    <td width="70" align="right" id="td_boder"><p><? echo number_format($tot_other_cost,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? //echo number_format($lab_test,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($tot_other_cost,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo '0'; ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? //echo number_format($lab_test,6); ?>&nbsp;</p></td>
                     
                    </tr>
					
                   
                     
                     <tr style="font-size:17px; background-color:#CCC">
                         
                        <td width="540" colspan="2"> <b>F-Total Others Cost:</b></td>
                        <td  align="right"><b><? echo number_format($total_other_cost_dzn,6); ?>&nbsp;</b></td>
                        <td  align="right"><b><? echo number_format($total_other_cost_pcs,6); ?>&nbsp;</b></td>
                        <td  align="right" id="td_boder"><b><? echo number_format($tot_other_cost_req_amount,6); ?>&nbsp;</b></td>
                        
                        
                        <td  align="right"><b><? //echo ($row[('req_amount')]); ?>&nbsp;</b></td>
                        <td  align="right"><b><? echo number_format($tot_other_cost_req_amount,6); ?>&nbsp;</b></td>
                        <td  align="right"><b><?   echo '0';?>&nbsp;</b></td>
                        <td  align="right"><b><? //echo ($row[('req_amount')]); ?>&nbsp;</b></td>
                        
                    </tr>
                   
                </table>
                <br>
             
                 <table align="left" border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px;" rules="all"> 
               		 <caption><b style="float:left"> Commission Cost:</b></caption>
                   <tr>
                 	 
                    <th  width="20">SL </th>
                    <th width="520" title="">Commission Cost </th>
                    <th width="70">Cost/Dzn</th>
                    <th  width="70">Cost/Pc</th>
                    <th  width="70" id="td_boder">Total Budget</th>
                    <th  width="70">Rate(USD)</th>
                    <th  width="70">Total Budget</th>
                    <th  width="70">Balance /Excess</th>
                    <th  width="70">&nbsp;</th>
                    
                    </tr>
                   
                    <?
                     
						$tot_commission_amount=$commission_arr[1]['commi_amt']+$commission_arr[2]['commi_amt'];
						$tot_commission_amount_pcs=($commission_arr[1]['commi_amt']/$order_price_per_dzn)+($commission_arr[2]['commi_amt']/$order_price_per_dzn);
						$tot_commision_req_amount=$commission_arr[1]['commi_req_amt']+$commission_arr[2]['commi_req_amt'];
						
					
					?>

					 
                   <tr bgcolor="<? echo $bgcolor;?>">
                    
                    <td width="20" align="center"><p>1</p></td>
                    <td width="520"  title="Local"><b>UK Office Commission</b></td> 
                    <td width="70"align="right"><p><? echo number_format($commission_arr[2]['commi_amt'],6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($commission_arr[2]['commi_amt']/$order_price_per_dzn,6); ?>&nbsp;</p></td>
                    <td width="70" align="right" id="td_boder"><p><? echo number_format($commission_arr[2]['commi_req_amt'],6); ?>&nbsp;</p></td>
                    
                     <td width="70" align="right"><p><? //echo number_format($lab_test,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><?  echo number_format($commission_arr[2]['commi_req_amt'],6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo '0'; ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? //echo number_format($lab_test,6); ?>&nbsp;</p></td>
                     
                    </tr>
                    <tr bgcolor="<? echo $bgcolor2;?>">
                     
                    <td width="20" align="center"><p>2</p></td>
                    <td width="520"><b>Buying Commission</b></td> 
                    <td width="70"align="right"><p><? echo number_format($commission_arr[1]['commi_amt'],6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($commission_arr[1]['commi_amt']/$order_price_per_dzn,6); ?>&nbsp;</p></td>
                    <td width="70" align="right" id="td_boder"><p><? echo number_format($commission_arr[1]['commi_req_amt'],6); ?>&nbsp;</p></td>
                     <td width="70" align="right"><p><? //echo number_format($lab_test,6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($commission_arr[1]['commi_req_amt'],6); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo '0'; ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? //echo number_format($lab_test,6); ?>&nbsp;</p></td>
                     
                    </tr>
					
                    <tr>
                         
                        <td width="540" colspan="2"> <b>G-Total Commission Cost:</b></td>
                        <td  align="right"><b><? echo number_format($tot_commission_amount,6); ?>&nbsp;</b></td>
                        <td  align="right"><b><? echo number_format($tot_commission_amount_pcs,6); ?>&nbsp;</b></td>
                        <td  align="right" id="td_boder"><b><? echo number_format($tot_commision_req_amount,6); ?>&nbsp;</b></td>
                        <td width="70" align="right"><b><? //echo number_format($lab_test,6); ?>&nbsp;</b></td>
                   		 <td width="70" align="right"><b><? echo number_format($tot_commision_req_amount,6); ?>&nbsp;</b></td>
                    	<td width="70" align="right"><b><? echo '0'; ?>&nbsp;</b></td>
                    	<td width="70" align="right"><b><? //echo number_format($lab_test,6); ?>&nbsp;</b></td>
                        
                    </tr>
                    
                    <tr bgcolor="<? echo $bgcolor;?>">
                    
                    <td width="20" align="center"><p>1</p></td>
                    <td width="520"><b>H-Total CM Cost</b></td> 
                    <td width="70"align="right"><b><? echo number_format($cm_cost_dzn,6); ?>&nbsp;</b></td>
                    <td width="70" align="right"><b><? $tot_cm_cost_pcs=$cm_cost_dzn/$order_price_per_dzn;echo number_format($tot_cm_cost_pcs,6); ?>&nbsp;</b></td>
                    <td width="70" title="CM Dzn*PO Qty Dzn" id="td_boder" align="right"><b><? echo number_format($tot_cm_qty_dzn,6); ?>&nbsp;</b></td>
                    <td width="70" align="left"  title="Commision+OtherCost+Wash+Emblishmnet+Trims+Fabric">
                    <p><b>Total Final Amount</b></p></td>
                   	<td width="70" title="Commision+OtherCost+Wash+Emblishmnet+Trims+Fabric" align="right"><b> <? $total_final_amount=$tot_commision_req_amount+$tot_other_cost_req_amount+$tot_wash_sourcing_req_amount+$tot_emb_sourcing_req_amount+$tot_sourcing_trim_sew_fin_amount+$tot_fab_req_sourcing_amount;
					 echo number_format($total_final_amount,6); ?>&nbsp;</b></td>
                    <td width="70" align="right"><b><? 
					$total_final_amount_bal=$tot_fab_req_sourcing_bal_amount+$tot_emb_sourcing_req_amount_bal+$tot_wash_sourcing_req_amount_bal+$tot_trim_source_amount_bal;
					echo number_format($total_final_amount_bal,6); ?>&nbsp;</b></td>
                    <td width="70" align="right"><p><? //echo number_format($lab_test,6); ?>&nbsp;</p></td>
                    </tr>
                    
                    <tr bgcolor="<? echo $bgcolor;?>">
                    <td width="540" colspan="2"><p> <b>Gross FOB Value [A+B+C+D+E+F+G+H]</b></p></td> 
                    <td width="70"align="right"><b><?  //tot_embro_amount_pcs tot_embro_req_amount
					$gross_fob_value_dzn=$tot_fab_amount+$trim_sew_fin_amt+$tot_wash_amount+$tot_embro_amount+$tot_other_cost_dzn+$tot_commission_amount+$cm_cost_dzn;
					$gross_fob_value_pcs=$tot_fab_amount_pcs+$trim_sew_fin_amt_pcs+$tot_wash_amount_pcs+$tot_embro_amount_pcs+$tot_other_cost_pcs+$tot_commission_amount_pcs+$tot_cm_cost_pcs;
					//echo $tot_fab_amount_pcs.'=='.$trim_sew_fin_amt_pcs.'=='.$tot_wash_amount_pcs.'=='.$tot_embro_amount_pcs.'=='.$tot_commission_amount_pcs.'=='.$tot_cm_cost_pcs;
					//$gross_fob_value_req=$tot_fab_req_amount+$trim_fin_req_amount+$tot_wash_req_amount+$tot_embro_req_amount+$tot_commision_req_amount+$tot_other_cost_req_amount+$cm_cost_req;
					
					$gross_fob_value_req=$tot_fab_req_amount+$trim_fin_req_amount+$tot_wash_req_amount+$tot_embro_req_amount+$tot_other_cost_req_amount+$tot_commision_req_amount+$tot_cm_qty_dzn;

					
					 //---fob value
					 $total_fob_gross_pcs=$tot_fab_amount_pcs+$trim_sew_fin_amt_pcs+$tot_wash_amount_pcs+$tot_embro_amount_pcs+$tot_other_cost_pcs+$tot_commission_amount_pcs+$tot_cm_cost_pcs;
$total_fob_gross_dzn=$tot_fab_amount+$trim_sew_fin_amt+$tot_wash_amount+$tot_embro_amount+$total_other_cost_dzn+$tot_commission_amount+$cm_cost_dzn;
					$tot_gross_fob_pcs=$total_fob_gross_dzn/$order_price_per_dzn;
					 $gross_fob_value_dzn_without_commi=$total_fob_gross_dzn-$tot_commission_amount;
					$gross_fob_value_pcs_without_commi=$tot_gross_fob_pcs-$tot_commission_amount_pcs;
					$gross_fob_value_req_without_commi=$gross_fob_value_req-$tot_commision_req_amount;
					
					echo number_format($total_fob_gross_dzn,6); ?>&nbsp;</b></td>
                    <td width="70" align="right"><b><? echo number_format($tot_gross_fob_pcs,6); ?>&nbsp;</b></td>
                    <td width="70" align="right" id="td_boder"><b><? echo number_format($gross_fob_value_req,6); ?>&nbsp;</b></td>
                     
                     <td width="70" align="left"><b>Total Final CM Amount</b></td>
                   	<td width="70" align="right" title="Gross FOB Value[A+B+C+D+E+F+G+H]-Total Final Amount"><b><? 
					$total_final_cm_amount=$gross_fob_value_req-$total_final_amount;echo number_format($total_final_cm_amount,6); ?>&nbsp;</b></td>
                    <td width="70" align="right"><b><? //echo number_format($gross_fob_value_req,6); ?>&nbsp;</b></td>
                      <td width="70" align="right"><p><? //echo number_format($lab_test,6); ?>&nbsp;</p></td>
                   
                    </tr>
                    <?
                   
					?>
                     <tr bgcolor="<? echo $bgcolor2;?>">
                    <td width="540" colspan="2"><b>Net FOB Value (Without Commission)</b></td> 
                    <td width="70"align="right"><b><? echo number_format($gross_fob_value_dzn_without_commi,6); ?> </b></td>
                    <td width="70" align="right"><b><? echo number_format($gross_fob_value_pcs_without_commi,6); ?> </b></td>
                    <td width="70" align="right" id="td_boder"><b><? echo number_format($gross_fob_value_req_without_commi,6); ?> </b></td>
                   
                    <td width="70" align="left"><b>Final CM [Dzn]</b></td>
                   	<td width="70" align="right" title="Total Final CM Amount/PO Qty Dzn"><b><? echo number_format($total_final_cm_amount/$offer_qty_dzn,6); ?>&nbsp;</b></td>
                    <td width="70" align="right"><b><? //echo number_format($gross_fob_value_req_without_commi,6); ?>&nbsp;</b></td>
                      <td width="70" align="right"><b><? //echo number_format($lab_test,6); ?>&nbsp;</b></td>
                    
                    </tr>
                    
                     <tr bgcolor="<? echo $bgcolor;?>">
                    <td width="540" colspan="2"><b></b></td> 
                    <td width="70"align="right"><b><? //echo number_format($gross_fob_value_dzn_without_commi,6); ?> </b></td>
                    <td width="70" align="right"><b><? //echo number_format($gross_fob_value_pcs_without_commi,6); ?> </b></td>
                    
                    <td width="140" colspan="2" align="right"><b>Total Value</b></td>
                   	<td width="70" title="CM tot Cost+Tot Final Amount" align="right"><b><? echo number_format($tot_cm_qty_dzn+$total_final_amount,6); ?>&nbsp;</b></td>
                    <td width="70" align="right"><b><? //echo number_format($gross_fob_value_req_without_commi,6); ?>&nbsp;</b></td>
                      <td width="70" align="right"><b><? //echo number_format($lab_test,6); ?>&nbsp;</b></td>
                    </tr>
                </table>
             
              
           </div>
          
         
           <? 
		   
		 
		   $cbo_company_name=str_replace("'","",$cbo_company_name);
		   //echo signature_table(219, $cbo_company_name, "1320px"); 
		   if ($cbo_template_id != '') {
			   $template_id = " and template_id=$cbo_template_id ";
		   }
		   $sql = sql_select("select designation,name,user_id,prepared_by from variable_settings_signature where report_id=240 and company_id='$cbo_company_name'  $template_id order by sequence_no");
	   $signature_sql = sql_select("SELECT c.master_tble_id as MASTER_TBLE_ID,c.image_location as IMAGE_LOCATION  from variable_settings_signature a, electronic_approval_setup b, common_photo_library c where a.user_id=b.user_id and a.user_id=c.master_tble_id and a.report_id=240 and a.company_id='$cbo_company_name' and a.template_id=$cbo_template_id and b.page_id=2164 and b.entry_form=47 and b.company_id=$cbo_company_name and c.form_name='user_signature'");
	  
	   $signature_location=array();
	   foreach($signature_sql as $row)
	   {
		   $signature_location[$row['MASTER_TBLE_ID']]=$row['IMAGE_LOCATION'];
	   }
	   if($sql[0][csf("prepared_by")]==1){
		   list($prepared_by,$activities)=explode('**',$prepared_by);
		   $sql_2[100] = array ( DESIGNATION => 'Prepared By' ,NAME => $prepared_by, ACTIVITIES =>$activities, PREPARED_BY => 0 );
		   $sql=$sql_2+$sql;
	   }
	   $count = count($sql);
	   $td_width = floor(1000 / $count);
	   $standard_width = $count * 150;
	   if ($standard_width > 1000) {
		   $td_width = 150;
	   }
	   $i = 1;
	   if ($count == 0) { echo "<b>Note: This is Software Generated Copy , Signature is not Required.</b>";}
	   else
	   {
		   echo '<table id="signatureTblId" width="1000" style="padding-top:50px;"><tr><td width="100%" height="50" colspan="' . $count . '">' . $message . '</td></tr><tr>';
		   foreach ($sql as $row) {
			   echo '<td width="' . $td_width . '" align="center" valign="bottom">';
			   if($signature_location[$row[csf("user_id")]]!='')
			   {
				   echo '<strong><img src="../../'.$signature_location[$row[csf("user_id")]].'" height="60" width="90" ></strong><br>';
			   }
			   else
			   {
				   echo '<span style="height:60px;width:90px;"></span><br>';
			   }
			   echo '<strong style="text-decoration:overline">' . $row[csf("designation")] . "</strong><br>" . $row[csf("name")] . '</td>';
			   $i++;
		   }
		   echo '</tr></table>';
	   }
	   
		   


		//    $cbo_company_name=str_replace("'","",$cbo_company_name);
		//    echo signature_table(219, $cbo_company_name, "1320px"); ?>
            
     </div>
    
      <div style="clear:both"></div>
     
    <?
	$mailBody=ob_get_contents();
	ob_clean();
	echo $mailBody;
	
	//Mail send------------------------------------------
	list($msil_address,$is_mail_send,$mail_body)=explode('**',$mail_data);
	if($is_mail_send==1){
		require_once('../../../mailer/class.phpmailer.php');
		require_once('../../../auto_mail/setting/mail_setting.php');
		$mailBody = preg_replace("/<img[^>]+\>/i", " ", $mailBody); 
			
		$mailToArr=array();
		if($msil_address){$mailToArr[]=$msil_address;}
			
		//$mailSql = "select c.TEAM_MEMBER_EMAIL,d.USER_EMAIL from wo_po_details_master a, wo_pre_cost_mst b,lib_mkt_team_member_info c,USER_PASSWD d where a.job_no=b.job_no and a.DEALING_MARCHANT=c.id and b.INSERTED_BY=d.id  and a.status_active=1 and a.job_no=$txt_job_no";
		
		$mailSql = "SELECT c.TEAM_LEADER_EMAIL, d.USER_EMAIL
  FROM wo_po_details_master  a,  wo_pre_cost_mst b, lib_marketing_team c, USER_PASSWD d
 WHERE a.job_no = b.job_no  AND a.TEAM_LEADER = c.id AND b.INSERTED_BY = d.id AND a.status_active = 1  AND a.job_no=$txt_job_no";
		
		
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows['TEAM_LEADER_EMAIL']){$mailToArr[$rows['TEAM_LEADER_EMAIL']]=$rows['TEAM_LEADER_EMAIL'];}
			if($rows['USER_EMAIL']){$mailToArr[$rows['USER_EMAIL']]=$rows['USER_EMAIL'];}
		}
		
		
		
		
		$elcetronicSql = "SELECT a.BUYER_ID,a.SEQUENCE_NO,a.BYPASS,b.USER_EMAIL  from electronic_approval_setup a join user_passwd b on a.user_id=b.id where b.valid=1 and a.page_id=1901 and a.entry_form=47 and a.company_id=$cbo_company_name order by a.SEQUENCE_NO";
		//echo $elcetronicSql;die;
		$elcetronicSqlRes=sql_select($elcetronicSql);
		foreach($elcetronicSqlRes as $rows){
			
			/*if($rows[BUYER_ID]!=''){
				 
				foreach(explode(',',$rows[BUYER_ID]) as $bi){
					if($rows[USER_EMAIL]!='' && $rows[BYPASS]==2 && $bi==$buyer_name_id){
						$mailToArr[100]=$rows[USER_EMAIL];break;
					}
				}
			}
			else{
			
				if($rows[SEQUENCE_NO]==1 && $rows[BYPASS]==2){
					if($rows[USER_EMAIL]){$mailToArr[100]=$rows[USER_EMAIL];}
				}
			}
			
			$elecDataArr[$rows[BYPASS]][]=$rows[USER_EMAIL];*/
			
			if($rows[BUYER_ID]!=''){
				foreach(explode(',',$rows[BUYER_ID]) as $bi){
					if($rows['USER_EMAIL']!='' && $bi==$buyer_name_id){$mailToArr[$rows['USER_EMAIL']]=$rows['USER_EMAIL'];}
					if($rows[BYPASS]==2){break;}
				}
			}
			else{
				if($rows['USER_EMAIL']){$mailToArr[$rows['USER_EMAIL']]=$rows['USER_EMAIL'];}
				if($rows[BYPASS]==2){break;}
			}
			
			
			
		}
		
		//if($elecDataArr[1][0] && $mailToArr[100]==""){$mailToArr[]=$elecDataArr[1][0];}
		//elseif($elecDataArr[2][0] && $mailToArr[100]==""){$mailToArr[]=$elecDataArr[2][0];}
		//Un-approve request mail......................................................
		$user_id=$_SESSION['logic_erp']['user_id'];
		$job_id=return_field_value("id", "wo_pre_cost_mst", "job_no='".str_replace("'","",$txt_job_no)."'");
		$approved_no=return_field_value("MAX(approved_no) as approved_no","approval_history","entry_form=46 and mst_id=$job_id","approved_no")+1;
		$unapproved_request=return_field_value("APPROVAL_CAUSE","fabric_booking_approval_cause","entry_form=46 and user_id=$user_id and booking_id=$job_id and approval_type=2 and approval_no='$approved_no'");//page_id=$page_id and
		if($unapproved_request){
			$mailToArr=array();
			if($msil_address){$mailToArr[]=$msil_address;}
			$final_app_user_mail=return_field_value("USER_EMAIL","user_passwd","id in(select APPROVED_BY from APPROVAL_HISTORY where id in(select max(id) from APPROVAL_HISTORY where mst_id=$job_id and ENTRY_FORM=46 and CURRENT_APPROVAL_STATUS=1))");
			$mailToArr[]= $final_app_user_mail;
		}
		$mailBody=$mail_body."<br>".$unapproved_request."<br>".$mailBody;
		//......................................................Un-approve request mail;		
		$to=implode(',',$mailToArr);
		
		//echo $to;die;
		
		//Att file....
/*		$imgSql="select IMAGE_LOCATION,REAL_FILE_NAME from common_photo_library where is_deleted=0  and MASTER_TBLE_ID=$txt_job_no and file_type=1";
		$imgSqlResult=sql_select($imgSql);
		foreach($imgSqlResult as $rows){
			$att_file_arr[]='../../../'.$rows[IMAGE_LOCATION].'**'.$rows[REAL_FILE_NAME];
		}
*/		
		$subject="Sourcing Post Cost Report";
		$header=mailHeader();
		echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
	}
	//------------------------------------End;
	exit();
}

if($action=='mo_sheet_2') //MO Sheet 2 BTN 17 md mamun ahmed sagor-28-10-2021
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$txt_job_no=str_replace("'","",$txt_job_no);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_buyer_name=str_replace("'","",$cbo_buyer_name);
	$txt_style_ref=str_replace("'","",$txt_style_ref);
	$txt_costing_date=str_replace("'","",$txt_costing_date);
	$txt_po_breack_down_id=str_replace("'","",$txt_po_breack_down_id);
	$cbo_costing_per=str_replace("'","",$cbo_costing_per);
	$excess_per_val=str_replace("'","",$excess_per_val);
	$supplier_check=str_replace("'","",$supplier_check);
	//echo $excess_val.'dd';
	if(str_replace("'",'',$txt_po_breack_down_id)=="")
	{
		$txt_po_breack_down_id_cond='';
		$txt_po_breack_down_id_cond1='';
		$txt_po_breack_down_id_cond2='';
		//$txt_po_breack_down_id_cond3='';
	}
	else
	{
		$txt_po_breack_down_id_cond=" and b.id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond1=" and a.id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond2=" and d.po_break_down_id in(".$txt_po_breack_down_id.")";
		//$txt_po_breack_down_id_cond3=" and b.id in(".$txt_po_breack_down_id.")";
	}
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$supplier_name_arr=return_library_array( "select id, supplier_name from  lib_supplier",'id','supplier_name');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	$size_library=return_library_array( "select id, size_name from lib_size where status_active=1 and is_deleted=0", "id", "size_name");

	$result =sql_select("select a.job_no,a.buyer_name,a.style_ref_no,a.ship_mode, a.order_uom,a.gmts_item_id,a.total_set_qnty,b.id,b.po_number,b.po_received_date,b.pub_shipment_date,b.file_no,b.grouping,c.costing_date,c.costing_per from wo_po_details_master a,wo_po_break_down b,wo_pre_cost_mst c where a.job_no=b.job_no_mst and c.job_no=b.job_no_mst  and c.job_no=a.job_no  and b.job_no_mst='$txt_job_no' $txt_po_breack_down_id_cond and b.status_active=1 and b.is_deleted=0 order by b.pub_shipment_date DESC");
	
	$job_in_orders = array();$job_in_ship_arr = array();
	$pulich_ship_date='';$shipment_date_arr='';
	$job_in_ref = array();
	$job_in_file = array();
	foreach ($result as $val){
		$job_in_orders_arr[$val[csf('id')]]= $val[csf('po_number')];
		$job_in_ship_arr[$val[csf('id')]]= $val[csf('pub_shipment_date')];
		$job_in_recvDate_arr[$val[csf('id')]]= change_date_format($val[csf('po_received_date')]);
		$job_in_ref_arr[$val[csf('id')]]= $val[csf('grouping')];
		$job_in_file_arr[$val[csf('id')]]= $val[csf('file_no')];
		$job_total_set_qnty_arr[$val[csf('job_no')]]= $val[csf('total_set_qnty')];
		
		$gmts_item_id=$val[csf('gmts_item_id')];
		$order_uom=$val[csf('order_uom')];
		$shipment_date_arr.=change_date_format($val[csf('pub_shipment_date')]).',';
		
		$job_no=$val[csf('job_no')];
		$buyer_name=$buyer_arr[$val[csf('buyer_name')]];
		$style_ref_no=$val[csf('style_ref_no')];
		
		$costing_date=$val[csf('costing_date')];
		$costing_per_name=$costing_per[$val[csf('costing_per')]];
	}
	//echo $txt_po_breack_down_id_cond.'DSD';
	$ref_cond=implode(",",array_unique($job_in_ref_arr));
	$file_con=implode(",",array_unique($job_in_file_arr));
	$shipment_date=rtrim($shipment_date_arr,',');
	$shipment_date=implode(",",array_unique(explode(",",$shipment_date)));
	
	$recv_date=implode(",",array_unique($job_in_recvDate_arr));
	//$shipment_date=implode(",",array_unique($job_in_ship_arr));
	$job_in_orders=implode(", ",$job_in_orders_arr);
	
	?>
	<style type="text/css" media="print">
   table { page-break-inside:auto; }
  
        @media print {
        thead {display: table-header-group;}
    }
	@media print {
				table {
					page-break-inside: avoid;
				}
			}  
	</style>
	 <div style="width:1100px; margin:0 auto">
	<!--    <div style="width:1100px; font-size:20px; font-weight:bold" align="center">< ? echo $comp[str_replace("'","",$cbo_company_name)]; ?></div>
	    <div style="width:1100px; font-size:14px; font-weight:bold" align="center">MO Sheet</div>
	-->	
	<br>
	
	 <div style="font-family:'Arial Narrow';">
        <table style="width:850px" ><tr><td colspan="6" align="center">
           <?
            $image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id='$cbo_company_name'","image_location");
            ?>
            <img  src='../../<? echo $image_location; ?>' height='70' align="left" />
            <b style="font-size:25px;"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></b><br>
            <b style="font-size:14px;">Material Order Sheet</b>
        </td></tr></table>
        
        <table style="width:560px; font-family:Arial Narrow" border="0" >
			<table width="50%"  class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all">
				<tr>
					<td width="80">Job No</td>
					<td width="80"><b><? echo $job_no; ?></b></td>
				</tr>
				  <tr>
					<td width="80">Buyer</td>
					<td width="80"><b><? echo $buyer_name; ?></b></td>
				</tr>
				  <tr>
					<td width="80">PO  Number</td>
					<td width="80"><b><? echo $job_in_orders; ?></b></td>
				</tr>
				  <tr>
					<td width="80">Style Number</td>
					<td width="80"><b><? echo $style_ref_no; ?></b></td>
				</tr>
				  <tr>
					<td width="80">Item</td>
					<td width="80"><b><? 
						$gmts_item=''; $gmts_item_id=explode(",",$gmts_item_id);
							foreach($gmts_item_id as $item_id)
							{
								if($gmts_item=="") $gmts_item=$garments_item[$item_id]; else $gmts_item.=", ".$garments_item[$item_id];
							}
							echo $gmts_item;
					 ?></b></td>
				</tr>
				  <tr>
					<td width="80">Shipment Date</td>
					<td width="80"><b><? echo $shipment_date; ?></b></td>
				</tr>
				  <tr>
					<td width="80">PO Receive Date</td>
					<td width="80"><b><? echo $recv_date; ?></b></td>
				</tr>
				  <tr>
					<td width="80">Costing Date</td>
					<td width="80"><b><? echo change_date_format($costing_date); ?></b></td>
				</tr>
					<td width="90">Costing Per</td>
					<td width="100"><b><? echo $costing_per_name; ?></b></td>
					
				</tr>
			</table>
			<table style="float:right; margin-top:-230px;"  width="350px" class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all">
				<caption><b> Item's View</b></caption>
				
				 <?
						// image show here  -------------------------------------------
						$sql = "select id,master_tble_id,image_location from common_photo_library   where master_tble_id='$txt_job_no' and file_type=1";
						$photo_data_array=sql_select($sql);
					 ?> 
					 	<tr>
						<td align="center">
							 <div style="margin:15px 5px;float:right;width:500px;"  >
							 
							<? foreach($photo_data_array AS $inf){ ?>
							
								<img  src='../../<? echo $inf[csf("image_location")]; ?>' height='80' width='80' />
								
							<?  } ?>
							
						  </div>
						
					</td>	
				</tr>
			</table>
			
		</table>
		<br/>
		<?
		 $color_size_sql= "select a.po_number,a.id as po_id,b.item_number_id,b.color_number_id,b.size_number_id,avg(b.excess_cut_perc) as excess_cut_perc,sum(b.plan_cut_qnty) as plan_cut_qnty,sum(b.order_quantity) as order_quantity from wo_po_break_down a,wo_po_color_size_breakdown b where  b.po_break_down_id=a.id  and b.job_no_mst='".$txt_job_no."'  and  a.is_deleted=0 and a.status_active=1 and  b.is_deleted=0 and b.status_active=1 $txt_po_breack_down_id_cond1 group by a.po_number,a.id,b.size_number_id,item_number_id,b.color_number_id order by b.item_number_id,b.size_number_id ";

			$result_color=sql_select($color_size_sql);
			$color_size_array=array();
			foreach($result_color as $row)
			{
				$color_size_array[$row[csf("po_id")]][$row[csf("item_number_id")]][$row[csf("color_number_id")]]=$row[csf("order_quantity")];
				$po_size_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['po_qty']=$row[csf("order_quantity")];
				$po_size_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['plan_cut_qnty']=$row[csf("plan_cut_qnty")];
				$po_color_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]]['order_quantity']=$row[csf("order_quantity")];
				//$po_size_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['tot_row']+=0;
				if($row[csf("excess_cut_perc")]>0)
				{
				$po_size_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['excess_cut_perc']=$row[csf("excess_cut_perc")];
				}
				$po_array[$row[csf("po_id")]]['po_no']=$row[csf("po_number")];
				$po_array[$row[csf("po_id")]]['item_number_id']=$row[csf("item_number_id")];
				
				$po_color_array[$row[csf("po_id")]][$row[csf("item_number_id")]]['color_number_id'].=$row[csf("color_number_id")].',';
				$item_color_size_array[$row[csf("item_number_id")]][$row[csf("color_number_id")]]+=$row[csf("order_quantity")];
			}
			


			//$size_sql= "select b.size_number_id,sum(b.order_quantity) as order_quantity from wo_po_break_down a,wo_po_color_size_breakdown b where  b.po_break_down_id=a.id  and b.job_no_mst=".$txt_job_no." and  b.is_deleted=0 and b.status_active=1 group by b.size_number_id";
		$size_sql= "select b.size_number_id,sum(b.order_quantity) as order_quantity,sum(b.plan_cut_qnty) as plan_cut_qnty from wo_po_break_down a,wo_po_color_size_breakdown b where  b.po_break_down_id=a.id  and b.job_no_mst='".$txt_job_no."' and  a.is_deleted=0 and a.status_active=1 and  b.is_deleted=0 and b.status_active=1 $txt_po_breack_down_id_cond1 group by b.size_number_id,b.size_order order by b.size_order";

			$result_size=sql_select($size_sql);
			$posize_array=array();
			foreach($result_size as $row)
			{
				$posize_array[$row[csf("size_number_id")]]=$row[csf("size_number_id")];
			}

			$po_rowspan_arr=array();$po_item_rowspan_arr=array();
			foreach($color_size_array as $pokey=>$po_data)
			{
				$po_row_span=0;
				foreach($po_data as $itemkey=>$item_data)
				{
					$item_row_span=0;$color_row_span=0;
					foreach($item_data as $colorkey=>$val)
					{
						$item_row_span++;
						$po_row_span++;
						//$po_item_color_rowspan_arr[$pokey][$itemkey][$colorkey]=$color_row_span;
						$color_row_span++;
					}
					$itempo_rowspan_arr[$pokey][$itemkey][$colorkey]=$color_row_span;
					$po_item_rowspan_arr[$pokey][$itemkey]=$item_row_span;
					$po_rowspan_arr[$pokey]=$po_row_span;
					
				}
			}

			//print_r($itempo_rowspan_arr);
			?>
            <br/>
			<div style="width:1100px;">
             <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:auto;text-align:center; font-family:Arial Narrow" rules="all">
            <label style="text-align:center"><b>Size and Color  Breakdown:</b></label>
                <tr style="font-weight:bold">
                	<td width="60">SL.</td>
                    <td width="110">Buyer PO</td>
					<td width="110">Item</td>
                    <td width="120">Color</td>
					   <?
                    foreach ($posize_array as $sizid)
                    {
                        //$size_count=count($sizid);
                        ?>
                            <th width="60"><strong><? echo  $size_library[$sizid];  ?></strong></th>
                        <?
                    }
                    ?>
                    <td  width="80"> Total Order Qty.</td>
					<td  width="60"> Ex.Cut %</td>
					<td  width="80">Plan Cut Qty</td>
                    </tr>
                    <?
					$k=1; $total_qnty=$total_plan_qnty=0;$grd_total_qnty=$grd_total_plan_qnty=0;
                    foreach ($color_size_array as $pokey=>$po_data)
					{
						$m=1;
						foreach ($po_data as $itemkey=>$item_data)
						{
							$n=1;
							foreach ($item_data as $colorkey=>$color_data)
							{
								$po_rowspan=$po_rowspan_arr[$pokey];
								$item_po_rowspan=$po_item_rowspan_arr[$pokey][$itemkey];
								$item_po_rowspan_row=$itempo_rowspan_arr[$itemkey][$colorkey];
								
								$color_number_id=rtrim($po_color_array[$pokey][$itemkey]['color_number_id']);
								$color_ids=explode(",",$color_number_id);
								$color_row=count($color_row);
								//echo $color_row.', ';
							?>
							<tr>
								<?
                                if($m==1)
                                {
									?>
									<td rowspan="<? echo $po_rowspan;?>"><? echo $k;?></td>
									<td rowspan="<? echo $po_rowspan;?>" align="left"><? echo $po_array[$pokey]['po_no']; ?></td>
									<?
                                }
								if($n==1)
                                {
									?>
									<td  rowspan="<? echo $item_po_rowspan;?>" align="left"><? echo $garments_item[$itemkey]; ?></td>
									<?
                                }
                                ?>
								
                                <td align="left"><? echo $color_library[$colorkey]; ?></td>
                                <?
                                $po_size_qty=0;$tot_qnty=array();
                                foreach ($posize_array as $sizval)
                                {
									$size_count=count($sizval);
									$po_size_qty=$po_size_qty_array[$pokey][$colorkey][$sizval]['po_qty'];
									$plan_cut_qnty=$po_size_qty_array[$pokey][$colorkey][$sizval]['plan_cut_qnty'];
									$excess_cut_perc=$po_size_qty_array[$pokey][$colorkey][$sizval]['excess_cut_perc'];
									$tot_excess_cut_per[$pokey][$colorkey]+=$excess_cut_perc;
									?>
									<td align="right"><? echo fn_number_format($po_size_qty,0); ?></td>
									<?
									$tot_qnty[$pokey][$colorkey]+=$po_size_qty;
									$tot_plan_qnty[$pokey][$colorkey]+=$plan_cut_qnty;
									$tot_qnty_size[$sizval]+=$po_size_qty;
									$tot_qnty_item_size[$sizval]+=$po_size_qty;
									$grd_tot_qnty_size[$sizval]+=$po_size_qty;
									$size_tot_qty+=$item_color_size_array[$pokey][$itemkey][$colorkey];
                                }
                               
								//if($n==1)
                                //{
									$tot_excess_cut_per=(($tot_plan_qnty[$pokey][$colorkey]-$tot_qnty[$pokey][$colorkey])/$tot_qnty[$pokey][$colorkey])*100;
									?>
									
									<td align="right" rowspan="<? //echo $item_po_rowspan;?>" ><? echo fn_number_format($tot_qnty[$pokey][$colorkey],0); ?></td>
									<td align="right" rowspan="<? //echo $item_po_rowspan;?>" ><? echo fn_number_format($tot_excess_cut_per,2); ?></td>
									<td align="right" rowspan="<? //echo $item_po_rowspan;?>" ><? echo fn_number_format($tot_plan_qnty[$pokey][$colorkey],0); ?></td>
									<?
                                //}
								?>
                                
							</tr>
							<?
							$total_qnty+=$tot_qnty[$pokey][$colorkey];
							$total_plan_qnty+=$tot_plan_qnty[$pokey][$colorkey];
							$total_item_qnty+=$tot_qnty_item_size[$pokey][$colorkey];
							$grd_total_qnty+=$tot_qnty[$pokey][$colorkey];
							$grd_total_plan_qnty+=$tot_plan_qnty[$pokey][$colorkey];
							$m++;$n++;
							}
							
							?>
							
						  <?
						}
						?>
					 <tr>
						<td colspan="4" align="right"><strong>PO Sub Total :</strong></td>
						<?
						foreach ($posize_array as $sizval)
						{
							?>
							<td align="right"><b><?php echo fn_number_format($tot_qnty_size[$sizval],0);unset($tot_qnty_size[$sizval]); ?></b></td>
							<?
						}
						?>
						<td align="right"><b><?php echo fn_number_format($total_qnty,0);unset($total_qnty); ?></b></td>
						<td align="right"><b><?php //echo fn_number_format($total_qnty,0);unset($total_qnty); ?></b></td>
						<td align="right"><b><?php echo fn_number_format($total_plan_qnty,0);unset($total_plan_qnty); ?></b></td>
					</tr>
						<?
					  $k++;
					}
					?>
                    <tr>
                    <td colspan="4" align="right"><strong>Job Total :</strong></td>
                    <?
					foreach ($posize_array as $sizval)
					{
						?>
						<td align="right"><b><?php echo fn_number_format($grd_tot_qnty_size[$sizval],0); ?></b></td>
						<?
					}
                    ?>
                    <td align="right"><b><?php echo fn_number_format($grd_total_qnty,0); ?></b></td>
					<td align="right"><b><?php //echo fn_number_format($grd_total_qnty,0); ?></b></td>
					<td align="right"><b><?php echo fn_number_format($grd_total_plan_qnty,0); ?></b></td>
                </tr>
               </table>
			   </div>
			   <br/>
			  <br/>  
			  <?
				$condition= new condition();
				 if($txt_po_breack_down_id!='' || $txt_po_breack_down_id!=0)
				 {
					$condition->po_id("in($txt_po_breack_down_id)"); 
				 }
				  if(str_replace("'","",$txt_job_no)!='')
				 {
					$condition->job_no("in('$txt_job_no')");
				 }
				 
				$condition->init();
				$costPerArr=$condition->getCostingPerArr();
				$costPerQty=$costPerArr[$txt_job_no];
				//echo $costPerQty.'DDDDDDD';
				$fabric= new fabric($condition);
				$trims= new trims($condition);
				$emblishment= new emblishment($condition);
				$wash= new wash($condition);
				$fabric_qty_arr=$fabric->getQtyArray_by_FabriccostidAndGmtscolor_knitAndwoven_greyAndfinish();
				
					//($plan_cut_qnty/$total_set_qnty)*($cons_qnty/$costPerQty);
			//	print_r($trims_qty_arr);
				 $nom_sup_cond="";
				 if($supplier_check==1)
				 {
				 	$nom_sup_cond=" and c.fabric_source=2 and (c.nominated_supp is null or c.nominated_supp=0) ";
				 }
				$sql_fab_color="select d.pre_cost_fabric_cost_dtls_id as fab_dtl_id,d.gmts_color_id,d.contrast_color_id from wo_pre_cost_fabric_cost_dtls c,wo_pre_cos_fab_co_color_dtls d
				 where c.job_no=d.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and c.status_active=1 and c.is_deleted=0 and c.job_no='$txt_job_no' $nom_sup_cond ";
				   $fab_result=sql_select($sql_fab_color);
				 foreach($fab_result as $row)
				 {
					$fab_color_arr[$row[csf("fab_dtl_id")]][$row[csf("gmts_color_id")]]=$row[csf("contrast_color_id")];
				 }

				
				
					$sql_fab="select  a.color_number_id as color_id,a.item_number_id  as item_id,b.id as po_id,b.po_quantity,b.po_total_price, b.po_number, b.pub_shipment_date,c.id, c.job_no,c.body_part_id as body_id, c.fab_nature_id as nat_id, c.color_type_id as color_type, c.construction as construction,c.composition,c.fabric_source,c.gsm_weight,c.body_part_id,c.color_size_sensitive,c.width_dia_type, c.avg_cons,c.uom,c.rate, c.amount, c.avg_finish_cons,d.dia_width,d.requirment,d.cons from wo_po_color_size_breakdown a, wo_po_break_down b,wo_pre_cost_fabric_cost_dtls c,wo_pre_cos_fab_co_avg_con_dtls d  where a.job_no_mst=b.job_no_mst and  c.job_no=a.job_no_mst and  a.po_break_down_id=b.id and c.job_no=a.job_no_mst and d.pre_cost_fabric_cost_dtls_id=c.id and d.po_break_down_id=a.po_break_down_id and d.po_break_down_id=b.id and d.color_size_table_id=a.id and d.job_no=b.job_no_mst and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no_mst='$txt_job_no' and d.cons>0 $txt_po_breack_down_id_cond  $nom_sup_cond  order  by a.item_number_id,c.body_part_id ";
				  //echo $sql_fab;
				  $sql_fabs_result=sql_select($sql_fab);
				  $fabric_detail_arr=array();  $fabric_job_check_arr=array();
				$total_purchase_amt=0;
					foreach($sql_fabs_result as $row)
					{
						$color_size_sensitive=$row[csf("color_size_sensitive")];
						if($color_size_sensitive==3)
						{
							if($fab_color_arr[$row[csf("id")]][$row[csf("color_id")]]!='')
							{
								$fab_color_id=$fab_color_arr[$row[csf("id")]][$row[csf("color_id")]];
							}
						}
						else  $fab_color_id=$row[csf("color_id")];
						
						$fab_des=$row[csf("construction")].', '.$row[csf("composition")];
						$item_desc= $fab_des.",".$row[csf("gsm_weight")].",".$row[csf("dia_width")].",".$fabric_typee[$row[csf("width_dia_type")]].",".$color_type[$row[csf("color_type")]];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['gmt_color'].=$row[csf("color_id")].',';
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['uom']=$row[csf("uom")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['item_id']=$row[csf("item_id")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['body_id']=$row[csf("body_id")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['nat_id']=$row[csf("nat_id")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['fabric_source']=$row[csf("fabric_source")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['item_desc']=$item_desc;
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['fin_cons']+=$row[csf("cons")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['consRow']+=1;
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['amount']+=$row[csf("amount")];
						
					}
				
				

			if(count($fabric_detail_color_arr)>0){
				?>


            <table id="table_header_1" class="rpt_table" width="1100" cellpadding="0" cellspacing="0" border="1" rules="all">
           				<caption> <b style="float:left">Fabric Details :</b></caption>
					<thead>
                    	<th width="30">SL</th>
                        <th width="100">Gmt Item</th>
						<th width="120">Fab. Nature</th>
						<th width="120">Body Part</th>
						<th width="200">Fab. Desc</th>
						<th width="100">Gmt Color</th>
						<th width="100">Fab. Color</th>
					    <th width="50">UOM</th> 
						<th width="90">Fin. Cons</th>
						<th width="90">Total Fin Cons. </th>
						<th width="90">Fab. Source</th>
                      
                    </thead>
            </table>
			<table class="rpt_table"   width="1100" cellpadding="0" cellspacing="0" border="1" rules="all" id="table_body1">
            
			<?
					
				 // print($fabric_detail_arr);
					$item_rowspan_arr=array();$fab_rowspan_arr=array();
					
					foreach($fabric_detail_color_arr as $fab_dtls_id_key=>$fab_dtls_data)
					{
						 $fab_body_rowspan=0;
						  foreach($fab_dtls_data as $fab_color_key=>$val)
						  {
							$fab_body_rowspan++;
						  }
						$fab_rowspan_arr[$fab_dtls_id_key]=$fab_body_rowspan;
					 }
					//print_r($fab_rowspan_arr);
				
					$i=$m=1;$total_greycons=$total_tot_greycons=$total_tot_fin_cons=$grand_total_fin_cons=$grand_total_tot_greycons=$grand_total_amount=0;
					
						foreach($fabric_detail_color_arr as $fab_dtls_id_key=>$fab_dtls_data)
						{
					  		$y=1;
							foreach($fab_dtls_data as $fab_color_key=>$val)
							{
						
								if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
							
								$uom_key=$val['uom'];
								$body_key=$val['body_id'];
								$item_key=$val['item_id'];
								$desc_key=$val['item_desc'];
								$nat_key=$val['nat_id'];$fab_source_key=$val['fabric_source'];
								$gmt_color=rtrim($val['gmt_color'],',');
								$gmt_colorid=array_unique(explode(",",$gmt_color));
								$gmt_color="";
								$wv_fincons=$fincons_knit=$tot_amount=0;
								foreach($gmt_colorid as $gid)
								{
									if($gmt_color=="") $gmt_color=$color_library[$gid];else $gmt_color.=",".$color_library[$gid];
									
									$fincons_knit+=$fabric_qty_arr['knit']['finish'][$fab_dtls_id_key][$gid][$uom_key];
									$wv_fincons+=$fabric_qty_arr['woven']['finish'][$fab_dtls_id_key][$gid][$uom_key];
								}
								$tot_fin_qty=$fincons_knit+$wv_fincons;
					?>
                    
						<tr bgcolor="<? echo $bgcolor;?>" onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor;?>')" id="tr_<? echo $i; ?>">  <?
                      	 if($y==1){
						?>
							<td width="30" rowspan="<? echo $fab_rowspan_arr[$fab_dtls_id_key]?>"><? echo $m; ?></td>
							<td width="100" rowspan="<?  echo $fab_rowspan_arr[$fab_dtls_id_key];?>"><? echo $garments_item[$item_key]; ?></td> 
							<td width="120" rowspan="<?  echo $fab_rowspan_arr[$fab_dtls_id_key];?>"><? echo $item_category[$nat_key]; ?></td> 
							<td width="120" rowspan="<? echo $fab_rowspan_arr[$fab_dtls_id_key];;?>" align="center"><div style="word-break:break-all"><? echo $body_part[$body_key]; ?></div></td>
                             <?
							 }
							
							?>
							
							<td width="200" align="center" ><div style="word-break:break-all"><? echo $desc_key; ?></div></td>
                            <td width="100"  align="center"><div style="word-break:break-all"><? echo $gmt_color; ?></div></td>
                            <td width="100"  align="center"><div style="word-break:break-all"><? echo $color_library[$fab_color_key]; ?></div></td>
							<td width="50" align="center"><? echo $unit_of_measurement[$val['uom']]; ?></td>
							<td width="90"  align="right">
                            <div style="word-break:break-all">
							<?
							
							 echo fn_number_format($val['fin_cons']/$val['consRow'],4); 
							 ?>
                            </div>
                            </td>
                            <td width="90"  align="right"><div style="word-break:break-all"><? echo fn_number_format($tot_fin_qty,4); ?></div></td>
							<td width="90"  align="center"><div style="word-break:break-all"><? echo $fabric_source[$fab_source_key]; ?></div></td>
							
                            </tr>
                            <?
								$total_fin_cons+=$tot_fin_qty;
								$total_tot_fin_cons+=$val['fin_cons'];
								$grand_total_fin_cons+=$tot_fin_qty;
							
									$y++;
									$i++;
									}
								$m++;
							?>
                            <?
														
						}
							?>
                            <tfoot>
                            <tr>
                            <th colspan="8" ><strong>Grand Total</strong> </th>
                          
                            <th align="right"><strong><? //echo fn_number_format($total_tot_fin_cons,4);?></strong> </th>
                            <th align="right"><strong><? echo fn_number_format($grand_total_fin_cons,4);?></strong> </th>
							<th><strong>&nbsp;</strong> </th>
                            </tr>
                            </tfoot>
                    </table>
					<br/>  	
					<?
			}
					$item_group_arr=return_library_array( "select item_name,id from lib_item_group where item_category=4 order by item_name", "id", "item_name");
					$supplier_library=return_library_array( "select a.supplier_name,a.id from  lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id  and a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
					
					$trims_qty_arr=$trims->getQtyArray_by_jobItemidDescriptionGmtcolorAndSizeid();
					$trims_item_qty_arr=$trims->getQtyArray_by_jobAndItemid();
					$trims_desc_qty_arr=$trims->getQtyArray_by_jobItemidAndDescription(); 
					
					$trims_dtl_qty_arr=$trims->getQtyArray_by_OrderPrecostdtlsidGmtscolorAndGmtssize();
					//print_r($trims_amt_arr);

				 $nom_sup_cond="";
				 if($supplier_check==1)
				 {
				 	$nom_sup_cond=" and ( c.nominated_supp_multi is null or c.nominated_supp_multi='' or c.nominated_supp_multi=0)";
				 }

				 $sql_trim_color="select c.id,c.job_no,c.trim_group,c.description,c.brand_sup_ref,c.nominated_supp_multi as nominated_supp,c.cons_uom,c.remark,d.wo_pre_cost_trim_cost_dtls_id as fab_dtl_id,d.item_size,d.color_number_id,d.item_number_id,d.size_number_id,d.po_break_down_id as po_id,d.excess_per,d.cons,d.tot_cons,c.source_id from wo_pre_cost_trim_cost_dtls c,wo_pre_cost_trim_co_cons_dtls d
				 where c.job_no=d.job_no and d.wo_pre_cost_trim_cost_dtls_id=c.id and c.status_active=1 and c.is_deleted=0 and d.cons>0 and c.job_no='$txt_job_no' $txt_po_breack_down_id_cond2 $nom_sup_cond order by c.id,c.trim_group";
				 //echo  $sql_trim_color;
				 $trim_result=sql_select($sql_trim_color);$tot_trim_req_qty=0;
				 foreach($trim_result as $row)
				 {
					if($excess_per_val>0)
					{
						$total_set_qnty=$job_total_set_qnty_arr[$row[csf('job_no')]];
						$order_quantity=$po_color_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]]['order_quantity'];
						//echo $plan_cut_qnty.'<br/>';
						$tot_cons_qnty=$row[csf("tot_cons")]+($row[csf("tot_cons")]*$excess_per_val)/100;
						$trim_req_qty=($order_quantity/$total_set_qnty)*($tot_cons_qnty/$costPerQty);
						$excess_per=$excess_per_val;
						//echo $trim_req_qty.'='.$excess_per_val.', ';
						//$tot_trim_req_qty+=$trim_req_qty;
					}
					else
					{
						$excess_per=0;
						$excess_per=$row[csf("excess_per")];
						$tot_cons_qnty=$row[csf("cons")];
						//$trim_req_qty=$trims_qty_arr[$row[csf("job_no")]][$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]];
						$trim_req_qty=$trims_dtl_qty_arr[$row[csf("po_id")]][$row[csf("id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]];
					}
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['description']=$row[csf("description")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['nominated_supp']=$row[csf("nominated_supp")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['size_number_id']=$row[csf("size_number_id")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['job_no']=$row[csf("job_no")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['item_size']=$row[csf("item_size")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['remark']=$row[csf("remark")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['cons_uom']=$row[csf("cons_uom")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['cons']=$row[csf("tot_cons")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['source_id']=$row[csf("source_id")];

					//$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['tot_size_cons']+=$trims_qty_arr[$row[csf("job_no")]][$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['tot_size_cons']+=$trim_req_qty;
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['tot_cons']=$tot_cons_qnty;
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['excess_per']=$excess_per;
					$item_tot_qty_arr[$row[csf("trim_group")]][$row[csf("description")]]+=$trim_req_qty;
					
				 }
				// echo $tot_trim_req_qty.', ';
				  	foreach($trims_color_arr as $trim_key=>$trim_data)
					 {
						  $trim_color_rowspan=0;
						   foreach($trim_data as $desc_key=>$desc_data)
					 	   {
						   $trim_desc_rowspan=0;
						    foreach($desc_data as $gmt_color_key=>$color_data)
					 	    {
								$item_size_rowspan=0;
								foreach($color_data as $size_key=>$val)
								{
									$item_size_rowspan++;
									$trim_desc_rowspan++;
									$trim_color_rowspan++;
									$color_qty[$trim_key][$desc_key][$gmt_color_key]+=$val['tot_size_cons'];
									$trim_color_rowspan_arr[$trim_key][$desc_key][$gmt_color_key]+=1;
								}
								$item_size_rowspan_arr[$trim_key][$desc_key][$gmt_color_key]=$item_size_rowspan;
								$trim_desc_rowspan_arr[$trim_key][$desc_key]=$trim_desc_rowspan;
								$trim_size_rowspan_arr[$trim_key]=$trim_color_rowspan;
								
							}
						   }
					}
				 	//print_r($trim_size_rowspan_arr);
					?>
           		 <table id="table_header_1" class="rpt_table" width="1120" cellpadding="0" cellspacing="0" border="1" rules="all">
           			<caption> <b style="float:left">Trims Details:</b></caption>
					<thead>
                    	<th width="30">SL</th>
                        <th width="100">Item</th>
						<th width="120">Description</th>
						<th width="100">Remarks</th>
						<th width="100">Source</th>
						<th width="100">Supplier</th>
						<th width="100">Gmt Color</th>
						<th width="100">Item Size</th>
					
					    <th width="50">UOM</th> 
						<th width="80">Cons</th>
						<th width="80">Exs %</th>
						<th width="80">Total Cons. </th>
						<th width="80">Total Qty </th>
						<th width="80">Color Total Qty.</th>
						<th width="80">Item Total Qty.</th>
                      
                    </thead>
					<tbody>
					 <?

					 	$supplier_library_fabric=return_library_array( "select a.id, a.supplier_name from lib_supplier a where a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
							
						 $j=1;$total_trim_cons=$total_tot_trim_cons_qty=$total_tot_item_qty_cons=$total_trim_qty_cons=0;
						 foreach($trims_color_arr as $trim_key=>$trim_data)
					 	 {
						   $k=1;
						   foreach($trim_data as $desc_key=>$desc_data)
					 	   {
						    $n=1;
						    foreach($desc_data as $gmt_color_key=>$color_data)
					 	    {
						    $m=1;$c=1;
						     foreach($color_data as $size_key=>$val)
					 	     {
								if($j%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
								if($col_size_cons_arr[$trim_key][$gmt_color_key]>0)
								{
								$tot_size_qty=$col_size_cons_arr[$trim_key][$gmt_color_key];
								}
								if($item_tot_cons_arr[$trim_key]>0)
								{
								$item_tot_size_qty=$item_tot_cons_arr[$trim_key];
								}
								$job_no=$val['job_no'];
								$item_size=$val['item_size'];
								$tot_size_cons=$val['tot_size_cons'];
								
								$gmt_item_desc_qty=$item_tot_qty_arr[$trim_key][$desc_key];//$trims_desc_qty_arr[$job_no][$trim_key][$desc_key];
								//$gmt_item_desc_qty=$trims_item_qty_arr[$job_no][$trim_key];
								$gmt_size_qty=$tot_size_cons;//$trims_qty_arr[$job_no][$trim_key][$desc_key][$gmt_color_key][$size_key];
								//$item_tot_qty=$item_tot_qty_arr[$trim_key][$desc_key];
							
								
								$nominated_supp_str="";
								$exsupp=explode(",",$val["nominated_supp"]);
								foreach($exsupp as $sid)
								{
									if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_fabric[$sid]; else $nominated_supp_str.=','.$supplier_library_fabric[$sid];
								}  
								
								
					?>
						
						<tr bgcolor="<? echo $bgcolor;?>" onClick="change_color('tr_<? echo $j; ?>','<? echo $bgcolor;?>')" id="tr_<? echo $j; ?>">  <?
                      	 if($k==1){ 
						?>
							<td width="30" rowspan="<? echo $trim_size_rowspan_arr[$trim_key]?>"><? echo $j; ?></td>
							<td width="100" rowspan="<?  echo $trim_size_rowspan_arr[$trim_key];?>"><? echo $item_group_arr[$trim_key]; ?></td> 
							 <?
								
							 }
							//$tot_gmt_size_qty=0;
							
							 
							  if($n==1){ 
							  
							 ?>
							<td width="120" rowspan="<?  echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>"><? echo  $desc_key; ?></td> 

							<td width="100" rowspan="<? echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>" align="center"><div style="word-break:break-all"><? echo $val['remark']; ?></div></td>

							<td width="100" rowspan="<? echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>" align="center"><div style="word-break:break-all"><? echo $commission_particulars[$val['source_id']]; ?></div></td>

							<td width="100"  rowspan="<? echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>" align="center" ><div style="word-break:break-all"><?=$nominated_supp_str; ?></div></td>
                             <?
							 }
							
							if($m==1){ 
							 
							?>
                            <td width="100" rowspan="<? echo $item_size_rowspan_arr[$trim_key][$desc_key][$gmt_color_key];?>"  align="center"><div style="word-break:break-all"><? echo $color_library[$gmt_color_key]; ?></div></td>
							<?
							}
							?>
                            <td width="100" title="<?=$size_key?>"  align="center"><div style="word-break:break-all"><?=$size_key?></div></td>
							<td width="50" align="center"><? echo $unit_of_measurement[$val['cons_uom']]; ?></td>
							<td width="80"  align="center"><div style="word-break:break-all"><? echo fn_number_format($val['cons'],4); ?></div></td>
							
                            <td width="80"  align="right" title="<? echo $val['excess_per']; ?>"><div style="word-break:break-all"><? echo fn_number_format($val['excess_per'],4);//echo fn_number_format($val['excess_per'],4); ?></div></td>
							
							<td width="80"  align="right"><div style="word-break:break-all"><? echo fn_number_format($val['tot_cons'],4); ?></div></td>
							<td width="80"  align="right"><div style="word-break:break-all"><? echo fn_number_format($gmt_size_qty,2); ?></div></td>
							<?
							
							
							 if($c==1){ 
							?>
                            <td width="80"   align="center" rowspan="<?=$trim_color_rowspan_arr[$trim_key][$desc_key][$gmt_color_key];?>"><div style="word-break:break-all"><? echo  fn_number_format($color_qty[$trim_key][$desc_key][$gmt_color_key],2); ?></div></td>
							<?
							 $c++;}
							if($n==1){ 
							 $total_tot_item_qty_cons+=$gmt_item_desc_qty;
							?>
                            <td width="80" rowspan="<? echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>"  align="center"><div style="word-break:break-all"><? echo  fn_number_format($gmt_item_desc_qty,2); ?></div></td>
							<?
							}
							?>
							
                       </tr>
					   <?
					   		$total_tot_trim_cons_qty+=$val['cons'];
							$total_trim_cons+=$val['tot_cons'];
							$total_trim_qty_cons+=$gmt_size_qty;
							$k++;$m++;$n++;
							
					   		}
							?>
							
							<?
						    }
							
						   }
						  
						  $j++;
					   	}
					   ?>
						<tfoot>
						<tr>
							<th colspan="8" align="right"> Grand Total </th>
							<th align="right"> </th>
							<th align="right"> <? echo fn_number_format($total_tot_trim_cons_qty,4); ?> </th>
							
							<th align="right"> <? //echo fn_number_format($total_tot_trim_qty,4); ?> </th>
							<th> <? echo fn_number_format($total_trim_cons,4); ?> </th>
							<th align="right"> <? echo fn_number_format($total_trim_qty_cons,2); ?> </th>
							<th align="right"> </th>
							<th align="right"> <? echo fn_number_format($total_tot_item_qty_cons,2); ?> </th>
						</tr>
						</tfoot>
					</tbody>
            </table>
			
		</div>
		<br>
		<? echo signature_table(109, $cbo_company_name, "950px"); ?>
	</div>
	<?
	exit();	
}

if($action=="bomRptWoven_2")// PO Wise btn JSTX
{

	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and c.costing_date='".$txt_costing_date."'";
	
	if(str_replace("'",'',$txt_po_breack_down_id)=="")
	{
		$txt_po_breack_down_id_cond='';
		$txt_po_breack_down_id_cond1='';
		$txt_po_breack_down_id_cond2='';
		$txt_po_breack_down_id_cond3='';
		$txt_po_breack_down_id_condavg="";
	}
	else
	{
		$poIDs=str_replace("'",'',$txt_po_breack_down_id);
		$txt_po_breack_down_id_cond=" and b.id in(".$poIDs.")";
		$txt_po_breack_down_id_cond1=" and id in(".$poIDs.")";
		$txt_po_breack_down_id_cond2=" and po_break_down_id in(".$poIDs.")";
		$txt_po_breack_down_id_condavg=" and c.po_break_down_id in(".$poIDs.")";
		$txt_po_breack_down_id_cond3=" and b.id in(".$poIDs.")";
	}

	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$supplier_name_arr=return_library_array( "select id, supplier_name from  lib_supplier",'id','supplier_name');
	$supplier_arr=return_library_array( "select a.id, a.supplier_name from lib_supplier a,lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(23) and a.is_deleted=0 and a.status_active=1 group by a.id, a.supplier_name order by a.supplier_name", "id", "supplier_name");
	$color_library=return_library_array("select id,color_name from lib_color where status_active=1 and is_deleted=0","id","color_name");

	$poNumber=array();
	$pubShipDate=array();
	$po_qty=0;
	$po_plun_cut_qty=0;
	$total_set_qnty=0;
	$avg_unit_price=0;
	 $sql_po="select a.job_no,a.total_set_qnty,a.avg_unit_price,b.id,b.po_number,b.pub_shipment_date,c.item_number_id,c.country_id,c.color_number_id,c.size_number_id,c.order_quantity ,c.plan_cut_qnty,c.order_total  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst   and b.id=c.po_break_down_id  and a.job_no =".$txt_job_no." $txt_po_breack_down_id_cond and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 order by b.id";
	$sql_po_data=sql_select($sql_po);
	foreach($sql_po_data as $sql_po_row){
		$po_qty+=$sql_po_row[csf('order_quantity')];
		$po_plun_cut_qty+=$sql_po_row[csf('plan_cut_qnty')];
		$total_set_qnty=$sql_po_row[csf('total_set_qnty')];
		$poNumber[$sql_po_row[csf('po_number')]]=$sql_po_row[csf('po_number')];
		$po_total_amount +=$sql_po_row[csf('order_total')];
		$pubShipDate[$sql_po_row[csf('po_number')]]=change_date_format($sql_po_row[csf('pub_shipment_date')],"dd-mm-yyyy","-");
		$avg_unit_price=$sql_po_row[csf('avg_unit_price')];
	}

	$poQtyUom=$po_qty/$total_set_qnty;
	$poPlunCutQtyUom=$po_plun_cut_qty/$total_set_qnty;
	$excessQty=$poPlunCutQtyUom-$poQtyUom;
	$excessPer=(100*$excessQty)/$poQtyUom;

	$gmtsItem=array();
	$gmtsitem_ratio_array=array();
	$gmtsitem_ratio_sql=sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no =".$txt_job_no."");
	foreach($gmtsitem_ratio_sql as $gmtsitem_ratio_sql_row){
		$gmtsitem_ratio_array[$gmtsitem_ratio_sql_row[csf('job_no')]][$gmtsitem_ratio_sql_row[csf('gmts_item_id')]]=$gmtsitem_ratio_sql_row[csf('set_item_ratio')];
		$gmtsItem[$gmtsitem_ratio_sql_row[csf('gmts_item_id')]]=$garments_item[$gmtsitem_ratio_sql_row[csf("gmts_item_id")]];
	}

	$financial_para=array();
	$sql_std_para=sql_select("select interest_expense,income_tax,cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and status_active=1 and	is_deleted=0 order by id");
	foreach($sql_std_para as $sql_std_row){
		$financial_para[interest_expense]=$sql_std_row[csf('interest_expense')];
		$financial_para[income_tax]=$sql_std_row[csf('income_tax')];
		$financial_para[cost_per_minute]=$sql_std_row[csf('cost_per_minute')];
	}

	$sql = "select a.job_no, a.company_name, a.buyer_name, a.style_ref_no, a.gmts_item_id, a.order_uom, a.job_quantity, a.avg_unit_price, b.costing_per, b.budget_minute, b.sew_smv, b.cut_smv,b.sew_effi_percent,b.cut_effi_percent,b.approved,b.id from wo_po_details_master a, wo_pre_cost_mst b where a.job_no=b.job_no  and a.status_active=1 $job_no $company_name $cbo_buyer_name $txt_style_ref order by a.job_no";
	$data_array=sql_select($sql);
	$uom="";
	$jobNo="";
	$buyerName="";
	$styleRefNo="";
	$costingPer="";
	$pre_cost_id="";
	$sewing_smv="";
	$sewing_effi="";

	foreach ($data_array as $row){
		$uom=$row[csf("order_uom")];
		$jobNo=$row[csf("job_no")];
		$buyerName=$buyer_arr[$row[csf("buyer_name")]];
		$styleRefNo=$row[csf("style_ref_no")];
		$costingPer=$row[csf("costing_per")];
		$pre_cost_id=$row[csf("id")];
		$sewing_smv=$row[csf("sew_smv")];
		$sewing_effi=$row[csf("sew_effi_percent")];

		$order_price_per_dzn=0;
		if($costingPer==1){
			$order_price_per_dzn=12;
			$costing_for=" DZN";
		}
		else if($costingPer==2){
			$order_price_per_dzn=1;
			$costing_for=" PCS";
		}
		else if($costingPer==3){
			$order_price_per_dzn=24;
			$costing_for=" 2 DZN";
		}
		else if($costingPer==4){
			$order_price_per_dzn=36;
			$costing_for=" 3 DZN";
		}
		else if($costingPer==5){
			$order_price_per_dzn=48;
			$costing_for=" 4 DZN";
		}
	}
	//start	all summary report here -------------------------------------------
	$po_id=str_replace("'","",$txt_po_breack_down_id);
	$condition= new condition();
	if(str_replace("'","",$txt_job_no) !=''){
		$condition->job_no("=$txt_job_no");
	}
	if(str_replace("'",'',$txt_po_breack_down_id) !=""){
		$condition->po_id("in($po_id)");
	}
	$condition->init();
	$fabric= new fabric($condition);
	//echo $fabric->getQuery();die;
	$conversion= new conversion($condition);
	$trim= new trims($condition);
	$emblishment= new emblishment($condition);
	$wash= new wash($condition);
	$other= new other($condition);
	$other_cost=$other->getAmountArray_by_job();
	$commercial= new commercial($condition);
	$commision= new commision($condition);


	 $sql_new = "select job_no,fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,wash_cost,wash_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,currier_pre_cost,currier_percent,certificate_pre_cost,certificate_percent,common_oh,common_oh_percent,depr_amor_pre_cost,total_cost , total_cost_percent, price_dzn, price_dzn_percent, margin_dzn,margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche from wo_pre_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array_new=sql_select($sql_new);
	$summary_data=array();

	foreach( $data_array_new as $row_new ){
		$summary_data[price_dzn]=$row_new[csf("price_dzn")];
		$summary_data[price_dzn_job]=($po_qty/($total_set_qnty*$order_price_per_dzn))*$row_new[csf("price_dzn")];
		$summary_data[price_dzn_job_per]=($summary_data[price_dzn_job]/$summary_data[price_dzn_job])*100;

		$summary_data[commission]=$row_new[csf("commission")];
		$summary_data[trims_cost]=$row_new[csf("trims_cost")];
		$summary_data[emb_cost]=$row_new[csf("embel_cost")];

		$summary_data[lab_test]=$row_new[csf("lab_test")];
		$summary_data[lab_test_job]=$other_cost[$row_new[csf("job_no")]]['lab_test'];

		$summary_data[inspection]=$row_new[csf("inspection")];
		$summary_data[inspection_job]=$other_cost[$row_new[csf("job_no")]]['inspection'];

		$summary_data[freight]=$row_new[csf("freight")];
		$summary_data[freight_job]=$other_cost[$row_new[csf("job_no")]]['freight'];

		$summary_data[currier_pre_cost]=$row_new[csf("currier_pre_cost")];
		$summary_data[currier_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['currier_pre_cost'];

		$summary_data[certificate_pre_cost]=$row_new[csf("certificate_pre_cost")];
		$summary_data[certificate_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['certificate_pre_cost'];
		$summary_data[wash_cost]=$row_new[csf("wash_cost")];

		$summary_data[OtherDirectExpenses]=$row_new[csf("lab_test")]+$row_new[csf("inspection")]+$row_new[csf("freight")]+$row_new[csf("currier_pre_cost")]+$row_new[csf("certificate_pre_cost")]+$row_new[csf("wash_cost")];

		$summary_data[OtherDirectExpenses_job]=$summary_data[lab_test_job]+$summary_data[inspection_job]+$summary_data[freight_job]+$summary_data[currier_pre_cost_job]+$summary_data[certificate_pre_cost_job];

		$summary_data[cm_cost]=$row_new[csf("cm_cost")];
		$summary_data[cm_cost_job]=$other_cost[$row_new[csf("job_no")]]['cm_cost'];

		$summary_data[comm_cost]=$row_new[csf("comm_cost")];

		$summary_data[common_oh]=$row_new[csf("common_oh")];
		$summary_data[common_oh_job]=$other_cost[$row_new[csf("job_no")]]['common_oh'];
		$summary_data[depr_amor_pre_cost]=$row_new[csf("depr_amor_pre_cost")];
		$summary_data[depr_amor_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['depr_amor_pre_cost'];
	}

	//Fabric =====================
	$fabric_qty=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$fabric_amount=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	
	 // $sql_fabric_avg = "SELECT b.id, b.job_no,b.body_part_id, b.fab_nature_id, b.color_type_id, b.fabric_description,b.uom, (c.requirment) as avg_cons,b.avg_cons_yarn, b.fabric_source,b.gsm_weight, c.rate, c.amount, b.avg_finish_cons, b.status_active,b.nominated_supp_multi from wo_pre_cost_fabric_cost_dtls b,wo_pre_cos_fab_co_avg_con_dtls c where  b.id=c.pre_cost_fabric_cost_dtls_id and b.job_id=c.job_id and b.job_no=".$txt_job_no." and b.status_active=1 and c.status_active=1 $txt_po_breack_down_id_condavg ";
	//$data_arr_fabricAvg=sql_select($sql_fabric_avg);
	$FabricData=array();
	//foreach($data_arr_fabricAvg as $row)
	//{
		//$fab_cons_dtls_arr[$row[csf("id")]]=$row[csf("id")];
		/*$FabricData[$row[csf("id")]][$row[csf("uom")]]['amount']+=$row[csf("rate")]*$row[csf("avg_cons")];
		$supplier_wise_amount_arr[$row[csf('nominated_supp_multi')]]['tot_amount']+=$row[csf("rate")]*$row[csf("avg_cons")];
		$FabricData[$row[csf("id")]][$row[csf("uom")]]['rate']=($row[csf("rate")]*$row[csf("avg_cons")])/$row[csf("avg_cons")];
		$FabricData[$row[csf("id")]][$row[csf("uom")]]['avg_cons']+=$row[csf("avg_cons")];*/
		
	//} 
	//$fab_dtls_cond_for_in=where_con_using_array($fab_cons_dtls_arr,0,"id");
	
	 $sql_fabric = "SELECT id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description,uom, avg_cons,avg_cons_yarn, fabric_source,gsm_weight, rate, amount, avg_finish_cons, status_active,nominated_supp_multi  from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no." and status_active=1 ";
	$data_arr_fabric=sql_select($sql_fabric);
	$totFabQty=0;
	$totFabAmt=0;
	
	foreach($data_arr_fabric as $fab_row){
		$summary_data[fabric_cost][$fab_row[csf("id")]]=$fab_row[csf("amount")];
		if($fab_row[csf("fab_nature_id")] == 3)
		{
			$summary_data[fabric_cost_job]+=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		}
		if($fab_row[csf("fab_nature_id")] == 2)
		{
			$summary_data[fabric_cost_job]+=$fabric_amount['knit']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		}
		$totFabQty+=$fabric_qty['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		$totFabAmt+=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];

		$FabricData[$fab_row[csf("id")]][$fab_row[csf("uom")]]['description']=$body_part[$fab_row[csf("body_part_id")]].", ".$color_type[$fab_row[csf("color_type_id")]].", ".$fab_row[csf("fabric_description")].", ".$fab_row[csf("gsm_weight")];
		$FabricData[$fab_row[csf("id")]][$fab_row[csf("uom")]]['fabric_source']=$fabric_source[$fab_row[csf("fabric_source")]];
		$FabricData[$fab_row[csf("id")]][$fab_row[csf("uom")]]['nominated_supp']=$fab_row[csf("nominated_supp_multi")];
		$FabricData[$fab_row[csf("id")]][$fab_row[csf("uom")]]['avg_cons']=$fab_row[csf("avg_cons")];
		if($fab_row[csf("fab_nature_id")] == 3){
			$FabricData[$fab_row[csf("id")]][$fab_row[csf("uom")]]['totalConsWoven']=$fabric_qty['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
			$FabricData[$fab_row[csf("id")]][$fab_row[csf("uom")]]['totalAmountWoven']=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
			$supplier_wise_amount_arr[$fab_row[csf('nominated_supp_multi')]]['tot_amount']+=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		}
		if($fab_row[csf("fab_nature_id")] == 2){
			$FabricData[$fab_row[csf("id")]][$fab_row[csf("uom")]]['totalConsWoven']=$fabric_qty['knit']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
			$FabricData[$fab_row[csf("id")]][$fab_row[csf("uom")]]['totalAmountWoven']=$fabric_amount['knit']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
			$supplier_wise_amount_arr[$fab_row[csf('nominated_supp_multi')]]['tot_amount']+=$fabric_amount['knit']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		}
		 
		$FabricData[$fab_row[csf("id")]][$fab_row[csf("uom")]]['uom']=$unit_of_measurement[$fab_row[csf("uom")]];
		$FabricData[$fab_row[csf("id")]][$fab_row[csf("uom")]]['rate']=$fab_row[csf("rate")];
		$FabricData[$fab_row[csf("id")]][$fab_row[csf("uom")]]['amount']=$fab_row[csf("rate")]*$fab_row[csf("avg_cons")];
		//$supplier_wise_amount_arr[$fab_row[csf('nominated_supp_multi')]]['tot_amount']+=$fab_row[csf("rate")]*$fab_row[csf("avg_cons")];
		 
	}
	$totFabQtyAsCostPer=($totFabQty/$poPlunCutQtyUom)*$order_price_per_dzn;
	//Fabric End======================
	//start	Trims Cost part report here -------------------------------------------
	$sql_trim = "SELECT id, job_no, trim_group,description,brand_sup_ref,remark, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp_multi,status_active,seq from wo_pre_cost_trim_cost_dtls where job_no=".$txt_job_no." and  status_active=1 and is_deleted=0 order by seq";
	$data_array_trim=sql_select($sql_trim);
	$trim_amount_arr=$trim->getAmountArray_by_jobAndPrecostdtlsid();
	$trim_qty_arr=$trim->getQtyArray_by_jobAndPrecostdtlsid();
	//$trim_amount_arr=$trim->getAmountArray_by_jobAndPrecostdtlsid_consAndTotcons();
	//$trim_qty_arr=$trim->getQtyArray_by_jobAndPrecostdtlsid_consAndTotcons();
	$totTrim=0;
	$TrimData=array();
	foreach( $data_array_trim as $row_trim ){
	    $trim_qty=$trim_qty_arr[$row_trim[csf("job_no")]][$row_trim[csf("id")]];
		$trim_amount=$trim_amount_arr[$row_trim[csf("job_no")]][$row_trim[csf("id")]];
		$summary_data[trims_cost_job]+=$trim_amount;

		$TrimData[$row_trim[csf('id')]]['trim_group']=$row_trim[csf('trim_group')];
		$TrimData[$row_trim[csf('id')]]['description']=$row_trim[csf('description')];
		$TrimData[$row_trim[csf('id')]]['brand_sup_ref']=$row_trim[csf('brand_sup_ref')];
		$TrimData[$row_trim[csf('id')]]['remark']=$row_trim[csf('remark')];
		$TrimData[$row_trim[csf('id')]]['cons_uom']=$row_trim[csf('cons_uom')];
		$TrimData[$row_trim[csf('id')]]['cons_dzn_gmts']=$row_trim[csf('cons_dzn_gmts')];
		$TrimData[$row_trim[csf('id')]]['rate']=$row_trim[csf('rate')];
		$TrimData[$row_trim[csf('id')]]['amount']=$row_trim[csf('amount')];
		$TrimData[$row_trim[csf('id')]]['apvl_req']=$row_trim[csf('apvl_req')];
		$TrimData[$row_trim[csf('id')]]['nominated_supp']=$row_trim[csf('nominated_supp_multi')];
		$TrimData[$row_trim[csf('id')]]['tot_cons']=$trim_qty;
		$TrimData[$row_trim[csf('id')]]['tot_amount']=$trim_amount;
		$totTrim+=$row_trim[csf('cons_dzn_gmts')];
		$supplier_wise_amount_arr[$row_trim[csf('nominated_supp_multi')]]['tot_amount']+=$trim_amount;
	}
	//End	Trims Cost part report here -------------------------------------------
	//Emb cost Cost part report here -------------------------------------------

	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active,nominated_supp_multi from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name in(1,2,4,5) and  status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	$emblishment_qty=$emblishment->getQtyArray_by_jobAndEmblishmentid();
	$emblishment_amount=$emblishment->getAmountArray_by_jobAndEmblishmentid();


	$totEmb=0;
	$EmbData=array();

	foreach( $data_array as $row ){
	$embqty=$emblishment_qty[$row[csf("job_no")]][$row[csf("id")]];
	$embamount=$emblishment_amount[$row[csf("job_no")]][$row[csf("id")]];
	$summary_data[emb_cost_job]+=$embamount;
	$EmbData[$row[csf("id")]]['emb_name']=$row[csf("emb_name")];
	$EmbData[$row[csf("id")]]['supplier_id']=$row[csf("nominated_supp_multi")];
	$EmbData[$row[csf("id")]]['emb_type']=$row[csf("emb_type")];
	$EmbData[$row[csf("id")]]['cons_dzn_gmts']=$row[csf("cons_dzn_gmts")];
	$EmbData[$row[csf("id")]]['rate']=$row[csf("rate")];
	$EmbData[$row[csf("id")]]['amount']=$row[csf("amount")];
	$EmbData[$row[csf("id")]]['tot_cons']=$embqty;
	$EmbData[$row[csf("id")]]['tot_amount']=$embamount;
	$totEmb+=$row[csf("cons_dzn_gmts")];
	$supplier_wise_amount_arr[$row[csf('nominated_supp_multi')]]['tot_amount']+=$embamount;
	}
	//End Emb cost Cost part report here -------------------------------------------
	//Wash cost Cost part report here -------------------------------------------
	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active,nominated_supp_multi from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name =3 and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	$wash_qty=$wash->getQtyArray_by_jobAndEmblishmentid();
	$wash_amount=$wash->getAmountArray_by_jobAndEmblishmentid();
	foreach( $data_array as $row ){
	$washqty=$wash_qty[$row[csf("job_no")]][$row[csf("id")]];
	$washamount=$wash_amount[$row[csf("job_no")]][$row[csf("id")]];
	$summary_data[wash_cost_job]+=$washamount;
	$summary_data[OtherDirectExpenses_job]+=$washamount;
	$EmbData[$row[csf("id")]]['emb_name']=$row[csf("emb_name")];
	$EmbData[$row[csf("id")]]['supplier_id']=$row[csf("nominated_supp_multi")];
	$EmbData[$row[csf("id")]]['emb_type']=$row[csf("emb_type")];
	$EmbData[$row[csf("id")]]['cons_dzn_gmts']=$row[csf("cons_dzn_gmts")];
	$EmbData[$row[csf("id")]]['rate']=$row[csf("rate")];
	$EmbData[$row[csf("id")]]['amount']=$row[csf("amount")];
	$EmbData[$row[csf("id")]]['tot_cons']=$washqty;
	$EmbData[$row[csf("id")]]['tot_amount']=$washamount;
	$totEmb+=$row[csf("cons_dzn_gmts")];
	$supplier_wise_amount_arr[$row[csf('nominated_supp_multi')]]['tot_amount']+=$washamount;
	}
	//End Wash cost Cost part report here -------------------------------------------

	//Commision cost Cost part report here -------------------------------------------
	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls  where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	$commision_amount=$commision->getAmountArray_by_jobAndPrecostdtlsid();
	$totCommi=0;
	$CommiData=array();
	foreach( $data_array as $row ){
	$CommiData[$row[csf("id")]]['particulars_id']=$row[csf("particulars_id")];
	$CommiData[$row[csf("id")]]['commission_base_id']=$row[csf("commission_base_id")];
	$CommiData[$row[csf("id")]]['commision_rate']=$row[csf("commision_rate")];
	$CommiData[$row[csf("id")]]['commission_amount']=$row[csf("commission_amount")];
	$CommiData[$row[csf("id")]]['tot_commission_amount']=$commision_amount[$row[csf("job_no")]][$row[csf("id")]];
	$totCommi+=$row[csf("commission_amount")];
	$summary_data[commission_job]+=$commision_amount[$row[csf("job_no")]][$row[csf("id")]];
	}
	$summary_data[commission_job_per]=($summary_data[commission_job]/$summary_data[price_dzn_job])*100;
	//End Commision cost Cost part report here -------------------------------------------

	//Commarcial cost Cost part report here -------------------------------------------
	$sql = "select id, job_no, item_id, rate, amount, status_active from  wo_pre_cost_comarci_cost_dtls  where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	$commarcial_amount=$commercial->getAmountArray_by_jobAndPrecostdtlsid();

	$totCommar=0;
	$CommarData=array();
	foreach( $data_array as $row ){
	$commarcialamount=$commarcial_amount[$row[csf("job_no")]][$row[csf("id")]];
	$summary_data[comm_cost_job]+=$commarcialamount;
	$CommarData[$row[csf("id")]]['item_id']=$row[csf("item_id")];
	$CommarData[$row[csf("id")]]['rate']=$row[csf("rate")];
	$CommarData[$row[csf("id")]]['amount']=$row[csf("amount")];
	$CommarData[$row[csf("id")]]['tot_amount']=$commarcialamount;
	$totCommar+=$row[csf("amount")];
	}
	?>        
    <table style="width:850px" ><tr><td colspan="6" align="center">
		   <?
            $image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id=$cbo_company_name","image_location");
            ?>
            <img  src='../../<? echo $image_location; ?>' height='70' align="left" />
            <b style="font-size:25px;"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></b><br>
            <b style="font-size:14px;">BOM Report</b>
        </td></tr></table>

        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
        <tr>
            <td width="80">Job Number</td>
            <td width="80"><b><? echo $jobNo; ?></b></td>
            <td width="90">Buyer</td>
            <td width="100"><b><? echo $buyerName; ?></b></td>
            <td width="80">Garments Item</td>
            <td width="100"><b><? echo implode(",",$gmtsItem); ?></b></td>
        </tr>

        <tr>
            <td>Order Qnty </td>
            <td colspan=""><b><? echo $poQtyUom; ?></b></td>
            <td>Excess Cut %</td>
            <td><b><?  echo number_format($excessPer,2) ?></b></td>
            <td>Plan Cut Qty</td>
            <td><b><? echo $poPlunCutQtyUom." ". $unit_of_measurement[$uom];?></b></td>
        </tr>

        <tr>
            <td>Style Ref. No </td>
            <td colspan=""><b><? echo $styleRefNo; ?></b></td>
            <td>Costing Per</td>
            <td><b><? echo $costing_per[$costingPer];?></b></td>
            <td>Price Per Unit</td>
            <td><b><? echo number_format($avg_unit_price,4); ?></b></td>
        </tr>

        <tr>
            <td>Order Numbers</td>
            <td ><b><? echo implode(", ",$poNumber); ?></b></td>
			<td>Sew. SMV</td>
            <td><b><? echo $sewing_smv; ?></b></td>
			<td>PO Value (USD)</td>
            <td><b><? echo fn_number_format($po_total_amount,4); ?></b></td>
        </tr>

        <tr>
            <td>Shipment Date </td>
            <td colspan="3"><b>  <? echo implode(", ",$pubShipDate); ?></b></td>
			<td>Sew Efficiency %</td>
            <td><b><? echo $sewing_effi; ?></b></td>
             <!-- <td>Fabric Cons</td>
            <td><b><? echo number_format($totFabQtyAsCostPer,2); ?></b></td> -->

        </tr>
    </table>
       <?
    $approved_sql=sql_select("SELECT  mst_id, approved_by ,approved_date  from approval_history where entry_form=46 AND  mst_id =$pre_cost_id and un_approved_date is null ");
    $user_lib_name=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");
    $user_lib_desg=return_library_array("SELECT id,designation from user_passwd", "id", "designation");
    $designation_lib=return_library_array("SELECT id,custom_designation from lib_designation", "id", "custom_designation");
    $supplier_name_arr=return_library_array( "select id, supplier_name from  lib_supplier",'id','supplier_name');
    if(count($approved_sql) > 0){ $sl=1; ?>
        <div style="margin-top:15px">
                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <label><b>Pre-Cost Approval Status </b></label>
                    <tr style="font-weight:bold">
                        <th width="20">SL</th>
                        <th width="250">Name</th>
                        <th width="200">Designation</th>
                        <th width="100">Approval Date</th>
                    </tr>
                    <? foreach ($approved_sql as $key => $value) { ?>
                        <tr>
                        <td width="20"><? echo $sl; ?></td>
                        <td width="250"><? echo $user_lib_name[$value[csf("approved_by")]]; ?></td>
                        <td width="200"><? echo $designation_lib[$user_lib_desg[$value[csf("approved_by")]]]; ?></td>
                        <td width="100"><? echo change_date_format($value[csf("approved_date")]); ?></td>
                    </tr>
                    <? $sl++; }  ?>

                </table>
        </div>
    <? } ?>
	<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
					<label><b> Fabric Cost  </b></label>
						<tr style="font-weight:bold"  align="center">
							<td width="350">Description</td>
							<td width="100">Source</td>
							<td width="100">Nominated Supp</td>
							<td width="100">Fab. Cons/<? echo $costing_for ?></td>
							<td width="100">Total Cons</td>
							<td width="50">UOM</td>
							<td width="50">Rate (USD)</td>
							<td width="100">Amount (USD)/<? echo $costing_for ?></td>
							<td width="100">Tot.Amount (USD)</td>
						</tr>
        <?
        /*echo '<pre>';
        print_r($FabricData); die;*/
		foreach( $FabricData as $uom_id=>$uom_data ) {

			foreach( $uom_data as $index=>$row ) {

			    $uom=$row["uom"];
			    $item_descrition =$row['description'];
			    $totalConsWoven=$row["totalConsWoven"];
				$totalAmountWoven=$row["totalAmountWoven"];
				$amount=$row["amount"];
				?>
                <tr>
                    <td align="left"><?  echo $item_descrition;?></td>
                    <td align="left"><?  echo $row["fabric_source"];?></td>
                    <td align="left">
                    <?  
                    	 $exnominated_supp=explode(",",$row['nominated_supp']);
                    	 $nominated_supp_str='';
						 foreach($exnominated_supp as $supp)
						 {
							if($nominated_supp_str=="") $nominated_supp_str=$supplier_name_arr[$supp]; else $nominated_supp_str.=','.$supplier_name_arr[$supp];
						 }
						 echo $nominated_supp_str;
                    	//echo $row["nominated_supp"];
						$avg_cons=($totalConsWoven/$poPlunCutQtyUom)*$order_price_per_dzn;
						
						if($totalAmountWoven) $amount=($totalAmountWoven/$totalConsWoven)*$order_price_per_dzn;
						else $amount=0;
                    ?>
                    	
                    </td>
                    <td align="right"><? echo number_format($avg_cons,4);?></td>
					<td align="right"><? echo number_format($totalConsWoven,4);?></td>
					<td align="left"><?  echo $uom; ?></td>
                    <td align="right"><? if($totalAmountWoven) echo number_format($totalAmountWoven/$totalConsWoven,4);else echo " ";?></td>
                    <td align="right"><?  echo number_format($amount,4);?></td>
					<td align="right"><? echo number_format($totalAmountWoven,4);?></td>
                </tr>
                <?
				
				 $subtotalDznAmount+=$amount;
				 $subtotalAmount+=$totalAmountWoven;

				 $GrandtotalConsWoven+=$totalConsWoven;
				 $GrandtotalDznAmount+=$amount;
				 $GrandtotalAmount+=$totalAmountWoven;
         }?>
		 <tr class="rpt_bottom" style="font-weight:bold">
            <td colspan="4" align="right">Sub Total</td>
            <td align="right"></td>
            <td></td>
            <td></td>
            <td align="right"><? echo number_format(($subtotalDznAmount),4);?></td>
            <td align="right"><? echo number_format(($subtotalAmount),4);?></td>
            </tr>
			
			<?
				$subtotalDznAmount=0;$subtotalAmount=0;

		}
		?>
            <tr class="rpt_bottom" style="font-weight:bold">
            <td colspan="4" align="center">Grand Total</td>
            <td align="right"></td>
            <td></td>
            <td></td>
            <td align="right"><? echo number_format(($GrandtotalDznAmount),4);?></td>
            <td align="right"><? echo number_format(($GrandtotalAmount),4);?></td>
            </tr>
            </table>
            </div>
		<?
		if($zero_value==1){
			echo $woven_fab;
		}
		else{
			if($row[csf("avg_cons")]>0){
				echo $woven_fab;
			}
			else{
				echo "";
			}
		}

		//Conversion
	$totConv=0;
	$ConvData=array();
	$conv_data=array();
	$conv_amount_arr=$conversion->getAmountArray_by_conversionid();
	$conv_qty_arr=$conversion->getQtyArray_by_conversionid();
	$sql_conv = "select a.id as con_id, a.fabric_description as fabric_description_id, a.job_no, a.cons_process, a.req_qnty,a.avg_req_qnty, a.charge_unit, a.amount, a.status_active,b.body_part_id,b.fab_nature_id,b.color_type_id,b.fabric_description,b.uom  from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id and b.status_active=1 and b.is_deleted=0 where a.job_no=".$txt_job_no."  and a.id>0 and a.is_deleted =0 and a.status_active=1 ";
	$data_arr_conv=sql_select($sql_conv);
	foreach($data_arr_conv as $conv_row)
	{
		$convamount=array_sum($conv_amount_arr[$conv_row[csf('con_id')]]);
		$convQty=array_sum($conv_qty_arr[$conv_row[csf('con_id')]]);
		$conv_data[cons_process][$conv_row[csf('con_id')]]=$conv_row[csf('cons_process')];
		$conv_data[amount][$conv_row[csf('con_id')]]=$conv_row[csf('amount')];
		$conv_data[amount_job][$conv_row[csf('con_id')]]+=$convamount;
		$summary_data[conver_cost_job]+=$convamount;
	
		$index=$conv_row[csf('con_id')];
		$ConvData[$index]['item_descrition']=$body_part[$conv_row[csf("body_part_id")]].", ".$color_type[$conv_row[csf("color_type_id")]].", ".$conv_row[csf("fabric_description")];
		$ConvData[$index]['cons_process']=$conv_row[csf("cons_process")];
		$ConvData[$index]['req_qnty']=$conv_row[csf("req_qnty")];
		$ConvData[$index]['uom']=$conv_row[csf("uom")];
		$ConvData[$index]['charge_unit']=$conv_row[csf("charge_unit")];
		$ConvData[$index]['amount']=$conv_row[csf("amount")];
		$ConvData[$index]['tot_req_qnty']=$convQty;
		$ConvData[$index]['tot_amount']=$convamount;
		$totConv+=$conv_row[csf("req_qnty")];
	}
	//Conversion End

	if($zero_value==1)
	{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($ConvData)+3; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Total Cons</td>
                    <td width="100">Uom</td>
                    <td width="100">Rate (USD)</td>
                    <td width="150">Amount (USD)/<? echo $costing_for; ?></td>
                    <td width="100">Tot. Amount (USD)</td>
                </tr>
				<?
                $TotalDznAmount =0; $TotalAmount =0;
                foreach( $ConvData as $index=>$row )
                {
                    
					$cons_dzn=($row["tot_req_qnty"]/$poPlunCutQtyUom)*$order_price_per_dzn;
					if($row["tot_amount"]) $amount_dzn=($row["tot_amount"]/$row["tot_req_qnty"])*$order_price_per_dzn;
					else $amount_dzn=0;
					?>
                    <tr>
                        <td align="left"><? echo $row['item_descrition']; ?></td>
                        <td align="left"><? echo $conversion_cost_head_array[$row["cons_process"]]; ?></td>
                        <td align="right"><? echo fn_number_format($cons_dzn,4); ?></td>
                        <td align="right"><? echo fn_number_format($row["tot_req_qnty"],4); ?></td>
                        <td align=""><? echo $unit_of_measurement[$row["uom"]]; ?></td>
                        <td align="right"><? echo fn_number_format($row["tot_amount"]/$row["tot_req_qnty"],4); ?></td>
                        <td align="right"><? echo fn_number_format($amount_dzn,4); ?></td>
                        <td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
                    </tr>
                    <?
                     $TotalDznAmount += $amount_dzn;
                     $TotalAmount += $row["tot_amount"];
    
                     $GrandTotalFabricDznAmount+=$amount_dzn;
                     $GrandTotalFabricAmount+=$row["tot_amount"];
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td  align="left" colspan="6">Total</td>
                    <td align="right"><? echo fn_number_format($TotalDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($TotalAmount,4); ?></td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="6">Total Fabric Cost</td>
                    <td align="right"><? echo fn_number_format($GrandtotalDznAmount + $GrandTotalFabricDznAmount,4); ?></td>
                    <td align="right"><? echo fn_number_format($GrandtotalAmount+ $GrandTotalFabricAmount,4); ?></td>
                </tr>
            </table>
        </div>
        <?
	}
	else
	{
		if($totConv>0)
		{
			?>
			 <div style="margin-top:15px">
                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                    <tr style="font-weight:bold">
                        <td width="80" rowspan="<? echo count($ConvData)+3; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                        <td width="350">Particulars</td>
                        <td width="100">Process</td>
                        <td width="100">Cons/<? echo $costing_for; ?></td>
                        <td width="100">Total Cons</td>
                         <td width="100">Uom</td>
                        <td width="100">Rate (USD)</td>
                        <td width="150">Amount (USD)/<? echo $costing_for; ?></td>
                         <td width="100">Tot. Amount (USD)</td>
                    </tr>
					<?
				    $TotalDznAmount =0; $TotalAmount =0;
					foreach( $ConvData as $index=>$row)
					{
							$cons_dzn=($row["tot_req_qnty"]/$poPlunCutQtyUom)*$order_price_per_dzn;
							if($row["tot_amount"]) $amount_dzn=($row["tot_amount"]/$row["tot_req_qnty"])*$order_price_per_dzn;
							else $amount_dzn=0;
					
						?>
						<tr>
							<td align="left"><? echo $row['item_descrition']; ?></td>
							<td align="left"><? echo $conversion_cost_head_array[$row["cons_process"]]; ?></td>
							<td align="right"><? echo fn_number_format($cons_dzn,4); ?></td>
							<td align="right"><? echo fn_number_format($row["tot_req_qnty"],4); ?></td>
							<td align=""><? echo $unit_of_measurement[$row["uom"]]; ?></td>
							<td align="right"><? echo fn_number_format($row["tot_amount"]/$row["tot_req_qnty"],4); ?></td>
							<td align="right"><? echo fn_number_format($amount_dzn,4); ?></td>
							<td align="right"><? echo fn_number_format($row["tot_amount"],4); ?></td>
						</tr>
						<?
						 $TotalDznAmount += $amount_dzn;
						 $TotalAmount += $row["tot_amount"];
		
						 $GrandTotalFabricDznAmount+=$amount_dzn;
						 $GrandTotalFabricAmount+=$row["tot_amount"];
					}
					?>
                    <tr class="rpt_bottom" style="font-weight:bold">
                        <td align="left" colspan="6">Total</td>
                        <td align="right"><? echo  fn_number_format($TotalDznAmount,4); ?></td>
                        <td align="right"><? echo  fn_number_format($TotalAmount,4); ?></td>
                    </tr>
                    <tr class="rpt_bottom" style="font-weight:bold">
                        <td align="left" colspan="6">Total Fabric Cost</td>
                        <td align="right"><? echo fn_number_format($GrandtotalDznAmount + $GrandTotalFabricDznAmount,4); ?></td>
                        <td align="right"><? echo fn_number_format($GrandtotalAmount + $GrandTotalFabricAmount,4); ?></td>
                    </tr>
                </table>
			  </div>
			  <?
		}
		else echo "";
	}
		//end 	All Fabric Cost part report-------------------------------------------
	//start	Trims Cost part report here -------------------------------------------
	$trim_group=return_library_array( "select item_name,id from  lib_item_group", "id", "item_name"  );
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="150">Nominated Supp</td>
                    <td width="150">Remarks</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/<? echo $costing_for ?></td>
                    <td width="100">Tot. Cons</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                </tr>
            <?
            $TotalDznAmountTrim=0;
			$TotalAmountTrim=0;	
			/*echo '<pre>';
			print_r($TrimData); die;*/		
            foreach( $TrimData as $index=>$row )
            {

			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row["trim_group"]]; ?></td>
                    <td align="left"><? echo $row["description"]; ?></td>
                    <td align="left"><? echo $row["brand_sup_ref"]; ?></td>
                    <td align="left">
                    <? 
	                	 $exnominated_supp=explode(",",$row['nominated_supp']);
	                	 $nominated_supp_str ='';
						 foreach($exnominated_supp as $supp)
						 {
							if($nominated_supp_str=="") $nominated_supp_str=$supplier_name_arr[$supp]; else $nominated_supp_str.=','.$supplier_name_arr[$supp];
						 }
                    	//echo $supplier_name_arr[$row["nominated_supp"]]; 
						 echo $nominated_supp_str;
						 
						 $cons_dzn_gmts=($row["tot_cons"]/$poQtyUom)*$order_price_per_dzn;
						if($row["tot_amount"]) $amount_dzn=($row["tot_amount"]/$row["tot_cons"])*$order_price_per_dzn;
						else $amount_dzn=0;
                    ?>
                    	
                    </td>
                     <td align="left"><? echo $row["remark"]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row["cons_uom"]]; ?></td>
                    <td align="right"><? echo number_format($cons_dzn_gmts,4); ?></td>
                     <td align="right"><? echo number_format($row["tot_cons"],4); ?></td>
                    <td align="right"><? if($row["tot_amount"])  echo number_format($row["tot_amount"]/$row["tot_cons"],4);else echo " "; ?></td>
                    <td align="right"><? echo number_format($amount_dzn,4); ?></td>
                    <td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmountTrim += $amount_dzn;
				 $TotalAmountTrim += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="9" align="left">Total</td>
                    <td align="right"><? echo number_format($TotalDznAmountTrim,4); ?></td>
                    <td align="right"><? echo number_format($TotalAmountTrim,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($totTrim>0)
		{
	?>
    <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="150">Nominated Supp</td>
                     <td width="150">Remarks</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/<? echo $costing_for ?></td>
                    <td width="100">Tot. Cons</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                     <td width="100">Tot. Amount</td>
                </tr>
            <?
            $TotalDznAmountTrim=0;
			$TotalAmountTrim=0;
            foreach( $TrimData as $index=>$row)
            {

			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row["trim_group"]]; ?></td>
                    <td align="left"><? echo $row["description"]; ?></td>
                    <td align="left"><? echo $row["brand_sup_ref"]; ?></td>
                    <td align="left">
                    <? 
                    	$exnominated_supp=explode(",",$row['nominated_supp']);
                    	$nominated_supp_str='';
						 foreach($exnominated_supp as $supp)
						 {
							if($nominated_supp_str=="") $nominated_supp_str=$supplier_name_arr[$supp]; else $nominated_supp_str.=','.$supplier_name_arr[$supp];
						 }
						 echo $nominated_supp_str;
						 
						  $cons_dzn_gmts=($row["tot_cons"]/$poQtyUom)*$order_price_per_dzn;
						if($row["tot_amount"]) $amount_dzn=($row["tot_amount"]/$row["tot_cons"])*$order_price_per_dzn;
						else $amount_dzn=0;
                    ?>
                    	
                    </td>
                     <td align="left"><? echo $row["remark"]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row["cons_uom"]]; ?></td>
                    <td align="right"><? echo number_format($cons_dzn_gmts,4); ?></td>
                    <td align="right"><? echo number_format($row["tot_cons"],4); ?></td>
                    <td align="right"><? if($row["tot_amount"]) echo number_format($row["tot_amount"]/$row["tot_cons"],4);else echo " "; ?></td>
                    <td align="right"><? echo number_format($amount_dzn,4); ?></td>
                    <td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmountTrim += $amount_dzn;
				 $TotalAmountTrim += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="8" align="left">Total</td>
                    <td align="right"><? echo number_format($TotalDznAmountTrim,4); ?></td>
                    <td align="right"><? echo number_format($TotalAmountTrim,4); ?></td>
                </tr>
            </table>
      </div>
	<?
		}
		else
		{
		   echo "";
		}
	}
	 //End Trims Cost Part report here -------------------------------------------
	 /*echo '<pre>';
	print_r($TrimData); die;*/
	$nominated_supp_arr = array();
	foreach ($TrimData as $value) {
		$exnominated_supp=explode(",",$row['nominated_supp']);
		foreach($exnominated_supp as $supp)
		{
			$nominated_supp_arr[$supp][] = $value['tot_amount'];
		}
		
	}
	// echo '<pre>';
	// print_r($nominated_supp_arr); 
	 //End Trims Cost Part report here -------------------------------------------
	 // Supplier wise amount
	 ?>
	 	<div style="margin-top:15px">
	 		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
	 			<label><b>Supplier Wise Amount</b></label>
	 			<tr>
	 				<th width="150">Supplier Name</th>
	 				<th width="150">Total Amount(USD)</th>
					 <th width="150">PO Value (%)</th>
	 			</tr>
	 			<?	$supplier_wise_amount = 0;
			
	 				foreach ($supplier_wise_amount_arr as $supplier_id => $value) {
	 				 
	 				 	$supplier_wise_amount +=$value['tot_amount'];
						$supplier_wise_po_value +=($value['tot_amount']/$po_total_amount)*100;
	 				  ?>
	 					<tr>
	 						<td><? echo $supplier_name_arr[$supplier_id]; ?></td>
	 						<td><? echo number_format($value['tot_amount'],4);?></td>
							 <td><? echo number_format(($value['tot_amount']/$po_total_amount)*100,4);?></td>
	 					</tr>
	 				<? }
	 			 ?>
	 			 <tr>
	 			 	<th>Total</th>
	 			 	<th><? echo number_format($supplier_wise_amount,4);?></th>
					<th><? echo number_format($supplier_wise_po_value,4);?></th>
	 			 </tr>
	 		</table>
	 	</div>
	 <?
	 // End supplier wise amount


	 //start	Embellishment Details part report here -------------------------------------------
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:1000px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
					<td width="150">Supplier Name</td>
                    <td width="150">Cons/<? echo $costing_for ?></td>
                    <td width="150">Tot.Cons</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
            <?
            $TotalDznAmountEmb=0;
		    $TotalAmountEmb =0;
			// print_r($EmbData);
            foreach( $EmbData as $index=>$row )
            {
				$em_type ='';
 				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row["emb_name"]==1)$em_type = $emblishment_print_type[$row["emb_type"]];
				else if($row["emb_name"]==2)$em_type = $emblishment_embroy_type[$row["emb_type"]];
				else if($row["emb_name"]==3)$em_type = $emblishment_wash_type[$row["emb_type"]];
				else if($row["emb_name"]==4)$em_type = $emblishment_spwork_type[$row["emb_type"]];
				else if($row["emb_name"]==5)$em_type = $emblishment_gmts_type[$row["emb_type"]];
				else if($row["emb_name"]==99)$em_type = $emblishment_other_type_arr[$row["emb_type"]];

				$cons_dzn_gmts=($row["tot_cons"]/$poQtyUom)*$order_price_per_dzn;
				if($row["tot_amount"]) $amount_dzn=($row["tot_amount"]/$row["tot_cons"])*$order_price_per_dzn;
				else $amount_dzn=0;
						
			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row["emb_name"]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
					<td align="left"><? echo $supplier_arr[$row["supplier_id"]]; ?></td>
                    <td align="right"><? echo number_format($cons_dzn_gmts,4); ?></td>
                    <td align="right"><? echo number_format($row["tot_cons"],4); ?></td>
                    <td align="right"><? if($row["tot_amount"]) echo number_format($row["tot_amount"]/$row["tot_cons"],4);else echo " "; ?></td>
                    <td align="right"><? echo number_format($amount_dzn,4); ?></td>
                    <td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmountEmb += $amount_dzn;
				 $TotalAmountEmb += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="6" align="left">Total</td>
                    <td align="right"><? echo number_format($TotalDznAmountEmb,4); ?></td>
                    <td align="right"><? echo number_format($TotalAmountEmb,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($totEmb>0)
		{
	?>
     <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:1000px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
					<td width="150">Supplier Name</td>
                    <td width="150">Cons/<? echo $costing_for ?></td>
                    <td width="150">Tot.Cons</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
            <?
            $TotalDznAmountEmb=0;
		    $TotalAmountEmb =0;
            foreach( $EmbData as $index=>$row  )
            {
				$em_type ='';
 				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row["emb_name"]==1)$em_type = $emblishment_print_type[$row["emb_type"]];
				else if($row["emb_name"]==2)$em_type = $emblishment_embroy_type[$row["emb_type"]];
				else if($row["emb_name"]==3)$em_type = $emblishment_wash_type[$row["emb_type"]];
				else if($row["emb_name"]==4)$em_type = $emblishment_spwork_type[$row["emb_type"]];
				else if($row["emb_name"]==5)$em_type = $emblishment_gmts_type[$row["emb_type"]];
				else if($row["emb_name"]==99)$em_type = $emblishment_other_type_arr[$row["emb_type"]];

				$cons_dzn_gmts=($row["tot_cons"]/$poQtyUom)*$order_price_per_dzn;
				if($row["tot_amount"]) $amount_dzn=($row["tot_amount"]/$row["tot_cons"])*$order_price_per_dzn;
				else $amount_dzn=0;
			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row["emb_name"]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
					<td align="left"><? echo $supplier_arr[$row["supplier_id"]]; ?></td>
                    <td align="right"><? echo number_format($cons_dzn_gmts,4); ?></td>
                    <td align="right"><? echo number_format($row["tot_cons"],4); ?></td>
                    <td align="right"><? if($row["tot_amount"]) echo number_format($row["tot_amount"]/$row["tot_cons"],4); else echo " ";?></td>
                    <td align="right"><? echo number_format($amount_dzn,4); ?></td>
                    <td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmountEmb += $amount_dzn;
				 $TotalAmountEmb += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="6" align="left">Total</td>
                    <td align="right"><? echo number_format($TotalDznAmountEmb,4); ?></td>
                    <td align="right"><? echo number_format($TotalAmountEmb,4); ?></td>
                </tr>
            </table>
      </div>
    <?

		}
		else
		{
			echo "";
		}
	}
	 //End Embellishment Details Part report here -------------------------------------------



	 //start	Commercial Cost part report here -------------------------------------------
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate In %</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot.Amount</td>
                 </tr>
            <?
           $TotalDznAountComr=0;
		   $TotalAountComr =0;
            foreach( $CommarData as $index=>$row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row["item_id"]]; ?></td>
                    <td align="right"><? echo number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAountComr += $row["amount"];
				 $TotalAountComr += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2" align="left">Total</td>
                    <td align="right"><? echo number_format($TotalDznAountComr,4); ?></td>
                    <td align="right"><? echo number_format($TotalAountComr,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($totCommar>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot.Amount</td>
                 </tr>
            <?
           $TotalDznAountComr=0;
		   $TotalAountComr =0;
            foreach( $CommarData as $index=>$row  )
            {
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row["item_id"]]; ?></td>
                    <td align="right"><? echo number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAountComr += $row["amount"];
				 $TotalAountComr += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2" align="left">Total</td>
                     <td align="right"><? echo number_format($TotalDznAountComr,4); ?></td>
                    <td align="right"><? echo number_format($TotalAountComr,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
			echo "";
		}

	}
	 //End Commercial Cost Part report here -------------------------------------------


  	//start	Commission Cost part report here -------------------------------------------

	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
            <?
            $TotalDznAountCommi = 0;
		    $TotalAountCommi = 0;
            foreach( $CommiData as $index=>$row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row["particulars_id"]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row["commission_base_id"]]; ?></td>
                    <td align="right"><? echo number_format($row["commision_rate"],4); ?></td>
                    <td align="right"><? echo number_format($row["commission_amount"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_commission_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAountCommi += $row["commission_amount"];
				 $TotalAountCommi += $row["tot_commission_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3" align="left">Total</td>
                    <td align="right"><? echo number_format($TotalDznAountCommi,4); ?></td>
                    <td align="right"><? echo number_format($TotalAountCommi,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($totCommi>0)
		{
			$TotalDznAountCommi = 0;
		    $TotalAountCommi = 0;
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
            <?
            foreach( $CommiData as $index=>$row )
            {
  			?>
                <tr>
                   <td align="left"><? echo $commission_particulars[$row["particulars_id"]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row["commission_base_id"]]; ?></td>
                    <td align="right"><? echo number_format($row["commision_rate"],4); ?></td>
                    <td align="right"><? echo number_format($row["commission_amount"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_commission_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAountCommi += $row["commission_amount"];
				 $TotalAountCommi += $row["tot_commission_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3" align="left">Total</td>
                    <td align="right"><? echo number_format($TotalDznAountCommi,4); ?></td>
                    <td align="right"><? echo number_format($TotalAountCommi,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
		   echo "";
		}

	}
	 //End Commission Cost Part report here -------------------------------------------


	//start	Other Components part report here -------------------------------------------
			$net_fob_value_dzn=$summary_data[price_dzn]-$summary_data[commission];
			$interest_expense_dzn=$net_fob_value_dzn*$financial_para['interest_expense']/100;
			$income_tax_dzn=$net_fob_value_dzn*$financial_para['income_tax']/100;

			$net_fob_value_tot=$summary_data[price_dzn_job]-$TotalAountCommi;
			$interest_expense_tot=$net_fob_value_tot*$financial_para['interest_expense']/100;
			$income_tax_tot=$net_fob_value_tot*$financial_para['income_tax']/100;

			$total_other_components += $summary_data[lab_test_job]+$summary_data[inspection_job]+$summary_data[freight_job]+$summary_data[currier_pre_cost_job]+$summary_data[certificate_pre_cost_job]+$summary_data[common_oh_job]+$summary_data[depr_amor_pre_cost_job]+$interest_expense_tot+$income_tax_tot+$TotalAountCommi+$TotalAountComr;
			$dzn_other_components += $summary_data[lab_test]+$summary_data[inspection]+$summary_data[freight]+$summary_data[currier_pre_cost]+$summary_data[certificate_pre_cost]+$summary_data[common_oh]+$summary_data[depr_amor_pre_cost]+$interest_expense_dzn+$income_tax_dzn+$summary_data[commission]+$summary_data[comm_cost];
            ?>
      <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>CM Cost - IE</b></label>
                <tr style="font-weight:bold">
                    <td width="100">Amount /<? echo $costing_for ?></td>
                    <td width="100">Amount</td>
                 </tr>
                 <tr>
                    <td width="100" align="right"><? echo number_format($summary_data[cm_cost],4);  ?></td>
                    <td width="100" align="right"><? echo number_format($summary_data[cm_cost_job],4);  ?></td>
                 </tr>
                 </table>
      </div>


        <div style="margin-top:15px">
         <table>
         <tr>
         <td>
          
            </td>
            <td valign="top" rowspan="2">

            <?
     	 // image show here  -------------------------------------------
		 $sql = "select id,master_tble_id,image_location
				from common_photo_library
				where master_tble_id=$txt_job_no limit 1";
		$data_array=sql_select($sql);
 	  ?>
          <div style="margin:15px 5px;float:right;width:500px" >
          	<? foreach($data_array AS $inf){ ?>
                <img  src='../../<? echo $inf[csf("image_location")]; ?>' height='400' width='300' />
            <?  } ?>
          </div>
          </td>
          </tr>
          <tr>
          <td>
			<?
            $total_summary_amount = $GrandtotalAmount+$TotalAmountTrim+$TotalAmountEmb+$summary_data[cm_cost_job]+$total_other_components;
            ?>
	 <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:450px;text-align:center" rules="all">
            <label><b>Summary</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Cost Summary</td>
                    <td width="100">Cost/<? echo $costing_for ?></td>
                    <td width="100">Total</td>
					<td width="100">According to PO Value (%)</td>
                 </tr>
                <tr>
                    <td align="left"> Fabric Cost</td>
                    <td align="right"><? echo number_format($GrandtotalDznAmount,4); ?></td>
                    <td align="right"><? echo number_format($GrandtotalAmount,4); ?></td>
					<td align="right"><? echo number_format(($GrandtotalAmount/$po_total_amount)*100,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Trims</td>
                    <td align="right"><? echo number_format($TotalDznAmountTrim,4); ?></td>
                    <td align="right"><? echo number_format($TotalAmountTrim,4); ?></td>
					<td align="right"><? echo number_format(($TotalAmountTrim/$po_total_amount)*100,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Embellishment</td>
                    <td align="right"><? echo number_format($TotalDznAmountEmb,4); ?></td>
                    <td align="right"><? echo number_format($TotalAmountEmb,4); ?></td>
					<td align="right"><? echo number_format(($TotalAmountEmb/$po_total_amount)*100,4); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo number_format($summary_data[cm_cost],4); ?></td>
                    <td align="right"><? echo number_format($summary_data[cm_cost_job],4); ?></td>
					<td align="right"><? echo number_format(($summary_data[cm_cost_job]/$po_total_amount)*100,4); ?></td>
                </tr>
                <tr>
                    <td align="left"s>Lab Test </td>
                    <td align="right"><? echo number_format($summary_data[lab_test_job],4); ?></td>
					<td align="right"><? echo number_format($summary_data[lab_test_job],4); ?></td>
					<td align="right"><? echo number_format(($summary_data[lab_test_job]/$po_total_amount)*100,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo number_format($summary_data[inspection_job],4); ?></td>
					<td align="right"><? echo number_format($summary_data[inspection_job],4); ?></td>
					<td align="right"><? echo number_format(($summary_data[inspection_job]/$po_total_amount)*100,4); ?></td>
                </tr>

                <tr>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo number_format($summary_data[freight_job],4); ?></td>
					<td align="right"><? echo number_format($summary_data[freight_job],4); ?></td>
					<td align="right"><? echo number_format(($summary_data[freight_job]/$po_total_amount)*100,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Currier Cost </td>
                    <td align="right"><? echo number_format($summary_data[currier_pre_cost_job],4); ?></td>
					<td align="right"><? echo number_format($summary_data[currier_pre_cost_job],4); ?></td>
					<td align="right"><? echo number_format(($summary_data[currier_pre_cost_job]/$po_total_amount)*100,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Certificate Cost </td>
                    <td align="right"><? echo number_format($summary_data[certificate_pre_cost_job],4); ?></td>
					<td align="right"><? echo number_format($summary_data[certificate_pre_cost_job],4); ?></td>
					<td align="right"><? echo number_format(($summary_data[certificate_pre_cost_job]/$po_total_amount)*100,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Commercial Cost </td>
                    <td align="right"><? echo number_format($TotalAountComr,4); ?></td>
					<td align="right"><? echo number_format($TotalAountComr,4); ?></td>
					<td align="right"><? echo number_format(($TotalAountComr/$po_total_amount)*100,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Operating Expenses</td>
                    <td align="right"><? echo number_format($summary_data[common_oh_job],4); ?></td>
					<td align="right"><? echo number_format($summary_data[common_oh_job],4); ?></td>
					<td align="right"><? echo number_format(($summary_data[common_oh_job]/$po_total_amount)*100,4); ?></td>
                </tr>
                  <tr>
                    <td align="left">Commission </td>
                    <td align="right"><? echo number_format($TotalAountCommi,4); ?></td>
					<td align="right"><? echo number_format($TotalAountCommi,4); ?></td>
					<td align="right"><? echo number_format(($TotalAountCommi/$po_total_amount)*100,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Depreciation & Amortization </td>
                    <td align="right"><? echo number_format($summary_data[depr_amor_pre_cost_job],4); ?></td>
					<td align="right"><? echo number_format($summary_data[depr_amor_pre_cost_job],4); ?></td>
					<td align="right"><? echo number_format(($summary_data[depr_amor_pre_cost_job]/$po_total_amount)*100,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Interest</td>
                    <td align="right"><? echo number_format($interest_expense_tot,4); ?></td>
					<td align="right"><? echo number_format($interest_expense_tot,4); ?></td>
						<td align="right"><? echo number_format(($interest_expense_tot/$po_total_amount)*100,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Income Tax</td>
                    <td align="right"><? echo number_format($income_tax_tot,4); ?></td>
					<td align="right"><? echo number_format($income_tax_tot,4); ?></td>
					<td align="right"><? echo number_format(($income_tax_tot/$po_total_amount)*100,4); ?></td>
                </tr>
              
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="right" colspan="2">Total</td>
                    <td align="right"><? echo number_format($total_summary_amount,4); ?></td>
					<td align="right"><? echo number_format(($total_summary_amount/$po_total_amount)*100,4); ?></td>
                </tr>
				<tr class="rpt_bottom" style="font-weight:bold">
                    <td align="right" colspan="2">Variance</td>
                    <td align="right"><? echo number_format($po_total_amount-$total_summary_amount,4); ?></td>
					<td align="right"><? echo number_format((100-($total_summary_amount/$po_total_amount)*100),4); ?></td>
                </tr>
            </table>
			<!-- $po_total_amount; -->
          </td>
          </tr>
          </table>
      </div>
       <br/>
 	<?=signature_table(109, $cbo_company_name, "850px");?>
	</div>
	 <?
	 exit();
}

if($action == "bom_pcs_woven6") //BOM PCS3 Btn 22
{
   	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if($txt_job_no==""){
		$job_no='';
	}else{
		$job_no=" and a.job_no=".$txt_job_no."";
	}

	if($cbo_company_name=="") {
		$company_name='';
	} else {
		 $company_name=" and a.company_name=".$cbo_company_name."";
	}

	if($cbo_buyer_name==""){
		 $cbo_buyer_name='';
	} else {
		$cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	}

	if($txt_style_ref==""){
		 $txt_style_ref='';
	} else {
		$txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	}

	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($db_type==0){
	   $costing_date=change_date_format($txt_costing_date, "yyyy-mm-dd", "-");
	}
	if($db_type==2){
		$costing_date=change_date_format($txt_costing_date, "yyyy-mm-dd", "-",1)	;
	}
	$txt_po_breack_down_id=str_replace("'",'',$txt_po_breack_down_id);
	if(str_replace("'",'',$txt_po_breack_down_id)==""){
		$txt_po_breack_down_id_cond='';
	}
	else{
		$txt_po_breack_down_id_cond=" and d.id in(".$txt_po_breack_down_id.")";
	}
    //if($txt_quotation_date=="") $txt_quotation_date=''; else $txt_quotation_date=" and a.quot_date ='".$txt_quotation_date."'";
	$imge_arr=return_library_array( "select master_tble_id,image_location from common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	

    $buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$season_name_arr=return_library_array( "select id, season_name from lib_buyer_season",'id','season_name');
	$color_library=return_library_array("select id,color_name from lib_color where status_active=1 and is_deleted=0","id","color_name");
	$brand_arr=return_library_array( "select id, brand_name from lib_buyer_brand where status_active=1 and is_deleted=0",'id','brand_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$merchantArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$group_gsm="listagg(b.gsm_weight ,',') within group (order by b.gsm_weight) AS gsm_weight";
	$gsm_weight_top=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and a.body_part_type=1","gsm_weight");
	$gsm_weight_bottom=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and a.body_part_type=20 ","gsm_weight");

	 $po_qty=0;
	 $po_plun_cut_qty=0;
	 $total_set_qnty=0;
	 $sql_po="select a.job_no,a.total_set_qnty,b.id,c.item_number_id,c.country_id,c.color_number_id,c.size_number_id,c.order_quantity ,c.plan_cut_qnty,a.brand_id  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst   and b.id=c.po_break_down_id  and a.job_no =".$txt_job_no." $poId_cond2  and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 order by b.id";
	$sql_po_data=sql_select($sql_po);
	foreach($sql_po_data as $sql_po_row){
		$po_qty+=$sql_po_row[csf('order_quantity')];
		$po_plun_cut_qty+=$sql_po_row[csf('plan_cut_qnty')];
		$total_set_qnty=$sql_po_row[csf('total_set_qnty')];
		$po_id_arr[$sql_po_row[csf('id')]]=$sql_po_row[csf('id')];
	}
	$po_id_str= implode( ",",$po_id_arr);
	
	$sales_contract_sql=sql_select("SELECT a.contract_no,b.wo_po_break_down_id from com_sales_contract a join com_sales_contract_order_info b on a.id=b.com_sales_contract_id where a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.wo_po_break_down_id in ($po_id_str) group by a.contract_no, b.wo_po_break_down_id");
	$sales_contract_arr=array();
	if(count($sales_contract_sql)>0)
	{
		foreach ($sales_contract_sql as $key => $row) {
			$sales_contract_arr[$row[csf('contract_no')]]=$row[csf('contract_no')];
		}
	}

	$export_lc_sql=sql_select("SELECT a.export_lc_no,b.wo_po_break_down_id from com_export_lc a join com_export_lc_order_info b on a.id=b.com_export_lc_id where a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.wo_po_break_down_id in ($po_id_str) group by a.export_lc_no,b.wo_po_break_down_id");
	$export_lc_arr=array();
	if(count($export_lc_sql)>0)
	{
		foreach ($export_lc_sql as $key => $row) {
			$export_lc_arr[$row[csf('wo_po_break_down_id')]]=$row[csf('export_lc_no')];
		}
	}
	$sc_lc_no="";
	if(count($sales_contract_arr)>0)
	{
		$sc_lc_no=implode(",", $sales_contract_arr);
	}
	if(count($export_lc_arr)>0)
	{
		$sc_lc_no=implode(",", $export_lc_arr);
	}

	//echo $po_qty;

	$gmtsitem_ratio_array=array();
	$gmtsitem_ratio_sql=sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no =".$txt_job_no."");// where job_no ='FAL-14-01157'
	foreach($gmtsitem_ratio_sql as $gmtsitem_ratio_sql_row){
	$gmtsitem_ratio_array[$gmtsitem_ratio_sql_row[csf('job_no')]][$gmtsitem_ratio_sql_row[csf('gmts_item_id')]]=$gmtsitem_ratio_sql_row[csf('set_item_ratio')];
	}
	$costing_per_arr=return_library_array( "select job_no,costing_per from wo_pre_cost_mst where job_no =".$txt_job_no."", "job_no", "costing_per");// where job_no ='FAL-14-01157'

	if($db_type==0){
		$sqlcpm=sql_select("select cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and '$costing_date' between applying_period_date and applying_period_to_date  and status_active=1 and is_deleted=0 LIMIT 1");
	}
	if($db_type==2){
		 $sqlcpm=sql_select("select cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and '$costing_date' between applying_period_date and applying_period_to_date and status_active=1 and is_deleted=0");

	}

	$cpm='';
	foreach($sqlcpm as $sqlcpmrow){
		$cpm=$sqlcpmrow[csf('cost_per_minute')];
	}

	$fab_knit_req_kg_avg=0;
	$fab_woven_req_yds_avg=0;
	$sql = "SELECT a.job_no, a.company_name, a.buyer_name,a.style_description,a.product_dept,a.season_buyer_wise,a.season_year, a.style_ref_no,a.brand_id, a.quotation_id, a.gmts_item_id,a.body_wash_color, a.order_uom, a.job_quantity, a.avg_unit_price,a.dealing_marchant, b.costing_per, b.budget_minute,b.costing_date, b.sew_smv, b.cut_smv, b.sew_effi_percent, b.cut_effi_percent, b.approved, d.margin_pcs_set, c.fab_knit_req_kg, c.fab_knit_fin_req_kg, c.fab_woven_req_yds, c.fab_woven_fin_req_yds, c.fab_yarn_req_kg, d.margin_pcs_bom,d.cm_cost, d.cost_pcs_set,b.exchange_rate,d.wash_cost,d.embel_cost,d.fabric_cost_percent,d.trims_cost_percent,d.wash_cost_percent,d.embel_cost_percent,d.fabric_cost, d.trims_cost, d.embel_cost,d.margin_dzn, d.wash_cost, d.comm_cost, d.commission, d.lab_test,d.inspection, d.cm_cost, d.freight,d.currier_pre_cost, d.certificate_pre_cost,d.common_oh, d.total_cost, d.interest_cost, d.incometax_cost, d.incometax_percent, d.deffdlc_cost, d.deffdlc_percent from wo_po_details_master a join wo_pre_cost_mst b on a.id=b.job_id join wo_pre_cost_dtls d on a.id=d.job_id left join wo_pre_cost_sum_dtls c on a.id=c.job_id and c.status_active=1 and c.is_deleted=0 where b.status_active=1 and b.is_deleted=0  and a.status_active=1 and b.status_active=1 and b.is_deleted=0 $job_no $company_name $cbo_buyer_name $txt_style_ref order by a.job_no";
	//echo __LINE__.$sql; die; 
	$data_array=sql_select($sql);
	foreach( $data_array as $row )
	{
		//$cm_cost_dzn =$row[csf("cm_cost")];
		$cm_cost_dzn =($row[csf("avg_unit_price")])-($row[csf("fabric_cost")]+$row[csf("trims_cost")]+$row[csf("embel_cost")]+$row[csf("wash_cost")]);
		$margin_dzn =$row[csf("margin_dzn")];
		$other_cost=$row[csf("fabric_cost")]+$row[csf("embel_cost")]+$row[csf("embel_cost")]+$row[csf("wash_cost")]+$row[csf("comm_cost")]+$row[csf("commission")]+$row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("freight")]+$row[csf("currier_pre_cost")]+$row[csf("certificate_pre_cost")]+$row[csf("common_oh")]+$row[csf("interest_cost")];
		$btb_cost=(($row[csf("fabric_cost")]+$row[csf("embel_cost")]+$row[csf("trims_cost")]+$row[csf("wash_cost")])/$row[csf("avg_unit_price")])*100;

		$exchange_rate =$row[csf("exchange_rate")];
		$approved_id=$row[csf("approved")];
		$dealing_marchant=$row[csf("dealing_marchant")];
		$wash_cost =$row[csf("job_quantity")]*$row[csf("wash_cost")];
		$embl_cost =$row[csf("job_quantity")]*$row[csf("embel_cost")];

		$fabric_cost_percent =$row[csf("fabric_cost_percent")];
		$trims_cost_percent =$row[csf("trims_cost_percent")];
		$wash_cost_percent =$row[csf("wash_cost_percent")];
		$embel_cost_percent =$row[csf("embel_cost_percent")];
		
	}	
	$quotation_id=return_field_value("quotation_id", "wo_po_details_master", "job_no=$txt_job_no");
	$field_array_item_tot="select id, mst_id, item_id, fabric_cost, sp_operation_cost, wash_cost, accessories_cost, cpm, smv, efficiency, cm_cost, frieght_cost, courier_cost, lab_test_cost, miscellaneous_cost, other_cost, commission_cost, fob_pcs, rmg_ratio, commercial_cost, inspection_cost, lc_cost, inserted_by, insert_date from qc_item_cost_summary where mst_id='$quotation_id'  and status_active=1 and is_deleted=0";
	$buyer_data_array=sql_select($field_array_item_tot);
	foreach( $buyer_data_array as $row )
	{
		
		$smv_buyer =$row[csf("smv")];
		$cm_buyer =$row[csf("cm_cost")];
		$efficiency_buyer =$row[csf("efficiency")];
		$fob_pcs_buyer =$row[csf("fob_pcs")];
		$tot_cost_buyer =$row[csf("fabric_cost")]+$row[csf("sp_operation_cost")]+$row[csf("wash_cost")]+$row[csf("accessories_cost")];
		$btb_cost_buyer =($tot_cost_buyer/$fob_pcs_buyer)*100;
		$cm_cost_buyer =$fob_pcs_buyer-$tot_cost_buyer;
	}

	
	$condition= new condition();
	if(str_replace("'","",$txt_job_no) !=''){
		$condition->job_no("=$txt_job_no");
	}
	$txt_po_breack_down_id=str_replace("'",'',$txt_po_breack_down_id);
	if(str_replace("'",'',$txt_po_breack_down_id) !=""){
		$condition->po_id("in($txt_po_breack_down_id)");
	}

	$condition->init();
	$fabric= new fabric($condition);
	$trim= new trims($condition);
	$emblishment= new emblishment($condition);
	$wash= new wash($condition);


	//Fabric =====================
	$fabric_qty=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$fabric_amount=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$sql_fabric = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description,uom, avg_cons,avg_cons_yarn, fabric_source,gsm_weight, rate, amount, avg_finish_cons, status_active from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_arr_fabric=sql_select($sql_fabric);
	$summary_data=array();
	foreach($data_arr_fabric as $fab_row)
	{
		$summary_data[fabric_cost][$fab_row[csf("id")]]=$fab_row[csf("amount")];
		$summary_data[fabric_cost_job]+=$fabric_amount['knit']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		$summary_data[fabric_cost_job]+=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
	}
	
	//start	Trims Cost part report here -------------------------------------------
		$sql_trim = "select id, job_no, trim_group,description,brand_sup_ref,remark, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,status_active,seq from wo_pre_cost_trim_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 order by seq";
		$data_array_trim=sql_select($sql_trim);
		$trim_amount_arr=$trim->getAmountArray_precostdtlsid();
		$trim_qty_arr=$trim->getQtyArray_by_precostdtlsid();
		$totTrim=0;
		$TrimData=array();
		foreach( $data_array_trim as $row_trim )
		{
			$trim_qty=$trim_qty_arr[$row_trim[csf("id")]];
			$trim_amount=$trim_amount_arr[$row_trim[csf("id")]];
			$summary_data[trims_cost_job]+=$trim_amount;
		}

	//Fabric End======================

	//emb start
	$emb_sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name in(1,2,4,5,99) and status_active=1 and is_deleted=0";
	$emb_data_array=sql_select($emb_sql);
	$emb_amount=$emblishment->getAmountArray_by_jobAndEmblishmentid();
	foreach( $emb_data_array as $row ){
	$embtotamount=$emb_amount[$row[csf("job_no")]][$row[csf("id")]];
	$summary_data[emb_cost_job]+=$embtotamount;
	}
	//emb end

	//Wash cost 
	$wash_sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name =3 and status_active=1 and is_deleted=0";
	$wash_data_array=sql_select($wash_sql);
	$wash_amt=$wash->getAmountArray_by_jobAndEmblishmentid();
	foreach( $wash_data_array as $row ){
	$washamt=$wash_amt[$row[csf("job_no")]][$row[csf("id")]];
	$summary_data[wash_cost_job]+=$washamt;
	}
	//End Wash cost Cost part report here -------------------------------------------
	 
	 
	$uom=""; $sew_smv=0; $cut_smv=0; $sew_effi_percent=0; $cut_effi_percent=0;
	foreach ($data_array as $row){
		$order_price_per_dzn=0;
		$order_job_qnty=0;
		$avg_unit_price=0;
		$sew_smv=$row[csf("sew_smv")];
	    $cut_smv=$row[csf("cut_smv")];
	    $sew_effi_percent=$row[csf("sew_effi_percent")];
	    $cut_effi_percent=$row[csf("cut_effi_percent")];
		$order_values = $row[csf("job_quantity")]*$row[csf("avg_unit_price")];
		$result =sql_select("select po_number,grouping,file_no,pub_shipment_date from wo_po_break_down where job_no_mst=$txt_job_no $poId_cond and status_active=1 and is_deleted=0 order by pub_shipment_date DESC");
		$job_in_orders = '';$pulich_ship_date='';$job_in_file = '';$job_in_ref = '';
		foreach ($result as $val){
			$job_in_orders .= $val[csf('po_number')].", ";
			$pulich_ship_date = $val[csf('pub_shipment_date')];
			$job_in_file .= $val[csf('file_no')].",";
			$job_in_ref .= $val[csf('grouping')].",";
		}
		$job_in_orders = substr(trim($job_in_orders),0,-1);
		$job_ref=array_unique(explode(",",rtrim($job_in_ref,", ")));
		$job_file=array_unique(explode(",",rtrim($job_in_file,", ")));

		foreach ($job_ref as $ref){
			$ref_cond.=", ".$ref;
		}
		$file_con='';
		foreach ($job_file as $file){
			if($file_con=='') $file_cond=$file; else $file_cond.=", ".$file;
		}

		
		$path =str_replace("'","",$path);
		$path =($path)?$path:"../../";
		
		
		?>
		<?
			if($row[csf("costing_per")]==1){
				$order_price_per_dzn=12;
				$costing_for=" DZN";
			}
			else if($row[csf("costing_per")]==2){
				$order_price_per_dzn=1;
				$costing_for=" PCS";
			}
			else if($row[csf("costing_per")]==3){
				$order_price_per_dzn=24;
				$costing_for=" 2 DZN";
			}
			else if($row[csf("costing_per")]==4){
				$order_price_per_dzn=36;
				$costing_for=" 3 DZN";
			}
			else if($row[csf("costing_per")]==5){
				$order_price_per_dzn=48;
				$costing_for=" 4 DZN";
			}
			$order_job_qnty=$row[csf("job_quantity")];
			$avg_unit_price=$row[csf("avg_unit_price")];

		}//end first foearch

		ob_start();
 		?>
            	
                <table style="width:850px" ><tr><td colspan="6" align="center">
                   <?
				   	$image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id='".str_replace("'","",$cbo_company_name)."'","image_location");
					?>
                    <img  src='<?=$path.$image_location; ?>' height='70' align="left" />
                    <b style="font-size:25px;"><?=$comp[str_replace("'","",$cbo_company_name)]; ?></b><br>
                    <b style="font-size:14px;">Pre- Costing</b>
                </td></tr></table>
				<table class="rpt_table" cellpadding="1" cellspacing="1" style="width:700px" rules="all">
				<tr>
				<td>
                <table class="rpt_table" align='left 'border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
				<tr>
					<td width="140">Buyer</td>
					<td width="140"><b><? echo $buyer_arr[$row[csf("buyer_name")]]; if($row[csf("brand_id")]>0)
							{
								echo '('.$brand_arr[$row[csf("brand_id")]].')';
							}?></b></td>
					<td width="140"><b>Header </b></td>
					<td width="140"><b>Buyer Cost</b> </td>
					<td width="140"><b>Internal Booking Costing<b></td>
				</tr>
				<tr>
					<td>Job No</td>
					<td><b><? echo $row[csf("job_no")]?></b></td>
					<td><b>SPM </b></td>
					<td align="right" title="CM Value/Costing Per/SMV"><b> <? $buyer_spm=$cm_cost_buyer/$smv_buyer; echo number_format($buyer_spm,4); ?> </b></td>
					<? $spm=$cm_cost_dzn/$order_price_per_dzn/$sew_smv ?>
					<td  align="right" title="CM Value/Costing Per/SMV"><b><? echo number_format($spm,4); ?></b></td>
				</tr>
				<tr>
					<td>Style Ref. No </td>
					<td><b><? echo $row[csf("style_ref_no")]; ?></b></td>
					<td>CPM</td>
					<td  align="right" title="CPM=<?=$cpm?>"><b><? echo  number_format($cpm,4);; ?></b></td>
					<td  align="right" title="CPM=<?=$cpm?>"><b><? echo  number_format($cpm,4);; ?></b></td>
				</tr>
				<tr>
					<td>Po Qnty</td>
					<? $job_qnty=$row[csf("job_quantity")];?>
					<td><b><? $uom=$row[csf("order_uom")]; echo $row[csf("job_quantity")]." ". $unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
					<td>Margin</td>
					<td align="right" title="SPM-CPM"><? 
					$buyer_margin=$buyer_spm-$cpm;
					$budget_margin=$spm-$cpm;
					echo  number_format($buyer_margin,4);; ?></td>
                    <td  align="right" title="SPM-CPM"><b><? echo  number_format($budget_margin,4);; ?></b></td>
				</tr>
				<tr>
					<td>Costing Per</td>
                    <td><b><? echo $costing_per[$row[csf("costing_per")]];?></b></td>
					<td>CM Value</td>
                    <td  align="right" title="FOB-(FB+Acc+Gmts_Wash+Emb)"><b><? echo number_format($cm_cost_buyer,4); ?></b></td>
					<td  align="right" title="FOB-(FB+Acc+Gmts_Wash+Emb)"><b><? 
					
					echo number_format($cm_cost_dzn,4); ?></b></td>
				</tr>
				<tr>
					<td>Item</td>
					<?
						$grmnt_items = "";
						if($garments_item[$row[csf("gmts_item_id")]]=="")
						{

							$grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no=$txt_job_no");
							foreach($grmts_sql as $key=>$val){
								$grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].", ";
							}
							$grmnt_items = substr_replace($grmnt_items,"",-1,1);
						}else{
							$grmnt_items = $garments_item[$row[csf("gmts_item_id")]];
						}
					?>
					<td><b><? echo $grmnt_items; ?></b></td>
					<td>FOB</td>
					<td  align="right"><b><? echo  number_format($fob_pcs_buyer,4);; ?></b></td>
					<td  align="right"><b><? echo $row[csf("avg_unit_price")]; ?></b></td>
				</tr>
				<tr>
					<td>Style Description</td>
					<td><b><? echo $row[csf("style_description")]; ?></b></td>
					<td>CM% on FOB</td>
					<td  align="right"  title="(CM Value/FOB)*100"><b><? echo number_format(($cm_cost_buyer/$fob_pcs_buyer)*100,4); ?></b></td>
					<td  align="right" title="(CM Value/FOB)*100"><b><? echo number_format(($cm_cost_dzn/$row[csf("avg_unit_price")])*100,4); ?></b></td>
				</tr>
				<tr>
					<td>Season</td>
					<td><b><? echo $season_name_arr[$row[csf('season_buyer_wise')]].'-'.substr( $row[csf('season_year')], -2);  ?></b></td>
					<td>Profit% on FOB</td>					
					<?
						$profit_per_fob=(($budget_margin*$sew_smv)/$row[csf("avg_unit_price")])*100;
						$buyer_profit_per_fob=(($buyer_margin*$smv_buyer)/$fob_pcs_buyer)*100;
					?>
					<td  align="right" title="((Margin*SMV)/FOB)*100"><b><? echo number_format($buyer_profit_per_fob,4); ?></b></td>
					<td  align="right" title="((Margin*SMV)/FOB)*100"><b><? echo number_format($profit_per_fob,4); ?></b></td>
				</tr>
				<tr>
					<td>Department</td>
                    <td><b><? echo $product_dept[$row[csf("product_dept")]];?></b></td>
					<td>BTB % on FOB</td>					
                    <td  align="right" title="((FABRIC+TRIM+EMB+WASH)/FOB)*100"><b><? echo number_format($btb_cost_buyer,4); ?></b></td>
					<td  align="right" title="((FABRIC+TRIM+EMB+WASH)/FOB)*100"><b><? echo number_format($btb_cost,4); ?></b></td>
					</tr>
					<tr>
						<td>Germents Color</td>
                        <td><b><? echo $color_library[$row[csf("body_wash_color")]];?></b></td>
						<td>SMV</td>
                        <td  align="right"><b><? echo $smv_buyer; ?></b></td>
						<td  align="right"><b><? echo $sew_smv; ?></b></td>
					</tr>
					<tr>
						<td style="border-bottom:hidden;border-left:hidden;"></td>
                        <td style="border-bottom:hidden;border-left:hidden;"></td>
						<td>Efficiency</td>
                        <td  align="right"><b><? echo $efficiency_buyer; ?></b></td>
						<td  align="right"><b><? echo  $sew_effi_percent; ?></b></td>
					</tr>
					
                </table>
				</td>
				<td  valign="top" style="border:hidden;">
                        <?
                        $nameArray_imge =sql_select("SELECT image_location,real_file_name FROM common_photo_library where master_tble_id=".$txt_job_no." and file_type=1");
						?>
                <table width="210" align='right'>
                <tr>
                <?
				 
				$img_counter = 0;
                foreach($nameArray_imge as $result_imge)
				{
				     

					?>
					<td>
						<!--<img src="../../<? //echo $result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />-->
                        <img src="<? echo $path .''. $result_imge[csf('image_location')]; ?>" width="192" height="192" border="2" />
                       <?
					  
					   ?>
					</td>
					<?

					$img_counter++;
				}
				?>
               	 </tr>
           		</table>
                        </td>
						</tr>
						</table>
					
	<br>
	<?
	if($costing_per==1) { $order_price_per_dzn=12; $costing_for=" DZN"; }
	else if($costing_per==2) { $order_price_per_dzn=1; $costing_for=" PCS"; }
	else if($costing_per==3) { $order_price_per_dzn=24;$costing_for=" 2 DZN"; }
	else if($costing_per==4) { $order_price_per_dzn=36;$costing_for=" 3 DZN"; }
	else if($costing_per==5) { $order_price_per_dzn=48;$costing_for=" 4 DZN"; }

	$dtlssql = "select fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent, wash_cost, wash_cost_percent, comm_cost, comm_cost_percent, commission, commission_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, freight, freight_percent, currier_pre_cost, currier_percent, certificate_pre_cost, certificate_percent, common_oh, common_oh_percent, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set, margin_pcs_set_percent, cm_for_sipment_sche, interest_cost, interest_percent, incometax_cost, incometax_percent, deffdlc_cost, deffdlc_percent, margin_pcs_bom, margin_bom_per from wo_pre_cost_dtls where job_no=$txt_job_no and status_active=1 and is_deleted=0";
	$dtlssql_res=sql_select($dtlssql);

	$fabric_cost=$trims_cost=$embel_cost=$wash_cost=$comm_cost=$commission=$lab_test=$inspection=$cm_cost=$freight=$currier_pre_cost=$certificate_pre_cost=$common_oh=$total_cost=$price_dzn=$margin_dzn=$price_pcs_or_set=$margin_pcs_set=$cm_for_sipment_sche=$interest_cost=$incometax_cost=$deffdlc_cost=0;

	$fabric_cost_percent=$trims_cost_percent=$embel_cost_percent=$embel_cost_percent=$wash_cost_percent=$comm_cost_percent=$commission_percent=$lab_test_percent=$inspection_percent=$cm_cost_percent=$freight_percent=$currier_percent=$certificate_percent=$common_oh_percent=$total_cost_percent=$price_dzn_percent=$margin_dzn_percent=$price_pcs_or_set=$price_pcs_or_set_percent=$margin_pcs_set_percent=$interest_percent=$incometax_percent=$deffdlc_percent=$margin_pcs_bom=$margin_bom_per=0;

	$fabric_cost=$dtlssql_res[0][csf('fabric_cost')];
	$fabric_cost_percent=$dtlssql_res[0][csf('fabric_cost_percent')];
	$trims_cost=$dtlssql_res[0][csf('trims_cost')];
	$trims_cost_percent=$dtlssql_res[0][csf('trims_cost_percent')];
	$embel_cost=$dtlssql_res[0][csf('embel_cost')];

	$embel_cost_percent=$dtlssql_res[0][csf('embel_cost_percent')];
	$wash_cost=$dtlssql_res[0][csf('wash_cost')];
	$wash_cost_percent=$dtlssql_res[0][csf('wash_cost_percent')];
	$comm_cost=$dtlssql_res[0][csf('comm_cost')];
	$comm_cost_percent=$dtlssql_res[0][csf('comm_cost_percent')];
	$commission=$dtlssql_res[0][csf('commission')];
	$commission_percent=$dtlssql_res[0][csf('commission_percent')];
	$lab_test=$dtlssql_res[0][csf('lab_test')];
	$lab_test_percent=$dtlssql_res[0][csf('lab_test_percent')];
	$inspection=$dtlssql_res[0][csf('inspection')];
	$inspection_percent=$dtlssql_res[0][csf('inspection_percent')];
	$cm_cost=$dtlssql_res[0][csf('cm_cost')];
	$cm_cost_percent=$dtlssql_res[0][csf('cm_cost_percent')];
	$freight=$dtlssql_res[0][csf('freight')];
	$freight_percent=$dtlssql_res[0][csf('freight_percent')];
	$currier_pre_cost=$dtlssql_res[0][csf('currier_pre_cost')];
	$currier_percent=$dtlssql_res[0][csf('currier_percent')];
	$certificate_pre_cost=$dtlssql_res[0][csf('certificate_pre_cost')];
	$certificate_percent=$dtlssql_res[0][csf('certificate_percent')];
	$common_oh=$dtlssql_res[0][csf('common_oh')];
	$common_oh_percent=$dtlssql_res[0][csf('common_oh_percent')];

	$total_cost=$dtlssql_res[0][csf('total_cost')];
	$total_cost_percent=$dtlssql_res[0][csf('total_cost_percent')];
	$price_dzn=$dtlssql_res[0][csf('price_dzn')];
	$price_dzn_percent=$dtlssql_res[0][csf('price_dzn_percent')];
	$margin_dzn=$dtlssql_res[0][csf('margin_dzn')];
	$margin_dzn_percent=$dtlssql_res[0][csf('margin_dzn_percent')];
	$price_pcs_or_set=$dtlssql_res[0][csf('price_pcs_or_set')];
	$price_pcs_or_set_percent=$dtlssql_res[0][csf('price_pcs_or_set_percent')];
	$margin_pcs_set=$dtlssql_res[0][csf('margin_pcs_set')];
	$margin_pcs_set_percent=$dtlssql_res[0][csf('margin_pcs_set_percent')];
	$cm_for_sipment_sche=$dtlssql_res[0][csf('cm_for_sipment_sche')];
	$interest_cost=$dtlssql_res[0][csf('interest_cost')];
	$interest_percent=$dtlssql_res[0][csf('interest_percent')];
	$incometax_cost=$dtlssql_res[0][csf('incometax_cost')];
	$incometax_percent=$dtlssql_res[0][csf('incometax_percent')];
	$deffdlc_cost=$dtlssql_res[0][csf('deffdlc_cost')];
	$deffdlc_percent=$dtlssql_res[0][csf('deffdlc_percent')];
	
	$margin_pcs_bom=$dtlssql_res[0][csf('margin_pcs_bom')];
	$margin_bom_per=$dtlssql_res[0][csf('margin_bom_per')];
	unset($dtlssql_res);
	$others_cost_value=0; $costOfFabriTrimsEmbWash=0;
	$others_cost_value=$total_cost-$cm_cost-$freight-$comm_cost-$commission;
	$costOfFabriTrimsEmbWash=($fabric_cost+$trims_cost+$embel_cost+$wash_cost);

	$quotation_id=return_field_value("quotation_id", "wo_po_details_master", "job_no=$txt_job_no");
	$sqlSum_query="select a.id, a.mst_id, a.buyer_agent_id, a.location_id, a.no_of_pack, a.is_confirm, a.is_cm_calculative, a.mis_lumsum_cost, a.commision_per, a.tot_fab_cost, a.tot_sp_operation_cost, a.tot_wash_cost, a.tot_accessories_cost, a.tot_cm_cost, a.tot_fright_cost, a.tot_courier_cost, a.tot_lab_test_cost, a.tot_miscellaneous_cost, a.tot_other_cost, a.tot_commission_cost, a.tot_cost, a.tot_fob_cost,a.inspection_cost,a.commercial_cost from qc_tot_cost_summary a where a.mst_id='$quotation_id'  and a.status_active=1 and a.is_deleted=0";
	$sqlSum=sql_select($sqlSum_query);
	$total_buyer_cost=$sqlSum[0][csf('tot_fob_cost')];
	$buyer_commission=$sqlSum[0][csf('tot_commission_cost')];
	$tot_fab_cost=$sqlSum[0][csf('tot_fab_cost')];
	$tot_accessories_cost=$sqlSum[0][csf('tot_accessories_cost')];
	$tot_sp_operation_cost=$sqlSum[0][csf('tot_sp_operation_cost')];
	$tot_wash_cost=$sqlSum[0][csf('tot_wash_cost')];
	$tot_cm_cost=$sqlSum[0][csf('tot_cm_cost')];
	$tot_fright_cost=$sqlSum[0][csf('tot_fright_cost')];
	$tot_courier_cost=$sqlSum[0][csf('tot_courier_cost')];
	$tot_lab_test_cost=$sqlSum[0][csf('tot_lab_test_cost')];
	$tot_miscellaneous_cost=$sqlSum[0][csf('tot_miscellaneous_cost')];
	$tot_other_buyer_cost=$sqlSum[0][csf('tot_other_cost')];
	$inspection_cost=$sqlSum[0][csf('inspection_cost')];
	$commercial_cost=$sqlSum[0][csf('commercial_cost')];
	
	//echo $margin_pcs_bom.'='.$margin_bom_per;
	$sl=1;
	?>
        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:100%;" rules="all">
            <tr style="font-weight:bold">

                <td  align="center" width="25%">Costing Head</td>
                <td  align="center" width="25%">Buyer Summary</td>
				<td  align="center" width="25%">Budget Cost</td>
				<td  align="center" width="25%">Variation</td>
            </tr>
            <? if($zero_value==1) { ?>
                <tr>
                    <td align="center">FOB</td>
                    <td align="center"><? echo fn_number_format($total_buyer_cost,4); ?></td>
					<td align="center"><? echo fn_number_format($avg_unit_price,4); ?></td>
					<td align="center"><? echo fn_number_format($total_buyer_cost-$avg_unit_price,4); ?></td>
                </tr>
                <tr>
                    <td align="center">Commission</td>
                    <td align="center"><? echo fn_number_format($buyer_commission,4); ?></td>
					<td align="center"><? echo fn_number_format($commission,4); ?></td>
					<td align="center"><? echo fn_number_format($buyer_commission-$commission,4); ?></td>
                </tr>
                <tr>
                    <td align="center">Net FOB</td>
                    <td align="center"><? $net_buyer_fob_value=$total_buyer_cost-$buyer_commission; echo fn_number_format($net_buyer_fob_value,4); ?></td>
					<td align="center"><? $net_fob_value=$avg_unit_price-$commission; echo fn_number_format($net_fob_value,4); ?></td>
					<td align="center"><? echo fn_number_format($net_buyer_fob_value-$net_fob_value,4); ?></td>
                </tr>
                <tr>
                    <td align="center">Fabric</td>
					<td align="center"><? echo fn_number_format($tot_fab_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format($fabric_cost,4); ?></td>
					<td align="center"><? echo fn_number_format($tot_fab_cost-$fabric_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="center">Accessories</td>
					<td align="center"><? echo fn_number_format($tot_accessories_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format($trims_cost,4); ?></td>
					<td align="center"><? echo fn_number_format($tot_accessories_cost-$trims_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="center">Embellishment</td>
                    <td align="center"><? echo fn_number_format($tot_sp_operation_cost,4); ?></td>
					<td align="center"><? echo fn_number_format($embel_cost,4); ?></td>
					<td align="center"><? echo fn_number_format($tot_sp_operation_cost-$embel_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="center">Gmts Wash</td>
                    <td align="center"><? echo fn_number_format($tot_wash_cost,4); ?></td>
					<td align="center"><? echo fn_number_format($wash_cost,4); ?></td>
					<td align="center"><? echo fn_number_format($tot_wash_cost-$wash_cost,4); ?></td>
                </tr>
				<tr>
                    <td align="center">Other Charge</td>
                    <td align="center"><? $other_buyer=$tot_fright_cost+$tot_courier_cost+$tot_lab_test_cost+$tot_miscellaneous_cost+$tot_other_buyer_cost+$inspection_cost+$commercial_cost;?><? echo fn_number_format($other_buyer,4); ?></td>
					<td align="center"><? $other=$comm_cost+$lab_test+$inspection+$freight+$currier_pre_cost+$certificate_pre_cost+$deffdlc_cost+$incometax_cost+$interest_cost;?><? echo fn_number_format($other,4); ?></td>
					<td align="center"><? echo fn_number_format($other_buyer-$other,4); ?></td>
                </tr>
                <tr>
                    <td align="center">CM</td>
					<td align="center"><? $cm_value_contribution_margine=$net_fob_value-$other; echo fn_number_format($tot_cm_cost,4); ?></td>
					<td align="center"><? $cm_value_contribution_margine=$net_fob_value-$other; echo fn_number_format($cm_cost,4); ?></td>
					<td align="center"><? echo fn_number_format($tot_cm_cost-$cm_cost,4); ?></td> 
                </tr>
               
               
            <? } else { ?>
                <tr>
					<td align="center">FOB</td>
                    <td align="center"><? echo fn_number_format($total_buyer_cost,4); ?></td>
					<td align="center"><? echo fn_number_format($avg_unit_price,4); ?></td>
					<td align="center"><? echo fn_number_format($total_buyer_cost-$avg_unit_price,4); ?></td>
                </tr>
                <tr>
					<td align="center">Commission</td>
                    <td align="center"><? echo fn_number_format($buyer_commission,4); ?></td>
					<td align="center"><? echo fn_number_format($commission,4); ?></td>
					<td align="center"><? echo fn_number_format($buyer_commission-$commission,4); ?></td>
                </tr>
                <tr>
					<td align="center">Net FOB</td>
                    <td align="center"><? $net_buyer_fob_value=$total_buyer_cost-$buyer_commission; echo fn_number_format($net_buyer_fob_value,4); ?></td>
					<td align="center"><? $net_fob_value=$avg_unit_price-$commission; echo fn_number_format($net_fob_value,4); ?></td>
					<td align="center"><? echo fn_number_format($net_buyer_fob_value-$net_fob_value,4); ?></td>
                </tr>
                <?
                if($fabric_cost!=0)
                {
					?>
					<tr>
						<td align="center">Fabric</td>
						<td align="center"><? echo fn_number_format($tot_fab_cost,4); ?></td>
						<td align="center"><? echo fn_number_format($fabric_cost,4); ?></td>
						<td align="center"><? echo fn_number_format($tot_fab_cost-$fabric_cost,4); ?></td>
					</tr>
					<?
                }
                if($trims_cost!=0)
                {
					?>
					<tr>
						<td align="center">Accessories</td>
						<td align="center"><? echo fn_number_format($tot_accessories_cost,4); ?></td>
						<td align="center"><? echo fn_number_format($trims_cost,4); ?></td>
						<td align="center"><? echo fn_number_format($tot_accessories_cost-$trims_cost,4); ?></td>
					</tr>
					<?
                }
                if($embel_cost!=0)
                {
					?>
					<tr>
						<td align="center">Embellishment</td>
						<td align="center"><? echo fn_number_format($tot_sp_operation_cost,4); ?></td>
						<td align="center"><? echo fn_number_format($embel_cost,4); ?></td>
						<td align="center"><? echo fn_number_format($tot_sp_operation_cost-$embel_cost,4); ?></td>
					</tr>
					<?
                }
                if($wash_cost!=0)
                {
					?>
					<tr>
						<td align="center">Gmts Wash</td>
						<td align="center"><? echo fn_number_format($tot_wash_cost,4); ?></td>
						<td align="center"><? echo fn_number_format($wash_cost,4); ?></td>
						<td align="center"><? echo fn_number_format($tot_wash_cost-$wash_cost,4); ?></td>
					</tr>
					<?
                }?>
				<tr>
                    <td align="center">Other Charge</td>
                    <td align="center"><? $other_buyer=$tot_fright_cost+$tot_courier_cost+$tot_lab_test_cost+$tot_miscellaneous_cost+$tot_other_buyer_cost+$commercial_cost;?><? echo fn_number_format($other_buyer,4); ?></td>
					<td align="center"><? $other=$comm_cost+$lab_test+$inspection+$freight+$currier_pre_cost+$certificate_pre_cost+$deffdlc_cost+$incometax_cost+$interest_cost;?><? echo fn_number_format($other,4); ?></td>
					<td align="center"><? echo fn_number_format($other_buyer-$other,4); ?></td>
                </tr>
                <tr>
                    <td align="center">CM</td>
					<td align="center"><? $cm_value_contribution_margine=$net_fob_value-$other; echo fn_number_format($tot_cm_cost,4); ?></td>
					<td align="center"><? $cm_value_contribution_margine=$net_fob_value-$other; echo fn_number_format($cm_cost,4); ?></td>
					<td align="center"><? echo fn_number_format($tot_cm_cost-$cm_cost,4); ?></td> 
                </tr>            
               
                <?
				}
				?>
            </table>
	<br>
	<?
	$condition= new condition();
	if(str_replace("'","",$txt_job_no) !=''){
		$condition->job_no("=$txt_job_no");
	}
	if(str_replace("'",'',$txt_po_breack_down_id) !="")
	{
		$condition->po_id("in($txt_po_breack_down_id)");
	}
	$condition->init();
	$fabric= new fabric($condition);
	$trim= new trims($condition);
	$wash= new wash($condition);
	$emblishment= new emblishment($condition);
	//echo $fabric->getQuery();die;
	$fabric_qty_arr=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	//print_r($fabric_qty_arr);
	$fabric_amount_arr=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	
	$trim_amount_arr=$trim->getAmountArray_precostdtlsid();
	$trim_qty_arr=$trim->getQtyArray_by_precostdtlsid();
	
	$emblishment_qtyArr=$emblishment->getQtyArray_by_jobAndEmblishmentid();
	$emblishment_amountArr=$emblishment->getAmountArray_by_jobAndEmblishmentid();
	$wash_qtyArr=$wash->getQtyArray_by_jobAndEmblishmentid();
	//	print_r($wash_qtyArr);
	$wash_amountArr=$wash->getAmountArray_by_jobAndEmblishmentid();
	   
	$sql_determin=sql_select("select a.id,a.type from lib_yarn_count_determina_mst a where  a.status_active=1  and a.entry_form=426");
	foreach($sql_determin as $row)
	{
		$determin_type_arr[$row[csf('id')]]=$row[csf('type')];	
	}
	
	
	// $pri_fab_arr="select a.quotation_id,b.fabric_source,b.lib_yarn_count_deter_id as deter_min_id,b.fabric_description as fab_desc,b.fabric_description,b.body_part_id,b.gsm_weight,b.uom, a.rate,a.amount, (a.requirment) as requirment,a.cons, (a.pcs) as pcs,a.process_loss_percent as p_loss from wo_pri_quo_fab_co_avg_con_dtls a,wo_pri_quo_fabric_cost_dtls  b where a.wo_pri_quo_fab_co_dtls_id=b.id and a.quotation_id=b.quotation_id  and b.status_active=1 and b.is_deleted=0 and a.quotation_id=$quot_id ";//and b.fabric_source=2
	//$pri_fab_result=sql_select($pri_fab_arr);
	
	  $pre_fab_arr="select  b.id, b.job_no,b.body_part_id,b.lib_yarn_count_deter_id as deter_min_id, b.fab_nature_id, b.color_type_id, b.fabric_description as fab_desc,b.uom,b.avg_cons,b.avg_cons_yarn, b.avg_process_loss,b.construction,b.composition,b.fabric_source,b.gsm_weight, b.rate,b.amount,b.avg_finish_cons,b.sourcing_rate,b.sourcing_nominated_supp from wo_pre_cost_fabric_cost_dtls  b where  b.status_active=1 and b.is_deleted=0 and b.job_no=$txt_job_no order by b.id ";//and b.fabric_source=2
	  //echo $pre_fab_arr; die;
	$pre_fab_result=sql_select($pre_fab_arr);
	
	$summ_fob_pcs=0;$summ_fob_gross_value_amt=$summ_sourcing_tot_budget_dzn_val=0;
	foreach($pre_fab_result as $row)
	{
		$determin_type=$determin_type_arr[$row[csf('deter_min_id')]];
		$body_partId=$body_part[$row[csf('body_part_id')]];
		//$fab_desc=$body_partId.','.$row[csf('fab_desc')];
		$fab_desc=$row[csf('fab_desc')];
		//echo $determin_type.'d';
		$tot_amt=$row[csf('avg_cons')]*$row[csf('rate')];
		$fab_req_qty=$fabric_qty_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]]+$fabric_qty_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
		$fab_req_amount=$fabric_amount_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]]+$fabric_amount_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
		$fab_cost_dtls_id=$row[csf('id')];
		$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['req_qty']+=$fab_req_qty;
		$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['req_amount']+=$fab_req_amount;
		//$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['cons']+=$row[csf('avg_finish_cons')];
		$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['cons']+=$row[csf('avg_cons')];
		$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['tot_cons']+=$row[csf('avg_cons')];
		$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['amount']+=$row[csf('amount')];
		$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['p_loss']=$row[csf('avg_process_loss')];
		$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['sourcing_nominated_supp']=$row[csf('sourcing_nominated_supp')];
		$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['sourcing_rate']=$row[csf('sourcing_rate')];
		$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['fab_desc']=$row[csf('construction')].','.$row[csf('composition')];
		$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['uom']=$unit_of_measurement[$row[csf('uom')]];
		$p_fab_precost_tot_row+=1;	
		//Summary
		$summ_fob_pcs+=$row[csf('amount')];
	//	$summ_sourcing_tot_budget_dzn_val+=$fab_req_qty*$row[csf('sourcing_rate')];
		
		$summ_fob_gross_value_amt+=$fab_req_amount;
	}
  $pre_trim_consarr="select b.id,c.trim_type,c.item_name,b.description,b.trim_group,b.cons_dzn_gmts,b.seq,b.cons_uom as uom,avg(d.excess_per) as  excess_per from wo_pre_cost_trim_cost_dtls b,lib_item_group c,wo_pre_cost_trim_co_cons_dtls d where  c.id=b.trim_group and b.id=d.wo_pre_cost_trim_cost_dtls_id and c.trim_type in(1,2) and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and b.job_no=$txt_job_no group by b.id,c.trim_type,c.item_name,b.description,b.trim_group,b.cons_dzn_gmts,b.cons_uom,b.seq order by b.seq";
	$pre_trim_cons_result=sql_select($pre_trim_consarr);
	foreach($pre_trim_cons_result as $row)
	{
		$trims_type=$row[csf('trim_type')];
		
		
		$description=$row[csf('description')];
		if($description!="") $descriptionCond=", ".$description; else $descriptionCond="";
		$item_id=$row[csf('item_name')].$descriptionCond;
		if($trims_type==1) //Sewing
		{
				$p_sew_trim_precost_excess_arr[$item_id]['p_loss']+=$row[csf('excess_per')];
		}
		else
		{
				$p_fin_trim_precost_excess_arr[$item_id]['p_loss']+=$row[csf('excess_per')];;
		}
		
	}
	
	
	//  $pre_trim_arr="select b.seq,b.id,c.trim_type,c.item_name,b.description,b.trim_group,b.tot_cons,b.ex_per ,b.cons_dzn_gmts,b.cons_uom as uom, b.rate,b.amount,b.sourcing_rate,b.sourcing_nominated_supp from wo_pre_cost_trim_cost_dtls b,lib_item_group c where  c.id=b.trim_group and c.trim_type in(1,2) and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and b.job_no=$txt_job_no order by b.seq";//and b.fabric_source=2

	/*  $pre_trim_arr="select b.seq,b.id,c.trim_type,c.item_name,b.description,b.trim_group,b.tot_cons,b.ex_per ,b.cons_dzn_gmts,b.cons_uom as uom, b.rate,b.amount,b.sourcing_rate,b.sourcing_nominated_supp from wo_pre_cost_trim_cost_dtls b,lib_item_group c where  c.id=b.trim_group  and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and b.job_no=$txt_job_no order by b.seq"; */

	$pre_trim_arr="SELECT b.seq, b.id, c.trim_type, c.item_name, b.description, b.trim_group, b.tot_cons, b.ex_per, b.cons_dzn_gmts, b.cons_uom AS uom, b.rate, b.amount, b.sourcing_rate, b.sourcing_nominated_supp,d.particular_type_id,d.consumption as buyer_consumption,d.tot_cons as buyer_cons,  d.rate as buyer_rate, d.value as buyer_value FROM wo_po_details_master a,wo_pre_cost_trim_cost_dtls b, lib_item_group c,qc_cons_rate_dtls d WHERE c.id = b.trim_group AND d.MST_ID=a.QUOTATION_ID and d.PARTICULAR_TYPE_ID=b.TRIM_GROUP AND a.id=b.job_id AND b.status_active = 1 AND b.is_deleted = 0 AND c.status_active = 1 AND c.is_deleted = 0 AND a.status_active = 1 AND a.is_deleted = 0 AND d.status_active = 1 AND d.is_deleted = 0 AND a.job_no = $txt_job_no AND d.type=4 ORDER BY b.seq";

	$pre_trim_result=sql_select($pre_trim_arr);
	
	$p_sew_trim_precost_arr=$p_fin_trim_precost_arr=array();

	//print_r($p_sew_trim_precost_arr2);
	
	$pre_emb_arr="SELECT b.job_no,b.id,b.emb_name,b.emb_type,b.cons_dzn_gmts, b.rate,b.amount,b.sourcing_rate,b.sourcing_nominated_supp ,d.particular_type_id,d.consumption as buyer_consumption,d.tot_cons as buyer_cons,  d.rate as buyer_rate, d.value as buyer_value FROM wo_po_details_master a,wo_pre_cost_embe_cost_dtls b, qc_cons_rate_dtls d WHERE  d.MST_ID=a.QUOTATION_ID and d.PARTICULAR_TYPE_ID=b.EMB_NAME AND a.id=b.job_id AND b.status_active = 1 AND b.is_deleted = 0  AND a.status_active = 1 AND a.is_deleted = 0 AND d.status_active = 1 AND d.is_deleted = 0 AND a.job_no = $txt_job_no AND d.type=2 ORDER BY b.EMB_NAME";

	/*  $pre_wash_arr="select b.job_no,b.id,b.emb_name,b.emb_type,b.cons_dzn_gmts, b.rate,b.amount,b.sourcing_rate,b.sourcing_nominated_supp from wo_pre_cost_embe_cost_dtls  b where  b.status_active=1 and b.is_deleted=0  and b.job_no=$txt_job_no  order by b.emb_name"; *///and b.fabric_source=2
	$pre_emb_result=sql_select($pre_emb_arr);
	
	//	$summ_sourcing_tot_budget_dzn_val=0;
 
	foreach($pre_emb_result as $row)
	{
		$emb_name_id=$row[csf('emb_name')];
		$emb_type=$row[csf('emb_type')];
	
		//emblishment_embroy_type_arr
		if($emb_name_id==1) //Print type
		{
			if($emb_type>0) $emb_typeCond=", ".$emblishment_print_type[$emb_type];else $emb_typeCond="";
			$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
		}
		else if($emb_name_id==2) //embro type
		{
			if($emb_type>0) $emb_typeCond=", ".$emblishment_embroy_type_arr[$emb_type];else $emb_typeCond="";
			$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
		}
		else if($emb_name_id==4) //Special type
		{
			if($emb_type>0) $emb_typeCond=", ".$emblishment_spwork_type[$emb_type];else $emb_typeCond="";
			$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
		}
		else if($emb_name_id==5) //GMT type
		{
			if($emb_type>0) $emb_typeCond=", ".$emblishment_gmts_type[$emb_type];else $emb_typeCond="";
			$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
		}
		else if($emb_name_id==99) //GMT type
		{
			if($emb_type>0) $emb_typeCond=", ".$emblishment_other_type_arr[$emb_type];else $emb_typeCond="";
			$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
		}
		 

		$wash_req_amount=$emb_req_amount=0;

		$emb_req_qty=$emblishment_qtyArr[$row[csf('job_no')]][$row[csf('id')]];
		$emb_req_amount=$emblishment_amountArr[$row[csf('job_no')]][$row[csf('id')]];
		$p_embro_precost_arr[$emb_name]['req_qty']+=$emb_req_qty;
		$p_embro_precost_arr[$emb_name]['req_amount']+=$emb_req_amount;
		$p_embro_precost_arr[$emb_name]['cons']+=$row[csf('cons_dzn_gmts')];
		//$p_wash_precost_arr[$emb_name]['tot_cons']+=$row[csf('cons_dzn_gmts')];
		$p_embro_precost_arr[$emb_name]['amount']+=$row[csf('amount')];
		$p_embro_precost_arr[$emb_name]['p_loss']=$row[csf('p_loss')];
		$p_embro_precost_arr[$emb_name]['pre_rate']=$row[csf('rate')];
		$p_embro_precost_arr[$emb_name]['buyer_consumption']+=$row[csf('buyer_cons')];
		$p_embro_precost_arr[$emb_name]['buyer_rate']=$row[csf('buyer_rate')];
		$p_embro_precost_arr[$emb_name]['buyer_value']=$row[csf('buyer_value')];
		if($row[csf('sourcing_rate')]>0)
		{
		$p_embro_precost_arr[$emb_name]['sourcing_rate']=$row[csf('sourcing_rate')];
		}
		$p_embro_precost_arr[$emb_name]['sourcing_nominated_supp']=$row[csf('sourcing_nominated_supp')];
		$p_embro_precost_arr[$emb_name]['uom']=$unit_of_measurement[$row[csf('uom')]];
		$summ_fob_pcs+=$row[csf('amount')];
		$summ_sourcing_tot_budget_dzn_val+=$emb_req_qty*$row[csf('sourcing_rate')];
		$p_embro_tot_row+=1;	
		//$summ_fob_value_pcs+=$row[csf('amount')]/$order_price_per_dzn;
		$summ_fob_gross_value_amt+=$emb_req_amount+$wash_req_amount;
	}

	$pre_wash_arr="SELECT b.job_no,b.id,b.emb_name,b.emb_type,b.cons_dzn_gmts, b.rate,b.amount,b.sourcing_rate,b.sourcing_nominated_supp ,d.particular_type_id,d.consumption as buyer_consumption,d.tot_cons as buyer_cons,  d.rate as buyer_rate, d.value as buyer_value FROM wo_po_details_master a,wo_pre_cost_embe_cost_dtls b, qc_cons_rate_dtls d WHERE  d.MST_ID=a.QUOTATION_ID and d.PARTICULAR_TYPE_ID=b.EMB_TYPE AND a.id=b.job_id AND b.status_active = 1 AND b.is_deleted = 0  AND a.status_active = 1 AND a.is_deleted = 0 AND d.status_active = 1 AND d.is_deleted = 0 AND a.job_no = $txt_job_no AND d.type=3 ORDER BY b.EMB_NAME";

	/*  $pre_wash_arr="select b.job_no,b.id,b.emb_name,b.emb_type,b.cons_dzn_gmts, b.rate,b.amount,b.sourcing_rate,b.sourcing_nominated_supp from wo_pre_cost_embe_cost_dtls  b where  b.status_active=1 and b.is_deleted=0  and b.job_no=$txt_job_no  order by b.emb_name"; *///and b.fabric_source=2
	$pre_wash_result=sql_select($pre_wash_arr);
	
	//	$summ_sourcing_tot_budget_dzn_val=0;
 
	foreach($pre_wash_result as $row)
	{
		$emb_name_id=$row[csf('emb_name')];
		$emb_type=$row[csf('emb_type')];
	
		//emblishment_embroy_type_arr
		if($emb_name_id==1) //Print type
		{
			if($emb_type>0) $emb_typeCond=", ".$emblishment_print_type[$emb_type];else $emb_typeCond="";
			$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
		}
		else if($emb_name_id==2) //embro type
		{
			if($emb_type>0) $emb_typeCond=", ".$emblishment_embroy_type_arr[$emb_type];else $emb_typeCond="";
			$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
		}
		else if($emb_name_id==4) //Special type
		{
			if($emb_type>0) $emb_typeCond=", ".$emblishment_spwork_type[$emb_type];else $emb_typeCond="";
			$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
		}
		else if($emb_name_id==5) //GMT type
		{
			if($emb_type>0) $emb_typeCond=", ".$emblishment_gmts_type[$emb_type];else $emb_typeCond="";
			$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
		}
		else if($emb_name_id==99) //GMT type
		{
			if($emb_type>0) $emb_typeCond=", ".$emblishment_other_type_arr[$emb_type];else $emb_typeCond="";
			$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
		}
		 

		$wash_req_amount=$emb_req_amount=0;
	
		if($row[csf('emb_type')]>0) $wash_emb_typeCond=", ".$emblishment_wash_type[$row[csf('emb_type')]];else $wash_emb_typeCond="";
		$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$wash_emb_typeCond;
		$wash_req_qty=$wash_qtyArr[$row[csf('job_no')]][$row[csf('id')]];
		$wash_req_amount=$wash_amountArr[$row[csf('job_no')]][$row[csf('id')]];
				// echo $emb_name.'='.$wash_emb_typeCond.' <br>';
			 
		$p_wash_precost_arr[$emb_name]['req_qty']+=$wash_req_qty;
		$p_wash_precost_arr[$emb_name]['req_amount']+=$wash_req_amount;
		$p_wash_precost_arr[$emb_name]['cons']+=$row[csf('cons_dzn_gmts')];
		//$p_wash_precost_arr[$emb_name]['tot_cons']+=$row[csf('cons_dzn_gmts')];
		$p_wash_precost_arr[$emb_name]['amount']+=$row[csf('amount')];
		$p_wash_precost_arr[$emb_name]['p_loss']=$row[csf('p_loss')];
		$p_wash_precost_arr[$emb_name]['sourcing_rate']=$row[csf('sourcing_rate')];
		$p_wash_precost_arr[$emb_name]['pre_rate']=$row[csf('rate')];
		$p_wash_precost_arr[$emb_name]['sourcing_nominated_supp']=$row[csf('sourcing_nominated_supp')];
		$p_wash_precost_arr[$emb_name]['uom']=$unit_of_measurement[$row[csf('uom')]];
		//$p_wash_precost_arr[$emb_name]['buyer_consumption']=$row[csf('buyer_consumption')];
		$p_wash_precost_arr[$emb_name]['buyer_consumption']=$row[csf('buyer_cons')];
		$p_wash_precost_arr[$emb_name]['buyer_rate']=$row[csf('buyer_rate')];
		$p_wash_precost_arr[$emb_name]['buyer_value']=$row[csf('buyer_value')];
		$summ_fob_pcs+=$row[csf('amount')];
		$summ_sourcing_tot_budget_dzn_val+=$wash_req_qty*$row[csf('sourcing_rate')];
		$p_wash_tot_row+=1;	
		$summ_fob_gross_value_amt+=$emb_req_amount+$wash_req_amount;
	}
	//echo $summ_fob_gross_value_amt.'=';
		//echo $summ_fob_pcs.'A';
		//echo $summ_fob_value_pcs.'C,';
	//wo_pri_quo_comarcial_cost_dtls 
	$sql_other = "select fabric_cost, trims_cost, embel_cost, wash_cost, comm_cost, commission, lab_test, inspection, cm_cost, freight, currier_pre_cost, certificate_pre_cost, design_cost, studio_cost, common_oh, depr_amor_pre_cost, interest_cost, incometax_cost, total_cost,price_dzn from wo_pre_cost_dtls where  job_no=$txt_job_no  and status_active=1 and  is_deleted=0";
	$pre_other_result=sql_select($sql_other);//$summ_fob_value_pcs=0;
	 foreach( $pre_other_result as $row )
	{
		$lab_test=($row[csf('lab_test')]/$order_price_per_dzn)*$order_job_qnty;
		$currier_pre_cost=($row[csf('currier_pre_cost')]/$order_price_per_dzn)*$order_job_qnty;
		$inspection=($row[csf('inspection')]/$order_price_per_dzn)*$order_job_qnty;
		$comarcial=($row[csf('comm_cost')]/$order_price_per_dzn)*$order_job_qnty;
		
		$freight=($row[csf('freight')]/$order_price_per_dzn)*$order_job_qnty;
		$certificate_pre_cost=($row[csf('certificate_pre_cost')]/$order_price_per_dzn)*$order_job_qnty;
		$design_pre_cost=($row[csf('design_cost')]/$order_price_per_dzn)*$order_job_qnty;
		$studio_pre_cost=($row[csf('studio_cost')]/$order_price_per_dzn)*$order_job_qnty;
		$common_oh=($row[csf('common_oh')]/$order_price_per_dzn)*$order_job_qnty;
		$depr_amor_pre_cost=($row[csf('depr_amor_pre_cost')]/$order_price_per_dzn)*$order_job_qnty;
		$interest_pre_cost=($row[csf('interest_cost')]/$order_price_per_dzn)*$order_job_qnty;
		$income_tax_pre_cost=($row[csf('incometax_cost')]/$order_price_per_dzn)*$order_job_qnty;
		
		$tot_other_for_fob_value=$lab_test+$currier_pre_cost+$inspection+$comarcial+$freight+$certificate_pre_cost+$design_pre_cost+$studio_pre_cost+$common_oh+$interest_pre_cost+$income_tax_pre_cost+$depr_amor_pre_cost;
		//echo $tot_other_for_fob_value;
		$lab_test_dzn=$row[csf('lab_test')];
		$fob_pcs=$row[csf('price_with_commn_pcs')];
		$currier_pre_cost_dzn=$row[csf('currier_pre_cost')];
		$inspection_dzn=$row[csf('inspection')];
		$comarcial_dzn=$row[csf('comm_cost')];
		
		$common_oh_dzn=$row[csf('common_oh')];
		$studio_pre_cost_dzn=$row[csf('studio_cost')];
		$design_pre_cost_dzn=$row[csf('design_cost')];
		$certificate_pre_cost_dzn=$row[csf('certificate_pre_cost')];
		
		$freight_dzn=$row[csf('freight')];
		//$comm_cost_dzn=$row[csf('comm_cost')];
		$depr_amor_pre_cost_dzn=$row[csf('depr_amor_pre_cost')];
		$income_tax_pre_cost_dzn=$row[csf('incometax_cost')];
		$interest_pre_cost_dzn=$row[csf('interest_cost')];
		
		$cm_cost_dzn=$row[csf('cm_cost')];
		$cm_cost_pcs=$row[csf('cm_cost')]/$order_price_per_dzn;
		$cm_cost_req=($row[csf('cm_cost')]/$order_price_per_dzn)*$order_job_qnty;
		$po_qty_dzn=$order_job_qnty/$order_price_per_dzn;
		$tot_cm_qty_dzn=$row[csf('cm_cost')]*$po_qty_dzn;
		//$lab_test_dzn=$row[csf('lab_test')];

		$tot_summ_fob_pcs=$row[csf('total_cost')];
		
		$tot_other_cost_dzn=$common_oh_dzn+$studio_pre_cost_dzn+$design_pre_cost_dzn+$certificate_pre_cost_dzn+$freight_dzn+$depr_amor_pre_cost_dzn+$income_tax_pre_cost_dzn+$interest_pre_cost_dzn;
		
		$tot_other_cost=($tot_other_cost_dzn/$order_price_per_dzn)*$order_job_qnty;
		//$summ_fob_value_pcs+=($tot_other_cost_dzn+$currier_pre_cost_dzn+$lab_test_dzn+$inspection_dzn+$comarcial_dzn)*$order_price_per_dzn+$cm_cost_pcs;
		
		// echo $tot_other_for_fob_value.'m';
		$summ_fob_gross_value_amt+=$tot_other_for_fob_value+$tot_cm_qty_dzn ;
		
		$summ_fob_pcs+=$tot_other_cost_dzn+$lab_test_dzn+$currier_pre_cost_dzn+$inspection_dzn+$comarcial_dzn+$cm_cost_dzn;
		
		$summ_sourcing_tot_budget_dzn_val+=$tot_other_for_fob_value;
		 
	}
	$quotation_id=return_field_value("quotation_id", "wo_po_details_master", "job_no=$txt_job_no");
	$consSql="select id, mst_id, item_id, type, particular_type_id, consumption, ex_percent, tot_cons, uom, rate, value, fab_id, description, use_for, fc_per, body_part_id, supp_ref from qc_cons_rate_dtls where mst_id='$quotation_id' and status_active=1 and is_deleted=0 order by id ASC";
	$consSqlData=sql_select($consSql); $cons_rate_fab_arr=array(); $EmbData=array(); $TrimData=array(); $tot_rows=0; $libFabId="";
			foreach ($consSqlData as $row)
			{
				if($row[csf("type")]==1)
				{
					if($row[csf("tot_cons")]>0)
					{
							$qcConsRateArr['cons']=$row[csf('consumption')];
							$qcConsRateArr['ex_percent']=$row[csf('ex_percent')];
							$qcConsRateArr['tot_cons']=$row[csf('tot_cons')];
							$qcConsRateArr['rate']=$row[csf('rate')];
							$qcConsRateArr['fc_per']=$row[csf('fc_per')];
							$qcConsRateArr['value']=$row[csf('value')];
					}
				}
			}

	$sql_commi = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls  where job_no=".$txt_job_no." and status_active=1";
	$result_commi=sql_select($sql_commi);
 foreach( $result_commi as $row )
	{
		$commission_type_id=$row[csf('particulars_id')];
		$com_type_id=$row[csf('commission_base_id')];
		
		$commission_arr[$commission_type_id]['commi_req_amt']=($row[csf('commission_amount')]/$order_price_per_dzn)*$order_job_qnty;
		$commission_arr[$commission_type_id]['commi_amt']=$row[csf('commission_amount')];
		$commission_arr[$commission_type_id]['commi_amt_pcs']=$row[csf('commission_amount')]*$order_price_per_dzn;
		//$summ_fob_value_pcs+=$row[csf('commission_amount')]/$order_price_per_dzn;
		$summ_fob_gross_value_amt+=($row[csf('commission_amount')]/$order_price_per_dzn)*$order_job_qnty;
		$summ_fob_pcs+=$row[csf('commission_amount')];
		$summ_sourcing_tot_budget_dzn_val+=($row[csf('commission_amount')]/$order_price_per_dzn)*$order_job_qnty;
	} 
	$summ_sourcing_fob_pcs=$summ_sourcing_tot_budget_dzn_val/$order_job_qnty;
	$summ_tot_final_cm=($summ_fob_gross_value_amt-$summ_sourcing_tot_budget_dzn_val)/$offer_qty_dzn;
	// $tot_summ_fob_pcs=$summ_fob_pcs/$order_price_per_dzn;
	
	 $supplier_library_arr=return_library_array( "select a.short_name, a.id from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id   and a.is_deleted=0  and a.status_active=1 group by a.id,a.short_name order by a.short_name", "id", "short_name");
	?>
            <table align="left" border="1" cellpadding="0" cellspacing="0"  width="100%" style="margin:5px;" rules="all"> 
              <tr>
             <td  width="100%">
             	<table align="left" class="rpt_table"  border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px;" rules="all"> 
                <tr>
                <th colspan="17" style="background-color:#CCC;font-size:20px;"> <b>Details Part</b></th>
               
                </tr>
				<tr>
				<td colspan="17" style="background-color:#963;font-size:20px;"> <b style="float:left">Fabric Cost</b></td>
				</tr>
				<tr>
					<th  rowspan="2" width="20">SL </th>
                    <th  rowspan="2" title="Fabric">ITEM DESCRIPTION </th>
					<th  rowspan="2">UOM </th>
					<th  colspan="5">Buyer Costing</th>
					<th width="70"></th>
					<th  colspan="5">Internal/Booking Costing</th>
					<th  rowspan="2" >Cons. Variation / Pcs</th>
                    <th  rowspan="2" >Rate Variation / Pcs </th>
					<th  rowspan="2">Total Variation</th>
				</tr>
                <tr>
                    <th  width="70">Cons/Pcs</th>
					<th  width="70">Rate(USD)</th>
					<th  width="70">Value/Pcs</th>
					<th  width="70">Req. Qty</th>
                    <th  width="70">Total Fab. Cost</th>
					<th width="70"></th>
					<th  width="70">Cons/Pcs</th>
					<th  width="70">Rate(USD)</th>
					<th  width="70">Value/Pcs</th>
					<th  width="70">Req. Qty</th>
                    <th  width="70">Total Fab. Cost</th>
                 </tr>
                    
                    <?
					$f=1;$tot_fab_amount=$tot_fab_amount_pcs=$tot_fab_req_amount=0;$ff=1;$tot_fab_req_sourcing_amount=$tot_fab_req_sourcing_bal_amount=0;
                    foreach($p_fab_precost_arr as $fabriccost_dtls_id=>$fabriccost_dtls_data)
					{
						foreach ($fabriccost_dtls_data as  $fab_type=>$fab_data) 
						{
							 foreach($fab_data as $fab_desc=>$row)
							{
							if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
							$cons_value=$qcConsRateArr['tot_cons'];
							$cons_rate=$qcConsRateArr['rate'];
							$value_value=$qcConsRateArr['value'];
							$nominated_supp_str=""; 
							 $exnominated_supp=explode(",",$row[('sourcing_nominated_supp')]);
							 foreach($exnominated_supp as $supp)
							 {
								if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_arr[$supp]; else $nominated_supp_str.=','.$supplier_library_arr[$supp];
							 }	
	                    ?>
	                	<tr bgcolor="<? echo $bgcolor;?>">
	                   
	                    <td width="20" align="center"><p><? echo $f; ?></p></td>
	                   
	                    <td width="300" align="center"><div style="word-break:break-all"><? echo $fab_desc; //echo $fab_type.','.$fab_desc; ?></div></td>
						<td width="50"><p><? echo $row[('uom')]; ?></p></td>
	                    <td width="70" align="right"><p><? echo number_format($cons_value,4); ?></p></td>
						<td width="70" align="right"><p><? echo number_format($cons_rate,4); ?></p></td>
						<td width="70" align="right"><p><? echo number_format($value_value,4); ?></p></td>
						<td width="70" align="right"><p><? echo number_format($cons_value*$job_qnty,4); ?></p></td>
						<td width="70" align="right"><p><? $cons_tot_val=($cons_value*$job_qnty*$cons_rate);echo number_format($cons_value*$job_qnty*$cons_rate,4); ?></p></td>
						<th width="70"></th>
						<td width="70" align="right"><p><? echo number_format($row['cons'],4); ?></p></td>
						<td width="70" align="right"><p><? $pre_rate=number_format($row[('req_amount')]/$row[('req_qty')],4);echo number_format($row[('req_amount')]/$row[('req_qty')],4); ?></p></td>
						<td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,4); ?></p></td>
						<td width="70" align="right"><p><? echo number_format($row[('req_qty')],4); ?></p></td>
						<td width="70" align="right"><p><? $req_amt=$row[('req_amount')];echo number_format($row[('req_amount')],4); ?></p></td>
						<td width="70" align="right"><p><? echo number_format($cons_value-$row['cons'],4); ?></p></td>
						<td width="70" align="right"><p><? echo number_format($cons_rate-$pre_rate,4); ?></p></td>
						<td width="70" align="right"><p><? echo number_format($cons_tot_val-$req_amt,4); ?></p></td>    
	                   
	                    </tr>
						<?
							$f++;$ff++;
							$tot_fab_amount+=$row[('amount')];
							$tot_fab_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
							$tot_fab_req_amount+=$row[('req_amount')];
							$tot_buyer_fab_req_amount+=$cons_value*$job_qnty*$cons_rate;
							$tot_fab_req_sourcing_amount+=$row[('sourcing_rate')]*$row[('req_qty')];
							$tot_fab_req_sourcing_bal_amount+=$bal_sourcing_amount;
							}
						}
					}
					?>
                     
                    <tfoot>
                      <tr style="font-size:18px; background-color:#CCC">
                        <td colspan="7"> <b style="float:right">Total Fabric Cost:</b></td>
                        <td  align="right"><b><? echo number_format($tot_buyer_fab_req_amount,4); ?></b></td>
						<td colspan="5"> <b style="float:right"></b></td>
                        <td  align="right"><b><? echo number_format($tot_fab_req_amount,4); ?></b></td>
						<td colspan="3"> <b style="float:right"></b></td>
                      
                        
                    </tr>
                    </tfoot>
                </table>
                <br>
                <?
               // die;
				?>
                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1"  width="98%" style="text-align:center;margin:5px;" rules="all">
                
                 <thead>
				 <tr>
				<td colspan="17" style="background-color:#963;font-size:20px;"> <b style="float:left">Trims Cost</b></td>
				</tr>
				<tr>
					<th  rowspan="2" width="20">SL </th>
                    <th  rowspan="2" title="Fabric">ITEM DESCRIPTION </th>
					<th  rowspan="2">UOM </th>
					<th  colspan="5">Buyer Costing</th>
					<th width="70"></th>
					<th  colspan="5">Internal/Booking Costing</th>
					<th  rowspan="2" >Cons. Variation / Pcs</th>
                    <th  rowspan="2" >Rate Variation / Pcs </th>
					<th  rowspan="2">Total Variation</th>
				</tr>
                <tr>
                    <th  width="70">Cons/Pcs</th>
					<th  width="70">Rate(USD)</th>
					<th  width="70">Value/Pcs</th>
					<th  width="70">Req. Qty</th>
                    <th  width="70">Total Trims Cost</th>
					<th width="70"></th>
					<th  width="70">Cons/Pcs</th>
					<th  width="70">Rate(USD)</th>
					<th  width="70">Value/Pcs</th>
					<th  width="70">Req. Qty</th>
                    <th  width="70">Total Trims Cost</th>
                 </tr>
                    </thead>
                     
                    <?
                    $trims_tot_amount=0;
					$ts=1;$tot_sew_amount=$tot_amount_pcs=$tot_sew_amount_pcs=$tot_sew_req_amount=$tot_buyer_sew_req_amount=0;$ttts=1;$tot_sew_req_sourcing_amount=$tot_sew_req_sourcing_bal_amount=0;
                    // foreach($p_sew_trim_precost_arr as $item_id=>$row)
					// {
					foreach($pre_trim_result as $row){

						$trims_type=$row[csf('trim_type')];
				
				
						$description=$row[csf('description')];
						if($description!="") $descriptionCond=", ".$description; else $descriptionCond="";
						$item_id=$row[csf('item_name')].$descriptionCond;
						//$item_name_arr[$item_id]=$row[csf('item_name')].$descriptionCond;
					



						
						if($ts%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
						$nominated_supp_str=""; 
						 $exnominated_supp=explode(",",$row[('sourcing_nominated_supp')]);
						 foreach($exnominated_supp as $supp)
						 {
							if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_arr[$supp]; else $nominated_supp_str.=','.$supplier_library_arr[$supp];
						 }	
						 
						 $req_amt=$row[csf('cons_dzn_gmts')]*$row[csf('rate')];

						 $p_sew_loss=$row[csf('ex_per')];
						 $ex_tot=$row[csf('cons_dzn_gmts')]+(($row[csf('cons_dzn_gmts')]*$p_sew_loss)/100);
					
							
						$trim_req_qty=$trim_qty_arr[$row[csf('id')]];
						$trim_req_amount=$trim_amount_arr[$row[csf('id')]];
								
						//$p_sew_trim_precost_arr[$item_id]['tot_row']+=1;
						$p_sew_trim_tot_row+=1;
					
						$summ_fob_pcs+=$row[csf('amount')];	
						$summ_sourcing_tot_budget_dzn_val+=$trim_req_qty*$row[csf('sourcing_rate')];
						$summ_fob_gross_value_amt+=$trim_req_amount;
						
                    ?>
                	<tr bgcolor="<? echo $bgcolor;?>">
                   
                    <td width="20" align="center"><p><? echo $ts; ?></p></td>
                    <td width="300" ><div style="word-break:break-all"><? echo $item_id; ?></div></td> 
					<td width="50" align="center"><p><? echo $unit_of_measurement[$row[csf('uom')]]; ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[csf('buyer_cons')],6); ?></p></td>
					<td width="70" align="right"><p><? echo number_format($row[csf('buyer_rate')],6); ?></p></td>
					<td width="70" align="right"><p><? echo number_format($row[csf('buyer_value')],6); ?></p></td>
					<td width="70" align="right"><p><? echo number_format($row[csf('buyer_cons')]*$job_qnty,6); ?></p></td>
					<td width="70" align="right"><p><? echo number_format($row[csf('buyer_cons')]*$job_qnty*$row[csf('buyer_rate')],6); ?></p></td>
					<td width="70"></td>
                    <td width="70" align="right"><p><? echo number_format($row[csf('cons_dzn_gmts')],6); ?></p></td>
					<td width="70" align="right"><p><? $budget_trims=number_format($trim_req_amount/$trim_req_qty,6);echo number_format($trim_req_amount/$trim_req_qty,6); ?></p></td>
					<td width="70" align="right"><p><? echo number_format($row[csf('amount')]/$order_price_per_dzn,6); ?></p></td>
					<td width="70" align="right"><p><? echo number_format($trim_req_qty,6); ?></p></td>
					<td width="70" align="right"><p><? echo number_format($trim_req_amount,6); ?></p></td>
					<td width="70" align="right"><p><? echo number_format($row[csf('buyer_cons')]-$row[csf('cons_dzn_gmts')],6); ?></p></td>
					<td width="70" align="right"><p><? echo number_format($row[csf('buyer_rate')]-$budget_trims,6); ?></p></td>
					<td width="70" align="right"><p><? echo number_format($row[csf('buyer_value')]-($row[csf('amount')]/$order_price_per_dzn),6); ?></p></td>

                     
                    </tr>
					<?
						$ts++;$ttts++;
						$tot_sew_amount+=$row[csf('amount')];
						$tot_sew_amount_pcs+=$row[csf('amount')]/$order_price_per_dzn;
						$tot_sew_req_amount+=$trim_req_amount;
						$tot_buyer_sew_req_amount+=$row[csf('buyer_cons')]*$job_qnty*$row[csf('buyer_rate')];
						$tot_sew_req_sourcing_amount+=$row[csf('sourcing_rate')]*$trim_req_qty;
						$tot_sew_req_sourcing_bal_amount+=$bal_sourcing_amout;
						$trims_tot_amount+=$trim_req_amount;
						
					}
					?>
                     
                     <tfoot>
                    <tr style="font-size:18px; background-color:#CCC">
                        <td colspan="7" align="right"><b>Total Trims Cost:</b></td>
						<td  align="right"><b><? echo number_format($tot_buyer_sew_req_amount,6); ?></b></td>
						<td colspan="5" align="right"></td>
                        <td  align="right"><b><? echo number_format($tot_sew_req_amount,6); ?></b></td>
						<td colspan="3" align="right"></td>
                        
                    </tr>
                    </tfoot>
                     
                </table>
            
                <br>
                 <?
                // die;
				 ?>
                <table align="left" class="rpt_table"  border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px; text-align:center;" rules="all"> 
                <caption><b style="float:left">Gmts Wash</b></caption>
                <thead>
				<tr>
					<th  rowspan="2" width="20">SL </th>
                    <th  rowspan="2" title="Fabric">ITEM DESCRIPTION </th>
					<th  rowspan="2">UOM </th>
					<th  colspan="5">Buyer Costing</th>
					<th width="70"></th>
					<th  colspan="5">Internal/Booking Costing</th>
					<th  rowspan="2" >Cons. Variation / Pcs</th>
                    <th  rowspan="2" >Rate Variation / Pcs </th>
					<th  rowspan="2">Total Variation</th>
				</tr>
                <tr>
                    <th  width="70">Cons/Pcs</th>
					<th  width="70">Rate(USD)</th>
					<th  width="70">Value/Pcs</th>
					<th  width="70">Req. Qty</th>
                    <th  width="70">Total Wash Cost</th>
					<th width="70"></th>
					<th  width="70">Cons/Pcs</th>
					<th  width="70">Rate(USD)</th>
					<th  width="70">Value/Pcs</th>
					<th  width="70">Req. Qty</th>
                    <th  width="70">Total Wash Cost</th>
                 </tr>
                    </thead>
                    
                    <?
					$w=1;$tot_wash_amount=$tot_wash_amount_pcs=$tot_wash_req_amount=$tot_wash_sourcing_req_amount=$tot_wash_sourcing_req_amount_bal=0;$ws=1;
                    foreach($p_wash_precost_arr as $embname_id=>$row)
					{
						
						if($w%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
						$wash_nominated_supp_str=""; 
						 $exnominated_suppArr=explode(",",$row[('sourcing_nominated_supp')]);
						 foreach($exnominated_suppArr as $supp)
						 {
							if($wash_nominated_supp_str=="") $wash_nominated_supp_str=$supplier_library_arr[$supp]; else $wash_nominated_supp_str.=','.$supplier_library_arr[$supp];
						 }		
                    ?>
                	<tr bgcolor="<? echo $bgcolor;?>">
                    
                    <td width="20" align="center"><p><? echo $w; ?></p></td>
                    <td width="300"><div style="word-break:break-all"><? $embname_id=explode(", ",$embname_id);echo $embname_id[1]; ?></div></td> 
					<td width="50"><p><? echo $costing_for; ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('buyer_consumption')],4); ?></p></td>
					<td width="70" align="right"><p><? 
					$rate=$row[('buyer_rate')];
					echo number_format($row[('buyer_rate')],4); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('buyer_value')],4); ?></p></td>                
                    <td width="70" align="right"><p><? 
					$wash_qnty=$job_qnty*$row[('buyer_consumption')];
					echo number_format($wash_qnty,4); ?></p></td>
					<td width="70" align="right"><p><? 
					$wash_value=$wash_qnty*$rate;
					echo number_format($wash_value,4); ?></p></td>
					<td width="70"></td>
					<td width="70" align="right"><p><? echo number_format($row[('cons')],4); ?></p></td>
					<td width="70" align="right" title="Rate=<? echo $row[('pre_rate')];?>"><p><? echo number_format($row[('pre_rate')],4); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,4); ?></p></td>                
                    <td width="70" align="right"><p><? 
					$wash_req_qty=$row[('cons')]*$job_qnty;
					echo number_format($wash_req_qty,4); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($wash_req_qty*$row[('pre_rate')],4); ?></p></td>
					<td width="70" align="right"><p><? echo number_format($row[('buyer_consumption')]-$row[('cons')],4); ?></p></td>                
                    <td width="70" align="right"><p><? echo number_format($row[('buyer_rate')]-$row[('pre_rate')],4); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($wash_value-($wash_req_qty*$row[('pre_rate')]),4); ?></p></td>
                    
                    </tr>
                    
                    
					<?
						$w++;$ws++;
						$tot_wash_amount+=$row[('amount')];
						$tot_wash_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
						$tot_wash_req_amount+=$wash_req_qty*$row[('pre_rate')];
						$tot_buyer_wash_req_amount+=$wash_value;
						$tot_wash_sourcing_req_amount+=$sourcing_tot_amount;
						$tot_wash_sourcing_req_amount_bal+=$sourcing_tot_amount_bal;
						
					}
					?>
                     
                <tfoot>
					<tr style="font-size:18px; background-color:#CCC">
                        <td colspan="7" align="right"><b>Total wash Cost:</b></td>
						<td  align="right"><b><? echo number_format($tot_buyer_wash_req_amount,6); ?></b></td>
						<td colspan="5" align="right"></td>
                        <td  align="right"><b><? echo number_format($tot_wash_req_amount,6); ?></b></td>
						<td colspan="3" align="right"></td>
                        
                    </tr>
                  </tfoot>
                </table>
                <br>
               
                <table align="left" class="rpt_table"  border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px; text-align:center;" rules="all"> 
                <caption><b style="float:left">Embellishment Cost</b></caption>
				<thead>
				<tr>
					<th  rowspan="2" width="20">SL </th>
                    <th  rowspan="2" title="Fabric">ITEM DESCRIPTION </th>
					<th  rowspan="2">UOM </th>
					<th  colspan="5">Buyer Costing</th>
					<th width="70" ></th>
					<th  colspan="5">Internal/Booking Costing</th>
					<th  rowspan="2" >Cons. Variation / Pcs</th>
                    <th  rowspan="2" >Rate Variation / Pcs </th>
					<th  rowspan="2">Total Variation</th>
				</tr>
                <tr>
                    <th  width="70">Cons/Pcs</th>
					<th  width="70">Rate(USD)</th>
					<th  width="70">Value/Pcs</th>
					<th  width="70">Req. Qty</th>
                    <th  width="70">Total Emb. Cost</th>
					<th width="70"></th>
					<th  width="70">Cons/Pcs</th>
					<th  width="70">Rate(USD)</th>
					<th  width="70">Value/Pcs</th>
					<th  width="70">Req. Qty</th>
                    <th  width="70">Total Emb. Cost</th>
                 </tr>
                    </thead>
                      
                    <?
					$em=1;$tot_embro_amount=$tot_embro_amount_pcs=$tot_embro_req_amount=$tot_emb_sourcing_req_amount=$tot_emb_sourcing_req_amount_bal=0;$emb=1;$emb_value=$emb_qnty=0;
                    foreach($p_embro_precost_arr as $embname_id=>$row)
					{
						
						if($w%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
						$emb_nominated_supp_str=""; 
						 $emb_exnominated_suppArr=explode(",",$row[('sourcing_nominated_supp')]);
						 foreach($emb_exnominated_suppArr as $supp)
						 {
							if($emb_nominated_supp_str=="") $emb_nominated_supp_str=$supplier_library_arr[$supp]; else $emb_nominated_supp_str.=','.$supplier_library_arr[$supp];
						 }		
                    ?>
                	<tr bgcolor="<? echo $bgcolor;?>">
                    
                    <td width="20" align="center"><p><? echo $w; ?></p></td>
                    <td width="300"><div style="word-break:break-all"><? $embname_id=explode(", ",$embname_id);echo $embname_id[1]; ?></div></td> 
					<td width="50"><p><? echo $costing_for; ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('buyer_consumption')],4); ?></p></td>
					<td width="70" align="right"><p><? echo number_format($row[('buyer_value')],4); ?></p></td>  
					<td width="70" align="right"><p><? 
					$rate=$row[('buyer_rate')];
					echo number_format($row[('buyer_rate')],4); ?></p></td>
                                
                    <td width="70" align="right"><p><? 
					$emb_qnty=$job_qnty*$row[('buyer_consumption')];
					echo number_format($emb_qnty,4); ?></p></td>
					<td width="70" align="right"><p><? 
					$emb_value=$emb_qnty*$rate;
					echo number_format($emb_value,4); ?></p></td>
					<td width="70"></td>
					<td width="70" align="right"><p><? echo number_format($row[('cons')],4); ?></p></td>
					<td width="70" align="right" title="Rate=<? echo $row[('pre_rate')];?>"><p><? echo number_format($row[('pre_rate')],4); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,4); ?></p></td>                
                    <td width="70" align="right"><p><? echo number_format($row[('req_qty')],4); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('req_qty')]*$row[('pre_rate')],4); ?></p></td>
					<td width="70" align="right"><p><? echo number_format($row[('buyer_consumption')]-$row[('cons')],4); ?></p></td>                
                    <td width="70" align="right"><p><? echo number_format($row[('buyer_value')]-$row[('pre_rate')],4); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($emb_value-($row[('req_qty')]*$row[('pre_rate')]),4); ?></p></td>
                    
                    </tr>
					<?
						$em++;$emb++;
						$tot_emb_amount+=$row[('amount')];
						$tot_emb_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
						$tot_emb_req_amount+=$row[('req_qty')]*$row[('pre_rate')];
						$tot_buyer_emb_req_amount+=$emb_value;
						$tot_emb_sourcing_req_amount+=$sourcing_tot_amount;
						$tot_emb_sourcing_req_amount_bal+=$sourcing_tot_amount_bal;
						
					}
					?>
                     
                    <tfoot>
					<tr style="font-size:18px; background-color:#CCC">
                        <td colspan="7" align="right"><b>Total emb Cost:</b></td>
						<td  align="right"><b><? echo number_format($tot_buyer_emb_req_amount,6); ?></b></td>
						<td colspan="5" align="right"></td>
                        <td  align="right"><b><? echo number_format($tot_emb_req_amount,6); ?></b></td>
						<td colspan="3" align="right"></td>
                        
                    </tr>
                  </tfoot>
                </table>
                <br>
                 
                <table align="left" class="rpt_table"  border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px;" rules="all"> 
                <caption><b style="float:left">Others Components</b></caption>
				<tr>
					<th  rowspan="2" width="20">SL </th>
					<th rowspan="2" title="520"><b>Others Components</b> </th>
					<th colspan="2">Buyer Costing</th>
					<th width="70"></th>
					<th colspan="2">Internal/Booking Costing</th>
					<th colspan="2">Variation</th>
				</tr>
                 <tr>
                   
                    <th width="70"><b>Value/Pcs</b></th>
					<th width="70"><b>Total Gmts Cost</b></th>
					<th width="70"></th>
					<th width="70"><b>Value/Pcs</b></th>
					<th width="70"><b>Total Gmts Cost</b></th>
					<th width="70"><b>Rate Variation/pcs</b></th>
					<th width="70"><b>Total Variation</b></th>
                    
                  
                    </tr>
                    <tbody> 
                    <?
					$bgcolor="#E9F3FF";
					$bgcolor2="#FFFFFF";

					$tot_other_cost_first=$tot_other_cost+$comarcial+$inspection+$currier_pre_cost+$lab_test;					
					$total_other_cost_dzn=$tot_other_cost_dzn+$comarcial_dzn+$inspection_dzn+$lab_test_dzn+$currier_pre_cost_dzn;
					$tot_other_cost_pcs=$tot_other_cost_dzn/$order_price_per_dzn;
					$tot_comarcial_dzn_pcs=$comarcial_dzn/$order_price_per_dzn;
					$tot_inspection_dzn_pcs=$inspection_dzn/$order_price_per_dzn;
					$currier_pre_cost_dzn_pcs=$currier_pre_cost_dzn/$order_price_per_dzn;
					$tot_lab_test_dzn_pcs=$lab_test_dzn/$order_price_per_dzn;
					$total_other_cost_pcs=$tot_other_cost_pcs+$tot_comarcial_dzn_pcs+$tot_lab_test_dzn_pcs+$tot_inspection_dzn_pcs+$currier_pre_cost_dzn_pcs;
					$total_other_buyer_cost=$tot_fright_cost+$tot_miscellaneous_cost+$tot_other_buyer_cost;
					$tot_other_cost_req_amount=$tot_other_cost_first;
						
					
					?>
                	<tr bgcolor="<? echo $bgcolor;?>">
                    
                    <td width="20" align="center"><p>1</p></td>
                    <td width="520" align="" ><b>Lab Test Charge</b></td> 
                    <td width="70" align="right"><p><? echo number_format($tot_lab_test_cost,4); ?>&nbsp;</p></td>
					<td width="70" align="right"><p><? echo number_format($tot_lab_test_cost*$job_qnty,4); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($tot_lab_test_dzn_pcs,4); ?>&nbsp;</p></td>
					<td width="70" align="right"><p><? echo number_format($lab_test,4); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($tot_lab_test_cost-$tot_lab_test_dzn_pcs,4); ?>&nbsp;</p></td>
					<td width="70" align="right"><p><? echo number_format(($tot_lab_test_cost*$job_qnty)-$lab_test,4); ?>&nbsp;</p></td>
                    
                    
                    </tr>
                     <td width="20" align="center" ><p>2</p></td>
                    <td width="520"><b>Courier Charge</b></td> 
                    <td width="70" align="right"><p><?  echo number_format($tot_courier_cost,4); ?>&nbsp;</p></td>
					<td width="70" align="right"><p><?  echo number_format($tot_courier_cost*$job_qnty,4); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p>&nbsp;</p></td>
					<td width="70" align="right"><p><? echo number_format($currier_pre_cost_dzn_pcs,4); ?>&nbsp;</p></td>
					<td width="70" align="right"><p><? echo number_format($currier_pre_cost,4); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($tot_courier_cost-$currier_pre_cost_dzn_pcs,4); ?>&nbsp;</p></td>
					<td width="70" align="right"><p><? echo number_format(($tot_courier_cost*$job_qnty)-$currier_pre_cost,4); ?>&nbsp;</p></td>
                   
                    </tr>
                    
                    <tr bgcolor="<? echo $bgcolor2;?>">
                    
                    <td width="20" align="center" ><p>3</p></td>
                    <td width="520"><b>Inspection Charge</b></td> 
                    <td width="70" align="right"><p><? echo number_format($inspection_cost,4); ?>&nbsp;</p></td>
					<td width="70" align="right"><p><? echo number_format($inspection_cost*$job_qnty,4); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p>&nbsp;</p></td>
					<td width="70" align="right"><p><? echo number_format($tot_inspection_dzn_pcs,4); ?>&nbsp;</p></td>
					<td width="70" align="right"><p><? echo number_format($inspection,4); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($inspection_cost-$tot_inspection_dzn_pcs,4); ?>&nbsp;</p></td>
					<td width="70" align="right"><p><? echo number_format(($inspection_cost*$job_qnty)-$inspection,4); ?>&nbsp;</p></td>
                    </tr>
                    
                    <tr bgcolor="<? echo $bgcolor;?>">
                    
                    <td width="20" align="center" ><p>4</p></td>
                    <td width="520"><b>Commercial Charge</b></td> 
                    <td width="70" align="right"><p><?  echo number_format($commercial_cost,4); ?>&nbsp;</p></td>
					<td width="70" align="right"><p><?  echo number_format($commercial_cost*$job_qnty,4); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p>&nbsp;</p></td>
					<td width="70" align="right"><p><? echo number_format($tot_comarcial_dzn_pcs,4); ?>&nbsp;</p></td>
					<td width="70" align="right"><p><? echo number_format($comarcial,4); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($commercial_cost-$tot_comarcial_dzn_pcs,4); ?>&nbsp;</p></td>
					<td width="70" align="right"><p><? echo number_format(($commercial_cost*$job_qnty)-$comarcial,4); ?>&nbsp;</p></td>
                       
                    </tr>
                    <tr bgcolor="<? echo $bgcolor2;?>">
                     
                    <td width="20" align="center"><p>5</p></td>
                    <td width="520" title="Freight+Certif.Cost+Design Cost+Studio Cost+Deprec.&Amort.+Operating Expenses+Deprec.&Amort.+Interest+Income Tax">
                    <b>Others Charge</b></td> 
                    <td width="70" align="right"><p><? echo number_format($total_other_buyer_cost,4); ?>&nbsp;</p></td>
					<td width="70" align="right"><p><? echo number_format($total_other_buyer_cost*$job_qnty,4); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p>&nbsp;</p></td>
					<td width="70" align="right"><p><? echo number_format($tot_other_cost_pcs,4); ?>&nbsp;</p></td>
					<td width="70" align="right"><p><? echo number_format($tot_other_cost,4); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($total_other_buyer_cost-$tot_other_cost_pcs,4); ?>&nbsp;</p></td>
					<td width="70" align="right"><p><? echo number_format(($total_other_buyer_cost*$job_qnty)-$tot_other_cost,4); ?>&nbsp;</p></td>
                    </tr>
                    </tbody>
                    <tfoot>
                     <tr style="font-size:20px; background-color:#CCC">
                         <?
						 $total_buyer_other_cost=$total_other_buyer_cost+$commercial_cost+$inspection_cost+$tot_courier_cost+$tot_lab_test_cost;
						 ?>
                        <td align="right" colspan="2"> <b>Total Others Cost:</b></td>
                        <td  align="right"><b><? echo number_format( $total_buyer_other_cost,4); ?>&nbsp;</b></td>
						<td  align="right"><b><? echo number_format( $total_buyer_other_cost*$job_qnty,4); ?>&nbsp;</b></td>
                        <td  align="right"><b>&nbsp;</b></td>
						<td  align="right"><b><? echo number_format($total_other_cost_pcs,4); ?>&nbsp;</b></td>
						<td  align="right"><b><? echo number_format($tot_other_cost_req_amount,4); ?>&nbsp;</b></td>
                        <td  align="right"><b><? echo number_format( $total_buyer_other_cost-$total_other_cost_pcs,4); ?>&nbsp;</b></td>
						<td  align="right"><b><? echo number_format(( $total_buyer_other_cost*$job_qnty)-$tot_other_cost_req_amount,4); ?>&nbsp;</b></td>
                        
                        
                     
                        
                    </tr>
                  </tfoot>
                </table>
                <br>
             
                 <table align="left" border="1" class="rpt_table"  cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px;" rules="all"> 
                <caption><b style="float:left"> Commission Cost:</b></caption>
				<tr>
					<th  rowspan="2" width="20">SL </th>
					<th rowspan="2" title="520"><b>Others Components</b> </th>
					<th colspan="2">Buyer Costing</th>
					<th width="70"></th>
					<th colspan="2">Internal/Booking Costing</th>
					<th colspan="2">Variation</th>
				</tr>
                 <tr>
                   
				 	<th width="70"><b>Value/Pcs</b></th>
					<th width="70"><b>Total Gmts Cost</b></th>
					<th width="70"></th>
					<th width="70"><b>Value/Pcs</b></th>
					<th width="70"><b>Total Gmts Cost</b></th>
					<th width="70"><b>Rate Variation/pcs</b></th>
					<th width="70"><b>Total Variation</b></th>
                    
                  
                    </tr>
                    <tbody> 
                    <?
                     
						$tot_commission_amount=$commission_arr[1]['commi_amt']+$commission_arr[2]['commi_amt'];
						$tot_commission_amount_pcs=($commission_arr[1]['commi_amt']/$order_price_per_dzn)+($commission_arr[2]['commi_amt']/$order_price_per_dzn);
						$tot_commision_req_amount=$commission_arr[1]['commi_req_amt']+$commission_arr[2]['commi_req_amt'];
						$total_buyer_commission+=$buyer_commission;
						$job_buyer_commission=$buyer_commission*$job_qnty;
						$total_job_buyer_commission+=$job_buyer_commission;
						
						$local_value=$commission_arr[2]['commi_amt']/$order_price_per_dzn;
						$foreign_value=$commission_arr[1]['commi_amt']/$order_price_per_dzn;

						$local_cost=$commission_arr[2]['commi_req_amt'];
						$foreign_cost=$commission_arr[1]['commi_req_amt'];
					
					?>
					 
                   <tr bgcolor="<? echo $bgcolor;?>">
                    
                    <td width="20" align="center"><p>1</p></td>
                    <td width="520" ><b>Local </b></td> 
                   
					<td width="70" align="right" rowspan="2"><p><? echo number_format($buyer_commission,4); ?>&nbsp;</p></td>
					<td width="70" align="right" rowspan="2"><p><? echo number_format($job_buyer_commission,4); ?>&nbsp;</p></td>
					<td width="70" align="right"><p>&nbsp;</p></td>
					<td width="70" align="right"><p><? echo number_format($local_value,4); ?>&nbsp;</p></td>
					<td width="70" align="right"><p><? echo number_format($local_cost,4); ?>&nbsp;</p></td>
					<td width="70" align="right"><p><? 
					if($local_value>0){
						echo number_format(($buyer_commission-$local_value),4);
					}else{
						echo 0.0000 ;
					} ?>&nbsp;</p></td>
					<td width="70" align="right"><p><? 
					if($local_cost>0){
						echo number_format(($job_buyer_commission-$local_cost),4);
					}else{
						echo 0.0000 ;
					} ?>&nbsp;</p></td>
                    
                    </tr>

                    <tr bgcolor="<? echo $bgcolor2;?>">                     
						<td width="20" align="center"><p>2</p></td>
						<td width="520" ><b>Foreign</b></td> 
						<td width="70" align="right"><p>&nbsp;</p></td>
						<td width="70" align="right"><p><? echo number_format($foreign_value,4); ?>&nbsp;</p></td>
						<td width="70" align="right"><p><? echo number_format($foreign_cost,4); ?>&nbsp;</p></td>
						<td width="70" align="right"><p><? 
							if($foreign_value>0){
								echo number_format(($buyer_commission-$foreign_value),4);
							}else{
								echo 0.0000 ;
							} ?>&nbsp;</p></td>
						<td width="70" align="right"><p><? 
							if($foreign_cost>0){
								echo number_format(($job_buyer_commission-$foreign_cost),4);
							}else{
								echo 0.0000 ;
							} ?>&nbsp;</p></td>
                    </tr>
					
                    </tbody>
                    <tfoot>
                    <tr>
                        <td align="right" colspan="2"> <b>Total Commission Cost:</b></td>
                        <td  align="right"><b><? echo number_format($total_buyer_commission,4); ?>&nbsp;</b></td>
						<td  align="right"><b><? echo number_format($total_job_buyer_commission,4); ?>&nbsp;</b></td>
						<td width="70" align="right"><p>&nbsp;</p></td>
						<td width="70" align="right"><p><? echo number_format($tot_commission_amount_pcs,4); ?>&nbsp;</p></td>
						<td width="70" align="right"><p><? echo number_format($tot_commision_req_amount,4); ?>&nbsp;</p></td>
						<td width="70" align="right"><p><? echo number_format($total_buyer_commission-$tot_commission_amount_pcs,4); ?>&nbsp;</p></td>
						<td width="70" align="right"><p><? echo number_format($total_job_buyer_commission-$tot_commision_req_amount,4); ?>&nbsp;</p></td>
                    </tr>
                    

                   
                  </tfoot>
                </table>
                
             </td>
              </tr>
              
           </table>
          
		   <div style="float:left" align="left">  <b> &nbsp;&nbsp;&nbsp;&nbsp; <? //echo $inserted_by;?> </b></div>
        <div style="clear:both"></div>
        <? 
		$cbo_company_name=str_replace("'","",$cbo_company_name);
		if ($cbo_template_id != '') {
			$template_id = " and a.template_id=$cbo_template_id ";
		}
		 
		$path=($path!='')?$path:"../../";
		//$inserted_by=return_field_value("inserted_by", "wo_pre_cost_mst", "job_no='".str_replace("'","",$txt_job_no)."'");
		$job_info=sql_select("SELECT id, inserted_by from wo_pre_cost_mst where status_active=1 and is_deleted=0 and job_no='".str_replace("'","",$txt_job_no)."'");
		foreach ($job_info as $row) {
			$inserted_by=$row[csf('inserted_by')];
			$job_id=$row[csf('id')];
		}
		
	   $signature_arr=return_library_array( "select master_tble_id,image_location from common_photo_library where form_name='user_signature'",'master_tble_id','image_location');
		$appSql="select approved_by from approval_history where entry_form=46 and mst_id = $job_id and is_signing=1";
		$appSqlRes=sql_select($appSql);
		foreach($appSqlRes as $row){
			$userSignatureArr[$row[csf('approved_by')]]=$path.$signature_arr[$row[csf('approved_by')]];	
		}
		$userSignatureArr[$inserted_by]=$path.$signature_arr[$inserted_by];

		echo signature_table(218, $cbo_company_name, "1200px",$cbo_template_id,50,$inserted_by,$userSignatureArr);
		?>            
     </div>
     <div style="clear:both"></div>
     
    <?
	$mailBody=ob_get_contents();
	ob_clean();
	echo $mailBody;

	//Mail send------------------------------------------
	list($msil_address,$is_mail_send,$mail_body)=explode('**',$mail_data);
	if($is_mail_send==1){
	
		require_once('../../../mailer/class.phpmailer.php');
		require_once('../../../auto_mail/setting/mail_setting.php');
		
		$mailBody = preg_replace("/<img[^>]+\>/i", " ", $mailBody); 	
		$mailToArr=array();
		if($msil_address){$mailToArr[]=$msil_address;}
			
		$mailSql = "SELECT c.TEAM_LEADER_EMAIL, d.USER_EMAIL
  FROM wo_po_details_master  a,  wo_pre_cost_mst b, lib_marketing_team c, USER_PASSWD d
 WHERE a.job_no = b.job_no  AND a.TEAM_LEADER = c.id AND b.INSERTED_BY = d.id AND a.status_active = 1  AND a.job_no=$txt_job_no";
		
		//echo $mailSql;die;
		
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows['TEAM_MEMBER_EMAIL']){$mailToArr[$rows['TEAM_LEADER_EMAIL']]=$rows['TEAM_LEADER_EMAIL'];}
			if($rows['USER_EMAIL']){$mailToArr[$rows['USER_EMAIL']]=$rows['USER_EMAIL'];}
		}
		
		//$elcetronicSql = "SELECT a.SEQUENCE_NO,a.BYPASS,b.USER_EMAIL  from electronic_approval_setup a join user_passwd b on a.user_id=b.id where b.valid=1 and a.page_id=2150 and a.entry_form=46 and a.company_id=$cbo_company_name order by a.SEQUENCE_NO";
		
		$elcetronicSql = "SELECT a.BUYER_ID,a.SEQUENCE_NO,a.BYPASS,b.USER_EMAIL  from electronic_approval_setup a join user_passwd b on a.user_id=b.id where b.valid=1  AND a.page_id in(428,1717,2150) and a.company_id=$cbo_company_name order by a.SEQUENCE_NO"; //and a.page_id=2150 and a.entry_form=46
		//echo $elcetronicSql;die;
		
		$elcetronicSqlRes=sql_select($elcetronicSql);
		foreach($elcetronicSqlRes as $rows){
			
			
			if($rows[BUYER_ID]!=''){
				foreach(explode(',',$rows[BUYER_ID]) as $bi){
					if($rows['USER_EMAIL']!='' && $bi==$buyer_name_id){$mailToArr[$rows['USER_EMAIL']]=$rows['USER_EMAIL'];}
					if($rows[BYPASS]==2){break;}
				}
			}
			else{
				if($rows['USER_EMAIL']){$mailToArr[$rows['USER_EMAIL']]=$rows['USER_EMAIL'];}
				if($rows[BYPASS]==2){break;}
			}
			
			
			
		}
		
		
		//Un-approve request mail......................................................
		$user_id=$_SESSION['logic_erp']['user_id'];
		$job_id=return_field_value("id", "wo_pre_cost_mst", "job_no='".str_replace("'","",$txt_job_no)."'");
		$approved_no=return_field_value("MAX(approved_no) as approved_no","approval_history","entry_form=46 and mst_id=$job_id","approved_no")+1;
		$unapproved_request=return_field_value("APPROVAL_CAUSE","fabric_booking_approval_cause","entry_form=46 and user_id=$user_id and booking_id=$job_id and approval_type=2 and approval_no='$approved_no'");//page_id=$page_id and
		if($unapproved_request){
			$mailToArr=array();
			if($msil_address){$mailToArr[]=$msil_address;}
			$final_app_user_mail=return_field_value("USER_EMAIL","user_passwd","id in(select APPROVED_BY from APPROVAL_HISTORY where id in(select max(id) from APPROVAL_HISTORY where mst_id=$job_id and ENTRY_FORM=46 and CURRENT_APPROVAL_STATUS=1))");
			$mailToArr[]= $final_app_user_mail;
		}
		$mailBody=$mail_body."<br>".$unapproved_request."<br>".$mailBody;
		//......................................................Un-approve request mail;


		
		$to=implode(',',$mailToArr);
		//echo $to;die;
		 
		
		//Att file....
		$imgSql="select IMAGE_LOCATION,REAL_FILE_NAME from common_photo_library where is_deleted=0  and MASTER_TBLE_ID=$txt_job_no and file_type=1";
		$imgSqlResult=sql_select($imgSql);
		foreach($imgSqlResult as $rows){
			$att_file_arr[]='../../../'.$rows[IMAGE_LOCATION].'**'.$rows[REAL_FILE_NAME];
		}
		
		$subject="BOM Pre Cost Report";
		$header=mailHeader();
		echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
		
	}
	
	//------------------------------------End;
	
	exit();
}


if($action == "bom_pcs_woven") //BOM PCS BTN 18
{
   	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if($txt_job_no==""){
		$job_no='';
	}else{
		$job_no=" and a.job_no=".$txt_job_no."";
	}

	if($cbo_company_name=="") {
		$company_name='';
	} else {
		 $company_name=" and a.company_name=".$cbo_company_name."";
	}

	if($cbo_buyer_name==""){
		 $cbo_buyer_name='';
	} else {
		$cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	}

	if($txt_style_ref==""){
		 $txt_style_ref='';
	} else {
		$txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	}

	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($txt_costing_date=="") {
		$txt_costing_date='';
	} else {
		$txt_costing_date=" and b.costing_date='".$txt_costing_date."'";
	}
	$txt_po_breack_down_id=str_replace("'",'',$txt_po_breack_down_id);
	if(str_replace("'",'',$txt_po_breack_down_id)==""){
		$txt_po_breack_down_id_cond='';
	}
	else{
		$txt_po_breack_down_id_cond=" and d.id in(".$txt_po_breack_down_id.")";
	}
    //if($txt_quotation_date=="") $txt_quotation_date=''; else $txt_quotation_date=" and a.quot_date ='".$txt_quotation_date."'";
	$imge_arr=return_library_array( "select master_tble_id,image_location from common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	

    $buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
    $season_name_arr=return_library_array( "select id, season_name from lib_buyer_season",'id','season_name');
    $comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	 $user_passArr=return_library_array( "select id, user_name from user_passwd",'id','user_name');
	 $brand_arr=return_library_array( "select id, brand_name from  lib_buyer_brand where status_active=1 and is_deleted=0",'id','brand_name');
	 //pro_ex_factory_mst 
	 $sql_ex="select max(ex_factory_date) as ex_factory_date from pro_ex_factory_mst b,wo_po_break_down d where d.id=b.po_break_down_id and d.job_no_mst=$txt_job_no and d.status_active=1";
	  $exf_data_array=sql_select($sql_ex);
	 foreach( $exf_data_array as $row)
	 {
		 	$ex_factory_date=$row[csf("ex_factory_date")];
	 }
	 $excess_cut=0;
	  $sql_excess="select b.excess_cut_perc from wo_po_color_size_breakdown b,wo_po_break_down d where d.id=b.po_break_down_id and d.job_no_mst=$txt_job_no and b.status_active=1 and d.status_active=1";
	  $excess_data_array=sql_select($sql_excess);
	 foreach( $excess_data_array as $row)
	 {
		 $excess_cut=$row[csf("excess_cut_perc")];
	 }
	 
	$sql_po="select  a.total_set_qnty as ratio,d.po_number,(d.po_quantity) as po_qnty,d.plan_cut, d.excess_cut,d.unit_price, d.pub_shipment_date,d.po_received_date,d.pack_handover_date  from wo_po_break_down d,wo_po_details_master a where   d.job_no_mst=a.job_no and d.job_no_mst=$txt_job_no and d.status_active=1 $txt_po_breack_down_id_cond";
	 $po_data_array=sql_select($sql_po);
	 	$order_job_qnty=0;$plan_cut=0;$leadtime_days_remian_cal="";
	 foreach( $po_data_array as $row)
	 {
		 	$po_received_dateArr.=$row[csf("po_received_date")].',';
			$pack_handover_dateArr.=$row[csf("pack_handover_date")].',';
			$order_job_qnty+=$row[csf("po_qnty")]*$row[csf("ratio")];
			 
			$plan_cut+=$row[csf("plan_cut")]*$row[csf("ratio")];
			$days_tot=datediff('d',$row[csf("po_received_date")],$row[csf("pub_shipment_date")])-1;
			 $leadtime_days_remian_cal.=$days_tot.',';
	 }
	  $leadtime_days_remian_calArr=rtrim($leadtime_days_remian_cal,',');
	 $leadtime_days_remian_calArr=explode(",",$leadtime_days_remian_calArr);
	 $leadtime_days_remian=max($leadtime_days_remian_calArr);
	  
	  
	 $po_received_dateArr=rtrim($po_received_dateArr,',');
	 $po_received_dateArr=explode(",",$po_received_dateArr);
	  $po_received_date=max($po_received_dateArr);
	 $pack_handover_dateArr=rtrim($pack_handover_dateArr,',');
	 $pack_handover_dateArr=explode(",",$pack_handover_dateArr);
	 $pack_handover_date=max($pack_handover_dateArr);
	 
	// $leadtime_days_remian=datediff('d',$po_received_date,$ex_factory_date)-1;
	 
	 $sql = "select a.job_no,a.company_name,a.buyer_name,a.quotation_id,a.season_buyer_wise,a.season_year,a.brand_id,a.style_ref_no,a.set_smv, a.gmts_item_id, a.order_uom, a.job_quantity, a.avg_unit_price,b.costing_date,b.sourcing_date, b.costing_per, c.fab_knit_req_kg, c.fab_woven_req_yds, c.fab_yarn_req_kg, a.total_set_qnty as ratio,a.working_company_id from wo_po_details_master a, wo_pre_cost_mst b,wo_pre_cost_sum_dtls c  where a.job_no=b.job_no and b.job_no=c.job_no and a.status_active=1 and a.job_no=$txt_job_no $company_name $cbo_buyer_name $txt_style_ref";
          // echo $sql;
    $data_array=sql_select($sql);
	$working_company_arr=return_library_array("SELECT id,company_name from lib_company ","id","company_name");  
	$working_company='';
	foreach ($data_array as $row)
			{
				$working_company=$working_company_arr[$row[csf("working_company_id")]];
			}
    if(empty($path))
    {
    	$path="../../";
    }
    else{
    	$path=str_replace("'", "", $path);
    }
    //echo $path;

	ob_start();
    ?>
    <div style="width:1320px" align="center">  
      <style>
	 /* p{ padding:0px !important; margin:0px !important;}*/
	</style>
      <table width="100%" cellpadding="0"  class="rpt_table"  cellspacing="0" style="border:1px solid black" rules="all">
           <tr>
               <td width="100"> 
               <img src='<? echo $path .''. $imge_arr[str_replace("'","",$cbo_company_name)]; ?>' height='100%' width='100%' />
               </td>
               <td width="1250">                                     
                    <table width="100%" cellpadding="0"  cellspacing="0" >
                        <tr >
                            <td align="center" style="font-size:20px;">
                            <b>  <?php      
                                    echo 'BOM Pre Cost Report';
                              ?>
                              </b>
							  <b style="font-size:21px;margin-left:80%">Revised no: <?
									$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_pre_cost_mst a, approval_history b where a.id=b.mst_id and b.mst_id=$mst_id and b.entry_form=46");
										if(isset($nameArray_approved[0][csf('approved_no')]) ){
											if($nameArray_approved[0][csf('approved_no')] >1){
												echo $nameArray_approved[0][csf('approved_no')] - 1;;
											}else{
												echo $nameArray_approved[0][csf('approved_no')] ;
											}
										}
									 ?>
                              </b>
							
                        </tr>
                      </table>
					  <br>
					  <table width="100%"   border="0"    cellpadding="0" cellspacing="0">
                        <tr align="center">
                            <td> <b style="font-size:21px;"> PO Rec Unit: </b><span style="font-size:19px;"><?  echo $comp[str_replace("'","",$cbo_company_name)];?> </span></td>
							
							<td ><b style="font-size:21px;">Prod Unit: </b><span style="font-size:19px;"><?echo $working_company;?></span></td>
							
                        </tr>
                      </table>
                </td>       
            </tr>
       </table>
       <br>
            <?
             $order_price_per_dzn=0;
		
			foreach ($data_array as $row)
			{
				
				$avg_unit_price=$row[csf("avg_unit_price")];
				$sourcing_date=$row[csf("sourcing_date")];
				$buyer_name_id=$row[csf("buyer_name")];
			
			 
				$order_values = $order_job_qnty*$avg_unit_price;
				 if($row[csf("costing_per")]==1){$order_price_per_dzn=12;$costing_val=" DZN";}
					else if($row[csf("costing_per")]==2){$order_price_per_dzn=1;$costing_val=" PCS";}
					else if($row[csf("costing_per")]==3){$order_price_per_dzn=24;$costing_val=" 2 DZN";}
					else if($row[csf("costing_per")]==4){$order_price_per_dzn=36;$costing_val=" 3 DZN";}
					else if($row[csf("costing_per")]==5){$order_price_per_dzn=48;$costing_val=" 4 DZN";}
				
					$quot_id=$row[csf("quotation_id")];
					$sew_smv=$row[csf("set_smv")];
					$inserted_by=$user_passArr[$row[csf("inserted_by")]];
					 
				?>
						<table align="left" border="0" cellpadding="0" cellspacing="0" style="width:550px; margin:5px;">
                        <tr>
                        <td>
                        
                        <table align="left" border="1"  class="rpt_table"  cellpadding="1" cellspacing="1" style="width:550px; margin:5px;" rules="all">
							<tr>
								<td width="80">Job No</td>
								<td width="80"><b><? echo $row[csf("job_no")]; ?></b></td>
								<td width="90">Costing </td>
								
								</tr>
							<tr>
                            <tr>
								<td width="80">Quotation ID</td>
								<td width="80"><b><? echo $quot_id; ?></b></td>
								<td width="100"><b><? echo $costing_per[$row[csf("costing_per")]]; ?></b></td>
							</tr>
                            <tr>
							<td> Costing Date :  </td>
							<td colspan="2"><b><? echo $row[csf("costing_date")]; ?></b></td>
							</tr>
                             
							<tr>
								<td>Buyer </td>
								<td colspan="2"><b><? echo $buyer_arr[$row[csf("buyer_name")]];
								
								if($row[csf("brand_id")]>0)
								{
									echo '('.$brand_arr[$row[csf("brand_id")]].')';
								}
								
								
								?></b></td>
							 </tr> 
							 <tr>
								<td>Style </td>
								<td colspan="2"><b><? echo $row[csf("style_ref_no")]; ?></b></td>
							 </tr>
							<tr>
								<td width="80">Item</td>
								<?
									if($row[csf("order_uom")]==1)
									{
									  $grmnt_items=$garments_item[$row[csf("gmts_item_id")]];
									}
									else
									{
										$gmt_item=explode(',',$row[csf("gmts_item_id")]);
										foreach($gmt_item as $key=>$val)
										{
											$grmnt_items .=$garments_item[$val].", ";
										}
									}
								?>
								<td width="100" colspan="2"><b><? echo $grmnt_items; ?></b></td>
							</tr>
							<tr>
								<td>Season</td>
								<td colspan="2"><b><? echo $season_name_arr[$row[csf('season_buyer_wise')]].'-'.substr( $row[csf('season_year')], -2);  ?></b></td>
							 </tr>
							<tr>
								<td>P.O. Qnty</td>
								<td><b><?  echo $order_job_qnty.' Pcs';
								$po_qty_dzn=$order_job_qnty/$order_price_per_dzn;
								 ?></b></td>
								<td  title="<? echo $offer_qty_dzn;?>"><b><?// echo number_format($po_qty_dzn,0).' '.$costing_val; ?></b></td>
							</tr>
							
							  <tr>
								<td>Plan Cut Qnty(<? echo $excess_cut.'%';?>)</td>
								<td><b><? echo $plan_cut.' Pcs';
								$offer_qty_dzn=$plan_cut/$order_price_per_dzn;
								 ?></b></td>
								<td  title="<? echo $offer_qty_dzn;?>"><b><?// echo number_format($offer_qty_dzn,0).' '.$costing_val; ?></b></td>
							</tr>
						</table>
                        </td>
              <?
			} //master part end
		//	die;
           $condition= new condition();
			if(str_replace("'","",$txt_job_no) !=''){
				$condition->job_no("=$txt_job_no");
			}
			if(str_replace("'",'',$txt_po_breack_down_id) !="")
			{
				$condition->po_id("in($txt_po_breack_down_id)");
			}
			$condition->init();
			$fabric= new fabric($condition);
			$trim= new trims($condition);
			$wash= new wash($condition);
			$emblishment= new emblishment($condition);
			//echo $fabric->getQuery();die;
			$fabric_qty_arr=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
			//print_r($fabric_qty_arr);
			$fabric_amount_arr=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
			
			$trim_amount_arr=$trim->getAmountArray_precostdtlsid();
			$trim_qty_arr=$trim->getQtyArray_by_precostdtlsid();
			
			$emblishment_qtyArr=$emblishment->getQtyArray_by_jobAndEmblishmentid();
			$emblishment_amountArr=$emblishment->getAmountArray_by_jobAndEmblishmentid();
			$wash_qtyArr=$wash->getQtyArray_by_jobAndEmblishmentid();
		//	print_r($wash_qtyArr);
			$wash_amountArr=$wash->getAmountArray_by_jobAndEmblishmentid();
	           
			$sql_determin=sql_select("select a.id,a.type from lib_yarn_count_determina_mst a where  a.status_active=1  and a.entry_form=426");
			foreach($sql_determin as $row)
			{
				$determin_type_arr[$row[csf('id')]]=$row[csf('type')];	
			}
			
			
			// $pri_fab_arr="select a.quotation_id,b.fabric_source,b.lib_yarn_count_deter_id as deter_min_id,b.fabric_description as fab_desc,b.fabric_description,b.body_part_id,b.gsm_weight,b.uom, a.rate,a.amount, (a.requirment) as requirment,a.cons, (a.pcs) as pcs,a.process_loss_percent as p_loss from wo_pri_quo_fab_co_avg_con_dtls a,wo_pri_quo_fabric_cost_dtls  b where a.wo_pri_quo_fab_co_dtls_id=b.id and a.quotation_id=b.quotation_id  and b.status_active=1 and b.is_deleted=0 and a.quotation_id=$quot_id ";//and b.fabric_source=2
			//$pri_fab_result=sql_select($pri_fab_arr);
			
			  $pre_fab_arr="select  b.id, b.job_no,b.body_part_id,b.lib_yarn_count_deter_id as deter_min_id, b.fab_nature_id, b.color_type_id, b.fabric_description as fab_desc,b.uom,b.avg_cons,b.avg_cons_yarn, b.avg_process_loss,b.construction,b.composition,b.fabric_source,b.gsm_weight, b.rate,b.amount,b.avg_finish_cons,b.sourcing_rate,b.sourcing_nominated_supp from wo_pre_cost_fabric_cost_dtls  b where  b.status_active=1 and b.is_deleted=0 and b.job_no=$txt_job_no order by b.id ";//and b.fabric_source=2
			  //echo $pre_fab_arr; die;
			$pre_fab_result=sql_select($pre_fab_arr);
			
			$summ_fob_pcs=0;$summ_fob_gross_value_amt=$summ_sourcing_tot_budget_dzn_val=0;
			foreach($pre_fab_result as $row)
			{
				$determin_type=$determin_type_arr[$row[csf('deter_min_id')]];
				$body_partId=$body_part[$row[csf('body_part_id')]];
				//$fab_desc=$body_partId.','.$row[csf('fab_desc')];
				$fab_desc=$row[csf('fab_desc')];
				//echo $determin_type.'d';
				$tot_amt=$row[csf('avg_cons')]*$row[csf('rate')];
				$fab_req_qty=$fabric_qty_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]]+$fabric_qty_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$fab_req_amount=$fabric_amount_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]]+$fabric_amount_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$fab_cost_dtls_id=$row[csf('id')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['req_qty']+=$fab_req_qty;
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['req_amount']+=$fab_req_amount;
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['cons']+=$row[csf('avg_finish_cons')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['tot_cons']+=$row[csf('avg_cons')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['amount']+=$row[csf('amount')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['p_loss']=$row[csf('avg_process_loss')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['sourcing_nominated_supp']=$row[csf('sourcing_nominated_supp')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['sourcing_rate']=$row[csf('sourcing_rate')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['fab_desc']=$row[csf('construction')].','.$row[csf('composition')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['uom']=$unit_of_measurement[$row[csf('uom')]];
				$p_fab_precost_tot_row+=1;	
				//Summary
				$summ_fob_pcs+=$row[csf('amount')];
			//	$summ_sourcing_tot_budget_dzn_val+=$fab_req_qty*$row[csf('sourcing_rate')];
				
				$summ_fob_gross_value_amt+=$fab_req_amount;
			}
		  $pre_trim_consarr="select b.id,c.trim_type,c.item_name,b.description,b.trim_group,b.cons_dzn_gmts,b.seq,b.cons_uom as uom,avg(d.excess_per) as  excess_per from wo_pre_cost_trim_cost_dtls b,lib_item_group c,wo_pre_cost_trim_co_cons_dtls d where  c.id=b.trim_group and b.id=d.wo_pre_cost_trim_cost_dtls_id and c.trim_type in(1,2) and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and b.job_no=$txt_job_no group by b.id,c.trim_type,c.item_name,b.description,b.trim_group,b.cons_dzn_gmts,b.cons_uom,b.seq order by b.seq";
		$pre_trim_cons_result=sql_select($pre_trim_consarr);
			foreach($pre_trim_cons_result as $row)
			{
				$trims_type=$row[csf('trim_type')];
				
				
				$description=$row[csf('description')];
				if($description!="") $descriptionCond=", ".$description; else $descriptionCond="";
				$item_id=$row[csf('item_name')].$descriptionCond;
				if($trims_type==1) //Sewing
				{
						$p_sew_trim_precost_excess_arr[$item_id]['p_loss']+=$row[csf('excess_per')];
				}
				else
				{
						$p_fin_trim_precost_excess_arr[$item_id]['p_loss']+=$row[csf('excess_per')];;
				}
				
			}
			
			
			//  $pre_trim_arr="select b.seq,b.id,c.trim_type,c.item_name,b.description,b.trim_group,b.tot_cons,b.ex_per ,b.cons_dzn_gmts,b.cons_uom as uom, b.rate,b.amount,b.sourcing_rate,b.sourcing_nominated_supp from wo_pre_cost_trim_cost_dtls b,lib_item_group c where  c.id=b.trim_group and c.trim_type in(1,2) and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and b.job_no=$txt_job_no order by b.seq";//and b.fabric_source=2

			 $pre_trim_arr="select b.seq,b.id,c.trim_type,c.item_name,b.description,b.trim_group,b.tot_cons,b.ex_per ,b.cons_dzn_gmts,b.cons_uom as uom, b.rate,b.amount,b.sourcing_rate,b.sourcing_nominated_supp from wo_pre_cost_trim_cost_dtls b,lib_item_group c where  c.id=b.trim_group  and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and b.job_no=$txt_job_no order by b.seq";//and b.fabric_source=2

			$pre_trim_result=sql_select($pre_trim_arr);
			
			$p_sew_trim_precost_arr=$p_fin_trim_precost_arr=array();
		
			//print_r($p_sew_trim_precost_arr2);
			
		
			 $pre_wash_arr="select b.job_no,b.id,b.emb_name,b.emb_type,b.cons_dzn_gmts, b.rate,b.amount,b.sourcing_rate,b.sourcing_nominated_supp from wo_pre_cost_embe_cost_dtls  b where  b.status_active=1 and b.is_deleted=0  and b.job_no=$txt_job_no  order by b.emb_name";//and b.fabric_source=2
			$pre_wash_result=sql_select($pre_wash_arr);
			
		//	$summ_sourcing_tot_budget_dzn_val=0;
		 
			foreach($pre_wash_result as $row)
			{
				$emb_name_id=$row[csf('emb_name')];
				$emb_type=$row[csf('emb_type')];
			
				//emblishment_embroy_type_arr
				if($emb_name_id==1) //Print type
				{
					if($emb_type>0) $emb_typeCond=", ".$emblishment_print_type[$emb_type];else $emb_typeCond="";
					$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
				}
				else if($emb_name_id==2) //embro type
				{
					if($emb_type>0) $emb_typeCond=", ".$emblishment_embroy_type_arr[$emb_type];else $emb_typeCond="";
					$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
				}
				else if($emb_name_id==4) //Special type
				{
					if($emb_type>0) $emb_typeCond=", ".$emblishment_spwork_type[$emb_type];else $emb_typeCond="";
					$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
				}
				else if($emb_name_id==5) //GMT type
				{
					if($emb_type>0) $emb_typeCond=", ".$emblishment_gmts_type[$emb_type];else $emb_typeCond="";
					$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
				}
				else if($emb_name_id==99) //GMT type
				{
					if($emb_type>0) $emb_typeCond=", ".$emblishment_other_type_arr[$emb_type];else $emb_typeCond="";
					$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
				}
				 

				$wash_req_amount=$emb_req_amount=0;
				if($row[csf('emb_name')]==3) //Wash
				{
					
						
				if($row[csf('emb_type')]>0) $wash_emb_typeCond=", ".$emblishment_wash_type[$row[csf('emb_type')]];else $wash_emb_typeCond="";
				$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$wash_emb_typeCond;
				$wash_req_qty=$wash_qtyArr[$row[csf('job_no')]][$row[csf('id')]];
				$wash_req_amount=$wash_amountArr[$row[csf('job_no')]][$row[csf('id')]];
						// echo $emb_name.'='.$wash_emb_typeCond.' <br>';
					 
				$p_wash_precost_arr[$emb_name]['req_qty']+=$wash_req_qty;
				$p_wash_precost_arr[$emb_name]['req_amount']+=$wash_req_amount;
				$p_wash_precost_arr[$emb_name]['cons']+=$row[csf('cons_dzn_gmts')];
				//$p_wash_precost_arr[$emb_name]['tot_cons']+=$row[csf('cons_dzn_gmts')];
				$p_wash_precost_arr[$emb_name]['amount']+=$row[csf('amount')];
				$p_wash_precost_arr[$emb_name]['p_loss']=$row[csf('p_loss')];
				$p_wash_precost_arr[$emb_name]['sourcing_rate']=$row[csf('sourcing_rate')];
				$p_wash_precost_arr[$emb_name]['pre_rate']=$row[csf('rate')];
				$p_wash_precost_arr[$emb_name]['sourcing_nominated_supp']=$row[csf('sourcing_nominated_supp')];
				$p_wash_precost_arr[$emb_name]['uom']=$unit_of_measurement[$row[csf('uom')]];
				$summ_fob_pcs+=$row[csf('amount')];
				$summ_sourcing_tot_budget_dzn_val+=$wash_req_qty*$row[csf('sourcing_rate')];
				$p_wash_tot_row+=1;	
				}
				else
				{
				$emb_req_qty=$emblishment_qtyArr[$row[csf('job_no')]][$row[csf('id')]];
				$emb_req_amount=$emblishment_amountArr[$row[csf('job_no')]][$row[csf('id')]];
				$p_embro_precost_arr[$emb_name]['req_qty']+=$emb_req_qty;
				$p_embro_precost_arr[$emb_name]['req_amount']+=$emb_req_amount;
				$p_embro_precost_arr[$emb_name]['cons']+=$row[csf('cons_dzn_gmts')];
				//$p_wash_precost_arr[$emb_name]['tot_cons']+=$row[csf('cons_dzn_gmts')];
				$p_embro_precost_arr[$emb_name]['amount']+=$row[csf('amount')];
				$p_embro_precost_arr[$emb_name]['p_loss']=$row[csf('p_loss')];
				$p_embro_precost_arr[$emb_name]['pre_rate']=$row[csf('rate')];
				if($row[csf('sourcing_rate')]>0)
				{
				$p_embro_precost_arr[$emb_name]['sourcing_rate']=$row[csf('sourcing_rate')];
				}
				$p_embro_precost_arr[$emb_name]['sourcing_nominated_supp']=$row[csf('sourcing_nominated_supp')];
				$p_embro_precost_arr[$emb_name]['uom']=$unit_of_measurement[$row[csf('uom')]];
				$summ_fob_pcs+=$row[csf('amount')];
				$summ_sourcing_tot_budget_dzn_val+=$emb_req_qty*$row[csf('sourcing_rate')];
				$p_embro_tot_row+=1;	
				}
				//$summ_fob_value_pcs+=$row[csf('amount')]/$order_price_per_dzn;
				$summ_fob_gross_value_amt+=$emb_req_amount+$wash_req_amount;
			}
			//echo $summ_fob_gross_value_amt.'=';
				//echo $summ_fob_pcs.'A';
				//echo $summ_fob_value_pcs.'C,';
			//wo_pri_quo_comarcial_cost_dtls 
			$sql_other = "select fabric_cost, trims_cost, embel_cost, wash_cost, comm_cost, commission, lab_test, inspection, cm_cost, freight, currier_pre_cost, certificate_pre_cost, design_cost, studio_cost, common_oh, depr_amor_pre_cost, interest_cost, incometax_cost, total_cost,price_dzn from wo_pre_cost_dtls where  job_no=$txt_job_no  and status_active=1 and  is_deleted=0";
			$pre_other_result=sql_select($sql_other);//$summ_fob_value_pcs=0;
			 foreach( $pre_other_result as $row )
			{
				$lab_test=($row[csf('lab_test')]/$order_price_per_dzn)*$order_job_qnty;
				$currier_pre_cost=($row[csf('currier_pre_cost')]/$order_price_per_dzn)*$order_job_qnty;
				$inspection=($row[csf('inspection')]/$order_price_per_dzn)*$order_job_qnty;
				$comarcial=($row[csf('comm_cost')]/$order_price_per_dzn)*$order_job_qnty;
				
				$freight=($row[csf('freight')]/$order_price_per_dzn)*$order_job_qnty;
				$certificate_pre_cost=($row[csf('certificate_pre_cost')]/$order_price_per_dzn)*$order_job_qnty;
				$design_pre_cost=($row[csf('design_cost')]/$order_price_per_dzn)*$order_job_qnty;
				$studio_pre_cost=($row[csf('studio_cost')]/$order_price_per_dzn)*$order_job_qnty;
				$common_oh=($row[csf('common_oh')]/$order_price_per_dzn)*$order_job_qnty;
				$depr_amor_pre_cost=($row[csf('depr_amor_pre_cost')]/$order_price_per_dzn)*$order_job_qnty;
				$interest_pre_cost=($row[csf('interest_cost')]/$order_price_per_dzn)*$order_job_qnty;
				$income_tax_pre_cost=($row[csf('incometax_cost')]/$order_price_per_dzn)*$order_job_qnty;
				
				$tot_other_for_fob_value=$lab_test+$currier_pre_cost+$inspection+$comarcial+$freight+$certificate_pre_cost+$design_pre_cost+$studio_pre_cost+$common_oh+$interest_pre_cost+$income_tax_pre_cost+$depr_amor_pre_cost;
				//echo $tot_other_for_fob_value;
				$lab_test_dzn=$row[csf('lab_test')];
				$fob_pcs=$row[csf('price_with_commn_pcs')];
				$currier_pre_cost_dzn=$row[csf('currier_pre_cost')];
				$inspection_dzn=$row[csf('inspection')];
				$comarcial_dzn=$row[csf('comm_cost')];
				
				$common_oh_dzn=$row[csf('common_oh')];
				$studio_pre_cost_dzn=$row[csf('studio_cost')];
				$design_pre_cost_dzn=$row[csf('design_cost')];
				$certificate_pre_cost_dzn=$row[csf('certificate_pre_cost')];
				
				$freight_dzn=$row[csf('freight')];
				//$comm_cost_dzn=$row[csf('comm_cost')];
				$depr_amor_pre_cost_dzn=$row[csf('depr_amor_pre_cost')];
				$income_tax_pre_cost_dzn=$row[csf('incometax_cost')];
				$interest_pre_cost_dzn=$row[csf('interest_cost')];
				
				$cm_cost_dzn=$row[csf('cm_cost')];
				$cm_cost_pcs=$row[csf('cm_cost')]/$order_price_per_dzn;
				$cm_cost_req=($row[csf('cm_cost')]/$order_price_per_dzn)*$order_job_qnty;
				$tot_cm_qty_dzn=$row[csf('cm_cost')]*$po_qty_dzn;
				//$lab_test_dzn=$row[csf('lab_test')];

				$tot_summ_fob_pcs=$row[csf('total_cost')];
				
				$tot_other_cost_dzn=$common_oh_dzn+$studio_pre_cost_dzn+$design_pre_cost_dzn+$certificate_pre_cost_dzn+$freight_dzn+$depr_amor_pre_cost_dzn+$income_tax_pre_cost_dzn+$interest_pre_cost_dzn;
				
				$tot_other_cost=($tot_other_cost_dzn/$order_price_per_dzn)*$order_job_qnty;
				//$summ_fob_value_pcs+=($tot_other_cost_dzn+$currier_pre_cost_dzn+$lab_test_dzn+$inspection_dzn+$comarcial_dzn)*$order_price_per_dzn+$cm_cost_pcs;
				
				// echo $tot_other_for_fob_value.'m';
				$summ_fob_gross_value_amt+=$tot_other_for_fob_value+$tot_cm_qty_dzn ;
				
				$summ_fob_pcs+=$tot_other_cost_dzn+$lab_test_dzn+$currier_pre_cost_dzn+$inspection_dzn+$comarcial_dzn+$cm_cost_dzn;
				
				$summ_sourcing_tot_budget_dzn_val+=$tot_other_for_fob_value;
				 
			}
			
		$sql_commi = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls  where job_no=".$txt_job_no." and status_active=1";
		$result_commi=sql_select($sql_commi);
		 foreach( $result_commi as $row )
			{
				$commission_type_id=$row[csf('particulars_id')];
				$com_type_id=$row[csf('commission_base_id')];
				
				$commission_arr[$commission_type_id]['commi_req_amt']=($row[csf('commission_amount')]/$order_price_per_dzn)*$order_job_qnty;
				$commission_arr[$commission_type_id]['commi_amt']=$row[csf('commission_amount')];
				$commission_arr[$commission_type_id]['commi_amt_pcs']=$row[csf('commission_amount')]*$order_price_per_dzn;
				//$summ_fob_value_pcs+=$row[csf('commission_amount')]/$order_price_per_dzn;
				$summ_fob_gross_value_amt+=($row[csf('commission_amount')]/$order_price_per_dzn)*$order_job_qnty;
				$summ_fob_pcs+=$row[csf('commission_amount')];
				$summ_sourcing_tot_budget_dzn_val+=($row[csf('commission_amount')]/$order_price_per_dzn)*$order_job_qnty;
			} 
			$summ_sourcing_fob_pcs=$summ_sourcing_tot_budget_dzn_val/$order_job_qnty;
			$summ_tot_final_cm=($summ_fob_gross_value_amt-$summ_sourcing_tot_budget_dzn_val)/$offer_qty_dzn;
			// $tot_summ_fob_pcs=$summ_fob_pcs/$order_price_per_dzn;
			
			 $supplier_library_arr=return_library_array( "select a.short_name, a.id from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id   and a.is_deleted=0  and a.status_active=1 group by a.id,a.short_name order by a.short_name", "id", "short_name");

				?>
                        <td valign="top">
                        	 <table align="left" border="1" class="rpt_table"  cellpadding="1" cellspacing="1" style="width:250px; margin:5px;" rules="all">
                            
							 <tr>
								<td width="80" colspan="2" align="center"><b>Summary </b></td>
							</tr>
							<tr>
								<td width="80"><b>Header </b></td>
                                <td width="80"><b>Pre Cost</b> </td>
								 
								
							</tr>
                            <tr>
								<td>PO Qty Pcs</td>
								<td title="=<? echo $order_job_qnty;?>"><b><? 
								//$fob_pcs=$fob_pcs;//$summ_fob_gross_value_amt/$offer_qty_dzn;
								echo  number_format($order_job_qnty,0); ?></b></td>
							 </tr> 
                             
                              <tr>
								<td>Unit Price/Pcs</td>
								<td title="Price=<? echo $avg_unit_price;?>"><b><? 
								//$fob_pcs=$fob_pcs;//$summ_fob_gross_value_amt/$offer_qty_dzn;
								echo  number_format($avg_unit_price,4); ?></b></td>
							 </tr> 
                             <tr>
								<td>SMV/Pcs</td>
								<td title="=<? //echo $summ_fob_gross_value_amt;?>"><b><? 
								echo  number_format($sew_smv,4); ?></b></td>
							 </tr> 
							<tr>
								<td>Budget Cost/Pcs</td>
								<td  title="Budget Cost/Pcs=<? echo $summ_fob_pcs;?>"><b><? 
								echo  number_format($tot_summ_fob_pcs,4); ?></b></td>
                               
							 </tr> 
                             <tr>
								<td>Margin/Pc(USD)</td>
								<td  title="Avg Rate-FoB Pcs=<? //echo $summ_fob_gross_value_amt;?>"><b><? 
								 $margin_pre=$avg_unit_price-$tot_summ_fob_pcs;
								 $margin_final=$avg_unit_price-$summ_sourcing_fob_pcs;
								echo  number_format($margin_pre,4); ?></b></td>
                              
							 </tr> 
							<tr>
								<td><b>CM/Pcs(USD)</b></td> 
								<td><b><? echo number_format($cm_cost_dzn,4); ?></b></td>
							 </tr> 
                             <tr>
								<td>E.P.M(USD)</td>
								<td title="CM/Costing Per/Sew SMV"><b><? echo number_format($cm_cost_dzn/$order_price_per_dzn/$sew_smv,4); ?></b></td>
							 </tr> 
						</table>
                        <td valign="top">
                        <?
                        $nameArray_imge =sql_select("SELECT image_location,real_file_name FROM common_photo_library where master_tble_id=".$txt_job_no." and file_type=1");
						?>
                <table width="210">
                <tr>
                <?
				 
				$img_counter = 0;
                foreach($nameArray_imge as $result_imge)
				{
				     

					?>
					<td>
						<!--<img src="../../<? //echo $result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />-->
                        <img src="<? echo $path .''. $result_imge[csf('image_location')]; ?>" width="192" height="192" border="2" />
                       <?
					  
					   ?>
					</td>
					<?

					$img_counter++;
				}
				?>
               	 </tr>
           		</table>
                        </td>
                        </tr>
                       
                        </table>
					
<br>
            <table align="left" border="1" cellpadding="0" cellspacing="0"  width="100%" style="margin:5px;" rules="all"> 
              <tr>
             <td  width="100%">
             	<table align="left" class="rpt_table"  border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px;" rules="all"> 
                <tr>
                <th colspan="10" style="background-color:#963;font-size:20px;"> <b>Details Part</b></th>
               
                </tr>
                 <tr>
                    <th  width="20">SL </th>
                    <th  width="100" title="Fabric">ITEM DESCRIPTION </th>
                    <th  width="70">Cons/Pcs</th>
                    <th  width="70">Wast % </th>
                    <th  width="70">Total Cons/Pcs</th>
                    <th  width="50">UOM </th>
                    <th  width="70">Req. Qty</th>
                    <th  width="70">Rate(USD)</th>
                    <!-- <th  width="70">Cost/Dzn</th> -->
                    <th  width="70">Cost/Pcs</th>
                    <th  width="70">Total Budget</th>
                    
                   
                   
                    </tr>
                    
                    <?
					$f=1;$tot_fab_amount=$tot_fab_amount_pcs=$tot_fab_req_amount=0;$ff=1;$tot_fab_req_sourcing_amount=$tot_fab_req_sourcing_bal_amount=0;
                    foreach($p_fab_precost_arr as $fabriccost_dtls_id=>$fabriccost_dtls_data)
					{
						foreach ($fabriccost_dtls_data as  $fab_type=>$fab_data) 
						{
							 foreach($fab_data as $fab_desc=>$row)
							{
							if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
							
							$nominated_supp_str=""; 
							 $exnominated_supp=explode(",",$row[('sourcing_nominated_supp')]);
							 foreach($exnominated_supp as $supp)
							 {
								if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_arr[$supp]; else $nominated_supp_str.=','.$supplier_library_arr[$supp];
							 }	
	                    ?>
	                	<tr bgcolor="<? echo $bgcolor;?>">
	                   
	                    <td width="20" align="center"><p><? echo $f; ?></p></td>
	                   
	                    <td width="100" align="center"><div style="word-break:break-all"><? echo $fab_desc; //echo $fab_type.','.$fab_desc; ?></div></td>
	                    <td width="70" align="right"><p><? echo number_format($row['cons'],4); ?></p></td>
	                    <td width="70" align="right"><p><? echo number_format($row[('p_loss')],4); ?></p></td>
	                    <td width="70" align="right"><p><? echo number_format($row[('tot_cons')],4); ?></p></td>
	                    <td width="50"><p><? echo $row[('uom')]; ?></p></td>
	                    <td width="70" align="right"><p><? echo number_format($row[('req_qty')],4); ?></p></td>
	                    <td width="70" align="right"><p><? echo number_format($row[('req_amount')]/$row[('req_qty')],4); ?></p></td>
	                    <!-- <td width="70"align="right"><p><? echo number_format($row[('amount')],4); ?></p></td> -->
	                    <td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,4); ?></p></td>
	                    <td width="70" align="right"><p><? echo number_format($row[('req_amount')],4); ?></p></td>
	                    
	                  
	                   
	                    </tr>
						<?
							$f++;$ff++;
							$tot_fab_amount+=$row[('amount')];
							$tot_fab_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
							$tot_fab_req_amount+=$row[('req_amount')];
							$tot_fab_req_sourcing_amount+=$row[('sourcing_rate')]*$row[('req_qty')];
							$tot_fab_req_sourcing_bal_amount+=$bal_sourcing_amount;
							}
						}
					}
					?>
                     
                    <tfoot>
                      <tr style="font-size:18px; background-color:#CCC">
                        <td colspan="8"> <b style="float:left">A Total Fabric Cost</b></td>
                        <!-- <td  align="right"><b><? echo number_format($tot_fab_amount,4); ?></b></td> -->
                        <td  align="right"><b><? echo number_format($tot_fab_amount_pcs,4); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_fab_req_amount,4); ?></b></td>
                      
                        
                    </tr>
                    </tfoot>
                </table>
                <br>
                <?
               // die;
				?>
                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1"  width="98%" style="text-align:center;margin:5px;" rules="all">
                
                 <thead>
                 <tr>
                 	
                    <th  width="20">SL </th>
                    <th  width="100" title="Trim sew">ITEM DESCRIPTION </th>
                    <th  width="70">Cons/Pcs</th>
                    <th  width="70">Wast % </th>
                    <th  width="70">Total Cons/Pcs</th>
                    <th  width="50">UOM </th>
                    <th  width="70">Req. Qty</th>
                    <th  width="70">Rate(USD)</th>
                    <!-- <th  width="70">Cost/Dzn</th> -->
                    <th  width="70">Cost/Pcs</th>
                    <th  width="70">Total Budget</th>
                  
                   
                    
                    </tr>
                    </thead>
                     
                    <?
                    $trims_tot_amount=0;
					$ts=1;$tot_sew_amount=$tot_amount_pcs=$tot_sew_amount_pcs=$tot_sew_req_amount=0;$ttts=1;$tot_sew_req_sourcing_amount=$tot_sew_req_sourcing_bal_amount=0;
                    // foreach($p_sew_trim_precost_arr as $item_id=>$row)
					// {
					foreach($pre_trim_result as $row){

						$trims_type=$row[csf('trim_type')];
				
				
						$description=$row[csf('description')];
						if($description!="") $descriptionCond=", ".$description; else $descriptionCond="";
						$item_id=$row[csf('item_name')].$descriptionCond;
						//$item_name_arr[$item_id]=$row[csf('item_name')].$descriptionCond;
					



						
						if($ts%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
						$nominated_supp_str=""; 
						 $exnominated_supp=explode(",",$row[('sourcing_nominated_supp')]);
						 foreach($exnominated_supp as $supp)
						 {
							if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_arr[$supp]; else $nominated_supp_str.=','.$supplier_library_arr[$supp];
						 }	
						 
						 $req_amt=$row[csf('cons_dzn_gmts')]*$row[csf('rate')];

						 $p_sew_loss=$row[csf('ex_per')];
						 $ex_tot=$row[csf('cons_dzn_gmts')]+(($row[csf('cons_dzn_gmts')]*$p_sew_loss)/100);
					
							
						$trim_req_qty=$trim_qty_arr[$row[csf('id')]];
						$trim_req_amount=$trim_amount_arr[$row[csf('id')]];
								
						//$p_sew_trim_precost_arr[$item_id]['tot_row']+=1;
						$p_sew_trim_tot_row+=1;
					
						$summ_fob_pcs+=$row[csf('amount')];	
						$summ_sourcing_tot_budget_dzn_val+=$trim_req_qty*$row[csf('sourcing_rate')];
						$summ_fob_gross_value_amt+=$trim_req_amount;
						
                    ?>
                	<tr bgcolor="<? echo $bgcolor;?>">
                   
                    <td width="20" align="center"><p><? echo $ts; ?></p></td>
                    <td width="100" ><div style="word-break:break-all"><? echo $item_id; ?></div></td> 
                    <td width="70" align="right"><p><? echo number_format($row[csf('tot_cons')],6); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($p_sew_loss,6); ?></p></td>
                    <td width="70" align="right"><p><?  echo number_format($row[csf('cons_dzn_gmts')],6); ?></p></td>
                    <td width="50" align="center"><p><? echo $unit_of_measurement[$row[csf('uom')]]; ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($trim_req_qty,6); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($trim_req_amount/$trim_req_qty,6); ?></p></td>
                    <!-- <td width="70"align="right"><p><? echo number_format($row[csf('amount')],6); ?></p></td> -->
                    <td width="70" align="right"><p><? echo number_format($row[csf('amount')]/$order_price_per_dzn,6); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($trim_req_amount,6); ?></p></td>
                     
                    </tr>
					<?
						$ts++;$ttts++;
						$tot_sew_amount+=$row[csf('amount')];
						$tot_sew_amount_pcs+=$row[csf('amount')]/$order_price_per_dzn;
						$tot_sew_req_amount+=$trim_req_amount;
						$tot_sew_req_sourcing_amount+=$row[csf('sourcing_rate')]*$trim_req_qty;
						$tot_sew_req_sourcing_bal_amount+=$bal_sourcing_amout;
						$trims_tot_amount+=$trim_req_amount;
						
					}
					?>
                     
                     <tfoot>
                    <tr style="font-size:18px; background-color:#CCC">
                        <td colspan="8" align="left"><b>B-Total Trims Cost:</b></td>
                        <!-- <td  align="right"><b><? echo number_format($tot_sew_amount,6); ?></b></td> -->
                        <td  align="right"><b><? echo number_format($tot_sew_amount_pcs,6); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_sew_req_amount,6); ?></b></td>
                        
                    </tr>
                    </tfoot>
                     
                </table>
            
                <br>
                 <?
                // die;
				 ?>
                <table align="left" class="rpt_table"  border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px; text-align:center;" rules="all"> 
                <caption><b style="float:left">Gmts Wash</b></caption>
                <thead>
                 <tr>
                  
                    <th width="20">SL </th>
                    <th width="100" title="Wash ">ITEM DESCRIPTION </th>
                    <th width="70">Cons/Pcs</th>
                    <th width="70">Wast % </th>
                    <th width="70">Total Cons/Pcs</th>
                    <th width="50">UOM </th>
                    <th width="70">Req. Qty</th>
                    <th width="70"> Rate(USD)</th>
                    <!-- <th width="70">Cost/Dzn</th> -->
                    <th width="70">Cost/Pcs</th>
                    <th width="70">Total Budget</th> 
                    </tr>
                     </thead>
                    
                    <?
					$w=1;$tot_wash_amount=$tot_wash_amount_pcs=$tot_wash_req_amount=$tot_wash_sourcing_req_amount=$tot_wash_sourcing_req_amount_bal=0;$ws=1;
                    foreach($p_wash_precost_arr as $embname_id=>$row)
					{
						
						if($w%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
						$wash_nominated_supp_str=""; 
						 $exnominated_suppArr=explode(",",$row[('sourcing_nominated_supp')]);
						 foreach($exnominated_suppArr as $supp)
						 {
							if($wash_nominated_supp_str=="") $wash_nominated_supp_str=$supplier_library_arr[$supp]; else $wash_nominated_supp_str.=','.$supplier_library_arr[$supp];
						 }		
                    ?>
                	<tr bgcolor="<? echo $bgcolor;?>">
                    
                    <td width="20" align="center"><p><? echo $w; ?></p></td>
                    <td width="100"><div style="word-break:break-all"><? $embname_id=explode(", ",$embname_id);echo $embname_id[1]; ?></div></td> 
                    
                    <td width="70" align="right"><p><? echo number_format($row[('cons')],4); ?></p></td>
                    <td width="70" align="right"><p><? //echo $row[('p_loss')]; ?></p></td>
                    <td width="70" align="right"><p><?  echo number_format($row[('cons')],4) ?></p></td>
                    <td width="50"><p><? echo $costing_val; ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('req_qty')],4); ?></p></td>
                    <td width="70" align="right" title="Rate=<? echo $row[('pre_rate')];?>"><p><? echo number_format($row[('pre_rate')],4); ?></p></td>
                    <!-- <td width="70"align="right"><p><? echo number_format($row[('amount')],4); ?></p></td> -->
                    <td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,4); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('req_qty')]*$row[('pre_rate')],4); ?></p></td>
                    
                    </tr>
                    
                    
					<?
						$w++;$ws++;
						$tot_wash_amount+=$row[('amount')];
						$tot_wash_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
						$tot_wash_req_amount+=$row[('req_qty')]*$row[('pre_rate')];
						$tot_wash_sourcing_req_amount+=$sourcing_tot_amount;
						$tot_wash_sourcing_req_amount_bal+=$sourcing_tot_amount_bal;
						
					}
					?>
                     
                    <tfoot>
                    <tr style="font-size:20px; background-color:#CCC">
                         
                        <td colspan="8"> <b>C-Total Wash Cost :</b></td>
                        <!-- <td  align="right"><b><? echo number_format($tot_wash_amount,4); ?></b></td> -->
                        <td  align="right"><b><? echo number_format($tot_wash_amount_pcs,4); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_wash_req_amount,4); ?></b></td>
                      
                        
                    </tr>
                    
                   
                  </tfoot>
                </table>
                <br>
               
                <table align="left" class="rpt_table"  border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px; text-align:center;" rules="all"> 
                <caption><b style="float:left">Embellishment Cost</b></caption>
                 <thead>
                 <tr>
                 	 
                    <th width="20">SL </th>
                    <th width="100" title="">ITEM DESCRIPTION </th>
                    <th width="70">Cons/Pcs</th>
                    <th width="70">Wast % </th>
                    <th width="70">Total Cons/Pcs</th>
                    <th width="50">UOM </th>
                    <th width="70">Req. Qty</th>
                    <th width="70">Rate(USD)</th>
                    
                    <!-- <th width="70">Cost/Dzn</th> -->
                    <th width="70">Cost/Pcs</th>
                    <th width="70">Total Budget</th>
                   
                    
                    </tr>
                    </thead>
                      
                    <?
					$em=1;$tot_embro_amount=$tot_embro_amount_pcs=$tot_embro_req_amount=$tot_emb_sourcing_req_amount=$tot_emb_sourcing_req_amount_bal=0;$emb=1;
                    foreach($p_embro_precost_arr as $embname_id=>$row)
					{
						
						if($w%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
						$emb_nominated_supp_str=""; 
						 $emb_exnominated_suppArr=explode(",",$row[('sourcing_nominated_supp')]);
						 foreach($emb_exnominated_suppArr as $supp)
						 {
							if($emb_nominated_supp_str=="") $emb_nominated_supp_str=$supplier_library_arr[$supp]; else $emb_nominated_supp_str.=','.$supplier_library_arr[$supp];
						 }		
                    ?>
                	<tr bgcolor="<? echo $bgcolor;?>">
                     
                    <td width="20" align="center"><p><? echo $em; ?></p></td>
                    <td width="100"><div style="word-break:break-all"><? echo $embname_id; ?></div></td> 
                    
                    <td width="70" align="right"><p><? echo number_format($row[('cons')],4); ?></p></td>
                    <td width="70" align="right"><p><? //echo $row[('p_loss')]; ?></p></td>
                    <td width="70" align="right"><p><?  echo number_format($row[('cons')],4); ?></p></td>
                    <td width="50"><p><? echo $costing_val; ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('req_qty')],4); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('req_amount')]/$row[('req_qty')],4); ?></p></td>
                    <!-- <td width="70"align="right"><p><? echo number_format($row[('amount')],4); ?></p></td> -->
                    <td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,4); ?></p></td>
                    <td width="70" align="right"><b><? echo number_format($row[('req_amount')],4); ?></b></td>
                    
                   
                    
                      
                    </tr>
					<?
						$em++;$emb++;
						$tot_embro_amount+=$row[('amount')];
						$tot_embro_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
						$tot_embro_req_amount+=$row[('req_amount')];
						$tot_emb_sourcing_req_amount+=$emb_sourcing_tot_amount;
						$tot_emb_sourcing_req_amount_bal+=$emb_sourcing_tot_amount_bal;
						
					}
					?>
                     
                    <tfoot>
                     <tr style="font-size:20px; background-color:#CCC">
                         
                        <td colspan="8"> <b>D-Total Embellishment Cost:</b></td>
                        <!-- <td  align="right"><b><? echo number_format($tot_embro_amount,4); ?></b></td> -->
                        <td  align="right"><b><? echo number_format($tot_embro_amount_pcs,4); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_embro_req_amount,4); ?></b></td>
                       
                    </tr>
                  </tfoot>
                </table>
                <br>
                 
                <table align="left" class="rpt_table"  border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px;" rules="all"> 
                <caption><b style="float:left">Others Components</b></caption>
                 <tr>
                 	 
                    <th width="20">SL </th>
                    <th title="520"><b>Others Components</b> </th>
                   
                    <!-- <th width="70"><b>Cost/Dzn</b></th> -->
                    <th width="70"><b>Cost/Pcs</b></th>
                    <th width="70"><b>Total Budget</b></th>
                    
                  
                    </tr>
                    <tbody> 
                    <?
					//$em=1;$tot_embro_amount=$tot_embro_amount_pcs=$tot_embro_req_amount=0;$emb=1;
						$bgcolor="#E9F3FF";
						$bgcolor2="#FFFFFF";//currier_pre_cost_dzn
					 
                      
                   // $tot_other_cost=0;
					$tot_other_cost_first=$tot_other_cost+$comarcial+$inspection+$currier_pre_cost+$lab_test;
					
						$total_other_cost_dzn=$tot_other_cost_dzn+$comarcial_dzn+$inspection_dzn+$lab_test_dzn+$currier_pre_cost_dzn;
						 $tot_other_cost_pcs=$tot_other_cost_dzn/$order_price_per_dzn;
						 $tot_comarcial_dzn_pcs=$comarcial_dzn/$order_price_per_dzn;
						 $tot_inspection_dzn_pcs=$inspection_dzn/$order_price_per_dzn;
						  $currier_pre_cost_dzn_pcs=$currier_pre_cost_dzn/$order_price_per_dzn;
						  $tot_lab_test_dzn_pcs=$lab_test_dzn/$order_price_per_dzn;
						 
						$total_other_cost_pcs=$tot_other_cost_pcs+$tot_comarcial_dzn_pcs+$tot_lab_test_dzn_pcs+$tot_inspection_dzn_pcs+$currier_pre_cost_dzn_pcs;
						
						
						
						$tot_other_cost_req_amount=$tot_other_cost_first;
						
					
					?>
                	<tr bgcolor="<? echo $bgcolor;?>">
                    
                    <td width="20" align="center"><p>1</p></td>
                    <td width="520" align="" ><b>Test Charge</b></td> 
                    <!-- <td width="70"align="right"><p><? echo number_format($lab_test_dzn,4); ?>&nbsp;</p></td> -->
                    <td width="70" align="right"><p><?   echo number_format($tot_lab_test_dzn_pcs,4); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($lab_test,4); ?>&nbsp;</p></td>
                    
                    
                    
                    </tr>
                     <td width="20" align="center" ><p>2</p></td>
                    <td width="520"><b>Courier Charge</b></td> 
                    <!-- <td width="70"align="right"><p><? echo number_format($currier_pre_cost_dzn,4); ?>&nbsp;</p></td> -->
                    <td width="70" align="right"><p><?  echo number_format($currier_pre_cost_dzn_pcs,4); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($currier_pre_cost,4); ?>&nbsp;</p></td>
                   
                    </tr>
                    
                    <tr bgcolor="<? echo $bgcolor2;?>">
                    
                    <td width="20" align="center" ><p>3</p></td>
                    <td width="520"><b>Inspection Charge</b></td> 
                    <!-- <td width="70"align="right"><p><? echo number_format($inspection_dzn,4); ?>&nbsp;</p></td> -->
                    <td width="70" align="right"><p><? echo number_format($tot_inspection_dzn_pcs,4); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($inspection,4); ?>&nbsp;</p></td>
                   
                     
                    </tr>
                    
                    <tr bgcolor="<? echo $bgcolor;?>">
                    
                    <td width="20" align="center" ><p>4</p></td>
                    <td width="520"><b>Commercial Charge</b></td> 
                    <!-- <td width="70"align="right"><p><? echo number_format($comarcial_dzn,4); ?>&nbsp;</p></td> -->
                    <td width="70" align="right"><p><?  echo number_format($tot_comarcial_dzn_pcs,4); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($comarcial,4); ?>&nbsp;</p></td>
                  
                       
                    </tr>
                    <tr bgcolor="<? echo $bgcolor2;?>">
                     
                    <td width="20" align="center"><p>5</p></td>
                    <td width="520" title="Freight+Certif.Cost+Design Cost+Studio Cost+Deprec.&Amort.+Operating Expenses+Deprec.&Amort.+Interest+Income Tax">
                    <b>Others Charge</b></td> 
                   
                     <!-- <td width="70"align="right"><p><? echo number_format($tot_other_cost_dzn,4); ?>&nbsp;</p></td> -->
                    <td width="70" align="right"><p><? echo number_format($tot_other_cost_pcs,4); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($tot_other_cost,4); ?>&nbsp;</p></td>
                   
                     
                    </tr>
					
                    </tbody>
                    <tfoot>
                     <tr style="font-size:20px; background-color:#CCC">
                         
                        <td colspan="2"> <b>E-Total Others Cost:</b></td>
                        <!-- <td  align="right"><b><? echo number_format($total_other_cost_dzn,4); ?>&nbsp;</b></td> -->
                        <td  align="right"><b><? echo number_format($total_other_cost_pcs,4); ?>&nbsp;</b></td>
                        <td  align="right"><b><? echo number_format($tot_other_cost_req_amount,4); ?>&nbsp;</b></td>
                        
                        
                     
                        
                    </tr>
                  </tfoot>
                </table>
                <br>
             
                 <table align="left" border="1" class="rpt_table"  cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px;" rules="all"> 
                <caption><b style="float:left"> Commission Cost:</b></caption>
                   <tr>
                 	 
                    <th  width="20">SL </th>
                    <th width="520" title="">Commission Cost </th>
                    <!-- <th width="70">Cost/Dzn</th> -->
                    <th  width="70">Cost/Pcs</th>
                    <th  width="70">Total Budget</th>
                    
                   
                    
                    
                     
                    </tr>
                    <tbody> 
                    <?
                     
						$tot_commission_amount=$commission_arr[1]['commi_amt']+$commission_arr[2]['commi_amt'];
						$tot_commission_amount_pcs=($commission_arr[1]['commi_amt']/$order_price_per_dzn)+($commission_arr[2]['commi_amt']/$order_price_per_dzn);
						$tot_commision_req_amount=$commission_arr[1]['commi_req_amt']+$commission_arr[2]['commi_req_amt'];
						
					
					?>
					 
                   <tr bgcolor="<? echo $bgcolor;?>">
                    
                    <td width="20" align="center"><p>1</p></td>
                    <td width="520" ><b>Local </b></td> 
                    <!-- <td width="70"align="right"><p><? echo number_format($commission_arr[2]['commi_amt'],4); ?>&nbsp;</p></td> -->
                    <td width="70" align="right"><p><? echo number_format($commission_arr[2]['commi_amt']/$order_price_per_dzn,4); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($commission_arr[2]['commi_req_amt'],4); ?>&nbsp;</p></td>
                    
                    </tr>

                    <tr bgcolor="<? echo $bgcolor2;?>">                     
						<td width="20" align="center"><p>2</p></td>
						<td width="520" ><b>Foreign</b></td> 
						<!-- <td width="70"align="right"><p><? echo number_format($commission_arr[1]['commi_amt'],4); ?>&nbsp;</p></td> -->
						<td width="70" align="right"><p><? echo number_format($commission_arr[1]['commi_amt']/$order_price_per_dzn,4); ?>&nbsp;</p></td>
						<td width="70" align="right"><p><? echo number_format($commission_arr[1]['commi_req_amt'],4); ?>&nbsp;</p></td>
                    
                     
                    </tr>
					
                    </tbody>
                    <tfoot>
                    <tr>
                         
                        <td colspan="2"> <b>F-Total Commission Cost:</b></td>
                        <!-- <td  align="right"><b><? echo number_format($tot_commission_amount,4); ?>&nbsp;</b></td> -->
                        <td  align="right"><b><? echo number_format($tot_commission_amount_pcs,4); ?>&nbsp;</b></td>
                        <td  align="right"><b><? echo number_format($tot_commision_req_amount,4); ?>&nbsp;</b></td>
                       
                        
                    </tr>
                    
                    <tr bgcolor="<? echo $bgcolor;?>">
                    
                    <td width="20" align="center"><p>1</p></td>
                    <td width="520"><b>G-Total CM Cost</b></td> 
                    <!-- <td width="70"align="right"><b><? echo number_format($cm_cost_dzn,4); ?>&nbsp;</b></td> -->
                    <td width="70" align="right"><b><? $tot_cm_cost_pcs=$cm_cost_dzn/$order_price_per_dzn;echo number_format($tot_cm_cost_pcs,4); ?>&nbsp;</b></td>
                    <td width="70" title="CM Dzn*PO Qty Dzn" align="right"><b><? echo number_format($tot_cm_qty_dzn,4); ?>&nbsp;</b></td>
                  
                    </tr>
                    
                    <tr bgcolor="<? echo $bgcolor;?>"> 
                    <td width="520" colspan="2"><p> <b>Gross FOB Value [A+B+C+D+E+F+G+H]</b></p></td> 
					<?php //tot_sew_amount_pcs
										$gross_fob_value_dzn=$tot_fab_amount+$trim_sew_fin_amt+$tot_wash_amount+$tot_embro_amount+$tot_other_cost_dzn+$tot_commission_amount+$cm_cost_dzn;
										$gross_fob_value_pcs=$tot_fab_amount_pcs+$trim_sew_fin_amt_pcs+$tot_wash_amount_pcs+$tot_embro_amount_pcs+$tot_other_cost_pcs+$tot_commission_amount_pcs+$tot_cm_cost_pcs;
										//echo $tot_fab_amount_pcs.'=='.$trim_sew_fin_amt_pcs.'=='.$tot_wash_amount_pcs.'=='.$tot_embro_amount_pcs.'=='.$tot_commission_amount_pcs.'=='.$tot_cm_cost_pcs;
										//$gross_fob_value_req=$tot_fab_req_amount+$trim_fin_req_amount+$tot_wash_req_amount+$tot_embro_req_amount+$tot_commision_req_amount+$tot_other_cost_req_amount+$cm_cost_req;
										
										$gross_fob_value_req=$tot_fab_req_amount+$trims_tot_amount+$tot_wash_req_amount+$tot_embro_req_amount+$tot_other_cost_req_amount+$tot_commision_req_amount+$tot_cm_qty_dzn;


					
										
										 //---fob value
										 $total_fob_gross_pcs=$tot_fab_amount_pcs+$trim_sew_fin_amt_pcs+$tot_wash_amount_pcs+$tot_embro_amount_pcs+$tot_other_cost_pcs+$tot_commission_amount_pcs+$tot_cm_cost_pcs;
							$total_fob_gross_dzn=$tot_fab_amount+$trim_sew_fin_amt+$tot_sew_amount_pcs+$tot_wash_amount+$tot_embro_amount+$total_other_cost_dzn+$tot_commission_amount+$cm_cost_dzn;
										$tot_gross_fob_pcs=$total_fob_gross_dzn/$order_price_per_dzn;
										 $gross_fob_value_dzn_without_commi=$total_fob_gross_dzn-$tot_commission_amount;
										$gross_fob_value_pcs_without_commi=$tot_gross_fob_pcs-$tot_commission_amount_pcs;
										$gross_fob_value_req_without_commi=$gross_fob_value_req-$tot_commision_req_amount;
					?>					
                    <!-- <td width="70"align="right"><b><?  //tot_embro_amount_pcs tot_embro_req_amount

					//echo number_format($total_fob_gross_dzn,4); ?>&nbsp;</b></td> -->
                    <td width="70" align="right"><b> <? echo number_format($tot_gross_fob_pcs,4); ?>&nbsp;</b></td>
                    <td width="70" align="right" title="<? echo $gross_fob_value_req."=".$tot_fab_req_amount."+".$trims_tot_amount."+".$tot_wash_req_amount."+".$tot_embro_req_amount."+".$tot_other_cost_req_amount."+".$tot_commision_req_amount."+".$tot_cm_qty_dzn;?>"><b><? echo number_format($gross_fob_value_req,4); ?>&nbsp;</b></td>
                   
                    </tr>
                    <?
                   
					?>
                     <tr bgcolor="<? echo $bgcolor2;?>">
                    <td width="520" colspan="2"><b>Net FOB Value (Without Commission)</b></td> 
                    <!-- <td width="70"align="right"><b><? //echo number_format($gross_fob_value_dzn_without_commi,4); ?> </b></td> -->
                    <td width="70" align="right"><b><? echo number_format($gross_fob_value_pcs_without_commi,4); ?> </b></td>
                    <td width="70" align="right"><b><? echo number_format($gross_fob_value_req_without_commi,4); ?> </b></td>
                   
                    </tr>
                   
                  </tfoot>
                </table>
                
             </td>
              </tr>
              
           </table>
          
           <div style="float:left" align="left">  <b> &nbsp;&nbsp;&nbsp;&nbsp; <? //echo $inserted_by;?> </b></div>
           <div style="clear:both"></div>
           <? 
		   
           /*
			$cbo_company_name=str_replace("'","",$cbo_company_name);
			//echo signature_table(219, $cbo_company_name, "1320px"); 
			if ($cbo_template_id != '') {
				$template_id = " and template_id=$cbo_template_id ";
			}
			$sql = sql_select("select designation,name,user_id,prepared_by from variable_settings_signature where report_id=218 and company_id='$cbo_company_name'  $template_id order by sequence_no");
		$signature_sql = sql_select("SELECT c.master_tble_id as MASTER_TBLE_ID,c.image_location as IMAGE_LOCATION  from variable_settings_signature a, electronic_approval_setup b, common_photo_library c where a.user_id=b.user_id and a.user_id=c.master_tble_id and a.report_id=218 and a.company_id='$cbo_company_name' and a.template_id=$cbo_template_id and b.page_id=428 and b.entry_form=15 and b.company_id=$cbo_company_name and c.form_name='user_signature'");
	   
		$signature_location=array();
		foreach($signature_sql as $row)
		{
			$signature_location[$row['MASTER_TBLE_ID']]=$row['IMAGE_LOCATION'];
		}
		if($sql[0][csf("prepared_by")]==1){
			list($prepared_by,$activities)=explode('**',$prepared_by);
			$sql_2[100] = array ( DESIGNATION => 'Prepared By' ,NAME => $prepared_by, ACTIVITIES =>$activities, PREPARED_BY => 0 );
			$sql=$sql_2+$sql;
		}
		$count = count($sql);
		$td_width = floor(1000 / $count);
		$standard_width = $count * 150;
		if ($standard_width > 1000) {
			$td_width = 150;
		}
		$i = 1;
		if ($count == 0) { echo "<b>Note: This is Software Generated Copy , Signature is not Required.</b>";}
		else
		{
			echo '<table id="signatureTblId" width="1000" style="padding-top:50px;"><tr><td width="100%" height="50" colspan="' . $count . '">' . $message . '</td></tr><tr>';
			foreach ($sql as $row) {
				echo '<td width="' . $td_width . '" align="center" valign="bottom">';
				if($signature_location[$row[csf("user_id")]]!='')
				{
					echo '<strong><img src="../../'.$signature_location[$row[csf("user_id")]].'" height="60" width="90" ></strong><br>';
				}
				else
				{
					echo '<span style="height:60px;width:90px;"></span><br>';
				}
				echo '<strong style="text-decoration:overline">' . $row[csf("designation")] . "</strong><br>" . $row[csf("name")] . '</td>';
				$i++;
			}
			echo '</tr></table>';
		}
		
		*/

		$cbo_company_name=str_replace("'","",$cbo_company_name);
			//echo signature_table(219, $cbo_company_name, "1320px"); 
			if ($cbo_template_id != '') {
				$template_id = " and a.template_id=$cbo_template_id ";
			}
			//$sql = sql_select("select a.designation,a.name,a.user_id,a.prepared_by from variable_settings_signature a left join electronic_approval_setup b where a.user_id=b.user_id and a.report_id=218 and a.company_id='$cbo_company_name'  $template_id order by sequence_no");
			$sql= sql_select("SELECT a.designation,
								         a.name,
								         a.user_id,
								         a.prepared_by,
								         b.sequence_no,
										 a.sequence_no as sequence_no_sign
								    FROM    variable_settings_signature a
								         LEFT JOIN
								            electronic_approval_setup b
								         ON a.user_id = b.user_id and b.page_id=1717 and b.entry_form=46 and b.company_id=a.company_id and b.is_deleted=0
								   WHERE a.report_id = 218 AND a.company_id = '$cbo_company_name' $template_id
									group by a.designation,
									         a.name,
									         a.user_id,
									         a.prepared_by,
									         b.sequence_no,
											 a.sequence_no
											  
									ORDER BY a.sequence_no");//,b.sequence_no
			$user_information=array();
			
			foreach($sql as $row)
			{
				$user_information[$row[csf('user_id')]]['name']=$row[csf('name')];
				$user_information[$row[csf('user_id')]]['designation']=$row[csf('designation')];
				$user_information[$row[csf('user_id')]]['prepared_by']=$row[csf('prepared_by')];
			}
		//$signature_sql = sql_select("SELECT c.master_tble_id as MASTER_TBLE_ID,c.image_location as IMAGE_LOCATION,a.user_id as user_id  from variable_settings_signature a, electronic_approval_setup b, common_photo_library c where a.user_id=b.user_id and a.user_id=c.master_tble_id and a.report_id=218 and a.company_id='$cbo_company_name' and a.template_id=$cbo_template_id and b.page_id=428 and b.entry_form=15 and b.company_id=$cbo_company_name and c.form_name='user_signature' group by c.master_tble_id,c.image_location,a.user_id");
		$inserted_by=return_field_value("inserted_by", "wo_pre_cost_mst", "job_no='".str_replace("'","",$txt_job_no)."'");
		
	   $ssql="SELECT a.user_id as user_id,b.sequence_no  from variable_settings_signature a, electronic_approval_setup b,approval_history c,wo_pre_cost_mst d where a.user_id=b.user_id and a.user_id=c.approved_by and c.mst_id=d.id and d.job_no='".str_replace("'","",$txt_job_no)."'  and a.report_id=218 and a.company_id='$cbo_company_name' and a.template_id=$cbo_template_id and b.page_id=1717 and b.entry_form=46 and b.company_id=$cbo_company_name and c.entry_form=46 group by a.user_id,b.sequence_no";
	   $signature_photo = sql_select("SELECT c.master_tble_id as MASTER_TBLE_ID,c.image_location as IMAGE_LOCATION  from common_photo_library c where c.form_name='user_signature' group by c.master_tble_id,c.image_location");
	   	//echo $ssql;
	   $signature_sql = sql_select($ssql);
	    $isApprovedUser=array();
	    foreach($signature_sql as $row)
	    {
	    	$isApprovedUser[$row[csf('user_id')]]=$row[csf('sequence_no')];
	    }
		$signature_location=array();
		foreach($signature_photo as $row)
		{
			$signature_location[$row['MASTER_TBLE_ID']]=$row['IMAGE_LOCATION'];
		}
		if($sql[0][csf("prepared_by")]==1){
			list($prepared_by,$activities)=explode('**',$prepared_by);
			$sql_2[100] = array ( DESIGNATION => 'Prepared By' ,NAME => $prepared_by, ACTIVITIES =>$activities, PREPARED_BY => 0 );
			//$sql=$sql_2+$sql;
			$sql=$sql_2+$sql;
			//print_r($sql);
		}
		$count = count($sql);
		
		$td_width = floor(1000 / $count);
		$standard_width = $count * 150;
		if ($standard_width > 1000) {
			$td_width = 150;
		}
		$i = 1;
		if ($count == 0) { echo "<b>Note: This is Software Generated Copy , Signature is not Required.</b>";}
		else
		{
			echo '<table id="signatureTblId" width="1000" style="padding-top:50px;"><tr><td width="100%" height="50" colspan="' . $count . '">' . $message . '</td></tr><tr>';
			foreach ($sql as $key=>$row) {
				echo '<td width="' . $td_width . '" align="center" valign="bottom">';
				//check isApproved
				$sequence_no='';
				$sequence_no=$isApprovedUser[$row[csf('user_id')]];
				if($signature_location[$row[csf('user_id')]]!='' && $sequence_no==$row[csf('sequence_no')] && $key!=100)
				{
					echo '<strong><img src="../../'.$signature_location[$row[csf('user_id')]].'" height="60" width="90" ></strong><br>';
					
				}
				else if($key==100 && $signature_location[$inserted_by]!='')
				{
					echo '<strong><img src="../../'.$signature_location[$inserted_by].'" height="60" width="90" ></strong><br>';
				}
				else
				{
					echo '<span style="height:60px;width:90px;"></span><br>';
				}
				echo '<strong style="text-decoration:overline">' . $row[csf("designation")] . "</strong><br>" . $row[csf("name")] . '</td>';
				//echo '<strong style="text-decoration:overline">' . $user_information[$row[csf('user_id')]]['designation']. "</strong><br>" . $user_information[$row[csf('user_id')]]['name'] . '</td>';
				$i++;
			}
			echo '</tr></table>';
		}
 
		?>            
     </div>
    
      <div style="clear:both"></div>
     
    <?
	$mailBody=ob_get_contents();
	ob_clean();
	echo $mailBody;

	//Mail send------------------------------------------
	list($msil_address,$is_mail_send,$mail_body)=explode('**',$mail_data);
	if($is_mail_send==1){
	
		require_once('../../../mailer/class.phpmailer.php');
		require_once('../../../auto_mail/setting/mail_setting.php');
		
		$mailBody = preg_replace("/<img[^>]+\>/i", " ", $mailBody); 	
		$mailToArr=array();
		if($msil_address){$mailToArr[]=$msil_address;}
			
		$mailSql = "SELECT c.TEAM_LEADER_EMAIL, d.USER_EMAIL
  FROM wo_po_details_master  a,  wo_pre_cost_mst b, lib_marketing_team c, USER_PASSWD d
 WHERE a.job_no = b.job_no  AND a.TEAM_LEADER = c.id AND b.INSERTED_BY = d.id AND a.status_active = 1  AND a.job_no=$txt_job_no";
		
		//echo $mailSql;die;
		
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows['TEAM_MEMBER_EMAIL']){$mailToArr[$rows['TEAM_LEADER_EMAIL']]=$rows['TEAM_LEADER_EMAIL'];}
			if($rows['USER_EMAIL']){$mailToArr[$rows['USER_EMAIL']]=$rows['USER_EMAIL'];}
		}
		
		//$elcetronicSql = "SELECT a.SEQUENCE_NO,a.BYPASS,b.USER_EMAIL  from electronic_approval_setup a join user_passwd b on a.user_id=b.id where b.valid=1 and a.page_id=2150 and a.entry_form=46 and a.company_id=$cbo_company_name order by a.SEQUENCE_NO";
		
		$elcetronicSql = "SELECT a.BUYER_ID,a.SEQUENCE_NO,a.BYPASS,b.USER_EMAIL  from electronic_approval_setup a join user_passwd b on a.user_id=b.id where b.valid=1  AND a.page_id in(428,1717,2150) and a.company_id=$cbo_company_name order by a.SEQUENCE_NO"; //and a.page_id=2150 and a.entry_form=46
		//echo $elcetronicSql;die;
		
		$elcetronicSqlRes=sql_select($elcetronicSql);
		foreach($elcetronicSqlRes as $rows){
			
			
			if($rows[BUYER_ID]!=''){
				foreach(explode(',',$rows[BUYER_ID]) as $bi){
					if($rows['USER_EMAIL']!='' && $bi==$buyer_name_id){$mailToArr[$rows['USER_EMAIL']]=$rows['USER_EMAIL'];}
					if($rows[BYPASS]==2){break;}
				}
			}
			else{
				if($rows['USER_EMAIL']){$mailToArr[$rows['USER_EMAIL']]=$rows['USER_EMAIL'];}
				if($rows[BYPASS]==2){break;}
			}
			
			
			
		}
		
		
		//Un-approve request mail......................................................
		$user_id=$_SESSION['logic_erp']['user_id'];
		$job_id=return_field_value("id", "wo_pre_cost_mst", "job_no='".str_replace("'","",$txt_job_no)."'");
		$approved_no=return_field_value("MAX(approved_no) as approved_no","approval_history","entry_form=46 and mst_id=$job_id","approved_no")+1;
		$unapproved_request=return_field_value("APPROVAL_CAUSE","fabric_booking_approval_cause","entry_form=46 and user_id=$user_id and booking_id=$job_id and approval_type=2 and approval_no='$approved_no'");//page_id=$page_id and
		if($unapproved_request){
			$mailToArr=array();
			if($msil_address){$mailToArr[]=$msil_address;}
			$final_app_user_mail=return_field_value("USER_EMAIL","user_passwd","id in(select APPROVED_BY from APPROVAL_HISTORY where id in(select max(id) from APPROVAL_HISTORY where mst_id=$job_id and ENTRY_FORM=46 and CURRENT_APPROVAL_STATUS=1))");
			$mailToArr[]= $final_app_user_mail;
		}
		$mailBody=$mail_body."<br>".$unapproved_request."<br>".$mailBody;
		//......................................................Un-approve request mail;


		
		$to=implode(',',$mailToArr);
		//echo $to;die;
		 
		
		//Att file....
		$imgSql="select IMAGE_LOCATION,REAL_FILE_NAME from common_photo_library where is_deleted=0  and MASTER_TBLE_ID=$txt_job_no and file_type=1";
		$imgSqlResult=sql_select($imgSql);
		foreach($imgSqlResult as $rows){
			$att_file_arr[]='../../../'.$rows[IMAGE_LOCATION].'**'.$rows[REAL_FILE_NAME];
		}
		
		$subject="BOM Pre Cost Report";
		$header=mailHeader();
		echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
		
	}
	
	//------------------------------------End;
	
	exit();
}

if($action=='mo_sheet_3') //MO Sheet PCS BTN 19 md mamun ahmed sagor-21-11-2021
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$txt_job_no=str_replace("'","",$txt_job_no);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_buyer_name=str_replace("'","",$cbo_buyer_name);
	$txt_style_ref=str_replace("'","",$txt_style_ref);
	$txt_costing_date=str_replace("'","",$txt_costing_date);
	$txt_po_breack_down_id=str_replace("'","",$txt_po_breack_down_id);
	$cbo_costing_per=str_replace("'","",$cbo_costing_per);
	$excess_per_val=str_replace("'","",$excess_per_val);
	$supplier_check=str_replace("'","",$supplier_check);
	//echo $excess_val.'dd';
	if(str_replace("'",'',$txt_po_breack_down_id)=="")
	{
		$txt_po_breack_down_id_cond='';
		$txt_po_breack_down_id_cond1='';
		$txt_po_breack_down_id_cond2='';
		//$txt_po_breack_down_id_cond3='';
	}
	else
	{
		$txt_po_breack_down_id_cond=" and b.id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond1=" and a.id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond2=" and d.po_break_down_id in(".$txt_po_breack_down_id.")";
		//$txt_po_breack_down_id_cond3=" and b.id in(".$txt_po_breack_down_id.")";
	}
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$supplier_name_arr=return_library_array( "select id, supplier_name from  lib_supplier",'id','supplier_name');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	$size_library=return_library_array( "select id, size_name from lib_size where status_active=1 and is_deleted=0", "id", "size_name");
	$trimGroupArr=return_library_array( "select id, item_name from lib_item_group where status_active=1 and is_deleted=0", "id", "item_name");
	$colorArr=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	$sizeArr=return_library_array( "select id, size_name from lib_size where status_active=1 and is_deleted=0", "id", "size_name");

	$result =sql_select("SELECT a.job_no,a.buyer_name,a.style_ref_no,a.ship_mode, a.order_uom,a.gmts_item_id,a.total_set_qnty,b.id,b.po_number,b.po_received_date,b.pub_shipment_date,b.file_no,b.grouping,c.costing_date,c.costing_per, a.job_quantity, a.style_description, b.plan_cut from wo_po_details_master a,wo_po_break_down b,wo_pre_cost_mst c where a.job_no=b.job_no_mst and c.job_no=b.job_no_mst  and c.job_no=a.job_no  and b.job_no_mst='$txt_job_no' $txt_po_breack_down_id_cond and b.status_active=1 and b.is_deleted=0 order by b.pub_shipment_date DESC");
	
	$job_in_orders = array();$job_in_ship_arr = array();
	$pulich_ship_date='';$shipment_date_arr='';
	$job_in_ref = array();
	$job_in_file = array();
	foreach ($result as $val){
		$job_in_orders_arr[$val[csf('id')]]= $val[csf('po_number')];
		$job_in_ship_arr[$val[csf('id')]]= $val[csf('pub_shipment_date')];
		$job_in_recvDate_arr[$val[csf('id')]]= change_date_format($val[csf('po_received_date')]);
		$job_in_ref_arr[$val[csf('id')]]= $val[csf('grouping')];
		$job_in_file_arr[$val[csf('id')]]= $val[csf('file_no')];
		$job_total_set_qnty_arr[$val[csf('job_no')]]= $val[csf('total_set_qnty')];
		
		$gmts_item_id=$val[csf('gmts_item_id')];
		$order_uom=$val[csf('order_uom')];
		$shipment_date_arr.=change_date_format($val[csf('pub_shipment_date')]).',';
		
		$job_no=$val[csf('job_no')];
		$buyer_name=$buyer_arr[$val[csf('buyer_name')]];
		$style_ref_no=$val[csf('style_ref_no')];
		$style_description=$val[csf('style_description')];
		
		$costing_date=$val[csf('costing_date')];
		$costing_per_name=$costing_per[$val[csf('costing_per')]];
		$job_quantity=$val[csf('job_quantity')];
		$plan_cut+=$val[csf('plan_cut')];


	}
	//echo $txt_po_breack_down_id_cond.'DSD';
	$ref_cond=implode(",",array_unique($job_in_ref_arr));
	$file_con=implode(",",array_unique($job_in_file_arr));
	$shipment_date=rtrim($shipment_date_arr,',');
	$shipment_date=implode(",",array_unique(explode(",",$shipment_date)));
	
	$recv_date=implode(",",array_unique($job_in_recvDate_arr));
	//$shipment_date=implode(",",array_unique($job_in_ship_arr));
	$job_in_orders=implode(", ",$job_in_orders_arr);
	$cons_breck_downn= $_SESSION['logic_erp']['cons_breck_downn'];
	
	?>
	<style type="text/css" media="print">
   table { page-break-inside:auto; }
  
        @media print {
        thead {display: table-header-group;}
    }
	@media print {
				table {
					page-break-inside: avoid;
				}
			}  
	</style>
	 <div style="width:1100px; margin:0 auto">	
	<br>
	
	 <div style="font-family:'Arial Narrow';">
        <table style="width:1100px" ><tr><td colspan="6" align="center">
           <?
            $image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id='$cbo_company_name'","image_location");

            $company_info=sql_select("select city, contact_no, zip_code from lib_company where id=$cbo_company_name and status_active=1 and is_deleted=0");
            foreach ($company_info as $row) {
            	$address=$row[csf('city')].' '.$row[csf('zip_code')];
            	$contact=$row[csf('contact_no')];
            }
            ?>
            <img  src='../../<? echo $image_location; ?>' height='70' align="left" />
            <b style="font-size:25px;"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></b><br>
            <b style="font-size:25px;"><? echo $address; ?></b><br>
            <b style="font-size:25px;"><? echo $contact; ?></b><br>
            <b style="font-size:14px;">BOM / Materilas Details</b>
        </td></tr></table>
        
        <table style="width:1100px; font-family:Arial Narrow" border="0" >
			<table width="100%"  class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all">
				<tr>
					<td width="80">Buyer</td>
					<td width="80"><b><? echo $buyer_name; ?></b></td>					
					<td width="80">Job No</td>
					<td width="80"><b><? echo $job_no; ?></b></td>					
					<td width="80">Job/Style Qty</td>
					<td width="80"><b><? echo $job_quantity.' '.$unit_of_measurement[$order_uom]; ?></b></td>
				</tr>				
				<tr>
					<td>Style Ref.</td>
					<td><b><?= $style_ref_no  ?></b></td>
					<td>Style Description</td>
					<td><b><?= $style_description  ?></b></td>
					<td>Plan Cut Qty </td>
					<td><b><?= $plan_cut.' '.$unit_of_measurement[$order_uom]; ?></b></td>
				</tr>
			</table>
		
			
		</table>
		<br/>
		<?
		 $color_size_sql= "SELECT a.po_number,a.id as po_id,b.item_number_id,b.color_number_id,b.size_number_id,avg(b.excess_cut_perc) as excess_cut_perc,sum(b.plan_cut_qnty) as plan_cut_qnty,sum(b.order_quantity) as order_quantity, b.country_id from wo_po_break_down a,wo_po_color_size_breakdown b where  b.po_break_down_id=a.id  and b.job_no_mst='".$txt_job_no."'  and  a.is_deleted=0 and a.status_active=1 and  b.is_deleted=0 and b.status_active=1 $txt_po_breack_down_id_cond1 group by a.po_number,a.id,b.size_number_id,item_number_id,b.color_number_id, b.country_id order by b.item_number_id,b.size_number_id ";

			$result_color=sql_select($color_size_sql);
			$color_size_array=array();
			$poItemColorSizeArr=array(); $poCountryItemColorSizeArr=array();
			foreach($result_color as $row)
			{
				$poItemColorSizeArr[$row[csf("po_id")]][$row[csf("item_number_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['poqty']+=$row[csf("order_quantity")];
				$poItemColorSizeArr[$row[csf("po_id")]][$row[csf("item_number_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['planqty']+=$row[csf("plan_cut_qnty")];
				$poCountryItemColorSizeArr[$row[csf("po_id")]][$row[csf("country_id")]][$row[csf("item_number_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['poqty']+=$row[csf("order_quantity")];

				$color_size_array[$row[csf("po_id")]][$row[csf("item_number_id")]][$row[csf("color_number_id")]]=$row[csf("order_quantity")];
				$po_size_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['po_qty']=$row[csf("order_quantity")];
				$po_size_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['plan_cut_qnty']=$row[csf("plan_cut_qnty")];
				$po_color_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]]['order_quantity']=$row[csf("order_quantity")];
				//$po_size_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['tot_row']+=0;
				if($row[csf("excess_cut_perc")]>0)
				{
				$po_size_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['excess_cut_perc']=$row[csf("excess_cut_perc")];
				}
				$po_array[$row[csf("po_id")]]['po_no']=$row[csf("po_number")];
				$po_array[$row[csf("po_id")]]['item_number_id']=$row[csf("item_number_id")];
				
				$po_color_array[$row[csf("po_id")]][$row[csf("item_number_id")]]['color_number_id'].=$row[csf("color_number_id")].',';
				$item_color_size_array[$row[csf("item_number_id")]][$row[csf("color_number_id")]]+=$row[csf("order_quantity")];

				
			}
			$size_sql= "SELECT b.size_number_id,sum(b.order_quantity) as order_quantity,sum(b.plan_cut_qnty) as plan_cut_qnty from wo_po_break_down a,wo_po_color_size_breakdown b where  b.po_break_down_id=a.id  and b.job_no_mst='".$txt_job_no."' and  a.is_deleted=0 and a.status_active=1 and  b.is_deleted=0 and b.status_active=1 $txt_po_breack_down_id_cond1 group by b.size_number_id,b.size_order order by b.size_order";

			$result_size=sql_select($size_sql);
			$posize_array=array();
			foreach($result_size as $row)
			{
				$posize_array[$row[csf("size_number_id")]]=$row[csf("size_number_id")];
			}

			$po_rowspan_arr=array();$po_item_rowspan_arr=array();
			foreach($color_size_array as $pokey=>$po_data)
			{
				$po_row_span=0;
				foreach($po_data as $itemkey=>$item_data)
				{
					$item_row_span=0;$color_row_span=0;
					foreach($item_data as $colorkey=>$val)
					{
						$item_row_span++;
						$po_row_span++;
						//$po_item_color_rowspan_arr[$pokey][$itemkey][$colorkey]=$color_row_span;
						$color_row_span++;
					}
					$itempo_rowspan_arr[$pokey][$itemkey][$colorkey]=$color_row_span;
					$po_item_rowspan_arr[$pokey][$itemkey]=$item_row_span;
					$po_rowspan_arr[$pokey]=$po_row_span;
					
				}
			}

			//print_r($itempo_rowspan_arr);
			?>
            <br/>
			<div style="width:100%">
             <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:auto;text-align:center; font-family:Arial Narrow" rules="all">
            <label style="text-align:center"><b>Size and Color  Breakdown:</b></label>
                <tr style="font-weight:bold">
                	<td width="60">SL.</td>
                    <td width="110">Buyer PO</td>
					<td width="110">Item</td>
                    <td width="120">Color</td>
					   <?
                    foreach ($posize_array as $sizid)
                    {
                        //$size_count=count($sizid);
                        ?>
                            <th width="60"><strong><? echo  $size_library[$sizid];  ?></strong></th>
                        <?
                    }
                    ?>
                    <td  width="80"> Total Order Qty.</td>
					<td  width="60"> Ex.Cut %</td>
					<td  width="80">Plan Cut Qty</td>
                    </tr>
                    <?
					$k=1; $total_qnty=$total_plan_qnty=0;$grd_total_qnty=$grd_total_plan_qnty=0;
                    foreach ($color_size_array as $pokey=>$po_data)
					{
						$m=1;
						foreach ($po_data as $itemkey=>$item_data)
						{
							$n=1;
							foreach ($item_data as $colorkey=>$color_data)
							{
								$po_rowspan=$po_rowspan_arr[$pokey];
								$item_po_rowspan=$po_item_rowspan_arr[$pokey][$itemkey];
								$item_po_rowspan_row=$itempo_rowspan_arr[$itemkey][$colorkey];
								
								$color_number_id=rtrim($po_color_array[$pokey][$itemkey]['color_number_id']);
								$color_ids=explode(",",$color_number_id);
								$color_row=count($color_row);
								//echo $color_row.', ';
							?>
							<tr>
								<?
                                if($m==1)
                                {
									?>
									<td rowspan="<? echo $po_rowspan;?>"><? echo $k;?></td>
									<td rowspan="<? echo $po_rowspan;?>" align="left"><? echo $po_array[$pokey]['po_no']; ?></td>
									<?
                                }
								if($n==1)
                                {
									?>
									<td  rowspan="<? echo $item_po_rowspan;?>" align="left"><? echo $garments_item[$itemkey]; ?></td>
									<?
                                }
                                ?>
								
                                <td align="left"><? echo $color_library[$colorkey]; ?></td>
                                <?
                                $po_size_qty=0;$tot_qnty=array();
                                foreach ($posize_array as $sizval)
                                {
									$size_count=count($sizval);
									$po_size_qty=$po_size_qty_array[$pokey][$colorkey][$sizval]['po_qty'];
									$plan_cut_qnty=$po_size_qty_array[$pokey][$colorkey][$sizval]['plan_cut_qnty'];
									$excess_cut_perc=$po_size_qty_array[$pokey][$colorkey][$sizval]['excess_cut_perc'];
									$tot_excess_cut_per[$pokey][$colorkey]+=$excess_cut_perc;
									?>
									<td align="right"><? echo fn_number_format($po_size_qty,0); ?></td>
									<?
									$tot_qnty[$pokey][$colorkey]+=$po_size_qty;
									$tot_plan_qnty[$pokey][$colorkey]+=$plan_cut_qnty;
									$tot_qnty_size[$sizval]+=$po_size_qty;
									$tot_qnty_item_size[$sizval]+=$po_size_qty;
									$grd_tot_qnty_size[$sizval]+=$po_size_qty;
									$size_tot_qty+=$item_color_size_array[$pokey][$itemkey][$colorkey];
                                }
                               
								//if($n==1)
                                //{
									$tot_excess_cut_per=(($tot_plan_qnty[$pokey][$colorkey]-$tot_qnty[$pokey][$colorkey])/$tot_qnty[$pokey][$colorkey])*100;
									?>
									
									<td align="right" rowspan="<? //echo $item_po_rowspan;?>" ><? echo fn_number_format($tot_qnty[$pokey][$colorkey],0); ?></td>
									<td align="right" rowspan="<? //echo $item_po_rowspan;?>" ><? echo fn_number_format($tot_excess_cut_per,2); ?></td>
									<td align="right" rowspan="<? //echo $item_po_rowspan;?>" ><? echo fn_number_format($tot_plan_qnty[$pokey][$colorkey],0); ?></td>
									<?
                                //}
								?>
                                
							</tr>
							<?
							$total_qnty+=$tot_qnty[$pokey][$colorkey];
							$total_plan_qnty+=$tot_plan_qnty[$pokey][$colorkey];
							$total_item_qnty+=$tot_qnty_item_size[$pokey][$colorkey];
							$grd_total_qnty+=$tot_qnty[$pokey][$colorkey];
							$grd_total_plan_qnty+=$tot_plan_qnty[$pokey][$colorkey];
							$m++;$n++;
							}
							
							?>
							
						  <?
						}
						?>
					 <tr>
						<td colspan="4" align="right"><strong>PO Sub Total :</strong></td>
						<?
						foreach ($posize_array as $sizval)
						{
							?>
							<td align="right"><b><?php echo fn_number_format($tot_qnty_size[$sizval],0);unset($tot_qnty_size[$sizval]); ?></b></td>
							<?
						}
						?>
						<td align="right"><b><?php echo fn_number_format($total_qnty,0);unset($total_qnty); ?></b></td>
						<td align="right"><b><?php //echo fn_number_format($total_qnty,0);unset($total_qnty); ?></b></td>
						<td align="right"><b><?php echo fn_number_format($total_plan_qnty,0);unset($total_plan_qnty); ?></b></td>
					</tr>
						<?
					  $k++;
					}
					?>
                    <tr>
                    <td colspan="4" align="right"><strong>Job Total :</strong></td>
                    <?
					foreach ($posize_array as $sizval)
					{
						?>
						<td align="right"><b><?php echo fn_number_format($grd_tot_qnty_size[$sizval],0); ?></b></td>
						<?
					}
                    ?>
                    <td align="right"><b><?php echo fn_number_format($grd_total_qnty,0); ?></b></td>
					<td align="right"><b><?php //echo fn_number_format($grd_total_qnty,0); ?></b></td>
					<td align="right"><b><?php echo fn_number_format($grd_total_plan_qnty,0); ?></b></td>
                </tr>
               </table>
			   </div>
			   <br/>
			  <br/>  
			  <?
				$condition= new condition();
				 if($txt_po_breack_down_id!='' || $txt_po_breack_down_id!=0)
				 {
					$condition->po_id("in($txt_po_breack_down_id)"); 
				 }
				  if(str_replace("'","",$txt_job_no)!='')
				 {
					$condition->job_no("in('$txt_job_no')");
				 }
				 
				$condition->init();
				$costPerArr=$condition->getCostingPerArr();
				$costPerQty=$costPerArr[$txt_job_no];
				//echo $costPerQty.'DDDDDDD';
				$fabric= new fabric($condition);
				$trims= new trims($condition);
				$emblishment= new emblishment($condition);
				$wash= new wash($condition);
				$fabric_qty_arr=$fabric->getQtyArray_by_FabriccostidAndGmtscolor_knitAndwoven_greyAndfinish();
				 $nom_sup_cond="";
				 if($supplier_check==1)
				 {
				 	$nom_sup_cond=" and c.fabric_source=2 and (c.nominated_supp is null or c.nominated_supp=0) ";
				 }
				$sql_fab_color="select d.pre_cost_fabric_cost_dtls_id as fab_dtl_id,d.gmts_color_id,d.contrast_color_id from wo_pre_cost_fabric_cost_dtls c,wo_pre_cos_fab_co_color_dtls d
				 where c.job_no=d.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and c.status_active=1 and c.is_deleted=0 and c.job_no='$txt_job_no' $nom_sup_cond ";
				   $fab_result=sql_select($sql_fab_color);
				 foreach($fab_result as $row)
				 {
					$fab_color_arr[$row[csf("fab_dtl_id")]][$row[csf("gmts_color_id")]]=$row[csf("contrast_color_id")];
				 }
			 	$fabric_supplier= sql_select("SELECT id, job_id, job_no, fabric_id, supplier_id from wo_pre_cost_fabric_supplier where job_no='$txt_job_no' and status_active=1 and is_deleted=0");
			 	foreach ($fabric_supplier as $row) {
			 		$fabric_supplier_arr[$row[csf('fabric_id')]][$row[csf('supplier_id')]]=$supplier_name_arr[$row[csf('supplier_id')]];
			 	}				
				$sql_fab="SELECT  a.item_number_id  as item_id,b.id as po_id,a.order_quantity,b.po_quantity,b.po_total_price, b.po_number, b.pub_shipment_date,c.id as fabric_id, c.job_no, c.fab_nature_id as nat_id, c.color_type_id as color_type, c.construction as construction,c.composition,c.fabric_source,c.gsm_weight,c.body_part_id,c.color_size_sensitive,c.width_dia_type, c.avg_cons,c.uom,c.rate, c.amount, c.avg_finish_cons,c.fabric_description, d.dia_width,d.requirment,d.cons,c.nominated_supp,d.remarks ,a.plan_cut_qnty, d.color_number_id, c.color_break_down from wo_po_color_size_breakdown a, wo_po_break_down b,wo_pre_cost_fabric_cost_dtls c,wo_pre_cos_fab_co_avg_con_dtls d  where a.job_no_mst=b.job_no_mst and  c.job_no=a.job_no_mst and  a.po_break_down_id=b.id and c.job_no=a.job_no_mst and d.pre_cost_fabric_cost_dtls_id=c.id and d.po_break_down_id=a.po_break_down_id and d.po_break_down_id=b.id and d.color_size_table_id=a.id and d.job_no=b.job_no_mst and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no_mst='$txt_job_no' and d.cons>0 $txt_po_breack_down_id_cond  $nom_sup_cond group by d.color_number_id,a.item_number_id ,b.id ,a.order_quantity,b.po_quantity,b.po_total_price, b.po_number, b.pub_shipment_date,c.id, c.job_no,c.body_part_id ,c.fab_nature_id , c.color_type_id , c.construction ,c.composition,c.fabric_source,c.gsm_weight,c.color_size_sensitive,c.width_dia_type, c.avg_cons,c.uom,c.rate, c.amount, c.avg_finish_cons,d.dia_width,d.requirment,d.cons,c.nominated_supp,d.remarks,a.plan_cut_qnty,c.fabric_description, c.color_break_down  order by c.id ";
				 //echo $sql_fab; die;
				/*echo '<pre>';
				print_r($fabric_qty_arr); die;*/
				  $fabric_detail_arr=array();
				  $sql_fabs_result=sql_select($sql_fab);
				  foreach ($sql_fabs_result as $row) {
				  	$fabric_qty=$fabric_qty_arr['woven']['grey'][$row[csf('fabric_id')]][$row[csf('color_number_id')]][$row[csf('uom')]];
				  	//$fabric_qty=$row[csf('plan_cut_qnty')];
				  	$fabric_detail_arr[$row[csf('fabric_id')]]['item']=$row[csf('item_id')];
				  	$fabric_detail_arr[$row[csf('fabric_id')]]['color_size_sensitive']=$row[csf('color_size_sensitive')];
				  	$fabric_detail_arr[$row[csf('fabric_id')]]['body_part_id']=$row[csf('body_part_id')];
				  	$fabric_detail_arr[$row[csf('fabric_id')]]['description']=$row[csf('fabric_description')];
				  	$fabric_detail_arr[$row[csf('fabric_id')]]['color_dtls'][$row[csf('color_number_id')]]['gmts_color']=$row[csf('color_number_id')];
				  	$fabric_detail_arr[$row[csf('fabric_id')]]['color_dtls'][$row[csf('color_number_id')]]['supplier']=implode(",", $fabric_supplier_arr[$row[csf('fabric_id')]]);
				  	if($row[csf('color_size_sensitive')]==1){
				  		$fabric_detail_arr[$row[csf('fabric_id')]]['color_dtls'][$row[csf('color_number_id')]]['fabric_color']=$color_library[$row[csf('color_number_id')]];
				  	}
				  	else{
				  		$contest_color_arr=explode("__", $row[csf('color_break_down')]);
				  		foreach ($contest_color_arr as $data) {
				  			$color_arr=explode("_", $data);
				  			$contest_color_str[$color_arr[0]]=$color_arr[2];
				  		}
				  		$fabric_detail_arr[$row[csf('fabric_id')]]['color_dtls'][$row[csf('color_number_id')]]['fabric_color']=$contest_color_str;
				  	}
				  	$fabric_detail_arr[$row[csf('fabric_id')]]['color_dtls'][$row[csf('color_number_id')]]['order_qty']=$fabric_qty;
				  	$fabric_detail_arr[$row[csf('fabric_id')]]['color_dtls'][$row[csf('color_number_id')]]['cons']=$row[csf('requirment')];
				  	$fabric_detail_arr[$row[csf('fabric_id')]]['color_dtls'][$row[csf('color_number_id')]]['uom']=$row[csf('uom')];
				  	$fabric_detail_arr[$row[csf('fabric_id')]]['color_dtls'][$row[csf('color_number_id')]]['required']=$fabric_qty;
				  }

				  /*echo '<pre>';
				  print_r($fabric_detail_arr); die;*/
					

			if(count($fabric_detail_arr)>0){?>
            <table id="table_header_1" class="rpt_table" width="100%" cellpadding="0" cellspacing="0" border="1" rules="all">
           				<caption> <b style="float:left">Fabric Details :</b></caption>
					<thead>
                    	<th width="30">SL</th>
                        <th width="100">Item</th>					
						<th width="100">Body Part</th>
						<th width="200">Description</th>
						<th width="100">Garments Color</th>
						<th width="120">Supplier</th>
						<th width="100">Fabric Color</th>
						<th width="90">Con: with %</th>
						<th width="50">UOM</th> 
						<th width="90">Required Qty </th>
						<th width="90">Remarks</th>
                      
                    </thead>
                    <tbody>
                	<?
                		$i=1;
                		foreach ($fabric_detail_arr as $data) { 
                			$rowspan=count($data['color_dtls']);
                			$k=1;
                		?>
                			<tr>
                				<? if($k==1){ ?>
                				<td rowspan="<?= $rowspan ?>"><?= $i; ?></td>
                				<td rowspan="<?= $rowspan ?>"><?= $garments_item[$data['item']]; ?></td>
                				<td rowspan="<?= $rowspan ?>"><?= $body_part[$data['body_part_id']]; ?></td>
                				<td rowspan="<?= $rowspan ?>"><?= $data['description']; ?></td>
                				<? 
                				}
                					foreach ($data['color_dtls'] as $value) {
                						if($k!=1) echo '<tr>';
                					 ?>
                						<td><?= $color_library[$value['gmts_color']] ?></td>
                						<td><?= $value['supplier'] ?></td>
                						<td>
                						<? if($data['color_size_sensitive']==1){
                							echo $value['fabric_color'];
                						}
                						else{
                							echo $value['fabric_color'][$value['gmts_color']];
                						}
                						?>
                						</td>
                						<td><?= number_format($value['cons'],2) ?></td>
                						<td><?= $unit_of_measurement[$value['uom']] ?></td>
                						<td><?= number_format($value['required'],2) ?></td>
                						<td>&nbsp;</td>
                					<? 
                					$k++;
                				}
                				?>
                			</tr>
                		<? 
                		$i++;
                		}
                	?>
                    </tbody>
            </table>
					<br/>  	
					<?
			}
			?>
			<br>
        	<?
		    $costingPerid=return_field_value("costing_per", "wo_pre_cost_mst", "job_no='$txt_job_no' and status_active=1 and is_deleted=0");
			$costingPerQty=12;
			if($costingPerid==1) $costingPerQty=12;
			elseif($costingPerid==2) $costingPerQty=1;	
			elseif($costingPerid==3) $costingPerQty=24;
			elseif($costingPerid==4) $costingPerQty=36;
			elseif($costingPerid==5) $costingPerQty=48;
			else $costingPerQty=12;
			//echo $gsm_weight_bottom.'DD';
			$gmtsitem_ratio_array=array();
			$grmnt_items = "";
		    $grmts_sql = sql_select("select job_no,gmts_item_id, set_item_ratio from wo_po_details_mas_set_details where job_no='$txt_job_no'");
			foreach($grmts_sql as $key=>$val)
			{
				$grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].'::'.$val[csf("set_item_ratio")].",";
				$gmtsitem_ratio_array[$val[csf('job_no')]][$val[csf('gmts_item_id')]]=$val[csf('set_item_ratio')];	
			}
			$sqlTrims="SELECT a.id, a.job_no, a.trim_group, a.description, a.brand_sup_ref, a.nominated_supp_multi, a.item_print, a.cons_uom, a.remark, a.country, b.po_break_down_id, b.item_number_id, b.color_number_id, b.item_color_number_id, b.size_number_id, b.item_size, b.cons, b.tot_cons, b.place, b.ex_cons from wo_pre_cost_trim_cost_dtls a, wo_pre_cost_trim_co_cons_dtls b where a.id=b.wo_pre_cost_trim_cost_dtls_id and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and b.tot_cons>0 and a.job_no='$txt_job_no' $txt_po_breack_down_id_cond1  order by a.seq, b.id ASC";
			//echo $sqlTrims; die;
			$sqlTrimsRes=sql_select($sqlTrims); $trimGmtsItemColorArr=array(); $trimsidArr=array(); $Color_size_wise=0; $colorsize=0;
			foreach($sqlTrimsRes as $trow)
			{
				$poQty=$set_item_ratio=$rowReqQtyPcs=$rowReqQtyExPcs=0;
				$set_item_ratio=$gmtsitem_ratio_array[$trow[csf('job_no')]][$trow[csf('item_number_id')]];
				
				if($trow[csf('country')]!="")
				{
					$excountry=explode(",",$trow[csf('country')]);
					foreach($excountry as $ctid)
					{
						$poQty+=$poCountryItemColorSizeArr[$trow[csf("po_break_down_id")]][$ctid][$trow[csf("item_number_id")]][$trow[csf("color_number_id")]][$trow[csf("size_number_id")]]['poqty'];
					}
				}
				else
				{
					$poQty=$poItemColorSizeArr[$trow[csf("po_break_down_id")]][$trow[csf("item_number_id")]][$trow[csf("color_number_id")]][$trow[csf("size_number_id")]]['poqty'];
				}
				
				$cons=0;
				//if ($zero_value==1) $cons=$trow[csf("tot_cons")]; else $cons=$trow[csf("cons")];
				
				$rowReqQtyPcs=($poQty/$set_item_ratio)*(number_format($trow[csf("tot_cons")],4,".","")/$costingPerQty);
				$rowReqQtyExPcs=($poQty/$set_item_ratio)*($trow[csf("cons")]/$costingPerQty);
				//echo $poQty.'_'.$set_item_ratio.'_'.$trow[csf("tot_cons")].'_'.$costingPerQty.'<br>';
				$str="";
				$str=$trow[csf("id")].'_'.$trow[csf("trim_group")].'_'.$trow[csf("description")].'_'.$trow[csf("nominated_supp_multi")].'_'.$trow[csf("item_print")].'_'.$trow[csf("cons_uom")].'_'.$trow[csf("remark")];
				if(($trow[csf("item_color_number_id")]*1)==0) $trow[csf("item_color_number_id")]=$trow[csf("color_number_id")];
				if($trow[csf("item_size")]=='0' || $trow[csf("item_size")]=="") $trow[csf("item_size")]=$size_library[$trow[csf("size_number_id")]];
				
				if($trow[csf("item_print")]==1)//ColorWise
				{
					$trimGmtsItemColorArr[$str][$trow[csf("color_number_id")]][$trow[csf("item_color_number_id")]]['req']+=$rowReqQtyPcs;
					$trimGmtsItemColorArr[$str][$trow[csf("color_number_id")]][$trow[csf("item_color_number_id")]]['reqex']+=$rowReqQtyExPcs;
					$trimGmtsItemColorArr[$str][$trow[csf("color_number_id")]][$trow[csf("item_color_number_id")]]['po']+=$poQty;
					$trimGmtsItemColorArr[$str][$trow[csf("color_number_id")]][$trow[csf("item_color_number_id")]]['place']=$trow[csf("place")];
					$colorsize=1;
				}
				else if($trow[csf("item_print")]==2)//Size Wise
				{
					$trimGmtsItemColorArr[$str][$trow[csf("size_number_id")]][$trow[csf("item_size")]]['req']+=$rowReqQtyPcs;
					$trimGmtsItemColorArr[$str][$trow[csf("size_number_id")]][$trow[csf("item_size")]]['reqex']+=$rowReqQtyExPcs;
					$trimGmtsItemColorArr[$str][$trow[csf("size_number_id")]][$trow[csf("item_size")]]['po']+=$poQty;
					$trimGmtsItemColorArr[$str][$trow[csf("size_number_id")]][$trow[csf("item_size")]]['place']=$trow[csf("place")];
					$colorsize=1;
				}else if($trow[csf("item_print")]==3)//color Size Wise
				{
					$gmts_item_size=$trow[csf("size_number_id")]."_".$trow[csf("item_size")];
					$gmts_item_color=$trow[csf("color_number_id")]."_".$trow[csf("item_color_number_id")];

					$trimGmtsItemColorArr[$str][$gmts_item_color][$gmts_item_size]['req']+=$rowReqQtyPcs;
					$trimGmtsItemColorArr[$str][$gmts_item_color][$gmts_item_size]['reqex']+=$rowReqQtyExPcs;
					$trimGmtsItemColorArr[$str][$gmts_item_color][$gmts_item_size]['po']+=$poQty;
					$trimGmtsItemColorArr[$str][$gmts_item_color][$gmts_item_size]['place']=$trow[csf("place")];
					$trimGmtsItemColorArr[$str][$gmts_item_color][$gmts_item_size]['color']=$gmts_item_color;
					$trimGmtsItemColorArr[$str][$gmts_item_color][$gmts_item_size]['size']=$gmts_item_size;
					$Color_size_wise=1;

				}
				else
				{
					$trimGmtsItemColorArr[$str][0][0]['req']+=$rowReqQtyPcs;
					$trimGmtsItemColorArr[$str][0][0]['reqex']+=$rowReqQtyExPcs;
					$trimGmtsItemColorArr[$str][0][0]['po']+=$poQty;
					$trimGmtsItemColorArr[$str][0][0]['place']=$trow[csf("place")];
				}
				$trimsidArr[$trow[csf("id")]]=$trow[csf("id")];
			}
			/*echo '<pre>';
			print_r($trimGmtsItemColorArr); die;*/
			unset($sqlTrimsRes);
			$trimsid=implode(",",$trimsidArr); $trimsimge_arr=array();
			if($trimsid!="")
			{
				$trimsimgesql=sql_select("select master_tble_id, image_location from common_photo_library where form_name='pre_cost_trimsv3' and master_tble_id in ($trimsid) and file_type=1 and is_deleted=0");
				foreach($trimsimgesql as $tirow)
				{
					$trimsimge_arr[$tirow[csf("master_tble_id")]]['img'].=$tirow[csf("image_location")].',';
					$trimsimge_arr[$tirow[csf("master_tble_id")]]['sl']=1;
				}
				unset($trimsimgesql);
			}

			if($colorsize==1){
		?>

        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:100%" rules="all">
        	<thead>
            	<tr>
                	<td colspan="9" align="left"><b>Accessories Details (Color/Size)</b></td>
                </tr>
                <tr>
                	<th width="130">Gmts. Color/Size</th>
                    <th width="130">Item Color/Size</th>
                    <th width="130">Placement</th>
                    <th width="80">Gmts. Qty</th>
                    <th width="80">Cons.</th>
                    <th width="80">Req-Qty</th>
                    <th width="60" bgcolor="<?=$exclucolor; ?>" style=" <?=$dispexacc; ?>">Ex %</th>
                    <th width="80" bgcolor="<?=$exclucolor; ?>" style=" <?=$dispexacc; ?>">Qty Inc. Allow.</th>
                    <th>Remarks</th>
                </tr>
            </thead>
            <tbody>
            <?
			$i=1; $strval=""; $str_array=array();
			//echo '<pre>';print_r($trimGmtsItemColorArr); die;
			foreach($trimGmtsItemColorArr as $strval=>$strdata)
			{
				$gmtcolor=0; $trimtotal=0; $sReqIncluQty=0;
				$exstr=explode("_",$strval);

				if($exstr[4]==1 || $exstr[4]==2 )//Color & size Wise
				{
					foreach($strdata as $gmtcolor=>$gmtdata)
					{
						$itemcolor=0;
						foreach($gmtdata as $itemcolor=>$itemdata)
						{
							
							$nomisupp="";
							if($exstr[3]!="")
							{
							 	$exsupp=explode("_",$exstr[3]);
							 	foreach($exsupp as $supid)
								{
									if($nomisupp=="") $nomisupp=$supplierArr[$supid]; else $nomisupp.=', '.$supplierArr[$supid];
								}
							}
							 
							if (!in_array($strval,$str_array) )
							{
								?>
	                            <tr bgcolor="#FFFFFF" style="font-style:italic">
	                                <td style="word-break:break-all"><?=$trimGroupArr[$exstr[1]]; ?></td>
	                                <td style="word-break:break-all" colspan="5"><?=$exstr[2].', UOM: '.$unit_of_measurement[$exstr[5]]; ?></td>
	                                <td style="word-break:break-all" colspan="<?=$acccolspn; ?>"><?=$nomisupp; ?></td>
	                            </tr>

	                            <?

								
								$trimimg=array_filter(explode(",",$trimsimge_arr[$exstr[0]]['img']));
								if($trimsimge_arr[$exstr[0]]['sl']==1)
								{
									?>
	                                <tr>
	                                	<td colspan="10">
	                                    <?
											foreach($trimimg as $imgshow)
											{
												?>
	                                            <img src='../../<?=$imgshow; ?>' height='40' align="left" width='70' />
	                                            <?
											}
										?>
	                                    </td>
	                                </tr>
	                                <?
								}
								
								$str_array[]=$strval;            
	                        	$i++; 
							}
							$poqtyDzn=($itemdata['po']/12);
							$reqqtyDzn=($itemdata['req']/$itemdata['po'])*12;
							$reqQty=$itemdata['req'];
							$reqIncluQty=$itemdata['reqex'];
							$trimtotal+=$reqQty;
							$exPer=(($reqIncluQty-$reqQty)/$reqQty)*100;
							$sReqIncluQty+=$reqIncluQty;
							//echo $itemdata['po'].'=<br>';
							?>
							<tr>
								<? if($exstr[4]==1)//Color Wise
								{
									?>
	                                <td style="word-break:break-all"><?=$colorArr[$gmtcolor]; ?></td>
	                                <td style="word-break:break-all"><?=$colorArr[$itemcolor]; ?></td>
								<? }  else if($exstr[4]==2) { //Size Wise
								?>
	                                <td style="word-break:break-all"><?=$size_library[$gmtcolor]; ?></td>
	                                <td style="word-break:break-all"><?=$itemcolor; ?></td>
								<? } else { //No
									?>
									<td style="word-break:break-all"><? //=$sizeArr[$gmtcolor]; ?>&nbsp;</td>
									<td style="word-break:break-all"><? //=$sizeArr[$itemcolor]; ?>NO</td>
									<?
								}
								?>
	                            <td style="word-break:break-all"><?=$itemdata['place']; ?>&nbsp;</td>
								<td style="word-break:break-all" align="center"><?=fn_number_format($poqtyDzn,2); ?></td>
								<td style="word-break:break-all" align="center"><?=fn_number_format($reqqtyDzn,2); ?></td>
								<td style="word-break:break-all" align="center"><?=fn_number_format($reqQty,2); ?></td>
	                            <td style="word-break:break-all; <?=$dispexacc; ?>" align="center" bgcolor="<?=$exclucolor; ?>"><?=fn_number_format($exPer,2); ?></td>
	                            <td style="word-break:break-all; <?=$dispexacc; ?>" align="center" bgcolor="<?=$exclucolor; ?>"><?=fn_number_format($reqIncluQty,2); ?></td>
								<td style="word-break:break-all"><?=$exstr[6]; ?></td>
							</tr>
							<?
						}
					}
					?>
	                <tr bgcolor="#CCCCCC">
	                    <td colspan="5" align="right">Sub Total=</td>
	                    <td style="word-break:break-all" align="center"><?=fn_number_format($trimtotal,2); ?></td>
	                    <td bgcolor="<?=$exclucolor; ?>" style=" <?=$dispexacc; ?>">&nbsp;</td>
	                    <td style="word-break:break-all; <?=$dispexacc; ?>" align="center" bgcolor="<?=$exclucolor; ?>"><?=fn_number_format($sReqIncluQty,2); ?></td>
	                    <td>&nbsp;</td>
	                </tr>
	                <?
				}
		 }
			?>
            </tbody>
        </table>
		<? }
		if($Color_size_wise==1){ ?>
		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:100%" rules="all">
        	<thead>
            	<tr>
                	<td colspan="11" align="left"><b>Accessories Details</b><br>(Color & Size Wise)</td>
                </tr>
                <tr>
                	<th width="130">Gmts. Color</th>
                    <th width="130">Item Color</th>
					<th width="130">Gmts. Size</th>
                    <th width="130">Item Size</th>
                    <th width="130">Placement</th>
                    <th width="80">Gmts. Qty</th>
                    <th width="80">Cons.</th>
                    <th width="80">Req-Qty </th>
                    <th width="60" bgcolor="<?=$exclucolor; ?>" style=" <?=$dispexacc; ?>">Ex %</th>
                    <th width="80" bgcolor="<?=$exclucolor; ?>" style=" <?=$dispexacc; ?>">Qty Inc. Allow.</th>
                    <th>Remarks</th>
                </tr>
            </thead>
            <tbody>
            <?
			$i=1; $strval=""; $str_array=array();
			foreach($trimGmtsItemColorArr as $strval=>$strdata)
			{
				$gmtcolor=0; $trimtotal=0; $sReqIncluQty=0;
				$exstr=explode("_",$strval);

				if($exstr[4]==3)//Color & size Wise
				{
					foreach($strdata as $gmtcolor=>$gmtdata)
					{
						$itemcolor=0;
						foreach($gmtdata as $itemcolor=>$itemdata)
						{
							

								$nomisupp="";
								if($exstr[3]!="")
								{
									$exsupp=explode("_",$exstr[3]);
									foreach($exsupp as $supid)
									{
										if($nomisupp=="") $nomisupp=$supplierArr[$supid]; else $nomisupp.=', '.$supplierArr[$supid];
									}
								}
								
								$color=explode("_",$gmtcolor);
								$size=explode("_",$itemcolor);

								if (!in_array($strval,$str_array) )
								{
									?>
									<tr bgcolor="#FFFFFF" style="font-style:italic">
										<td style="word-break:break-all"><?=$trimGroupArr[$exstr[1]]; ?></td>
										<td style="word-break:break-all" colspan="7"><?=$exstr[2].', UOM: '.$unit_of_measurement[$exstr[5]]; ?></td>
										<td style="word-break:break-all" colspan="<?=$acccolspn; ?>"><?=$nomisupp; ?></td>
									</tr>

									<?

									
									$trimimg=array_filter(explode(",",$trimsimge_arr[$exstr[0]]['img']));
									if($trimsimge_arr[$exstr[0]]['sl']==1)
									{
										?>
										<tr>
											<td colspan="10">
											<?
												foreach($trimimg as $imgshow)
												{
													?>
													<img src='../../<?=$imgshow; ?>' height='40' align="left" width='70' />
													<?
												}
											?>
											</td>
										</tr>
										<?
									}
									
									$str_array[]=$strval;            
									$i++; 
								}
								$poqtyDzn=($itemdata['po']/12);
								$reqqtyDzn=($itemdata['req']/$itemdata['po'])*12;
								$reqQty=$itemdata['req'];
								$reqIncluQty=$itemdata['reqex'];
								$trimtotal+=$reqQty;
								$exPer=(($reqIncluQty-$reqQty)/$reqQty)*100;
								$sReqIncluQty+=$reqIncluQty;
								//echo $itemdata['po'].'=<br>';
							
								?>
								<tr>
									
									<td style="word-break:break-all"><?=$colorArr[$color[0]]; ?></td>
									<td style="word-break:break-all"><?=$colorArr[$color[1]]; ?></td>
									<td style="word-break:break-all"><?=$size_library[$size[0]]; ?></td>
	                                <td style="word-break:break-all"><?=$size[1]; ?></td>
									
									<td style="word-break:break-all"><?=$itemdata['place']; ?>&nbsp;</td>
									<td style="word-break:break-all" align="center"><?=fn_number_format($poqtyDzn,2); ?></td>
									<td style="word-break:break-all" align="center"><?=fn_number_format($reqqtyDzn,2); ?></td>
									<td style="word-break:break-all" align="center"><?=fn_number_format($reqQty,2); ?></td>
									<td style="word-break:break-all; <?=$dispexacc; ?>" align="center" bgcolor="<?=$exclucolor; ?>"><?=fn_number_format($exPer,2); ?></td>
									<td style="word-break:break-all; <?=$dispexacc; ?>" align="center" bgcolor="<?=$exclucolor; ?>"><?=fn_number_format($reqIncluQty,2); ?></td>
									<td style="word-break:break-all"><?=$exstr[6]; ?></td>
								</tr>
								<?
						  }
						
					}
					?>
	                <tr bgcolor="#CCCCCC">
	                    <td colspan="7" align="right">Sub Total=</td>
	                    <td style="word-break:break-all" align="center"><?=fn_number_format($trimtotal,2); ?></td>
	                    <td bgcolor="<?=$exclucolor; ?>" style=" <?=$dispexacc; ?>">&nbsp;</td>
	                    <td style="word-break:break-all; <?=$dispexacc; ?>" align="center" bgcolor="<?=$exclucolor; ?>"><?=fn_number_format($sReqIncluQty,2); ?></td>
	                    <td>&nbsp;</td>
	                </tr>
	                <?
				}}
			?>
            </tbody>
        </table>
        <?
		}
        $item_group_arr=return_library_array( "select item_name,id from lib_item_group where item_category=4 order by item_name", "id", "item_name");
		$supplier_library=return_library_array( "select a.supplier_name,a.id from  lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id  and a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
		
		$trims_qty_arr=$trims->getQtyArray_by_jobItemidDescriptionGmtcolorAndSizeid();
		$trims_item_qty_arr=$trims->getQtyArray_by_jobAndItemid();
		$trims_desc_qty_arr=$trims->getQtyArray_by_jobItemidAndDescription(); 
		
		// $trims_dtl_qty_arr=$trims->getQtyArray_by_OrderPrecostdtlsidGmtscolorAndGmtssize();

		$trims_data=sql_select("SELECT a.job_no AS job_no,a.total_set_qnty AS total_set_qnty,b.id AS id,c.item_number_id AS item_number_id,c.country_id AS country_id,c.color_number_id AS 	color_number_id,c.size_number_id size_number_id,c.article_number AS article_number, c.order_quantity AS order_quantity ,c.plan_cut_qnty AS plan_cut_qnty ,
		c.size_order AS size_order,d.id AS pre_cost_dtls_id,d.trim_group AS trim_group,d.source_id AS source_id,d.description AS description ,
		d.cons_uom AS cons_uom,d.cons_dzn_gmts cons_dzn_gmts,d.rate AS rateMst,d.amount AS amount, e.cons AS cons,e.tot_cons AS tot_cons,e.country_id AS
		 country_id_trims ,e.rate AS rate,e.sourcing_rate AS sourcing_rate  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c, wo_pre_cost_trim_cost_dtls d, wo_pre_cost_trim_co_cons_dtls e  where 1=1 and a.job_no in('$txt_job_no') and a.id=b.job_id and b.id=c.po_break_down_id and a.id=d.job_id and d.id=e.wo_pre_cost_trim_cost_dtls_id and b.id=e.po_break_down_id  and c.item_number_id= e.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.size_number_id and e.cons>0  and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active in(1,3) and c.is_deleted=0 and c.status_active in(1,3) and d.is_deleted=0 and d.status_active=1 and e.is_deleted=0 and e.status_active=1 and d.item_print=0");

		 $trims_dtl_qty_arr=array();
			foreach($trims_data as $rows){

					$trims_dtl_qty_arr[$rows[csf("id")]][$rows[csf("pre_cost_dtls_id")]][$rows[csf("color_number_id")]][$rows[csf("size_number_id")]]['gmts_qty']+=$rows[csf("plan_cut_qnty")];
			}

	 $nom_sup_cond="";
	 if($supplier_check==1)
	 {
	 	$nom_sup_cond=" and ( c.nominated_supp_multi is null or c.nominated_supp_multi='' or c.nominated_supp_multi=0)";
	 }

	 $sql_trim_color="SELECT c.id,c.job_no,c.trim_group,c.description,c.brand_sup_ref,c.nominated_supp_multi as nominated_supp,c.cons_uom,c.remark,d.wo_pre_cost_trim_cost_dtls_id as fab_dtl_id,d.item_size,d.color_number_id,d.item_number_id,d.size_number_id,d.po_break_down_id as po_id,d.excess_per,d.cons,d.tot_cons,c.source_id,d.place,c.cons_dzn_gmts from wo_pre_cost_trim_cost_dtls c,wo_pre_cost_trim_co_cons_dtls d
	 where c.job_no=d.job_no and d.wo_pre_cost_trim_cost_dtls_id=c.id and c.status_active=1 and c.is_deleted=0 and d.cons>0 and c.job_no='$txt_job_no' $txt_po_breack_down_id_cond2 $nom_sup_cond and c.item_print=0 order by c.id,c.trim_group";
	//   echo  $sql_trim_color;
	 $trim_result=sql_select($sql_trim_color);$tot_trim_req_qty=0;
	 foreach($trim_result as $row)
	 {
		if($excess_per_val>0)
		{
			$total_set_qnty=$job_total_set_qnty_arr[$row[csf('job_no')]];
			$order_quantity=$po_color_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]]['order_quantity'];
			$tot_cons_qnty=$row[csf("tot_cons")]+($row[csf("tot_cons")]*$excess_per_val)/100;
			$trim_req_qty=($order_quantity/$total_set_qnty)*($tot_cons_qnty/$costPerQty);
			$excess_per=$excess_per_val;		
		}
		else
		{			
			$excess_per=0;
			$excess_per=$row[csf("excess_per")];
			$tot_cons_qnty=$row[csf("cons")];
			$trim_req_qty=$trims_dtl_qty_arr[$row[csf("po_id")]][$row[csf("id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['gmts_qty'];
		}
		$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['description']=$row[csf("description")];
		$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['nominated_supp']=$row[csf("nominated_supp")];
		$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['size_number_id']=$row[csf("size_number_id")];
		$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['job_no']=$row[csf("job_no")];
		$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['item_size']=$row[csf("item_size")];
		$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['remark']=$row[csf("remark")];
		$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['cons_uom']=$row[csf("cons_uom")];
		$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['cons']=$row[csf("tot_cons")];
		$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['source_id']=$row[csf("source_id")];
		$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['place']=$row[csf("place")];
		$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['cons_dzn_gmts']=$row[csf("cons_dzn_gmts")];

		//$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['tot_size_cons']+=$trims_qty_arr[$row[csf("job_no")]][$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]];
		$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['tot_size_cons']+=$trim_req_qty;
		$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['tot_cons']=$tot_cons_qnty;
		$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['excess_per']=$excess_per;
		$item_tot_qty_arr[$row[csf("trim_group")]][$row[csf("description")]]+=$trim_req_qty;
		
	 }
	// echo $tot_trim_req_qty.', ';
	  	foreach($trims_color_arr as $trim_key=>$trim_data)
		 {
			  $trim_color_rowspan=0;
			   foreach($trim_data as $desc_key=>$desc_data)
		 	   {
			   $trim_desc_rowspan=0;
			    foreach($desc_data as $gmt_color_key=>$color_data)
		 	    {
					$item_size_rowspan=0;
					foreach($color_data as $size_key=>$val)
					{
						$item_size_rowspan++;
						$trim_desc_rowspan++;
						$trim_color_rowspan++;
						$color_qty[$trim_key][$desc_key][$gmt_color_key]+=$val['tot_size_cons'];
						$trim_color_rowspan_arr[$trim_key][$desc_key][$gmt_color_key]+=1;
					}
					$item_size_rowspan_arr[$trim_key][$desc_key][$gmt_color_key]=$item_size_rowspan;
					$trim_desc_rowspan_arr[$trim_key][$desc_key]=$trim_desc_rowspan;
					$trim_size_rowspan_arr[$trim_key]=$trim_color_rowspan;
					
				}
			   }
		}
	 	//print_r($trim_size_rowspan_arr);
		 if(count($trims_color_arr)>0){
		?>
		 <table id="table_header_1" class="rpt_table" width="100%" cellpadding="0" cellspacing="0" border="1" rules="all">
			<caption> <b style="float:left">Accessories Details:(Item Wise)</b></caption>
		<thead>
        	<th width="30">SL</th>
            <th width="100">Item</th>
			<th width="120">Description</th>
			<th width="100">Supplier</th>
			<th width="100">Placement</th>
			<th width="80">GMT Qty</th>
			<th width="80">Cons. </th>
			<th width="50">UOM</th> 
			<th width="80">Total Qty </th>
        </thead>
		<tbody>
		 <?

		 	$supplier_library_fabric=return_library_array( "select a.id, a.supplier_name from lib_supplier a where a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
				
			 $j=1;$total_trim_cons=$total_tot_trim_cons_qty=$total_tot_item_qty_cons=$total_trim_qty_cons=0;
			 foreach($trims_color_arr as $trim_key=>$trim_data)
			 {
			  $k=1;
			  foreach($trim_data as $desc_key=>$desc_data)
			   {
			   $n=1;
			   foreach($desc_data as $gmt_color_key=>$color_data)
				{
			   $m=1;$c=1;
				foreach($color_data as $size_key=>$val)
				 {

					if($col_size_cons_arr[$trim_key][$gmt_color_key]>0)
					{
					$tot_size_qty=$col_size_cons_arr[$trim_key][$gmt_color_key];
					}
					if($item_tot_cons_arr[$trim_key]>0)
					{
					$item_tot_size_qty=$item_tot_cons_arr[$trim_key];
					}
					$job_no=$val['job_no'];
					$item_size=$val['item_size'];
					$tot_size_cons=$val['tot_size_cons'];
					
					$gmt_item_desc_qty=$item_tot_qty_arr[$trim_key][$desc_key];
					$gmt_size_qty=$tot_size_cons;
				

					$nominated_supp_str="";
					$exsupp=explode(",",$val["nominated_supp"]);
					foreach($exsupp as $sid)
					{
						if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_fabric[$sid]; else $nominated_supp_str.=','.$supplier_library_fabric[$sid];
					}  

					$key=$trim_key."*".$desc_key;
					$item_wise_data_arr[$key]['desc']=$desc_key;
					$item_wise_data_arr[$key]['supplier']=$nominated_supp_str;
					$item_wise_data_arr[$key]['place']=$val['place'];
					$item_wise_data_arr[$key]['cons_dzn_gmts']=$val['cons_dzn_gmts'];
					$item_wise_data_arr[$key]['tot_size_cons']+=$val['tot_size_cons'];;
					$item_wise_data_arr[$key]['tot_cons']+=$val['tot_cons'];;
					$item_wise_data_arr[$key]['gmts_qty']+=$gmt_size_qty;;
					$item_wise_data_arr[$key]['uom']=$unit_of_measurement[$val['cons_uom']];;
					$item_wise_data_arr[$key]['item']=$item_group_arr[$trim_key];
					$item_wise_data_arr[$key]['total_qty']+=$gmt_size_qty*$val['tot_cons'];;
					

				 }
				}
			  }
	    	}

				// echo "<pre>";
				// print_r($item_wise_data_arr);

			foreach($item_wise_data_arr as $val){
		?>
			
			<tr bgcolor="<? echo $bgcolor;?>" onClick="change_color('tr_<? echo $j; ?>','<? echo $bgcolor;?>')" id="tr_<? echo $j; ?>">  <?
          	
			?>
				<td width="30" ><? echo $j; ?></td>
				<td width="100" ><? echo $val['item']; ?></td> 
				<td width="120" ><? echo  $val['desc']; ?></td> 	
				<td width="100"   align="center" ><div style="word-break:break-all"><?=$val['supplier'];; ?></div></td>
				<td width="100"  align="center" ><div style="word-break:break-all"><?=$val['place']; ?></div></td>
				<td width="80"  align="center"><div style="word-break:break-all"><? echo fn_number_format($val['gmts_qty'],4); ?></div></td>
				<td width="80"  align="right"><div style="word-break:break-all"><? echo fn_number_format($val['cons_dzn_gmts'],4); ?></div></td>
				<td width="50" align="center"><? echo $val['uom']; ?></td>
				<td width="80"  align="right"><div style="word-break:break-all"><? echo fn_number_format($val['gmts_qty']*$val['cons_dzn_gmts'],2); ?></div></td>
				
           </tr>
		   <?
		   		$total_tot_trim_cons_qty+=$val['gmts_qty'];
				$total_trim_cons+=$val['cons_dzn_gmts'];
				$total_trim_qty_cons+=$val['gmts_qty']*$val['cons_dzn_gmts'];
				$k++;$m++;$n++;
				
		   		}
				?>
				
				<?
			   
		   ?>
			<tfoot>
			<tr>
				<th colspan="5" align="right"> Grand Total </th>
				<th align="right"> <? echo fn_number_format($total_tot_trim_cons_qty,4); ?> </th>
				<th  align="right"> <? echo fn_number_format($total_trim_cons,4); ?> </th>
				<th align="right"> <? //echo fn_number_format($total_tot_trim_qty,4); ?> </th>
				<th align="right"> <? echo fn_number_format($total_trim_qty_cons,2); ?> </th>
			
			
			</tr>
			</tfoot>
		</tbody>
		</table>
		<? } ?>		
			
		</div>
		<br>
		<? echo signature_table(109, $cbo_company_name, "950px"); ?>
	</div>
	<?
	exit();	
}

if($action == "bom_pcs_woven2") //BOM PCS2 Btn 20
{ 
   	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";
	if($cbo_company_name=="" || $cbo_company_name==0) $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="" || $cbo_buyer_name==0) $cbo_buyer_name=''; else  $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";

	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and b.costing_date='".$txt_costing_date."'";
	$txt_po_breack_down_id=str_replace("'",'',$txt_po_breack_down_id);
	if(str_replace("'",'',$txt_po_breack_down_id)=="") $txt_po_breack_down_id_cond=''; else $txt_po_breack_down_id_cond=" and d.id in(".$txt_po_breack_down_id.")";
	$zero_value=str_replace("'",'',$zero_value);
	//echo $zero_value.'dssssss';
    //if($txt_quotation_date=="") $txt_quotation_date=''; else $txt_quotation_date=" and a.quot_date ='".$txt_quotation_date."'";
	$imge_arr=return_library_array( "select master_tble_id,image_location from common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');

    $buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
    $season_name_arr=return_library_array( "select id, season_name from lib_buyer_season",'id','season_name');
    $comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$user_passArr=return_library_array( "select id, user_name from user_passwd",'id','user_name');
	$brand_arr=return_library_array( "select id, brand_name from lib_buyer_brand where status_active=1 and is_deleted=0",'id','brand_name');
	 //pro_ex_factory_mst 
	$sql_ex="select max(ex_factory_date) as ex_factory_date from pro_ex_factory_mst b,wo_po_break_down d where d.id=b.po_break_down_id and d.job_no_mst=$txt_job_no and d.status_active=1";
	$exf_data_array=sql_select($sql_ex);
	foreach( $exf_data_array as $row)
	{
		$ex_factory_date=$row[csf("ex_factory_date")];
	}
	$excess_cut=0;
	$sql_excess="select avg(b.excess_cut_perc) as excess_cut_perc,max(d.pub_shipment_date) as last_pub_shipment_date,min(d.pub_shipment_date) as first_pub_shipment_date from wo_po_color_size_breakdown b,wo_po_break_down d where d.id=b.po_break_down_id and d.job_no_mst=$txt_job_no and b.status_active=1 and d.status_active=1";
	$excess_data_array=sql_select($sql_excess);
	foreach( $excess_data_array as $row)
	{
		$excess_cut=$row[csf("excess_cut_perc")];
		$last_pub_shipment_date=$row[csf("last_pub_shipment_date")];
		$first_pub_shipment_date=$row[csf("first_pub_shipment_date")];
	}
	 
	$sql_po="select a.total_set_qnty as ratio, d.po_number, (d.po_quantity) as po_qnty, d.plan_cut, d.excess_cut, d.unit_price, d.pub_shipment_date, d.po_received_date, d.pack_handover_date from wo_po_break_down d, wo_po_details_master a where d.job_no_mst=a.job_no and d.job_no_mst=$txt_job_no and d.status_active=1 $txt_po_breack_down_id_cond";
	$po_data_array=sql_select($sql_po);
	$order_job_qnty=0; $plan_cut=0; $leadtime_days_remian_cal=""; $ordQtyUom=$planqtyUom=0;
	foreach( $po_data_array as $row)
	{
		$po_received_dateArr.=$row[csf("po_received_date")].',';
		$pack_handover_dateArr.=$row[csf("pack_handover_date")].',';
		$order_job_qnty+=$row[csf("po_qnty")]*$row[csf("ratio")];
		
		$plan_cut+=$row[csf("plan_cut")]*$row[csf("ratio")];
		
		$ordQtyUom+=$row[csf("po_qnty")];
		$planqtyUom+=$row[csf("plan_cut")];
		$days_tot=datediff('d',$row[csf("po_received_date")],$row[csf("pub_shipment_date")])-1;
		$leadtime_days_remian_cal.=$days_tot.',';
		$pub_shipment_dateArr[$row[csf("pub_shipment_date")]]=$row[csf("pub_shipment_date")];
	}
	/*$pub_shipment_dateAll=implode(',',$pub_shipment_dateArr);
	$pub_shipment_dateAllArr=explode(",",$pub_shipment_dateAll);
	$last_pub_shipment_date=max($pub_shipment_dateAllArr);
	$first_pub_shipment_date=min($pub_shipment_dateAllArr);*/
	
	$leadtime_days_remian_calArr=rtrim($leadtime_days_remian_cal,',');
	$leadtime_days_remian_calArr=explode(",",$leadtime_days_remian_calArr);
	$leadtime_days_remian=max($leadtime_days_remian_calArr);
	  
	$po_received_dateArr=rtrim($po_received_dateArr,',');
	$po_received_dateArr=explode(",",$po_received_dateArr);
	$po_received_date=max($po_received_dateArr);
	$pack_handover_dateArr=rtrim($pack_handover_dateArr,',');
	$pack_handover_dateArr=explode(",",$pack_handover_dateArr);
	$pack_handover_date=max($pack_handover_dateArr);
	 
	// $leadtime_days_remian=datediff('d',$po_received_date,$ex_factory_date)-1;
	 
	 $sql = "select a.job_no, a.company_name, b.approved, a.buyer_name, a.quotation_id, a.season_buyer_wise, a.season_year, a.brand_id, a.style_ref_no, a.set_smv, a.gmts_item_id, a.order_uom, a.job_quantity, a.avg_unit_price,b.costing_date,b.sourcing_date, b.costing_per, c.fab_knit_req_kg, c.fab_woven_req_yds, c.fab_yarn_req_kg, a.total_set_qnty as ratio,a.working_company_id from wo_po_details_master a, wo_pre_cost_mst b,wo_pre_cost_sum_dtls c  where a.id=b.job_id and b.job_id=c.job_id and a.status_active=1 and a.job_no=$txt_job_no $company_name $cbo_buyer_name $txt_style_ref";
    //echo $sql; die;
    $data_array=sql_select($sql);
	$working_company_arr=return_library_array("SELECT id,company_name from lib_company ","id","company_name");  
	$working_company='';
	foreach ($data_array as $row)
	{
		$working_company=$working_company_arr[$row[csf("working_company_id")]];
		$approved_id=$row[csf("approved")];
	}
			//echo $approved_id.'d';
    if(empty($path)) $path="../../"; else $path=str_replace("'", "", $path);
    //echo $path;

	ob_start();
    ?>
    <div style="width:1320px; border:1px solid black;margin:5px;" align="center">  
      <style>
	 /* p{ padding:0px !important; margin:0px !important;}*/
	 table td{ font-size:15px;}
	</style>
      <table width="98%" cellpadding="0" cellspacing="0" style="border:1px solid black;margin:5px; font-size:14px;">
           <tr>
               <td width="100"> 
               <img src='<? echo $path .''. $imge_arr[str_replace("'","",$cbo_company_name)]; ?>' height='100%' width='100%' />
               </td>
               <td width="1250">                                     
                    <table width="100%" cellpadding="0" cellspacing="0" >
                        <tr>
                        	<td align="center" style="font-size:20px;"><b><?='Pre Cost Sheet'; ?></b></td>
                        </tr>
                    </table>
                    <br>
                    <table width="100%" cellpadding="0" cellspacing="0">
                        <tr align="center">
                            <td> <b style="font-size:21px;"> PO Rec Unit: </b><span style="font-size:19px;"><?=$comp[str_replace("'","",$cbo_company_name)];?> </span></td>
                            <td ><b style="font-size:21px;">Prod Unit: </b><span style="font-size:19px;"><?=$working_company;?></span></td>
                        </tr>
                    </table>
                </td>       
            </tr>
       </table>
       <br>
       <table align="left" border="0" cellpadding="0" cellspacing="0" style="width:550px; margin:5px;">
            <tr>
            <?
            $order_price_per_dzn=0; $orderUom=0;
		
			foreach ($data_array as $row)
			{
				$avg_unit_price=$row[csf("avg_unit_price")];
				$sourcing_date=$row[csf("sourcing_date")];
				$buyer_name_id=$row[csf("buyer_name")];
				$costing_date=$row[csf("costing_date")];
				$order_values = $order_job_qnty*$avg_unit_price;
				if($row[csf("costing_per")]==1){$order_price_per_dzn=12;$costing_val=" DZN";}
				else if($row[csf("costing_per")]==2){$order_price_per_dzn=1;$costing_val=" PCS";}
				else if($row[csf("costing_per")]==3){$order_price_per_dzn=24;$costing_val=" 2 DZN";}
				else if($row[csf("costing_per")]==4){$order_price_per_dzn=36;$costing_val=" 3 DZN";}
				else if($row[csf("costing_per")]==5){$order_price_per_dzn=48;$costing_val=" 4 DZN";}
			
				$quot_id=$row[csf("quotation_id")];
				$sew_smv=$row[csf("set_smv")];
				$inserted_by=$user_passArr[$row[csf("inserted_by")]];
				?>
                <td valign="top">
                <table class="rpt_table" align="left" border="1" cellpadding="1" cellspacing="1" style="width:550px; margin:5px; font-size:14px;" rules="all">
                    <tr>
                        <td width="80">Job No</td>
                        <td width="80"><b><? echo $row[csf("job_no")]; ?></b></td>
                        <td width="90">Costing </td>
                    </tr>
                    <tr>
                        <td width="80">Quotation ID</td>
                        <td width="80"><b><? echo $quot_id; ?></b></td>
                        <td width="100"><b><? echo $costing_per[$row[csf("costing_per")]]; ?></b></td>
                    </tr>
                    <tr>
                        <td> Costing Date :  </td>
                        <td colspan="2"><b><? echo change_date_format($row[csf("costing_date")],4); ?></b></td>
                    </tr>
                    <tr>
                        <td>Buyer </td>
                        <td colspan="2"><b><? echo $buyer_arr[$row[csf("buyer_name")]]; ?></b></td>
                     </tr> 
                     <tr>
                        <td>Brand </td>
                        <td colspan="2"><b><? //echo $buyer_arr[$row[csf("buyer_name")]];
                        if($row[csf("brand_id")]>0)
                        {
                            echo $brand_arr[$row[csf("brand_id")]];
                        }
                        ?></b></td>
                     </tr> 
                     <tr>
                        <td>Style </td>
                        <td colspan="2"><b><? echo $row[csf("style_ref_no")]; ?></b></td>
                     </tr>
                    <tr>
                        <td width="80">Item</td>
                        <?
                            if($row[csf("order_uom")]==1)
                            {
                              $grmnt_items=$garments_item[$row[csf("gmts_item_id")]];
                            }
                            else
                            {
                                $gmt_item=explode(',',$row[csf("gmts_item_id")]);
                                foreach($gmt_item as $key=>$val)
                                {
                                    $grmnt_items .=$garments_item[$val].", ";
                                }
                            }
                        ?>
                        <td width="100" colspan="2"><b><? echo $grmnt_items; ?></b></td>
                    </tr>
                    <tr>
                        <td>Season</td>
                        <td colspan="2"><b><? echo $season_name_arr[$row[csf('season_buyer_wise')]].'-'.substr( $row[csf('season_year')], -2);  ?></b></td>
                     </tr>
                    <tr>
                        <td>P.O. Qty</td>
                        <td><b><? echo $ordQtyUom.'-'.$unit_of_measurement[$row[csf("order_uom")]]; $po_qty_dzn=$order_job_qnty/$order_price_per_dzn; ?></b></td>
                        <td title="<? echo $offer_qty_dzn;?>"><b><? // echo number_format($po_qty_dzn,0).' '.$costing_val; ?></b></td>
                    </tr>
                    <tr>
                        <td>Plan Cut Qty[<?=number_format($excess_cut,2).'%'; ?>]</td>
                        <td><b><? echo $planqtyUom.'-'.$unit_of_measurement[$row[csf("order_uom")]]; $orderUom=$row[csf("order_uom")]; $offer_qty_dzn=$plan_cut/$order_price_per_dzn; ?></b></td>
                        <td title="<? echo $offer_qty_dzn;?>"><b><? // echo number_format($offer_qty_dzn,0).' '.$costing_val; ?></b></td>
                    </tr>
                </table>
                </td>
              	<?
			} //master part end
			//die;
			$condition= new condition();
			if(str_replace("'","",$txt_job_no) !=''){
				$condition->job_no("=$txt_job_no");
			}
			if(str_replace("'",'',$txt_po_breack_down_id) !="")
			{
				$condition->po_id("in($txt_po_breack_down_id)");
			}
			$condition->init();
			$fabric= new fabric($condition);
			$trim= new trims($condition);
			$wash= new wash($condition);
			$emblishment= new emblishment($condition);
			//echo $fabric->getQuery();die;
			$fabric_qty_arr=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
			//print_r($fabric_qty_arr);
			$fabric_amount_arr=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
			
			$trim_amount_arr=$trim->getAmountArray_precostdtlsid();
			$trim_qty_arr=$trim->getQtyArray_by_precostdtlsid();
			
			$emblishment_qtyArr=$emblishment->getQtyArray_by_jobAndEmblishmentid();
			$emblishment_amountArr=$emblishment->getAmountArray_by_jobAndEmblishmentid();
			$wash_qtyArr=$wash->getQtyArray_by_jobAndEmblishmentid();
			//	print_r($wash_qtyArr);
			$wash_amountArr=$wash->getAmountArray_by_jobAndEmblishmentid();
			
			$sql_determin=sql_select("select a.id,a.type from lib_yarn_count_determina_mst a where a.status_active=1 and a.entry_form=426");
			foreach($sql_determin as $row)
			{
				$determin_type_arr[$row[csf('id')]]=$row[csf('type')];	
			}
			
			if($zero_value==1) $cons_qty_chk=""; else  $cons_qty_chk="b.avg_cons>0";
			
			$pre_fab_arr="select  b.id, b.job_no,b.body_part_id,b.lib_yarn_count_deter_id as deter_min_id, b.fab_nature_id, b.color_type_id, b.fabric_description as fab_desc,b.uom,b.avg_cons,b.avg_cons_yarn, b.avg_process_loss,b.construction,b.composition,b.fabric_source,b.gsm_weight, b.rate,b.amount,b.avg_finish_cons,b.sourcing_rate,b.sourcing_nominated_supp from wo_pre_cost_fabric_cost_dtls  b where  b.status_active=1 and b.is_deleted=0 and b.job_no=$txt_job_no and b.avg_cons>0 order by b.id ";//and b.fabric_source=2
			 //echo $pre_fab_arr; die;
			
			$pre_fab_result=sql_select($pre_fab_arr);
			
			$summ_fob_pcs=0;$summ_fob_gross_value_amt=$summ_sourcing_tot_budget_dzn_val=0;
			foreach($pre_fab_result as $row)
			{
				$pre_c_id=$row[csf('id')];
				$remarks_arr=sql_select("select remarks from wo_pre_cos_fab_co_avg_con_dtls where job_no=$txt_job_no and pre_cost_fabric_cost_dtls_id=$pre_c_id group by remarks");
				$determin_type=$determin_type_arr[$row[csf('deter_min_id')]];
				$body_partId=$body_part[$row[csf('body_part_id')]];
				//$fab_desc=$body_partId.','.$row[csf('fab_desc')];
				$fab_desc=$row[csf('fab_desc')];
				//echo $determin_type.'d';
				$tot_amt=$row[csf('avg_cons')]*$row[csf('rate')];
				$fab_req_qty=$fabric_qty_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]]+$fabric_qty_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$fab_req_amount=$fabric_amount_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]]+$fabric_amount_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$fab_cost_dtls_id=$row[csf('id')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['req_qty']+=$fab_req_qty;
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['req_amount']+=$fab_req_amount;
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['cons']+=$row[csf('avg_finish_cons')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['tot_cons']+=$row[csf('avg_cons')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['amount']+=$row[csf('amount')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['p_loss']=$row[csf('avg_process_loss')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['sourcing_nominated_supp']=$row[csf('sourcing_nominated_supp')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['sourcing_rate']=$row[csf('sourcing_rate')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['fab_desc']=$row[csf('construction')].','.$row[csf('composition')];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['uom']=$unit_of_measurement[$row[csf('uom')]];
				$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['remarks']=$remarks_arr[0][REMARKS];
				$p_fab_precost_tot_row+=1;	
				//Summary
				$summ_fob_pcs+=$row[csf('amount')];
			//	$summ_sourcing_tot_budget_dzn_val+=$fab_req_qty*$row[csf('sourcing_rate')];
				
				$summ_fob_gross_value_amt+=$fab_req_amount;
			}
			$pre_trim_consarr="select b.id,c.trim_type,c.item_name,b.description,b.trim_group,b.cons_dzn_gmts,b.seq,b.cons_uom as uom,avg(d.excess_per) as  excess_per from wo_pre_cost_trim_cost_dtls b,lib_item_group c,wo_pre_cost_trim_co_cons_dtls d where  c.id=b.trim_group and b.id=d.wo_pre_cost_trim_cost_dtls_id and c.trim_type in(1,2) and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and b.job_no=$txt_job_no and b.cons_dzn_gmts>0  group by b.id,c.trim_type,c.item_name,b.description,b.trim_group,b.cons_dzn_gmts,b.cons_uom,b.seq order by b.seq";
			$pre_trim_cons_result=sql_select($pre_trim_consarr);
			foreach($pre_trim_cons_result as $row)
			{
				$trims_type=$row[csf('trim_type')];
				$description=$row[csf('description')];
				if($description!="") $descriptionCond=", ".$description; else $descriptionCond="";
				$item_id=$row[csf('item_name')].$descriptionCond;
				if($trims_type==1) //Sewing
				{
					$p_sew_trim_precost_excess_arr[$item_id]['p_loss']+=$row[csf('excess_per')];
				}
				else
				{
					$p_fin_trim_precost_excess_arr[$item_id]['p_loss']+=$row[csf('excess_per')];;
				}
			}
			//  $pre_trim_arr="select b.seq,b.id,c.trim_type,c.item_name,b.description,b.trim_group,b.tot_cons,b.ex_per ,b.cons_dzn_gmts,b.cons_uom as uom, b.rate,b.amount,b.sourcing_rate,b.sourcing_nominated_supp from wo_pre_cost_trim_cost_dtls b,lib_item_group c where  c.id=b.trim_group and c.trim_type in(1,2) and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and b.job_no=$txt_job_no order by b.seq";//and b.fabric_source=2

			$pre_trim_arr="select b.seq,b.id,c.trim_type,c.item_name,b.description,b.trim_group,b.tot_cons,b.ex_per ,b.cons_dzn_gmts,b.cons_uom as uom, b.rate,b.amount,b.sourcing_rate,b.sourcing_nominated_supp,b.remark from wo_pre_cost_trim_cost_dtls b,lib_item_group c where  c.id=b.trim_group  and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and b.cons_dzn_gmts>0  and b.job_no=$txt_job_no order by b.seq";//and b.fabric_source=2
			$pre_trim_result=sql_select($pre_trim_arr);
			$p_sew_trim_precost_arr=$p_fin_trim_precost_arr=array();
		
			//print_r($p_sew_trim_precost_arr2);
			$pre_wash_arr="select b.job_no,b.id,b.emb_name,b.emb_type,b.cons_dzn_gmts, b.rate,b.amount,b.sourcing_rate,b.sourcing_nominated_supp from wo_pre_cost_embe_cost_dtls  b where  b.status_active=1 and b.is_deleted=0  and b.job_no=$txt_job_no   and b.cons_dzn_gmts>0 order by b.emb_name";//and b.fabric_source=2
			$pre_wash_result=sql_select($pre_wash_arr);
			
			//$summ_sourcing_tot_budget_dzn_val=0;
		 
			foreach($pre_wash_result as $row)
			{
				$emb_name_id=$row[csf('emb_name')];
				$emb_type=$row[csf('emb_type')];
			
				//emblishment_embroy_type_arr
				if($emb_name_id==1) //Print type
				{
					if($emb_type>0) $emb_typeCond=", ".$emblishment_print_type[$emb_type];else $emb_typeCond="";
					$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
				}
				else if($emb_name_id==2) //embro type
				{
					if($emb_type>0) $emb_typeCond=", ".$emblishment_embroy_type_arr[$emb_type];else $emb_typeCond="";
					$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
				}
				else if($emb_name_id==4) //Special type
				{
					if($emb_type>0) $emb_typeCond=", ".$emblishment_spwork_type[$emb_type];else $emb_typeCond="";
					$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
				}
				else if($emb_name_id==5) //GMT type
				{
					if($emb_type>0) $emb_typeCond=", ".$emblishment_gmts_type[$emb_type];else $emb_typeCond="";
					$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
				}
				else if($emb_name_id==99) //GMT type
				{
					if($emb_type>0) $emb_typeCond=", ".$emblishment_other_type_arr[$emb_type];else $emb_typeCond="";
					$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
				}

				$wash_req_amount=$emb_req_amount=0;
				if($row[csf('emb_name')]==3) //Wash
				{
					if($row[csf('emb_type')]>0) $wash_emb_typeCond=", ".$emblishment_wash_type[$row[csf('emb_type')]];else $wash_emb_typeCond="";
					$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$wash_emb_typeCond;
					$wash_req_qty=$wash_qtyArr[$row[csf('job_no')]][$row[csf('id')]];
					$wash_req_amount=$wash_amountArr[$row[csf('job_no')]][$row[csf('id')]];
					// echo $emb_name.'='.$wash_emb_typeCond.' <br>';
						 
					$p_wash_precost_arr[$emb_name]['req_qty']+=$wash_req_qty;
					$p_wash_precost_arr[$emb_name]['req_amount']+=$wash_req_amount;
					$p_wash_precost_arr[$emb_name]['cons']+=$row[csf('cons_dzn_gmts')];
					//$p_wash_precost_arr[$emb_name]['tot_cons']+=$row[csf('cons_dzn_gmts')];
					$p_wash_precost_arr[$emb_name]['amount']+=$row[csf('amount')];
					$p_wash_precost_arr[$emb_name]['p_loss']=$row[csf('p_loss')];
					$p_wash_precost_arr[$emb_name]['sourcing_rate']=$row[csf('sourcing_rate')];
					$p_wash_precost_arr[$emb_name]['pre_rate']=$row[csf('rate')];
					$p_wash_precost_arr[$emb_name]['sourcing_nominated_supp']=$row[csf('sourcing_nominated_supp')];
					$p_wash_precost_arr[$emb_name]['uom']=$unit_of_measurement[$row[csf('uom')]];
					$summ_fob_pcs+=$row[csf('amount')];
					$summ_sourcing_tot_budget_dzn_val+=$wash_req_qty*$row[csf('sourcing_rate')];
					$p_wash_tot_row+=1;	
				}
				else
				{
					$emb_req_qty=$emblishment_qtyArr[$row[csf('job_no')]][$row[csf('id')]];
					$emb_req_amount=$emblishment_amountArr[$row[csf('job_no')]][$row[csf('id')]];
					$p_embro_precost_arr[$emb_name]['req_qty']+=$emb_req_qty;
					$p_embro_precost_arr[$emb_name]['req_amount']+=$emb_req_amount;
					$p_embro_precost_arr[$emb_name]['cons']+=$row[csf('cons_dzn_gmts')];
					//$p_wash_precost_arr[$emb_name]['tot_cons']+=$row[csf('cons_dzn_gmts')];
					$p_embro_precost_arr[$emb_name]['amount']+=$row[csf('amount')];
					$p_embro_precost_arr[$emb_name]['p_loss']=$row[csf('p_loss')];
					$p_embro_precost_arr[$emb_name]['pre_rate']=$row[csf('rate')];
					if($row[csf('sourcing_rate')]>0)
					{
						$p_embro_precost_arr[$emb_name]['sourcing_rate']=$row[csf('sourcing_rate')];
					}
					$p_embro_precost_arr[$emb_name]['sourcing_nominated_supp']=$row[csf('sourcing_nominated_supp')];
					$p_embro_precost_arr[$emb_name]['uom']=$unit_of_measurement[$row[csf('uom')]];
					$summ_fob_pcs+=$row[csf('amount')];
					$summ_sourcing_tot_budget_dzn_val+=$emb_req_qty*$row[csf('sourcing_rate')];
					$p_embro_tot_row+=1;	
				}
				//$summ_fob_value_pcs+=$row[csf('amount')]/$order_price_per_dzn;
				$summ_fob_gross_value_amt+=$emb_req_amount+$wash_req_amount;
			}
			$sql_other = "select fabric_cost, trims_cost, embel_cost, wash_cost, margin_dzn,margin_dzn_percent,comm_cost, commission, lab_test, inspection, cm_cost, freight, currier_pre_cost, certificate_pre_cost, design_cost, studio_cost, common_oh,common_oh_percent, depr_amor_pre_cost, interest_cost, incometax_cost, total_cost,price_dzn from wo_pre_cost_dtls where  job_no=$txt_job_no  and status_active=1 and  is_deleted=0";
			$pre_other_result=sql_select($sql_other);//$summ_fob_value_pcs=0; TOTAL_COST
			foreach( $pre_other_result as $row )
			{
				$cm_cost=$row[csf('cm_cost')];
				$total_fob=$row[csf('price_dzn')];
				$total_cost=$row[csf('total_cost')];
				
				$lab_test=($row[csf('lab_test')]/$order_price_per_dzn)*$ordQtyUom;
				$currier_pre_cost=($row[csf('currier_pre_cost')]/$order_price_per_dzn)*$ordQtyUom;
				$inspection=($row[csf('inspection')]/$order_price_per_dzn)*$ordQtyUom;
				$comarcial=($row[csf('comm_cost')]/$order_price_per_dzn)*$ordQtyUom;
				
				$freight=($row[csf('freight')]/$order_price_per_dzn)*$ordQtyUom;
				$certificate_pre_cost=($row[csf('certificate_pre_cost')]/$order_price_per_dzn)*$ordQtyUom;
				$design_pre_cost=($row[csf('design_cost')]/$order_price_per_dzn)*$ordQtyUom;
				$studio_pre_cost=($row[csf('studio_cost')]/$order_price_per_dzn)*$ordQtyUom;
				$common_oh=($row[csf('common_oh')]/$order_price_per_dzn)*$order_job_qnty;
				$depr_amor_pre_cost=($row[csf('depr_amor_pre_cost')]/$order_price_per_dzn)*$ordQtyUom;
				$interest_pre_cost=($row[csf('interest_cost')]/$order_price_per_dzn)*$ordQtyUom;
				$income_tax_pre_cost=($row[csf('incometax_cost')]/$order_price_per_dzn)*$ordQtyUom;
				
				$operating_oh=$row[csf('common_oh')];
				$operating_oh_per=$row[csf('common_oh_percent')];
				
				$tot_other_for_fob_value=$lab_test+$currier_pre_cost+$inspection+$comarcial+$freight+$certificate_pre_cost+$design_pre_cost+$studio_pre_cost+$common_oh+$interest_pre_cost+$income_tax_pre_cost+$depr_amor_pre_cost;
				//echo $tot_other_for_fob_value;
				$lab_test_dzn=$row[csf('lab_test')];
				$fob_pcs=$row[csf('price_with_commn_pcs')];
				$currier_pre_cost_dzn=$row[csf('currier_pre_cost')];
				$inspection_dzn=$row[csf('inspection')];
				$comarcial_dzn=$row[csf('comm_cost')];
				
				$common_oh_dzn=$row[csf('common_oh')];
				$studio_pre_cost_dzn=$row[csf('studio_cost')];
				$design_pre_cost_dzn=$row[csf('design_cost')];
				$certificate_pre_cost_dzn=$row[csf('certificate_pre_cost')];
				
				$freight_dzn=$row[csf('freight')];
				//$comm_cost_dzn=$row[csf('comm_cost')];
				$depr_amor_pre_cost_dzn=$row[csf('depr_amor_pre_cost')];
				$income_tax_pre_cost_dzn=$row[csf('incometax_cost')];
				$interest_pre_cost_dzn=$row[csf('interest_cost')];
				
				$cm_cost_dzn=$row[csf('cm_cost')];
				$margin_dzn=$row[csf('margin_dzn')];
				$margin_dzn_percent=$row[csf('margin_dzn_percent')];;
				$cm_cost_pcs=$row[csf('cm_cost')]/$order_price_per_dzn;
				$cm_cost_req=($row[csf('cm_cost')]/$order_price_per_dzn)*$order_job_qnty;
				$tot_cm_qty_dzn=$row[csf('cm_cost')]*$po_qty_dzn;
				$cmCost=(($row[csf('cm_cost')]+$row[csf('margin_dzn')])/$order_price_per_dzn)*$ordQtyUom;
				//$lab_test_dzn=$row[csf('lab_test')];
				//echo $cmCost;

				$tot_summ_fob_pcs=$row[csf('total_cost')];
				$tot_other_cost_dzn=$design_pre_cost_dzn+$certificate_pre_cost_dzn+$freight_dzn+$depr_amor_pre_cost_dzn+$income_tax_pre_cost_dzn+$interest_pre_cost_dzn;
				 
				$tot_other_cost=($tot_other_cost_dzn/$order_price_per_dzn)*$ordQtyUom;
				//$summ_fob_value_pcs+=($tot_other_cost_dzn+$currier_pre_cost_dzn+$lab_test_dzn+$inspection_dzn+$comarcial_dzn)*$order_price_per_dzn+$cm_cost_pcs;
				
				// echo $tot_other_for_fob_value.'m';
				$summ_fob_gross_value_amt+=$tot_other_for_fob_value+$tot_cm_qty_dzn ;
				$summ_fob_pcs+=$tot_other_cost_dzn+$lab_test_dzn+$currier_pre_cost_dzn+$inspection_dzn+$comarcial_dzn+$cm_cost_dzn;
				$summ_sourcing_tot_budget_dzn_val+=$tot_other_for_fob_value;
			}
			
			$sql_commi = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls  where job_no=".$txt_job_no." and status_active=1  and commission_amount>0";
			$result_commi=sql_select($sql_commi);
		 	foreach( $result_commi as $row )
			{
				$commission_type_id=$row[csf('particulars_id')];
				$com_type_id=$row[csf('commission_base_id')];
				
				$commission_arr[$commission_type_id]['commi_req_amt']=($row[csf('commission_amount')]/$order_price_per_dzn)*$ordQtyUom;
				$commission_arr[$commission_type_id]['commi_amt']=$row[csf('commission_amount')];
				$commission_arr[$commission_type_id]['commi_amt_pcs']=$row[csf('commission_amount')]*$order_price_per_dzn;
				//$summ_fob_value_pcs+=$row[csf('commission_amount')]/$order_price_per_dzn;
				$summ_fob_gross_value_amt+=($row[csf('commission_amount')]/$order_price_per_dzn)*$order_job_qnty;
				$summ_fob_pcs+=$row[csf('commission_amount')];
				$summ_sourcing_tot_budget_dzn_val+=($row[csf('commission_amount')]/$order_price_per_dzn)*$order_job_qnty;
			} 
			$summ_sourcing_fob_pcs=$summ_sourcing_tot_budget_dzn_val/$order_job_qnty;
			$summ_tot_final_cm=($summ_fob_gross_value_amt-$summ_sourcing_tot_budget_dzn_val)/$offer_qty_dzn;
			// $tot_summ_fob_pcs=$summ_fob_pcs/$order_price_per_dzn;
			
			$supplier_library_arr=return_library_array( "select a.short_name, a.id from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id   and a.is_deleted=0  and a.status_active=1 group by a.id,a.short_name order by a.short_name", "id", "short_name");
			?>
			<style>
			#th_tbl_height {
			  height: 18px;
			  width: 100%;
			  border: 1px solid #4CAF50;
			}
			</style>
            <script>
				//gross_fob_value_th
				function fnc_fob_verify()
				{
					var gross_fob_value=document.getElementById('gross_fob_value_th').value*1;
					//alert(gross_fob_value);
					document.getElementById('fob_verify_td').innerHTML=number_format_common(gross_fob_value,2);
				}
				
			</script>
			<td valign="top">
				<table class="rpt_table" align="left" border="1" cellpadding="1" cellspacing="1" style="width:280px; margin:5px; font-size:14px;" rules="all">
					<tr>
						<td width="80" colspan="2" align="center"><b>Summary </b></td>
					</tr>
					<tr>
						<td width="80"><b>Header </b></td>
						<td width="80"><b>Pre Cost</b> </td>
					</tr>
					<tr>
						<td>PO Qty <?='-'.$unit_of_measurement[$orderUom]; ?></td>
						<td title="=<? echo $ordQtyUom;?>"><b><?=number_format($ordQtyUom,0); ?></b></td>
					</tr> 
					<tr>
						<td>FOB <?='-'.$unit_of_measurement[$orderUom]; ?></td>
						<td title="Price=<? echo $avg_unit_price;?>"><b><?=number_format($avg_unit_price,4); ?></b></td>
					</tr>
					<tr>
						<td>FOB Value</td>
						<td title=""><b><?=number_format($avg_unit_price*$ordQtyUom,2); ?></b></td>
					</tr> 
					<tr>
						<td>SMV/<?=$unit_of_measurement[$orderUom]; ?></td>
						<td title="=<? //echo $summ_fob_gross_value_amt;?>"><b><?=number_format($sew_smv,4); ?></b></td>
					</tr> 
					<tr>
						<td>Budget Cost/<?=$unit_of_measurement[$orderUom]; ?></td>
						<td  title="Budget Cost/<?=$unit_of_measurement[$orderUom]; ?>=<? echo $summ_fob_pcs;?>"><b><?=number_format($tot_summ_fob_pcs,4); ?></b></td>
					</tr> 
					<tr>
						<td>Margin/<?=$unit_of_measurement[$orderUom]; ?>[USD] &nbsp; <? echo $margin_dzn_percent;?>%</td>
						<td  title="<? //echo $summ_fob_gross_value_amt;?>"><b><? 
						$margin_pre=$margin_dzn;//$avg_unit_price-$tot_summ_fob_pcs;
						$margin_final=$avg_unit_price-$summ_sourcing_fob_pcs;
						echo  number_format($margin_pre,4); ?></b></td>
					</tr> 
					<tr>
						<td>Total Margin Value</td>
						<td title="Margin Pcs*PO Qty <?=$unit_of_measurement[$orderUom]; ?>"><b><?=number_format($ordQtyUom*$margin_pre,2);
						$tot_margin_value=$ordQtyUom*$margin_pre; ?></b></td>
					</tr> 
					
					<tr>
						<td><b>CM/<?=$unit_of_measurement[$orderUom]; ?>[USD]</b></td> 
						<td title="CM Cost+Margin/1 Pcs"><b><? echo number_format($cm_cost_dzn,4); ?></b></td>
					</tr> 
					<tr>
						<td>Total CM Value</td>
						<td  title="CM Pcs*PO Qty <?=$unit_of_measurement[$orderUom]; ?>"><b><?=number_format($ordQtyUom*$cm_cost_dzn,2); ?></b></td>
					</tr> 
					<tr>
						<td>E.P.M [USD]</td>
						<td title="CM/Costing Per/Sew SMV"><b><?=number_format($cm_cost_dzn/$order_price_per_dzn/$sew_smv,4); ?></b></td>
					</tr>
					<? 
					if($show_others==1){ 
						$sqlcpm=sql_select("select asking_profit from lib_standard_cm_entry where company_id=$cbo_company_name and '$costing_date' between applying_period_date and applying_period_to_date and status_active=1 and is_deleted=0");
						$asking_profit=0;
						foreach($sqlcpm as $sqlcpmrow){
							$asking_profit=$sqlcpmrow[csf('asking_profit')];
						}
						$profit_margin=$cm_cost*$asking_profit;
						$buffer=$total_fob-($total_cost+$profit_margin);
						?>
						<tr>
						<td>Profit Margin</td>
						<td  title="CM/<?=$unit_of_measurement[$orderUom]; ?> X Asking Profit %"><b><?=number_format($profit_margin,2); ?></b></td>
						</tr> 
						<tr>
							<td>Buffer</td>
							<td title="Total FOB - Total Cost - Profit Margin"><b><?=number_format($buffer,4); ?></b></td>
						</tr>
					<? } ?>
				</table>
			</td>
			<td valign="top">
				<? $nameArray_imge =sql_select("SELECT image_location,real_file_name FROM common_photo_library where master_tble_id=".$txt_job_no." and file_type=1"); ?>
				<br>      
				<table class="rpt_table" width="300"  border="1" cellpadding="0" cellspacing="0" rules="all">
					<tr>
						<td width="120">First Shipment Date:</td><td><?=change_date_format($first_pub_shipment_date); ?></td> 
					</tr>
					<tr>
						<td>Last Shipment Date:</td><td><?=change_date_format($last_pub_shipment_date);?></td>
					</tr>
					<tr>
						<td title="(CM/<?=$unit_of_measurement[$orderUom]; ?>[USD]+Margin/<?=$unit_of_measurement[$orderUom]; ?>[USD] &nbsp; <? echo $operating_oh_per;?>%)/SMV/<?=$unit_of_measurement[$orderUom]; ?>">EPM with Margin</td><td title="<?='('.$cm_cost_dzn.'+'.$margin_pre.')/'.$sew_smv; ?>"><?=number_format(($cm_cost_dzn+$margin_pre)/$sew_smv,4); ?></td>
					</tr>
                    <tr>
						<td>FOB Verify:</td>
                        <td id="fob_verify_td" title="Total Margin Value+GrossFOB Value [A+B+C+D+E+F+G]"><? $fob_varify=$avg_unit_price*$ordQtyUom;echo number_format($fob_varify,2);?></td>
					</tr>
				</table>
				<br/> <br/>
				<?
				if($approved_id==1) $app_msg="Approved"; else if($approved_id==3) $app_msg="Partial Approved";  else $app_msg="Un-Approved";
				
				if($app_msg!='')
				{
					?>
					<table class="rpt_table" width="300"  border="1" cellpadding="0" cellspacing="0" rules="all">
						<tr>
						<td style="color:#F00; font-size:16px"><b> Approval Status: &nbsp; <?=$app_msg;?> </b></td>
						</tr>
					</table>
					<?
				}
				?>
			</td>
		</tr>
		</table>
		<?
		//end first foearch
		if($zero_value==1)
		{	
			?>
			<table  class="rpt_table" border="1" cellpadding="1" cellspacing="1"  width="98%" style=" margin:5px;text-align:center; font-size:14px;" rules="all"> 
                <caption><b>Details Part</b></caption>
                <tr style="font-weight:bold">
                    <td  width="20">SL </td>
                    <td  width="350" title="Fabric">ITEM DESCRIPTION </td>
                    <td  width="70">Cons/<?=$unit_of_measurement[$orderUom]; ?></td>
                    <td  width="70">Wast % </td>
                    <td  width="70">Total Cons/<?=$unit_of_measurement[$orderUom]; ?></td>
                    <td  width="50">UOM </td>
                    <td  width="70">Req. Qty</td>
                    <td  width="70">Rate(USD)</td>
                    <td  width="70">Cost/<?=$unit_of_measurement[$orderUom]; ?></td>
                    <td  width="70">Total Budget</td>
                    <td  width="170">Remarks</td>
                </tr>
                <?
                $f=1;$tot_fab_amount=$tot_fab_amount_pcs=$tot_fab_req_amount=0;$ff=1;$tot_fab_req_sourcing_amount=$tot_fab_req_sourcing_bal_amount=0;
                foreach($p_fab_precost_arr as $fabriccost_dtls_id=>$fabriccost_dtls_data)
                {
					foreach ($fabriccost_dtls_data as  $fab_type=>$fab_data) 
					{
						foreach($fab_data as $fab_desc=>$row)
						{
							if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
							
							$nominated_supp_str=""; 
							$exnominated_supp=explode(",",$row[('sourcing_nominated_supp')]);
							foreach($exnominated_supp as $supp)
							{
								if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_arr[$supp]; else $nominated_supp_str.=','.$supplier_library_arr[$supp];
							}	
							?>
							<tr id="" bgcolor="<? //echo $bgcolor;?>">
                                <td width="20" align="center"><p><? echo $f; ?></p></td>
                                <td width="350"><div style="word-break:break-all"><? echo $fab_desc; //echo $fab_type.','.$fab_desc; ?></div></td>
                                <td width="70" align="right"><p><? echo number_format($row['cons'],4); ?></p></td>
                                <td width="70" align="right"><p><? echo number_format($row[('p_loss')],4); ?></p></td>
                                <td width="70" align="right"><p><? echo number_format($row[('tot_cons')],4); ?></p></td>
                                <td width="50"><p><? echo $row[('uom')]; ?></p></td>
                                <td width="70" align="right"><p><? echo number_format($row[('req_qty')],4); ?></p></td>
                                <td width="70" align="right"><p><? echo number_format($row[('req_amount')]/$row[('req_qty')],4); ?></p></td>
                                <td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,4); ?></p></td>
                                <td width="70" align="right"><p><? echo number_format($row[('req_amount')],4); ?></p></td>
                                <td width="170" align="left"><p><?=$row[('remarks')];?></p></td>
							</tr>
							<?
							$f++;$ff++;
							$tot_fab_amount+=$row[('amount')];
							$tot_fab_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
							$tot_fab_req_amount+=$row[('req_amount')];
							$tot_fab_req_sourcing_amount+=$row[('sourcing_rate')]*$row[('req_qty')];
							$tot_fab_req_sourcing_bal_amount+=$bal_sourcing_amount;
						}
					}
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="8"> <b style="float:left">A Total Fabric Cost</b></td>
                    <td  align="right"><b><? echo number_format($tot_fab_amount_pcs,4); ?></b></td>
                    <td  align="right"><b><? echo number_format($tot_fab_req_amount,4); ?></b></td>
                    <td  align="right"><b></b></td>
                </tr>
			</table>
			<?
		}
		else
		{ 
			if(count($p_fab_precost_arr)>0)
			{
				?>
				<table  class="rpt_table" border="1" cellpadding="1" cellspacing="1"  width="98%" style=" margin:5px;text-align:center; font-size:14px;" rules="all"> 
                    <caption><b>Details Part</b></caption>
                    <tr style="font-weight:bold">
                        <td  width="20">SL </td>
                        <td  width="350" title="Fabric">ITEM DESCRIPTION </td>
                        <td  width="70">Cons/<?=$unit_of_measurement[$orderUom]; ?></td>
                        <td  width="70">Wast % </td>
                        <td  width="70">Total Cons/<?=$unit_of_measurement[$orderUom]; ?></td>
                        <td  width="50">UOM </td>
                        <td  width="70">Req. Qty</td>
                        <td  width="70">Rate[USD]</td>
                        <td  width="70">Cost/<?=$unit_of_measurement[$orderUom]; ?></td>
                        <td  width="70">Total Budget</td>
                        <td  width="170">Remarks</td>
                    </tr>
                    
                    <?
                    $f=1;$tot_fab_amount=$tot_fab_amount_pcs=$tot_fab_req_amount=0;$ff=1;$tot_fab_req_sourcing_amount=$tot_fab_req_sourcing_bal_amount=0;
                    foreach($p_fab_precost_arr as $fabriccost_dtls_id=>$fabriccost_dtls_data)
                    {
						foreach ($fabriccost_dtls_data as  $fab_type=>$fab_data) 
						{
							foreach($fab_data as $fab_desc=>$row)
							{
								if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
								
								$nominated_supp_str=""; 
								$exnominated_supp=explode(",",$row[('sourcing_nominated_supp')]);
								foreach($exnominated_supp as $supp)
								{
									if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_arr[$supp]; else $nominated_supp_str.=','.$supplier_library_arr[$supp];
								}	
								?>
								<tr  id="" bgcolor="<? //echo $bgcolor;?>">
                                    <td width="20" align="center"><p><? echo $f; ?></p></td>
                                    <td width="450"><div style="word-break:break-all"><? echo $fab_desc; //echo $fab_type.','.$fab_desc; ?></div></td>
                                    <td width="70" align="right"><p><? echo number_format($row['cons'],4); ?></p></td>
                                    <td width="70" align="right"><p><? echo number_format($row[('p_loss')],4); ?></p></td>
                                    <td width="70" align="right"><p><? echo number_format($row[('tot_cons')],4); ?></p></td>
                                    <td width="50"><p><? echo $row[('uom')]; ?></p></td>
                                    <td width="70" align="right"><p><? echo number_format($row[('req_qty')],4); ?></p></td>
                                    <td width="70" align="right"><p><? echo number_format($row[('req_amount')]/$row[('req_qty')],4); ?></p></td>
                                    <td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,4); ?></p></td>
                                    <td width="70" align="right"><p><? echo number_format($row[('req_amount')],4); ?></p></td>
                                    <td width="170" align="left"><p><?=$row[('remarks')];?></p></td>
								</tr>
								<?
								$f++;$ff++;
								$tot_fab_amount+=$row[('amount')];
								$tot_fab_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
								$tot_fab_req_amount+=$row[('req_amount')];
								$tot_fab_req_sourcing_amount+=$row[('sourcing_rate')]*$row[('req_qty')];
								$tot_fab_req_sourcing_bal_amount+=$bal_sourcing_amount;
							}
						}
                    }
                    ?>
                    <tr class="rpt_bottom" style="font-weight:bold">
                        <td colspan="8"> <b style="float:left">A Total Fabric Cost</b></td>
                        <td  align="right"><b><? echo number_format($tot_fab_amount_pcs,4); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_fab_req_amount,4); ?></b></td>
                        <td  align="right"><b></b></td>
                    </tr>
				</table>
				<? 
			}// zero value check end
		}
               // die;
			   
		if($zero_value==1)
		{
			?>
			<table class="rpt_table" border="1" cellpadding="0" cellspacing="0"  width="98%" style="text-align:center;margin:5px; font-size:14px;" rules="all">
                <tr style="font-weight:bold">
                    <td  width="20">SL </td>
                    <td  width="350" title="Trim sew">ITEM DESCRIPTION </td>
                    <td  width="70">Cons/<?=$unit_of_measurement[$orderUom]; ?></td>
                    <td  width="70">Wast % </td>
                    <td  width="70">Total Cons/<?=$unit_of_measurement[$orderUom]; ?></td>
                    <td  width="50">UOM </td>
                    <td  width="70">Req. Qty</td>
                    <td  width="70">Rate[USD]</td>
                    <td  width="70">Cost/<?=$unit_of_measurement[$orderUom]; ?></td>
                    <td  width="70">Total Budget</td>
                    <td  width="170">Remarks</td>
                </tr>
                <?
                $trims_tot_amount=0;
                $ts=1;$tot_sew_amount=$tot_amount_pcs=$tot_sew_amount_pcs=$tot_sew_req_amount=0;$ttts=1;$tot_sew_req_sourcing_amount=$tot_sew_req_sourcing_bal_amount=0;
                
                foreach($pre_trim_result as $row){
                
					$trims_type=$row[csf('trim_type')];
					$description=$row[csf('description')];
					if($description!="") $descriptionCond=", ".$description; else $descriptionCond="";
					$item_id=$row[csf('item_name')].$descriptionCond;
					//$item_name_arr[$item_id]=$row[csf('item_name')].$descriptionCond;
					
					if($ts%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					$nominated_supp_str=""; 
					$exnominated_supp=explode(",",$row[('sourcing_nominated_supp')]);
					foreach($exnominated_supp as $supp)
					{
						if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_arr[$supp]; else $nominated_supp_str.=','.$supplier_library_arr[$supp];
					}	
					
					$req_amt=$row[csf('cons_dzn_gmts')]*$row[csf('rate')];
					
					$p_sew_loss=$row[csf('ex_per')];
					$ex_tot=$row[csf('cons_dzn_gmts')]+(($row[csf('cons_dzn_gmts')]*$p_sew_loss)/100);
					
					$trim_req_qty=$trim_qty_arr[$row[csf('id')]];
					$trim_req_amount=$trim_amount_arr[$row[csf('id')]];
					
					//$p_sew_trim_precost_arr[$item_id]['tot_row']+=1;
					$p_sew_trim_tot_row+=1;
					
					$summ_fob_pcs+=$row[csf('amount')];	
					$summ_sourcing_tot_budget_dzn_val+=$trim_req_qty*$row[csf('sourcing_rate')];
					$summ_fob_gross_value_amt+=$trim_req_amount;
					?>
					<tr bgcolor="<? //echo $bgcolor;?>">
                        <td width="20" align="center"><p><? echo $ts; ?></p></td>
                        <td width="350" ><div style="word-break:break-all"><? echo $item_id; ?></div></td> 
                        <td width="70" align="right"><p><? echo number_format($row[csf('tot_cons')],6); ?></p></td>
                        <td width="70" align="right"><p><? echo number_format($p_sew_loss,6); ?></p></td>
                        <td width="70" align="right"><p><?  echo number_format($row[csf('cons_dzn_gmts')],6); ?></p></td>
                        <td width="50" align="center"><p><? echo $unit_of_measurement[$row[csf('uom')]]; ?></p></td>
                        <td width="70" align="right"><p><? echo number_format($trim_req_qty,5); ?></p></td>
                        <td width="70" align="right"><p><? echo number_format($trim_req_amount/$trim_req_qty,6); ?></p></td>
                        <td width="70" align="right"><p><? echo number_format($row[csf('amount')]/$order_price_per_dzn,6); ?></p></td>
                        <td width="70" align="right"><p><? echo number_format($trim_req_amount,6); ?></p></td>
                        <td width="170" align="left"><p><?=$row[csf('remark')];?></p></td>
					</tr>
					<?
					$ts++;$ttts++;
					$tot_sew_amount+=$row[csf('amount')];
					$tot_sew_amount_pcs+=$row[csf('amount')]/$order_price_per_dzn;
					$tot_sew_req_amount+=$trim_req_amount;
					$tot_sew_req_sourcing_amount+=$row[csf('sourcing_rate')]*$trim_req_qty;
					$tot_sew_req_sourcing_bal_amount+=$bal_sourcing_amout;
					$trims_tot_amount+=$trim_req_amount;
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="8" align="left"><b>B-Total Trims Cost:</b></td>
                    <td  align="right"><b><? echo number_format($tot_sew_amount_pcs,6); ?></b></td>
                    <td  align="right"><b><? echo number_format($tot_sew_req_amount,6); ?></b></td>
                    <td  align="right"><b></b></td>
                </tr>
			</table>
			<?
		}
		else
		{ 
			if(count($pre_trim_result)>0)
			{
				?>
				<table class="rpt_table" border="1" cellpadding="0" cellspacing="0"  width="98%" style="text-align:center;margin:5px; font-size:14px;" rules="all">
                    <tr style="font-weight:bold">
                        <td  width="20">SL </td>
                        <td  width="350" title="Trim sew">ITEM DESCRIPTION </td>
                        <td  width="70">Cons/<?=$unit_of_measurement[$orderUom]; ?></td>
                        <td  width="70">Wast % </td>
                        <td  width="70">Total Cons/<?=$unit_of_measurement[$orderUom]; ?></td>
                        <td  width="50">UOM </td>
                        <td  width="70">Req. Qty</td>
                        <td  width="70">Rate(USD)</td>
                        <td  width="70">Cost/<?=$unit_of_measurement[$orderUom]; ?></td>
                        <td  width="70">Total Budget</td>
                        <td  width="170">Remarks</td>
                    </tr>
                    <?
                    $trims_tot_amount=0;
                    $ts=1;$tot_sew_amount=$tot_amount_pcs=$tot_sew_amount_pcs=$tot_sew_req_amount=0;$ttts=1;$tot_sew_req_sourcing_amount=$tot_sew_req_sourcing_bal_amount=0;
                    
                    foreach($pre_trim_result as $row){
						$trims_type=$row[csf('trim_type')];
						$description=$row[csf('description')];
						if($description!="") $descriptionCond=", ".$description; else $descriptionCond="";
						$item_id=$row[csf('item_name')].$descriptionCond;
						//$item_name_arr[$item_id]=$row[csf('item_name')].$descriptionCond;
						
						if($ts%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
						$nominated_supp_str=""; 
						$exnominated_supp=explode(",",$row[('sourcing_nominated_supp')]);
						foreach($exnominated_supp as $supp)
						{
							if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_arr[$supp]; else $nominated_supp_str.=','.$supplier_library_arr[$supp];
						}	
						
						$req_amt=$row[csf('cons_dzn_gmts')]*$row[csf('rate')];
						
						$p_sew_loss=$row[csf('ex_per')];
						$ex_tot=$row[csf('cons_dzn_gmts')]+(($row[csf('cons_dzn_gmts')]*$p_sew_loss)/100);
						
						$trim_req_qty=$trim_qty_arr[$row[csf('id')]];
						$trim_req_amount=$trim_amount_arr[$row[csf('id')]];
						
						//$p_sew_trim_precost_arr[$item_id]['tot_row']+=1;
						$p_sew_trim_tot_row+=1;
						
						$summ_fob_pcs+=$row[csf('amount')];	
						$summ_sourcing_tot_budget_dzn_val+=$trim_req_qty*$row[csf('sourcing_rate')];
						$summ_fob_gross_value_amt+=$trim_req_amount;
						?>
						<tr bgcolor="<? //echo $bgcolor;?>">
                            <td width="20" align="center"><p><? echo $ts; ?></p></td>
                            <td width="350" ><div style="word-break:break-all"><? echo $item_id; ?></div></td> 
                            <td width="70" align="right"><p><? echo number_format($row[csf('tot_cons')],6); ?></p></td>
                            <td width="70" align="right"><p><? echo number_format($p_sew_loss,6); ?></p></td>
                            <td width="70" align="right"><p><?  echo number_format($row[csf('cons_dzn_gmts')],6); ?></p></td>
                            <td width="50" align="center"><p><? echo $unit_of_measurement[$row[csf('uom')]]; ?></p></td>
                            <td width="70" align="right"><p><? echo number_format($trim_req_qty,5); ?></p></td>
                            <td width="70" align="right"><p><? echo number_format($trim_req_amount/$trim_req_qty,6); ?></p></td>
                            <td width="70" align="right"><p><? echo number_format($row[csf('amount')]/$order_price_per_dzn,6); ?></p></td>
                            <td width="70" align="right"><p><? echo number_format($trim_req_amount,6); ?></p></td>
                            <td width="170" align="left"><p><?=$row[csf('remark')];?></p></td>
						</tr>
						<?
						$ts++;$ttts++;
						$tot_sew_amount+=$row[csf('amount')];
						$tot_sew_amount_pcs+=$row[csf('amount')]/$order_price_per_dzn;
						$tot_sew_req_amount+=$trim_req_amount;
						$tot_sew_req_sourcing_amount+=$row[csf('sourcing_rate')]*$trim_req_qty;
						$tot_sew_req_sourcing_bal_amount+=$bal_sourcing_amout;
						$trims_tot_amount+=$trim_req_amount;
					}
                    ?>
                    <tr class="rpt_bottom" style="font-weight:bold">
                        <td colspan="8" align="left"><b>B-Total Trims Cost:</b></td>
                        <td  align="right"><b><? echo number_format($tot_sew_amount_pcs,6); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_sew_req_amount,6); ?></b></td>
                        <td  align="right"><b></b></td>
                    </tr>
				</table>
				<?    
			}
		}
                // die;
		if($zero_value==1)
		{
			?>
			<table align="left" class="rpt_table" border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px; font-size:14px;" rules="all"> 
                <caption><b style="float:left">Gmts Wash</b></caption>
                <tr align="center">
                    <td width="20">SL </td>
                    <td width="400" title="Wash ">ITEM DESCRIPTION </td>
                    <td width="70">Cons/PCS</td>
                    <td width="70">Wast % </td>
                    <td width="70">Total Cons/<?=$unit_of_measurement[$orderUom]; ?></td>
                    <td width="50">UOM </td>
                    <td width="70">Req. Qty</td>
                    <td width="70"> Rate(USD)</td>
                    <td width="70">Cost/<?=$unit_of_measurement[$orderUom]; ?></td>
                    <td width="70">Total Budget</td>
                </tr>
                <?
                $w=1;$tot_wash_amount=$tot_wash_amount_pcs=$tot_wash_req_amount=$tot_wash_sourcing_req_amount=$tot_wash_sourcing_req_amount_bal=0;$ws=1;
                foreach($p_wash_precost_arr as $embname_id=>$row)
                {
					if($w%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					$wash_nominated_supp_str=""; 
					$exnominated_suppArr=explode(",",$row[('sourcing_nominated_supp')]);
					foreach($exnominated_suppArr as $supp)
					{
						if($wash_nominated_supp_str=="") $wash_nominated_supp_str=$supplier_library_arr[$supp]; else $wash_nominated_supp_str.=','.$supplier_library_arr[$supp];
					}		
					?>
					<tr bgcolor="<? //echo $bgcolor;?>">
                        <td width="20" align="center"><p><? echo $w; ?></p></td>
                        <td width="400"><div style="word-break:break-all"><? $embname_id=explode(", ",$embname_id);echo $embname_id[1]; ?></div></td> 
                        <td width="70" align="right"><p><? echo number_format($row[('cons')],4); ?></p></td>
                        <td width="70" align="right"><p><? //echo $row[('p_loss')]; ?></p></td>
                        <td width="70" align="right"><p><?  echo number_format($row[('cons')],4) ?></p></td>
                        <td width="50"  align="center"><p><? echo $costing_val; ?></p></td>
                        <td width="70" align="right"><p><? echo number_format($row[('req_qty')],4); ?></p></td>
                        <td width="70" align="right" title="Rate=<? echo $row[('pre_rate')];?>"><p><? echo number_format($row[('pre_rate')],4); ?></p></td>
                        <td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,4); ?></p></td>
                        <td width="70" align="right"><p><? echo number_format($row[('req_qty')]*$row[('pre_rate')],4); ?></p></td>
					</tr>
					<?
					$w++;$ws++;
					$tot_wash_amount+=$row[('amount')];
					$tot_wash_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
					$tot_wash_req_amount+=$row[('req_qty')]*$row[('pre_rate')];
					$tot_wash_sourcing_req_amount+=$sourcing_tot_amount;
					$tot_wash_sourcing_req_amount_bal+=$sourcing_tot_amount_bal;
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="8"> <b>C-Total Wash Cost :</b></td>
                    <td  align="right"><b><? echo number_format($tot_wash_amount_pcs,4); ?></b></td>
                    <td  align="right"><b><? echo number_format($tot_wash_req_amount,4); ?></b></td>
                </tr>
			</table>
			<?
		}
		else
		{ 
			if(count($p_wash_precost_arr)>0)
			{
				?>
				<table align="left" class="rpt_table" border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px; font-size:14px;" rules="all"> 
                    <caption><b style="float:left">Gmts Wash</b></caption>
                    <tr align="center">
                        <td width="20">SL </td>
                        <td width="450" title="Wash ">ITEM DESCRIPTION </td>
                        <td width="70">Cons/PCS</td>
                        <td width="70">Wast % </td>
                        <td width="70">Total Cons/<?=$unit_of_measurement[$orderUom]; ?></td>
                        <td width="50">UOM </td>
                        <td width="70">Req. Qty</td>
                        <td width="70"> Rate(USD)</td>
                        <td width="70">Cost/<?=$unit_of_measurement[$orderUom]; ?></td>
                        <td width="70">Total Budget</td>
                    </tr>
                    <?
                    $w=1;$tot_wash_amount=$tot_wash_amount_pcs=$tot_wash_req_amount=$tot_wash_sourcing_req_amount=$tot_wash_sourcing_req_amount_bal=0;$ws=1;
                    foreach($p_wash_precost_arr as $embname_id=>$row)
                    {
						if($w%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
						$wash_nominated_supp_str=""; 
						$exnominated_suppArr=explode(",",$row[('sourcing_nominated_supp')]);
						foreach($exnominated_suppArr as $supp)
						{
							if($wash_nominated_supp_str=="") $wash_nominated_supp_str=$supplier_library_arr[$supp]; else $wash_nominated_supp_str.=','.$supplier_library_arr[$supp];
						}		
						?>
						<tr bgcolor="<? //echo $bgcolor;?>">
                            <td width="20" align="center"><p><? echo $w; ?></p></td>
                            <td width="450"><div style="word-break:break-all"><? $embname_id=explode(", ",$embname_id);echo $embname_id[1]; ?></div></td> 
                            <td width="70" align="right"><p><? echo number_format($row[('cons')],4); ?></p></td>
                            <td width="70" align="right"><p><? //echo $row[('p_loss')]; ?></p></td>
                            <td width="70" align="right"><p><?  echo number_format($row[('cons')],4) ?></p></td>
                            <td width="50"  align="center"><p><? echo $costing_val; ?></p></td>
                            <td width="70" align="right"><p><? echo number_format($row[('req_qty')],4); ?></p></td>
                            <td width="70" align="right" title="Rate=<? echo $row[('pre_rate')];?>"><p><? echo number_format($row[('pre_rate')],4); ?></p></td>
                            <td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,4); ?></p></td>
                            <td width="70" align="right"><p><? echo number_format($row[('req_qty')]*$row[('pre_rate')],4); ?></p></td>
						</tr>
						<?
						$w++;$ws++;
						$tot_wash_amount+=$row[('amount')];
						$tot_wash_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
						$tot_wash_req_amount+=$row[('req_qty')]*$row[('pre_rate')];
						$tot_wash_sourcing_req_amount+=$sourcing_tot_amount;
						$tot_wash_sourcing_req_amount_bal+=$sourcing_tot_amount_bal;
                    }
                    ?>
                    <tr class="rpt_bottom" style="font-weight:bold">
                        <td colspan="8"> <b>C-Total Wash Cost :</b></td>
                        <td  align="right"><b><? echo number_format($tot_wash_amount_pcs,4); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_wash_req_amount,4); ?></b></td>
                    </tr>
				</table>
				<? 
			}
		}
		if($zero_value==1)
		{
			?>
			<table align="left" class="rpt_table" border="1" cellpadding="0" cellspacing="0"  width="98%" style="margin:5px; text-align:center; font-size:14px;" rules="all"> 
                <caption><b style="float:left">Embellishment Cost</b></caption>
                <tr>
                    <td width="20">SL </td>
                    <td width="450" title="">ITEM DESCRIPTION </td>
                    <td width="70">Cons/PCS</td>
                    <td width="70">Wast % </td>
                    <td width="70">Total Cons/<?=$unit_of_measurement[$orderUom]; ?></td>
                    <td width="50">UOM </td>
                    <td width="70">Req. Qty</td>
                    <td width="70">Rate(USD)</td>
                    <td width="70">Cost/<?=$unit_of_measurement[$orderUom]; ?></td>
                    <td width="70">Total Budget</td>
                </tr>
                <?
                $em=1;$tot_embro_amount=$tot_embro_amount_pcs=$tot_embro_req_amount=$tot_emb_sourcing_req_amount=$tot_emb_sourcing_req_amount_bal=0;$emb=1;
                foreach($p_embro_precost_arr as $embname_id=>$row)
                {
					if($w%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					$emb_nominated_supp_str=""; 
					$emb_exnominated_suppArr=explode(",",$row[('sourcing_nominated_supp')]);
					foreach($emb_exnominated_suppArr as $supp)
					{
						if($emb_nominated_supp_str=="") $emb_nominated_supp_str=$supplier_library_arr[$supp]; else $emb_nominated_supp_str.=','.$supplier_library_arr[$supp];
					}		
					?>
					<tr bgcolor="<? echo $bgcolor;?>">
                        <td width="20" align="center"><p><? echo $em; ?></p></td>
                        <td width="450"><div style="word-break:break-all"><? echo $embname_id; ?></div></td> 
                        <td width="70" align="right"><p><? echo number_format($row[('cons')],4); ?></p></td>
                        <td width="70" align="right"><p><? //echo $row[('p_loss')]; ?></p></td>
                        <td width="70" align="right"><p><?  echo number_format($row[('cons')],4); ?></p></td>
                        <td width="50"  align="center"><p><? echo $costing_val; ?></p></td>
                        <td width="70" align="right"><p><? echo number_format($row[('req_qty')],4); ?></p></td>
                        <td width="70" align="right"><p><? echo number_format($row[('req_amount')]/$row[('req_qty')],4); ?></p></td>
                        <td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,4); ?></p></td>
                        <td width="70" align="right"><b><? echo number_format($row[('req_amount')],4); ?></b></td>
					</tr>
					<?
					$em++;$emb++;
					$tot_embro_amount+=$row[('amount')];
					$tot_embro_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
					$tot_embro_req_amount+=$row[('req_amount')];
					$tot_emb_sourcing_req_amount+=$emb_sourcing_tot_amount;
					$tot_emb_sourcing_req_amount_bal+=$emb_sourcing_tot_amount_bal;
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="8"> <b>D-Total Embellishment Cost:</b></td>
                    <td  align="right"><b><? echo number_format($tot_embro_amount_pcs,4); ?></b></td>
                    <td  align="right"><b><? echo number_format($tot_embro_req_amount,4); ?></b></td>
                </tr>
			</table>
			<?
		}
		else{ 
			if(count($p_embro_precost_arr)>0)
			{
				?>
				<table align="left" class="rpt_table" border="1" cellpadding="0" cellspacing="0"  width="98%" style="margin:5px; text-align:center; font-size:14px;" rules="all"> 
                    <caption><b style="float:left">Embellishment Cost</b></caption>
                    <tr>
                        <td width="20">SL </td>
                        <td width="450" title="">ITEM DESCRIPTION </td>
                        <td width="70">Cons/<?=$unit_of_measurement[$orderUom]; ?></td>
                        <td width="70">Wast % </td>
                        <td width="70">Total Cons/<?=$unit_of_measurement[$orderUom]; ?></td>
                        <td width="50">UOM </td>
                        <td width="70">Req. Qty</td>
                        <td width="70">Rate(USD)</td>
                        <td width="70">Cost/<?=$unit_of_measurement[$orderUom]; ?></td>
                        <td width="70">Total Budget</td>
                    </tr>
                    <?
                    $em=1;$tot_embro_amount=$tot_embro_amount_pcs=$tot_embro_req_amount=$tot_emb_sourcing_req_amount=$tot_emb_sourcing_req_amount_bal=0;$emb=1;
                    foreach($p_embro_precost_arr as $embname_id=>$row)
                    {
						if($w%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
						$emb_nominated_supp_str=""; 
						$emb_exnominated_suppArr=explode(",",$row[('sourcing_nominated_supp')]);
						foreach($emb_exnominated_suppArr as $supp)
						{
							if($emb_nominated_supp_str=="") $emb_nominated_supp_str=$supplier_library_arr[$supp]; else $emb_nominated_supp_str.=','.$supplier_library_arr[$supp];
						}		
						?>
						<tr bgcolor="<? echo $bgcolor;?>">
                            <td width="20" align="center"><p><? echo $em; ?></p></td>
                            <td width="450"><div style="word-break:break-all"><? echo $embname_id; ?></div></td> 
                            <td width="70" align="right"><p><? echo number_format($row[('cons')],4); ?></p></td>
                            <td width="70" align="right"><p><? //echo $row[('p_loss')]; ?></p></td>
                            <td width="70" align="right"><p><?  echo number_format($row[('cons')],4); ?></p></td>
                            <td width="50" align="center"><p><? echo $costing_val; ?></p></td>
                            <td width="70" align="right"><p><? echo number_format($row[('req_qty')],4); ?></p></td>
                            <td width="70" align="right"><p><? echo number_format($row[('req_amount')]/$row[('req_qty')],4); ?></p></td>
                            <td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,4); ?></p></td>
                            <td width="70" align="right"><b><? echo number_format($row[('req_amount')],4); ?></b></td>
						</tr>
						<?
						$em++;$emb++;
						$tot_embro_amount+=$row[('amount')];
						$tot_embro_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
						$tot_embro_req_amount+=$row[('req_amount')];
						$tot_emb_sourcing_req_amount+=$emb_sourcing_tot_amount;
						$tot_emb_sourcing_req_amount_bal+=$emb_sourcing_tot_amount_bal;
                    }
                    ?>
                    <tr class="rpt_bottom" style="font-weight:bold">
                        <td colspan="8"> <b>D-Total Embellishment Cost:</b></td>
                        <td  align="right"><b><? echo number_format($tot_embro_amount_pcs,4); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_embro_req_amount,4); ?></b></td>
                    </tr>
				</table>
				<?  
			}
		}
		?>
                 
        <table align="left" class="rpt_table" border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px; font-size:14px;" rules="all"> 
            <caption><b style="float:left">Others Components</b></caption>
            <tr>
                <td width="20">SL </td>
                <td title="450"><b>Others Components</b> </td>
                <td width="70"><b>Cost/<?=$unit_of_measurement[$orderUom]; ?></b></td>
                <td width="70"><b>Total Budget</b></td>
            </tr>
            <tbody> 
				<?
                //$em=1;$tot_embro_amount=$tot_embro_amount_pcs=$tot_embro_req_amount=0;$emb=1;
                $bgcolor="#E9F3FF";
                $bgcolor2="#FFFFFF";//currier_pre_cost_dzn
                
                // $tot_other_cost=0; 
                $tot_other_cost_first=$tot_other_cost+$comarcial+$inspection+$currier_pre_cost+$lab_test;
                
                $total_other_cost_dzn=$tot_other_cost_dzn+$comarcial_dzn+$inspection_dzn+$lab_test_dzn+$currier_pre_cost_dzn;
                $tot_other_cost_pcs=$tot_other_cost_dzn/$order_price_per_dzn;
                $tot_comarcial_dzn_pcs=$comarcial_dzn/$order_price_per_dzn;//here
                $tot_inspection_dzn_pcs=$inspection_dzn/$order_price_per_dzn;
                $currier_pre_cost_dzn_pcs=$currier_pre_cost_dzn/$order_price_per_dzn;
                $tot_lab_test_dzn_pcs=$lab_test_dzn/$order_price_per_dzn;
				$studio_pre_cost_psc=$studio_pre_cost_dzn/$order_price_per_dzn;
				
                
                $total_other_cost_pcs=$tot_other_cost_pcs+$tot_comarcial_dzn_pcs+$tot_lab_test_dzn_pcs+$tot_inspection_dzn_pcs+$currier_pre_cost_dzn_pcs+$studio_pre_cost_psc;
                $tot_other_cost_req_amount=$tot_other_cost_first+$studio_pre_cost_psc;
                
                if($zero_value==1)
                {
                    ?>
                    <tr bgcolor="<? echo $bgcolor;?>">
                        <td width="20" align="center"><p>1</p></td>
                        <td width="450" align="" ><b>Test Charge</b></td> 
                        <td width="70" align="right"><p><? echo number_format($tot_lab_test_dzn_pcs,4); ?></p></td>
                        <td width="70" align="right"><p><? echo number_format($lab_test,4); ?></p></td>
                     </tr>
                    <?
                }
                else
                {
                    if($tot_lab_test_dzn_pcs>0)
                    {
                        ?>
                        <tr bgcolor="<? echo $bgcolor;?>">
                            <td width="20" align="center"><p>1</p></td>
                            <td width="450" align="" ><b>Test Charge</b></td> 
                            <td width="70" align="right"><p><?   echo number_format($tot_lab_test_dzn_pcs,4); ?></p></td>
                            <td width="70" align="right"><p><? echo number_format($lab_test,4); ?></p></td>
                        </tr>
                        <? 
                    }
                }
                
                if($zero_value==1)
                {
                    ?>
                    <tr bgcolor="<? echo $bgcolor2;?>">
                        <td width="20" align="center" ><p>2</p></td>
                        <td width="450"><b>Courier Charge</b></td> 
                        <td width="70" align="right"><p><?  echo number_format($currier_pre_cost_dzn_pcs,4); ?></p></td>
                        <td width="70" align="right"><p><? echo number_format($currier_pre_cost,4); ?></p></td>
                    </tr>
                    <?
                }
                else
                {  
                    if($currier_pre_cost_dzn_pcs>0)
                    {  ?>
                        <tr bgcolor="<? echo $bgcolor2;?>">
                            <td width="20" align="center" ><p>2</p></td>
                            <td width="450"><b>Courier Charge</b></td> 
                            <td width="70" align="right"><p><?  echo number_format($currier_pre_cost_dzn_pcs,4); ?></p></td>
                            <td width="70" align="right"><p><? echo number_format($currier_pre_cost,4); ?></p></td>
                        </tr> 
                        <? 
                    }
                }
                
                if($zero_value==1)
                {
                    ?>
                    <tr bgcolor="<? echo $bgcolor;?>">
                        <td width="20" align="center" ><p>3</p></td>
                        <td width="450"><b>Inspection Charge</b></td> 
                        <td width="70" align="right"><p><? echo number_format($tot_inspection_dzn_pcs,4); ?></p></td>
                        <td width="70" align="right"><p><? echo number_format($inspection,4); ?></p></td>
                    </tr>
                    <?
                }
                else
                { 
                    if($tot_inspection_dzn_pcs>0)
                    {
                        ?>
                        <tr bgcolor="<? echo $bgcolor;?>">
                            <td width="20" align="center" ><p>3</p></td>
                            <td width="450"><b>Inspection Charge</b></td> 
                            <td width="70" align="right"><p><? echo number_format($tot_inspection_dzn_pcs,4); ?></p></td>
                            <td width="70" align="right"><p><? echo number_format($inspection,4); ?></p></td>
                        </tr>
                        <? 
                    }
                }
                
                if($zero_value==1)
                {
                    ?>
                    <tr bgcolor="<? echo $bgcolor;?>">
                        <td width="20" align="center" ><p>4</p></td>
                        <td width="450"><b>Commercial Charge</b></td> 
                        <td width="70" align="right" title="Comml.+Studio/Others"><p>
							<? 
								$tot_comarcial_dzn_pcs=$tot_comarcial_dzn_pcs+$studio_pre_cost_psc;
									echo number_format($tot_comarcial_dzn_pcs,4); 
							 ?></p>
						</td>
                        <td width="70" align="right"><p>
							<?$comarcial=$comarcial+$studio_pre_cost_psc; echo number_format($comarcial,4); ?></p></td>
                    </tr>
                    <?
                }
                else
                { 
                    if($tot_comarcial_dzn_pcs>0)
                    {
                        ?>
                        <tr bgcolor="<? echo $bgcolor;?>">
                            <td width="20" align="center" ><p>4</p></td>
                            <td width="450"><b>Commercial Charge</b></td> 
                            <td width="70" align="right"><p><?  echo number_format($tot_comarcial_dzn_pcs,4); ?></p></td>
                            <td width="70" align="right"><p><? echo number_format($comarcial,4); ?></p></td>
                        </tr>
                        <? 
                    }
                }
                ?>
                <tr bgcolor="<? echo $bgcolor2;?>">
                    <td width="20" align="center"><p>5</p></td>
                    <td width="450" title="Freight+Certif.Cost+Design Cost+Deprec.&Amort.+Deprec.&Amort.+Interest+Income Tax">
                    <b>Others Charge</b></td> 
                    <td width="70" align="right"><p><? echo number_format($tot_other_cost_pcs,4); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($tot_other_cost,4); ?></p></td>
                </tr>
            </tbody>
            <tfoot>
                <tr style="font-size:12px; background-color:#CCC">
                    <td colspan="2"> <b>E-Total Others Cost:</b></td>
                    <td  align="right"><b><? echo number_format($total_other_cost_pcs,4); ?></b></td>
                    <td  align="right"><b><? echo number_format($tot_other_cost_req_amount,4); ?></b></td>
                </tr>
            </tfoot>
        </table>
        <table align="left" class="rpt_table" border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px; font-size:14px;" rules="all"> 
            <caption><b style="float:left"> Commission Cost:</b></caption>
            <tr>
                <td  width="20">SL </td>
                <td width="450" title="">Commission Cost </td>
                <td  width="70">Cost/<?=$unit_of_measurement[$orderUom]; ?></td>
                <td  width="70">Total Budget</td>
            </tr>
            <tbody> 
				<?
                $tot_commission_amount=$commission_arr[1]['commi_amt']+$commission_arr[2]['commi_amt'];
                $tot_commission_amount_pcs=($commission_arr[1]['commi_amt']/$order_price_per_dzn)+($commission_arr[2]['commi_amt']/$order_price_per_dzn);
                $tot_commision_req_amount=$commission_arr[1]['commi_req_amt']+$commission_arr[2]['commi_req_amt'];
                ?>
                <tr bgcolor="<? echo $bgcolor;?>">
                    <td width="20" align="center"><p>1</p></td>
                    <td width="450" ><b>Local </b></td> 
                    <td width="70" align="right"><p><? echo number_format($commission_arr[2]['commi_amt']/$order_price_per_dzn,4); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($commission_arr[2]['commi_req_amt'],4); ?></p></td>
                </tr>
                <tr bgcolor="<? echo $bgcolor2;?>">                     
                    <td width="20" align="center"><p>2</p></td>
                    <td width="450" ><b>Foreign</b></td> 
                    <td width="70" align="right"><p><? echo number_format($commission_arr[1]['commi_amt']/$order_price_per_dzn,4); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($commission_arr[1]['commi_req_amt'],4); ?></p></td>
                </tr>
            </tbody>
            <tfoot>
                <tr>
                    <td colspan="2"> <b>F-Total Commission Cost:</b></td>
                    <td  align="right"><b><? echo number_format($tot_commission_amount_pcs,4); ?></b></td>
                    <td  align="right"><b><? echo number_format($tot_commision_req_amount,4); ?></b></td>
                </tr>
                <tr bgcolor="<? echo $bgcolor;?>">
                    <td width="20" align="center"><p>1</p></td>
                    <td width="450"><b>G-Total CM Cost</b></td> 
                    <td width="70" align="right"><b><? $tot_cm_cost_pcs=$cm_cost_dzn/$order_price_per_dzn;echo number_format($tot_cm_cost_pcs,4); ?></b></td>
                    <td width="70" title="CM Cost*PO Qty " align="right"><b><? echo number_format($cmCost,4); ?></b></td>
                </tr>
                <tr bgcolor="<? echo $bgcolor;?>"> 
                    <td width="450" colspan="2"><p> <b>Gross FOB Value [A+B+C+D+E+F+G]</b></p></td> 
                    <?php //tot_sew_amount_pcs
                    $gross_fob_value_dzn=$tot_fab_amount+$trim_sew_fin_amt+$tot_wash_amount+$tot_embro_amount+$tot_other_cost_dzn+$tot_commission_amount+$cm_cost_dzn;
                    $gross_fob_value_pcs=$tot_fab_amount_pcs+$trim_sew_fin_amt_pcs+$tot_wash_amount_pcs+$tot_embro_amount_pcs+$tot_other_cost_pcs+$tot_commission_amount_pcs+$tot_cm_cost_pcs;
                    //echo $tot_fab_amount_pcs.'=='.$trim_sew_fin_amt_pcs.'=='.$tot_wash_amount_pcs.'=='.$tot_embro_amount_pcs.'=='.$tot_commission_amount_pcs.'=='.$tot_cm_cost_pcs;
                    //$gross_fob_value_req=$tot_fab_req_amount+$trim_fin_req_amount+$tot_wash_req_amount+$tot_embro_req_amount+$tot_commision_req_amount+$tot_other_cost_req_amount+$cm_cost_req;
                    
                    $gross_fob_value_req=$tot_fab_req_amount+$trims_tot_amount+$tot_wash_req_amount+$tot_embro_req_amount+$tot_other_cost_req_amount+$tot_commision_req_amount+$cmCost;
                    
                    //---fob value
                    $total_fob_gross_pcs=$tot_fab_amount_pcs+$trim_sew_fin_amt_pcs+$tot_wash_amount_pcs+$tot_embro_amount_pcs+$tot_other_cost_pcs+$tot_commission_amount_pcs+$tot_cm_cost_pcs;
                    $total_fob_gross_dzn=$tot_fab_amount+$trim_sew_fin_amt+$tot_sew_amount_pcs+$tot_wash_amount+$tot_embro_amount+$total_other_cost_dzn+$tot_commission_amount+$cm_cost_dzn;
                    $tot_gross_fob_pcs=$total_fob_gross_dzn/$order_price_per_dzn;
                    $gross_fob_value_dzn_without_commi=$total_fob_gross_dzn-$tot_commission_amount;
                    $gross_fob_value_pcs_without_commi=$tot_gross_fob_pcs-$tot_commission_amount_pcs;
                    $gross_fob_value_req_without_commi=$gross_fob_value_req-$tot_commision_req_amount;
                    ?>					
                    <td width="70" align="right"><b> <? echo number_format($tot_gross_fob_pcs,4); ?></b></td>
                    <td width="70" id="gross_fob_value_td" align="right" title="<? echo $gross_fob_value_req."=".$tot_fab_req_amount."+".$trims_tot_amount."+".$tot_wash_req_amount."+".$tot_embro_req_amount."+".$tot_other_cost_req_amount."+".$tot_commision_req_amount."+".$cmCost;?>"><b><? echo number_format($gross_fob_value_req,4); ?></b>  
                    <input type="hidden" id="gross_fob_value_th" width="70px" value="<? echo $gross_fob_value_req+$tot_margin_value; ?>"></td>
               
                </tr>
                <tr bgcolor="<? echo $bgcolor2;?>">
                    <td width="450" colspan="2"><b>Net FOB Value (Without Commission)</b></td> 
                    <td width="70" align="right"><b><? echo number_format($gross_fob_value_pcs_without_commi,4); ?> </b></td>
                    <td width="70" align="right"><b><? echo number_format($gross_fob_value_req_without_commi,4); ?> </b></td>
                </tr>
            </tfoot>
        </table>
        <script>
				fnc_fob_verify();
		</script>
        <div style="float:left" align="left">  <b> &nbsp;&nbsp;&nbsp;&nbsp; <? //echo $inserted_by;?> </b></div>
        <div style="clear:both"></div>
        <? 
		$cbo_company_name=str_replace("'","",$cbo_company_name);
		if ($cbo_template_id != '') {
			$template_id = " and a.template_id=$cbo_template_id ";
		}
		 
		$path=($path!='')?$path:"../../";
		//$inserted_by=return_field_value("inserted_by", "wo_pre_cost_mst", "job_no='".str_replace("'","",$txt_job_no)."'");
		$job_info=sql_select("SELECT id, inserted_by from wo_pre_cost_mst where status_active=1 and is_deleted=0 and job_no='".str_replace("'","",$txt_job_no)."'");
		foreach ($job_info as $row) {
			$inserted_by=$row[csf('inserted_by')];
			$job_id=$row[csf('id')];
		}
		
	   $signature_arr=return_library_array( "select master_tble_id,image_location from common_photo_library where form_name='user_signature'",'master_tble_id','image_location');
		$appSql="select approved_by from approval_history where entry_form=46 and mst_id = $job_id and is_signing=1";
		$appSqlRes=sql_select($appSql);
		foreach($appSqlRes as $row){
			$userSignatureArr[$row[csf('approved_by')]]=$path.$signature_arr[$row[csf('approved_by')]];	
		}
		$userSignatureArr[$inserted_by]=$path.$signature_arr[$inserted_by];

		echo signature_table(218, $cbo_company_name, "1200px",$cbo_template_id,50,$inserted_by,$userSignatureArr);
		?>            
     </div>
     <div style="clear:both"></div>
    <?
	$mailBody=ob_get_contents();
	ob_clean();
	echo $mailBody;

	//Mail send------------------------------------------
	list($msil_address,$is_mail_send,$mail_body)=explode('**',$mail_data);
	if($is_mail_send==1){
	
		require_once('../../../mailer/class.phpmailer.php');
		require_once('../../../auto_mail/setting/mail_setting.php');
		
		$mailBody = preg_replace("/<img[^>]+\>/i", " ", $mailBody); 	
		$mailToArr=array();
		if($msil_address){$mailToArr[]=$msil_address;}
			
		$mailSql = "SELECT c.TEAM_LEADER_EMAIL, d.USER_EMAIL FROM wo_po_details_master  a,  wo_pre_cost_mst b, lib_marketing_team c, USER_PASSWD d WHERE a.job_no = b.job_no  AND a.TEAM_LEADER = c.id AND b.INSERTED_BY = d.id AND a.status_active = 1  AND a.job_no=$txt_job_no";
		//echo $mailSql;die;
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows['TEAM_LEADER_EMAIL']){$mailToArr[$rows['TEAM_LEADER_EMAIL']]=$rows['TEAM_LEADER_EMAIL'];}
			if($rows['USER_EMAIL']){$mailToArr[$rows['USER_EMAIL']]=$rows['USER_EMAIL'];}
		}
		
		
		$elcetronicSql = "SELECT a.BUYER_ID,a.SEQUENCE_NO,a.BYPASS,b.USER_EMAIL  from electronic_approval_setup a join user_passwd b on a.user_id=b.id where b.valid=1  AND a.page_id in(428,1717,2150) and a.company_id=$cbo_company_name order by a.SEQUENCE_NO"; //and a.
		
		$elcetronicSqlRes=sql_select($elcetronicSql);
		foreach($elcetronicSqlRes as $rows){
			
		
			if($rows[BUYER_ID]!=''){
				foreach(explode(',',$rows[BUYER_ID]) as $bi){
					if($rows['USER_EMAIL']!='' && $bi==$buyer_name_id){$mailToArr[$rows['USER_EMAIL']]=$rows['USER_EMAIL'];}
					if($rows[BYPASS]==2){break;}
				}
			}
			else{
				if($rows[USER_EMAIL]){$mailToArr[$rows['USER_EMAIL']]=$rows['USER_EMAIL'];}
				if($rows[BYPASS]==2){break;}
			}
		}
		
		//Un-approve request mail......................................................
		$user_id=$_SESSION['logic_erp']['user_id'];
		$job_id=return_field_value("id", "wo_pre_cost_mst", "job_no='".str_replace("'","",$txt_job_no)."'");
		$approved_no=return_field_value("MAX(approved_no) as approved_no","approval_history","entry_form=46 and mst_id=$job_id","approved_no")+1;
		$unapproved_request=return_field_value("APPROVAL_CAUSE","fabric_booking_approval_cause","entry_form=46 and user_id=$user_id and booking_id=$job_id and approval_type=2 and approval_no='$approved_no'");//page_id=$page_id and
		if($unapproved_request){
			$mailToArr=array();
			if($msil_address){$mailToArr[]=$msil_address;}
			$final_app_user_mail=return_field_value("USER_EMAIL","user_passwd","id in(select APPROVED_BY from APPROVAL_HISTORY where id in(select max(id) from APPROVAL_HISTORY where mst_id=$job_id and ENTRY_FORM=46 and CURRENT_APPROVAL_STATUS=1))");
			$mailToArr[]= $final_app_user_mail;
		}
		$mailBody=$mail_body."<br>".$unapproved_request."<br>".$mailBody;
		//......................................................Un-approve request mail;		
		$to=implode(',',$mailToArr);
		//echo $to;die;
		//Att file....
		$imgSql="select IMAGE_LOCATION,REAL_FILE_NAME from common_photo_library where is_deleted=0  and MASTER_TBLE_ID=$txt_job_no and file_type=1";
		$imgSqlResult=sql_select($imgSql);
		foreach($imgSqlResult as $rows){
			$att_file_arr[]='../../../'.$rows[IMAGE_LOCATION].'**'.$rows[REAL_FILE_NAME];
		}
		$subject="Pre Cost Sheet";
		$header=mailHeader();
		echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
	}
	//------------------------------------End;
	exit();
}

if($action=="slgCostRpt")//Cost Rpt / EPM Btn 21
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";

	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	$costing_date=str_replace("'","",$txt_costing_date);
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and b.costing_date='".$txt_costing_date."'";
	$poBreackDownId=str_replace("'","",$txt_po_breack_down_id);
	if($poBreackDownId==""){$poId_cond='';$poId_cond2='';}else{$poId_cond=" and id in ($poBreackDownId)"; $poId_cond2=" and b.id in ($poBreackDownId)";}


	//array for display name
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$merchantArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$group_gsm="listagg(b.gsm_weight ,',') within group (order by b.gsm_weight) AS gsm_weight";
	$gsm_weight_top=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and a.body_part_type=1","gsm_weight");
	$gsm_weight_bottom=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and a.body_part_type=20 ","gsm_weight");

	 $po_qty=0;
	 $po_plun_cut_qty=0;
	 $total_set_qnty=0;
	 $sql_po="select a.job_no,a.total_set_qnty,b.id,c.item_number_id,c.country_id,c.color_number_id,c.size_number_id,c.order_quantity ,c.plan_cut_qnty  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst   and b.id=c.po_break_down_id  and a.job_no =".$txt_job_no." $poId_cond2  and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 order by b.id";
	$sql_po_data=sql_select($sql_po);
	foreach($sql_po_data as $sql_po_row){
		$po_qty+=$sql_po_row[csf('order_quantity')];
		$po_plun_cut_qty+=$sql_po_row[csf('plan_cut_qnty')];
		$total_set_qnty=$sql_po_row[csf('total_set_qnty')];
		$po_id_arr[$sql_po_row[csf('id')]]=$sql_po_row[csf('id')];
	}
	$po_id_str= implode( ",",$po_id_arr);
	
	$sales_contract_sql=sql_select("SELECT a.contract_no,b.wo_po_break_down_id from com_sales_contract a join com_sales_contract_order_info b on a.id=b.com_sales_contract_id where a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.wo_po_break_down_id in ($po_id_str) group by a.contract_no, b.wo_po_break_down_id");
	$sales_contract_arr=array();
	if(count($sales_contract_sql)>0)
	{
		foreach ($sales_contract_sql as $key => $row) {
			$sales_contract_arr[$row[csf('contract_no')]]=$row[csf('contract_no')];
		}
	}

	$export_lc_sql=sql_select("SELECT a.export_lc_no,b.wo_po_break_down_id from com_export_lc a join com_export_lc_order_info b on a.id=b.com_export_lc_id where a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.wo_po_break_down_id in ($po_id_str) group by a.export_lc_no,b.wo_po_break_down_id");
	$export_lc_arr=array();
	if(count($export_lc_sql)>0)
	{
		foreach ($export_lc_sql as $key => $row) {
			$export_lc_arr[$row[csf('wo_po_break_down_id')]]=$row[csf('export_lc_no')];
		}
	}
	$sc_lc_no="";
	if(count($sales_contract_arr)>0)
	{
		$sc_lc_no=implode(",", $sales_contract_arr);
	}
	if(count($export_lc_arr)>0)
	{
		$sc_lc_no=implode(",", $export_lc_arr);
	}

	//echo $po_qty;

	$gmtsitem_ratio_array=array();
	$gmtsitem_ratio_sql=sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no =".$txt_job_no."");// where job_no ='FAL-14-01157'
	foreach($gmtsitem_ratio_sql as $gmtsitem_ratio_sql_row){
	$gmtsitem_ratio_array[$gmtsitem_ratio_sql_row[csf('job_no')]][$gmtsitem_ratio_sql_row[csf('gmts_item_id')]]=$gmtsitem_ratio_sql_row[csf('set_item_ratio')];
	}
	$costing_per_arr=return_library_array( "select job_no,costing_per from wo_pre_cost_mst where job_no =".$txt_job_no."", "job_no", "costing_per");// where job_no ='FAL-14-01157'
	$financial_para=array();
	$sql_std_para=sql_select("select applying_period_date,applying_period_to_date,interest_expense,income_tax,cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and status_active=1 and	is_deleted=0 order by id desc");
	foreach($sql_std_para as $sql_std_row){
		$applying_period_date=change_date_format($sql_std_row[csf('applying_period_date')],'','',1);
		$applying_period_to_date=change_date_format($sql_std_row[csf('applying_period_to_date')],'','',1);
		$diff=datediff('d',$applying_period_date,$applying_period_to_date);
		for($j=0;$j<$diff;$j++)
		{
			$date_all=add_date(str_replace("'","",$applying_period_date),$j);
			$newdate =change_date_format($date_all,'','',1);
			$financial_para[$newdate][interest_expense]=$sql_std_row[csf('interest_expense')];
			$financial_para[$newdate][income_tax]=$sql_std_row[csf('income_tax')];
			$financial_para[$newdate][cost_per_minute]=$sql_std_row[csf('cost_per_minute')];
		}
	}
	// echo "<pre>";
	// print_r($financial_para)."<br>";
	

	$pre_costing_date=date("d-M-Y",strtotime($costing_date));

	$fab_knit_req_kg_avg=0;
	$fab_woven_req_yds_avg=0;
	$sql = "SELECT a.job_no, a.company_name, a.buyer_name, a.style_ref_no, a.quotation_id, a.gmts_item_id, a.order_uom, a.job_quantity, a.avg_unit_price,a.dealing_marchant, b.costing_per, b.budget_minute,b.costing_date, b.sew_smv, b.cut_smv, b.sew_effi_percent, b.cut_effi_percent, b.approved, c.fab_knit_req_kg, c.fab_knit_fin_req_kg, c.fab_woven_req_yds, c.fab_woven_fin_req_yds, c.fab_yarn_req_kg, d.margin_pcs_bom,d.cm_cost, d.cost_pcs_set,b.exchange_rate,d.wash_cost,d.embel_cost,d.fabric_cost_percent,d.trims_cost_percent,d.wash_cost_percent,d.embel_cost_percent from wo_po_details_master a join wo_pre_cost_mst b on a.id=b.job_id join wo_pre_cost_dtls d on a.id=d.job_id left join wo_pre_cost_sum_dtls c on a.id=c.job_id and c.status_active=1 and c.is_deleted=0 where b.status_active=1 and b.is_deleted=0  and a.status_active=1 and b.status_active=1 and b.is_deleted=0 $job_no $company_name $cbo_buyer_name $txt_style_ref order by a.job_no";
	//echo __LINE__.$db_type; die;
	$data_array=sql_select($sql);
	foreach( $data_array as $row )
	{
		$cm_cost_dzn =$row[csf("cm_cost")];
		$exchange_rate =$row[csf("exchange_rate")];
		$approved_id=$row[csf("approved")];
		$dealing_marchant=$row[csf("dealing_marchant")];
		$wash_cost =$row[csf("job_quantity")]*$row[csf("wash_cost")];
		$embl_cost =$row[csf("job_quantity")]*$row[csf("embel_cost")];

		$fabric_cost_percent =$row[csf("fabric_cost_percent")];
		$trims_cost_percent =$row[csf("trims_cost_percent")];
		$wash_cost_percent =$row[csf("wash_cost_percent")];
		$embel_cost_percent =$row[csf("embel_cost_percent")];
		
	}	
	
	$condition= new condition();
	if(str_replace("'","",$txt_job_no) !=''){
		$condition->job_no("=$txt_job_no");
	}
	$txt_po_breack_down_id=str_replace("'",'',$txt_po_breack_down_id);
	if(str_replace("'",'',$txt_po_breack_down_id) !=""){
		$condition->po_id("in($txt_po_breack_down_id)");
	}

	$condition->init();
	$fabric= new fabric($condition);
	$trim= new trims($condition);
	$emblishment= new emblishment($condition);
	$wash= new wash($condition);


	//Fabric =====================
	$fabric_qty=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$fabric_amount=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$sql_fabric = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description,uom, avg_cons,avg_cons_yarn, fabric_source,gsm_weight, rate, amount, avg_finish_cons, status_active from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_arr_fabric=sql_select($sql_fabric);
	$summary_data=array();
	foreach($data_arr_fabric as $fab_row)
	{
		$summary_data[fabric_cost][$fab_row[csf("id")]]=$fab_row[csf("amount")];
		$summary_data[fabric_cost_job]+=$fabric_amount['knit']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		$summary_data[fabric_cost_job]+=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
	}
	
	//start	Trims Cost part report here -------------------------------------------
		$sql_trim = "select id, job_no, trim_group,description,brand_sup_ref,remark, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,status_active,seq from wo_pre_cost_trim_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 order by seq";
		$data_array_trim=sql_select($sql_trim);
		$trim_amount_arr=$trim->getAmountArray_precostdtlsid();
		$trim_qty_arr=$trim->getQtyArray_by_precostdtlsid();
		$totTrim=0;
		$TrimData=array();
		foreach( $data_array_trim as $row_trim )
		{
			$trim_qty=$trim_qty_arr[$row_trim[csf("id")]];
			$trim_amount=$trim_amount_arr[$row_trim[csf("id")]];
			$summary_data[trims_cost_job]+=$trim_amount;
		}

	//Fabric End======================

	//emb start
	$emb_sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name in(1,2,4,5,99) and status_active=1 and is_deleted=0";
	$emb_data_array=sql_select($emb_sql);
	$emb_amount=$emblishment->getAmountArray_by_jobAndEmblishmentid();
	foreach( $emb_data_array as $row ){
	$embtotamount=$emb_amount[$row[csf("job_no")]][$row[csf("id")]];
	$summary_data[emb_cost_job]+=$embtotamount;
	}
	//emb end

	//Wash cost 
	$wash_sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name =3 and status_active=1 and is_deleted=0";
	$wash_data_array=sql_select($wash_sql);
	$wash_amt=$wash->getAmountArray_by_jobAndEmblishmentid();
	foreach( $wash_data_array as $row ){
	$washamt=$wash_amt[$row[csf("job_no")]][$row[csf("id")]];
	$summary_data[wash_cost_job]+=$washamt;
	}
	//End Wash cost Cost part report here -------------------------------------------
	 
	 
	$uom=""; $sew_smv=0; $cut_smv=0; $sew_effi_percent=0; $cut_effi_percent=0;
	foreach ($data_array as $row){
		$order_price_per_dzn=0;
		$order_job_qnty=0;
		$avg_unit_price=0;
		$sew_smv=$row[csf("sew_smv")];
	    $cut_smv=$row[csf("cut_smv")];
	    $sew_effi_percent=$row[csf("sew_effi_percent")];
	    $cut_effi_percent=$row[csf("cut_effi_percent")];
		$order_values = $row[csf("job_quantity")]*$row[csf("avg_unit_price")];
		$result =sql_select("select po_number,grouping,file_no,pub_shipment_date from wo_po_break_down where job_no_mst=$txt_job_no $poId_cond and status_active=1 and is_deleted=0 order by pub_shipment_date DESC");
		$job_in_orders = '';$pulich_ship_date='';$job_in_file = '';$job_in_ref = '';
		foreach ($result as $val){
			$job_in_orders .= $val[csf('po_number')].", ";
			$pulich_ship_date = $val[csf('pub_shipment_date')];
			$job_in_file .= $val[csf('file_no')].",";
			$job_in_ref .= $val[csf('grouping')].",";
		}
		$job_in_orders = substr(trim($job_in_orders),0,-1);
		$job_ref=array_unique(explode(",",rtrim($job_in_ref,", ")));
		$job_file=array_unique(explode(",",rtrim($job_in_file,", ")));

		foreach ($job_ref as $ref){
			$ref_cond.=", ".$ref;
		}
		$file_con='';
		foreach ($job_file as $file){
			if($file_con=='') $file_cond=$file; else $file_cond.=", ".$file;
		}

		
		$path =str_replace("'","",$path);
		$path =($path)?$path:"../../";
		
		
		?>
		<?
			if($row[csf("costing_per")]==1){
				$order_price_per_dzn=12;
				$costing_for=" DZN";
			}
			else if($row[csf("costing_per")]==2){
				$order_price_per_dzn=1;
				$costing_for=" PCS";
			}
			else if($row[csf("costing_per")]==3){
				$order_price_per_dzn=24;
				$costing_for=" 2 DZN";
			}
			else if($row[csf("costing_per")]==4){
				$order_price_per_dzn=36;
				$costing_for=" 3 DZN";
			}
			else if($row[csf("costing_per")]==5){
				$order_price_per_dzn=48;
				$costing_for=" 4 DZN";
			}
			$order_job_qnty=$row[csf("job_quantity")];
			$avg_unit_price=$row[csf("avg_unit_price")];

		}//end first foearch
 		?>
            	
                <table style="width:850px" ><tr><td colspan="6" align="center">
                   <?
				   	$image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id='".str_replace("'","",$cbo_company_name)."'","image_location");
					?>
                    <img  src='<?=$path.$image_location; ?>' height='70' align="left" />
                    <b style="font-size:25px;"><?=$comp[str_replace("'","",$cbo_company_name)]; ?></b><br>
                    <b style="font-size:14px;">Pre- Costing</b>
                </td></tr></table>

                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
                	<tr>
                    	<td width="140">Job Number</td>
                        <td width="130"><b><? echo $row[csf("job_no")]; ?></b></td>
                        <td width="140">Buyer</td>
                        <td width="140"><b><? echo $buyer_arr[$row[csf("buyer_name")]]; ?></b></td>
                        <td colspan="2" align="center"><b>Material Cost and Service Cost</b></td>
						<td width="100"><b>% To Q.price</b></td>
                    </tr>
                    <tr>
                    	<td>Garments Item</td>
                        <?
							$grmnt_items = "";
							if($garments_item[$row[csf("gmts_item_id")]]=="")
							{

								$grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no=$txt_job_no");
								foreach($grmts_sql as $key=>$val){
									$grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].", ";
								}
								$grmnt_items = substr_replace($grmnt_items,"",-1,1);
							}else{
								$grmnt_items = $garments_item[$row[csf("gmts_item_id")]];
							}
						?>
                        <td><b><? echo $grmnt_items; ?></b></td>
                    	<td>Style Ref. No </td>
                        <td colspan=""><b><? echo $row[csf("style_ref_no")]; ?></b></td>
                        <td width="100"><b>Fabric Purchase</b></td>
			    		<td align="right" style="word-break:break-all"><b><? echo fn_number_format($summary_data[fabric_cost_job],4); ?></b></td>
						<td align="right"><b><?=fn_number_format($fabric_cost_percent,2);;?></b> </td>
                    </tr>
                    <tr>
                    	<td>Job Qty.</td>
                        <td><b><? $uom=$row[csf("order_uom")]; echo $row[csf("job_quantity")]." ". $unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
                        <td>Plan Cut Qty.</td>
                        <td><b><? echo $po_plun_cut_qty/$total_set_qnty." ". $unit_of_measurement[$row[csf("order_uom")]];?></b></td>
                        <td><b>Accessories</b></td>
						<td align="right" style="word-break:break-all"><b><? echo fn_number_format($summary_data[trims_cost_job],4)?></b></td>
						<td align="right"><b> <?=fn_number_format($trims_cost_percent,2);;?></b></td>
                    </tr>
                   
					<tr>
						<td rowspan="2">Order Numbers</td>
                        <td rowspan="2" colspan="3"><? echo $job_in_orders; ?></td>
                        <td><b>Wash</b></td>
						<td align="right" style="word-break:break-all"><b><?=fn_number_format($summary_data[wash_cost_job],4);?></b></td>
						<td align="right"><b> <?=fn_number_format($wash_cost_percent,2);;?></b></td>
						</tr>
					<tr>
                        <td><b>Embelishment </b></td>
						<td align="right" style="word-break:break-all"><b><?=fn_number_format($summary_data[emb_cost_job],4);?></b></td>
						<td align="right"><b><?=fn_number_format($embel_cost_percent,2);;?> </b></td>
                    </tr>
					<tr>
						<td>Knit Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_knit_req_kg")];$fab_knit_req_kg_avg+=$row[csf("fab_knit_req_kg")]; ?> </b></td>
                        <td>Woven Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_woven_req_yds")];$fab_woven_req_yds_avg+= $row[csf("fab_woven_req_yds")];?> </b></td>
                        <td><b>Total</b></td>
						<td align="right" style="word-break:break-all"><b><? echo fn_number_format($summary_data[fabric_cost_job]+$summary_data[trims_cost_job]+$summary_data[wash_cost_job]+$summary_data[emb_cost_job],4); ?></b></td>
						<td align="right" ><b><?=fn_number_format($fabric_cost_percent+$trims_cost_percent+$wash_cost_percent+$embel_cost_percent,2);?></b> </td>
                    </tr>
                    <tr>
						<td>Shipment Date </td>
                        <td><b><? echo change_date_format($pulich_ship_date); ?></b></td>
                        <td>Quotation ID</td>
                        <td><b><? echo $row[csf("quotation_id")] ?></b></td>
                        <td>Price Per <?= $unit_of_measurement[$row[csf("order_uom")]] ?></td>
						<td align="right"><b><? echo number_format($row[csf("avg_unit_price")],2); ?></b></td>
						<td style="border-bottom:hidden;border-right:hidden;"></td>
                    </tr>
                    <tr>
						<td>Internal Ref</td>
                        <td><b><? echo ltrim($ref_cond,", "); ?></b></td>
                        <td>Costing Per</td>
                        <td><b><? echo $costing_per[$row[csf("costing_per")]];?></b></td>
                        <td>Costing Per <?= $unit_of_measurement[$row[csf("order_uom")]] ?></td>
						<td align="right"><b><? echo number_format($row[csf("avg_unit_price")]-$row[csf("margin_pcs_bom")],4);;?></b></td>
						<td style="border-bottom:hidden;border-right:hidden;"></td>
                     </tr>
                     <tr>
					 	<td>Sc/Lc No</td>
                        <td><b><? echo $sc_lc_no; ?> </b></td>
                        <td>File No</td>
                        <td><b><? echo $file_cond; ?> </b></td>
                        <!-- <td align="center" height="10" colspan="2" valign="middle" id="app_sms" style="font-size:20px;"><font color="#FF0000"><? if( $row[csf("approved")]==1){echo "This Job is Approved ";} else {echo "";} ?> </font> </td> -->
                        <td>Margin Per <?= $unit_of_measurement[$row[csf("order_uom")]] ?></td>
						<td align="right"><b><? echo $row[csf("margin_pcs_bom")];?></b></td>
						<td style="border-bottom:hidden;border-right:hidden;"></td>
                     </tr>
                     <tr>   
					 	<td>SMV</td>
                        <td><b><? echo $sew_smv; ?></b></td>
                        <td>EFF %</td>
                        <td><b><? echo $sew_effi_percent; ?></b></td>
						<td>EPM</td>
                        <td><b><? echo number_format($cm_cost_dzn/$order_price_per_dzn/$sew_smv,6); ?></b></td>
						<td style="border-bottom:hidden;border-right:hidden;"></td>
                    </tr>
					<tr>   
						<td>Dealing Merchant</td>
                        <td><b><? echo $merchantArr[$dealing_marchant]; ?></b></td>
                        <td colspan="2" style="color:red"> This Job Is <b ><? if($approved_id==1) $app_msg="Approved"; else if($approved_id==3) $app_msg="Partial Approved";  else $app_msg="Un-Approved"; echo $app_msg; ?></b></td>
						<td>CPM</td>
                        <td title="Ex.Rate=<?=$exchange_rate."==>".$financial_para[$pre_costing_date][cost_per_minute];?>"><b><? echo  number_format($financial_para[$pre_costing_date][cost_per_minute]/$exchange_rate,6);; ?></b></td>
						<td style="border-bottom:hidden;border-right:hidden;"></td>
                    </tr>
                </table>
            
      <?
		//start	all summary report here -------------------------------------------
	$condition= new condition();
	if(str_replace("'","",$txt_job_no) !=''){
		$condition->job_no("=$txt_job_no");
	}
	$txt_po_breack_down_id=str_replace("'",'',$txt_po_breack_down_id);
	if(str_replace("'",'',$txt_po_breack_down_id) !=""){
		$condition->po_id("in($txt_po_breack_down_id)");
	}
	$condition->init();
	$fabric= new fabric($condition);
	$yarn= new yarn($condition);
	$conversion= new conversion($condition);
	$trim= new trims($condition);
	$emblishment= new emblishment($condition);
	$wash= new wash($condition);
	$other= new other($condition);
	$other_cost=$other->getAmountArray_by_job();
	$commercial= new commercial($condition);
	$commision= new commision($condition);


	 $sql_new = "SELECT job_no, fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent, wash_cost, wash_cost_percent, comm_cost, comm_cost_percent, commission, commission_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, freight, freight_percent, currier_pre_cost, currier_percent, certificate_pre_cost, certificate_percent, common_oh, common_oh_percent, depr_amor_pre_cost, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set, margin_pcs_set_percent, cm_for_sipment_sche, design_cost, design_percent, studio_cost, studio_percent from wo_pre_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
			$data_array_new=sql_select($sql_new);
			$summary_data=array();

            foreach( $data_array_new as $row_new ){
				$summary_data[price_dzn]=$row_new[csf("price_dzn")];
				$summary_data[price_dzn_job]=($po_qty/($total_set_qnty*$order_price_per_dzn))*$row_new[csf("price_dzn")];
			    $summary_data[commission]=$row_new[csf("commission")];
				$summary_data[trims_cost]=$row_new[csf("trims_cost")];
				$summary_data[emb_cost]=$row_new[csf("embel_cost")];

				$summary_data[lab_test]=$row_new[csf("lab_test")];
				$summary_data[lab_test_job]=$other_cost[$row_new[csf("job_no")]]['lab_test'];

				$summary_data[inspection]=$row_new[csf("inspection")];
				$summary_data[inspection_job]=$other_cost[$row_new[csf("job_no")]]['inspection'];

				$summary_data[freight]=$row_new[csf("freight")];
				$summary_data[freight_job]=$other_cost[$row_new[csf("job_no")]]['freight'];

				$summary_data[design]=$row_new[csf("design_cost")];
				$summary_data[design_job]=$row_new[csf("design_cost")]/$order_price_per_dzn*$po_qty;

				$summary_data[studio]=$row_new[csf("studio_cost")];
				$summary_data[studio_job]=$row_new[csf("studio_cost")]/$order_price_per_dzn*$po_qty;

				$summary_data[currier_pre_cost]=$row_new[csf("currier_pre_cost")];
				$summary_data[currier_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['currier_pre_cost'];

				$summary_data[certificate_pre_cost]=$row_new[csf("certificate_pre_cost")];
				$summary_data[certificate_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['certificate_pre_cost'];
				$summary_data[wash_cost]=$row_new[csf("wash_cost")];

				$summary_data[OtherDirectExpenses]=$row_new[csf("lab_test")]+$row_new[csf("inspection")]+$row_new[csf("design_cost")]+$row_new[csf("studio_cost")]+$row_new[csf("freight")]+$row_new[csf("currier_pre_cost")]+$row_new[csf("certificate_pre_cost")]+$row_new[csf("wash_cost")];

				$summary_data[OtherDirectExpenses_job]=$summary_data[lab_test_job]+$summary_data[inspection_job]+$summary_data[design_job]+$summary_data[studio_job]+$summary_data[freight_job]+$summary_data[currier_pre_cost_job]+$summary_data[certificate_pre_cost_job];

				$summary_data[cm_cost]=$row_new[csf("cm_cost")];
				$summary_data[cm_cost_job]=$other_cost[$row_new[csf("job_no")]]['cm_cost'];

				$summary_data[comm_cost]=$row_new[csf("comm_cost")];

				$summary_data[common_oh]=$row_new[csf("common_oh")];
				$summary_data[common_oh_job]=$other_cost[$row_new[csf("job_no")]]['common_oh'];
				$summary_data[depr_amor_pre_cost]=$row_new[csf("depr_amor_pre_cost")];
				$summary_data[depr_amor_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['depr_amor_pre_cost'];
			}

	//Fabric =====================
	$fabric_qty=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$fabric_amount=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$sql_fabric = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description,uom, avg_cons,avg_cons_yarn, fabric_source,gsm_weight, rate, amount, avg_finish_cons, status_active  from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no." and is_deleted=0 and status_active=1";
	$data_arr_fabric=sql_select($sql_fabric);
	foreach($data_arr_fabric as $fab_row){
		$summary_data[fabric_cost][$fab_row[csf("id")]]=$fab_row[csf("amount")];
		$summary_data[fabric_cost_job]+=$fabric_amount['knit']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		$summary_data[fabric_cost_job]+=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
	}



	//Fabric End======================

	// Yarn===========================
	$totYarn=0;
	$YarnData=array();
	$yarn_data_array=$yarn->get_By_Precostdtlsid_YarnQtyAmountArray();
	$sql_yarn="select f.id as yarn_id,f.cons_ratio,f.cons_qnty,f.avg_cons_qnty,f.rate,f.amount,count_id,copm_one_id,percent_one,color,type_id   from wo_pre_cost_fab_yarn_cost_dtls f where     f.job_no =".$txt_job_no." and f.is_deleted=0 and f.status_active=1  order by f.id";
	$data_arr_yarn=sql_select($sql_yarn);
	foreach($data_arr_yarn as $yarn_row){
		$yarnrate=$yarn_row[csf("rate")];
		$summary_data[yarn_cost][$yarn_row[csf("yarn_id")]]=$yarn_row[csf("amount")];
		$summary_data[yarn_cost_job]+=$yarn_data_array[$yarn_row[csf("yarn_id")]]['amount'];

		$index="'".$yarn_row[csf("count_id")]."_".$yarn_row[csf("copm_one_id")]."_".$yarn_row[csf("percent_one")]."_".$yarn_row[csf("type_id")]."_".$yarn_row[csf("color")]."_".$yarnrate."'";
		$YarnData[$index]['qty']+=$yarn_data_array[$yarn_row[csf("yarn_id")]]['qty'];
		$YarnData[$index]['amount']+=$yarn_data_array[$yarn_row[csf("yarn_id")]]['amount'];
		$YarnData[$index]['dznqty']+=$yarn_row[csf("cons_qnty")];
		$YarnData[$index]['dznamount']+=$yarn_row[csf("amount")];
		$totYarn+=$yarn_data_array[$yarn_row[csf("yarn_id")]]['qty'];
	}
	// Yarn End============================
	// Conversion
	$totConv=0;
	$ConvData=array();
	$conv_data=array();
	$conv_amount_arr=$conversion->getAmountArray_by_conversionid();
	$conv_qty_arr=$conversion->getQtyArray_by_conversionid();
	$sql_conv = "select a.id as con_id, a.fabric_description as fabric_description_id, a.job_no, a.cons_process, a.req_qnty,a.avg_req_qnty, a.charge_unit, a.amount, a.status_active,b.body_part_id,b.fab_nature_id,b.color_type_id,b.fabric_description,b.uom  from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id and b.is_deleted=0 and b.status_active=1 where a.job_no=".$txt_job_no."";
	$data_arr_conv=sql_select($sql_conv);
	foreach($data_arr_conv as $conv_row){
		$convamount=$conv_amount_arr[$conv_row[csf('con_id')]][$conv_row[csf('uom')]];
		$convQty=$conv_qty_arr[$conv_row[csf('con_id')]][$conv_row[csf('uom')]];

		$conv_data[cons_process][$conv_row[csf('con_id')]]=$conv_row[csf('cons_process')];
		$conv_data[amount][$conv_row[csf('con_id')]]=$conv_row[csf('amount')];
		$conv_data[amount_job][$conv_row[csf('con_id')]]+=$convamount;
		$summary_data[conver_cost_job]+=$convamount;

		$index=$conv_row[csf('con_id')];
		$ConvData[$index]['item_descrition']=$body_part[$conv_row[csf("body_part_id")]].", ".$color_type[$conv_row[csf("color_type_id")]].", ".$conv_row[csf("fabric_description")];
		$ConvData[$index]['cons_process']=$conv_row[csf("cons_process")];
		$ConvData[$index]['req_qnty']=$conv_row[csf("req_qnty")];
		$ConvData[$index]['uom']=$conv_row[csf("uom")];
		$ConvData[$index]['charge_unit']=$conv_row[csf("charge_unit")];
		$ConvData[$index]['amount']=$conv_row[csf("amount")];
		$ConvData[$index]['tot_req_qnty']=$convQty;
		$ConvData[$index]['tot_amount']=$convamount;
		$totConv+=$conv_row[csf("req_qnty")];
	}
	//Conversion End

	//start	Trims Cost part report here -------------------------------------------
	$sql_trim = "select id, job_no, trim_group,description,brand_sup_ref,remark, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,status_active,seq
	from wo_pre_cost_trim_cost_dtls
	where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 order by seq";
	$data_array_trim=sql_select($sql_trim);
	$trim_amount_arr=$trim->getAmountArray_precostdtlsid();
	$trim_qty_arr=$trim->getQtyArray_by_precostdtlsid();
	$totTrim=0;
	$TrimData=array();
	foreach( $data_array_trim as $row_trim ){
		$trim_qty=$trim_qty_arr[$row_trim[csf("id")]];
		$trim_amount=$trim_amount_arr[$row_trim[csf("id")]];
		$summary_data[trims_cost_job]+=$trim_amount;
		$TrimData[$row_trim[csf('id')]]['trim_group']=$row_trim[csf('trim_group')];
		$TrimData[$row_trim[csf('id')]]['description']=$row_trim[csf('description')];
		$TrimData[$row_trim[csf('id')]]['brand_sup_ref']=$row_trim[csf('brand_sup_ref')];
		$TrimData[$row_trim[csf('id')]]['remark']=$row_trim[csf('remark')];
		$TrimData[$row_trim[csf('id')]]['cons_uom']=$row_trim[csf('cons_uom')];
		$TrimData[$row_trim[csf('id')]]['cons_dzn_gmts']=$row_trim[csf('cons_dzn_gmts')];
		$TrimData[$row_trim[csf('id')]]['rate']=$row_trim[csf('rate')];
		$TrimData[$row_trim[csf('id')]]['amount']=$row_trim[csf('amount')];
		$TrimData[$row_trim[csf('id')]]['apvl_req']=$row_trim[csf('apvl_req')];
		$TrimData[$row_trim[csf('id')]]['nominated_supp']=$row_trim[csf('nominated_supp')];
		$TrimData[$row_trim[csf('id')]]['tot_cons']=$trim_qty;
		$TrimData[$row_trim[csf('id')]]['tot_amount']=$trim_amount;
		$totTrim+=$row_trim[csf('cons_dzn_gmts')];
	}
	//End	Trims Cost part report here -------------------------------------------
	//Emb cost Cost part report here -------------------------------------------

	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name in(1,2,4,5,99) and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	$emblishment_qty=$emblishment->getQtyArray_by_jobAndEmblishmentid();
	$emblishment_amount=$emblishment->getAmountArray_by_jobAndEmblishmentid();

	$totEmb=0;
	$EmbData=array();

	foreach( $data_array as $row ){
		$embqty=$emblishment_qty[$row[csf("job_no")]][$row[csf("id")]];
		$embamount=$emblishment_amount[$row[csf("job_no")]][$row[csf("id")]];
		$summary_data[emb_cost_job]+=$embamount;
		$EmbData[$row[csf("id")]]['emb_name']=$row[csf("emb_name")];
		$EmbData[$row[csf("id")]]['emb_type']=$row[csf("emb_type")];
		$EmbData[$row[csf("id")]]['cons_dzn_gmts']=$row[csf("cons_dzn_gmts")];
		$EmbData[$row[csf("id")]]['rate']=$row[csf("rate")];
		$EmbData[$row[csf("id")]]['amount']=$row[csf("amount")];
		$EmbData[$row[csf("id")]]['tot_cons']=$embqty;
		$EmbData[$row[csf("id")]]['tot_amount']=$embamount;
		$totEmb+=$row[csf("cons_dzn_gmts")];
	}
	//End Emb cost Cost part report here -------------------------------------------
	//Wash cost Cost part report here -------------------------------------------
	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name =3 and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	$wash_qty=$wash->getQtyArray_by_jobAndEmblishmentid();
	$wash_amount=$wash->getAmountArray_by_jobAndEmblishmentid();
	foreach( $data_array as $row ){
		$washqty=$wash_qty[$row[csf("job_no")]][$row[csf("id")]];
		$washamount=$wash_amount[$row[csf("job_no")]][$row[csf("id")]];
		$summary_data[wash_cost_job]+=$washamount;
		$summary_data[OtherDirectExpenses_job]+=$washamount;
		$EmbData[$row[csf("id")]]['emb_name']=$row[csf("emb_name")];
		$EmbData[$row[csf("id")]]['emb_type']=$row[csf("emb_type")];
		$EmbData[$row[csf("id")]]['cons_dzn_gmts']=$row[csf("cons_dzn_gmts")];
		$EmbData[$row[csf("id")]]['rate']=$row[csf("rate")];
		$EmbData[$row[csf("id")]]['amount']=$row[csf("amount")];
		$EmbData[$row[csf("id")]]['tot_cons']=$washqty;
		$EmbData[$row[csf("id")]]['tot_amount']=$washamount;
		$totEmb+=$row[csf("cons_dzn_gmts")];
	}
	//End Wash cost Cost part report here -------------------------------------------
	//Commision cost Cost part report here -------------------------------------------
	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls  where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	$commision_amount=$commision->getAmountArray_by_jobAndPrecostdtlsid();
	$totCommi=0;
	$CommiData=array();
	foreach( $data_array as $row ){
		$commisionamount=$commision_amount[$row[csf("job_no")]][$row[csf("id")]];
		$summary_data[commission_job]+=$commisionamount;
		$CommiData[$row[csf("id")]]['particulars_id']=$row[csf("particulars_id")];
		$CommiData[$row[csf("id")]]['commission_base_id']=$row[csf("commission_base_id")];
		$CommiData[$row[csf("id")]]['commision_rate']=$row[csf("commision_rate")];
		$CommiData[$row[csf("id")]]['commission_amount']=$row[csf("commission_amount")];
		$CommiData[$row[csf("id")]]['tot_commission_amount']=$commisionamount;
		$totCommi+=$row[csf("commission_amount")];
	}
	//End Commision cost Cost part report here -------------------------------------------

	//Commarcial cost Cost part report here -------------------------------------------
	$sql = "select id, job_no, item_id, rate, amount, status_active from  wo_pre_cost_comarci_cost_dtls  where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	$commarcial_amount=$commercial->getAmountArray_by_jobAndPrecostdtlsid();

	$totCommar=0;
	$CommarData=array();
	foreach( $data_array as $row ){
		$commarcialamount=$commarcial_amount[$row[csf("job_no")]][$row[csf("id")]];
		$summary_data[comm_cost_job]+=$commarcialamount;
		$CommarData[$row[csf("id")]]['item_id']=$row[csf("item_id")];
		$CommarData[$row[csf("id")]]['rate']=$row[csf("rate")];
		$CommarData[$row[csf("id")]]['amount']=$row[csf("amount")];
		$CommarData[$row[csf("id")]]['tot_amount']=$commarcialamount;
		$totCommar+=$row[csf("amount")];
	}
	//End Commarcial cost Cost part report here -------------------------------------------
	  ?>
       <div style="margin-top:15px">
         <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
          <tr style="font-weight:bold">
                            <td width="380" colspan="5">Order Profitability </td>

                        </tr>
                        <tr style="font-weight:bold">
                            <td width="80">Line Items</td>
                            <td width="380">Particulars</td>
                            <td width="100">Amount (USD)/<? echo $costing_for; ?></td>
                            <td width="100">Total Value</td>
                            <td width="100">%</td>
                        </tr>
                        <tr>
                            <td width="80">1</td>
                            <td width="380" align="left" style="font-weight:bold">Gross FOB Value</td>
                            <td width="100" align="right" style="font-weight:bold"><? echo number_format($summary_data[price_dzn],4); ?></td>
                            <td width="100" align="right" style="font-weight:bold"><? echo number_format($summary_data[price_dzn_job],4); ?></td>
                            <td width="180" align="right" style="font-weight:bold"><? echo number_format(($summary_data[price_dzn_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                            <td width="80">2</td>
                            <td width="380" align="left" style=" padding-left:15px">Less: commission</td>
                            <td width="100" align="right"><? echo number_format($summary_data[commission],4); ?></td>
                            <td width="100" align="right"><? echo number_format($summary_data[commission_job],4); ?></td>
                            <td width="180" align="right"><? echo number_format(($summary_data[commission_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                           <td width="80">3</td>
                            <?
							$NetFOBValue=$summary_data[price_dzn]-$summary_data[commission];
							$NetFOBValue_job=$summary_data[price_dzn_job]-$summary_data[commission_job];
							?>
                            <td width="380" align="left" style="font-weight:bold"><b>Net FOB Value (1-2)</b></td>
                            <td width="100" align="right" style="font-weight:bold"><? echo number_format($NetFOBValue,4); ?></td>
                            <td width="100" align="right" style="font-weight:bold"><? echo number_format($NetFOBValue_job,4); ?></td>
                            <td width="180" align="right" style="font-weight:bold"><? echo number_format(($NetFOBValue_job/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                            <td width="80">4</td>
                            <td width="380" align="left" style="font-weight:bold"><b>Less: Cost of Material & Services (5+6+7+8+9) </b></td>
                            <?
							$Less_Cost_Material_Services=array_sum($summary_data[fabric_cost])+array_sum($conv_data[amount])+$summary_data[trims_cost]+$summary_data[emb_cost]+$summary_data[lab_test]+$summary_data[inspection]+$summary_data[design]+$summary_data[studio]+$summary_data[freight]+$summary_data[currier_pre_cost]+$summary_data[certificate_pre_cost]+$summary_data[wash_cost];
							//array_sum($summary_data[yarn_cost])+

							$Less_Cost_Material_Services_job=$summary_data[yarn_cost_job]+$summary_data[fabric_cost_job]+$summary_data[conver_cost_job]+$summary_data[trims_cost_job]+$summary_data[emb_cost_job]+$summary_data[OtherDirectExpenses_job];
							?>
                            <td width="100" align="right" style="font-weight:bold"> <? echo number_format($Less_Cost_Material_Services,4); ?></td>
                            <td width="100" align="right" style="font-weight:bold"><? echo number_format($Less_Cost_Material_Services_job,4); ?></td>
                            <td width="180" align="right" style="font-weight:bold"><? echo number_format(($Less_Cost_Material_Services_job/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                          <tr>
                            <td width="80">5</td>
                            <td width="380" align="left" style=" padding-left:100px;font-weight:bold">Fabric Purchase Cost</td>
                            <td width="100" align="right" style="font-weight:bold"> <? echo number_format(array_sum($summary_data[fabric_cost]),4); ?></td>
                            <td width="100" align="right" style="font-weight:bold"> <? echo number_format($summary_data[fabric_cost_job],4); ?></td>
                            <td width="180" align="right" style="font-weight:bold"><? echo number_format(($summary_data[fabric_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                            <td width="80" valign="top">6</td>
                            <td width="380" align="left" style=" padding-left:100px">

                            <table>
                            <tr>
                            <td width="180" style="font-weight:bold">Conversion Cost</td>

                            </tr>
                            </table>

                            <table border="1" class="rpt_table" rules="all">
                            <? foreach($conv_data[cons_process] as $key => $value){ ?>
                            <tr>
                            <td width="180" align="left"><? echo $conversion_cost_head_array[$conv_data[cons_process][$key]]; ?></td>

                            </tr>
                            <? }?>
                            </table>
                            </td>
                            <td width="100" align="right" valign="top">
							<? //echo number_format(array_sum($conv_data[amount]),4); ?>

                             <table>
                            <tr>
                            <td width="100" align="right" style="font-weight:bold"><? echo number_format(array_sum($conv_data[amount]),4); ?></td>
                            </tr>
                            </table>

                            <table border="1" class="rpt_table" rules="all">
                            <? foreach($conv_data[cons_process] as $key => $value){ ?>
                            <tr>

                            <td width="100" align="right"><? echo number_format($conv_data[amount][$key],4);?></td>
                            </tr>
                            <? }?>
                            </table>
                            </td>
                            <td width="100" align="right" valign="top">

                            <table>
                            <tr>
                            <td width="100" align="right" style="font-weight:bold"><? echo number_format($summary_data[conver_cost_job],4); ?></td>
                            </tr>
                            </table>

                            <table border="1" class="rpt_table" rules="all">
                            <? foreach($conv_data[cons_process] as $key => $value){ ?>
                            <tr>

                            <td width="100" align="right"><? echo number_format($conv_data[amount_job][$key],4);?></td>
                            </tr>
                            <? }?>
                            </table>
                            </td>
                            <td width="180" align="right" valign="top">

                            <table>
                            <tr>
                            <td width="100" align="right" style="font-weight:bold"><? echo number_format(($summary_data[conver_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
                            </tr>
                            </table>

                            <table border="1" class="rpt_table" rules="all">
                            <? foreach($conv_data[cons_process] as $key => $value){ ?>
                            <tr>

                            <td width="180" align="right"><? echo number_format(($conv_data[amount_job][$key]/$summary_data[price_dzn_job])*100,4);?></td>
                            </tr>
                            <? }?>
                            </table>
                            </td>
                        </tr>

                        <tr>
                            <td width="80">7</td>
                            <td width="380" align="left" style=" padding-left:100px;font-weight:bold" ><b>Trim Cost </b></td>
                            <td width="100" align="right" style="font-weight:bold"> <? echo number_format($summary_data[trims_cost],4); ?></td>
                            <td width="100" align="right" style="font-weight:bold"><? echo number_format($summary_data[trims_cost_job],4)?></td>
                            <td width="180" align="right" style="font-weight:bold"><? echo number_format(($summary_data[trims_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                            <td width="80">8</td>
                            <td width="380" align="left" style=" padding-left:100px;font-weight:bold"><b>Embelishment Cost </b></td>
                            <td width="100" align="right" style="font-weight:bold"> <? echo number_format($summary_data[emb_cost],4); ?></td>
                            <td width="100" align="right" style="font-weight:bold"><? echo number_format($summary_data[emb_cost_job],4); ?></td>
                            <td width="180" align="right" style="font-weight:bold"><? echo number_format(($summary_data[emb_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                            <td width="80" valign="top">9</td>
                            <td width="380" align="left" style=" padding-left:100px">

                            <table>
                            <tr>
                            <td width="180" style="font-weight:bold">Other Direct Expenses</td>

                            </tr>
                            </table>


                            <table border="1" class="rpt_table" rules="all">

                            <tr>
                            	<td width="180" align="left">Lab Test</td>
                            </tr>
                            <tr>
                            	<td width="180" align="left">Inspection</td>
                            </tr>
                            <tr>
                            	<td width="180" align="left">Design Cost</td>
                            </tr>
                            <tr>
                            	<td width="180" align="left">Studio Cost</td>
                            </tr>

                            <tr>
                            <td width="180" align="left">Freight Cost</td>

                            </tr>

                            <tr>
                            <td width="180" align="left">Courier Cost</td>

                            </tr>

                             <tr>
                            <td width="180" align="left">Certificate Cost</td>

                            </tr>

                            <tr>
                            <td width="180" align="left">Garments Wash Cost</td>

                            </tr>

                            </table>
                            </td>
                            <td width="100" align="right" valign="top">
                            <table>
                            <tr>
                            <td width="100" align="right" style="font-weight:bold"><? echo number_format($summary_data[OtherDirectExpenses],4); ?></td>
                            </tr>
                            </table>
                            <table border="1" class="rpt_table" rules="all">

                            <tr>

                            <td width="100" align="right"><? echo number_format($summary_data[lab_test],4);?></td>
                            </tr>

                            <tr>
                            	<td width="100" align="right"><? echo number_format($summary_data[inspection],4);?></td>
                            </tr>

                            <tr>
                            	<td width="100" align="right"><? echo number_format($summary_data[design],4);?></td>
                            </tr>
                            <tr>
                            	<td width="100" align="right"><? echo number_format($summary_data[studio],4);?></td>
                            </tr>

                            <tr>

                            <td width="100" align="right"><? echo number_format($summary_data[freight],4);?></td>
                            </tr>

                            <tr>

                            <td width="100" align="right"><? echo number_format($summary_data[currier_pre_cost],4);?></td>
                            </tr>

                             <tr>

                            <td width="100" align="right"><? echo number_format($summary_data[certificate_pre_cost],4);?></td>
                            </tr>

                            <tr>

                            <td width="100" align="right"><? echo number_format($summary_data[wash_cost],4);?></td>
                            </tr>

                            </table>
                            </td>


                            <td width="100" align="right" valign="top">
							<? //echo number_format($summary_data[OtherDirectExpenses_job],4); ?>
                            <table>
                            <tr>
                            <td width="100" align="right" style="font-weight:bold"><? echo number_format($summary_data[OtherDirectExpenses_job],4); ?></td>
                            </tr>
                            </table>
                            <table border="1" class="rpt_table" rules="all">

                            <tr>

                            <td width="100" align="right"><? echo number_format($summary_data[lab_test_job],4);?></td>
                            </tr>

                            <tr>
                            <td width="100" align="right"><? echo number_format($summary_data[inspection_job],4);?></td>
                            </tr>

                            <tr>
                            <td width="100" align="right"><? echo number_format($summary_data[design_job],4);?></td>
                            </tr>

                            <tr>
                            <td width="100" align="right"><? echo number_format($summary_data[studio_job],4);?></td>
                            </tr>

                            <tr>

                            <td width="100" align="right"><? echo number_format($summary_data[freight_job],4);?></td>
                            </tr>

                            <tr>

                            <td width="100" align="right"><? echo number_format($summary_data[currier_pre_cost_job],4);?></td>
                            </tr>

                             <tr>

                            <td width="100" align="right"><? echo number_format($summary_data[certificate_pre_cost_job],4);?></td>
                            </tr>

                            <tr>

                            <td width="100" align="right"><? echo number_format($summary_data[wash_cost_job],4);?></td>
                            </tr>

                            </table>
                            </td>
                            <td width="180" align="right" valign="top">

                            <table>
                            <tr>
                            <td width="180" align="right" style="font-weight:bold"><? echo number_format(($summary_data[OtherDirectExpenses_job]/$summary_data[price_dzn_job])*100,4);?></td>
                            </tr>
                            </table>
                            <table border="1" class="rpt_table" rules="all">

                            <tr>

                            <td width="180" align="right"><? echo number_format(($summary_data[lab_test_job]/$summary_data[price_dzn_job])*100,4);?></td>
                            </tr>

                            <tr>
                            <td width="180" align="right"><? echo number_format(($summary_data[inspection_job]/$summary_data[price_dzn_job])*100,4);?></td>
                            </tr>

                            <tr>
                            <td width="180" align="right"><? echo number_format(($summary_data[design_job]/$summary_data[price_dzn_job])*100,4);?></td>
                            </tr>

                            <tr>
                            <td width="180" align="right"><? echo number_format(($summary_data[studio_job]/$summary_data[price_dzn_job])*100,4);?></td>
                            </tr>

                            <tr>

                            <td width="180" align="right"><? echo number_format(($summary_data[freight_job]/$summary_data[price_dzn_job])*100,4);?></td>
                            </tr>

                            <tr>

                            <td width="180" align="right"><? echo number_format(($summary_data[currier_pre_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
                            </tr>

                             <tr>

                            <td width="180" align="right"><? echo number_format(($summary_data[certificate_pre_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
                            </tr>

                            <tr>

                            <td width="180" align="right"><? echo number_format(($summary_data[wash_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
                            </tr>

                            </table>
                            </td>
                        </tr>
                         <tr>
                            <td width="80">10</td>
                            <td width="380" align="left" style="font-weight:bold">Contributions/Value Additions (3-4)</td>
                            <?
							$Contribution_Margin=$NetFOBValue-$Less_Cost_Material_Services;
							$Contribution_Margin_job=$NetFOBValue_job-$Less_Cost_Material_Services_job;
							?>
                            <td width="100" align="right" style="font-weight:bold"> <? echo number_format($Contribution_Margin,4); ?></td>
                            <td width="100" align="right" style="font-weight:bold"><? echo number_format($Contribution_Margin_job,4); ?></td>
                            <td width="180" align="right" style="font-weight:bold"><? echo number_format(($Contribution_Margin_job/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                            <td width="80">11</td>
                            <td width="380" align="left" style=" padding-left:15px">Less: CM Cost </td>
                            <td width="100" align="right"><? echo number_format($summary_data[cm_cost],4); ?> </td>
                            <td width="100" align="right"><? echo number_format($summary_data[cm_cost_job],4); ?></td>
                            <td width="180" align="right"><? echo number_format(($summary_data[cm_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                            <td width="80">12</td>
                            <td width="380" align="left" style="font-weight:bold">Gross Profit (10-11)</td>
                            <?
							$Gross_Profit=$Contribution_Margin-$summary_data[cm_cost];
							$Gross_Profit_job=$Contribution_Margin_job-$summary_data[cm_cost_job];
							?>
                            <td width="100" align="right" style="font-weight:bold"> <? echo number_format($Gross_Profit,4); ?></td>
                            <td width="100" align="right" style="font-weight:bold"><? echo number_format($Gross_Profit_job,4); ?></td>
                            <td width="180" align="right" style="font-weight:bold"><? echo number_format(($Gross_Profit_job/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>

                        <tr>
                            <td width="80">13</td>
                            <td width="380" align="left" style=" padding-left:15px">Less: Commercial Cost</td>

                            <td width="100" align="right"> <? echo number_format( $summary_data[comm_cost],4); ?></td>
                            <td width="100" align="right"><? echo number_format( $summary_data[comm_cost_job],4); ?></td>
                            <td width="180" align="right"><? echo number_format(($summary_data[comm_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                            <td width="80">14</td>
                            <td width="380" align="left" style=" padding-left:15px">Less: Operating Expensees</td>

                            <td width="100" align="right"><? echo number_format( $summary_data[common_oh],4); ?> </td>
                            <td width="100" align="right"><? echo number_format( $summary_data[common_oh_job],4); ?> </td>
                            <td width="180" align="right"><? echo number_format(($summary_data[common_oh_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>

                        <tr >
                            <td width="80">15</td>
                            <td width="380" align="left" style="font-weight:bold">Operating Profit/ Loss (12-(13+14))</td>
                            <?
							$OperatingProfitLoss=$Gross_Profit-($summary_data[comm_cost]+$summary_data[common_oh]);
							$OperatingProfitLoss_job=$Gross_Profit_job-($summary_data[comm_cost_job]+$summary_data[common_oh_job]);
							?>
                            <td width="100" align="right" style="font-weight:bold"> <? echo number_format($OperatingProfitLoss,4); ?></td>
                            <td width="100" align="right" style="font-weight:bold"><? echo number_format($OperatingProfitLoss_job,4); ?></td>
                            <td width="180" align="right" style="font-weight:bold"><? echo number_format(($OperatingProfitLoss_job/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                         <tr>
                            <td width="80">16</td>
                            <td width="380" align="left" style=" padding-left:15px">Less: Depreciation & Amortization </td>

                            <td width="100" align="right"> <? echo number_format( $summary_data[depr_amor_pre_cost],4); ?></td>
                            <td width="100" align="right"><? echo number_format( $summary_data[depr_amor_pre_cost_job],4); ?></td>
                            <td width="180" align="right"><? echo number_format(($summary_data[depr_amor_pre_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                        <?
						$interest_expense=$NetFOBValue*$financial_para[$pre_costing_date][interest_expense]/100;
						$income_tax=$NetFOBValue*$financial_para[$pre_costing_date][income_tax]/100;
						$interest_expense_job=$NetFOBValue_job*$financial_para[$pre_costing_date][interest_expense]/100;
						$income_tax_job=$NetFOBValue_job*$financial_para[$pre_costing_date][income_tax]/100;
						?>
                            <td width="80">17</td>
                            <td width="380" align="left" style=" padding-left:15px">Less: Interest </td>

                            <td width="100" align="right"> <? echo number_format( $interest_expense,4); ?></td>
                            <td width="100" align="right"><? echo number_format( $interest_expense_job,4); ?></td>
                            <td width="180" align="right"><? echo number_format(($interest_expense_job/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                         <tr>
                            <td width="80">18</td>
                            <td width="380" align="left" style=" padding-left:15px">Less: Income Tax</td>

                            <td width="100" align="right"> <? echo number_format( $income_tax,4); ?></td>
                            <td width="100" align="right"><? echo number_format( $income_tax_job,4); ?></td>
                            <td width="180" align="right"><? echo number_format(($income_tax_job/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        <tr>
                            <?
							$Netprofit=$OperatingProfitLoss-($summary_data[depr_amor_pre_cost]+$interest_expense+$income_tax);
							$Netprofit_job=$OperatingProfitLoss_job-($summary_data[depr_amor_pre_cost_job]+$interest_expense_job+$income_tax_job);
							?>
                            <td width="80">19</td>
                            <td width="380" align="left" style="font-weight:bold">Net Profit/Loss (15-(16+17+18))</td>

                            <td width="100" align="right" style="font-weight:bold"><? echo number_format( $Netprofit,4); ?> </td>
                            <td width="100" align="right" style="font-weight:bold"><? echo number_format( $Netprofit_job,4); ?></td>
                            <td width="180" align="right" style="font-weight:bold"><? echo number_format(($Netprofit_job/$summary_data[price_dzn_job])*100,4);?></td>
                        </tr>
                        </table>
         </div>
      <?
	//End all summary report here -------------------------------------------



	//2	All Fabric Cost part here-------------------------------------------
		$sql = "SELECT id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description,uom, avg_cons,avg_cons_yarn, fabric_source,gsm_weight, rate, amount,avg_finish_cons,status_active,gsm_weight_type from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no." and is_deleted=0 and status_active=1";
		$data_array=sql_select($sql);

		$knit_fab="";
		$woven_fab="";
		$knit_fab_dtls="";

		$knit_subtotal_avg_cons=0;
		$knit_subtotal_amount=0;
		$woven_subtotal_avg_cons=0;
		$woven_subtotal_amount=0;
		$grand_total_amount=0;

		$i=1;
		$j=1;
		foreach( $data_array as $row ) {
			$uom=$unit_of_measurement[$row[csf("uom")]];
			$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")].", ".$fabric_weight_type[$row[csf("gsm_weight_type")]].", ".$row[csf("gsm_weight")];

            if($row[csf("fab_nature_id")]==2){//knit fabrics
			    $i++;
				$totalConsKnit=$fabric_qty['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$totalAmountKnit=$fabric_amount['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$amount=$row[csf("avg_cons")]*$row[csf("rate")];

                $knit_fab_dtls .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.number_format($row[csf("avg_cons")],4).'</td>
					<td align="right">'.number_format($totalConsKnit,4).'</td>
					<td align="left">'.$uom.'</td>
                    <td align="right">'.number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.number_format($amount,4).'</td>
					<td align="right">'.number_format($totalAmountKnit,4).'</td>
                </tr>';
				if($row[csf("uom")]==1){
					$DznConsKnitSubTotalPcs += $row[csf("avg_cons")];
					$TotalConsKnitSubTotalPcs += $totalConsKnit;
					$DznAmountKnitSubTotalPcs+=$amount;
					$TotalAmountKnitSubTotalPcs+=$totalAmountKnit;
				 }
                 if($row[csf("uom")]==12){
					$DznConsKnitSubTotalKg += $row[csf("avg_cons")];
					$TotalConsKnitSubTotalKg += $totalConsKnit;
					$DznAmountKnitSubTotalKg+=$amount;
					$TotalAmountKnitSubTotalKg+=$totalAmountKnit;
				 }
				 if($row[csf("uom")]==23){
					$DznConsKnitSubTotalMtr += $row[csf("avg_cons")];
					$TotalConsKnitSubTotalMtr += $totalConsKnit;
					$DznAmountKnitSubTotalMtr+=$amount;
					$TotalAmountKnitSubTotalMtr+=$totalAmountKnit;
				 }
				 if($row[csf("uom")]==27){
					$DznConsKnitSubTotalYds += $row[csf("avg_cons")];
					$TotalConsKnitSubTotalYds += $totalConsKnit;
					$DznAmountKnitSubTotalYds+=$amount;
					$TotalAmountKnitSubTotalYds+=$totalAmountKnit;
				 }
				 $GrandtotalDznAmount+=$amount;
				 $GrandtotalAmount+=$totalAmountKnit;

				 $GrandTotalFabricDznAmount+=$amount;
				 $GrandTotalFabricAmount+=$totalAmountKnit;


			}

			if($row[csf("fab_nature_id")]==3){//woven fabrics
			    $j++;
			    $totalConsWoven=$fabric_qty['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$totalAmountWoven=$fabric_amount['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];

				$amount=$row[csf("avg_cons")]*$row[csf("rate")];

                $woven_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.number_format($row[csf("avg_cons")],4).'</td>
					<td align="right">'.number_format($totalConsWoven,4).'</td>
					<td align="left">'.$uom.'</td>
                    <td align="right">'.number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.number_format($amount,4).'</td>
					<td align="right">'.number_format($totalAmountWoven,4).'</td>
                </tr>';

				if($row[csf("uom")]==1){
					$DznConsWovenSubTotalPcs += $row[csf("avg_cons")];
					$TotalConsWovenSubTotalPcs += $totalConsWoven;
					$DznAmountWovenSubTotalPcs+=$amount;
					$TotalAmountWovenSubTotalPcs+=$totalAmountWoven;
				 }
                 if($row[csf("uom")]==12){
					$DznConsWovenSubTotalKg += $row[csf("avg_cons")];
					$TotalConsWovenSubTotalKg += $totalConsWoven;
					$DznAmountWovenSubTotalKg+=$amount;
					$TotalAmountWovenSubTotalKg+=$totalAmountWoven;
				 }
				 if($row[csf("uom")]==23){
					$DznConsWovenSubTotalMtr += $row[csf("avg_cons")];
					$TotalConsWovenSubTotalMtr += $totalConsWoven;
					$DznAmountWovenSubTotalMtr+=$amount;
					$TotalAmountWovenSubTotalMtr+=$totalAmountWoven;
				 }
				 if($row[csf("uom")]==27){
					$DznConsWovenSubTotalYds += $row[csf("avg_cons")];
					$TotalConsWovenSubTotalYds += $totalConsWoven;
					$DznAmountWovenSubTotalYds+=$amount;
					$TotalAmountWovenSubTotalYds+=$totalAmountWoven;
				 }
				 $GrandtotalDznAmount+=$amount;
				 $GrandtotalAmount+=$totalAmountWoven;

				 $GrandTotalFabricDznAmount+=$amount;
				 $GrandTotalFabricAmount+=$totalAmountWoven;
			}
        }
		if($DznConsKnitSubTotalPcs>0){
				$i++;
		}
		if($DznConsKnitSubTotalKg>0){
				$i++;

		}
		if($DznConsKnitSubTotalMtr>0){
				$i++;
		}
		if($DznConsKnitSubTotalYds>0){
				$i++;
		}

		if($DznConsWovenSubTotalPcs>0){
			$j++;
		}
		if($DznConsWovenSubTotalKg>0){
			$j++;
		}
		if($DznConsWovenSubTotalMtr>0){
			$j++;
		}
		if($DznConsWovenSubTotalYds>0){
			$j++;
		}
		$knit_fab= '<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
					<label><b>All Fabric Cost  </b></label>
						<tr style="font-weight:bold"  align="center">
							<td width="80"  ><div class=""><b>Fabric Nature</b></div></td>
							<td width="350">Description</td>
							<td width="100">Source</td>
							<td width="100">Fab. Cons/'.$costing_for.'</td>
							<td width="100">Total Cons</td>
							<td width="100">UOM</td>
							<td width="100">Rate (USD)</td>
							<td width="100">Amount (USD)/'.$costing_for.'</td>
							<td width="100">Tot.Amount (USD)</td>
						</tr>';
		if($DznConsKnitSubTotalPcs>0 || $DznConsKnitSubTotalKg>0 || $DznConsKnitSubTotalMtr>0 || $DznConsKnitSubTotalYds>0){
			$knit_fab.='<tr><td width="80" rowspan="'.$i.'"><div class="verticalText"><b>Knit Fabric</b></div></td></tr>'.$knit_fab_dtls;
		}			
		
		
		if($DznConsWovenSubTotalPcs>0 || $DznConsWovenSubTotalKg>0 || $DznConsWovenSubTotalMtr>0 || $DznConsWovenSubTotalYds>0){
			if($knit_fab_dtls!="")
			{
				$woven_fab= '<tr><td colspan="9">&nbsp;</td></tr><tr>
						<td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;
			}
			else{
				$woven_fab= '<tr><td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;
			}
		
		}

		//knit fabrics table here
		if($DznConsKnitSubTotalPcs>0){
			$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
							<td colspan="2" align="left">Sub Total(Pcs)</td>
							<td align="right">'.number_format($DznConsKnitSubTotalPcs,4).'</td>
							<td align="right">'.number_format($TotalConsKnitSubTotalPcs,4).'</td>
							<td></td>
							<td></td>
							<td align="right">'.number_format($DznAmountKnitSubTotalPcs,4).'</td>
							<td align="right">'.number_format($TotalAmountKnitSubTotalPcs,4).'</td>
						</tr>';
		}
		if($DznConsKnitSubTotalKg>0){
			$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
							<td colspan="2" align="left">Sub Total(Kg)</td>
							<td align="right">'.number_format($DznConsKnitSubTotalKg,4).'</td>
							<td align="right">'.number_format($TotalConsKnitSubTotalKg,4).'</td>
							<td></td>
							<td></td>
							<td align="right">'.number_format($DznAmountKnitSubTotalKg,4).'</td>
							<td align="right">'.number_format($TotalAmountKnitSubTotalKg,4).'</td>
						</tr>';
		}
		if($DznConsKnitSubTotalMtr>0){
			$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
							<td colspan="2" align="left">Sub Total(Mtr)</td>
							<td align="right">'.number_format($DznConsKnitSubTotalMtr,4).'</td>
							<td align="right">'.number_format($TotalConsKnitSubTotalMtr,4).'</td>
							<td></td>
							<td></td>
							<td align="right">'.number_format($DznAmountKnitSubTotalMtr,4).'</td>
							<td align="right">'.number_format($TotalAmountKnitSubTotalMtr,4).'</td>
						</tr>';
		}
		if($DznConsKnitSubTotalYds>0){
			$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
							<td colspan="2" align="left">Sub Total(Yds)</td>
							<td align="right">'.number_format($DznConsKnitSubTotalYds,4).'</td>
							<td align="right">'.number_format($TotalConsKnitSubTotalYds,4).'</td>
							<td></td>
							<td></td>
							<td align="right">'.number_format($DznAmountKnitSubTotalYds,4).'</td>
							<td align="right">'.number_format($TotalAmountKnitSubTotalYds,4).'</td>
						</tr>';
		}
		if($zero_value==1){
		   echo $knit_fab;
		}
		else{
			if($row[csf("avg_cons")]>0){
				echo $knit_fab;
			}
			else{
				echo "";
			}
		}

		//woven fabrics table here
		if($DznConsWovenSubTotalPcs>0){
		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total(Pcs)</td>
						<td align="right">'.number_format($DznConsWovenSubTotalPcs,4).'</td>
						<td align="right">'.number_format($TotalConsWovenSubTotalPcs,4).'</td>
						<td></td>
						<td></td>
						<td align="right">'.number_format($DznAmountWovenSubTotalPcs,4).'</td>
						<td align="right">'.number_format($TotalAmountWovenSubTotalPcs,4).'</td>
					</tr>';
		}
		if($DznConsWovenSubTotalKg>0){
		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total(Kg)</td>
						<td align="right">'.number_format($DznConsWovenSubTotalKg,4).'</td>
						<td align="right">'.number_format($TotalConsWovenSubTotalKg,4).'</td>
						<td></td>
						<td></td>
						<td align="right">'.number_format($DznAmountWovenSubTotalKg,4).'</td>
						<td align="right">'.number_format($TotalAmountWovenSubTotalKg,4).'</td>
					</tr>';
		}
		if($DznConsWovenSubTotalMtr>0){

		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total(Mtr)</td>
						<td align="right">'.number_format($DznConsWovenSubTotalMtr,4).'</td>
						<td align="right">'.number_format($TotalConsWovenSubTotalMtr,4).'</td>
						<td></td>
						<td></td>
						<td align="right">'.number_format($DznAmountWovenSubTotalMtr,4).'</td>
						<td align="right">'.number_format($TotalAmountWovenSubTotalMtr,4).'</td>
					</tr>';
		}
		if($DznConsWovenSubTotalYds>0){
		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total(Yds)</td>
						<td align="right">'.number_format($DznConsWovenSubTotalYds,4).'</td>
						<td align="right">'.number_format($TotalConsWovenSubTotalYds,4).'</td>
						<td></td>
						<td></td>
						<td align="right">'.number_format($DznAmountWovenSubTotalYds,4).'</td>
						<td align="right">'.number_format($TotalAmountWovenSubTotalYds,4).'</td>
					</tr>';
		}

   		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="4" align="left">Total</td>
						<td align="right"></td>
						<td></td>
						<td></td>
						<td align="right">'.number_format(($GrandtotalDznAmount),4).'</td>
						<td align="right">'.number_format(($GrandtotalAmount),4).'</td>
					</tr></table></div>';
		if($zero_value==1){
			echo $woven_fab;
		}
		else{
			if($row[csf("avg_cons")]>0){
				echo $woven_fab;
			}
			else{
				echo "";
			}
		}
		//end 	All Fabric Cost part report-------------------------------------------


  	//start	Conversion Cost to Fabric report here -------------------------------------------

	if($zero_value==1)
	{
	 ?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($ConvData)+3; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Total Cons</td>
                    <td width="100">Uom</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Total Amount (USD)</td>
                </tr>
            <?
            $TotalDznAmount =0;
			$TotalAmount =0;
            foreach( $ConvData as $index=>$row ){

			?>
                <tr>
                    <td align="left"><? echo $row['item_descrition']; ?></td>
                    <td align="left"><? echo $conversion_cost_head_array[$row["cons_process"]]; ?></td>
                    <td align="right"><? echo number_format($row["req_qnty"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_req_qnty"],4); ?></td>
                    <td align=""><? echo $unit_of_measurement[$row["uom"]]; ?></td>
                    <td align="right"><? echo number_format($row["charge_unit"],4); ?></td>
                    <td align="right"><? echo number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmount += $row["amount"];
				 $TotalAmount += $row["tot_amount"];

				 $GrandTotalFabricDznAmount+=$row["amount"];
				 $GrandTotalFabricAmount+=$row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td  align="left" colspan="6">Total</td>
                    <td align="right"><? echo $TotalDznAmount; ?></td>
                    <td align="right"><? echo $TotalAmount; ?></td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="6">Total Fabric Cost</td>
                    <td align="right"><? echo number_format($GrandTotalFabricDznAmount,4); ?></td>
                    <td align="right"><? echo number_format($GrandTotalFabricAmount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else{
		if($totConv>0){
	?>
     <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($ConvData)+3; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Total Cons</td>
                     <td width="100">Uom</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                     <td width="100">Total Amount (USD)</td>
                </tr>
            <?
           $TotalDznAmount =0;
		   $TotalAmount =0;
            foreach( $ConvData as $index=>$row){

			?>
                <tr>
                    <td align="left"><? echo $row['item_descrition']; ?></td>
                    <td align="left"><? echo $conversion_cost_head_array[$row["cons_process"]]; ?></td>
                    <td align="right"><? echo number_format($row["req_qnty"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_req_qnty"],4); ?></td>
                    <td align=""><? echo $unit_of_measurement[$row["uom"]]; ?></td>
                    <td align="right"><? echo number_format($row["charge_unit"],4); ?></td>
                    <td align="right"><? echo number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmount += $row["amount"];
				 $TotalAmount += $row["tot_amount"];

				 $GrandTotalFabricDznAmount+=$row["amount"];
				 $GrandTotalFabricAmount+=$row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="6">Total</td>
                    <td align="right"><? echo $TotalDznAmount; ?></td>
                    <td align="right"><? echo $TotalAmount; ?></td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="6">Total Fabric Cost</td>
                    <td align="right"><? echo number_format($GrandTotalFabricDznAmount,4); ?></td>
                    <td align="right"><? echo number_format($GrandTotalFabricAmount,4); ?></td>
                </tr>
            </table>
      </div>
    <?
		}
		else{
			echo "";
		}
	}
	//End Conversion Cost to Fabric report here -------------------------------------------



  	//start	Trims Cost part report here -------------------------------------------

	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="50">SL</td>
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="150">Remarks</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Tot. Cons</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                </tr>
            <?
            $TotalDznAmount=0;
			$TotalAmount=0;
			$i=1;
            foreach( $TrimData as $index=>$row )
            {
 				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row["trim_group"], "id", "item_name"  );

			?>
                <tr>
                    <td align="left"><? echo $i; ?></td>
                    <td align="left"><? echo $trim_group[$row["trim_group"]]; ?></td>
                    <td align="left"><? echo $row["description"]; ?></td>
                    <td align="left"><? echo $row["brand_sup_ref"]; ?></td>
                     <td align="left"><? echo $row["remark"]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row["cons_uom"]]; ?></td>
                    <td align="right"><? echo number_format($row["cons_dzn_gmts"],4); ?></td>
                     <td align="right"><? echo number_format($row["tot_cons"],4); ?></td>
                    <td align="right"><? echo number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmount += $row["amount"];
				 $TotalAmount += $row["tot_amount"];
				 $Totalcons += $row["tot_cons"];
				 $Totalrate += $row["rate"];
				 $i++;
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="7" align="left">Total</td>
                    <td align="right"><? echo number_format($Totalcons,4); ?></td>
                    <td align="right"><? echo number_format($Totalrate,4); ?></td>
                    <td align="right"><? echo number_format($TotalDznAmount,4); ?></td>
                    <td align="right"><? echo number_format($TotalAmount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($totTrim>0)
		{
	?>
    <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="50">SL</td>
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                     <td width="150">Remarks</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Tot. Cons</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                     <td width="100">Tot. Amount</td>
                </tr>
            <?
            $TotalDznAmount=0;
			$TotalAmount=0;
            foreach( $TrimData as $index=>$row)
            {
 				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row["trim_group"], "id", "item_name"  );

			?>
                <tr>
                	<td align="left"><? echo $i; ?></td>
                    <td align="left"><? echo $trim_group[$row["trim_group"]]; ?></td>
                    <td align="left"><? echo $row["description"]; ?></td>
                    <td align="left"><? echo $row["brand_sup_ref"]; ?></td>
                     <td align="left"><? echo $row["remark"]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row["cons_uom"]]; ?></td>
                    <td align="right"><? echo number_format($row["cons_dzn_gmts"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_cons"],4); ?></td>
                    <td align="right"><? echo number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmount += $row["amount"];
				 $TotalAmount += $row["tot_amount"];
				 $i++;
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="9" align="left">Total</td>
                    <td align="right"><? echo number_format($TotalDznAmount,4); ?></td>

                    <td align="right"><? echo number_format($TotalAmount,4); ?></td>
                </tr>
            </table>
      </div>
	<?
		}
		else
		{
		   echo "";
		}
	}
	 //End Trims Cost Part report here -------------------------------------------



	//start	Embellishment Details part report here -------------------------------------------

	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/<? echo $costing_for; ?></td>
                    <td width="150">Tot.Cons</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
            <?
            $TotalDznAmount=0;
		    $TotalAmount =0;
            foreach( $EmbData as $index=>$row )
            {
 				$em_type ="";
				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row["emb_name"]==1)$em_type = $emblishment_print_type[$row["emb_type"]];
				else if($row["emb_name"]==2)$em_type = $emblishment_embroy_type[$row["emb_type"]];
				else if($row["emb_name"]==3)$em_type = $emblishment_wash_type[$row["emb_type"]];
				else if($row["emb_name"]==4)$em_type = $emblishment_spwork_type[$row["emb_type"]];
				else if($row["emb_name"]==5)$em_type = $emblishment_gmts_type[$row["emb_type"]];
				else if($row["emb_name"]==99)$em_type = $emblishment_other_type_arr[$row["emb_type"]];


			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row["emb_name"]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo number_format($row["cons_dzn_gmts"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_cons"],4); ?></td>
                    <td align="right"><? echo number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmount += $row["amount"];
				 $TotalAmount += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="5" align="left">Total</td>
                    <td align="right"><? echo number_format($TotalDznAmount,4); ?></td>
                    <td align="right"><? echo number_format($TotalAmount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($totEmb>0)
		{
	?>
     <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/Dzn</td>
                    <td width="150">Tot.Cons</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
            <?
           $TotalDznAmount=0;
		   $TotalAmount =0;
            foreach( $EmbData as $index=>$row  )
            {
 				$em_type ="";
 				if($row["emb_name"]==1)$em_type = $emblishment_print_type[$row["emb_type"]];
				else if($row["emb_name"]==2)$em_type = $emblishment_embroy_type[$row["emb_type"]];
				else if($row["emb_name"]==3)$em_type = $emblishment_wash_type[$row["emb_type"]];
				else if($row["emb_name"]==4)$em_type = $emblishment_spwork_type[$row["emb_type"]];
				else if($row["emb_name"]==5)$em_type = $emblishment_gmts_type[$row["emb_type"]];
				else if($row["emb_name"]==99) $em_type = $emblishment_other_type_arr[$row["emb_type"]];


			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row["emb_name"]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo number_format($row["cons_dzn_gmts"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_cons"],4); ?></td>
                    <td align="right"><? echo number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAmount += $row["amount"];
				 $TotalAmount += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="5" align="left">Total</td>
                    <td align="right"><? echo number_format($TotalDznAmount,4); ?></td>
                    <td align="right"><? echo number_format($TotalAmount,4); ?></td>
                </tr>
            </table>
      </div>
    <?

		}
		else
		{
			echo "";
		}
	}
	 //End Embellishment Details Part report here -------------------------------------------


  	//start	Commercial Cost part report here -------------------------------------------

	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate In %</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot.Amount</td>
                 </tr>
            <?
           $TotalDznAount=0;
		   $TotalAount =0;
            foreach( $CommarData as $index=>$row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row["item_id"]]; ?></td>
                    <td align="right"><? echo number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAount += $row["amount"];
				 $TotalAount += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2" align="left">Total</td>
                    <td align="right"><? echo number_format($TotalDznAount,4); ?></td>
                    <td align="right"><? echo number_format($TotalAount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($totCommar>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot.Amount</td>
                 </tr>
            <?
           $TotalDznAount=0;
		   $TotalAount =0;
            foreach( $CommarData as $index=>$row  )
            {
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row["item_id"]]; ?></td>
                    <td align="right"><? echo number_format($row["rate"],4); ?></td>
                    <td align="right"><? echo number_format($row["amount"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAount += $row["amount"];
				 $TotalAount += $row["tot_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2" align="left">Total</td>
                     <td align="right"><? echo number_format($TotalDznAount,4); ?></td>
                    <td align="right"><? echo number_format($TotalAount,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
			echo "";
		}

	}
	 //End Commercial Cost Part report here -------------------------------------------


  	//start	Commission Cost part report here -------------------------------------------
 	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
            <?
            $TotalDznAount = 0;
		    $TotalAount = 0;
            foreach( $CommiData as $index=>$row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row["particulars_id"]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row["commission_base_id"]]; ?></td>
                    <td align="right"><? echo number_format($row["commision_rate"],4); ?></td>
                    <td align="right"><? echo number_format($row["commission_amount"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_commission_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAount += $row["commission_amount"];
				 $TotalAount += $row["tot_commission_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3" align="left">Total</td>
                    <td align="right"><? echo number_format($TotalDznAount,4); ?></td>
                    <td align="right"><? echo number_format($TotalAount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($totCommi>0)
		{
			$TotalDznAount = 0;
		    $TotalAount = 0;
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">Tot. Amount</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $CommiData as $index=>$row )
            {
  			?>
                <tr>
                   <td align="left"><? echo $commission_particulars[$row["particulars_id"]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row["commission_base_id"]]; ?></td>
                    <td align="right"><? echo number_format($row["commision_rate"],4); ?></td>
                    <td align="right"><? echo number_format($row["commission_amount"],4); ?></td>
                    <td align="right"><? echo number_format($row["tot_commission_amount"],4); ?></td>
                </tr>
            <?
                 $TotalDznAount += $row["commission_amount"];
				 $TotalAount += $row["tot_commission_amount"];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3" align="left">Total</td>
                    <td align="right"><? echo number_format($TotalDznAount,4); ?></td>
                    <td align="right"><? echo number_format($TotalAount,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
		   echo "";
		}

	}
	 //End Commission Cost Part report here -------------------------------------------


	?>
	<br>
	<br>
	<br>
	<br>
	<br>


  		  <?
     	 // image show here  -------------------------------------------
		$sqlData = "select id,master_tble_id,image_location
				from common_photo_library
				where master_tble_id=".$txt_job_no."";
		$data_array_img=sql_select($sqlData);
 	  ?>
          <div style=" margin-left:310px;margin-top:-70px; display: block;" >
          	<? foreach($data_array_img AS $inf){ ?>
                <img  src='<? echo $path.$inf[csf("image_location")]; ?>' border="1" height='97' width='89' />
            <?  } ?>
          </div>
    <br/><br/><br/> <br/>

 	<?
 	$lib_designation_arr=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");
	$user_lib_designation_arr=return_library_array("SELECT id,designation from user_passwd", "id", "designation");
	$user_lib_name_arr=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");

	$mst_id=return_field_value("id as mst_id","wo_pre_cost_mst","job_no=$txt_job_no","mst_id");
	//and b.un_approved_date is null
	//echo "select b.approved_by, min(b.approved_date) as approved_date from  approval_history b where b.mst_id=$mst_id and b.entry_form=15 group by  b.approved_by order by b.sequence_no asc";
	$approve_data_array=sql_select("select b.approved_by, min(b.approved_date) as approved_date from  approval_history b where b.mst_id=$mst_id and b.entry_form=46 group by  b.approved_by order by b.approved_by asc");
	$unapprove_data_array=sql_select("select b.approved_by, b.un_approved_by, b.approved_date, b.un_approved_reason, b.un_approved_date, b.approved_no from approval_history b where b.mst_id=$mst_id and b.entry_form=46 order by b.approved_date, b.approved_by");
	// echo "select b.approved_by,b.approved_date,b.un_approved_reason,b.un_approved_date,b.approved_no from   approval_history b where b.mst_id=$mst_id and b.entry_form=15  order by b.approved_no";
	if(count($approve_data_array)>0)
	{
		?>
		<table  width="850" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
                <tr style="border:1px solid black;">
                	<th colspan="5" style="border:1px solid black;">Approval Status</th>
                </tr>
                <tr style="border:1px solid black;">
                    <th width="3%" style="border:1px solid black;">Sl</th>
                    <th width="40%" style="border:1px solid black;">Name</th>
                    <th width="30%" style="border:1px solid black;">Designation</th>
                    <th width="27%" style="border:1px solid black;">Approval Date</th>
                </tr>
            </thead>
            <tbody>
            <?
            $i=1;
            foreach($approve_data_array as $row)
			{
				?>
				<tr style="border:1px solid black;">
				<td width="3%" style="border:1px solid black;"><? echo $i;?></td>
				<td width="40%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
				<td width="30%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
				<td width="27%" style="border:1px solid black;text-align:center"><? echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')]));?></td>
				</tr>
				<?
				$i++;
            }
            ?>
            </tbody>
		</table>
		<?
	}
	?>
    <br/>
	<?
	$sql_unapproved=sql_select("select booking_id,approval_cause from fabric_booking_approval_cause where entry_form=46 and approval_type=2 and is_deleted=0 and status_active=1 and booking_id=$mst_id");
	//echo "select booking_id,approval_cause from fabric_booking_approval_cause where  entry_form=15 and approval_type=2 and is_deleted=0 and status_active=1 and booking_id=$mst_id";
	$unapproved_request_arr=array();
	foreach($sql_unapproved as $rowu)
	{
		$unapproved_request_arr[$rowu[csf('booking_id')]]=$rowu[csf('approval_cause')];
	}

	if(count($unapprove_data_array)>0)
	{
		?>
		<table  width="850" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
                <tr style="border:1px solid black;">
                	<th colspan="6" style="border:1px solid black;">Approval/Un Approval History</th>
                </tr>
                <tr style="border:1px solid black;">
                    <th width="3%" style="border:1px solid black;">Sl</th>
                    <th width="30%" style="border:1px solid black;">Name</th>
                    <th width="20%" style="border:1px solid black;">Designation</th>
                    <th width="5%" style="border:1px solid black;">Approval Status</th>
                    <th width="20%" style="border:1px solid black;">Reason For Un Approval</th>
                    <th width="22%" style="border:1px solid black;"> Date</th>
                </tr>
            </thead>
            <tbody>
				<?
                $i=1;
                foreach($unapprove_data_array as $row)
				{
					?>
					<tr style="border:1px solid black;">
                        <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
                        <td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
                        <td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
                        <td width="5%" style="border:1px solid black; text-align:center"><? echo 'Yes';?></td>
                        <td width="20%" style="border:1px solid black;"><? echo '';?></td>
                        <td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); else echo "";?></td>
					</tr>
					<?
					$i++;
					$un_approved_date= explode(" ",$row[csf('un_approved_date')]);
					$un_approved_date=$un_approved_date[0];
					if($db_type==0) //Mysql
					{
						if($un_approved_date=="" || $un_approved_date=="0000-00-00") $un_approved_date="";else $un_approved_date=$un_approved_date;
					}
					else
					{
						if($un_approved_date=="") $un_approved_date="";else $un_approved_date=$un_approved_date;
					}

					if($un_approved_date!="")
					{
						if($row[csf('un_approved_by')]!=0) $row[csf('approved_by')]=$row[csf('un_approved_by')];
						?>
						<tr style="border:1px solid black;">
                            <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
                            <td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
                            <td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
                            <td width="5%" style="border:1px solid black;text-align:center;"><? echo 'No';?></td>
                            <td width="20%" style="border:1px solid black;text-align:center"><? echo $unapproved_request_arr[$mst_id];?></td>
                            <td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('un_approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('un_approved_date')])); else echo "";?></td>
						</tr>

						<?
						$i++;
					}
                }
                ?>
            </tbody>
		</table>
		<?
	}
	echo signature_table(218, $cbo_company_name, "860px");
	exit();
}

if($action == "bom_pcs_woven3") //BOM PCS3 Btn 22
{
   	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if($txt_job_no==""){
		$job_no='';
	}else{
		$job_no=" and a.job_no=".$txt_job_no."";
	}

	if($cbo_company_name=="") {
		$company_name='';
	} else {
		 $company_name=" and a.company_name=".$cbo_company_name."";
	}

	if($cbo_buyer_name==""){
		 $cbo_buyer_name='';
	} else {
		$cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	}

	if($txt_style_ref==""){
		 $txt_style_ref='';
	} else {
		$txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	}

	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($db_type==0){
	   $costing_date=change_date_format($txt_costing_date, "yyyy-mm-dd", "-");
	}
	if($db_type==2){
		$costing_date=change_date_format($txt_costing_date, "yyyy-mm-dd", "-",1)	;
	}
	$txt_po_breack_down_id=str_replace("'",'',$txt_po_breack_down_id);
	if(str_replace("'",'',$txt_po_breack_down_id)==""){
		$txt_po_breack_down_id_cond='';
	}
	else{
		$txt_po_breack_down_id_cond=" and d.id in(".$txt_po_breack_down_id.")";
	}
    //if($txt_quotation_date=="") $txt_quotation_date=''; else $txt_quotation_date=" and a.quot_date ='".$txt_quotation_date."'";
	$imge_arr=return_library_array( "select master_tble_id,image_location from common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	

    $buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$season_name_arr=return_library_array( "select id, season_name from lib_buyer_season",'id','season_name');
	$color_library=return_library_array("select id,color_name from lib_color where status_active=1 and is_deleted=0","id","color_name");
	$brand_arr=return_library_array( "select id, brand_name from lib_buyer_brand where status_active=1 and is_deleted=0",'id','brand_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$merchantArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$group_gsm="listagg(b.gsm_weight ,',') within group (order by b.gsm_weight) AS gsm_weight";
	$gsm_weight_top=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and a.body_part_type=1","gsm_weight");
	$gsm_weight_bottom=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and a.body_part_type=20 ","gsm_weight");

	 $po_qty=0;
	 $po_plun_cut_qty=0;
	 $total_set_qnty=0;
	 $sql_po="select a.job_no,a.total_set_qnty,b.id,c.item_number_id,c.country_id,c.color_number_id,c.size_number_id,c.order_quantity ,c.plan_cut_qnty,a.brand_id  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst   and b.id=c.po_break_down_id  and a.job_no =".$txt_job_no." $poId_cond2  and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 order by b.id";
	$sql_po_data=sql_select($sql_po);
	foreach($sql_po_data as $sql_po_row){
		$po_qty+=$sql_po_row[csf('order_quantity')];
		$po_plun_cut_qty+=$sql_po_row[csf('plan_cut_qnty')];
		$total_set_qnty=$sql_po_row[csf('total_set_qnty')];
		$po_id_arr[$sql_po_row[csf('id')]]=$sql_po_row[csf('id')];
	}
	$po_id_str= implode( ",",$po_id_arr);
	
	$sales_contract_sql=sql_select("SELECT a.contract_no,b.wo_po_break_down_id from com_sales_contract a join com_sales_contract_order_info b on a.id=b.com_sales_contract_id where a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.wo_po_break_down_id in ($po_id_str) group by a.contract_no, b.wo_po_break_down_id");
	$sales_contract_arr=array();
	if(count($sales_contract_sql)>0)
	{
		foreach ($sales_contract_sql as $key => $row) {
			$sales_contract_arr[$row[csf('contract_no')]]=$row[csf('contract_no')];
		}
	}

	$export_lc_sql=sql_select("SELECT a.export_lc_no,b.wo_po_break_down_id from com_export_lc a join com_export_lc_order_info b on a.id=b.com_export_lc_id where a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.wo_po_break_down_id in ($po_id_str) group by a.export_lc_no,b.wo_po_break_down_id");
	$export_lc_arr=array();
	if(count($export_lc_sql)>0)
	{
		foreach ($export_lc_sql as $key => $row) {
			$export_lc_arr[$row[csf('wo_po_break_down_id')]]=$row[csf('export_lc_no')];
		}
	}
	$sc_lc_no="";
	if(count($sales_contract_arr)>0)
	{
		$sc_lc_no=implode(",", $sales_contract_arr);
	}
	if(count($export_lc_arr)>0)
	{
		$sc_lc_no=implode(",", $export_lc_arr);
	}

	//echo $po_qty;

	$gmtsitem_ratio_array=array();
	$gmtsitem_ratio_sql=sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no =".$txt_job_no."");// where job_no ='FAL-14-01157'
	foreach($gmtsitem_ratio_sql as $gmtsitem_ratio_sql_row){
	$gmtsitem_ratio_array[$gmtsitem_ratio_sql_row[csf('job_no')]][$gmtsitem_ratio_sql_row[csf('gmts_item_id')]]=$gmtsitem_ratio_sql_row[csf('set_item_ratio')];
	}
	$costing_per_arr=return_library_array( "select job_no,costing_per from wo_pre_cost_mst where job_no =".$txt_job_no."", "job_no", "costing_per");// where job_no ='FAL-14-01157'

	if($db_type==0){
		$sqlcpm=sql_select("select cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and '$costing_date' between applying_period_date and applying_period_to_date  and status_active=1 and is_deleted=0 LIMIT 1");
	}
	if($db_type==2){
		 $sqlcpm=sql_select("select cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and '$costing_date' between applying_period_date and applying_period_to_date and status_active=1 and is_deleted=0");

	}

	$cpm='';
	foreach($sqlcpm as $sqlcpmrow){
		$cpm=$sqlcpmrow[csf('cost_per_minute')];
	}

	$fab_knit_req_kg_avg=0;
	$fab_woven_req_yds_avg=0;
	$sql = "SELECT a.job_no, a.company_name, a.buyer_name,a.style_description,a.product_dept,a.season_buyer_wise,a.season_year, a.style_ref_no,a.brand_id, a.quotation_id, a.gmts_item_id,a.body_wash_color, a.order_uom, a.job_quantity, a.avg_unit_price,a.dealing_marchant, b.costing_per, b.budget_minute,b.costing_date, b.sew_smv, b.cut_smv, b.sew_effi_percent, b.cut_effi_percent, b.approved, d.margin_pcs_set, c.fab_knit_req_kg, c.fab_knit_fin_req_kg, c.fab_woven_req_yds, c.fab_woven_fin_req_yds, c.fab_yarn_req_kg, d.margin_pcs_bom,d.cm_cost, d.cost_pcs_set,b.exchange_rate,d.wash_cost,d.embel_cost,d.fabric_cost_percent,d.trims_cost_percent,d.wash_cost_percent,d.embel_cost_percent,d.fabric_cost, d.trims_cost, d.embel_cost, d.wash_cost, d.comm_cost, d.commission, d.lab_test,d.inspection, d.cm_cost, d.freight,d.currier_pre_cost, d.certificate_pre_cost,d.common_oh, d.total_cost, d.interest_cost, d.incometax_cost, d.incometax_percent, d.deffdlc_cost, d.deffdlc_percent from wo_po_details_master a join wo_pre_cost_mst b on a.id=b.job_id join wo_pre_cost_dtls d on a.id=d.job_id left join wo_pre_cost_sum_dtls c on a.id=c.job_id and c.status_active=1 and c.is_deleted=0 where b.status_active=1 and b.is_deleted=0  and a.status_active=1 and b.status_active=1 and b.is_deleted=0 $job_no $company_name $cbo_buyer_name $txt_style_ref order by a.job_no";
	//echo __LINE__.$sql; die; 
	$data_array=sql_select($sql);
	foreach( $data_array as $row )
	{
		$cm_cost_dzn =$row[csf("cm_cost")];
		$other_cost=$row[csf("fabric_cost")]+$row[csf("embel_cost")]+$row[csf("embel_cost")]+$row[csf("wash_cost")]+$row[csf("comm_cost")]+$row[csf("commission")]+$row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("freight")]+$row[csf("currier_pre_cost")]+$row[csf("certificate_pre_cost")]+$row[csf("common_oh")]+$row[csf("interest_cost")];

		$exchange_rate =$row[csf("exchange_rate")];
		$approved_id=$row[csf("approved")];
		$dealing_marchant=$row[csf("dealing_marchant")];
		$wash_cost =$row[csf("job_quantity")]*$row[csf("wash_cost")];
		$embl_cost =$row[csf("job_quantity")]*$row[csf("embel_cost")];

		$fabric_cost_percent =$row[csf("fabric_cost_percent")];
		$trims_cost_percent =$row[csf("trims_cost_percent")];
		$wash_cost_percent =$row[csf("wash_cost_percent")];
		$embel_cost_percent =$row[csf("embel_cost_percent")];
		
	}	
	
	$condition= new condition();
	if(str_replace("'","",$txt_job_no) !=''){
		$condition->job_no("=$txt_job_no");
	}
	$txt_po_breack_down_id=str_replace("'",'',$txt_po_breack_down_id);
	if(str_replace("'",'',$txt_po_breack_down_id) !=""){
		$condition->po_id("in($txt_po_breack_down_id)");
	}

	$condition->init();
	$fabric= new fabric($condition);
	$trim= new trims($condition);
	$emblishment= new emblishment($condition);
	$wash= new wash($condition);


	//Fabric =====================
	$fabric_qty=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$fabric_amount=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$sql_fabric = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description,uom, avg_cons,avg_cons_yarn, fabric_source,gsm_weight, rate, amount, avg_finish_cons, status_active from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_arr_fabric=sql_select($sql_fabric);
	$summary_data=array();
	foreach($data_arr_fabric as $fab_row)
	{
		$summary_data[fabric_cost][$fab_row[csf("id")]]=$fab_row[csf("amount")];
		$summary_data[fabric_cost_job]+=$fabric_amount['knit']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		$summary_data[fabric_cost_job]+=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
	}
	
	//start	Trims Cost part report here -------------------------------------------
		$sql_trim = "select id, job_no, trim_group,description,brand_sup_ref,remark, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,status_active,seq from wo_pre_cost_trim_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 order by seq";
		$data_array_trim=sql_select($sql_trim);
		$trim_amount_arr=$trim->getAmountArray_precostdtlsid();
		$trim_qty_arr=$trim->getQtyArray_by_precostdtlsid();
		$totTrim=0;
		$TrimData=array();
		foreach( $data_array_trim as $row_trim )
		{
			$trim_qty=$trim_qty_arr[$row_trim[csf("id")]];
			$trim_amount=$trim_amount_arr[$row_trim[csf("id")]];
			$summary_data[trims_cost_job]+=$trim_amount;
		}

	//Fabric End======================

	//emb start
	$emb_sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name in(1,2,4,5,99) and status_active=1 and is_deleted=0";
	$emb_data_array=sql_select($emb_sql);
	$emb_amount=$emblishment->getAmountArray_by_jobAndEmblishmentid();
	foreach( $emb_data_array as $row ){
	$embtotamount=$emb_amount[$row[csf("job_no")]][$row[csf("id")]];
	$summary_data[emb_cost_job]+=$embtotamount;
	}
	//emb end

	//Wash cost 
	$wash_sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name =3 and status_active=1 and is_deleted=0";
	$wash_data_array=sql_select($wash_sql);
	$wash_amt=$wash->getAmountArray_by_jobAndEmblishmentid();
	foreach( $wash_data_array as $row ){
	$washamt=$wash_amt[$row[csf("job_no")]][$row[csf("id")]];
	$summary_data[wash_cost_job]+=$washamt;
	}
	//End Wash cost Cost part report here -------------------------------------------
	 
	 
	$uom=""; $sew_smv=0; $cut_smv=0; $sew_effi_percent=0; $cut_effi_percent=0;
	foreach ($data_array as $row){
		$order_price_per_dzn=0;
		$order_job_qnty=0;
		$avg_unit_price=0;
		$sew_smv=$row[csf("sew_smv")];
	    $cut_smv=$row[csf("cut_smv")];
	    $sew_effi_percent=$row[csf("sew_effi_percent")];
	    $cut_effi_percent=$row[csf("cut_effi_percent")];
		$order_values = $row[csf("job_quantity")]*$row[csf("avg_unit_price")];
		$result =sql_select("select po_number,grouping,file_no,pub_shipment_date from wo_po_break_down where job_no_mst=$txt_job_no $poId_cond and status_active=1 and is_deleted=0 order by pub_shipment_date DESC");
		$job_in_orders = '';$pulich_ship_date='';$job_in_file = '';$job_in_ref = '';
		foreach ($result as $val){
			$job_in_orders .= $val[csf('po_number')].", ";
			$pulich_ship_date = $val[csf('pub_shipment_date')];
			$job_in_file .= $val[csf('file_no')].",";
			$job_in_ref .= $val[csf('grouping')].",";
		}
		$job_in_orders = substr(trim($job_in_orders),0,-1);
		$job_ref=array_unique(explode(",",rtrim($job_in_ref,", ")));
		$job_file=array_unique(explode(",",rtrim($job_in_file,", ")));

		foreach ($job_ref as $ref){
			$ref_cond.=", ".$ref;
		}
		$file_con='';
		foreach ($job_file as $file){
			if($file_con=='') $file_cond=$file; else $file_cond.=", ".$file;
		}

		
		$path =str_replace("'","",$path);
		$path =($path)?$path:"../../";
		
		
		?>
		<?
			if($row[csf("costing_per")]==1){
				$order_price_per_dzn=12;
				$costing_for=" DZN";
			}
			else if($row[csf("costing_per")]==2){
				$order_price_per_dzn=1;
				$costing_for=" PCS";
			}
			else if($row[csf("costing_per")]==3){
				$order_price_per_dzn=24;
				$costing_for=" 2 DZN";
			}
			else if($row[csf("costing_per")]==4){
				$order_price_per_dzn=36;
				$costing_for=" 3 DZN";
			}
			else if($row[csf("costing_per")]==5){
				$order_price_per_dzn=48;
				$costing_for=" 4 DZN";
			}
			$order_job_qnty=$row[csf("job_quantity")];
			$avg_unit_price=$row[csf("avg_unit_price")];

		}//end first foearch

		ob_start();
 		?>
            	
                <table style="width:850px" ><tr><td colspan="6" align="center">
                   <?
				   	$image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id='".str_replace("'","",$cbo_company_name)."'","image_location");
					?>
                    <img  src='<?=$path.$image_location; ?>' height='70' align="left" />
                    <b style="font-size:25px;"><?=$comp[str_replace("'","",$cbo_company_name)]; ?></b><br>
                    <b style="font-size:14px;">Pre- Costing</b>
                </td></tr></table>
				<table class="rpt_table" cellpadding="1" cellspacing="1" style="width:1170px" rules="all">
				<tr>
				<td>
                <table class="rpt_table" align='left 'border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
				<tr>
						<td width="140">Buyer</td>
                        <td width="140"><b><? echo $buyer_arr[$row[csf("buyer_name")]]; if($row[csf("brand_id")]>0)
								{
									echo '('.$brand_arr[$row[csf("brand_id")]].')';
								}?></b></td>
						<td width="140"><b>Header </b></td>
						<td width="140"><b>Pre Cost</b> </td>
						<td width="140"> Costing Date</td>
                        <td width="150"><b><? echo change_date_format($row[csf("costing_date")],4); ?></b></td>
						<td style="border-bottom:hidden;border-right:hidden;"></td>
				</tr>
				<tr>
						<td>Style Ref. No </td>
                        <td><b><? echo $row[csf("style_ref_no")]; ?></b></td>
						<td>Costing Per</td>
                        <td><b><? echo $costing_per[$row[csf("costing_per")]];?></b></td>
						<td>CPM</td>
                        <td  align="right" title="CPM=<?=$cpm?>"><b><? echo  number_format($cpm,4);; ?></b></td>
						<td style="border-bottom:hidden;border-right:hidden;"></td>
				</tr>
				<tr>
                    	<td>Item</td>
                        <?
							$grmnt_items = "";
							if($garments_item[$row[csf("gmts_item_id")]]=="")
							{

								$grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no=$txt_job_no");
								foreach($grmts_sql as $key=>$val){
									$grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].", ";
								}
								$grmnt_items = substr_replace($grmnt_items,"",-1,1);
							}else{
								$grmnt_items = $garments_item[$row[csf("gmts_item_id")]];
							}
						?>
                        <td><b><? echo $grmnt_items; ?></b></td>
                    	<td>Po Qnty</td>
                        <td  align="right"><b><? $uom=$row[csf("order_uom")]; echo $row[csf("job_quantity")]." ". $unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
						<td>SPM</td>
						<? $spm=$cm_cost_dzn/$order_price_per_dzn/$sew_smv ?>
                        <td  align="right" title="<? echo $cm_cost_dzn."/".$order_price_per_dzn."/".$sew_smv;?>"><b><? echo number_format($spm,4); ?></b></td>
						<td style="border-bottom:hidden;border-right:hidden;"></td>
                    </tr>
					<tr>
						<td>Style Description</td>
                        <td><b><? echo $row[csf("style_description")]; ?></b></td>
						<td>Mark. Sew. Effic.</td>
                        <td  align="right"><b><? echo $sew_effi_percent; ?></b></td>
						<td>CM</td>
                        <td  align="right"><b><? echo number_format($cm_cost_dzn,4); ?></b></td>
						<td style="border-bottom:hidden;border-right:hidden;"></td>
					</tr>
                	<tr>
						<td>Season</td>
                        <td><b><? echo $season_name_arr[$row[csf('season_buyer_wise')]].'-'.substr( $row[csf('season_year')], -2);  ?></b></td>
						<td>SMV</td>
                        <td  align="right"><b><? echo $sew_smv; ?></b></td>
						<td>CM% on FOB</td>
                        <td  align="right" title="CM/FOB Value*100"><b><? echo number_format(($cm_cost_dzn/$row[csf("avg_unit_price")])*100,4); ?>%</b></td>
						<td style="border-bottom:hidden;border-right:hidden;"></td>
					</tr>
					<tr>
						<td>Department</td>
                        <td><b><? echo $product_dept[$row[csf("product_dept")]];?></b></td>
						<td>FOB Value</td>
                        <td  align="right"><b><? echo $row[csf("avg_unit_price")]; ?></b></td>
						<td>Profit% on FOB</td>					
						<?
							$profit_per_fob=((number_format($spm,4)-number_format($cpm,4))*$sew_smv/$row[csf("avg_unit_price")])*100;
						?>
                        <td  align="right" title="((SPM-CPM)*SMV/FOB)*100"><b><? echo number_format($profit_per_fob,4); ?>%</b></td>
						<td style="border-bottom:hidden;border-right:hidden;"></td>
					</tr>
					<tr>
						<td>Germents Color</td>
                        <td><b><? echo $color_library[$row[csf("body_wash_color")]];?></b></td>
						<td>Net FOB</td>
                        <td  align="right" title="<? echo $row[csf("avg_unit_price")]."-".$row[csf("commission")];?>"><b><? echo number_format(($row[csf("avg_unit_price")]-$row[csf("commission")]),4); ?></b></td>
						<td>Net Profit</td>
                        <td  align="right"><b><? echo number_format($row[csf('margin_pcs_set')],4); ?></b></td>
						<td style="border-bottom:hidden;border-right:hidden;"></td>
					</tr>
					
                </table>
				</td>
				<td style="border:hidden;">
                        <?
                        $nameArray_imge =sql_select("SELECT image_location,real_file_name FROM common_photo_library where master_tble_id=".$txt_job_no." and file_type=1");
						?>
                <table width="210" align='right'>
                <tr>
                <?
				 
				$img_counter = 0;
                foreach($nameArray_imge as $result_imge)
				{
				     

					?>
					<td>
						<!--<img src="../../<? //echo $result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />-->
                        <img src="<? echo $path .''. $result_imge[csf('image_location')]; ?>" width="192" height="192" border="2" />
                       <?
					  
					   ?>
					</td>
					<?

					$img_counter++;
				}
				?>
               	 </tr>
           		</table>
                        </td>
						</tr>
						</table>
					
	<br>
	<?
	if($costing_per==1) { $order_price_per_dzn=12; $costing_for=" DZN"; }
	else if($costing_per==2) { $order_price_per_dzn=1; $costing_for=" PCS"; }
	else if($costing_per==3) { $order_price_per_dzn=24;$costing_for=" 2 DZN"; }
	else if($costing_per==4) { $order_price_per_dzn=36;$costing_for=" 3 DZN"; }
	else if($costing_per==5) { $order_price_per_dzn=48;$costing_for=" 4 DZN"; }

	$dtlssql = "select fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent, wash_cost, wash_cost_percent, comm_cost, comm_cost_percent, commission, commission_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, freight, freight_percent, currier_pre_cost, currier_percent, certificate_pre_cost, certificate_percent, common_oh, common_oh_percent, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set, margin_pcs_set_percent, cm_for_sipment_sche, interest_cost, interest_percent, incometax_cost, incometax_percent, deffdlc_cost, deffdlc_percent, margin_pcs_bom, margin_bom_per from wo_pre_cost_dtls where job_no=$txt_job_no and status_active=1 and is_deleted=0";
	$dtlssql_res=sql_select($dtlssql);

	$fabric_cost=$trims_cost=$embel_cost=$wash_cost=$comm_cost=$commission=$lab_test=$inspection=$cm_cost=$freight=$currier_pre_cost=$certificate_pre_cost=$common_oh=$total_cost=$price_dzn=$margin_dzn=$price_pcs_or_set=$margin_pcs_set=$cm_for_sipment_sche=$interest_cost=$incometax_cost=$deffdlc_cost=0;

	$fabric_cost_percent=$trims_cost_percent=$embel_cost_percent=$embel_cost_percent=$wash_cost_percent=$comm_cost_percent=$commission_percent=$lab_test_percent=$inspection_percent=$cm_cost_percent=$freight_percent=$currier_percent=$certificate_percent=$common_oh_percent=$total_cost_percent=$price_dzn_percent=$margin_dzn_percent=$price_pcs_or_set=$price_pcs_or_set_percent=$margin_pcs_set_percent=$interest_percent=$incometax_percent=$deffdlc_percent=$margin_pcs_bom=$margin_bom_per=0;

	$fabric_cost=$dtlssql_res[0][csf('fabric_cost')];
	$fabric_cost_percent=$dtlssql_res[0][csf('fabric_cost_percent')];
	$trims_cost=$dtlssql_res[0][csf('trims_cost')];
	$trims_cost_percent=$dtlssql_res[0][csf('trims_cost_percent')];
	$embel_cost=$dtlssql_res[0][csf('embel_cost')];

	$embel_cost_percent=$dtlssql_res[0][csf('embel_cost_percent')];
	$wash_cost=$dtlssql_res[0][csf('wash_cost')];
	$wash_cost_percent=$dtlssql_res[0][csf('wash_cost_percent')];
	$comm_cost=$dtlssql_res[0][csf('comm_cost')];
	$comm_cost_percent=$dtlssql_res[0][csf('comm_cost_percent')];
	$commission=$dtlssql_res[0][csf('commission')];
	$commission_percent=$dtlssql_res[0][csf('commission_percent')];
	$lab_test=$dtlssql_res[0][csf('lab_test')];
	$lab_test_percent=$dtlssql_res[0][csf('lab_test_percent')];
	$inspection=$dtlssql_res[0][csf('inspection')];
	$inspection_percent=$dtlssql_res[0][csf('inspection_percent')];
	$cm_cost=$dtlssql_res[0][csf('cm_cost')];
	$cm_cost_percent=$dtlssql_res[0][csf('cm_cost_percent')];
	$freight=$dtlssql_res[0][csf('freight')];
	$freight_percent=$dtlssql_res[0][csf('freight_percent')];
	$currier_pre_cost=$dtlssql_res[0][csf('currier_pre_cost')];
	$currier_percent=$dtlssql_res[0][csf('currier_percent')];
	$certificate_pre_cost=$dtlssql_res[0][csf('certificate_pre_cost')];
	$certificate_percent=$dtlssql_res[0][csf('certificate_percent')];
	$common_oh=$dtlssql_res[0][csf('common_oh')];
	$common_oh_percent=$dtlssql_res[0][csf('common_oh_percent')];

	$total_cost=$dtlssql_res[0][csf('total_cost')];
	$total_cost_percent=$dtlssql_res[0][csf('total_cost_percent')];
	$price_dzn=$dtlssql_res[0][csf('price_dzn')];
	$price_dzn_percent=$dtlssql_res[0][csf('price_dzn_percent')];
	$margin_dzn=$dtlssql_res[0][csf('margin_dzn')];
	$margin_dzn_percent=$dtlssql_res[0][csf('margin_dzn_percent')];
	$price_pcs_or_set=$dtlssql_res[0][csf('price_pcs_or_set')];
	$price_pcs_or_set_percent=$dtlssql_res[0][csf('price_pcs_or_set_percent')];
	$margin_pcs_set=$dtlssql_res[0][csf('margin_pcs_set')];
	$margin_pcs_set_percent=$dtlssql_res[0][csf('margin_pcs_set_percent')];
	$cm_for_sipment_sche=$dtlssql_res[0][csf('cm_for_sipment_sche')];
	$interest_cost=$dtlssql_res[0][csf('interest_cost')];
	$interest_percent=$dtlssql_res[0][csf('interest_percent')];
	$incometax_cost=$dtlssql_res[0][csf('incometax_cost')];
	$incometax_percent=$dtlssql_res[0][csf('incometax_percent')];
	$deffdlc_cost=$dtlssql_res[0][csf('deffdlc_cost')];
	$deffdlc_percent=$dtlssql_res[0][csf('deffdlc_percent')];
	
	$margin_pcs_bom=$dtlssql_res[0][csf('margin_pcs_bom')];
	$margin_bom_per=$dtlssql_res[0][csf('margin_bom_per')];
	unset($dtlssql_res);
	$others_cost_value=0; $costOfFabriTrimsEmbWash=0;
	$others_cost_value=$total_cost-$cm_cost-$freight-$comm_cost-$commission;
	$costOfFabriTrimsEmbWash=($fabric_cost+$trims_cost+$embel_cost+$wash_cost);
	
	//echo $margin_pcs_bom.'='.$margin_bom_per;
	$sl=1;
	?>
        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;" rules="all">
            <tr style="font-weight:bold">

                <td  align="center" width="50%">Costing Group</td>
                <td  align="center" width="50%">Costing Summary</td>
            </tr>
            <? if($zero_value==1) { ?>
                <tr>
                    <td align="center">FOB</td>
                    <td align="center"><? echo fn_number_format($avg_unit_price,4); ?></td>
                </tr>
                <tr>
                    <td align="center">Commission</td>
                    <td align="center"><? echo fn_number_format($commission,4); ?></td>
                </tr>
                <tr>
                    <td align="center">Net FOB</td>
                    <td align="center"><? $net_fob_value=$avg_unit_price-$commission; echo fn_number_format($net_fob_value,4); ?></td>
                </tr>
                <tr>
                    <td align="center">Fabric</td>
                    <td align="center"><? echo fn_number_format($fabric_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="center">Accessories</td>
                    <td align="center"><? echo fn_number_format($trims_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="center">Embellishment</td>
                    <td align="center"><? echo fn_number_format($embel_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="center">Gmts Wash</td>
                    <td align="center"><? echo fn_number_format($wash_cost,4); ?></td>
                </tr>
				<tr>
                    <td align="center">Other Charge</td>
                    <td align="center"><? $other=$comm_cost+$lab_test+$inspection+$freight+$currier_pre_cost+$certificate_pre_cost+$deffdlc_cost+$incometax_cost+$interest_cost;?><? echo fn_number_format($other,4); ?></td>
                </tr>
                <tr>
                    <td align="center">CM</td>
					<td align="center"><? $cm_value_contribution_margine=$net_fob_value-$other; echo fn_number_format($cm_cost,4); ?></td>
                   
                </tr>
                <tr>
                    <td align="center">Profit</td>
                    <td align="center"><? echo fn_number_format($margin_pcs_set,4); ?></td>
                </tr>
               
               
            <? } else { ?>
                <tr>
					<td align="center">FOB</td>
                    <td align="center"><? echo fn_number_format($avg_unit_price,4); ?></td>
                </tr>
                <tr>
					<td align="center">Commision</td>
                    <td align="center"><? echo fn_number_format($commission,4); ?></td>
                </tr>
                <tr>
					<td align="center">Net FOB</td>
                    <td align="center"><? $net_fob_value=$avg_unit_price-$commission; echo fn_number_format($net_fob_value,4); ?></td>
                </tr>
                <?
                if($fabric_cost!=0)
                {
					?>
					<tr>
						<td align="center">Fabric</td>
                   	 	<td align="center"><? echo fn_number_format($fabric_cost,4); ?></td>
					</tr>
					<?
                }
                if($trims_cost!=0)
                {
					?>
					<tr>
						<td align="center">Accesories</td>
                    	<td align="center"><? echo fn_number_format($trims_cost,4); ?></td>
					</tr>
					<?
                }
                if($embel_cost!=0)
                {
					?>
					<tr>
						<td align="center">Embellishment</td>
                    	<td align="center"><? echo fn_number_format($embel_cost,4); ?></td>
					</tr>
					<?
                }
                if($wash_cost!=0)
                {
					?>
					<tr>
						<td align="center">Gmts Wash</td>
                    	<td align="center"><? echo fn_number_format($wash_cost,4); ?></td>
					</tr>
					<?
                }?>
				<td align="center">Other Charge</td>
				<td align="center"><? $other=$comm_cost+$lab_test+$inspection+$freight+$currier_pre_cost+$certificate_pre_cost+$deffdlc_cost+$incometax_cost+$interest_cost;?><? echo fn_number_format($other,4); ?></td>
			</tr>
			<tr>
				<td align="center">CM</td>
				<td align="center"><? $cm_value_contribution_margine=$net_fob_value-$other; echo fn_number_format($cm_cost,4); ?></td>
			   
			</tr>
			<tr>
				<td align="center">Profit</td>
				<td align="center"><? echo fn_number_format($margin_pcs_bom,4); ?></td>
			</tr>
               
               
             
               
                <?
				}
				?>
            </table>
	<br>
	<?
	$condition= new condition();
	if(str_replace("'","",$txt_job_no) !=''){
		$condition->job_no("=$txt_job_no");
	}
	if(str_replace("'",'',$txt_po_breack_down_id) !="")
	{
		$condition->po_id("in($txt_po_breack_down_id)");
	}
	$condition->init();
	$fabric= new fabric($condition);
	$trim= new trims($condition);
	$wash= new wash($condition);
	$emblishment= new emblishment($condition);
	//echo $fabric->getQuery();die;
	$fabric_qty_arr=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	//print_r($fabric_qty_arr);
	$fabric_amount_arr=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	
	$trim_amount_arr=$trim->getAmountArray_precostdtlsid();
	$trim_qty_arr=$trim->getQtyArray_by_precostdtlsid();
	
	$emblishment_qtyArr=$emblishment->getQtyArray_by_jobAndEmblishmentid();
	$emblishment_amountArr=$emblishment->getAmountArray_by_jobAndEmblishmentid();
	$wash_qtyArr=$wash->getQtyArray_by_jobAndEmblishmentid();
	//	print_r($wash_qtyArr);
	$wash_amountArr=$wash->getAmountArray_by_jobAndEmblishmentid();
	   
	$sql_determin=sql_select("select a.id,a.type from lib_yarn_count_determina_mst a where  a.status_active=1  and a.entry_form=426");
	foreach($sql_determin as $row)
	{
		$determin_type_arr[$row[csf('id')]]=$row[csf('type')];	
	}
	
	
	// $pri_fab_arr="select a.quotation_id,b.fabric_source,b.lib_yarn_count_deter_id as deter_min_id,b.fabric_description as fab_desc,b.fabric_description,b.body_part_id,b.gsm_weight,b.uom, a.rate,a.amount, (a.requirment) as requirment,a.cons, (a.pcs) as pcs,a.process_loss_percent as p_loss from wo_pri_quo_fab_co_avg_con_dtls a,wo_pri_quo_fabric_cost_dtls  b where a.wo_pri_quo_fab_co_dtls_id=b.id and a.quotation_id=b.quotation_id  and b.status_active=1 and b.is_deleted=0 and a.quotation_id=$quot_id ";//and b.fabric_source=2
	//$pri_fab_result=sql_select($pri_fab_arr);
	
	  $pre_fab_arr="select  b.id, b.job_no,b.body_part_id,b.lib_yarn_count_deter_id as deter_min_id, b.fab_nature_id, b.color_type_id, b.fabric_description as fab_desc,b.uom,b.avg_cons,b.avg_cons_yarn, b.avg_process_loss,b.construction,b.composition,b.fabric_source,b.gsm_weight, b.rate,b.amount,b.avg_finish_cons,b.sourcing_rate,b.sourcing_nominated_supp from wo_pre_cost_fabric_cost_dtls  b where  b.status_active=1 and b.is_deleted=0 and b.job_no=$txt_job_no order by b.id ";//and b.fabric_source=2
	  //echo $pre_fab_arr; die;
	$pre_fab_result=sql_select($pre_fab_arr);
	
	$summ_fob_pcs=0;$summ_fob_gross_value_amt=$summ_sourcing_tot_budget_dzn_val=0;
	foreach($pre_fab_result as $row)
	{
		$determin_type=$determin_type_arr[$row[csf('deter_min_id')]];
		$body_partId=$body_part[$row[csf('body_part_id')]];
		//$fab_desc=$body_partId.','.$row[csf('fab_desc')];
		$fab_desc=$row[csf('fab_desc')];
		//echo $determin_type.'d';
		$tot_amt=$row[csf('avg_cons')]*$row[csf('rate')];
		$fab_req_qty=$fabric_qty_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]]+$fabric_qty_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
		$fab_req_amount=$fabric_amount_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]]+$fabric_amount_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
		$fab_cost_dtls_id=$row[csf('id')];
		$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['req_qty']+=$fab_req_qty;
		$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['req_amount']+=$fab_req_amount;
		$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['cons']+=$row[csf('avg_finish_cons')];
		$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['tot_cons']+=$row[csf('avg_cons')];
		$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['amount']+=$row[csf('amount')];
		$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['p_loss']=$row[csf('avg_process_loss')];
		$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['sourcing_nominated_supp']=$row[csf('sourcing_nominated_supp')];
		$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['sourcing_rate']=$row[csf('sourcing_rate')];
		$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['fab_desc']=$row[csf('construction')].','.$row[csf('composition')];
		$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['uom']=$unit_of_measurement[$row[csf('uom')]];
		$p_fab_precost_tot_row+=1;	
		//Summary
		$summ_fob_pcs+=$row[csf('amount')];
	//	$summ_sourcing_tot_budget_dzn_val+=$fab_req_qty*$row[csf('sourcing_rate')];
		
		$summ_fob_gross_value_amt+=$fab_req_amount;
	}
  $pre_trim_consarr="select b.id,c.trim_type,c.item_name,b.description,b.trim_group,b.cons_dzn_gmts,b.seq,b.cons_uom as uom,avg(d.excess_per) as  excess_per from wo_pre_cost_trim_cost_dtls b,lib_item_group c,wo_pre_cost_trim_co_cons_dtls d where  c.id=b.trim_group and b.id=d.wo_pre_cost_trim_cost_dtls_id and c.trim_type in(1,2) and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and b.job_no=$txt_job_no group by b.id,c.trim_type,c.item_name,b.description,b.trim_group,b.cons_dzn_gmts,b.cons_uom,b.seq order by b.seq";
	$pre_trim_cons_result=sql_select($pre_trim_consarr);
	foreach($pre_trim_cons_result as $row)
	{
		$trims_type=$row[csf('trim_type')];
		
		
		$description=$row[csf('description')];
		if($description!="") $descriptionCond=", ".$description; else $descriptionCond="";
		$item_id=$row[csf('item_name')].$descriptionCond;
		if($trims_type==1) //Sewing
		{
				$p_sew_trim_precost_excess_arr[$item_id]['p_loss']+=$row[csf('excess_per')];
		}
		else
		{
				$p_fin_trim_precost_excess_arr[$item_id]['p_loss']+=$row[csf('excess_per')];;
		}
		
	}
	
	
	//  $pre_trim_arr="select b.seq,b.id,c.trim_type,c.item_name,b.description,b.trim_group,b.tot_cons,b.ex_per ,b.cons_dzn_gmts,b.cons_uom as uom, b.rate,b.amount,b.sourcing_rate,b.sourcing_nominated_supp from wo_pre_cost_trim_cost_dtls b,lib_item_group c where  c.id=b.trim_group and c.trim_type in(1,2) and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and b.job_no=$txt_job_no order by b.seq";//and b.fabric_source=2

	 $pre_trim_arr="select b.seq,b.id,c.trim_type,c.item_name,b.description,b.trim_group,b.tot_cons,b.ex_per ,b.cons_dzn_gmts,b.cons_uom as uom, b.rate,b.amount,b.sourcing_rate,b.sourcing_nominated_supp from wo_pre_cost_trim_cost_dtls b,lib_item_group c where  c.id=b.trim_group  and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and b.job_no=$txt_job_no order by b.seq";//and b.fabric_source=2

	$pre_trim_result=sql_select($pre_trim_arr);
	
	$p_sew_trim_precost_arr=$p_fin_trim_precost_arr=array();

	//print_r($p_sew_trim_precost_arr2);
	

	 $pre_wash_arr="select b.job_no,b.id,b.emb_name,b.emb_type,b.cons_dzn_gmts, b.rate,b.amount,b.sourcing_rate,b.sourcing_nominated_supp from wo_pre_cost_embe_cost_dtls  b where  b.status_active=1 and b.is_deleted=0  and b.job_no=$txt_job_no  order by b.emb_name";//and b.fabric_source=2
	$pre_wash_result=sql_select($pre_wash_arr);
	
	//	$summ_sourcing_tot_budget_dzn_val=0;
 
	foreach($pre_wash_result as $row)
	{
		$emb_name_id=$row[csf('emb_name')];
		$emb_type=$row[csf('emb_type')];
	
		//emblishment_embroy_type_arr
		if($emb_name_id==1) //Print type
		{
			if($emb_type>0) $emb_typeCond=", ".$emblishment_print_type[$emb_type];else $emb_typeCond="";
			$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
		}
		else if($emb_name_id==2) //embro type
		{
			if($emb_type>0) $emb_typeCond=", ".$emblishment_embroy_type_arr[$emb_type];else $emb_typeCond="";
			$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
		}
		else if($emb_name_id==4) //Special type
		{
			if($emb_type>0) $emb_typeCond=", ".$emblishment_spwork_type[$emb_type];else $emb_typeCond="";
			$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
		}
		else if($emb_name_id==5) //GMT type
		{
			if($emb_type>0) $emb_typeCond=", ".$emblishment_gmts_type[$emb_type];else $emb_typeCond="";
			$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
		}
		else if($emb_name_id==99) //GMT type
		{
			if($emb_type>0) $emb_typeCond=", ".$emblishment_other_type_arr[$emb_type];else $emb_typeCond="";
			$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
		}
		 

		$wash_req_amount=$emb_req_amount=0;
		if($row[csf('emb_name')]==3) //Wash
		{
			
				
		if($row[csf('emb_type')]>0) $wash_emb_typeCond=", ".$emblishment_wash_type[$row[csf('emb_type')]];else $wash_emb_typeCond="";
		$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$wash_emb_typeCond;
		$wash_req_qty=$wash_qtyArr[$row[csf('job_no')]][$row[csf('id')]];
		$wash_req_amount=$wash_amountArr[$row[csf('job_no')]][$row[csf('id')]];
				// echo $emb_name.'='.$wash_emb_typeCond.' <br>';
			 
		$p_wash_precost_arr[$emb_name]['req_qty']+=$wash_req_qty;
		$p_wash_precost_arr[$emb_name]['req_amount']+=$wash_req_amount;
		$p_wash_precost_arr[$emb_name]['cons']+=$row[csf('cons_dzn_gmts')];
		//$p_wash_precost_arr[$emb_name]['tot_cons']+=$row[csf('cons_dzn_gmts')];
		$p_wash_precost_arr[$emb_name]['amount']+=$row[csf('amount')];
		$p_wash_precost_arr[$emb_name]['p_loss']=$row[csf('p_loss')];
		$p_wash_precost_arr[$emb_name]['sourcing_rate']=$row[csf('sourcing_rate')];
		$p_wash_precost_arr[$emb_name]['pre_rate']=$row[csf('rate')];
		$p_wash_precost_arr[$emb_name]['sourcing_nominated_supp']=$row[csf('sourcing_nominated_supp')];
		$p_wash_precost_arr[$emb_name]['uom']=$unit_of_measurement[$row[csf('uom')]];
		$summ_fob_pcs+=$row[csf('amount')];
		$summ_sourcing_tot_budget_dzn_val+=$wash_req_qty*$row[csf('sourcing_rate')];
		$p_wash_tot_row+=1;	
		}
		else
		{
		$emb_req_qty=$emblishment_qtyArr[$row[csf('job_no')]][$row[csf('id')]];
		$emb_req_amount=$emblishment_amountArr[$row[csf('job_no')]][$row[csf('id')]];
		$p_embro_precost_arr[$emb_name]['req_qty']+=$emb_req_qty;
		$p_embro_precost_arr[$emb_name]['req_amount']+=$emb_req_amount;
		$p_embro_precost_arr[$emb_name]['cons']+=$row[csf('cons_dzn_gmts')];
		//$p_wash_precost_arr[$emb_name]['tot_cons']+=$row[csf('cons_dzn_gmts')];
		$p_embro_precost_arr[$emb_name]['amount']+=$row[csf('amount')];
		$p_embro_precost_arr[$emb_name]['p_loss']=$row[csf('p_loss')];
		$p_embro_precost_arr[$emb_name]['pre_rate']=$row[csf('rate')];
		if($row[csf('sourcing_rate')]>0)
		{
		$p_embro_precost_arr[$emb_name]['sourcing_rate']=$row[csf('sourcing_rate')];
		}
		$p_embro_precost_arr[$emb_name]['sourcing_nominated_supp']=$row[csf('sourcing_nominated_supp')];
		$p_embro_precost_arr[$emb_name]['uom']=$unit_of_measurement[$row[csf('uom')]];
		$summ_fob_pcs+=$row[csf('amount')];
		$summ_sourcing_tot_budget_dzn_val+=$emb_req_qty*$row[csf('sourcing_rate')];
		$p_embro_tot_row+=1;	
		}
		//$summ_fob_value_pcs+=$row[csf('amount')]/$order_price_per_dzn;
		$summ_fob_gross_value_amt+=$emb_req_amount+$wash_req_amount;
	}
	//echo $summ_fob_gross_value_amt.'=';
		//echo $summ_fob_pcs.'A';
		//echo $summ_fob_value_pcs.'C,';
	//wo_pri_quo_comarcial_cost_dtls 
	$sql_other = "select fabric_cost, trims_cost, embel_cost, wash_cost, comm_cost, commission, lab_test, inspection, cm_cost, freight, currier_pre_cost, certificate_pre_cost, design_cost, studio_cost, common_oh, depr_amor_pre_cost, interest_cost, incometax_cost, total_cost,price_dzn from wo_pre_cost_dtls where  job_no=$txt_job_no  and status_active=1 and  is_deleted=0";
	$pre_other_result=sql_select($sql_other);//$summ_fob_value_pcs=0;
	 foreach( $pre_other_result as $row )
	{
		$lab_test=($row[csf('lab_test')]/$order_price_per_dzn)*$order_job_qnty;
		$currier_pre_cost=($row[csf('currier_pre_cost')]/$order_price_per_dzn)*$order_job_qnty;
		$inspection=($row[csf('inspection')]/$order_price_per_dzn)*$order_job_qnty;
		$comarcial=($row[csf('comm_cost')]/$order_price_per_dzn)*$order_job_qnty;
		
		$freight=($row[csf('freight')]/$order_price_per_dzn)*$order_job_qnty;
		$certificate_pre_cost=($row[csf('certificate_pre_cost')]/$order_price_per_dzn)*$order_job_qnty;
		$design_pre_cost=($row[csf('design_cost')]/$order_price_per_dzn)*$order_job_qnty;
		$studio_pre_cost=($row[csf('studio_cost')]/$order_price_per_dzn)*$order_job_qnty;
		$common_oh=($row[csf('common_oh')]/$order_price_per_dzn)*$order_job_qnty;
		$depr_amor_pre_cost=($row[csf('depr_amor_pre_cost')]/$order_price_per_dzn)*$order_job_qnty;
		$interest_pre_cost=($row[csf('interest_cost')]/$order_price_per_dzn)*$order_job_qnty;
		$income_tax_pre_cost=($row[csf('incometax_cost')]/$order_price_per_dzn)*$order_job_qnty;
		
		$tot_other_for_fob_value=$lab_test+$currier_pre_cost+$inspection+$comarcial+$freight+$certificate_pre_cost+$design_pre_cost+$studio_pre_cost+$common_oh+$interest_pre_cost+$income_tax_pre_cost+$depr_amor_pre_cost;
		//echo $tot_other_for_fob_value;
		$lab_test_dzn=$row[csf('lab_test')];
		$fob_pcs=$row[csf('price_with_commn_pcs')];
		$currier_pre_cost_dzn=$row[csf('currier_pre_cost')];
		$inspection_dzn=$row[csf('inspection')];
		$comarcial_dzn=$row[csf('comm_cost')];
		
		$common_oh_dzn=$row[csf('common_oh')];
		$studio_pre_cost_dzn=$row[csf('studio_cost')];
		$design_pre_cost_dzn=$row[csf('design_cost')];
		$certificate_pre_cost_dzn=$row[csf('certificate_pre_cost')];
		
		$freight_dzn=$row[csf('freight')];
		//$comm_cost_dzn=$row[csf('comm_cost')];
		$depr_amor_pre_cost_dzn=$row[csf('depr_amor_pre_cost')];
		$income_tax_pre_cost_dzn=$row[csf('incometax_cost')];
		$interest_pre_cost_dzn=$row[csf('interest_cost')];
		
		$cm_cost_dzn=$row[csf('cm_cost')];
		$cm_cost_pcs=$row[csf('cm_cost')]/$order_price_per_dzn;
		$cm_cost_req=($row[csf('cm_cost')]/$order_price_per_dzn)*$order_job_qnty;
		$po_qty_dzn=$order_job_qnty/$order_price_per_dzn;
		$tot_cm_qty_dzn=$row[csf('cm_cost')]*$po_qty_dzn;
		//$lab_test_dzn=$row[csf('lab_test')];

		$tot_summ_fob_pcs=$row[csf('total_cost')];
		
		$tot_other_cost_dzn=$common_oh_dzn+$studio_pre_cost_dzn+$design_pre_cost_dzn+$certificate_pre_cost_dzn+$freight_dzn+$depr_amor_pre_cost_dzn+$income_tax_pre_cost_dzn+$interest_pre_cost_dzn;
		
		$tot_other_cost=($tot_other_cost_dzn/$order_price_per_dzn)*$order_job_qnty;
		//$summ_fob_value_pcs+=($tot_other_cost_dzn+$currier_pre_cost_dzn+$lab_test_dzn+$inspection_dzn+$comarcial_dzn)*$order_price_per_dzn+$cm_cost_pcs;
		
		// echo $tot_other_for_fob_value.'m';
		$summ_fob_gross_value_amt+=$tot_other_for_fob_value+$tot_cm_qty_dzn ;
		
		$summ_fob_pcs+=$tot_other_cost_dzn+$lab_test_dzn+$currier_pre_cost_dzn+$inspection_dzn+$comarcial_dzn+$cm_cost_dzn;
		
		$summ_sourcing_tot_budget_dzn_val+=$tot_other_for_fob_value;
		 
	}
	
	$sql_commi = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls  where job_no=".$txt_job_no." and status_active=1";
	$result_commi=sql_select($sql_commi);
 foreach( $result_commi as $row )
	{
		$commission_type_id=$row[csf('particulars_id')];
		$com_type_id=$row[csf('commission_base_id')];
		
		$commission_arr[$commission_type_id]['commi_req_amt']=($row[csf('commission_amount')]/$order_price_per_dzn)*$order_job_qnty;
		$commission_arr[$commission_type_id]['commi_amt']=$row[csf('commission_amount')];
		$commission_arr[$commission_type_id]['commi_amt_pcs']=$row[csf('commission_amount')]*$order_price_per_dzn;
		//$summ_fob_value_pcs+=$row[csf('commission_amount')]/$order_price_per_dzn;
		$summ_fob_gross_value_amt+=($row[csf('commission_amount')]/$order_price_per_dzn)*$order_job_qnty;
		$summ_fob_pcs+=$row[csf('commission_amount')];
		$summ_sourcing_tot_budget_dzn_val+=($row[csf('commission_amount')]/$order_price_per_dzn)*$order_job_qnty;
	} 
	$summ_sourcing_fob_pcs=$summ_sourcing_tot_budget_dzn_val/$order_job_qnty;
	$summ_tot_final_cm=($summ_fob_gross_value_amt-$summ_sourcing_tot_budget_dzn_val)/$offer_qty_dzn;
	// $tot_summ_fob_pcs=$summ_fob_pcs/$order_price_per_dzn;
	
	 $supplier_library_arr=return_library_array( "select a.short_name, a.id from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id   and a.is_deleted=0  and a.status_active=1 group by a.id,a.short_name order by a.short_name", "id", "short_name");
	?>
            <table align="left" border="1" cellpadding="0" cellspacing="0"  width="100%" style="margin:5px;" rules="all"> 
              <tr>
             <td  width="100%">
             	<table align="left" class="rpt_table"  border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px;" rules="all"> 
                <tr>
                <th colspan="10" style="background-color:#CCC;font-size:20px;"> <b>Details Part</b></th>
               
                </tr>
				<tr>
				<td colspan="8" style="background-color:#963;font-size:20px;"> <b style="float:left">Fabric Cost</b></td>
				</tr>
                 <tr>
                    <th  width="20">SL </th>
                    <th  width="100" title="Fabric">ITEM DESCRIPTION </th>
                    <th  width="70">Cons/Pcs</th>
                    <th  width="70">Wast % </th>
                    <th  width="70">Total Cons/Pcs</th>
                    <th  width="50">UOM </th>
                    <th  width="70">Req. Qty</th>
                    <th  width="70">Rate(USD)</th>
                    <!-- <th  width="70">Cost/Dzn</th> -->
                    <th  width="70">Cost/Pcs</th>
                    <th  width="70">Total Budget</th>
                    
                   
                   
                    </tr>
                    
                    <?
					$f=1;$tot_fab_amount=$tot_fab_amount_pcs=$tot_fab_req_amount=0;$ff=1;$tot_fab_req_sourcing_amount=$tot_fab_req_sourcing_bal_amount=0;
                    foreach($p_fab_precost_arr as $fabriccost_dtls_id=>$fabriccost_dtls_data)
					{
						foreach ($fabriccost_dtls_data as  $fab_type=>$fab_data) 
						{
							 foreach($fab_data as $fab_desc=>$row)
							{
							if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
							
							$nominated_supp_str=""; 
							 $exnominated_supp=explode(",",$row[('sourcing_nominated_supp')]);
							 foreach($exnominated_supp as $supp)
							 {
								if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_arr[$supp]; else $nominated_supp_str.=','.$supplier_library_arr[$supp];
							 }	
	                    ?>
	                	<tr bgcolor="<? echo $bgcolor;?>">
	                   
	                    <td width="20" align="center"><p><? echo $f; ?></p></td>
	                   
	                    <td width="100" align="center"><div style="word-break:break-all"><? echo $fab_desc; //echo $fab_type.','.$fab_desc; ?></div></td>
	                    <td width="70" align="right"><p><? echo number_format($row['cons'],4); ?></p></td>
	                    <td width="70" align="right"><p><? echo number_format($row[('p_loss')],4); ?></p></td>
	                    <td width="70" align="right"><p><? echo number_format($row[('tot_cons')],4); ?></p></td>
	                    <td width="50"><p><? echo $row[('uom')]; ?></p></td>
	                    <td width="70" align="right"><p><? echo number_format($row[('req_qty')],4); ?></p></td>
	                    <td width="70" align="right"><p><? echo number_format($row[('req_amount')]/$row[('req_qty')],4); ?></p></td>
	                    <!-- <td width="70"align="right"><p><? echo number_format($row[('amount')],4); ?></p></td> -->
	                    <td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,4); ?></p></td>
	                    <td width="70" align="right"><p><? echo number_format($row[('req_amount')],4); ?></p></td>
	                    
	                  
	                   
	                    </tr>
						<?
							$f++;$ff++;
							$tot_fab_amount+=$row[('amount')];
							$tot_fab_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
							$tot_fab_req_amount+=$row[('req_amount')];
							$tot_fab_req_sourcing_amount+=$row[('sourcing_rate')]*$row[('req_qty')];
							$tot_fab_req_sourcing_bal_amount+=$bal_sourcing_amount;
							}
						}
					}
					?>
                     
                    <tfoot>
                      <tr style="font-size:18px; background-color:#CCC">
                        <td colspan="8"> <b style="float:right">Total Fabric Cost:</b></td>
                        <!-- <td  align="right"><b><? echo number_format($tot_fab_amount,4); ?></b></td> -->
                        <td  align="right"><b><? echo number_format($tot_fab_amount_pcs,4); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_fab_req_amount,4); ?></b></td>
                      
                        
                    </tr>
                    </tfoot>
                </table>
                <br>
                <?
               // die;
				?>
                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1"  width="98%" style="text-align:center;margin:5px;" rules="all">
                
                 <thead>
				 <td colspan="8" style="background-color:#963;font-size:20px;"> <b style="float:left">Trims Cost</b></td>
                 <tr>
                 	
                    <th  width="20">SL </th>
                    <th  width="100" title="Trim sew">ITEM DESCRIPTION </th>
                    <th  width="70">Cons/Pcs</th>
                    <th  width="70">Wast % </th>
                    <th  width="70">Total Cons/Pcs</th>
                    <th  width="50">UOM </th>
                    <th  width="70">Req. Qty</th>
                    <th  width="70">Rate(USD)</th>
                    <!-- <th  width="70">Cost/Dzn</th> -->
                    <th  width="70">Cost/Pcs</th>
                    <th  width="70">Total Budget</th>
                  
                   
                    
                    </tr>
                    </thead>
                     
                    <?
                    $trims_tot_amount=0;
					$ts=1;$tot_sew_amount=$tot_amount_pcs=$tot_sew_amount_pcs=$tot_sew_req_amount=0;$ttts=1;$tot_sew_req_sourcing_amount=$tot_sew_req_sourcing_bal_amount=0;
                    // foreach($p_sew_trim_precost_arr as $item_id=>$row)
					// {
					foreach($pre_trim_result as $row){

						$trims_type=$row[csf('trim_type')];
				
				
						$description=$row[csf('description')];
						if($description!="") $descriptionCond=", ".$description; else $descriptionCond="";
						$item_id=$row[csf('item_name')].$descriptionCond;
						//$item_name_arr[$item_id]=$row[csf('item_name')].$descriptionCond;
					



						
						if($ts%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
						$nominated_supp_str=""; 
						 $exnominated_supp=explode(",",$row[('sourcing_nominated_supp')]);
						 foreach($exnominated_supp as $supp)
						 {
							if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_arr[$supp]; else $nominated_supp_str.=','.$supplier_library_arr[$supp];
						 }	
						 
						 $req_amt=$row[csf('cons_dzn_gmts')]*$row[csf('rate')];

						 $p_sew_loss=$row[csf('ex_per')];
						 $ex_tot=$row[csf('cons_dzn_gmts')]+(($row[csf('cons_dzn_gmts')]*$p_sew_loss)/100);
					
							
						$trim_req_qty=$trim_qty_arr[$row[csf('id')]];
						$trim_req_amount=$trim_amount_arr[$row[csf('id')]];
								
						//$p_sew_trim_precost_arr[$item_id]['tot_row']+=1;
						$p_sew_trim_tot_row+=1;
					
						$summ_fob_pcs+=$row[csf('amount')];	
						$summ_sourcing_tot_budget_dzn_val+=$trim_req_qty*$row[csf('sourcing_rate')];
						$summ_fob_gross_value_amt+=$trim_req_amount;
						
                    ?>
                	<tr bgcolor="<? echo $bgcolor;?>">
                   
                    <td width="20" align="center"><p><? echo $ts; ?></p></td>
                    <td width="100" ><div style="word-break:break-all"><? echo $item_id; ?></div></td> 
                    <td width="70" align="right"><p><? echo number_format($row[csf('tot_cons')],6); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($p_sew_loss,6); ?></p></td>
                    <td width="70" align="right"><p><?  echo number_format($row[csf('cons_dzn_gmts')],6); ?></p></td>
                    <td width="50" align="center"><p><? echo $unit_of_measurement[$row[csf('uom')]]; ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($trim_req_qty,6); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($trim_req_amount/$trim_req_qty,6); ?></p></td>
                    <!-- <td width="70"align="right"><p><? echo number_format($row[csf('amount')],6); ?></p></td> -->
                    <td width="70" align="right"><p><? echo number_format($row[csf('amount')]/$order_price_per_dzn,6); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($trim_req_amount,6); ?></p></td>
                     
                    </tr>
					<?
						$ts++;$ttts++;
						$tot_sew_amount+=$row[csf('amount')];
						$tot_sew_amount_pcs+=$row[csf('amount')]/$order_price_per_dzn;
						$tot_sew_req_amount+=$trim_req_amount;
						$tot_sew_req_sourcing_amount+=$row[csf('sourcing_rate')]*$trim_req_qty;
						$tot_sew_req_sourcing_bal_amount+=$bal_sourcing_amout;
						$trims_tot_amount+=$trim_req_amount;
						
					}
					?>
                     
                     <tfoot>
                    <tr style="font-size:18px; background-color:#CCC">
                        <td colspan="8" align="right"><b>Total Trims Cost:</b></td>
                        <!-- <td  align="right"><b><? echo number_format($tot_sew_amount,6); ?></b></td> -->
                        <td  align="right"><b><? echo number_format($tot_sew_amount_pcs,6); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_sew_req_amount,6); ?></b></td>
                        
                    </tr>
                    </tfoot>
                     
                </table>
            
                <br>
                 <?
                // die;
				 ?>
                <table align="left" class="rpt_table"  border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px; text-align:center;" rules="all"> 
                <caption><b style="float:left">Gmts Wash</b></caption>
                <thead>
					
                 <tr>
                  
                    <th width="20">SL </th>
                    <th width="100" title="Wash ">ITEM DESCRIPTION </th>
                    <th width="70">Cons/Pcs</th>
                    <th width="70">Wast % </th>
                    <th width="70">Total Cons/Pcs</th>
                    <th width="50">UOM </th>
                    <th width="70">Req. Qty</th>
                    <th width="70"> Rate(USD)</th>
                    <!-- <th width="70">Cost/Dzn</th> -->
                    <th width="70">Cost/Pcs</th>
                    <th width="70">Total Budget</th> 
                    </tr>
                     </thead>
                    
                    <?
					$w=1;$tot_wash_amount=$tot_wash_amount_pcs=$tot_wash_req_amount=$tot_wash_sourcing_req_amount=$tot_wash_sourcing_req_amount_bal=0;$ws=1;
                    foreach($p_wash_precost_arr as $embname_id=>$row)
					{
						
						if($w%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
						$wash_nominated_supp_str=""; 
						 $exnominated_suppArr=explode(",",$row[('sourcing_nominated_supp')]);
						 foreach($exnominated_suppArr as $supp)
						 {
							if($wash_nominated_supp_str=="") $wash_nominated_supp_str=$supplier_library_arr[$supp]; else $wash_nominated_supp_str.=','.$supplier_library_arr[$supp];
						 }		
                    ?>
                	<tr bgcolor="<? echo $bgcolor;?>">
                    
                    <td width="20" align="center"><p><? echo $w; ?></p></td>
                    <td width="100"><div style="word-break:break-all"><? $embname_id=explode(", ",$embname_id);echo $embname_id[1]; ?></div></td> 
                    
                    <td width="70" align="right"><p><? echo number_format($row[('cons')],4); ?></p></td>
                    <td width="70" align="right"><p><? //echo $row[('p_loss')]; ?></p></td>
                    <td width="70" align="right"><p><?  echo number_format($row[('cons')],4) ?></p></td>
                    <td width="50"><p><? echo $costing_val; ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('req_qty')],4); ?></p></td>
                    <td width="70" align="right" title="Rate=<? echo $row[('pre_rate')];?>"><p><? echo number_format($row[('pre_rate')],4); ?></p></td>
                    <!-- <td width="70"align="right"><p><? echo number_format($row[('amount')],4); ?></p></td> -->
                    <td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,4); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('req_qty')]*$row[('pre_rate')],4); ?></p></td>
                    
                    </tr>
                    
                    
					<?
						$w++;$ws++;
						$tot_wash_amount+=$row[('amount')];
						$tot_wash_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
						$tot_wash_req_amount+=$row[('req_qty')]*$row[('pre_rate')];
						$tot_wash_sourcing_req_amount+=$sourcing_tot_amount;
						$tot_wash_sourcing_req_amount_bal+=$sourcing_tot_amount_bal;
						
					}
					?>
                     
                    <tfoot>
                    <tr style="font-size:20px; background-color:#CCC">
                         
                        <td align="right" colspan="8"> <b>Total Wash Cost :</b></td>
                        <!-- <td  align="right"><b><? echo number_format($tot_wash_amount,4); ?></b></td> -->
                        <td  align="right"><b><? echo number_format($tot_wash_amount_pcs,4); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_wash_req_amount,4); ?></b></td>
                      
                        
                    </tr>
                    
                   
                  </tfoot>
                </table>
                <br>
               
                <table align="left" class="rpt_table"  border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px; text-align:center;" rules="all"> 
                <caption><b style="float:left">Embellishment Cost</b></caption>
                 <thead>
                 <tr>
                 	 
                    <th width="20">SL </th>
                    <th width="100" title="">ITEM DESCRIPTION </th>
                    <th width="70">Cons/Pcs</th>
                    <th width="70">Wast % </th>
                    <th width="70">Total Cons/Pcs</th>
                    <th width="50">UOM </th>
                    <th width="70">Req. Qty</th>
                    <th width="70">Rate(USD)</th>
                    
                    <!-- <th width="70">Cost/Dzn</th> -->
                    <th width="70">Cost/Pcs</th>
                    <th width="70">Total Budget</th>
                   
                    
                    </tr>
                    </thead>
                      
                    <?
					$em=1;$tot_embro_amount=$tot_embro_amount_pcs=$tot_embro_req_amount=$tot_emb_sourcing_req_amount=$tot_emb_sourcing_req_amount_bal=0;$emb=1;
                    foreach($p_embro_precost_arr as $embname_id=>$row)
					{
						
						if($w%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
						$emb_nominated_supp_str=""; 
						 $emb_exnominated_suppArr=explode(",",$row[('sourcing_nominated_supp')]);
						 foreach($emb_exnominated_suppArr as $supp)
						 {
							if($emb_nominated_supp_str=="") $emb_nominated_supp_str=$supplier_library_arr[$supp]; else $emb_nominated_supp_str.=','.$supplier_library_arr[$supp];
						 }		
                    ?>
                	<tr bgcolor="<? echo $bgcolor;?>">
                     
                    <td width="20" align="center"><p><? echo $em; ?></p></td>
                    <td width="100"><div style="word-break:break-all"><? echo $embname_id; ?></div></td> 
                    
                    <td width="70" align="right"><p><? echo number_format($row[('cons')],4); ?></p></td>
                    <td width="70" align="right"><p><? //echo $row[('p_loss')]; ?></p></td>
                    <td width="70" align="right"><p><?  echo number_format($row[('cons')],4); ?></p></td>
                    <td width="50"><p><? echo $costing_val; ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('req_qty')],4); ?></p></td>
                    <td width="70" align="right"><p><? echo number_format($row[('req_amount')]/$row[('req_qty')],4); ?></p></td>
                    <!-- <td width="70"align="right"><p><? echo number_format($row[('amount')],4); ?></p></td> -->
                    <td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,4); ?></p></td>
                    <td width="70" align="right"><b><? echo number_format($row[('req_amount')],4); ?></b></td>
                    
                   
                    
                      
                    </tr>
					<?
						$em++;$emb++;
						$tot_embro_amount+=$row[('amount')];
						$tot_embro_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
						$tot_embro_req_amount+=$row[('req_amount')];
						$tot_emb_sourcing_req_amount+=$emb_sourcing_tot_amount;
						$tot_emb_sourcing_req_amount_bal+=$emb_sourcing_tot_amount_bal;
						
					}
					?>
                     
                    <tfoot>
                     <tr style="font-size:20px; background-color:#CCC">
                         
                        <td align="right" colspan="8"> <b>D-Total Embellishment Cost:</b></td>
                        <!-- <td  align="right"><b><? echo number_format($tot_embro_amount,4); ?></b></td> -->
                        <td  align="right"><b><? echo number_format($tot_embro_amount_pcs,4); ?></b></td>
                        <td  align="right"><b><? echo number_format($tot_embro_req_amount,4); ?></b></td>
                       
                    </tr>
                  </tfoot>
                </table>
                <br>
                 
                <table align="left" class="rpt_table"  border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px;" rules="all"> 
                <caption><b style="float:left">Others Components</b></caption>
                 <tr>
                 	 
                    <th width="20">SL </th>
                    <th title="520"><b>Others Components</b> </th>
                   
                    <!-- <th width="70"><b>Cost/Dzn</b></th> -->
                    <th width="70"><b>Cost/Pcs</b></th>
                    <th width="70"><b>Total Budget</b></th>
                    
                  
                    </tr>
                    <tbody> 
                    <?
					//$em=1;$tot_embro_amount=$tot_embro_amount_pcs=$tot_embro_req_amount=0;$emb=1;
						$bgcolor="#E9F3FF";
						$bgcolor2="#FFFFFF";//currier_pre_cost_dzn
					 
                      
                   // $tot_other_cost=0;
					$tot_other_cost_first=$tot_other_cost+$comarcial+$inspection+$currier_pre_cost+$lab_test;
					
						$total_other_cost_dzn=$tot_other_cost_dzn+$comarcial_dzn+$inspection_dzn+$lab_test_dzn+$currier_pre_cost_dzn;
						 $tot_other_cost_pcs=$tot_other_cost_dzn/$order_price_per_dzn;
						 $tot_comarcial_dzn_pcs=$comarcial_dzn/$order_price_per_dzn;
						 $tot_inspection_dzn_pcs=$inspection_dzn/$order_price_per_dzn;
						  $currier_pre_cost_dzn_pcs=$currier_pre_cost_dzn/$order_price_per_dzn;
						  $tot_lab_test_dzn_pcs=$lab_test_dzn/$order_price_per_dzn;
						 
						$total_other_cost_pcs=$tot_other_cost_pcs+$tot_comarcial_dzn_pcs+$tot_lab_test_dzn_pcs+$tot_inspection_dzn_pcs+$currier_pre_cost_dzn_pcs;
						
						
						
						$tot_other_cost_req_amount=$tot_other_cost_first;
						
					
					?>
                	<tr bgcolor="<? echo $bgcolor;?>">
                    
                    <td width="20" align="center"><p>1</p></td>
                    <td width="520" align="" ><b>Test Charge</b></td> 
                    <!-- <td width="70"align="right"><p><? echo number_format($lab_test_dzn,4); ?>&nbsp;</p></td> -->
                    <td width="70" align="right"><p><?   echo number_format($tot_lab_test_dzn_pcs,4); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($lab_test,4); ?>&nbsp;</p></td>
                    
                    
                    
                    </tr>
                     <td width="20" align="center" ><p>2</p></td>
                    <td width="520"><b>Courier Charge</b></td> 
                    <!-- <td width="70"align="right"><p><? echo number_format($currier_pre_cost_dzn,4); ?>&nbsp;</p></td> -->
                    <td width="70" align="right"><p><?  echo number_format($currier_pre_cost_dzn_pcs,4); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($currier_pre_cost,4); ?>&nbsp;</p></td>
                   
                    </tr>
                    
                    <tr bgcolor="<? echo $bgcolor2;?>">
                    
                    <td width="20" align="center" ><p>3</p></td>
                    <td width="520"><b>Inspection Charge</b></td> 
                    <!-- <td width="70"align="right"><p><? echo number_format($inspection_dzn,4); ?>&nbsp;</p></td> -->
                    <td width="70" align="right"><p><? echo number_format($tot_inspection_dzn_pcs,4); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($inspection,4); ?>&nbsp;</p></td>
                   
                     
                    </tr>
                    
                    <tr bgcolor="<? echo $bgcolor;?>">
                    
                    <td width="20" align="center" ><p>4</p></td>
                    <td width="520"><b>Commercial Charge</b></td> 
                    <!-- <td width="70"align="right"><p><? echo number_format($comarcial_dzn,4); ?>&nbsp;</p></td> -->
                    <td width="70" align="right"><p><?  echo number_format($tot_comarcial_dzn_pcs,4); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($comarcial,4); ?>&nbsp;</p></td>
                  
                       
                    </tr>
                    <tr bgcolor="<? echo $bgcolor2;?>">
                     
                    <td width="20" align="center"><p>5</p></td>
                    <td width="520" title="Freight+Certif.Cost+Design Cost+Studio Cost+Deprec.&Amort.+Operating Expenses+Deprec.&Amort.+Interest+Income Tax">
                    <b>Others Charge</b></td> 
                   
                     <!-- <td width="70"align="right"><p><? echo number_format($tot_other_cost_dzn,4); ?>&nbsp;</p></td> -->
                    <td width="70" align="right"><p><? echo number_format($tot_other_cost_pcs,4); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($tot_other_cost,4); ?>&nbsp;</p></td>
                   
                     
                    </tr>
					
                    </tbody>
                    <tfoot>
                     <tr style="font-size:20px; background-color:#CCC">
                         
                        <td align="right" colspan="2"> <b>E-Total Others Cost:</b></td>
                        <!-- <td  align="right"><b><? echo number_format($total_other_cost_dzn,4); ?>&nbsp;</b></td> -->
                        <td  align="right"><b><? echo number_format($total_other_cost_pcs,4); ?>&nbsp;</b></td>
                        <td  align="right"><b><? echo number_format($tot_other_cost_req_amount,4); ?>&nbsp;</b></td>
                        
                        
                     
                        
                    </tr>
                  </tfoot>
                </table>
                <br>
             
                 <table align="left" border="1" class="rpt_table"  cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px;" rules="all"> 
                <caption><b style="float:left"> Commission Cost:</b></caption>
                   <tr>
                 	 
                    <th  width="20">SL </th>
                    <th width="520" title="">Commission Cost </th>
                    <!-- <th width="70">Cost/Dzn</th> -->
                    <th  width="70">Cost/Pcs</th>
                    <th  width="70">Total Budget</th>
                    
                   
                    
                    
                     
                    </tr>
                    <tbody> 
                    <?
                     
						$tot_commission_amount=$commission_arr[1]['commi_amt']+$commission_arr[2]['commi_amt'];
						$tot_commission_amount_pcs=($commission_arr[1]['commi_amt']/$order_price_per_dzn)+($commission_arr[2]['commi_amt']/$order_price_per_dzn);
						$tot_commision_req_amount=$commission_arr[1]['commi_req_amt']+$commission_arr[2]['commi_req_amt'];
						
					
					?>
					 
                   <tr bgcolor="<? echo $bgcolor;?>">
                    
                    <td width="20" align="center"><p>1</p></td>
                    <td width="520" ><b>Local </b></td> 
                    <!-- <td width="70"align="right"><p><? echo number_format($commission_arr[2]['commi_amt'],4); ?>&nbsp;</p></td> -->
                    <td width="70" align="right"><p><? echo number_format($commission_arr[2]['commi_amt']/$order_price_per_dzn,4); ?>&nbsp;</p></td>
                    <td width="70" align="right"><p><? echo number_format($commission_arr[2]['commi_req_amt'],4); ?>&nbsp;</p></td>
                    
                    </tr>

                    <tr bgcolor="<? echo $bgcolor2;?>">                     
						<td width="20" align="center"><p>2</p></td>
						<td width="520" ><b>Foreign</b></td> 
						<!-- <td width="70"align="right"><p><? echo number_format($commission_arr[1]['commi_amt'],4); ?>&nbsp;</p></td> -->
						<td width="70" align="right"><p><? echo number_format($commission_arr[1]['commi_amt']/$order_price_per_dzn,4); ?>&nbsp;</p></td>
						<td width="70" align="right"><p><? echo number_format($commission_arr[1]['commi_req_amt'],4); ?>&nbsp;</p></td>
                    
                     
                    </tr>
					
                    </tbody>
                    <tfoot>
                    <tr>
                         
                        <td align="right" colspan="2"> <b>F-Total Commission Cost:</b></td>
                        <!-- <td  align="right"><b><? echo number_format($tot_commission_amount,4); ?>&nbsp;</b></td> -->
                        <td  align="right"><b><? echo number_format($tot_commission_amount_pcs,4); ?>&nbsp;</b></td>
                        <td  align="right"><b><? echo number_format($tot_commision_req_amount,4); ?>&nbsp;</b></td>
                       
                        
                    </tr>
                    
                    <tr bgcolor="<? echo $bgcolor;?>">
                    
                    <td width="20" align="center"><p>1</p></td>
                    <td width="520"><b>G-Total CM Cost</b></td> 
                    <!-- <td width="70"align="right"><b><? echo number_format($cm_cost_dzn,4); ?>&nbsp;</b></td> -->
                    <td width="70" align="right"><b><? $tot_cm_cost_pcs=$cm_cost_dzn/$order_price_per_dzn;echo number_format($tot_cm_cost_pcs,4); ?>&nbsp;</b></td>
                    <td width="70" title="CM Dzn*PO Qty Dzn" align="right"><b><? echo number_format($tot_cm_qty_dzn,4); ?>&nbsp;</b></td>
                  
                    </tr>
                    
                    <tr bgcolor="<? echo $bgcolor;?>"> 
                    <td width="520" colspan="2"><p> <b>Gross FOB Value [A+B+C+D+E+F+G+H]</b></p></td> 
					<?php //tot_sew_amount_pcs
										$gross_fob_value_dzn=$tot_fab_amount+$trim_sew_fin_amt+$tot_wash_amount+$tot_embro_amount+$tot_other_cost_dzn+$tot_commission_amount+$cm_cost_dzn;
										$gross_fob_value_pcs=$tot_fab_amount_pcs+$trim_sew_fin_amt_pcs+$tot_wash_amount_pcs+$tot_embro_amount_pcs+$tot_other_cost_pcs+$tot_commission_amount_pcs+$tot_cm_cost_pcs;
										//echo $tot_fab_amount_pcs.'=='.$trim_sew_fin_amt_pcs.'=='.$tot_wash_amount_pcs.'=='.$tot_embro_amount_pcs.'=='.$tot_commission_amount_pcs.'=='.$tot_cm_cost_pcs;
										//$gross_fob_value_req=$tot_fab_req_amount+$trim_fin_req_amount+$tot_wash_req_amount+$tot_embro_req_amount+$tot_commision_req_amount+$tot_other_cost_req_amount+$cm_cost_req;
										
										$gross_fob_value_req=$tot_fab_req_amount+$trims_tot_amount+$tot_wash_req_amount+$tot_embro_req_amount+$tot_other_cost_req_amount+$tot_commision_req_amount+$tot_cm_qty_dzn;


					
										
										 //---fob value
										 $total_fob_gross_pcs=$tot_fab_amount_pcs+$trim_sew_fin_amt_pcs+$tot_wash_amount_pcs+$tot_embro_amount_pcs+$tot_other_cost_pcs+$tot_commission_amount_pcs+$tot_cm_cost_pcs;
							$total_fob_gross_dzn=$tot_fab_amount+$trim_sew_fin_amt+$tot_sew_amount_pcs+$tot_wash_amount+$tot_embro_amount+$total_other_cost_dzn+$tot_commission_amount+$cm_cost_dzn;
										$tot_gross_fob_pcs=$total_fob_gross_dzn/$order_price_per_dzn;
										 $gross_fob_value_dzn_without_commi=$total_fob_gross_dzn-$tot_commission_amount;
										$gross_fob_value_pcs_without_commi=$tot_gross_fob_pcs-$tot_commission_amount_pcs;
										$gross_fob_value_req_without_commi=$gross_fob_value_req-$tot_commision_req_amount;
					?>					
                    <!-- <td width="70"align="right"><b><?  //tot_embro_amount_pcs tot_embro_req_amount

					//echo number_format($total_fob_gross_dzn,4); ?>&nbsp;</b></td> -->
                    <td width="70" align="right"><b> <? echo number_format($tot_gross_fob_pcs,4); ?>&nbsp;</b></td>
                    <td width="70" align="right" title="<? echo $gross_fob_value_req."=".$tot_fab_req_amount."+".$trims_tot_amount."+".$tot_wash_req_amount."+".$tot_embro_req_amount."+".$tot_other_cost_req_amount."+".$tot_commision_req_amount."+".$tot_cm_qty_dzn;?>"><b><? echo number_format($gross_fob_value_req,4); ?>&nbsp;</b></td>
                   
                    </tr>
                    <?
                   
					?>
                     <tr bgcolor="<? echo $bgcolor2;?>">
                    <td width="520" colspan="2"><b>Net FOB Value (Without Commission)</b></td> 
                    <!-- <td width="70"align="right"><b><? //echo number_format($gross_fob_value_dzn_without_commi,4); ?> </b></td> -->
                    <td width="70" align="right"><b><? echo number_format($gross_fob_value_pcs_without_commi,4); ?> </b></td>
                    <td width="70" align="right"><b><? echo number_format($gross_fob_value_req_without_commi,4); ?> </b></td>
                   
                    </tr>
                   
                  </tfoot>
                </table>
                
             </td>
              </tr>
              
           </table>
          
		   <div style="float:left" align="left">  <b> &nbsp;&nbsp;&nbsp;&nbsp; <? //echo $inserted_by;?> </b></div>
        <div style="clear:both"></div>
        <? 
		$cbo_company_name=str_replace("'","",$cbo_company_name);
		if ($cbo_template_id != '') {
			$template_id = " and a.template_id=$cbo_template_id ";
		}
		 
		$path=($path!='')?$path:"../../";
		//$inserted_by=return_field_value("inserted_by", "wo_pre_cost_mst", "job_no='".str_replace("'","",$txt_job_no)."'");
		$job_info=sql_select("SELECT id, inserted_by from wo_pre_cost_mst where status_active=1 and is_deleted=0 and job_no='".str_replace("'","",$txt_job_no)."'");
		foreach ($job_info as $row) {
			$inserted_by=$row[csf('inserted_by')];
			$job_id=$row[csf('id')];
		}
		
	   $signature_arr=return_library_array( "select master_tble_id,image_location from common_photo_library where form_name='user_signature'",'master_tble_id','image_location');
		$appSql="select approved_by from approval_history where entry_form=46 and mst_id = $job_id and is_signing=1";
		$appSqlRes=sql_select($appSql);
		foreach($appSqlRes as $row){
			$userSignatureArr[$row[csf('approved_by')]]=$path.$signature_arr[$row[csf('approved_by')]];	
		}
		$userSignatureArr[$inserted_by]=$path.$signature_arr[$inserted_by];

		echo signature_table(218, $cbo_company_name, "1200px",$cbo_template_id,50,$inserted_by,$userSignatureArr);
		?>            
     </div>
     <div style="clear:both"></div>
     
    <?
	$mailBody=ob_get_contents();
	ob_clean();
	echo $mailBody;

	//Mail send------------------------------------------
	list($msil_address,$is_mail_send,$mail_body)=explode('**',$mail_data);
	if($is_mail_send==1){
	
		require_once('../../../mailer/class.phpmailer.php');
		require_once('../../../auto_mail/setting/mail_setting.php');
		
		$mailBody = preg_replace("/<img[^>]+\>/i", " ", $mailBody); 	
		$mailToArr=array();
		if($msil_address){$mailToArr[]=$msil_address;}
			
		$mailSql = "SELECT c.TEAM_LEADER_EMAIL, d.USER_EMAIL
  FROM wo_po_details_master  a,  wo_pre_cost_mst b, lib_marketing_team c, USER_PASSWD d
 WHERE a.job_no = b.job_no  AND a.TEAM_LEADER = c.id AND b.INSERTED_BY = d.id AND a.status_active = 1  AND a.job_no=$txt_job_no";
		
		//echo $mailSql;die;
		
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows['TEAM_MEMBER_EMAIL']){$mailToArr[$rows['TEAM_LEADER_EMAIL']]=$rows['TEAM_LEADER_EMAIL'];}
			if($rows['USER_EMAIL']){$mailToArr[$rows['USER_EMAIL']]=$rows['USER_EMAIL'];}
		}
		
		//$elcetronicSql = "SELECT a.SEQUENCE_NO,a.BYPASS,b.USER_EMAIL  from electronic_approval_setup a join user_passwd b on a.user_id=b.id where b.valid=1 and a.page_id=2150 and a.entry_form=46 and a.company_id=$cbo_company_name order by a.SEQUENCE_NO";
		
		$elcetronicSql = "SELECT a.BUYER_ID,a.SEQUENCE_NO,a.BYPASS,b.USER_EMAIL  from electronic_approval_setup a join user_passwd b on a.user_id=b.id where b.valid=1  AND a.page_id in(428,1717,2150) and a.company_id=$cbo_company_name order by a.SEQUENCE_NO"; //and a.page_id=2150 and a.entry_form=46
		//echo $elcetronicSql;die;
		
		$elcetronicSqlRes=sql_select($elcetronicSql);
		foreach($elcetronicSqlRes as $rows){
			
			
			if($rows[BUYER_ID]!=''){
				foreach(explode(',',$rows[BUYER_ID]) as $bi){
					if($rows['USER_EMAIL']!='' && $bi==$buyer_name_id){$mailToArr[$rows['USER_EMAIL']]=$rows['USER_EMAIL'];}
					if($rows[BYPASS]==2){break;}
				}
			}
			else{
				if($rows['USER_EMAIL']){$mailToArr[$rows['USER_EMAIL']]=$rows['USER_EMAIL'];}
				if($rows[BYPASS]==2){break;}
			}
			
			
			
		}
		
		
		//Un-approve request mail......................................................
		$user_id=$_SESSION['logic_erp']['user_id'];
		$job_id=return_field_value("id", "wo_pre_cost_mst", "job_no='".str_replace("'","",$txt_job_no)."'");
		$approved_no=return_field_value("MAX(approved_no) as approved_no","approval_history","entry_form=46 and mst_id=$job_id","approved_no")+1;
		$unapproved_request=return_field_value("APPROVAL_CAUSE","fabric_booking_approval_cause","entry_form=46 and user_id=$user_id and booking_id=$job_id and approval_type=2 and approval_no='$approved_no'");//page_id=$page_id and
		if($unapproved_request){
			$mailToArr=array();
			if($msil_address){$mailToArr[]=$msil_address;}
			$final_app_user_mail=return_field_value("USER_EMAIL","user_passwd","id in(select APPROVED_BY from APPROVAL_HISTORY where id in(select max(id) from APPROVAL_HISTORY where mst_id=$job_id and ENTRY_FORM=46 and CURRENT_APPROVAL_STATUS=1))");
			$mailToArr[]= $final_app_user_mail;
		}
		$mailBody=$mail_body."<br>".$unapproved_request."<br>".$mailBody;
		//......................................................Un-approve request mail;


		
		$to=implode(',',$mailToArr);
		//echo $to;die;
		 
		
		//Att file....
		$imgSql="select IMAGE_LOCATION,REAL_FILE_NAME from common_photo_library where is_deleted=0  and MASTER_TBLE_ID=$txt_job_no and file_type=1";
		$imgSqlResult=sql_select($imgSql);
		foreach($imgSqlResult as $rows){
			$att_file_arr[]='../../../'.$rows[IMAGE_LOCATION].'**'.$rows[REAL_FILE_NAME];
		}
		
		$subject="BOM Pre Cost Report";
		$header=mailHeader();
		echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
		
	}
	
	//------------------------------------End;
	
	exit();
}

if($action=='material_checklist') //Material Checklist Btn 24 for Energypac Fashions Ltd shariar 16687
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$txt_job_no=str_replace("'","",$txt_job_no);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_buyer_name=str_replace("'","",$cbo_buyer_name);
	$txt_style_ref=str_replace("'","",$txt_style_ref);
	$txt_costing_date=str_replace("'","",$txt_costing_date);
	$txt_po_breack_down_id=str_replace("'","",$txt_po_breack_down_id);
	$cbo_costing_per=str_replace("'","",$cbo_costing_per);
	$excess_per_val=str_replace("'","",$excess_per_val);
	$supplier_check=str_replace("'","",$supplier_check);
	//echo $excess_val.'dd';
	if(str_replace("'",'',$txt_po_breack_down_id)=="")
	{
		$txt_po_breack_down_id_cond='';
		$txt_po_breack_down_id_cond1='';
		$txt_po_breack_down_id_cond2='';
		$txt_po_breack_down_id_cond3='';
	}
	else
	{
		$txt_po_breack_down_id_cond=" and b.id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond1=" and a.id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond2=" and d.po_break_down_id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond3=" and b.po_break_down_id in(".$txt_po_breack_down_id.")";
		//$txt_po_breack_down_id_cond3=" and b.id in(".$txt_po_breack_down_id.")";
	}
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$supplier_name_arr=return_library_array( "select id, supplier_name from  lib_supplier",'id','supplier_name');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	$size_library=return_library_array( "select id, size_name from lib_size where status_active=1 and is_deleted=0", "id", "size_name");
	$supplier_library=return_library_array( "select a.id, a.supplier_name from lib_supplier a where a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
	$result =sql_select("select a.job_no,a.buyer_name,a.style_ref_no,a.ship_mode, a.order_uom,a.gmts_item_id,a.total_set_qnty,a.job_quantity,a.fit_id,b.id,b.po_number,b.po_received_date,b.pub_shipment_date,b.file_no,b.grouping,c.costing_date,c.costing_per from wo_po_details_master a,wo_po_break_down b,wo_pre_cost_mst c where a.job_no=b.job_no_mst and c.job_no=b.job_no_mst  and c.job_no=a.job_no  and b.job_no_mst='$txt_job_no' $txt_po_breack_down_id_cond and b.status_active=1 and b.is_deleted=0 order by b.pub_shipment_date DESC");
	
	$job_in_orders = array();$job_in_ship_arr = array();
	$pulich_ship_date='';$shipment_date_arr='';
	$job_in_ref = array();
	$job_in_file = array();
	foreach ($result as $val){
		$job_in_orders_arr[$val[csf('id')]]= $val[csf('po_number')];
		$job_in_ship_arr[$val[csf('id')]]= $val[csf('pub_shipment_date')];
		$job_in_recvDate_arr[$val[csf('id')]]= change_date_format($val[csf('po_received_date')]);
		$job_in_ref_arr[$val[csf('id')]]= $val[csf('grouping')];
		$job_in_file_arr[$val[csf('id')]]= $val[csf('file_no')];
		$job_total_set_qnty_arr[$val[csf('job_no')]]= $val[csf('total_set_qnty')];
		
		$gmts_item_id=$val[csf('gmts_item_id')];
		$order_uom=$val[csf('order_uom')];
		$shipment_date_arr.=change_date_format($val[csf('pub_shipment_date')]).',';
		
		$job_no=$val[csf('job_no')];
		$buyer_name=$buyer_arr[$val[csf('buyer_name')]];
		$style_ref_no=$val[csf('style_ref_no')];
		$job_quantity=$val[csf('job_quantity')];
		$fit_id=$fit_list_arr[$val[csf('fit_id')]];
		$costing_date=$val[csf('costing_date')];
		$costing_per_name=$costing_per[$val[csf('costing_per')]];
	}
	//echo $txt_po_breack_down_id_cond.'DSD';
	$ref_cond=implode(",",array_unique($job_in_ref_arr));
	$file_con=implode(",",array_unique($job_in_file_arr));
	$shipment_date=rtrim($shipment_date_arr,',');
	$shipment_date=implode(",",array_unique(explode(",",$shipment_date)));
	
	$recv_date=implode(",",array_unique($job_in_recvDate_arr));
	//$shipment_date=implode(",",array_unique($job_in_ship_arr));
	$job_in_orders=implode(", ",$job_in_orders_arr);
	$sql_check=sql_select("select a.color_number_id from wo_po_color_size_breakdown a where a.job_no_mst='$job_no' and a.status_active=1 and a.is_deleted=0 ");
		foreach($sql_check as $dts)
		{
			$color_ids.=$color_library[$dts[csf("color_number_id")]].',';
		}
		unset($sql_check);
		$color_id=implode(",",array_filter(array_unique(explode(",",$color_ids))));
		//ob_start();
		ob_start();
	?>
	<style type="text/css" media="print">

@media print
   {
	   tbody {
		   page-break-inside: avoid;
		   tbody {display: table-row-group;}
	   }
	   thead {
		   display: table-header-group;
		   page-break-before: always;

	   }
   }
/*	@media print {
		 #page_break_div {
		   page-break-before: always;
		 }
}
   */	.footer_signature {
		   position: fixed;
		   height: auto;
		   bottom:0;
		   width:100%;

		   }
	   @media print {
		   table {
			   page-break-inside: avoid;
		   }
	   }
	   /*@media all {
		 #page_break_div   { display: none; }
	   }

	   @media screen {
	   thead { display: block; }
	   tfoot { display: block; }
	   }*/

</style>
	<!-- <style type="text/css" media="print">
   table { page-break-inside:auto; }
  
        @media print {
        thead {display: table-header-group;}
    }
	@media print {
				table {
					page-break-inside: avoid;
				}
			}  
	</style> -->
	 <div style="width:1100px; margin:0 auto">
	<!--    <div style="width:1100px; font-size:20px; font-weight:bold" align="center">< ? echo $comp[str_replace("'","",$cbo_company_name)]; ?></div>
	    <div style="width:1100px; font-size:14px; font-weight:bold" align="center">MO Sheet</div>
	-->	
	<br>
	
	 <div style="font-family:'Arial Narrow';">
        <table style="width:850px" ><tr><td colspan="6" align="center">
           <?
            $image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id='$cbo_company_name'","image_location");
            ?>
           <img src="<? echo base_url($image_location); ?>" height='70' align="left" />
            <b style="font-size:25px;"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></b><br>
            <b style="font-size:14px;">Material Order Sheet</b>
        </td></tr></table>
        
        <table style="width:560px; font-family:Arial Narrow" border="0" >
			<table width="50%"  class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all">
				<tr>
					<td width="200">Job No</td>
					<td width="200"><b><? echo $job_no; ?></b></td>
				</tr>
				  <tr>
					<td width="200">Buyer</td>
					<td width="200"><b><? echo $buyer_name; ?></b></td>
				</tr>
				  <tr>
					<td width="200">PO  Number</td>
					<td width="200"><b><? echo $job_in_orders; ?></b></td>
				</tr>
				  <tr>
					<td width="200">Style Number</td>
					<td width="200"><b><? echo $style_ref_no; ?></b></td>
				</tr>
				  <tr>
					<td width="200">Item</td>
					<td width="200"><b><? 
						$gmts_item=''; $gmts_item_id=explode(",",$gmts_item_id);
							foreach($gmts_item_id as $item_id)
							{
								if($gmts_item=="") $gmts_item=$garments_item[$item_id]; else $gmts_item.=", ".$garments_item[$item_id];
							}
							echo $gmts_item;
					 ?></b></td>
				</tr>
				<tr>
					<td width="200">Block/Fit</td>
					<td width="200"><b><? echo $fit_id; ?></b></td>
				</tr>
				<tr>
					<td width="200">Color</td>
					<td width="200"><b><? echo $color_id; ?></b></td>
				</tr>
				<tr>
					<td width="200">Order Quantity</td>
					<td width="200"><b><? echo $job_quantity; ?></b></td>
				</tr>
				<tr>
					<td width="200">Shipment Date</td>
					<td width="200"><b><? echo $shipment_date; ?></b></td>
				</tr>
				  <tr>
					<td width="200">PO Receive Date</td>
					<td width="200"><b><? echo $recv_date; ?></b></td>
					
				</tr>
				  <tr>
					<td width="200">Costing Date</td>
					<td width="200"><b><? echo change_date_format($costing_date); ?></b></td>
					
				</tr>
					<td width="200">Costing Per</td>
					<td width="200"><b><? echo $costing_per_name; ?></b></td>
					
				</tr>
			</table>
			<table style="float:right; margin-top:-230px;"  width="350px" class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all">
				<caption><b> Item's View</b></caption>
				
				 <?
						// image show here  -------------------------------------------
						$sql = "select id,master_tble_id,image_location from common_photo_library   where master_tble_id='$txt_job_no' and file_type=1";
						$photo_data_array=sql_select($sql);
					 ?> 
					 	<tr>
						<td align="center">
							 <div style="margin:15px 5px;float:right;width:500px;"  >
							 
							<? foreach($photo_data_array AS $inf){ ?>
							
								<img src="<? echo base_url($inf[csf("image_location")]); ?>" height='80' width='80' />
								
							<?  } ?>
							
						  </div>
						
					</td>	
				</tr>
			</table>
			
		</table>
		
		<?
		 $color_size_sql= "select a.po_number,a.id as po_id,b.item_number_id,b.color_number_id,b.size_number_id,avg(b.excess_cut_perc) as excess_cut_perc,sum(b.plan_cut_qnty) as plan_cut_qnty,sum(b.order_quantity) as order_quantity from wo_po_break_down a,wo_po_color_size_breakdown b where  b.po_break_down_id=a.id  and b.job_no_mst='".$txt_job_no."'  and  a.is_deleted=0 and a.status_active=1 and  b.is_deleted=0 and b.status_active=1 $txt_po_breack_down_id_cond1 group by a.po_number,a.id,b.size_number_id,item_number_id,b.color_number_id order by b.item_number_id,b.size_number_id ";

			$result_color=sql_select($color_size_sql);
			$color_size_array=array();
			foreach($result_color as $row)
			{
				$color_size_array[$row[csf("po_id")]][$row[csf("item_number_id")]][$row[csf("color_number_id")]]=$row[csf("order_quantity")];
				$po_size_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['po_qty']=$row[csf("order_quantity")];
				$po_size_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['plan_cut_qnty']=$row[csf("plan_cut_qnty")];
				$po_color_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]]['order_quantity']=$row[csf("order_quantity")];
				//$po_size_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['tot_row']+=0;
				if($row[csf("excess_cut_perc")]>0)
				{
				$po_size_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]]['excess_cut_perc']=$row[csf("excess_cut_perc")];
				}
				$po_array[$row[csf("po_id")]]['po_no']=$row[csf("po_number")];
				$po_array[$row[csf("po_id")]]['item_number_id']=$row[csf("item_number_id")];
				
				$po_color_array[$row[csf("po_id")]][$row[csf("item_number_id")]]['color_number_id'].=$row[csf("color_number_id")].',';
				$item_color_size_array[$row[csf("item_number_id")]][$row[csf("color_number_id")]]+=$row[csf("order_quantity")];
			}
			


			//$size_sql= "select b.size_number_id,sum(b.order_quantity) as order_quantity from wo_po_break_down a,wo_po_color_size_breakdown b where  b.po_break_down_id=a.id  and b.job_no_mst=".$txt_job_no." and  b.is_deleted=0 and b.status_active=1 group by b.size_number_id";
		$size_sql= "select b.size_number_id,sum(b.order_quantity) as order_quantity,sum(b.plan_cut_qnty) as plan_cut_qnty from wo_po_break_down a,wo_po_color_size_breakdown b where  b.po_break_down_id=a.id  and b.job_no_mst='".$txt_job_no."' and  a.is_deleted=0 and a.status_active=1 and  b.is_deleted=0 and b.status_active=1 $txt_po_breack_down_id_cond1 group by b.size_number_id,b.size_order order by b.size_order";

			$result_size=sql_select($size_sql);
			$posize_array=array();
			foreach($result_size as $row)
			{
				$posize_array[$row[csf("size_number_id")]]=$row[csf("size_number_id")];
			}

			$po_rowspan_arr=array();$po_item_rowspan_arr=array();
			foreach($color_size_array as $pokey=>$po_data)
			{
				$po_row_span=0;
				foreach($po_data as $itemkey=>$item_data)
				{
					$item_row_span=0;$color_row_span=0;
					foreach($item_data as $colorkey=>$val)
					{
						$item_row_span++;
						$po_row_span++;
						//$po_item_color_rowspan_arr[$pokey][$itemkey][$colorkey]=$color_row_span;
						$color_row_span++;
					}
					$itempo_rowspan_arr[$pokey][$itemkey][$colorkey]=$color_row_span;
					$po_item_rowspan_arr[$pokey][$itemkey]=$item_row_span;
					$po_rowspan_arr[$pokey]=$po_row_span;
					
				}
			}

			//print_r($itempo_rowspan_arr);
			?>
           
			<div style="width:1100px;">
             <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:auto;text-align:center; font-family:Arial Narrow" rules="all">
            <label style="text-align:center"><b>Size and Color  Breakdown:</b></label>
                <tr style="font-weight:bold">
                	<td width="60">SL.</td>
                    <td width="110">Buyer PO</td>
					<td width="110">Item</td>
                    <td width="120">Color</td>
					   <?
                    foreach ($posize_array as $sizid)
                    {
                        //$size_count=count($sizid);
                        ?>
                            <th width="60"><strong><? echo  $size_library[$sizid];  ?></strong></th>
                        <?
                    }
                    ?>
                    <td  width="80"> Total Order Qty.</td>
					<td  width="60"> Ex.Cut %</td>
					<td  width="80">Plan Cut Qty</td>
                    </tr>
                    <?
					$k=1; $total_qnty=$total_plan_qnty=0;$grd_total_qnty=$grd_total_plan_qnty=0;
                    foreach ($color_size_array as $pokey=>$po_data)
					{
						$m=1;
						foreach ($po_data as $itemkey=>$item_data)
						{
							$n=1;
							foreach ($item_data as $colorkey=>$color_data)
							{
								$po_rowspan=$po_rowspan_arr[$pokey];
								$item_po_rowspan=$po_item_rowspan_arr[$pokey][$itemkey];
								$item_po_rowspan_row=$itempo_rowspan_arr[$itemkey][$colorkey];
								
								$color_number_id=rtrim($po_color_array[$pokey][$itemkey]['color_number_id']);
								$color_ids=explode(",",$color_number_id);
								$color_row=count($color_row);
								//echo $color_row.', ';
							?>
							<tr>
								<?
                                if($m==1)
                                {
									?>
									<td rowspan="<? echo $po_rowspan;?>"><? echo $k;?></td>
									<td rowspan="<? echo $po_rowspan;?>" align="left"><? echo $po_array[$pokey]['po_no']; ?></td>
									<?
                                }
								if($n==1)
                                {
									?>
									<td  rowspan="<? echo $item_po_rowspan;?>" align="left"><? echo $garments_item[$itemkey]; ?></td>
									<?
                                }
                                ?>
								
                                <td align="left"><? echo $color_library[$colorkey]; ?></td>
                                <?
                                $po_size_qty=0;$tot_qnty=array();
                                foreach ($posize_array as $sizval)
                                {
									$size_count=count($sizval);
									$po_size_qty=$po_size_qty_array[$pokey][$colorkey][$sizval]['po_qty'];
									$plan_cut_qnty=$po_size_qty_array[$pokey][$colorkey][$sizval]['plan_cut_qnty'];
									$excess_cut_perc=$po_size_qty_array[$pokey][$colorkey][$sizval]['excess_cut_perc'];
									$tot_excess_cut_per[$pokey][$colorkey]+=$excess_cut_perc;
									?>
									<td align="right"><? echo fn_number_format($po_size_qty,0); ?></td>
									<?
									$tot_qnty[$pokey][$colorkey]+=$po_size_qty;
									$tot_plan_qnty[$pokey][$colorkey]+=$plan_cut_qnty;
									$tot_qnty_size[$sizval]+=$po_size_qty;
									$tot_qnty_item_size[$sizval]+=$po_size_qty;
									$grd_tot_qnty_size[$sizval]+=$po_size_qty;
									$size_tot_qty+=$item_color_size_array[$pokey][$itemkey][$colorkey];
                                }
                               
								//if($n==1)
                                //{
									$tot_excess_cut_per=(($tot_plan_qnty[$pokey][$colorkey]-$tot_qnty[$pokey][$colorkey])/$tot_qnty[$pokey][$colorkey])*100;
									?>
									
									<td align="right" rowspan="<? //echo $item_po_rowspan;?>" ><? echo fn_number_format($tot_qnty[$pokey][$colorkey],0); ?></td>
									<td align="right" rowspan="<? //echo $item_po_rowspan;?>" ><? echo fn_number_format($tot_excess_cut_per,2); ?></td>
									<td align="right" rowspan="<? //echo $item_po_rowspan;?>" ><? echo fn_number_format($tot_plan_qnty[$pokey][$colorkey],0); ?></td>
									<?
                                //}
								?>
                                
							</tr>
							<?
							$total_qnty+=$tot_qnty[$pokey][$colorkey];
							$total_plan_qnty+=$tot_plan_qnty[$pokey][$colorkey];
							$total_item_qnty+=$tot_qnty_item_size[$pokey][$colorkey];
							$grd_total_qnty+=$tot_qnty[$pokey][$colorkey];
							$grd_total_plan_qnty+=$tot_plan_qnty[$pokey][$colorkey];
							$m++;$n++;
							}
							
							?>
							
						  <?
						}
						?>
					 <tr>
						<td colspan="4" align="right"><strong>PO Sub Total :</strong></td>
						<?
						foreach ($posize_array as $sizval)
						{
							?>
							<td align="right"><b><?php echo fn_number_format($tot_qnty_size[$sizval],0);unset($tot_qnty_size[$sizval]); ?></b></td>
							<?
						}
						?>
						<td align="right"><b><?php echo fn_number_format($total_qnty,0);unset($total_qnty); ?></b></td>
						<td align="right"><b><?php //echo fn_number_format($total_qnty,0);unset($total_qnty); ?></b></td>
						<td align="right"><b><?php echo fn_number_format($total_plan_qnty,0);unset($total_plan_qnty); ?></b></td>
					</tr>
						<?
					  $k++;
					}
					?>
                    <tr>
                    <td colspan="4" align="right"><strong>Job Total :</strong></td>
                    <?
					foreach ($posize_array as $sizval)
					{
						?>
						<td align="right"><b><?php echo fn_number_format($grd_tot_qnty_size[$sizval],0); ?></b></td>
						<?
					}
                    ?>
                    <td align="right"><b><?php echo fn_number_format($grd_total_qnty,0); ?></b></td>
					<td align="right"><b><?php //echo fn_number_format($grd_total_qnty,0); ?></b></td>
					<td align="right"><b><?php echo fn_number_format($grd_total_plan_qnty,0); ?></b></td>
                </tr>
               </table>
			   </div>
			   <br/>
			  <br/>  
			  <?
				$condition= new condition();
				 if($txt_po_breack_down_id!='' || $txt_po_breack_down_id!=0)
				 {
					$condition->po_id("in($txt_po_breack_down_id)"); 
				 }
				  if(str_replace("'","",$txt_job_no)!='')
				 {
					$condition->job_no("in('$txt_job_no')");
				 }
				 
				$condition->init();
				$costPerArr=$condition->getCostingPerArr();
				$costPerQty=$costPerArr[$txt_job_no];
				//echo $costPerQty.'DDDDDDD';
				$fabric= new fabric($condition);
				$trims= new trims($condition);
				$emblishment= new emblishment($condition);
				$wash= new wash($condition);
				$fabric_qty_arr=$fabric->getQtyArray_by_FabriccostidAndGmtscolor_knitAndwoven_greyAndfinish();
				
					//($plan_cut_qnty/$total_set_qnty)*($cons_qnty/$costPerQty);
			//	print_r($trims_qty_arr);
				 $nom_sup_cond="";
				 if($supplier_check==1)
				 {
				 	$nom_sup_cond=" and c.fabric_source=2 and (c.nominated_supp is null or c.nominated_supp=0) ";
				 }
				$sql_fab_color="select d.pre_cost_fabric_cost_dtls_id as fab_dtl_id,d.gmts_color_id,d.contrast_color_id from wo_pre_cost_fabric_cost_dtls c,wo_pre_cos_fab_co_color_dtls d
				 where c.job_no=d.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and c.status_active=1 and c.is_deleted=0 and c.job_no='$txt_job_no' $nom_sup_cond ";
				   $fab_result=sql_select($sql_fab_color);
				 foreach($fab_result as $row)
				 {
					$fab_color_arr[$row[csf("fab_dtl_id")]][$row[csf("gmts_color_id")]]=$row[csf("contrast_color_id")];
				 }

				$fabric_supplier= sql_select("SELECT id, job_id, job_no, fabric_id, supplier_id from wo_pre_cost_fabric_supplier where job_no='$txt_job_no' and status_active=1 and is_deleted=0");
			 	foreach ($fabric_supplier as $row) {
			 		$fabric_supplier_arr[$row[csf('fabric_id')]][$row[csf('supplier_id')]]=$supplier_name_arr[$row[csf('supplier_id')]];
			 	}
				
					$sql_fab="select  a.color_number_id as color_id,a.item_number_id  as item_id,b.id as po_id,b.po_quantity,b.po_total_price, b.po_number, b.pub_shipment_date,c.id, c.job_no,c.body_part_id as body_id, c.fab_nature_id as nat_id, c.color_type_id as color_type, c.construction as construction,c.composition,c.fabric_source,c.gsm_weight,c.body_part_id,c.color_size_sensitive,c.width_dia_type, c.avg_cons,c.uom,c.rate, c.amount, c.avg_finish_cons,d.dia_width,d.requirment,d.cons,c.remarks from wo_po_color_size_breakdown a, wo_po_break_down b,wo_pre_cost_fabric_cost_dtls c,wo_pre_cos_fab_co_avg_con_dtls d  where a.job_no_mst=b.job_no_mst and  c.job_no=a.job_no_mst and  a.po_break_down_id=b.id and c.job_no=a.job_no_mst and d.pre_cost_fabric_cost_dtls_id=c.id and d.po_break_down_id=a.po_break_down_id and d.po_break_down_id=b.id and d.color_size_table_id=a.id and d.job_no=b.job_no_mst and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and b.job_no_mst='$txt_job_no' and d.cons>0 $txt_po_breack_down_id_cond  $nom_sup_cond  order  by a.item_number_id,c.body_part_id ";
				  //echo $sql_fab;
				  $sql_fabs_result=sql_select($sql_fab);
				  $fabric_detail_arr=array();  $fabric_job_check_arr=array();
				$total_purchase_amt=0;
					foreach($sql_fabs_result as $row)
					{
						$color_size_sensitive=$row[csf("color_size_sensitive")];
						if($color_size_sensitive==3)
						{
							if($fab_color_arr[$row[csf("id")]][$row[csf("color_id")]]!='')
							{
								$fab_color_id=$fab_color_arr[$row[csf("id")]][$row[csf("color_id")]];
							}
						}
						else  $fab_color_id=$row[csf("color_id")];
						$supplier_ids=$fabric_supplier_arr[$row[csf('id')]][$row[csf('supplier_id')]];
						
						$fab_des=$row[csf("construction")].', '.$row[csf("composition")];
						$item_desc= $fab_des.",".$row[csf("gsm_weight")].",".$row[csf("dia_width")].",".$fabric_typee[$row[csf("width_dia_type")]].",".$color_type[$row[csf("color_type")]];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['gmt_color'].=$row[csf("color_id")].',';
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['uom']=$row[csf("uom")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['item_id']=$row[csf("item_id")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['body_id']=$row[csf("body_id")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['nat_id']=$row[csf("nat_id")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['fabric_source']=$row[csf("fabric_source")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['remarks']=$row[csf("remarks")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['item_desc']=$item_desc;
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['fin_cons']+=$row[csf("cons")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['consRow']+=1;
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['amount']+=$row[csf("amount")];
						$fabric_detail_color_arr[$row[csf("id")]][$fab_color_id]['supplier']=implode(",", $fabric_supplier_arr[$row[csf('id')]]);
					}
				//echo '<pre>';print_r($fabric_detail_color_arr);die;
				

			if(count($fabric_detail_color_arr)>0){
				?>


            <table id="table_header_1" class="rpt_table" width="1110" cellpadding="0" cellspacing="0" border="1" rules="all">
           				<caption> <b style="float:left">Fabric Details :</b></caption>
					<thead>
                    	<th width="30">SL</th>
						<th width="120">Item</th>
						<th width="220">Use for</th>
						<th width="200">Item. Desc</th>
						<th width="100">Supplier</th>
						<th width="100">Gmt Color</th>
						<th width="100">Item Color</th>
					    <th width="50">UOM</th> 
						<th width="90">Fin. Cons</th>
						<th width="90">Total Fin Cons. </th>
                    </thead>
            </table>
			<table class="rpt_table"   width="1110" cellpadding="0" cellspacing="0" border="1" rules="all" id="table_body1">
            
			<?
					
				 // print($fabric_detail_arr);
					$item_rowspan_arr=array();$fab_rowspan_arr=array();
					
					foreach($fabric_detail_color_arr as $fab_dtls_id_key=>$fab_dtls_data)
					{
						 $fab_body_rowspan=0;
						  foreach($fab_dtls_data as $fab_color_key=>$val)
						  {
							$fab_body_rowspan++;
						  }
						$fab_rowspan_arr[$fab_dtls_id_key]=$fab_body_rowspan;
					 }
					//print_r($fab_rowspan_arr);
				
					$i=$m=1;$total_greycons=$total_tot_greycons=$total_tot_fin_cons=$grand_total_fin_cons=$grand_total_tot_greycons=$grand_total_amount=0;
					
						foreach($fabric_detail_color_arr as $fab_dtls_id_key=>$fab_dtls_data)
						{
					  		$y=1;
							foreach($fab_dtls_data as $fab_color_key=>$val)
							{
						
								if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
							
								$uom_key=$val['uom'];
								$body_key=$val['body_id'];
								$item_key=$val['item_id'];
								$desc_key=$val['item_desc'];
								$remarks=$val['remarks'];
								$nat_key=$val['nat_id'];$fab_source_key=$val['fabric_source'];
								$gmt_color=rtrim($val['gmt_color'],',');
								$gmt_colorid=array_unique(explode(",",$gmt_color));
								$gmt_color="";
								$wv_fincons=$fincons_knit=$tot_amount=0;
								foreach($gmt_colorid as $gid)
								{
									if($gmt_color=="") $gmt_color=$color_library[$gid];else $gmt_color.=",".$color_library[$gid];
									
									$fincons_knit+=$fabric_qty_arr['knit']['finish'][$fab_dtls_id_key][$gid][$uom_key];
									$wv_fincons+=$fabric_qty_arr['woven']['finish'][$fab_dtls_id_key][$gid][$uom_key];
								}
								$tot_fin_qty=$fincons_knit+$wv_fincons;
					?>
                    
						<tr bgcolor="<? echo $bgcolor;?>" onClick="change_color('tr_<? echo $i; ?>','<? echo $bgcolor;?>')" id="tr_<? echo $i; ?>">  <?
                      	 if($y==1){
						?>
							<td width="30" rowspan="<? echo $fab_rowspan_arr[$fab_dtls_id_key]?>"><? echo $m; ?></td>
							<td width="120" rowspan="<? echo $fab_rowspan_arr[$fab_dtls_id_key];;?>" align="center"><div style="word-break:break-all"><? echo $body_part[$body_key]; ?></div></td>
                             <?
							 }
							
							?>
							<td width="220" align="center" ><div style="word-break:break-all"><? echo $remarks; ?></div></td>
							<td width="200" align="center" ><div style="word-break:break-all"><? echo $desc_key; ?></div></td>
							<td width="100" align="center" ><div style="word-break:break-all"><? echo $val['supplier']; ?></div></td>
                            <td width="100"  align="center"><div style="word-break:break-all"><? echo $gmt_color; ?></div></td>
                            <td width="100"  align="center"><div style="word-break:break-all"><? echo $color_library[$fab_color_key]; ?></div></td>
							<td width="50" align="center"><? echo $unit_of_measurement[$val['uom']]; ?></td>
							<td width="90"  align="right">
                            <div style="word-break:break-all">
							<?
							
							 echo fn_number_format($val['fin_cons']/$val['consRow'],4); 
							 ?>
                            </div>
                            </td>
                            <td width="90"  align="right"><div style="word-break:break-all"><? echo fn_number_format($tot_fin_qty,4); ?></div></td>
                            </tr>
                            <?
								$total_fin_cons+=$tot_fin_qty;
								$total_tot_fin_cons+=$val['fin_cons'];
								$grand_total_fin_cons+=$tot_fin_qty;
							
									$y++;
									$i++;
									}
								$m++;
							?>
                            <?
														
						}
							?>
                            <tfoot>
                            <tr>
                            <th colspan="8" ><strong>Grand Total</strong> </th>
                          
                            <th align="right"><strong><? //echo fn_number_format($total_tot_fin_cons,4);?></strong> </th>
                            <th align="right"><strong><? echo fn_number_format($grand_total_fin_cons,4);?></strong> </th>
                            </tr>
                            </tfoot>
                    </table>
					<br/>  	
					<?
			}
					$item_group_arr=return_library_array( "select item_name,id from lib_item_group where item_category=4 order by item_name", "id", "item_name");
					$supplier_library=return_library_array( "select a.supplier_name,a.id from  lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id  and a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
					$lib_item_group_arr=return_library_array( "select item_name,id from lib_item_group where item_category=4 order by item_name", "id", "item_name");
					$trims_qty_arr=$trims->getQtyArray_by_jobItemidDescriptionGmtcolorAndSizeid();
					$trims_item_qty_arr=$trims->getQtyArray_by_jobAndItemid();
					$trims_desc_qty_arr=$trims->getQtyArray_by_jobItemidAndDescription(); 
					
					$trims_dtl_qty_arr=$trims->getQtyArray_by_OrderPrecostdtlsidGmtscolorAndGmtssize();
					//print_r($trims_amt_arr);

				 $nom_sup_cond="";
				 if($supplier_check==1)
				 {
				 	$nom_sup_cond=" and ( c.nominated_supp_multi is null or c.nominated_supp_multi='' or c.nominated_supp_multi=0)";
				 }

				 $sql_trim_color="select c.id,c.job_no,c.trim_group,c.description,c.brand_sup_ref,c.nominated_supp_multi as nominated_supp,c.cons_uom,c.remark,d.wo_pre_cost_trim_cost_dtls_id as fab_dtl_id,d.item_size,d.color_number_id,d.item_number_id,d.size_number_id,d.po_break_down_id as po_id,d.excess_per,d.cons,d.tot_cons,c.source_id,c.item_print from wo_pre_cost_trim_cost_dtls c,wo_pre_cost_trim_co_cons_dtls d
				 where c.job_no=d.job_no and d.wo_pre_cost_trim_cost_dtls_id=c.id and c.status_active=1 and c.is_deleted=0 and d.cons>0 and c.job_no='$txt_job_no' $txt_po_breack_down_id_cond2 $nom_sup_cond order by c.id,c.trim_group";
				 //echo  $sql_trim_color;
				 $trim_result=sql_select($sql_trim_color);$tot_trim_req_qty=0;
				 foreach($trim_result as $row)
				 {
					if($excess_per_val>0)
					{
						$total_set_qnty=$job_total_set_qnty_arr[$row[csf('job_no')]];
						$order_quantity=$po_color_qty_array[$row[csf("po_id")]][$row[csf("color_number_id")]]['order_quantity'];
						//echo $plan_cut_qnty.'<br/>';
						$tot_cons_qnty=$row[csf("tot_cons")]+($row[csf("tot_cons")]*$excess_per_val)/100;
						$trim_req_qty=($order_quantity/$total_set_qnty)*($tot_cons_qnty/$costPerQty);
						$excess_per=$excess_per_val;
						//echo $trim_req_qty.'='.$excess_per_val.', ';
						//$tot_trim_req_qty+=$trim_req_qty;
					}
					else
					{
						$excess_per=0;
						$excess_per=$row[csf("excess_per")];
						$tot_cons_qnty=$row[csf("cons")];
						//$trim_req_qty=$trims_qty_arr[$row[csf("job_no")]][$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]];
						$trim_req_qty=$trims_dtl_qty_arr[$row[csf("po_id")]][$row[csf("id")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]];
					}
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['item_print']=$row[csf("item_print")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['description']=$row[csf("description")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['nominated_supp']=$row[csf("nominated_supp")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['size_number_id']=$row[csf("size_number_id")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['job_no']=$row[csf("job_no")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['item_size']=$row[csf("item_size")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['remark']=$row[csf("remark")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['cons_uom']=$row[csf("cons_uom")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['cons']=$row[csf("tot_cons")];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['source_id']=$row[csf("source_id")];

					//$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['tot_size_cons']+=$trims_qty_arr[$row[csf("job_no")]][$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]];
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['tot_size_cons']+=$trim_req_qty;
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['tot_cons']=$tot_cons_qnty;
					$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['excess_per']=$excess_per;
					$item_tot_qty_arr[$row[csf("trim_group")]][$row[csf("description")]]+=$trim_req_qty;
					
				 }
				 
				// echo $tot_trim_req_qty.', ';
				  	foreach($trims_color_arr as $trim_key=>$trim_data)
					 {
						  $trim_color_rowspan=0;
						   foreach($trim_data as $desc_key=>$desc_data)
					 	   {
						   $trim_desc_rowspan=0;
						    foreach($desc_data as $gmt_color_key=>$color_data)
					 	    {
								$item_size_rowspan=0;
								foreach($color_data as $size_key=>$val)
								{
									$item_size_rowspan++;
									$trim_desc_rowspan++;
									$trim_color_rowspan++;
									$color_qty[$trim_key][$desc_key][$gmt_color_key]+=$val['tot_size_cons'];
									$trim_color_rowspan_arr[$trim_key][$desc_key][$gmt_color_key]+=1;
								}
								$item_size_rowspan_arr[$trim_key][$desc_key][$gmt_color_key]=$item_size_rowspan;
								$trim_desc_rowspan_arr[$trim_key][$desc_key]=$trim_desc_rowspan;
								$trim_size_rowspan_arr[$trim_key]=$trim_color_rowspan;
								
							}
						   }
					}
				 	//print_r($trim_size_rowspan_arr);
					?>
           		 <table id="table_header_1" class="rpt_table" width="1120" cellpadding="0" cellspacing="0" border="1" rules="all">
           			<!-- <caption> <b style="float:left">Trims Details:</b></caption> -->
					<!-- <thead>
                    	<th width="30">SL</th>
                        <th width="100">Item</th>
						<th width="180">Use For</th>
						<th width="120">Item Desc</th>
						<th width="100">Supplier</th>
						<th width="80">Gmt Color</th>
						<th width="75">Item Size</th>
						<th width="80">Item Color</th>
					    <th width="50">UOM</th> 
						<th width="80">Cons</th>
						<th width="80">Exs %</th>
						<th width="80">Total Cons. </th>
						<th width="80">Total Qty </th>
						<th width="80">Color Total Qty.</th>
						<th width="80">Item Total Qty.</th>
                      
                    </thead> -->
					<tbody>
					 <?

					 	$supplier_library_fabric=return_library_array( "select a.id, a.supplier_name from lib_supplier a where a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
							
						 $j=1;$total_trim_cons=$total_tot_trim_cons_qty=$total_tot_item_qty_cons=$total_trim_qty_cons=0;
						 foreach($trims_color_arrar as $trim_key=>$trim_data)
					 	 {
						   $k=1;
						   foreach($trim_data as $desc_key=>$desc_data)
					 	   {
						    $n=1;
						    foreach($desc_data as $gmt_color_key=>$color_data)
					 	    {
						    $m=1;$c=1;
						    foreach($color_data as $size_key=>$val)
					 	    {
								if($j%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
								if($col_size_cons_arr[$trim_key][$gmt_color_key]>0)
								{
								$tot_size_qty=$col_size_cons_arr[$trim_key][$gmt_color_key];
								}
								if($item_tot_cons_arr[$trim_key]>0)
								{
								$item_tot_size_qty=$item_tot_cons_arr[$trim_key];
								}
								$job_no=$val['job_no'];
								$item_size=$val['item_size'];
								$tot_size_cons=$val['tot_size_cons'];
								
								$gmt_item_desc_qty=$item_tot_qty_arr[$trim_key][$desc_key];//$trims_desc_qty_arr[$job_no][$trim_key][$desc_key];
								//$gmt_item_desc_qty=$trims_item_qty_arr[$job_no][$trim_key];
								$gmt_size_qty=$tot_size_cons;//$trims_qty_arr[$job_no][$trim_key][$desc_key][$gmt_color_key][$size_key];
								//$item_tot_qty=$item_tot_qty_arr[$trim_key][$desc_key];
							
								
								$nominated_supp_str="";
								$exsupp=explode(",",$val["nominated_supp"]);
								foreach($exsupp as $sid)
								{
									if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_fabric[$sid]; else $nominated_supp_str.=','.$supplier_library_fabric[$sid];
								}  
								
								
					?>
						
						<tr bgcolor="<? echo $bgcolor;?>" onClick="change_color('tr_<? echo $j; ?>','<? echo $bgcolor;?>')" id="tr_<? echo $j; ?>">  <?
                      	if($k==1){ ?>
							<td width="30" rowspan="<? echo $trim_size_rowspan_arr[$trim_key]?>"><? echo $j; ?></td>
							<td width="100" rowspan="<?  echo $trim_size_rowspan_arr[$trim_key];?>"><? echo $item_group_arr[$trim_key]; ?></td> 
						<? } if($n==1){ ?>
							<td width="180" rowspan="<? echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>" align="center"><div style="word-break:break-all"><? echo $val['remark']; ?></div></td> 
							<td width="120" rowspan="<? echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>"><? echo  $desc_key; ?></td> 
							<td width="100" rowspan="<? echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>" align="center" ><div style="word-break:break-all"><?=$nominated_supp_str; ?></div></td>
                        <? } if($m==1){ ?>
                            <td width="80" rowspan="<? echo $item_size_rowspan_arr[$trim_key][$desc_key][$gmt_color_key];?>"  align="center"><div style="word-break:break-all"><? echo $color_library[$gmt_color_key]; ?></div></td>
						<? } ?>
                            <td width="75" title="<?//=$size_key?>"  align="center"><div style="word-break:break-all">
							<? if($val['item_print']==1){
									echo "";
								}else{
									echo $size_key;
								} ?>
							</div></td>
							<td width="80" title="<?//=$color_library[$gmt_color_key]?>"  align="center"><div style="word-break:break-all"><? if($val['item_print']==2){
									echo "";
								}else{
									echo $color_library[$gmt_color_key];
								} ?></div></td>
							<td width="50" align="center"><? echo $unit_of_measurement[$val['cons_uom']]; ?></td>
							<td width="80"  align="center"><div style="word-break:break-all"><? echo fn_number_format($val['cons'],4); ?></div></td>
                            <td width="80"  align="right" title="<? echo $val['excess_per']; ?>"><div style="word-break:break-all"><? echo fn_number_format($val['excess_per'],4);//echo fn_number_format($val['excess_per'],4); ?></div></td>
							<td width="80"  align="right"><div style="word-break:break-all"><? echo fn_number_format($val['tot_cons'],4); ?></div></td>
							<td width="80"  align="right"><div style="word-break:break-all"><? echo fn_number_format($gmt_size_qty,2); ?></div></td>
						<? if($c==1){ ?>
                            <td width="80"   align="center" rowspan="<?=$trim_color_rowspan_arr[$trim_key][$desc_key][$gmt_color_key];?>"><div style="word-break:break-all"><? echo  fn_number_format($color_qty[$trim_key][$desc_key][$gmt_color_key],2); ?></div></td>
						<? $c++;}
						if($n==1){ 
							 $total_tot_item_qty_cons+=$gmt_item_desc_qty;
						?>
                            <td width="80" rowspan="<? echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>"  align="center"><div style="word-break:break-all"><? echo  fn_number_format($gmt_item_desc_qty,2); ?></div></td>
						<? } ?>
							
                       </tr>
					   <?
					   		$total_tot_trim_cons_qty+=$val['cons'];
							$total_trim_cons+=$val['tot_cons'];
							$total_trim_qty_cons+=$gmt_size_qty;
							$k++;$m++;$n++;
					   	}
						}
							
					}
					$j++;
				}
					   ?>
						<tfoot>
						<tr>
							<!-- <th colspan="8" align="right"> Grand Total </th>
							<th align="right"> </th>
							<th align="right"> <? //echo fn_number_format($total_tot_trim_cons_qty,4); ?> </th>
							
							<th align="right"> <? //echo fn_number_format($total_tot_trim_qty,4); ?> </th>
							<th> <? //echo fn_number_format($total_trim_cons,4); ?> </th>
							<th align="right"> <? //echo fn_number_format($total_trim_qty_cons,2); ?> </th>
							<th align="right"> </th>
							<th align="right"> <? //echo fn_number_format($total_tot_item_qty_cons,2); ?> </th> -->
						</tr>
						</tfoot>
					</tbody>
            </table>
			<?
			$nom_sup_cond="";
			if($supplier_check==1)
			{
				$nom_sup_cond=" and ( a.nominated_supp_multi is null or a.nominated_supp_multi='' or a.nominated_supp_multi=0)";
			}
			$sqlTrims=sql_select("SELECT a.id as trim_id, a.nominated_supp_multi, a.job_no, a.trim_group, a.description, a.brand_sup_ref, a.apvl_req, a.remark, a.source_id, a.item_print, a.cons_uom, a.country, b.po_break_down_id, b.item_number_id, b.color_number_id as gmts_color, b.item_color_number_id as item_color, b.size_number_id, b.item_size, b.cons, b.tot_cons, b.place, b.ex_cons, b.item_ref, b.excess_per, c.trim_type from wo_pre_cost_trim_cost_dtls a join wo_pre_cost_trim_co_cons_dtls b on a.id=b.wo_pre_cost_trim_cost_dtls_id join lib_item_group c on c.id=a.trim_group where a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.job_no='$txt_job_no' $txt_po_breack_down_id_cond2  $nom_sup_cond and b.tot_cons>0 order by a.id ASC");


	$master_attr=array('item_number_id','trim_type','trim_group','description','brand_sup_ref','apvl_req','remark','source_id','item_print','cons_uom','country','nominated_supp_multi');
	foreach($sqlTrims as $row){
		$poQty=$set_item_ratio=$rowReqQtyPcs=$rowReqQtyExPcs=0;
		$set_item_ratio=$gmtsitem_ratio_array[$row[csf('job_no')]][$row[csf('item_number_id')]];
		$item_number[$row[csf('trim_id')]][$garments_item[$row[csf('item_number_id')]]]= $garments_item[$row[csf('item_number_id')]];
		if($excess_per_val>0)
					{
						$total_set_qnty=$job_total_set_qnty_arr[$row[csf('job_no')]];
						$order_quantity=$po_color_qty_array[$row[csf("po_break_down_id")]][$row[csf("color_number_id")]]['order_quantity'];
						//echo $plan_cut_qnty.'<br/>';
						$tot_cons_qnty=$row[csf("tot_cons")]+($row[csf("tot_cons")]*$excess_per_val)/100;
						$trim_req_qty=($order_quantity/$total_set_qnty)*($tot_cons_qnty/$costPerQty);
						$excess_per=$excess_per_val;
						
						//$tot_trim_req_qty+=$trim_req_qty;
					}
					else
					{
						$excess_per=0;
						$excess_per=$row[csf("excess_per")];
						$tot_cons_qnty=$row[csf("cons")];
						//$trim_req_qty=$trims_qty_arr[$row[csf("job_no")]][$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]];
						$trim_req_qty=$trims_dtl_qty_arr[$row[csf("po_break_down_id")]][$row[csf("trim_id")]][$row[csf("gmts_color")]][$row[csf("size_number_id")]];
						//echo $trim_req_qty.'='.$excess_per_val.', ';
					}
	
		if($row[csf('country')]!="")
		{
			$excountry=explode(",",$row[csf('country')]);
			foreach($excountry as $ctid)
			{
				$poQty+=$poCountryItemColorSizeArr[$row[csf("po_break_down_id")]][$ctid][$row[csf("item_number_id")]][$row[csf("gmts_color")]][$row[csf("size_number_id")]]['poqty'];
			}
		}
		else
		{
				$poQty=$poItemColorSizeArr[$row[csf("po_break_down_id")]][$row[csf("item_number_id")]][$row[csf("gmts_color")]][$row[csf("size_number_id")]]['poqty'];
		}	
		
		$rowReqQtyPcs=($poQty/$set_item_ratio)*(number_format($row[csf("tot_cons")],4,".","")/$costPerQty);
		$rowReqQtyExPcs=($poQty/$set_item_ratio)*($row[csf("cons")]/$costPerQty);
		if(($row[csf("item_color")]*1)==0) $row[csf("item_color")]=$row[csf("gmts_color")];
		if($row[csf("item_size")]=='0' || $row[csf("item_size")]=="") $row[csf("item_size")]=$sizeArr[$row[csf("size_number_id")]];
		if($row[csf("ex_cons")]>0) $rowReqQtyExPcs=$rowReqQtyExPcs;else $rowReqQtyExPcs=$rowReqQtyPcs;
		foreach($master_attr as $attr){
			$trimitem_data[$row[csf('trim_id')]][$attr]=$row[csf($attr)];
		}		
		if($row[csf('item_print')]==1){//Color Wise
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][$row[csf("item_color")]][0]['nominated_supplier']=$row[csf('nominated_supp_multi')];
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][$row[csf("item_color")]][0]['uom']=$row[csf('cons_uom')];
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][$row[csf("item_color")]][0]['item_ref']=$row[csf('item_ref')];
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][$row[csf("item_color")]][0]['req']+=$rowReqQtyPcs;
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][$row[csf("item_color")]][0]['reqex']+=$rowReqQtyExPcs;
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][$row[csf("item_color")]][0]['po']+=$poQty;
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][$row[csf("item_color")]][0]['tot_cons']=$row[csf('tot_cons')];
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][$row[csf("item_color")]][0]['cons']=$row[csf('cons')];
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][$row[csf("item_color")]][0]['excess_per']=$row[csf('excess_per')];
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][$row[csf("item_color")]][0]['tot_consumption']+=$trim_req_qty;
			$trimitem_datas[$row[csf('trim_id')]]['itemprint'][$row[csf("item_color")]]['tot_size_cons']+=$trim_req_qty;
			$item_tot_qty_array[$row[csf('trim_id')]]['total_consumption']+=$trim_req_qty;
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][$row[csf("item_color")]][0]['gmts_color'][$row[csf("gmts_color")]]=$color_library[$row[csf("gmts_color")]];
			
		}
		else if($row[csf('item_print')]==2){//Size Wise
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][0][$row[csf("item_size")]]['uom']=$row[csf('cons_uom')];
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][0][$row[csf("item_size")]]['nominated_supplier']=$row[csf('nominated_supp_multi')];
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][0][$row[csf("item_size")]]['item_ref']=$row[csf('item_ref')];
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][0][$row[csf("item_size")]]['req']+=$rowReqQtyPcs;
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][0][$row[csf("item_size")]]['reqex']+=$rowReqQtyExPcs;
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][0][$row[csf("item_size")]]['po']+=$poQty;
			$trimitem_datas[$row[csf('trim_id')]]['itemprint'][0]['tot_size_cons']+=$trim_req_qty;
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][0][$row[csf("item_size")]]['tot_cons']=$row[csf('tot_cons')];
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][0][$row[csf("item_size")]]['gmts_color'].=$color_library[$row[csf('gmts_color')]].',';
			$item_tot_qty_array[$row[csf('trim_id')]]['total_consumption']+=$trim_req_qty;
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][0][$row[csf("item_size")]]['cons']=$row[csf('cons')];
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][0][$row[csf("item_size")]]['excess_per']=$row[csf('excess_per')];
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][0][$row[csf("item_size")]]['tot_consumption']+=$trim_req_qty;
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][0][$row[csf("item_size")]]['size_number_id'][$row[csf("size_number_id")]]=$size_library[$row[csf('size_number_id')]];
		}
		else if($row[csf("item_print")]==3)//color Size Wise
		{
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][$row[csf("item_color")]][$row[csf("item_size")]]['uom']=$row[csf('cons_uom')];
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][$row[csf("item_color")]][$row[csf("item_size")]]['item_ref']=$row[csf('item_ref')];
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][$row[csf("item_color")]][$row[csf("item_size")]]['nominated_supplier']=$row[csf('nominated_supp_multi')];
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][$row[csf("item_color")]][$row[csf("item_size")]]['req']+=$rowReqQtyPcs;
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][$row[csf("item_color")]][$row[csf("item_size")]]['reqex']+=$rowReqQtyExPcs;
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][$row[csf("item_color")]][$row[csf("item_size")]]['po']+=$poQty;
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][$row[csf("item_color")]][$row[csf("item_size")]]['tot_cons']=$row[csf('tot_cons')];
			$item_tot_qty_array[$row[csf('trim_id')]]['total_consumption']+=$trim_req_qty;
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][$row[csf("item_color")]][$row[csf("item_size")]]['cons']=$row[csf('cons')];
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][$row[csf("item_color")]][$row[csf("item_size")]]['excess_per']=$row[csf('excess_per')];
			$trimitem_datas[$row[csf('trim_id')]]['itemprint'][$row[csf("item_color")]]['tot_size_cons']+=$trim_req_qty;
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][$row[csf("item_color")]][$row[csf("item_size")]]['tot_consumption']+=$trim_req_qty;
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][$row[csf("item_color")]][$row[csf("item_size")]]['size_number_id'][$row[csf("size_number_id")]]=$size_library[$row[csf('size_number_id')]];
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][$row[csf("item_color")]][$row[csf("item_size")]]['gmts_color'][$row[csf("gmts_color")]]=$color_library[$row[csf('gmts_color')]];
		}
		else
		{
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][0][0]['uom']=$row[csf('cons_uom')];
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][0][0]['nominated_supplier']=$row[csf('nominated_supp_multi')];
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][0][0]['item_ref']=$row[csf('item_ref')];
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][0][0]['req']+=$rowReqQtyPcs;
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][0][0]['reqex']+=$rowReqQtyExPcs;
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][0][0]['po']+=$poQty;
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][0][0]['tot_consumption']+=$trim_req_qty;
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][0][0]['tot_cons']=$row[csf('tot_cons')];
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][0][0]['cons']=$row[csf('cons')];
			$trimitem_data[$row[csf('trim_id')]]['itemprint'][0][0]['excess_per']=$row[csf('excess_per')];
		}
		  
		
	}
	 /* echo '<pre>';
	print_r($trimitem_data);die;   */ 


	$trim_size_rowspan_arr=array();$$trim_color_rowspan_arr=array();
	foreach($trimitem_data as $trimid=>$trimdtls)
	{
		$trim_ids_rowspan=0;
		foreach($trimdtls['itemprint'] as $trimcolor_id=>$colordata)
		{
			$trim_color_rowspan=0; if($trimcolor_id==0) $trimcolor_id='';
			$color_qty[$trimid][$trimcolor_id]+=$colordata['tot_size_cons'];
 			foreach($colordata as $itemsize_id=>$sizeDara)
			{
				
					$item_size_rowspan++;
					$trim_color_rowspan++;
					$trim_ids_rowspan++;
					
					//$trim_color_rowspan_arr[$trimid][$trimcolor_id][$itemsize_id]+=1;
			
				
				
			}
				$trim_color_rowspan_arr[$trimid][$trimcolor_id]=$trim_color_rowspan;
				$trim_size_rowspan_arr[$trimid]=$trim_ids_rowspan;
		}
	} 
	?>
	<table id="trim_item_dtls" class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:100%; margin-top:20px" rules="all">
		<thead>
			<tr>
				<th colspan="16"><b>Trims Details:</b></th>
			</tr>
			<tr>
				<th width="30">SL</th>
				<th width="80">Group</th>
				<th width="80">Use For</th>
				<th width="80">Item Desc</th>
				<th width="80">Supplier</th>
				<th width="80">Item Print</th>
				<th width="80">Gmt Color</th>
				<th width="80">Item Color</th>
				<th width="80">Item Size</th>
				<th width="80">Cons UOM</th>
				<th width="80">Cons /Unit Gmts</th>
				<th width="80">Ex. %</th>
				<th width="80">Tot. Cons</th>
				<th width="80">Item Qty</th>
				<th width="80">Color Total Qty.</th>
				<th width="80">Item Total Qty.</th>
			</tr>
		</thead>
		<tbody>
		<?
		$i=1;$total_trim_cons=$total_tot_trim_cons_qty=$total_tot_item_qty_cons=$total_trim_qty_cons=0;
		foreach($trimitem_data as $trimid=>$trimdata){	
			$z=1;
			foreach($trimdata['itemprint'] as $colorid=>$color_data){
				$k=1;$c=1;$d=1;if($colorid==0) $colorid='';
				foreach($color_data as $sizeid=>$size_data){ 
					$gmt_item_desc_qty=$item_tot_qty_array[$trimid]['total_consumption'];
					$nominated_supp_str="";
								$exsupp=explode(",",$size_data["nominated_supplier"]);
								foreach($exsupp as $sid)
								{
									if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_fabric[$sid]; else $nominated_supp_str.=','.$supplier_library_fabric[$sid];
								} 
			?>
			<tr>
			<?
                      	if($z==1){ ?> 
				<td rowspan="<? echo $trim_size_rowspan_arr[$trimid]?>"><?= $i ?></td>
				<td rowspan="<? echo $trim_size_rowspan_arr[$trimid]?>"><?= $lib_item_group_arr[$trimdata['trim_group']] ?></td>
				<td rowspan="<? echo $trim_size_rowspan_arr[$trimid]?>"><?= $trimdata['remark'] ?></td>
				<td rowspan="<? echo $trim_size_rowspan_arr[$trimid]?>"><?= $trimdata['description'] ?></td>
				<td rowspan="<? echo $trim_size_rowspan_arr[$trimid]?>"><?= $nominated_supp_str ?></td>
				<td rowspan="<? echo $trim_size_rowspan_arr[$trimid]?>"><?= $itemPrintArr[$trimdata['item_print']] ?></td>
				<? } ?>
						<? if($trimdata['item_print']==2 || $trimdata['item_print']==0){ ?>
							<td><?= implode(",",array_filter(array_unique(explode(",",$size_data['gmts_color']))));?></td>
							<td></td>
						<? } else if($trimdata['item_print']==1){ ?>
							<td><?= implode(",", $size_data['gmts_color'])?></td>
							<td><?= $color_library[$colorid] ?></td>
						<? } else{ ?>
							<td><?= implode(",", $size_data['gmts_color'])?></td>
							<td><?= $color_library[$colorid] ?></td>
						<? }?>
						<td><?= $sizeid ?></td>
						<td><?= $unit_of_measurement[$size_data['uom']]; ?></td>
						<td><?=fn_number_format($size_data['tot_cons'],4,".","");$total_tot_trim_cons_qty+=$size_data['tot_cons'];  ?></td>
						<td><?=fn_number_format($size_data['excess_per'],4,".","")  ?></td>
						<td><?=fn_number_format($size_data['cons'],4,".","");$total_trim_cons+=$size_data['cons'];  ?></td>
						<td><?=fn_number_format($size_data['tot_consumption'],2,".","");$total_trim_qty_cons+=$size_data['tot_consumption']; ?></td>
						<td><?=fn_number_format($size_data['tot_consumption'],2,".",""); ?></td>
					<!-- 	<? //if($c==1){ ?> 
						<td  rowspan="<? //echo $trim_color_rowspan_arr[$trimid][$trimcolor_id]?>"><? //echo  fn_number_format($color_qty[$trimid][$colorid],2); ?></td> -->
						<!-- <? //}if($z==1){ ?>  -->
							<? if($z==1){ ?> 
							<td  rowspan="<? echo $trim_size_rowspan_arr[$trimid]?>"><?=fn_number_format($gmt_item_desc_qty,2,".","");$total_tot_item_qty_cons+=$gmt_item_desc_qty; ?></td>
						<? }
						$k++;	
						$z++;
						$c++;
						
						//$d++;
					} 
					
					?>
					<?
			 }  ?>

			</tr>
			<? 
			$i++;//$zz++;
		} ?>
		</tbody>
		<tfoot>
						<tr>
							<th colspan="9" align="right"> Grand Total </th>
							<th align="right"> </th>
							<th align="right"> <? echo fn_number_format($total_tot_trim_cons_qty,4); ?> </th>
							
							<th align="right"> <? //echo fn_number_format($total_tot_trim_qty,4); ?> </th>
							<th> <? echo fn_number_format($total_trim_cons,4); ?> </th>
							<th align="right"> <? echo fn_number_format($total_trim_qty_cons,2); ?> </th>
							<th align="right"> </th>
							<th align="right"> <? echo fn_number_format($total_tot_item_qty_cons,2); ?> </th>
						</tr>
						</tfoot>
	</table>
			
		</div>
		<br>
		<? echo signature_table(218, $cbo_company_name, "950px"); ?>
	</div>
	<?
	$user_id=$_SESSION['logic_erp']['user_id'];
	$report_cat=100;
	$html = ob_get_contents();ob_clean();
		foreach (glob("pre*.xls") as $filename) {
		@unlink($filename);
		}
		$name=time();
		$filename="pre".$user_id."_".$name.".xls";
		$create_new_doc = fopen($filename, 'w');
		$is_created = fwrite($create_new_doc, $html);
		echo "$filename####$html####$report_cat";
	exit();	
}

if($action=="preCostRpt")//bom page is not used
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";
	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($db_type==0){
	   $costing_date=change_date_format($txt_costing_date, "yyyy-mm-dd", "-");
	}
	if($db_type==2){
		$costing_date=change_date_format($txt_costing_date, "yyyy-mm-dd", "-",1)	;
	}
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and b.costing_date='".$txt_costing_date."'";
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");

	if($db_type==0){
		$sqlcpm=sql_select("select cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and '$costing_date' between applying_period_date and applying_period_to_date  and status_active=1 and is_deleted=0 LIMIT 1");
	}
	if($db_type==2){
		 $sqlcpm=sql_select("select cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and '$costing_date' between applying_period_date and applying_period_to_date and status_active=1 and is_deleted=0");

	}

	$cpm='';
	foreach($sqlcpm as $sqlcpmrow){
		$cpm=$sqlcpmrow[csf('cost_per_minute')];
	}
	if($db_type==0) $group_gsm="group_concat( distinct b.gsm_weight) AS gsm_weight";
	if($db_type==2) $group_gsm="listagg(b.gsm_weight ,',') within group (order by b.gsm_weight) AS gsm_weight";

	$gsm_weight_top=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and a.body_part_type=1 and b.status_active=1 and b.is_deleted=0","gsm_weight");
	$gsm_weight_bottom=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and a.body_part_type=20 and b.status_active=1 and b.is_deleted=0","gsm_weight");

	//echo $gsm_weight_top.'='.$gsm_weight_bottom;
	// $gsm_weight_top=return_field_value("gsm_weight", "wo_pre_cost_fabric_cost_dtls", "job_no=$txt_job_no and body_part_id=1");
	// $gsm_weight_bottom=return_field_value("gsm_weight", "wo_pre_cost_fabric_cost_dtls", "job_no=$txt_job_no and body_part_id=20");
	 $po_qty=0;
	 $po_plun_cut_qty=0;
	 $total_set_qnty=0;
	 $sql_po="select a.job_no,a.total_set_qnty,b.id,c.item_number_id,c.country_id,c.color_number_id,c.size_number_id,c.order_quantity ,c.plan_cut_qnty  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst   and b.id=c.po_break_down_id  and a.job_no =".$txt_job_no."   and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 order by b.id";
	$sql_po_data=sql_select($sql_po);
	foreach($sql_po_data as $sql_po_row)
	{
	$po_qty+=$sql_po_row[csf('order_quantity')];
	$po_plun_cut_qty+=$sql_po_row[csf('plan_cut_qnty')];
	$total_set_qnty=$sql_po_row[csf('total_set_qnty')];
	}
	$fab_knit_req_kg_avg=0;
	$fab_woven_req_yds_avg=0;

	if($db_type==0)
	{
	$sql = "select a.job_no,a.company_name,a.buyer_name,a.style_ref_no,a.gmts_item_id,a.order_uom,a.job_quantity,a.avg_unit_price,b.costing_per,b.budget_minute,b.approved,b.sew_smv,b.sew_effi_percent,c.fab_knit_req_kg,c.fab_knit_fin_req_kg,c.fab_woven_req_yds,c.fab_woven_fin_req_yds,c.fab_yarn_req_kg from wo_po_details_master a, wo_pre_cost_mst b left join wo_pre_cost_sum_dtls c on   b.job_no=c.job_no where a.job_no=b.job_no  and a.status_active=1 $job_no $company_name $cbo_buyer_name  $txt_costing_date order by a.job_no";
	}
	if($db_type==2)
	{
	$sql = "select a.job_no,a.company_name,a.buyer_name,a.style_ref_no,a.gmts_item_id,a.order_uom,a.job_quantity,a.avg_unit_price,b.costing_per,b.budget_minute,b.approved,b.sew_smv,b.sew_effi_percent,c.fab_knit_req_kg,c.fab_knit_fin_req_kg,c.fab_woven_req_yds,c.fab_woven_fin_req_yds,c.fab_yarn_req_kg from wo_po_details_master a, wo_pre_cost_mst b left join wo_pre_cost_sum_dtls c on   b.job_no=c.job_no where a.job_no=b.job_no and a.status_active=1 $job_no $company_name $cbo_buyer_name  order by a.job_no";
	}

	$data_array=sql_select($sql);


	?>
    <!--<div style="width:850px; font-size:20px; font-weight:bold" align="center">< ? echo $comp[str_replace("'","",$cbo_company_name)]; ?></div>
    <div style="width:850px; font-size:14px; font-weight:bold" align="center">Pre- Costing</div>-->
	<?		
	ob_start();
	$uom="";
	foreach ($data_array as $row)
	{
		$order_price_per_dzn=0;
		$order_job_qnty=0;
		$avg_unit_price=0;

		$order_values = $row[csf("job_quantity")]*$row[csf("avg_unit_price")];
		$result =sql_select("select po_number,grouping,file_no,pub_shipment_date from wo_po_break_down where job_no_mst=$txt_job_no and status_active=1 and is_deleted=0 order by pub_shipment_date DESC");
		$job_in_orders = '';$pulich_ship_date='';$job_in_file = '';$job_in_ref = '';
		foreach ($result as $val)
		{
			$job_in_orders .= $val[csf('po_number')].", ";
			$pulich_ship_date = $val[csf('pub_shipment_date')];
			$job_in_ref.=$val[csf('grouping')].",";
			$job_in_file.=$val[csf('file_no')].",";

		}
		$job_in_orders = substr(trim($job_in_orders),0,-1);

		$job_ref=array_unique(explode(",",rtrim($job_in_ref,", ")));
		$job_file=array_unique(explode(",",rtrim($job_in_file,", ")));

		foreach ($job_ref as $ref)
		{
			$ref_cond.=", ".$ref;
		}
		$file_con='';
		foreach ($job_file as $file)
		{
			if($file_con=='') $file_cond=$file; else $file_cond.=", ".$file;
		}

		

		?>
            	<table style="width:850px" ><tr><td colspan="6" align="center">
                   <?
				   	$image_location=return_field_value("image_location","common_photo_library","file_type=1 and form_name='company_details' and master_tble_id=$cbo_company_name","image_location");
					?>
                    <img  src='../../<? echo $image_location; ?>' height='70' align="left" />
                    <b style="font-size:25px;"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></b><br>
                    <b style="font-size:14px;">Pre- Costing</b>
                </td></tr></table>

                
                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
                	<tr>
                    	<td width="80">Job Number</td>
                        <td width="80"><b><? echo $row[csf("job_no")]; ?></b></td>
                        <td width="90">Buyer</td>
                        <td width="100"><b><? echo $buyer_arr[$row[csf("buyer_name")]]; ?></b></td>
                        <td width="80">Garments Item</td>
                        <?
							$grmnt_items = "";
							if($garments_item[$row[csf("gmts_item_id")]]=="")
							{

								$grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no=$txt_job_no");
								foreach($grmts_sql as $key=>$val){
									$grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].", ";
								}
								$grmnt_items = substr_replace($grmnt_items,"",-1,1);
							}else{
								$grmnt_items = $garments_item[$row[csf("gmts_item_id")]];
							}

						?>
                        <td width="100"><b><? echo $grmnt_items; ?></b></td>
                    </tr>
                    <tr>
                    	<td>Style Ref. No </td>
                        <td colspan="3"><b><? echo $row[csf("style_ref_no")]; ?></b></td>

                        <td>Job Qnty</td>
                        <td><b><? $uom=$row[csf("order_uom")]; echo $row[csf("job_quantity")]." ". $unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
                    </tr>
                    <tr>
                    	<td>Order Numbers</td>
                        <td colspan="3"><? echo $job_in_orders; ?></td>
                        <td>Plun Cut Qnty</td>
                        <td><b><? $uom=$row[csf("order_uom")]; echo $po_plun_cut_qty/$total_set_qnty." ". $unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
                    </tr>
                    <tr>
                    	<td>Knit Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_knit_req_kg")];$fab_knit_req_kg_avg+=$row[csf("fab_knit_req_kg")]; ?> (Kg)</b></td>

                        <td>Woven Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_woven_req_yds")];$fab_woven_req_yds_avg+= $row[csf("fab_woven_req_yds")];?> (Yds)</b></td>
                        <td>Price Per Unit</td>
                        <td><b><? echo $row[csf("avg_unit_price")]; ?> USD</b></td>
                    </tr>
                    <tr>
                    	<td>Avg Yarn Req</td>
                        <td><b><? echo $row[csf("fab_yarn_req_kg")] ?> (Kg)</b></td>
                        <td>Costing Per</td>
                        <td><b><? echo $costing_per[$row[csf("costing_per")]]; ?></b></td>
                        <td>Shipment Date </td>
                        <td><b><? echo change_date_format($pulich_ship_date); ?></b></td>
                    </tr>
                    <tr>
                    <td>Knit Fin Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_knit_fin_req_kg")] ?> (Kg)</b></td>
                        <td>Woven Fin Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_woven_fin_req_yds")]; ?>(Yds)</b></td>
                    	<td>GSM </td>
                        <td><b><? //echo $gsm_weight_top.",".$gsm_weight_bottom

						$gsm_weights_top=implode(",",array_unique(explode(",",$gsm_weight_top)));
						$gsm_weight_bottom=implode(",",array_unique(explode(",",$gsm_weight_bottom)));
						if($gsm_weights_top!='') $gsm_weightTop=$gsm_weights_top;else $gsm_weightTop='';
						if($gsm_weight_bottom!='' && $gsm_weights_top!='') $gsm_weightBottom=" ,".$gsm_weight_bottom;
						else if($gsm_weight_bottom!='' && $gsm_weights_top=='') $gsm_weightBottom=$gsm_weight_bottom;
						else $gsm_weightBottom='';
						echo $gsm_weightTop .$gsm_weightBottom;
						 ?></b></td>

                    </tr>
                     <tr>
                     <td>SMV</td>
                    <td><b><? echo $row[csf("sew_smv")] ?> </b></td>
                     <td>CPM</td>
                    <td><b><? echo $cpm; ?> </b></td>
                    <td>Budget Minute</td>
                        <td><b><? echo $row[csf("budget_minute")] ?> </b></td>
                    </tr>

                    <tr>
                    <td>Efficiency</td>
                    <td colspan="1"><b><? echo $row[csf("sew_effi_percent")] ?> </b></td>
                    <td>Internal Ref</td>
                    <td colspan="1"><b><? echo ltrim($ref_cond,", "); ?> </b></td>
                    <td>File No</td>
                    <td colspan="1"><b><? echo $file_cond; ?></b></td>
                    </tr>
                    <tr>
                    <td align="center" height="10" colspan="6" valign="top" id="app_sms" style="font-size:18px;"><font color="#FF0000"><? if( $row[csf("approved")]==1 || $row[csf("approved")]==3){echo "This Job is Approved ";} else {echo "";} ?> </font> </td>
                    </tr>
                </table>
            <?
			if($row[csf("costing_per")]==1){$order_price_per_dzn=12; $costing_for=" DZN";}
			else if($row[csf("costing_per")]==2){$order_price_per_dzn=1; $costing_for=" PCS";}
			else if($row[csf("costing_per")]==3){$order_price_per_dzn=24; $costing_for=" 2 DZN";}
			else if($row[csf("costing_per")]==4){$order_price_per_dzn=36; $costing_for=" 3 DZN";}
			else if($row[csf("costing_per")]==5){$order_price_per_dzn=48; $costing_for=" 4 DZN";}
			$order_job_qnty=$row[csf("job_quantity")];
			$avg_unit_price=$row[csf("avg_unit_price")];
	}//end first foearch


	//id, fab_yarn_req_kg,fab_woven_req_yds,fab_knit_req_kg,fab_amount,yarn_cons_qnty,yarn_amount,conv_req_qnty,conv_charge_unit,conv_amount,trim_cons,trim_rate,trim_amount,emb_amount,comar_rate,comar_amount,commis_rate,commis_amount
	// 	costing_per_id 	order_uom_id 	fabric_cost 	fabric_cost_percent 	trims_cost 	trims_cost_percent 	embel_cost
	//embel_cost_percent 	comm_cost 	comm_cost_percent 	commission 	commission_percent 	lab_test 	lab_test_percent 	inspection
	//inspection_percent 	cm_cost,cm_cost_percent 	freight,freight_percent,common_oh,common_oh_percent,total_cost ,total_cost_percent
	// 	price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
	//margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche


	//start	all summary report here -------------------------------------------
	 $sql = "select fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,wash_cost,wash_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,currier_pre_cost,currier_percent,certificate_pre_cost,certificate_percent,common_oh,common_oh_percent,total_cost ,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
	from wo_pre_cost_dtls
	where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	$others_cost_value=0;
	$fabric_cost=0;
	$trims_cost=0;
	$embel_cost=0;
	$comm_cost=0;
	$commission=0;
	$lab_test=0;
	$inspection=0;
	$cm_cost=0;
	$freight=0;
	$currier_pre_cost=0;
	$certificate_pre_cost=0;
	$common_oh=0;
 	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80">SL</td>
                    <td width="300">Particulars</td>
                    <td width="100">Cost</td>
                    <td width="100">Amount (USD)</td>
                    <td width="180">% to Ord. Value</td>
                </tr>
            <?
			$price_dzn=0;
            $sl=0;
            foreach( $data_array as $row )
            {
			$fabric_cost=$row[csf("fabric_cost")];
			$trims_cost=$row[csf("trims_cost")];
			$embel_cost=$row[csf("embel_cost")];
			$comm_cost=$row[csf("comm_cost")];
			$commission=$row[csf("commission")];
			$lab_test=$row[csf("lab_test")];
			$inspection=$row[csf("inspection")];
			$cm_cost=$row[csf("cm_cost")];
			$freight=$row[csf("freight")];
			$currier_pre_cost=$row[csf("currier_pre_cost")];
			$certificate_pre_cost=$row[csf("certificate_pre_cost")];
			$common_oh=$row[csf("common_oh")];
				$sl=$sl+1;
  				$others_cost_value=$row[csf("total_cost")]-$row[csf("cm_cost")]-$row[csf("freight")]-$row[csf("comm_cost")]-$row[csf("commission")];
				if($zero_value==1)
				{

		?>
                <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left"><b>Order Price/<? echo $costing_for; ?></b></td>
                    <td></td>
                    <td align="right"><b><? echo fn_number_format($row[csf("price_dzn")],4);$price_dzn=$row[csf("price_dzn")];//$avg_unit_price*$order_price_per_dzn ?></b></td>
                    <td align="center"><? echo "100.00%"; ?></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">All Fabric Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("fabric_cost")],4); ?></td>
                    <td align="right" rowspan="13">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("fabric_cost_percent")],2); ?>%</td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Trims Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("trims_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("trims_cost_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Embellishment Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("embel_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("embel_cost_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Gmts Wash</td>
                    <td align="right"><? echo fn_number_format($row[csf("wash_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("wash_cost_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commercial Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("comm_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("comm_cost_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commission Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("commission")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("commission_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo fn_number_format($row[csf("lab_test")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("lab_test_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("inspection")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("inspection_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CM Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("cm_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("cm_cost_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("freight")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("freight_percent")],2); ?>%</td>
                 </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Currier Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("currier_pre_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("currier_percent")],2); ?>%</td>
                 </tr>
                  <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Certificate Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("certificate_pre_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("certificate_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Office OH </td>
                    <td align="right"><? echo fn_number_format($row[csf("common_oh")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("common_oh_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"><b>Total Cost (2:14)</b></td>
                    <td>&nbsp;</td>
                    <td align="right"><b><? echo fn_number_format($row[csf("total_cost")],4); ?></b></td>
                    <td align="center"><b><? echo fn_number_format($row[csf("total_cost_percent")],2); ?>%</b></td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?> (1-15)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("margin_dzn")],4); ?></td>
                    <td align="center"><b><? $margin_dzn_percent=($row[csf("margin_dzn")]/$row[csf("price_dzn")])*100; echo fn_number_format($margin_dzn_percent,2); ?>%</b></td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Price /<? echo $costing_for; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("price_pcs_or_set")],4); ?></td>
                    <td align="right"></td>
                </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Cost /<? echo $costing_for; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("total_cost")]/$order_price_per_dzn,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("margin_pcs_set")],4); ?></td>
                    <td align="right"></td>
                </tr>

            <?
				}
				else
				{
					?>
                 <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left"><b>Order Price/<? echo $costing_for; ?></b></td>
                    <td></td>
                    <td align="right"><b><? echo fn_number_format($row[csf("price_dzn")],4);//$avg_unit_price*$order_price_per_dzn ?></b></td>
                    <td align="center"><? echo "100.00%"; ?></td>
                </tr>
                <?
				if($row[csf("fabric_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">All Fabric Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("fabric_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("fabric_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("trims_cost")]!=0)
				{
				?>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Trims Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("trims_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("trims_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("embel_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Embellishment Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("embel_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("embel_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("wash_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Gmts Wash</td>
                    <td align="right"><? echo fn_number_format($row[csf("wash_cost")],4); ?></td>
                    <td align="center"><? echo fn_number_format($row[csf("wash_cost_percent")],2); ?>%</td>
                </tr>

                <?
				}
				if($row[csf("comm_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commercial Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("comm_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("comm_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("commission")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commission Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("commission")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("commission_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("lab_test")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo fn_number_format($row[csf("lab_test")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("lab_test_percent")],2); ?>%</td>
                 </tr>
                <?
				}
				if($row[csf("inspection")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("inspection")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("inspection_percent")],2); ?>%</td>
                 </tr>
                 <?
				}
				if($row[csf("cm_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CM Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("cm_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("cm_cost_percent")],2); ?>%</td>
                 </tr>
                 <?
				}
				if($row[csf("freight")]!=0)

				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("freight")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("freight_percent")],2); ?>%</td>
                 </tr>
                <?
				}
				if($row[csf("common_oh")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Office OH </td>
                    <td align="right"><? echo fn_number_format($row[csf("common_oh")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo fn_number_format($row[csf("common_oh_percent")],2); ?>%</td>
                 </tr>
                 <?
				}
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"><b>Total Cost (2:<? echo $sl-1;?>)</b></td>
                    <td>&nbsp;</td>
                    <td align="right"><b><? echo fn_number_format($row[csf("total_cost")],4); ?></b></td>
                    <td align="center"><b><? echo fn_number_format($row[csf("total_cost_percent")],2); ?>%</b></td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?> (1-<? echo $sl-1;?>)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("margin_dzn")],4); ?></td>
                    <td align="center"><b><? $margin_dzn_percent=($row[csf("margin_dzn")]/$row[csf("price_dzn")])*100; echo fn_number_format($margin_dzn_percent,2); ?>%</b></td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Price / <? echo $costing_for; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("price_pcs_or_set")],4); ?></td>
                    <td align="right"></td>
                </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Cost /<? echo $costing_for; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("total_cost")]/$order_price_per_dzn,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo fn_number_format($row[csf("margin_pcs_set")],4); ?></td>
                    <td align="right"></td>
                </tr>
                    <?
				}
            }
            ?>
            </table>
      </div>
      <?
	//End all summary report here -------------------------------------------



	    $sql = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description,uom, avg_cons,avg_cons_yarn, fabric_source,gsm_weight, rate, amount,avg_finish_cons,status_active   from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";

		$data_array=sql_select($sql);
		$knit_fab="";$woven_fab="";
		$knit_subtotal_avg_cons=0;
		$knit_subtotal_amount=0;
		$woven_subtotal_avg_cons=0;
		$woven_subtotal_amount=0;
		$grand_total_amount=0;
        $i=3;$j=2;
		foreach( $data_array as $row )
        {
			$uom=$unit_of_measurement[$row[csf("uom")]];
            if($row[csf("fab_nature_id")]==2)//knit fabrics
			{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")].", ".$row[csf("gsm_weight")];
				if($row[csf("fabric_source")] !=2){
				$amount=$row[csf("avg_cons_yarn")]*$row[csf("rate")];
				}
				else{
				$amount=$row[csf("avg_cons")]*$row[csf("rate")];
				}
				$percent_to_order_value=$amount/$price_dzn*100;
				//echo $amount.'='.$price_dzn;
				$i++;
                $knit_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.fn_number_format($row[csf("avg_cons")],4).'</td>
					 <td align="right">'.fn_number_format($row[csf("avg_cons_yarn")],4).'</td>
					  <td align="left">'.$uom.'</td>
                    <td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.fn_number_format($amount,4).'</td>
					<td align="right">'.fn_number_format($percent_to_order_value,2).'%</td>
                </tr>';
					if($row[csf("uom")]==12){
						$knit_subtotal_avg_cons += $row[csf("avg_cons")];
						$knit_subtotal_avg_cons_yarn += $row[csf("avg_cons_yarn")];
						if($row[csf("fabric_source")] !=2){
						$knit_subtotal_amount += $row[csf("avg_cons_yarn")]*$row[csf("rate")];
						}
						else{
							$knit_subtotal_amount += $row[csf("avg_cons")]*$row[csf("rate")];
						}
					}
					if($row[csf("uom")]==27){
						$knit_subtotal_avg_cons_yds += $row[csf("avg_cons")];
						$knit_subtotal_avg_cons_yarn_yds += $row[csf("avg_cons_yarn")];
						if($row[csf("fabric_source")] !=2){
						$knit_subtotal_amount_yds += $row[csf("avg_cons_yarn")]*$row[csf("rate")];
						}
						else{
							$knit_subtotal_amount_yds += $row[csf("avg_cons")]*$row[csf("rate")];
						}
					}
			}

			if($row[csf("fab_nature_id")]==3)//woven fabrics
			{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")].", ".$row[csf("gsm_weight")];
				$amount=$row[csf("avg_cons_yarn")]*$row[csf("rate")];
				$percent_to_order_value=$amount/$price_dzn*100;
				$j++;
                $woven_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.fn_number_format($row[csf("avg_cons")],4).'</td>
					<td align="right">'.fn_number_format($row[csf("avg_cons_yarn")],4).'</td>
					 <td align="left">'.$uom.'</td>
                    <td align="right">'.fn_number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.fn_number_format($amount,4).'</td>
					<td align="right">'.fn_number_format($percent_to_order_value,2).'%</td>
                </tr>';

				$woven_subtotal_avg_cons += $row[csf("avg_cons")];
				$woven_subtotal_avg_cons_yarn += $row[csf("avg_cons_yarn")];
				$woven_subtotal_amount += $row[csf("avg_cons_yarn")]*$row[csf("rate")];
			}
        }

		$knit_fab= '<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
					<label><b>All Fabric Cost  </b></label>
						<tr style="font-weight:bold"  align="center">
							<td width="80" rowspan="'.$i.'" ><div class="verticalText"><b>Knit Fabric</b></div></td>
							<td width="350">Description</td>
							<td width="100">Source</td>
							<td width="100">Fab. Cons/'.$costing_for.'</td>
							<td width="100">Avg. Fab. Cons/'.$costing_for.'</td>
							<td width="100">UOM</td>
							<td width="100">Rate (USD)</td>
							<td width="100">Amount (USD)</td>
							<td width="100">% to Ord. Value</td>
						</tr>'.$knit_fab;
		$woven_fab= '<tr><td colspan="8">&nbsp;</td></tr><tr>
						<td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;

		//knit fabrics table here
		$fab_knit_req_kg_avg_amount=$knit_subtotal_amount/$knit_subtotal_avg_cons*$fab_knit_req_kg_avg;
		$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total (Kg)</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_cons,4).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_cons_yarn,4).'</td>
						<td></td>
						<td></td>
						<td align="right">'.fn_number_format($knit_subtotal_amount,4).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_amount/$price_dzn*100,2).'%</td>
					</tr>';
		$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total(Yds)</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_cons_yds,4).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_cons_yarn_yds,4).'</td>
						<td></td>
						<td></td>
						<td align="right">'.fn_number_format($knit_subtotal_amount_yds,4).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_amount_yds/$price_dzn*100,2).'%</td>
					</tr>';
					/*$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total (Avg)</td>
						<td align="right">'.fn_number_format($fab_knit_req_kg_avg,4).'</td>
						<td align="right">'.fn_number_format($fab_knit_req_kg_avg,4).'</td>
						<td></td>
						<td align="right">'.fn_number_format($fab_knit_req_kg_avg_amount,4).'</td>
					</tr>';*/
					if($zero_value==1)
					{
  		               echo $knit_fab;
					}
					else
					{
						if($row[csf("avg_cons")]>0)
						{
							echo $knit_fab;
						}
						else
						{
							echo "";
						}

					}

		//woven fabrics table here
		$fab_woven_req_yds_avg_amount=$woven_subtotal_amount/$woven_subtotal_avg_cons*$fab_woven_req_yds_avg;
		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total</td>
						<td align="right">'.fn_number_format($woven_subtotal_avg_cons,4).'</td>
						<td align="right">'.fn_number_format($woven_subtotal_avg_cons_yarn,4).'</td>
						<td></td>
						<td></td>
						<td align="right">'.fn_number_format($woven_subtotal_amount,4).'</td>
						<td align="right">'.fn_number_format($woven_subtotal_amount/$price_dzn*100,2).'%</td>
					</tr>';
					/*$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total (Avg)</td>
						<td align="right">'.fn_number_format($fab_woven_req_yds_avg,4).'</td>
						<td align="right">'.fn_number_format($fab_woven_req_yds_avg,4).'</td>
						<td></td>
						<td align="right">'.fn_number_format($fab_woven_req_yds_avg_amount,4).'</td>
					</tr>';*/
   					$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="4" align="left">Total</td>
						<td align="right"></td>
						<td></td>
						<td></td>
						<td align="right">'.fn_number_format(($woven_subtotal_amount+$knit_subtotal_amount),4).'</td>
						<td align="right">'.fn_number_format((($woven_subtotal_amount+$knit_subtotal_amount)/$price_dzn*100),2).'%</td>
					</tr></table></div>';
					/*$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="4" align="left">Total (Avg)</td>
						<td align="right"></td>
						<td></td>
						<td align="right">'.fn_number_format(($fab_woven_req_yds_avg_amount+$fab_knit_req_kg_avg_amount),4).'</td>
					</tr></table></div>';*/
        // echo $woven_fab;
		 if($zero_value==1)
					{
  		               echo $woven_fab;
					}
					else
					{
						if($row[csf("avg_cons")]>0)
						{
							echo $woven_fab;
						}
						else
						{
							echo "";
						}

					}
  		$grand_total_amount = $knit_subtotal_amount+$woven_subtotal_amount;
		//end 	All Fabric Cost part report-------------------------------------------


		//Start	Yarn Cost part report here -------------------------------------------
		$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count"  );
		//mysql
		/*$sql = "select id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, cons_ratio, sum(cons_qnty) as cons_qnty, rate, sum(amount) as amount
				from wo_pre_cost_fab_yarn_cost_dtls
				where job_no=".$txt_job_no." group by count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, rate";*/
				//oracle
				$sql = "select min(id) as id, count_id, copm_one_id, percent_one, copm_two_id, percent_two,color,type_id, min(cons_ratio) as cons_ratio , sum(cons_qnty) as cons_qnty,sum(avg_cons_qnty) as avg_cons_qnty, rate, sum(amount) as amount
				from wo_pre_cost_fab_yarn_cost_dtls
				where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 group by count_id, copm_one_id, percent_one, copm_two_id, percent_two,color, type_id, rate";
		$data_array=sql_select($sql);
		if($zero_value==1)
		{
		?>
        <div style="margin-top:15px">
        	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="70" rowspan="<? echo count($data_array)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
                    <td width="350">Yarn Desc</td>
                    <td width="100">Yarn Qty</td>
                    <td width="100">Avg.Yarn Qty</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                   <td width="100">% to Ord. Value</td>
                </tr>
			<?
            $total_qnty=0;  $total_avg_qnty=0;$total_amount=0;
			foreach( $data_array as $row )
            {
				if($row[csf("percent_one")]==100)
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
            	else
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];

			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("avg_cons_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
				 $total_qnty += $row[csf("cons_qnty")];
				  $total_avg_qnty += $row[csf("avg_cons_qnty")];
				 $total_amount += $row[csf("amount")];
            }
            ?>
            	<tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_qnty,4); ?></td>
                     <td align="right"><? echo fn_number_format($total_avg_qnty,4); ?></td>
                    <td></td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
        	</table>
      </div>
      <?
	  $grand_total_amount +=$total_amount;
	  }
	  else
	  {
		  if($fabric_cost>0)
		  {
		  ?>
           <div style="margin-top:15px">
        	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="70" rowspan="<? echo count($data_array)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
                    <td width="350">Yarn Desc</td>
                    <td width="100">Yarn Qnty</td>
                     <td width="100">Avg.Yarn Qnty</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
			<?
            $total_qnty=0;$total_amount=0;
			foreach( $data_array as $row )
            {
				if($row[csf("percent_one")]==100)
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
            	else
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];

			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("avg_cons_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                     <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
				 $total_qnty += $row[csf("cons_qnty")];
				  $total_avg_qnty += $row[csf("avg_cons_qnty")];
				 $total_amount += $row[csf("amount")];
            }
            ?>
            	<tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_qnty,4); ?></td>
                     <td align="right"><? echo fn_number_format($total_avg_qnty,4); ?></td>
                    <td></td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
        	</table>
      </div>
      <?
	      $grand_total_amount +=$total_amount;
		  }
		  else
		  {
			 echo "";
		  }
	  }
	//End Yarn Cost part report here -------------------------------------------



  	//start	Conversion Cost to Fabric report here -------------------------------------------
   	$sql = "select a.id,a.fabric_description as fabric_description_id, a.job_no, a.cons_process, a.req_qnty,a.avg_req_qnty, a.charge_unit, a.amount, a.status_active,b.body_part_id,b.fab_nature_id,b.color_type_id,b.fabric_description
			from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id and b.status_active=1 and b.is_deleted=0
			where a.job_no=".$txt_job_no." and a.status_active=1 and a.is_deleted=0";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($data_array)+3; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Avg. Cons/<? echo $costing_for; ?></td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                     <td width="100">% to Ord. Value</td>
                </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
			if($row[csf("fabric_description_id")] !=0)
			{
 				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
			}
			else
			{
				$item_descrition = "All Fabrics";
			}
			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="left"><? echo $conversion_cost_head_array[$row[csf("cons_process")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("req_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("avg_req_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("charge_unit")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="5">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo  fn_number_format($total_amount/$price_dzn*100,2);?>%</td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="5">Total Fabric Cost</td>
                    <td align="right"><? echo fn_number_format(($grand_total_amount+$total_amount),4); ?></td>
                    <td align="right"><? echo fn_number_format((($grand_total_amount+$total_amount)/$price_dzn*100),2); ?>%</td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($fabric_cost>0)
		{
	?>
     <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($data_array)+3; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Avg. Cons/<? echo $costing_for; ?></td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
			if($row[csf("fabric_description_id")] !=0)
			{
 				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
			}
			else
			{
				$item_descrition = "All Fabrics";
			}
			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="left"><? echo $conversion_cost_head_array[$row[csf("cons_process")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("req_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("avg_req_qnty")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("charge_unit")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="5">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="5">Total Fabric Cost</td>
                    <td align="right"><? echo fn_number_format(($grand_total_amount+$total_amount),4); ?></td>
                     <td align="right"><? echo fn_number_format((($grand_total_amount+$total_amount)/$price_dzn*100),2); ?>%</td>
                </tr>
            </table>
      </div>
    <?
		}
		else
		{
			echo "";
		}
	}
	//End Conversion Cost to Fabric report here -------------------------------------------



  	//start	Trims Cost part report here -------------------------------------------
   	$sql = "select id, job_no, trim_group,description,brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,status_active,seq
			from wo_pre_cost_trim_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 order by seq";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row[csf("trim_group")], "id", "item_name"  );

			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                    <td align="left"><? echo $row[csf("description")]; ?></td>
                    <td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="6">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($trims_cost>0)
		{
	?>
    <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row[csf("trim_group")], "id", "item_name"  );

			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                    <td align="left"><? echo $row[csf("description")]; ?></td>
                    <td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="6">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
      </div>
	<?
		}
		else
		{
		   echo "";
		}
	}
	 //End Trims Cost Part report here -------------------------------------------



	//start	Embellishment Details part report here -------------------------------------------
    	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active
			from wo_pre_cost_embe_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				$em_type ="";
				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==99)$em_type = $emblishment_other_type_arr[$row[csf("emb_type")]];
			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                     <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($embel_cost>0)
		{
	?>
     <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				$em_type ="";
				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==99)$em_type = $emblishment_other_type_arr[$row[csf("emb_type")]];
			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                    <td align="right"><? echo fn_number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
      </div>
    <?
		}
		else
		{
			echo "";
		}
	}
	 //End Embellishment Details Part report here -------------------------------------------


  	//start	Commercial Cost part report here -------------------------------------------
   	$sql = "select id, job_no, item_id, rate, amount, status_active
			from  wo_pre_cost_comarci_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate In %</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($comm_cost>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
			echo "";
		}

	}
	 //End Commercial Cost Part report here -------------------------------------------


  	//start	Commission Cost part report here -------------------------------------------
   	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active
			from  wo_pre_cost_commiss_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commision_rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commission_amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("commission_amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($commission>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commision_rate")],4); ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("commission_amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("commission_amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3">Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
		   echo "";
		}

	}
	 //End Commission Cost Part report here -------------------------------------------


	//start	Other Components part report here -------------------------------------------
   	$sql = "select id,job_no,costing_per_id,order_uom_id,fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,total_cost,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
			from wo_pre_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Others Components</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>

                <tr>
                    <td align="left"s>Lab Test </td>
                    <td align="right"><? echo fn_number_format($row[csf("lab_test")],4); ?></td>
                </tr>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("inspection")],4); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo fn_number_format($row[csf("cm_cost")],4); ?></td>
                </tr>
                <tr>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("freight")],4); ?></td>
                </tr>
                <tr>
                    <td align="left">Office OH</td>
                    <td align="right"><? echo fn_number_format($row[csf("common_oh")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("cm_cost")]+$row[csf("freight")]+$row[csf("common_oh")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($lab_test>0 || $inspection>0 || $cm_cost>0 || $freight>0 || $common_oh>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Others Components</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
				if($row[csf("lab_test")]>0)
				{
  			?>


                <tr>
                    <td align="left"s>Lab Test </td>
                    <td align="right"><? echo fn_number_format($row[csf("lab_test")],4); ?></td>
                </tr>
                <?
				}
				if($row[csf("inspection")]>0)
				{
				?>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("inspection")],4); ?></td>
                </tr>
                <?
				}
				if($row[csf("cm_cost")]>0)
				{
				?>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo fn_number_format($row[csf("cm_cost")],4); ?></td>
                </tr>
                <?
				}
				if($row[csf("freight")]>0)
				{
				?>
                <tr>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo fn_number_format($row[csf("freight")],4); ?></td>
                </tr>
                 <?
				}
				if($row[csf("common_oh")]>0)
				{
				?>
                <tr>
                    <td align="left">Office OH</td>
                    <td align="right"><? echo fn_number_format($row[csf("common_oh")],4); ?></td>
                </tr>
            <?
				}
                 $total_amount += $row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("cm_cost")]+$row[csf("freight")]+$row[csf("common_oh")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo fn_number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
			echo "";
		}

	}
	 //End Other Components  Part report here -------------------------------------------



  	//start	CM on Net Order Value part report here -------------------------------------------
    	$sql = "select id,job_no,costing_per_id,order_uom_id,fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,total_cost,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
			from wo_pre_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	foreach( $data_array as $row );
	$order_net_value = 0;
	?>

        <div style="margin-top:15px">
        <div style="float:left">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
            <label><b>CM on Net Order Value</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">%</td>
                </tr>
                <tr>
                    <td align="left">Order Value </td>
                    <td align="right"><? echo fn_number_format($order_values,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Commission </td>
                    <td align="right"><? $less_commission = $row[csf("commission")]/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($less_commission,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Commercial Cost </td>
                    <td align="right"><? $less_commercial = $row[csf("comm_cost")]/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($less_commercial,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Freight</td>
                    <td align="right"><? $less_freight = $row[csf("freight")]/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($less_freight,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Net Order Value</td>
                    <td align="right"><? $order_net_value=$order_values-($less_commission+$less_commercial+$less_freight);echo fn_number_format($order_net_value,4); ?></td>
                    <td align="center"><? echo fn_number_format($order_net_value/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">Other Cost</td>
                    <td align="right"><? $otherCost=$others_cost_value/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($otherCost,4); ?></td>
                    <td align="center"><? echo fn_number_format($otherCost/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Value</td>
                    <td align="right"><? $cmValue = $order_net_value-$otherCost; echo fn_number_format($cmValue,4); ?></td>
                    <td align="center"><? echo fn_number_format($cmValue/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">CM /<? echo $costing_for; ?></td>
                    <td align="right"><? $cmPerDzn=$cmValue/$order_job_qnty*$order_price_per_dzn; echo fn_number_format($cmPerDzn,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td align="left">CM Cost /<? echo $costing_for; ?></td>
                    <td align="right"><? echo fn_number_format($row[csf("cm_cost")],4); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Margin /<? echo $costing_for; ?></td>
                    <td align="right"><? echo fn_number_format($cmPerDzn-$row[csf("cm_cost")],4); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>

            </table>
      </div>
      <div style="margin-left:5px;float:left;">
      		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
            <label><b>Cost Summary for order quantity</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">%</td>
                </tr>

                <tr>
                    <td align="left">Total Order Value </td>
                    <td align="right"><? $total_order_val = $order_job_qnty*$avg_unit_price; echo fn_number_format($total_order_val,4); ?></td>
                    <td align="center"><? echo fn_number_format($total_order_val/$total_order_val*100,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Total Cost </td>
                    <td align="right"><?  $total_cost = $row[csf("total_cost")]/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($total_cost,4); ?></td>
                    <td align="center"><? echo fn_number_format($total_cost/$total_order_val*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Margin </td>
                    <td align="right"><? $margin_val = $total_order_val-$total_cost; echo fn_number_format($margin_val,4); ?></td>
                    <td align="center"><? echo fn_number_format($margin_val/$total_order_val*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Margin /<? echo $costing_for; ?> </td>
                    <td align="right"><? echo fn_number_format($margin_val/$order_job_qnty*$order_price_per_dzn,2); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>

           </table>
      </div>

       <?
     	 // image show here  -------------------------------------------
		$sql = "select id,master_tble_id,image_location
				from common_photo_library
				where master_tble_id=".$txt_job_no."";
		$data_array=sql_select($sql);
 	  ?>
          <div style="margin:15px 5px;float:left;width:500px" >
          	<? foreach($data_array AS $inf){ ?>
                <img  src='../../<? echo $inf[csf("image_location")]; ?>' height='97' width='89' />
            <?  } ?>
          </div>


      <div style="clear:both"></div>
      </div>
    <!--End CM on Net Order Value Part report here -->
	<? echo "<br /><b>Note: Other Cost =  Fabric Cost + Trims Cost + Embellishment Cost + Lab Test + Inspection + Office OH</b><br /><br />"; ?>
    <br/>
 	<?
     echo signature_table(109, $cbo_company_name, "860px");
	 
	$mailBody=ob_get_contents();
	ob_clean();
	echo $mailBody;

	//Mail send------------------------------------------
	list($msil_address,$is_mail_send,$mail_body)=explode('**',$mail_data);
	if($is_mail_send==1){
	
		require_once('../../../mailer/class.phpmailer.php');
		require_once('../../../auto_mail/setting/mail_setting.php');
		
		$mailBody = preg_replace("/<img[^>]+\>/i", " ", $mailBody); 	
		$mailToArr=array();
		if($msil_address){$mailToArr[]=$msil_address;}
			
		
		$sql = "SELECT a.BRAND_IDS,a.BUYER_IDS,c.email_address as MAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id  and a.mail_item=b.MAIL_ITEM_MST and a.mail_item=89 and b.mail_user_setup_id=c.id and a.company_id =".$cbo_company_name."  and   A.IS_DELETED=0 and A.STATUS_ACTIVE=1  and b.IS_DELETED=0 and b.STATUS_ACTIVE=1  and c.IS_DELETED=0 and c.STATUS_ACTIVE=1";
		$mail_sql=sql_select($sql);
		$receverMailArr=array();
		foreach($mail_sql as $row)
		{
			$mailToArr[]=$row['MAIL'];
		}
		
		$elcetronicSql = "SELECT a.BUYER_ID,a.SEQUENCE_NO,a.BYPASS,b.USER_EMAIL  from electronic_approval_setup a join user_passwd b on a.user_id=b.id where b.valid=1  AND a.entry_form=46 and a.company_id=$cbo_company_name order by a.SEQUENCE_NO";
		
		$elcetronicSqlRes=sql_select($elcetronicSql);
		foreach($elcetronicSqlRes as $rows){
			
			if($rows[BUYER_ID]!=''){
				foreach(explode(',',$rows[BUYER_ID]) as $bi){
					if($rows['USER_EMAIL']!='' && $bi==$buyer_name_id){$mailToArr[]=$rows['USER_EMAIL'];}
					if($rows[BYPASS]==2){break;}
				}
			}
			else{
				if($rows['USER_EMAIL']){$mailToArr[]=$rows['USER_EMAIL'];}
				if($rows[BYPASS]==2){break;}
			}

		}
		
		//Un-approve request mail......................................................
		$user_id=$_SESSION['logic_erp']['user_id'];
		$job_id=return_field_value("id", "wo_pre_cost_mst", "job_no='".str_replace("'","",$txt_job_no)."'");
		$approved_no=return_field_value("MAX(approved_no) as approved_no","approval_history","entry_form=46 and mst_id=$job_id","approved_no")+1;
		$unapproved_request=return_field_value("APPROVAL_CAUSE","fabric_booking_approval_cause","entry_form=46 and user_id=$user_id and booking_id=$job_id and approval_type=2 and approval_no='$approved_no'");//page_id=$page_id and
		if($unapproved_request){
			$mailToArr=array();
			if($msil_address){$mailToArr[]=$msil_address;}
			$mailToArr[]= $final_app_user_mail;
			$final_app_user_mail=return_field_value("USER_EMAIL","user_passwd","id in(select APPROVED_BY from APPROVAL_HISTORY where id in(select max(id) from APPROVAL_HISTORY where mst_id=$job_id and ENTRY_FORM=46 and CURRENT_APPROVAL_STATUS=1))");
			$mailToArr[]= $final_app_user_mail;
		}
		$mailBody=$mail_body."<br>".$unapproved_request."<br>".$mailBody;
		//......................................................Un-approve request mail;

		$to=implode(',',array_unique($mailToArr));
		//echo $to;die;
		 
		
 /*		//Att file....
		$imgSql="select IMAGE_LOCATION,REAL_FILE_NAME from common_photo_library where is_deleted=0  and MASTER_TBLE_ID=$txt_job_no and file_type=1";
		$imgSqlResult=sql_select($imgSql);
		foreach($imgSqlResult as $rows){
			$att_file_arr[]='../../../'.$rows[IMAGE_LOCATION].'**'.$rows[REAL_FILE_NAME];
		}
 */		
		$subject="Pre Cost Entry Report";
		$header=mailHeader();
		echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
		
	}
	
	//------------------------------------End;
	 
	exit(); 
}

if($action=="preCostRptOrder")//bom page is not used   Order Wise Pre Costing Used in Fabric Receive Status Report and Cost Break Down Report
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));

	$order_id=$txt_job_no;

	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and b.costing_date='".$txt_costing_date."'";


	//array for display name
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	if($db_type==0)
	{
	$sql = "select a.job_no,a.company_name,a.buyer_name,a.style_ref_no, a.gmts_item_id, a.order_uom, a.job_quantity, a.avg_unit_price, b.costing_per, c.fab_knit_req_kg, c.fab_woven_req_yds, c.fab_yarn_req_kg, a.total_set_qnty as ratio, d.po_number, d.po_quantity as po_qnty, d.unit_price, d.pub_shipment_date from wo_po_details_master a, wo_pre_cost_mst b,wo_pre_cost_sum_dtls c, wo_po_break_down d where a.job_no=b.job_no and a.job_no=d.job_no_mst and b.job_no=c.job_no and a.status_active=1 and d.id=$order_id $company_name $cbo_buyer_name $txt_style_ref $txt_costing_date";
	}
	if($db_type==2)
	{
	$sql = "select a.job_no,a.company_name,a.buyer_name,a.style_ref_no, a.gmts_item_id, a.order_uom, a.job_quantity, a.avg_unit_price, b.costing_per, c.fab_knit_req_kg, c.fab_woven_req_yds, c.fab_yarn_req_kg, a.total_set_qnty as ratio, d.po_number, d.po_quantity as po_qnty, d.unit_price, d.pub_shipment_date from wo_po_details_master a, wo_pre_cost_mst b,wo_pre_cost_sum_dtls c, wo_po_break_down d where a.job_no=b.job_no and a.job_no=d.job_no_mst and b.job_no=c.job_no and a.status_active=1 and d.id=$order_id $company_name $cbo_buyer_name $txt_style_ref";
	}

	$data_array=sql_select($sql);


	?>
    <div style="width:850px; font-size:20px; font-weight:bold" align="center"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></div>
    <div style="width:850px; font-size:14px; font-weight:bold" align="center">Pre- Costing</div>
	<?
	$uom="";
	foreach ($data_array as $row)
	{
		$order_price_per_dzn=0;
		$order_job_qnty=0;
		$avg_unit_price=0;

		$order_values = $row[csf("po_qnty")]*$row[csf("unit_price")];

		$job_in_orders = $row[csf("po_number")];
		$pulich_ship_date = $row[csf("pub_shipment_date")];

		?>
            	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
                	<tr>
                    	<td width="80">Job Number</td>
                        <td width="80"><b><? echo $row[csf("job_no")]; ?></b></td>
                        <td width="90">Buyer</td>
                        <td width="100"><b><? echo $buyer_arr[$row[csf("buyer_name")]]; ?></b></td>
                        <td width="80">Garments Item</td>
                        <?
							$gmts_item='';
							$gmts_item_id=explode(",",$row[csf('gmts_item_id')]);
							foreach($gmts_item_id as $item_id)
							{
								if($gmts_item=="") $gmts_item=$garments_item[$item_id]; else $gmts_item.=",".$garments_item[$item_id];
							}

						?>
                        <td width="100"><b><? echo $gmts_item; ?></b></td>
                    </tr>
                    <tr>
                    	<td>Style Ref. No </td>
                        <td colspan="3"><b><? echo $row[csf("style_ref_no")]; ?></b></td>

                        <td>Order Qnty</td>
                        <td><b><? $uom=$row[csf("order_uom")]; echo $row[csf("po_qnty")]." ". $unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
                    </tr>
                    <tr>
                    	<td>Order Numbers</td>
                        <td colspan="5"><? echo $job_in_orders; ?></td>
                    </tr>
                    <tr>
                    	<td>Knit Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_knit_req_kg")]; ?> (Kg)</b></td>
                        <td>Woven Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_woven_req_yds")]; ?> (Yds)</b></td>
                        <td>Price Per Unit</td>
                        <td><b><? echo $row[csf("unit_price")]; ?> USD</b></td>
                    </tr>
                    <tr>
                    	<td>Avg Yarn Req</td>
                        <td><b><? echo $row[csf("fab_yarn_req_kg")] ?> (Kg)</b></td>
                        <td>Costing Per</td>
                        <td><b><? echo $cting_per[$row[csf("costing_per")]]; ?></b></td>
                        <td>Shipment Date </td>
                        <td><b><? echo change_date_format($pulich_ship_date); ?></b></td>
                    </tr>
                </table>
            <?

			if($row[csf("costing_per")]==1){$order_price_per_dzn=12;$costing_for=" DZN";}
			else if($row[csf("costing_per")]==2){$order_price_per_dzn=1;$costing_for=" PCS";}
			else if($row[csf("costing_per")]==3){$order_price_per_dzn=24;$costing_for=" 2 DZN";}
			else if($row[csf("costing_per")]==4){$order_price_per_dzn=36;$costing_for=" 3 DZN";}
			else if($row[csf("costing_per")]==5){$order_price_per_dzn=48;$costing_for=" 4 DZN";}
			$order_job_qnty=$row[csf("po_qnty")];
			$avg_unit_price=$row[csf("unit_price")];

	}//end first foearch



	$job_no=$row[csf('job_no')];
	//start	all summary report here -------------------------------------------
	$sql = "select fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,total_cost ,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
			from wo_pre_cost_dtls
			where job_no='".$job_no."' and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	$others_cost_value=0;
	$fabric_cost=0;
	$trims_cost=0;
	$embel_cost=0;
	$comm_cost=0;
	$commission=0;
	$lab_test=0;
	$inspection=0;
	$cm_cost=0;
	$freight=0;
	$common_oh=0;
 	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80">SL</td>
                    <td width="300">Particulars</td>
                    <td width="100">Cost</td>
                    <td width="100">Amount (USD)</td>
                    <td width="180">% to Ord. Value</td>
                </tr>
            <?
            $sl=0;
            foreach( $data_array as $row )
            {
			$fabric_cost=$row[csf("fabric_cost")];

			$trims_cost=$row[csf("trims_cost")];
			$embel_cost=$row[csf("embel_cost")];
			$comm_cost=$row[csf("comm_cost")];
			$commission=$row[csf("commission")];
			$lab_test=$row[csf("lab_test")];
			$inspection=$row[csf("inspection")];
			$cm_cost=$row[csf("cm_cost")];
			$freight=$row[csf("freight")];
			$common_oh=$row[csf("common_oh")];
				$sl=$sl+1;
  				$others_cost_value=$row[csf("total_cost")]-$row[csf("cm_cost")]-$row[csf("freight")]-$row[csf("comm_cost")]-$row[csf("commission")];
				if($zero_value==1)
				{

?>
                <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left"><b>Order Price/<? echo $costing_for; ?></b></td>
                    <td></td>
                    <td align="right"><b><? echo number_format($row[csf("price_dzn")],4);//$avg_unit_price*$order_price_per_dzn ?></b></td>
                    <td align="center"><? echo "100.00%"; ?></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">All Fabric Cost</td>
                    <td align="right"><? echo number_format($row[csf("fabric_cost")],4); ?></td>
                    <td align="right" rowspan="10">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("fabric_cost_percent")],2); ?>%</td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Trims Cost</td>
                    <td align="right"><? echo number_format($row[csf("trims_cost")],4); ?></td>
                    <td align="center"><? echo number_format($row[csf("trims_cost_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Embellishment Cost</td>
                    <td align="right"><? echo number_format($row[csf("embel_cost")],4); ?></td>
                    <td align="center"><? echo number_format($row[csf("embel_cost_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commercial Cost</td>
                    <td align="right"><? echo number_format($row[csf("comm_cost")],4); ?></td>
                    <td align="center"><? echo number_format($row[csf("comm_cost_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commission Cost</td>
                    <td align="right"><? echo number_format($row[csf("commission")],4); ?></td>
                    <td align="center"><? echo number_format($row[csf("commission_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo number_format($row[csf("lab_test")],4); ?></td>
                    <td align="center"><? echo number_format($row[csf("lab_test_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo number_format($row[csf("inspection")],4); ?></td>
                    <td align="center"><? echo number_format($row[csf("inspection_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CM Cost</td>
                    <td align="right"><? echo number_format($row[csf("cm_cost")],4); ?></td>
                    <td align="center"><? echo number_format($row[csf("cm_cost_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo number_format($row[csf("freight")],4); ?></td>
                    <td align="center"><? echo number_format($row[csf("freight_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Office OH </td>
                    <td align="right"><? echo number_format($row[csf("common_oh")],4); ?></td>
                    <td align="center"><? echo number_format($row[csf("common_oh_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"><b>Total Cost (2:11)</b></td>
                    <td>&nbsp;</td>
                    <td align="right"><b><? echo number_format($row[csf("total_cost")],4); ?></b></td>
                    <td align="center"><b><? echo number_format($row[csf("total_cost_percent")],2); ?>%</b></td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?> (1-12)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo number_format($row[csf("margin_dzn")],4); ?></td>
                    <td align="center"><b><? $margin_dzn_percent=($row[csf("margin_dzn")]/$row[csf("price_dzn")])*100; echo number_format($margin_dzn_percent,2); ?>%</b></td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Price / <? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo number_format($row[csf("price_pcs_or_set")],4); ?></td>
                    <td align="right"></td>
                </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Cost /<? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo number_format($row[csf("total_cost")]/$order_price_per_dzn,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo number_format($row[csf("margin_pcs_set")],4); ?></td>
                    <td align="right"></td>
                </tr>

            <?
				}
				else
				{
					?>
                 <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left"><b>Order Price/<? echo $costing_for; ?></b></td>
                    <td></td>
                    <td align="right"><b><? echo number_format($row[csf("price_dzn")],4);//$avg_unit_price*$order_price_per_dzn ?></b></td>
                    <td align="center"><? echo "100.00%"; ?></td>
                </tr>
                <?
				if($row[csf("fabric_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">All Fabric Cost</td>
                    <td align="right"><? echo number_format($row[csf("fabric_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("fabric_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("trims_cost")]!=0)
				{
				?>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Trims Cost</td>
                    <td align="right"><? echo number_format($row[csf("trims_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("trims_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("embel_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Embellishment Cost</td>
                    <td align="right"><? echo number_format($row[csf("embel_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("embel_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("comm_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commercial Cost</td>
                    <td align="right"><? echo number_format($row[csf("comm_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("comm_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("commission")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commission Cost</td>
                    <td align="right"><? echo number_format($row[csf("commission")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("commission_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("lab_test")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo number_format($row[csf("lab_test")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("lab_test_percent")],2); ?>%</td>
                 </tr>
                <?
				}
				if($row[csf("inspection")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo number_format($row[csf("inspection")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("inspection_percent")],2); ?>%</td>
                 </tr>
                 <?
				}
				if($row[csf("cm_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CM Cost</td>
                    <td align="right"><? echo number_format($row[csf("cm_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("cm_cost_percent")],2); ?>%</td>
                 </tr>
                 <?
				}
				if($row[csf("freight")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo number_format($row[csf("freight")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("freight_percent")],2); ?>%</td>
                 </tr>
                <?
				}
				if($row[csf("common_oh")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Office OH </td>
                    <td align="right"><? echo number_format($row[csf("common_oh")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("common_oh_percent")],2); ?>%</td>
                 </tr>
                 <?
				}
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"><b>Total Cost (2:<? echo $sl-1;?>)</b></td>
                    <td>&nbsp;</td>
                    <td align="right"><b><? echo number_format($row[csf("total_cost")],4); ?></b></td>
                    <td align="center"><b><? echo number_format($row[csf("total_cost_percent")],2); ?>%</b></td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?> (1-<? echo $sl-1;?>)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo number_format($row[csf("margin_dzn")],4); ?></td>
                    <td align="center"><b><? $margin_dzn_percent=($row[csf("margin_dzn")]/$row[csf("price_dzn")])*100; echo number_format($margin_dzn_percent,2); ?>%</b></td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Price / <? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo number_format($row[csf("price_pcs_or_set")],4); ?></td>
                    <td align="right"></td>
                </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Cost /<? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo number_format($row[csf("total_cost")]/$order_price_per_dzn,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo number_format($row[csf("margin_pcs_set")],4); ?></td>
                    <td align="right"></td>
                </tr>
                    <?
				}
            }
            ?>
            </table>
      </div>
      <?
		//End all summary report here -------------------------------------------



		//2	All Fabric Cost part here-------------------------------------------
		$sql = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description, avg_cons, fabric_source, rate, amount,avg_finish_cons,status_active
			from wo_pre_cost_fabric_cost_dtls
			where job_no='".$job_no."'";
		$data_array=sql_select($sql);
		$knit_fab="";$woven_fab="";

		$knit_subtotal_avg_cons=0;
		$knit_subtotal_amount=0;
		$woven_subtotal_avg_cons=0;
		$woven_subtotal_amount=0;
		$grand_total_amount=0;
        $i=2;$j=2;
		foreach( $data_array as $row )
        {
            if($row[csf("fab_nature_id")]==2)//knit fabrics
			{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				$i++;
                $knit_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.number_format($row[csf("avg_cons")],4).'</td>
                    <td align="right">'.number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.number_format($row[csf("amount")],4).'</td>
                </tr>';

				$knit_subtotal_avg_cons += $row[csf("avg_cons")];
				$knit_subtotal_amount += $row[csf("amount")];
			}

			if($row[csf("fab_nature_id")]==3)//woven fabrics
			{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				$j++;
                $woven_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.number_format($row[csf("avg_cons")],4).'</td>
                    <td align="right">'.number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.number_format($row[csf("amount")],4).'</td>
                </tr>';

				$woven_subtotal_avg_cons += $row[csf("avg_cons")];
				$woven_subtotal_amount += $row[csf("amount")];
			}
        }

		$knit_fab= '<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
					<label><b>All Fabric Cost  </b></label>
						<tr style="font-weight:bold"  align="center">
							<td width="80" rowspan="'.$i.'" ><div class="verticalText"><b>Knit Fabric</b></div></td>
							<td width="350">Description</td>
							<td width="100">Source</td>
							<td width="100">Fab. Cons/Dzn</td>
							<td width="100">Rate (USD)</td>
							<td width="100">Amount (USD)</td>
						</tr>'.$knit_fab;
		$woven_fab= '<tr><td colspan="6">&nbsp;</td></tr><tr>
						<td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;

		//knit fabrics table here
		$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2">Sub Total</td>
						<td align="right">'.number_format($knit_subtotal_avg_cons,4).'</td>
						<td></td>
						<td align="right">'.number_format($knit_subtotal_amount,4).'</td>
					</tr>';
					if($zero_value==1)
					{
  		               echo $knit_fab;
					}
					else
					{
						if($row[csf("avg_cons")]>0)
						{
							echo $knit_fab;
						}
						else
						{
							echo "";
						}

					}

		//woven fabrics table here
		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2">Sub Total</td>
						<td align="right">'.number_format($woven_subtotal_avg_cons,4).'</td>
						<td></td>
						<td align="right">'.number_format($woven_subtotal_amount,4).'</td>
					</tr>
   					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="3">Total</td>
						<td align="right"></td>
						<td></td>
						<td align="right">'.number_format(($woven_subtotal_amount+$knit_subtotal_amount),4).'</td>
					</tr></table></div>';
        // echo $woven_fab;
		 if($zero_value==1)
					{
  		               echo $woven_fab;
					}
					else
					{
						if($row[csf("avg_cons")]>0)
						{
							echo $woven_fab;
						}
						else
						{
							echo "";
						}

					}
  		$grand_total_amount = $knit_subtotal_amount+$woven_subtotal_amount;
		//end 	All Fabric Cost part report-------------------------------------------


		//Start	Yarn Cost part report here -------------------------------------------
		$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count"  );
		//Oracle
				$sql = "select min(id) as id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, min(cons_ratio) as cons_ratio, sum(cons_qnty) as cons_qnty, rate, sum(amount) as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no='".$job_no."' group by count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, rate";
		$data_array=sql_select($sql);
		if($zero_value==1)
		{
		?>
        <div style="margin-top:15px">
        	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="70" rowspan="<? echo count($data_array)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
                    <td width="350">Yarn Desc</td>
                    <td width="100">Yarn Qnty</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                </tr>
			<?
            $total_qnty=0;$total_amount=0;
			foreach( $data_array as $row )
            {
				if($row[csf("percent_one")]==100)
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$yarn_type[$row[csf("type_id")]];
            	else
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$yarn_type[$row[csf("type_id")]];

			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="right"><? echo number_format($row[csf("cons_qnty")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
				 $total_qnty += $row[csf("cons_qnty")];
				 $total_amount += $row[csf("amount")];
            }
            ?>
            	<tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo number_format($total_qnty,4); ?></td>
                    <td></td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                </tr>
        	</table>
      </div>
      <?
	  $grand_total_amount +=$total_amount;
	  }
	  else
	  {
		  if($fabric_cost>0)
		  {
		  ?>
           <div style="margin-top:15px">
        	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="70" rowspan="<? echo count($data_array)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
                    <td width="350">Yarn Desc</td>
                    <td width="100">Yarn Qnty</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                </tr>
			<?
            $total_qnty=0;$total_amount=0;
			foreach( $data_array as $row )
            {
				if($row[csf("percent_one")]==100)
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$yarn_type[$row[csf("type_id")]];
            	else
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$yarn_type[$row[csf("type_id")]];

			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="right"><? echo number_format($row[csf("cons_qnty")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
				 $total_qnty += $row[csf("cons_qnty")];
				 $total_amount += $row[csf("amount")];
            }
            ?>
            	<tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo number_format($total_qnty,4); ?></td>
                    <td></td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                </tr>
        	</table>
      </div>
      <?
	      $grand_total_amount +=$total_amount;
		  }
		  else
		  {
			 echo "";
		  }
	  }
	//End Yarn Cost part report here -------------------------------------------



  	//start	Conversion Cost to Fabric report here -------------------------------------------
   	$sql = "select a.id,a.fabric_description, a.job_no, a.cons_process, a.req_qnty, a.charge_unit, a.amount, a.status_active,b.body_part_id,b.fab_nature_id,b.color_type_id,b.fabric_description
			from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id
			where a.job_no='".$job_no."'";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($data_array)+3; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
			if($row[csf("fabric_description")] !=0)
			{
 				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
			}
			else
			{
				$item_descrition = "All Fabrics";
			}
			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="left"><? echo $conversion_cost_head_array[$row[csf("cons_process")]]; ?></td>
                    <td align="right"><? echo number_format($row[csf("req_qnty")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("charge_unit")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo $total_amount; ?></td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="4">Total Fabric Cost</td>
                    <td align="right"><? echo number_format(($grand_total_amount+$total_amount),4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($fabric_cost>0)
		{
	?>
     <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($data_array)+3; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
			if($row[csf("fabric_description")] !=0)
			{
 				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
			}
			else
			{
				$item_descrition = "All Fabrics";
			}
			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="left"><? echo $conversion_cost_head_array[$row[csf("cons_process")]]; ?></td>
                    <td align="right"><? echo number_format($row[csf("req_qnty")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("charge_unit")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo $total_amount; ?></td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="4">Total Fabric Cost</td>
                    <td align="right"><? echo number_format(($grand_total_amount+$total_amount),4); ?></td>
                </tr>
            </table>
      </div>
    <?
		}
		else
		{
			echo "";
		}
	}
	//End Conversion Cost to Fabric report here -------------------------------------------



  	//start	Trims Cost part report here -------------------------------------------
   	$sql = "select id, job_no, trim_group,description,brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,status_active
			from wo_pre_cost_trim_cost_dtls
			where job_no='".$job_no."'";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row[csf("trim_group")], "id", "item_name"  );

			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                    <td align="left"><? echo $row[csf("description")]; ?></td>
                    <td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                    <td align="right"><? echo number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="6">Total</td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($trims_cost>0)
		{
	?>
    <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row[csf("trim_group")], "id", "item_name"  );

			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                    <td align="left"><? echo $row[csf("description")]; ?></td>
                    <td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                    <td align="right"><? echo number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="6">Total</td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
	<?
		}
		else
		{
		   echo "";
		}
	}
	 //End Trims Cost Part report here -------------------------------------------



	//start	Embellishment Details part report here -------------------------------------------
    	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active
			from wo_pre_cost_embe_cost_dtls
			where job_no='".$job_no."'";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				$em_type ="";
				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==99)$em_type = $emblishment_other_type_arr[$row[csf("emb_type")]];
			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($embel_cost>0)
		{
	?>
     <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				$em_type ="";
				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];

				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==99)$em_type = $emblishment_other_type_arr[$row[csf("emb_type")]];
			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
    <?
		}
		else
		{
			echo "";
		}
	}
	 //End Embellishment Details Part report here -------------------------------------------


  	//start	Commercial Cost part report here -------------------------------------------
   	$sql = "select id, job_no, item_id, rate, amount, status_active
			from  wo_pre_cost_comarci_cost_dtls
			where job_no='".$job_no."'";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($comm_cost>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
			echo "";
		}

	}
	 //End Commercial Cost Part report here -------------------------------------------


  	//start	Commission Cost part report here -------------------------------------------
   	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active
			from  wo_pre_cost_commiss_cost_dtls
			where job_no='".$job_no."'";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                    <td align="right"><? echo number_format($row[csf("commision_rate")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("commission_amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("commission_amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3">Total</td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($commission>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                    <td align="right"><? echo number_format($row[csf("commision_rate")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("commission_amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("commission_amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3">Total</td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
		   echo "";
		}

	}
	 //End Commission Cost Part report here -------------------------------------------


	//start	Other Components part report here -------------------------------------------
   	$sql = "select id,job_no,costing_per_id,order_uom_id,fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,total_cost,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
			from wo_pre_cost_dtls
			where job_no='".$job_no."' and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Others Components</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>

                <tr>
                    <td align="left"s>Lab Test </td>
                    <td align="right"><? echo number_format($row[csf("lab_test")],4); ?></td>
                </tr>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo number_format($row[csf("inspection")],4); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo number_format($row[csf("cm_cost")],4); ?></td>
                </tr>
                <tr>

                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo number_format($row[csf("freight")],4); ?></td>
                </tr>
                <tr>
                    <td align="left">Office OH</td>
                    <td align="right"><? echo number_format($row[csf("common_oh")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("cm_cost")]+$row[csf("freight")]+$row[csf("common_oh")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($lab_test>0 || $inspection>0 || $cm_cost>0 || $freight>0 || $common_oh>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Others Components</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
				if($row[csf("lab_test")]>0)
				{
  			?>


                <tr>
                    <td align="left"s>Lab Test </td>
                    <td align="right"><? echo number_format($row[csf("lab_test")],4); ?></td>
                </tr>
                <?
				}
				if($row[csf("inspection")]>0)
				{
				?>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo number_format($row[csf("inspection")],4); ?></td>
                </tr>
                <?
				}
				if($row[csf("cm_cost")]>0)
				{
				?>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo number_format($row[csf("cm_cost")],4); ?></td>
                </tr>
                <?
				}
				if($row[csf("freight")]>0)
				{
				?>
                <tr>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo number_format($row[csf("freight")],4); ?></td>
                </tr>
                 <?
				}
				if($row[csf("common_oh")]>0)

				{
				?>
                <tr>
                    <td align="left">Office OH</td>
                    <td align="right"><? echo number_format($row[csf("common_oh")],4); ?></td>
                </tr>
            <?
				}
                 $total_amount += $row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("cm_cost")]+$row[csf("freight")]+$row[csf("common_oh")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
			echo "";
		}

	}
	 //End Other Components  Part report here -------------------------------------------



  	//start	CM on Net Order Value part report here -------------------------------------------
    	$sql = "select id,job_no,costing_per_id,order_uom_id,fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,total_cost,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
			from wo_pre_cost_dtls
			where job_no='".$job_no."' and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	foreach( $data_array as $row );
	$order_net_value = 0;
	?>

        <div style="margin-top:15px">
        <div style="float:left">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
            <label><b>CM on Net Order Value</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">%</td>
                </tr>
                <tr>
                    <td align="left">Order Value </td>
                    <td align="right"><? echo number_format($order_values,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Commission </td>
                    <td align="right"><? $less_commission = $row[csf("commission")]/$order_price_per_dzn*$order_job_qnty; echo number_format($less_commission,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Commercial Cost </td>
                    <td align="right"><? $less_commercial = $row[csf("comm_cost")]/$order_price_per_dzn*$order_job_qnty; echo number_format($less_commercial,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Freight</td>
                    <td align="right"><? $less_freight = $row[csf("freight")]/$order_price_per_dzn*$order_job_qnty; echo number_format($less_freight,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Net Order Value</td>
                    <td align="right"><? $order_net_value=$order_values-($less_commission+$less_commercial+$less_freight);echo number_format($order_net_value,4); ?></td>
                    <td align="center"><? echo number_format($order_net_value/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">Other Cost</td>
                    <td align="right"><? $otherCost=$others_cost_value/$order_price_per_dzn*$order_job_qnty; echo number_format($otherCost,4); ?></td>
                    <td align="center"><? echo number_format($otherCost/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Value</td>
                    <td align="right"><? $cmValue = $order_net_value-$otherCost; echo number_format($cmValue,4); ?></td>
                    <td align="center"><? echo number_format($cmValue/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">CM /<? echo $costing_for; ?></td>
                    <td align="right"><? $cmPerDzn=$cmValue/$order_job_qnty*$order_price_per_dzn; echo number_format($cmPerDzn,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td align="left">CM Cost /<? echo $costing_for; ?></td>
                    <td align="right"><? echo number_format($row[csf("cm_cost")],4); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Margin /<? echo $costing_for; ?></td>
                    <td align="right"><? echo number_format($cmPerDzn-$row[csf("cm_cost")],4); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>

            </table>
      </div>
      <div style="margin-left:5px;float:left;">
      		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
            <label><b>Cost Summary for order quantity</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">%</td>
                </tr>
                <tr>
                    <td align="left">Total Order Value </td>
                    <td align="right"><? $total_order_val = $order_job_qnty*$avg_unit_price; echo number_format($total_order_val,4); ?></td>
                    <td align="center"><? echo number_format($total_order_val/$total_order_val*100,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Total Cost </td>
                    <td align="right"><?  $total_cost = $row[csf("total_cost")]/$order_price_per_dzn*$order_job_qnty; echo number_format($total_cost,4); ?></td>
                    <td align="center"><? echo number_format($total_cost/$total_order_val*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Margin </td>
                    <td align="right"><? $margin_val = $total_order_val-$total_cost; echo number_format($margin_val,4); ?></td>
                    <td align="center"><? echo number_format($margin_val/$total_order_val*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Margin /<? echo $costing_for; ?> </td>
                    <td align="right"><? echo number_format($margin_val/$order_job_qnty*$order_price_per_dzn,2); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>

           </table>
      </div>

       <?
     	 // image show here  -------------------------------------------
		$sql = "select id,master_tble_id,image_location
				from common_photo_library
				where master_tble_id='".$job_no."'";
		$data_array=sql_select($sql);
 	  ?>
          <div style="margin:15px 5px;float:left;width:500px" >
          	<? foreach($data_array AS $inf){ ?>
                <img  src='../../<? echo $inf[csf("image_location")]; ?>' height='97' width='89' />
            <?  } ?>
          </div>


      <div style="clear:both"></div>
      </div>

	<? echo "<br /><b>Note: Other Cost =  Fabric Cost + Trims Cost + Embellishment Cost + Lab Test + Inspection + Office OH</b><br /><br />"; ?>

    <br/>

<?
	echo signature_table(109, $cbo_company_name, "860px");
	exit();
}

if ($action=="bom_pcs_woven4"){
 
		$process = array( &$_POST );
		extract(check_magic_quote_gpc( $process ));
		if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";
		if($cbo_company_name=="" || $cbo_company_name==0) $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
		if($cbo_buyer_name=="" || $cbo_buyer_name==0) $cbo_buyer_name=''; else  $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
		if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	
		$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
		if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and b.costing_date='".$txt_costing_date."'";
		$txt_po_breack_down_id=str_replace("'",'',$txt_po_breack_down_id);
		if(str_replace("'",'',$txt_po_breack_down_id)=="") $txt_po_breack_down_id_cond=''; else $txt_po_breack_down_id_cond=" and d.id in(".$txt_po_breack_down_id.")";
		$zero_value=str_replace("'",'',$zero_value);
		//echo $zero_value.'dssssss';
		//if($txt_quotation_date=="") $txt_quotation_date=''; else $txt_quotation_date=" and a.quot_date ='".$txt_quotation_date."'";
		$imge_arr=return_library_array( "select master_tble_id,image_location from common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	
		$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
		$season_name_arr=return_library_array( "select id, season_name from lib_buyer_season",'id','season_name');
		$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
		$user_passArr=return_library_array( "select id, user_name from user_passwd",'id','user_name');
		$brand_arr=return_library_array( "select id, brand_name from lib_buyer_brand where status_active=1 and is_deleted=0",'id','brand_name');
		 //pro_ex_factory_mst 
		$sql_ex="select max(ex_factory_date) as ex_factory_date from pro_ex_factory_mst b,wo_po_break_down d where d.id=b.po_break_down_id and d.job_no_mst=$txt_job_no and d.status_active=1";
		$exf_data_array=sql_select($sql_ex);
		foreach( $exf_data_array as $row)
		{
			$ex_factory_date=$row[csf("ex_factory_date")];
		}
		$excess_cut=0;
		$sql_excess="select avg(b.excess_cut_perc) as excess_cut_perc,max(d.pub_shipment_date) as last_pub_shipment_date,min(d.pub_shipment_date) as first_pub_shipment_date from wo_po_color_size_breakdown b,wo_po_break_down d where d.id=b.po_break_down_id and d.job_no_mst=$txt_job_no and b.status_active=1 and d.status_active=1";
		$excess_data_array=sql_select($sql_excess);
		foreach( $excess_data_array as $row)
		{
			$excess_cut=$row[csf("excess_cut_perc")];
			$last_pub_shipment_date=$row[csf("last_pub_shipment_date")];
			$first_pub_shipment_date=$row[csf("first_pub_shipment_date")];
		}
		 
		$sql_po="select a.total_set_qnty as ratio, d.po_number, (d.po_quantity) as po_qnty, d.plan_cut, d.excess_cut, d.unit_price, d.pub_shipment_date, d.po_received_date, d.pack_handover_date from wo_po_break_down d, wo_po_details_master a where d.job_no_mst=a.job_no and d.job_no_mst=$txt_job_no and d.status_active=1 $txt_po_breack_down_id_cond";
		$po_data_array=sql_select($sql_po);
		$order_job_qnty=0; $plan_cut=0; $leadtime_days_remian_cal=""; $ordQtyUom=$planqtyUom=0;
		foreach( $po_data_array as $row)
		{
			$po_received_dateArr.=$row[csf("po_received_date")].',';
			$pack_handover_dateArr.=$row[csf("pack_handover_date")].',';
			$order_job_qnty+=$row[csf("po_qnty")]*$row[csf("ratio")];
			
			$plan_cut+=$row[csf("plan_cut")]*$row[csf("ratio")];
			
			$ordQtyUom+=$row[csf("po_qnty")];
			$planqtyUom+=$row[csf("plan_cut")];
			$days_tot=datediff('d',$row[csf("po_received_date")],$row[csf("pub_shipment_date")])-1;
			$leadtime_days_remian_cal.=$days_tot.',';
			$pub_shipment_dateArr[$row[csf("pub_shipment_date")]]=$row[csf("pub_shipment_date")];
		}
		/*$pub_shipment_dateAll=implode(',',$pub_shipment_dateArr);
		$pub_shipment_dateAllArr=explode(",",$pub_shipment_dateAll);
		$last_pub_shipment_date=max($pub_shipment_dateAllArr);
		$first_pub_shipment_date=min($pub_shipment_dateAllArr);*/
		
		$leadtime_days_remian_calArr=rtrim($leadtime_days_remian_cal,',');
		$leadtime_days_remian_calArr=explode(",",$leadtime_days_remian_calArr);
		$leadtime_days_remian=max($leadtime_days_remian_calArr);
		  
		$po_received_dateArr=rtrim($po_received_dateArr,',');
		$po_received_dateArr=explode(",",$po_received_dateArr);
		$po_received_date=max($po_received_dateArr);
		$pack_handover_dateArr=rtrim($pack_handover_dateArr,',');
		$pack_handover_dateArr=explode(",",$pack_handover_dateArr);
		$pack_handover_date=max($pack_handover_dateArr);
		 
		// $leadtime_days_remian=datediff('d',$po_received_date,$ex_factory_date)-1;
		 
		 $sql = "select a.job_no, a.company_name, b.approved, a.buyer_name, a.quotation_id, a.season_buyer_wise, a.season_year, a.brand_id, a.style_ref_no, a.set_smv, a.gmts_item_id, a.order_uom, a.job_quantity, a.avg_unit_price,b.costing_date,b.sourcing_date, b.costing_per, c.fab_knit_req_kg, c.fab_woven_req_yds, c.fab_yarn_req_kg, a.total_set_qnty as ratio,a.working_company_id from wo_po_details_master a, wo_pre_cost_mst b,wo_pre_cost_sum_dtls c  where a.id=b.job_id and b.job_id=c.job_id and a.status_active=1 and a.job_no=$txt_job_no $company_name $cbo_buyer_name $txt_style_ref";
		//echo $sql; die;
		$data_array=sql_select($sql);
		$working_company_arr=return_library_array("SELECT id,company_name from lib_company ","id","company_name");  
		$working_company='';
		foreach ($data_array as $row)
		{
			$working_company=$working_company_arr[$row[csf("working_company_id")]];
			$approved_id=$row[csf("approved")];
		}
				//echo $approved_id.'d';
		if(empty($path)) $path="../../"; else $path=str_replace("'", "", $path);
		//echo $path;
	
		ob_start();
		?>
		<div style="width:1320px; border:1px solid black;margin:5px;" align="center">  
		  <style>
		 /* p{ padding:0px !important; margin:0px !important;}*/
		 table td{ font-size:15px;}
		</style>
		  <table width="98%" cellpadding="0" cellspacing="0" style="border:1px solid black;margin:5px; font-size:14px;">
			   <tr>
				   <td width="100"> 
				   <img src='<? echo $path .''. $imge_arr[str_replace("'","",$cbo_company_name)]; ?>' height='100%' width='100%' />
				   </td>
				   <td width="1250">                                     
						<table width="100%" cellpadding="0" cellspacing="0" >
							<tr>
								<td align="center" style="font-size:20px;"><b><?='Pre Cost Sheet'; ?></b></td>
							</tr>
						</table>
						<br>
						<table width="100%" cellpadding="0" cellspacing="0">
							<tr align="center">
								<td> <b style="font-size:21px;"> PO Rec Unit: </b><span style="font-size:19px;"><?=$comp[str_replace("'","",$cbo_company_name)];?> </span></td>
								<td ><b style="font-size:21px;">Prod Unit: </b><span style="font-size:19px;"><?=$working_company;?></span></td>
							</tr>
						</table>
					</td>       
				</tr>
		   </table>
		   <br>
		   <table align="left" border="0" cellpadding="0" cellspacing="0" style="width:550px; margin:5px;">
				<tr>
				<?
				$order_price_per_dzn=0; $orderUom=0;
			
				foreach ($data_array as $row)
				{
					$avg_unit_price=$row[csf("avg_unit_price")];
					$sourcing_date=$row[csf("sourcing_date")];
					$buyer_name_id=$row[csf("buyer_name")];
					$costing_date=$row[csf("costing_date")];
					$order_values = $order_job_qnty*$avg_unit_price;
					if($row[csf("costing_per")]==1){$order_price_per_dzn=12;$costing_val=" DZN";}
					else if($row[csf("costing_per")]==2){$order_price_per_dzn=1;$costing_val=" PCS";}
					else if($row[csf("costing_per")]==3){$order_price_per_dzn=24;$costing_val=" 2 DZN";}
					else if($row[csf("costing_per")]==4){$order_price_per_dzn=36;$costing_val=" 3 DZN";}
					else if($row[csf("costing_per")]==5){$order_price_per_dzn=48;$costing_val=" 4 DZN";}
				
					$quot_id=$row[csf("quotation_id")];
					$sew_smv=$row[csf("set_smv")];
					$inserted_by=$user_passArr[$row[csf("inserted_by")]];
					?>
					<td valign="top">
					<table class="rpt_table" align="left" border="1" cellpadding="1" cellspacing="1" style="width:550px; margin:5px; font-size:14px;" rules="all">
						<tr>
							<td width="80">Job No</td>
							<td width="80"><b><? echo $row[csf("job_no")]; ?></b></td>
							<td width="90">Costing </td>
						</tr>
						<tr>
							<td width="80">Quotation ID</td>
							<td width="80"><b><? echo $quot_id; ?></b></td>
							<td width="100"><b><? echo $costing_per[$row[csf("costing_per")]]; ?></b></td>
						</tr>
						<tr>
							<td> Costing Date :  </td>
							<td colspan="2"><b><? echo change_date_format($row[csf("costing_date")],4); ?></b></td>
						</tr>
						<tr>
							<td>Buyer </td>
							<td colspan="2"><b><? echo $buyer_arr[$row[csf("buyer_name")]]; ?></b></td>
						 </tr> 
						 <tr>
							<td>Brand </td>
							<td colspan="2"><b><? //echo $buyer_arr[$row[csf("buyer_name")]];
							if($row[csf("brand_id")]>0)
							{
								echo $brand_arr[$row[csf("brand_id")]];
							}
							?></b></td>
						 </tr> 
						 <tr>
							<td>Style </td>
							<td colspan="2"><b><? echo $row[csf("style_ref_no")]; ?></b></td>
						 </tr>
						<tr>
							<td width="80">Item</td>
							<?
								if($row[csf("order_uom")]==1)
								{
								  $grmnt_items=$garments_item[$row[csf("gmts_item_id")]];
								}
								else
								{
									$gmt_item=explode(',',$row[csf("gmts_item_id")]);
									foreach($gmt_item as $key=>$val)
									{
										$grmnt_items .=$garments_item[$val].", ";
									}
								}
							?>
							<td width="100" colspan="2"><b><? echo $grmnt_items; ?></b></td>
						</tr>
						<tr>
							<td>Season</td>
							<td colspan="2"><b><? echo $season_name_arr[$row[csf('season_buyer_wise')]].'-'.substr( $row[csf('season_year')], -2);  ?></b></td>
						 </tr>
						<tr>
							<td>P.O. Qty</td>
							<td><b><? echo $ordQtyUom.'-'.$unit_of_measurement[$row[csf("order_uom")]]; $po_qty_dzn=$order_job_qnty/$order_price_per_dzn; ?></b></td>
							<td title="<? echo $offer_qty_dzn;?>"><b><? // echo number_format($po_qty_dzn,0).' '.$costing_val; ?></b></td>
						</tr>
						<tr>
							<td>Plan Cut Qty[<?=number_format($excess_cut,2).'%'; ?>]</td>
							<td><b><? echo $planqtyUom.'-'.$unit_of_measurement[$row[csf("order_uom")]]; $orderUom=$row[csf("order_uom")]; $offer_qty_dzn=$plan_cut/$order_price_per_dzn; ?></b></td>
							<td title="<? echo $offer_qty_dzn;?>"><b><? // echo number_format($offer_qty_dzn,0).' '.$costing_val; ?></b></td>
						</tr>
					</table>
					</td>
					  <?
				} //master part end
				//die;
				$condition= new condition();
				if(str_replace("'","",$txt_job_no) !=''){
					$condition->job_no("=$txt_job_no");
				}
				if(str_replace("'",'',$txt_po_breack_down_id) !="")
				{
					$condition->po_id("in($txt_po_breack_down_id)");
				}
				$condition->init();
				$fabric= new fabric($condition);
				$trim= new trims($condition);
				$wash= new wash($condition);
				$emblishment= new emblishment($condition);
				//echo $fabric->getQuery();die;
				$fabric_qty_arr=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
				//print_r($fabric_qty_arr);
				$fabric_amount_arr=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
				
				$trim_amount_arr=$trim->getAmountArray_precostdtlsid();
				$trim_qty_arr=$trim->getQtyArray_by_precostdtlsid();
				
				$emblishment_qtyArr=$emblishment->getQtyArray_by_jobAndEmblishmentid();
				$emblishment_amountArr=$emblishment->getAmountArray_by_jobAndEmblishmentid();
				$wash_qtyArr=$wash->getQtyArray_by_jobAndEmblishmentid();
				//	print_r($wash_qtyArr);
				$wash_amountArr=$wash->getAmountArray_by_jobAndEmblishmentid();
				
				$sql_determin=sql_select("select a.id,a.type from lib_yarn_count_determina_mst a where a.status_active=1 and a.entry_form=426");
				foreach($sql_determin as $row)
				{
					$determin_type_arr[$row[csf('id')]]=$row[csf('type')];	
				}
				
				if($zero_value==1) $cons_qty_chk=""; else  $cons_qty_chk="b.avg_cons>0";
				
				$pre_fab_arr="select  b.id, b.job_no,b.body_part_id,b.lib_yarn_count_deter_id as deter_min_id, b.fab_nature_id, b.color_type_id, b.fabric_description as fab_desc,b.uom,b.avg_cons,b.avg_cons_yarn, b.avg_process_loss,b.construction,b.composition,b.fabric_source,b.gsm_weight, b.rate,b.amount,b.avg_finish_cons,b.sourcing_rate,b.sourcing_nominated_supp from wo_pre_cost_fabric_cost_dtls  b where  b.status_active=1 and b.is_deleted=0 and b.job_no=$txt_job_no and b.avg_cons>0 order by b.id ";//and b.fabric_source=2
				 //echo $pre_fab_arr; die;
				
				$pre_fab_result=sql_select($pre_fab_arr);
				
				$summ_fob_pcs=0;$summ_fob_gross_value_amt=$summ_sourcing_tot_budget_dzn_val=0;
				foreach($pre_fab_result as $row)
				{
					$pre_c_id=$row[csf('id')];
					$remarks_arr=sql_select("select remarks from wo_pre_cos_fab_co_avg_con_dtls where job_no=$txt_job_no and pre_cost_fabric_cost_dtls_id=$pre_c_id group by remarks");
					$determin_type=$determin_type_arr[$row[csf('deter_min_id')]];
					$body_partId=$body_part[$row[csf('body_part_id')]];
					//$fab_desc=$body_partId.','.$row[csf('fab_desc')];
					$fab_desc=$row[csf('fab_desc')];
					//echo $determin_type.'d';
					$tot_amt=$row[csf('avg_cons')]*$row[csf('rate')];
					$fab_req_qty=$fabric_qty_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]]+$fabric_qty_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
					$fab_req_amount=$fabric_amount_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]]+$fabric_amount_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
					$fab_cost_dtls_id=$row[csf('id')];
					$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['req_qty']+=$fab_req_qty;
					$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['req_amount']+=$fab_req_amount;
					$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['cons']+=$row[csf('avg_finish_cons')];
					$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['tot_cons']+=$row[csf('avg_cons')];
					$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['amount']+=$row[csf('amount')];
					$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['p_loss']=$row[csf('avg_process_loss')];
					$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['sourcing_nominated_supp']=$row[csf('sourcing_nominated_supp')];
					$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['sourcing_rate']=$row[csf('sourcing_rate')];
					$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['fab_desc']=$row[csf('construction')].','.$row[csf('composition')];
					$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['uom']=$unit_of_measurement[$row[csf('uom')]];
					$p_fab_precost_arr[$fab_cost_dtls_id][$determin_type][$fab_desc]['remarks']=$remarks_arr[0][REMARKS];
					$p_fab_precost_tot_row+=1;	
					//Summary
					$summ_fob_pcs+=$row[csf('amount')];
				//	$summ_sourcing_tot_budget_dzn_val+=$fab_req_qty*$row[csf('sourcing_rate')];
					
					$summ_fob_gross_value_amt+=$fab_req_amount;
				}
				$pre_trim_consarr="select b.id,c.trim_type,c.item_name,b.description,b.trim_group,b.cons_dzn_gmts,b.seq,b.cons_uom as uom,avg(d.excess_per) as  excess_per from wo_pre_cost_trim_cost_dtls b,lib_item_group c,wo_pre_cost_trim_co_cons_dtls d where  c.id=b.trim_group and b.id=d.wo_pre_cost_trim_cost_dtls_id and c.trim_type in(1,2) and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and b.job_no=$txt_job_no and b.cons_dzn_gmts>0  group by b.id,c.trim_type,c.item_name,b.description,b.trim_group,b.cons_dzn_gmts,b.cons_uom,b.seq order by b.seq";
				$pre_trim_cons_result=sql_select($pre_trim_consarr);
				foreach($pre_trim_cons_result as $row)
				{
					$trims_type=$row[csf('trim_type')];
					$description=$row[csf('description')];
					if($description!="") $descriptionCond=", ".$description; else $descriptionCond="";
					$item_id=$row[csf('item_name')].$descriptionCond;
					if($trims_type==1) //Sewing
					{
						$p_sew_trim_precost_excess_arr[$item_id]['p_loss']+=$row[csf('excess_per')];
					}
					else
					{
						$p_fin_trim_precost_excess_arr[$item_id]['p_loss']+=$row[csf('excess_per')];;
					}
				}
				//  $pre_trim_arr="select b.seq,b.id,c.trim_type,c.item_name,b.description,b.trim_group,b.tot_cons,b.ex_per ,b.cons_dzn_gmts,b.cons_uom as uom, b.rate,b.amount,b.sourcing_rate,b.sourcing_nominated_supp from wo_pre_cost_trim_cost_dtls b,lib_item_group c where  c.id=b.trim_group and c.trim_type in(1,2) and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and b.job_no=$txt_job_no order by b.seq";//and b.fabric_source=2
	
				$pre_trim_arr="select b.seq,b.id,c.trim_type,c.item_name,b.description,b.trim_group,b.tot_cons,b.ex_per ,b.cons_dzn_gmts,b.cons_uom as uom, b.rate,b.amount,b.sourcing_rate,b.sourcing_nominated_supp,b.remark from wo_pre_cost_trim_cost_dtls b,lib_item_group c where  c.id=b.trim_group  and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and b.cons_dzn_gmts>0  and b.job_no=$txt_job_no order by b.seq";//and b.fabric_source=2
				$pre_trim_result=sql_select($pre_trim_arr);
				$p_sew_trim_precost_arr=$p_fin_trim_precost_arr=array();
			
				//print_r($p_sew_trim_precost_arr2);
				$pre_wash_arr="select b.job_no,b.id,b.emb_name,b.emb_type,b.cons_dzn_gmts, b.rate,b.amount,b.sourcing_rate,b.sourcing_nominated_supp from wo_pre_cost_embe_cost_dtls  b where  b.status_active=1 and b.is_deleted=0  and b.job_no=$txt_job_no   and b.cons_dzn_gmts>0 order by b.emb_name";//and b.fabric_source=2
				$pre_wash_result=sql_select($pre_wash_arr);
				
				//$summ_sourcing_tot_budget_dzn_val=0;
			 
				foreach($pre_wash_result as $row)
				{
					$emb_name_id=$row[csf('emb_name')];
					$emb_type=$row[csf('emb_type')];
				
					//emblishment_embroy_type_arr
					if($emb_name_id==1) //Print type
					{
						if($emb_type>0) $emb_typeCond=", ".$emblishment_print_type[$emb_type];else $emb_typeCond="";
						$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
					}
					else if($emb_name_id==2) //embro type
					{
						if($emb_type>0) $emb_typeCond=", ".$emblishment_embroy_type_arr[$emb_type];else $emb_typeCond="";
						$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
					}
					else if($emb_name_id==4) //Special type
					{
						if($emb_type>0) $emb_typeCond=", ".$emblishment_spwork_type[$emb_type];else $emb_typeCond="";
						$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
					}
					else if($emb_name_id==5) //GMT type
					{
						if($emb_type>0) $emb_typeCond=", ".$emblishment_gmts_type[$emb_type];else $emb_typeCond="";
						$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
					}
					else if($emb_name_id==99) //GMT type
					{
						if($emb_type>0) $emb_typeCond=", ".$emblishment_other_type_arr[$emb_type];else $emb_typeCond="";
						$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$emb_typeCond;
					}
	
					$wash_req_amount=$emb_req_amount=0;
					if($row[csf('emb_name')]==3) //Wash
					{
						if($row[csf('emb_type')]>0) $wash_emb_typeCond=", ".$emblishment_wash_type[$row[csf('emb_type')]];else $wash_emb_typeCond="";
						$emb_name=$emblishment_name_array[$row[csf('emb_name')]].$wash_emb_typeCond;
						$wash_req_qty=$wash_qtyArr[$row[csf('job_no')]][$row[csf('id')]];
						$wash_req_amount=$wash_amountArr[$row[csf('job_no')]][$row[csf('id')]];
						// echo $emb_name.'='.$wash_emb_typeCond.' <br>';
							 
						$p_wash_precost_arr[$emb_name]['req_qty']+=$wash_req_qty;
						$p_wash_precost_arr[$emb_name]['req_amount']+=$wash_req_amount;
						$p_wash_precost_arr[$emb_name]['cons']+=$row[csf('cons_dzn_gmts')];
						//$p_wash_precost_arr[$emb_name]['tot_cons']+=$row[csf('cons_dzn_gmts')];
						$p_wash_precost_arr[$emb_name]['amount']+=$row[csf('amount')];
						$p_wash_precost_arr[$emb_name]['p_loss']=$row[csf('p_loss')];
						$p_wash_precost_arr[$emb_name]['sourcing_rate']=$row[csf('sourcing_rate')];
						$p_wash_precost_arr[$emb_name]['pre_rate']=$row[csf('rate')];
						$p_wash_precost_arr[$emb_name]['sourcing_nominated_supp']=$row[csf('sourcing_nominated_supp')];
						$p_wash_precost_arr[$emb_name]['uom']=$unit_of_measurement[$row[csf('uom')]];
						$summ_fob_pcs+=$row[csf('amount')];
						$summ_sourcing_tot_budget_dzn_val+=$wash_req_qty*$row[csf('sourcing_rate')];
						$p_wash_tot_row+=1;	
					}
					else
					{
						$emb_req_qty=$emblishment_qtyArr[$row[csf('job_no')]][$row[csf('id')]];
						$emb_req_amount=$emblishment_amountArr[$row[csf('job_no')]][$row[csf('id')]];
						$p_embro_precost_arr[$emb_name]['req_qty']+=$emb_req_qty;
						$p_embro_precost_arr[$emb_name]['req_amount']+=$emb_req_amount;
						$p_embro_precost_arr[$emb_name]['cons']+=$row[csf('cons_dzn_gmts')];
						//$p_wash_precost_arr[$emb_name]['tot_cons']+=$row[csf('cons_dzn_gmts')];
						$p_embro_precost_arr[$emb_name]['amount']+=$row[csf('amount')];
						$p_embro_precost_arr[$emb_name]['p_loss']=$row[csf('p_loss')];
						$p_embro_precost_arr[$emb_name]['pre_rate']=$row[csf('rate')];
						if($row[csf('sourcing_rate')]>0)
						{
							$p_embro_precost_arr[$emb_name]['sourcing_rate']=$row[csf('sourcing_rate')];
						}
						$p_embro_precost_arr[$emb_name]['sourcing_nominated_supp']=$row[csf('sourcing_nominated_supp')];
						$p_embro_precost_arr[$emb_name]['uom']=$unit_of_measurement[$row[csf('uom')]];
						$summ_fob_pcs+=$row[csf('amount')];
						$summ_sourcing_tot_budget_dzn_val+=$emb_req_qty*$row[csf('sourcing_rate')];
						$p_embro_tot_row+=1;	
					}
					//$summ_fob_value_pcs+=$row[csf('amount')]/$order_price_per_dzn;
					$summ_fob_gross_value_amt+=$emb_req_amount+$wash_req_amount;
				}
				$sql_other = "select fabric_cost, trims_cost, embel_cost, wash_cost, margin_dzn,margin_dzn_percent,comm_cost, commission, lab_test, inspection, cm_cost, freight, currier_pre_cost, certificate_pre_cost, design_cost, studio_cost, common_oh,common_oh_percent, depr_amor_pre_cost, interest_cost, incometax_cost, total_cost,price_dzn from wo_pre_cost_dtls where  job_no=$txt_job_no  and status_active=1 and  is_deleted=0";
				$pre_other_result=sql_select($sql_other);//$summ_fob_value_pcs=0; TOTAL_COST
				foreach( $pre_other_result as $row )
				{
					$cm_cost=$row[csf('cm_cost')];
					$total_fob=$row[csf('price_dzn')];
					$total_cost=$row[csf('total_cost')];
					
					$lab_test=($row[csf('lab_test')]/$order_price_per_dzn)*$ordQtyUom;
					$currier_pre_cost=($row[csf('currier_pre_cost')]/$order_price_per_dzn)*$ordQtyUom;
					$inspection=($row[csf('inspection')]/$order_price_per_dzn)*$ordQtyUom;
					$comarcial=($row[csf('comm_cost')]/$order_price_per_dzn)*$ordQtyUom;
					
					$freight=($row[csf('freight')]/$order_price_per_dzn)*$ordQtyUom;
					$certificate_pre_cost=($row[csf('certificate_pre_cost')]/$order_price_per_dzn)*$ordQtyUom;
					$design_pre_cost=($row[csf('design_cost')]/$order_price_per_dzn)*$ordQtyUom;
					$studio_pre_cost=($row[csf('studio_cost')]/$order_price_per_dzn)*$ordQtyUom;
					$common_oh=($row[csf('common_oh')]/$order_price_per_dzn)*$order_job_qnty;
					$depr_amor_pre_cost=($row[csf('depr_amor_pre_cost')]/$order_price_per_dzn)*$ordQtyUom;
					$interest_pre_cost=($row[csf('interest_cost')]/$order_price_per_dzn)*$ordQtyUom;
					$income_tax_pre_cost=($row[csf('incometax_cost')]/$order_price_per_dzn)*$ordQtyUom;
					
					$operating_oh=$row[csf('common_oh')];
					$operating_oh_per=$row[csf('common_oh_percent')];
					
					$tot_other_for_fob_value=$lab_test+$currier_pre_cost+$inspection+$comarcial+$freight+$certificate_pre_cost+$design_pre_cost+$studio_pre_cost+$common_oh+$interest_pre_cost+$income_tax_pre_cost+$depr_amor_pre_cost;
					//echo $tot_other_for_fob_value;
					$lab_test_dzn=$row[csf('lab_test')];
					$fob_pcs=$row[csf('price_with_commn_pcs')];
					$currier_pre_cost_dzn=$row[csf('currier_pre_cost')];
					$inspection_dzn=$row[csf('inspection')];
					$comarcial_dzn=$row[csf('comm_cost')];
					
					$common_oh_dzn=$row[csf('common_oh')];
					$studio_pre_cost_dzn=$row[csf('studio_cost')];
					$design_pre_cost_dzn=$row[csf('design_cost')];
					$certificate_pre_cost_dzn=$row[csf('certificate_pre_cost')];
					
					$freight_dzn=$row[csf('freight')];
					//$comm_cost_dzn=$row[csf('comm_cost')];
					$depr_amor_pre_cost_dzn=$row[csf('depr_amor_pre_cost')];
					$income_tax_pre_cost_dzn=$row[csf('incometax_cost')];
					$interest_pre_cost_dzn=$row[csf('interest_cost')];
					
					$cm_cost_dzn=$row[csf('cm_cost')];
					$margin_dzn=$row[csf('margin_dzn')];
					$margin_dzn_percent=$row[csf('margin_dzn_percent')];;
					$cm_cost_pcs=$row[csf('cm_cost')]/$order_price_per_dzn;
					$cm_cost_req=($row[csf('cm_cost')]/$order_price_per_dzn)*$order_job_qnty;
					$tot_cm_qty_dzn=$row[csf('cm_cost')]*$po_qty_dzn;
					$cmCost=(($row[csf('cm_cost')]+$row[csf('margin_dzn')])/$order_price_per_dzn)*$ordQtyUom;
					//$lab_test_dzn=$row[csf('lab_test')];
					//echo $cmCost;
	
					$tot_summ_fob_pcs=$row[csf('total_cost')];
					$tot_other_cost_dzn=$design_pre_cost_dzn+$certificate_pre_cost_dzn+$freight_dzn+$depr_amor_pre_cost_dzn+$income_tax_pre_cost_dzn+$interest_pre_cost_dzn;
					 
					$tot_other_cost=($tot_other_cost_dzn/$order_price_per_dzn)*$ordQtyUom;
					//$summ_fob_value_pcs+=($tot_other_cost_dzn+$currier_pre_cost_dzn+$lab_test_dzn+$inspection_dzn+$comarcial_dzn)*$order_price_per_dzn+$cm_cost_pcs;
					
					// echo $tot_other_for_fob_value.'m';
					$summ_fob_gross_value_amt+=$tot_other_for_fob_value+$tot_cm_qty_dzn ;
					$summ_fob_pcs+=$tot_other_cost_dzn+$lab_test_dzn+$currier_pre_cost_dzn+$inspection_dzn+$comarcial_dzn+$cm_cost_dzn;
					$summ_sourcing_tot_budget_dzn_val+=$tot_other_for_fob_value;
				}
				
				$sql_commi = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls  where job_no=".$txt_job_no." and status_active=1  and commission_amount>0";
				$result_commi=sql_select($sql_commi);
				 foreach( $result_commi as $row )
				{
					$commission_type_id=$row[csf('particulars_id')];
					$com_type_id=$row[csf('commission_base_id')];
					
					$commission_arr[$commission_type_id]['commi_req_amt']=($row[csf('commission_amount')]/$order_price_per_dzn)*$ordQtyUom;
					$commission_arr[$commission_type_id]['commi_amt']=$row[csf('commission_amount')];
					$commission_arr[$commission_type_id]['commi_amt_pcs']=$row[csf('commission_amount')]*$order_price_per_dzn;
					//$summ_fob_value_pcs+=$row[csf('commission_amount')]/$order_price_per_dzn;
					$summ_fob_gross_value_amt+=($row[csf('commission_amount')]/$order_price_per_dzn)*$order_job_qnty;
					$summ_fob_pcs+=$row[csf('commission_amount')];
					$summ_sourcing_tot_budget_dzn_val+=($row[csf('commission_amount')]/$order_price_per_dzn)*$order_job_qnty;
				} 
				$summ_sourcing_fob_pcs=$summ_sourcing_tot_budget_dzn_val/$order_job_qnty;
				$summ_tot_final_cm=($summ_fob_gross_value_amt-$summ_sourcing_tot_budget_dzn_val)/$offer_qty_dzn;
				// $tot_summ_fob_pcs=$summ_fob_pcs/$order_price_per_dzn;
				
				$supplier_library_arr=return_library_array( "select a.short_name, a.id from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id   and a.is_deleted=0  and a.status_active=1 group by a.id,a.short_name order by a.short_name", "id", "short_name");
				?>
				<style>
				#th_tbl_height {
				  height: 18px;
				  width: 100%;
				  border: 1px solid #4CAF50;
				}
				</style>
				<script>
					//gross_fob_value_th
					function fnc_fob_verify()
					{
						var gross_fob_value=document.getElementById('gross_fob_value_th').value*1;
						//alert(gross_fob_value);
						document.getElementById('fob_verify_td').innerHTML=number_format_common(gross_fob_value,2);
					}
					
				</script>
				<td valign="top">
					<table class="rpt_table" align="left" border="1" cellpadding="1" cellspacing="1" style="width:280px; margin:5px; font-size:14px;" rules="all">
						<tr>
							<td width="80" colspan="2" align="center"><b>Summary </b></td>
						</tr>
						<tr>
							<td width="80"><b>Header </b></td>
							<td width="80"><b>Pre Cost</b> </td>
						</tr>
						<tr>
							<td>PO Qty <?='-'.$unit_of_measurement[$orderUom]; ?></td>
							<td title="=<? echo $ordQtyUom;?>"><b><?=number_format($ordQtyUom,0); ?></b></td>
						</tr> 
						<tr>
							<td>FOB <?='-'.$unit_of_measurement[$orderUom]; ?></td>
							<td title="Price=<? echo $avg_unit_price;?>"><b><?=number_format($avg_unit_price,4); ?></b></td>
						</tr>
						<tr>
							<td>FOB Value</td>
							<td title=""><b><?=number_format($avg_unit_price*$ordQtyUom,2); ?></b></td>
						</tr> 
						<tr>
							<td>SMV/<?=$unit_of_measurement[$orderUom]; ?></td>
							<td title="=<? //echo $summ_fob_gross_value_amt;?>"><b><?=number_format($sew_smv,4); ?></b></td>
						</tr> 
						<tr>
							<td>Budget Cost/<?=$unit_of_measurement[$orderUom]; ?></td>
							<td  title="Budget Cost/<?=$unit_of_measurement[$orderUom]; ?>=<? echo $summ_fob_pcs;?>"><b><?=number_format($tot_summ_fob_pcs,4); ?></b></td>
						</tr> 
						<tr>
							<td>Margin/<?=$unit_of_measurement[$orderUom]; ?>[USD] &nbsp; <? echo $margin_dzn_percent;?>%</td>
							<td  title="<? //echo $summ_fob_gross_value_amt;?>"><b><? 
							$margin_pre=$margin_dzn;//$avg_unit_price-$tot_summ_fob_pcs;
							$margin_final=$avg_unit_price-$summ_sourcing_fob_pcs;
							echo  number_format($margin_pre,4); ?></b></td>
						</tr> 
						<tr>
							<td>Total Margin Value</td>
							<td title="Margin Pcs*PO Qty <?=$unit_of_measurement[$orderUom]; ?>"><b><?=number_format($ordQtyUom*$margin_pre,2);
							$tot_margin_value=$ordQtyUom*$margin_pre; ?></b></td>
						</tr> 
						
						<tr>
							<td><b>CM/<?=$unit_of_measurement[$orderUom]; ?>[USD]</b></td> 
							<td title="CM Cost+Margin/1 Pcs"><b><? echo number_format($cm_cost_dzn,4); ?></b></td>
						</tr> 
						<tr>
							<td>Total CM Value</td>
							<td  title="CM Pcs*PO Qty <?=$unit_of_measurement[$orderUom]; ?>"><b><?=number_format($ordQtyUom*$cm_cost_dzn,2); ?></b></td>
						</tr> 
						<tr>
							<td>E.P.M [USD]</td>
							<td title="CM/Costing Per/Sew SMV"><b><?=number_format($cm_cost_dzn/$order_price_per_dzn/$sew_smv,4); ?></b></td>
						</tr>
						<? 
						if($show_others==1){ 
							$sqlcpm=sql_select("select asking_profit from lib_standard_cm_entry where company_id=$cbo_company_name and '$costing_date' between applying_period_date and applying_period_to_date and status_active=1 and is_deleted=0");
							$asking_profit=0;
							foreach($sqlcpm as $sqlcpmrow){
								$asking_profit=$sqlcpmrow[csf('asking_profit')];
							}
							$profit_margin=$cm_cost*$asking_profit;
							$buffer=$total_fob-($total_cost+$profit_margin);
							?>
							<tr>
							<td>Profit Margin</td>
							<td  title="CM/<?=$unit_of_measurement[$orderUom]; ?> X Asking Profit %"><b><?=number_format($profit_margin,2); ?></b></td>
							</tr> 
							<tr>
								<td>Buffer</td>
								<td title="Total FOB - Total Cost - Profit Margin"><b><?=number_format($buffer,4); ?></b></td>
							</tr>
						<? } ?>
					</table>
				</td>
				<td valign="top">
					<? $nameArray_imge =sql_select("SELECT image_location,real_file_name FROM common_photo_library where master_tble_id=".$txt_job_no." and file_type=1"); ?>
					<br>      
					<table class="rpt_table" width="300"  border="1" cellpadding="0" cellspacing="0" rules="all">
						<tr>
							<td width="120">First Shipment Date:</td><td><?=change_date_format($first_pub_shipment_date); ?></td> 
						</tr>
						<tr>
							<td>Last Shipment Date:</td><td><?=change_date_format($last_pub_shipment_date);?></td>
						</tr>
						<tr>
							<td title="(CM/<?=$unit_of_measurement[$orderUom]; ?>[USD]+Margin/<?=$unit_of_measurement[$orderUom]; ?>[USD] &nbsp; <? echo $operating_oh_per;?>%)/SMV/<?=$unit_of_measurement[$orderUom]; ?>">EPM with Margin</td><td title="<?='('.$cm_cost_dzn.'+'.$margin_pre.')/'.$sew_smv; ?>"><?=number_format(($cm_cost_dzn+$margin_pre)/$sew_smv,4); ?></td>
						</tr>
						<tr>
							<td>FOB Verify:</td>
							<td id="fob_verify_td" title="Total Margin Value+GrossFOB Value [A+B+C+D+E+F+G]"><? $fob_varify=$avg_unit_price*$ordQtyUom;echo number_format($fob_varify,2);?></td>
						</tr>
					</table>
					<br/> <br/>
					<?
					if($approved_id==1) $app_msg="Approved"; else if($approved_id==3) $app_msg="Partial Approved";  else $app_msg="Un-Approved";
					
					if($app_msg!='')
					{
						?>
						<table class="rpt_table" width="300"  border="1" cellpadding="0" cellspacing="0" rules="all">
							<tr>
							<td style="color:#F00; font-size:16px"><b> Approval Status: &nbsp; <?=$app_msg;?> </b></td>
							</tr>
						</table>
						<?
					}
					?>
				</td>
			</tr>
			</table>
			<?
			//end first foearch
			if($zero_value==1)
			{	
				?>
				<table  class="rpt_table" border="1" cellpadding="1" cellspacing="1"  width="98%" style=" margin:5px;text-align:center; font-size:14px;" rules="all"> 
					<caption><b>Details Part</b></caption>
					<tr style="font-weight:bold">
						<td  width="20">SL </td>
						<td  width="350" title="Fabric">ITEM DESCRIPTION </td>
						<td  width="70">Cons/<?=$unit_of_measurement[$orderUom]; ?></td>
						<td  width="70">Wast % </td>
						<td  width="70">Total Cons/<?=$unit_of_measurement[$orderUom]; ?></td>
						<td  width="50">UOM </td>
						<td  width="70">Req. Qty</td>
						<td  width="70">Rate(USD)</td>
						<td  width="70">Cost/<?=$unit_of_measurement[$orderUom]; ?></td>
						<td  width="70">Total Budget</td>
						<td  width="170">Remarks</td>
					</tr>
					<?
					$f=1;$tot_fab_amount=$tot_fab_amount_pcs=$tot_fab_req_amount=0;$ff=1;$tot_fab_req_sourcing_amount=$tot_fab_req_sourcing_bal_amount=0;
					foreach($p_fab_precost_arr as $fabriccost_dtls_id=>$fabriccost_dtls_data)
					{
						foreach ($fabriccost_dtls_data as  $fab_type=>$fab_data) 
						{
							foreach($fab_data as $fab_desc=>$row)
							{
								if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
								
								$nominated_supp_str=""; 
								$exnominated_supp=explode(",",$row[('sourcing_nominated_supp')]);
								foreach($exnominated_supp as $supp)
								{
									if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_arr[$supp]; else $nominated_supp_str.=','.$supplier_library_arr[$supp];
								}	
								?>
								<tr id="" bgcolor="<? //echo $bgcolor;?>">
									<td width="20" align="center"><p><? echo $f; ?></p></td>
									<td width="350"><div style="word-break:break-all"><? echo $fab_desc; //echo $fab_type.','.$fab_desc; ?></div></td>
									<td width="70" align="right"><p><? echo number_format($row['cons'],4); ?></p></td>
									<td width="70" align="right"><p><? echo number_format($row[('p_loss')],4); ?></p></td>
									<td width="70" align="right"><p><? echo number_format($row[('tot_cons')],4); ?></p></td>
									<td width="50"><p><? echo $row[('uom')]; ?></p></td>
									<td width="70" align="right"><p><? echo number_format($row[('req_qty')],4); ?></p></td>
									<td width="70" align="right"><p><? echo number_format($row[('req_amount')]/$row[('req_qty')],4); ?></p></td>
									<td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,4); ?></p></td>
									<td width="70" align="right"><p><? echo number_format($row[('req_amount')],4); ?></p></td>
									<td width="170" align="left"><p><?=$row[('remarks')];?></p></td>
								</tr>
								<?
								$f++;$ff++;
								$tot_fab_amount+=$row[('amount')];
								$tot_fab_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
								$tot_fab_req_amount+=$row[('req_amount')];
								$tot_fab_req_sourcing_amount+=$row[('sourcing_rate')]*$row[('req_qty')];
								$tot_fab_req_sourcing_bal_amount+=$bal_sourcing_amount;
							}
						}
					}
					?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="8"> <b style="float:left">A Total Fabric Cost</b></td>
						<td  align="right"><b><? echo number_format($tot_fab_amount_pcs,4); ?></b></td>
						<td  align="right"><b><? echo number_format($tot_fab_req_amount,4); ?></b></td>
						<td  align="right"><b></b></td>
					</tr>
				</table>
				<?
			}
			else
			{ 
				if(count($p_fab_precost_arr)>0)
				{
					?>
					<table  class="rpt_table" border="1" cellpadding="1" cellspacing="1"  width="98%" style=" margin:5px;text-align:center; font-size:14px;" rules="all"> 
						<caption><b>Details Part</b></caption>
						<tr style="font-weight:bold">
							<td  width="20">SL </td>
							<td  width="350" title="Fabric">ITEM DESCRIPTION </td>
							<td  width="70">Cons/<?=$unit_of_measurement[$orderUom]; ?></td>
							<td  width="70">Wast % </td>
							<td  width="70">Total Cons/<?=$unit_of_measurement[$orderUom]; ?></td>
							<td  width="50">UOM </td>
							<td  width="70">Req. Qty</td>
							<td  width="70">Rate[USD]</td>
							<td  width="70">Cost/<?=$unit_of_measurement[$orderUom]; ?></td>
							<td  width="70">Total Budget</td>
							<td  width="170">Remarks</td>
						</tr>
						
						<?
						$f=1;$tot_fab_amount=$tot_fab_amount_pcs=$tot_fab_req_amount=0;$ff=1;$tot_fab_req_sourcing_amount=$tot_fab_req_sourcing_bal_amount=0;
						foreach($p_fab_precost_arr as $fabriccost_dtls_id=>$fabriccost_dtls_data)
						{
							foreach ($fabriccost_dtls_data as  $fab_type=>$fab_data) 
							{
								foreach($fab_data as $fab_desc=>$row)
								{
									if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
									
									$nominated_supp_str=""; 
									$exnominated_supp=explode(",",$row[('sourcing_nominated_supp')]);
									foreach($exnominated_supp as $supp)
									{
										if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_arr[$supp]; else $nominated_supp_str.=','.$supplier_library_arr[$supp];
									}	
									?>
									<tr  id="" bgcolor="<? //echo $bgcolor;?>">
										<td width="20" align="center"><p><? echo $f; ?></p></td>
										<td width="450"><div style="word-break:break-all"><? echo $fab_desc; //echo $fab_type.','.$fab_desc; ?></div></td>
										<td width="70" align="right"><p><? echo number_format($row['cons'],4); ?></p></td>
										<td width="70" align="right"><p><? echo number_format($row[('p_loss')],4); ?></p></td>
										<td width="70" align="right"><p><? echo number_format($row[('tot_cons')],4); ?></p></td>
										<td width="50"><p><? echo $row[('uom')]; ?></p></td>
										<td width="70" align="right"><p><? echo number_format($row[('req_qty')],4); ?></p></td>
										<td width="70" align="right"><p><? echo number_format($row[('req_amount')]/$row[('req_qty')],4); ?></p></td>
										<td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,4); ?></p></td>
										<td width="70" align="right"><p><? echo number_format($row[('req_amount')],4); ?></p></td>
										<td width="170" align="left"><p><?=$row[('remarks')];?></p></td>
									</tr>
									<?
									$f++;$ff++;
									$tot_fab_amount+=$row[('amount')];
									$tot_fab_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
									$tot_fab_req_amount+=$row[('req_amount')];
									$tot_fab_req_sourcing_amount+=$row[('sourcing_rate')]*$row[('req_qty')];
									$tot_fab_req_sourcing_bal_amount+=$bal_sourcing_amount;
								}
							}
						}
						?>
						<tr class="rpt_bottom" style="font-weight:bold">
							<td colspan="8"> <b style="float:left">A Total Fabric Cost</b></td>
							<td  align="right"><b><? echo number_format($tot_fab_amount_pcs,4); ?></b></td>
							<td  align="right"><b><? echo number_format($tot_fab_req_amount,4); ?></b></td>
							<td  align="right"><b></b></td>
						</tr>
					</table>
					<? 
				}// zero value check end
			}
				   // die;
				   
			if($zero_value==1)
			{
				?>
				<table class="rpt_table" border="1" cellpadding="0" cellspacing="0"  width="98%" style="text-align:center;margin:5px; font-size:14px;" rules="all">
					<tr style="font-weight:bold">
						<td  width="20">SL </td>
						<td  width="350" title="Trim sew">ITEM DESCRIPTION </td>
						<td  width="70">Cons/<?=$unit_of_measurement[$orderUom]; ?></td>
						<td  width="70">Wast % </td>
						<td  width="70">Total Cons/<?=$unit_of_measurement[$orderUom]; ?></td>
						<td  width="50">UOM </td>
						<td  width="70">Req. Qty</td>
						<td  width="70">Rate[USD]</td>
						<td  width="70">Cost/<?=$unit_of_measurement[$orderUom]; ?></td>
						<td  width="70">Total Budget</td>
						<td  width="170">Remarks</td>
					</tr>
					<?
					$trims_tot_amount=0;
					$ts=1;$tot_sew_amount=$tot_amount_pcs=$tot_sew_amount_pcs=$tot_sew_req_amount=0;$ttts=1;$tot_sew_req_sourcing_amount=$tot_sew_req_sourcing_bal_amount=0;
					
					foreach($pre_trim_result as $row){
					
						$trims_type=$row[csf('trim_type')];
						$description=$row[csf('description')];
						if($description!="") $descriptionCond=", ".$description; else $descriptionCond="";
						$item_id=$row[csf('item_name')].$descriptionCond;
						//$item_name_arr[$item_id]=$row[csf('item_name')].$descriptionCond;
						
						if($ts%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
						$nominated_supp_str=""; 
						$exnominated_supp=explode(",",$row[('sourcing_nominated_supp')]);
						foreach($exnominated_supp as $supp)
						{
							if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_arr[$supp]; else $nominated_supp_str.=','.$supplier_library_arr[$supp];
						}	
						
						$req_amt=$row[csf('cons_dzn_gmts')]*$row[csf('rate')];
						
						$p_sew_loss=$row[csf('ex_per')];
						$ex_tot=$row[csf('cons_dzn_gmts')]+(($row[csf('cons_dzn_gmts')]*$p_sew_loss)/100);
						
						$trim_req_qty=$trim_qty_arr[$row[csf('id')]];
						$trim_req_amount=$trim_amount_arr[$row[csf('id')]];
						
						//$p_sew_trim_precost_arr[$item_id]['tot_row']+=1;
						$p_sew_trim_tot_row+=1;
						
						$summ_fob_pcs+=$row[csf('amount')];	
						$summ_sourcing_tot_budget_dzn_val+=$trim_req_qty*$row[csf('sourcing_rate')];
						$summ_fob_gross_value_amt+=$trim_req_amount;
						?>
						<tr bgcolor="<? //echo $bgcolor;?>">
							<td width="20" align="center"><p><? echo $ts; ?></p></td>
							<td width="350" ><div style="word-break:break-all"><? echo $item_id; ?></div></td> 
							<td width="70" align="right"><p><? echo number_format($row[csf('tot_cons')],6); ?></p></td>
							<td width="70" align="right"><p><? echo number_format($p_sew_loss,6); ?></p></td>
							<td width="70" align="right"><p><?  echo number_format($row[csf('cons_dzn_gmts')],6); ?></p></td>
							<td width="50" align="center"><p><? echo $unit_of_measurement[$row[csf('uom')]]; ?></p></td>
							<td width="70" align="right"><p><? echo number_format($trim_req_qty,5); ?></p></td>
							<td width="70" align="right"><p><? echo number_format($trim_req_amount/$trim_req_qty,6); ?></p></td>
							<td width="70" align="right"><p><? echo number_format($row[csf('amount')]/$order_price_per_dzn,6); ?></p></td>
							<td width="70" align="right"><p><? echo number_format($trim_req_amount,6); ?></p></td>
							<td width="170" align="left"><p><?=$row[csf('remark')];?></p></td>
						</tr>
						<?
						$ts++;$ttts++;
						$tot_sew_amount+=$row[csf('amount')];
						$tot_sew_amount_pcs+=$row[csf('amount')]/$order_price_per_dzn;
						$tot_sew_req_amount+=$trim_req_amount;
						$tot_sew_req_sourcing_amount+=$row[csf('sourcing_rate')]*$trim_req_qty;
						$tot_sew_req_sourcing_bal_amount+=$bal_sourcing_amout;
						$trims_tot_amount+=$trim_req_amount;
					}
					?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="8" align="left"><b>B-Total Trims Cost:</b></td>
						<td  align="right"><b><? echo number_format($tot_sew_amount_pcs,6); ?></b></td>
						<td  align="right"><b><? echo number_format($tot_sew_req_amount,6); ?></b></td>
						<td  align="right"><b></b></td>
					</tr>
				</table>
				<?
			}
			else
			{ 
				if(count($pre_trim_result)>0)
				{
					?>
					<table class="rpt_table" border="1" cellpadding="0" cellspacing="0"  width="98%" style="text-align:center;margin:5px; font-size:14px;" rules="all">
						<tr style="font-weight:bold">
							<td  width="20">SL </td>
							<td  width="350" title="Trim sew">ITEM DESCRIPTION </td>
							<td  width="70">Cons/<?=$unit_of_measurement[$orderUom]; ?></td>
							<td  width="70">Wast % </td>
							<td  width="70">Total Cons/<?=$unit_of_measurement[$orderUom]; ?></td>
							<td  width="50">UOM </td>
							<td  width="70">Req. Qty</td>
							<td  width="70">Rate(USD)</td>
							<td  width="70">Cost/<?=$unit_of_measurement[$orderUom]; ?></td>
							<td  width="70">Total Budget</td>
							<td  width="170">Remarks</td>
						</tr>
						<?
						$trims_tot_amount=0;
						$ts=1;$tot_sew_amount=$tot_amount_pcs=$tot_sew_amount_pcs=$tot_sew_req_amount=0;$ttts=1;$tot_sew_req_sourcing_amount=$tot_sew_req_sourcing_bal_amount=0;
						
						foreach($pre_trim_result as $row){
							$trims_type=$row[csf('trim_type')];
							$description=$row[csf('description')];
							if($description!="") $descriptionCond=", ".$description; else $descriptionCond="";
							$item_id=$row[csf('item_name')].$descriptionCond;
							//$item_name_arr[$item_id]=$row[csf('item_name')].$descriptionCond;
							
							if($ts%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
							$nominated_supp_str=""; 
							$exnominated_supp=explode(",",$row[('sourcing_nominated_supp')]);
							foreach($exnominated_supp as $supp)
							{
								if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_arr[$supp]; else $nominated_supp_str.=','.$supplier_library_arr[$supp];
							}	
							
							$req_amt=$row[csf('cons_dzn_gmts')]*$row[csf('rate')];
							
							$p_sew_loss=$row[csf('ex_per')];
							$ex_tot=$row[csf('cons_dzn_gmts')]+(($row[csf('cons_dzn_gmts')]*$p_sew_loss)/100);
							
							$trim_req_qty=$trim_qty_arr[$row[csf('id')]];
							$trim_req_amount=$trim_amount_arr[$row[csf('id')]];
							
							//$p_sew_trim_precost_arr[$item_id]['tot_row']+=1;
							$p_sew_trim_tot_row+=1;
							
							$summ_fob_pcs+=$row[csf('amount')];	
							$summ_sourcing_tot_budget_dzn_val+=$trim_req_qty*$row[csf('sourcing_rate')];
							$summ_fob_gross_value_amt+=$trim_req_amount;
							?>
							<tr bgcolor="<? //echo $bgcolor;?>">
								<td width="20" align="center"><p><? echo $ts; ?></p></td>
								<td width="350" ><div style="word-break:break-all"><? echo $item_id; ?></div></td> 
								<td width="70" align="right"><p><? echo number_format($row[csf('tot_cons')],6); ?></p></td>
								<td width="70" align="right"><p><? echo number_format($p_sew_loss,6); ?></p></td>
								<td width="70" align="right"><p><?  echo number_format($row[csf('cons_dzn_gmts')],6); ?></p></td>
								<td width="50" align="center"><p><? echo $unit_of_measurement[$row[csf('uom')]]; ?></p></td>
								<td width="70" align="right"><p><? echo number_format($trim_req_qty,5); ?></p></td>
								<td width="70" align="right"><p><? echo number_format($trim_req_amount/$trim_req_qty,6); ?></p></td>
								<td width="70" align="right"><p><? echo number_format($row[csf('amount')]/$order_price_per_dzn,6); ?></p></td>
								<td width="70" align="right"><p><? echo number_format($trim_req_amount,6); ?></p></td>
								<td width="170" align="left"><p><?=$row[csf('remark')];?></p></td>
							</tr>
							<?
							$ts++;$ttts++;
							$tot_sew_amount+=$row[csf('amount')];
							$tot_sew_amount_pcs+=$row[csf('amount')]/$order_price_per_dzn;
							$tot_sew_req_amount+=$trim_req_amount;
							$tot_sew_req_sourcing_amount+=$row[csf('sourcing_rate')]*$trim_req_qty;
							$tot_sew_req_sourcing_bal_amount+=$bal_sourcing_amout;
							$trims_tot_amount+=$trim_req_amount;
						}
						?>
						<tr class="rpt_bottom" style="font-weight:bold">
							<td colspan="8" align="left"><b>B-Total Trims Cost:</b></td>
							<td  align="right"><b><? echo number_format($tot_sew_amount_pcs,6); ?></b></td>
							<td  align="right"><b><? echo number_format($tot_sew_req_amount,6); ?></b></td>
							<td  align="right"><b></b></td>
						</tr>
					</table>
					<?    
				}
			}
					// die;
			if($zero_value==1)
			{
				?>
				<table align="left" class="rpt_table" border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px; font-size:14px;" rules="all"> 
					<caption><b style="float:left">Gmts Wash</b></caption>
					<tr align="center">
						<td width="20">SL </td>
						<td width="400" title="Wash ">ITEM DESCRIPTION </td>
						<td width="70">Cons/PCS</td>
						<td width="70">Wast % </td>
						<td width="70">Total Cons/<?=$unit_of_measurement[$orderUom]; ?></td>
						<td width="50">UOM </td>
						<td width="70">Req. Qty</td>
						<td width="70"> Rate(USD)</td>
						<td width="70">Cost/<?=$unit_of_measurement[$orderUom]; ?></td>
						<td width="70">Total Budget</td>
					</tr>
					<?
					$w=1;$tot_wash_amount=$tot_wash_amount_pcs=$tot_wash_req_amount=$tot_wash_sourcing_req_amount=$tot_wash_sourcing_req_amount_bal=0;$ws=1;
					foreach($p_wash_precost_arr as $embname_id=>$row)
					{
						if($w%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
						$wash_nominated_supp_str=""; 
						$exnominated_suppArr=explode(",",$row[('sourcing_nominated_supp')]);
						foreach($exnominated_suppArr as $supp)
						{
							if($wash_nominated_supp_str=="") $wash_nominated_supp_str=$supplier_library_arr[$supp]; else $wash_nominated_supp_str.=','.$supplier_library_arr[$supp];
						}		
						?>
						<tr bgcolor="<? //echo $bgcolor;?>">
							<td width="20" align="center"><p><? echo $w; ?></p></td>
							<td width="400"><div style="word-break:break-all"><? $embname_id=explode(", ",$embname_id);echo $embname_id[1]; ?></div></td> 
							<td width="70" align="right"><p><? echo number_format($row[('cons')],4); ?></p></td>
							<td width="70" align="right"><p><? //echo $row[('p_loss')]; ?></p></td>
							<td width="70" align="right"><p><?  echo number_format($row[('cons')],4) ?></p></td>
							<td width="50"  align="center"><p><? echo $costing_val; ?></p></td>
							<td width="70" align="right"><p><? echo number_format($row[('req_qty')],4); ?></p></td>
							<td width="70" align="right" title="Rate=<? echo $row[('pre_rate')];?>"><p><? echo number_format($row[('pre_rate')],4); ?></p></td>
							<td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,4); ?></p></td>
							<td width="70" align="right"><p><? echo number_format($row[('req_qty')]*$row[('pre_rate')],4); ?></p></td>
						</tr>
						<?
						$w++;$ws++;
						$tot_wash_amount+=$row[('amount')];
						$tot_wash_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
						$tot_wash_req_amount+=$row[('req_qty')]*$row[('pre_rate')];
						$tot_wash_sourcing_req_amount+=$sourcing_tot_amount;
						$tot_wash_sourcing_req_amount_bal+=$sourcing_tot_amount_bal;
					}
					?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="8"> <b>C-Total Wash Cost :</b></td>
						<td  align="right"><b><? echo number_format($tot_wash_amount_pcs,4); ?></b></td>
						<td  align="right"><b><? echo number_format($tot_wash_req_amount,4); ?></b></td>
					</tr>
				</table>
				<?
			}
			else
			{ 
				if(count($p_wash_precost_arr)>0)
				{
					?>
					<table align="left" class="rpt_table" border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px; font-size:14px;" rules="all"> 
						<caption><b style="float:left">Gmts Wash</b></caption>
						<tr align="center">
							<td width="20">SL </td>
							<td width="450" title="Wash ">ITEM DESCRIPTION </td>
							<td width="70">Cons/PCS</td>
							<td width="70">Wast % </td>
							<td width="70">Total Cons/<?=$unit_of_measurement[$orderUom]; ?></td>
							<td width="50">UOM </td>
							<td width="70">Req. Qty</td>
							<td width="70"> Rate(USD)</td>
							<td width="70">Cost/<?=$unit_of_measurement[$orderUom]; ?></td>
							<td width="70">Total Budget</td>
						</tr>
						<?
						$w=1;$tot_wash_amount=$tot_wash_amount_pcs=$tot_wash_req_amount=$tot_wash_sourcing_req_amount=$tot_wash_sourcing_req_amount_bal=0;$ws=1;
						foreach($p_wash_precost_arr as $embname_id=>$row)
						{
							if($w%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
							$wash_nominated_supp_str=""; 
							$exnominated_suppArr=explode(",",$row[('sourcing_nominated_supp')]);
							foreach($exnominated_suppArr as $supp)
							{
								if($wash_nominated_supp_str=="") $wash_nominated_supp_str=$supplier_library_arr[$supp]; else $wash_nominated_supp_str.=','.$supplier_library_arr[$supp];
							}		
							?>
							<tr bgcolor="<? //echo $bgcolor;?>">
								<td width="20" align="center"><p><? echo $w; ?></p></td>
								<td width="450"><div style="word-break:break-all"><? $embname_id=explode(", ",$embname_id);echo $embname_id[1]; ?></div></td> 
								<td width="70" align="right"><p><? echo number_format($row[('cons')],4); ?></p></td>
								<td width="70" align="right"><p><? //echo $row[('p_loss')]; ?></p></td>
								<td width="70" align="right"><p><?  echo number_format($row[('cons')],4) ?></p></td>
								<td width="50"  align="center"><p><? echo $costing_val; ?></p></td>
								<td width="70" align="right"><p><? echo number_format($row[('req_qty')],4); ?></p></td>
								<td width="70" align="right" title="Rate=<? echo $row[('pre_rate')];?>"><p><? echo number_format($row[('pre_rate')],4); ?></p></td>
								<td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,4); ?></p></td>
								<td width="70" align="right"><p><? echo number_format($row[('req_qty')]*$row[('pre_rate')],4); ?></p></td>
							</tr>
							<?
							$w++;$ws++;
							$tot_wash_amount+=$row[('amount')];
							$tot_wash_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
							$tot_wash_req_amount+=$row[('req_qty')]*$row[('pre_rate')];
							$tot_wash_sourcing_req_amount+=$sourcing_tot_amount;
							$tot_wash_sourcing_req_amount_bal+=$sourcing_tot_amount_bal;
						}
						?>
						<tr class="rpt_bottom" style="font-weight:bold">
							<td colspan="8"> <b>C-Total Wash Cost :</b></td>
							<td  align="right"><b><? echo number_format($tot_wash_amount_pcs,4); ?></b></td>
							<td  align="right"><b><? echo number_format($tot_wash_req_amount,4); ?></b></td>
						</tr>
					</table>
					<? 
				}
			}
			if($zero_value==1)
			{
				?>
				<table align="left" class="rpt_table" border="1" cellpadding="0" cellspacing="0"  width="98%" style="margin:5px; text-align:center; font-size:14px;" rules="all"> 
					<caption><b style="float:left">Embellishment Cost</b></caption>
					<tr>
						<td width="20">SL </td>
						<td width="450" title="">ITEM DESCRIPTION </td>
						<td width="70">Cons/PCS</td>
						<td width="70">Wast % </td>
						<td width="70">Total Cons/<?=$unit_of_measurement[$orderUom]; ?></td>
						<td width="50">UOM </td>
						<td width="70">Req. Qty</td>
						<td width="70">Rate(USD)</td>
						<td width="70">Cost/<?=$unit_of_measurement[$orderUom]; ?></td>
						<td width="70">Total Budget</td>
					</tr>
					<?
					$em=1;$tot_embro_amount=$tot_embro_amount_pcs=$tot_embro_req_amount=$tot_emb_sourcing_req_amount=$tot_emb_sourcing_req_amount_bal=0;$emb=1;
					foreach($p_embro_precost_arr as $embname_id=>$row)
					{
						if($w%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
						$emb_nominated_supp_str=""; 
						$emb_exnominated_suppArr=explode(",",$row[('sourcing_nominated_supp')]);
						foreach($emb_exnominated_suppArr as $supp)
						{
							if($emb_nominated_supp_str=="") $emb_nominated_supp_str=$supplier_library_arr[$supp]; else $emb_nominated_supp_str.=','.$supplier_library_arr[$supp];
						}		
						?>
						<tr bgcolor="<? echo $bgcolor;?>">
							<td width="20" align="center"><p><? echo $em; ?></p></td>
							<td width="450"><div style="word-break:break-all"><? echo $embname_id; ?></div></td> 
							<td width="70" align="right"><p><? echo number_format($row[('cons')],4); ?></p></td>
							<td width="70" align="right"><p><? //echo $row[('p_loss')]; ?></p></td>
							<td width="70" align="right"><p><?  echo number_format($row[('cons')],4); ?></p></td>
							<td width="50"  align="center"><p><? echo $costing_val; ?></p></td>
							<td width="70" align="right"><p><? echo number_format($row[('req_qty')],4); ?></p></td>
							<td width="70" align="right"><p><? echo number_format($row[('req_amount')]/$row[('req_qty')],4); ?></p></td>
							<td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,4); ?></p></td>
							<td width="70" align="right"><b><? echo number_format($row[('req_amount')],4); ?></b></td>
						</tr>
						<?
						$em++;$emb++;
						$tot_embro_amount+=$row[('amount')];
						$tot_embro_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
						$tot_embro_req_amount+=$row[('req_amount')];
						$tot_emb_sourcing_req_amount+=$emb_sourcing_tot_amount;
						$tot_emb_sourcing_req_amount_bal+=$emb_sourcing_tot_amount_bal;
					}
					?>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="8"> <b>D-Total Embellishment Cost:</b></td>
						<td  align="right"><b><? echo number_format($tot_embro_amount_pcs,4); ?></b></td>
						<td  align="right"><b><? echo number_format($tot_embro_req_amount,4); ?></b></td>
					</tr>
				</table>
				<?
			}
			else{ 
				if(count($p_embro_precost_arr)>0)
				{
					?>
					<table align="left" class="rpt_table" border="1" cellpadding="0" cellspacing="0"  width="98%" style="margin:5px; text-align:center; font-size:14px;" rules="all"> 
						<caption><b style="float:left">Embellishment Cost</b></caption>
						<tr>
							<td width="20">SL </td>
							<td width="450" title="">ITEM DESCRIPTION </td>
							<td width="70">Cons/<?=$unit_of_measurement[$orderUom]; ?></td>
							<td width="70">Wast % </td>
							<td width="70">Total Cons/<?=$unit_of_measurement[$orderUom]; ?></td>
							<td width="50">UOM </td>
							<td width="70">Req. Qty</td>
							<td width="70">Rate(USD)</td>
							<td width="70">Cost/<?=$unit_of_measurement[$orderUom]; ?></td>
							<td width="70">Total Budget</td>
						</tr>
						<?
						$em=1;$tot_embro_amount=$tot_embro_amount_pcs=$tot_embro_req_amount=$tot_emb_sourcing_req_amount=$tot_emb_sourcing_req_amount_bal=0;$emb=1;
						foreach($p_embro_precost_arr as $embname_id=>$row)
						{
							if($w%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
							$emb_nominated_supp_str=""; 
							$emb_exnominated_suppArr=explode(",",$row[('sourcing_nominated_supp')]);
							foreach($emb_exnominated_suppArr as $supp)
							{
								if($emb_nominated_supp_str=="") $emb_nominated_supp_str=$supplier_library_arr[$supp]; else $emb_nominated_supp_str.=','.$supplier_library_arr[$supp];
							}		
							?>
							<tr bgcolor="<? echo $bgcolor;?>">
								<td width="20" align="center"><p><? echo $em; ?></p></td>
								<td width="450"><div style="word-break:break-all"><? echo $embname_id; ?></div></td> 
								<td width="70" align="right"><p><? echo number_format($row[('cons')],4); ?></p></td>
								<td width="70" align="right"><p><? //echo $row[('p_loss')]; ?></p></td>
								<td width="70" align="right"><p><?  echo number_format($row[('cons')],4); ?></p></td>
								<td width="50" align="center"><p><? echo $costing_val; ?></p></td>
								<td width="70" align="right"><p><? echo number_format($row[('req_qty')],4); ?></p></td>
								<td width="70" align="right"><p><? echo number_format($row[('req_amount')]/$row[('req_qty')],4); ?></p></td>
								<td width="70" align="right"><p><? echo number_format($row[('amount')]/$order_price_per_dzn,4); ?></p></td>
								<td width="70" align="right"><b><? echo number_format($row[('req_amount')],4); ?></b></td>
							</tr>
							<?
							$em++;$emb++;
							$tot_embro_amount+=$row[('amount')];
							$tot_embro_amount_pcs+=$row[('amount')]/$order_price_per_dzn;
							$tot_embro_req_amount+=$row[('req_amount')];
							$tot_emb_sourcing_req_amount+=$emb_sourcing_tot_amount;
							$tot_emb_sourcing_req_amount_bal+=$emb_sourcing_tot_amount_bal;
						}
						?>
						<tr class="rpt_bottom" style="font-weight:bold">
							<td colspan="8"> <b>D-Total Embellishment Cost:</b></td>
							<td  align="right"><b><? echo number_format($tot_embro_amount_pcs,4); ?></b></td>
							<td  align="right"><b><? echo number_format($tot_embro_req_amount,4); ?></b></td>
						</tr>
					</table>
					<?  
				}
			}
			?>
					 
			<table align="left" class="rpt_table" border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px; font-size:14px;" rules="all"> 
				<caption><b style="float:left">Others Components</b></caption>
				<tr>
					<td width="20">SL </td>
					<td title="450"><b>Others Components</b> </td>
					<td width="70"><b>Cost/<?=$unit_of_measurement[$orderUom]; ?></b></td>
					<td width="70"><b>Total Budget</b></td>
				</tr>
				<tbody> 
					<?
					//$em=1;$tot_embro_amount=$tot_embro_amount_pcs=$tot_embro_req_amount=0;$emb=1;
					$bgcolor="#E9F3FF";
					$bgcolor2="#FFFFFF";//currier_pre_cost_dzn
					
					// $tot_other_cost=0; 
					$tot_other_cost_first=$tot_other_cost+$comarcial+$inspection+$currier_pre_cost+$lab_test;
					
					$total_other_cost_dzn=$tot_other_cost_dzn+$comarcial_dzn+$inspection_dzn+$lab_test_dzn+$currier_pre_cost_dzn;
					$tot_other_cost_pcs=$tot_other_cost_dzn/$order_price_per_dzn;
					$tot_comarcial_dzn_pcs=$comarcial_dzn/$order_price_per_dzn;//here
					$tot_inspection_dzn_pcs=$inspection_dzn/$order_price_per_dzn;
					$currier_pre_cost_dzn_pcs=$currier_pre_cost_dzn/$order_price_per_dzn;
					$tot_lab_test_dzn_pcs=$lab_test_dzn/$order_price_per_dzn;
					$studio_pre_cost_psc=$studio_pre_cost_dzn/$order_price_per_dzn;
					
					
					$total_other_cost_pcs=$tot_other_cost_pcs+$tot_comarcial_dzn_pcs+$tot_lab_test_dzn_pcs+$tot_inspection_dzn_pcs+$currier_pre_cost_dzn_pcs+$studio_pre_cost_psc;
					$tot_other_cost_req_amount=$tot_other_cost_first+$studio_pre_cost_psc;
					
					if($zero_value==1)
					{
						?>
						<tr bgcolor="<? echo $bgcolor;?>">
							<td width="20" align="center"><p>1</p></td>
							<td width="450" align="" ><b>Test Charge</b></td> 
							<td width="70" align="right"><p><? echo number_format($tot_lab_test_dzn_pcs,4); ?></p></td>
							<td width="70" align="right"><p><? echo number_format($lab_test,4); ?></p></td>
						 </tr>
						<?
					}
					else
					{
						if($tot_lab_test_dzn_pcs>0)
						{
							?>
							<tr bgcolor="<? echo $bgcolor;?>">
								<td width="20" align="center"><p>1</p></td>
								<td width="450" align="" ><b>Test Charge</b></td> 
								<td width="70" align="right"><p><?   echo number_format($tot_lab_test_dzn_pcs,4); ?></p></td>
								<td width="70" align="right"><p><? echo number_format($lab_test,4); ?></p></td>
							</tr>
							<? 
						}
					}
					
					if($zero_value==1)
					{
						?>
						<tr bgcolor="<? echo $bgcolor2;?>">
							<td width="20" align="center" ><p>2</p></td>
							<td width="450"><b>Courier Charge</b></td> 
							<td width="70" align="right"><p><?  echo number_format($currier_pre_cost_dzn_pcs,4); ?></p></td>
							<td width="70" align="right"><p><? echo number_format($currier_pre_cost,4); ?></p></td>
						</tr>
						<?
					}
					else
					{  
						if($currier_pre_cost_dzn_pcs>0)
						{  ?>
							<tr bgcolor="<? echo $bgcolor2;?>">
								<td width="20" align="center" ><p>2</p></td>
								<td width="450"><b>Courier Charge</b></td> 
								<td width="70" align="right"><p><?  echo number_format($currier_pre_cost_dzn_pcs,4); ?></p></td>
								<td width="70" align="right"><p><? echo number_format($currier_pre_cost,4); ?></p></td>
							</tr> 
							<? 
						}
					}
					
					if($zero_value==1)
					{
						?>
						<tr bgcolor="<? echo $bgcolor;?>">
							<td width="20" align="center" ><p>3</p></td>
							<td width="450"><b>Inspection Charge</b></td> 
							<td width="70" align="right"><p><? echo number_format($tot_inspection_dzn_pcs,4); ?></p></td>
							<td width="70" align="right"><p><? echo number_format($inspection,4); ?></p></td>
						</tr>
						<?
					}
					else
					{ 
						if($tot_inspection_dzn_pcs>0)
						{
							?>
							<tr bgcolor="<? echo $bgcolor;?>">
								<td width="20" align="center" ><p>3</p></td>
								<td width="450"><b>Inspection Charge</b></td> 
								<td width="70" align="right"><p><? echo number_format($tot_inspection_dzn_pcs,4); ?></p></td>
								<td width="70" align="right"><p><? echo number_format($inspection,4); ?></p></td>
							</tr>
							<? 
						}
					}
					
					if($zero_value==1)
					{
						?>
						<tr bgcolor="<? echo $bgcolor;?>">
							<td width="20" align="center" ><p>4</p></td>
							<td width="450"><b>Commercial Charge</b></td> 
							<td width="70" align="right" title="Comml.+Studio/Others"><p>
								<? 
									$tot_comarcial_dzn_pcs=$tot_comarcial_dzn_pcs+$studio_pre_cost_psc;
										echo number_format($tot_comarcial_dzn_pcs,4); 
								 ?></p>
							</td>
							<td width="70" align="right"><p>
								<?$comarcial=$comarcial+$studio_pre_cost_psc; echo number_format($comarcial,4); ?></p></td>
						</tr>
						<?
					}
					else
					{ 
						if($tot_comarcial_dzn_pcs>0)
						{
							?>
							<tr bgcolor="<? echo $bgcolor;?>">
								<td width="20" align="center" ><p>4</p></td>
								<td width="450"><b>Commercial Charge</b></td> 
								<td width="70" align="right"><p><?  echo number_format($tot_comarcial_dzn_pcs,4); ?></p></td>
								<td width="70" align="right"><p><? echo number_format($comarcial,4); ?></p></td>
							</tr>
							<? 
						}
					}
					?>
					<tr bgcolor="<? echo $bgcolor2;?>">
						<td width="20" align="center"><p>5</p></td>
						<td width="450" title="Freight+Certif.Cost+Design Cost+Deprec.&Amort.+Deprec.&Amort.+Interest+Income Tax">
						<b>Others Charge</b></td> 
						<td width="70" align="right"><p><? echo number_format($tot_other_cost_pcs,4); ?></p></td>
						<td width="70" align="right"><p><? echo number_format($tot_other_cost,4); ?></p></td>
					</tr>
				</tbody>
				<tfoot>
					<tr style="font-size:12px; background-color:#CCC">
						<td colspan="2"> <b>E-Total Others Cost:</b></td>
						<td  align="right"><b><? echo number_format($total_other_cost_pcs,4); ?></b></td>
						<td  align="right"><b><? echo number_format($tot_other_cost_req_amount,4); ?></b></td>
					</tr>
				</tfoot>
			</table>
			<table align="left" class="rpt_table" border="1" cellpadding="0" cellspacing="0"  width="98%" style=" margin:5px; font-size:14px;" rules="all"> 
				<caption><b style="float:left"> Commission Cost:</b></caption>
				<tr>
					<td  width="20">SL </td>
					<td width="450" title="">Commission Cost </td>
					<td  width="70">Cost/<?=$unit_of_measurement[$orderUom]; ?></td>
					<td  width="70">Total Budget</td>
				</tr>
				<tbody> 
					<?
					$tot_commission_amount=$commission_arr[1]['commi_amt']+$commission_arr[2]['commi_amt'];
					$tot_commission_amount_pcs=($commission_arr[1]['commi_amt']/$order_price_per_dzn)+($commission_arr[2]['commi_amt']/$order_price_per_dzn);
					$tot_commision_req_amount=$commission_arr[1]['commi_req_amt']+$commission_arr[2]['commi_req_amt'];
					?>
					<tr bgcolor="<? echo $bgcolor;?>">
						<td width="20" align="center"><p>1</p></td>
						<td width="450" ><b>Local </b></td> 
						<td width="70" align="right"><p><? echo number_format($commission_arr[2]['commi_amt']/$order_price_per_dzn,4); ?></p></td>
						<td width="70" align="right"><p><? echo number_format($commission_arr[2]['commi_req_amt'],4); ?></p></td>
					</tr>
					<tr bgcolor="<? echo $bgcolor2;?>">                     
						<td width="20" align="center"><p>2</p></td>
						<td width="450" ><b>Foreign</b></td> 
						<td width="70" align="right"><p><? echo number_format($commission_arr[1]['commi_amt']/$order_price_per_dzn,4); ?></p></td>
						<td width="70" align="right"><p><? echo number_format($commission_arr[1]['commi_req_amt'],4); ?></p></td>
					</tr>
				</tbody>
				<tfoot>
					<tr>
						<td colspan="2"> <b>F-Total Commission Cost:</b></td>
						<td  align="right"><b><? echo number_format($tot_commission_amount_pcs,4); ?></b></td>
						<td  align="right"><b><? echo number_format($tot_commision_req_amount,4); ?></b></td>
					</tr>
					<tr bgcolor="<? echo $bgcolor;?>">
						<td width="20" align="center"><p>1</p></td>
						<td width="450"><b>G-Total CM Cost</b></td> 
						<td width="70" align="right"><b><? $tot_cm_cost_pcs=$cm_cost_dzn/$order_price_per_dzn;echo number_format($tot_cm_cost_pcs,4); ?></b></td>
						<td width="70" title="CM Cost*PO Qty " align="right"><b><? echo number_format($cmCost,4); ?></b></td>
					</tr>
					<tr bgcolor="<? echo $bgcolor;?>"> 
						<td width="450" colspan="2"><p> <b>Gross FOB Value [A+B+C+D+E+F+G]</b></p></td> 
						<?php //tot_sew_amount_pcs
						$gross_fob_value_dzn=$tot_fab_amount+$trim_sew_fin_amt+$tot_wash_amount+$tot_embro_amount+$tot_other_cost_dzn+$tot_commission_amount+$cm_cost_dzn;
						$gross_fob_value_pcs=$tot_fab_amount_pcs+$trim_sew_fin_amt_pcs+$tot_wash_amount_pcs+$tot_embro_amount_pcs+$tot_other_cost_pcs+$tot_commission_amount_pcs+$tot_cm_cost_pcs;
						//echo $tot_fab_amount_pcs.'=='.$trim_sew_fin_amt_pcs.'=='.$tot_wash_amount_pcs.'=='.$tot_embro_amount_pcs.'=='.$tot_commission_amount_pcs.'=='.$tot_cm_cost_pcs;
						//$gross_fob_value_req=$tot_fab_req_amount+$trim_fin_req_amount+$tot_wash_req_amount+$tot_embro_req_amount+$tot_commision_req_amount+$tot_other_cost_req_amount+$cm_cost_req;
						
						$gross_fob_value_req=$tot_fab_req_amount+$trims_tot_amount+$tot_wash_req_amount+$tot_embro_req_amount+$tot_other_cost_req_amount+$tot_commision_req_amount+$cmCost;
						
						//---fob value
						$total_fob_gross_pcs=$tot_fab_amount_pcs+$trim_sew_fin_amt_pcs+$tot_wash_amount_pcs+$tot_embro_amount_pcs+$tot_other_cost_pcs+$tot_commission_amount_pcs+$tot_cm_cost_pcs;
						$total_fob_gross_dzn=$tot_fab_amount+$trim_sew_fin_amt+$tot_sew_amount_pcs+$tot_wash_amount+$tot_embro_amount+$total_other_cost_dzn+$tot_commission_amount+$cm_cost_dzn;
						$tot_gross_fob_pcs=$total_fob_gross_dzn/$order_price_per_dzn;
						$gross_fob_value_dzn_without_commi=$total_fob_gross_dzn-$tot_commission_amount;
						$gross_fob_value_pcs_without_commi=$tot_gross_fob_pcs-$tot_commission_amount_pcs;
						$gross_fob_value_req_without_commi=$gross_fob_value_req-$tot_commision_req_amount;
						?>					
						<td width="70" align="right"><b> <? echo number_format($tot_gross_fob_pcs,4); ?></b></td>
						<td width="70" id="gross_fob_value_td" align="right" title="<? echo $gross_fob_value_req."=".$tot_fab_req_amount."+".$trims_tot_amount."+".$tot_wash_req_amount."+".$tot_embro_req_amount."+".$tot_other_cost_req_amount."+".$tot_commision_req_amount."+".$cmCost;?>"><b><? echo number_format($gross_fob_value_req,4); ?></b>  
						<input type="hidden" id="gross_fob_value_th" width="70px" value="<? echo $gross_fob_value_req+$tot_margin_value; ?>"></td>
				   
					</tr>
					<tr bgcolor="<? echo $bgcolor2;?>">
						<td width="450" colspan="2"><b>Net FOB Value (Without Commission)</b></td> 
						<td width="70" align="right"><b><? echo number_format($gross_fob_value_pcs_without_commi,4); ?> </b></td>
						<td width="70" align="right"><b><? echo number_format($gross_fob_value_req_without_commi,4); ?> </b></td>
					</tr>
				</tfoot>
			</table>
			<script>
					fnc_fob_verify();
			</script>
			<div style="float:left" align="left">  <b> &nbsp;&nbsp;&nbsp;&nbsp; <? //echo $inserted_by;?> </b></div>
			<div style="clear:both"></div>
			<? 
			$cbo_company_name=str_replace("'","",$cbo_company_name);
			if ($cbo_template_id != '') {
				$template_id = " and a.template_id=$cbo_template_id ";
			}
			 
			$path=($path!='')?$path:"../../";
			//$inserted_by=return_field_value("inserted_by", "wo_pre_cost_mst", "job_no='".str_replace("'","",$txt_job_no)."'");
			$job_info=sql_select("SELECT id, inserted_by from wo_pre_cost_mst where status_active=1 and is_deleted=0 and job_no='".str_replace("'","",$txt_job_no)."'");
			foreach ($job_info as $row) {
				$inserted_by=$row[csf('inserted_by')];
				$job_id=$row[csf('id')];
			}
			
		   $signature_arr=return_library_array( "select master_tble_id,image_location from common_photo_library where form_name='user_signature'",'master_tble_id','image_location');
			$appSql="select approved_by from approval_history where entry_form=46 and mst_id = $job_id and is_signing=1";
			$appSqlRes=sql_select($appSql);
			foreach($appSqlRes as $row){
				$userSignatureArr[$row[csf('approved_by')]]=$path.$signature_arr[$row[csf('approved_by')]];	
			}
			$userSignatureArr[$inserted_by]=$path.$signature_arr[$inserted_by];
	
			echo signature_table(218, $cbo_company_name, "1200px",$cbo_template_id,50,$inserted_by,$userSignatureArr);
			?>            
		 </div>
		 <div style="clear:both"></div>
		<?
		$mailBody=ob_get_contents();
		ob_clean();
		echo $mailBody;
	
		//Mail send------------------------------------------
		list($msil_address,$is_mail_send,$mail_body)=explode('**',$mail_data);
		if($is_mail_send==1){
		
			require_once('../../../mailer/class.phpmailer.php');
			require_once('../../../auto_mail/setting/mail_setting.php');
			
			$mailBody = preg_replace("/<img[^>]+\>/i", " ", $mailBody); 	
			$mailToArr=array();
			if($msil_address){$mailToArr[]=$msil_address;}
				
			$mailSql = "SELECT c.TEAM_LEADER_EMAIL, d.USER_EMAIL FROM wo_po_details_master  a,  wo_pre_cost_mst b, lib_marketing_team c, USER_PASSWD d WHERE a.job_no = b.job_no  AND a.TEAM_LEADER = c.id AND b.INSERTED_BY = d.id AND a.status_active = 1  AND a.job_no=$txt_job_no";
			//echo $mailSql;die;
			$mailSqlRes=sql_select($mailSql);
			foreach($mailSqlRes as $rows){
				if($rows['TEAM_LEADER_EMAIL']){$mailToArr[$rows['TEAM_LEADER_EMAIL']]=$rows['TEAM_LEADER_EMAIL'];}
				if($rows['USER_EMAIL']){$mailToArr[$rows['USER_EMAIL']]=$rows['USER_EMAIL'];}
			}
			
			
			$elcetronicSql = "SELECT a.BUYER_ID,a.SEQUENCE_NO,a.BYPASS,b.USER_EMAIL  from electronic_approval_setup a join user_passwd b on a.user_id=b.id where b.valid=1  AND a.page_id in(428,1717,2150) and a.company_id=$cbo_company_name order by a.SEQUENCE_NO"; //and a.
			
			$elcetronicSqlRes=sql_select($elcetronicSql);
			foreach($elcetronicSqlRes as $rows){
				
			
				if($rows[BUYER_ID]!=''){
					foreach(explode(',',$rows[BUYER_ID]) as $bi){
						if($rows['USER_EMAIL']!='' && $bi==$buyer_name_id){$mailToArr[$rows['USER_EMAIL']]=$rows['USER_EMAIL'];}
						if($rows[BYPASS]==2){break;}
					}
				}
				else{
					if($rows[USER_EMAIL]){$mailToArr[$rows['USER_EMAIL']]=$rows['USER_EMAIL'];}
					if($rows[BYPASS]==2){break;}
				}
			}
			
			//Un-approve request mail......................................................
			$user_id=$_SESSION['logic_erp']['user_id'];
			$job_id=return_field_value("id", "wo_pre_cost_mst", "job_no='".str_replace("'","",$txt_job_no)."'");
			$approved_no=return_field_value("MAX(approved_no) as approved_no","approval_history","entry_form=46 and mst_id=$job_id","approved_no")+1;
			$unapproved_request=return_field_value("APPROVAL_CAUSE","fabric_booking_approval_cause","entry_form=46 and user_id=$user_id and booking_id=$job_id and approval_type=2 and approval_no='$approved_no'");//page_id=$page_id and
			if($unapproved_request){
				$mailToArr=array();
				if($msil_address){$mailToArr[]=$msil_address;}
				$final_app_user_mail=return_field_value("USER_EMAIL","user_passwd","id in(select APPROVED_BY from APPROVAL_HISTORY where id in(select max(id) from APPROVAL_HISTORY where mst_id=$job_id and ENTRY_FORM=46 and CURRENT_APPROVAL_STATUS=1))");
				$mailToArr[]= $final_app_user_mail;
			}
			$mailBody=$mail_body."<br>".$unapproved_request."<br>".$mailBody;
			//......................................................Un-approve request mail;		
			$to=implode(',',$mailToArr);
			//echo $to;die;
			//Att file....
			$imgSql="select IMAGE_LOCATION,REAL_FILE_NAME from common_photo_library where is_deleted=0  and MASTER_TBLE_ID=$txt_job_no and file_type=1";
			$imgSqlResult=sql_select($imgSql);
			foreach($imgSqlResult as $rows){
				$att_file_arr[]='../../../'.$rows[IMAGE_LOCATION].'**'.$rows[REAL_FILE_NAME];
			}
			$subject="Pre Cost Sheet";
			$header=mailHeader();
			echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
		}
		//------------------------------------End;
		exit();
}

?>