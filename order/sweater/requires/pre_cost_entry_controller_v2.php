<?
/*-------------------------------------------- Comments -----------------------
Purpose			: 	This form will create Sweater Garments Pre-Cost V2
Functionality	:
JS Functions	:
Created by		:	Kausar
Creation date 	: 	29-12-2015
Updated by 		:
Update date		:
QC Performed BY	:
QC Date			:
Comments		:
-------------------------------------------------------------------------------*/
header('Content-type:text/html; charset=utf-8');
session_start();
if( $_SESSION['logic_erp']['user_id'] == "" ) header("location:login.php");
include('../../../includes/common.php');
include('../../../includes/class4/class.conditions.php');
include('../../../includes/class4/class.reports.php');
include('../../../includes/class4/class.fabrics.php');
include('../../../includes/class4/class.yarns.php');
include('../../../includes/class4/class.conversions.php');
include('../../../includes/class4/class.trims.php');
include('../../../includes/class4/class.emblishments.php');
include('../../../includes/class4/class.washes.php');
include('../../../includes/class4/class.commercials.php');
include('../../../includes/class4/class.commisions.php');
include('../../../includes/class4/class.others.php');

if($_SESSION['app_notification'] == 1){
	include('../../../includes/class4/Notifications.php');
}

$data=$_REQUEST['data'];
$action=$_REQUEST['action'];
$type=$_REQUEST['type'];
$permission=$_SESSION['page_permission'];
$israte_popup=2;
$color_library=return_library_array( "select id,color_name from lib_color where status_active=1 ", "id", "color_name"  );
$size_library=return_library_array( "select id,size_name from lib_size where status_active=1", "id", "size_name"  );
$country_library=return_library_array( "select id,country_name from lib_country", "id", "country_name");
//----------------------------------------------------Start---------------------------------------------------------
//*************************************************Master Form Start************************************************
if($action=="save_post_session"){
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$_SESSION['logic_erp']['cons_breck_downn']="";
	$_SESSION['logic_erp']['msmnt_breack_downn']="";
	$_SESSION['logic_erp']['marker_breack_down']="";
	$_SESSION['logic_erp']['cons_breck_downn']=$cons_breck_downn;
	$_SESSION['logic_erp']['msmnt_breack_downn']=$msmnt_breack_downn;
	$_SESSION['logic_erp']['marker_breack_down']=$marker_breack_down;
	echo 1;
	die;
}

if ($action=="load_drop_down_buyer"){
	echo create_drop_down( "cbo_buyer_name", 120, "select buy.id,buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='$data' $buyer_cond and buy.id in (select buyer_id from lib_buyer_party_type where party_type in (1,3,21,90)) order by buyer_name","id,buyer_name", 1, "-- Select Buyer --", $selected, "" );
	exit();
}

if ($action=="load_drop_down_agent"){
	echo create_drop_down( "cbo_agent", 120, "select a.id,a.buyer_name from lib_buyer a, lib_buyer_tag_company b where a.status_active =1 and a.is_deleted=0 and b.buyer_id=a.id and b.tag_company='$data' and a.id in (select buyer_id from lib_buyer_party_type where party_type in (20,21)) order by buyer_name","id,buyer_name", 1, "-- Select Agent --", $selected, "" );
	exit();
}

if ($action=="load_drop_down_po"){
	echo create_drop_down( "txt_po_breack_down_id", 120, "select id,po_number from  wo_po_break_down   where job_no_mst='$data' and status_active =1 and is_deleted=0 ","id,po_number", 1, "-- Select po --", $selected, "" );
	exit();
}

if ($action=="cm_cost_predefined_method")
{
	$cm_cost_method=return_field_value("cm_cost_method", "variable_order_tracking", "company_name=$data  and variable_list=22 and status_active=1 and is_deleted=0");
	if($cm_cost_method=="") $cm_cost_method=0;
	echo $cm_cost_method;
	die;
}

if($action=="check_conversion_rate")
{
	$data=explode("**",$data);
	if($db_type==0) $conversion_date=change_date_format($data[1], "Y-m-d", "-",1);
	else $conversion_date=change_date_format($data[1], "d-M-y", "-",1);

	$currency_rate=set_conversion_rate( $data[0], $conversion_date );
	echo "1"."_".$currency_rate;
	exit();
}

function deffd_lc_per($buyer){
	$sql=sql_select("select deffd_lc_cost_percent from lib_buyer where id='$buyer'");
	$deffd_lc_cost_percent=$sql[0][csf('deffd_lc_cost_percent')];
	return $deffd_lc_cost_percent;
}

function buyer_profit_per($buyer){
	$sql=sql_select("select min_budgeted_profit_parcent from lib_buyer where id='$buyer'");
	$buyer_profit_percent=$sql[0][csf('min_budgeted_profit_parcent')];
	return $buyer_profit_percent;
}

function get_efficiency_source($data)
{
	$efficiency_source=return_field_value("efficiency_source_for_pre_cost", "variable_order_tracking", "company_name=$data  and variable_list=54 and status_active=1 and is_deleted=0");
	if($efficiency_source==""){
		$efficiency_source=0;
	}
	return  $efficiency_source;
}

function get_job_data($company,$job){
	$data_array=sql_select("select a.order_repeat_no, a.total_set_qnty, sum(c.order_quantity) as order_quantity, sum(c.plan_cut_qnty) as plan_cut_qnty  from wo_po_details_master a,wo_po_break_down b, wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and  a.job_no='$job' and a.company_name=$company  and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 group by a.order_repeat_no,a.total_set_qnty");
	$job_data=array();
	foreach($data_array as $row){
		$order_repeat_no=$row[csf('order_repeat_no')];
		$total_set_qnty=$row[csf('total_set_qnty')];
		$order_quantity=$row[csf('order_quantity')];
		$plan_cut_qnty=$row[csf('plan_cut_qnty')];

		$order_quantity_set=$order_quantity/$total_set_qnty;
		$plan_cut_qnty_set=$plan_cut_qnty/$total_set_qnty;

		$job_data['order_quantity_set']=$order_quantity_set;
		$job_data['plan_cut_qnty_set']=$plan_cut_qnty_set;
		$job_data['order_quantity']=$order_quantity;
		$job_data['plan_cut_qnty']=$plan_cut_qnty;
		$job_data['order_repeat_no']=$order_repeat_no;
	}
	unset($data_array);
	return $job_data;
}

function get_efficiency_percent($company,$job,$smv){
	$efficiency_source=get_efficiency_source($company);
	if($efficiency_source== "" || $efficiency_source==0){
		$efficiency_source=1;
	}
	$job_data=get_job_data($company,$job);

	if($efficiency_source==1) $efficiency_percent=0;
	if($efficiency_source==2) $efficiency_percent=get_efficiency_percent_from_work_study($company,$job);
	if($efficiency_source==3) $efficiency_percent=get_efficiency_percent_from_slab($company,$job_data['order_repeat_no'],$job_data['order_quantity_set'],$smv);
	return array("efficiency_source"=>$efficiency_source,"efficiency_percent"=>$efficiency_percent);
	exit();
}

function get_efficiency_percent_from_slab($company,$order_repeat_no,$order_quantity,$smv){
	$efficiency_percent=0;
	$sql=sql_select("select efficiency_new_order, efficiency_repeat_order from efficiency_percentage_slab where ($smv between smv_lower_limit and  smv_upper_limit) and ($order_quantity between order_qty_lower_limit and order_qty_upper_limit) and company_id=$company and status_active=1 and is_deleted=0");
	foreach($sql as $row){
		if($order_repeat_no) $efficiency_percent=$row[csf('efficiency_repeat_order')];
		else $efficiency_percent=$row[csf('efficiency_new_order')];
	}
	return $efficiency_percent;
	exit();
}

function get_efficiency_percent_from_work_study($company,$jobno){
	$sqlwsid=sql_select("select ws_id from wo_po_details_mas_set_details where job_no='$jobno'");
	$wsidstr="";
	foreach($sqlwsid as $jrow){
		if($jrow[csf('ws_id')]=="") $jrow[csf('ws_id')]=0;
		if($jrow[csf('ws_id')]!=0)
		{
			if($wsidstr=="") $wsidstr=$jrow[csf('ws_id')]; else $wsidstr.=','.$jrow[csf('ws_id')];
		}
	}
	unset($sqlwsid);
	
	$eff_percentws=0;
	if($wsidstr!="")
	{
		$sql=sql_select("select id, efficiency from ppl_balancing_mst_entry where gsd_mst_id in ($wsidstr) and status_active=1 and is_deleted=0");
		$countwseff=count($sql); $efficiency_percent=0;
		foreach($sql as $row){
			$efficiency_percent+=$row[csf('efficiency')];
		}
		if($countwseff==1) $eff_percentws=$efficiency_percent; else if($countwseff>1) $eff_percentws=fn_number_format($efficiency_percent/$countwseff,2); else $eff_percentws=0;
	}
	
	return $eff_percentws;
	exit();
}

if($action=="get_efficiency_percent"){
	$data=explode("**",$data);
	$efficiency_data=get_efficiency_percent($data[0],$data[1],$data[2]);
	echo "set_efficiency_percent('".json_encode($efficiency_data)."')\n";
}

if($action=="is_manula_approved")
{
    $is_manula_approved=0;
	$sql_data=sql_select("select pre_cost_approval from variable_order_tracking where company_name='$data' and variable_list=41 and status_active=1 and is_deleted=0");
	foreach($sql_data as $sql_row)
	{
		$is_manula_approved=$sql_row[csf('pre_cost_approval')];
	}
	echo $is_manula_approved;
	exit();
}

if ($action=="cost_per_minute")
{
	$data=explode("_",$data);
	$cm_cost_method_based_on=return_field_value("cm_cost_method_based_on", "variable_order_tracking", "company_name=$data[0]  and variable_list=22 and status_active=1 and is_deleted=0");
	if($cm_cost_method_based_on=="") $cm_cost_method_based_on=1;
	$txt_costing_date="";
	if($cm_cost_method_based_on==1){
		if($data[1]=="" || $data[1]==0)
		{
			if($db_type==0) $txt_costing_date=change_date_format(date('d-m-Y'), "yyyy-mm-dd", "-");
			if($db_type==2) $txt_costing_date=change_date_format(date('d-m-Y'), "yyyy-mm-dd", "-",1);
		}
		else
		{
			if($db_type==0) $txt_costing_date=change_date_format($data[1], "yyyy-mm-dd", "-");
			if($db_type==2) $txt_costing_date=change_date_format($data[1], "yyyy-mm-dd", "-",1)	;
		}
	}
	else if($cm_cost_method_based_on==2){
		$min_shipment_sql=sql_select("select job_no_mst, min(shipment_date) as min_shipment_date from wo_po_break_down where job_no_mst='$data[2]' and status_active=1 and is_deleted=0 group by job_no_mst");
		$min_shipment_date="";
		foreach($min_shipment_sql as $row){
			$min_shipment_date=$row[csf('min_shipment_date')];
		}

		if($db_type==0) $txt_costing_date=change_date_format($min_shipment_date, "yyyy-mm-dd", "-");
		if($db_type==2) $txt_costing_date=change_date_format($min_shipment_date, "yyyy-mm-dd", "-",1)	;
	}
	else if($cm_cost_method_based_on==3){
		$max_shipment_sql=sql_select("select job_no_mst, max(shipment_date) as max_shipment_date from wo_po_break_down where job_no_mst='$data[2]' and status_active=1 and is_deleted=0 group by job_no_mst");
		$max_shipment_date="";
		foreach($max_shipment_sql as $row){
			$max_shipment_date=$row[csf('max_shipment_date')];
		}

		if($db_type==0) $txt_costing_date=change_date_format($max_shipment_date, "yyyy-mm-dd", "-");
		if($db_type==2) $txt_costing_date=change_date_format($max_shipment_date, "yyyy-mm-dd", "-",1)	;
	}
	else if($cm_cost_method_based_on==4){

		$max_shipment_sql=sql_select("select job_no_mst, min(pub_shipment_date) as min_pub_shipment_date from wo_po_break_down where job_no_mst='$data[2]' and status_active=1 and is_deleted=0 group by job_no_mst");
		$min_pub_shipment_date="";
		foreach($max_shipment_sql as $row){
			$min_pub_shipment_date=$row[csf('min_pub_shipment_date')];
		}

		if($db_type==0) $txt_costing_date=change_date_format($min_pub_shipment_date, "yyyy-mm-dd", "-");
		if($db_type==2) $txt_costing_date=change_date_format($min_pub_shipment_date, "yyyy-mm-dd", "-",1)	;
	}
	else if($cm_cost_method_based_on==4){
		$max_shipment_sql=sql_select("select job_no_mst, max(pub_shipment_date) as max_pub_shipment_date from wo_po_break_down where job_no_mst='$data[2]' and status_active=1 and is_deleted=0 group by job_no_mst");
		$max_pub_shipment_date="";
		foreach($max_shipment_sql as $row){
			$max_pub_shipment_date=$row[csf('max_pub_shipment_date')];
		}

		if($db_type==0)  $txt_costing_date=change_date_format($max_pub_shipment_date, "yyyy-mm-dd", "-");
		if($db_type==2) $txt_costing_date=change_date_format($max_pub_shipment_date, "yyyy-mm-dd", "-",1)	;
	}
	/*if($db_type==0)
		{
		   $txt_costing_date=change_date_format($data[1], "yyyy-mm-dd", "-");
		}
		if($db_type==2)
		{
			$txt_costing_date=change_date_format($data[1], "yyyy-mm-dd", "-",1)	;
		}*/

	$monthly_cm_expense=0; $no_factory_machine=0; $working_hour=0; $cost_per_minute=0; $depreciation_amorti=0; $operating_expn=0; $interest_expense=0; $income_tax=0;

	if($db_type==0)
	{
		$sql="select monthly_cm_expense, no_factory_machine, working_hour, cost_per_minute, depreciation_amorti, operating_expn, interest_expense, income_tax from lib_standard_cm_entry where company_id=$data[0] and '$txt_costing_date' between applying_period_date and applying_period_to_date  and status_active=1 and is_deleted=0 LIMIT 1";
	}
	else if($db_type==2)
	{
		$sql="select monthly_cm_expense, no_factory_machine, working_hour, cost_per_minute, depreciation_amorti, operating_expn, interest_expense, income_tax from lib_standard_cm_entry where company_id=$data[0] and '$txt_costing_date' between applying_period_date and applying_period_to_date and status_active=1 and is_deleted=0";
	}
	$data_array=sql_select($sql);
	foreach ($data_array as $row)
	{
		if($row[csf("monthly_cm_expense")] !="") $monthly_cm_expense=$row[csf("monthly_cm_expense")];
		if($row[csf("no_factory_machine")] !="") $no_factory_machine=$row[csf("no_factory_machine")];
		if($row[csf("working_hour")] !="") $working_hour=$row[csf("working_hour")];
		if($row[csf("cost_per_minute")] !="") $cost_per_minute=$row[csf("cost_per_minute")];
		if($row[csf("depreciation_amorti")] !="") $depreciation_amorti=$row[csf("depreciation_amorti")];
		if($row[csf("operating_expn")] !="") $operating_expn=$row[csf("operating_expn")];
		if($row[csf("interest_expense")] !="") $interest_expense=$row[csf("interest_expense")];
		if($row[csf("income_tax")] !="") $income_tax=$row[csf("income_tax")];
	}
	$data=$monthly_cm_expense."_".$no_factory_machine."_".$working_hour."_".$cost_per_minute."_".$depreciation_amorti."_".$operating_expn."_".$interest_expense."_".$income_tax;
	echo $data;
	exit();
}

if ($action=="order_popup")
{
  	echo load_html_head_contents("Popup Info","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
		function set_checkvalue()
		{
			if(document.getElementById('chk_job_wo_po').value==0) document.getElementById('chk_job_wo_po').value=1;
			else document.getElementById('chk_job_wo_po').value=0;
		}

		function js_set_value( job_no )
		{
			document.getElementById('selected_job').value=job_no;
			parent.emailwindow.hide();
		}
    </script>
    </head>
    <body>
    <div align="center" style="width:100%;" >
    <form name="searchorderfrm_1"  id="searchorderfrm_1" autocomplete="off">
        <table width="1080" cellspacing="0" cellpadding="0" border="1" class="rpt_table" align="center" rules="all">
            <thead>
                <tr>
                 <th width="150" colspan="4"> </th>
                    <th><? echo create_drop_down( "cbo_string_search_type", 100, $string_search_type,'', 1, "-- Searching Type --" ); ?></th>
                  <th width="150" colspan="4"> </th>
                </tr>
                <tr>
                    <th width="150" class="must_entry_caption">Company Name</th>
                    <th width="120">Buyer Name</th>
                    <th width="80">Job No</th>
                    <th width="100">Style Ref </th>
                    <th width="100">Internal Ref </th>
                    <th width="100">File No </th>
                    <th width="100">Order No</th>
                    <th width="160">Date Range</th>
                    <th>&nbsp;</th>
                </tr>
            </thead>
            <tr class="general">
                <td> <input type="hidden" id="selected_job">
                    <? echo create_drop_down( "cbo_company_mst", 150, "select id,company_name from lib_company comp where status_active =1 and is_deleted=0 $company_cond order by company_name","id,company_name",1, "-- Select Company --", '',"load_drop_down( 'pre_cost_entry_controller_v2', this.value, 'load_drop_down_buyer', 'buyer_td' );" ); ?></td>
                <td id="buyer_td"><? echo create_drop_down( "cbo_buyer_name", 120, $blank_array,'', 1, "-- Select Buyer --" ); ?></td>
                <td><input name="txt_job_prifix" id="txt_job_prifix" class="text_boxes" style="width:70px"></td>
                <td><input name="txt_style" id="txt_style" class="text_boxes" style="width:90px"></td>
                <td><input name="txt_internal_ref" id="txt_internal_ref" class="text_boxes" style="width:90px"></td>
                <td><input name="txt_file_no" id="txt_file_no" class="text_boxes" style="width:90px"></td>
                <td><input name="txt_order_search" id="txt_order_search" class="text_boxes" style="width:90px"></td>
                <td>
                    <input name="txt_date_from" id="txt_date_from" class="datepicker" style="width:60px">
                    <input name="txt_date_to" id="txt_date_to" class="datepicker" style="width:60px">
                </td>
                <td align="center">
                    <input type="button" name="button2" class="formbutton" value="Show" onClick="show_list_view ( document.getElementById('cbo_company_mst').value+'_'+document.getElementById('cbo_buyer_name').value+'_'+document.getElementById('txt_date_from').value+'_'+document.getElementById('txt_date_to').value+'_'+document.getElementById('txt_job_prifix').value+'_'+document.getElementById('cbo_year_selection').value+'_'+document.getElementById('txt_order_search').value+'_'+document.getElementById('txt_style').value+'_'+document.getElementById('cbo_string_search_type').value+'_'+document.getElementById('txt_internal_ref').value+'_'+document.getElementById('txt_file_no').value, 'create_po_search_list_view', 'search_div', 'pre_cost_entry_controller_v2', 'setFilterGrid(\'list_view\',-1)')" style="width:100px;" /></td>
            </tr>
            <tr>
                <td align="center" valign="middle" colspan="9"><?=load_month_buttons(1); ?></td>
            </tr>
     </table>
     <div id="search_div"></div>
        </form>
       </div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
    exit();
}

if($action=="create_po_search_list_view")
{
	$data=explode('_',$data);
	if ($data[0]!=0) $company=" and a.company_name='$data[0]'"; else { echo "Please Select Company First."; die; }
	if ($data[1]!=0){ $buyer=" and a.buyer_name='$data[1]'"; }
	else
	{
		$buyer=""; $bu_arr=array();
		$pri_buyer=sql_select("select buy.id,buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='$data[0]' $buyer_cond and buy.id in (select buyer_id from lib_buyer_party_type where party_type in (1,3,21,90)) order by buyer_name");
		foreach($pri_buyer as $pri_buyer_row)
		{
			$bu_arr[$pri_buyer_row[csf('id')]]=$pri_buyer_row[csf('id')];
		}
		$bu_arr_str=implode(",",$bu_arr);
		$buyer=" and a.buyer_name in ($bu_arr_str)";
	}
	$job_cond=""; $order_cond=""; $style_cond="";
	if($data[8]==1)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num='$data[4]'  $year_cond"; //else  $job_cond="";
		if (str_replace("'","",$data[6])!="") $order_cond=" and b.po_number = '$data[6]'  "; //else  $order_cond="";
		if (trim($data[7])!="") $style_cond=" and a.style_ref_no ='$data[7]'"; //else  $style_cond="";
	}
	else if($data[8]==2)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num like '$data[4]%'  $year_cond"; //else  $job_cond="";
		if (str_replace("'","",$data[6])!="") $order_cond=" and b.po_number like '$data[6]%'  "; //else  $order_cond="";
		if (trim($data[7])!="") $style_cond=" and a.style_ref_no like '$data[7]%'  "; //else  $style_cond="";
	}
	else if($data[8]==3)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num like '%$data[4]'  $year_cond"; //else  $job_cond="";
		if (str_replace("'","",$data[6])!="") $order_cond=" and b.po_number like '%$data[6]'  "; //else  $order_cond="";
		if (trim($data[7])!="") $style_cond=" and a.style_ref_no like '%$data[7]'"; //else  $style_cond="";
	}
	else if($data[8]==4 || $data[8]==0)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num like '%$data[4]%'  $year_cond"; //else  $job_cond="";
		if (str_replace("'","",$data[6])!="") $order_cond=" and b.po_number like '%$data[6]%'  "; //else  $order_cond="";
		if (trim($data[7])!="") $style_cond=" and a.style_ref_no like '%$data[7]%'"; //else  $style_cond="";
	}

	$internal_ref = str_replace("'","",$data[9]);
	$file_no = str_replace("'","",$data[10]);
	if ($file_no=="") $file_no_cond=""; else $file_no_cond=" and b.file_no='".trim($file_no)."' ";
	if ($internal_ref=="") $internal_ref_cond=""; else $internal_ref_cond=" and b.grouping='".trim($internal_ref)."' ";

	if($db_type==0)
	{
		if ($data[2]!="" &&  $data[3]!="") $shipment_date = "and b.pub_shipment_date between '".change_date_format($data[2], "yyyy-mm-dd", "-")."' and '".change_date_format($data[3], "yyyy-mm-dd", "-")."'"; else $shipment_date ="";
		$year_cond=" and SUBSTRING_INDEX(a.insert_date, '-', 1)=$data[5]";
		$insert_year="YEAR(a.insert_date)";
	}
	else if($db_type==2)
	{
		if ($data[2]!="" &&  $data[3]!="") $shipment_date = "and b.pub_shipment_date between '".change_date_format($data[2], "yyyy-mm-dd", "-",1)."' and '".change_date_format($data[3], "yyyy-mm-dd", "-",1)."'"; else $shipment_date ="";
		$year_cond=" and to_char(a.insert_date,'YYYY')=$data[5]";
		$insert_year="to_char(a.insert_date,'YYYY')";
	}

	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
		$pre_Cost_approv_status = array(0 =>'No',1=>'Yes',2=>'No',3=>'yes');
	$arr=array (2=>$comp,3=>$buyer_arr,11=>$pre_Cost_approv_status);

	 $sql= "select $insert_year as year, a.job_no_prefix_num, a.company_name, a.buyer_name, a.style_ref_no, a.job_quantity, b.po_number, b.grouping,b.file_no, b.po_quantity, b.shipment_date, a.job_no,c.approved, c.id as pre_id from wo_po_details_master a, wo_po_break_down b left join wo_pre_cost_mst c on b.job_no_mst=c.job_no and c.status_active=1 and c.is_deleted=0 where a.job_no=b.job_no_mst and a.garments_nature=100 and a.status_active=1 and b.status_active=1 $shipment_date $company $buyer $job_cond $style_cond $order_cond $file_no_cond $internal_ref_cond $year_cond order by a.id DESC";
	//echo $sql;
	echo  create_list_view("list_view", "Year,Job No,Company,Buyer Name,Style Ref. No,Internal Ref,File No,Job Qty.,PO number,PO Quantity,Shipment Date,Approve Status, Precost id", "50,50,120,100,100,100,100,80,90,80,70,70,100","1180","270",0, $sql , "js_set_value", "job_no", "", 1, "0,0,company_name,buyer_name,0,0,0,0,0,0,0,approved,0", $arr , "year,job_no_prefix_num,company_name,buyer_name,style_ref_no,grouping,file_no,job_quantity,po_number,po_quantity,shipment_date,approved,pre_id", "",'','0,0,0,0,0,0,0,1,0,1,3,0,0') ;
	exit();
}

function cost_per_minute($data)
{
	global $db_type;
	$data=explode("_",$data);
	if($data[1]=="" || $data[1]==0)
	{
		if($db_type==0) $txt_costing_date=change_date_format(date('d-m-Y'), "yyyy-mm-dd", "-");
		if($db_type==2) $txt_costing_date=change_date_format(date('d-m-Y'), "yyyy-mm-dd", "-",1);
	}
	else
	{
		if($db_type==0) $txt_costing_date=change_date_format($data[1], "yyyy-mm-dd", "-");
		if($db_type==2) $txt_costing_date=change_date_format($data[1], "yyyy-mm-dd", "-",1)	;
	}
	/*if($db_type==0)
		{
		   $txt_costing_date=change_date_format($data[1], "yyyy-mm-dd", "-");
		}
		if($db_type==2)
		{
			$txt_costing_date=change_date_format($data[1], "yyyy-mm-dd", "-",1)	;
		}*/

	$monthly_cm_expense=$no_factory_machine=$working_hour=$cost_per_minute=$depreciation_amorti=$operating_expn=$interest_expense=$income_tax=0;

	if($db_type==0)
	{
		 $sql="select monthly_cm_expense, no_factory_machine, working_hour, cost_per_minute, depreciation_amorti, operating_expn, interest_expense, income_tax from lib_standard_cm_entry where company_id=$data[0] and '$txt_costing_date' between applying_period_date and applying_period_to_date  and status_active=1 and is_deleted=0 LIMIT 1";
	}
	else if($db_type==2)
	{
		 $sql="select monthly_cm_expense, no_factory_machine, working_hour, cost_per_minute, depreciation_amorti, operating_expn, interest_expense, income_tax from lib_standard_cm_entry where company_id=$data[0] and '$txt_costing_date' between applying_period_date and applying_period_to_date and status_active=1 and is_deleted=0";
	}

	$data_array=sql_select($sql);
	foreach ($data_array as $row)
	{
		if($row[csf("monthly_cm_expense")] !="") $monthly_cm_expense=$row[csf("monthly_cm_expense")];
		if($row[csf("no_factory_machine")] !="") $no_factory_machine=$row[csf("no_factory_machine")];
		if($row[csf("working_hour")] !="") $working_hour=$row[csf("working_hour")];
		if($row[csf("cost_per_minute")] !="") $cost_per_minute=$row[csf("cost_per_minute")];
		if($row[csf("depreciation_amorti")] !="") $depreciation_amorti=$row[csf("depreciation_amorti")];
		if($row[csf("operating_expn")] !="") $operating_expn=$row[csf("operating_expn")];
		if($row[csf("interest_expense")] !="") $interest_expense=$row[csf("interest_expense")];
		if($row[csf("income_tax")] !="") $income_tax=$row[csf("income_tax")];
	}
	unset($data_array);
	$data=$monthly_cm_expense."_".$no_factory_machine."_".$working_hour."_".$cost_per_minute."_".$depreciation_amorti."_".$operating_expn."_".$interest_expense."_".$income_tax;
	return  $data;
	exit();
}

function cm_cost_predefined_method($data)
{
	$cm_cost_method=return_field_value("cm_cost_method", "variable_order_tracking", "company_name=$data  and variable_list=22 and status_active=1 and is_deleted=0");
	if($cm_cost_method=="") $cm_cost_method=0;
	return  $cm_cost_method;
	exit();
}

if ($action=="populate_data_from_job_table")
{
	$entry_from=0;
	//app_sms
	$data_entry_from=sql_select("select entry_from from wo_pre_cost_mst where job_no='$data' and is_deleted=0 and status_active=1");
	if (count($data_entry_from)>0)
	{
		foreach ($data_entry_from as $row)
		{
			$entry_from=$row[csf('entry_from')];
		}
	}
	if($entry_from==111){
			echo "alert('This Job is in Pre-cost V1');\n";
	}
	else
	{
		$company_name=""; $copy_quotation_id=""; $quotation_id=''; $avg_unit_price=''; $price_costing_per='';

		if($db_type==2) $group_concat_all=" listagg(cast(b.grouping as varchar2(4000)),',') within group (order by b.grouping) as grouping, listagg(cast(b.file_no as varchar2(4000)),',') within group (order by b.file_no) as file_no ";
		else { $group_concat_all="group_concat(b.grouping) as grouping, group_concat(b.file_no) as file_no";}

		$job_data_arr=array();
		$data_array=sql_select("select a.job_no,$group_concat_all from wo_po_details_master a, wo_po_break_down b where a.job_no='$data' and a.job_no=b.job_no_mst group by a.job_no");
		foreach($data_array as $row)
		{
			$job_data_arr[$row[csf('job_no')]]['file']=$row[csf('file_no')];
			$job_data_arr[$row[csf('job_no')]]['ref']=$row[csf('grouping')];
		}
		unset($data_array);


		$component_approved_lab=$component_approved_ins=$component_approved_friegt=$component_approved_currier=$component_approved_certificate=$component_approved_others=0;
		$sql=sql_select("select cost_component_id, current_approval_status as approved from co_com_pre_costing_approval where cost_component_id in (7,8,9,10,11,12) and job_no='$data'");
		foreach($sql as $row){
			$approved=$row[csf('approved')];
			if($approved==3){
				$approved=1;
			}
			if($row[csf('cost_component_id')]==7 && $approved==1) $component_approved_lab=1;
			else if($row[csf('cost_component_id')]==8 && $approved==1) $component_approved_ins=1;
			else if($row[csf('cost_component_id')]==9 && $approved==1) $component_approved_friegt=1;
			else if($row[csf('cost_component_id')]==10 && $approved==1) $component_approved_currier =1;
			else if($row[csf('cost_component_id')]==11 && $approved==1) $component_approved_certificate =1;
			else if($row[csf('cost_component_id')]==12 && $approved==1) $component_approved_others=1;
		}
		
		$sqlsmv=sql_select("select sum(SMV_SET+CUTSMV_SET+FINSMV_SET+TRIMSMVSET) as SETSMV from WO_PO_DETAILS_MAS_SET_DETAILS where job_no='$data'");
		
		$totalsmv=$sqlsmv[0]["SETSMV"];

		$data_array=sql_select("select id, garments_nature, job_no, job_no_prefix, job_no_prefix_num, copy_from, company_name, buyer_name, location_name, style_ref_no, style_description, product_dept, product_code, currency_id, agent_name, order_repeat_no, region, team_leader, dealing_marchant, packing,remarks, job_quantity, avg_unit_price, ship_mode, order_uom, set_break_down, gmts_item_id, total_set_qnty, set_smv, quotation_id,gauge from wo_po_details_master where job_no='$data' and is_deleted=0 and status_active=1");
		
		foreach ($data_array as $row)
		{
			$row[csf("set_smv")]=$totalsmv;
			$print_report_format=return_field_value("format_id","lib_report_template","template_name ='".$row[csf("company_name")]."' and module_id=2 and report_id=43 and is_deleted=0 and status_active=1");
			echo "print_report_button_setting('$print_report_format');\n";

			echo "reset_form('quotationdtls_2','','');\n";
			//echo "load_drop_down( 'requires/pre_cost_entry_controller_v2', '".$row[csf("company_name")]."', 'load_drop_down_buyer', 'buyer_td' ); load_drop_down( 'requires/pre_cost_entry_controller_v2', '".$row[csf("company_name")]."', 'load_drop_down_agent', 'agent_td' );load_drop_down( 'requires/pre_cost_entry_controller_v2', '".$row[csf("job_no")]."', 'load_drop_down_po', 'po_td' ); ;\n";

			$cbo_buyer_name= create_drop_down( "cbo_buyer_name", 120, "select buy.id,buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='".$row[csf("company_name")]."' $buyer_cond and buy.id in (select buyer_id from lib_buyer_party_type where party_type in (1,3,21,90)) order by buyer_name","id,buyer_name", 1, "-- Select Buyer --", $selected, "" );
			$cbo_agent= create_drop_down( "cbo_agent", 120, "select a.id,a.buyer_name from lib_buyer a, lib_buyer_tag_company b where a.status_active =1 and a.is_deleted=0 and b.buyer_id=a.id and b.tag_company='".$row[csf("company_name")]."' and a.id in (select buyer_id from lib_buyer_party_type where party_type in (20,21)) order by buyer_name","id,buyer_name", 1, "-- Select Agent --", $selected, "" );
			$txt_po_breack_down_id= create_drop_down( "txt_po_breack_down_id", 120, "select id,po_number from  wo_po_break_down   where job_no_mst='".$row[csf("job_no")]."' and status_active =1 and is_deleted=0 ","id,po_number", 1, "-- Select po --", $selected, "" );

			$company_id=$row[csf("company_name")];
			$cost_per_minute=cost_per_minute($row[csf("company_name")]."_".date("d-m-Y"));

			$deffd_lc_per=deffd_lc_per($row[csf("buyer_name")]);
			$buyer_profit_per=buyer_profit_per($row[csf("buyer_name")]);
			
			echo "document.getElementById('cost_per_minute').value = '".$cost_per_minute."';\n";
			echo "document.getElementById('txt_deffd_lc_cost_percent').value = '".$deffd_lc_per."';\n";

			echo "$('#txt_margin_dzn_po_price').attr('buyer_profit_per','".$buyer_profit_per."');\n";

			echo "document.getElementById('buyer_td').innerHTML = '".$cbo_buyer_name."';\n";
			echo "document.getElementById('agent_td').innerHTML = '".$cbo_agent."';\n";
			echo "document.getElementById('po_td').innerHTML = '".$txt_po_breack_down_id."';\n";


			echo "change_caption_cost_dtls('".$row[csf(order_uom)]."','change_caption_pcs')\n";
			echo "document.getElementById('txt_job_no').value = '".$row[csf("job_no")]."';\n";
			echo "document.getElementById('hidd_job_id').value = '".$row[csf("id")]."';\n";
			echo "document.getElementById('txt_copy_form').value = '".$row[csf("copy_from")]."';\n";

			$grouping=implode(",",array_unique(explode(",",$job_data_arr[$row[csf('job_no')]]['ref'])));
			$file_no=implode(",",array_unique(explode(",",$job_data_arr[$row[csf('job_no')]]['file'])));
			echo "document.getElementById('txt_intarnal_ref').value = '".$grouping."';\n";
			echo "document.getElementById('txt_file_no').value = '".$file_no."';\n";

			echo "document.getElementById('cbo_company_name').value = '".$row[csf("company_name")]."';\n";
			echo "document.getElementById('txt_quotation_id').value = '".$row[csf("quotation_id")]."';\n";
			echo "document.getElementById('txt_style_ref').value = '".$row[csf("style_ref_no")]."';\n";
			echo "document.getElementById('txt_style_desc').value = '".$row[csf("style_description")]."';\n";
			echo "document.getElementById('cbo_buyer_name').value = '".$row[csf("buyer_name")]."';\n";
			echo "document.getElementById('cbo_pord_dept').value = '".$row[csf("product_dept")]."';\n";
			echo "document.getElementById('txt_product_code').value = '".$row[csf("product_code")]."';\n";
			echo "document.getElementById('cbo_currercy').value = '".$row[csf("currency_id")]."';\n";
			echo "document.getElementById('cbo_agent').value = '".$row[csf("agent_name")]."';\n";
			echo "document.getElementById('txt_offer_qnty').value = '".$row[csf("job_quantity")]."';\n";
			echo "document.getElementById('cbo_region').value = '".$row[csf("region")]."';\n";
			echo "document.getElementById('cbo_order_uom').value = '".$row[csf("order_uom")]."';\n";
			echo "document.getElementById('set_breck_down').value = '".$row[csf("set_break_down")]."';\n";
			echo "document.getElementById('item_id').value = '".$row[csf("gmts_item_id")]."';\n";
			echo "document.getElementById('tot_set_qnty').value = '".$row[csf("total_set_qnty")]."';\n";
			echo "document.getElementById('txt_sew_smv').value = '".number_format($row[csf("set_smv")],2)."';\n";
		 	echo "document.getElementById('txt_gauge').value = '".$gauge_arr[$row[csf("gauge")]]."';\n";

			echo "document.getElementById('update_id').value = '".$row[csf("job_no")]."';\n";
			echo "$('#cbo_buyer_name').attr('disabled','true')".";\n";
			echo "$('#cbo_agent').attr('disabled','true')".";\n";
			echo "$('#cbo_company_name').attr('disabled','true')".";\n";
			echo "$('#cbo_region').attr('disabled','true')".";\n";
			echo "$('#cbo_order_uom').attr('disabled','true')".";\n";

			$cm_cost_predefined_method=cm_cost_predefined_method($row[csf("company_name")]);
			$quotation_id=$row[csf("quotation_id")];
			$company_name=$row[csf("company_name")];
			$sql_vari_seting_copy_quotation=sql_select("select copy_quotation from variable_order_tracking where company_name='$company_name' and variable_list=20 and status_active=1 and is_deleted=0");
			list($copy_quotation)= $sql_vari_seting_copy_quotation;
			$copy_quotation_id=$copy_quotation[csf('copy_quotation')];
			echo "document.getElementById('copy_quatation_id').value = '".$copy_quotation_id."';\n";

			$sql_vari_seting_budget_exceeds_quot=sql_select("select budget_exceeds_quot from variable_order_tracking where company_name='$company_name' and variable_list=37 and status_active=1 and is_deleted=0");
			list($budget_exceeds_quot)= $sql_vari_seting_budget_exceeds_quot;
			$budget_exceeds_quot_id=$budget_exceeds_quot[csf('budget_exceeds_quot')];
			echo "document.getElementById('budget_exceeds_quot_id').value = '".$budget_exceeds_quot_id."';\n";
			// calculation for Dtls Table

			$sql_cost_control_source=sql_select("select cost_control_source from variable_order_tracking where company_name='$company_name' and variable_list=53 and status_active=1 and is_deleted=0");
			list($cost_control_source)= $sql_cost_control_source;
			$cost_control_source_id=$cost_control_source[csf('cost_control_source')];
			echo "document.getElementById('txt_cost_control_source').value = '".$cost_control_source_id."';\n";

			$avg_unit_price=$row[csf("avg_unit_price")];

			echo "document.getElementById('txt_final_price_pcs_pre_cost').value = '".$avg_unit_price."';\n";
			echo "calculate_confirm_price_dzn()\n";

			echo "cm_cost_predefined_method('".$cm_cost_predefined_method."')\n";
			echo "set_multiselect('txt_po_breack_down_id','0','0','0','0');\n";
			echo "document.getElementById('app_sms').innerHTML = '';\n";
			echo "document.getElementById('txt_un_appv_request').disabled = '".true."';\n";
			echo "document.getElementById('txt_un_appv_request').value = '';\n";

			$efficiency_data=get_efficiency_percent($row[csf("company_name")],$row[csf("job_no")],$row[csf("set_smv")]);
			echo "set_efficiency_percent('".json_encode($efficiency_data)."')\n";
			//echo "document.getElementById('txt_sew_efficiency_per').value = '".$efficiency_data."';\n";
			echo "set_currier_cost_method_variable(".$company_id.")\n";

			$is_manula_approved=0;
			$sql_data=sql_select("select pre_cost_approval from variable_order_tracking where company_name='$company_name' and variable_list=41 and status_active=1 and is_deleted=0");
			foreach($sql_data as $sql_row)
			{
				if($sql_row[csf('pre_cost_approval')]==1){
					echo "$('#approve1').hide()".";\n";
				}
				if($sql_row[csf('pre_cost_approval')]==2 || $sql_row[csf('pre_cost_approval')]==0){
					echo "$('#approve1').show()".";\n";
				}
			}
			
			if($cost_control_source_id==7)
			{
				$sql_qRate=sql_select("select a.qc_no, a.revise_no, a.option_id, a.style_ref from qc_mst a where a.status_active=1 and a.is_deleted=0 and a.qc_no='".$row[csf("quotation_id")]."'");
				$option_revise_no="Option-".$sql_qRate[0][csf("option_id")]."; Revise-".$sql_qRate[0][csf("revise_no")];
				echo "document.getElementById('txt_quotation_style').value = '".$sql_qRate[0][csf("style_ref")]."';\n";
				echo "document.getElementById('txt_quotation_style').title = '".$option_revise_no."';\n";
				echo "document.getElementById('txt_style_ref').title = '".$option_revise_no."';\n";
			}
			//echo $is_manula_approved;
		//exit();
		   // calculation for Dtls Table End
		}
		$cbo_approved_status=="";
		$data_array=sql_select("select id, costing_date, incoterm, incoterm_place, machine_line, prod_line_hr, costing_per, copy_quatation, cm_cost_predefined_method_id, exchange_rate, sew_smv, cut_smv, sew_effi_percent, cut_effi_percent, efficiency_wastage_percent, sew_efficiency_source, remarks, approved, ready_to_approved, budget_minute from wo_pre_cost_mst where job_no='$data' and is_deleted=0 and status_active=1");
		if (count($data_array)>0)
		{
			foreach ($data_array as $row)
			{
				$row[csf("sew_smv")]=$totalsmv;
				$cost_per_minute=cost_per_minute($company_name."_".change_date_format($row[csf("costing_date")],'dd-mm-yyyy','-'));
				echo "document.getElementById('cost_per_minute').value = '".$cost_per_minute."';\n";
				echo "document.getElementById('txt_costing_date').value = '".change_date_format($row[csf("costing_date")],'dd-mm-yyyy','-')."';\n";
				echo "document.getElementById('cbo_inco_term').value = '".$row[csf("incoterm")]."';\n";
				echo "document.getElementById('txt_incoterm_place').value = '".$row[csf("incoterm_place")]."';\n";
				echo "document.getElementById('txt_machine_line').value = '".$row[csf("machine_line")]."';\n";
				echo "document.getElementById('txt_prod_line_hr').value = '".$row[csf("prod_line_hr")]."';\n";
				echo "document.getElementById('cbo_costing_per').value = '".$row[csf("costing_per")]."';\n";
				echo "document.getElementById('copy_quatation_id').value = '".$row[csf("copy_quatation")]."';\n";
				echo "document.getElementById('txt_precost_id').value = '".$row[csf("id")]."';\n";
				echo "document.getElementById('cm_cost_predefined_method_id').value = '".$row[csf("cm_cost_predefined_method_id")]."';\n";
				if($row[csf("cm_cost_predefined_method_id")]==0)
				{
					echo "cm_cost_predefined_method('".$cm_cost_predefined_method."')\n";
				}
				//echo "set_currier_cost_method_variable(".$company_id.")\n";
				echo "document.getElementById('txt_exchange_rate').value = '".$row[csf("exchange_rate")]."';\n";
				echo "document.getElementById('txt_sew_smv').value = '".number_format($row[csf("sew_smv")],2)."';\n";
				echo "document.getElementById('txt_cut_smv').value = '".$row[csf("cut_smv")]."';\n";
				echo "document.getElementById('txt_sew_efficiency_per').value = '".$row[csf("sew_effi_percent")]."';\n";
				echo "document.getElementById('txt_sew_efficiency_source').value = '".$row[csf("sew_efficiency_source")]."';\n";
				echo "document.getElementById('txt_cut_efficiency_per').value = '".$row[csf("cut_effi_percent")]."';\n";
				echo "document.getElementById('txt_efficiency_wastage').value = '".$row[csf("efficiency_wastage_percent")]."';\n";
				echo "document.getElementById('txt_remarks').value = '".$row[csf("remarks")]."';\n";
				$cbo_approved_status= $row[csf("approved")];
				$approved_sms='';
				if($cbo_approved_status==3){
					$cbo_approved_status=1;
					$approved_sms='This Job Is Partially Approved';
				}
				echo "document.getElementById('cbo_approved_status').value = '".$cbo_approved_status."';\n";
				echo "document.getElementById('cbo_ready_to_approved').value = '".$row[csf("ready_to_approved")]."';\n";
				echo "document.getElementById('txt_budget_minute').value = '".$row[csf("budget_minute")]."';\n";

				echo "change_caption_cost_dtls('".$row[csf("costing_per")]."','change_caption_dzn')\n";
				

				if($row[csf("costing_per")]==1) $price_costing_per=$avg_unit_price*1*12;
				if($row[csf("costing_per")]==2) $price_costing_per=$avg_unit_price*1*1;
				if($row[csf("costing_per")]==3) $price_costing_per=$avg_unit_price*2*12;
				if($row[csf("costing_per")]==4) $price_costing_per=$avg_unit_price*3*12;
				if($row[csf("costing_per")]==5) $price_costing_per=$avg_unit_price*4*12;

				if($cbo_approved_status==1)
				{
					if(empty($approved_sms))
					{
						$approved_sms='This Job Is Approved';
					}
					
					$approval_cause='';
					$menu_id=$_SESSION['menu_id'];
					$user_id=$_SESSION['logic_erp']['user_id'];
					$sql_request="select MAX(id) as id, approval_cause from fabric_booking_approval_cause where entry_form=15 and user_id='$user_id' and booking_id=".$row[csf("id")]." and approval_type=2 and status_active=1 and is_deleted=0 group by approval_cause";//page_id='$menu_id' and

					$nameArray_request=sql_select($sql_request);
					foreach($nameArray_request as $approw)
					{
						$approval_cause=$approw[csf("approval_cause")];
					}
					unset($nameArray_request);

					echo "document.getElementById('approve1').value = 'Un-Approved';\n";
					echo "$('#txt_costing_date').attr('disabled','true')".";\n";
					echo "$('#cbo_inco_term').attr('disabled','true')".";\n";
					echo "$('#txt_incoterm_place').attr('disabled','true')".";\n";
					echo "$('#txt_machine_line').attr('disabled','true')".";\n";
					echo "$('#txt_prod_line_hr').attr('disabled','true')".";\n";
					echo "$('#cbo_costing_per').attr('disabled','true')".";\n";
					echo "$('#copy_quatation_id').attr('disabled','true')".";\n";
					echo "$('#txt_remarks').attr('disabled','true')".";\n";
					echo "$('#save1').attr('disabled','true')".";\n";
					echo "$('#update1').attr('disabled','true')".";\n";
					echo "$('#Delete1').attr('disabled','true')".";\n";
					echo "document.getElementById('app_sms').innerHTML = '".$approved_sms."';\n";
					echo "document.getElementById('txt_un_appv_request').disabled = '".false."';\n";
					echo "document.getElementById('txt_un_appv_request').value = '".$approval_cause."';\n";
				}
				else
				{
					echo "document.getElementById('approve1').value = 'Approved';\n";
					echo "$('#txt_costing_date').removeAttr('disabled')".";\n";
					echo "$('#cbo_inco_term').removeAttr('disabled')".";\n";
					echo "$('#txt_incoterm_place').removeAttr('disabled')".";\n";
					echo "$('#txt_machine_line').removeAttr('disabled')".";\n";
					echo "$('#txt_prod_line_hr').removeAttr('disabled')".";\n";
					echo "$('#cbo_costing_per').removeAttr('disabled')".";\n";
					echo "$('#copy_quatation_id').removeAttr('disabled')".";\n";
					echo "$('#txt_remarks').removeAttr('disabled')".";\n";
					echo "$('#save1').removeAttr('disabled')".";\n";
					echo "$('#update1').removeAttr('disabled')".";\n";
					echo "$('#Delete1').removeAttr('disabled')".";\n";
					echo "document.getElementById('app_sms').innerHTML = '".$approved_sms."';\n";
					echo "document.getElementById('txt_un_appv_request').disabled = '".true."';\n";
					echo "document.getElementById('txt_un_appv_request').value = '';\n";
					//$efficiency_data=get_efficiency_percent($row[csf("company_name")],$row[csf("job_no")],$row[csf("set_smv")]);
					//echo "set_efficiency_percent('".json_encode($efficiency_data)."')\n";
				}
				echo "set_button_status(1, permission, 'fnc_precosting_entry',1)\n";
			}
		}
		else
		{
			if($copy_quotation_id==1)
			{
				$data_array=sql_select("select quot_date, incoterm, incoterm_place, machine_line, prod_line_hr, costing_per, cm_cost_predefined_method_id, exchange_rate, sew_smv, cut_smv, sew_effi_percent, cut_effi_percent, efficiency_wastage_percent, remarks from wo_price_quotation where id='$quotation_id' and is_deleted=0 and status_active=1");
				foreach ($data_array as $row)
				{
					echo "document.getElementById('cbo_inco_term').value = '".$row[csf("incoterm")]."';\n";
					echo "document.getElementById('txt_incoterm_place').value = '".$row[csf("incoterm_place")]."';\n";
					echo "document.getElementById('txt_machine_line').value = '".$row[csf("machine_line")]."';\n";
					echo "document.getElementById('txt_prod_line_hr').value = '".$row[csf("prod_line_hr")]."';\n";
					echo "document.getElementById('cbo_costing_per').value = '".$row[csf("costing_per")]."';\n";
					echo "document.getElementById('cm_cost_predefined_method_id').value = '".$row[csf("cm_cost_predefined_method_id")]."';\n";
					if($row[csf("cm_cost_predefined_method_id")]==0)
					{
						echo "cm_cost_predefined_method('".$cm_cost_predefined_method."')\n";
					}
					echo "document.getElementById('txt_exchange_rate').value = '".$row[csf("exchange_rate")]."';\n";
					echo "document.getElementById('txt_sew_smv').value = '".number_format($row[csf("sew_smv")],2)."';\n";
					echo "document.getElementById('txt_cut_smv').value = '".$row[csf("cut_smv")]."';\n";
					echo "document.getElementById('txt_sew_efficiency_per').value = '".$row[csf("sew_effi_percent")]."';\n";
					echo "document.getElementById('txt_cut_efficiency_per').value = '".$row[csf("cut_effi_percent")]."';\n";
					echo "document.getElementById('txt_efficiency_wastage').value = '".$row[csf("efficiency_wastage_percent")]."';\n";
					echo "document.getElementById('txt_remarks').value = '".$row[csf("remarks")]."';\n";
					echo "change_caption_cost_dtls('".$row[csf(costing_per)]."','change_caption_dzn')\n";
					echo "set_button_status(0, permission, 'fnc_precosting_entry',1)\n";

					if($row[csf("costing_per")]==1) $price_costing_per=$avg_unit_price*1*12;
					if($row[csf("costing_per")]==2) $price_costing_per=$avg_unit_price*1*1;
					if($row[csf("costing_per")]==3) $price_costing_per=$avg_unit_price*2*12;
					if($row[csf("costing_per")]==4) $price_costing_per=$avg_unit_price*3*12;
					if($row[csf("costing_per")]==5) $price_costing_per=$avg_unit_price*4*12;
				}
			}
		}
		$data_array=sql_select("select id, job_no, fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent, wash_cost, wash_cost_percent, comm_cost, comm_cost_percent, commission, commission_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, freight, freight_percent, currier_pre_cost, currier_percent, certificate_pre_cost, certificate_percent, common_oh, common_oh_percent, depr_amor_pre_cost, depr_amor_po_price, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, cost_pcs_set, cost_pcs_set_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set, margin_pcs_set_percent, cm_for_sipment_sche, deffdlc_cost, deffdlc_percent, interest_cost, interest_percent, incometax_cost, incometax_percent, design_cost, design_percent, studio_cost, studio_percent from wo_pre_cost_dtls where job_no='$data' and status_active=1 and is_deleted=0");
		if (count($data_array)>0)
		{
			foreach ($data_array as $row)
			{
				echo "reset_form('quotationdtls_2','','');\n";
				echo "document.getElementById('txt_fabric_pre_cost').value = '".$row[csf("fabric_cost")]."';\n";
				echo "document.getElementById('txt_fabric_po_price').value = '".$row[csf("fabric_cost_percent")]."';\n";
				echo "$('#txt_fabric_pre_cost').attr('pre_fab_cost','".$row[csf("fabric_cost")]."');\n";
				echo "document.getElementById('txt_trim_pre_cost').value = '".$row[csf("trims_cost")]."';\n";
				echo "document.getElementById('txt_trim_po_price').value = '".$row[csf("trims_cost_percent")]."';\n";
				echo "$('#txt_trim_pre_cost').attr('pre_trim_cost','".$row[csf("trims_cost")]."');\n";
				echo "document.getElementById('txt_embel_pre_cost').value = '".$row[csf("embel_cost")]."';\n";
				echo "document.getElementById('txt_embel_po_price').value = '".$row[csf("embel_cost_percent")]."';\n";
				echo "$('#txt_embel_pre_cost').attr('pre_emb_cost','".$row[csf("embel_cost")]."');\n";
				echo "document.getElementById('txt_wash_pre_cost').value = '".$row[csf("wash_cost")]."';\n";
				echo "document.getElementById('txt_wash_po_price').value = '".$row[csf("wash_cost_percent")]."';\n";
				echo "$('#txt_wash_pre_cost').attr('pre_wash_cost','".$row[csf("wash_cost")]."');\n";
				echo "document.getElementById('txt_comml_pre_cost').value = '".$row[csf("comm_cost")]."';\n";
				echo "$('#txt_comml_pre_cost').attr('pre_comml_cost','".$row[csf("comm_cost")]."');\n";
				echo "document.getElementById('txt_comml_po_price').value = '".$row[csf("comm_cost_percent")]."';\n";
				echo "document.getElementById('txt_commission_pre_cost').value = '".$row[csf("commission")]."';\n";
				echo "$('#txt_commission_pre_cost').attr('pre_commis_cost','".$row[csf("commission")]."');\n";
				echo "document.getElementById('txt_commission_po_price').value = '".$row[csf("commission_percent")]."';\n";
				echo "document.getElementById('txt_lab_test_pre_cost').value = '".$row[csf("lab_test")]."';\n";
				echo "document.getElementById('txt_lab_test_po_price').value = '".$row[csf("lab_test_percent")]."';\n";
				echo "document.getElementById('txt_inspection_pre_cost').value = '".$row[csf("inspection")]."';\n";
				echo "document.getElementById('txt_inspection_po_price').value = '".$row[csf("inspection_percent")]."';\n";
				echo "document.getElementById('txt_cm_pre_cost').value = '".$row[csf("cm_cost")]."';\n";
				echo "document.getElementById('txt_cm_po_price').value = '".$row[csf("cm_cost_percent")]."';\n";
				echo "document.getElementById('txt_freight_pre_cost').value = '".$row[csf("freight")]."';\n";
				echo "document.getElementById('txt_freight_po_price').value = '".$row[csf("freight_percent")]."';\n";
				echo "document.getElementById('txt_currier_pre_cost').value = '".$row[csf("currier_pre_cost")]."';\n";
				echo "document.getElementById('txt_currier_po_price').value = '".$row[csf("currier_percent")]."';\n";
				echo "document.getElementById('txt_certificate_pre_cost').value = '".$row[csf("certificate_pre_cost")]."';\n";
				echo "document.getElementById('txt_certificate_po_price').value = '".$row[csf("certificate_percent")]."';\n";

				echo "document.getElementById('txt_common_oh_pre_cost').value = '".$row[csf("common_oh")]."';\n";
				echo "document.getElementById('txt_common_oh_po_price').value = '".$row[csf("common_oh_percent")]."';\n";

				echo "document.getElementById('txt_depr_amor_pre_cost').value = '".$row[csf("depr_amor_pre_cost")]."';\n";
				echo "document.getElementById('txt_depr_amor_po_price').value = '".$row[csf("depr_amor_po_price")]."';\n";

				echo "document.getElementById('txt_deffdlc_pre_cost').value = '".$row[csf("deffdlc_cost")]."';\n";
				echo "document.getElementById('txt_deffdlc_po_price').value = '".$row[csf("deffdlc_percent")]."';\n";

				echo "document.getElementById('txt_interest_pre_cost').value = '".$row[csf("interest_cost")]."';\n";
				echo "document.getElementById('txt_interest_po_price').value = '".$row[csf("interest_percent")]."';\n";

				echo "document.getElementById('txt_incometax_pre_cost').value = '".$row[csf("incometax_cost")]."';\n";
				echo "document.getElementById('txt_incometax_po_price').value = '".$row[csf("incometax_percent")]."';\n";

				echo "document.getElementById('txt_design_pre_cost').value = '".$row[csf("design_cost")]."';\n";
				echo "document.getElementById('txt_design_po_price').value = '".$row[csf("design_percent")]."';\n";

				echo "document.getElementById('txt_studio_pre_cost').value = '".$row[csf("studio_cost")]."';\n";
				echo "document.getElementById('txt_studio_po_price').value = '".$row[csf("studio_percent")]."';\n";

				echo "document.getElementById('txt_total_pre_cost').value = '".$row[csf("total_cost")]."';\n";
				echo "document.getElementById('txt_total_po_price').value = '".$row[csf("total_cost_percent")]."';\n";
				echo "document.getElementById('txt_final_price_dzn_pre_cost').value = '".$row[csf("price_dzn")]."';\n";
				echo "document.getElementById('txt_final_price_dzn_po_price').value = '".$row[csf("price_dzn_percent")]."';\n";
				echo "document.getElementById('txt_margin_dzn_pre_cost').value = '".$row[csf("margin_dzn")]."';\n";
				echo "document.getElementById('txt_margin_dzn_po_price').value = '".$row[csf("margin_dzn_percent")]."';\n";
				echo "document.getElementById('txt_total_pre_cost_psc_set').value = '".$row[csf("cost_pcs_set")]."';\n";
				echo "document.getElementById('txt_total_pre_cost_psc_set_po_price').value = '".$row[csf("cost_pcs_set_percent")]."';\n";
				echo "document.getElementById('txt_final_price_pcs_pre_cost').value = '".$row[csf("price_pcs_or_set")]."';\n";
				echo "document.getElementById('txt_final_price_pcs_po_price').value = '".$row[csf("price_pcs_or_set_percent")]."';\n";
				echo "document.getElementById('txt_margin_pcs_pre_cost').value = '".$row[csf("margin_pcs_set")]."';\n";
				echo "document.getElementById('txt_margin_pcs_po_price').value = '".$row[csf("margin_pcs_set_percent")]."';\n";
				echo "document.getElementById('update_id_dtls').value = '".$row[csf("id")]."';\n";
				if($row[csf("margin_dzn")]<0)
				{
					echo "document.getElementById('txt_margin_dzn_pre_cost').style.backgroundColor = '#F00';\n";
				}
				else
				{
					echo "document.getElementById('txt_margin_dzn_pre_cost').style.backgroundColor = '';\n";
				}

				if($row[csf("margin_pcs_set")]<0)
				{
					echo "document.getElementById('txt_margin_pcs_pre_cost').style.backgroundColor = '#F00';\n";
				}
				else
				{
					echo "document.getElementById('txt_margin_pcs_pre_cost').style.backgroundColor = '';\n";
				}
				if($cbo_approved_status==1)
				{
					echo "$('#txt_lab_test_pre_cost').attr('disabled','true')".";\n";
					echo "$('#txt_inspection_pre_cost').attr('disabled','true')".";\n";
					//echo "$('#txt_cm_pre_cost').attr('disabled','true')".";\n";
					echo "$('#txt_freight_pre_cost').attr('disabled','true')".";\n";
					echo "$('#txt_common_oh_pre_cost').attr('disabled','true')".";\n";
					echo "$('#txt_1st_quoted_price_pre_cost').attr('disabled','true')".";\n";
					echo "$('#txt_first_quoted_price_date').attr('disabled','true')".";\n";
					echo "$('#txt_revised_price_pre_cost').attr('disabled','true')".";\n";
					echo "$('#txt_revised_price_date').attr('disabled','true')".";\n";
					echo "$('#txt_confirm_price_pre_cost').attr('disabled','true')".";\n";
					echo "$('#txt_confirm_date_pre_cost').attr('disabled','true')".";\n";
					echo "$('#save2').attr('disabled','true')".";\n";
					echo "$('#update2').attr('disabled','true')".";\n";
					echo "$('#Delete2').attr('disabled','true')".";\n";
				}
				else
				{
					echo "$('#txt_lab_test_pre_cost').removeAttr('disabled')".";\n";
					echo "$('#txt_inspection_pre_cost').removeAttr('disabled')".";\n";
					//echo "$('#txt_cm_pre_cost').removeAttr('disabled')".";\n";
					echo "$('#txt_freight_pre_cost').removeAttr('disabled')".";\n";
					echo "$('#txt_common_oh_pre_cost').removeAttr('disabled')".";\n";
					echo "$('#txt_1st_quoted_price_pre_cost').removeAttr('disabled')".";\n";
					echo "$('#txt_first_quoted_price_date').removeAttr('disabled')".";\n";
					echo "$('#txt_revised_price_pre_cost').removeAttr('disabled')".";\n";
					echo "$('#txt_revised_price_date').removeAttr('disabled')".";\n";

					echo "$('#txt_confirm_price_pre_cost').removeAttr('disabled')".";\n";
					echo "$('#txt_confirm_date_pre_cost').removeAttr('disabled')".";\n";
					echo "$('#save2').removeAttr('disabled')".";\n";
					echo "$('#update2').removeAttr('disabled')".";\n";
					echo "$('#Delete2').removeAttr('disabled')".";\n";
				}
				if($component_approved_lab==1) echo "$('#txt_lab_test_pre_cost').attr('disabled','true')".";\n"; else echo "$('#txt_lab_test_pre_cost').removeAttr('disabled')".";\n";
				if($component_approved_ins==1) echo "$('#txt_inspection_pre_cost').attr('disabled','true')".";\n"; else echo "$('#txt_inspection_pre_cost').removeAttr('disabled')".";\n";
				if($component_approved_friegt==1) echo "$('#txt_freight_pre_cost').attr('disabled','true')".";\n"; else echo "$('#txt_freight_pre_cost').removeAttr('disabled')".";\n";
				if($component_approved_currier==1) echo "$('#txt_currier_pre_cost').attr('disabled','true')".";\n"; else echo "$('#txt_currier_pre_cost').removeAttr('disabled')".";\n";
				if($component_approved_certificate==1) echo "$('#txt_certificate_pre_cost').attr('disabled','true')".";\n"; else echo "$('#txt_certificate_pre_cost').removeAttr('disabled')".";\n";
				if($component_approved_others==1)
				{
					echo "$('#txt_interest_pre_cost').attr('disabled','true')".";\n";
					echo "$('#txt_incometax_pre_cost').attr('disabled','true')".";\n";
					echo "$('#txt_common_oh_pre_cost').attr('disabled','true')".";\n";
					echo "$('#txt_depr_amor_pre_cost').attr('disabled','true')".";\n";
				}
				else
				{
					echo "$('#txt_interest_pre_cost').removeAttr('disabled')".";\n";
					echo "$('#txt_incometax_pre_cost').removeAttr('disabled')".";\n";
					echo "$('#txt_common_oh_pre_cost').removeAttr('disabled')".";\n";
					echo "$('#txt_depr_amor_pre_cost').removeAttr('disabled')".";\n";
				}

				echo "set_button_status(1, permission, 'fnc_quotation_entry_dtls',2)\n";
			}

			if($copy_quotation_id==1)
			{
				$data_array=sql_select("select id, quotation_id, fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent,wash_cost, wash_cost_percent, comm_cost, comm_cost_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, freight, freight_percent,currier_pre_cost, 	currier_percent, certificate_pre_cost, certificate_percent, common_oh, common_oh_percent, depr_amor_pre_cost, depr_amor_po_price, total_cost, total_cost_percent, commission, commission_percent, final_cost_dzn, final_cost_dzn_percent, final_cost_pcs, final_cost_set_pcs_rate, a1st_quoted_price, a1st_quoted_price_date, revised_price,revised_price_date, confirm_price, confirm_price_set_pcs_rate, confirm_price_dzn, confirm_price_dzn_percent, margin_dzn, margin_dzn_percent, confirm_date, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted from wo_price_quotation_costing_mst where quotation_id='$quotation_id' and status_active=1 and is_deleted=0");

				if (count($data_array)>0)
				{
					foreach ($data_array as $row)
					{
						//echo "document.getElementById('txt_fabric_pre_cost').value = '".$row[csf("fabric_cost")]."';\n";
						//echo "document.getElementById('txt_fabric_po_price').value = '".$row[csf("fabric_cost_percent")]."';\n";
						echo "$('#txt_fabric_pre_cost').attr('pri_fabric_pre_cost','".$row[csf("fabric_cost")]."')".";\n";

						//echo "document.getElementById('txt_trim_pre_cost').value = '".$row[csf("trims_cost")]."';\n";
						//echo "document.getElementById('txt_trim_po_price').value = '".$row[csf("trims_cost_percent")]."';\n";
						echo "$('#txt_trim_pre_cost').attr('pri_trim_pre_cost','".$row[csf("trims_cost")]."')".";\n";

						//echo "document.getElementById('txt_embel_pre_cost').value = '".$row[csf("embel_cost")]."';\n";
						//echo "document.getElementById('txt_embel_po_price').value = '".$row[csf("embel_cost_percent")]."';\n";
						echo "$('#txt_embel_pre_cost').attr('pri_embel_pre_cost','".$row[csf("embel_cost")]."')".";\n";

						//echo "document.getElementById('txt_wash_pre_cost').value = '".$row[csf("wash_cost")]."';\n";
						//echo "document.getElementById('txt_wash_po_price').value = '".$row[csf("wash_cost_percent")]."';\n";
						echo "$('#txt_wash_pre_cost').attr('pri_wash_pre_cost','".$row[csf("wash_cost")]."')".";\n";

						//echo "document.getElementById('txt_comml_pre_cost').value = '".$row[csf("comm_cost")]."';\n";
						//echo "document.getElementById('txt_comml_po_price').value = '".$row[csf("comm_cost_percent")]."';\n";
						echo "$('#txt_comml_pre_cost').attr('pri_comml_pre_cost','".$row[csf("comm_cost")]."')".";\n";

						//echo "document.getElementById('txt_commission_pre_cost').value = '".$row[csf("commission")]."';\n";
						//echo "document.getElementById('txt_commission_po_price').value = '".$row[csf("commission_percent")]."';\n";
						echo "$('#txt_commission_pre_cost').attr('pri_commission_pre_cost','".$row[csf("commission")]."')".";\n";

						//echo "document.getElementById('txt_lab_test_pre_cost').value = '".$row[csf("lab_test")]."';\n";
						//echo "document.getElementById('txt_lab_test_po_price').value = '".$row[csf("lab_test_percent")]."';\n";
						echo "$('#txt_lab_test_pre_cost').attr('pri_lab_test_pre_cost','".$row[csf("lab_test")]."')".";\n";

						//echo "document.getElementById('txt_inspection_pre_cost').value = '".$row[csf("inspection")]."';\n";
						//echo "document.getElementById('txt_inspection_po_price').value = '".$row[csf("inspection_percent")]."';\n";
						echo "$('#txt_inspection_pre_cost').attr('pri_inspection_pre_cost','".$row[csf("inspection")]."')".";\n";

						//echo "document.getElementById('txt_cm_pre_cost').value = '".$row[csf("cm_cost")]."';\n";
						//echo "document.getElementById('txt_cm_po_price').value = '".$row[csf("cm_cost_percent")]."';\n";
						echo "$('#txt_cm_pre_cost').attr('pri_cm_pre_cost','".$row[csf("cm_cost")]."')".";\n";
						//echo "document.getElementById('txt_freight_pre_cost').value = '".$row[csf("freight")]."';\n";
						//echo "document.getElementById('txt_freight_po_price').value = '".$row[csf("freight_percent")]."';\n";
						echo "$('#txt_freight_pre_cost').attr('pri_freight_pre_cost','".$row[csf("freight")]."')".";\n";

						//echo "document.getElementById('txt_currier_pre_cost').value = '".$row[csf("currier_pre_cost")]."';\n";
						//echo "document.getElementById('txt_currier_po_price').value = '".$row[csf("currier_percent")]."';\n";
						echo "$('#txt_currier_pre_cost').attr('pri_currier_pre_cost','".$row[csf("currier_pre_cost")]."')".";\n";

						//echo "document.getElementById('txt_certificate_pre_cost').value = '".$row[csf("certificate_pre_cost")]."';\n";
						//echo "document.getElementById('txt_certificate_po_price').value = '".$row[csf("certificate_percent")]."';\n";
						echo "$('#txt_certificate_pre_cost').attr('pri_certificate_pre_cost','".$row[csf("certificate_pre_cost")]."')".";\n";

						//echo "document.getElementById('txt_common_oh_pre_cost').value = '".$row[csf("common_oh")]."';\n";
						//echo "document.getElementById('txt_common_oh_po_price').value = '".$row[csf("common_oh_percent")]."';\n";
						echo "$('#txt_common_oh_pre_cost').attr('pri_common_oh_pre_cost','".$row[csf("common_oh")]."')".";\n";

						//echo "document.getElementById('txt_depr_amor_pre_cost').value = '".$row[csf("depr_amor_pre_cost")]."';\n";
						//echo "document.getElementById('txt_depr_amor_po_price').value = '".$row[csf("depr_amor_po_price")]."';\n";
						echo "$('#txt_depr_amor_pre_cost').attr('pri_depr_amor_pre_cost','".$row[csf("depr_amor_pre_cost")]."')".";\n";
						//echo "document.getElementById('txt_total_pre_cost').value = '".$row[csf("total_cost")]."';\n";
						//echo "document.getElementById('txt_total_po_price').value = '".$row[csf("total_cost_percent")]."';\n";
						echo "$('#txt_total_pre_cost').attr('pri_total_pre_cost','".$row[csf("total_cost")]."')".";\n";

						//echo "document.getElementById('txt_final_price_pcs_pre_cost').value = '".$avg_unit_price."';\n";
						//echo "document.getElementById('txt_final_price_dzn_pre_cost').value = '".$price_costing_per."';\n";
					}
				}
				else
				{
					echo "$('#txt_fabric_pre_cost').attr('pri_fabric_pre_cost','0')".";\n";
					echo "$('#txt_trim_pre_cost').attr('pri_trim_pre_cost','0')".";\n";
					echo "$('#txt_embel_pre_cost').attr('pri_embel_pre_cost','0')".";\n";
					echo "$('#txt_wash_pre_cost').attr('pri_wash_pre_cost','0')".";\n";
					echo "$('#txt_comml_pre_cost').attr('pri_comml_pre_cost','0')".";\n";
					echo "$('#txt_commission_pre_cost').attr('pri_commission_pre_cost','0')".";\n";
					echo "$('#txt_lab_test_pre_cost').attr('pri_lab_test_pre_cost','0')".";\n";
					echo "$('#txt_inspection_pre_cost').attr('pri_inspection_pre_cost','0')".";\n";
					echo "$('#txt_cm_pre_cost').attr('pri_cm_pre_cost','0')".";\n";
					echo "$('#txt_freight_pre_cost').attr('pri_freight_pre_cost','0')".";\n";
					echo "$('#txt_currier_pre_cost').attr('pri_currier_pre_cost','0')".";\n";
					echo "$('#txt_certificate_pre_cost').attr('pri_certificate_pre_cost','0')".";\n";
					echo "$('#txt_common_oh_pre_cost').attr('pri_common_oh_pre_cost','0')".";\n";
					echo "$('#txt_depr_amor_pre_cost').attr('pri_depr_amor_pre_cost','0')".";\n";
					echo "$('#txt_total_pre_cost').attr('pri_total_pre_cost','0')".";\n";
				}
			}
		}
		else
		{
			if($copy_quotation_id==1)
			{
				if($cost_control_source_id==2)
				{
					$data_array=sql_select("select id, quotation_id, fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent, wash_cost, wash_cost_percent, comm_cost, comm_cost_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, freight, freight_percent, currier_pre_cost, 	currier_percent, certificate_pre_cost, certificate_percent, common_oh, common_oh_percent, depr_amor_pre_cost, depr_amor_po_price, total_cost, total_cost_percent, commission, commission_percent, final_cost_dzn, final_cost_dzn_percent, final_cost_pcs, final_cost_set_pcs_rate, a1st_quoted_price, a1st_quoted_price_date, revised_price, revised_price_date, confirm_price, confirm_price_set_pcs_rate, confirm_price_dzn, confirm_price_dzn_percent, margin_dzn, margin_dzn_percent, confirm_date, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, design_pre_cost, design_percent, studio_pre_cost, studio_percent from wo_price_quotation_costing_mst where quotation_id='$quotation_id' and status_active=1 and is_deleted=0");
				}
				else if($cost_control_source_id==7)// QC Sweater 
				{
					$data_array=sql_select("select cost_sheet_id as quotation_id, sum(fab_amount) as fabric_cost, sum(acc_amount) trims_cost, sum(sp_oparation_amount) as  embel_cost, sum(wash_amount) as wash_cost,sum(commercial_cost) as comm_cost, sum(lab_amount) as lab_test, sum(cm_amount) as cm_cost, sum(fright_amount) as freight, sum(courier_amount) as currier_pre_cost, 0 as common_oh, sum(comm_amount) as commission, sum(other_amount) as studio_pre_cost from qc_confirm_dtls where cost_sheet_id='$quotation_id' and status_active=1 and is_deleted=0 group by cost_sheet_id");
				}
				if(count($data_array)>0)
				{
					foreach ($data_array as $row)
					{
						echo "reset_form('quotationdtls_2','','');\n";
						echo "document.getElementById('txt_fabric_pre_cost').value = '".$row[csf("fabric_cost")]."';\n";
						echo "document.getElementById('txt_fabric_po_price').value = '".$row[csf("fabric_cost_percent")]."';\n";
						echo "document.getElementById('txt_trim_pre_cost').value = '".$row[csf("trims_cost")]."';\n";
						echo "document.getElementById('txt_trim_po_price').value = '".$row[csf("trims_cost_percent")]."';\n";
						echo "document.getElementById('txt_embel_pre_cost').value = '".$row[csf("embel_cost")]."';\n";
						echo "document.getElementById('txt_embel_po_price').value = '".$row[csf("embel_cost_percent")]."';\n";
						echo "document.getElementById('txt_wash_pre_cost').value = '".$row[csf("wash_cost")]."';\n";
						echo "document.getElementById('txt_wash_po_price').value = '".$row[csf("wash_cost_percent")]."';\n";
						echo "document.getElementById('txt_comml_pre_cost').value = '".$row[csf("comm_cost")]."';\n";
						echo "document.getElementById('txt_comml_po_price').value = '".$row[csf("comm_cost_percent")]."';\n";
						echo "document.getElementById('txt_commission_pre_cost').value = '".$row[csf("commission")]."';\n";
						echo "document.getElementById('txt_commission_po_price').value = '".$row[csf("commission_percent")]."';\n";
						echo "document.getElementById('txt_lab_test_pre_cost').value = '".$row[csf("lab_test")]."';\n";
						echo "document.getElementById('txt_lab_test_po_price').value = '".$row[csf("lab_test_percent")]."';\n";
						echo "document.getElementById('txt_inspection_pre_cost').value = '".$row[csf("inspection")]."';\n";
						echo "document.getElementById('txt_inspection_po_price').value = '".$row[csf("inspection_percent")]."';\n";
						echo "document.getElementById('txt_cm_pre_cost').value = '".$row[csf("cm_cost")]."';\n";
						echo "document.getElementById('txt_cm_po_price').value = '".$row[csf("cm_cost_percent")]."';\n";
						echo "document.getElementById('txt_freight_pre_cost').value = '".$row[csf("freight")]."';\n";
						echo "document.getElementById('txt_freight_po_price').value = '".$row[csf("freight_percent")]."';\n";
						echo "document.getElementById('txt_currier_pre_cost').value = '".$row[csf("currier_pre_cost")]."';\n";
						echo "document.getElementById('txt_currier_po_price').value = '".$row[csf("currier_percent")]."';\n";
						echo "document.getElementById('txt_certificate_pre_cost').value = '".$row[csf("certificate_pre_cost")]."';\n";
						echo "document.getElementById('txt_certificate_po_price').value = '".$row[csf("certificate_percent")]."';\n";

						echo "document.getElementById('txt_common_oh_pre_cost').value = '".$row[csf("common_oh")]."';\n";
						echo "document.getElementById('txt_common_oh_po_price').value = '".$row[csf("common_oh_percent")]."';\n";

						echo "document.getElementById('txt_depr_amor_pre_cost').value = '".$row[csf("depr_amor_pre_cost")]."';\n";
						echo "document.getElementById('txt_depr_amor_po_price').value = '".$row[csf("depr_amor_po_price")]."';\n";

						echo "document.getElementById('txt_total_pre_cost').value = '".$row[csf("total_cost")]."';\n";
						echo "document.getElementById('txt_total_po_price').value = '".$row[csf("total_cost_percent")]."';\n";
						echo "document.getElementById('txt_final_price_pcs_pre_cost').value = '".$avg_unit_price."';\n";
						echo "document.getElementById('txt_final_price_dzn_pre_cost').value = '".$price_costing_per."';\n";

						echo "document.getElementById('txt_design_pre_cost').value = '".$row[csf("design_pre_cost")]."';\n";
						echo "document.getElementById('txt_design_po_price').value = '".$row[csf("design_percent")]."';\n";

						echo "document.getElementById('txt_studio_pre_cost').value = '".$row[csf("studio_pre_cost")]."';\n";
						echo "document.getElementById('txt_studio_po_price').value = '".$row[csf("studio_percent")]."';\n";

						echo "calculate_confirm_price_dzn()\n";
						echo "set_button_status(0, permission, 'fnc_quotation_entry_dtls',2)\n";

						echo "$('#txt_fabric_pre_cost').attr('pri_fabric_pre_cost','".$row[csf("fabric_cost")]."')".";\n";
						echo "$('#txt_trim_pre_cost').attr('pri_trim_pre_cost','".$row[csf("trims_cost")]."')".";\n";
						echo "$('#txt_embel_pre_cost').attr('pri_embel_pre_cost','".$row[csf("embel_cost")]."')".";\n";
						echo "$('#txt_wash_pre_cost').attr('pri_wash_pre_cost','".$row[csf("wash_cost")]."')".";\n";
						echo "$('#txt_comml_pre_cost').attr('pri_comml_pre_cost','".$row[csf("comm_cost")]."')".";\n";
						echo "$('#txt_commission_pre_cost').attr('pri_commission_pre_cost','".$row[csf("commission")]."')".";\n";
						echo "$('#txt_lab_test_pre_cost').attr('pri_lab_test_pre_cost','".$row[csf("lab_test")]."')".";\n";
						echo "$('#txt_inspection_pre_cost').attr('pri_inspection_pre_cost','".$row[csf("inspection")]."')".";\n";
						echo "$('#txt_cm_pre_cost').attr('pri_cm_pre_cost','".$row[csf("cm_cost")]."')".";\n";
						echo "$('#txt_freight_pre_cost').attr('pri_freight_pre_cost','".$row[csf("freight")]."')".";\n";
						echo "$('#txt_currier_pre_cost').attr('pri_currier_pre_cost','".$row[csf("currier_pre_cost")]."')".";\n";
						echo "$('#txt_certificate_pre_cost').attr('pri_certificate_pre_cost','".$row[csf("certificate_pre_cost")]."')".";\n";
						echo "$('#txt_common_oh_pre_cost').attr('pri_common_oh_pre_cost','".$row[csf("common_oh")]."')".";\n";
						echo "$('#txt_depr_amor_pre_cost').attr('pri_depr_amor_pre_cost','".$row[csf("depr_amor_pre_cost")]."')".";\n";
						echo "$('#txt_total_pre_cost').attr('pri_total_pre_cost','".$row[csf("total_cost")]."')".";\n";
					}
				}
				else
				{
					echo "$('#txt_fabric_pre_cost').attr('pri_fabric_pre_cost','0')".";\n";
					echo "$('#txt_trim_pre_cost').attr('pri_trim_pre_cost','0')".";\n";
					echo "$('#txt_embel_pre_cost').attr('pri_embel_pre_cost','0')".";\n";
					echo "$('#txt_wash_pre_cost').attr('pri_wash_pre_cost','0')".";\n";
					echo "$('#txt_comml_pre_cost').attr('pri_comml_pre_cost','0')".";\n";
					echo "$('#txt_commission_pre_cost').attr('pri_commission_pre_cost','0')".";\n";
					echo "$('#txt_lab_test_pre_cost').attr('pri_lab_test_pre_cost','0')".";\n";
					echo "$('#txt_inspection_pre_cost').attr('pri_inspection_pre_cost','0')".";\n";
					echo "$('#txt_cm_pre_cost').attr('pri_cm_pre_cost','0')".";\n";
					echo "$('#txt_freight_pre_cost').attr('pri_freight_pre_cost','0')".";\n";
					echo "$('#txt_currier_pre_cost').attr('pri_currier_pre_cost','0')".";\n";
					echo "$('#txt_certificate_pre_cost').attr('pri_certificate_pre_cost','0')".";\n";
					echo "$('#txt_common_oh_pre_cost').attr('pri_common_oh_pre_cost','0')".";\n";
					echo "$('#txt_depr_amor_pre_cost').attr('pri_depr_amor_pre_cost','0')".";\n";
					echo "$('#txt_total_pre_cost').attr('pri_total_pre_cost','0')".";\n";
				}
			}
		}
	}
	exit();
}

// partial pre cost copy popup action-- new development-- 02-11-2016 kaiyum //
if ($action=="partial_pre_cost_copy_popup")
{
  	echo load_html_head_contents("Popup Partial Pre Cost Copy","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
	var permission = '<? echo $permission; ?>';
	function fnc_copy_pre_cost( )
	{
		//alert( operation);
		if (form_validation('txt_popup_job_no','Job No')==false)
		{
			return;
		}
		else
		{
			//alert('sss');return;
			//var data="action=save_partial_pre_cost_copy&operation="+operation+get_submitted_data_string('txt_popup_job_no*txt_main_job_no_hidden',"../../../");
			var txt_popup_job_no=$("#txt_popup_job_no").val();
			var txt_main_job_no_hidden=$("#txt_main_job_no_hidden").val();
			var data="action=save_partial_pre_cost_copy&datas="+txt_popup_job_no+'*'+txt_main_job_no_hidden;
			//var data="action=save_partial_pre_cost_copy&operation="+operation+get_submitted_data_string('txt_popup_job_no*txt_main_job_no_hidden',"../../../");
			//alert(data);
			http.open("POST","pre_cost_entry_controller_v2.php",true);
			http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
			http.send(data);
			http.onreadystatechange = fnc_pre_cost_copy_reponse;
		}
		function fnc_pre_cost_copy_reponse()
		{
			if(http.readyState == 4)
			{
				//alert (http.responseText); //return ;
				var reponse=http.responseText.split('**');
				show_msg(trim(reponse[0]));
				if(reponse[0]==0)
				{
					alert('Data is copy successfully');
				}
				else
				{
					alert('Data is copy failed');
				}
				//show_list_view(reponse[1],'section_list_view_action','section_list_view','requires/order_allocation_controller','setFilterGrid("list_view",-1)');
				reset_form('partialcopyfrm_1','','');
				//set_button_status(0, permission, 'fnc_order_allocation_entry',1);
				//release_freezing();
			}
		}
	}
	
	</script>
	</head>
	<body>
	<div align="center" style="width:100%;" >
	<form name="partialcopyfrm_1"  id="partialcopyfrm_1" autocomplete="off">
		<table width="300" cellspacing="0" cellpadding="0" border="0"  align="center">
			<tr>
				<td align="left" width="60" class="must_entry_caption">Job No</td>
				<td  width="150">
					<input type="hidden" id="txt_main_job_no_hidden" name="txt_main_job_no_hidden" class="text_boxes" style="width:150px;" value="<? echo $txt_job_no; ?>" />
					<input type="text" id="txt_popup_job_no" name="txt_popup_job_no" class="text_boxes" style="width:150px;" />
				</td>
				<td align="right" width="60">
					<input type="button" id="pre_cost_copy_btn" class="formbutton" value="Copy" onClick="fnc_copy_pre_cost()" />
				</td>
			</tr>
		</table>
		</form>
	   </div>
	</body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}
// END  partial pre cost copy popup action//
//START  partial pre cost copy SAVE action here...............................
if($action=="save_partial_pre_cost_copy") // Save here....
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$datas=explode('*',$datas);
	$popup_job_no=$datas[0];
	$main_job_no=$datas[1];
	//echo 'got it';
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}

	//wo_pre_cost_mst

	//wo_pre_cost_fabric_cost_dtls
	$sql_se_set_2=sql_select("select id from wo_pre_cost_fabric_cost_dtls  where job_no='$popup_job_no' order by id ASC");
	foreach($sql_se_set_2 as $row_se_set)
	{
		$id2=return_next_id( "id", "wo_pre_cost_fabric_cost_dtls", 1 );
		$sql_insert_22="insert into wo_pre_cost_fabric_cost_dtls (id,job_no,item_number_id,body_part_id,fab_nature_id,color_type_id,lib_yarn_count_deter_id,construction,composition,fabric_description,gsm_weight,color_size_sensitive,color,avg_cons,fabric_source,rate,amount,avg_finish_cons,avg_process_loss,inserted_by,insert_date,status_active,is_deleted,company_id,costing_per,consumption_basis,process_loss_method,cons_breack_down,yarn_breack_down,width_dia_type,avg_cons_yarn,gsm_weight_yarn,plan_cut_qty,job_plan_cut_qty,is_apply_last_update,uom) select $id2,'".$main_job_no."',item_number_id,body_part_id,fab_nature_id,color_type_id,lib_yarn_count_deter_id,construction,composition,fabric_description,gsm_weight,color_size_sensitive,color,avg_cons,fabric_source,rate,amount,avg_finish_cons,avg_process_loss,".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',status_active,is_deleted,company_id,costing_per,consumption_basis,process_loss_method,cons_breack_down,yarn_breack_down,width_dia_type,avg_cons_yarn,gsm_weight_yarn,plan_cut_qty,job_plan_cut_qty,is_apply_last_update,uom from wo_pre_cost_fabric_cost_dtls where job_no = '$popup_job_no' and id=".$row_se_set[csf('id')]." ";
		$rID2=execute_query($sql_insert_22,1);
		//echo $sql_insert_22;
	}
	//wo_pre_cost_fab_yarn_cost_dtls
	$sql_se_set_3=sql_select("select id from wo_pre_cost_fab_yarn_cost_dtls  where job_no='$popup_job_no' order by id ASC");
	foreach($sql_se_set_3 as $row_se_set)
	{
		$id3=return_next_id( "id", "wo_pre_cost_fab_yarn_cost_dtls", 1 );
		$sql_insert_33="insert into wo_pre_cost_fab_yarn_cost_dtls (id, fabric_cost_dtls_id, job_no,count_id, copm_one_id, percent_one, copm_two_id, percent_two,type_id, cons_ratio,cons_qnty,rate,amount,inserted_by, insert_date,status_active, is_deleted,avg_cons_qnty, supplier_id,color) select $id3, fabric_cost_dtls_id, '".$main_job_no."',count_id, copm_one_id, percent_one, copm_two_id, percent_two,type_id, cons_ratio,cons_qnty,rate,amount,".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',status_active, is_deleted,avg_cons_qnty, supplier_id,color from wo_pre_cost_fab_yarn_cost_dtls where job_no = '$popup_job_no' and id=".$row_se_set[csf('id')]." ";
		$rID3=execute_query($sql_insert_33,1);
		//echo $sql_insert_33;
	}
	//wo_pre_cost_fab_conv_cost_dtls
	$sql_se_set_4=sql_select("select id from wo_pre_cost_fab_conv_cost_dtls  where job_no='$popup_job_no' order by id ASC");
	foreach($sql_se_set_4 as $row_se_set)
	{
		$id4=return_next_id( "id", "wo_pre_cost_fab_conv_cost_dtls", 1 );
		$sql_insert_44="insert into wo_pre_cost_fab_conv_cost_dtls (id,job_no,fabric_description,cons_process,req_qnty,charge_unit,inserted_by,insert_date,status_active,is_deleted,avg_req_qnty,process_loss) select $id4, '".$main_job_no."',fabric_description,cons_process,req_qnty,charge_unit,".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',status_active,is_deleted,avg_req_qnty,process_loss from wo_pre_cost_fab_conv_cost_dtls where job_no = '$popup_job_no' and id=".$row_se_set[csf('id')]." ";
		$rID4=execute_query($sql_insert_44,1);
		//echo $sql_insert_44;
	}
	//wo_pre_cost_trim_cost_dtls
	$sql_se_set_5=sql_select("select id from wo_pre_cost_trim_cost_dtls  where job_no='$popup_job_no' order by id ASC");
	foreach($sql_se_set_5 as $row_se_set)
	{
		$id5=return_next_id( "id", "wo_pre_cost_trim_cost_dtls", 1 );
		$sql_insert_55="insert into wo_pre_cost_trim_cost_dtls (id, job_no, trim_group, description, brand_sup_ref, cons_uom, seq, rate, amount, apvl_req, nominated_supp, inserted_by, remark, country, calculatorstring, unit_price, inco_term, add_price) select $id5, '".$main_job_no."', trim_group, description, brand_sup_ref, cons_uom, seq, rate, amount, apvl_req, nominated_supp, ".$_SESSION['logic_erp']['user_id'].", remark, country, calculatorstring, unit_price, inco_term, add_price from wo_pre_cost_trim_cost_dtls where job_no = '$popup_job_no' and id=".$row_se_set[csf('id')]." ";
		$rID5=execute_query($sql_insert_55,1);
		//echo $sql_insert_55;
	}
	//wo_pre_cost_embe_cost_dtls
	$sql_se_set_6=sql_select("select id from wo_pre_cost_embe_cost_dtls  where job_no='$popup_job_no' order by id ASC");
	foreach($sql_se_set_6 as $row_se_set)
	{
		$id6=return_next_id( "id", "wo_pre_cost_embe_cost_dtls", 1 );
		$sql_insert_66="insert into wo_pre_cost_embe_cost_dtls (id,job_no,emb_name,emb_type,cons_dzn_gmts,rate,amount,charge_lib_id,inserted_by,insert_date,status_active, is_deleted) select $id6,'".$main_job_no."',emb_name,emb_type,cons_dzn_gmts,rate,amount,charge_lib_id,".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',status_active, is_deleted from wo_pre_cost_embe_cost_dtls where job_no = '$popup_job_no' and id=".$row_se_set[csf('id')]." ";
		$rID6=execute_query($sql_insert_66,1);
		//echo $sql_insert_66;
	}
	//wo_pre_cost_comarci_cost_dtls
	$sql_se_set_7=sql_select("select id from wo_pre_cost_comarci_cost_dtls  where job_no='$popup_job_no' order by id ASC");
	foreach($sql_se_set_7 as $row_se_set)
	{
		$id7=return_next_id( "id", "wo_pre_cost_comarci_cost_dtls", 1 );
		$sql_insert_77="insert into wo_pre_cost_comarci_cost_dtls (id,job_no,item_id,rate,amount,inserted_by,insert_date,status_active,is_deleted) select $id7,'".$main_job_no."',item_id,rate,amount,".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',status_active,is_deleted from wo_pre_cost_comarci_cost_dtls where job_no = '$popup_job_no' and id=".$row_se_set[csf('id')]." ";
		$rID7=execute_query($sql_insert_77,1);
		//echo $sql_insert_77;
	}
	//wo_pre_cost_commiss_cost_dtls
	$sql_se_set_8=sql_select("select id from wo_pre_cost_commiss_cost_dtls  where job_no='$popup_job_no' order by id ASC");
	foreach($sql_se_set_8 as $row_se_set)
	{
		$id8=return_next_id( "id", "wo_pre_cost_commiss_cost_dtls", 1 );
		$sql_insert_88="insert into wo_pre_cost_commiss_cost_dtls (id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount,inserted_by,insert_date,status_active,is_deleted) select $id8,'".$main_job_no."',particulars_id,commission_base_id,commision_rate,commission_amount,".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',status_active,is_deleted from wo_pre_cost_commiss_cost_dtls where job_no = '$popup_job_no'  and id=".$row_se_set[csf('id')]." ";
		$rID8=execute_query($sql_insert_88,1);
		//echo $sql_insert_88;
	}

	if($db_type==0)
	{
		if( $rID2 || $rID3 || $rID4 || $rID5 || $rID6 || $rID7 || $rID8 ){
			mysql_query("COMMIT");
			echo "0**".$rID2.'*'.$rID3.'*'.$rID4.'*'.$rID5.'*'.$rID6.'*'.$rID7.'*'.$rID8;
		}
		else
		{
			mysql_query("ROLLBACK");
			echo "10**".$rID1;
		}
	}
	if($db_type==2 || $db_type==1 )
		{
			if( $rID2 || $rID3 || $rID4 || $rID5 || $rID6 || $rID7 || $rID8 )
			{
				oci_commit($con);
				echo "0**".$rID2.'*'.$rID3.'*'.$rID4.'*'.$rID5.'*'.$rID6.'*'.$rID7.'*'.$rID8;
			}
			else
			{
				oci_rollback($con);
				echo "10**".$rID2.'*'.$rID3.'*'.$rID4.'*'.$rID5.'*'.$rID6.'*'.$rID7.'*'.$rID8;
			}
		}
	disconnect($con);
	die;

}
// END partial pre cost copy SAVE action here...............................


if($action=="check_data_mismass")
{
	$user_library=return_library_array( "select id,user_name from user_passwd", "id", "user_name"  );

	//Mysql
	/*$sql_check=sql_select("select Max(a.update_date) as cst_update_date, a.updated_by as cst_updated_by,   Max(b.update_date) as fct_update_date, b.updated_by as fct_updated_by  from wo_po_color_size_breakdown a, wo_pre_cost_fabric_cost_dtls b where a.job_no_mst=b.job_no and a.job_no_mst='$data'  and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 group by a.job_no_mst");*/
	//Oracle
	$sql_check=sql_select("select Max(a.update_date) as cst_update_date, Max(a.updated_by) as cst_updated_by,   Max(b.update_date) as fct_update_date, Max(b.updated_by) as fct_updated_by,Max(b.is_apply_last_update) as is_apply_last_update  from wo_po_color_size_breakdown a, wo_pre_cost_fabric_cost_dtls b where a.job_no_mst=b.job_no and a.job_no_mst='$data'  and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 group by a.job_no_mst");

	foreach($sql_check as $check_row)
	{
		if($check_row[csf("is_apply_last_update")]==2)
		{
			$check_input=1;
			$cst_update_date=date('d-m-Y',strtotime($check_row[csf("cst_update_date")]));
			$cst_update_time = date('g:i:s A',strtotime($check_row[csf("cst_update_date")]));
			$fct_update_date=date('d-m-Y',strtotime($check_row[csf("fct_update_date")]));
			$fct_update_time = date('g:i:s A',strtotime($check_row[csf("fct_update_date")]));

			$pre_cost_up="";
			if($check_row[csf("fct_update_date")] !="" && $check_row[csf("fct_update_date")] !="0000-00-00" && $check_row[csf("fct_update_date")] !="0")
			{
				$pre_cost_up="PreCost is updated by Mr. ".ucfirst($user_library[$check_row[csf("fct_updated_by")]])." at ".$fct_update_time.", on ".$fct_update_date;
			}

			$sms="Mr.".ucfirst($user_library[$check_row[csf("cst_updated_by")]])." have changed  Color Size Break Down at ".$cst_update_time.", on ".$cst_update_date.",".$pre_cost_up."  So You have to update Pre-cost";

			echo "document.getElementById('check_sms').innerHTML = '".$sms."';\n";
			echo "document.getElementById('check_input').value = '".$check_input."';\n";
		}
		else
		{
			$sms="";
			$check_input=0;
			echo "document.getElementById('check_input').value = '".$check_input."';\n";
			echo "document.getElementById('check_sms').innerHTML = '".$sms."';\n";
		}
	}
	exit();
}

if($action=="open_set_list_view")
{
	echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode,'','');
	extract($_REQUEST);
	?>
	<script>
	function js_set_value_set()
	{
		var rowCount = $('#tbl_set_details tr').length-1;
		var set_breck_down="";
		var smv_breck_down="";
		var item_id=""
		for(var i=1; i<=rowCount; i++)
		{
			if (form_validation('cboitem_'+i+'*txtsetitemratio_'+i,'Gmts Items*Set Ratio')==false)
			{
				return;
			}
			if(smv_breck_down=="")
			{
				smv_breck_down+=$('#cboitem_'+i).val()+'_'+$('#smv_'+i).val()+'_'+$('#smvset_'+i).val();
			}
			else
			{
				smv_breck_down+="__"+$('#cboitem_'+i).val()+'_'+$('#smv_'+i).val()+'_'+$('#smvset_'+i).val();
			}
		}
		var job_no=document.getElementById('job_no').value;
		var booking=return_global_ajax_value(job_no+"**"+smv_breck_down, 'update_smv', '', 'pre_cost_entry_controller_v2');
		document.getElementById('set_breck_down').value=smv_breck_down;
		parent.emailwindow.hide();
	}

	function calculate_set_smv(i)
	{
		var txtsetitemratio=document.getElementById('txtsetitemratio_'+i).value;
		var smv=document.getElementById('smv_'+i).value;
		var set_smv=txtsetitemratio*smv;
		document.getElementById('smvset_'+i).value=set_smv;
		set_sum_value_set( 'tot_set_qnty', 'txtsetitemratio_' );
		set_sum_value_set( 'tot_smv_qnty', 'smvset_' );
	}

	function set_sum_value_set(des_fil_id,field_id)
	{
		var rowCount = $('#tbl_set_details tr').length-1;
		if(des_fil_id=="tot_set_qnty")
		{
		math_operation( des_fil_id, field_id, '+', rowCount );
		}
		if(des_fil_id=="tot_smv_qnty")
		{
		var ddd={ dec_type:1, comma:0, currency:1}
		math_operation( des_fil_id, field_id, '+', rowCount,ddd );
		}
	}
	</script>
	</head>
	<body>
       <div id="set_details"  align="center">
        <fieldset>
            <form id="setdetails_1" autocomplete="off">
            <input type="hidden" id="set_breck_down" />
            <input type="hidden" id="item_id" />
            <input type="hidden" id="job_no" value="<? echo $txt_job_no; ?>" />
            <table width="520" cellspacing="0" class="rpt_table" border="0" id="tbl_set_details" rules="all">
                <thead>
                    <tr>
                        <th width="230">Item</th>
                        <th width="50">Set Ratio</th>
                        <th width="40">Knit. SMV/ Pcs</th>
                        <th width="40">Link. SMV/ Pcs</th>
                        <th width="40">Trim. SMV/ Pcs</th>
                        <th width="40">Fin. SMV/ Pcs</th>
                        <th width=""></th>
                    </tr>
                </thead>
                <tbody>
					<?
                    $tot_set_qnty=0; $tot_smv_qnty=$tot_link_smv=$tot_trim_smv=$tot_fin_smv=0; 
                    $data_array=explode("__",$set_breck_down);

                    $data_array=sql_select("Select gmts_item_id, set_item_ratio, smv_pcs, smv_set, smv_pcs_precost, smv_set_precost, cutsmv_pcs, cutsmv_set, finsmv_pcs, finsmv_set, trimsmv, trimsmvset from wo_po_details_mas_set_details where job_no='$txt_job_no'");

                    if ( count($data_array)>0)
                    {
						$i=0;
						foreach( $data_array as $row )
						{
							$i++;
							//$data=explode('_',$row);
							$smv_pcs_precost=0; $smv_set_precost=0; $linksmv_pcs=$linksmv_set=$trimsmv_pcs=$trimsmv_set=$finsmv_pcs=$finsmv_set=0;
							$tot_set_qnty=$tot_set_qnty+$row[csf("set_item_ratio")];
							if($row[csf("smv_set_precost")]>0 || $row[csf("smv_pcs_precost")]>0)
							{
								$smv_pcs_precost=$row[csf("smv_pcs_precost")];
								$smv_set_precost=$row[csf("smv_set_precost")];
								$tot_smv_qnty=$tot_smv_qnty+$row[csf("smv_set_precost")];
							}
							else
							{
								$smv_pcs_precost=$row[csf("smv_pcs")];
								$smv_set_precost=$row[csf("smv_set")];
								$tot_smv_qnty=$tot_smv_qnty+$row[csf("smv_set")];
							}
							
							$linksmv_pcs=$row[csf("cutsmv_pcs")];
							$linksmv_set=$row[csf("cutsmv_set")];
							$trimsmv_pcs=$row[csf("trimsmv")];
							$trimsmv_set=$row[csf("trimsmvset")];
							$finsmv_pcs=$row[csf("finsmv_pcs")];
							$finsmv_set=$row[csf("finsmv_set")];
							
							$tot_link_smv+=$linksmv_set;
							$tot_trim_smv+=$trimsmv_set;
							$tot_fin_smv+=$finsmv_set;
							
							?>
							<tr id="settr_<?=$i; ?>" align="center">
                                <td><?=create_drop_down( "cboitem_".$i, 230, $garments_item, "",1,"-- Select Item --", $row[csf("gmts_item_id")], "",1,'' ); ?></td>
                                <td><input type="text" id="txtsetitemratio_<?=$i; ?>" name="txtsetitemratio_<?=$i; ?>" style="width:40px" class="text_boxes_numeric" value="<?=$row[csf("set_item_ratio")]; ?>" readonly/></td>
                                <td>
                                    <input type="text" id="smv_<?=$i; ?>" name="smv_<?=$i; ?>" style="width:30px" class="text_boxes_numeric" value="<?=number_format($smv_pcs_precost,2); ?>" disabled />
                                    <input type="hidden" id="smvset_<?=$i; ?>" style="width:30px" class="text_boxes_numeric" value="<?=$smv_set_precost; ?>" />
                                </td>
                                <td>
                                	<input type="text" id="cutsmv_<?=$i; ?>" name="cutsmv_<?=$i; ?>" style="width:30px" class="text_boxes_numeric" value="<?=number_format($linksmv_pcs,2); ?>" disabled />
                                     <input type="hidden" id="cutsmvset_<?=$i; ?>" style="width:20px" class="text_boxes_numeric" value="<?=$linksmv_set; ?>" readonly/>
                                </td>
                                <td>
                                	<input type="text" id="trimsmv_<?=$i; ?>" name="trimsmv_<?=$i; ?>" style="width:30px" class="text_boxes_numeric" value="<?=number_format($trimsmv_pcs,2); ?>" disabled />
                                	<input type="hidden" id="trimsmvset_<?=$i;?>" style="width:20px" class="text_boxes_numeric" value="<?=$trimsmv_set; ?>" readonly/>
                                </td>
                                <td>
                                    <input type="text" id="finsmv_<?=$i; ?>" name="finsmv_<?=$i; ?>" style="width:30px" class="text_boxes_numeric" value="<?=number_format($finsmv_pcs,2); ?>" disabled />
                                    <input type="hidden" id="finsmvset_<?=$i;?>" style="width:20px" class="text_boxes_numeric" value="<?=$finsmv_set; ?>" readonly/>
                               </td>
                               <td>&nbsp;</td>
							</tr>
							<?
						}
                    }
                    else
                    {
						?>
						<tr id="settr_1" align="center">
							<td><? echo create_drop_down( "cboitem_1", 230, $garments_item, "",1,"--Select--", 0, '',1,'' ); ?></td>
							<td><input type="text" id="txtsetitemratio_1" name="txtsetitemratio_1" style="width:40px" class="text_boxes_numeric"  readonly /></td>
							<td>
                                <input type="text" id="smv_1" name="smv_1" style="width:30px" class="text_boxes_numeric" />
                                <input type="hidden" id="smvset_1" style="width:30px" class="text_boxes_numeric"   value=""  />
							</td>
                             <td>
                                 <input type="text" id="cutsmv_1" name="cutsmv_1" style="width:30px" class="text_boxes_numeric"   value="0"  />
                                <input type="hidden" id="cutsmvset_1" style="width:30px" class="text_boxes_numeric"   value="0"  />
                            </td>
                            <td>
                                <input type="text" id="trimsmv_1" name="trimsmv_1" style="width:30px" class="text_boxes_numeric"  value="0"  />
                                <input type="hidden" id="trimsmvset_1" style="width:30px" class="text_boxes_numeric" value="0" />
                            </td>
                            <td>
                                <input type="text" id="finsmv_1" name="finsmv_1" style="width:30px" class="text_boxes_numeric" value="0"  />
                                <input type="hidden" id="finsmvset_1" style="width:30px" class="text_boxes_numeric"   value="0"  />
                            </td>
							<td>&nbsp;</td>
						</tr>
						<?
                    }
                    ?>
                </tbody>
            </table>
            <table width="520" cellspacing="0" class="rpt_table" border="0" rules="all">
                <tfoot>
                    <tr>
                        <th width="230">Total</th>
                        <th width="50"><input type="text" id="tot_set_qnty" name="tot_set_qnty"  class="text_boxes_numeric" style="width:40px" value="<?=$tot_set_qnty; ?>" disabled /></th>
                        <th width="40"><input type="text" id="tot_smv_qnty" name="tot_smv_qnty" class="text_boxes_numeric" style="width:30px" value="<? if($tot_smv_qnty!=''){ echo number_format($tot_smv_qnty,2);} else{ echo 1;} ?>" disabled /></th>
                        <th width="40"><input type="text" id="tot_cutsmv_qnty" name="tot_cutsmv_qnty" class="text_boxes_numeric" style="width:30px" value="<? if($tot_link_smv !=''){ echo number_format($tot_link_smv,2);} else{ echo 0;} ?>" disabled />
                        </th>
                        <th width="40"><input type="text" id="tot_trimsmv_qnty" name="tot_trimsmv_qnty" class="text_boxes_numeric" style="width:30px" value="<? if($tot_trim_smv !=''){ echo number_format($tot_trim_smv,2);} else{ echo 0;} ?>" disabled />
                        </th>
                        <th width="40"><input type="text" id="tot_finsmv_qnty" name="tot_finsmv_qnty" class="text_boxes_numeric" style="width:30px" value="<? if($tot_fin_smv !=''){ echo number_format($tot_fin_smv,2);} else{ echo 0;} ?>" disabled />
                        </th>
                        <th>&nbsp;</th>
                    </tr>
                </tfoot>
            </table>
            <table width="520" cellspacing="0" class="" border="0">
                <tr>
                    <td align="center" width="100%" class="button_container"><input type="button" class="formbutton" value="Close" onClick="js_set_value_set()"/></td>
                </tr>
            </table>
            </form>
        </fieldset>
        </div>
	 </body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}

if($action=='update_smv')
{
	$data=explode("**",$data);
	$data_array=explode("__",$data[1]);
	if ( count($data_array)>0)
	{
		$i=0;
		foreach( $data_array as $row )
		{
			$i++;
			$data_smv=explode('_',$row);
			$con = connect();
			if($db_type==0)
			{
				mysql_query("BEGIN");
			}
			$rID_de1=execute_query( "update wo_po_details_mas_set_details set smv_pcs_precost='$data_smv[1]',smv_set_precost='$data_smv[2]',smv_pcs='$data_smv[1]',smv_set='$data_smv[2]'  where  job_no ='".$data[0]."' and gmts_item_id=".$data_smv[0]."",0);
			if($db_type==0)
			{
				if($rID_de1==1){
					mysql_query("COMMIT");
					//echo "0**".$rID."**".str_replace("'","",$txt_job_no);
				}
				else{
					mysql_query("ROLLBACK");
					//echo "10**".$rID."**".str_replace("'","",$txt_job_no);
				}
			}
			else if($db_type==2 || $db_type==1 )
			{
				if($rID_de1==1){
					oci_commit($con);
					//echo "0**".$rID."**".str_replace("'","",$txt_job_no);
				}
				else{
					oci_rollback($con);
					//echo "10**".$rID."**".str_replace("'","",$txt_job_no);
				}
			}
			disconnect($con);
		}
	}

	$job_no="'".$data[0]."'";

	$sql_d=sql_select('Select gmts_item_id AS "gmts_item_id",set_item_ratio AS "set_item_ratio",smv_pcs AS "smv_pcs",smv_set AS "smv_set",complexity AS "complexity",embelishment AS "embelishment", cutsmv_pcs AS "cutsmv_pcs", cutsmv_set AS "cutsmv_set", finsmv_pcs AS "finsmv_pcs", finsmv_set AS "finsmv_set",printseq AS "printseq",embro AS "embro",embroseq AS "embroseq",wash AS "wash",washseq AS "washseq",spworks AS "spworks" ,spworksseq AS "spworksseq",gmtsdying AS "gmtsdying",gmtsdyingseq AS "gmtsdyingseq" from wo_po_details_mas_set_details where job_no='.$job_no.' order by id');
	foreach($sql_d as $sql_r){
		if($sql_r['gmts_item_id']=="") $sql_r['gmts_item_id']=0;
		if($sql_r['set_item_ratio']=="") $sql_r['set_item_ratio']=0;
		if($sql_r['smv_pcs']=="") $sql_r['smv_set']=0;
		if($sql_r['complexity']=="") $sql_r['complexity']=0;
		if($sql_r['embelishment']=="") $sql_r['embelishment']=0;
		if($sql_r['cutsmv_pcs']==""){
			$sql_r['cutsmv_pcs']=0;
			$sql_r['cutsmv_set']=0;
		}
		if($sql_r['finsmv_pcs']==""){
			$sql_r['finsmv_pcs']=0;
			$sql_r['finsmv_set']=0;
		}
		if($sql_r['printseq']=="") $sql_r['printseq']=0;
		if($sql_r['embro']=="") $sql_r['embro']=0;
		if($sql_r['embroseq']=="") $sql_r['embroseq']=0;

		if($sql_r['wash']=="") $sql_r['wash']=0;
		if($sql_r['washseq']=="") $sql_r['washseq']=0;

		if($sql_r['spworks']=="") $sql_r['spworks']=0;
		if($sql_r['spworksseq']=="") $sql_r['spworksseq']=0;

		if($sql_r['gmtsdying']=="") $sql_r['gmtsdying']=0;
		if($sql_r['gmtsdyingseq']=="") $sql_r['gmtsdyingseq']=0;

		$sql_r=removenumeric($sql_r);
		$smv_arr[]=implode("_",$sql_r);
	}
	$smv_srt=rtrim(implode("__",$smv_arr),"__");
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}
	$rID3=execute_query( "update  wo_po_details_master set set_break_down='$smv_srt'  where  job_no =".$job_no."",1);
	if($db_type==0)
	{
		if($rID3==1){
			mysql_query("COMMIT");
		}
		else{
			mysql_query("ROLLBACK");
		}
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($rID3==1){
			oci_commit($con);
		}
		else{
			oci_rollback($con);
		}
	}
	disconnect($con);
}

if($action=='is_used_costing_per')
{
	$sql_data=sql_select("select count(a.id) as id, a.costing_per from  wo_pre_cost_mst a, wo_pre_cost_fabric_cost_dtls b, wo_pre_cost_dtls c where a.job_no=b.job_no and a.job_no=c.job_no and a.job_no='$data' and a.is_deleted=0 and  a.status_active=1 and b.is_deleted=0 and b.status_active=1 group by a.job_no,a.costing_per");
	$id=0;
	$costing_per=0;
	foreach($sql_data as $row)
	{
		$id=$row[csf('id')];


		$costing_per=$row[csf('costing_per')];
	}
	echo trim($id)."_".trim($costing_per);
	die;
}

if($action=='is_booking_found')
{
	$sql_data=sql_select("select count(a.id) as id,a.booking_no from  wo_booking_mst a, wo_booking_dtls b where a.job_no=b.job_no and a.booking_no=b.booking_no  and a.job_no='$data' and a.is_deleted=0 and  a.status_active=1 and b.is_deleted=0 and b.status_active=1 group by a.booking_no");
	$id=0;
	$booking_no=array();
	foreach($sql_data as $row)
	{
		$id=$row[csf('id')];
		$booking_no[]=$row[csf('booking_no')];
	}
	echo trim($id)."_".implode(",",$booking_no);
	die;
}

if($action=='delete_costing')
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}
	$rID_de1=execute_query( "update  wo_pre_cost_dtls set status_active=0, is_deleted=1 where  job_no ='$data' and status_active=1 and is_deleted=0",0);
	$rID_de1=execute_query( "update  wo_pre_cost_fabric_cost_dtls set status_active=0, is_deleted=1 where  job_no ='$data' and status_active=1 and is_deleted=0",0);

	$rID_de1=execute_query( "update  wo_pre_cost_fab_yarn_cost_dtls set status_active=0, is_deleted=1 where  job_no ='$data' and status_active=1 and is_deleted=0",0);
	$rID_de1=execute_query( "update  wo_pre_cost_fab_conv_cost_dtls set status_active=0, is_deleted=1 where  job_no ='$data' and status_active=1 and is_deleted=0",0);


	$rID_de1=execute_query( "update  wo_pre_cost_trim_cost_dtls set status_active=0, is_deleted=1 where  job_no ='$data' and status_active=1 and is_deleted=0",0);
	$rID_de1=execute_query( "update  wo_pre_cost_embe_cost_dtls set status_active=0, is_deleted=1 where  job_no ='$data' and status_active=1 and is_deleted=0",0);

	if($db_type==0)
	{
		if($rID_de1)
		{
			mysql_query("COMMIT");
			echo 0;
		}
		else
		{
			mysql_query("ROLLBACK");
			echo 10;
		}
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($rID_de1)
		{
			oci_commit($con);
			echo 0;
		}
		else
		{
			oci_rollback($con);
			echo 10;
		}
	}
	disconnect($con);
	die;
}

if($action=='active_costing')
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}
	$rID_de1=execute_query( "update  wo_pre_cost_dtls set status_active=1, is_deleted=0 where  job_no ='$data'  and status_active=0 and is_deleted=1",0);
	$rID_de1=execute_query( "update  wo_pre_cost_fabric_cost_dtls set status_active=1, is_deleted=0 where  job_no ='$data' and status_active=0 and is_deleted=1",0);
	$rID_de1=execute_query( "update  wo_pre_cost_fab_yarn_cost_dtls set status_active=1, is_deleted=0 where  job_no ='$data' and status_active=0 and is_deleted=1",0);
	$rID_de1=execute_query( "update   wo_pre_cost_fab_conv_cost_dtls set status_active=1, is_deleted=0 where  job_no ='$data' and status_active=0 and is_deleted=1",0);

	$rID_de1=execute_query( "update  wo_pre_cost_trim_cost_dtls set status_active=1, is_deleted=0 where  job_no ='$data' and status_active=0 and is_deleted=1",0);
	$rID_de1=execute_query( "update  wo_pre_cost_embe_cost_dtls set status_active=1, is_deleted=0 where  job_no ='$data' and status_active=0 and is_deleted=1",0);
	if($db_type==0)
	{
		if($rID_de1)
		{
			mysql_query("COMMIT");
			echo 0;
		}

		else
		{
			mysql_query("ROLLBACK");
			echo 10;
		}
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($rID_de1)
		{
			oci_commit($con);
			echo 0;
		}
		else
		{
			oci_rollback($con);
			echo 10;
		}
	}
	disconnect($con);
	die;
}

if($action=='delete_costing_permanently')
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}

	$rID_de1=execute_query( "update  wo_pre_cost_fabric_cost_dtls set status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",0);
	$rID_de1=execute_query( "delete from wo_pre_cos_fab_co_avg_con_dtls where job_no ='$data'",0);
	$rID_de1=execute_query( "delete from wo_pre_cos_fab_co_color_dtls where job_no ='$data'",0);

	$rID_de1=execute_query( "update  wo_pre_cost_fab_yarn_cost_dtls set status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",0);
	$rID_de1=execute_query( "update  wo_pre_cost_fab_yarnbreakdown set status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",0);

	$rID_de1=execute_query( "update  wo_pre_cost_fab_conv_cost_dtls set status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",0);

	$rID_de1=execute_query( "update  wo_pre_cost_trim_cost_dtls set status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",0);
	$rID_de1=execute_query( "delete from wo_pre_cost_trim_co_cons_dtls where job_no ='$data'",0);

	$rID_de1=execute_query( "update  wo_pre_cost_embe_cost_dtls set status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",0);

	$rID_de1=execute_query( "update  wo_pre_cost_comarci_cost_dtls set status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",0);
	$rID_de1=execute_query( "update  wo_pre_cost_commiss_cost_dtls set status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",0);

	//$rID_de1=execute_query( "update  wo_pre_cost_dtls set status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",0);
	//$rID_de1=execute_query( "update  wo_pre_cost_sum_dtls set status_active=0, is_deleted=1 where job_no ='$data' and status_active=1 and is_deleted=0",0);
	if($db_type==0)
	{
		if($rID_de1)
		{
			mysql_query("COMMIT");
			echo 0;
		}
		else
		{
			mysql_query("ROLLBACK");
			echo 10;
		}
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($rID_de1)
		{
			oci_commit($con);
			echo 0;
		}
		else
		{
			oci_rollback($con);
			echo 10;
		}
	}

	disconnect($con);
	die;
}

if($action=='check_is_master_part_saved')
{
	$job_no=return_field_value("job_no", "wo_pre_cost_mst","job_no='$data' and status_active =1 and is_deleted=0");
	echo $job_no;
}

if ($action=="save_update_delete")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$date= date('Y-m-d');
	/*$copy_quotation=return_field_value("copy_quotation", "variable_order_tracking", "company_name=$cbo_company_name  and variable_list=20  and status_active=1 and is_deleted=0");*/
	$sql=sql_select("select approval_need from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
	$app_nessity=2;
	foreach($sql as $row){
		$app_nessity=$row[csf('approval_need')];
	}

	$sql=sql_select("select approved from wo_price_quotation  where id=$txt_quotation_id");
	$quatation_approved=2;
	foreach($sql as $row){
		$quatation_approved=$row[csf('approved')];
	}

	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	//echo "10**",$is_copy_quatation."**". $app_nessity."**".$quatation_approved;
	//die;
	if($is_copy_quatation==1 && $app_nessity==1){
		if($quatation_approved==2 || $quatation_approved==0 || $quatation_approved==3){
			echo "quataNotApp**".str_replace("'","",$txt_job_no);
			disconnect($con);die;
		}
	}
	if ($operation==0)  // Insert Here
	{
		if (is_duplicate_field( "job_no", "wo_pre_cost_mst", "job_no=$txt_job_no and is_deleted=0 and status_active=1" ) == 1)
		{
			echo "11**0"; disconnect($con);die;
		}
		else
		{
			$con = connect();
			if($db_type==0)
			{
				mysql_query("BEGIN");
			}
			$id=return_next_id( "id", "wo_pre_cost_mst", 1 );
			$field_array="id, job_id, garments_nature, job_no, costing_date, incoterm, incoterm_place, machine_line, prod_line_hr, costing_per, copy_quatation, cm_cost_predefined_method_id, exchange_rate, sew_smv, cut_smv, sew_effi_percent, cut_effi_percent, efficiency_wastage_percent, sew_efficiency_source, remarks, ready_to_approved, budget_minute, entry_from, inserted_by, insert_date, status_active, is_deleted";
			$data_array="(".$id.",".$hidd_job_id.",".$garments_nature.",".$txt_job_no.",".$txt_costing_date.",".$cbo_inco_term.",".$txt_incoterm_place.",".$txt_machine_line.",".$txt_prod_line_hr.",".$cbo_costing_per.",".$copy_quatation_id.",".$cm_cost_predefined_method_id.",".$txt_exchange_rate.",".$txt_sew_smv.",".$txt_cut_smv.",".$txt_sew_efficiency_per.",".$txt_cut_efficiency_per.",".$txt_efficiency_wastage.",".$txt_sew_efficiency_source.",".$txt_remarks.",".$cbo_ready_to_approved.",".$txt_budget_minute.",'521',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."','1','0')";
			$rID=sql_insert("wo_pre_cost_mst",$field_array,$data_array,1);
			//$rID3=execute_query( "update  wo_po_details_master set set_smv=$txt_sew_smv  where  job_no =".$txt_job_no."",1);

			if($db_type==0)
			{
				if($rID==1){
					mysql_query("COMMIT");
					echo "0**".$rID."**".str_replace("'","",$txt_job_no);
				}
				else{
					mysql_query("ROLLBACK");
					echo "10**".$rID."**".str_replace("'","",$txt_job_no);
				}
			}
			else if($db_type==2 || $db_type==1 )
			{
				if($rID==1){
					oci_commit($con);
					echo "0**".$rID."**".str_replace("'","",$txt_job_no);
				}
				else{
					oci_rollback($con);
					echo "10**".$rID."**".str_replace("'","",$txt_job_no);
				}
			}
			disconnect($con);
			die;
		}
	}
	else if ($operation==1)   // Update Here
	{

		
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		$approved=0;
		$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$txt_job_no");
		foreach($sql as $row){
			if($row[csf('approved')]==3){
				$approved=1;
			}else{
				$approved=$row[csf('approved')];
			}
		}
		if($approved==1){
			echo "approved**".str_replace("'","",$txt_job_no);
			disconnect($con);die;
		}
		
		$materialReciveNo="";
		$sql=sql_select("select a.recv_number from inv_receive_master a, inv_transaction b, wo_po_break_down c where a.id=b.mst_id and b.job_no=c.job_no_mst and b.job_no=$txt_job_no and a.entry_form=248 and c.is_confirmed=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by a.recv_number");
		foreach($sql as $row)
		{
			if($materialReciveNo=="") $materialReciveNo=$row[csf('recv_number')]; else $materialReciveNo.=','.$row[csf('recv_number')];
		}
		if($materialReciveNo!=""){
			echo "materialRecive**".$materialReciveNo;
			disconnect($con);die;
		}

		$copy_quatation=0;
		$quotation_id=0;
		$ready_to_approved=str_replace("'","",$cbo_ready_to_approved);
		$sql=sql_select("select a.copy_quatation,b.quotation_id from wo_pre_cost_mst a, wo_po_details_master b where a.job_no=b.job_no and  a.job_no=$txt_job_no");
		foreach($sql as $row){
			$copy_quatation=$row[csf('copy_quatation')];
			$quotation_id=$row[csf('quotation_id')];
		}
		if($copy_quatation==1 && $ready_to_approved==1){
			$sql_fab=sql_select("select job_no,sum(amount) as avg_cons from wo_pre_cost_fabric_cost_dtls where job_no=$txt_job_no group by job_no");
			$fabQtyPre=0;
			foreach($sql_fab as $row_fab){
				$fabQtyPre=$row_fab[csf('avg_cons')]*1;	
			}
			$sql_fab=sql_select("select quotation_id,sum(amount) as avg_cons from wo_pri_quo_fabric_cost_dtls where quotation_id=$quotation_id group by quotation_id");
			$fabQtyPri=0;
			foreach($sql_fab as $row_fab){
				$fabQtyPri=$row_fab[csf('avg_cons')]*1;	
			}
			//if($fabQtyPri >0 && $fabQtyPre <=0)
			if($fabQtyPri>0)
			{
				if($fabQtyPri<$fabQtyPre){
					echo "FabApp**".str_replace("'","",$txt_job_no).'**'.$fabQtyPri.'**'.$fabQtyPre;
					disconnect($con);die;
				}
			}
			
			$sql_yarn=sql_select("select job_no,sum(cons_qnty) as cons_qnty from wo_pre_cost_fab_yarn_cost_dtls where job_no=$txt_job_no group by job_no");
			$yarQtyPre=0;
			foreach($sql_yarn as $row_yarn){
				$yarQtyPre=$row_yarn[csf('cons_qnty')]*1;	
			}
			
			$sql_yar=sql_select("select quotation_id,sum(cons_qnty) as cons_qnty from wo_pri_quo_fab_yarn_cost_dtls where quotation_id=$quotation_id group by quotation_id");
			$yarQtyPri=0;
			
			foreach($sql_yar as $row_yarn){
				$yarQtyPri=$row_yarn[csf('cons_qnty')]*1;	
			}
			if($yarQtyPri>0)
			{
				//if( $yarQtyPri >0 && $yarQtyPre <=0)
				if( $yarQtyPri<$yarQtyPre){
					echo "YarApp**".str_replace("'","",$txt_job_no).'**'.$yarQtyPri.'**'.$yarQtyPre;
					disconnect($con);die;
				}
			}
			
			
			$sql_con=sql_select("select job_no,sum(req_qnty) as req_qnty from wo_pre_cost_fab_conv_cost_dtls where job_no=$txt_job_no group by job_no");
			$conQtyPre=0;
			foreach($sql_con as $row_con){
				$conQtyPre=$row_con[csf('req_qnty')]*1;	
			}
			
			$sql_con=sql_select("select quotation_id,sum(req_qnty) as req_qnty from wo_pri_quo_fab_conv_cost_dtls where quotation_id=$quotation_id group by quotation_id");
			$conQtyPri=0;
			foreach($sql_con as $row_con){
				$conQtyPri=$row_con[csf('req_qnty')]*1;	
			}
			//if( $conQtyPri >0 && $conQtyPre <=0)
			if($conQtyPri>0)
			{
				if( $conQtyPri<$conQtyPre){
					echo "ConApp**".str_replace("'","",$txt_job_no).'**'.$conQtyPri."**".$conQtyPre;
					disconnect($con);die;
				}
			}
			
			$sql_tri=sql_select("select job_no,sum(amount) as cons_dzn_gmts from wo_pre_cost_trim_cost_dtls where job_no=$txt_job_no group by job_no");
			$triQtyPre=0;
			foreach($sql_tri as $row_tri){
				$triQtyPre=$row_tri[csf('cons_dzn_gmts')]*1;	
			}
			
			$sql_tri=sql_select("select quotation_id,sum(amount) as cons_dzn_gmts from wo_pri_quo_trim_cost_dtls where quotation_id=$quotation_id group by quotation_id");
			$triQtyPri=0;
			foreach($sql_tri as $row_tri){
				$triQtyPri=$row_tri[csf('cons_dzn_gmts')]*1;	
			}
			//if($triQtyPri >0 && $triQtyPre <=0)
			if($triQtyPri>0)
			{
				if($triQtyPri<$triQtyPre){
					echo "TriApp**".str_replace("'","",$txt_job_no).'**'.$triQtyPri."**".$triQtyPre;
					disconnect($con);die;
				}
			}
			
			$sql_emb=sql_select("select job_no,sum(cons_dzn_gmts) as cons_dzn_gmts from wo_pre_cost_embe_cost_dtls where job_no=$txt_job_no and emb_name!=3 group by job_no");
			$embQtyPre=0;
			foreach($sql_emb as $row_emb){
				$embQtyPre=$row_emb[csf('cons_dzn_gmts')]*1;	
			}
			
			$sql_emb=sql_select("select quotation_id,sum(cons_dzn_gmts) as cons_dzn_gmts from wo_pri_quo_embe_cost_dtls where quotation_id=$quotation_id and emb_name!=3 group by quotation_id");
			$embQtyPri=0;
			foreach($sql_emb as $row_emb){
				$embQtyPri=$row_emb[csf('cons_dzn_gmts')]*1;	
			}
			//if( $embQtyPri >0 && $embQtyPre <=0)
			if($embQtyPri>0)
			{
				if( $embQtyPri<$embQtyPre){
					echo "EmbApp**".str_replace("'","",$txt_job_no).'**'.$embQtyPri."**".$embQtyPre;
					disconnect($con);die;
				}
			}
			
			$sql_was=sql_select("select job_no,sum(cons_dzn_gmts) as cons_dzn_gmts from wo_pre_cost_embe_cost_dtls where job_no=$txt_job_no and emb_name =3 group by job_no");
			$wasQtyPre=0;
			foreach($sql_was as $row_was){
				$wasQtyPre=$row_was[csf('cons_dzn_gmts')]*1;	
			}
			
			$sql_was=sql_select("select quotation_id,sum(cons_dzn_gmts) as cons_dzn_gmts from wo_pri_quo_embe_cost_dtls where quotation_id=$quotation_id and emb_name =3 group by quotation_id");
			$wasQtyPri=0;
			foreach($sql_was as $row_was){
				$wasQtyPri=$row_was[csf('cons_dzn_gmts')]*1;	
			}
			//if($wasQtyPri >0 && $wasQtyPre <=0)
			if($wasQtyPri>0)
			{
				if($wasQtyPri<$wasQtyPre){
					echo "WasApp**".str_replace("'","",$txt_job_no).'**'.$wasQtyPri."**".$wasQtyPre;
					disconnect($con);die;
				}
			}
			
			$sql_comn=sql_select("select job_no,sum(commission_amount) as commission_amount from wo_pre_cost_commiss_cost_dtls where job_no=$txt_job_no  group by job_no");
			$comnQtyPre=0;
			foreach($sql_comn as $row_comn){
				$comnQtyPre=$row_comn[csf('commission_amount')]*1;	
			}
			
			$sql_comn=sql_select("select quotation_id,sum(commission_amount) as commission_amount from wo_pri_quo_commiss_cost_dtls where quotation_id=$quotation_id  group by quotation_id");
			$comnQtyPri=0;
			foreach($sql_comn as $row_comn){
				$comnQtyPri=$row_comn[csf('commission_amount')]*1;	
			}
			//if( $comnQtyPri >0 && $comnQtyPre <=0)
			if($comnQtyPri>0)
			{
				if( $comnQtyPri<$comnQtyPre){
					echo "ComnApp**".str_replace("'","",$txt_job_no).'**'.$comnQtyPri."**".$comnQtyPre;
					disconnect($con);die;
				}
			}
			
			
			$sql_comm=sql_select("select job_no,sum(amount) as amount from wo_pre_cost_comarci_cost_dtls where job_no=$txt_job_no  group by job_no");
			$commQtyPre=0;
			foreach($sql_comm as $row_comm){
				$commQtyPre=$row_comm[csf('amount')]*1;	
			}
			
			$sql_comm=sql_select("select quotation_id,sum(amount) as amount from wo_pri_quo_comarcial_cost_dtls where quotation_id=$quotation_id  group by quotation_id");
			$commQtyPri=0;
			foreach($sql_comm as $row_comm){
				$commQtyPri=$row_comm[csf('amount')]*1;	
			}
			
			//if( $commQtyPri >0 && $commQtyPre <=0)
			if($commQtyPri>0)
			{
				if( $commQtyPri<$commQtyPre){
					echo "CommApp**".str_replace("'","",$txt_job_no).'**'.$commQtyPri."**".$commQtyPre;
					disconnect($con);die;
				}
			}
			
			$lab_test=0; $inspection=0; $cm_cost=0; $freight=0; $currier_pre_cost=0; $certificate_pre_cost=0; $common_oh=0; $depr_amor_pre_cost=0; $interest_cost=0; $incometax_cost=0;
			
			//$deffdlc_cost=0;
			
			$sql_oth=sql_select("select job_no, lab_test, inspection, cm_cost, freight, currier_pre_cost, certificate_pre_cost, common_oh, depr_amor_pre_cost, deffdlc_cost, interest_cost, incometax_cost from wo_pre_cost_dtls where job_no=$txt_job_no");
			foreach($sql_oth as $oth_row){
				$lab_test=$oth_row[csf('lab_test')]*1;
				$inspection=$oth_row[csf('inspection')]*1;
				$cm_cost=$oth_row[csf('cm_cost')]*1;
				$freight=$oth_row[csf('freight')]*1;
				$currier_pre_cost=$oth_row[csf('currier_pre_cost')]*1;
				$certificate_pre_cost=$oth_row[csf('certificate_pre_cost')]*1;
				$common_oh=$oth_row[csf('common_oh')]*1;
				$depr_amor_pre_cost=$oth_row[csf('depr_amor_pre_cost')]*1;
				$interest_cost=$oth_row[csf('interest_cost')]*1;
				$incometax_cost=$oth_row[csf('incometax_cost')]*1;
				
				//$deffdlc_cost=$oth_row[csf('deffdlc_cost')];
			}
			
			$lab_test_pri=0; $inspection_pri=0; $cm_cost_pri=0; $freight_pri=0; $currier_pre_cost_pri=0; $certificate_pre_cost_pri=0; $common_oh_pri=0; $depr_amor_pre_cost_pri=0; $interest_cost_pri=0; $incometax_cost_pri=0;
			
			//$deffdlc_cost_pri=0;
			$sql_oth=sql_select("select quotation_id, lab_test, inspection, cm_cost, freight, currier_pre_cost, certificate_pre_cost, common_oh, depr_amor_pre_cost, interest_pre_cost, income_tax_pre_cost from wo_price_quotation_costing_mst where quotation_id = $quotation_id");
			foreach($sql_oth as $oth_row){
				$lab_test_pri=$oth_row[csf('lab_test')]*1;
				$inspection_pri=$oth_row[csf('inspection')]*1;
				$cm_cost_pri=$oth_row[csf('cm_cost')]*1;
				$freight_pri=$oth_row[csf('freight')]*1;
				$currier_pre_cost_pri=$oth_row[csf('currier_pre_cost')]*1;
				$certificate_pre_cost_pri=$oth_row[csf('certificate_pre_cost')]*1;
				$common_oh_pri=$oth_row[csf('common_oh')]*1;
				$depr_amor_pre_cost_pri=$oth_row[csf('depr_amor_pre_cost')]*1;
				$interest_cost_pri=$oth_row[csf('interest_pre_cost')]*1;
				$incometax_cost_pri=$oth_row[csf('income_tax_pre_cost')]*1;
				//$deffdlc_cost_pri=$oth_row[csf('deffdlc_cost')];
			}
			
			//if( $lab_test_pri >0 && $lab_test <=0)
			if($lab_test_pri>0)
			{
				if( $lab_test_pri<$lab_test){
					echo "LabApp**".str_replace("'","",$txt_job_no).'**'.$lab_test_pri."**".$lab_test;
					disconnect($con);die;
				}
			}
			
			//if( $inspection_pri >0 &&  $inspection <=0)
			if($inspection_pri>0)
			{
				if( $inspection_pri<$inspection){
					echo "InspApp**".str_replace("'","",$txt_job_no).'**'.$inspection_pri."**".$inspection;
					disconnect($con);die;
				}
			}
			
			//if( $cm_cost_pri >0 && $cm_cost <=0)
			if($cm_cost_pri>0)
			{
				if( $cm_cost_pri<$cm_cost){
					echo "CmApp**".str_replace("'","",$txt_job_no).'**'.$cm_cost_pri."**".$cm_cost;
					disconnect($con);die;
				}
			}
			
			//if( $freight_pri >0 && $freight <=0)
			if($freight_pri>0)
			{
				if( $freight_pri<$freight){
					echo "FreApp**".str_replace("'","",$txt_job_no).'**'.$freight_pri."**".$freight;
					disconnect($con);die;
				}
			}
			
			//if( $currier_pre_cost_pri >0 && $currier_pre_cost <=0)
			if($currier_pre_cost_pri>0)
			{
				if( $currier_pre_cost_pri<$currier_pre_cost){
					echo "CurrApp**".str_replace("'","",$txt_job_no).'**'.$currier_pre_cost_pri."**".$currier_pre_cost;
					disconnect($con);die;
				}
			}
			
			//if( $certificate_pre_cost_pri >0 && $certificate_pre_cost <=0)
			if($certificate_pre_cost_pri>0)
			{
				if( $certificate_pre_cost_pri<$certificate_pre_cost){
					echo "CertApp**".str_replace("'","",$txt_job_no).'**'.$certificate_pre_cost_pri."**".$certificate_pre_cost;
					disconnect($con);die;
				}
			}
			//if( $common_oh_pri >0 && $common_oh <=0)
			if($common_oh_pri>0)
			{
				if( $common_oh_pri<$common_oh){
					echo "CoohApp**".str_replace("'","",$txt_job_no).'**'.$common_oh_pri."**".$common_oh;
					disconnect($con);die;
				}
			}
			//if( $depr_amor_pre_cost_pri >0 && $depr_amor_pre_cost <=0)
			if($depr_amor_pre_cost_pri>0)
			{
				if( $depr_amor_pre_cost_pri<$depr_amor_pre_cost){
					echo "DeprApp**".str_replace("'","",$txt_job_no).'**'.$depr_amor_pre_cost_pri."**".$depr_amor_pre_cost;
					disconnect($con);die;
				}
			}
			//if( $interest_cost_pri >0 && $interest_cost <=0)
			if($interest_cost_pri>0)
			{
				if( $interest_cost_pri<$interest_cost){
					echo "InterApp**".str_replace("'","",$txt_job_no).'**'.$interest_cost_pri."**".$interest_cost;
					disconnect($con);die;
				}
			}
			//if( $incometax_cost_pri >0 && $incometax_cost <=0)
			if($incometax_cost_pri>0)
			{
				if( $incometax_cost_pri<$incometax_cost){
					echo "IncomApp**".str_replace("'","",$txt_job_no).'**'.$incometax_cost_pri."**".$incometax_cost;
					disconnect($con);die;
				}
			}
		}


		$field_array="costing_date*incoterm*incoterm_place*machine_line*prod_line_hr*costing_per*copy_quatation*cm_cost_predefined_method_id*exchange_rate*sew_smv*cut_smv*sew_effi_percent*cut_effi_percent*efficiency_wastage_percent*sew_efficiency_source*remarks*ready_to_approved*budget_minute*updated_by*update_date*status_active*is_deleted";
		$data_array="".$txt_costing_date."*".$cbo_inco_term."*".$txt_incoterm_place."*".$txt_machine_line."*".$txt_prod_line_hr."*".$cbo_costing_per."*".$copy_quatation_id."*".$cm_cost_predefined_method_id."*".$txt_exchange_rate."*".$txt_sew_smv."*".$txt_cut_smv."*".$txt_sew_efficiency_per."*".$txt_cut_efficiency_per."*".$txt_efficiency_wastage."*".$txt_sew_efficiency_source."*".$txt_remarks."*".$cbo_ready_to_approved."*".$txt_budget_minute."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*'1'*'0'";
		$rID=sql_update("wo_pre_cost_mst",$field_array,$data_array,"job_no","".$txt_job_no."",1);
		//$rID3=execute_query( "update wo_po_details_master set set_smv=$txt_sew_smv  where  job_no =".$txt_job_no."",1);

		//echo "10**".$txt_job_no; die;

		if($db_type==0)
		{
			if($rID )
			{
				mysql_query("COMMIT");
				echo "1**".$rID."**".str_replace("'","",$txt_job_no);
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$rID."**".str_replace("'","",$txt_job_no);
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID )
			{
			
				//App Notification....................................
				if($_SESSION['app_notification'] == 1){
					//$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
					$notification = new Notifications();
					if($ready_to_approved == 1){
						$job_sql_res = sql_select("select p.ID,p.COSTING_DATE,a.JOB_NO,d.COMPANY_NAME,a.COMPANY_NAME as COMPANY_ID, a.BUYER_NAME as BUYER_ID,b.BUYER_NAME,a.BRAND_ID,c.BRAND_NAME from WO_PRE_COST_MST p,WO_PO_DETAILS_MASTER a
						left join lib_buyer b on a.buyer_name = b.id left join LIB_BUYER_BRAND c on a.brand_id = c.id left join LIB_COMPANY d on a.company_name = d.id where  a.id = p.job_id and A.id = $hidd_job_id");


						foreach($job_sql_res as $row){

							$desc = "Company: ".$row['COMPANY_NAME'].",\nJob. No: ".$row['JOB_NO'].", \nCosting. date: ".date('d/m/Y',strtotime($row['COSTING_DATE']));
							$noti_data_arr = array(
								'ID' => $row['ID'],
								'DATE' => date('d/m/Y',strtotime($row['COSTING_DATE'])),
								'DELIVERY_DATE' => date('d/m/Y',strtotime($row['COSTING_DATE'])),
								'COMPANY' => $row['COMPANY_NAME'],
								'BUYER' => $row['BUYER_NAME'],
								'SYS_NUMBER' => $row['JOB_NO'],
								'SYS_DEF' => '',
								'DESC' => $desc,
								'MENU_ID' => return_field_value("page_id as menu_id","ELECTRONIC_APPROVAL_SETUP","entry_form=77","menu_id")
							);

							$approval_parameter = array('BUYER_ID' => $row['BUYER_ID'],'BRAND_ID' => $row['BRAND_ID'],
							'approval_data' => $noti_data_arr,
							'approval_desc' => 'Company :'.$row['COMPANY_NAME'].', Job :'.$row['JOB_NO'].', Buyer :'.$row['BUYER_NAME'].', Brand :'.$row['BRAND_NAME'] );
							$COMPANY_NAME = $row['COMPANY_ID'];
							$pre_cost_id = $row['ID'];
						}
						$not_res = $notification->notificationEngine($pre_cost_id,$COMPANY_NAME,77,$approval_parameter);
					}
					else{
						$appr_data = array("USER_ID"=>'',"SEQUENCE_NO" =>'',"COMPANY_ID"=> '','NOTIFICATION_TYPE'=>0,'approval_desc'=>'','approval_data'=>'');
							$not_res=$notification->pushAll($pre_cost_id,77,$appr_data);
							if($not_res == 1)
							{
								$query="DELETE FROM APPROVAL_NOTIFICATION_ENGINE  WHERE ENTRY_FORM=77 AND REF_ID IN ($pre_cost_id) ";
								$not_delete=execute_query($query,1);
							} 
					}

				}
				//.................................................end;
				oci_commit($con);
				echo "1**".$rID."**".str_replace("'","",$txt_job_no);
			}
			else{
				oci_rollback($con);
				echo "10**".$rID."**".str_replace("'","",$txt_job_no);
			}
		}

		disconnect($con);
		die;
	}
	else if ($operation==2)   // Update Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		$approved=0;
		$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$txt_job_no");
		foreach($sql as $row){
			if($row[csf('approved')]==3){
				$approved=1;
			}else{
				$approved=$row[csf('approved')];
			}
		}
		if($approved==1){
			echo "approved**".str_replace("'","",$txt_job_no);
		disconnect($con);die;
		}
		
		$materialReciveNo="";
		$sql=sql_select("select a.recv_number from inv_receive_master a, inv_transaction b, wo_po_break_down c where a.id=b.mst_id and b.job_no=c.job_no_mst and b.job_no=$txt_job_no and a.entry_form=248 and c.is_confirmed=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by a.recv_number");
		foreach($sql as $row)
		{
			if($materialReciveNo=="") $materialReciveNo=$row[csf('recv_number')]; else $materialReciveNo.=','.$row[csf('recv_number')];
		}
		if($materialReciveNo!=""){
			echo "materialRecive**".$materialReciveNo;
			disconnect($con);die;
		}
		
		$field_array="updated_by*update_date*status_active*is_deleted";
		$data_array="".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*'0'*'1'";

		$rID=sql_delete("wo_pre_cost_mst",$field_array,$data_array,"job_no","".$txt_job_no."",1);

		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "2**".$rID."**".str_replace("'","",$txt_job_no);
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$rID."**".str_replace("'","",$txt_job_no);
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "2**".$rID."**".str_replace("'","",$txt_job_no);
			}
			else{
				oci_rollback($con);
				echo "10**".$rID."**".str_replace("'","",$txt_job_no);
			}
		}
		disconnect($con);
		die;
	}
	else if ($operation==3)   // Update Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
				//echo "1**select a.copy_quatation,b.quotation_id from wo_pre_cost_mst a, wo_po_details_master b where a.job_no=b.job_no and  a.job_no=$txt_job_no"; die;

		/*$approved=0;
		$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$txt_job_no");
		foreach($sql as $row){
			$approved=$row[csf('approved')];
		}
		if($approved==1){
			echo "approved**".str_replace("'","",$txt_job_no);
			die;
		}*/


		$field_array="approved*approved_by*approved_date";
		if(trim(str_replace("'","",$cbo_approved_status))==2)
		{
			$data_array="'1'*'".$_SESSION['logic_erp']['user_id']."'*'".$pc_date_time."'";
		}
		else
		{
			$data_array="'2'*'".$_SESSION['logic_erp']['user_id']."'*'".$pc_date_time."'";

		}
		$rID=sql_update("wo_pre_cost_mst",$field_array,$data_array,"job_no",$txt_job_no,1);
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "3**".$rID."**".str_replace("'","",$txt_job_no)."**".trim(str_replace("'","",$cbo_approved_status));
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$rID."**".str_replace("'","",$txt_job_no)."**".trim(str_replace("'","",$cbo_approved_status));
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "3**".$rID."**".str_replace("'","",$txt_job_no)."**".trim(str_replace("'","",$cbo_approved_status));
			}
			else{
				oci_rollback($con);
				echo "10**".$rID."**".str_replace("'","",$txt_job_no)."**".trim(str_replace("'","",$cbo_approved_status));
			}
		}
		disconnect($con);
		die;
	}
}

//*************************************************Master Form End ***********************************************
//*************************************************Dtls Form Start ***********************************************
if ($action=="save_update_delete_quotation_entry_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$sql=sql_select("select approval_need from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
	$app_nessity=2;
	foreach($sql as $row){
		$app_nessity=$row[csf('approval_need')];
	}
	 
		

	$sql=sql_select("select approved from wo_price_quotation  where id=$txt_quotation_id");
	$quatation_approved=2;
	foreach($sql as $row){
		$quatation_approved=$row[csf('approved')];
	}

	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	//echo "10**",$is_copy_quatation."**". $app_nessity."**".$quatation_approved;
	//die;
	if($is_copy_quatation==1 && $app_nessity==1){
		if($quatation_approved==2 || $quatation_approved==0 || $quatation_approved==3){
			echo "quataNotApp**".str_replace("'","",$txt_job_no);
			disconnect($con);die;
		}
	}
	//============ Negative Margin Allow In Budget ============================
	 $vari_nameArray=sql_select( "select STYLE_FROM_LIBRARY from  variable_order_tracking where company_name=$cbo_company_name and variable_list=86" );
	// echo "10**=select STYLE_FROM_LIBRARY from  variable_order_tracking where company_name='$cbo_company_name' and variable_list=86";die;
	 $negative_margin_vari=1;
	 foreach($vari_nameArray as $row){
		$negative_margin_vari=$row['STYLE_FROM_LIBRARY'];
	}
	$margin_dzn_pre_cost_chk=str_replace("'","",$txt_margin_dzn_pre_cost);
	
	if($operation==1 && count($vari_nameArray)>0)
	{
		
		if($negative_margin_vari==2 && $margin_dzn_pre_cost_chk<0){
			echo "negative**Negative margin not allow in budget";
			disconnect($con);die;
		}
	}
	
	$cm_for_shipment_sche = str_replace("'","", $txt_margin_dzn_pre_cost) +str_replace("'","", $txt_cm_pre_cost);
	$date= date('Y-m-d');
	if ($operation==0)  // Insert Here
	{
		$con = connect();
		if($db_type==0) mysql_query("BEGIN");
		
		 
	$sql_result=sql_select("select job_no  from wo_pre_cost_dtls  where   job_no=$update_id and is_deleted=0 and status_active=1");
		$tot_row=count($sql_result);
		if($tot_row>0)
		{
			$msg="Duplicate Entry found";
			echo "11**".$msg;
			disconnect($con);
			die;
		}

		$id=return_next_id( "id", "wo_pre_cost_dtls", 1 ) ;
		$field_array="id, job_id, job_no, costing_per_id, order_uom_id, fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent, wash_cost, 	wash_cost_percent, comm_cost, comm_cost_percent, commission, commission_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, freight, freight_percent, currier_pre_cost, currier_percent, certificate_pre_cost, certificate_percent, common_oh, common_oh_percent, depr_amor_pre_cost, depr_amor_po_price, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, cost_pcs_set, cost_pcs_set_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set, margin_pcs_set_percent, cm_for_sipment_sche, deffdlc_cost, deffdlc_percent, interest_cost, interest_percent, incometax_cost, incometax_percent, design_cost, design_percent, studio_cost, studio_percent, inserted_by, insert_date, status_active, is_deleted";

		$data_array="(".$id.", ".$hidd_job_id.", ".$update_id.", ".$cbo_costing_per.", ".$cbo_order_uom.", ".$txt_fabric_pre_cost.", ".$txt_fabric_po_price.", ".$txt_trim_pre_cost.", ".$txt_trim_po_price.", ".$txt_embel_pre_cost.", ".$txt_embel_po_price.", ".$txt_wash_pre_cost.", ".$txt_wash_po_price.", ".$txt_comml_pre_cost.", ".$txt_comml_po_price.", ".$txt_commission_pre_cost.", ".$txt_commission_po_price.", ".$txt_lab_test_pre_cost.", ".$txt_lab_test_po_price.", ".$txt_inspection_pre_cost.", ".$txt_inspection_po_price.", ".$txt_cm_pre_cost.", ".$txt_cm_po_price.", ".$txt_freight_pre_cost.", ".$txt_freight_po_price.", ".$txt_currier_pre_cost.", ".$txt_currier_po_price.", ".$txt_certificate_pre_cost.", ".$txt_certificate_po_price.", ".$txt_common_oh_pre_cost.", ".$txt_common_oh_po_price.", ".$txt_depr_amor_pre_cost.", ".$txt_depr_amor_po_price.", ".$txt_total_pre_cost.", ".$txt_total_po_price.", ".$txt_final_price_dzn_pre_cost.", ".$txt_final_price_dzn_po_price.", ".$txt_margin_dzn_pre_cost.", ".$txt_margin_dzn_po_price.", ".$txt_total_pre_cost_psc_set.", ".$txt_total_pre_cost_psc_set_po_price.", ".$txt_final_price_pcs_pre_cost.", ".$txt_final_price_pcs_po_price.", ".$txt_margin_pcs_pre_cost.", ".$txt_margin_pcs_po_price.", ".$cm_for_shipment_sche.", ".$txt_deffdlc_pre_cost.", ".$txt_deffdlc_po_price.", ".$txt_interest_pre_cost.", ".$txt_interest_po_price.", ".$txt_incometax_pre_cost.", ".$txt_incometax_po_price.", ".$txt_design_pre_cost.", ".$txt_design_po_price.", ".$txt_studio_pre_cost.", ".$txt_studio_po_price.", ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', 1,0)";
		$rID=sql_insert("wo_pre_cost_dtls",$field_array,$data_array,1,1);
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "0**".$rID."**".$id;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$rID."**".$id;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "0**".$rID."**".$id;
			}
			else{
				oci_rollback($con);
				echo "10**".$rID."**".$id;
			}
		}
		//update_cost_sheet($update_id);
		//echo "10**kk=".$dt; die;
		if($db_type==0) mysql_query("COMMIT"); else if($db_type==2) oci_commit($con);
		disconnect($con);
		die;
	}
	else if ($operation==1)   // Update Here
	{
		$con = connect();
		if($db_type==0) mysql_query("BEGIN");
		
		$materialReciveNo="";
		$sql=sql_select("select a.recv_number from inv_receive_master a, inv_transaction b, wo_po_break_down c where a.id=b.mst_id and b.job_no=c.job_no_mst and b.job_no=$update_id and a.entry_form=248 and c.is_confirmed=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by a.recv_number");
		foreach($sql as $row)
		{
			if($materialReciveNo=="") $materialReciveNo=$row[csf('recv_number')]; else $materialReciveNo.=','.$row[csf('recv_number')];
		}
		if($materialReciveNo!=""){
			echo "materialRecive**".$materialReciveNo;
			disconnect($con);die;
		}

		if(str_replace("'",'',$update_id_dtls)=="" && 1==2)
		{
			$id=return_next_id( "id", "wo_pre_cost_dtls", 1 ) ;
			$field_array="id, job_id, job_no, costing_per_id, order_uom_id, fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent, wash_cost, 	 wash_cost_percent, comm_cost, comm_cost_percent, commission, commission_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, freight, freight_percent, currier_pre_cost, currier_percent, certificate_pre_cost, certificate_percent, common_oh, common_oh_percent, depr_amor_pre_cost, depr_amor_po_price, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, cost_pcs_set, cost_pcs_set_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set, margin_pcs_set_percent, cm_for_sipment_sche, deffdlc_cost, deffdlc_percent, interest_cost, interest_percent, incometax_cost, incometax_percent,design_cost, design_percent, studio_cost, studio_percent, inserted_by, insert_date, status_active, is_deleted";
			$data_array="(".$id.", ".$hidd_job_id.", ".$update_id.", ".$cbo_costing_per.", ".$cbo_order_uom.", ".$txt_fabric_pre_cost.", ".$txt_fabric_po_price.", ".$txt_trim_pre_cost.", ".$txt_trim_po_price.", ".$txt_embel_pre_cost.", ".$txt_embel_po_price.", ".$txt_wash_pre_cost.", ".$txt_wash_po_price.", ".$txt_comml_pre_cost.", ".$txt_comml_po_price.", ".$txt_commission_pre_cost.", ".$txt_commission_po_price.", ".$txt_lab_test_pre_cost.", ".$txt_lab_test_po_price.", ".$txt_inspection_pre_cost.", ".$txt_inspection_po_price.", ".$txt_cm_pre_cost.", ".$txt_cm_po_price.", ".$txt_freight_pre_cost.", ".$txt_freight_po_price.", ".$txt_currier_pre_cost.", ".$txt_currier_po_price.", ".$txt_certificate_pre_cost.", ".$txt_certificate_po_price.", ".$txt_common_oh_pre_cost.", ".$txt_common_oh_po_price.", ".$txt_depr_amor_pre_cost.", ".$txt_depr_amor_po_price.", ".$txt_total_pre_cost.", ".$txt_total_po_price.", ".$txt_final_price_dzn_pre_cost.", ".$txt_final_price_dzn_po_price.", ".$txt_margin_dzn_pre_cost.", ".$txt_margin_dzn_po_price.", ".$txt_total_pre_cost_psc_set.", ".$txt_total_pre_cost_psc_set_po_price.", ".$txt_final_price_pcs_pre_cost.", ".$txt_final_price_pcs_po_price.", ".$txt_margin_pcs_pre_cost.", ".$txt_margin_pcs_po_price.", ".$cm_for_shipment_sche.", ".$txt_deffdlc_pre_cost.", ".$txt_deffdlc_po_price.", ".$txt_interest_pre_cost.", ".$txt_interest_po_price.", ".$txt_incometax_pre_cost.", ".$txt_incometax_po_price.", ".$txt_design_pre_cost.", ".$txt_design_po_price.", ".$txt_studio_pre_cost.", ".$txt_studio_po_price.", ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."', 1,0)";
			//$rID=sql_insert("wo_pre_cost_dtls",$field_array,$data_array,1);
		}
		if(str_replace("'",'',$update_id_dtls)!="")
		{
			$approved=0;
			$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$update_id");
			foreach($sql as $row){
				if($row[csf('approved')]==3){
					$approved=1;
				}else{
					$approved=$row[csf('approved')];
				}
			}
			if($approved==1){
				echo "approved**".str_replace("'","",$update_id);
				disconnect($con);die;
			}
			$field_array="costing_per_id*order_uom_id*fabric_cost*fabric_cost_percent*trims_cost*trims_cost_percent*embel_cost*embel_cost_percent*wash_cost* 	wash_cost_percent*comm_cost*comm_cost_percent*commission*commission_percent*lab_test*lab_test_percent*inspection*inspection_percent*cm_cost*cm_cost_percent*freight*freight_percent*currier_pre_cost*currier_percent*certificate_pre_cost*certificate_percent*common_oh*common_oh_percent*depr_amor_pre_cost*depr_amor_po_price*total_cost*total_cost_percent*price_dzn*price_dzn_percent*margin_dzn*margin_dzn_percent*cost_pcs_set*cost_pcs_set_percent*price_pcs_or_set*price_pcs_or_set_percent*margin_pcs_set*margin_pcs_set_percent*cm_for_sipment_sche*deffdlc_cost*deffdlc_percent*interest_cost*interest_percent*incometax_cost*incometax_percent*design_cost*design_percent*studio_cost*studio_percent*updated_by*update_date*status_active*is_deleted";
			$data_array="".$cbo_costing_per."*".$cbo_order_uom."*".$txt_fabric_pre_cost."*".$txt_fabric_po_price."*".$txt_trim_pre_cost."*".$txt_trim_po_price."*".$txt_embel_pre_cost."*".$txt_embel_po_price."*".$txt_wash_pre_cost."*".$txt_wash_po_price."*".$txt_comml_pre_cost."*".$txt_comml_po_price."*".$txt_commission_pre_cost."*".$txt_commission_po_price."*".$txt_lab_test_pre_cost."*".$txt_lab_test_po_price."*".$txt_inspection_pre_cost."*".$txt_inspection_po_price."*".$txt_cm_pre_cost."*".$txt_cm_po_price."*".$txt_freight_pre_cost."*".$txt_freight_po_price."*".$txt_currier_pre_cost."*".$txt_currier_po_price."*".$txt_certificate_pre_cost."*".$txt_certificate_po_price."*".$txt_common_oh_pre_cost."*".$txt_common_oh_po_price."*".$txt_depr_amor_pre_cost."*".$txt_depr_amor_po_price."*".$txt_total_pre_cost."*".$txt_total_po_price."*".$txt_final_price_dzn_pre_cost."*".$txt_final_price_dzn_po_price."*".$txt_margin_dzn_pre_cost."*".$txt_margin_dzn_po_price."*".$txt_total_pre_cost_psc_set."*".$txt_total_pre_cost_psc_set_po_price."*".$txt_final_price_pcs_pre_cost."*".$txt_final_price_pcs_po_price."*".$txt_margin_pcs_pre_cost."*".$txt_margin_pcs_po_price."*".$cm_for_shipment_sche."*".$txt_deffdlc_pre_cost."*".$txt_deffdlc_po_price."*".$txt_interest_pre_cost."*".$txt_interest_po_price."*".$txt_incometax_pre_cost."*".$txt_incometax_po_price."*".$txt_design_pre_cost."*".$txt_design_po_price."*".$txt_studio_pre_cost."*".$txt_studio_po_price."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*1*0";
			//echo "10**".$data_array;	die;
		    //$rID=sql_update("wo_pre_cost_dtls",$field_array,$data_array,"job_id","".$hidd_job_id."",1);
			$rID=sql_update("wo_pre_cost_dtls",$field_array,$data_array,"job_id*status_active*is_deleted","".$hidd_job_id."*1*0",1);
		}

		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "1**".$rID."**".str_replace("'","",$update_id_dtls);
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$rID."**".str_replace("'","",$update_id_dtls);
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "1**".$rID."**".str_replace("'","",$update_id_dtls);
			}
			else{
				oci_rollback($con);
				echo "10**".$rID."**".str_replace("'","",$update_id_dtls);
			}
		}
		//update_cost_sheet($update_id);
		//echo "10**kk=".$dt; die;
		if($db_type==0) mysql_query("COMMIT"); else if($db_type==2) oci_commit($con);
		disconnect($con);
		die;
	}
	else if ($operation==2)//Update Here============================================================================================================================
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		$field_array="updated_by*update_date*status_active*is_deleted";
		$data_array="".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*'0'*'1'";
		$rID=sql_delete("wo_pre_cost_dtls",$field_array,$data_array,"job_id","".$hidd_job_id."",1);
		if($db_type==0)
		{
			if($rID )
			{
				mysql_query("COMMIT");
				echo "2**".$rID."**".str_replace("'","",$update_id_dtls);
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "10**".$rID."**".str_replace("'","",$update_id_dtls);
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID )
			{
				oci_commit($con);
				echo "2**".$rID."**".str_replace("'","",$update_id_dtls);
			}
			else
			{
				oci_rollback($con);
				echo "10**".$rID."**".str_replace("'","",$update_id_dtls);
			}
		}
		//update_cost_sheet($update_id);
		//echo "10**kk=".$dt; die;
		if($db_type==0) mysql_query("COMMIT"); else if($db_type==2) oci_commit($con);
		disconnect($con);
		die;
	}
	else if ($operation==3)//Update Here============================================================================================================================
	{
			echo "1**".$rID."**".str_replace("'","",$update_id_dtls);
			disconnect($con);
			die;
	}
}
//*************************************************Dtls Form End ***********************************************
//*************************************************Fabric Cost, Yarn Cost, Coversion Cost Start ***********************************************
if($action=="check_booking")
{
	$booking_no="";
	$sql_data=sql_select("select booking_no from wo_booking_dtls where pre_cost_fabric_cost_dtls_id=$data and booking_type=1 and status_active=1 and is_deleted=0 group by  booking_no");
	foreach($sql_data as $row)
	{
		$booking_no=$row[csf("booking_no")];
	}
	echo $booking_no;
	exit();
}

if($action=="booking_no_with_approved_status")
{
	$data=explode("_",$data);
	//echo $data[0];
	//echo $data[1];
	if($data[1]=="")
	{
		$sql="select booking_no, is_approved from wo_booking_mst where job_no='$data[0]' and booking_type=1 and is_short=2 and is_deleted=0 and status_active=1";
	}
	else
	{
		$sql="select a.booking_no,a.is_approved from wo_booking_mst a, wo_booking_dtls b where a.job_no=b.job_no and  a.job_no='$data[0]' and a.booking_type=1 and a.is_short=2 and b.po_break_down_id=$data[1] and a.is_deleted=0 and a.status_active=1 group by a.booking_no,a.is_approved";
	}
	$approved_booking="";
	$un_approved_booking="";
	$sql_booking=sql_select($sql);
	foreach($sql_booking as $row)
	{
		if($row[csf('is_approved')]==1 || $row[csf('is_approved')]==3)
		{
		  $approved_booking.=$row[csf('booking_no')].", ";
		}
		else
		{
		  $un_approved_booking.=$row[csf('booking_no')].", ";
		}
	}
	echo rtrim($approved_booking ,", ")."_".rtrim($un_approved_booking , ", ");
	exit();
}

if ($action=="show_fabric_cost_listview")
{
	$data=explode("_",$data); $component_approved=0; $approved_message="";
	//print_r($data);
	$bom_of_yarn="";
	if(count($data)==7 && trim($data[6])=="bomofyarn")
	{
		//$bom_of_yarn="display:none;";
		$bomfyarn_data=sql_select("select bom_yarn_approval,id from  variable_order_tracking where company_name='$data[3]' and variable_list=82 order by id");
		if(count($bomfyarn_data)>0){
			$bomfyarn_btn=" <input type='button' id='bomfyarn_id' class='formbutton' style='width:80px' value='Approval' onClick='fn_bomfyarn(1);' />";
		}
	}
	
	$mandatory_sql=sql_select("select variable_list, embellishment_id, embellishment_budget_id, style_from_library, default_fabric_source, color_from_library, conversion_from_chart, consumption_basis from variable_order_tracking where status_active=1 and variable_list in (19,23,49,75,80,103) and company_name=$data[3]");
	$var_dia_width_type=2; $de_fab_source=1; $color_from_library=2; $conversion_from_chart=2; $fabricBudgetOn=2; $consumtion_basis_id=2; $qcconsfrom=2;
	foreach($mandatory_sql as $row){
		if($row[csf('variable_list')]==80) $var_dia_width_type=$row[csf('style_from_library')];
		if($row[csf('variable_list')]==49) $de_fab_source=$row[csf('default_fabric_source')];
		if($row[csf('variable_list')]==23) $color_from_library=$row[csf('color_from_library')];
		if($row[csf('variable_list')]==75 && $row[csf('embellishment_id')]==100) $fabricBudgetOn=$row[csf('embellishment_budget_id')];//
		if($row[csf('variable_list')]==19) $consumtion_basis_id=$row[csf('consumption_basis')];
		if($row[csf('variable_list')]==103) $qcconsfrom=$row[csf('consumption_basis')];
		//  Issue Id=11140 For Lariz As per Nasir
	}
	
	$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=1 and job_no='$data[0]'");
	foreach($sql as $row){
		if($row[csf('approved')]==1 || $row[csf('approved')]==3) { 
			$component_approved=1; $approved_message="<marquee width='500'><p style='color:#f00;'> Approved</p></marquee> ";
		}
	}
	
	if($data[5]==1) $div_display="display:none"; else $div_display="";
	?>
       <h3 align="left" class="accordion_h" onClick="show_hide_content('fabric_cost', '')"> +Yarn Consumption Details <? echo $approved_message; ?></h3>
       <div id="content_fabric_cost" style="display:none;">
    	<fieldset>
        	<form id="fabriccost_3" autocomplete="off">
            <input type="hidden" id="tr_ortder" name="tr_ortder" value="" width="500" />
            <table width="1430" cellspacing="0" class="rpt_table" border="0" id="tbl_fabric_cost" rules="all">
                <thead>
                    <tr>
                    	<th width="30">Seq</th>
                        <th width="80" style="color:#2A3FFF">Gmts Item</th>
                        <th width="80" style="color:#2A3FFF">Body Part</th>
                        <th width="60" style="color:#2A3FFF">Body Part Type</th>
                        <th width="80" style="color:#2A3FFF">Yarn Nature</th>
                        <th width="70" style="color:#2A3FFF">Color Type</th>
                        <th width="150" style="color:#2A3FFF">Yarn Description</th>
                        <th width="80" style="color:#2A3FFF">Source</th>
                        <th width="80">Nominated Supp</th>
                        <th width="60" id="" style="display:none">Width /Dia Type</th>
                        <th width="40" id="gsmweight_caption" style="display:none">GSM/ Weight</th>
                        <th width="100">Color & Size Sensitive</th>
                        <th width="75" id="gsmweight_caption">Color</th>
                        <th width="70">Consumption Basis</th>
                        <th width="50" style="color:#2A3FFF">Uom</th>
                        <th width="65">Avg. Grey Cons</th>
                        <th width="40">Rate</th>
                        <th width="60">Amount</th>
                        <th width="60">Total Qty</th>
                        <th width="70">Total Amount</th>
                        <th>&nbsp;</th>
                    </tr>
                </thead>
                <tbody>
                <?
				//echo $yarn_controller.'==';
                $supplier_library_fabric=return_library_array( "select a.supplier_name, a.id from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(1,9) and a.is_deleted=0 and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");

				$sql_fld_lvl_acss="select field_name, defalt_value, is_disable from field_level_access where user_id='".$_SESSION['logic_erp']['user_id']."' and company_id=$data[3] and page_id=521";
				$sql_fld_lvl_acss_data=sql_select($sql_fld_lvl_acss);
				$fld_lvl_acss_arr=array();
				foreach($sql_fld_lvl_acss_data as $fld_lvl_acss_row)
				{
					$fld_lvl_acss_arr[$fld_lvl_acss_row[csf("field_name")]]['defalt_value']=$fld_lvl_acss_row[csf("defalt_value")];
					$fld_lvl_acss_arr[$fld_lvl_acss_row[csf("field_name")]]['is_disable']=$fld_lvl_acss_row[csf("is_disable")];
				}
				unset($sql_fld_lvl_acss_data);
				
				$sql_wo=sql_select("select company_name, gmts_item_id from wo_po_details_master where job_no='$data[0]'");
				$company_name=$sql_wo[0][csf('company_name')];
				$gmts_item_id=$sql_wo[0][csf('gmts_item_id')];
				
				$arr_bo_app=array();

				$save_update=1;
				$approved=return_field_value("approved", "wo_pre_cost_mst", "job_no='$data[0]'");
				if($approved==3) $approved=1;
				
				$body_part_type_arr=return_library_array("select id, body_part_type from lib_body_part","id","body_part_type");

				$data_array=sql_select("select id, seq, job_no, nominated_supp, item_number_id, body_part_id, fab_nature_id, color_type_id, lib_yarn_count_deter_id as lib_yarn_count_deter_id, construction, composition, fabric_description, gsm_weight, color_size_sensitive, color, consumption_basis, avg_cons, fabric_source, rate, amount, avg_finish_cons, avg_process_loss, status_active, cons_breack_down, msmnt_break_down, color_break_down, yarn_breack_down, process_loss_method, marker_break_down, width_dia_type, avg_cons_yarn, gsm_weight_yarn, plan_cut_qty, job_plan_cut_qty, is_apply_last_update, uom, body_part_type, budget_on, quotdtlsid from wo_pre_cost_fabric_cost_dtls where job_no='$data[0]' and is_deleted=0 and status_active=1 order by seq asc");
				$is_booking_arr=array();
				if (count($data_array)>0)
				{
					//echo "select a.is_approved, a.entry_form, b.is_short, b.pre_cost_fabric_cost_dtls_id from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and b.job_no ='$data[0]' and b.booking_type='1' and a.is_deleted=0 and a.status_active=1 and b.status_active=1 and b.is_deleted=0 group by a.is_approved, a.entry_form, b.is_short, b.pre_cost_fabric_cost_dtls_id";
					$data_arr=sql_select("select a.is_approved, a.entry_form, b.is_short, b.pre_cost_fabric_cost_dtls_id from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and b.job_no ='$data[0]' and b.booking_type='1' and a.is_deleted=0 and a.status_active=1 and b.status_active=1 and b.is_deleted=0 group by a.is_approved, a.entry_form, b.is_short, b.pre_cost_fabric_cost_dtls_id");
					foreach ($data_arr as $row)
					{
						$is_booking_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]]=$row[csf('pre_cost_fabric_cost_dtls_id')];
					}
					//print_r($is_booking_arr);
					unset($data_arr);
				}

				if (count($data_array)<1 && $data[2]==1 && $data[6]==2 )//Price Quotation 
				{
					$data_array=sql_select("select id as quotdtlsid, quotation_id, nominated_supp, item_number_id, body_part_id, fab_nature_id, color_type_id, lib_yarn_count_deter_id as lib_yarn_count_deter_id, construction, composition, fabric_description, gsm_weight, fab_cons_in_quotat_varia, avg_cons, fabric_source, rate, amount, avg_finish_cons, avg_process_loss, yarn_breack_down, width_dia_type, status_active, '' as body_part_type from wo_pri_quo_fabric_cost_dtls where quotation_id='$data[1]' and is_deleted=0 and status_active=1 order by id asc");
					$save_update=0;
				}
				
				if (count($data_array) < 1 && $data[2]==1 && $data[6]==7)//Quick Costing
				{
					$sql_qc="select id as quotdtlsid, mst_id as quotation_id, 0 as nominated_supp, item_id as item_number_id, body_part_id, 100 as fab_nature_id, color_type_id as color_type_id, fab_id as lib_yarn_count_deter_id, '' as construction, '' as composition, description as fabric_description, fabwidth as gsm_weight, 0 as fab_cons_in_quotat_varia, 0 as avg_cons, $de_fab_source as fabric_source, 0 as rate, 0 as amount, 0 as avg_finish_cons, 0 as avg_process_loss, yarn_break_down as yarn_breack_down, 0 as width_dia_type, status_active, 12 as uom, 1 as color_size_sensitive, $consumtion_basis_id as consumption_basis, '' as body_part_type, 0 as gsm_weight_type, 0 as plan_cut_qty, 0 as job_plan_cut_qty from qc_cons_rate_dtls where mst_id='$data[1]' and type=1 and tot_cons>0 and status_active=1 and is_deleted=0 order by id";// Query Invalid by kausar
					//echo $sql_qc;
					$data_array=sql_select($sql_qc);
					//echo count($data_array);
					$fabeicID="";
					foreach( $data_array as $frow)
					{
						if($fabeicID=="") $fabeicID=$frow[csf('lib_yarn_count_deter_id')]; else $fabeicID.=','.$frow[csf('lib_yarn_count_deter_id')];
					}
					$composition_arr=array(); $yarn_description=array();
					if($fabeicID!="")
					{
						$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count");
						
						$sql="select a.fab_nature_id, a.construction, a.type, a.design, a.gsm_weight, a.weight_type, a.color_range_id, a.stich_length, a.process_loss, b.copmposition_id, b.percent, b.count_id, b.type_id, a.id, b.id as bid from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.is_deleted=0 and a.id in ($fabeicID) order by a.id,b.id";
						//echo $sql;
						$sqlRes=sql_select($sql); $fabricDataArr=array();
						if (count($sqlRes)>0)
						{
							foreach( $sqlRes as $row )
							{
								if($row[csf('count_id')]=="") $row[csf('count_id')]=0;
								if($row[csf('copmposition_id')]=="") $row[csf('copmposition_id')]=0;
								if($row[csf('type_id')]=="") $row[csf('type_id')]=0;
								if($row[csf('percent')]=="") $row[csf('percent')]=100;
								
								$compo_per="";
								if(($row[csf('percent')]*1)>0) $compo_per=$row[csf('percent')]."% "; else $compo_per="";
								if(array_key_exists($row[csf('id')],$composition_arr))
								{
									$composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('copmposition_id')]]." ".$compo_per.$lib_yarn_count[$row[csf('count_id')]]." ".$yarn_type[$row[csf('type_id')]].",";
								}
								else
								{
									$composition_arr[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$compo_per.$lib_yarn_count[$row[csf('count_id')]]." ".$yarn_type[$row[csf('type_id')]].",";
								}
								
								if($yarn_description[$row[csf('id')]]!="")
								{
									$yarn_description[$row[csf('id')]]=$yarn_description."__".$row[csf('count_id')]."_".$row[csf('copmposition_id')]."_100_".$row[csf('type_id')]."_".$row[csf('percent')];
								}
								else
								{
									$yarn_description[$row[csf('id')]]=$row[csf('count_id')]."_".$row[csf('copmposition_id')]."_100_".$row[csf('type_id')]."_".$row[csf('percent')];
								}
								
								$fabricDataArr[$row[csf('id')]]['construction']=$row[csf('construction')];
								$fabricDataArr[$row[csf('id')]]['fab_nature_id']=$row[csf('fab_nature_id')];
								$fabricDataArr[$row[csf('id')]]['gsm_weight']=$row[csf('gsm_weight')];
								$fabricDataArr[$row[csf('id')]]['process_loss']=$row[csf('process_loss')];
								$fabricDataArr[$row[csf('id')]]['weight_type']=$row[csf('weight_type')];
								$fabricDataArr[$row[csf('id')]]['type']=$row[csf('type')];
								$fabricDataArr[$row[csf('id')]]['design']=$row[csf('design')];
								
								if(array_key_exists($row[csf('id')],$fab_description))
								{
									$fab_description[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
								}
								else
								{
									$fab_description[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
								}
							}
							unset($sqlRes);
						}
					}
					$save_update=0;
				}
				//echo count($data_array);
				if (count($data_array)>0)
				{
					$i=0;
					foreach( $data_array as $row )
					{
						$i++;
						$seq='';
                    	if($row[csf("seq")]=="" || $row[csf("seq")]==0) $seq=$i; else $seq=$row[csf("seq")];
						if($row[csf("id")]!="") $fab_id_wise_item[$row[csf("id")]]['seq']=$seq;
						else $fab_id_wise_item[$row[csf("quotdtlsid")]]['seq']=$seq;
						$cons_breack_down=$msmnt_break_down="";
						if($row[csf('cons_breack_down')] !="") $cons_breack_down=$row[csf('cons_breack_down')]->load();
						if($row[csf('msmnt_break_down')] !="") $msmnt_break_down=$row[csf('msmnt_break_down')]->load();
						//$disabled=0; $btn_disabled=0;
						//if($approved==1 || $arr_bo_app[$row[csf('id')]]==1) $disabled=1; else $disabled=0;
						
						$dis=0; $txt_dis="";
						if($approved!=1)
						{
							$disabled=0; $btn_disabled=0; 
							if($is_booking_arr[$row[csf('id')]]!="") 
							{ 
								$disabled=1;  $btn_disabled=1; $txt_dis="disabled"; 
							}
						}
						else if( $component_approved!=1)
						{
							$disabled=0; $btn_disabled=0; 
							if($is_booking_arr[$row[csf('id')]]!="") { 
								$disabled=1; $btn_disabled=1; $txt_dis="disabled"; 
							}
						}

						if($approved==1 || $component_approved==1)
						{
							$disabled=1; $btn_disabled=1; $txt_disabled="disabled";
						}
						
						//echo $disabled;

						$uom=12;
						if($row[csf("fab_nature_id")]==3)
						{
							if($save_update==0)
							{
								if($row[csf('uom')]==0) $uom=27; else $uom=$row[csf('uom')];
							}
							else
							{
								if($row[csf('uom')]==0) $uom=27; else $uom=$row[csf('uom')];
							}
						}
						else
						{
							if($save_update==0)
							{
								if($row[csf('uom')]==0) $uom=12; else $uom=$row[csf('uom')];
							}
							else
							{
								if($row[csf('uom')]==0) $uom=12; else $uom=$row[csf('uom')];
							}
						}
						
						if($row[csf('yarn_breack_down')]=="") $row[csf('yarn_breack_down')]=$yarn_description[$row[csf("lib_yarn_count_deter_id")]];
						$row[csf('yarn_breack_down')]=str_replace("##","__",rtrim($row[csf('yarn_breack_down')] ,","));
						$row[csf('yarn_breack_down')]=str_replace(",","_",rtrim($row[csf('yarn_breack_down')] ,","));
						if($row[csf("body_part_type")]=="") $row[csf("body_part_type")]=$body_part_type_arr[$row[csf("body_part_id")]];
						
						$row[csf("construction")]=$fabricDataArr[$row[csf("lib_yarn_count_deter_id")]]['construction'];
						$row[csf("composition")]=$composition_arr[$row[csf("lib_yarn_count_deter_id")]];
						if($row[csf("budget_on")]=="" || $row[csf("budget_on")]==0) $budget_on=$fabricBudgetOn;
						?>
							<tr id="fabriccosttbltr_<?=$i; ?>" align="center">
                            	<td><input type="text" id="seq_<?=$i; ?>" name="seq_<?=$i; ?>" class="text_boxes_numeric" style="width:18px" value="<?=$seq; ?>" /></td>
                                <td><?=create_drop_down( "cbogmtsitem_".$i, 80, $garments_item,"", 1, "--Select Item--", $row[csf("item_number_id")], "",$disabled,$gmts_item_id ); ?></td>
                                <td>
                                    <input type="text" id="txtbodyparttext_<?=$i; ?>" name="txtbodyparttext_<?=$i; ?>" class="text_boxes" style="width:70px" onDblClick="open_body_part_popup(<?=$i; ?>);" value="<?=$body_part[$row[csf("body_part_id")]]; ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?>  title="<? echo $row[csf("body_part_id")]; ?>" readonly/>
                                    <input type="hidden" id="txtbodypart_<?=$i; ?>" name="txtbodypart_<? echo $i; ?>" class="text_boxes" style="width:70px" value="<? echo $row[csf("body_part_id")]; ?>" readonly/>
                                </td>
                                <td><?=create_drop_down( "txtbodyparttype_".$i, 60, $body_part_type, "", 1, "-Display-", $row[csf("body_part_type")], "",1,"" );  ?></td>
                                <td><?=create_drop_down( "cbofabricnature_".$i, 80, $item_category,"", 0, "", $row[csf("fab_nature_id")], "change_caption( this.value, 'gsmweight_caption');",$disabled,"2,3,100" ); ?> </td>
                                <td><?=create_drop_down( "cbocolortype_".$i, 70, $color_type,"", 1, "-- Select --", $row[csf("color_type_id")], "",$disabled,"" ); ?></td>
                                <td>
                                	<input type="hidden" id="libyarncountdeterminationid_<?=$i; ?>" name="libyarncountdeterminationid_<?=$i; ?>" class="text_boxes" style="width:10px" value="<?=$row[csf("lib_yarn_count_deter_id")];  ?>" readonly />
                                    <input type="hidden" id="oldlibyarncountdeterminationid_<?=$i; ?>" name="oldlibyarncountdeterminationid_<?=$i; ?>" class="text_boxes" style="width:10px" value="<?=$row[csf("lib_yarn_count_deter_id")]; ?>" readonly />
                                    <input type="hidden" id="construction_<?=$i; ?>" name="construction_<?=$i; ?>" class="text_boxes" style="width:10px" value="<?=$row[csf("construction")]; ?>" readonly/>
                                    <input type="hidden" id="composition_<?=$i; ?>" name="composition_<?=$i; ?>" class="text_boxes" style="width:10px" value="<?=$row[csf("composition")]; ?>" readonly  />

                                    <input type="text" id="fabricdescription_<?=$i; ?>" name="fabricdescription_<?=$i; ?>" class="text_boxes" style="width:140px" onDblClick="open_fabric_decription_popup(<?=$i; ?>);" value="<?=$row[csf("fabric_description")]; ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> title="<?=$row[csf("fabric_description")]; ?>" readonly/>
                                </td>
                                <td><? asort($fabric_source); echo create_drop_down( "cbofabricsource_".$i, 80, $fabric_source, "", 0, "", $row[csf("fabric_source")], "enable_disable( this.value,'txtrate_*txtamount_', $i );",$disabled,"1,2,3" ); ?></td>
                                <td><? asort($supplier_library_fabric); echo create_drop_down( "cbonominasupplier_".$i,80, $supplier_library_fabric, "", 1, '-Select-', $row[csf("nominated_supp")],"",$disabled,"" );?></td>
                                <td style="display:none"> <? asort($fabric_typee); echo create_drop_down( "cbowidthdiatype_".$i, 60, $fabric_typee,"", 1, "-- Select --", $row[csf("width_dia_type")], "",$disabled,"" ); ?></td>
                                <td style="display:none"><input type="text" id="txtgsmweight_<?=$i; ?>" name="txtgsmweight_<?=$i; ?>" class="text_boxes_numeric" style="width:30px" onBlur="sum_yarn_required();" value="<?=$row[csf("gsm_weight")]; ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> avglvalue="<?=$row[csf("gsm_weight_yarn")]; ?>" title="<?  echo $row[csf("gsm_weight_yarn")]; ?>"/>
                                    <input type="hidden" id="avgtxtgsmweight_<? echo $i; ?>" name="avgtxtgsmweight_<? echo $i; ?>" class="text_boxes_numeric" style="width:30px"  value="<? echo $row[csf("gsm_weight_yarn")]; ?>"  readonly />
                                </td>
                                <td><?=create_drop_down( "cbocolorsizesensitive_".$i, 100, $size_color_sensitive,"", 1, "--Select--", $row[csf("color_size_sensitive")], "control_color_field($i)",$disabled,"" ); ?></td>
                                <td><input type="text" id="txtcolor_<?=$i; ?>" name="txtcolor_<?=$i; ?>" class="text_boxes" style="width:65px" onClick="open_color_popup(<?=$i; ?>);" value="<?=$color_library[$row[csf("color")]]; ?>" <? if($row[csf("color_size_sensitive")] ==3){echo "";}else{echo "disabled";}?> /></td>
                                <td><?=create_drop_down( "consumptionbasis_".$i, 70, $consumtion_basis,'', 0, '', $row[csf('consumption_basis')], "",$disabled,"" ); ?></td>
                                <td><?=create_drop_down( "uom_".$i, 50, $unit_of_measurement,'', 1, '-select-', $uom, "",$disabled,"1,12,23,27,15" ); ?></td>
                                <td>
                                	<input type="text" id="txtconsumption_<?=$i; ?>" name="txtconsumption_<?=$i; ?>" onBlur="math_operation( 'txtamount_<?=$i; ?>', 'txtconsumption_<?=$i; ?>*txtrate_<?=$i; ?>', '*','',{dec_type:1,comma:0, currency:document.getElementById('cbo_currercy').value} ); sum_yarn_required(); set_sum_value( 'txtamount_sum', 'txtamount_','tbl_fabric_cost');" onDblClick="set_session_large_post_data('requires/pre_cost_entry_controller_v2.php?action=consumption_popup', 'Consumption Entry Form','txtbodypart_<?=$i; ?>', 'cbofabricnature_<?=$i; ?>', 'txtgsmweight_<?=$i; ?>','<?=$i; ?>','updateid_<?=$i; ?>');" class="text_boxes_numeric" style="width:55px" value="<?=$row[csf("avg_cons")]; ?>" avglvalue="<?=$row[csf("avg_cons_yarn")]; ?>" title="<?=$row[csf("avg_cons_yarn")]; ?>" readonly/>
                                    <input type="hidden" id="avgtxtconsumption_<?=$i; ?>" name="avgtxtconsumption_<?=$i; ?>" class="text_boxes_numeric" style="width:50px" value="<?=$row[csf("avg_cons_yarn")]; ?>" readonly/>
                                </td>
                                <td><input type="text" id="txtrate_<?=$i; ?>" name="txtrate_<?=$i; ?>" onBlur="math_operation('txtamount_<?=$i; ?>', 'txtconsumption_<?=$i; ?>*txtrate_<?=$i; ?>', '*','',{dec_type:1,comma:0,currency:document.getElementById('cbo_currercy').value} );set_sum_value( 'txtamount_sum', 'txtamount_','tbl_fabric_cost');" class="text_boxes_numeric" style="width:30px" value="<?=$row[csf("rate")]; ?>" <? if($row[csf("fabric_source")]==2){echo "";}else{echo "disabled";}?> readonly/>
                                </td>
                                <td><input type="text" id="txtamount_<?=$i; ?>" onBlur="set_sum_value( 'txtamount_sum', 'txtamount_','tbl_fabric_cost');" name="txtamount_<?=$i; ?>" class="text_boxes_numeric" style="width:50px" value="<?=$row[csf("amount")]; ?>" <? if($row[csf("fabric_source")]==2 && $disabled==0){echo "";}else{echo "disabled";}?> readonly /></td>
                                <td><input type="text" id="totalqty_<?=$i; ?>" name="totalqty_<?=$i; ?>" class="text_boxes_numeric" style="width:50px" value="" placeholder="Click to Load" onClick="loadTotal(<?=$i; ?>,'fabric');" readonly /></td>
                                <td>
                                	<input type="text" id="totalamount_<?=$i; ?>" name="totalamount_<?=$i; ?>" class="text_boxes_numeric" style="width:60px" readonly />
                                    <input type="hidden" id="budgeton_<?=$i; ?>" name="budgeton_<?=$i; ?>" class="text_boxes" style="width:20px" value="<?=$budget_on; ?>" />
                                </td>
                                <td>
                                    <input type="hidden" id="cbostatus_<?=$i; ?>" style="width:90px" value="<?=$row[csf("status_active")]; ?>" readonly />
                                    <input type="button" id="increase_<?=$i; ?>" style="width:25px" class="formbutton" value="+" onClick="add_break_down_tr(<?=$i; ?>);" <? if($approved==1 || $component_approved==1) {echo "disabled";} else {echo "";}?> />
                                    <input type="button" id="decrease_<?=$i; ?>" style="width:25px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<?=$i; ?>,'tbl_fabric_cost');"  <? if($disabled==0){echo "";}else{echo "disabled";} ?> />
                                    <input type="hidden" id="txtfinishconsumption_<?=$i; ?>" style="width:60px" value="<?=$row[csf("avg_finish_cons")]; ?>" readonly/>
                                    <input type="hidden" id="txtavgprocessloss_<?=$i; ?>" style="width:60px" value="<?=$row[csf("avg_process_loss")]; ?>" readonly/>
                                    <input type="hidden" id="consbreckdown_<?=$i; ?>" style="width:90px" value="<?=$cons_breack_down; ?>" readonly />
                                    <input type="hidden" id="msmntbreackdown_<?=$i; ?>" style="width:90px" value="<?=$msmnt_break_down; ?>" readonly/>
                                    <input type="hidden" id="markerbreackdown_<?=$i; ?>" style="width:90px" value="<?=$row[csf("marker_break_down")]; ?>" readonly/>
                                    <input type="hidden" id="colorbreackdown_<?=$i; ?>" style="width:90px" value="<?=$row[csf("color_break_down")]; ?>" readonly/>
                                    <input type="hidden" id="yarnbreackdown_<?=$i; ?>" style="width:90px" value="<?=$row[csf("yarn_breack_down")]; ?>" readonly/>
                                    <input type="hidden" id="processlossmethod_<?=$i; ?>" value="<?=$row[csf("process_loss_method")]; ?>" readonly/>
                                    <input type="hidden" id="updateid_<?=$i; ?>" style="width:20px" value="<?=$row[csf("id")]; ?>" readonly/>
                                    <!-- Price quatation fabric cost Id-->
                                    <input type="hidden" id="prifabcostdtlsid_<?=$i; ?>" style="width:20px" value="<?=$row[csf("quotdtlsid")]; ?>" readonly/>
                                    <input type="hidden" id="isclickedconsinput_<?=$i; ?>" style="width:20px" value="<?=$row[csf("is_apply_last_update")]; ?>" readonly/>
                                    <input type="hidden" id="plancutqty_<?=$i; ?>" style="width:20px" value="<?=$row[csf("plan_cut_qty")]; ?>" readonly/>
                                    <input type="hidden" id="jobplancutqty_<?=$i; ?>" style="width:20px" value="<?=$row[csf("job_plan_cut_qty")];?>" readonly/>
                                    <input type="hidden" id="precostapproved_<?=$i; ?>" style="width:20px" value="<?=$approved; ?>" readonly/>
                                    <input type="hidden" id="isconspopupupdate_<?=$i; ?>" style="width:20px" value="0" readonly/>
                                <!-- Price quatation fabric cost Id end-->
                                </td>
                            </tr>
						<?
						}
					}
					else
					{
						$selected_item=0;
						$gmts_item_id_arr=explode(",",$gmts_item_id);
						if(count($gmts_item_id_arr)==1)
						{
							$selected_item=	$gmts_item_id;
						}
						$uom_fld_accs=$fld_lvl_acss_arr['cbo_fabric_costing_uom']['defalt_value'];
						$fab_nature_fld_accs=$fld_lvl_acss_arr['cbo_fabric_costing_fab_nature']['defalt_value'];
						?>
						<tr id="fabriccosttbltr_1" align="center">
                        	<td><input type="text" id="seq_1" name="seq_1" class="text_boxes_numeric" style="width:18px" value="1" /></td>
                            <td><?=create_drop_down( "cbogmtsitem_1", 80, $garments_item,"", 1, "-- Select Item --", $selected_item, "" ,"",$gmts_item_id); ?></td>
                            <td><input type="text" id="txtbodyparttext_1" name="txtbodyparttext_1" class="text_boxes" style="width:70px" onDblClick="open_body_part_popup(1)" value="<? echo $body_part[$row[csf("body_part_id")]]; ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> title="<? echo $row[csf("body_part_id")]; ?>" placeholder="DblClick" readonly/>

                            	<input type="hidden" id="txtbodypart_1" name="txtbodypart_1" class="text_boxes" style="width:70px" value="<? echo $row[csf("body_part_id")]; ?>" title="<? echo $row[csf("body_part_id")]; ?>" readonly/>
                            </td>
                            <td><? echo create_drop_down( "txtbodyparttype_1", 60, $body_part_type, "", 1, "-Display-", "", "",1,"" );  ?></td>
                            <td><? echo create_drop_down( "cbofabricnature_1", 80, $item_category,"", 0, "", 100, "change_caption( this.value, 'gsmweight_caption');","","2,3,100" ); ?></td>
                            <td><? echo create_drop_down( "cbocolortype_1", 70, $color_type,"", 1, "-- Select --", $selected, "","","" ); ?></td>
                            <td>
                                <input type="hidden" id="libyarncountdeterminationid_1" name="libyarncountdeterminationid_1" class="text_boxes" style="width:10px"  />
                                <input type="hidden" id="oldlibyarncountdeterminationid_1" name="oldlibyarncountdeterminationid_1" class="text_boxes" style="width:10px"  />
                                <input type="hidden" id="construction_1" name="construction_1" class="text_boxes" style="width:10px"  />
                                <input type="hidden" id="composition_1" name="composition_1" class="text_boxes" style="width:10px"  />
                                <input type="text" id="fabricdescription_1" placeholder="Double Click To Search"  name="fabricdescription_1"  class="text_boxes" style="width:140px" onDblClick="open_fabric_decription_popup(1);" readonly />
                            </td>
                            <td><? echo create_drop_down( "cbofabricsource_1", 80, $fabric_source, "", 0, "", $de_fab_source, "enable_disable( this.value,'txtrate_*txtamount_', 1 );","","1,2,3" );  ?></td>
                            <td><? asort($supplier_library_fabric); echo create_drop_down( "cbonominasupplier_1",80, $supplier_library_fabric, "", 1, '-Select-', $row[csf("nominated_supp")],"",$disabled,"" );?>
                                </td>
                            <td style="display:none"><?  echo create_drop_down( "cbowidthdiatype_1", 60, $fabric_typee,"", 1, "-- Select --", $selected, "","","" ); ?></td>
                            <td style="display:none">
                                <input type="text" id="txtgsmweight_1" name="txtgsmweight_1" class="text_boxes_numeric" style="width:30px" onBlur="sum_yarn_required()" value="1">
                                <input type="hidden" id="avgtxtgsmweight_1" name="avgtxtgsmweight_1" class="text_boxes_numeric" style="width:30px" onBlur="sum_yarn_required()">
                            </td>
                            <td><?  echo create_drop_down( "cbocolorsizesensitive_1", 100, $size_color_sensitive,"", 1, "-- Select --", 1, "control_color_field(1)","","" ); ?> </td>
                            <td><input type="text" id="txtcolor_1" name="txtcolor_1" class="text_boxes" style="width:65px"  onClick="open_color_popup(1)" value="<? //echo $row[csf("gsm_weight")];  ?>" /></td>
                            <td><? echo create_drop_down( "consumptionbasis_1", 70, $consumtion_basis,'', 2, '', $consumtion_basis_id, "","","" ); ?></td>
                            <td><? echo create_drop_down( "uom_1", 50, $unit_of_measurement,'', 1, '-Select-','12', "",'',"1,12,23,27,15" ); ?></td>
                            <td>
                                <input type="text" id="txtconsumption_1" name="txtconsumption_1" onBlur="math_operation( 'txtamount_1', 'txtconsumption_1*txtrate_1', '*','',{dec_type:1,comma:0,currency:document.getElementById('cbo_currercy').value} );sum_yarn_required();set_sum_value( 'txtamount_sum', 'txtamount_','tbl_fabric_cost' )"  onDblClick="set_session_large_post_data('requires/pre_cost_entry_controller_v2.php?action=consumption_popup', 'Consumption Entry Form','txtbodypart_1','cbofabricnature_1','txtgsmweight_1','1','updateid_1')"    class="text_boxes_numeric" style="width:55px" readonly  />
                                <input type="hidden" id="avgtxtconsumption_1" name="avgtxtconsumption_1" class="text_boxes_numeric" style="width:50px"  readonly/>
                            </td>
                            <td><input type="text" id="txtrate_1" onBlur="math_operation( 'txtamount_1', 'txtconsumption_1*txtrate_1', '*','',{dec_type:1,comma:0, currency:document.getElementById('cbo_currercy').value});set_sum_value( 'txtamount_sum', 'txtamount_' ,'tbl_fabric_cost') "  name="txtrate_1" class="text_boxes_numeric" style="width:30px" readonly> </td>
                            <td><input type="text" id="txtamount_1"  onBlur="set_sum_value( 'txtamount_sum', 'txtamount_','tbl_fabric_cost') " readonly  name="txtamount_1" class="text_boxes_numeric" style="width:50px"></td>
                            <td><input type="text" id="totalqty_1"  name="totalqty_1" class="text_boxes_numeric" style="width:50px" value="" placeholder="Click to Load" onClick="loadTotal(1,'fabric');" readonly /></td>
                            <td>
                            	<input type="text" id="totalamount_1"  name="totalamount_1" class="text_boxes_numeric" style="width:60px" value=""  readonly  />
                                <input type="hidden" id="budgeton_1" name="budgeton_1" value="<?=$fabricBudgetOn; ?>"  />
                            </td>
                            <td>
                                <input type="hidden" id="cbostatus_1" name="cbostatus_1"   class="text_boxes" style="width:90px" value="1" readonly />
                                <input type="button" id="increase_1" style="width:25px" class="formbutton" value="+" onClick="add_break_down_tr(1)" />
                                <input type="button" id="decrease_1" style="width:25px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(1,'tbl_fabric_cost');" />
                                <input type="hidden" id="txtfinishconsumption_1"  name="txtfinishconsumption_1" class="text_boxes_numeric" style="width:60px" readonly/>
                                <input type="hidden" id="txtavgprocessloss_1"  name="txtavgprocessloss_1" class="text_boxes_numeric" style="width:60px"  readonly/>
                                <input type="hidden" id="consbreckdown_1" name="consbreckdown_1" value=""  class="text_boxes" style="width:90px" />
                                <input type="hidden" id="msmntbreackdown_1" name="msmntbreackdown_1" value="" class="text_boxes" style="width:90px" />
                                <input type="hidden" id="markerbreackdown_1" name="markerbreackdown_1" value="" class="text_boxes" style="width:90px" />
                                <input type="hidden" id="colorbreackdown_1" name="colorbreackdown_1" value="" class="text_boxes" style="width:90px" />
                                <input type="hidden" id="yarnbreackdown_1" name="yarnbreackdown_1" value="" class="text_boxes" style="width:90px" />
                                <input type="hidden" id="processlossmethod_1" name="processlossmethod_1"/>
                                <input type="hidden" id="updateid_1" name="updateid_1" value="" class="text_boxes" style="width:20px" />
                                <input type="hidden" id="prifabcostdtlsid_1" name="prifabcostdtlsid_1"  class="text_boxes" style="width:20px"  />
                                <input type="hidden" id="isclickedconsinput_1" name="isclickedconsinput_1"  class="text_boxes" style="width:20px" value="1"  />
                                <input type="hidden" id="plancutqty_1" name="plancutqty_1"  class="text_boxes" style="width:20px"/>
                                <input type="hidden" id="jobplancutqty_1" name="jobplancutqty_1"  class="text_boxes" style="width:20px"/>
                                <input type="hidden" id="precostapproved_1" name="precostapproved_1"  class="text_boxes" style="width:20px" value="0" readonly/>
                                <input type="hidden" id="isconspopupupdate_1" name="isconspopupupdate_1"  class="text_boxes" style="width:20px" value="0" readonly/>
                            </td>
						</tr>
					<? } ?>
                </tbody>
            </table>
            <br/>

            <table width="1430" cellspacing="0" class="rpt_table" border="0" rules="all" style="display:none">
                <tfoot>
                <?
				$yarn_needed=0;
				$data_array1=sql_select("select fab_yarn_req_kg , fab_woven_req_yds , fab_knit_req_kg,fab_woven_fin_req_yds,fab_knit_fin_req_kg, fab_amount,avg,pro_woven_grey_fab_req_yds,pro_knit_grey_fab_req_kg,pro_woven_fin_fab_req_yds,pro_knit_fin_fab_req_kg,pur_woven_grey_fab_req_yds,pur_knit_grey_fab_req_kg,pur_woven_fin_fab_req_yds,pur_knit_fin_fab_req_kg,woven_amount,knit_amount from wo_pre_cost_sum_dtls where job_no='$data[0]' and status_active=1 and is_deleted=0 ");
				list($sum_data_array )=$data_array1;
				$avg_value="";
				if($sum_data_array[csf("avg")]=="")$avg_value="Make AVG"; else $avg_value=$sum_data_array[csf("avg")];
			?>
					<tr>
						<th width="250">
						<input type="button" id="avg" style="width:70px; display:none" class="formbutton" value="<? echo $avg_value; ?>"/> &nbsp; Yarn Required(Kg)
						<input type="text" id="tot_yarn_needed" name="tot_yarn_needed" class="text_boxes_numeric" style="width:50px;" value="<? echo $sum_data_array[csf("fab_yarn_req_kg")];$yarn_needed= $sum_data_array[csf("fab_yarn_req_kg")];?>" readonly/>
						</th>
						<th width="850">
							Woven Grey Fab Req.(Yds)<input type="text" id="txtwoven_sum" name="txtwoven_sum" class="text_boxes_numeric" style="width:50px" value="<? echo $sum_data_array[csf("fab_woven_req_yds")] ?>" readonly />
							Knit Grey Fab Req.(Kg)<input type="text" id="txtknit_sum"  name="txtknit_sum" class="text_boxes_numeric" style="width:50px" value="<? echo $sum_data_array[csf("fab_knit_req_kg")] ?>" readonly>
							Woven Fin. Fab Req.(Yds)<input type="text" id="txtwoven_fin_sum" name="txtwoven_fin_sum" class="text_boxes_numeric" style="width:50px" value="<? echo $sum_data_array[csf("fab_woven_fin_req_yds")] ?>" readonly />
							Knit Fin. Fab Req.(Kg) <input type="text" id="txtknit_fin_sum"  name="txtknit_fin_sum" class="text_boxes_numeric" style="width:50px" value="<? echo $sum_data_array[csf("fab_knit_fin_req_kg")] ?>"  readonly>
						</th>
						<th width="80">&nbsp;</th>
						<th width="60">&nbsp;</th>
						<th width="70"><input type="text" id="txtamount_sum" name="txtamount_sum" class="text_boxes_numeric" style="width:60px" value="<? echo $sum_data_array[csf("fab_amount")] ?>"  readonly></th>
						<th width="70">&nbsp;</th>
						<th width="70">&nbsp;</th>
						<th>&nbsp;</th>
					</tr>
					<tr>
						<th colspan="2">
							Pro. Woven Grey Fab Req.(Yds)
							<input type="text" id="txtwoven_sum_production" name="txtwoven_sum_production" class="text_boxes_numeric" style="width:60px" value="<? echo $sum_data_array[csf("pro_woven_grey_fab_req_yds")] ?>" readonly />
							Pro. Knit Grey Fab Req.(Kg) <input type="text" id="txtknit_sum_production" name="txtknit_sum_production" class="text_boxes_numeric" style="width:60px" value="<? echo $sum_data_array[csf("pro_knit_grey_fab_req_kg")] ?>"  readonly>
							Pro. Woven Fin. Fab Req.(Yds)
							<input type="text" id="txtwoven_fin_sum_production" name="txtwoven_fin_sum_production" class="text_boxes_numeric" style="width:60px" value="<?  echo $sum_data_array[csf("pro_woven_fin_fab_req_yds")] ?>" readonly />
							Pro. Knit Fin. Fab Req.(Kg) <input type="text" id="txtknit_fin_sum_production" name="txtknit_fin_sum_production" class="text_boxes_numeric" style="width:60px" value="<? echo $sum_data_array[csf("pro_knit_fin_fab_req_kg")] ?>" readonly>
						</th>
						<th width="80">&nbsp;</th>
						<th width="60">&nbsp;</th>
						<th>&nbsp;</th>
						<th>&nbsp;</th>
					</tr>
					<tr>
						<th colspan="2">
							Pur. Woven Grey Fab Req.(Yds)
							<input type="text" id="txtwoven_sum_purchase" name="txtwoven_sum_purchase" class="text_boxes_numeric" style="width:60px" value="<? echo $sum_data_array[csf("pur_woven_grey_fab_req_yds")] ?>" readonly />
							Pur. Knit Grey Fab Req.(Kg) <input type="text" id="txtknit_sum_purchase"  name="txtknit_sum_purchase" class="text_boxes_numeric" style="width:60px" value="<? echo $sum_data_array[csf("pur_knit_grey_fab_req_kg")] ?>"  readonly>
							Pur. Woven Fin. Fab Req.(Yds)
							<input type="text" id="txtwoven_fin_sum_purchase" name="txtwoven_fin_sum_purchase" class="text_boxes_numeric" style="width:60px" value="<?  echo $sum_data_array[csf("pur_woven_fin_fab_req_yds")] ?>" readonly />
							Pur. Knit Fin. Fab Req.(Kg) <input type="text" id="txtknit_fin_sum_purchase"  name="txtknit_fin_sum_purchase" class="text_boxes_numeric" style="width:60px" value="<? echo $sum_data_array[csf("pur_knit_fin_fab_req_kg")] ?>"  readonly>
						</th>
						<th width="80">Woven  Amt</th>
						<th width="60"><input type="text" id="txtwoven_amount_sum_purchase" name="txtwoven_amount_sum_purchase" class="text_boxes_numeric" style="width:55px" value="<? echo $sum_data_array[csf("woven_amount")] ?>"  readonly></th>
						<th width="60">Kint  Amt</th>
						<th width="70"><input type="text" id="txtkint_amount_sum_purchase" name="txtkint_amount_sum_purchase" class="text_boxes_numeric" style="width:55px" value="<? echo $sum_data_array[csf("knit_amount")] ?>"  readonly></th>
						<th>&nbsp;</th>
					</tr>
				</tfoot>
			</table>
            <table width="1430" cellspacing="0" class="" border="0">
                <tr>
                    <td align="right" width="50%" class="button_container">
                    <?
					//  echo $bomfyarn_btn;
					 if(count($bomfyarn_data)>0){
						 $aprroval_data=sql_select("select approved from wo_pre_cost_mst where job_no='$data[0]'");
						// echo $aprroval_data[0][csf('approved')];
						if($aprroval_data[0][csf('approved')]==2){?>
						<input type="button" id='bomfyarn_id' class='formbutton' style='width:80px;'  value='Approval'  onClick="fn_bomfyarn(1);fnc_fabric_cost_dtls(3)" />
						<input type='button' id='bomfyarn_id1' class='formbutton' style='width:80px;display:none;'  value='Un-Approval' onClick="fn_bomfyarn(2);fnc_fabric_cost_dtls(3)" />
						<? }else{ ?>
							<input type='button' id='bomfyarn_id1' class='formbutton' style='width:80px;'  value='Un-Approval' onClick="fn_bomfyarn(2);fnc_fabric_cost_dtls(3)" />
							<input type="button" id='bomfyarn_id' class='formbutton'  style='width:80px;display:none;'  value='Approval' onClick="fn_bomfyarn(1);fnc_fabric_cost_dtls(3)" />
						<? } ?>
						<input type="hidden" id="bomfyarn_approval_id" class="formbutton" style="width:80px"  value=""  />

					 <? }
					 	$is_seq_load=0;
                        if ( count($data_array)>0)
                        {
                            echo load_submit_buttons( $permission, "fnc_fabric_cost_dtls", $save_update,0,"reset_form('fabriccost_3','','', 'cbofabricnature_,3,$i')",3) ;
							$is_seq_load=1;
                        }
                        else
                        {
                            echo load_submit_buttons( $permission, "fnc_fabric_cost_dtls", 0,0,"reset_form('fabriccost_3','','',0)",3) ;
                        }
                    ?>
                    <input type="button" id="report_btn_15" class="formbutton" value="Weight Sheet" onClick="generate_report('avgWeightCalSheet');" style="display:none;" />
                    </td>
                    <td align="left" width="50%" class="button_container" valign="top">
                    <?
                        if ( count($data_array)>0)
                        {
                            ?>
                            <input type="button" class="formbutton" style="width:100px;display:none;" name="stripe_color" id="stripe_color" value="Stripe Color"  onClick="open_stripe_color_popup();"/>
                            <?
                        }
                    ?>
                    </td>
                </tr>
            </table>
        </form>
    </fieldset>
    </div>
	
    <h3 style="width:1005px;" align="left" id="accordion_h_yarn" class="accordion_h" onClick="show_hide_content('yarn_cost', '');">+Yarn Cost Details<?=$approved_message; ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<span id="tot_yarn_needed_span"><? //echo $yarn_needed; ?></span></h3>
       <div id="content_yarn_cost" style="display:none;">
    	<fieldset style="width:1000px;">
        	<form id="yarnccost_4" autocomplete="off">
            	<table width="1000" cellspacing="0" class="rpt_table" border="0" id="copy_table" rules="all">
                	<tr>
                    	<td>
                            &nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;<b>Copy</b> : &nbsp;&nbsp;
                            <form>
                                <input type="radio" name="rate_copy" value="1" checked>All &nbsp;&nbsp;&nbsp;&nbsp;
                                <input type="radio" name="rate_copy" value="2">Color Wise &nbsp;&nbsp;&nbsp;&nbsp;
                                <input type="radio" name="rate_copy" value="3">Count Wise &nbsp;&nbsp;&nbsp;&nbsp;
                                <input type="radio" name="rate_copy" value="4">Comp 1 Wise &nbsp;&nbsp;&nbsp;&nbsp;
                                <input type="reset" value="Reset">
                            </form>
                        </td>
                    </tr>
                </table>
            	<table width="1000" cellspacing="0" class="rpt_table" border="0" id="tbl_yarn_cost" rules="all">
                	<thead>
                    	<tr>
                        	<th width="30">F.Seq</th>
                        	<th width="60">Count</th>
                            <th width="100" class="must_entry_caption">Comp 1</th>
                            <th width="45" class="must_entry_caption">%</th>
                            <th width="80">Color</th>
                            <th width="100">Type</th>
							<th width="100">Supplier Source</th>
                            <th width="120">Supplier</th>
                            <th width="75" class="must_entry_caption">Cons Qty</th>
                            <th width="75" class="must_entry_caption" title="(((Stripe Actual Cons/Total Stripe Actual Cons)*Avg. Grey Cons)*(Stripe Excess %/100))+((Stripe Actual Cons/Total Stripe Actual Cons)*Avg. Grey Cons)">Avg. Cons/Dzn</th>
                            <th width="75" class="must_entry_caption" title="(Avg. Cons Dzn*2.20462)">Avg. Cons/Dzn in Lbs</th>
                            <th width="50" style=" <?=$bom_of_yarn; ?>">Rate Per Lbs</th>
                            <th title="Avg. Cons Dzn in Lbs*Rate Per Lbs" style=" <?=$bom_of_yarn; ?>">Amount [Lbs]</th>
                        </tr>
                    </thead>
                    <tbody>
                    <?
					$print_report_format=return_field_value("format_id","lib_report_template","template_name ='$data[3]' and module_id=2 and report_id=43 and is_deleted=0 and status_active=1");
					
					$supplier_library_yarn=return_library_array( "select c.id, c.supplier_name from lib_supplier_tag_company a, lib_supplier_party_type b, lib_supplier c where c.id=b.supplier_id and a.supplier_id = b.supplier_id and a.tag_company=$data[3]  and b.party_type =2 and c.status_active=1 and c.is_deleted=0 group by c.id, c.supplier_name order by supplier_name", "id", "supplier_name");
					
					$yarn_count_arr=return_library_array("select id,yarn_count from  lib_yarn_count where is_deleted=0 and status_active=1 order by yarn_count","id","yarn_count");
					
					$color_from_library=return_field_value("color_from_library", "variable_order_tracking", "company_name=$data[3] and variable_list=23 and status_active=1 and is_deleted=0");
					if($color_from_library==1) $color_browse="readonly='readonly' placeholder='Click' onClick='color_select_popup($data[4],this.id)'"; 
					else $color_browse="";

					$save_update=1;
                    $data_array=sql_select("select id, fabric_cost_dtls_id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, color, type_id, cons_ratio, supplier_id,source, cons_qnty, avg_cons_qnty, consdznlbs, rate, amount, status_active from wo_pre_cost_fab_yarn_cost_dtls where job_no='$data[0]' and is_deleted=0 and status_active=1 order by id");
					if(count($data_array)<1 && $data[2]==1  && $data[6]==2 )// Price Quotation
					{
						$data_array=sql_select("select id as pri_id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, cons_ratio, cons_qnty, supplier_id,source, rate, amount, status_active from wo_pri_quo_fab_yarn_cost_dtls where quotation_id='$data[1]' and is_deleted=0 and status_active=1 order by id");
						$save_update=0;
					}
					if (count($data_array) < 1 && $data[2]==1 && $data[6]==7 )//Short Quotation Sweater
					{
						$data_array=sql_select("select id as pri_id, cons_rate_dtls_id as prifabdtlsid, count as count_id, composition as copm_one_id, percent as percent_one, 0 as copm_two_id, 0 as percent_two, '' as color, yarn_type as type_id, 0 as cons_ratio, cons as cons_qnty, tot_cons as avg_cons_qnty, nominated_supp_multi as supplier_id, rate, value as amount, status_active, 0 as yarn_finish, 0 as yarn_spinning_system, 0 as certification from qc_fab_yarn_conv where qc_no='$data[1]' and type=2 and cons>0 and status_active=1 and is_deleted=0 order by id");
						$save_update=0;
					}
					$i=0; $tot_cons=0; $tot_avg_cons=0; $tot_rate_cal=0; $tot_rate_dzn=0; 
					if(count($data_array)>0)
					{
						foreach( $data_array as $row )
						{
							$i++; $tot_cons=$tot_cons+$row[csf("cons_qnty")]; $tot_avg_cons+=$row[csf("avg_cons_qnty")]; $tot_rate_dzn+=$row[csf("rate_dzn")];
							
							if($approved==1) $disabled=1; else $disabled=0;
							if($component_approved==1)
							{
								$disabled=1; $btn_disabled=1;
							}
							else
							{
								$disabled=0; $btn_disabled=0;
							}
							$consdznlbs=$row[csf("avg_cons_qnty")]*2.20462;
							if($row[csf("consdznlbs")]==0) $row[csf("consdznlbs")]=$consdznlbs;
							$tot_consdznlbs+=$row[csf("consdznlbs")];
							
							if($is_seq_load==1) $yarnFabSeqNo=$fab_id_wise_item[$row[csf("fabric_cost_dtls_id")]]['seq'];
							else $yarnFabSeqNo=$fab_id_wise_item[$row[csf("pri_id")]]['seq'];
							?>
                            <tr id="yarncost_<?=$i; ?>" align="center">
                            	<td><input type="text" id="txtyarnseq_<?=$i; ?>" name="txtyarnseq_<?=$i; ?>" class="text_boxes_numeric" style="width:18px" value="<?=$fab_id_wise_item[$row[csf("fabric_cost_dtls_id")]]['seq']; ?>" /></td>
                                <td><?=create_drop_down( "cbocount_".$i, 58, $yarn_count_arr, "",1,"-- Select Item --", $row[csf("count_id")], "",$disabled,"" ); ?> </td>
                                <td><?=create_drop_down( "cbocompone_".$i, 98, $composition,"", 1, "-- Select --", $row[csf("copm_one_id")], "",$disabled,"" ); ?></td>
                               <td><input type="text" id="percentone_<?=$i; ?>"  name="percentone_<?=$i; ?>" class="text_boxes" style="width:31px" onChange="" value="<?=$row[csf("percent_one")];  ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?>  readonly/>
                                </td>
                                <td><input type="text" id="color_<?=$i; ?>" name="color_<?=$i; ?>" class="text_boxes" style="width:66px" <?=$color_browse; ?> value="<?=$color_library[$row[csf("color")]]; ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> readonly title="<?=$color_library[$row[csf("color")]]; ?>" />
                                </td>
                                <td><?=create_drop_down( "cbotype_".$i, 98, $yarn_type,"", 1, "-- Select --", $row[csf("type_id")], "",$disabled,"" ); ?></td>
								<td><?=create_drop_down( "source_".$i, 98, $source, "",1," --Select--", $row[csf("source")], '','','' ); ?></td>
                                <td><?=create_drop_down( "supplier_".$i, 118, $supplier_library_yarn, "",1," --Select--", $row[csf("supplier_id")], "set_yarn_rate($i)",'','' ); ?></td>
                                <td><input type="text" id="consqnty_<?=$i; ?>" name="consqnty_<?=$i; ?>" class="text_boxes_numeric" style="width:62px" onChange=" calculate_yarn_consumption_ratio(<?=$i; ?>,'calculate_amount');" value="<?=$row[csf("cons_qnty")]; ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> readonly /></td>
                                <td><input type="text" id="avgconsqnty_<?=$i; ?>" name="avgconsqnty_<?=$i; ?>" class="text_boxes_numeric" style="width:62px" value="<?=$row[csf("avg_cons_qnty")]; ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> readonly /></td>
                                <td><input type="text" id="txtconsdznlbs_<?=$i; ?>" name="txtconsdznlbs_<?=$i; ?>" class="text_boxes_numeric" style="width:62px" value="<?=number_format($row[csf("consdznlbs")],4,'.',''); ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> readonly/></td>
                                <td style=" <?=$bom_of_yarn; ?>"><input type="text" id="txtrateyarn_<?=$i; ?>" name="txtrateyarn_<?=$i; ?>" class="text_boxes_numeric" style="width:37px" onChange="calculate_yarn_consumption_ratio(<?=$i; ?>,'calculate_amount'); fnc_copy_rate(this.value,<?=$i; ?>);" value="<?=$row[csf("rate")]; ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> /></td>
                                <td style=" <?=$bom_of_yarn; ?>">
                                	<input type="text" id="txtamountyarn_<?=$i; ?>" name="txtamountyarn_<?=$i; ?>" class="text_boxes_numeric" style="width:60px" value="<?=$row[csf("amount")]; ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> readonly />
                                   <input type="hidden" id="updateidyarncost_<?=$i; ?>" name="updateidyarncost_<?=$i; ?>" class="text_boxes" style="width:20px" value="<?=$row[csf("id")]; ?>"  /> 
                                </td>
                            </tr>
                            <?
						}
					}
					else
					{
						$save_update=0;
						$data_array_p=sql_select("select id, count_id, copm_one_id, percent_one, type_id, cons_ratio, cons_qnty, avg_cons_qnty, supplier_id,source from wo_pre_cost_fab_yarnbreakdown where job_no='$data[0]' and is_deleted=0 and status_active=1 order by id");
						if(count($data_array)>0)
					    {
							foreach($data_array_p as $row_p)
							{
								$i++; $tot_cons=$tot_cons+$row_p[csf("cons_qnty")]; $tot_avg_cons+=$row_p[csf("avg_cons_qnty")]; $tot_rate_dzn+=$row_p[csf("rate_dzn")];	
								$consdznlbs=$row[csf("avg_cons_qnty")]*2.20462;
								if($row[csf("consdznlbs")]==0) $row[csf("consdznlbs")]=$consdznlbs;	
								$tot_consdznlbs+=$row[csf("consdznlbs")];						
								?>
								<tr id="yarncost_<?=$i; ?>" align="center">
                                	<td><input type="text" id="txtyarnseq_<?=$i; ?>" name="txtyarnseq_<?=$i; ?>" class="text_boxes_numeric" style="width:18px" value="<?=$fab_id_wise_item[$row[csf("fabric_cost_dtls_id")]]['seq']; ?>" /></td>
                                    <td><?=create_drop_down( "cbocount_".$i, 58, $yarn_count_arr, "",1," -- Select Item --", $row_p[csf("count_id")], '','','' ); ?></td>
                                    <td><?=create_drop_down( "cbocompone_".$i,98, $composition,"", 1, "-- Select --", $row_p[csf("copm_one_id")], "",'','' ); ?></td>
                                   <td><input type="text" id="percentone_<?=$i;?>" name="percentone_<?=$i;?>" class="text_boxes" style="width:32px" onChange="" value="<?=$row_p[csf("percent_one")]; ?>"  readonly/>
                                    </td>
                                    <td><input type="text" id="color_<?=$i; ?>" name="color_<?=$i; ?>" class="text_boxes" style="width:67px" <?=$color_browse; ?> value="<?=$row_p[csf("color")]; ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> /></td>
                                    <td><?=create_drop_down( "cbotype_".$i, 98, $yarn_type,"", 1, "-- Select --", $row_p[csf("type_id")], '','','' ); ?></td>
									<td><?=create_drop_down( "source_".$i, 98, $source, "",1," -- Select --", $row_p[csf("source")], '','','' ); ?></td>
                                    <td><?=create_drop_down( "supplier_".$i, 118, $supplier_library_yarn, "",1," -- Select --", $row_p[csf("supplier_id")], "set_yarn_rate($i)",'','' ); ?></td>
                                    
                                    <td><input type="text" id="consqnty_<?=$i; ?>" name="consqnty_<?=$i; ?>" class="text_boxes_numeric" style="width:62px" onChange=" calculate_yarn_consumption_ratio(<?=$i; ?>,'calculate_amount')" value="<?=$row[csf("cons_qnty")]; ?>" readonly /></td>
                                    <td><input type="text" id="avgconsqnty_<?=$i; ?>" name="avgconsqnty_<?=$i; ?>" class="text_boxes_numeric" style="width:62px" value="<?=$row[csf("avg_cons_qnty")]; ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> readonly /></td>
                                    <td><input type="text" id="txtconsdznlbs_<?=$i; ?>" name="txtconsdznlbs_<?=$i; ?>" class="text_boxes_numeric" style="width:62px" value="<?= number_format($row[csf("consdznlbs")],4,'.',''); ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> readonly/></td>
                                    
                                    <td style=" <?=$bom_of_yarn; ?>"><input type="text" id="txtrateyarn_<?=$i; ?>" name="txtrateyarn_<?=$i; ?>" class="text_boxes_numeric" style="width:37px" onChange="calculate_yarn_consumption_ratio(<?=$i; ?>,'calculate_amount'); fnc_copy_rate(this.value,<?=$i; ?>);" value="<?=$row[csf("rate")]; ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> /></td>
                                    
                                    <td style=" <?=$bom_of_yarn; ?>">
                                        <input type="text" id="txtamountyarn_<?=$i; ?>" name="txtamountyarn_<?=$i; ?>" class="text_boxes_numeric" style="width:60px" value="" <? if($disabled==0){echo "";}else{echo "disabled";}?> readonly />
                                        <input type="hidden" id="updateidyarncost_<?=$i; ?>" name="updateidyarncost_<?=$i; ?>"  class="text_boxes" style="width:20px" value="" />
                                    </td>
                                </tr>
								<?
							}
						}
						else
						{
							?>
							<tr id="yarncost_1" align="center">
                            	<td><input type="text" id="txtyarnseq_1" name="txtyarnseq_1" class="text_boxes_numeric" style="width:18px" value="1" /></td>
                                <td><?=create_drop_down( "cbocount_1", 60, $yarn_count_arr, "",1," -- Select Item --", $selected, '','','' ); ?></td>
                                <td><?=create_drop_down( "cbocompone_1",100, $composition,"", 1, "-- Select --", $selected, "",'','' ); ?></td>
                                <td><input type="text" id="percentone_1" name="percentone_1" class="text_boxes" style="width:32px" onChange="" value="100" readonly /></td>
                                <td><input type="text" id="color_1" name="color_1" class="text_boxes" style="width:67px" <? echo $color_browse; ?> value="" /></td>
                                <td><?=create_drop_down( "cbotype_1", 100, $yarn_type,"", 1, "-- Select --", $row_p[csf("type_id")], '','','' ); ?></td>
								<td><?=create_drop_down( "source_1", 120, $source, "",1," -- Select --", $selected, '','','' ); ?></td>
                                <td><?=create_drop_down( "supplier_1", 120, $supplier_library_yarn, "",1," -- Select --", $selected, "set_yarn_rate(1)",'','' ); ?></td>
                                
                                <td><input type="text" id="consqnty_1" name="consqnty_1" class="text_boxes_numeric" style="width:62px" onChange=" calculate_yarn_consumption_ratio(1,'calculate_amount')" value="" readonly /></td>
                                <td><input type="text" id="avgconsqnty_1" name="avgconsqnty_1" class="text_boxes_numeric" style="width:62px" value="" readonly /></td>
                                <td><input type="text" id="txtconsdznlbs_1" name="txtconsdznlbs_1" class="text_boxes_numeric" style="width:62px" value="" readonly /></td>
                                
                                <td style=" <?=$bom_of_yarn; ?>"><input type="text" id="txtrateyarn_1" name="txtrateyarn_1" class="text_boxes_numeric" style="width:37px" onChange="calculate_yarn_consumption_ratio(1,'calculate_amount')" value="" /></td>
                                
                                <td style=" <?=$bom_of_yarn; ?>">
                                <input type="text" id="txtamountyarn_1" name="txtamountyarn_1" class="text_boxes_numeric" style="width:60px" value="" readonly />
                                <input type="hidden" id="updateidyarncost_1" name="updateidyarncost_1" class="text_boxes" style="width:20px" value=""  />
                                </td>
                            </tr>
                        	<?
						}
					}
					?>
                	</tbody>
                </table>
                
                <table width="1000" class="rpt_table" cellpadding="0" cellspacing="0" border="1" rules="all" >
                	<tfoot>
                    	<tr>
                        	<th width="30">&nbsp;</th>
                        	<th width="60">&nbsp;</th>
                            <th width="100">&nbsp;</th>
                            <th width="45">&nbsp;</th>
                            <th width="80">&nbsp;</th>
                            <th width="100">&nbsp;</th>
							<th width="100">&nbsp;</th>
                            <th width="120">SUM :</th>
                            <th width="75"><input type="text" id="txtconsumptionyarn_sum" name="txtconsumptionyarn_sum" class="text_boxes_numeric" style="width:62px" value="<?=$tot_cons; ?>" readonly></th>
                            <th width="75"><input type="text" id="txtavgconsumptionyarn_sum" name="txtavgconsumptionyarn_sum" class="text_boxes_numeric" style="width:62px" value="<?=$tot_avg_cons; ?>" readonly></th>
                            <th width="75"><input type="text" id="txtconsumptionyarnlbs_sum" name="txtconsumptionyarnlbs_sum" class="text_boxes_numeric" style="width:62px" value="<?=number_format($tot_consdznlbs,4,'.',''); ?>" readonly></th>
                            <th width="50"><input type="text" id="txtratecal_sum" name="txtratecal_sum" class="text_boxes_numeric" style="width:37px" value="<? //=$tot_rate_cal; ?>" readonly></th>
                            <th><input type="text" id="txtamountyarn_sum" name="txtamountyarn_sum" class="text_boxes_numeric" style="width:60px" value="<?=$tot_rate_dzn; ?>" readonly></th>
                        </tr>
                    </tfoot>
                </table>

                <table width="1000" cellspacing="0" class="" border="0">
                    <tr>
                        <td align="center" width="100%" class="button_container">
                        <?
                        if (count($data_array)>0)
                        {
                        	echo load_submit_buttons( $permission, "fnc_fabric_yarn_cost_dtls", $save_update,0,"reset_form('yarnccost_4','','',0)",4) ;
                        }
                        else
                        {
                        	echo load_submit_buttons( $permission, "fnc_fabric_yarn_cost_dtls", $save_update,0,"reset_form('yarnccost_4','','',0)",4) ;
                        }
						
						$printReportFormat= explode(",",$print_report_format);
						foreach($printReportFormat as $key)
						{
							if($key==229) $show_hide = "style='display:inline'";
							else $show_hide = "style='display:none;'";
							
						}
                        ?>
                        <input type="button" id="btn_weight_sheet" class="formbutton" value="Weight Sheet" onClick="generate_report('avgWeightCalSheet')" <? echo $show_hide;?>   />
                        </td>
                    </tr>
                </table>
            </form>
        </fieldset>
        </div>
       <h3 style="width:790px; display:none" align="left" class="accordion_h" onClick="show_hide_content('conversion_cost', '')">+Conversion Cost <?=$approved_message; ?></h3>
       <div id="content_conversion_cost" style="display:none;" align="left">
    	<fieldset style="width:780px; display:none">
        	<form id="conversionccost_5" autocomplete="off">
            	<table width="780" cellspacing="0" class="rpt_table" border="0" id="tbl_conversion_cost" rules="all">
                	<thead>
                    	<tr>
                        	<th width="235">Fabric Description</th>
                            <th width="110">Process</th>
                            <th width="50">Process Loss</th>
                            <th width="50">Req. Qty</th>
                            <th width="50">Avg.Req. Qty (Less Process Loss)</th>
                            <th width="50">Charge/ Unit</th>
                            <th width="70">Amount</th>
                            <th width="60">Status</th>
                            <th>&nbsp;</th>
                        </tr>
                    </thead>
                    <tbody>
                    <?
					$conversion_from_chart=return_field_value("conversion_from_chart", "variable_order_tracking", "company_name='$data[3]'  and variable_list=21 and status_active=1 and is_deleted=0");
					if($conversion_from_chart=="") $conversion_from_chart=2;

					if($conversion_from_chart==1) $readonly="readonly"; $readonly="";

					$fab_description=array();
					$fab_description_array=sql_select("select id, body_part_id, color_type_id, fabric_description from wo_pre_cost_fabric_cost_dtls where job_no='$data[0]' and  	fabric_source in(1,2) order by id");
					foreach( $fab_description_array as $row_fab_description_array )
					{
						$fab_description[$row_fab_description_array[csf("id")]]=	$body_part[$row_fab_description_array[csf("body_part_id")]].', '.$color_type[$row_fab_description_array[csf("color_type_id")]].', '.$row_fab_description_array[csf("fabric_description")];
					}

					$save_update=1;
					$data_array=sql_select("select id, job_no, fabric_description, cons_process, process_loss,req_qnty,avg_req_qnty, charge_unit, amount,color_break_down,charge_lib_id, status_active from  wo_pre_cost_fab_conv_cost_dtls where job_no='$data[0]' order by id");
					if(count($data_array)<1 && $data[2]==1)
					{
						$data_array=sql_select("select id, quotation_id, cost_head, cons_type,process_loss, req_qnty, charge_unit, amount, status_active from  wo_pri_quo_fab_conv_cost_dtls where quotation_id='$data[1]'");
					$save_update=0;
					}

					if ( count($data_array)>0)
					{
						$i=0;
						foreach( $data_array as $row )
						{
							$selected_fab_description="";
							if($row[csf("fabric_description")]!="") $selected_fab_description=$row[csf("fabric_description")];
							else $selected_fab_description=$row[csf("cost_head")];

							$selected_process="";
							if($row[csf("cons_process")]!="") $selected_process=$row[csf("cons_process")]; else $selected_process=$row[csf("cons_type")];
							$i++;

							if($approved==1 || $component_approved==1){
								 $disabled=1;
							}
							else{
								 $disabled=0;
							}
							
							if($component_approved==1)
							{
								 $btn_disabled=1;
							}
							else
							{
								 $btn_disabled=0;
							}

							?>
                            <tr id="conversion_1" align="center">
                                <td><? echo create_drop_down( "cbocosthead_".$i, 235, $fab_description, "",1," -- Select--", $selected_fab_description, "set_conversion_qnty(".$i.")",$disabled,"" ); ?></td>
                                <td><?  echo create_drop_down( "cbotypeconversion_".$i, 110, $conversion_cost_head_array,"", 1, "-- Select --", $selected_process, "set_conversion_charge_unit(".$i.",".$conversion_from_chart.")",$disabled,"" ); ?></td>
                                <td><input type="text" id="txtprocessloss_<? echo $i; ?>" name="txtprocessloss_<? echo $i; ?>" class="text_boxes_numeric" style="width:40px"  value="<? echo $row[csf("process_loss")];  ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> onChange="set_conversion_qnty(<? echo $i ?>)" readonly /></td>
                               <td><input type="text" id="txtreqqnty_<? echo $i; ?>"  name="txtreqqnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:40px" onChange="calculate_conversion_cost( <? echo $i;?> )"  value="<? echo $row[csf("req_qnty")];  ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> readonly/></td>
                                <td><input type="text" id="txtavgreqqnty_<? echo $i; ?>"  name="txtavgreqqnty_<? echo $i; ?>" class="text_boxes_numeric" style="width:40px" onChange="calculate_conversion_cost( <? echo $i;?> )"  value="<? echo $row[csf("avg_req_qnty")];  ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?>  readonly/></td>
                               <td><input type="text" id="txtchargeunit_<? echo $i; ?>"  name="txtchargeunit_<? echo $i; ?>" class="text_boxes_numeric" style="width:40px" onChange="calculate_conversion_cost( <? echo $i;?> )" onClick="set_conversion_charge_unit(<? echo $i;?>,<? echo $conversion_from_chart;?>)"  value="<? echo $row[csf("charge_unit")];?>"  <? if($disabled==0){echo "";}else{echo "disabled";}?> <? echo $readonly; ?>/></td>
                                <td><input type="text" id="txtamountconversion_<? echo $i; ?>" name="txtamountconversion_<? echo $i; ?>" class="text_boxes_numeric" style="width:60px" value="<? echo $row[csf("amount")]; ?>" readonly/></td>
                                <td><? echo create_drop_down( "cbostatusconversion_".$i, 60, $row_status,"", 0, "0", $row[csf("status_active")], '',$disabled,'' );  ?></td>
                                <td>
                                    <input type="button" id="increaseconversion_<? echo $i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_conversion_cost(<? echo $i; ?>,<? echo $conversion_from_chart;?> )" <? if($disabled==0){echo "";}else{echo "disabled";}?>/>
                                    <input type="button" id="decreaseconversion_<? echo $i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<? echo $i; ?> ,'tbl_conversion_cost' );" <? if($disabled==0){echo "";}else{echo "disabled";}?>/>
                                    <input type="hidden" id="updateidcoversion_<? echo $i; ?>" name="updateidcoversion_<? echo $i; ?>"  class="text_boxes" style="width:20px" value="<? echo $row[csf("id")]; ?>" />
                                    <input type="hidden" id="colorbreakdown_<? echo $i; ?>" name="colorbreakdown_<? echo $i; ?>"  class="text_boxes" style="width:20px" value="<? echo $row[csf("color_break_down")]; ?>" />
                                    <input type="hidden" id="coversionchargelibraryid_<? echo $i; ?>" name="coversionchargelibraryid_<? echo $i; ?>"  class="text_boxes" style="width:20px" value="<? echo  $row[csf("charge_lib_id")]; ?>"   readonly />
                                 </td>
                            </tr>
                            <?
						}
					}
					else
					{
						$save_update=0;
						?>
						<tr id="conversion_1" align="center">
                            <td><? echo create_drop_down( "cbocosthead_1", 235, $fab_description, "",1," -- All Fabrics--", "", "set_conversion_qnty(1)","","" ); ?></td>
                            <td><? echo create_drop_down( "cbotypeconversion_1", 110, $conversion_cost_head_array,"", 1, "-- Select --", "", "set_conversion_charge_unit( 1,".$conversion_from_chart." )","","" ); ?></td>
                            <td><input type="text" id="txtprocessloss_1" name="txtprocessloss_1" class="text_boxes_numeric" style="width:40px"  value="" onChange="set_conversion_qnty(1)" readonly /></td>
                            <td><input type="text" id="txtreqqnty_1"  name="txtreqqnty_1" class="text_boxes_numeric" style="width:40px" onChange="calculate_conversion_cost( 1 )" value="" readonly /></td>
                            <td><input type="text" id="txtavgreqqnty_1"  name="txtavgreqqnty_1" class="text_boxes_numeric" style="width:40px" onChange="calculate_conversion_cost( 1 )" value="" readonly/></td>
                            <td><input type="text" id="txtchargeunit_1"  name="txtchargeunit_1" class="text_boxes_numeric" style="width:40px" onChange="calculate_conversion_cost( 1 )" onClick="set_conversion_charge_unit(1,<? echo $conversion_from_chart;?>)" <? echo $readonly; ?> value="" /></td>
                            <td><input type="text" id="txtamountconversion_1"  name="txtamountconversion_1" class="text_boxes_numeric" style="width:60px" value="" readonly /></td>

                            <td><? echo create_drop_down( "cbostatusconversion_1", 60, $row_status,"", 0, "0", '', '','','' );  ?></td>
                            <td>
                                <input type="button" id="increaseconversion_1" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_conversion_cost(1,<? echo $conversion_from_chart;?>)" />
                                <input type="button" id="decreaseconversion_1" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(1,'tbl_conversion_cost' );" />
                                <input type="hidden" id="updateidcoversion_1" name="updateidcoversion_1"  class="text_boxes" style="width:20px" value=""  />
                                <input type="hidden" id="colorbreakdown_1" name="colorbreakdown_1"  class="text_boxes" style="width:20px" value=""  />
                                <input type="hidden" id="coversionchargelibraryid_1" name="coversionchargelibraryid_1"  class="text_boxes" style="width:20px" value="" readonly  />                             </td>
                        </tr>
                <? } ?>
                </tbody>
            </table>
            <table width="780" cellspacing="0" class="rpt_table" border="0" rules="all">
            	<tfoot>
                    <tr>
                        <th width="345">Sum</th>
                        <th width="50"><input type="text" id="txtconreqnty_sum"  name="txtconreqnty_sum" class="text_boxes_numeric" style="width:40px"  readonly /></th>
                        <th width="50"><input type="text" id="txtavgconreqnty_sum"  name="txtavgconreqnty_sum" class="text_boxes_numeric" style="width:40px" readonly /></th>
                        <th width="50"><input type="text" id="txtconchargeunit_sum"  name="txtconchargeunit_sum" class="text_boxes_numeric" style="width:40px"  readonly /></th>
                        <th width="70"><input type="text" id="txtconamount_sum"  name="txtconamount_sum" class="text_boxes_numeric" style="width:60px"  readonly /></th>
                        <th width="60" style=" border:none"></th>
                        <th width="" style=" border:none"></th>
                    </tr>
                </tfoot>
            </table>
            <table width="780" cellspacing="0" class="" border="0">
                <tr>
                    <td align="center" width="100%" class="button_container">
                    <?
                    if ( count($data_array)>0)
                    {
                    	echo load_submit_buttons( $permission, "fnc_fabric_conversion_cost_dtls", $save_update,0,"reset_form('fabriccost_3','','',0)",5) ;
                    }
                    else
                    {
                    	echo load_submit_buttons( $permission, "fnc_fabric_conversion_cost_dtls", $save_update,0,"reset_form('fabriccost_3','','',0)",5) ;
                    }
                    ?>
                    </td>
                </tr>
            </table>
            </form>
        </fieldset>
    </div>
	<?
	exit();
}

if($action=="body_part_popup")
{
	echo load_html_head_contents("Item Group Select","../../../", 1, 1, $unicode,'','');
	extract($_REQUEST);
	?>
	<script>
	function js_set_value(id, name,type)
	{
		document.getElementById('gid').value=id;
		document.getElementById('gname').value=name;
		document.getElementById('gtype').value=type;
		parent.emailwindow.hide();
	}
	</script>
	</head>
	<body>
        <div align="center" style="width:100%;">
        <input type="hidden" id="gid" name="gid"/>
        <input type="hidden" id="gname" name="gname"/>
        <input type="hidden" id="gtype" name="gtype"/>
        <?
        $sql_tgroup=sql_select( "select body_part_full_name,body_part_short_name,body_part_type,id from lib_body_part where  is_deleted=0  and  status_active=1 order by body_part_short_name");
        ?>
        <table width="420" cellspacing="0" class="rpt_table" border="0" rules="all">
            <thead>
            	<th width="40">SL</th><th width="300">Item Group</th><th>Type</th>
            </thead>
        </table>
        <table width="420" cellspacing="0" class="rpt_table" border="0" rules="all" id="item_table">
            <tbody>
            <?
            $i=1;
            foreach($sql_tgroup as $row_tgroup)
			{
				if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
				?>
				<tr onClick="js_set_value(<? echo $row_tgroup[csf('id')]; ?>, '<? echo $row_tgroup[csf('body_part_full_name')]; ?>', '<? echo $row_tgroup[csf('body_part_type')]; ?>')" bgcolor="<? echo $bgcolor; ?>">
					<td width="40"><? echo $i; ?></td><td width="300"><? echo $row_tgroup[csf('body_part_full_name')]; ?></td><td width=""><? echo $body_part_type[$row_tgroup[csf('body_part_type')]]; ?></td>
				</tr>
				<?
				$i++;
            }
            ?>
            </tbody>
        </table>
        </div>
	</body>
	<script> setFilterGrid('item_table',-1); </script>
	</html>
	<?
	exit();
}

if($action=="fabric_description_popup")
{
	echo load_html_head_contents("Fabric Description Info", "../../../", 1, 1,'','','');
	extract($_REQUEST);
	?>
	<script>
		function js_set_value(data)
		{
			var data=data.split('_');
			var fabric_yarn_description=return_global_ajax_value(data[0], 'fabric_yarn_description', '', 'pre_cost_entry_controller_v2');
			var fabric_yarn_description_arr=fabric_yarn_description.split("**");
			var fabric_description=trim(data[2])+' '+trim(fabric_yarn_description_arr[0]);
			document.getElementById('fab_des_id').value=data[0];
			document.getElementById('fab_nature_id').value=data[1];
			document.getElementById('construction').value=trim(data[2]);
			document.getElementById('fab_gsm').value=trim(data[3]);
			document.getElementById('process_loss').value=trim(data[4]);
			document.getElementById('fab_desctiption').value=trim(fabric_description);
			document.getElementById('composition').value=trim(fabric_yarn_description_arr[0]);
			var yarn =fabric_yarn_description_arr[1].split("_");
			if(yarn[1]*1==0 || yarn[1]==""){
				alert("Composition not set in yarn count determination");
				return;
			}
			document.getElementById('yarn_desctiption').value=trim(fabric_yarn_description_arr[1]);
			parent.emailwindow.hide();
		}
		function toggle( x, origColor )
		{
			var newColor = 'yellow';
			document.getElementById(x).style.backgroundColor = ( newColor == document.getElementById(x).style.backgroundColor )? origColor : newColor;
		}
			</script>
    </head>
    <body>
    <div align="center">
        <form name="styleRef_form" id="styleRef_form">
		<fieldset>
            <table cellspacing="0" cellpadding="0" border="1" rules="all" align="center" class="rpt_table" id="tbl_list">
                <thead>
                    <tr>
                    	<th colspan="3" align="center"><? echo create_drop_down( "cbo_string_search_type", 100, $string_search_type,'', 1, "-- Searching Type --" ); ?></th>
                    </tr>
                    <tr>
                        <th>Construction</th>
                        <th>GSM/Weight</th>
                        <th><input type="reset" name="button" class="formbutton" value="Reset" style="width:100px;" onClick="reset_form('styleRef_form','search_div','','','','');"></th>
                    </tr>
                </thead>
                <tbody>
                    <tr>
                        <td align="center"><input type="text" style="width:130px" class="text_boxes" name="txt_construction" id="txt_construction" /></td>
                        <td align="center">	<input type="text" style="width:130px" class="text_boxes" name="txt_gsm_weight" id="txt_gsm_weight" /></td>
                        <td align="center">
                        	<input type="button" name="button" class="formbutton" value="Show" onClick="show_list_view ('<? echo $fabric_nature; ?>'+'**'+'<? echo $libyarncountdeterminationid; ?>'+'**'+document.getElementById('txt_construction').value+'**'+document.getElementById('txt_gsm_weight').value+'**'+document.getElementById('cbo_string_search_type').value, 'fabric_description_popup_search_list_view', 'search_div', 'pre_cost_entry_controller_v2', 'setFilterGrid(\'list_view\',-1)'); toggle( 'tr_'+'<? echo $libyarncountdeterminationid; ?>', '#FFFFCC');" style="width:100px;" />
                        </td>
                    </tr>
            	</tbody>
           	</table>
            <div style="margin-top:10px" id="search_div"></div>
		</fieldset>
	</form>
    </div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
	exit();
}

if($action=="fabric_description_popup_search_list_view")
{
	//echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	list($fabric_nature,$libyarncountdeterminationid,$construction,$gsm_weight,$string_search_type)=explode('**',$data);
	$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count"  );
	$search_con='';
	if($string_search_type==1)
	{
		if($construction!='') {$search_con .= " and a.construction='".trim($construction)."'";}
		if($gsm_weight!='') {$search_con .= " and a.gsm_weight='".trim($gsm_weight)."'";}
	}
	else if($string_search_type==2)
	{
		if($construction!='') {$search_con .= " and a.construction like ('".trim($construction)."%')";}
		if($gsm_weight!='') {$search_con .= " and a.gsm_weight like ('".trim($gsm_weight)."%')";}
	}
	else if($string_search_type==3)
	{
		if($construction!='') {$search_con .= " and a.construction like ('%".trim($construction)."')";}
		if($gsm_weight!='') {$search_con .= " and a.gsm_weight like ('%".trim($gsm_weight)."')";}
	}
	else if($string_search_type==4 || $string_search_type==0)
	{
		if($construction!='') {$search_con .= " and a.construction like ('%".trim($construction)."%')";}
		if($gsm_weight!='') {$search_con .= " and a.gsm_weight like ('%".trim($gsm_weight)."%')";}
	}
?>

</head>
<body>
    <div align="center">
        <form>
            <input type="hidden" id="fab_des_id" name="fab_des_id" />
            <input type="hidden" id="fab_nature_id" name="fab_des_id" />
            <input type="hidden" id="construction" name="construction" />
            <input type="hidden" id="composition" name="composition" />
            <input type="hidden" id="fab_gsm" name="fab_gsm" />
            <input type="hidden" id="process_loss" name="process_loss" />
            <input type="hidden" id="fab_desctiption" name="fab_desctiption" />
            <input type="hidden" id="yarn_desctiption" name="yarn_desctiption" />
        </form>
	<?
	$composition_arr=array();
	$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count");
	$arr=array (0=>$item_category, 3=>$color_range,6=>$composition,8=>$lib_yarn_count,9=>$yarn_type);
	$sql="select a.fab_nature_id, a.construction, a.gsm_weight, a.color_range_id, a.stich_length, a.process_loss, b.copmposition_id, b.percent, b.count_id, b.type_id, a.id, b.id as bid from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.fab_nature_id=100 and a.is_deleted=0 order by a.id, b.id";
	$data_array=sql_select($sql);
	if (count($data_array)>0)
	{
		foreach( $data_array as $row )
		{
			if(array_key_exists($row[csf('id')],$composition_arr))
			{
				$composition_arr[$row[csf('id')]]=$composition_arr[$row[csf('id')]]." ".$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."% ".$lib_yarn_count[$row[csf('count_id')]]." ".$yarn_type[$row[csf('type_id')]].",";
			}
			else
			{
				$composition_arr[$row[csf('id')]]=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."% ".$lib_yarn_count[$row[csf('count_id')]]." ".$yarn_type[$row[csf('type_id')]].",";
			}
		}
	}
	?>
    <table class="rpt_table" width="950" cellspacing="0" cellpadding="0" border="0" rules="all">
        <thead>
            <tr>
                <th width="50">SL No</th>
                <th width="100">Fab Nature</th>
                <th width="100">Construction</th>
                <th width="100">GSM/Weight</th>
                <th width="100">Color Range</th>
                <th width="90">Stich Length</th>
                <th width="50">Process Loss</th>
                <th>Composition</th>
            </tr>
       </thead>
   </table>
   <div id="" style="max-height:300px; width:948px; overflow-y:scroll">
   <table id="list_view" class="rpt_table" width="930" height="" cellspacing="0" cellpadding="0" border="1" rules="all">
        <tbody>
		<?
        $sql_data=sql_select("select a.fab_nature_id, a.construction, a.gsm_weight, a.color_range_id, a.stich_length, a.process_loss, a.id from lib_yarn_count_determina_mst a,  lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.is_deleted=0 and a.fab_nature_id=100 $search_con group by a.id, a.fab_nature_id, a.construction, a.gsm_weight, a.color_range_id, a.stich_length, a.process_loss order by a.id");
         //echo "select a.fab_nature_id,a.construction,a.gsm_weight,a.color_range_id,a.stich_length,a.process_loss,a.id from  lib_yarn_count_determina_mst a,  lib_yarn_count_determina_dtls b where a.id=b.mst_id and  a.fab_nature_id= '$fabric_nature' and  a.is_deleted=0 $search_con group by a.id,a.fab_nature_id,a.construction,a.gsm_weight,a.color_range_id,a.stich_length,a.process_loss order by a.id";
        $i=1;
        foreach($sql_data as $row)
        {
            if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
            ?>
                <tr id="tr_<? echo $row[csf('id')] ?>" bgcolor="<? echo $bgcolor; ?>" height="20" style="cursor:pointer; word-break:break-all;" onClick="js_set_value('<? echo $row[csf('id')]."_".$row[csf('fab_nature_id')]."_".$row[csf('construction')]."_".$row[csf('gsm_weight')]."_".$row[csf('process_loss')] ?>')">
                    <td width="50"><? echo $i; ?></td>
                    <td width="100" align="left"><? echo $item_category[$row[csf('fab_nature_id')]]; ?></td>
                    <td width="100" align="left"><? echo $row[csf('construction')]; ?></td>
                    <td width="100" align="right"><? echo $row[csf('gsm_weight')]; ?></td>
                    <td width="100" align="left"><? echo $color_range[$row[csf('color_range_id')]]; ?></td>
                    <td width="90" align="right"><? echo $row[csf('stich_length')]; ?></td>
                    <td width="50" align="right"><? echo $row[csf('process_loss')]; ?></td>
                    <td><? echo $composition_arr[$row[csf('id')]]; ?></td>
                </tr>
            <?
            $i++;
        }
        ?>
        </tbody>
    </table>
	<script>
    //setFilterGrid("list_view",-1);
    //toggle( "tr_"+"<? //echo $libyarncountdeterminationid; ?>", '#FFFFCC');
    </script>
    </div>
    </div>
    </body>
    </html>
    <?
    exit();
}

if($action == 'save_update_delete_consumption_entry')
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process )); 
	
	$job_id=return_field_value("id", "wo_po_details_master", "job_no=$job_no");
	
	$materialReciveNo="";
	$sql=sql_select("select a.recv_number from inv_receive_master a, inv_transaction b, wo_po_break_down c where a.id=b.mst_id and b.job_no=c.job_no_mst and b.job_no=$job_no and a.entry_form=248 and c.is_confirmed=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by a.recv_number");
	foreach($sql as $row)
	{
		if($materialReciveNo=="") $materialReciveNo=$row[csf('recv_number')]; else $materialReciveNo.=','.$row[csf('recv_number')];
	}
	if($materialReciveNo!=""){
		echo "materialRecive**".$materialReciveNo;
		disconnect($con);die;
	}
	
	if ($operation==0)
	{
		if($db_type==0) mysql_query("BEGIN");
		$con = connect();
		
		if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0";disconnect($con); die;}
		
		$field_array = "id, job_id, pre_cost_fabric_cost_dtls_id, job_no, po_break_down_id, color_number_id, gmts_sizes, length, dia_width, length_sleeve, width_sleeve, item_size, cons, process_loss_percent, requirment, rate, amount, pcs, color_size_table_id, remarks, inserted_by, insert_date, status_active, is_deleted";
		$add_comma=0;
		$save_string = '';
		$id=return_next_id( "id", "wo_pre_cos_fab_co_avg_con_dtls", 1 ) ;
		for ($i=1;$i<=$total_row;$i++)
		{
			$ponoid="ponoid_".$i;
			$pocolorid="pocolorid_".$i;
			$gmtssizesid="gmtssizesid_".$i;
			$txtlengthbody="txtlengthbody_".$i;
			$txtdiawidthbody="txtdiawidthbody_".$i;
			$txtlengthsleeve="txtlengthsleeve_".$i;
			$txtdiawidthsleeve="txtdiawidthsleeve_".$i;
			
			$itemsizes="itemsizes_".$i;
			$cons="cons_".$i;
			$processloss="processloss_".$i;
			$requirement="requirement_".$i;
			$pcs="pcs_".$i;
			$colorsizetableid="colorsizetableid_".$i;
			$rate="rate_".$i;
			$amount="amount_".$i;
			$remarks="remarks_".$i;
			
			$txtlengthbody=str_replace("'","",$$txtlengthbody) ? $$txtlengthbody : 0;
			$txtdiawidthbody=str_replace("'","",$$txtdiawidthbody) ? $$txtdiawidthbody : 0;
			$txtlengthsleeve=str_replace("'","",$$txtlengthsleeve) ? $$txtlengthsleeve : 0;
			$txtdiawidthsleeve=str_replace("'","",$$txtdiawidthsleeve) ? $$txtdiawidthsleeve : 0;
			
			$itemsizes=str_replace("'","",$$itemsizes) ? $$itemsizes : 0;
			$cons=str_replace("'","",$$cons) ? $$cons : 0;
			$processloss=str_replace("'","",$$processloss) ? $$processloss : 0;
			$requirement=str_replace("'","",$$requirement) ? $$requirement : 0;
			$pcs=str_replace("'","",$$pcs) ? $$pcs : 0;
			$colorsizetableid=str_replace("'","",$$colorsizetableid) ? $$colorsizetableid : 0;
			$rate=str_replace("'","",$$rate) ? $$rate : 0;
			$amount=str_replace("'","",$$amount )? $$amount : 0;
			$remarks=str_replace("'","",$$remarks) ? str_replace("'","",$$remarks) : 'no remarks';
			
			if ($i!=1) $data_array .=",";
			$data_array .="(".$id.",".$job_id.",".$fabric_cost_id.",".$job_no.",".$$ponoid.",".$$pocolorid.",".$$gmtssizesid.",".$txtlengthbody.",".$txtdiawidthbody.",".$txtlengthsleeve.",".$txtdiawidthsleeve.",".$itemsizes.",".$cons.",".$processloss.",".$requirement.",".$rate.",".$amount.",".$pcs.",".$colorsizetableid.",'".$remarks."',".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."',1,0)";
			$id=$id+1;
		}
		$rID_de1=execute_query( "delete from wo_pre_cos_fab_co_avg_con_dtls where  pre_cost_fabric_cost_dtls_id =".$fabric_cost_id."",0);
		//check_table_status( $_SESSION['menu_id'],0);
		//echo "10**insert into wo_pre_cos_fab_co_avg_con_dtls (".$field_array.") values ".$data_array; check_table_status( $_SESSION['menu_id'],0); die;
		$rID=sql_insert("wo_pre_cos_fab_co_avg_con_dtls",$field_array,$data_array,1);
		//execute_query("update wo_pre_cost_fabric_cost_dtls set avg_cons=".$calculated_cons." where id =".$fabric_cost_id."",1);
		
		check_table_status( $_SESSION['menu_id'],0);
		if($db_type==2 || $db_type==1 )
		{
			if( $rID ){
				oci_commit($con);  
				echo "0**".$rID;
			}
			else{
				oci_rollback($con);
				echo "10**".$rID;;
			}
		}
		disconnect($con);
		die;
	}
}

if($action =="fabric_yarn_description")
{
	$fab_description="";
	$yarn_description="";
	$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count");

	$sql="select a.fab_nature_id,a.construction,a.gsm_weight,a.color_range_id,a.stich_length,a.process_loss,b.copmposition_id,b.percent,b.count_id,b.type_id,a.id from  lib_yarn_count_determina_mst a,  lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.fab_nature_id=100  and a.id=$data and  a.is_deleted=0 order by a.id,b.id";

	$data_array=sql_select($sql);
	if (count($data_array)>0)
	{
		foreach( $data_array as $row )
		{
			if($fab_description!="")
			{
				$fab_description=$fab_description." ".$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
			}
			else
			{
				$fab_description=$composition[$row[csf('copmposition_id')]]." ".$row[csf('percent')]."%";
			}

			if($yarn_description!="")
			{
				$yarn_description=$yarn_description."__".$row[csf('count_id')]."_".$row[csf('copmposition_id')]."_100_".$row[csf('type_id')]."_".$row[csf('percent')];
			}
			else
			{
				$yarn_description=$row[csf('count_id')]."_".$row[csf('copmposition_id')]."_100_".$row[csf('type_id')]."_".$row[csf('percent')];
			}
		}
	}
	echo $fab_description."**".$yarn_description;
	exit();
}

if($action=="rate_amount")
{
	$result="";
	$data_array=sql_select("select rate,amount from  wo_pre_cost_fabric_cost_dtls where id='$data'");
	foreach( $data_array as $row )
	{
	  $result=$row["rate"]."_".$row["amount"];
	}
	echo $result;
	exit();
}

if ($action=="consumption_popup")
{
    echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode,'','');
    extract($_REQUEST);
	$cons_breck_downn= $_SESSION['logic_erp']['cons_breck_downn'];
	//$msmnt_breack_downn= $_SESSION['logic_erp']['msmnt_breack_downn'];
	$marker_breack_down= $_SESSION['logic_erp']['marker_breack_down'];
	?>
	<script>
	/*var str_gmtssizes = [<?//=substr( return_library_autocomplete( "select size_name from lib_size where status_active=1 and is_deleted=0", "size_name" ), 0, -1); ?>];
	var str_diawidth = [<?//=substr( return_library_autocomplete( "select color_name from lib_color where status_active=1 and is_deleted=0", "color_name" ), 0, -1); ?>];*/
	
	var hid_fab_cons_in_quotation_variable='<?=$hid_fab_cons_in_quotation_variable; ?>';
	var uom='<?=$uom; ?>';
	
	function copy_value(value,field_id,i)
	{
		var copy_val=document.getElementById('copy_val').checked;
		var hid_fab_cons_in_quotation_variable=document.getElementById('hid_fab_cons_in_quotation_variable').value;
		var gmtssizesid=document.getElementById('gmtssizesid_'+i).value;
		var itemsizes=document.getElementById('itemsizes_'+i).value;
		var pocolorid=document.getElementById('pocolorid_'+i).value;
		var ponoid=document.getElementById('ponoid_'+i).value;
		var comcons=$("#txtcomcons").val()*1;
		var tot_plancut_qty=document.getElementById('tot_plancut_qty').value*1;
		var process_loss_method_id=document.getElementById('process_loss_method_id').value;
		var rowCount = $('#tbl_consmption_cost tr').length;
		var copy_basis=$('input[name="copy_basis"]:checked').val()
		//alert(process_loss_method_id)
		//alert(hid_fab_cons_in_quotation_variable); return;
		if(hid_fab_cons_in_quotation_variable==1)
		{
			var conssum=0; var processLossSum=0; var consreq=0; var ratesum=0; var amtsum=0; var calculated_cons=0; var avg_cons=0; var plancutqty=0; var calculated_amount=0; var significant_row=0; var totReqQty=0; var totamt=0;
			for(var j=i; j<=rowCount; j++)
			{
				var isDisabled = document.getElementById(field_id+j).disabled;
				if(isDisabled==false)
				{
					if(copy_val==true)
					{
						if(field_id=='itemsizes_')
						{
							if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value)
							{
								document.getElementById(field_id+j).value=value;
								//calculate_requirement(j);
							}
						}
					}
					if(field_id=='cons_' || field_id=='processloss_' || field_id=='remarks_')
					{
						if(copy_basis==1)
						{
							if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
						}
						else if(copy_basis==2)
						{
							if( pocolorid==document.getElementById('pocolorid_'+j).value) document.getElementById(field_id+j).value=value;
						}
						else if(copy_basis==3)
						{
							if( ponoid==document.getElementById('ponoid_'+j).value) document.getElementById(field_id+j).value=value;
						}
						else if(copy_val==true) document.getElementById(field_id+j).value=value;
							
						//if(field_id!='remarks_') calculate_requirement(j);
					}
					
					if(field_id=='rate_')
					{
						if(copy_basis==1)
						{
							if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0) document.getElementById(field_id+j).value=value;
						}
						else if(copy_basis==2)
						{
							if( pocolorid==document.getElementById('pocolorid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0) document.getElementById(field_id+j).value=value;
						}
						else if(copy_basis==3)
						{
							if( ponoid==document.getElementById('ponoid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0) document.getElementById(field_id+j).value=value;
						}
						else if(copy_val==true && (document.getElementById('requirement_'+j).value*1) >0) document.getElementById(field_id+j).value=value;
		
						//claculate_amount(j);
					}
				}
				
				/*var txtlengthbody=$("#txtlengthbody_"+j).val()*1;
				var txtdiawidthbody=$("#txtdiawidthbody_"+j).val()*1;
				
				var txtlengthsleeve=$("#txtlengthsleeve_"+j).val()*1;
				var txtdiawidthsleeve=$("#txtdiawidthsleeve_"+j).val()*1;*/
				var pcs=$("#pcs_"+j).val()*1;
				var processloss=$("#processloss_"+j).val()*1;
				if(processloss=="") processloss=0;
				processLossSum+=(processloss*1);
				
				var cnsrate=$("#rate_"+j).val()*1;
				if(cnsrate=="") cnsrate=0;
				ratesum+=(cnsrate*1);
				
				/*var lenth_width=(txtlengthbody*txtdiawidthbody)+(txtlengthsleeve*txtdiawidthsleeve); 
				var rowCons=number_format_common((lenth_width*comcons*pcs), 5, 0);*/
				var rowCons=document.getElementById('cons_'+j).value*1;
				if(rowCons=="") rowCons=0;
				conssum+=(rowCons*1);
				
				var WastageQty=0;
				
				if(process_loss_method_id==1)
				{
					WastageQty=(rowCons*1)+((rowCons*1)*((processloss*1)/100));
					//alert(WastageQty)
				}
				else if(process_loss_method_id==2)
				{
					var devided_val = 1-(processloss/100);
					var WastageQty=parseFloat(rowCons/devided_val);
				}
				else WastageQty=0;						
				
				var reqQty= number_format_common( WastageQty, 5, 0) ;
				consreq+=(WastageQty*1);
				//document.getElementById('processloss_'+j).value=processloss;
				document.getElementById('requirement_'+j).value= reqQty;
				
				significant_row=significant_row+1;
				var pcsgmts=document.getElementById('pcsgmts_'+j).value*1;
				plancutqty+=(pcsgmts*1);
				var plan_cut_percent=(pcsgmts/tot_plancut_qty)*100;
				
				var avg_cons_percent=(rowCons*plan_cut_percent)/100;
				//alert(avg_cons_percent)
				avg_cons+=avg_cons_percent;
				
				var requirement=WastageQty*1;
				var calculated_cons_percent=(requirement*plan_cut_percent)/100;
				calculated_cons+=calculated_cons_percent;
				
				var consamt=(WastageQty*1)*cnsrate;
				
				$("#amount_"+j).val( number_format_common((consamt*1), 4, 0) );
				
				amtsum+=consamt;
				var calculated_amount_percent=(consamt*plan_cut_percent)/100;
				calculated_amount+=calculated_amount_percent;
				
				var rowtotReq=(reqQty/pcs)*pcsgmts;
				$("#totqty_"+j).val( number_format_common((rowtotReq*1), 4, 0) );
				totReqQty+=(rowtotReq*1);
				
				var rowtotAmt=rowtotReq*cnsrate;
				$("#totamount_"+j).val( number_format_common((rowtotAmt*1), 4, 0) );
				totamt+=(rowtotAmt*1);
				//alert();
			}
			$("#cons_sum").val( number_format_common(conssum, 5, 0) );
			$("#processloss_sum").val( number_format_common(processLossSum, 5, 0) );
			$("#requirement_sum").val( number_format_common(consreq, 5, 0) );
			$("#rate_sum").val( number_format_common(ratesum, 5, 0) );
			$("#amount_sum").val( number_format_common(amtsum, 5, 0) );
			$("#totReq_sum").val( number_format_common(totReqQty, 5, 0) );
			$("#totAmount_sum").val( number_format_common(totamt, 5, 0) );
			
			var calculated_procloss=(processLossSum*1)/significant_row;
			var calculated_pcs=(document.getElementById('pcs_sum').value*1)/significant_row;
			document.getElementById('calculated_cons').value=number_format_common(calculated_cons, 5, 0);
			document.getElementById('avg_cons').value=number_format_common(avg_cons, 5, 0);
			document.getElementById('calculated_procloss').value=number_format_common(calculated_procloss, 5, 0);
			document.getElementById('calculated_pcs').value=calculated_pcs;
			document.getElementById('calculated_plancutqty').value=plancutqty;
			document.getElementById('calculated_amount').value=number_format_common(calculated_amount, 5, 0);
			document.getElementById('calculated_rate').value=number_format_common(calculated_amount/calculated_cons, 5, 0);
		}
	
		else if(hid_fab_cons_in_quotation_variable==2)
		{
			var conssum=0; var processLossSum=0; var consreq=0; var ratesum=0; var amtsum=0; var calculated_cons=0; var avg_cons=0; var plancutqty=0; var calculated_amount=0; var significant_row=0; var totReqQty=0; var totamt=0;
			for(var j=i; j<=rowCount; j++)
			{
				if(document.getElementById('approved_'+j).value==0)
				{
					if(copy_val==true)
					{
						if(field_id=='itemsizes_')
						{
							if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value)
							{
								document.getElementById(field_id+j).value=value;
								//calculate_measurement_top(j);
							}
						}
					}
					if(field_id=='txtlengthbody_' || field_id=='txtdiawidthbody_' || field_id=='txtlengthsleeve_' || field_id=='txtdiawidthsleeve_' || field_id=='rate_' || field_id=='processloss_' || field_id=='remarks_')
					{
						if(copy_basis==1)
						{
							if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
						}
						else if(copy_basis==2)
						{
							if( pocolorid==document.getElementById('pocolorid_'+j).value) document.getElementById(field_id+j).value=value;
						}
						else if(copy_basis==3)
						{
							if( ponoid==document.getElementById('ponoid_'+j).value) document.getElementById(field_id+j).value=value;
						}
						else if(copy_val==true) document.getElementById(field_id+j).value=value;
						
						/*if(field_id!='remarks_')
						{
							
							var widthbody =document.getElementById('txtdiawidthbody_'+j).value*1;
							
							if(widthbody) //For Faster Copy -6573 Aziz
							{
								//calculate_requirement(j);
								//calculate_measurement_top(j);
							}
						}*/
						var txtlengthbody=$("#txtlengthbody_"+j).val()*1;
						var txtdiawidthbody=$("#txtdiawidthbody_"+j).val()*1;
						
						var txtlengthsleeve=$("#txtlengthsleeve_"+j).val()*1;
						var txtdiawidthsleeve=$("#txtdiawidthsleeve_"+j).val()*1;
						var pcs=$("#pcs_"+j).val()*1;
						var processloss=$("#processloss_"+j).val()*1;
						if(processloss=="") processloss=0;
						processLossSum+=(processloss*1);
						
						var cnsrate=$("#rate_"+j).val()*1;
						if(cnsrate=="") cnsrate=0;
						ratesum+=(cnsrate*1);
						
						var lenth_width=(txtlengthbody*txtdiawidthbody)+(txtlengthsleeve*txtdiawidthsleeve); 
						var rowCons=number_format_common((lenth_width*comcons*pcs), 5, 0);
						document.getElementById('cons_'+j).value=rowCons;
						if(rowCons=="") rowCons=0;
						conssum+=(rowCons*1);
						
						var WastageQty=0;
						
						if(process_loss_method_id==1)
						{
							WastageQty=(rowCons*1)+((rowCons*1)*((processloss*1)/100));
							//alert(WastageQty)
						}
						else if(process_loss_method_id==2)
						{
							var devided_val = 1-(processloss/100);
							var WastageQty=parseFloat(rowCons/devided_val);
						}
						else WastageQty=0;						
						
						var reqQty= number_format_common( WastageQty, 5, 0) ;
						consreq+=(WastageQty*1);
						//document.getElementById('processloss_'+j).value=processloss;
						document.getElementById('requirement_'+j).value= reqQty;
						
						significant_row=significant_row+1;
						var pcsgmts=document.getElementById('pcsgmts_'+j).value*1;
						plancutqty+=(pcsgmts*1);
						var plan_cut_percent=(pcsgmts/tot_plancut_qty)*100;
						
						var avg_cons_percent=(rowCons*plan_cut_percent)/100;
						//alert(avg_cons_percent)
						avg_cons+=avg_cons_percent;
						
						var requirement=WastageQty*1;
						var calculated_cons_percent=(requirement*plan_cut_percent)/100;
						calculated_cons+=calculated_cons_percent;
						
						var consamt=(WastageQty*1)*cnsrate;
						
						$("#amount_"+j).val( number_format_common((consamt*1), 4, 0) );
						
						amtsum+=consamt;
						var calculated_amount_percent=(consamt*plan_cut_percent)/100;
						calculated_amount+=calculated_amount_percent;
						
						var rowtotReq=(reqQty/pcs)*pcsgmts;
						$("#totqty_"+j).val( number_format_common((rowtotReq*1), 4, 0) );
						totReqQty+=(rowtotReq*1);
						
						var rowtotAmt=rowtotReq*cnsrate;
						$("#totamount_"+j).val( number_format_common((rowtotAmt*1), 4, 0) );
						totamt+=(rowtotAmt*1);
					}
				}//if(document.getElementById('approved_'+j).value==0)
			}
			
			$("#cons_sum").val( number_format_common(conssum, 5, 0) );
			$("#processloss_sum").val( number_format_common(processLossSum, 5, 0) );
			$("#requirement_sum").val( number_format_common(consreq, 5, 0) );
			$("#rate_sum").val( number_format_common(ratesum, 5, 0) );
			$("#amount_sum").val( number_format_common(amtsum, 5, 0) );
			$("#totReq_sum").val( number_format_common(totReqQty, 5, 0) );
			$("#totAmount_sum").val( number_format_common(totamt, 5, 0) );
			
			var calculated_procloss=(processLossSum*1)/significant_row;
			var calculated_pcs=(document.getElementById('pcs_sum').value*1)/significant_row;
			document.getElementById('calculated_cons').value=number_format_common(calculated_cons, 5, 0);
			document.getElementById('avg_cons').value=number_format_common(avg_cons, 5, 0);
			document.getElementById('calculated_procloss').value=number_format_common(calculated_procloss, 5, 0);
			document.getElementById('calculated_pcs').value=calculated_pcs;
			document.getElementById('calculated_plancutqty').value=plancutqty;
			document.getElementById('calculated_amount').value=number_format_common(calculated_amount, 5, 0);
			document.getElementById('calculated_rate').value=number_format_common(calculated_amount/calculated_cons, 5, 0);
		}
		else if(hid_fab_cons_in_quotation_variable==3)
		{
			for(var j=i; j<=rowCount; j++)
			{
				if(document.getElementById('approved_'+j).value==0)
				{
					if(copy_val==true)
					{
						if(field_id=='diawidth_')
						{
							if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
						}
						if(field_id=='itemsizes_')
						{
							if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
						}
						calculate_requirement(j);
					}
					if(field_id=='cons_' || field_id=='processloss_' || field_id=='remarks_')
					{
						if(copy_basis==1)
						{
							if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
						}
						else if(copy_basis==2)
						{
							if( pocolorid==document.getElementById('pocolorid_'+j).value) document.getElementById(field_id+j).value=value;
						}
						else if(copy_basis==3)
						{
							if( ponoid==document.getElementById('ponoid_'+j).value) document.getElementById(field_id+j).value=value;
						}
						else if(copy_val==true) document.getElementById(field_id+j).value=value;
						
						if(field_id!='remarks_') calculate_requirement(j);
					}
				}//if(document.getElementById('approved_'+j).value==0)
			}
		}
	}

	function check_width_is_null_or_not(i)
	{
		var cbofabricnature_id=document.getElementById('cbofabricnature_id').value;
		if(cbofabricnature_id==3)
		{
			if(document.getElementById('diawidth_'+i).value=='' || document.getElementById('diawidth_'+i).value==0)
			{
				alert("Fill up Width")
				document.getElementById('diawidth_'+i).focus();
			}
		}
	}
	
	function set_sum_value(des_fil_id,field_id)
	{
		var ddd="";
		if(des_fil_id=='pcs_sum') ddd={dec_type:6,comma:0};
		else ddd={dec_type:5,comma:0};
		
		var rowCount = $('#tbl_consmption_cost tr').length;
		math_operation( des_fil_id, field_id, '+', rowCount,ddd );
		claculate_avg();
	}

	function js_set_value()
	{
		var body_part_id_type=document.getElementById('body_part_id_type').value;
		var cbofabricnature_id=document.getElementById('cbofabricnature_id').value;
		var cbofabricsource_id=document.getElementById('cbofabricsource_id').value;
		var hid_fab_cons_in_quotation_variable=document.getElementById('hid_fab_cons_in_quotation_variable').value;
		var rowCount = $('#tbl_consmption_cost tr').length;
		var cons_breck_down="";
		var msmnt_breack_down="";
		var marker_breack_down="";
		if(hid_fab_cons_in_quotation_variable==3)
		{
			if(form_validation('txt_marker_dia*txt_marker_yds*txt_marker_inch*txt_gmt_pcs*txt_marker_length_yds*txt_marker_gsm*txt_marker_net_fab_cons','Marker Dia*Marker Yds*Marker Inch*Gmt Pcs*Marker Length*Marker Gsm*Marker Net Fabric')==false)
			{
				return;
			}
			else
			{
				var txt_marker_dia=$('#txt_marker_dia').val();
				var txt_marker_yds=$('#txt_marker_yds').val();
				var txt_marker_inch=$('#txt_marker_inch').val();
				var txt_gmt_pcs=$('#txt_gmt_pcs').val();
				var txt_marker_length_yds=$('#txt_marker_length_yds').val();
				var txt_marker_net_fab_cons=$('#txt_marker_net_fab_cons').val();
				marker_breack_down+=txt_marker_dia+'_'+txt_marker_yds+'_'+txt_marker_inch+'_'+txt_gmt_pcs+'_'+txt_marker_length_yds+'_'+txt_marker_net_fab_cons;
			}
		}
		
		if(hid_fab_cons_in_quotation_variable==1)
		{
			var comlenth=comwidth=comlenthsl=comwidthsl=comcons=0;
			
			var comsizename=$('#txtcomsizename').val();
			if(comsizename=='') comsizename=0;
			var comsizecons=$('#txtcomsizecons').val();
			if(comsizecons=='') comsizecons=0;
			
			var sampleid=$('#hiddensampleid').val();
			if(sampleid=='') sampleid=0;
			
			msmnt_breack_down+=comsizename+'_'+comsizecons+'_'+comlenth+'_'+comwidth+'_'+comcons+'_'+comlenthsl+'_'+comwidthsl+'_'+sampleid;
		}
		else if(hid_fab_cons_in_quotation_variable==2)
		{
			var comsizename=$('#txtcomsizename').val();
			if(comsizename=='') comsizename=0;
			var comsizecons=$('#txtcomsizecons').val();
			if(comsizecons=='') comsizecons=0;
			var comlenth=$('#txtcomlenth').val();
			if(comlenth=='') comlenth=0;
			var comwidth=$('#txtcomwidth').val();
			if(comwidth=='') comwidth=0;
			
			var comlenthsl=$('#txtcomlenthsl').val();
			if(comlenthsl=='') comlenthsl=0;
			var comwidthsl=$('#txtcomwidthsl').val();
			if(comwidthsl=='') comwidthsl=0;
			
			var comcons=$('#txtcomcons').val();
			if(comcons=='') comcons=0;
			var sampleid=$('#hiddensampleid').val();
			if(sampleid=='') sampleid=0;
			
			msmnt_breack_down+=comsizename+'_'+comsizecons+'_'+comlenth+'_'+comwidth+'_'+comcons+'_'+comlenthsl+'_'+comwidthsl+'_'+sampleid;
		}
		
		for(var i=1; i<=rowCount; i++)
		{
			var ponoid=$('#ponoid_'+i).val();
				if(ponoid=='') ponoid=0;
			var pocolorid=$('#pocolorid_'+i).val();
				if(pocolorid=='') pocolorid=0;
			var gmtssizesid=$('#gmtssizesid_'+i).val();
				if(gmtssizesid=='') gmtssizesid=0;
			
			var txtlengthbody=txtdiawidthbody=txtlengthsleeve=txtdiawidthsleeve=0;
			if(hid_fab_cons_in_quotation_variable==2)	
			{
				var txtlengthbody=$('#txtlengthbody_'+i).val();
					if(txtlengthbody=='') txtlengthbody=0;
				var txtdiawidthbody=$('#txtdiawidthbody_'+i).val();
					if(txtdiawidthbody=='') txtdiawidthbody=0;
					
				var txtlengthsleeve=$('#txtlengthsleeve_'+i).val();
					if(txtlengthsleeve=='') txtlengthsleeve=0;
				var txtdiawidthsleeve=$('#txtdiawidthsleeve_'+i).val();
					if(txtdiawidthsleeve=='') txtdiawidthsleeve=0;
			}
				
			var itemsizes=$('#itemsizes_'+i).val();
				if(itemsizes=='') itemsizes=0;
			var cons=$('#cons_'+i).val();
				if(cons=='') cons=0;
			var processloss=$('#processloss_'+i).val();
				if(processloss=='') processloss=0;
			var requirement=$('#requirement_'+i).val();
				if(requirement=='') requirement=0;
			var pcs=$('#pcs_'+i).val();
				if(pcs=='') pcs=0;
			var colorsizetableid=$('#colorsizetableid_'+i).val();
				if(colorsizetableid=='') colorsizetableid=0;
	
			var rate=$('#rate_'+i).val();
				if(rate=='') rate=0;
			var amount=$('#amount_'+i).val();
				if(amount=='') amount=0;
	
			var remarks=$('#remarks_'+i).val();
				if(remarks=='') remarks='no remarks';
	
			if(cbofabricnature_id==3 && diawidth !='' && cons!='' && processloss=='' )
			{
				if(processloss=='' || processloss==0)
				{
					alert("Fill up  Process Loss")
					return;
				}
				if(cons=='' || cons==0)
				{
					alert("Fill up Cons")
					return;
				}
				if(diawidth=='' || diawidth==0)
				{
					alert("Fill up Width")
					return;
				}
			}
			
			//=======================================================
	
			if(cbofabricnature_id==2  && cons!='' && processloss=='')
			{
				alert("Fill up  Process Loss")
				return;
			}
			if(cbofabricnature_id==2  && cons=='' && (processloss*1)!='')
			{
				alert("Fill up Cons")
				return;
			}
			//========================================================
			if(cbofabricnature_id==2  && cons!=0 && (processloss*1) < 0 )
			{
				alert("Fill up  Process Loss")
				return;
			}
			if(cbofabricnature_id==2  && cons==0 && (processloss*1)!=0)
			{
				alert("Fill up Cons")
				return;
			}
	
			//======================================================
	
			if(cbofabricsource_id==2 && (cons*1) > 0 && rate==0){
				alert("Fill up Rate")
				return;
			}
	
			if(cons_breck_down=="")
			{
				cons_breck_down+=ponoid+'_'+pocolorid+'_'+gmtssizesid+'_'+txtdiawidthbody+'_'+itemsizes+'_'+cons+'_'+processloss+'_'+requirement+'_'+pcs+'_'+colorsizetableid+'_'+rate+'_'+amount+'_'+remarks+'_'+txtdiawidthbody+'_'+txtlengthsleeve+'_'+txtdiawidthsleeve;
			}
			else
			{
				cons_breck_down+="__"+ponoid+'_'+pocolorid+'_'+gmtssizesid+'_'+txtdiawidthbody+'_'+itemsizes+'_'+cons+'_'+processloss+'_'+requirement+'_'+pcs+'_'+colorsizetableid+'_'+rate+'_'+amount+'_'+remarks+'_'+txtdiawidthbody+'_'+txtlengthsleeve+'_'+txtdiawidthsleeve;
			}
		}
		document.getElementById('cons_breck_down').value=cons_breck_down;
		document.getElementById('msmnt_breack_down').value=msmnt_breack_down;
		document.getElementById('marker_breack_down').value=marker_breack_down;
		claculate_avg();
	
		parent.emailwindow.hide();
	}

	function save_consumption_entry_data(operation)
	{
		freeze_window(operation);
		var hid_fab_cons_in_quotation_variable=document.getElementById('hid_fab_cons_in_quotation_variable').value;
		var rowCount = $('#tbl_consmption_cost tbody tr').length;
		var data_all="";
		if(hid_fab_cons_in_quotation_variable==1)
		{
			data_all+=get_submitted_data_string('txtcomsizename*txtcomsizecons*avg_cons*calculated_cons*calculated_rate*calculated_amount',"../../../");
		}
		if(hid_fab_cons_in_quotation_variable==2)
		{
			data_all+=get_submitted_data_string('txtcomsizename*txtcomsizecons*txtcomlenth*txtcomwidth*txtcomcons*avg_cons*calculated_cons*calculated_rate*calculated_amount',"../../../");
		}
		var z=1;
		for(var i=1; i<=rowCount; i++)
		{
			//data_all=data_all+get_submitted_data_string('job_no*fabric_cost_id*calculated_cons*ponoid_'+i+'*pocolorid_'+i+'*gmtssizesid_'+i+'*txtlengthbody_'+i+'*txtdiawidthbody_'+i+'*txtlengthsleeve_'+i+'*txtdiawidthsleeve_'+i+'*itemsizes_'+i+'*cons_'+i+'*processloss_'+i+'*requirement_'+i+'*pcs_'+i+'*colorsizetableid_'+i+'*rate_'+i+'*amount_'+i+'*remarks_'+i,"../../../",i);
			if(hid_fab_cons_in_quotation_variable==1)
			{
				data_all+="&ponoid_" + z + "='" + $('#ponoid_'+i).val()+"'"+"&pocolorid_" + z + "='" + $('#pocolorid_'+i).val()+"'"+"&gmtssizesid_" + z + "='" + $('#gmtssizesid_'+i).val()+"'"+"&itemsizes_" + z + "='" + $('#itemsizes_'+i).val()+"'"+"&cons_" + z + "='" + $('#cons_'+i).val()+"'"+"&processloss_" + z + "='" + $('#processloss_'+i).val()+"'"+"&requirement_" + z + "='" + $('#requirement_'+i).val()+"'"+"&pcs_" + z + "='" + $('#pcs_'+i).val()+"'"+"&colorsizetableid_" + z + "='" + $('#colorsizetableid_'+i).val()+"'"+"&rate_" + z + "='" + $('#rate_'+i).val()+"'"+"&amount_" + z + "='" + $('#amount_'+i).val()+"'"+"&remarks_" + z + "='" + $('#remarks_'+i).val()+"'";
				z++;
			}
			if(hid_fab_cons_in_quotation_variable==2)
			{
				data_all+="&ponoid_" + z + "='" + $('#ponoid_'+i).val()+"'"+"&pocolorid_" + z + "='" + $('#pocolorid_'+i).val()+"'"+"&gmtssizesid_" + z + "='" + $('#gmtssizesid_'+i).val()+"'"+"&txtlengthbody_" + z + "='" + $('#txtlengthbody_'+i).val()+"'"+"&txtdiawidthbody_" + z + "='" + $('#txtdiawidthbody_'+i).val()+"'"+"&txtlengthsleeve_" + z + "='" + $('#txtlengthsleeve_'+i).val()+"'"+"&txtdiawidthsleeve_" + z + "='" + $('#txtdiawidthsleeve_'+i).val()+"'"+"&itemsizes_" + z + "='" + $('#itemsizes_'+i).val()+"'"+"&cons_" + z + "='" + $('#cons_'+i).val()+"'"+"&processloss_" + z + "='" + $('#processloss_'+i).val()+"'"+"&requirement_" + z + "='" + $('#requirement_'+i).val()+"'"+"&pcs_" + z + "='" + $('#pcs_'+i).val()+"'"+"&colorsizetableid_" + z + "='" + $('#colorsizetableid_'+i).val()+"'"+"&rate_" + z + "='" + $('#rate_'+i).val()+"'"+"&amount_" + z + "='" + $('#amount_'+i).val()+"'"+"&remarks_" + z + "='" + $('#remarks_'+i).val()+"'";
				z++;
			}
		}
		
		//var data='action=save_consumption_entry&operation='+operation+'&total_row='+rowCount+data_all;
		//var data='action=save_update_delete_consumption_entry&operation='+operation+'&total_row='+rowCount+data_all;
		
		var data="action=save_update_delete_consumption_entry&operation="+operation+'&total_row='+rowCount+get_submitted_data_string('job_no*fabric_cost_id*calculated_cons',"../../../")+data_all;
		
		//alert(data); return;
		http.open("POST","pre_cost_entry_controller_v2.php",true);
		http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
		http.send(data);
		http.onreadystatechange = function (){
		if(http.readyState == 4)
		{
			var reponse=trim(http.responseText).split('**');
				if(trim(reponse[0])=='materialRecive'){
					alert("Yarn Receive Found :"+trim(reponse[1])+"\n So Update/Delete Not Possible")
					release_freezing();
					return;
				 }
				if(reponse[0]==0){
					show_msg(reponse[0]);
					release_freezing(); 
					js_set_value();
				}else{
					alert("Not Saved. Problem Found")
				}
			}
		};
	}

	function calculate_measurement_top(i)
	{
		var body_part_id_type=document.getElementById('body_part_id_type').value;
		var cbofabricnature_id=document.getElementById('cbofabricnature_id').value;
		var cbo_costing_per_id=document.getElementById('cbo_costing_per_id').value;
		var hid_fab_cons_in_quotation_variable=document.getElementById('hid_fab_cons_in_quotation_variable').value;
		
		if (cbo_costing_per_id==1) var dzn_mult=1*12;
		else if (cbo_costing_per_id==2) var dzn_mult=1*1;
		else if (cbo_costing_per_id==3) var dzn_mult=2*12;
		else if (cbo_costing_per_id==4) var dzn_mult=3*12;
		else if (cbo_costing_per_id==5) var dzn_mult=4*12;
		else dzn_mult=0;
	
	//------------------------------------Knit------------------------------------
		if(cbofabricnature_id==2)//Knit
		{
			var txt_required_gsm_top=(document.getElementById('txt_gsm').value)*1;
			if (body_part_id_type==1)//main fabric top
			{
				var txt_body_length_measurement_top=0; var txt_body_length_sewing_top=0; var txt_body_length_hem_top=0; var txt_sleeve_length_measurement_top=0; var txt_sleeve_length_sewing_top=0; var txt_sleeve_length_hem_top=0; var txt_chest_measurement_top=0; var txt_chest_sew_top=0;
				
				txt_body_length_measurement_top=(document.getElementById('bodylength_'+i).value)*1;
				txt_body_length_sewing_top=(document.getElementById('bodysewingmargin_'+i).value)*1;
				txt_body_length_hem_top=(document.getElementById('bodyhemmargin_'+i).value)*1;
				txt_sleeve_length_measurement_top=(document.getElementById('sleevelength_'+i).value)*1;
				txt_sleeve_length_sewing_top=(document.getElementById('sleevesewingmargin_'+i).value)*1;
				txt_sleeve_length_hem_top=(document.getElementById('sleevehemmargin_'+i).value)*1;
				txt_chest_measurement_top=(document.getElementById('chestlenght_'+i).value)*1;
				txt_chest_sew_top=(document.getElementById('chestsewingmargin_'+i).value)*1;
				//[{(Body Lentg +Sleeve Lenth + Sewing Margin + Hem) x (Half Chest + Sewing Margin)} x 2] x 12 x GSM / 10000000
				var dbl_total=(((txt_body_length_measurement_top +txt_sleeve_length_measurement_top+txt_body_length_sewing_top + txt_sleeve_length_sewing_top+txt_body_length_hem_top+txt_sleeve_length_hem_top) * (txt_chest_measurement_top + txt_chest_sew_top)) * 2) * 12 * txt_required_gsm_top / 10000000;
			}
			if (body_part_id_type==20)//main fabric bottom
			{
				var txt_front_rise_measurement_bottom=0; var txt_front_rise_sewing_bottom=0; var txt_west_band_measurement_bottom=0; var txt_west_band_sewing_bottom=0; var txt_in_seam_measurement_bottom=0; var txt_in_seam_sew_bottom=0; var txt_in_seam_hem_bottom=0; var txt_half_thai_measurement_bottom=0; var txt_half_thai_sew_bottom=0;
				
				var txt_front_rise_measurement_bottom=(document.getElementById('frontriselength_'+i).value)*1;
				var txt_front_rise_sewing_bottom=(document.getElementById('frontrisesewingmargin_'+i).value)*1;
				var txt_west_band_measurement_bottom=(document.getElementById('westbandlength_'+i).value)*1;
				var txt_west_band_sewing_bottom=(document.getElementById('westbandsewingmargin_'+i).value)*1;
				var txt_in_seam_measurement_bottom=(document.getElementById('inseamlength_'+i).value)*1;
				var txt_in_seam_sew_bottom=(document.getElementById('inseamsewingmargin_'+i).value)*1;
				var txt_in_seam_hem_bottom=document.getElementById('inseamhemmargin_'+i).value;
				var txt_half_thai_measurement_bottom=(document.getElementById('halfthailength_'+i).value)*1;
				var txt_half_thai_sew_bottom=(document.getElementById('halfthaisewingmargin_'+i).value)*1;
				//[{(Front Rise + In Seam + West Band + Sewing Margin + Hem) x (Half Thai + Sewing Margin)} x 4] x 12  x GSM / 10000000
				var dbl_total=(((txt_front_rise_measurement_bottom +txt_west_band_measurement_bottom +txt_in_seam_measurement_bottom+txt_front_rise_sewing_bottom + txt_west_band_sewing_bottom+txt_in_seam_sew_bottom+txt_in_seam_hem_bottom) * (txt_half_thai_measurement_bottom+txt_half_thai_sew_bottom)) * 4) * 12  * txt_required_gsm_top/ 10000000;
			}
		}
	//------------------------------------End Knit------------------------------------
	//----------------------------------- Woven---------------------------------------
		else if(cbofabricnature_id==3)//woven
		{
			var txt_required_weight_top=document.getElementById('diawidth_'+i).value;
			if (body_part_id_type==1)//main fabric top
			{
				var txt_body_length_measurement_top=0; var txt_body_length_sewing_top=0; var txt_body_length_hem_top=0; var txt_sleeve_length_measurement_top=0; var txt_sleeve_length_sewing_top=0; var txt_sleeve_length_hem_top=0; var txt_chest_measurement_top=0; var txt_chest_sew_top=0;
				
				txt_body_length_measurement_top=document.getElementById('bodylength_'+i).value;
				txt_body_length_sewing_top=document.getElementById('bodysewingmargin_'+i).value;
				txt_body_length_hem_top=document.getElementById('bodyhemmargin_'+i).value;
				txt_sleeve_length_measurement_top=document.getElementById('sleevelength_'+i).value;
				txt_sleeve_length_sewing_top=document.getElementById('sleevesewingmargin_'+i).value;
				txt_sleeve_length_hem_top=document.getElementById('sleevehemmargin_'+i).value;
				txt_chest_measurement_top=document.getElementById('chestlenght_'+i).value;
				txt_chest_sew_top=document.getElementById('chestsewingmargin_'+i).value;
				//[{(Body Lentg +Sleeve Lenth + Sewing Margin + Hem) x (Half Chest + Sewing Margin)} x 2] x 12 / (Width x 36)
				var dbl_total=(((txt_body_length_measurement_top*1)+(txt_body_length_sewing_top*1)+(txt_body_length_hem_top*1)+(txt_sleeve_length_measurement_top*1)+(txt_sleeve_length_sewing_top*1)+(txt_sleeve_length_hem_top*1))*((txt_chest_measurement_top*1)+(txt_chest_sew_top*1))*2*(dzn_mult*1))/((txt_required_weight_top*1)*36);
	
			}
			if (body_part_id_type==20)//main fabric bottom
			{
				var txt_front_rise_measurement_bottom=0; var txt_front_rise_sewing_bottom=0; var txt_west_band_measurement_bottom=0; var txt_west_band_sewing_bottom=0; var txt_in_seam_measurement_bottom=0; var txt_in_seam_sew_bottom=0; var txt_in_seam_hem_bottom=0; var txt_half_thai_measurement_bottom=0; var txt_half_thai_sew_bottom=0;
				
				var txt_front_rise_measurement_bottom=document.getElementById('frontriselength_'+i).value;
				var txt_front_rise_sewing_bottom=document.getElementById('frontrisesewingmargin_'+i).value;
				var txt_west_band_measurement_bottom=document.getElementById('westbandlength_'+i).value;
				var txt_west_band_sewing_bottom=document.getElementById('westbandsewingmargin_'+i).value;
				var txt_in_seam_measurement_bottom=document.getElementById('inseamlength_'+i).value;
				var txt_in_seam_sew_bottom=document.getElementById('inseamsewingmargin_'+i).value;
				var txt_in_seam_hem_bottom=document.getElementById('inseamhemmargin_'+i).value;
				var txt_half_thai_measurement_bottom=document.getElementById('halfthailength_'+i).value;
				var txt_half_thai_sew_bottom=document.getElementById('halfthaisewingmargin_'+i).value;
				//[{(Front Rise + In Seam + West Band + Sewing Margin + Hem) x (Half Thai + Sewing Margin)} x 4] x 12  / Width x 36
				var dbl_total=(((txt_front_rise_measurement_bottom*1)+(txt_front_rise_sewing_bottom*1)+(txt_west_band_measurement_bottom*1)+(txt_west_band_sewing_bottom*1)+(txt_in_seam_measurement_bottom*1)+(txt_in_seam_sew_bottom*1)+(txt_in_seam_hem_bottom*1))*((txt_half_thai_measurement_bottom*1)+(txt_half_thai_sew_bottom*1))*4*(dzn_mult*1))/((txt_required_weight_top*1)*36);
	
			}
		}
		//----------------------------------- End Woven---------------------------------------
		//----------------------------------- Sweater---------------------------------------
		else if(cbofabricnature_id==100)//Sweater
		{
			var comcons=$("#txtcomcons").val()*1;
			if (hid_fab_cons_in_quotation_variable==2)//Consumption Basis
			{
				var txtlengthbody=0; var txtdiawidthbody=0; var txtlengthsleeve=0; var txtdiawidthsleeve=0; var pcs=0; var lenth_width=0;
				txtlengthbody=$("#txtlengthbody_"+i).val()*1;
				txtdiawidthbody=$("#txtdiawidthbody_"+i).val()*1;
				
				txtlengthsleeve=$("#txtlengthsleeve_"+i).val()*1;
				txtdiawidthsleeve=$("#txtdiawidthsleeve_"+i).val()*1;
				pcs=$("#pcs_"+i).val()*1;
				lenth_width=(txtlengthbody*txtdiawidthbody)+(txtlengthsleeve*txtdiawidthsleeve); 
				
				var dbl_total=(lenth_width*comcons*pcs);
			}
		}
		//----------------------------------- End Sweater---------------------------------------
		dbl_total= number_format_common( dbl_total, 5, 0);
		//document.getElementById('totalcons_'+i).value=dbl_total;
		if(dbl_total)
		{
		document.getElementById('cons_'+i).value=dbl_total;
		//set_sum_value( 'cons_sum', 'cons_'  );
		//set_sum_value( 'requirement_sum', 'requirement_' );
		//calculate_requirement(i);
		//claculate_avg();
		}
		
	}

	function calculate_requirement(i)
	{
		//alert(i)
		var process_loss_method_id=document.getElementById('process_loss_method_id').value;
		var cons=(document.getElementById('cons_'+i).value)*1;
		if(cons=="") cons=0;
		//if(cons)
		//{
		var processloss=(document.getElementById('processloss_'+i).value)*1;
		if(processloss=="") processloss=0;
		
		var WastageQty='';
		if(process_loss_method_id==1)
		{
			WastageQty=cons+cons*(processloss/100);
		}
		else if(process_loss_method_id==2)
		{
			var devided_val = 1-(processloss/100);
			var WastageQty=parseFloat(cons/devided_val);
		}
		else WastageQty=0;
		
		WastageQty= number_format_common( WastageQty, 5, 0) ;
		document.getElementById('processloss_'+i).value=processloss;
		document.getElementById('requirement_'+i).value= WastageQty;
		set_sum_value( 'requirement_sum', 'requirement_' );
		claculate_amount(i);
		claculate_avg();
		//}
		
	}
	
	function claculate_avg()
	{
		var tot_plancut_qty=document.getElementById('tot_plancut_qty').value*1
		var item_ratio=document.getElementById('item_ratio').value*1
		var calculated_cons=0; var avg_cons=0; var plancutqty=0; var calculated_amount=0; var significant_row=0;
		var rowCount = $('#tbl_consmption_cost tr').length;
	
		for(var j=1; j<=rowCount; j++){
			if(document.getElementById('cons_'+j).value =='' || document.getElementById('cons_'+j).value ==0){
				continue;
			}
			else{
				plancutqty+=document.getElementById('pcsgmts_'+j).value*1;
				
				significant_row=significant_row+1;
				var pcsgmts=document.getElementById('pcsgmts_'+j).value*1
				//var plan_cut_percent=(pcsgmts/plancutqty)*100;
				var plan_cut_percent=(pcsgmts/tot_plancut_qty)*100;
	
				var cons=document.getElementById('cons_'+j).value*1
				var avg_cons_percent=(cons*plan_cut_percent)/100;
				avg_cons+=avg_cons_percent;
	
				var requirement=document.getElementById('requirement_'+j).value*1
				var calculated_cons_percent=(requirement*plan_cut_percent)/100;
				calculated_cons+=calculated_cons_percent;
	
				var amount=document.getElementById('amount_'+j).value*1
				var calculated_amount_percent=(amount*plan_cut_percent)/100;
				calculated_amount+=calculated_amount_percent;
			}
		}
	
		/*
		for(var i=1; i<=rowCount; i++){
			if(document.getElementById('cons_'+i).value =='' || document.getElementById('cons_'+i).value ==0){
				continue;
			}
			else{
				significant_row=significant_row+1;
				var pcsgmts=document.getElementById('pcsgmts_'+i).value*1
				//var plan_cut_percent=(pcsgmts/plancutqty)*100;
				var plan_cut_percent=(pcsgmts/tot_plancut_qty)*100;
	
				var cons=document.getElementById('cons_'+i).value*1
				var avg_cons_percent=(cons*plan_cut_percent)/100;
				avg_cons+=avg_cons_percent;
	
				var requirement=document.getElementById('requirement_'+i).value*1
				var calculated_cons_percent=(requirement*plan_cut_percent)/100;
				calculated_cons+=calculated_cons_percent;
	
				var amount=document.getElementById('amount_'+i).value*1
				var calculated_amount_percent=(amount*plan_cut_percent)/100;
				calculated_amount+=calculated_amount_percent;
			}
		}*/
		var calculated_procloss=(document.getElementById('processloss_sum').value*1)/significant_row;
		var calculated_pcs=(document.getElementById('pcs_sum').value*1)/significant_row;
		//document.getElementById('calculated_cons').value=number_format_common(calculated_cons*item_ratio, 5, 0);
		document.getElementById('calculated_cons').value=number_format_common(calculated_cons, 5, 0);
		document.getElementById('avg_cons').value=number_format_common(avg_cons, 5, 0);
		document.getElementById('calculated_procloss').value=number_format_common(calculated_procloss, 5, 0);
		document.getElementById('calculated_pcs').value=calculated_pcs;
		document.getElementById('calculated_plancutqty').value=plancutqty;
		//document.getElementById('calculated_plancutqty').value=tot_plancut_qty/item_ratio;
		//document.getElementById('calculated_amount').value=number_format_common(calculated_amount*item_ratio, 5, 0);
		document.getElementById('calculated_amount').value=number_format_common(calculated_amount, 5, 0);
		document.getElementById('calculated_rate').value=number_format_common(calculated_amount/calculated_cons, 5, 0);
	}
	
	function calculate_marker_length()
	{
		var cbo_costing_per_id=document.getElementById('cbo_costing_per_id').value;
		
		if (cbo_costing_per_id==1) var dzn_mult=1*12;
		else if (cbo_costing_per_id==2) var dzn_mult=1*1;
		else if (cbo_costing_per_id==3) var dzn_mult=2*12;
		else if (cbo_costing_per_id==4) var dzn_mult=3*12;
		else if (cbo_costing_per_id==5) var dzn_mult=4*12;
		else dzn_mult=0;
		
		var txt_marker_yds= (document.getElementById('txt_marker_yds').value)*1;
		var txt_marker_inch= (document.getElementById('txt_marker_inch').value)*1;
		var txt_gmt_pcs= (document.getElementById('txt_gmt_pcs').value)*1;
		var txt_marker_dia= (document.getElementById('txt_marker_dia').value)*1;
		var txt_marker_gsm= (document.getElementById('txt_marker_gsm').value)*1;
	
		var txt_marker_length_yds=(txt_marker_inch/36)+txt_marker_yds;
		//alert(txt_marker_length_yds);
		var txt_marker_length_yds2=(txt_marker_length_yds/txt_gmt_pcs)*dzn_mult;
		txt_marker_length_yds3= number_format_common( txt_marker_length_yds2, 5, 0) ;
		document.getElementById('txt_marker_length_yds').value=txt_marker_length_yds3;
		var txt_marker_net_fab_cons=((txt_marker_length_yds3*36*2.54)/dzn_mult)*(txt_marker_dia*2*2.54*dzn_mult*txt_marker_gsm);
		var txt_marker_net_fab_cons2=txt_marker_net_fab_cons/10000000;
		document.getElementById('txt_marker_net_fab_cons').value=number_format_common(txt_marker_net_fab_cons2,5,0);
		//document.getElementById('cons_1').value=number_format_common(txt_marker_net_fab_cons2,1,0);
		copy_value(number_format_common(txt_marker_net_fab_cons2,5,0),'cons_',1);
	}
	
	function claculate_amount(i)
	{
		var rate=document.getElementById('rate_'+i).value;
		if(rate=="") rate=0;
		var requirement=document.getElementById('requirement_'+i).value;
		if(requirement=="") requirement=0;
		//if(requirement)
		//{
		var plan_cut_qty=document.getElementById('pcsgmts_'+i).value*1;
		if(plan_cut_qty=="") plan_cut_qty=0;
		var pcs=document.getElementById('pcs_'+i).value*1;
		if(pcs=="") pcs=0;
	
		var rowtotReq=(requirement/pcs)*plan_cut_qty;
		var amount= requirement*rate;
		var rowtotAmt=rowtotReq*rate;
		document.getElementById('amount_'+i).value=number_format_common(amount,5,0);
		document.getElementById('totqty_'+i).value=number_format_common(rowtotReq,5,0);
		document.getElementById('totamount_'+i).value=number_format_common(rowtotAmt,5,0);
		set_sum_value( 'amount_sum', 'amount_' );
		set_sum_value( 'totReq_sum', 'totqty_');
		set_sum_value( 'totAmount_sum', 'totamount_');
		claculate_avg();
		//}
		
	}

	function stripePopup(i){
		var job_no='<? echo $txt_job_no?>';
		var cbogmtsitem='<? echo $cbogmtsitem?>';
		var fabric_cost_id='<? echo $pre_cost_fabric_cost_dtls_id?>';
		var ponoid=$('#ponoid_'+i).val();
		var cbo_color_name=$('#pocolorid_'+i).val();
		var gmtssizesid=$('#gmtssizesid_'+i).val();
		var requirement=$('#requirement_'+i).val();
		var lenth=$("#txtlengthbody_"+i).val()*1;
		var width=$("#txtdiawidthbody_"+i).val()*1;
		var cbo_company_id=$('#cbo_company_id').val();
		var page_link='stripe_color_measurement_controller_sweater.php?action=open_stripe_popup&txt_job_no='+job_no+'&cbogmtsitem='+cbogmtsitem+'&fabric_cost_id='+fabric_cost_id+'&cbo_color_name='+cbo_color_name+'&gmtssizesid='+gmtssizesid+'&ponoid='+ponoid+'&requirement='+requirement+'&cbo_company_id='+cbo_company_id+'&lenth='+lenth+'&width='+width;
		emailwindow=dhtmlmodal.open('EmailBox', 'iframe', page_link, 'Stripe Color Info', 'width=650px,height=300px,center=1,resize=1,scrolling=0','../../')
		emailwindow.onclose=function()
		{
		}
	}

	function fnc_sample_popup()
	{
		var job_no='<? echo $txt_job_no?>';
		var cbo_company_id=$('#cbo_company_id').val();
		var page_link='pre_cost_entry_controller_v2.php?action=sample_popup&txt_job_no='+job_no+'&cbo_company_id='+cbo_company_id+'&uom='+uom;
		emailwindow=dhtmlmodal.open('EmailBox', 'iframe', page_link, 'Size Sample Info', 'width=800px,height=300px,center=1,resize=1,scrolling=0','../../')
		emailwindow.onclose=function()
		{
			var theform=this.contentDoc.forms[0];
			var samplesize=this.contentDoc.getElementById("samplesize_breakdown").value;
			var size_kg=samplesize.split('_');
			var sample_id=size_kg[0];
			var sample_size=size_kg[1];
			var sample_kg=size_kg[2];
			if (samplesize!="")
			{
				$('#hiddensampleid').val( sample_id );
				$('#txtcomsizename').val( sample_size );
				$('#txtcomsizecons').val( sample_kg );
				if(hid_fab_cons_in_quotation_variable==2) fnc_common_size_cons();
			}
		}
	}

	function fnc_common_size_cons()
	{
		var comsizecons=$('#txtcomsizecons').val()*1;
		var comlenth=$('#txtcomlenth').val()*1;
		var comwidth=$('#txtcomwidth').val()*1;
		
		var txtcomlenthsl=$('#txtcomlenthsl').val()*1;
		var txtcomwidthsl=$('#txtcomwidthsl').val()*1;
		
		var comn_cons=comsizecons/((comlenth*comwidth)+(txtcomlenthsl*txtcomwidthsl));
		$('#txtcomcons').val( number_format(comn_cons,8,'.','' ) );
	}
	
	function open_stripe_color_popup()
	{
		var txt_job_no='<?=$txt_job_no; ?>';
		var cbogmtsitem='<?=$cbogmtsitem; ?>';
		var fabric_cost_id='<?=$pre_cost_fabric_cost_dtls_id; ?>';
		var cbo_company_id=$('#cbo_company_id').val();
		var index_page=$('#index_page', window.parent.document).val();
		var permission = '<?=$permission; ?>';
		var bomfyarn_approval_id='<?=$bomfyarn_approval_id; ?>';
		
		var page_link="../stripe_color_measurement_sweater.php?permission="+permission+'&txt_job_no='+txt_job_no+'&index_page='+index_page+'&permission='+permission+'&bomfyarn_approval_id='+bomfyarn_approval_id;
		emailwindow=dhtmlmodal.open('EmailBox', 'iframe', page_link, "Stripe Color Details", 'width=1030px,height=400px,center=1,resize=1,scrolling=0','../../')
		emailwindow.onclose=function()
		{
		}
	}
</script>
</head>
<body>
<div align="left" style="width:95%;">
<div style="display:none;"><?=load_freeze_divs ("../../../",$permission); ?></div>
    <fieldset>
    	<div align="center" style="width:100%;">
            <legend><?=$body_part_id.'.'.$body_part[$body_part_id].' Costing '.$costing_per[$cbo_costing_per].'; Cons Basis: '.$consumtion_basis[$hid_fab_cons_in_quotation_variable]; ?> </legend>
        	<form id="consumptionform_1" autocomplete="off">
            <input type="hidden" id="cbo_company_id" name="cbo_company_id" value="<?=$cbo_company_id; ?>"/>
            <input type="hidden" id="cbo_costing_per_id" name="cbo_costing_per_id" value="<?=$cbo_costing_per; ?>"/>
            <input type="hidden" id="hid_fab_cons_in_quotation_variable" name="hid_fab_cons_in_quotation_variable" value="<?=$hid_fab_cons_in_quotation_variable; ?>" />
            <input type="hidden" id="body_part_id_type" name="body_part_id_type" value="<?=$body_part_id_type; ?>"/>
            <input type="hidden" id="cbofabricnature_id" name="cbofabricnature_id" value="<?=$cbofabricnature_id; ?>"/>
            <input type="hidden" id="cbofabricsource_id" name="cbofabricsource_id" value="<?=$cbofabricsource; ?>"/>
            <input type="hidden" id="cons_breck_down" name="cons_breck_down" value="<?=$cons_breck_downn;?>"/>
            <input type="hidden" id="msmnt_breack_down" name="msmnt_breack_down" value="<?=$msmnt_breack_downn;?>"/>
            <input type="hidden" id="marker_breack_down" name="marker_breack_down" value="<?=$marker_breack_down;?>"/>
            <input type="hidden" id="txt_gsm" name="txt_gsm" value="<?=$txtgsmweight; ?>"/>
            
            <input type="hidden" id="job_no" name="job_no" value="<?=$txt_job_no; ?>"/>
            <input type="hidden" id="cbogmtsitem" name="cbogmtsitem" value="<?=$cbogmtsitem; ?>"/>
            <input type="hidden" id="fabric_cost_id" name="fabric_cost_id" value="<? echo $pre_cost_fabric_cost_dtls_id; ?>"/>
            
            <b>Copy</b> : <input type="checkbox" id="copy_val" name="copy_val" checked/>
            <form>
                <input type="radio" name="copy_basis" value="1">Size Wise
                <input type="radio" name="copy_basis" value="2">Color Wise
                <input type="radio" name="copy_basis" value="3">Po Wise
                <input type="reset" value="Reset">
                <?
				if($hid_fab_cons_in_quotation_variable==1)//Cad Basis
				{
					$ex_msmt_data=explode('_',$msmnt_breack_downn);
					?>
                    <table width="200" cellspacing="0" border="1" class="rpt_table" rules="all" align="center">
                        <thead>
                            <tr>
                                <th width="60">Size Name </th>
                                <th width="80">Size Cons.</th>
                                <th>Uom</th>
                            </tr>
                        </thead>
                        <tr>
                            <td width="60">
                                <input type="text" id="txtcomsizename" name="txtcomsizename" class="text_boxes" style="width:48px" placeholder="Browse" value="<?=$ex_msmt_data[0]; ?>" onDblClick="fnc_sample_popup();" readonly >
                                <input type="hidden" id="hiddensampleid" name="hiddensampleid" value="<?=$ex_msmt_data[7]; ?>"/>
                            </td>
                            <td width="80"><input type="text" id="txtcomsizecons" name="txtcomsizecons" class="text_boxes_numeric" style="width:68px" placeholder="Display" value="<?=$ex_msmt_data[1]; ?>" readonly></td>
                            <td><?=$unit_of_measurement[$uom]; ?></td>
                        </tr>
                    </table>
					<?
				}
				if($hid_fab_cons_in_quotation_variable==2)//Measurement Basis
				{
					$ex_msmt_data=explode('_',$msmnt_breack_downn);
					?>
                    <table width="500" cellspacing="0" border="1" class="rpt_table" rules="all" align="center">
                        <thead>
                            <tr>
                                <th width="60" rowspan="2">Size Name</th>
                                <th width="80" rowspan="2">Size Cons.</th>
                                <th width="60" rowspan="2">Uom</th>
                                <th colspan="2">Body</th>
                                <th colspan="2">Sleeve</th>
                                <th rowspan="2">&nbsp;</th>
                            </tr>
                            <tr>
                                <th width="50">Length</th>
                                <th width="50">Width</th>
                                <th width="50">Length</th>
                                <th width="50">Width</th>
                            </tr>
                        </thead>
                        <tr>
                            <td width="60">
                                <input type="text" id="txtcomsizename" name="txtcomsizename" class="text_boxes" style="width:48px" placeholder="Browse" value="<? echo $ex_msmt_data[0]; ?>" onDblClick="fnc_sample_popup();" readonly >
                                <input type="hidden" id="hiddensampleid" name="hiddensampleid" value="<? echo $ex_msmt_data[7]; ?>"/>
                            </td>
                            <td width="80"><input type="text" id="txtcomsizecons" name="txtcomsizecons" class="text_boxes_numeric" style="width:68px" placeholder="Display" onBlur="fnc_common_size_cons();" value="<? echo $ex_msmt_data[1]; ?>" readonly></td>
                            <td width="60" <? if($bomfyarn_approval_id==1) { echo "disabled";} else{ echo "";}?>><? echo $unit_of_measurement[$uom]; ?></td>
                            <td width="50"><input type="text" id="txtcomlenth" name="txtcomlenth" class="text_boxes_numeric" style="width:38px" placeholder="Write" onBlur="fnc_common_size_cons();" value="<? echo $ex_msmt_data[2]; ?>" <? if($bomfyarn_approval_id==1) { echo "disabled";} else{ echo "";}?>></td>
                            <td width="50"><input type="text" id="txtcomwidth" name="txtcomwidth" class="text_boxes_numeric" style="width:38px" placeholder="Write" onBlur="fnc_common_size_cons();" value="<? echo $ex_msmt_data[3]; ?>" <? if($bomfyarn_approval_id==1) { echo "disabled";} else{ echo "";}?>></td>
                            <td width="50"><input type="text" id="txtcomlenthsl" name="txtcomlenthsl" class="text_boxes_numeric" style="width:38px" placeholder="Write" onBlur="fnc_common_size_cons();" value="<? echo $ex_msmt_data[5]; ?>" <? if($bomfyarn_approval_id==1) { echo "disabled";} else{ echo "";}?>></td>
                            <td width="50"><input type="text" id="txtcomwidthsl" name="txtcomwidthsl" class="text_boxes_numeric" style="width:38px" placeholder="Write" onBlur="fnc_common_size_cons();" value="<? echo $ex_msmt_data[6]; ?>" <? if($bomfyarn_approval_id==1) { echo "disabled";} else{ echo "";}?>></td>
                            <td><input type="text" id="txtcomcons" name="txtcomcons" class="text_boxes_numeric" style="width:68px" placeholder="Display" readonly value="<? echo $ex_msmt_data[4]; ?>" ></td>
                        </tr>
                    </table>
					<?
				}?>
            </form>
        </div>
		
		<?
        $component_approved=0;
        $sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=1 and job_no='$txt_job_no'");
        foreach($sql as $row){
            if($row[csf('approved')]==1 || $row[csf('approved')]==3) { $component_approved=1; }
        }
        $arr_bo_app_po=array();
        $sql_bo_app_po=sql_select("select a.is_approved, b.pre_cost_fabric_cost_dtls_id, b.po_break_down_id from wo_booking_mst a, wo_booking_dtls b where  a.booking_no=b.booking_no and  b.job_no='$txt_job_no' and a.booking_type=1 and a.is_short=2 and a.is_approved in(1,3)  and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 group by b.pre_cost_fabric_cost_dtls_id,a.is_approved,b.po_break_down_id");
        foreach($sql_bo_app_po as $row_bo_app_po)
        {
            $is_approved=$row_bo_app_po[csf('is_approved')];
            if($is_approved==3) $is_approved=1; else $is_approved=$is_approved;
            
            $arr_bo_app_po[$row_bo_app_po[csf('po_break_down_id')]][$row_bo_app_po[csf('pre_cost_fabric_cost_dtls_id')]]	= $is_approved;
        }

        $pcs_value=0;
        $set_item_ratio=return_field_value("set_item_ratio", "wo_po_details_mas_set_details", "job_no='$txt_job_no'  and gmts_item_id='$cbogmtsitem'");
        if($set_item_ratio==0 || $set_item_ratio=="") $set_item_ratio=1;

        if($cbo_costing_per==1) $pcs_value=1*12*$set_item_ratio;
        else if($cbo_costing_per==2) $pcs_value=1*1*$set_item_ratio;
        else if($cbo_costing_per==3) $pcs_value=2*12*$set_item_ratio;
        else if($cbo_costing_per==4) $pcs_value=3*12*$set_item_ratio;
        else if($cbo_costing_per==5) $pcs_value=4*12*$set_item_ratio;
		//echo $pcs_value;
        if($body_part_id_type==50) $pcs_value=$pcs_value*2;

        $tot_plancut_qty=array(); $job_plancut_qty=0;
        $data_array_tot_po_qty=sql_select("select b.id, b.po_number, c.item_number_id, c.order_quantity, c.plan_cut_qnty as plan_cut_qnty from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and b.id=c.po_break_down_id and b.job_no_mst='$txt_job_no' and a.garments_nature='$garments_nature' and a.status_active=1 and b.status_active=1 and c.status_active=1 and c.is_deleted=0");// and c.item_number_id='$cbogmtsitem'
        foreach($data_array_tot_po_qty as $po_row )
        {
			if($budgeton==1)
			{
				$tot_plancut_qty[$po_row[csf('item_number_id')]]+=$po_row[csf('order_quantity')];
				$job_plancut_qty+=$po_row[csf('order_quantity')];
			}
			else
			{
				$tot_plancut_qty[$po_row[csf('item_number_id')]]+=$po_row[csf('plan_cut_qnty')];
				$job_plancut_qty+=$po_row[csf('plan_cut_qnty')];
			}
        }
		unset($data_array_tot_po_qty);

		$mandatory_sql=sql_select("select variable_list, process_loss_method, item_category_id, consumption_basis from variable_order_tracking where status_active=1 and variable_list in (18,103) and company_name=$cbo_company_id");
		$process_loss_method=0; $qcconsfrom=2;
		foreach($mandatory_sql as $row){
			if($row[csf('variable_list')]==18 && $row[csf('item_category_id')]==100) $process_loss_method=$row[csf('process_loss_method')];
			if($row[csf('variable_list')]==103) $qcconsfrom=$row[csf('consumption_basis')];
		}
        ?>
       <input type="hidden" id="process_loss_method_id" name="process_loss_method_id" value="<?=$process_loss_method; ?>"/>
       <input type="hidden" id="tot_plancut_qty" name="tot_plancut_qty" value="<?=$tot_plancut_qty[$cbogmtsitem]; ?>"/>
       <input type="hidden" id="job_plancut_qty" name="job_plancut_qty" value="<?=$job_plancut_qty; ?>"/>
       <input type="hidden" id="item_ratio" name="item_ratio" value="<?=$set_item_ratio; ?>"/>
       <? //echo $hid_fab_cons_in_quotation_variable;
		if($hid_fab_cons_in_quotation_variable==3)
		{
			?>
            <table width="800" cellspacing="0" class="rpt_table" border="0" id="tbl_marker_cost" rules="all">
                <thead>
                    <tr>
                        <th width="100" rowspan="2">Marker Dia (Inch)</th>
                        <th width="100" colspan="2">Marker Length</th>
                        <th width="110" rowspan="2">Gmts. Size Ratio (Pcs)</th>
                        <th width="90" rowspan="2">Marker Length -Yds (1Dzn Gmts)</th>
                        <th width="110" rowspan="2">GSM</th>
                        <th width="110" rowspan="2">Net Fab Cons</th>
                        <th>&nbsp;</th>
                    </tr>
                    <tr>
                        <th width="100">Yds</th>
                        <th width="100">Inch</th>
                        <th>&nbsp;</th>
                    </tr>
                </thead>
                <tbody>
					<? $marker_breack_down_arr=explode("_",$marker_breack_down); ?>
                    <tr>
                        <td><input type="text" id="txt_marker_dia" name="txt_marker_dia" class="text_boxes_numeric" style="width:90px" onChange="calculate_marker_length();" value="<? echo $marker_breack_down_arr[0]; ?>" <? if($bomfyarn_approval_id==1) { echo "disabled";} else{ echo "";}?>> </td>
                        <td><input type="text" id="txt_marker_yds"  name="txt_marker_yds" class="text_boxes_numeric" style="width:90px"  onChange="calculate_marker_length();" value="<? echo $marker_breack_down_arr[1]; ?>" <? if($bomfyarn_approval_id==1) { echo "disabled";} else{ echo "";}?>></td>
                        <td><input type="text" id="txt_marker_inch"  name="txt_marker_inch" class="text_boxes_numeric" style="width:90px" onChange="calculate_marker_length();"  value="<? echo $marker_breack_down_arr[2]; ?>" <? if($bomfyarn_approval_id==1) { echo "disabled";} else{ echo "";}?>></td>
                        <td><input type="text" id="txt_gmt_pcs"  name="txt_gmt_pcs" class="text_boxes_numeric" style="width:110px" onChange="calculate_marker_length();" value="<? echo $marker_breack_down_arr[3]; ?>" <? if($bomfyarn_approval_id==1) { echo "disabled";} else{ echo "";}?>></td>
                        <td><input type="text" id="txt_marker_length_yds"  name="txt_marker_length_yds" class="text_boxes_numeric" style="width:110px" readonly value="<? echo $marker_breack_down_arr[4]; ?>" <? if($bomfyarn_approval_id==1) { echo "disabled";} else{ echo "";}?>></td>
                        <td><input type="text" id="txt_marker_gsm"  name="txt_marker_gsm" class="text_boxes_numeric" readonly style="width:110px" value="<? echo $txtgsmweight; ?>" <? if($bomfyarn_approval_id==1) { echo "disabled";} else{ echo "";}?>></td>
                        <td><input type="text" id="txt_marker_net_fab_cons"  name="txt_marker_net_fab_cons" class="text_boxes_numeric" style="width:110px" value="<? echo $marker_breack_down_arr[5]; ?>" <? if($bomfyarn_approval_id==1) { echo "disabled";} else{ echo "";}?>></td>
                        <td>&nbsp;</td>
                    </tr>
                </tbody>
            </table>
        <?
        }


		if($bomfyarn_approval_id==1) $disabled="disabled"; else $disabled="";
		
		if($hid_fab_cons_in_quotation_variable==1) $tblWidth="1000"; else if($hid_fab_cons_in_quotation_variable==2) $tblWidth="1200"; else $tblWidth="1000";
        ?>
		
        <table width="<?=$tblWidth; ?>" cellspacing="0" class="rpt_table" border="0" rules="all">
            <thead>
                <tr>
                    <th width="30" rowspan="2">SL</th>
                    <th width="100" rowspan="2">PO NO</th>
                    <th width="80" rowspan="2">Color</th>
                    <th width="50" rowspan="2">Gmts Size</th>
                     <? if($hid_fab_cons_in_quotation_variable==2) { ?>
                    <th width="100" colspan="2">Body</th>
                    <th width="100" colspan="2">Sleeve</th>
                    <? } ?>
                    <th width="50" rowspan="2">Item Size</th>
                    <th width="70" rowspan="2">Finish Cons <?="(". $unit_of_measurement[$uom].")"; ?></th>
                    <th width="50" rowspan="2">Process Loss %</th>
                    <th width="70" rowspan="2">Actual Cons <?="(". $unit_of_measurement[$uom].")"; ?></th>
                    <th width="60" rowspan="2">Rate</th>
                    <th width="70" rowspan="2">Amount</th>
                    <th width="50" rowspan="2">Pcs</th>
                    <th width="70" rowspan="2">Total Qty</th>
                    <th width="70" rowspan="2">Total Amount</th>
                    <th width="100" rowspan="2">Remarks</th>
                    <th rowspan="2">&nbsp;</th>
                </tr>
                 <? if($hid_fab_cons_in_quotation_variable==2) { ?>
                <tr>
                	<th width="50">Length</th>
                    <th width="50">Width</th>
                    <th width="50">Length</th>
                    <th width="50">Width</th>
                </tr>
                <? } ?>
            </thead>
        </table>
        <div style="max-height:280px; overflow-y:scroll; width:<?=$tblWidth+20; ?>px"  align="left" id="scroll_body">
            <table width="<?=$tblWidth; ?>" cellspacing="0" class="rpt_table" border="0" id="tbl_consmption_cost" rules="all">
                 <tbody>
                    <?
					$po_no_library=return_library_array( "select id, po_number from wo_po_break_down where job_no_mst ='$txt_job_no'", "id", "po_number");
					$data_array=explode("__",$cons_breck_downn);
					if($data_array[0]=="")
					{
						$data_array=array();
					}
					
					$qcdata=""; //echo $qcconsfrom;
					if($qcconsfrom<1)
					{
						if($pri_fab_cost_dtls_id !="")
						{
							$sql_price_quatation=sql_select("select gmts_sizes, dia_width, cons, process_loss_percent, requirment, rate, amount from  wo_pri_quo_fab_co_avg_con_dtls where wo_pri_quo_fab_co_dtls_id=$pri_fab_cost_dtls_id");
							
							foreach($sql_price_quatation as $row)
							{
								$price_quatation_dia[$row[csf('gmts_sizes')]]=$row[csf('dia_width')];
								$price_quatation_cons[$row[csf('gmts_sizes')]]=$row[csf('cons')];
								$price_quatation_cons_process_loss[$row[csf('gmts_sizes')]]=$row[csf('process_loss_percent')];
								$price_quatation_requirment[$row[csf('gmts_sizes')]]=$row[csf('requirment')];
								$price_quatation_rate[$row[csf('gmts_sizes')]]=$row[csf('rate')];
								$price_quatation_amount[$row[csf('gmts_sizes')]]=$row[csf('amount')];
							}
							unset($sql_price_quatation);
						}
					}
					else
					{
						if($pri_fab_cost_dtls_id !="")
						{
							$sql_qc="select id as quotdtlsid, consumption, rate, value as amount, ex_percent, tot_cons from qc_cons_rate_dtls where id='$pri_fab_cost_dtls_id' and type=1 and tot_cons>0 and status_active=1 and is_deleted=0";
							
							$sql_qc_arr=sql_select($sql_qc);
							
							foreach($sql_qc_arr as $row)
							{
								if($uom==12)//KG
								{
									if($qcconsfrom==1)
									{
										$qcdata=($row[csf('consumption')]*0.453592).'_0_'.($row[csf('consumption')]*0.453592).'_0_0';
									}
									else if($qcconsfrom==2)
									{
										$qcdata=($row[csf('consumption')]*0.453592).'_'.$row[csf('ex_percent')].'_'.($row[csf('tot_cons')]*0.453592).'_0_0';
									}
									else if($qcconsfrom==3)
									{
										$qcdata=($row[csf('tot_cons')]*0.453592).'_0_'.($row[csf('tot_cons')]*0.453592).'_0_0';
									}
								}
								else if($uom==15)//Lbs
								{
									if($qcconsfrom==1)
									{
										$qcdata=$row[csf('consumption')].'_0_'.$row[csf('consumption')].'_0_0';
									}
									else if($qcconsfrom==2)
									{
										$qcdata=$row[csf('consumption')].'_'.$row[csf('ex_percent')].'_'.$row[csf('tot_cons')].'_0_0';
									}
									else if($qcconsfrom==3)
									{
										$qcdata=$row[csf('tot_cons')].'_0_'.$row[csf('tot_cons')].'_0_0';
									}
								}
							}
						}
					}

					//Oracle
					$data_array=sql_select("select b.id, b.po_number, b.po_quantity, b.shipment_date, min(c.id) as color_size_table_id, min(color_order) as color_order, min(size_order) as size_order, c.color_number_id, c.size_number_id, sum(c.order_quantity) as order_quantity, sum(c.plan_cut_qnty) as plan_cut_qnty from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id  and b.job_no_mst='$txt_job_no' and c.item_number_id='$cbogmtsitem' and a.garments_nature='$garments_nature' and a.status_active=1 and b.status_active=1 and c.status_active=1 and c.is_deleted=0 group by b.id, b.po_number, b.po_quantity, b.shipment_date, c.color_number_id, c.size_number_id order by b.id, color_order, size_order");
					
					//=======================================
					if($pre_cost_fabric_cost_dtls_id != "")
					{
						$is_booking_arr=array();
						$data_arr=sql_select("select a.is_approved, a.entry_form, b.is_short, b.pre_cost_fabric_cost_dtls_id from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and b.job_no ='$txt_job_no' and b.booking_type='1' and a.is_deleted=0 and a.status_active=1 and b.status_active=1 and b.is_deleted=0 group by a.is_approved, a.entry_form, b.is_short, b.pre_cost_fabric_cost_dtls_id");
						//$is_booking=count($data_arr);
						foreach($data_arr as $row)
						{
							if($row[csf('entry_form')]==108 || $row[csf('is_short')]==1 || $row[csf('is_approved')]==1)
							{
								$is_booking_arr[$row[csf('po_break_down_id')]]=$row[csf('pre_cost_fabric_cost_dtls_id')];
							}
						}
						unset($data_arr);
						
						$row_arr_data="";
						$wo_pre_cos_fab_co_avg_con_dtls_data=sql_select("select  id, po_break_down_id, color_number_id, gmts_sizes, length, dia_width, length_sleeve, width_sleeve, item_size, cons, process_loss_percent, requirment, pcs, color_size_table_id, rate, amount, remarks from wo_pre_cos_fab_co_avg_con_dtls where job_no='$txt_job_no' and pre_cost_fabric_cost_dtls_id=$pre_cost_fabric_cost_dtls_id order by id");//po_break_down_id,color_size_table_id
						//echo "select  id,po_break_down_id,color_number_id,gmts_sizes,dia_width,item_size,cons,process_loss_percent,requirment,pcs,color_size_table_id  from wo_pre_cos_fab_co_avg_con_dtls where job_no='$txt_job_no' and pre_cost_fabric_cost_dtls_id=$pre_cost_fabric_cost_dtls_id order by id";
						foreach($wo_pre_cos_fab_co_avg_con_dtls_data as $fab_co_avg_row)
						{
							$data_array_cons[$fab_co_avg_row[csf('color_size_table_id')]]=$fab_co_avg_row[csf('po_break_down_id')]."_".$fab_co_avg_row[csf('color_number_id')]."_".$fab_co_avg_row[csf('gmts_sizes')]."_".$fab_co_avg_row[csf('dia_width')]."_".$fab_co_avg_row[csf('item_size')]."_".$fab_co_avg_row[csf('cons')]."_".$fab_co_avg_row[csf('process_loss_percent')]."_".$fab_co_avg_row[csf('requirment')]."_".$fab_co_avg_row[csf('pcs')]."_".$fab_co_avg_row[csf('color_size_table_id')]."_".$fab_co_avg_row[csf('rate')]."_".$fab_co_avg_row[csf('amount')]."_".$fab_co_avg_row[csf('remarks')]."_".$fab_co_avg_row[csf('length')]."_".$fab_co_avg_row[csf('length_sleeve')]."_".$fab_co_avg_row[csf('width_sleeve')];
						}
					}
					if($pre_cost_fabric_cost_dtls_id == "")
					{
						$data_array_cons=explode("__",$cons_breck_downn);
					}
					//=======================================
					if(count($data_array)>0)
					{
						$i=0;
						foreach( $data_array as $row )
						{
							if($pre_cost_fabric_cost_dtls_id != "") $data=explode('_',$data_array_cons[$row[csf('color_size_table_id')]]); 
							else $data=explode('_',$data_array_cons[$i]);
							//print_r($qcdata);
							if($data[0]=='' && $pri_fab_cost_dtls_id !="")
							{
								//echo $qcdata;
								$exdata=explode("_",$qcdata);
								
								$data[5]=number_format($exdata[0],4);
								$data[6]=$exdata[1];
								$data[7]=number_format($exdata[2],4);
								$data[10]=number_format($exdata[3],4);
								$data[11]=number_format($exdata[4],4);
							}
							
							$cons_up=0;
							if($precostapproved==1 || $arr_bo_app_po[$row[csf('id')]][$pre_cost_fabric_cost_dtls_id]==1 || $component_approved==1 || $is_booking_arr[$row[csf('id')]]!="" || $is_booking_arr[$row[csf('id')]]!=0)//$is_booking>0
							{
								$disabled=1; if($is_booking_arr[$row[csf('id')]]!="" || $is_booking_arr[$row[csf('id')]]!=0) $cons_up=1;
							}
							else $disabled=0;
							$i++;
							
							$planPoQty=0;
							
							if($budgeton==1) $planPoQty=$row[csf('order_quantity')]; else $planPoQty=$row[csf('plan_cut_qnty')];
							
							$RowtotReq=0; $RowtotAmt=0;
							$RowtotReq=number_format(($data[7]/$pcs_value)*$planPoQty,4,".","");
							
							$totReq+=$RowtotReq;
							$RowtotAmt=number_format($RowtotReq*$data[10],4,".","");
							$totAmt+=$RowtotAmt;
							?>
							<tr id="break_<?=$i; ?>" align="center">
                                <td width="30"><?=$i; ?></td>
                                <td width="100">
                                    <input type="text" id="pono_<?=$i; ?>" name="pono_<?=$i; ?>" class="text_boxes" style="width:88px" value="<?=$row[csf('po_number')]; ?>" readonly />
                                    <input type="hidden" id="ponoid_<?=$i; ?>" name="ponoid_<?=$i; ?>" class="text_boxes" style="width:85px" value="<?=$row[csf('id')]; ?>" readonly />
                                </td>
                                <td width="80">
                                    <input type="text" id="pocolor_<?=$i; ?>" name="pocolor_<?=$i; ?>" class="text_boxes" style="width:68px" value="<?=$color_library[$row[csf('color_number_id')]]; ?>" readonly />
                                    <input type="hidden" id="pocolorid_<?=$i; ?>" name="pocolorid_<?=$i; ?>" class="text_boxes" style="width:65px" value="<?=$row[csf('color_number_id')]; ?>" readonly/>
                                </td>
                                <td width="50">
                                    <input type="text" id="gmtssizes_<?=$i; ?>" name="gmtssizes_<?=$i; ?>" class="text_boxes" style="width:38px" value="<?=$size_library[$row[csf('size_number_id')]]; ?>" readonly>
                                    <input type="hidden" id="gmtssizesid_<?=$i; ?>" name="gmtssizesid_<?=$i; ?>" class="text_boxes" style="width:35px" value="<?=$row[csf('size_number_id')]; ?>" readonly />
                                </td>
                                <? if($hid_fab_cons_in_quotation_variable==2) { ?>
                                <td width="50"><input type="text" id="txtlengthbody_<?=$i; ?>" name="txtlengthbody_<?=$i; ?>" class="text_boxes_numeric" style="width:38px" value="<?=$data[13]; ?>" onChange="copy_value(this.value,'txtlengthbody_',<?=$i; ?>);" <? if($disabled==1){ echo "disabled";} else{ echo "";} ?> <? if($bomfyarn_approval_id==1) { echo "disabled";} else{ echo "";}?>></td>
                                <td width="50">
                                	<input type="text" id="txtdiawidthbody_<?=$i; ?>" value="<? if($data[3]==""){echo $price_quatation_dia[$row[csf('size_number_id')]];}else{ echo $data[3];} ?>" name="txtdiawidthbody_<?=$i; ?>" class="<? if($cbofabricnature_id==2){echo "text_boxes"; }else{ echo "text_boxes_numeric";}?>" style="width:38px" onChange="copy_value(this.value,'txtdiawidthbody_',<?=$i; ?>);" <? if($disabled==1){ echo "disabled";} else{ echo "";} ?> <? if($bomfyarn_approval_id==1) { echo "disabled";} else{ echo "";}?> />
                                </td>
                                <td width="50"><input type="text" id="txtlengthsleeve_<?=$i; ?>" name="txtlengthsleeve_<?=$i; ?>" class="text_boxes_numeric" style="width:38px" value="<?=$data[14]; ?>" onChange="copy_value(this.value,'txtlengthsleeve_',<?=$i; ?>);" <? if($disabled==1){ echo "disabled";} else{ echo "";} ?> <? if($bomfyarn_approval_id==1) { echo "disabled";} else{ echo "";}?>></td>
                                <td width="50">
                                	<input type="text" id="txtdiawidthsleeve_<?=$i; ?>" value="<? if($data[3]==""){echo $price_quatation_dia[$row[csf('size_number_id')]];}else{ echo $data[15];} ?>" name="txtdiawidthsleeve_<?=$i; ?>" class="<? if($cbofabricnature_id==2){echo "text_boxes"; }else{ echo "text_boxes_numeric";}?>" style="width:38px" onChange="copy_value(this.value,'txtdiawidthsleeve_',<?=$i; ?>);"<? if($disabled==1){ echo "disabled";} else{ echo "";} ?>  <? if($bomfyarn_approval_id==1) { echo "disabled";} else{ echo "";}?>/>
                                </td>
                                 <? } ?>
                                <td width="50">
                                	<input type="text" id="itemsizes_<?=$i; ?>"  name="itemsizes_<?=$i; ?>" class="text_boxes" style="width:38px" onChange="copy_value(this.value,'itemsizes_',<?=$i; ?>);" value="<?=$data[4]; ?>" <? if($disabled==1){ echo "disabled";} else{ echo "";} ?> <? if($bomfyarn_approval_id==1) { echo "disabled";} else{ echo "";}?> >
                                </td>
                                <td width="70">
                                	<input type="text" id="cons_<?=$i; ?>" onChange="copy_value(this.value,'cons_',<?=$i; ?>);" name="cons_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" <? if(($hid_fab_cons_in_quotation_variable==2 || $hid_fab_cons_in_quotation_variable==3)){ echo "readonly";} else{ echo "";} ?> value="<? if ($data[5]==""){echo $price_quatation_cons[$row[csf('size_number_id')]];} else {echo $data[5];} ?>" <? if($cons_up==1) { echo "disabled";} else{ echo "";} if($disabled==1){ echo "disabled";} else{ echo "";} ?> <? if($bomfyarn_approval_id==1) { echo "disabled";} else{ echo "";}?> />
                                </td>
                                <td width="50">
                                	<input type="text" id="processloss_<?=$i; ?>" name="processloss_<?=$i; ?>" class="text_boxes_numeric" style="width:38px" onChange="copy_value(this.value,'processloss_',<?=$i; ?>);" value="<? if ($data[6]==""){echo $price_quatation_cons_process_loss[$row[csf('size_number_id')]];} else{echo $data[6];} ?>" <? if($disabled==1){ echo "disabled";} else{ echo "";} ?> <? if($bomfyarn_approval_id==1) { echo "disabled";} else{ echo "";}?>/>
                                </td>
                                <td width="70">
                                	<input type="text" id="requirement_<?=$i; ?>" name="requirement_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="<? if ($data[7]==""){ echo $price_quatation_requirment[$row[csf('size_number_id')]];} else { echo $data[7]; } ?>" readonly />
                                </td>
                                <td width="60">
                                	<input type="text" id="rate_<?=$i; ?>" name="rate_<?=$i; ?>" onChange="copy_value(this.value,'rate_',<?=$i; ?>);" class="text_boxes_numeric" style="width:48px"  value="<? if($data[10]==""){echo $price_quatation_rate[$row[csf('size_number_id')]];}else { echo $data[10];}  ?>" <? if($cons_up==1) { echo "disabled";} else{ echo "";} ?>  <? if($bomfyarn_approval_id==1) { echo "disabled";} else{ echo "";}?>/>
                                </td>
                                <td width="70">
                                	<input type="text" id="amount_<?=$i; ?>" name="amount_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="<? if($data[11]==""){echo $price_quatation_amount[$row[csf('size_number_id')]];}else { echo $data[11];} ?>" readonly />
                                </td>
                                <td width="50">
                                    <input type="text" id="pcs_<?=$i; ?>" name="pcs_<?=$i; ?>" class="text_boxes_numeric" style="width:38px" value="<?=$pcs_value; ?>" readonly>
                                    <input type="hidden" id="pcsgmts_<?=$i; ?>" name="pcsgmts_<?=$i; ?>" class="text_boxes_numeric" style="width:35px"  value="<?=$planPoQty; ?>">
                                </td>
                                <td width="70">
                                	<input type="text" id="totqty_<?=$i; ?>" name="totqty_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="<?=$RowtotReq; ?>" readonly  />
                                </td>
                                <td width="70">
                                	<input type="text" id="totamount_<?=$i; ?>" name="totamount_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="<?=$RowtotAmt; ?>" readonly />
                                </td>
                                <td width="100">
                                	<input type="text" id="remarks_<?=$i; ?>" name="remarks_<?=$i; ?>" onChange="copy_value(this.value,'remarks_',<?=$i; ?>)"  class="text_boxes" style="width:88px" value="<?=$data[12]; ?>" >
                                </td>
                                <td id="add_<?=$i;?>">
                                    <input type="hidden" id="colorsizetableid_<?=$i; ?>" name="colorsizetableid_<?=$i; ?>" class="text_boxes" style="width:30px" value="<?=$row[csf('color_size_table_id')]; ?>" readonly/>
                                    <input type="hidden" id="stripe_<?=$i;?>" style="width:30px" class="formbutton" value="S" onClick="javascript:stripePopup(<?=$i; ?>);"/>
                                    <input type="hidden" id="approved_<?=$i; ?>"  name="approved_<?=$i; ?>" class="text_boxes_numeric" style="width:30px" value="<?=$disabled; ?>">
                                </td>
							</tr>
							<?
						}
					}
					?>
                </tbody>
            </table>
        </div>
        <table width="<?=$tblWidth; ?>" cellspacing="0" class="rpt_table" border="0" rules="all">
            <tfoot>
            	<tr>
                    <th width="30">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                    <th width="80">&nbsp;</th>
                    <th width="50">&nbsp;</th>
                     <? if($hid_fab_cons_in_quotation_variable==2) { ?>
                    <th width="50">&nbsp;</th><!--Lenth-->
                    <th width="50">&nbsp;</th><!--Width-->
                    <th width="50">&nbsp;</th><!--Lenth-->
                    <th width="50">&nbsp;</th><!--Width-->
                    <? } ?>
                    <th width="50">SUM :</th>
                    <th width="70"><input type="text" id="cons_sum" name="cons_sum" class="text_boxes_numeric" style="width:58px" readonly></th>
                    <th width="50"><input type="text" id="processloss_sum" name="processloss_sum" class="text_boxes_numeric" style="width:38px" readonly></th>
                    <th width="70"><input type="text" id="requirement_sum" name="requirement_sum" class="text_boxes_numeric" style="width:58px" readonly></th>
                    <th width="60"><input type="text" id="rate_sum" name="rate_sum" class="text_boxes_numeric" style="width:48px" readonly></th>
                    <th width="70"><input type="text" id="amount_sum" name="amount_sum" class="text_boxes_numeric" style="width:58px" readonly></th>
                    <th width="50">
                    	<input type="text" id="pcs_sum" name="pcs_sum" class="text_boxes_numeric" style="width:38px" readonly>
                        <input type="hidden" id="plancutqty_sum" name="plancutqty_sum" class="text_boxes_numeric" style="width:10px" readonly>
                    </th>
                    <th width="70"><input type="text" id="totReq_sum" name="totReq_sum" class="text_boxes_numeric" style="width:58px" readonly></th>
                    <th width="70"><input type="text" id="totAmount_sum" name="totAmount_sum" class="text_boxes_numeric" style="width:58px" readonly></th>
                    <th width="100">&nbsp;</th>
                    <th>&nbsp;</th>
                </tr>
                <tr>
                    <th width="30">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                    <th width="80">&nbsp;</th>
                    <th width="50">&nbsp;</th>
                     <? if($hid_fab_cons_in_quotation_variable==2) { ?>
                    <th width="50">&nbsp;</th><!--Lenth-->
                    <th width="50">&nbsp;</th><!--Width-->
                    <th width="50">&nbsp;</th><!--Lenth-->
                    <th width="50">&nbsp;</th><!--Width-->
                    <? } ?>
                    <th width="50">AVG :</th>
                    <th width="70"><input type="text" id="avg_cons" name="avg_cons" class="text_boxes_numeric" style="width:58px" readonly></th>
                    <th width="50"><input type="text" id="calculated_procloss"  name="calculated_procloss" class="text_boxes_numeric" style="width:38px" readonly></th>
                    <th width="70"><input type="text" id="calculated_cons" name="calculated_cons" class="text_boxes_numeric" style="width:58px" value="<? echo $calculated_conss;?>" readonly></th>
                    <th width="60"><input type="text" id="calculated_rate" name="calculated_rate" class="text_boxes_numeric" style="width:48px" readonly></th>
                    <th width="70"><input type="text" id="calculated_amount" name="calculated_amount" class="text_boxes_numeric" style="width:58px" readonly></th>
                    <th width="50">
                    	<input type="text" id="calculated_pcs" name="calculated_pcs" class="text_boxes_numeric" style="width:38px" readonly>
                        <input type="hidden" id="calculated_plancutqty"  name="calculated_plancutqty" class="text_boxes_numeric" style="width:30px" readonly>
                    </th>
                    <th width="70"><input type="text" id="AtotReq_sum" name="AtotReq_sum" class="text_boxes_numeric" style="width:58px" disabled></th>
                    <th width="70"><input type="text" id="AtotAmount_sum" name="AtotAmount_sum" class="text_boxes_numeric" style="width:58px" disabled></th>
                    <th width="100">&nbsp;</th>
                    <th>&nbsp;</th>
                </tr>
            </tfoot>
        </table>
		<script>
			set_sum_value( 'cons_sum', 'cons_');
			set_sum_value( 'processloss_sum', 'processloss_');
			set_sum_value( 'requirement_sum', 'requirement_');
			set_sum_value( 'pcs_sum', 'pcs_');
			set_sum_value( 'rate_sum', 'rate_');
			set_sum_value( 'amount_sum', 'amount_');
			set_sum_value( 'totReq_sum', 'totqty_');
			set_sum_value( 'totAmount_sum', 'totamount_');
        </script>
        </form>
    </fieldset>
	</div>
    <div align="center" style="width:100%;" >
        <table cellspacing="0" border="0" rules="all">
            <tr>
                <td width="100%" class="button_container" colspan="2">
					<? echo load_submit_buttons( $permission, "save_consumption_entry_data", 0,0 ,"",1,0) ; ?>
                	<input type="button" class="formbutton" style="width:100px;" name="stripe_color" id="stripe_color" value="Stripe Color"  onClick="open_stripe_color_popup();"/>
                    <input type="button" class="formbutton" style="width:100px;" name="close_popup" id="close_popup" value="Close"  onClick="js_set_value();"/>
                </td>
            </tr>
        </table>
    </div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
    exit();
}

if($action=="sample_popup")
{
	echo load_html_head_contents("Size Sample Info","../../../", 1, 1, $unicode,'','');
	extract($_REQUEST);
	?>
	<script>
		function js_set_value(str)
		{
			
			document.getElementById('samplesize_breakdown').value=str;
			parent.emailwindow.hide();
		}
    </script>
    </head>
    <body>
        <div id="sample_details" align="center">
        <fieldset>
            <form id="samplesize_1" autocomplete="off">
                <input type="hidden" id="samplesize_breakdown" />
                <?
					$job_buyer=return_library_array( "select job_no, buyer_name from wo_po_details_master where job_no='$txt_job_no' and company_name='$cbo_company_id' ", "job_no", "buyer_name");
					$job_buyer_id=$job_buyer[$txt_job_no];
					//echo $job_buyer_id;
                ?>
                <table width="770" cellspacing="0" class="rpt_table" border="0" id="tbl_sample_details" rules="all">
                    <thead>
                        <tr>
                        	<th width="20">SL</th>
                        	<th width="50">Style NO</th>
                            <th width="40">Year</th>
                            <th width="90">Buyer</th>
                            <th width="90">Style Ref.</th>
                            <th width="70">Gmts. Item</th>
                            <th width="80">Sample Name</th>
                            <th width="50">Dev. No.</th>
                            <th width="70">Sample Color</th>
                            <th width="60">Sample Size</th>
                            <th width="60">Weight (GM)</th>
                            <th>Weight (KG)</th>
                        </tr>
                    </thead>
                </table>
                <div style="width:770px; max-height:270px; overflow-y:scroll" >	 
 				<table cellspacing="0" cellpadding="0" border="1" rules="all" width="750" class="rpt_table" id="list_view"> 
                    <tbody>
                    <?
					$buyer_arr=return_library_array("select id, buyer_name from lib_buyer",'id','buyer_name');
					$sample_arr=return_library_array("select id, sample_name from lib_sample",'id','sample_name');
					
					if($db_type==0) $insert_year="YEAR(a.insert_date)";
					else if($db_type==2) $insert_year="to_char(a.insert_date,'YYYY')";
                    
                    //Oracle
                    $data_arr="select a.id, a.requisition_number_prefix_num, $insert_year as year, a.buyer_name, a.style_ref_no, a.item_name, b.sample_name, b.acc_status_id, b.color_id, b.size_id, b.knitinggm
					
					 from sample_development_mst a, sample_development_dtls b where a.id=b.sample_mst_id and a.company_id='$cbo_company_id' and a.entry_form_id=245 and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 order by a.id DESC";// and a.buyer_name='$job_buyer_id'
					//echo  $data_arr; and a.uom='$uom'
					$data_arr_res=sql_select($data_arr);
                    
                    if(count($data_arr_res)>0)
                    {
						$i=1;
						foreach( $data_arr_res as $row )
						{
							if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF"; 
							?>
							<tr bgcolor="<?=$bgcolor; ?>" id="sample_<?=$i;?>" style="cursor:pointer" onClick="js_set_value('<?=$row[csf('id')].'_'.$size_library[$row[csf('size_id')]].'_'.number_format(($row[csf('knitinggm')]/1000),8,".","");?>')">
                            	<td width="20"><?=$i;?></td>
                                <td width="50" align="center"><?=$row[csf('requisition_number_prefix_num')]; ?></td>
                                <td width="40" align="center"><?=$row[csf('year')]; ?></td>
                                <td width="90" style="word-break:break-all"><?=$buyer_arr[$row[csf('buyer_name')]];?></td>
                                <td width="90" style="word-break:break-all"><?=$row[csf('style_ref_no')]; ?></td>
                                <td width="70" style="word-break:break-all"><?=$garments_item[$row[csf('item_name')]]; ?></td>
                                <td width="80" style="word-break:break-all"><?=$sample_arr[$row[csf('sample_name')]]; ?></td>
                                <td width="50" style="word-break:break-all"><?=$development_no[$row[csf('acc_status_id')]]; ?></td>
                                <td width="70" style="word-break:break-all"><?=$color_library[$row[csf('color_id')]]; ?></td>
                                <td width="60" style="word-break:break-all"><?=$size_library[$row[csf('size_id')]]; ?></td>
                                <td width="60" align="right"><?=number_format($row[csf('knitinggm')],6,".",""); ?></td>
                                <td align="right"><?=number_format(($row[csf('knitinggm')]/1000),4,".",""); ?></td>
							</tr>
							<?
							$i++;
						}
                    }
                    ?>
                    </tbody>
                </table>
                </div>
            </form>
        </fieldset>
        </div>
     </body>
    <script>setFilterGrid("list_view",-1);</script>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
    exit();
}

if($action=="open_color_list_view")
{
echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode,'','');
extract($_REQUEST);
?>
<script>
function js_set_value_color()
{
	var rowCount = $('#tbl_color_details tr').length-1;
	var color_breck_down="";
	for(var i=1; i<=rowCount; i++)
	{
		var contrstcolor=$('#concolor_'+i).val();
		var contrstcolor=$('#concolor_'+i).val();
			contrstcolor=contrstcolor.replaceAll('"','');
			var concolor = contrstcolor.toUpperCase();
		if(concolor=='') concolor=$('#gmtscolor_'+i).val();

		if(color_breck_down=="")
		{
			color_breck_down=$('#gmtscolorid_'+i).val()+'_'+$('#gmtscolor_'+i).val()+'_'+concolor;
		}
		else
		{
			color_breck_down+="__"+$('#gmtscolorid_'+i).val()+'_'+$('#gmtscolor_'+i).val()+'_'+concolor;
		}
	}
	document.getElementById('color_breck_down').value=color_breck_down;
	parent.emailwindow.hide();
}
function color_select_popup(buyer_name,texbox_id)
{
	//var page_link='requires/sample_booking_non_order_controller.php?action=color_popup'
	//alert(texbox_id)
	emailwindow=dhtmlmodal.open('EmailBox', 'iframe', 'pre_cost_entry_controller_v2.php?action=color_popup&buyer_name='+buyer_name, 'Color Select Pop Up', 'width=250px,height=450px,center=1,resize=1,scrolling=0','../../')
	emailwindow.onclose=function()
	{
		var theform=this.contentDoc.forms[0];
		var color_name=this.contentDoc.getElementById("color_name");
		if (color_name.value!="")
		{
			$('#'+texbox_id).val(color_name.value);
		}
	}
}
</script>
</head>
<body>
       <div id="color_details"  align="center">
    	<fieldset>
        	<form id="contrastcolor_1" autocomplete="off">
            <input type="hidden" id="color_breck_down" />
            <input type="hidden" id="item_id" />
            <table width="350" cellspacing="0" class="rpt_table" border="0" id="tbl_color_details" rules="all">
                	<thead>
                    	<tr>
                        	<th width="200">Gmts Color</th><th>Contrast Color</th>
                        </tr>
                    </thead>
                    <tbody>
                    <?
						$arr_bo_app=array();
						$sql_bo_app=sql_select("select a.is_approved,b.pre_cost_fabric_cost_dtls_id from wo_booking_mst a, wo_booking_dtls b where a.job_no=b.job_no and a.booking_no=b.booking_no and  a.job_no='$txt_job_no' and a.booking_type=1 and a.is_short=2 and a.is_approved=1  and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 group by b.pre_cost_fabric_cost_dtls_id,a.is_approved");
						foreach($sql_bo_app as $row_bo_app)
						{
							$is_approved=$row_bo_app[csf('is_approved')];
							if($is_approved==3){
								$is_approved=1;
							}else{
								$is_approved=$is_approved;
							}
						  $arr_bo_app[$row_bo_app[csf('pre_cost_fabric_cost_dtls_id')]]	=$is_approved;
						}

						if($precostapproved==1 || $arr_bo_app[$pre_cost_fabric_cost_dtls_id])
						{
							$disabled=1;
						}
						else $disabled=0;

						$color_from_library=return_field_value("color_from_library", "variable_order_tracking", "company_name=$cbo_company_id  and variable_list=23  and status_active=1 and is_deleted=0");
						if($color_from_library==1)
						{
							$readonly="readonly='readonly'"; $plachoder="placeholder='Click'"; $onClick="onClick='color_select_popup($cbo_buyer_name,this.id)'";
						}
						else
						{
							$readonly=""; $plachoder=""; $onClick="";
						}
						$data_array_color=explode("__",$color_breck_down);

					//Oracle
					$data_array=sql_select("select a.color_number_id from  wo_po_color_size_breakdown a, wo_po_break_down b where a.job_no_mst=b.job_no_mst and a.po_break_down_id=b.id and a.job_no_mst='$txt_job_no' and a.item_number_id='$cbogmtsitem' and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 group by a.color_number_id, a.color_order order by a.color_order ASC");

						if ( count($data_array)>0)
						{
							$i=0;
							foreach( $data_array as $row )
							{
								$data=explode('_',$data_array_color[$i]);
								//print_r($data);
								$i++;
								?>
								<tr id="color_1" align="center">
                                    <td>
                                    <input type="hidden" id="gmtscolorid_<? echo $i;?>"   name="gmtscolorid_<? echo $i;?>" style="width:50px"  class="text_boxes"   value="<? echo $row[csf('color_number_id')]; ?>"  readonly/>
                                    <input type="text" id="gmtscolor_<? echo $i;?>"   name="gmtscolor_<? echo $i;?>" style="width:150px"  class="text_boxes"   value="<? echo $color_library[$row[csf('color_number_id')]]; ?>"  readonly/>
                                    </td>
                                    <td>
                                    <input type="text" id="concolor_<? echo $i;?>" name="concolor_<? echo $i;?> " style="width:130px" class="text_boxes" value="<? echo $data[2]; ?>" <? echo $readonly." ".$onClick." ".$plachoder?>  <? if($disabled==1){ echo "disabled";} else{ echo "";} ?> />
                                    </td>
								</tr>
							<?
							}
						}
					?>
                </tbody>
                </table>
                <table width="350" cellspacing="0" class="" border="0">
                	<tr>
                        <td align="center" width="100%" class="button_container">
						        <input type="button" class="formbutton" value="Close" onClick="js_set_value_color()"/>
                        </td>
                    </tr>
                </table>

            </form>
        </fieldset>
        </div>
 </body>
<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
</html>
<?
exit();
}

if($action=="color_popup")
{
	echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
	function js_set_value(data)
	{
		document.getElementById('color_name').value=data;
		parent.emailwindow.hide();
	}
	</script>
	</head>
	<body>
        <body>
            <div align="center">
                <form>
                    <input type="hidden" id="color_name" name="color_name" />
                    <?
                    if($buyer_name=="" || $buyer_name=="")
                    {
                        $sql="select color_name,id FROM lib_color  WHERE status_active=1 and is_deleted=0";
                    }
                    else
                    {
                        $sql="select a.color_name,a.id FROM lib_color a, lib_color_tag_buyer b  WHERE a.id=b.color_id and b.buyer_id=$buyer_name and  status_active=1 and is_deleted=0";
                    }
                    echo  create_list_view("list_view", "Color Name", "160","210","420",0, $sql , "js_set_value", "color_name", "", 1, "0", $arr , "color_name", "requires/sample_booking_non_order_controller",'setFilterGrid("list_view",-1);','0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,2') ;
                    ?>
                </form>
            </div>
        </body>
	</html>
	<?
	exit();
}

if($action=="get_yarn_rate")
{
	$data=explode("_",$data);
	if($db_type==0) 
	{
		$effective_date=change_date_format($data[5],'yyyy-mm-dd','-'); $limit="limit 1";
	}
	else if($db_type==2) 
	{
		$effective_date=change_date_format($data[5],'yyyy-mm-dd','-',1); $limit="";
	}
	
	$sql="select  rate from lib_yarn_rate where supplier_id=$data[4] and yarn_count=$data[0] and composition=$data[1] and  percent=$data[2] and yarn_type=$data[3] and effective_date='$effective_date' and status_active=1 and is_deleted=0  order by id desc $limit";
	
	$sql_data=sql_select($sql);
	//print_r($sql_data);
    echo trim($sql_data[0][csf('rate')]);
	exit();
}

if($action=="conversion_chart_popup")
{
	echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	
	?>
	<script>
	function js_set_value(id,rate)
	{
		//var data=data.split("_");
		document.getElementById('charge_id').value=id;
		document.getElementById('charge_value').value=rate;
		parent.emailwindow.hide();
	
	}
	function toggle( x, origColor )
			{
				var newColor = 'yellow';
				document.getElementById(x).style.backgroundColor = ( newColor == document.getElementById(x).style.backgroundColor )? origColor : newColor;
			}
	</script>
	</head>
	<body>
	<div align="center">
	<form>
	<input type="hidden" id="charge_id" name="charge_id" />
	<input type="hidden" id="charge_value" name="charge_value" />
	
	
	
	<?
	if($cbotypeconversion==1)
	{
		 $company_arr=return_library_array( "select id, company_name from lib_company",'id','company_name');
		 //$buyer_arr=return_library_array("select id, buyer_name from lib_buyer",'id','buyer_name');
		 $arr=array (0=>$company_arr,1=>$body_part,5=>$unit_of_measurement,7=>$row_status);
		// echo  create_list_view ( "list_view", "Company Name,Body Part,Construction & Composition,GSM,Yarn Description,UOM,In-House Rate,Status", "150,120,180,60,150,70,100,60","980","220",1, "select id,comapny_id,body_part,const_comp,gsm,yarn_description,in_house_rate,uom_id,status_active from lib_subcon_charge where status_active=1 and is_deleted=0 and rate_type_id=2 and comapny_id=$cbo_company_name", "js_set_value", "id,in_house_rate","", 1, "comapny_id,body_part,0,0,0,uom_id,0,status_active", $arr , "comapny_id,body_part,const_comp,gsm,yarn_description,uom_id,in_house_rate,status_active", "../sub_contract_bill/requires/lib_subcontract_knitting_controller", 'setFilterGrid("list_view",-1);','0,0,0,2,0,0,2,0' ) ;
		 ?>
		 <table width="963" class="rpt_table" border="1" rules="all" cellpadding="0" cellspacing="0">
		 <thead>
		 <th width="50">SL</th>
		 <th width="150">Company Name</th>
		 <th width="120">Body Part</th>
		 <th width="180">Construction & Composition</th>
		 <th width="60">GSM</th>
		 <th width="150">Yarn Description</th>
		 <th width="70">UOM</th>
		 <th width="100">In-House Rate</th>
		 <th>Status</th>
		 </thead>
		 </table>
		 <div style=" width:980; overflow:scroll-y; max-height:300px">
		 <table width="963" class="rpt_table" border="1" rules="all" id="list_view" cellpadding="0" cellspacing="0">
		 <?
		 if($israte_popup==2) $comp_cond=" and comapny_id=$cbo_company_name"; else $comp_cond="";
		 $sql_data=sql_select("select id,comapny_id,body_part,const_comp,gsm,yarn_description,in_house_rate,uom_id,status_active from lib_subcon_charge where status_active=1 and is_deleted=0 and rate_type_id=2 $comp_cond");
		 $i=1;
		 foreach($sql_data as $row)
		 {
			 if ($i%2==0)
			$bgcolor="#E9F3FF";
			else
			$bgcolor="#FFFFFF";
	
		 ?>
		 <tr bgcolor="<? echo $bgcolor; ?>" onClick="js_set_value(<? echo $row[csf("id")]?>, <? echo $row[csf("in_house_rate")]; ?>)" id="tr_<? echo $row[csf("id")];  ?>">
		 <td width="50"><? echo $i; ?></td>
		 <td width="150"><? echo $company_arr[$row[csf("comapny_id")]]; ?></td>
		 <td width="120"><? echo $body_part[$row[csf("body_part")]]; ?></td>
		 <td width="180"><? echo $row[csf("const_comp")]; ?></td>
		 <td width="60"><? echo $row[csf("gsm")]; ?></td>
		 <td width="150"><? echo $row[csf("yarn_description")]; ?></td>
		 <td width="70"><? echo $unit_of_measurement[$row[csf("uom_id")]]; ?></td>
		 <td width="100"><? echo $row[csf("in_house_rate")]; ?></td>
		 <td><? echo $row_status[$row[csf("status_active")]]; ?></td>
		 </tr>
		 <?
		  $i++;
		 }
		 ?>
		 <script>
		 setFilterGrid("list_view",-1)
		 toggle( "tr_"+"<? echo $coversionchargelibraryid ?>", '#FFFFCC');
		 </script>
		 </table>
		 </div>
	
		 <?
	}
	else
	{
		$company_arr=return_library_array( "select id, company_name from lib_company",'id','company_name');
		$color_library_arr=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
		$arr=array (0=>$company_arr,2=>$process_type,3=>$conversion_cost_head_array,4=>$color_library_arr,5=>$fabric_typee,7=>$unit_of_measurement,8=>$production_process,9=>$row_status);
		//echo "select id,comapny_id,const_comp,process_type_id,process_id,color_id,width_dia_id,in_house_rate,uom_id,rate_type_id,status_active from lib_subcon_charge where status_active=1 and is_deleted=0 and rate_type_id in (3,4,8) and process_id=$cbotypeconversion and comapny_id=$cbo_company_name";
		//echo  create_list_view ( "list_view", "Company Name,Const. Compo.,Process Type,Process Name,Color,Width/Dia type,In House Rate,UOM,Rate type,Status", "100,150,70,70,70,80,60,80,60,50","900","250",1, "select id,comapny_id,const_comp,process_type_id,process_id,color_id,width_dia_id,in_house_rate,uom_id,rate_type_id,status_active from lib_subcon_charge where status_active=1 and is_deleted=0 and rate_type_id in (3,4,7,8) and process_id=$cbotypeconversion and comapny_id=$cbo_company_name", "js_set_value", "id,in_house_rate","", 1, "comapny_id,0,process_type_id,process_id,color_id,width_dia_id,0,uom_id,rate_type_id,status_active", $arr, "comapny_id,const_comp,process_type_id,process_id,color_id,width_dia_id,in_house_rate,uom_id,rate_type_id,status_active","requires/lib_subcontract_dyeing_controller", 'setFilterGrid("list_view",-1);','0,0,0,0,0,0,2,0,0,0' );
		?>
		<table width="900" class="rpt_table" border="1" rules="all" cellpadding="0" cellspacing="0">
		 <thead>
		 <th width="50">SL</th>
		 <th width="100">Company Name</th>
		 <th width="150">Const. Compo.</th>
		 <th width="70">Process Type</th>
		 <th width="70">Process Name</th>
		 <th width="70">Color</th>
		 <th width="80">Width/Dia type</th>
	
		 <th width="60">In House Rate</th>
		 <th width="80">UOM</th>
		 <th width="60">Rate type</th>
		 <th>Status</th>
		 </thead>
		 </table>
		 <div style=" width:917; overflow:scroll-y; max-height:300px">
		 <table width="900" class="rpt_table" border="1" rules="all" id="list_view" cellpadding="0" cellspacing="0">
		 <?
		 if($israte_popup==2) $comp_cond=" and comapny_id=$cbo_company_name"; else $comp_cond="";
		 $sql_data=sql_select("select id,comapny_id,const_comp,process_type_id,process_id,color_id,width_dia_id,in_house_rate,uom_id,rate_type_id,status_active from lib_subcon_charge where status_active=1 and is_deleted=0 and rate_type_id in (3,4,7,8) and process_id=$cbotypeconversion $comp_cond");
		 $i=1;
		 foreach($sql_data as $row)
		 {
			 if ($i%2==0)
			$bgcolor="#E9F3FF";
			else
			$bgcolor="#FFFFFF";
	
		 ?>
		 <tr bgcolor="<? echo $bgcolor; ?>" onClick="js_set_value(<? echo $row[csf("id")]?>, <? echo $row[csf("in_house_rate")]; ?>)" id="tr_<? echo $row[csf("id")];  ?>">
		 <td width="50"><? echo $i; ?></td>
		 <td width="100"><? echo $company_arr[$row[csf("comapny_id")]]; ?></td>
		 <td width="150"><? echo $row[csf("const_comp")]; ?></td>
		 <td width="70"><? echo $process_type[$row[csf("process_type_id")]]; ?></td>
		  <td width="70"><? echo $conversion_cost_head_array[$row[csf("process_id")]]; ?></td>
		 <td width="70"><? echo $color_library_arr[$row[csf("color_id")]]; ?></td>
		 <td width="80"><? echo $fabric_typee[$row[csf("width_dia_id")]]; ?></td>
	
		 <td width="60"><? echo $row[csf("in_house_rate")]; ?></td>
		 <td width="80"><? echo $unit_of_measurement[$row[csf("uom_id")]]; ?></td>
		 <td width="60"><? echo $production_process[$row[csf("rate_type_id")]]; ?></td>
		 <td><? echo $row_status[$row[csf("status_active")]]; ?></td>
		 </tr>
		 <?
		  $i++;
		 }
		 ?>
		 <script>
		 setFilterGrid("list_view",-1)
		 toggle( "tr_"+"<? echo $coversionchargelibraryid ?>", '#FFFFCC');
		 </script>
		 </table>
		 </div>
		<?
		exit();
	}
	?>
	</form>
	</div>
	</body>
	</html>
	<?
	exit();
}

if ($action=="set_conversion_charge"){
	//extract($_REQUEST);
	$rate=return_field_value("rate", "lib_cost_component", "cost_component_name=$data");
	echo $rate; die;
}

if ($action=="set_conversion_qnty"){
	$data=explode("_",$data);
	$lib_yarn_count_deter_id=return_field_value("lib_yarn_count_deter_id", "wo_pre_cost_fabric_cost_dtls", "id=$data[0]");
	$processloss=return_field_value("process_loss", "conversion_process_loss", "mst_id=$lib_yarn_count_deter_id and process_id=$data[1]");
	$processloss_from_library=1;
	if(!$processloss){
		$processloss=$data[2];
		$processloss_from_library=0;
	}
	if($data[3]){// update mode
		$processloss=$data[2];
	}
	if($data[1]==30){
		$sql=sql_select("select sum(fabreq) as fabreq from  wo_pre_stripe_color where pre_cost_fabric_cost_dtls_id=$data[0] and yarn_dyed=1");
		$avg_cons= $sql[0][csf('fabreq')];
		$avg_cons=$avg_cons-($avg_cons*$processloss)/100;
		$avg_cons_yarn=$avg_cons-($avg_cons*$processloss)/100;
	}
	else{
		$avg_cons=return_field_value("avg_cons", "wo_pre_cost_fabric_cost_dtls", "id=$data[0]");
		$avg_cons=$avg_cons-($avg_cons*$processloss)/100;
	    //$avg_cons_yarn=return_field_value("avg_cons_yarn", "wo_pre_cost_fabric_cost_dtls", "id=$data[0]");
		$avg_cons_yarn=return_field_value("avg_cons", "wo_pre_cost_fabric_cost_dtls", "id=$data[0]");
	    $avg_cons_yarn=$avg_cons_yarn-($avg_cons_yarn*$processloss)/100;
		if($avg_cons_yarn==''){
			$avg_cons_yarn=$avg_cons;
		}
	}
	echo trim($avg_cons)."_".trim($avg_cons_yarn)."_".trim($processloss)."_".trim($processloss_from_library);
	die;
}

if($action=="delete_row_fabric_cost")
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}

	$sql_quo_fab_dtls_del="insert into wo_pre_cost_fabric_dtls_del( id, job_no, item_number_id, body_part_id, fab_nature_id, color_type_id, lib_yarn_count_deter_id, construction, composition, fabric_description, gsm_weight, color_size_sensitive, color, avg_cons, fabric_source, rate, amount, avg_finish_cons, avg_process_loss, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, company_id, costing_per, consumption_basis, process_loss_method, cons_breack_down, msmnt_break_down, color_break_down, yarn_breack_down, marker_break_down, width_dia_type, avg_cons_yarn, gsm_weight_yarn, plan_cut_qty, job_plan_cut_qty, is_apply_last_update, uom, body_part_type, deleted_by, delete_date)
select
	id, job_no, item_number_id, body_part_id, fab_nature_id, color_type_id, lib_yarn_count_deter_id, construction, composition, fabric_description, gsm_weight, color_size_sensitive, color, avg_cons, fabric_source, rate, amount, avg_finish_cons, avg_process_loss, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, company_id, costing_per, consumption_basis, process_loss_method, cons_breack_down, msmnt_break_down, color_break_down, yarn_breack_down, marker_break_down, width_dia_type, avg_cons_yarn, gsm_weight_yarn, plan_cut_qty, job_plan_cut_qty, is_apply_last_update, uom, body_part_type, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."' from wo_pre_cost_fabric_cost_dtls where id=".$data."";

	$rID_de1=execute_query($sql_quo_fab_dtls_del,0);

	$sql_quo_yarn_dtls_del="insert into wo_pre_cost_fab_yarn_dtls_del( id, fabric_cost_dtls_id, job_no, count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, cons_ratio, cons_qnty, rate, amount, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, avg_cons_qnty, supplier_id, color, deleted_by, delete_date)
select
	id, fabric_cost_dtls_id, job_no, count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, cons_ratio, cons_qnty, rate, amount, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, avg_cons_qnty, supplier_id, color, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."' from wo_pre_cost_fab_yarn_cost_dtls where fabric_cost_dtls_id=".$data."";

	$rID_de1=execute_query($sql_quo_yarn_dtls_del,0);

	$sql_quo_conv_dtls_del="insert into wo_pre_cost_fab_conv_dtls_del( id, job_no, fabric_description, cons_process, req_qnty, charge_unit, amount, color_break_down, charge_lib_id, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, avg_req_qnty, process_loss, deleted_by, delete_date)
select
	id, job_no, fabric_description, cons_process, req_qnty, charge_unit, amount, color_break_down, charge_lib_id, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, avg_req_qnty, process_loss, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."' from wo_pre_cost_fab_conv_cost_dtls where fabric_description=".$data."";

	$rID_de1=execute_query($sql_quo_conv_dtls_del,0);

	$rID_de1=execute_query( "delete from  wo_pre_cost_fabric_cost_dtls where  id =".$data."",0);
	$rID_de1=execute_query( "delete from  wo_pre_cos_fab_co_avg_con_dtls where  pre_cost_fabric_cost_dtls_id =".$data."",0);
	$rID_de1=execute_query( "delete from  wo_pre_cos_fab_co_color_dtls where  pre_cost_fabric_cost_dtls_id =".$data."",0);
	$rID_de1=execute_query( "delete from  wo_pre_cost_fab_yarn_cost_dtls where  fabric_cost_dtls_id =".$data."",0);
	$rID_de1=execute_query( "delete from  wo_pre_cost_fab_yarnbreakdown where  fabric_cost_dtls_id =".$data."",0);
	$rID_de1=execute_query( "delete from  wo_pre_cost_fab_conv_cost_dtls where  fabric_description =".$data."",0);
	if($db_type==0)
	{
		if($rID_de1) mysql_query("COMMIT"); else mysql_query("ROLLBACK");
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($rID_de1) oci_commit($con); else oci_rollback($con);
	}
	disconnect($con);
}
if($action=="delete_row_yarn_cost")
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}

	$sql_quo_yarn_dtls_del="insert into wo_pre_cost_fab_yarn_dtls_del( id, fabric_cost_dtls_id, job_no, count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, cons_ratio, cons_qnty, rate, amount, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, avg_cons_qnty, supplier_id, color, deleted_by, delete_date)
select
	id, fabric_cost_dtls_id, job_no, count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, cons_ratio, cons_qnty, rate, amount, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, avg_cons_qnty, supplier_id, color, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."' from wo_pre_cost_fab_yarn_cost_dtls where id=".$data."";

	$rID_de1=execute_query($sql_quo_yarn_dtls_del,0);

	$rID_de1=execute_query( "delete from  wo_pre_cost_fab_yarn_cost_dtls where  id =".$data."",0);
	if($db_type==0)
	{
		if($rID_de1) mysql_query("COMMIT"); else mysql_query("ROLLBACK");
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($rID_de1) oci_commit($con); else oci_rollback($con);
	}
	disconnect($con);
}

if($action=="conversion_from_chart")
{
	$conversion_from_chart=return_field_value("conversion_from_chart", "variable_order_tracking", "company_name='$data'  and variable_list=21 and status_active=1 and is_deleted=0");
	if($conversion_from_chart=="")
	{
		$conversion_from_chart=2;
	}
	echo trim($conversion_from_chart);
}

if($action=="delete_row_conversion_cost")
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}

	$sql_quo_conv_dtls_del="insert into wo_pre_cost_fab_conv_dtls_del( id, job_no, fabric_description, cons_process, req_qnty, charge_unit, amount, color_break_down, charge_lib_id, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, avg_req_qnty, process_loss, deleted_by, delete_date)
select
	id, job_no, fabric_description, cons_process, req_qnty, charge_unit, amount, color_break_down, charge_lib_id, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, avg_req_qnty, process_loss, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."' from wo_pre_cost_fab_conv_cost_dtls where id=".$data."";

	$rID_de1=execute_query($sql_quo_conv_dtls_del,0);

	$rID_de1=execute_query( "delete from  wo_pre_cost_fab_conv_cost_dtls where  id =".$data."",0);
	if($db_type==0)
	{
		if($rID_de1) mysql_query("COMMIT");  else mysql_query("ROLLBACK");
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($rID_de1) oci_commit($con); else oci_rollback($con);
	}
	disconnect($con);
}

if($action=="check_trims_booking")
{
	if (is_duplicate_field( "pre_cost_fabric_cost_dtls_id", "wo_booking_dtls", "pre_cost_fabric_cost_dtls_id=$data and booking_type=2 and is_deleted=0 and status_active=1" ) == 1)
	{
		echo "11"; die;
	}
}

if($action=="delete_row_trim_cost")
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}
	if (is_duplicate_field( "pre_cost_fabric_cost_dtls_id", "wo_booking_dtls", "pre_cost_fabric_cost_dtls_id=$data and booking_type=2 and is_deleted=0 and status_active=1" ) == 1)
	{
		echo "11"; die;
	}

	$sql_quo_trim_dtls_del="insert into wo_pre_cost_trim_dtls_del( id, job_no, trim_group, description, brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, cons_breack_down, remark, country, calculatorstring, unit_price, inco_term, add_price, seq, deleted_by, delete_date)
select
	id, job_no, trim_group, description, brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, cons_breack_down, remark, country, calculatorstring, unit_price, inco_term, add_price, seq, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."' from wo_pre_cost_trim_cost_dtls where id=".$data."";

	$rID_de1=execute_query($sql_quo_trim_dtls_del,0);

	$rID_de1=execute_query( "delete from  wo_pre_cost_trim_cost_dtls where  id =".$data."",0);
	$rID_de1=execute_query( "delete from  wo_pre_cost_trim_co_cons_dtls where  wo_pre_cost_trim_cost_dtls_id =".$data."",0);
	if($db_type==0)
	{
		if($rID_de1) mysql_query("COMMIT"); else mysql_query("ROLLBACK");
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($rID_de1) oci_commit($con); else oci_rollback($con);
	}
	disconnect($con);
}

if($action=="delete_row_embellishment_cost")
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}

	$sql_quo_emb_dtls_del="insert into wo_pre_cost_embe_dtls_del( id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount, charge_lib_id, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, budget_on, supplier_id, country, deleted_by, delete_date)
select
	id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount, charge_lib_id, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, budget_on, supplier_id, country, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."' from wo_pre_cost_embe_cost_dtls where id=".$data."";

	$rID_de1=execute_query($sql_quo_emb_dtls_del,0);

	$rID_de1=execute_query( "delete from  wo_pre_cost_embe_cost_dtls where  id =".$data."",0);
	if($db_type==0)
	{
		if($rID_de1) mysql_query("COMMIT"); else mysql_query("ROLLBACK");
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($rID_de1) oci_commit($con); else oci_rollback($con);
	}
	disconnect($con);
}

if($action=="delete_row_wash_cost")
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}
	$sql_quo_wash_dtls_del="insert into wo_pre_cost_embe_dtls_del( id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount, charge_lib_id, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, budget_on, supplier_id, country, deleted_by, delete_date)
select
	id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount, charge_lib_id, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, budget_on, supplier_id, country, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."' from wo_pre_cost_embe_cost_dtls where id=".$data."";

	$rID_de1=execute_query($sql_quo_wash_dtls_del,0);
	$rID_de1=execute_query("delete from  wo_pre_cost_embe_cost_dtls where  id =".$data."",0);
	if($db_type==0)
	{
		if($rID_de1) mysql_query("COMMIT"); else mysql_query("ROLLBACK");
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($rID_de1) oci_commit($con); else oci_rollback($con);
	}
	disconnect($con);
}

if($action=="delete_row_comarcial_cost")
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}

	$sql_quo_coml_dtls_del="insert into wo_pre_cost_comarci_dtls_del( id, job_no, item_id, rate, amount, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, deleted_by, delete_date)
select
	id, job_no, item_id, rate, amount, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, ".$_SESSION['logic_erp']['user_id'].", '".$pc_date_time."' from wo_pre_cost_comarci_cost_dtls where id=".$data."";

	$rID_de1=execute_query($sql_quo_coml_dtls_del,0);

	$rID_de1=execute_query( "delete from  wo_pre_cost_comarci_cost_dtls where  id =".$data."",0);
	if($db_type==0)
	{
		if($rID_de1) mysql_query("COMMIT"); else mysql_query("ROLLBACK");
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($rID_de1) oci_commit($con); else oci_rollback($con);
	}
	disconnect($con);
}

if ($action=="save_update_delet_fabric_cost_dtls_per_row")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$sql=sql_select("select approval_need from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
	$app_nessity=2;
	foreach($sql as $row){
		$app_nessity=$row[csf('approval_need')];
	}

	$sql=sql_select("select approved from wo_price_quotation  where id=$txt_quotation_id");
	$quatation_approved=2;
	foreach($sql as $row){
		$quatation_approved=$row[csf('approved')];
	}

	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	if($is_copy_quatation==1 && $app_nessity==1){
		if($quatation_approved==2 || $quatation_approved==0 || $quatation_approved==3){
			echo "quataNotApp**".str_replace("'","",$txt_job_no);
			disconnect($con);die;
		}
	}

	if($operation==0)
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		$approved=0;
		$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$update_id");
		foreach($sql as $row){
			if($row[csf('approved')]==3){
				$approved=1;
			}else{
				$approved=$row[csf('approved')];
			}
		}
		if($approved==1){
			echo "approved**".str_replace("'","",$update_id);
			disconnect($con);die;
		}
		
		$materialReciveNo="";
		$sql=sql_select("select a.recv_number from inv_receive_master a, inv_transaction b, wo_po_break_down c where a.id=b.mst_id and b.job_no=c.job_no_mst and b.job_no=$update_id and a.entry_form=248 and c.is_confirmed=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by a.recv_number");
		foreach($sql as $row)
		{
			if($materialReciveNo=="") $materialReciveNo=$row[csf('recv_number')]; else $materialReciveNo.=','.$row[csf('recv_number')];
		}
		if($materialReciveNo!=""){
			echo "materialRecive**".$materialReciveNo;
			disconnect($con);die;
		}
		
		if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0"; die;}
		$field_array="id, job_id, job_no, item_number_id, body_part_id, fab_nature_id, color_type_id, lib_yarn_count_deter_id, construction, composition, fabric_description, gsm_weight, color_size_sensitive, color, avg_cons, fabric_source, rate, amount, avg_finish_cons, avg_process_loss, inserted_by, insert_date, status_active, is_deleted, company_id, costing_per, consumption_basis, process_loss_method, cons_breack_down, msmnt_break_down, color_break_down, yarn_breack_down, marker_break_down, width_dia_type, avg_cons_yarn, gsm_weight_yarn, plan_cut_qty, job_plan_cut_qty, uom, body_part_type, seq, budget_on, quotdtlsid";

		$id=return_next_id( "id", "wo_pre_cost_fabric_cost_dtls", 1 );
		$i=$total_row; 
		
		$cbogmtsitem="cbogmtsitem_".$i;
		$txtbodypart="txtbodypart_".$i;
		$cbofabricnature="cbofabricnature_".$i;
		$cbocolortype="cbocolortype_".$i;
		$libyarncountdeterminationid="libyarncountdeterminationid_".$i;
		$construction="construction_".$i;
		$composition="composition_".$i;
		$fabricdescription="fabricdescription_".$i;
		$txtgsmweight="txtgsmweight_".$i;
		$cbocolorsizesensitive="cbocolorsizesensitive_".$i;
		$txtcolor="txtcolor_".$i;
		$txtconsumption="txtconsumption_".$i;
		$cbofabricsource="cbofabricsource_".$i;
		$txtrate="txtrate_".$i;
		$txtamount="txtamount_".$i;
		$txtfinishconsumption="txtfinishconsumption_".$i;
		$txtavgprocessloss="txtavgprocessloss_".$i;
		$cbostatus="cbostatus_".$i;
		$consbreckdown="consbreckdown_".$i;
		$msmntbreackdown="msmntbreackdown_".$i;
		$processlossmethod="processlossmethod_".$i;
		$colorbreackdown="colorbreackdown_".$i;
		$yarnbreackdown="yarnbreackdown_".$i;
		$consumptionbasis="consumptionbasis_".$i;
		$markerbreackdown="markerbreackdown_".$i;
		$cbowidthdiatype="cbowidthdiatype_".$i;

		$avgtxtconsumption="avgtxtconsumption_".$i;
		$avgtxtgsmweight="avgtxtgsmweight_".$i;
		$plancutqty="plancutqty_".$i;
		$jobplancutqty="jobplancutqty_".$i;
		$uom="uom_".$i;
		$seq="seq_".$i;
		$budgeton="budgeton_".$i;
		$txtbodyparttype="txtbodyparttype_".$i;
		$prifabcostdtlsid="prifabcostdtlsid_".$i;
		$cons_breckdown=substr(str_replace("'","",$$consbreckdown),0,100);
			//color Id;
			if( str_replace("'","",$$cbocolorsizesensitive)==0)
			{
				if(str_replace("'","",$$txtcolor)!="")
				{
					if (!in_array(str_replace("'","",$$txtcolor),$new_array_color))
					{
						$color_id = return_id( str_replace("'","",$$txtcolor), $color_library, "lib_color", "id,color_name","521");
						$new_array_color[$color_id]=str_replace("'","",$$txtcolor);
					}
					else $color_id =  array_search(str_replace("'","",$$txtcolor), $new_array_color);
				}
				else $color_id=0;
			}
			else $color_id=0;
			//color Id End
			$data_array ="(".$id.",".$hidd_job_id.",".$update_id.",".$$cbogmtsitem.",".$$txtbodypart.",".$$cbofabricnature.",".$$cbocolortype.",".$$libyarncountdeterminationid.",".$$construction.",".$$composition.",".$$fabricdescription.",".$$txtgsmweight.",".$$cbocolorsizesensitive.",".$color_id.",".$$txtconsumption.",".$$cbofabricsource.",".$$txtrate.",".$$txtamount.",".$$txtfinishconsumption.",".$$txtavgprocessloss.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbostatus.",0,".$cbo_company_name.",".$cbo_costing_per.",".$$consumptionbasis.",".$$processlossmethod.",'".$cons_breckdown."',".$$msmntbreackdown.",".$$colorbreackdown.",".$$yarnbreackdown.",".$$markerbreackdown.",".$$cbowidthdiatype.",".$$avgtxtconsumption.",".$$avgtxtgsmweight.",".$$plancutqty.",".$$jobplancutqty.",".$$uom.",".$$txtbodyparttype.",".$$seq.",".$$budgeton.",".$$prifabcostdtlsid.")";
			$rID_in=sql_insert("wo_pre_cost_fabric_cost_dtls",$field_array,$data_array,0,1);

			/*echo "10**".$rID_in; 
			echo "10*insert into wo_pre_cost_fabric_cost_dtls (".$field_array.") values ".$data_array;
			check_table_status( $_SESSION['menu_id'],0);die;*/
			$field_array2="id, job_id, pre_cost_fabric_cost_dtls_id, job_no, gmts_color_id, gmts_color, contrast_color_id";
			$wo_pre_cos_fab_co_color_dtls_id=return_next_id( "id", "wo_pre_cos_fab_co_color_dtls", 1 );
// Color break down ==================================================================================================
			if(str_replace("'",'',$$colorbreackdown)!="")
			{
				$colorbreckdown_array=explode('__',str_replace("'",'',$$colorbreackdown));
				for($c=0;$c < count($colorbreckdown_array);$c++)
				{
					$counter++;
					$colorbreckdownarr=explode('_',$colorbreckdown_array[$c]);
					if(str_replace("'","",$colorbreckdownarr[2])!="")
					{
						if (!in_array(str_replace("'","",$colorbreckdownarr[2]),$new_array_color))
						{
							$color_id = return_id( str_replace("'","",$colorbreckdownarr[2]), $color_library, "lib_color", "id,color_name","521");
							$new_array_color[$color_id]=str_replace("'","",$colorbreckdownarr[2]);
						}
						else $color_id =  array_search(str_replace("'","",$colorbreckdownarr[2]), $new_array_color);
					}
					else $color_id =0;
					$data_array2 ="(".$wo_pre_cos_fab_co_color_dtls_id.",".$hidd_job_id.",".$id.",".$update_id.",".$colorbreckdownarr[0].",'".$colorbreckdownarr[1]."','".$color_id."')";
					$rID=sql_insert("wo_pre_cos_fab_co_color_dtls",$field_array2,$data_array2,1);
					$wo_pre_cos_fab_co_color_dtls_id=$wo_pre_cos_fab_co_color_dtls_id+1;
				}
			}
//  color break down end ===============================================================================================
			

		$tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);
		check_table_status( $_SESSION['menu_id'],0);

		if($db_type==0)
		{
			if ($data_array2!="")
			{
				if($rID_in)
				{
					mysql_query("COMMIT");
					echo "0**".$id."**".$rID."**".$tot_com_amount;
				}
				else
				{
					mysql_query("ROLLBACK");
					echo "10**".$id."**".$rID."**".$tot_com_amount;
				}
			}
			else
			{
				if($rID_in)
				{
					mysql_query("COMMIT");
					echo "0**".$id."**".$rID."**".$tot_com_amount;
				}
				else
				{
					mysql_query("ROLLBACK");
					echo "10**".$id."**".$rID."**".$tot_com_amount;
				}
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if ($data_array2!="")
			{
				if($rID_in)
				{
					oci_commit($con);
					echo "0**".$id."**".$rID."**".$tot_com_amount;
				}
				else
				{
					oci_rollback($con);
					echo "10**".$id."**".$rID."**".$tot_com_amount;
				}
			}
			else
			{
				if($rID_in )
				{
					oci_commit($con);
					echo "0**".$id."**".$rID."**".$tot_com_amount;
				}
				else
				{
					oci_rollback($con);
					echo "10**".$id."**".$rID."**".$tot_com_amount;
				}
			}
		}
		disconnect($con);
		die;
	}
// Insert  end ====================================================================================
}

if ($action=="save_update_delet_fabric_cost_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	
	$sql=sql_select("select approval_need from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
	$app_nessity=2;
	foreach($sql as $row){
		$app_nessity=$row[csf('approval_need')];
	}

	$sql=sql_select("select approved from wo_price_quotation  where id=$txt_quotation_id");
	$quatation_approved=2;
	foreach($sql as $row){
		$quatation_approved=$row[csf('approved')];
	}

	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	if($is_copy_quatation==1 && $app_nessity==1){
		if($quatation_approved==2 || $quatation_approved==0 || $quatation_approved==3){
			echo "quataNotApp**".str_replace("'","",$txt_job_no);
			disconnect($con);die;
		}
	}
	
	$yanColorArr=array(); $stripeColorArr=array(); $new_array_color=array();
	for ($i=1;$i<=$total_row;$i++)
	{
		$txtcolor="txtcolor_".$i;
		$cbocolorsizesensitive="cbocolorsizesensitive_".$i;
		$colorbreackdown="colorbreackdown_".$i;
		
		if(str_replace("'","",$$cbocolorsizesensitive)==0)
		{
			if(str_replace("'","",$$txtcolor)!="")
			{
				if (!in_array(str_replace("'","",$$txtcolor),$new_array_color))
				{
					$color_id = return_id( str_replace("'","",$colorbreckdownarr[2]), $color_library, "lib_color", "id,color_name","521");
					$new_array_color[$color_id]=str_replace("'","",$$txtcolor);
					$yanColorArr[trim(str_replace("'","",$$txtcolor))]=$color_id;
				}
				else $color_id =  array_search(str_replace("'","",$$txtcolor), $new_array_color);
				$yanColorArr[trim(str_replace("'","",$$txtcolor))]=$color_id;
			}
			else 
			{
				$color_id=0;
				$yanColorArr[trim(str_replace("'","",$$txtcolor))]=$color_id;
			}
		}
		else 
		{
			$color_id=0;
			$yanColorArr[trim(str_replace("'","",$$txtcolor))]=$color_id;
		}
		
		if(str_replace("'",'',$$colorbreackdown)!="")
		{
			$colorbreckdown_array=explode('__',str_replace("'",'',$$colorbreackdown));
			for($c=0; $c < count($colorbreckdown_array); $c++)
			{
				$counter++;
				$colorbreckdownarr=explode('_',$colorbreckdown_array[$c]);
				if(str_replace("'","",$colorbreckdownarr[2])=='0') $colorbreckdownarr[2]="";
				if(str_replace("'","",$colorbreckdownarr[2])!="")
				{
					$fab_colorName=str_replace("'","",$colorbreckdownarr[2]);
					//$fab_colorName="'".trim($fab_colorName)."'";
					//echo $colorbreckdownarr[2].'<br>';
					if(str_replace("'","",$colorbreckdownarr[2])!="")
					{
						if (!in_array(str_replace("'","",$colorbreckdownarr[2]),$new_array_color, TRUE))
						{
							 $color_id = return_id( str_replace("'","",$colorbreckdownarr[2]), $color_library, "lib_color", "id,color_name","521");
							 $new_array_color[$color_id]=str_replace("'","",$colorbreckdownarr[2]);
							 $stripeColorArr[trim($colorbreckdownarr[2])]=$color_id;
						}
						else 
						{
							$color_id =  array_search(str_replace("'","",$colorbreckdownarr[2]), $new_array_color);
							$stripeColorArr[trim($colorbreckdownarr[2])]=$color_id;
						}
					}
					else $color_id=0;
					$stripeColorArr[trim($colorbreckdownarr[2])]=$color_id;
				}
			}
		}
	}
	
	if($operation==0)
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		$approved=0;
		$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$update_id");
		foreach($sql as $row){
			if($row[csf('approved')]==3){
				$approved=1;
			}else{
				$approved=$row[csf('approved')];
			}
		}
		if($approved==1){
			echo "approved**".str_replace("'","",$update_id);
			disconnect($con);die;
		}
		
		$materialReciveNo="";
		$sql=sql_select("select a.recv_number from inv_receive_master a, inv_transaction b, wo_po_break_down c where a.id=b.mst_id and b.job_no=c.job_no_mst and b.job_no=$update_id and a.entry_form=248 and c.is_confirmed=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by a.recv_number");
		foreach($sql as $row)
		{
			if($materialReciveNo=="") $materialReciveNo=$row[csf('recv_number')]; else $materialReciveNo.=','.$row[csf('recv_number')];
		}
		if($materialReciveNo!=""){
			echo "materialRecive**".$materialReciveNo;
			disconnect($con);die;
		}
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="") $wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1);
		
		if(check_table_status( $_SESSION['menu_id'], 1 )==0) { echo "15**0"; die;}
		$field_array="id, job_id, job_no, item_number_id, body_part_id, fab_nature_id, color_type_id, lib_yarn_count_deter_id, construction, composition, fabric_description, gsm_weight, color_size_sensitive, color, avg_cons, fabric_source, rate, amount, avg_finish_cons, avg_process_loss, inserted_by, insert_date, status_active, is_deleted, company_id, costing_per, consumption_basis, process_loss_method, cons_breack_down, msmnt_break_down, color_break_down, yarn_breack_down, marker_break_down, width_dia_type, avg_cons_yarn, gsm_weight_yarn, plan_cut_qty, job_plan_cut_qty, uom, body_part_type, seq, budget_on, quotdtlsid";
		
		$field_array2="id, job_id, pre_cost_fabric_cost_dtls_id, job_no, gmts_color_id, gmts_color, contrast_color_id";

		$id=return_next_id("id", "wo_pre_cost_fabric_cost_dtls", 1);
		$wo_pre_cos_fab_co_color_dtls_id=return_next_id("id", "wo_pre_cos_fab_co_color_dtls", 1);
		$flag=1; $$rID1=$rID2=1;
		
		for ($i=1;$i<=$total_row;$i++)
		{
			$cbogmtsitem="cbogmtsitem_".$i;
			$txtbodypart="txtbodypart_".$i;
			$cbofabricnature="cbofabricnature_".$i;
			$cbocolortype="cbocolortype_".$i;
			$libyarncountdeterminationid="libyarncountdeterminationid_".$i;
			$construction="construction_".$i;
			$composition="composition_".$i;
			$fabricdescription="fabricdescription_".$i;
			$txtgsmweight="txtgsmweight_".$i;
			$cbocolorsizesensitive="cbocolorsizesensitive_".$i;
			$txtcolor="txtcolor_".$i;
			$txtconsumption="txtconsumption_".$i;
			$cbofabricsource="cbofabricsource_".$i;
			$txtrate="txtrate_".$i;
			$txtamount="txtamount_".$i;
			$txtfinishconsumption="txtfinishconsumption_".$i;
			$txtavgprocessloss="txtavgprocessloss_".$i;
			$cbostatus="cbostatus_".$i;
			$consbreckdown="consbreckdown_".$i;
			$msmntbreackdown="msmntbreackdown_".$i;
			$processlossmethod="processlossmethod_".$i;
			$colorbreackdown="colorbreackdown_".$i;
			$yarnbreackdown="yarnbreackdown_".$i;
			$consumptionbasis="consumptionbasis_".$i;
			$markerbreackdown="markerbreackdown_".$i;
			$cbowidthdiatype="cbowidthdiatype_".$i;
	
			$avgtxtconsumption="avgtxtconsumption_".$i;
			$avgtxtgsmweight="avgtxtgsmweight_".$i;
			$plancutqty="plancutqty_".$i;
			$jobplancutqty="jobplancutqty_".$i;
			$uom="uom_".$i;
			$seq="seq_".$i;
			$budgeton="budgeton_".$i;
			$txtbodyparttype="txtbodyparttype_".$i;
			$prifabcostdtlsid="prifabcostdtlsid_".$i;
			$cons_breckdown=substr(str_replace("'","",$$consbreckdown),0,100);
			//color Id;
			if( str_replace("'","",$$cbocolorsizesensitive)==0)
			{
				if(str_replace("'","",$$txtcolor)!="")
				{
					$color_id=$yanColorArr[trim(str_replace("'","",$$txtcolor))];
				}
				else $color_id=0;
			}
			else $color_id=0;
			//color Id End
			//$data_array ="(".$id.",".$hidd_job_id.",".$update_id.",".$$cbogmtsitem.",".$$txtbodypart.",".$$cbofabricnature.",".$$cbocolortype.",".$$libyarncountdeterminationid.",".$$construction.",".$$composition.",".$$fabricdescription.",".$$txtgsmweight.",".$$cbocolorsizesensitive.",".$color_id.",".$$txtconsumption.",".$$cbofabricsource.",".$$txtrate.",".$$txtamount.",".$$txtfinishconsumption.",".$$txtavgprocessloss.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbostatus.",0,".$cbo_company_name.",".$cbo_costing_per.",".$$consumptionbasis.",".$$processlossmethod.",'".$cons_breckdown."',".$$msmntbreackdown.",".$$colorbreackdown.",".$$yarnbreackdown.",".$$markerbreackdown.",".$$cbowidthdiatype.",".$$avgtxtconsumption.",".$$avgtxtgsmweight.",".$$plancutqty.",".$$jobplancutqty.",".$$uom.",".$$txtbodyparttype.",".$$seq.")";
			
			$data_array.="INTO wo_pre_cost_fabric_cost_dtls (".$field_array.") VALUES(".$id.",".$hidd_job_id.",".$update_id.",".$$cbogmtsitem.",".$$txtbodypart.",".$$cbofabricnature.",".$$cbocolortype.",".$$libyarncountdeterminationid.",".$$construction.",".$$composition.",".$$fabricdescription.",".$$txtgsmweight.",".$$cbocolorsizesensitive.",".$color_id.",".$$txtconsumption.",".$$cbofabricsource.",".$$txtrate.",".$$txtamount.",".$$txtfinishconsumption.",".$$txtavgprocessloss.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbostatus.",0,".$cbo_company_name.",".$cbo_costing_per.",".$$consumptionbasis.",".$$processlossmethod.",'".$cons_breckdown."',".$$msmntbreackdown.",".$$colorbreackdown.",".$$yarnbreackdown.",".$$markerbreackdown.",".$$cbowidthdiatype.",".$$avgtxtconsumption.",".$$avgtxtgsmweight.",".$$plancutqty.",".$$jobplancutqty.",".$$uom.",".$$txtbodyparttype.",".$$seq.",".$$budgeton.",".$$prifabcostdtlsid.")";
			
			// Color break down ==================================================================================================
			if(str_replace("'",'',$$colorbreackdown)!="")
			{
				$colorbreckdown_array=explode('__',str_replace("'",'',$$colorbreackdown));
				for($c=0;$c < count($colorbreckdown_array);$c++)
				{
					$counter++;
					$colorbreckdownarr=explode('_',$colorbreckdown_array[$c]);
					
					if(str_replace("'","",$colorbreckdownarr[2])=='0') $colorbreckdownarr[2]="";
					
					$stripecolor_id=$stripeColorArr[trim($colorbreckdownarr[2])];
					if($stripecolor_id=="") $stripecolor_id=0;
					 
					$data_array2="";
					
					$data_array2="INSERT INTO wo_pre_cos_fab_co_color_dtls (".$field_array2.") VALUES(".$wo_pre_cos_fab_co_color_dtls_id.",".$hidd_job_id.",".$id.",".$update_id.",".$colorbreckdownarr[0].",'".$colorbreckdownarr[1]."','".$stripecolor_id."')";
					$wo_pre_cos_fab_co_color_dtls_id=$wo_pre_cos_fab_co_color_dtls_id+1;
					
					$rID2=execute_query($data_array2);
					if ($rID2==1 && $flag==1) { $flag=1; }
					else { echo "10**coColor-".$data_array2; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
				}
			}
			$id=$id+1;
		}
		
		$queryfab="INSERT ALL ".$data_array." SELECT * FROM dual";
		$rID1=execute_query($queryfab);
		if($rID1==1 && $flag==1) $flag=1; else $flag=0;
		
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$field_array5="id, job_id, job_no, fab_yarn_req_kg, fab_woven_req_yds, fab_knit_req_kg, fab_woven_fin_req_yds, fab_knit_fin_req_kg, fab_amount, avg, pro_woven_grey_fab_req_yds, pro_knit_grey_fab_req_kg, pro_woven_fin_fab_req_yds, pro_knit_fin_fab_req_kg, pur_woven_grey_fab_req_yds, pur_knit_grey_fab_req_kg, pur_woven_fin_fab_req_yds, pur_knit_fin_fab_req_kg, woven_amount, knit_amount";
			$data_array5="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$tot_yarn_needed.",".$txtwoven_sum.",".$txtknit_sum.",".$txtwoven_fin_sum.",".$txtknit_fin_sum.",".$txtamount_sum.",".$avg.",".$txtwoven_sum_production.",".$txtknit_sum_production.",".$txtwoven_fin_sum_production.",".$txtknit_fin_sum_production.",".$txtwoven_sum_purchase.",".$txtknit_sum_purchase.",".$txtwoven_fin_sum_purchase.",".$txtknit_fin_sum_purchase.",".$txtwoven_amount_sum_purchase.",".$txtkint_amount_sum_purchase.")";
			$rID_in5=sql_insert("wo_pre_cost_sum_dtls",$field_array5,$data_array5,1);
			if($rID_in5==1 && $flag==1) $flag=1; else $flag=0;
		}

		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			$field_array5="fab_yarn_req_kg*fab_woven_req_yds*fab_knit_req_kg*fab_woven_fin_req_yds*fab_knit_fin_req_kg*fab_amount*avg*pro_woven_grey_fab_req_yds*pro_knit_grey_fab_req_kg*pro_woven_fin_fab_req_yds*pro_knit_fin_fab_req_kg*pur_woven_grey_fab_req_yds*pur_knit_grey_fab_req_kg*pur_woven_fin_fab_req_yds*pur_knit_fin_fab_req_kg*woven_amount*knit_amount*status_active*is_deleted";
			$data_array5 ="".$tot_yarn_needed."*".$txtwoven_sum."*".$txtknit_sum."*".$txtwoven_fin_sum."*".$txtknit_fin_sum."*".$txtamount_sum."*".$avg."*".$txtwoven_sum_production."*".$txtknit_sum_production."*".$txtwoven_fin_sum_production."*".$txtknit_fin_sum_production."*".$txtwoven_sum_purchase."*".$txtknit_sum_purchase."*".$txtwoven_fin_sum_purchase."*".$txtknit_fin_sum_purchase."*".$txtwoven_amount_sum_purchase."*".$txtkint_amount_sum_purchase."*1*0";
			$rID_in5=sql_update("wo_pre_cost_sum_dtls",$field_array5,$data_array5,"job_no","".$update_id."",1);
			if($rID_in5==1 && $flag==1) $flag=1; else $flag=0;
		}
		// color break down end ===============================================================================================
		$tot_com_amount=0;
		
		if($flag==1) $tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);
		check_table_status( $_SESSION['menu_id'],0);

		if($db_type==2 || $db_type==1 )
		{
			if($flag==1)
			{
				oci_commit($con);
				echo "0**".$id."**".$flag."**".$tot_com_amount;
			}
			else
			{
				oci_rollback($con);
				echo "10**".$id."**".$flag."**".$tot_com_amount;
			}
		}
		disconnect($con);
		die;
	}
	else if($operation==1)// Update here ====================================================================================
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		$component_approved=return_field_value("current_approval_status", "co_com_pre_costing_approval", "job_no=$update_id and cost_component_id=1");
		if($component_approved==3) $component_approved=1;
		$approved=0;
		$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$update_id");
		foreach($sql as $row){
			if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
		}
		if($approved==1 || $component_approved==1){
			echo "approved**".str_replace("'","",$update_id);
			disconnect($con);die;
		}
		
		$materialReciveNo="";
		$sql=sql_select("select a.recv_number from inv_receive_master a, inv_transaction b, wo_po_break_down c where a.id=b.mst_id and b.job_no=c.job_no_mst and b.job_no=$update_id and a.entry_form=248 and c.is_confirmed=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by a.recv_number");
		foreach($sql as $row)
		{
			if($materialReciveNo=="") $materialReciveNo=$row[csf('recv_number')]; else $materialReciveNo.=','.$row[csf('recv_number')];
		}
		if($materialReciveNo!=""){
			echo "materialRecive**".$materialReciveNo;
			disconnect($con);die;
		}
		
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from wo_pre_cost_sum_dtls where job_no =$update_id and status_active=1 and is_deleted=0";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="") $wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1);

		//if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**1"; die;}
		$yarn_data_arr=array(); $row_cons_arr=array();
		$field_array_up="job_no*item_number_id*body_part_id*fab_nature_id*color_type_id*lib_yarn_count_deter_id*construction*composition*fabric_description*gsm_weight*color_size_sensitive* 	color*avg_cons*fabric_source*rate*amount*avg_finish_cons*avg_process_loss*updated_by*update_date*status_active*is_deleted*company_id*costing_per*consumption_basis*process_loss_method*cons_breack_down*msmnt_break_down*color_break_down*yarn_breack_down*marker_break_down*width_dia_type*avg_cons_yarn*gsm_weight_yarn*plan_cut_qty*job_plan_cut_qty*is_apply_last_update*uom*body_part_type*sample_id*seq";
		
		$field_array2="id, job_id, pre_cost_fabric_cost_dtls_id, job_no, gmts_color_id, gmts_color, contrast_color_id";
		
		$wo_pre_cos_fab_co_color_dtls_id=return_next_id( "id", "wo_pre_cos_fab_co_color_dtls", 1);
		
		$lib_yarn_deter_id_str="";
		$rIDStColor=1; $rID2=1; $rID_up=1; $rID1=1; $flag=1;
		for ($i=1;$i<=$total_row;$i++)
		{
			$cbogmtsitem="cbogmtsitem_".$i;
			$txtbodypart="txtbodypart_".$i;
			$cbofabricnature="cbofabricnature_".$i;
			$cbocolortype="cbocolortype_".$i;
			$libyarncountdeterminationid="libyarncountdeterminationid_".$i;
            $construction="construction_".$i;
			$composition="composition_".$i;
			$fabricdescription="fabricdescription_".$i;
			$txtgsmweight="txtgsmweight_".$i;
			$cbocolorsizesensitive="cbocolorsizesensitive_".$i;
			$txtcolor="txtcolor_".$i;
			$txtconsumption="txtconsumption_".$i;
			$cbofabricsource="cbofabricsource_".$i;
			$txtrate="txtrate_".$i;
			$txtamount="txtamount_".$i;
			$txtfinishconsumption="txtfinishconsumption_".$i;
			$txtavgprocessloss="txtavgprocessloss_".$i;
			$cbostatus="cbostatus_".$i;
			$consbreckdown="consbreckdown_".$i;
			$msmntbreackdown="msmntbreackdown_".$i;
			$updateid="updateid_".$i;
			$processlossmethod="processlossmethod_".$i;
			$colorbreackdown="colorbreackdown_".$i;
			$yarnbreackdown="yarnbreackdown_".$i;
			$consumptionbasis="consumptionbasis_".$i;
			$markerbreackdown="markerbreackdown_".$i;
			$cbowidthdiatype="cbowidthdiatype_".$i;
			$avgtxtconsumption="avgtxtconsumption_".$i;
			$avgtxtgsmweight="avgtxtgsmweight_".$i;
			$plancutqty="plancutqty_".$i;
			$jobplancutqty="jobplancutqty_".$i;
			$isclickedconsinput="isclickedconsinput_".$i;
			$oldlibyarncountdeterminationid="oldlibyarncountdeterminationid_".$i;
			$isconspopupupdate="isconspopupupdate_".$i;
			$uom="uom_".$i;
			$seq="seq_".$i;
			$txtbodyparttype="txtbodyparttype_".$i;
			
			$exsample_data=explode('_',str_replace("'",'',$$msmntbreackdown));
			$sample_id=$exsample_data[7];
			
			$lib_yarn_deter_id_str.=str_replace("'","",$$libyarncountdeterminationid).',';
			$yarn_data_arr[str_replace("'",'',$$updateid)]=str_replace("'",'',$$libyarncountdeterminationid).'_'.str_replace("'",'',$$oldlibyarncountdeterminationid);
			$row_cons_arr[str_replace("'",'',$$updateid)]=str_replace("'",'',$$txtconsumption);
			
			if( str_replace("'","",$$cbocolorsizesensitive)==0)
			{
				if(str_replace("'","",$$txtcolor)!="")
				{
					$color_id=$yanColorArr[trim(str_replace("'","",$$txtcolor))];
				}
				else $color_id=0;
			}
			else $color_id=0;
			//color Id End
			$cons_breckdown=substr(str_replace("'","",$$consbreckdown),0,100);
			if(str_replace("'",'',$$updateid)!="")
			{
				$id_arr[]=str_replace("'",'',$$updateid);
				$data_array_up[str_replace("'",'',$$updateid)] =explode("*",("".$update_id."*".$$cbogmtsitem."*".$$txtbodypart."*".$$cbofabricnature."*".$$cbocolortype."*".$$libyarncountdeterminationid."*".$$construction."*".$$composition."*".$$fabricdescription."*".$$txtgsmweight."*".$$cbocolorsizesensitive."*".$color_id."*".$$txtconsumption."*".$$cbofabricsource."*".$$txtrate."*".$$txtamount."*".$$txtfinishconsumption."*".$$txtavgprocessloss."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*".$$cbostatus."*0*".$cbo_company_name."*".$cbo_costing_per."*".$$consumptionbasis."*".$$processlossmethod."*'".$cons_breckdown."'*".$$msmntbreackdown."*".$$colorbreackdown."*".$$yarnbreackdown."*".$$markerbreackdown."*".$$cbowidthdiatype."*".$$avgtxtconsumption."*".$$avgtxtgsmweight."*".$$plancutqty."*".$$jobplancutqty."*".$$isclickedconsinput."*".$$uom."*".$$txtbodyparttype."*'".$sample_id."'*".$$seq.""));
			}// end if(str_replace("'",'',$$updateid)!="")
			
			// Color break down ==================================================================================================
			if(str_replace("'",'',$$colorbreackdown)!="")
			{
				$rIDStColor=execute_query( "delete from wo_pre_cos_fab_co_color_dtls where pre_cost_fabric_cost_dtls_id =".$$updateid."",0);
				if ($rIDStColor==1 && $flag==1) { $flag=1; }
				else { echo "10**stripeColorDelUp-"; $flag=0; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
				$colorbreckdown_array=explode('__',str_replace("'",'',$$colorbreackdown));
				for($c=0;$c < count($colorbreckdown_array);$c++)
				{
					$counter++;
					$colorbreckdownarr=explode('_',$colorbreckdown_array[$c]); 
					// color ID
					if( str_replace("'","",$$cbocolorsizesensitive)==3)
					{
						if(str_replace("'","",$colorbreckdownarr[2])=='0') $colorbreckdownarr[2]='';
						
						$stripecolor_id=$stripeColorArr[trim($colorbreckdownarr[2])];
						if($stripecolor_id=="") $stripecolor_id=0;
						$data_array2="";
						$data_array2="INSERT INTO wo_pre_cos_fab_co_color_dtls (".$field_array2.") VALUES(".$wo_pre_cos_fab_co_color_dtls_id.",".$hidd_job_id.",".$$updateid.",".$update_id.",".$colorbreckdownarr[0].",'".$colorbreckdownarr[1]."','".$stripecolor_id."')";
						$wo_pre_cos_fab_co_color_dtls_id=$wo_pre_cos_fab_co_color_dtls_id+1;
						
						$rID2=execute_query($data_array2);
						if ($rID2==1 && $flag==1) { $flag=1; }
						else { echo "10**coColorup-".$data_array2; oci_rollback($con); check_table_status( $_SESSION['menu_id'],0); disconnect($con); die; }
					}//Sensitivity Contrast color
				}
			}//  color break down end ===============================================================================================
		}// end master for loop
		$rID_up=execute_query(bulk_update_sql_statement( "wo_pre_cost_fabric_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
		if($rID_up==1 && $flag==1) $flag=1; else $flag=0;
					
		$lib_yarn_deter_id_str=implode(',',array_filter(array_unique(explode(",",$lib_yarn_deter_id_str))));			
		$libdeter_sql="select a.id, b.id as bid, b.copmposition_id, b.percent, b.count_id, b.type_id from lib_yarn_count_determina_mst a, lib_yarn_count_determina_dtls b where a.id=b.mst_id and a.id in ($lib_yarn_deter_id_str) and b.status_active=1 and b.is_deleted=0";//hidden id skip
		
		$libdeter_sql_res=sql_select($libdeter_sql);
		$libyarn_data_arr=array(); $lib_yarn_per=array();
		
		foreach($libdeter_sql_res as $row)
		{
			$libyarn_data_arr[$row[csf('id')]].=$row[csf('copmposition_id')].'_'.$row[csf('percent')].'_'.$row[csf('count_id')].'_'.$row[csf('type_id')].'**';
			$lib_yarn_per[]=$row[csf('percent')];
		}
		unset($libdeter_sql_res);
		//echo "10**";
		//print_r($libyarn_data_arr); die;
		
		$job_sql="select b.id, d.id as cid, d.plan_cut_qnty, d.item_number_id, d.color_number_id from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown d where a.job_no=$update_id and a.job_no=b.job_no_mst and a.job_no=d.job_no_mst and b.id=d.po_break_down_id and b.status_active=1 and b.is_deleted=0 and d.status_active=1 and d.is_deleted=0 "; //skip conditional job no
		$job_sql_res=sql_select($job_sql);//echo "10**";and b.id=33953
		$job_data_arr=array();
		$item_colora=array();
		
		foreach($job_sql_res as $row)
		{
			$item_colora[$row[csf('cid')]]=$row[csf('item_number_id')];
			$job_data_arr[$row[csf('id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]]+=$row[csf('plan_cut_qnty')];
		}
		unset($job_sql_res);
		//print_r($job_data_arr);
		
		$condition= new condition();
		if(str_replace("'","",$update_id) !=''){
			$condition->job_no("=$update_id");
		}
		$condition->init();
		$GmtsitemRatioArr=$condition->getGmtsitemRatioArr();
		//print_r($GmtsitemRatioArr);
		$fabric= new fabric($condition);
		$fabric_costing_arr=$fabric->getQtyArray_by_FabriccostidAndGmtscolor_knitAndwoven_greyAndfinish();	
		$cost_per_qty_arr=$condition->getCostingPerArr();
		$job_no=str_replace("'","",$update_id);
		$cost_per_qty=$cost_per_qty_arr[$job_no];
		
		$yarn_cons_dtls_arr=array();
		$yarn_cons_dtls_sql="select pre_cost_fabric_cost_dtls_id, color_size_table_id, po_break_down_id, color_number_id, requirment from wo_pre_cos_fab_co_avg_con_dtls where job_no=$update_id and status_active=1 and is_deleted=0 and cons!=0";
		$yarn_cons_dtls_sql_res=sql_select($yarn_cons_dtls_sql);
		foreach($yarn_cons_dtls_sql_res as $row)
		{
			$plan_cut_qty=0; $item_id=0;
			$item_id=$item_colora[$row[csf('color_size_table_id')]];
			$plan_cut_qty=$job_data_arr[$row[csf('po_break_down_id')]][$item_id][$row[csf('color_number_id')]];
			
			$GmtsitemRatio=$GmtsitemRatioArr[$job_no][$item_id];
			
			$greyreq=array_sum($fabric_costing_arr['sweater']['grey'][$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('color_number_id')]]);
			$totgreyreq=($greyreq/$plan_cut_qty)*($cost_per_qty*$GmtsitemRatio); 
			//echo $totgreyreq.'='.$greyreq.'='.$plan_cut_qty.'='.$cost_per_qty.'='.str_replace("'","",$update_id)."<br>";
			
			$yarn_cons_dtls_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('color_number_id')]]+=$totgreyreq;
		}
		unset($yarn_cons_dtls_sql_res);
		
		$stripe_dataarr=array(); $actual_avg_cons=array();
		$stripe_data="select pre_cost_fabric_cost_dtls_id, item_number_id, color_number_id, stripe_color, measurement, excess_per, cons from wo_pre_stripe_color where job_no=$update_id and status_active=1 and is_deleted=0";
		$tot_stripe_cons=0;
		$stripe_data_res=sql_select($stripe_data);
		foreach($stripe_data_res as $row)
		{
			$stripe_dataarr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('stripe_color')]]['scons']+=$row[csf('measurement')];
			$stripe_dataarr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('stripe_color')]]['str'].=$row[csf('cons')].'***'.$row[csf('excess_per')].',';
			$tot_stripe_cons+=$row[csf('cons')];
		}
		unset($stripe_data_res);
		
		$yarn_str_arr=array(); $yarnSaveString=array();
		$yarn_str="select id, fabric_cost_dtls_id, job_no, count_id, copm_one_id, percent_one, color, type_id, cons_ratio, cons_qnty, avg_cons_qnty, consdznlbs, supplier_id, rate, amount from wo_pre_cost_fab_yarn_cost_dtls where job_no=$update_id and status_active=1 and is_deleted=0";
		
		$yarn_str_res=sql_select($yarn_str);
		foreach($yarn_str_res as $row)
		{
			if($row[csf('color')]=="") $row[csf('color')]=0;
			if($row[csf('cons_ratio')]=="") $row[csf('cons_ratio')]=0;
			if($row[csf('count_id')]=="") $row[csf('count_id')]=0;
			if($row[csf('copm_one_id')]=="") $row[csf('copm_one_id')]=0;
			if($row[csf('percent_one')]=="") $row[csf('percent_one')]=0;
			if($row[csf('type_id')]=="") $row[csf('type_id')]=0;
			if($row[csf('supplier_id')]=="") $row[csf('supplier_id')]=0;
			if($row[csf('rate')]=="") $row[csf('rate')]=0;
			if($row[csf('amount')]=="") $row[csf('amount')]=0;
			if($row[csf('avg_cons_qnty')]=="") $row[csf('avg_cons_qnty')]=0;
			if($row[csf('consdznlbs')]=="") $row[csf('consdznlbs')]=0;
			
			$yarn_str_arr[$row[csf('fabric_cost_dtls_id')]][$row[csf('color')]][$row[csf('cons_ratio')]]=$row[csf('count_id')].'_'.$row[csf('copm_one_id')].'_'.$row[csf('percent_one')].'_'.$row[csf('type_id')].'_'.$row[csf('supplier_id')].'_'.$row[csf('rate')].'_'.$row[csf('amount')].'_'.$row[csf('avg_cons_qnty')].'_'.$row[csf('consdznlbs')].'_'.$row[csf('cons_ratio')];
			
			if(isset($yarnSaveString[$row[csf('fabric_cost_dtls_id')]]))
			{
				$yarnSaveString[$row[csf('fabric_cost_dtls_id')]].= "**".$row[csf('copm_one_id')]."_".$row[csf('percent_one')]."_".$row[csf('count_id')]."_".$row[csf('type_id')]."_".$row[csf('cons_ratio')]."_".$row[csf('color')];
			}
			else
			{
				$yarnSaveString[$row[csf('fabric_cost_dtls_id')]]=$row[csf('copm_one_id')]."_".$row[csf('percent_one')]."_".$row[csf('count_id')]."_".$row[csf('type_id')]."_".$row[csf('cons_ratio')]."_".$row[csf('color')];
			}
		}
		/*echo "10**<pre>";
		print_r($yarn_str_arr[45463]); die;*/
		unset($yarn_str_res);
		
		$field_array3="id, job_id, fabric_cost_dtls_id, job_no, count_id, copm_one_id, percent_one, color, type_id, cons_ratio, cons_qnty, avg_cons_qnty, consdznlbs, rate, amount,supplier_id, inserted_by, insert_date, status_active, is_deleted";// avg_cons_qnty, consdznlbs, rate, amount,
		$fab_yarn_cost_dtls_id=return_next_id( "id", "wo_pre_cost_fab_yarn_cost_dtls",1);  //echo "10**";check_table_status( $_SESSION['menu_id'],0);
		//echo "10**delete from wo_pre_cost_fab_yarn_cost_dtls where job_no =".$update_id.""; die;
		$rID_de2=execute_query( "delete from wo_pre_cost_fab_yarn_cost_dtls where job_no =".$update_id."",0);
		
		$yarndataArr=array();
		//echo "10**<pre>";
		foreach($yarn_data_arr as $pre_id=>$lib_data)
		{
			$row_cons=0;
			$row_cons=$row_cons_arr[$pre_id];
			
			$emst_data=explode("_",$lib_data);
			$libyarncountdeterminationid=$emst_data[0];
			$oldlibyarncountdeterminationid=$emst_data[1];
			$libyarn_data=array_filter(explode("**",$libyarn_data_arr[$libyarncountdeterminationid]));
			foreach($libyarn_data as $libid=>$libdata)//for($c=0; $c<count($libyarn_data); $c++)
			{
				$yarnbreckdownarr=explode('_',$libdata);
				$count_id=$copmposition_id=$percent=$type_id=0;
				$copmposition_id=$yarnbreckdownarr[0];
				if($yarnbreckdownarr[1]==0 || $yarnbreckdownarr[1]=='') $yarnbreckdownarr[1]=100;
				$percent=$yarnbreckdownarr[1];
				$count_id=$yarnbreckdownarr[2];
				$type_id=$yarnbreckdownarr[3];
				
				$stripe_data=$stripe_dataarr[$pre_id];
				foreach($stripe_data as $stp_color=>$req)
				{
					$save_data=$yarn_str_arr[$pre_id][$stp_color][$percent];
					//echo $save_data.'<br>';
					$ex_save_data=explode("_",$save_data);
					$supplier_id=$rate=0;
					if(trim($save_data)!="")
					{
						$count_id=$ex_save_data[0];
						$copmposition_id=$ex_save_data[1];
						$type_id=$ex_save_data[3];
						$supplier_id=$ex_save_data[4];
						$rate=$ex_save_data[5];
					}
					
					$exstr=array_filter(explode(",",$req['str']));
					$avg_cons_dzn=0;
					foreach ($exstr as $rstr)
					{
						$exstr=explode("***",$rstr);
						$cons=$exstr[0];
						$exper=$exstr[1]/100;
						
						$cons_percent=0; $add_extra_cons=0; $tot_avg_cons=0;
						$cons_percent=$cons/$tot_stripe_cons;
						
						$add_extra_cons=($cons_percent*$row_cons)*$exper;
						$tot_avg_cons=($cons_percent*$row_cons)+$add_extra_cons;
						$avg_cons_dzn+=$tot_avg_cons;
					}
					$consdznlbs=0; $amount=0; $req_cons=0;
					
					$consdznlbs=$avg_cons_dzn*2.20462;
					$amount=$consdznlbs*$rate;
					$req_cons=($req['scons']*$percent)/100;
					//echo $avg_cons_dzn.'-'.$consdznlbs.'-'.$rate.'-'.$amount.'-'.$req_cons.'<br>';
					
					$data_array3="(".$fab_yarn_cost_dtls_id.",".$hidd_job_id.",".$pre_id.",".$update_id.",'".$count_id."','".$copmposition_id."','100','".$stp_color."','".$type_id."','".$percent."','".number_format($req_cons,4,'.','')."','".number_format($avg_cons_dzn,4,'.','')."','".number_format($consdznlbs,4,'.','')."','".$rate."','".number_format($amount,4,'.','')."','".$supplier_id."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";//'".number_format($req_cons,4,'.','')."','".$rate."','".$amount."',
					$fab_yarn_cost_dtls_id++;
					//echo "10**Insert into wo_pre_cost_fab_yarn_cost_dtls ($field_array3) values $data_array3"; 
					$rID_3=sql_insert("wo_pre_cost_fab_yarn_cost_dtls",$field_array3,$data_array3,0);
				}
			}
		}
		
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$field_array5="id, job_id, job_no, fab_yarn_req_kg, fab_woven_req_yds, fab_knit_req_kg, fab_woven_fin_req_yds, fab_knit_fin_req_kg, fab_amount, avg, pro_woven_grey_fab_req_yds, pro_knit_grey_fab_req_kg, pro_woven_fin_fab_req_yds, pro_knit_fin_fab_req_kg, pur_woven_grey_fab_req_yds, pur_knit_grey_fab_req_kg, pur_woven_fin_fab_req_yds, pur_knit_fin_fab_req_kg, woven_amount, knit_amount";
			$data_array5="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$tot_yarn_needed.",".$txtwoven_sum.",".$txtknit_sum.",".$txtwoven_fin_sum.",".$txtknit_fin_sum.",".$txtamount_sum.",".$avg.",".$txtwoven_sum_production.",".$txtknit_sum_production.",".$txtwoven_fin_sum_production.",".$txtknit_fin_sum_production.",".$txtwoven_sum_purchase.",".$txtknit_sum_purchase.",".$txtwoven_fin_sum_purchase.",".$txtknit_fin_sum_purchase.",".$txtwoven_amount_sum_purchase.",".$txtkint_amount_sum_purchase.")";
			$rID6=sql_insert("wo_pre_cost_sum_dtls",$field_array5,$data_array5,1);
			if($rID6==1 && $flag==1) $flag=1; else $flag=0;
		}

		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			$field_array5="fab_yarn_req_kg*fab_woven_req_yds*fab_knit_req_kg*fab_woven_fin_req_yds*fab_knit_fin_req_kg*fab_amount*avg*pro_woven_grey_fab_req_yds*pro_knit_grey_fab_req_kg*pro_woven_fin_fab_req_yds*pro_knit_fin_fab_req_kg*pur_woven_grey_fab_req_yds*pur_knit_grey_fab_req_kg*pur_woven_fin_fab_req_yds*pur_knit_fin_fab_req_kg*woven_amount*knit_amount*status_active*is_deleted";
			$data_array5 ="".$tot_yarn_needed."*".$txtwoven_sum."*".$txtknit_sum."*".$txtwoven_fin_sum."*".$txtknit_fin_sum."*".$txtamount_sum."*".$avg."*".$txtwoven_sum_production."*".$txtknit_sum_production."*".$txtwoven_fin_sum_production."*".$txtknit_fin_sum_production."*".$txtwoven_sum_purchase."*".$txtknit_sum_purchase."*".$txtwoven_fin_sum_purchase."*".$txtknit_fin_sum_purchase."*".$txtwoven_amount_sum_purchase."*".$txtkint_amount_sum_purchase."*1*0";
			$rID6=sql_update("wo_pre_cost_sum_dtls",$field_array5,$data_array5,"job_no","".$update_id."",1);
			if($rID6==1 && $flag==1) $flag=1; else $flag=0;
		}
		/*echo "10**<pre>ll";
		print_r($yarndataArr[45463]);
		
		die;*/
		$tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);
		//check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID_up )
			{
				mysql_query("COMMIT");
				echo "1**".$update_id."**".$rID_up."**".$tot_com_amount;
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "10**".$update_id."**".$rID_up."**".$tot_com_amount;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID_up)
			{
				oci_commit($con);
				echo "1**".$update_id."**".$rID_up."**".$tot_com_amount;
			}
			else
			{
				oci_rollback($con);
				echo "10**".$update_id."**".$rID_up."**".$tot_com_amount;
			}
		}
		disconnect($con);
		die;
	}
	else if ($operation==3)   // Update Here
	{

		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
				//echo "1**select a.copy_quatation,b.quotation_id from wo_pre_cost_mst a, wo_po_details_master b where a.job_no=b.job_no and  a.job_no=$txt_job_no"; die;

		/*$approved=0;
		$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$txt_job_no");
		foreach($sql as $row){
			$approved=$row[csf('approved')];
		}
		if($approved==1){
			echo "approved**".str_replace("'","",$txt_job_no);
			die;
		}*/

		

		$field_array="approved*approved_by*approved_date";

		if(trim(str_replace("'","",$bomfyarn_approval_id))==1)
		{
			$data_array="'1'*'".$_SESSION['logic_erp']['user_id']."'*'".$pc_date_time."'";
		}
		else
		{
			$data_array="'2'*'".$_SESSION['logic_erp']['user_id']."'*'".$pc_date_time."'";

		}

		$rID=sql_update("wo_pre_cost_mst",$field_array,$data_array,"job_no",$update_id,1);

		
		if($db_type==0)
		{
			
			if($rID ){
				mysql_query("COMMIT");
				echo "3**".$rID."**".str_replace("'","",$update_id)."**".trim(str_replace("'","",$bomfyarn_approval_id));
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$rID."**".str_replace("'","",$update_id)."**".trim(str_replace("'","",$bomfyarn_approval_id));
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "3**".$rID."**".str_replace("'","",$update_id)."**".trim(str_replace("'","",$bomfyarn_approval_id));
			}
			else{
				oci_rollback($con);
				echo "10**".$rID."**".str_replace("'","",$update_id)."**".trim(str_replace("'","",$bomfyarn_approval_id));
			}
		}
		disconnect($con);
		die;
	}
// Update End ==========================================================================================
}

if ($action=="save_update_delet_fabric_yarn_cost_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$sql=sql_select("select approval_need from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
	$app_nessity=2;
	foreach($sql as $row){
		$app_nessity=$row[csf('approval_need')];
	}

	$sql=sql_select("select approved from wo_price_quotation  where id=$txt_quotation_id");
	$quatation_approved=2;
	foreach($sql as $row){
		$quatation_approved=$row[csf('approved')];
	}

	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	//echo "10**",$is_copy_quatation."**". $app_nessity."**".$quatation_approved;
	//die;
	if($is_copy_quatation==1 && $app_nessity==1){
		if($quatation_approved==2 || $quatation_approved==0 || $quatation_approved==3){
			echo "quataNotApp**".str_replace("'","",$txt_job_no);
			disconnect($con);die;
		}
	}

	if($operation==0)
	{
	    $con = connect();
		if($db_type==0) mysql_query("BEGIN");
		
		$approved=0;
		$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$update_id");
		foreach($sql as $row){
			if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
		}
		if($approved==1){
			echo "approved**".str_replace("'","",$update_id);
			disconnect($con);die;
		}
		if(check_table_status( $_SESSION['menu_id'], 1)==0 ) { echo "15**0";disconnect($con); die;}

		$id=return_next_id( "id", "wo_pre_cost_fab_yarn_cost_dtls", 1 ) ;
		$field_array="id, job_id, job_no, count_id, copm_one_id, percent_one, color, type_id, supplier_id,source, cons_qnty, avg_cons_qnty, consdznlbs, rate, amount, inserted_by, insert_date, status_active, is_deleted";
		$new_array_color=array();
		for ($i=1;$i<=$total_row;$i++)
		{
			$cbocount="cbocount_".$i;
			$cbocompone="cbocompone_".$i;
			$percentone="percentone_".$i;
			//$cbocomptwo="cbocomptwo_".$i;
			
			$cbotype="cbotype_".$i;
			
			$consqnty="consqnty_".$i;
			$avgconsqnty="avgconsqnty_".$i;
			$txtconsdznlbs="txtconsdznlbs_".$i;
			$txtrateyarn="txtrateyarn_".$i;
			$txtamountyarn="txtamountyarn_".$i;
			$updateidyarncost="updateidyarncost_".$i;
			$supplier="supplier_".$i;
			$source="source_".$i;
			$color="color_".$i;
			
			if(str_replace("'","",$$color)!="")
			{
				if (!in_array(str_replace("'","",$$color),$new_array_color))
				{
					$color_id = return_id( str_replace("'","",$$color), $color_library, "lib_color", "id,color_name","521");  
					$new_array_color[$color_id]=str_replace("'","",$$color);
				}
				else $color_id =  array_search(str_replace("'","",$$color), $color_library);
			}
			else $color_id=0;

			if ($i!=1) $data_array .=",";
			$data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cbocount.",".$$cbocompone.",".$$percentone.",".$color_id.",".$$cbotype.",".$$supplier.",".$$source.",".$$consqnty.",".$$avgconsqnty.",".$$txtconsdznlbs.",".$$txtrateyarn.",".$$txtamountyarn.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
			$id=$id+1;
		}
		$rID=sql_insert(" wo_pre_cost_fab_yarn_cost_dtls",$field_array,$data_array,0);
		//=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array1="id, job_id, job_no, yarn_cons_qnty, yarn_amount";
			$data_array1="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtconsumptionyarn_sum.",".$txtamountyarn_sum.")";
			$rID1=sql_insert("wo_pre_cost_sum_dtls",$field_array1,$data_array1,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array1="yarn_cons_qnty*yarn_amount";
			$data_array1 ="".$txtconsumptionyarn_sum."*".$txtamountyarn_sum."";
			$rID1=sql_update("wo_pre_cost_sum_dtls",$field_array1,$data_array1,"job_no","".$update_id."",1);
		}
		//=======================sum End =================
		$tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);
		check_table_status( $_SESSION['menu_id'],0);

		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "0**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "0**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		disconnect($con);
		die;
	}
	else if($operation==1)
	{
	    $con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		$component_approved=return_field_value("current_approval_status", "co_com_pre_costing_approval", "job_no=$update_id and cost_component_id=1");
		if($component_approved==3) $component_approved=1;
		
		$approved=0;
		$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$update_id");
		foreach($sql as $row){
			if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
		}
		if($approved==1 || $component_approved==1){
			echo "approved**".str_replace("'","",$update_id);
			disconnect($con);die;
		}
		
		$materialReciveNo="";
		$sql=sql_select("select a.recv_number from inv_receive_master a, inv_transaction b, wo_po_break_down c where a.id=b.mst_id and b.job_no=c.job_no_mst and b.job_no=$update_id and a.entry_form=248 and c.is_confirmed=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by a.recv_number");
		foreach($sql as $row)
		{
			if($materialReciveNo=="") $materialReciveNo=$row[csf('recv_number')]; else $materialReciveNo.=','.$row[csf('recv_number')];
		}
		if($materialReciveNo!=""){
			echo "materialRecive**".$materialReciveNo;
			disconnect($con);die;
		}
		if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**1"; die;}
		$field_array_up="job_no*count_id*copm_one_id*percent_one*color*type_id*supplier_id*source*cons_qnty*avg_cons_qnty*consdznlbs*rate*amount*updated_by*update_date*status_active*is_deleted";
		$field_array="id, job_id, job_no, count_id, copm_one_id, percent_one, color, type_id, supplier_id,source, cons_qnty, avg_cons_qnty, consdznlbs, rate, amount, inserted_by, insert_date, status_active, is_deleted";
		$new_array_color=array();
		$add_comma=0;
		$id=return_next_id( "id", " wo_pre_cost_fab_yarn_cost_dtls", 1 ) ;
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cbocount="cbocount_".$i;
			 $cbocompone="cbocompone_".$i;
			 $percentone="percentone_".$i;
			 //$cbocomptwo="cbocomptwo_".$i;
			 //$percenttwo="percenttwo_".$i;
			 
			 $cbotype="cbotype_".$i;
			 $consqnty="consqnty_".$i;
			 $avgconsqnty="avgconsqnty_".$i;
			 $txtconsdznlbs="txtconsdznlbs_".$i;
			 $txtrateyarn="txtrateyarn_".$i;
			 $txtamountyarn="txtamountyarn_".$i;
			 $updateidyarncost="updateidyarncost_".$i;
			 $supplier="supplier_".$i;
			 $source="source_".$i;
			 $color="color_".$i;
			if(str_replace("'","",$$color)!="")
			{
				if (!in_array(str_replace("'","",$$color),$new_array_color))
				{
					$color_id = return_id( str_replace("'","",$$color), $color_library, "lib_color", "id,color_name","521");  
					$new_array_color[$color_id]=str_replace("'","",$$color);
				}
				else $color_id =  array_search(str_replace("'","",$$color), $color_library);
			}
			else $color_id=0;
			
			if(str_replace("'",'',$$updateidyarncost)!="")
			{
				$id_arr[]=str_replace("'",'',$$updateidyarncost);
				$data_array_up[str_replace("'",'',$$updateidyarncost)] =explode(",",("".$update_id.",".$$cbocount.",".$$cbocompone.",".$$percentone.",'".$color_id."',".$$cbotype.",".$$supplier.",".$$source.",".$$consqnty.",".$$avgconsqnty.",".$$txtconsdznlbs.",".$$txtrateyarn.",".$$txtamountyarn.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0"));
			}
			if(str_replace("'",'',$$updateidyarncost)=="")
			{
				if ($add_comma!=0) $data_array .=",";
			    $data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cbocount.",".$$cbocompone.",".$$percentone.",".$color_id.",".$$cbotype.",".$$supplier.",".$$suppliersource.",".$$consqnty.",".$$avgconsqnty.",".$$txtconsdznlbs.",".$$txtrateyarn.",".$$txtamountyarn.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
			    $id=$id+1;
			    $add_comma++;
			}
		 }
		 $rID=execute_query(bulk_update_sql_statement( "wo_pre_cost_fab_yarn_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
		 //echo "1**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
		 //echo bulk_update_sql_statement( "wo_pre_cost_fab_yarn_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr );
		 if($data_array !="")
		 {
			$rID1=sql_insert("wo_pre_cost_fab_yarn_cost_dtls",$field_array,$data_array,0);
		 }

		 //=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, yarn_cons_qnty, yarn_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtconsumptionyarn_sum.",".$txtamountyarn_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}

		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="yarn_cons_qnty*yarn_amount";
			$data_array2 ="".$txtconsumptionyarn_sum."*".$txtamountyarn_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		$tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);
		//=======================sum End =================
 		check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "1**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "1**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		disconnect($con);
		die;
	}
}

if ($action=="save_update_delet_fabric_conversion_cost_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$sql=sql_select("select approval_need from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
	$app_nessity=2;
	foreach($sql as $row){
		$app_nessity=$row[csf('approval_need')];
	}

	$sql=sql_select("select approved from wo_price_quotation  where id=$txt_quotation_id");
	$quatation_approved=2;
	foreach($sql as $row){
		$quatation_approved=$row[csf('approved')];
	}

	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	//echo "10**",$is_copy_quatation."**". $app_nessity."**".$quatation_approved;
	//die;
	if($is_copy_quatation==1 && $app_nessity==1){
		if($quatation_approved==2 || $quatation_approved==0 || $quatation_approved==3){
			echo "quataNotApp**".str_replace("'","",$txt_job_no);
			disconnect($con);die;
		}
	}
	if($operation==0)
	{
	    $con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		 if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0";disconnect($con); die;}
		 $approved=0;
		$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$update_id");
		foreach($sql as $row){
			if($row[csf('approved')]==3){
				$approved=1;
			}else{
				$approved=$row[csf('approved')];
			}
		}
		if($approved==1){
			echo "approved**".str_replace("'","",$update_id);
			disconnect($con);die;
		}
		 $id=return_next_id( "id", "wo_pre_cost_fab_conv_cost_dtls", 1 ) ;
		 $field_array="id, job_id, job_no, fabric_description, cons_process, process_loss, req_qnty, avg_req_qnty, charge_unit, amount, color_break_down, charge_lib_id, inserted_by, insert_date, status_active, is_deleted";
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cbocosthead="cbocosthead_".$i;
			 $cbotypeconversion="cbotypeconversion_".$i;
			 $txtprocessloss="txtprocessloss_".$i;
			 $txtreqqnty="txtreqqnty_".$i;
			 $txtavgreqqnty="txtavgreqqnty_".$i;
			 $txtchargeunit="txtchargeunit_".$i;
			 $txtamountconversion="txtamountconversion_".$i;
			 $cbostatusconversion="cbostatusconversion_".$i;
			 $updateidcoversion="updateidcoversion_".$i;
			 $colorbreakdown="colorbreakdown_".$i;
			 $coversionchargelibraryid="coversionchargelibraryid_".$i;
			if ($i!=1) $data_array .=",";
			$data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cbocosthead.",".$$cbotypeconversion.",".$$txtprocessloss.",".$$txtreqqnty.",".$$txtavgreqqnty.",".$$txtchargeunit.",".$$txtamountconversion.",".$$colorbreakdown.",".$$coversionchargelibraryid.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbostatusconversion.",0)";
			$id=$id+1;
		 }

		 $rID=sql_insert("wo_pre_cost_fab_conv_cost_dtls",$field_array,$data_array,0);
		 //=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array1="id, job_id, job_no, conv_req_qnty, conv_charge_unit, conv_amount";
			$data_array1="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtconreqnty_sum.",".$txtconchargeunit_sum.",".$txtconamount_sum.")";
			$rID1=sql_insert("wo_pre_cost_sum_dtls",$field_array1,$data_array1,1);
		}

		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array1="conv_req_qnty*conv_charge_unit*conv_amount";
			$data_array1 ="".$txtconreqnty_sum."*".$txtconchargeunit_sum."*".$txtconamount_sum."";
			$rID1=sql_update("wo_pre_cost_sum_dtls",$field_array1,$data_array1,"job_no","".$update_id."",1);
		}
		//=======================sum End =================
		 check_table_status( $_SESSION['menu_id'],0);


		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "0**".$new_job_no[0]."**".$rID;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "0**".$new_job_no[0]."**".$rID;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		disconnect($con);
		die;
	}
	else if($operation==1)
	{
	    $con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		$component_approved=return_field_value("current_approval_status", "co_com_pre_costing_approval", "job_no=$update_id and cost_component_id=1");
		if($component_approved==3){
			$component_approved=1;
		}
		$approved=0;
		$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$update_id");
		foreach($sql as $row){
			if($row[csf('approved')]==3){
				$approved=1;
			}else{
				$approved=$row[csf('approved')];
			}
		}
		if($approved==1 || $component_approved==1){
			echo "approved**".str_replace("'","",$update_id);
			disconnect($con);die;
		}
		
		$materialReciveNo="";
		$sql=sql_select("select a.recv_number from inv_receive_master a, inv_transaction b, wo_po_break_down c where a.id=b.mst_id and b.job_no=c.job_no_mst and b.job_no=$update_id and a.entry_form=248 and c.is_confirmed=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by a.recv_number");
		foreach($sql as $row)
		{
			if($materialReciveNo=="") $materialReciveNo=$row[csf('recv_number')]; else $materialReciveNo.=','.$row[csf('recv_number')];
		}
		if($materialReciveNo!=""){
			echo "materialRecive**".$materialReciveNo;
			disconnect($con);die;
		}
		
		if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**1"; die;}
		$field_array_up ="job_no*fabric_description*cons_process*process_loss*req_qnty*avg_req_qnty*charge_unit*amount*color_break_down*charge_lib_id*updated_by*update_date*status_active*is_deleted";
		$field_array="id, job_id, job_no, fabric_description, cons_process, process_loss, req_qnty, avg_req_qnty, charge_unit, amount, color_break_down, charge_lib_id, inserted_by, insert_date, status_active, is_deleted";
		$add_comma=0;
		$id=return_next_id( "id", "wo_pre_cost_fab_conv_cost_dtls", 1 ) ;
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cbocosthead="cbocosthead_".$i;
			 $cbotypeconversion="cbotypeconversion_".$i;
			 $txtprocessloss="txtprocessloss_".$i;
			 $txtreqqnty="txtreqqnty_".$i;
			 $txtavgreqqnty="txtavgreqqnty_".$i;
			 $txtchargeunit="txtchargeunit_".$i;
			 $txtamountconversion="txtamountconversion_".$i;
			 $cbostatusconversion="cbostatusconversion_".$i;
			 $updateidcoversion="updateidcoversion_".$i;
			 $colorbreakdown="colorbreakdown_".$i;
			 $coversionchargelibraryid="coversionchargelibraryid_".$i;
			if(str_replace("'",'',$$updateidcoversion)!="")
			{
				$id_arr[]=str_replace("'",'',$$updateidcoversion);
				$data_array_up[str_replace("'",'',$$updateidcoversion)] =explode(",",("".$update_id.",".$$cbocosthead.",".$$cbotypeconversion.",".$$txtprocessloss.",".$$txtreqqnty.",".$$txtavgreqqnty.",".$$txtchargeunit.",".$$txtamountconversion.",".$$colorbreakdown.",".$$coversionchargelibraryid.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbostatusconversion.",0"));
			}
			if(str_replace("'",'',$$updateidcoversion)=="")
			{
				if ($add_comma!=0) $data_array .=",";
				$data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cbocosthead.",".$$cbotypeconversion.",".$$txtprocessloss.",".$$txtreqqnty.",".$$txtavgreqqnty.",".$$txtchargeunit.",".$$txtamountconversion.",".$$colorbreakdown.",".$$coversionchargelibraryid.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbostatusconversion.",0)";
				$id=$id+1;
				$add_comma++;
			}
		 }
		 $rID=execute_query(bulk_update_sql_statement( "wo_pre_cost_fab_conv_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
		 if($data_array !="")
		 {
			 $rID1=sql_insert("wo_pre_cost_fab_conv_cost_dtls",$field_array,$data_array,0);
		 }

 		//=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, conv_req_qnty, conv_charge_unit, conv_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtconreqnty_sum.",".$txtconchargeunit_sum.",".$txtconamount_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="conv_req_qnty*conv_charge_unit*conv_amount";
			$data_array2 ="".$txtconreqnty_sum."*".$txtconchargeunit_sum."*".$txtconamount_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		//=======================sum End =================
		check_table_status( $_SESSION['menu_id'],0);

		if($db_type==0)
		{

			if($rID ){
				mysql_query("COMMIT");
				echo "1**".$new_job_no[0]."**".$rID;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "1**".$new_job_no[0]."**".$rID;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		disconnect($con);
		die;
	}
}
//*************************************************Fabric Cost, Yarn Cost, Coversion Cost End ***********************************************
if ($action=="load_drop_down_supplier_rate"){
	$supplier_library=return_library_array( "select a.supplier_name,a.id from  lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(4,5) and a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
	$data=explode("_",$data);
	if($data[2]==2){
		$supplier_library_with_rate=array();
		$sql_data_supplier_rate_sql=sql_select("select a.id, b.supplier_id, b.rate  from lib_item_group a, lib_item_group_rate b where a.id=b.mst_id and a.item_category=4 and a.id='".$data[0]."' and    b.rate>0 and a.status_active=1 and	a.is_deleted=0 group by a.id, b.supplier_id, b.rate order by b.rate");
		foreach($sql_data_supplier_rate_sql as $sql_data_supplier_rate_row){
			$supplier_library_with_rate[$sql_data_supplier_rate_row[csf('supplier_id')]]=$supplier_library[$sql_data_supplier_rate_row[csf('supplier_id')]]."--Rate--[".$sql_data_supplier_rate_row[csf('rate')]."]";
		}
		echo create_drop_down( "cbonominasupplier_".$data[1],90, $supplier_library_with_rate, "", 1, '-Select-', $row[csf("nominated_supp")],"set_trim_rate_amount(this.value,".$data[1].",'supplier_change')",$disabled,"" );
	}
	else if($data[2]==3){
		$supplier_library_with_rate=array();
		$sql_data_supplier_rate_sql=sql_select("select a.id, b.supplier_id, b.rate  from lib_item_group a, lib_item_group_rate b, lib_supplier_tag_buyer c where a.id=b.mst_id and b.supplier_id=c.supplier_id and a.item_category=4 and a.id='".$data[0]."' and c.tag_buyer=$data[3] and    b.rate>0 and a.status_active=1 and	a.is_deleted=0 group by a.id, b.supplier_id, b.rate order by b.rate");
		foreach($sql_data_supplier_rate_sql as $sql_data_supplier_rate_row){
			$supplier_library_with_rate[$sql_data_supplier_rate_row[csf('supplier_id')]]=$supplier_library[$sql_data_supplier_rate_row[csf('supplier_id')]]."--Rate--[".$sql_data_supplier_rate_row[csf('rate')]."]";
		}
		echo create_drop_down( "cbonominasupplier_".$data[1],90, $supplier_library_with_rate, "", 1, '-Select-', $row[csf("nominated_supp")],"set_trim_rate_amount(this.value,".$data[1].",'supplier_change')",$disabled,"" );
	}
	else{
		echo create_drop_down( "cbonominasupplier_".$data[1],90, "select a.supplier_name,a.id from  lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(4,5) and a.is_deleted=0  and a.status_active=1  group by a.id,a.supplier_name order by a.supplier_name", "id,supplier_name", 1, '-Select-', $row[csf("nominated_supp")],"set_trim_rate_amount(this.value,".$data[1].",'supplier_change')",$disabled,"" );
	}
	exit();
}

//*************************************************Trim Cost Start ***********************************************
if ($action=="show_trim_cost_listview")
{
	$supplier_library=return_library_array( "select a.supplier_name,a.id from  lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(4,5) and a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");

	$data=explode("*",$data);
	
	$trim_variable=1;
	$trim_variable_sql=sql_select( "select trim_rate from  variable_order_tracking where company_name='$data[4]' and variable_list=35 order by id" );
	foreach($trim_variable_sql as $trim_variable_row)
	{
		$trim_variable=	$trim_variable_row[csf('trim_rate')];
	}
	if( $trim_variable==2) $readonly_rate="readonly"; else if( $trim_variable==3) $readonly_rate="readonly"; else $readonly_rate="";
	$component_approved=0;
	$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=2 and job_no='$data[0]'");
	foreach($sql as $row){
		if($row[csf('approved')]==1 || $row[csf('approved')]==3) { $component_approved=1; $approved_message="<marquee width='500'><p style='color:#f00; text-align:center;'> Approved</p></marquee>";}
	}

	$approved=return_field_value("approved", "wo_pre_cost_mst", "job_no='$data[0]'");
	if($approved==3){
		$approved=1;
	}
	if($approved==1 || $component_approved==1)
	{
		$disabled=1; $txt_disabled="disabled";
	}
	else
	{
		$disabled=0; $txt_disabled="";
	}
	//echo $txt_disabled.'='.$component_approved;
	?>
	
	<h3 align="left" class="accordion_h">+Trim Cost <?=$approved_message; ?></h3>
       <div id="content_trim_cost"  align="center">
    	<fieldset>
        <input type="hidden" id="trim_rate_variable" value="<?=$trim_variable; ?>" />
        <form id="trimccost_6" autocomplete="off">
            <table width="1420" cellspacing="0" class="rpt_table" border="0" id="tbl_trim_cost" rules="all">
                <thead>
                    <tr>
                        <th width="35">Seq.</th>
                        <th width="60"><font style="font-size:11px; font-weight:100">Indigenous Item</font></th>
                        <th width="100">Group</th>
                        <th width="90">Country</th>
                        <th width="200">Description</th>
                        <th width="90">Brand/Sup Ref</th>
                        <th width="90">Nominated Supp</th>
                        <th width="60">Cons UOM</th>

                        <th width="60">Cons/ Unit Gmts</th>
                        <th width="60">Rate</th>
                        <th width="60">Amount</th>
                        <th width="70">Total Qty</th>
                        <th width="70">Total Amount</th>
                        <th width="100">Remarks</th>
                        <th width="50">Apvl Req.</th>
                        <th width="50">Image</th>
                        <th width="70">Item Print</th>
                        <th>&nbsp;</th>
                    </tr>
                </thead>
                <tbody>
				<?
				$supplier_lib_with_rate_arr=array();
				if($trim_variable==2)
				{
					$sql_data_supplier_rate_sql=sql_select("select a.id, b.supplier_id, b.rate  from lib_item_group a, lib_item_group_rate b where a.id=b.mst_id and a.item_category=4 and b.rate>0 and a.status_active=1 and a.is_deleted=0 group by a.id, b.supplier_id, b.rate order by b.rate");
					foreach($sql_data_supplier_rate_sql as $srow)
					{
						$supplier_lib_with_rate_arr[$srow[csf('id')]][$srow[csf('supplier_id')]]=$supplier_library[$srow[csf('supplier_id')]]."--Rate--[".$srow[csf('rate')]."]";
					}
				}
				else if($trim_variable==3)
				{
					$sql_data_supplier_rate_sql=sql_select("select a.id, b.supplier_id, b.rate  from lib_item_group a, lib_item_group_rate b, lib_supplier_tag_buyer c where a.id=b.mst_id and b.supplier_id=c.supplier_id and a.item_category=4 and c.tag_buyer=$data[1] and b.rate>0 and a.status_active=1 and	a.is_deleted=0 group by a.id, b.supplier_id, b.rate order by b.rate");
					foreach( $sql_data_supplier_rate_sql as $srow )
					{
						$supplier_lib_with_rate_arr[$srow[csf('id')]][$srow[csf('supplier_id')]]=$supplier_library[$srow[csf('supplier_id')]]."--Rate--[".$srow[csf('rate')]."]";
					}
				}

				unset($sql_data_supplier_rate_sql);

                $total_Amount=0;
                //print_r($totalamountarray_arr);
                $lib_item_group_arr=return_library_array( "select item_name,id from lib_item_group where item_category=4 order by item_name", "id", "item_name");

                $save_update=1;
                $data_array=sql_select("select id, remark, job_no, trim_group, description, brand_sup_ref, cons_uom, cons_dzn_gmts, ex_per as excess_per, tot_cons as total_cons, rate, amount, apvl_req, nominated_supp, cons_breack_down, country, calculatorstring, seq, status_active, item_print from wo_pre_cost_trim_cost_dtls where job_no='$data[0]' order by seq");// quotation_id='$data'

				$is_booking_arr=array();
				if (count($data_array)>0)
				{
					$data_arr=sql_select("select trim_group,pre_cost_fabric_cost_dtls_id from wo_booking_dtls where job_no ='$data[0]' and booking_type='2' and status_active=1 and is_deleted=0 group by pre_cost_fabric_cost_dtls_id,trim_group");
					foreach ($data_arr as $row)
					{
						$is_booking_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('trim_group')]]=$row[csf('pre_cost_fabric_cost_dtls_id')];
					}
					unset($data_arr);
				}
                if(count($data_array)<1 && $data[3]==1 && $data[6]==2)//Price Quotation
                {
                    $data_array=sql_select("select id as qid, seq, quotation_id, trim_group, description, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp, status_active from wo_pri_quo_trim_cost_dtls where quotation_id='$data[2]' order by seq");// quotation_id='$data'
                    $save_update=0;
                }
				if (count($data_array)<1 && $data[3]==1 && $data[6]==7)//Quick Costing
				{
					$dataQc = sql_select("select id as qid, '' as seq, mst_id as quotation_id, particular_type_id as trim_group, description, uom as cons_uom, consumption as total_cons, rate, value as amount, 0 as apvl_req, 0 as nominated_supp_multi, supp_ref as sup_ref, status_active, ex_percent as excess_per, 0 as ex_cons, tot_cons as cons_dzn_gmts, 0 as material_source from qc_cons_rate_dtls where mst_id='$data[2]' and type=4 and tot_cons>0 and status_active=1 and is_deleted=0 order by id");// Query Invalid by kausar
					//echo "select id as qid, '' as seq, mst_id as quotation_id, particular_type_id as trim_group, description, uom as cons_uom, consumption as cons_dzn_gmts, rate, value as amount, 0 as apvl_req, 0 as nominated_supp_multi, supp_ref as sup_ref, status_active, ex_percent as excess_per, 0 as ex_cons, tot_cons as total_cons, 0 as material_source from qc_cons_rate_dtls where mst_id='$data[2]' and type=4 and tot_cons>0 and status_active=1 and is_deleted=0 order by id";
					$trimID=""; $qcDataArr=array();
					foreach( $dataQc as $trow)
					{
						if($trimID=="") $trimID=$trow[csf('trim_group')]; else $trimID.=','.$trow[csf('trim_group')];
						$qcDataArr[$trow[csf('qid')]]=$trow[csf('cons_dzn_gmts')].'__'.$trow[csf('excess_per')].'__'.$trow[csf('total_cons')].'__'.$trow[csf('rate')].'__'.$trow[csf('amount')].'__'.$trow[csf('cons_uom')];
					}
					
					$data_array=$dataQc;
					$save_update=0;
				}

				if ( count($data_array)>0)
				{
					$i=0;
					foreach( $data_array as $row )
					{
						$i++;
						if($db_type==0) $cons_breack_down=$row[csf('cons_breack_down')];
						else if($db_type==2)
						{
							if($row[csf('cons_breack_down')] !="") $cons_breack_down=$row[csf('cons_breack_down')];
						}

						$country_text="";
						$countryarr=explode(",",$row[csf("country")]);
						//print_r($countryarr);
						for($cu=0; $cu<count($countryarr); $cu++){
							//echo "mmmm";
							$country_text.= $country_library[trim($countryarr[$cu])].",";
						}
						$country_text=rtrim($country_text,",");

						$seq=0;
						if($save_update==0)
						{
							if($row[csf("seq")]=="") $seq=$i; else $seq=$row[csf("seq")];
						}
						else
						{
							if($row[csf("seq")]=="") $seq=$i; else $seq=$row[csf("seq")];
						}
						$dis=0; $txt_dis='';
						if($disabled!=1)
						{
							if($is_booking_arr[$row[csf('id')]][$row[csf('trim_group')]]!="")
							{
								$dis=1; $txt_dis="disabled";
							}
							else
							{
								$dis=0; $txt_dis='';
							}
						}
						if($row[csf("excess_per")] != '') $excess_per = $row[csf("excess_per")]; else $excess_per=0;
						if($row[csf("ex_cons")] != '') $ex_cons = $row[csf("ex_cons")]; else $ex_cons=0;
						//if($row[csf("cons_dzn_gmts")] != '') $row[csf("cons_dzn_gmts")] = $row[csf("cons_dzn_gmts")];
						if($row[csf("total_cons")] == '') $row[csf("total_cons")] = $row[csf("cons_dzn_gmts")]; 
						?>
						<tr id="trim_<?=$i; ?>" align="center">
                            <td>
                           		<input type="hidden" id="cbotrimstatus_<?=$i; ?>" name="cbotrimstatus_<?=$i; ?>"  class="text_boxes" style="width:20px" value="1"  />                            	<input type="text" id="seq_<?=$i; ?>" name="seq_<?=$i; ?>" class="text_boxes_numeric" style="width:23px" value="<?=$seq; ?>" <?=$txt_disabled; echo $txt_dis; ?> />
                            </td>
							<td><input readonly type="text" id="cbointernaltext_<?=$i; ?>" name="cbointernaltext_<?=$i; ?>" class="text_boxes" placeholder="Browse" style="width:47px" <?=$txt_disabled; echo $txt_dis; ?> onDblClick="openpopup_internalitem(<?=$i; ?>);"/></td>
                            <td>
                                <input title="<?=$lib_item_group_arr[$row[csf("trim_group")]]; ?>" readonly type="text" id="cbogrouptext_<?=$i; ?>"  name="cbogrouptext_<?=$i; ?>" class="text_boxes" placeholder="Browse" style="width:88px" value="<?=$lib_item_group_arr[$row[csf("trim_group")]]; ?>" <?=$txt_disabled; echo $txt_dis; ?> onDblClick="openpopup_itemgroup(<?=$i; ?>);"/>
                                <input type="hidden" id="cbogroup_<?=$i; ?>" name="cbogroup_<?=$i; ?>" class="text_boxes" style="width:80px" value="<?=$row[csf("trim_group")]; ?>" />
                            </td>
                            <td>
                                <input type="text" id="countrytext_<?=$i; ?>" name="countrytext_<?=$i; ?>" class="text_boxes" style="width:78px" value="<?=$country_text; ?>" <?=$txt_disabled; echo $txt_dis; ?> onDblClick="open_country_popup('<?=$i.'_1'; ?>')" placeholder="Browse" readonly/>
                                <input type="hidden" id="country_<?=$i; ?>" name="country_<?=$i; ?>" class="text_boxes" style="width:75px" value="<?=$row[csf("country")]; ?>" />
                            </td>
                            <td><input type="text" id="txtdescription_<?=$i; ?>" name="txtdescription_<?=$i; ?>" class="text_boxes" style="width:188px" value="<?=$row[csf("description")];  ?>" <?=$txt_disabled; echo $txt_dis; ?> onDblClick="trims_description_popup(<?=$i; ?>);"/></td>
                            <td><input type="text" id="txtsupref_<?=$i; ?>" name="txtsupref_<?=$i; ?>" maxlength="20" class="text_boxes" style="width:78px" value="<?=$row[csf("brand_sup_ref")];  ?>" <?=$txt_disabled; echo $txt_dis;  ?> /></td>
                            
                            <td id="tdsupplier_<?=$i; ?>">
                            <?
								if($trim_variable==1)
								{
									echo create_drop_down( "cbonominasupplier_".$i,90, $supplier_library, "", 1, '-Select-', $row[csf("nominated_supp")],"set_trim_rate_amount(this.value,".$i.",'supplier_change')",$dis,"" );
								}
								else
								{
									echo create_drop_down( "cbonominasupplier_".$i,90, $supplier_lib_with_rate_arr[$row[csf('trim_group')]], "", 1, '-Select-', $row[csf("nominated_supp")],"set_trim_rate_amount(this.value,".$i.",'supplier_change')",$dis,"" );
								}
                            ?>
                            </td>
                            <td><?=create_drop_down( "cboconsuom_".$i, 60, $unit_of_measurement,"", 1, "-- Select --", $row[csf("cons_uom")], "",1,"" ); ?></td>
                            <td><input type="text" id="txtconsdzngmts_<?=$i; ?>" tmp_cons="" name="txtconsdzngmts_<?=$i; ?>" class="text_boxes_numeric" style="width:47px" value="<?=$row[csf("cons_dzn_gmts")]; ?>" onChange="calculate_trim_cost(<?=$i; ?>);" onDblClick="set_session_large_post_data_trim( 'requires/pre_cost_entry_controller_v2.php?action=consumption_popup_trim', 'Consumption Entry Form','<?=$i; ?>');" readonly/>
							<input type="hidden" id="txtexper_<?=$i; ?>" name="txtexper_<?=$i; ?>" qcdata="" class="text_boxes" style="width:10px" readonly  />
                            </td>
                            <td>
                            	<input type="text" id="txttrimrate_<?=$i; ?>" name="txttrimrate_<?=$i; ?>" class="text_boxes_numeric" style="width:47px" value="<?=$row[csf("rate")]; ?>" onChange="calculate_trim_cost(<?=$i; ?>);" disabled onDblClick="trim_rate_popup(<?=$i; ?>);"/>
                                <input type="hidden" name="excessper_<?=$i; ?>" id="excessper_<?=$i; ?>" value="<?=$row[csf("excess_per")]; ?>">
                            	<input type="hidden" name="totalcons_<?=$i; ?>" id="totalcons_<?=$i; ?>" value="<?=$row[csf("total_cons")]; ?>">
                            </td>
                            <td><input type="text" id="txttrimamount_<?=$i; ?>" name="txttrimamount_<?=$i; ?>" class="text_boxes_numeric" style="width:47px" value="<?=$row[csf("amount")]; ?>" readonly /></td>
                            <td>
                            <? $total_qty+=$totalqtyarray_arr[$data[0]][$row[csf("id")]]; ?>
                            <input type="text" id="totalqty_<?=$i; ?>" name="totalqty_<?=$i; ?>" class="text_boxes_numeric" style="width:57px" value="" readonly placeholder="Click to Load" onClick="loadTotal(<?=$i; ?>,'trim');" />
                            </td>
                            <td>
								<? $total_Amount+=$totalamountarray_arr[$data[0]][$row[csf("id")]]; ?>
                                <input type="text" id="totalamount_<?=$i; ?>"  name="totalamount_<?=$i; ?>" class="text_boxes_numeric" style="width:57px" value="" readonly  />
                            </td>
                            <td><input class="text_boxes" type="text" style="width:88px;" name="txtremark_<?=$i; ?>" id="txtremark_<?=$i; ?>" value="<?=$row[csf("remark")]; ?>" maxlength="500" title="Maximum 500 Character" <?=$txt_disabled; echo $txt_dis; ?> /></td>
                            <td><?=create_drop_down( "cboapbrequired_".$i, 48, $yes_no,"", 0, "0", $row[csf("apvl_req")], '',$disabled,'' ); ?></td>
                            <td><input type="button" class="image_uploader" style="width:48px" id="btnimg_<?=$i; ?>" value="IMG" onClick="file_uploader ( '../../', '<?=$row[csf("id")]; ?>','', 'pre_cost_trimsv2', 0 ,1);" />
                            </td>
                            <td><?=create_drop_down( "cboitemprint_".$i, 70, $itemPrintArr,"", 1, "-Select-", $row[csf("item_print")], '',$disabled,'' ); ?></td>
                            <td>
                                <input type="button" id="increasetrim_<?=$i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_trim_cost(<?=$i; ?>);" <? if($approved==1 || $component_approved==1) {echo "disabled";} else {echo "";}?> />
                                <input type="button" id="decreasetrim_<?=$i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<?=$i; ?> ,'tbl_trim_cost' );" <?=$txt_disabled; echo $txt_dis; ?> />

                                <input type="hidden" id="updateidtrim_<?=$i; ?>" name="updateidtrim_<?=$i; ?>" class="text_boxes" style="width:20px" value="<?=$row[csf("id")]; ?>"  />
								<input type="hidden" id="updateTempleteTrimTd_<?=$i; ?>" name="updateTempleteTrimTd_<?=$i; ?>"  class="text_boxes" style="width:20px" value="<?=$row[csf("id")]; ?>"  />
                                <input type="hidden" id="consbreckdown_<?=$i; ?>" name="consbreckdown_<?=$i; ?>" class="text_boxes" style="width:20px" value="<? //echo  $cons_breack_down; ?>" />
                                <input type="hidden" id="calculatorstring_<?=$i; ?>" name="calculatorstring_<?=$i; ?>" class="text_boxes" style="width:20px" value="<?=$row[csf("calculatorstring")]; ?>"  />
                            </td>
						</tr>
						<?
					}
				}
				else
				{
					$save_update=0;
					?>
					<tr id="trim_1" align="center">
						<td><input type="hidden" id="cbotrimstatus_1" name="cbotrimstatus_1"  class="text_boxes" style="width:20px" value="1"  />                                <input type="text" id="seq_1" name="seq_1" class="text_boxes_numeric" style="width:23px" value="1"/>
						</td>
						<td><input readonly type="text" id="cbointernaltext_1" name="cbointernaltext_1" class="text_boxes" placeholder="Browse" style="width:47px"  onDblClick="openpopup_internalitem(1);"/></td>
						<td>
							<input title="<?=$lib_item_group_arr[$row[csf("trims_group")]]; ?>" type="text" readonly id="cbogrouptext_1" placeholder="Browse" name="cbogrouptext_1" class="text_boxes" style="width:88px" value="" onDblClick="openpopup_itemgroup(1);"/>
							<input type="hidden" id="cbogroup_1"  name="cbogroup_1" class="text_boxes" style="width:80px" value=""  />
						</td>
						<td>
						<input type="text" id="countrytext_1"  name="countrytext_1" class="text_boxes" style="width:78px" value="" placeholder="Browse" onDblClick="open_country_popup('1_1');" readonly/>
						<input type="hidden" id="country_1"  name="country_1" class="text_boxes" style="width:75px" value="" />
						</td>
						<td><input type="text" id="txtdescription_1"  name="txtdescription_1" class="text_boxes" style="width:188px" value="" onDblClick="trims_description_popup(1);"/></td>
						<td><input type="text" id="txtsupref_1"  name="txtsupref_1" maxlength="20" class="text_boxes" style="width:78px" value="" /></td>
						<td id="tdsupplier_1"><?=create_drop_down( "cbonominasupplier_1",90, $supplier_library, "", 1, '-Select-', $row[csf("nominated_supp")],"set_trim_rate_amount(this.value,".$i.",'supplier_change')",$disabled,"" ); ?>
						</td>
						<td><?=create_drop_down( "cboconsuom_1", 60, $unit_of_measurement,"", 1, "-- Select --", '', "",1,"" ); ?></td>
						<td>
							<input type="text" id="txtconsdzngmts_1" tmp_cons="" name="txtconsdzngmts_1" class="text_boxes_numeric" style="width:47px" value="" onChange="calculate_trim_cost(1)" onDblClick="set_session_large_post_data_trim('requires/pre_cost_entry_controller_v2.php?action=consumption_popup_trim', 'Consumption Entry Form',1)" readonly/> <!--onDblClick="open_calculator(1)"-->
							<input type="hidden" id="txtexper_1" name="txtexper_1" class="text_boxes" style="width:10px" readonly  />
						</td>
						<td>
							<input type="text" id="txttrimrate_1"  name="txttrimrate_1" class="text_boxes_numeric" style="width:47px" value="" onChange="calculate_trim_cost(1);" disabled onDblClick="trim_rate_popup(1);"/>
                            <input type="hidden" name="excessper_1" id="excessper_1" value="">
                            <input type="hidden" name="totalcons_1" id="totalcons_1" value="">
						</td>
						<td><input type="text" id="txttrimamount_1"  name="txttrimamount_1" class="text_boxes_numeric" style="width:47px" value=""  readonly /></td>
						<td><input type="text" id="totalqty_1"  name="totalqty_1" class="text_boxes_numeric" style="width:57px" readonly placeholder="Click to Load" onClick="loadTotal(1,'trim');" /></td>
						<td><input type="text" id="totalamount_1"  name="totalamount_1" class="text_boxes_numeric" style="width:57px" readonly /></td>
						<td><input class="text_boxes" type="text" style="width:88px;" name="txtremark_1" id="txtremark_1" maxlength="500" title="Maximum 500 Character"/></td>
						<td><?=create_drop_down( "cboapbrequired_1", 48, $yes_no,"", 0, "0", $row[csf("apvl_req")], '','','' ); ?></td>
						<td><input type="button" class="image_uploader" style="width:48px" id="btnimg_1" value="IMG" onClick="file_uploader( '../../', document.getElementById('updateTempleteTrimTd_1').value,'', 'knit_order_entry', 0 ,1);" /></td>
                        <td><?=create_drop_down( "cboitemprint_1", 70, $itemPrintArr,"", 1, "-Select-", '', '','','' ); ?></td>
						<td>
							<input type="button" id="increasetrim_1" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_trim_cost(1);" />
							<input type="button" id="decreasetrim_1" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(1,'tbl_trim_cost');" />
							<input type="hidden" id="updateidtrim_1" name="updateidtrim_1"  class="text_boxes" style="width:20px" value=""  />
							<input type="hidden" id="updateTempleteTrimTd_1" name="updateTempleteTrimTd_1"  class="text_boxes" style="width:20px" value=""  />
							<input type="hidden" id="consbreckdown_1" name="consbreckdown_1"  class="text_boxes" style="width:20px" value=""  />
							<input type="hidden" id="calculatorstring_1" name="calculatorstring_1"  class="text_boxes" style="width:20px" value=""  />
						</td>
					</tr>
					<?
				}
			?>
			</tbody>
        </table>
        <table width="1420" cellspacing="0" class="rpt_table" border="0" rules="all">
        	<tfoot>
                <tr>
                	<th width="35">&nbsp;</th>
                	<th width="60">&nbsp;</th>
                    <th width="100">&nbsp;</th>
                    <th width="90">&nbsp;</th>
                    <th width="200">&nbsp;</th>
                    <th width="90">&nbsp;</th>
                    <th width="90">&nbsp;</th>
                    <th width="60">Sum</th>

                    <th width="60"><input type="text" id="txtconsdzntrim_sum"  name="txtconsdzntrim_sum" class="text_boxes_numeric" style="width:47px" readonly /></th>
                    <th width="60"><input type="text" id="txtratetrim_sum"  name="txtratetrim_sum" class="text_boxes_numeric" style="width:47px" readonly /></th>
                    <th width="60"><input type="text" id="txttrimamount_sum"  name="txttrimamount_sum" class="text_boxes_numeric" style="width:47px"  readonly /></th>
                    <th width="70"><input type="text" id="totalqty_sum"  name="totalqty_sum" class="text_boxes_numeric" style="width:57px" readonly /></th>
                    <th width="70"><input type="text" id="totalamount_sum"  name="totalamount_sum" class="text_boxes_numeric" style="width:57px" value="<?=number_format($total_Amount ,4,".","")?>" readonly /></th>
                    <th width="100">&nbsp;</th>
                    <th width="50">&nbsp;</th>
                    <th width="50">&nbsp;</th>
                    <th width="70">&nbsp;</th>
                    <th>&nbsp;</th>
                </tr>
            </tfoot>
        </table>
        <table width="1420" cellspacing="0" class="" border="0">
            <tr>
                <td align="center" height="15" width="100%">&nbsp;</td>
            </tr>
            <tr>
                <td align="center" width="100%" class="button_container">
                <?
                if ( count($data_array)>0)
                {
                    echo load_submit_buttons( $permission, "fnc_trim_cost_dtls", $save_update,0,"reset_form('trimccost_6','','',0)",6) ;
                }
                else
                {
                    echo load_submit_buttons( $permission, "fnc_trim_cost_dtls", $save_update,0,"reset_form('trimccost_6','','',0)",6) ;
                }
                ?>
                </td>
            </tr>
        </table>
        </form>
    </fieldset>
    </div>
	<?
    exit();
}

if ($action=="trims_description_popup")
{
	echo load_html_head_contents("Description","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	$data=$data;
	?>
    <script>
		$( document ).ready(function() {
			document.getElementById("description").value='<? echo $data; ?>';
		});
    </script>
    <body>
		<div align="center" style="width:100%;">
        <? echo load_freeze_divs ("../../",$permission,1); ?>
        <form>
			<fieldset style="width:450px;">
            <table align="center" cellspacing="0" width="450" class="rpt_table" border="1" rules="all" id="size_tbl" >
                <tr id="row_1">
                    <td width="150" align="center" >
                    	<textarea name="description" id="description" class="text_area" style="width:430px; height:100px;" maxlength="500" title="Maximum 500 Character"></textarea>
                    </td>
                </tr>
            </table>

            <table align="center" cellspacing="0" width="450" class="rpt_table" border="1" rules="all" id="" >
                <tr>
                    <td align="center">
                    <input type="hidden" name="hidden_appv_cause" id="hidden_appv_cause" class="text_boxes /">
                        <input type="button" name="close" class="formbutton" value="Close" id="main_close" onClick="parent.emailwindow.hide();" style="width:100px" />
                    </td>
                </tr>
            </table>
            </fieldset>
            </form>
        </div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    <script>
		$( "#description" ).focus();
	</script>
    </html>
    <?
	exit();
}

if($action=="load_total_qtyAmount")
{
	$exdata=explode("__",$data);
	$condition= new condition();
	if(str_replace("'","",$exdata[0]) !=''){
		$condition->job_no("='$exdata[0]'");
	}
	$condition->init();
	if($exdata[1]=="trim")
	{
		$trim= new trims($condition);
		//echo $trim->getQuery();
		$totalamountarray_arr=$trim->getAmountArray_by_jobAndPrecostdtlsid();
		$totalqtyarray_arr=$trim->getQtyArray_by_jobAndPrecostdtlsid();
		$response=array();
		foreach($totalqtyarray_arr as $job=>$PrecostdtlsidArr){
			foreach($PrecostdtlsidArr as $Precostdtlsid=> $value){
				$response['qty'][$Precostdtlsid]=number_format($value,2,".","");
				$response['amt'][$Precostdtlsid]=number_format($totalamountarray_arr[$job][$Precostdtlsid],2,".","");
			}
		}
	}
	if($exdata[1]=="fabric")
	{
		$fabric= new fabric($condition,1);
		  // echo $fabric->getQuery();die;
		$fabric_qty_arr=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
		$fabric_amount_arr=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
		//print_r($fabric_qty_arr);die;

		//$totalamountarray_arr=$trim->getAmountArray_by_jobAndPrecostdtlsid();
		//$totalqtyarray_arr=$trim->getQtyArray_by_jobAndPrecostdtlsid();
		$response=array();


		foreach($fabric_qty_arr['sweater']['grey'] as $precostdtls_id=>$uomval){
			foreach($uomval as $uom=>$value){
				$response['qty'][$precostdtls_id]=number_format($value,2,".","");
				$response['amt'][$precostdtls_id]=number_format($fabric_amount_arr['sweater']['grey'][$precostdtls_id][$uom],2,".","");
			}
		}
	}
	echo json_encode($response);
}

if ($action=="trims_description")
{
	//extract($_REQUEST);
	//echo "select description from  wo_pre_cost_trim_cost_dtls where trim_group=$data  group by description";
	//die;
	echo substr(return_library_autocomplete("select description from  wo_pre_cost_trim_cost_dtls where trim_group=$data  group by description", "description" ), 0, -1);
}
if ($action=="set_cons_uom")
{
	//extract($_REQUEST);
	$cons_uom=return_field_value("trim_uom", "lib_item_group", "id=$data");
	echo $cons_uom; die;
}
if ($action=="rate_from_library")
{
	$data=explode("_",$data);

	$rate=0;
	if($data[1]==0)
	{
	$trim_rate_from_library=sql_select( "select a.id, min(b.rate) as rate from lib_item_group a, lib_item_group_rate b where a.id=b.mst_id and a.id=$data[0]  and a.item_category=4 and a.status_active=1 and	a.is_deleted=0 group by a.id");
	}
	else
	{
	$trim_rate_from_library=sql_select( "select a.id, b.rate as rate from lib_item_group a, lib_item_group_rate b where a.id=b.mst_id and a.id=$data[0] and b.supplier_id=$data[1] and a.item_category=4 and a.status_active=1 and	a.is_deleted=0 ");
	}

	foreach($trim_rate_from_library as $trim_rate_from_library_row)
	{
	    if($trim_rate_from_library_row[csf('rate')] !="")
		{
	     $rate=$trim_rate_from_library_row[csf('rate')];
		}
	}
	echo trim($rate); die;
}

if($action=="openpopup_itemgroup")
{
	echo load_html_head_contents("Item Group Select","../../../", 1, 1, $unicode,'','');
	extract($_REQUEST);
	?>
    <script>
		function check_all_data() {
			var tbl_row_count = document.getElementById( 'item_table' ).rows.length;
			tbl_row_count = tbl_row_count;
			if(document.getElementById('check_all').checked){
				for( var i = 1; i <= tbl_row_count; i++ ) {
				//js_set_value( i);
				document.getElementById( 'search' + i ).style.backgroundColor = 'yellow';
				if( jQuery.inArray( $('#txttrimgroupdata_' + i).val(), selected_name ) == -1 ) {
					selected_name.push($('#txttrimgroupdata_' + i).val());
				}
				else{
					for( var j = 0; j < selected_name.length; j++ ) {
						if( selected_name[j] == $('#txttrimgroupdata_' + i).val() ) break;
					}
					selected_name.splice( j,1 );
				}

				}
			}else{
				for( var i = 1; i <= tbl_row_count; i++ ) {
					if(i%2==0  ){
						document.getElementById('search'+i).style.backgroundColor = '#FFFFFF';
					}
					if(i%2!=0 ){
						document.getElementById('search'+i).style.backgroundColor = '#E9F3FF';
					}
					if( jQuery.inArray( $('#txttrimgroupdata_' + i).val(), selected_name ) == -1 ) {
						selected_name.push($('#txttrimgroupdata_' + i).val());
					}
					else{
						for( var j = 0; j < selected_name.length; j++ ) {
							if( selected_name[j] == $('#txttrimgroupdata_' + i).val() ) break;
						}
						selected_name.splice( j,1 );
					}
				}

			}

		}

		function toggle( x, origColor ) {
			var newColor = 'yellow';
			if ( x.style ) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}

		function onlyUnique(value, index, self) {
			return self.indexOf(value) === index;
		}

		var selected_name = new Array();

		function js_set_value( str ) {
			if($("#search"+str).css("display") !='none'){
				//toggle( document.getElementById( 'search' + str ), '#FFFFCC' );
				if(str%2==0  ){
					toggle( document.getElementById( 'search' + str ), '#FFFFFF');
				}
				if(str%2!=0 ){
					toggle( document.getElementById( 'search' + str ), '#E9F3FF');
				}
				if( jQuery.inArray( $('#txttrimgroupdata_' + str).val(), selected_name ) == -1 ) {
					selected_name.push($('#txttrimgroupdata_' + str).val());
				}
				else{
					for( var i = 0; i < selected_name.length; i++ ) {
						if( selected_name[i] == $('#txttrimgroupdata_' + str).val() ) break;
					}
					selected_name.splice( i,1 );
				}
			}
			var trimgroupdata='';
			for( var i = 0; i < selected_name.length; i++ ) {
				trimgroupdata += selected_name[i] + ',';
			}
			trimgroupdata = trimgroupdata.substr( 0, trimgroupdata.length - 1 );

			$('#itemdata').val( trimgroupdata );
		}
	</script>
	</head>
	<body>
        <div align="center" style="width:100%;">
        <input type="hidden" id="gid" name="gid"/>
        <input type="hidden" id="itemdata" name="itemdata"/>
        <? $sql_tgroup=sql_select( "select id, item_name, trim_uom from lib_item_group where item_category=4 and is_deleted=0 and status_active=1 order by item_name"); ?>
        <table width="420" cellspacing="0" class="rpt_table" border="0" rules="all">
            <thead>
            	<th width="40">SL</th><th>Item Group</th>
            </thead>
        </table>
        <div style="width:420px; overflow-y:scroll; max-height:340px;" >
        <table width="400" cellspacing="0" class="rpt_table" border="0" rules="all" id="item_table">
            <tbody>
				<?
                $i=1;
                foreach($sql_tgroup as $row_tgroup)
				{
					if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					$str="";
					$str=$row_tgroup[csf('id')].'***'.$row_tgroup[csf('item_name')].'***'.$row_tgroup[csf('trim_uom')];
					?>
					<tr id="search<? echo $i;?>" onClick="js_set_value(<? echo $i; ?>)" bgcolor="<? echo $bgcolor; ?>">
						<td width="40"><? echo $i; ?></td><td><? echo $row_tgroup[csf('item_name')]; ?>
                        	<input type="hidden" name="txttrimgroupdata_<? echo $i; ?>" id="txttrimgroupdata_<? echo $i; ?>" value="<? echo $str; ?>"/>
                        </td>
					</tr>
					<?
					$i++;
                }
                ?>
            </tbody>
        </table>
        </div>
        <table width="420" cellspacing="0" cellpadding="0" style="border:none" align="center">
        <tr>
            <td align="center" height="30" valign="bottom">
                <div style="width:100%">
                    <div style="width:50%; float:left" align="left">
                    	<input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                    </div>
                    <div style="width:50%; float:left" align="left">
                    	<input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                    </div>
                </div>
            </td>
        </tr>
	</table>
    </div>
    </body>
	<script>setFilterGrid('item_table',-1);</script>
	<!--<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>-->
	</html>
	<?
	exit();
}
if($action=="openpopup_internalitem")
{
	echo load_html_head_contents("Item Name","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
    <script>
	var permission='<? echo $permission; ?>';
	function fnc_trim_internal_info( operation )
	{
		freeze_window(operation);
		if (form_validation('txt_pur_order_date','Trims Purchase Order Date')==false)
		{
			release_freezing();
			return; 
		}
		
		var data="action=save_update_delete_internalitem&operation="+operation+get_submitted_data_string('trim_id*update_id*hid_job_id*txt_pur_order_date*txt_etd_date*txt_eta_date*txt_rcv_date',"../../../");
		http.open("POST","pre_cost_entry_controller_v2.php",true);
		http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
		http.send(data);
		http.onreadystatechange = fnc_trim_internal_info_reponse;
	}
	function fnc_trim_internal_info_reponse()
	{
		if(http.readyState == 4) 
		{
			var reponse=trim(http.responseText).split('**');
			if(reponse[0]==10)
			{
				show_msg(trim(reponse[0]));
				release_freezing();
				return;
			}
			if(reponse[0]==0 || reponse[0]==1)
			{	show_msg(trim(reponse[0]));		
				document.getElementById('update_id').value=reponse[1];
				set_button_status(1, permission, 'fnc_trim_internal_info',1);
				release_freezing();
			}
			if(reponse[0]==2)
			{	show_msg(trim(reponse[0]));
				document.getElementById('update_id').value='';		
				reset_form('triminternal_1','','','','','txt_pur_order_date*txt_etd_date*txt_eta_date*txt_rcv_date');
				set_button_status(0, permission, 'fnc_trim_internal_info',1);
				release_freezing();
			}
		}
	}
	</script>
	</head>
	<body>
        <div align="center" style="width:100%;">
		<?=load_freeze_divs ("../../../",$permission,1); ?>
        <? 
			$id=$purchase_date=$etd_date=$eta_date=$receive_date='';
			$sql_internaldata=sql_select( "SELECT id, purchase_date, etd_date, eta_date,receive_date from wo_pre_cost_trims_internal_dtls where is_deleted=0 and status_active=1 and trims_id=$trimid order by id");
			$attr_arr=array('id', 'purchase_date', 'etd_date', 'eta_date','receive_date');
			foreach($sql_internaldata as $row)
			{
				foreach($attr_arr as $attr){
					$$attr=$row[csf($attr)];
				}				
			}		 
		?>
		<form id="triminternal_1" autocomplete="off">
        <table width="500" cellspacing="0" class="rpt_table" border="0" rules="all">
            <thead>
            	<th class="must_entry_caption" width="80">Trims Pur. Order Date</th>
				<th width="80">Trims ETD</th>
				<th width="80">Trims ETA</th>
				<th width="80">Trims Receive Date</th>
            </thead>
            <tbody>
				<tr>
					<td align="center"><input type="text" id="txt_pur_order_date" name="txt_pur_order_date" class="datepicker" style="width:100px" readonly value="<?= change_date_format($purchase_date,'dd-mm-yyyy','-'); ?>"/></td>
					<td align="center"><input type="text" id="txt_etd_date" name="txt_etd_date" class="datepicker" style="width:100px" readonly value="<?= change_date_format($etd_date,'dd-mm-yyyy','-'); ?>"/></td>
					<td align="center"><input type="text" id="txt_eta_date" name="txt_eta_date" class="datepicker" style="width:100px" readonly value="<?= change_date_format($eta_date,'dd-mm-yyyy','-'); ?>"/></td>
					<td align="center">
					<input type="text" id="txt_rcv_date" name="txt_rcv_date" class="datepicker" style="width:100px" readonly value="<?= change_date_format($receive_date,'dd-mm-yyyy','-'); ?>"/>
					<input type="hidden" id="update_id" value="<?= $id ?>" />
					<input type="hidden" id="trim_id" value="<?= $trimid ?>" />
					<input type="hidden" id="hid_job_id" value="<?= $jobid ?>" />
					</td>					
				</tr>
            </tbody>
        </table>
		<div align="center" style="margin-top:10px">
		<?
		if(count($sql_internaldata)>0)
		{
			echo load_submit_buttons( $permission, "fnc_trim_internal_info", 1,0 ,"reset_form('triminternal_1','','','','','')",1) ; 
		}
		else
		{
			echo load_submit_buttons( $permission, "fnc_trim_internal_info", 0,0 ,"reset_form('triminternal_1','','','','','')",1) ; 
		}
		?>
		</div>
        </div>
		</form>        
    </body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}
if($action=="save_update_delete_internalitem")// zakaria joy 25-09-22(19164)
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));	
	if ($operation==0)  // Insert Here
	{
		$con = connect();		
		$mst_id=return_next_id( "id", "wo_pre_cost_trims_internal_dtls", 1);
		$field_array="id, trims_id, job_id, purchase_date, etd_date, eta_date, receive_date, inserted_by, insert_date, status_active, is_deleted";
		$data_array="(".$mst_id.",".$trim_id.",".$hid_job_id.",".$txt_pur_order_date.",".$txt_etd_date.",".$txt_eta_date.",".$txt_rcv_date.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,'0')";
		//echo "10**insert into wo_pre_cost_trims_internal_dtls ($field_array) values $data_array"; die;
		$rID=sql_insert("wo_pre_cost_trims_internal_dtls",$field_array,$data_array,0);
		check_table_status( $_SESSION['menu_id'],0);
		if($db_type==2 || $db_type==1 )
		{
			if($rID){
				oci_commit($con);
				echo "0**".$mst_id;
			}
			else{
				oci_rollback($con);
				echo "10**".$mst_id;
			}
		}
		disconnect($con);
		die;
	}
	else if ($operation==1)  // Update Here
	{
		$con = connect();
		$update_id=str_replace("'",'',$update_id);
		$field_array="purchase_date*etd_date*eta_date*receive_date*updated_by*update_date";
		$data_array="".$txt_pur_order_date."*".$txt_etd_date."*".$txt_eta_date."*".$txt_rcv_date."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'";

		$rID2=sql_update("wo_pre_cost_trims_internal_dtls",$field_array,$data_array,"id",$update_id,1);
		
		check_table_status( $_SESSION['menu_id'],0);
		if($db_type==2 || $db_type==1 )
		{
			if($rID2){
				oci_commit($con);
				echo "1**".$update_id;
			}
			else{
				oci_rollback($con);
				echo "10**".$update_id;
			}
		}
		disconnect($con);
		die;
	}
	else if($operation==2)  //Delete Here
	{
		$con = connect();
		$rID=execute_query("update wo_pre_cost_trims_internal_dtls set status_active=0, is_deleted=1, updated_by=".$_SESSION['logic_erp']['user_id'].",update_date='".$pc_date_time."' where id=$update_id");
		if($db_type==2 || $db_type==1 )
		{			
			if($rID){
				oci_commit($con);
				echo "2";
			}
			else{
				oci_rollback($con);
				echo "10";
			}
		}
		disconnect($con);
		die;
	}
}

if($action=="save_post_session_trim"){
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$_SESSION['logic_erp']['cons_breck_downn_trim']="";
	$_SESSION['logic_erp']['cons_breck_downn_trim']=$cons_breck_downn_trim;
	echo 1;
	die;
}

if ($action=="consumption_popup_trim")
{
  echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode,'','');
  extract($_REQUEST);
  $cons_breck_downn_trim= $_SESSION['logic_erp']['cons_breck_downn_trim'];
?>
<script>

	function copy_value(value,field_id,i){
		var gmtssizesid=document.getElementById('gmtssizesid_'+i).value;
		var pocolorid=document.getElementById('pocolorid_'+i).value;
		var cbogmtsitem=document.getElementById('cbogmtsitem_'+i).value;
		var ponoid=document.getElementById('ponoid_'+i).value;

		//var copy_val=document.getElementById('copy_val').checked;
		var rowCount = $('#tbl_consmption_cost tr').length-3;
		var copy_basis=$('input[name="copy_basis"]:checked').val()
		for(var j=i; j<=rowCount; j++)
		{
			if(field_id=='itemsizes_'){
				if(copy_basis==0){
					document.getElementById(field_id+j).value=value;
				}
				if(copy_basis==1){
					if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
				}
				else if(copy_basis==2){
					if( pocolorid==document.getElementById('pocolorid_'+j).value) document.getElementById(field_id+j).value=value;
				}
				else if(copy_basis==3){
					if( cbogmtsitem==document.getElementById('cbogmtsitem_'+j).value) document.getElementById(field_id+j).value=value;
				}
				else if(copy_basis==4){
					if( ponoid==document.getElementById('ponoid_'+j).value) document.getElementById(field_id+j).value=value;
				}
			}
			if(field_id=='cons_'){
				if(copy_basis==0){
					document.getElementById(field_id+j).value=value;
					calculate_tot_cons(j)
				}
				if(copy_basis==1){
					if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value){
						document.getElementById(field_id+j).value=value;
						calculate_tot_cons(j)
					}
				}
				else if(copy_basis==2){
					if( pocolorid==document.getElementById('pocolorid_'+j).value){
						document.getElementById(field_id+j).value=value;
						calculate_tot_cons(j)
					}
				}
				else if(copy_basis==3){
					if( cbogmtsitem==document.getElementById('cbogmtsitem_'+j).value){
						document.getElementById(field_id+j).value=value;
						calculate_tot_cons(j)
					}
				}
				else if(copy_basis==4){
					if( ponoid==document.getElementById('ponoid_'+j).value){
						document.getElementById(field_id+j).value=value;
						calculate_tot_cons(j)
					}
				}
			}
			if(field_id=='exper_'){
			if(copy_basis==0){
					document.getElementById(field_id+j).value=value;
					calculate_tot_cons(j)
				}
				if(copy_basis==1){
					if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value){
						document.getElementById(field_id+j).value=value;
						calculate_tot_cons(j)
					}
				}
				else if(copy_basis==2){
					if( pocolorid==document.getElementById('pocolorid_'+j).value){
						document.getElementById(field_id+j).value=value;
						calculate_tot_cons(j)
					}
				}
				else if(copy_basis==3){
					if( cbogmtsitem==document.getElementById('cbogmtsitem_'+j).value){
						document.getElementById(field_id+j).value=value;
						calculate_tot_cons(j)
					}
				}
				else if(copy_basis==4){
					if( ponoid==document.getElementById('ponoid_'+j).value){
						document.getElementById(field_id+j).value=value;
						calculate_tot_cons(j)
					}
				}
			}
			if(field_id=='totcons_'){
				if(copy_basis==0) document.getElementById(field_id+j).value=value;
				if(copy_basis==1){
					if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
				}
				else if(copy_basis==2){
					if( pocolorid==document.getElementById('pocolorid_'+j).value) document.getElementById(field_id+j).value=value;
				}
				else if(copy_basis==3){
					if( cbogmtsitem==document.getElementById('cbogmtsitem_'+j).value) document.getElementById(field_id+j).value=value;
				}
				else if(copy_basis==4){
					if( ponoid==document.getElementById('ponoid_'+j).value) document.getElementById(field_id+j).value=value;
				}
			}
			if(field_id=='rate_'){
			if(copy_basis==0){
					document.getElementById(field_id+j).value=value;
					calculate_amount(j)
				}
				if(copy_basis==1){
					if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value){
						document.getElementById(field_id+j).value=value;
						calculate_amount(j)
					}
				}
				else if(copy_basis==2){
					if( pocolorid==document.getElementById('pocolorid_'+j).value){
						document.getElementById(field_id+j).value=value;
						calculate_amount(j)
					}
				}
				else if(copy_basis==3){
					if( cbogmtsitem==document.getElementById('cbogmtsitem_'+j).value){
						document.getElementById(field_id+j).value=value;
						calculate_amount(j)
					}
				}
				else if(copy_basis==4){
					if( ponoid==document.getElementById('ponoid_'+j).value){
						document.getElementById(field_id+j).value=value;
						calculate_tot_cons(j)
					}
				}
			}
			if(field_id=='amount_'){
				if(copy_basis==0) document.getElementById(field_id+j).value=value;
				if(copy_basis==1){
					if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
				}
				else if(copy_basis==2){
					if( pocolorid==document.getElementById('pocolorid_'+j).value) document.getElementById(field_id+j).value=value;
				}
				else if(copy_basis==3){
					if( cbogmtsitem==document.getElementById('cbogmtsitem_'+j).value) document.getElementById(field_id+j).value=value;
				}
				else if(copy_basis==4){
					if( ponoid==document.getElementById('ponoid_'+j).value) document.getElementById(field_id+j).value=value;
				}
			}
			if(field_id=='place_'){
				if(copy_basis==0) document.getElementById(field_id+j).value=value;
				if(copy_basis==1){
					if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value) document.getElementById(field_id+j).value=value;
				}
				else if(copy_basis==2){
					if( pocolorid==document.getElementById('pocolorid_'+j).value) document.getElementById(field_id+j).value=value;
				}
				else if(copy_basis==3){
					if( cbogmtsitem==document.getElementById('cbogmtsitem_'+j).value) document.getElementById(field_id+j).value=value;
				}
				else if(copy_basis==4){
					if( ponoid==document.getElementById('ponoid_'+j).value) document.getElementById(field_id+j).value=value;
				}
			}
		}
		set_sum_value( 'cons_sum', 'cons_'  );
		set_sum_value( 'exper_sum', 'exper_'  );
		set_sum_value( 'totcons_sum', 'totcons_'  );
		set_sum_value( 'rate_sum', 'rate_'  );
		set_sum_value( 'amount_sum', 'amount_'  );
		set_sum_value( 'pcs_sum', 'pcs_');
	}

	function fn_delete_down_tr(rowNo,table_id)
	{
		if(table_id=='tbl_consmption_cost')
		{
			var numRow = $('table#tbl_consmption_cost tbody tr').length;
			if(numRow==rowNo && rowNo!=1)
			{
				$('#tbl_consmption_cost tbody tr:last').remove();
			}
			set_sum_value( 'cons_sum', 'cons_'  );
			set_sum_value( 'exper_sum', 'exper_'  );
			set_sum_value( 'totcons_sum', 'totcons_'  );
			set_sum_value( 'rate_sum', 'rate_'  );
			set_sum_value( 'amount_sum', 'amount_'  );
			set_sum_value( 'pcs_sum', 'pcs_');
		}
	}

	function set_sum_value(des_fil_id,field_id)
	{
		if(des_fil_id=='cons_sum') var ddd={dec_type:5,comma:0};
		if(des_fil_id=='exper_sum') var ddd={dec_type:5,comma:0};
		if(des_fil_id=='totcons_sum') var ddd={dec_type:5,comma:0};
		if(des_fil_id=='rate_sum') var ddd={dec_type:5,comma:0};
		if(des_fil_id=='amount_sum') var ddd={dec_type:5,comma:0};
		if(des_fil_id=='pcs_sum') var ddd={dec_type:6,comma:0};

		var rowCount = $('#tbl_consmption_cost tr').length-3;
		math_operation( des_fil_id, field_id, '+', rowCount,ddd );
		claculate_avg()
	}

	function js_set_value()
	{
		var rowCount = $('#tbl_consmption_cost tr').length-3;
		var cons_breck_down="";
		for(var i=1; i<=rowCount; i++)
		{
			var ponoid=$('#ponoid_'+i).val()
			if(ponoid=='') ponoid=0;
			var itemsizes=$('#itemsizes_'+i).val();
			if(itemsizes=='') itemsizes=0;
			var cons=$('#cons_'+i).val()
			if(cons=='') cons=0;
			var place=$('#place_'+i).val()
			if(place=='') place=0;
			var pcs=$('#pcs_'+i).val()
			if(pcs=='') pcs=0;
			var cbocountry=$('#cbocountry_'+i).val()
			if(cbocountry=='') cbocountry=0;

			var exper=$('#exper_'+i).val()
			if(exper=='') exper=0;
			var totcons=$('#totcons_'+i).val()
			if(totcons=='') totcons=0;
			var totexper=$('#totexper_'+i).val()
			if(totexper=='') totexper=0;

			var cbogmtsitem=$('#cbogmtsitem_'+i).val()
			if(cbogmtsitem=='') cbogmtsitem=0;
			var pocolorid=$('#pocolorid_'+i).val()
			if(pocolorid=='') pocolorid=0;
			var gmtssizesid=$('#gmtssizesid_'+i).val()
			if(gmtssizesid=='') gmtssizesid=0;

			var rate=$('#rate_'+i).val()
			if(rate=='') rate=0;
			var amount=$('#amount_'+i).val()
			if(amount=='') amount=0;
			var colorsizetableid=$('#colorsizetableid_'+i).val()
			if(colorsizetableid=='') colorsizetableid=0;

			if(cons_breck_down=="")
			{
				cons_breck_down+=ponoid+'_'+itemsizes+'_'+cons+'_'+place+'_'+pcs+'_'+cbocountry+'_'+exper+'_'+totcons+'_'+totexper+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+rate+'_'+amount+'_'+colorsizetableid;
			}
			else
			{
				cons_breck_down+="__"+ponoid+'_'+itemsizes+'_'+cons+'_'+place+'_'+pcs+'_'+cbocountry+'_'+exper+'_'+totcons+'_'+totexper+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+rate+'_'+amount+'_'+colorsizetableid;
			}
		}
		//alert(cons_breck_down)
		var calculator_string='';
		var calculator_parameter=document.getElementById('calculator_parameter').value
		if(calculator_parameter==1){

			var txt_cons_per_gmts=document.getElementById('txt_cons_per_gmts').value
			var txt_cons_for_mtr=document.getElementById('txt_cons_for_mtr').value
			var txt_cons_length=document.getElementById('txt_cons_length').value
			var txt_caculated_value=document.getElementById('txt_caculated_value').value
			calculator_string=txt_cons_per_gmts+"_"+txt_cons_for_mtr+"_"+txt_cons_length+"_"+txt_caculated_value
		}
		if(calculator_parameter==2){
			var txt_gmts_per_catton=document.getElementById('txt_gmts_per_catton').value
			var txt_cost_for=document.getElementById('txt_cost_for').value
			var txt_caculated_value=document.getElementById('txt_caculated_value').value
			calculator_string=txt_gmts_per_catton+"_"+txt_cost_for+"_"+txt_caculated_value
		}
		if(calculator_parameter==3){
			var txt_stiker_per_catton=document.getElementById('txt_stiker_per_catton').value
			var txt_req_carton=document.getElementById('txt_req_carton').value
			var txt_caculated_value=document.getElementById('txt_caculated_value').value
			calculator_string=txt_stiker_per_catton+"_"+txt_req_carton+"_"+txt_caculated_value
		}
		if(calculator_parameter==4){
			var txt_gmts_per_catton=document.getElementById('txt_gmts_per_catton').value
			var txt_cost_for=document.getElementById('txt_cost_for').value
			var txt_caculated_value=document.getElementById('txt_caculated_value').value
			calculator_string=txt_gmts_per_catton+"_"+txt_cost_for+"_"+txt_caculated_value
		}
		if(calculator_parameter==5){
			var txt_cons_per_gmts=document.getElementById('txt_cons_per_gmts').value
			var txt_cons_length=document.getElementById('txt_cons_length').value
			var txt_caculated_value=document.getElementById('txt_caculated_value').value
			calculator_string=txt_cons_per_gmts+"_"+txt_cons_length+"_"+txt_caculated_value
		}
		if(calculator_parameter==6){
			var txt_cons_per_gmts=document.getElementById('txt_cons_per_gmts').value
			var txt_pcs_per_carton=document.getElementById('txt_pcs_per_carton').value
			var txt_cons_length=document.getElementById('txt_cons_length').value
			var txt_caculated_value=document.getElementById('txt_caculated_value').value
			calculator_string=txt_cons_per_gmts+"_"+txt_pcs_per_carton+"_"+txt_cons_length+"_"+txt_caculated_value
		}
		if(calculator_parameter==7){
			var txt_cons_per_gmts=document.getElementById('txt_cons_per_gmts').value
			var txt_cons_length=document.getElementById('txt_cons_length').value
			var txt_caculated_value=document.getElementById('txt_caculated_value').value
			calculator_string=txt_cons_per_gmts+"_"+txt_cons_length+"_"+txt_caculated_value
		}
		if(calculator_parameter==8){
			var txt_cons_per_gmts=document.getElementById('txt_cons_per_gmts').value
			var txt_cons_length=document.getElementById('txt_cons_length').value
			var txt_caculated_value=document.getElementById('txt_caculated_value').value
			calculator_string=txt_cons_per_gmts+"_"+txt_cons_length+"_"+txt_caculated_value

		}
		document.getElementById('cons_breck_down').value=cons_breck_down;
		document.getElementById('calculator_string').value=calculator_string;
		claculate_avg();
		parent.emailwindow.hide();
	}

	function claculate_avg(){
		//var tot_plancut_qty=document.getElementById('job_qty').value*1
		var item_ratio=document.getElementById('item_ratio').value*1
		var calculated_cons=0; var avg_cons=0; var plancutqty=0; var calculated_amount=0; var significant_row_cal=0; var avg_ex_cons_per=0;
		var rowCount = $('#tbl_consmption_cost tr').length-3;

		for(var i=1; i<=rowCount; i++){
			if(document.getElementById('cons_'+i).value =='' || document.getElementById('cons_'+i).value ==0){
				continue;
			}
			else{
				var tot_plancut_qty=document.getElementById('itempcsgmts_'+i).value*1
				var pcsgmts=document.getElementById('pcsgmts_'+i).value*1
				var plan_cut_percent=(pcsgmts/tot_plancut_qty)*100;
				
				var ex_cons_per=document.getElementById('exper_'+i).value*1;
				avg_ex_cons_per+=ex_cons_per;

				var cons=document.getElementById('cons_'+i).value*1
				var avg_cons_percent=(cons*plan_cut_percent)/100;
				avg_cons+=avg_cons_percent;

				var requirement=document.getElementById('totcons_'+i).value*1
				var calculated_cons_percent=(requirement*plan_cut_percent)/100;
				calculated_cons+=calculated_cons_percent;

				var amount=document.getElementById('amount_'+i).value*1
				var calculated_amount_percent=(amount*plan_cut_percent)/100;
				calculated_amount+=calculated_amount_percent;
				
				significant_row_cal=significant_row_cal+1;
			}
		}
		//document.getElementById('avg_cons').value=number_format_common(avg_cons*item_ratio, 5, 0);
		//document.getElementById('avg_totcons').value=number_format_common(calculated_cons*item_ratio, 5, 0);
		//document.getElementById('avg_amountcons').value=number_format_common(calculated_amount*item_ratio, 5, 0);
		document.getElementById('avg_cons').value=number_format_common(avg_cons, 5, 0);
		document.getElementById('avg_totcons').value=number_format_common(calculated_cons, 5, 0);
		document.getElementById('avg_amountcons').value=number_format_common(calculated_amount, 5, 0);
		document.getElementById('avg_ratecons').value=number_format_common(calculated_amount/calculated_cons, 5, 0);
		
		var calculated_exper=(document.getElementById('exper_sum').value*1)/significant_row_cal;
		document.getElementById('avg_exper').value=number_format_common(calculated_exper, 6, 0);
	}


	function clculate_cons_for_mtr()
	{
		var txt_cons_per_gmts=(document.getElementById('txt_cons_per_gmts').value)*1;
		var txt_costing_per=document.getElementById('txt_costing_per').value;
		if(txt_costing_per==1) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*12;
		if(txt_costing_per==2) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*1;
		if(txt_costing_per==3) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*2*12;
		if(txt_costing_per==4) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*3*12;
		if(txt_costing_per==5) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*4*12;

		var txt_cons_for_mtr= (document.getElementById('txt_cons_for_mtr').value)*1
		var txt_cons_length= (document.getElementById('txt_cons_length').value)*1
		document.getElementById('txt_caculated_value').value=txt_cons_for_mtr/txt_cons_length;
	}

	function clculate_req_carton()
	{
		var txt_gmts_per_catton=(document.getElementById('txt_gmts_per_catton').value)*1;
		var txt_cost_for=document.getElementById('txt_cost_for').value;
		var txt_caculated_value=(1/txt_gmts_per_catton)*txt_cost_for;
		document.getElementById('txt_caculated_value').value= number_format_common(txt_caculated_value,5,0);
	}

	function clculate_req_carton_stiker()
	{
		var txt_stiker_per_catton=(document.getElementById('txt_stiker_per_catton').value)*1;
		var txt_req_carton=document.getElementById('txt_req_carton').value;
		var txt_caculated_value=txt_stiker_per_catton*txt_req_carton;
		document.getElementById('txt_caculated_value').value= number_format_common(txt_caculated_value,5,0);
	}

	function clculate_elastic()
	{
		var txt_costing_per=document.getElementById('txt_costing_per').value;
		var txt_cons_per_gmts=(document.getElementById('txt_cons_per_gmts').value)*1;
		var txt_cons_length= (document.getElementById('txt_cons_length').value)*1
		var cons_dzn=0;
		if(txt_costing_per==1) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*12
		if(txt_costing_per==2) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*1
		if(txt_costing_per==3) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*24
		if(txt_costing_per==4) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*36
		if(txt_costing_per==5) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*48

		document.getElementById('txt_caculated_value').value=number_format_common(cons_dzn,5,0);
	}

	function clculate_gumtap()
	{
		var txt_costing_per=document.getElementById('txt_costing_per').value;
		var txt_cons_per_gmts=(document.getElementById('txt_cons_per_gmts').value)*1;
		var txt_pcs_per_carton=(document.getElementById('txt_pcs_per_carton').value)*1;
		var txt_cons_length= (document.getElementById('txt_cons_length').value)*1
		var cons_dzn=0;
		if(txt_costing_per==1)
		{
			cons_dzn=(txt_cons_per_gmts/txt_pcs_per_carton);
			cons_dzn=(cons_dzn/txt_cons_length)*12;
		}
		if(txt_costing_per==2)
		{
			cons_dzn=(txt_cons_per_gmts/txt_pcs_per_carton);
			cons_dzn=(cons_dzn/txt_cons_length)*1;
		}
		if(txt_costing_per==3)
		{
			cons_dzn=(txt_cons_per_gmts/txt_pcs_per_carton);
			cons_dzn=(cons_dzn/txt_cons_length)*24;
		}
		if(txt_costing_per==4)
		{
			cons_dzn=(txt_cons_per_gmts/txt_pcs_per_carton);
			cons_dzn=(cons_dzn/txt_cons_length)*36;
		}
		if(txt_costing_per==5)
		{
			cons_dzn=(txt_cons_per_gmts/txt_pcs_per_carton);
			cons_dzn=(cons_dzn/txt_cons_length)*48;
		}
		document.getElementById('txt_caculated_value').value=number_format_common(cons_dzn,5,0);
	}

	function clculate_tagpin()
	{
		var txt_costing_per=document.getElementById('txt_costing_per').value;
		var txt_cons_per_gmts=(document.getElementById('txt_cons_per_gmts').value)*1;
		var txt_cons_length= (document.getElementById('txt_cons_length').value)*1
		var cons_dzn=0;
		if(txt_costing_per==1) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*12
		if(txt_costing_per==2) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*1
		if(txt_costing_per==3) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*24
		if(txt_costing_per==4) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*36
		if(txt_costing_per==5) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*48

		document.getElementById('txt_caculated_value').value=number_format_common(cons_dzn,5,0);
	}

	function clculate_sequines()
	{
		var txt_costing_per=document.getElementById('txt_costing_per').value;
		var txt_cons_per_gmts=(document.getElementById('txt_cons_per_gmts').value)*1;
		var txt_cons_length= (document.getElementById('txt_cons_length').value)*1
		var cons_dzn=0;
		if(txt_costing_per==1) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*12
		if(txt_costing_per==2) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*1
		if(txt_costing_per==3) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*24
		if(txt_costing_per==4) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*36
		if(txt_costing_per==5) cons_dzn=(txt_cons_per_gmts/txt_cons_length)*48

		document.getElementById('txt_caculated_value').value=number_format_common(cons_dzn,5,0);
	}

	function calculator_value_set(i)
	{
		var txt_caculated_value=document.getElementById('txt_caculated_value').value
		document.getElementById('tr_order').value=i;
		if(txt_caculated_value !='')
		{
			document.getElementById('cons_'+i).value=txt_caculated_value;
			copy_value(txt_caculated_value,'cons_',i);
			//calculate_tot_cons(i)
		}
	}

	function open_country_popup(i)
	{
		var txt_po_id=document.getElementById('ponoid_'+i).value;
		var txt_country=document.getElementById('cbocountry_'+i).value
		var txt_country_name=document.getElementById('cbocountryname_'+i).value
		var page_link='pre_cost_entry_controller_v2.php?action=open_country_popup';
		var title='Country';
		page_link=page_link+'&txt_po_id='+txt_po_id+'&txt_country='+txt_country+'&txt_country_name='+txt_country_name;
		emailwindow=dhtmlmodal.open('EmailBox', 'iframe', page_link, title, 'width=420px,height=350px,center=1,resize=0,scrolling=0','../')
		emailwindow.onclose=function()
		{
			var theform=this.contentDoc.forms[0];
			var theemail=this.contentDoc.getElementById("txt_selected_id");
			var theemailname=this.contentDoc.getElementById("txt_selected_name");
			//if (trim(theemail.value)!="")
			//{
			//freeze_window(5);
			document.getElementById('cbocountry_'+i).value=trim(theemail.value);
			document.getElementById('cbocountryname_'+i).value=trim(theemailname.value);
			//release_freezing();
			//}
		}
	}

	function calculate_tot_cons(i)
	{
		var cons=document.getElementById('cons_'+i).value*1;
		var exper=document.getElementById('exper_'+i).value*1;
		var totexper=number_format_common((cons*exper/100),5,0)*1;
		var totcons=number_format_common(totexper+cons,5,0);
		document.getElementById('totcons_'+i).value=totcons;
		document.getElementById('totexper_'+i).value=totexper;
		//copy_value(totcons,'totcons_',i)
		set_sum_value( 'totcons_sum', 'totcons_'  );
		calculate_amount(i);
		row_tot(i);
	}

	function calculate_amount(i)
	{
		var totcons=document.getElementById('totcons_'+i).value*1;
		var rate=document.getElementById('rate_'+i).value*1;
		var amount=number_format_common(totcons*rate,5,0);
		document.getElementById('amount_'+i).value=amount;
		//copy_value(amount,'amount_',i)
		set_sum_value( 'amount_sum', 'amount_'  );
		row_tot(i);
	}

	function row_tot(i){
		var itemratiogmts= (document.getElementById('itemratiogmts_'+i).value)*1;
		var pcsgmts= (document.getElementById('pcsgmts_'+i).value)*1;
		var pcs= (document.getElementById('pcs').value)*1;
		var totcons= (document.getElementById('totcons_'+i).value)*1;
		var rate= (document.getElementById('rate_'+i).value)*1;
		var dznGmts=(pcsgmts/itemratiogmts);
		var RowtotReq= dznGmts*(totcons/pcs);
		var RowtotAmt= RowtotReq*rate;
		document.getElementById('totqty_'+i).value=RowtotReq;
		document.getElementById('totamount_'+i).value=RowtotAmt;
		set_sum_value( 'totReq_sum', 'totqty_'  );
		set_sum_value( 'totAmount_sum', 'totamount_'  );
		set_sum_value( 'AtotReq_sum', 'totqty_'  );
		set_sum_value( 'AtotAmount_sum', 'totamount_'  );
	}
</script>
</head>
<body>
<div align="center" style="width:100%;">
<?
	if($cbo_costing_per==1) $pcs_value=1*12;
	if($cbo_costing_per==2) $pcs_value=1*1;
	if($cbo_costing_per==3) $pcs_value=2*12;
	if($cbo_costing_per==4) $pcs_value=3*12;
	if($cbo_costing_per==5)$pcs_value=4*12;

	$job_order_uom=return_field_value("order_uom","wo_po_details_master","job_no='$txt_job_no'");
	$calculatorstringarr=explode("_",$calculatorstring);
?>
 	<div style="font-size:18px; font-weight:bold"><?=$cbogrouptext; ?></div>
        <table class="rpt_table" border="0">
            <tr>
                <td><?
                if($calculator_parameter==1)
				{
					$txt_cons_length=$calculatorstringarr[2];
					if($txt_cons_length=="" || $txt_cons_length==0) $txt_cons_length=4000;
					?>
					<fieldset>
                        <legend>Sewing Thread-Comsumption Calculator</legend>
                        <table cellpadding="0" cellspacing="0" align="center" width="1020">
                            <tr>
                                <td width="100">Cons Per Garment</td>
                                <td><input type="text" id="txt_cons_per_gmts" name="txt_cons_per_gmts" class="text_boxes_numeric" onChange="clculate_cons_for_mtr()" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> style="width:100px"  value="<?=$calculatorstringarr[0]; ?>"/> Mtr</td>
                                <td width="100">Cons <?=$costing_per[$cbo_costing_per]; ?></td>
                                <td><input type="text" id="txt_cons_for_mtr" name="txt_cons_for_mtr" class="text_boxes_numeric" style="width:100px" value="<?=$calculatorstringarr[1]; ?>" readonly/> Mtr</td>
                                <td width="100">Cone Length</td>
                                <td><input type="text" id="txt_cons_length" name="txt_cons_length" class="text_boxes_numeric"  onChange="clculate_cons_for_mtr()"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> style="width:100px" value="<?=$txt_cons_length; ?>"/> Mtr</td>
                                <td width="100">Cons <?=$costing_per[$cbo_costing_per]; ?></td>
                                <td>
                                    <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" style="width:100px" readonly value="<?=$calculatorstringarr[3]; ?>" /> Cone
                                    <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<?=$cbo_costing_per; ?>" readonly /> 										<input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
                                </td>
                            </tr>
                        </table>
					</fieldset>
				<?
                }
                else if($calculator_parameter==2)
                {
					?>
					<fieldset>
                        <legend>Carton-Comsumption Calculator</legend>
                        <table cellpadding="0" cellspacing="0" align="center" width="1020">
                            <tr>
                                <td width="120">Gmts Per Carton</td>
                                <td><input type="text" id="txt_gmts_per_catton" name="txt_gmts_per_catton" class="text_boxes_numeric" onChange="clculate_req_carton()" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>  value="<?=$calculatorstringarr[0]; ?>"/></td>
                                <td>Costting <?=$costing_per[$cbo_costing_per]; ?></td>
                                <td><input type="text" id="txt_cost_for" name="txt_cost_for" class="text_boxes_numeric" value="<?=$pcs_value;?>"  readonly/></td>
                                <td>Required Carton</td>
                                <td>
                                    <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" readonly value="<?=$calculatorstringarr[2]; ?>" />
                                    <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<?=$cbo_costing_per; ?>" readonly /> 										<input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
                                </td>
                            </tr>
                        </table>
					</fieldset>
					<?
                }
                if($calculator_parameter==3)
                {
					$data_array=sql_select("select a.cons_dzn_gmts from wo_pre_cost_trim_cost_dtls a,lib_item_group b where a.trim_group=b.id and b.cal_parameter=2 and a.job_no='$txt_job_no' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
					$total_row=count($data_array);
					$req_carton=0;
					if($total_row==1)
					{
						list($data)	= $data_array;
						$req_carton=$data[csf('cons_dzn_gmts')];
					}
					?>
					<fieldset>
                        <legend>Carton Stiker-Comsumption Calculator</legend>
                        <table cellpadding="0" cellspacing="0" align="center" width="1020">
                            <tr>
                                <td width="120">Stiker Per Carton</td>
                                <td><input type="text" id="txt_stiker_per_catton" name="txt_stiker_per_catton" class="text_boxes_numeric" onChange="clculate_req_carton_stiker();"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> value="<?=$calculatorstringarr[0] ?>"/></td>
                                <td>Req Car <?=$costing_per[$cbo_costing_per]; ?></td>
                                <td><input type="text" id="txt_req_carton" name="txt_req_carton" class="text_boxes_numeric" onChange="clculate_req_carton_stiker();" value="<?=$req_carton;?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> readonly /></td>
                                <td>Required Stiker</td>
                                <td>
                                    <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" readonly value="<?=$calculatorstringarr[2] ?>" />
                                    <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<?=$cbo_costing_per; ?>" readonly /> 										<input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
                                </td>
                            </tr>
                        </table>
					</fieldset>
					<?
                }
                if($calculator_parameter==4)
                {
					?>
					<fieldset>
                        <legend>Poly-Comsumption Calculator</legend>
                        <table cellpadding="0" cellspacing="0" align="center" width="1020">
                            <tr>
                                <td width="120">Gmts Per Poly</td>
                                <td><input type="text" id="txt_gmts_per_catton" name="txt_gmts_per_catton" class="text_boxes_numeric" onChange="clculate_req_carton()" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>  value="<?=$calculatorstringarr[0] ?>"/></td>
                                <td>Costting <?=$costing_per[$cbo_costing_per];?></td>
                                <td><input type="text" id="txt_cost_for" name="txt_cost_for" class="text_boxes_numeric" value="<?=$pcs_value;?>"  readonly/></td>
                                <td>Required Poly</td>
                                <td>
                                    <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" readonly value="<?=$calculatorstringarr[2] ?>" />
                                    <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<?=$cbo_costing_per; ?>" readonly /> 										<input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
                                </td>
                            </tr>
                        </table>
					</fieldset>
					<?
                }
                if($calculator_parameter==5)
                {
					$RollLength=$calculatorstringarr[1];
					if($RollLength == "" || $RollLength==0) $RollLength=48;
					?>
					<fieldset>
                        <legend>Elastic Calculator</legend>
                        <table cellpadding="0" cellspacing="0" align="center" width="1020">
                            <tr>
                                <td width="100">Cons Per Garment</td>
                                <td><input type="text" id="txt_cons_per_gmts" name="txt_cons_per_gmts" class="text_boxes_numeric" onChange="clculate_elastic()" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> style="width:100px" value="<? echo $calculatorstringarr[0] ?>" /> Yds</td>
                                <td width="100">Roll Length</td>
                                <td><input type="text" id="txt_cons_length" name="txt_cons_length" class="text_boxes_numeric"  onChange="clculate_elastic()" value="<? echo $RollLength; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> style="width:100px"/> Yds</td>
                                <td width="100">Cons <?=$costing_per[$cbo_costing_per]; ?></td>
                                <td>
                                    <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" style="width:100px" readonly value="<? echo $calculatorstringarr[2] ?>" /> Roll
                                    <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<? echo $cbo_costing_per; ?>" readonly /> 										<input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
                                </td>
                            </tr>
                        </table>
					</fieldset>
					<?
                }
                if($calculator_parameter==6)
                {
					$RollLength=$calculatorstringarr[2];
					if($RollLength == "" || $RollLength==0) $RollLength=48;
					?>
					<fieldset>
                        <legend>Gum Tap Calculator</legend>
                        <table cellpadding="0" cellspacing="0" align="center" width="1020">
                            <tr>
                                <td width="100">Cons Per Carton</td>
                                <td><input type="text" id="txt_cons_per_gmts" name="txt_cons_per_gmts" class="text_boxes_numeric" onChange="clculate_gumtap()" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>  style="width:100px" value="<? echo $calculatorstringarr[0] ?>"/> Yds</td>
                                <td width="100">Pcs Per Carton</td>
                                <td><input type="text" id="txt_pcs_per_carton" name="txt_pcs_per_carton" class="text_boxes_numeric" onChange="clculate_gumtap()" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> style="width:100px" value="<? echo $calculatorstringarr[1] ?>"/> Pcs</td>
                                <td width="100">Roll Length</td>
                                <td><input type="text" id="txt_cons_length" name="txt_cons_length" class="text_boxes_numeric"  onChange="clculate_gumtap()" value="<? echo $RollLength; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> style="width:100px"/> Yds</td>
                                <td width="100">Cons  <? echo $costing_per[$cbo_costing_per];?></td>
                                <td>
                                    <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" style="width:100px" readonly value="<? echo $calculatorstringarr[3] ?>"/> Roll
                                    <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<? echo $cbo_costing_per; ?>" readonly /> 										<input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
                                </td>
                            </tr>
                        </table>
					</fieldset>
					<?
                }
                if($calculator_parameter==7)
                {
					$QtyPerBox=$calculatorstringarr[1];
					if($QtyPerBox=="" || $QtyPerBox== 0) $QtyPerBox=4800;
					?>
					<fieldset>
                        <legend>Tag Pin Calculator</legend>
                        <table cellpadding="0" cellspacing="0" align="center" width="1020">
                            <tr>
                                <td width="120">Cons Per Garments</td>
                                <td><input type="text" id="txt_cons_per_gmts" name="txt_cons_per_gmts" class="text_boxes_numeric" onChange="clculate_tagpin()" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>  value="<? echo $calculatorstringarr[0] ?>"/> Pcs</td>
                                <td>Qty Per Box</td>
                                <td><input type="text" id="txt_cons_length" name="txt_cons_length" class="text_boxes_numeric"  onChange="clculate_tagpin()" value="<? echo $QtyPerBox; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>/> Pcs</td>
                                <td>Cons  <? echo $costing_per[$cbo_costing_per];?></td>
                                <td>
                                    <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" readonly value="<? echo $calculatorstringarr[2] ?>"/> Box
                                    <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<? echo $cbo_costing_per; ?>" readonly /> 										<input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
                                </td>
                            </tr>
                        </table>
					</fieldset>
					<?
                }
                if($calculator_parameter==8)
                {
					$RollLength=$calculatorstringarr[1];
					if($RollLength== "" || $RollLength==0) $RollLength=10000;
					?>
					<fieldset>
                        <legend>Sequines Calculator</legend>
                        <table cellpadding="0" cellspacing="0" align="center" width="1020">
                            <tr>
                                <td width="120">Cons Per Garments</td>
                                <td><input type="text" id="txt_cons_per_gmts" name="txt_cons_per_gmts" class="text_boxes_numeric" onChange="clculate_sequines()" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> value="<? echo $calculatorstringarr[0] ?>" /> Yds</td>
                                <td>Roll Length</td>
                                <td><input type="text" id="txt_cons_length" name="txt_cons_length" class="text_boxes_numeric"  onChange="clculate_sequines()" value="<? echo $RollLength; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>/> Yds</td>
                                <td>Cons <? echo $costing_per[$cbo_costing_per];?></td>
                                <td>
                                    <input type="text" id="txt_caculated_value" name="txt_caculated_value" class="text_boxes_numeric" readonly value="<? echo $calculatorstringarr[2] ?>"/> Roll
                                    <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<? echo $cbo_costing_per; ?>" readonly /> 										<input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
                                </td>
                            </tr>
                        </table>
					</fieldset>
					<?
                }
                ?>
                </td>
            </tr>
            <tr>
                <th><!--<b>Copy</b> : <input type="checkbox" id="copy_val" name="copy_val" checked/>-->
                    <input type="hidden" id="pcs" name="pcs" class="text_boxes_numeric" style="width:75px" value="<?=$pcs_value; ?>"> 
                    <input type="hidden" id="tr_order" name="tr_order" class="text_boxes_numeric" style="width:75px" value="" /> 
                    <input type="hidden" id="cons_breck_down" name="cons_breck_down" class="text_boxes_numeric" style="width:75px" value="" />
                    <input type="hidden" id="item_ratio" name="item_ratio" class="text_boxes_numeric" style="width:75px"  value="<?=$tot_set_qnty; ?>" />
                    <input type="hidden" id="calculator_parameter" name="calculator_parameter" class="text_boxes_numeric" style="width:75px" value="<?=$calculator_parameter; ?>"/>
                    <input type="hidden" id="calculator_string" name="calculator_string" class="text_boxes_numeric" style="width:75px" value="" readonly />
                    <form>
                        <input type="radio" name="copy_basis" value="no" >No Copy 
                        <input type="radio" name="copy_basis" value="0" checked>Copy to All
                        <input type="radio" name="copy_basis" value="1">Copy Gmts Size Wise
                        <input type="radio" name="copy_basis" value="2">Copy Gmts Color Wise
                        <input type="radio" name="copy_basis" value="3">Copy Gmts Item Wise
                        <input type="radio" name="copy_basis" value="4">Copy Po Wise
                        <input type="reset" value="Reset">
                    </form>
                </th> 
                <th></th>
            </tr>
            <tr>
            <td>
            <table width="1170" cellspacing="0" class="rpt_table" border="0" id="tbl_consmption_cost" rules="all">
                <thead>
                    <tr>
                        <th width="30">SL</th>
                        <th width="120">PO NO</th>
                        <th width="120">Gmts.Item</th>
                        <th width="80">Country</th>
                        <th width="90">Gmts Color</th>
                        <th width="70">Gmts Size</th>
                        <th width="60">Item Size</th>
                        <th width="60">Cons</th>
                        <th width="50">Ex. %</th>
                        <th width="60">Tot. Cons</th>
                        <th width="50">Rate</th>
                        <th width="60">Amount</th>
                        <th width="70">Total Qty</th>
                        <th width="70">Total Amount</th>
                        <th width="50">Placement</th>
                        <th width="50"><? if ($job_order_uom==1){echo "Pcs";} if($job_order_uom==58){echo "Set";} ?></th>
                        <th>&nbsp;</th>
                    </tr>
                </thead>
                <tbody>
                <?
                if($cbo_costing_per==1) $pcs_value=1*12;
                if($cbo_costing_per==2) $pcs_value=1*1;
                if($cbo_costing_per==3) $pcs_value=2*12;
                if($cbo_costing_per==4) $pcs_value=3*12;
                if($cbo_costing_per==5) $pcs_value=4*12;
                $component_approved=0;
                $sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=2 and job_no='$txt_job_no'");
                foreach($sql as $row){
                	if($row[csf('approved')]==1 || $row[csf('approved')]==3) { $component_approved=1; }
                }
                $item_ratio_arr=array();
                $gmts_item_sql=sql_select("select gmts_item_id, set_item_ratio from  wo_po_details_mas_set_details  where job_no='$txt_job_no'");
                foreach($gmts_item_sql as $gmts_item_row)
                {
               		$item_ratio_arr[$gmts_item_row[csf('gmts_item_id')]] = $gmts_item_row[csf('set_item_ratio')];
                }
                $country=rtrim($country,",");
                if($country=="") $country_cond=""; else $country_cond=" and c.country_id in($country)";
               
                $country_array=array();
                $data_country=sql_select("select b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id ,c.country_id from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c  where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id  and b.job_no_mst='$txt_job_no' $country_cond   and a.status_active=1 and b.status_active=1 and c.status_active=1");
                foreach($data_country as $data_country_row){
					$country_array[$data_country_row[csf('id')]][$data_country_row[csf('item_number_id')]][$data_country_row[csf('color_number_id')]][$data_country_row[csf('size_number_id')]]['country_id'][$data_country_row[csf('country_id')]]=$data_country_row[csf('country_id')];
					$country_array[$data_country_row[csf('id')]][$data_country_row[csf('item_number_id')]][$data_country_row[csf('color_number_id')]][$data_country_row[csf('size_number_id')]]['country_name'][$data_country_row[csf('country_id')]]=$country_library[$data_country_row[csf('country_id')]];
                }
                
                $data_array_item_qty=sql_select("select b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id ,min(c.id)as color_size_table_id, min(color_order) as color_order, min(size_order) as size_order, sum(plan_cut_qnty) as plan_cut_qnty,sum(order_quantity) as order_quantity from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c  where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id  and b.job_no_mst='$txt_job_no'   and a.status_active=1 and b.status_active=1 and c.status_active=1 group by b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id order by b.id,c.item_number_id,color_order,size_order");
                
                $data_array=sql_select("select b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id ,min(c.id)as color_size_table_id, min(color_order) as color_order, min(size_order) as size_order, sum(plan_cut_qnty) as plan_cut_qnty,sum(order_quantity) as order_quantity from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c  where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id  and b.job_no_mst='$txt_job_no' $country_cond   and a.status_active=1 and b.status_active=1 and c.status_active=1 group by b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id order by b.id,c.item_number_id,color_order,size_order");
                // echo $updateidtrim ;
                if($updateidtrim != ""){
					// echo "select id, wo_pre_cost_trim_cost_dtls_id, job_no, po_break_down_id,item_number_id, color_number_id, size_number_id,item_size,item_color_number_id,country_id,place, cons,excess_per,tot_cons,ex_cons,rate,amount,pcs,gmts_pcs,color_size_table_id  from wo_pre_cost_trim_co_cons_dtls where job_no='$txt_job_no' and wo_pre_cost_trim_cost_dtls_id=$updateidtrim order by id";
					//echo "select a.id, a.wo_pre_cost_trim_cost_dtls_id, a.job_no, a.po_break_down_id,a.item_number_id, a.color_number_id, a.size_number_id,a.item_size,a.item_color_number_id,a.country_id,a.place, a.cons,a.excess_per,a.tot_cons,a.ex_cons,a.rate,a.amount,a.pcs,a.gmts_pcs,a.color_size_table_id, b.color_order,b.size_order  from wo_pre_cost_trim_co_cons_dtls a, wo_po_color_size_breakdown b where a.job_no=b.job_no_mst and a.po_break_down_id=b.po_break_down_id and a.item_number_id=b.item_number_id and a.color_number_id=b.color_number_id and a.size_number_id=b.size_number_id  and  a.job_no='$txt_job_no' and a.wo_pre_cost_trim_cost_dtls_id=$updateidtrim order by a.po_break_down_id,a.item_number_id,color_order,size_order";
					$row_arr_data="";
					$wo_pre_cos_fab_co_avg_con_dtls_data=sql_select("select a.id, a.wo_pre_cost_trim_cost_dtls_id, a.job_no, a.po_break_down_id,a.item_number_id, a.color_number_id, a.size_number_id,a.item_size,a.item_color_number_id,a.country_id,a.place, a.cons,a.excess_per,a.tot_cons,a.ex_cons,a.rate,a.amount,a.pcs,a.gmts_pcs,a.color_size_table_id, min(b.color_order) as color_order,min(b.size_order) as size_order   from wo_pre_cost_trim_co_cons_dtls a, wo_po_color_size_breakdown b where a.job_no=b.job_no_mst and a.po_break_down_id=b.po_break_down_id and a.item_number_id=b.item_number_id and a.color_number_id=b.color_number_id and a.size_number_id=b.size_number_id  and  a.job_no='$txt_job_no' and a.wo_pre_cost_trim_cost_dtls_id=$updateidtrim group by a.id, a.wo_pre_cost_trim_cost_dtls_id, a.job_no, a.po_break_down_id,a.item_number_id, a.color_number_id, a.size_number_id,a.item_size,a.item_color_number_id,a.country_id,a.place, a.cons,a.excess_per,a.tot_cons,a.ex_cons,a.rate,a.amount,a.pcs,a.gmts_pcs,a.color_size_table_id order by a.po_break_down_id,a.item_number_id,color_order,size_order");
					
					foreach($wo_pre_cos_fab_co_avg_con_dtls_data as $wo_pre_cos_fab_co_avg_con_dtls_data_row){
						$row_arr=$wo_pre_cos_fab_co_avg_con_dtls_data_row[csf('po_break_down_id')]."_".$wo_pre_cos_fab_co_avg_con_dtls_data_row[csf('item_size')]."_".$wo_pre_cos_fab_co_avg_con_dtls_data_row[csf('tot_cons')]."_".$wo_pre_cos_fab_co_avg_con_dtls_data_row[csf('place')]."_".$wo_pre_cos_fab_co_avg_con_dtls_data_row[csf('pcs')]."_".$wo_pre_cos_fab_co_avg_con_dtls_data_row[csf('country_id')]."_".$wo_pre_cos_fab_co_avg_con_dtls_data_row[csf('excess_per')]."_".$wo_pre_cos_fab_co_avg_con_dtls_data_row[csf('cons')]."_".$wo_pre_cos_fab_co_avg_con_dtls_data_row[csf('ex_cons')]."_".$wo_pre_cos_fab_co_avg_con_dtls_data_row[csf('item_number_id')]."_".$wo_pre_cos_fab_co_avg_con_dtls_data_row[csf('color_number_id')]."_".$wo_pre_cos_fab_co_avg_con_dtls_data_row[csf('size_number_id')]."_".$wo_pre_cos_fab_co_avg_con_dtls_data_row[csf('rate')]."_".$wo_pre_cos_fab_co_avg_con_dtls_data_row[csf('amount')]."_".$wo_pre_cos_fab_co_avg_con_dtls_data_row[csf('color_size_table_id')];
						$row_arr_data.=$row_arr."__";
					}
					$row_arr_data=rtrim($row_arr_data,"__");
					$cons_breck_downnarr=explode("__",$row_arr_data);
                }
                //print_r($cons_breck_downnarr);
                if($updateidtrim == ""){
                	$cons_breck_downnarr=explode("__",$cons_breck_downn_trim);
                }
                
                $itemqty_array=array();
                foreach($data_array_item_qty as $data_array_tot_job_qty_row ){
                	$itemqty_array[$data_array_tot_job_qty_row[csf('item_number_id')]]+=$data_array_tot_job_qty_row[csf('order_quantity')];
                }
                if($cbo_approved_status!=1) $cbo_approved_status=$component_approved;
                $cons_fld=0; $is_booking_arr=array();
                if($cbo_approved_status!=1)
                {
					$data_arr=sql_select("select po_break_down_id, pre_cost_fabric_cost_dtls_id from wo_booking_dtls where pre_cost_fabric_cost_dtls_id ='$updateidtrim' and booking_type='2' and status_active=1 and is_deleted=0 group by po_break_down_id, pre_cost_fabric_cost_dtls_id");
					//if ( count($data_arr)>0) { $cbo_approved_status=1; }
					foreach($data_arr as $row)
					{
						$is_booking_arr[$row[csf('po_break_down_id')]]=$row[csf('pre_cost_fabric_cost_dtls_id')];
					}
					unset($data_arr);
                }
                //print_r($cons_breck_downnarr); //30057_0_1_0_12_4_1_1.01_.01_6_5136_830_.55_.5555_271573
                
                //$cons_breck_downnarr=explode('__',$cons_breck_downn);
                //$cons_breck_downnarr=explode('__',$cons_breck_downn_trim);
                if ( count($data_array)>0)
                {
					$i=0;
					foreach( $data_array as $row )
					{
						$data=explode('_',$cons_breck_downnarr[$i]);
						$i++;
						$country_string=implode(",",$country_array[$row[csf('id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['country_id']);
						$country_string_name=implode(",",$country_array[$row[csf('id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['country_name']);
						
						$po_country_arr=explode(",",$country_string);
						
						$countrydata=explode(",",$data[5]);
						$arr_d=array_diff($countrydata, $po_country_arr);
						$arr_d2=array_diff($countrydata, $arr_d);
						$country_name="";
						
						for($countryindex=0; $countryindex < count($arr_d2);$countryindex++){
							$country_name.=	$country_library[$countrydata[$countryindex]].",";
						}
						$country_idstring=implode(",",$arr_d2);
						
						if(count($arr_d)>0 && count($countrydata)>0 ){
							$country_name_pre="";
							for($countryindex=0; $countryindex < count($arr_d);$countryindex++){
								$country_name_pre.=	$country_library[$countrydata[$countryindex]].",";
							}
							$title="Country have Changed in po entry, you have to update this field, Previous Country was ".rtrim($country_name_pre,",")."";
							if(rtrim($country_name_pre,",")!="") $bgc="#D41F00";
							
						}
						else{
							$title=""; $bgc="#FFFFFF";
						}
						/* $data[6]=$data[6];
						if($data[6]=='') $data[6]=0;
						
						$data[7]=$data[7];
						if($data[7]=='') $data[7]=$data[2];
						
						$rate=$data[12];
						if($rate=="") $rate=$txttrimrate; */

						//echo $txtexper.'D';
						if($txtexper!="")
						{
							$exdata=explode("__",$txtexper);
							if(count($exdata)>1)
							{
								$data[2]=$exdata[0];
								$data[6]=$exdata[1];
								$data[7]=$exdata[2];
							}
							else //From Library Template
							{
								$data[2]=$txtconsdzngmts;
								$data[6]=$exdata[0];
								$data[6]='';
							}
						}
						$rate=$data[12]; if($rate=="") $rate=$txttrimrate;
						if($data[2]=="") $data[2]=$txtconsdzngmts;
						if($data[7]=="") $data[7]=$txtconsdzngmts;
						//echo $data[6].'f';
						
						if($data[6]=='' ) 
						{ 
							$data[6]=$txtexper; $data[7]=$txtconsdzngmts+($txtconsdzngmts*$txtexper)/100;
							//$data[13]=$data[7]*$rate;
						}
						$data[13]=$data[7]*$rate;
						
						
						if($data[10] != $row[csf('color_number_id')] && $data[10] !=""){
							$title_color="Color have Changed in po entry, you have to update this field, Previous Color was ".$color_library[$data[10]]."";
							$bgc_color="#D41F00";
						}
						else{
							$title_color=""; $bgc_color="#FFFFFF";
						}
						if($data[11] != $row[csf('size_number_id')] && $data[11] !=""){
							$title_size="Size have Changed in po entry, you have to update this field, Previous Size was ".$size_library[$data[11]]."";
							$bgc_size="#D41F00";
						}
						else{
							$title_size=""; $bgc_size="#FFFFFF";
						}
						$item_size=$data[1];
						if($item_size=="") $item_size=$size_library[$row[csf('size_number_id')]];
						
						$pcs=$pcs_value * $item_ratio_arr[$row[csf('item_number_id')]];
						$RowtotReq=number_format(($row[csf('order_quantity')]/$item_ratio_arr[$row[csf('item_number_id')]])*($data[7]/$pcs_value),4,".","");;
						$totReq+=$RowtotReq;
						$RowtotAmt=number_format($RowtotReq*$rate,4,".","");;
						$totAmt+=$RowtotAmt;
						$cons_fld=0;
						if($cbo_approved_status!=1)
						{
							//echo $is_booking_arr[$row[csf('id')]];
							if($is_booking_arr[$row[csf('id')]]!="" || $is_booking_arr[$row[csf('id')]]!=0) $cons_fld=1;
						}
						?>
						<tr id="break_<?=$i;?>" align="center">
                            <td><?=$i; ?></td>
                            <td>
                                <input type="text" id="pono_<?=$i;?>" name="pono_<?=$i;?>" class="text_boxes" style="width:108px" value="<?=$row[csf('po_number')]; ?>" readonly/>
                                <input type="hidden" id="ponoid_<?=$i;?>" name="ponoid_<?=$i;?>" class="text_boxes" style="width:85px" value="<?=$row[csf('id')]; ?>" readonly/>
                            </td>
                            <td><?=create_drop_down( "cbogmtsitem_".$i, 120, $garments_item,"", 0, "",$row[csf('item_number_id')], "",1); ?></td>
                            <td>
                                <input type="hidden" id="cbocountry_<?=$i;?>" name="cbocountry_<?=$i;?>" onClick="" class="text_boxes_numeric" style="width:68px" value="<? echo $country_string; ?>" readonly />
                                <input type="text" id="cbocountryname_<? echo $i;?>" name="cbocountryname_<?=$i;?>" onClick="open_country_popup(<?=$i; ?>)" class="text_boxes" style="width:68px; background-color:<? echo $bgc; ?>"  value="<? echo $country_string_name; ?>" readonly title="<?=$title; ?>" disabled />
                            </td>
                            <td>
                                <input type="text" id="pocolor_<? echo $i;?>"  name="pocolor_<? echo $i;?>" class="text_boxes" style="width:78px; background-color:<?=$bgc_color; ?>" value="<?=$color_library[$row[csf('color_number_id')]]; ?>" title="<?=$title_color; ?>" readonly />
                                <input type="hidden" id="pocolorid_<?=$i;?>" name="pocolorid_<?=$i;?>" class="text_boxes" style="width:58px" value="<?=$row[csf('color_number_id')]; ?>" readonly/>

                            </td>
                            <td>
                                <input type="text" id="gmtssizes_<?=$i;?>" name="gmtssizes_<?=$i;?>" class="text_boxes" style="width:58px; background-color:<?=$bgc_size; ?>" value="<?=$size_library[$row[csf('size_number_id')]]; ?>" title="<?=$title_size; ?>" readonly>
                                <input type="hidden" id="gmtssizesid_<?=$i;?>" name="gmtssizesid_<?=$i;?>" class="text_boxes" style="width:48px" value="<?=$row[csf('size_number_id')]; ?>" readonly />
                            </td>
                            <td><input type="text" id="itemsizes_<? echo $i;?>"  name="itemsizes_<? echo $i;?>"    class="text_boxes" style="width:48px" onChange="copy_value(this.value,'itemsizes_',<? echo $i;?>)" value="<? echo $item_size; ?>" <? if ($cons_fld==1) { echo "disabled";} else { if($cbo_approved_status==1){echo "disabled";} else { echo "";}} ?> /></td>
                            <td><input type="text" id="cons_<? echo $i;?>"  onChange="set_sum_value( 'cons_sum', 'cons_' ); copy_value(this.value,'cons_',<? echo $i;?>); calculate_tot_cons(<? echo $i;?>)"  name="cons_<? echo $i;?>" onClick="calculator_value_set(<? echo $i;?>)" class="text_boxes_numeric" style="width:48px" value="<? echo $data[2]; ?>" <? if ($cons_fld==1) { echo "";} else if($cbo_approved_status==1){echo "disabled";}  else { echo "";} ?> /></td>
                            <td>
                                <input type="text" id="exper_<? echo $i;?>"  onChange="set_sum_value( 'exper_sum', 'exper_' ); copy_value(this.value,'exper_',<? echo $i;?>); calculate_tot_cons(<? echo $i;?>)"  name="exper_<? echo $i;?>" class="text_boxes_numeric" style="width:38px" value="<? echo $data[6]; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> />
                                <input type="hidden" id="totexper_<?=$i;?>" name="totexper_<?=$i;?>" class="text_boxes_numeric" style="width:28px" value="<?=$data[8]; ?>" />
                            </td>
                            <td>
                                <input type="text" id="totcons_<? echo $i;?>"  onChange="set_sum_value( 'totcons_sum', 'totcons_' ); copy_value(this.value,'totcons_',<? echo $i;?>)"  name="totcons_<? echo $i;?>" onClick="calculator_value_set(<? echo $i;?>)" class="text_boxes_numeric" style="width:48px" value="<? echo $data[7]; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>  readonly />
                            </td>
                            <td>
                                <input type="text" id="rate_<? echo $i;?>"  onChange="set_sum_value( 'rate_sum', 'rate_' ); copy_value(this.value,'rate_',<? echo $i;?>);calculate_amount(<? echo $i;?>)"  name="rate_<? echo $i;?>"  class="text_boxes_numeric" style="width:38px" value="<? echo $rate; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?>   />
                            </td>
                            <td><input type="text" id="amount_<?=$i;?>" onChange="set_sum_value('amount_sum','amount_'); copy_value(this.value,'amount_',<?=$i;?>);" name="amount_<?=$i;?>" class="text_boxes_numeric" style="width:48px" value="<?=$data[13]; ?>" <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> readonly /></td>
                            <td><input type="text" id="totqty_<? echo $i;?>"  name="totqty_<? echo $i;?>"  class="text_boxes_numeric" style="width:58px" value="<? echo $RowtotReq; ?>" readonly  /></td>
                            <td><input type="text" id="totamount_<? echo $i;?>"  name="totamount_<? echo $i;?>" class="text_boxes_numeric" style="width:58px" value="<? echo $RowtotAmt; ?>" readonly /></td>
                            <td><input type="text" id="place_<? echo $i;?>"  name="place_<? echo $i;?>" class="text_boxes" style="width:38px" onChange="copy_value(this.value,'place_',<? echo $i;?>)"  value="<? echo $data[3]; ?>"  <? if($cbo_approved_status==1){echo "disabled";} else { echo "";}?> /></td>
                            <td>
                                <input type="text" id="pcs_<?=$i;?>" name="pcs_<?=$i;?>" onBlur="set_sum_value('pcs_sum','pcs_');" class="text_boxes_numeric" style="width:38px"  value="<?=$pcs;; ?>" readonly />
                                <input type="hidden" id="pcsgmts_<? echo $i;?>"  name="pcsgmts_<? echo $i;?>"  onBlur="set_sum_value( 'pcs_sum', 'pcs_' ) " class="text_boxes_numeric" style="width:35px"  value="<? echo $row[csf('order_quantity')]; ?>">
                                <input type="hidden" id="itempcsgmts_<? echo $i;?>"  name="itempcsgmts_<? echo $i;?>"  onBlur="set_sum_value( 'pcs_sum', 'pcs_' ) " class="text_boxes_numeric" style="width:35px"  value="<? echo $itemqty_array[$row[csf('item_number_id')]]; ?>">
                                <input type="hidden" id="itemratiogmts_<?=$i;?>" name="itemratiogmts_<?=$i;?>" onBlur="set_sum_value('pcs_sum','pcs_');" class="text_boxes_numeric" style="width:35px" value="<?=$item_ratio_arr[$row[csf('item_number_id')]]; ?>">
                                <? $jobqty+=$row[csf('order_quantity')]; ?>
                                <input type="hidden" id="colorsizetableid_<?=$i;?>" name="colorsizetableid_<?=$i;?>" class="text_boxes" style="width:35px" value="<?=$row[csf('color_size_table_id')]; ?>" readonly/>
                            </td>
                            <td id="add_<?=$i;?>">
                            <input type="button" id="decreaserow_<?=$i;?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_delete_down_tr(<?=$i; ?>,'tbl_consmption_cost');" />
                            </td>
						</tr>
						<?
					}
                }
                ?>
                </tbody>
                <tfoot>
                    <tr>
                        <th width="30">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="80">&nbsp;</th>
                        <th width="90">&nbsp;</th>
                        <th width="70">&nbsp;</th>
                        <th width="60">Sum:</th>
                        <th width="60"><input type="text" id="cons_sum" name="cons_sum" class="text_boxes_numeric" style="width:47px" readonly></th>
                        <th width="50"><input type="text" id="exper_sum" name="exper_sum" class="text_boxes_numeric" style="width:37px" readonly></th>
                        <th width="60"><input type="text" id="totcons_sum" name="totcons_sum" class="text_boxes_numeric" style="width:47px" readonly></th>
                        <th width="50"><input type="text" id="rate_sum" name="rate_sum" class="text_boxes_numeric" style="width:37px" readonly></th>
                        <th width="60"><input type="text" id="amount_sum" name="amount_sum" class="text_boxes_numeric" style="width:47px" readonly></th>
                        <th width="70"><input type="text" id="totReq_sum" name="totReq_sum" class="text_boxes_numeric" style="width:57px" value=" <? echo $totReq;?> " readonly></th>
                        <th width="70"><input type="text" id="totAmount_sum" name="totAmount_sum" class="text_boxes_numeric" style="width:57px" value="<? echo $totAmt; ?>" readonly></th>
                        <th width="50">&nbsp;</th>
                        <th width="50"><input type="text" id="pcs_sum"    name="pcs_sum" class="text_boxes_numeric" style="width:37px" readonly>
                        <input type="hidden" id="job_qty"    name="job_qty" class="text_boxes_numeric" style="width:35px" value="<? echo $jobqty ?>" readonly></th>
                        <th>&nbsp;</th>
                    </tr>
                    <tr>
                        <th width="30">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="80">&nbsp;</th>
                        <th width="90">&nbsp;</th>
                        <th width="70">&nbsp;</th>
                        <th width="60">Avg:</th>
                        <th width="60"><input type="text" id="avg_cons" name="avg_cons" class="text_boxes_numeric" style="width:47px" value="" readonly></th>
                        <th width="50"><input type="text" id="avg_exper" name="avg_exper" class="text_boxes_numeric" style="width:37px" value="" readonly></th>
                        <th width="60"><input type="text" id="avg_totcons" name="avg_totcons" class="text_boxes_numeric" style="width:47px" value="" readonly></th>
                        <th width="50"><input type="text" id="avg_ratecons" name="avg_ratecons" class="text_boxes_numeric" style="width:37px" value="" readonly></th>
                        <th width="60"><input type="text" id="avg_amountcons" name="avg_amountcons" class="text_boxes_numeric" style="width:47px" value="" readonly></th>
                        <th width="70"><input type="text" id="AtotReq_sum" name="AtotReq_sum" class="text_boxes_numeric" style="width:57px" value="<?=$totReq; ?>" readonly></th>
                        <th width="70"><input type="text" id="AtotAmount_sum" name="AtotAmount_sum" class="text_boxes_numeric" style="width:57px" value="<?=$totAmt; ?>" readonly></th>
                        <th width="50">&nbsp;</th>
                        <th width="50"><input type="text" id="calculated_pcs" name="calculated_pcs" class="text_boxes_numeric" style="width:37px" readonly></th>
                        <th>&nbsp;</th>
                    </tr>
                </tfoot>
            </table>
            <script>
				set_sum_value('cons_sum', 'cons_');
				set_sum_value('exper_sum', 'exper_');
				set_sum_value('totcons_sum', 'totcons_');
				set_sum_value('rate_sum', 'rate_');
				set_sum_value('amount_sum', 'amount_');
				set_sum_value('pcs_sum', 'pcs_');
            </script>
            <div align="center" style="width:100%;" >
                <fieldset>
                    <table width="1170" cellspacing="0" class="" border="0" rules="all">
                        <tr>
                        	<td align="center" width="100%" class="button_container"><input type="button" class="formbutton" value="Close" onClick="js_set_value();"/></td>
                        </tr>
                    </table>
                </fieldset>
            </div>
            </td>
            <tr>
        </table>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
    exit();
}

if($action=="calculator_parameter")
{
	extract($_REQUEST);
	$cal_parameter_type=return_field_value("cal_parameter", "lib_item_group", "id='$data'");
	echo trim($cal_parameter_type); die;
}

if($action=="calculator_type")
{
   extract($_REQUEST);
   echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode);
	?>
	<script>
		function clculate_cons_for_mtr()
		{
			var txt_cons_per_gmts=(document.getElementById('txt_cons_per_gmts').value)*1;
			var txt_costing_per=document.getElementById('txt_costing_per').value;
			if(txt_costing_per==1) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*12;
			if(txt_costing_per==2) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*1;
			if(txt_costing_per==3) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*2*12;
			if(txt_costing_per==4) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*3*12;
			if(txt_costing_per==5) document.getElementById('txt_cons_for_mtr').value=txt_cons_per_gmts*4*12;
			
			var txt_cons_for_mtr= (document.getElementById('txt_cons_for_mtr').value)*1
			var txt_cons_length= (document.getElementById('txt_cons_length').value)*1
			document.getElementById('txt_cons_for_cone').value=txt_cons_for_mtr/txt_cons_length;
		}
	
		function js_set_value_calculator(type)
		{
			if(type=='sewing_thread')
			{
				var clacolator_param_value=document.getElementById('txt_cons_per_gmts').value+'*'+document.getElementById('txt_cons_for_mtr').value+'*'+document.getElementById('txt_cons_length').value+'*'+document.getElementById('txt_cons_for_cone').value+'*'+document.getElementById('txt_costing_per').value;
		
				document.getElementById('txt_clacolator_param_value').value=clacolator_param_value;
			}
			parent.emailwindow.hide();
		}
	</script>
	</head>
	<body>
	<?
	if($calculator_parameter==1)
	{
		?>
        <fieldset>
            <legend>Sewing Thread</legend>
            <table cellpadding="0" cellspacing="2" align="center" width="300">
                <tr>
                    <td width="120">Cons Per Garment</td>
                    <td><input type="text" id="txt_cons_per_gmts" name="txt_cons_per_gmts" class="text_boxes_numeric" onChange="clculate_cons_for_mtr();"/> Mtr</td>
                </tr>
                <tr>
                    <td>Cons <?=$costing_per[$cbo_costing_per]; ?></td>
                    <td><input type="text" id="txt_cons_for_mtr" name="txt_cons_for_mtr" class="text_boxes_numeric" readonly/> Mtr</td>
                </tr>
                <tr>
                    <td>Cone Length</td>
                    <td><input type="text" id="txt_cons_length" name="txt_cons_length" class="text_boxes_numeric" onChange="clculate_cons_for_mtr();" value="4000"/> Mtr</td>
                </tr>
                <tr>
                    <td>Cons <?=$costing_per[$cbo_costing_per]; ?></td>
                    <td><input type="text" id="txt_cons_for_cone" name="txt_cons_for_cone" class="text_boxes_numeric" readonly /> Cone</td>
                </tr>
                <tr>
                    <td colspan="3" align="center">
                        <input type="button" class="formbutton" value="Close" onClick="js_set_value_calculator('sewing_thread')"/>
                        <input type="hidden" id="txt_costing_per" name="txt_costing_per" class="text_boxes_numeric" value="<?=$cbo_costing_per; ?>" readonly />
                        <input type="hidden" id="txt_clacolator_param_value" name="txt_clacolator_param_value" class="text_boxes_numeric" value="" readonly />
                    </td>
                </tr>
            </table>
        </fieldset>
        <?
	}
	?>
    </body>
    	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
    exit();
}

if($action=="trim_rate_popup_page")
{
	echo load_html_head_contents("Country","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
		function js_set_value(data)
		{
			var data=data.split('_');
			document.getElementById('txt_selected_supllier').value=data[0];
			document.getElementById('txt_selected_rate').value=data[1];
			parent.emailwindow.hide();
		}
	</script>
	</head>
	<body>
        <div align="center">
            <form>
                <input type="hidden" id="txt_selected_supllier" name="txt_selected_supllier" value=" " />
                <input type="hidden" id="txt_selected_rate" name="txt_selected_rate" value="" />
                <?
                $supplier_library=return_library_array( "select a.supplier_name,a.id from  lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(4,5) and a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
                $sql_data=sql_select("select a.id, b.supplier_id, b.rate  from lib_item_group a, lib_item_group_rate b where a.id=b.mst_id and a.item_category=4 and a.id='$cbogroup' and b.rate>0 and a.status_active=1 and	a.is_deleted=0 group by a.id, b.supplier_id, b.rate order by b.rate");
                ?>
                <table class="rpt_table" width="500" cellpadding="0" cellspacing="0" border="1" rules="all">
                    <thead>
                        <th width="50">SL</th>
                        <th width="100">Supplier</th>
                        <th width="100">Rate</th>
                    </thead>
                </table>
                <table width="500" cellspacing="0" class="rpt_table" border="0" id="tbl_list_search" rules="all">
                <?
                $i=1;
                foreach($sql_data as $row)
                {
                    if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                    ?>
                    <tr bgcolor="<?=$bgcolor; ?>" style="text-decoration:none; cursor:pointer" onClick="js_set_value('<?=$row[csf('supplier_id')]."_".$row[csf('rate')]; ?>');">
                        <td width="50"><?=$i; ?></td>
                        <td width="100"><?=$supplier_library[$row[csf('supplier_id')]]; ?></td>
                        <td width="100"><?=$row[csf('rate')]; ?></td>
                    </tr>
                    <?
                    $i++;
                }
                ?>
            </table>
            </form>
        </div>
	</body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}

if($action=="open_country_popup")
{
	echo load_html_head_contents("Country","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
		var selected_id = new Array, selected_name = new Array();
		function check_all_data() {
			$("#tbl_list_search tr").each(function() {
				var valTP=$(this).attr("id");
				$("#"+valTP).click();
			});
		}
		
		function toggle( x, origColor ) {
			var newColor = 'yellow';
			if ( x.style ) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}
		
		function js_set_value( str ) {
			toggle( document.getElementById( 'search' + str ), '#FFFFCC' );
			if( jQuery.inArray( $('#txt_individual_id' + str).val(), selected_id ) == -1 ) {
				selected_id.push( $('#txt_individual_id' + str).val() );
				selected_name.push( $('#txt_individual_name' + str).val() );
			}
			else {
				for( var i = 0; i < selected_id.length; i++ ) {
					if( selected_id[i] == $('#txt_individual_id' + str).val() ) break;
				}
				selected_id.splice( i, 1 );
				selected_name.splice( i, 1 );
			}
			var id = ''; var name='';
			for( var i = 0; i < selected_id.length; i++ ) {
				id += trim(selected_id[i]) + ',';
				name += trim(selected_name[i]) + ',';
			}
			id = id.substr( 0, id.length - 1 );
			name = name.substr( 0, name.length - 1 );
			
			//alert(id)
			$('#txt_selected_id').val( trim(id) );
			$('#txt_selected_name').val( trim(name) );
		}
	</script>
	</head>
	<body>
        <div align="center">
            <form>
            <? $sql_data=sql_select("select country_id  from wo_po_color_size_breakdown   WHERE job_no_mst='$txt_job_no' and  status_active=1 and is_deleted=0 group by country_id"); ?>
            <table width="500" cellspacing="0" class="rpt_table" border="0" id="tbl_list_search" rules="all">
				<?
                $couArr=array();
                $i=1;
                foreach($sql_data as $row)
                {
					$couArr['id'][trim($row[csf('country_id')])]=trim($row[csf('country_id')]);
					$couArr['name'][trim($row[csf('country_id')])]= $country_library[trim($row[csf('country_id')])];
					if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					?>
					<tr bgcolor="<? echo $bgcolor;  ?>" style="text-decoration:none; cursor:pointer" id="search<? echo trim($row[csf('country_id')]);?>" onClick="js_set_value(<? echo trim($row[csf('country_id')]);?>)">
                        <td width="50"><? echo $i ?></td>
                        <td width="100">
                            <input type="hidden" name="txt_individual_id" id="txt_individual_id<?=trim($row[csf('country_id')]); ?>" value="<?=trim($row[csf('country_id')]); ?>"/>
                            <input type="hidden" name="txt_individual_name" id="txt_individual_name<?=trim($row[csf('country_id')]); ?>" value="<?=$country_library[trim($row[csf('country_id')])]; ?>"/>
                            <?=$country_library[$row[csf('country_id')]]; ?>
                        </td>
                        <td width="100"><?=$country_library_short[$row[csf('country_id')]]; ?></td>
					</tr>
					<?
					$i++;
                }
                $nIdcouSArr=array();
                $nNamecouSArr=array();
                $couSArr=explode(",",trim($txt_country));
                foreach($couSArr as $key=>$value){
					if (in_array(trim($value), $couArr['id'])) {
						$nIdcouSArr[]=trim($value);
						$nNamecouSArr[]=$country_library[trim($value)];
					}
                }
                ?>
            </table>
            <table width="500" cellspacing="0" cellpadding="0" style="border:none" align="center">
                <tr>
                    <td align="center" height="30" valign="bottom">
                    <div style="width:100%">
                        <div style="width:50%; float:left" align="left">
                            <input type="hidden" id="txt_selected_id" name="txt_selected_id" value="<? if(count($nIdcouSArr)>0){echo implode(",",$nIdcouSArr);}?>" />
                            <input type="hidden" id="txt_selected_name" name="txt_selected_name" value="<? if(count($nIdcouSArr)>0){echo implode(",",$nNamecouSArr);}?> " />
                            <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data();" /> Check / Uncheck All
                        </div>
                        <div style="width:50%; float:left" align="left">
                            <input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                        </div>
                    </div>
                    </td>
                </tr>
            </table>
            </form>
        </div>
	</body>
	<script>
	
	var txt_country='<? if(count($nIdcouSArr)>0){echo implode(",",$nIdcouSArr);}?> '
	var txt_country_name='<?  if(count($nIdcouSArr)>0){echo implode(",",$nNamecouSArr);}?>'
	
	if(trim(txt_country) !=""){
		selected_id=trim(txt_country).split(",");
		selected_name=txt_country_name.split(",");
	}
	for(var i=0; i<selected_id.length;i++){
		if(trim(selected_id[i]) !=""){
			toggle( document.getElementById( 'search' + trim(selected_id[i]) ), '#FFFFCC' );
		}
	}
	</script>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}

function create_consbreak_down($job_no,$cons_value,$rate,$amount,$country)
{
	$cbo_costing_per=return_field_value("costing_per", "wo_pre_cost_mst", "job_no=$job_no");
	$size_library_arr=return_library_array( "select id,size_name from lib_size where status_active=1 and is_deleted=0", "id", "size_name"  );
	$item_ratio_arr=array();

	$gmts_item_sql=sql_select("select gmts_item_id, set_item_ratio from  wo_po_details_mas_set_details  where job_no=$job_no");
	foreach($gmts_item_sql as $gmts_item_row)
	{
		$item_ratio_arr[$gmts_item_row[csf('gmts_item_id')]]=$gmts_item_row[csf('set_item_ratio')];
	}

	$country=rtrim($country,",");
	if($country=="") $country_cond=""; else $country_cond=" and c.country_id in($country)";
	$country_array=array();
	$data_country=sql_select("select b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id ,c.country_id from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c  where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id  and b.job_no_mst=$job_no $country_cond   and a.status_active=1 and b.status_active=1 and c.status_active=1");
	foreach($data_country as $data_country_row){
		$country_array[$data_country_row[csf('id')]][$data_country_row[csf('item_number_id')]][$data_country_row[csf('color_number_id')]][$data_country_row[csf('size_number_id')]]['country_id'][$data_country_row[csf('country_id')]]=$data_country_row[csf('country_id')];
		$country_array[$data_country_row[csf('id')]][$data_country_row[csf('item_number_id')]][$data_country_row[csf('color_number_id')]][$data_country_row[csf('size_number_id')]]['country_name'][$data_country_row[csf('country_id')]]=$country_library[$data_country_row[csf('country_id')]];
	}

	$data_array=sql_select("select a.gmts_item_id,a.total_set_qnty,b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id ,min(c.id)as color_size_table_id, min(color_order) as color_order, min(size_order) as size_order, sum(plan_cut_qnty) as plan_cut_qnty,sum(order_quantity) as order_quantity from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c  where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id  and b.job_no_mst=$job_no $country_cond   and a.status_active=1 and b.status_active=1 and c.status_active=1 group by a.gmts_item_id,a.total_set_qnty,b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id order by b.id,c.item_number_id,color_order,size_order");

	if ( count($data_array)>0)
	{
		$cons_breck_down="";
		if($cbo_costing_per==1) $pcs_value=1*12;
		if($cbo_costing_per==2) $pcs_value=1*1;
		if($cbo_costing_per==3) $pcs_value=2*12;
		if($cbo_costing_per==4) $pcs_value=3*12;
		if($cbo_costing_per==5) $pcs_value=4*12;
		$oth=0;
		foreach( $data_array as $row )
		{
			/*$cons_value=def_number_format($cons_value/$row[csf('total_set_qnty')],5,"");
			$amount=def_number_format($amount/$row[csf('total_set_qnty')],5,"");
			$rate=def_number_format($amount/$cons_value,5,"");*/
			//$item_array=explode(",",rtrim($row[csf('gmts_item_id')],","));
			$totitem=count($item_ratio_arr);
			$cons=def_number_format($cons_value/$totitem,5,"");
			$amount=def_number_format($cons*$rate,5,"");
			//$rate=def_number_format($amount/$cons_value,5,"");
			$pcs=$pcs_value*$item_ratio_arr[$row[csf('item_number_id')]];
			$country_string=implode(",",$country_array[$row[csf('id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['country_id']);
			if($country_string==""){
			$country_string=0;
			}
			////ponoid+'_'+itemsizes+'_'+cons+'_'+place+'_'+pcs+'_'+cbocountry+'_'+exper+'_'+totcons+'_'+totexper+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+rate+'_'+amount+'_'+colorsizetableid
			if($cons_breck_down=="")
			{
				$cons_breck_down.=$row[csf('id')].'_'.$size_library_arr[$row[csf('size_number_id')]].'_'.$cons.'_'.$oth.'_'.$pcs.'_'.$country_string.'_'.$oth.'_'.$cons.'_'.$oth.'_'.$row[csf('item_number_id')].'_'.$row[csf('color_number_id')].'_'.$row[csf('size_number_id')].'_'.$rate.'_'.$amount.'_'.$row[csf('color_size_table_id')];
			}
			else
			{
				$cons_breck_down.="__".$row[csf('id')].'_'.$size_library_arr[$row[csf('size_number_id')]].'_'.$cons.'_'.$oth.'_'.$pcs.'_'.$country_string.'_'.$oth.'_'.$cons.'_'.$oth.'_'.$row[csf('item_number_id')].'_'.$row[csf('color_number_id')].'_'.$row[csf('size_number_id')].'_'.$rate.'_'.$amount.'_'.$row[csf('color_size_table_id')];
			}
			//echo $cons_breck_down; die;
		}
		return $cons_breck_down;
	}
}

if ($action=="save_update_delet_trim_cost_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$sql=sql_select("select approval_need from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
	$app_nessity=2;
	foreach($sql as $row){
		$app_nessity=$row[csf('approval_need')];
	}

	$sql=sql_select("select approved from wo_price_quotation  where id=$txt_quotation_id");
	$quatation_approved=2;
	foreach($sql as $row){
		$quatation_approved=$row[csf('approved')];
	}

	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	//echo "10**",$is_copy_quatation."**". $app_nessity."**".$quatation_approved;
	//die;
	if($is_copy_quatation==1 && $app_nessity==1){
		if($quatation_approved==2 || $quatation_approved==0 || $quatation_approved==3){
			echo "quataNotApp**".str_replace("'","",$txt_job_no);
			disconnect($con);die;
		}
	}
	
	$materialReciveNo="";
	$sql=sql_select("select a.recv_number from inv_receive_master a, inv_transaction b, wo_po_break_down c where a.id=b.mst_id and b.job_no=c.job_no_mst and b.job_no=$update_id and a.entry_form=248 and c.is_confirmed=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by a.recv_number");
	foreach($sql as $row)
	{
		if($materialReciveNo=="") $materialReciveNo=$row[csf('recv_number')]; else $materialReciveNo.=','.$row[csf('recv_number')];
	}
	if($materialReciveNo!=""){
		echo "materialRecive**".$materialReciveNo;
		disconnect($con);die;
	}
	
	$str_rep=array("/", "&", "*", "(", ")", "=","'",",","\r", "\n",'"','#');
	if($operation==0)
	{
	     $con = connect();
		 if($db_type==0)
		 {
			mysql_query("BEGIN");
		 }
		 $approved=0;
		$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$update_id");
		foreach($sql as $row){
			if($row[csf('approved')]==3){
				$approved=1;
			}else{
				$approved=$row[csf('approved')];
			}
		}
		if($approved==1){
			echo "approved**".str_replace("'","",$update_id);
			disconnect($con);die;
		}
		 if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0";disconnect($con); die;}
		 $add_comma=0;
		 $fail1=0;
		 $id=return_next_id( "id", "wo_pre_cost_trim_cost_dtls", 1 ) ;
		 $id1=return_next_id( "id", "wo_pre_cost_trim_co_cons_dtls", 1 ) ;
		 $field_array="id, job_id, job_no, remark, trim_group, description, brand_sup_ref, cons_uom, cons_dzn_gmts, ex_per, tot_cons, rate, amount, apvl_req, nominated_supp, cons_breack_down, country, calculatorstring, seq, item_print, inserted_by, insert_date, status_active, is_deleted";
		 //item_number_id,color_number_id,item_color_number_id,size_number_id,rate,amount,gmts_pcs,color_size_table_id
		 $field_array1="id, job_id, wo_pre_cost_trim_cost_dtls_id, job_no, po_break_down_id, item_size, cons, place, pcs, country_id, excess_per, tot_cons, ex_cons, item_number_id, color_number_id, size_number_id, rate, amount, color_size_table_id";
		 //ponoid+'_'+itemsizes+'_'+cons+'_'+place+'_'+pcs+'_'+cbocountry+'_'+exper+'_'+totcons+'_'+totexper+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+rate+'_'+amount+'_'+colorsizetableid
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cbogroup="cbogroup_".$i;
			 $txtremark="txtremark_".$i;
			 $txtdescription="txtdescription_".$i;
			 $txtsupref="txtsupref_".$i;
			 $cboconsuom="cboconsuom_".$i;
			 $txtconsdzngmts="txtconsdzngmts_".$i;
			 $excessper="excessper_".$i;
			 $totalcons="totalcons_".$i;
			 $txttrimrate="txttrimrate_".$i;
			 $txttrimamount="txttrimamount_".$i;
			 $cboapbrequired="cboapbrequired_".$i;
			 $cbonominasupplier="cbonominasupplier_".$i;
			 $cbotrimstatus="cbotrimstatus_".$i;
			 $updateidtrim="updateidtrim_".$i;
			
			 $consbreckdown="consbreckdown_".$i;
			 $country="country_".$i;
			 $calculatorstring="calculatorstring_".$i;
			 $cboitemprint="cboitemprint_".$i;
			 $seq="seq_".$i;
			 $updateTempleteTrimTd="updateTempleteTrimTd_".$i;
			 $updateTempleteTrimTd=str_replace("'",'',$$updateTempleteTrimTd);

			$img_data=sql_select("select master_tble_id,form_name,image_location,file_type,real_file_name from common_photo_library where master_tble_id='$updateTempleteTrimTd' and form_name='knit_order_entry'");
			if(count($img_data)>0){

				$imgfield_array="id,master_tble_id,form_name,image_location,real_file_name,insert_date";
				$imgid=return_next_id( "id", "common_photo_library", 1 ) ;
				$imgdata_array="('".$imgid."','".$id."','pre_cost_trimsv2','".$img_data[0][csf('image_location')]."','".$img_data[0][csf('real_file_name')]."','".$pc_date_time."')";
				$imgrID=sql_insert("common_photo_library",$imgfield_array,$imgdata_array,1); 
			}

			 $txtdescription=str_replace("'",'',$$txtdescription);
			 $txttrimdescription='';
			 $txttrimdescription=str_replace($str_rep,' ',$txtdescription);

			 $txtsupref=str_replace("'",'',$$txtsupref);
			 $txttrimsupref='';
			 $txttrimsupref=str_replace($str_rep,' ',$txtsupref);

			 $txtremark=str_replace("'",'',$$txtremark);
			 $txttrimremark='';
			 $txttrimremark=str_replace($str_rep,' ',$txtremark);
			 if(str_replace("'",'',$$consbreckdown) !='')
			 {
				$consbreckdown= $$consbreckdown;
			 }
			 else
			 {
				 $consbreckdown="'".create_consbreak_down($update_id,str_replace("'",'',$$txtconsdzngmts),str_replace("'",'',$$txttrimrate),str_replace("'",'',$$txttrimamount),str_replace("'",'',$$country))."'";
			 }

			 //echo $consbreckdown; die;
			 $cons_breckdown=substr(str_replace("'","",$consbreckdown),0,100);

			 if ($i!=1) $data_array .=",";
			$data_array .="(".$id.",".$hidd_job_id.",".$update_id.",'".$txttrimremark."',".$$cbogroup.",'".$txttrimdescription."','".$txttrimsupref."',".$$cboconsuom.",".$$txtconsdzngmts.",".$$excessper.",".$$totalcons.",".$$txttrimrate.",".$$txttrimamount.",".$$cboapbrequired.",".$$cbonominasupplier.",'".$cons_breckdown."',".$$country.",".$$calculatorstring.",".$$seq.",".$$cboitemprint.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbotrimstatus.",0)";
			//	CONS break down===============================================================================================

			if(str_replace("'",'',$consbreckdown) !='')
			{
				$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
				$counter=0;
				for($c=0;$c < count($consbreckdown_array);$c++)
				{
					$counter++;
					$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
					$consbreckdownarr[7]=$consbreckdownarr[7];
					if($consbreckdownarr[7]=='' || $consbreckdownarr[7]==0)
					{
						$consbreckdownarr[7]=$consbreckdownarr[2];
					}

					if ($add_comma!=0) $data_array1 .=",";
					$data_array1 .="(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[7]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[2]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".$consbreckdownarr[10]."','".$consbreckdownarr[11]."','".$consbreckdownarr[12]."','".$consbreckdownarr[13]."','".$consbreckdownarr[14]."')";

					$id1=$id1+1;
					$add_comma++;
					if ($data_array1!="" && $counter==100)
					{
						$rID_in1=sql_insert("wo_pre_cost_trim_co_cons_dtls",$field_array1,$data_array1,1);
						$counter=0;
						$data_array1="";
						$add_comma=0;
						if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
					}


				}
				if ($data_array1!="" && $counter!=100)
				{
					$rID_in1=sql_insert("wo_pre_cost_trim_co_cons_dtls",$field_array1,$data_array1,1);
					$counter=0;
					$data_array1="";
					$add_comma=0;
					if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
				}
			}
           //CONS break down end===============================================================================================
		   $id=$id+1;
		 }
		 //echo "10**";die;
		 $rID=sql_insert("wo_pre_cost_trim_cost_dtls",$field_array,$data_array,0);
		 //$rID_in1=sql_insert("wo_pre_cost_trim_co_cons_dtls",$field_array1,$data_array1,1);

		 //=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, trim_cons, trim_rate, trim_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtconsdzntrim_sum.",".$txtratetrim_sum.",".$txttrimamount_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}

		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="trim_cons*trim_rate*trim_amount";
			$data_array2 ="".$txtconsdzntrim_sum."*".$txtratetrim_sum."*".$txttrimamount_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		$tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);

		check_table_status( $_SESSION['menu_id'],0);
		//=======================sum End =================
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "0**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "0**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		disconnect($con);
		die;
	}
	else if($operation==1)
	{
	    $con = connect();
		if($db_type==0) mysql_query("BEGIN");

		$component_approved=return_field_value("current_approval_status", "co_com_pre_costing_approval", "job_no=$update_id and cost_component_id=2");
		if($component_approved==3){
			$component_approved=1;
		}

		$approved=0;
		$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$update_id");
		foreach($sql as $row){
			if($row[csf('approved')]==3){
				$approved=1;
			}else{
				$approved=$row[csf('approved')];
			}
		}

		if($approved==1 || $component_approved==1){
			echo "approved**".str_replace("'","",$update_id);
			disconnect($con);die;
		}
		
		$is_sequence_validation=return_field_value("season_mandatory", "variable_order_tracking", "company_name=$cbo_company_name and variable_list=63");

		$booking_cons_arr=array();
		if($is_sequence_validation==1)
		{
			$booking_sql="select pre_cost_fabric_cost_dtls_id, booking_no, pre_req_amt from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_type=2 and job_no=".$update_id."";
			$booking_sql_res=sql_select($booking_sql);
			foreach($booking_sql_res as $row)
			{
				$booking_cons_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]]=$row[csf('pre_req_amt')];
			}
			unset($booking_sql_res);
		}

		$msg="Booking Amount is over then Budget.";
		for ($i=1; $i<=$total_row; $i++)
		{
			$updateidtrim="updateidtrim_".$i;
			$txttrimamount="txttrimamount_".$i;

			$pre_cost_trim_cost_dtls_id=str_replace("'","",$$updateidtrim);
			$pretrimamount=str_replace("'","",$$txttrimamount);
			if($pre_cost_trim_cost_dtls_id!="")
			{
				$booking_amt=$booking_cons_arr[$pre_cost_trim_cost_dtls_id];
				/*if($pretrimamount<$booking_amt)
				{
					echo "6**".$msg;
					return;
				}*/
			}
		}
		unset($booking_cons_arr);

		if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**1"; disconnect($con);die;}

		$field_array_up="job_no*remark*trim_group*description*brand_sup_ref*cons_uom*cons_dzn_gmts*ex_per*tot_cons*rate*amount*apvl_req*nominated_supp*cons_breack_down*country*calculatorstring*seq*item_print*updated_by*update_date*status_active*is_deleted";

		 $field_array="id, job_id, job_no, remark, trim_group, description, brand_sup_ref, cons_uom, cons_dzn_gmts, ex_per, tot_cons, rate, amount, apvl_req, nominated_supp, cons_breack_down, country, calculatorstring, seq, item_print, inserted_by, insert_date, status_active, is_deleted";
		 $field_array1="id, job_id, wo_pre_cost_trim_cost_dtls_id, job_no, po_break_down_id, item_size, cons, place, pcs, country_id, excess_per, tot_cons, ex_cons, item_number_id, color_number_id, size_number_id, rate, amount, color_size_table_id";

		 $add_co=0;
		 $add_comma=0;
		 $fail1=0;
		 $id=return_next_id( "id","wo_pre_cost_trim_cost_dtls", 1 ) ;
		 $id1=return_next_id( "id", "wo_pre_cost_trim_co_cons_dtls", 1 ) ;

		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cbogroup="cbogroup_".$i;
			 $txtremark="txtremark_".$i;
			 $txtdescription="txtdescription_".$i;
			 $txtsupref="txtsupref_".$i;
			 $cboconsuom="cboconsuom_".$i;
			 $txtconsdzngmts="txtconsdzngmts_".$i;
			 $excessper="excessper_".$i;
			 $totalcons="totalcons_".$i;
			 $txttrimrate="txttrimrate_".$i;
			 $txttrimamount="txttrimamount_".$i;
			 $cboapbrequired="cboapbrequired_".$i;
			 $cbonominasupplier="cbonominasupplier_".$i;
			 $cbotrimstatus="cbotrimstatus_".$i;
			 $updateidtrim="updateidtrim_".$i;
			 $consbreckdown="consbreckdown_".$i;
			 $country="country_".$i;
			 $calculatorstring="calculatorstring_".$i;
			 $cboitemprint="cboitemprint_".$i;
			 $seq="seq_".$i;
			 
			 $updateTempleteTrimTd="updateTempleteTrimTd_".$i;
			 $updateTempleteTrimTd=str_replace("'",'',$$updateTempleteTrimTd);

			 	$img_data=sql_select("select master_tble_id,form_name,image_location,file_type,real_file_name from common_photo_library where master_tble_id='$updateTempleteTrimTd' and form_name='knit_order_entry'");
				if(count($img_data)>0){

					$imgfield_array="id,master_tble_id,form_name,image_location,real_file_name,insert_date";
					$imgid=return_next_id( "id", "common_photo_library", 1 ) ;
					$imgdata_array="('".$imgid."','".$id."','pre_cost_trimsv2','".$img_data[0][csf('image_location')]."','".$img_data[0][csf('real_file_name')]."','".$pc_date_time."')";
					$imgrID=sql_insert("common_photo_library",$imgfield_array,$imgdata_array,1); 
				}


			 $txtdescription=str_replace("'",'',$$txtdescription);
			 $txttrimdescription='';
			 $txttrimdescription=str_replace($str_rep,' ',$txtdescription);


			 $txtsupref=str_replace("'",'',$$txtsupref);
			 $txttrimsupref='';
			 $txttrimsupref=str_replace($str_rep,' ',$txtsupref);

			 $txtremark=str_replace("'",'',$$txtremark);
			 $txttrimremark='';
			 $txttrimremark=str_replace($str_rep,' ',$txtremark);

			if(str_replace("'",'',$$updateidtrim)!="")
			{
				if(str_replace("'",'',$$consbreckdown) !='') $consbreckdown= $$consbreckdown; else $consbreckdown="";
				$cons_breckdown=substr(str_replace("'","",$$consbreckdown),0,100);
				$id_arr[]=str_replace("'",'',$$updateidtrim);
				$data_array_up[str_replace("'",'',$$updateidtrim)] =explode("*",("".$update_id."*'".$txttrimremark."'*".$$cbogroup."*'".$txttrimdescription."'*'".$txttrimsupref."'*".$$cboconsuom."*".$$txtconsdzngmts."*".$$excessper."*".$$totalcons."*".$$txttrimrate."*".$$txttrimamount."*".$$cboapbrequired."*".$$cbonominasupplier."*'".$cons_breckdown."'*".$$country."*".$$calculatorstring."*".$$seq."*".$$cboitemprint."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*".$$cbotrimstatus."*0"));
				//	CONS break down===============================================================================================
				if(str_replace("'",'',$consbreckdown) !='')
				{
					$rID_de1=execute_query( "delete from wo_pre_cost_trim_co_cons_dtls where  wo_pre_cost_trim_cost_dtls_id =".$$updateidtrim."",0);
					$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
					$counter=0;
					for($c=0;$c < count($consbreckdown_array);$c++)
					{
						$counter++;
						//		 $field_array1="id, wo_pre_cost_trim_cost_dtls_id, job_no, po_break_down_id,item_size, cons, pcs";
						$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
						$consbreckdownarr[7]=$consbreckdownarr[7];
						if($consbreckdownarr[7]=='' || $consbreckdownarr[7]==0)
						{
							$consbreckdownarr[7]=$consbreckdownarr[2];
						}
						if ($add_comma!=0) $data_array1 .=",";
						$data_array1 .="(".$id1.",".$hidd_job_id.",".$$updateidtrim.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[7]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[2]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".$consbreckdownarr[10]."','".$consbreckdownarr[11]."','".$consbreckdownarr[12]."','".$consbreckdownarr[13]."','".$consbreckdownarr[14]."')";

						$id1=$id1+1;
						$add_comma++;
						if ($data_array1!="" && $counter==100)
						{
							$rID_in1=sql_insert("wo_pre_cost_trim_co_cons_dtls",$field_array1,$data_array1,1);
							$counter=0;
							$data_array1="";
							$add_comma=0;
							if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
						}
					}
					if ($data_array1!="" && $counter!=100)
					{
						$rID_in1=sql_insert("wo_pre_cost_trim_co_cons_dtls",$field_array1,$data_array1,1);
						$counter=0;
						$data_array1="";
						$add_comma=0;
						if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
					}
				}
          //CONS break down end===============================================================================================

			}
			if(str_replace("'",'',$$updateidtrim)=="")
			{
				 if(str_replace("'",'',$$consbreckdown) !='')
				 {
					$consbreckdown= $$consbreckdown;
				 }
				 else
				 {
					 $consbreckdown="'".create_consbreak_down($update_id,str_replace("'",'',$$txtconsdzngmts),str_replace("'",'',$$txttrimrate),str_replace("'",'',$$txttrimamount),str_replace("'",'',$$country))."'";
				 }
				if ($add_co!=0) $data_array .=",";
				$data_array .="(".$id.",".$hidd_job_id.",".$update_id.",'".$txttrimremark."',".$$cbogroup.",'".$txttrimdescription."','".$txttrimsupref."',".$$cboconsuom.",".$$txtconsdzngmts.",".$$excessper.",".$$totalcons.",".$$txttrimrate.",".$$txttrimamount.",".$$cboapbrequired.",".$$cbonominasupplier.",'".$cons_breckdown."',".$$country.",".$$calculatorstring.",".$$seq.",".$$cboitemprint.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbotrimstatus.",0)";
				 //$id=$id+1;
				 // $add_co++;
			     //	CONS break down===============================================================================================
				 //echo $consbreckdown;
				if(str_replace("'",'',$consbreckdown) !='')
				{
					//echo "Monzu";

					$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
					for($c=0;$c < count($consbreckdown_array);$c++)
					{
						//echo "Monzu22";
						$counter++;
						$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
						$consbreckdownarr[7]=$consbreckdownarr[7];
						if($consbreckdownarr[7]=='' || $consbreckdownarr[7]==0)
						{
							$consbreckdownarr[7]=$consbreckdownarr[2];
						}
						if ($add_comma!=0) $data_array1 .=",";
						$data_array1 .="(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[7]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[2]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."','".$consbreckdownarr[10]."','".$consbreckdownarr[11]."','".$consbreckdownarr[12]."','".$consbreckdownarr[13]."','".$consbreckdownarr[14]."')";

						$id1=$id1+1;
						$add_comma++;
						if ($data_array1!="" && $counter==100)
						{
							$rID_in1=sql_insert("wo_pre_cost_trim_co_cons_dtls",$field_array1,$data_array1,1);
							$counter=0;
							$data_array1="";
							$add_comma=0;
							if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
						}
					}
					if ($data_array1!="" && $counter!=100)
					{
						$rID_in1=sql_insert("wo_pre_cost_trim_co_cons_dtls",$field_array1,$data_array1,1);
						$counter=0;
						$data_array1="";
						$add_comma=0;
						if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
					}
				}
          //CONS break down end===============================================================================================
		    $id=$id+1;
		    $add_co++;
			}
		 }
		$rID=execute_query(bulk_update_sql_statement( "wo_pre_cost_trim_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
		if($data_array !="")
		{
			$rID1=sql_insert("wo_pre_cost_trim_cost_dtls",$field_array,$data_array,0);
		}
		//echo "insert into wo_pre_cost_trim_co_cons_dtls (".$field_array1.") values ".$data_array1;

		//$rID_in1=sql_insert("wo_pre_cost_trim_co_cons_dtls",$field_array1,$data_array1,1);

 		 //=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, trim_cons, trim_rate, trim_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtconsdzntrim_sum.",".$txtratetrim_sum.",".$txttrimamount_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}

		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="trim_cons*trim_rate*trim_amount";
			$data_array2 ="".$txtconsdzntrim_sum."*".$txtratetrim_sum."*".$txttrimamount_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		$tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);
		//=======================sum End =================
		check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID )
			{
				mysql_query("COMMIT");
				echo "1**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID )
			{
				oci_commit($con);
				echo "1**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else
			{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		disconnect($con);
		die;
	}
}
//*************************************************Trim Cost End ***********************************************
//*************************************************Embellishment Cost Start ***********************************************
if ($action=="show_embellishment_cost_listview")
{
	$data=explode("_",$data);

	$supplier_arr=return_library_array( "select a.id, a.supplier_name from lib_supplier a,lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(23) and a.is_deleted=0 and a.status_active=1 group by a.id, a.supplier_name order by a.supplier_name", "id", "supplier_name");

	$header_td="";
	$costing_per=return_field_value("costing_per", "wo_pre_cost_mst", "job_no ='$data[0]'");
	if($costing_per==1) $header_td="Cons/ 1 Dzn Gmts";
	else if($costing_per==2) $header_td="Cons/ 1 Pcs Gmts";
	else if($costing_per==3) $header_td="Cons/ 2 Dzn Gmts";
	else if($costing_per==4) $header_td="Cons/ 3 Dzn Gmts";
	else if($costing_per==5) $header_td="Cons/ 4 Dzn Gmts";

	$variArr=array();
	$sqlvari=sql_select("select embellishment_id,embellishment_budget_id from variable_order_tracking where company_name='$data[3]' and variable_list=56 and status_active=1 and is_deleted=0");
	foreach($sqlvari as $vari_row)
	{
		//$is_manula_approved=$sql_row[csf('pre_cost_approval')];
		$variArr[$vari_row[csf('embellishment_id')]]=$vari_row[csf('embellishment_budget_id')]?$vari_row[csf('embellishment_budget_id')]:2;
	}
	$component_approved=0;
	$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=3 and job_no='$data[0]'");
	foreach($sql as $row){
		if($row[csf('approved')]==1 || $row[csf('approved')]==3) { $component_approved=1; $approved_message="<marquee width='500'><p style='color:#f00; text-align:center;'> Approved</p></marquee>";}
	}
?>
	<h3 style="width:940px;" align="left" id="accordion_h1" class="accordion_h">+Embellishment Cost <? echo $approved_message; ?></h3>
       <div id="content_embellishment_cost" align="left">
    	<fieldset style="width:940px">
        	<form id="embellishment_7" autocomplete="off">
            	<table width="940" cellspacing="0" class="rpt_table" border="0" id="tbl_embellishment_cost" rules="all">
                	<thead>
                    	<tr>
                        	<th width="120">Name</th>
                            <th width="100">Type</th>
                            <th width="100">Body Part</th>
                            <th width="90">Country</th>
                            <th width="120">Emb. Supplier</th>
                            <th width="80"><?=$header_td; ?></th>
                            <th width="70">Rate</th>
                            <th width="80">Amount</th>
                            <th width="80">Status</th>
                            <th>&nbsp;</th>
                        </tr>
                    </thead>
                    <tbody>
                    <?
					$save_update=1;
					$approved=return_field_value("approved", "wo_pre_cost_mst", "job_no='$data[0]'");
					if($approved==3) $approved=1;
					
					if($approved==1 || $component_approved==1) $disabled=1; else $disabled=0;

					$is_booking_arr=array();
					if($disabled!=1)
					{
						$data_arr=sql_select("select pre_cost_fabric_cost_dtls_id from wo_booking_dtls where job_no ='$data[0]' and booking_type='6' and status_active=1 and is_deleted=0 group by pre_cost_fabric_cost_dtls_id");
						foreach ($data_arr as $row)
						{
							$is_booking_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]]=$row[csf('pre_cost_fabric_cost_dtls_id')];
						}
						unset($data_arr);
					}

					$data_array=sql_select("select id, job_no, emb_name, emb_type, body_part_id, country, supplier_id, cons_dzn_gmts, rate, amount, status_active, budget_on from wo_pre_cost_embe_cost_dtls where emb_name!=3 and job_no='$data[0]' order by id");
					if(count($data_array)<1 && $data[2]==1 && $data[5]==2)//Price Quotation
					{
						$data_array=sql_select("select id, quotation_id, emb_name, emb_type, cons_dzn_gmts, rate, amount, status_active from  wo_pri_quo_embe_cost_dtls where emb_name!=3 and quotation_id='$data[1]' and status_active=1 and is_deleted=0 order by id");// quotation_id='$data'
						$save_update=0;
					}
					if (count($data_array)<1 && $data[2]==1 && $data[5]==7)//Quick Costing
					{
						$dataQc=sql_select("select id as pri_id, mst_id as quotation_id, particular_type_id as emb_name, fab_id as emb_type, consumption, ex_percent, tot_cons as cons_dzn_gmts, rate, value as amount, status_active from qc_cons_rate_dtls where mst_id='$data[1]' and type=2 and tot_cons>0 and status_active=1 and is_deleted=0 order by id");
						$qcDataArr=array();
						foreach($dataQc as $erow)
						{
							$qcDataArr[$erow[csf('pri_id')]]=$erow[csf('cons_dzn_gmts')].'__'.$erow[csf('excess_per')].'__'.$erow[csf('consumption')].'__'.$erow[csf('rate')].'__'.$erow[csf('amount')];
						}
						if (count($data_array) < 1)//Quick Costing
						{
							$data_array=$dataQc;
							$save_update=0;
						}
					}
					if ( count($data_array)>0)
					{
						$i=0;
						$type_array=array(0=>$blank_array,1=>$emblishment_print_type,2=>$emblishment_embroy_type,3=>$emblishment_wash_type,4=>$emblishment_spwork_type,5=>$emblishment_gmts_type,99=>$blank_array);

						foreach( $data_array as $row )
						{
							$i++;
							$country_text="";
							$countryarr=explode(",",$row[csf("country")]);
							//print_r($countryarr);
							for($cu=0 ;$cu< count($countryarr); $cu++){
								//echo "mmmm";
								$country_text.= $country_library[trim($countryarr[$cu])].",";
							}
							$country_text=rtrim($country_text,",");
							if($disabled!=1)
							{
								$booking_id='';
								$booking_id=$is_booking_arr[$row[csf('id')]];
								 $txt_dis=""; $dis=0;
								if($booking_id!="") { $dis=1; $txt_dis="disabled"; }
							}
							else $dis=$disabled;
							if($row[csf("supplier_id")]=="") $row[csf("supplier_id")]=0;
							?>
                            <tr id="embellishment_<?=$i;?>" align="center">
                                <td id="cboembnametd_<?=$i; ?>"><?=create_drop_down( "cboembname_".$i, 120,$emblishment_name_array, "",1,"-Select Item-", $row[csf("emb_name")], "cbotype_loder(".$i.")",$dis,'1,2,4,5,99' ); ?></td>
                                <td id="embtypetd_<?=$i;?>"><?=create_drop_down( "cboembtype_".$i, 100, $type_array[$row[csf("emb_name")]],"", 1, "--Select--", $row[csf("emb_type")], "check_duplicate(".$i.")",$dis,"" ); ?></td>
                                <td><?=create_drop_down( "cboembbodypart_".$i, 100, $body_part,"", 1, "--Select--", $row[csf("body_part_id")], "check_duplicate(".$i.")",$dis,"" ); ?></td>
                                <td>
                                    <input type="text" id="countrytext_<?=$i; ?>" name="countrytext_<?=$i; ?>" class="text_boxes" style="width:78px" value="<?=$country_text; ?>" <? if($dis==0){echo "";}else{echo "disabled";}?> onDblClick="open_country_popup('<?=$i.'_2'; ?>')" placeholder="Browse" readonly/>
                                    <input type="hidden" id="country_<?=$i; ?>" name="country_<?=$i; ?>" class="text_boxes" style="width:75px" value="<?=$row[csf("country")]; ?>" />
                            	</td>
                                <td id="embsuppliertd_<?=$i;?>">
                                    <input type="text" name="txtembsupplier_<?=$i;?>" id="txtembsupplier_<?=$i;?>" class="text_boxes supplier_name" onFocus="auto_completesupplier( $('#cbo_company_name').val(), <?=$i; ?>)" onBlur="check_duplicate(<?=$i; ?>)" style="width:108px;" placeholder="Write" value="<?=$supplier_arr[$row[csf("supplier_id")]]; ?>" <? if($dis==0){echo "";}else{echo "disabled";}?> />
                                    <input type="hidden" class="hidsupplier_<?=$i;?>" id="hidembsupplier_<?=$i;?>" name="hidembsupplier_<?=$i;?>" value="<?=$supplier_arr[$row[csf("supplier_id")]]; ?>" />
                                    <input type="hidden" name="cboembsupplierid_<?=$i;?>" id="cboembsupplierid_<?=$i;?>" class="text_boxes" style="width:40px;" value="<?=$row[csf("supplier_id")]; ?>" />
								</td>
                                <td id="txtembconsdzngmtstd_<?=$i;?>">
                                	<input type="text" id="txtembconsdzngmts_<?=$i; ?>" name="txtembconsdzngmts_<?=$i; ?>" class="text_boxes_numeric" style="width:68px" value="<?=$row[csf("cons_dzn_gmts")]; ?>" onChange="calculate_emb_cost(<?=$i; ?>);" onDblClick="set_session_large_post_data_emb( 'requires/pre_cost_entry_controller_v2.php?action=consumption_popup_emb', 'Consumption Entry Form',<?=$i; ?>);" readonly/>
                                </td>
                                <td id="txtembratetd_<?=$i;?>">
                                	<input type="text" id="txtembrate_<? echo $i; ?>"  name="txtembrate_<? echo $i; ?>" class="text_boxes_numeric" style="width:58px" value="<? echo $row[csf("rate")];  ?>" onChange="calculate_emb_cost( <? echo $i;?> )" <? if($dis==0){echo "";}else{echo "disabled";}?> readonly/>
                                </td>
                                <td id="txtembamounttd_<?=$i;?>">
                                	<input type="text" id="txtembamount_<? echo $i; ?>" name="txtembamount_<? echo $i; ?>" class="text_boxes_numeric" style="width:68px" value="<? echo $row[csf("amount")]; ?>" <? if($dis==0){echo "";}else{echo "disabled";}?> readonly/>
                                </td>
                                <td id="cboembstatustd_<?=$i;?>"><?=create_drop_down("cboembstatus_".$i,80,$row_status,"",0,"0",$row[csf("status_active")],'',$dis,''); ?></td>
                                <td id="buttontd_<?=$i;?>">
                                    <input type="button" id="increaseemb_<? echo $i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_embellishment_cost(<? echo $i; ?> )"  <? if($disabled==0){echo "";}else{echo "disabled";}?>/>
                                    <input type="button" id="decreaseemb_<? echo $i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<? echo $i; ?> ,'tbl_embellishment_cost' );" <? if($disabled==0){echo "";}else{echo "disabled";}?> />
                                    <input type="hidden" id="embupdateid_<? echo $i; ?>" name="embupdateid_<? echo $i; ?>"  class="text_boxes" style="width:20px" value="<? echo  $row[csf("id")]; ?>"  />
                                    <input type="hidden" id="consbreckdownemb_<? echo $i; ?>" name="consbreckdownemb_<? echo $i; ?>"  class="text_boxes" style="width:20px" value="<? //echo  $row[csf("id")]; ?>"  />
                                    <input type="hidden" id="empbudgeton_<? echo $i; ?>" name="empbudgeton_<? echo $i; ?>"  class="text_boxes" style="width:20px" value="<? if($row[csf("budget_on")]){echo $row[csf("budget_on")];} else{echo $variArr[$row[csf("emb_name")]]; }?>"  />
                                </td>
                            </tr>
                            <?
						}
					}
					else
					{
						$save_update=0;
						$type_array=array(0=>$blank_array,1=>$emblishment_print_type,2=>$emblishment_embroy_type,3=>$emblishment_wash_type,4=>$emblishment_spwork_type,5=>$emblishment_gmts_type,99=>$blank_array);
						$i=0;
						foreach( $emblishment_name_array as $row => $value )
						{
							$i++;
							if($i==3) continue;
							else
							{
								if($i>3) $i=$i-1;
								//echo $i;
								?>
								<tr id="embellishment_<?=$i;?>" align="center">
                                    <td id="cboembnametd_<?=$i;?>"><?=create_drop_down( "cboembname_".$i, 120, $emblishment_name_array, "",0,"", $row, "cbotype_loder(".$i.")",'','1,2,4,5,99' ); ?></td>
                                    <td id="embtypetd_<?=$i;?>"><?=create_drop_down( "cboembtype_".$i, 100, $type_array[$row],"", 1, "-- Select --", "", "check_duplicate(".$i.")","","" ); ?></td>
                                    <td><?=create_drop_down( "cboembbodypart_".$i, 100, $body_part,"", 1, "--Select--", '', "check_duplicate(".$i.")",'',"" ); ?></td>
                                    <td>
                                        <input  type="text" id="countrytext_<?=$i; ?>" name="countrytext_<?=$i; ?>" class="text_boxes" style="width:78px" value="" onDblClick="open_country_popup('<?=$i.'_2'; ?>');" placeholder="Browse" readonly/>
                                        <input type="hidden" id="country_<?=$i; ?>" name="country_<?=$i; ?>" class="text_boxes" style="width:75px" value="" />
                                    </td>
                                    <td id="embsuppliertd_<?=$i;?>">
										<input type="text" name="txtembsupplier_<?=$i;?>" id="txtembsupplier_<?=$i;?>" class="text_boxes supplier_name" onFocus="auto_completesupplier( $('#cbo_company_name').val(), <?=$i; ?>);" onBlur="check_duplicate(<?=$i; ?>)" style="width:108px;" placeholder="Write" value="" />
                                        <input type="hidden" class="text_boxes" id="hidembsupplier_<?=$i;?>" name="hidembsupplier_<?=$i;?>" value="" />
                                        <input type="hidden" name="cboembsupplierid_<?=$i;?>" id="cboembsupplierid_<?=$i;?>" class="text_boxes" style="width:40px;" value="0" />
									</td>
                                    <td id="txtembconsdzngmtstd_<?=$i;?>">
                                    	<input type="text" id="txtembconsdzngmts_<?=$i; ?>" name="txtembconsdzngmts_<?=$i; ?>" class="text_boxes_numeric" style="width:68px" value="" onChange="calculate_emb_cost(<?=$i;?>);" onDblClick="set_session_large_post_data_emb('requires/pre_cost_entry_controller_v2.php?action=consumption_popup_emb', 'Consumption Entry Form',<?=$i;?>)" readonly/>
                                    </td>
                                    <td id="txtembratetd_<?=$i;?>">
                                    	<input type="text" id="txtembrate_<?=$i; ?>" name="txtembrate_<?=$i; ?>" class="text_boxes_numeric" style="width:58px" value="" onChange="calculate_emb_cost(<?=$i;?>)" readonly/>
                                    </td>
                                    <td id="txtembamounttd_<?=$i;?>"><input type="text" id="txtembamount_<?=$i; ?>"  name="txtembamount_<?=$i; ?>" class="text_boxes_numeric" style="width:68px" value="" readonly />
                                    </td>
                                    <td id="cboembstatustd_<?=$i;?>"><?=create_drop_down( "cboembstatus_".$i, 80, $row_status,"", 0, "0", '', '','','' );  ?></td>
                                    <td id="buttontd_<?=$i;?>">
                                        <input type="button" id="increaseemb_<?=$i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_embellishment_cost(<?=$i; ?>);" />
                                        <input type="button" id="decreaseemb_<?=$i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<?=$i; ?> ,'tbl_embellishment_cost');" />
                                        <input type="hidden" id="embupdateid_<?=$i; ?>" name="embupdateid_<?=$i; ?>"  class="text_boxes" style="width:20px" value=""  />                                    	<input type="hidden" id="consbreckdownemb_<?=$i; ?>" name="consbreckdownemb_<?=$i; ?>"  class="text_boxes" style="width:20px" value="<? //echo  $row[csf("id")]; ?>" />
                                        <input type="hidden" id="empbudgeton_<?=$i; ?>" name="empbudgeton_<?=$i; ?>" class="text_boxes" style="width:20px" value="<?=$variArr[$row] ;?>"  />
                                    </td>
								</tr>
								<?
								if($i==3 || $i==4 || $i==5) $i++;
							}
						}
					}
					?>
                </tbody>
            </table>
            <table width="940" cellspacing="0" class="rpt_table" border="0" rules="all">
                <tfoot>
                	<tr>
                        <th width="120">&nbsp;</th>
                        <th width="100">&nbsp;</th>
                        <th width="100">&nbsp;</th>
                        <th width="90">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="80">&nbsp;</th>
                        <th width="70">Sum:</th>
                        <th width="80"><input type="text" id="txtamountemb_sum"  name="txtamountemb_sum" class="text_boxes_numeric" style="width:68px" readonly /></th>
                        <th width="80">&nbsp;</th>
                        <th>&nbsp;</th>
                    </tr>
                </tfoot>
            </table>
            <table width="940" cellspacing="0" class="" border="0">
                <tr>
                	<td align="center" height="15" width="100%">&nbsp;</td>
                </tr>
                <tr>
                    <td align="center" width="100%" class="button_container">
                    <?
                    if ( count($data_array)>0)
                    {
                    	echo load_submit_buttons( $permission, "fnc_embellishment_cost_dtls", $save_update,0,"reset_form('embellishment_7','','',0)",7) ;
                    }
                    else
                    {
                    	echo load_submit_buttons( $permission, "fnc_embellishment_cost_dtls", $save_update,0,"reset_form('embellishment_7','','',0)",7) ;
                    }
                    ?>
                    </td>
                </tr>
            </table>
        </form>
        </fieldset>
    </div>
	<?
	exit();
}

if ($action=="load_drop_down_embtype")
{
	$data=explode('_',$data);

	$emb_typearr="";
	if($data[0]==1) $emb_typearr=$emblishment_print_type;
	else if($data[0]==2) $emb_typearr=$emblishment_embroy_type;
	else if($data[0]==3) $emb_typearr=$emblishment_wash_type;
	else if($data[0]==4) $emb_typearr=$emblishment_spwork_type;
	else if($data[0]==5) $emb_typearr=$emblishment_gmts_type;
	else if($data[0]==99) $emb_typearr=$blank_array;
	else $emb_typearr=$blank_array;

	echo create_drop_down( "cboembtype_".$data[1], 97,$emb_typearr,"", 1, "-- Select --", "", "check_duplicate(".$data[1].")","","" );
	exit();
}

if($action=="load_drop_down_embtype_budgeton"){
	$data=explode('_',$data);
	$variArr=array();
	$sqlvari=sql_select("select embellishment_id,embellishment_budget_id from variable_order_tracking where company_name='$data[2]' and variable_list=56 and status_active=1 and is_deleted=0");
	foreach($sqlvari as $vari_row)
	{
		//$is_manula_approved=$sql_row[csf('pre_cost_approval')];
		$variArr[$vari_row[csf('embellishment_id')]]=$vari_row[csf('embellishment_budget_id')]?$vari_row[csf('embellishment_budget_id')]:2;
	}
	//$cboembtype="";
	$budget_on=2;
	echo "document.getElementById('empbudgeton_".$data[1]."').value = '".$variArr[$data[0]]."';\n";
	exit();
}

if($action=="save_post_session_emb"){
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$_SESSION['logic_erp']['cons_breck_downn_emb']="";
	$_SESSION['logic_erp']['cons_breck_downn_emb']=$cons_breck_downn_emb;
	echo 1;
	die;
}

if($action=="consumption_popup_emb"){

    echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode,'','');
    extract($_REQUEST);
	$cons_breck_downn= $_SESSION['logic_erp']['cons_breck_downn_emb'];
	$itemqty_array=array();
	$job_plancut_qty=0;

	$country=rtrim($country,",");
	if($country=="") $country_cond=""; else $country_cond=" and c.country_id in($country)";

	$data_array_tot_job_qty=sql_select("select b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id ,min(c.id) as color_size_table_id,min(color_order) as color_order,min(size_order) as size_order,sum(plan_cut_qnty) as plan_cut_qnty, sum(c.order_quantity) as order_quantity from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id  and b.job_no_mst='$txt_job_no'  $country_cond  and a.garments_nature='$garments_nature' and a.status_active=1 and b.status_active=1 and c.status_active=1 group by b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id order by b.id,c.item_number_id,color_order,size_order");
	foreach($data_array_tot_job_qty as $data_array_tot_job_qty_row ){
		if($empbudgeton==1){
			$itemqty_array[$data_array_tot_job_qty_row[csf('item_number_id')]]+=$data_array_tot_job_qty_row[csf('order_quantity')];
			$job_plancut_qty+=$data_array_tot_job_qty_row[csf('order_quantity')];
		}
		else if($empbudgeton==2){
			$itemqty_array[$data_array_tot_job_qty_row[csf('item_number_id')]]+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
			$job_plancut_qty+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
		}else{
			$itemqty_array[$data_array_tot_job_qty_row[csf('item_number_id')]]+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
		    $job_plancut_qty+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
		}

		$po_no_library[$data_array_tot_job_qty_row[csf('id')]]=$data_array_tot_job_qty_row[csf('po_number')];
	}
   $item_idarr=explode(",",$item_id);
   $total_item=count($item_idarr);
	?>
	<script>
		function copy_value(value,field_id,i){
			//var copy_val=document.getElementById('copy_val').checked;
			var gmtssizesid=document.getElementById('gmtssizesid_'+i).value;
			var pocolorid=document.getElementById('pocolorid_'+i).value;
			var ponoid=document.getElementById('ponoid_'+i).value;
			var cbogmtsitem=document.getElementById('cbogmtsitem_'+i).value;
			var rowCount = $('#tbl_consmption_cost tr').length-1;
			var copy_basis=$('input[name="copy_basis"]:checked').val()
			for(var j=i; j<=rowCount; j++){
				if(document.getElementById('approved_'+j).value==0){
					if(field_id=='rate_'){
						if(copy_basis==0){
							document.getElementById(field_id+j).value=value;
							claculate_amount(j)
						}
						else if(copy_basis==1){
							if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0){
								document.getElementById(field_id+j).value=value;
								claculate_amount(j)
							}
						}
						else if(copy_basis==2){
							if( pocolorid==document.getElementById('pocolorid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0){
								document.getElementById(field_id+j).value=value;
								claculate_amount(j)
							}
						}
						else if(copy_basis==3){
							if( cbogmtsitem==document.getElementById('cbogmtsitem_'+j).value && (document.getElementById('requirement_'+j).value*1) >0){
								document.getElementById(field_id+j).value=value;
								claculate_amount(j)
							}
						}
						else if(copy_basis==4){
							if( ponoid==document.getElementById('ponoid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0){
								document.getElementById(field_id+j).value=value;
								claculate_amount(j)
							}
						}
					}
					if(field_id=='requirement_'){
						if(copy_basis==0){
							document.getElementById(field_id+j).value=value;
							claculate_amount(j)
						}
						else if(copy_basis==1){
							if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value){
								document.getElementById(field_id+j).value=value;
								claculate_amount(j)
							}
						}
						else if(copy_basis==2){
							if( pocolorid==document.getElementById('pocolorid_'+j).value){
								document.getElementById(field_id+j).value=value;
								claculate_amount(j)
							}
						}
						else if(copy_basis==3){
							if( cbogmtsitem==document.getElementById('cbogmtsitem_'+j).value){
								document.getElementById(field_id+j).value=value;
								claculate_amount(j)
							}
						}
						else if(copy_basis==4){
							if( ponoid==document.getElementById('ponoid_'+j).value){
								document.getElementById(field_id+j).value=value;
								claculate_amount(j)
							}
						}
					}
				}//if(var approved=document.getElementById('approved_'+j).value==0)
			}
		}

		function fn_delete_down_tr(rowNo,table_id)
		{
			if(table_id=='tbl_consmption_cost')
			{
				var numRow = $('table#tbl_consmption_cost tbody tr').length;
				if(numRow==rowNo && rowNo!=1)
				{
					$('#tbl_consmption_cost tbody tr:last').remove();
					$('#tbl_msmnt_cost tbody tr:last').remove();
				}
				set_sum_value( 'requirement_sum', 'requirement_');
				set_sum_value( 'rate_sum', 'rate_');
				set_sum_value( 'amount_sum', 'amount_');
			}
		}

		function set_sum_value(des_fil_id,field_id){
			if(des_fil_id=='requirement_sum') var ddd={dec_type:5,comma:0};
			if(des_fil_id=='amount_sum') var ddd={dec_type:5,comma:0};
			if(des_fil_id=='rate_sum') var ddd={dec_type:5,comma:0};
			var rowCount = $('#tbl_consmption_cost tr').length-1;
			math_operation( des_fil_id, field_id, '+', rowCount,ddd );
			claculate_avg();
		}

		function js_set_value(){
			var rowCount = $('#tbl_consmption_cost tr').length-1;
			var cons_breck_down="";
			for(var i=1; i<=rowCount; i++){
				var ponoid=$('#ponoid_'+i).val()
				if(ponoid==''){ ponoid=0; }
				var cbogmtsitem=$('#cbogmtsitem_'+i).val()
				if(cbogmtsitem==''){ cbogmtsitem=0; }

				var pocolorid=$('#pocolorid_'+i).val()
				if(pocolorid==''){ pocolorid=0; }
				var gmtssizesid=$('#gmtssizesid_'+i).val()
				if(gmtssizesid==''){ gmtssizesid=0; }
				var requirement=$('#requirement_'+i).val()
				if(requirement==''){ requirement=0; }
				var colorsizetableid=$('#colorsizetableid_'+i).val()
				if(colorsizetableid==''){ colorsizetableid=0; }
				var rate=$('#rate_'+i).val()
				if(rate==''){ rate=0; }
				var amount=$('#amount_'+i).val()
				if(amount==''){ amount=0; }
				var countyid=$('#cbocountry_'+i).val()
				if(countyid==''){ countyid=0; }

				if(cons_breck_down==""){
					cons_breck_down+=ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid+'_'+countyid;
				}
				else{
					cons_breck_down+="__"+ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid+'_'+countyid;
				}
			}
			document.getElementById('cons_breck_down').value=cons_breck_down;
			claculate_avg();
			parent.emailwindow.hide();
		}

		function claculate_avg(){
			var tot_plancut_qty=document.getElementById('job_plancut_qty').value*1
			var item_ratio=document.getElementById('item_ratio').value*1
			var total_item=document.getElementById('total_item').value*1
			var calculated_cons=0;
			var avg_cons=0;
			var plancutqty=0;
			var calculated_amount=0;
			var rowCount = $('#tbl_consmption_cost tr').length-1;

			/*for(var j=1; j<=rowCount; j++){
				if(document.getElementById('requirement_'+j).value =='' || document.getElementById('requirement_'+j).value ==0){
					continue;
				}
				else{
					//plancutqty+=document.getElementById('pcsgmts_'+j).value*1;
				}
			}*/

			for(var i=1; i<=rowCount; i++){
				if(document.getElementById('requirement_'+i).value =='' || document.getElementById('requirement_'+i).value ==0){
					continue;
				}
				else{

					//var tot_plancut_qty=document.getElementById('itempcsgmts_'+i).value*1
					var pcsgmts=document.getElementById('pcsgmts_'+i).value*1
					var plan_cut_percent=(pcsgmts/tot_plancut_qty)*100;
					var requirement=document.getElementById('requirement_'+i).value*1
					var calculated_cons_percent=(requirement*plan_cut_percent)/100;
					calculated_cons+=calculated_cons_percent;
					var amount=document.getElementById('amount_'+i).value*1
					var calculated_amount_percent=(amount*plan_cut_percent)/100;
					calculated_amount+=calculated_amount_percent;
				}
			}
			document.getElementById('calculated_cons').value=number_format_common(calculated_cons,5, 0);
			document.getElementById('calculated_amount').value=number_format_common(calculated_amount,5, 0);
			document.getElementById('calculated_rate').value=number_format_common((calculated_amount/calculated_cons), 5, 0);
			//document.getElementById('calculated_cons').value=number_format_common(calculated_cons,5, 0);
			//document.getElementById('calculated_amount').value=number_format_common(calculated_amount,5, 0);
			//document.getElementById('calculated_rate').value=number_format_common(((calculated_cons*item_ratio)/total_item)/((calculated_amount/calculated_cons)/total_item), 5, 0);
		}

		function claculate_amount(i){
			var rate=document.getElementById('rate_'+i).value;
			var requirement=document.getElementById('requirement_'+i).value;
			var amount= requirement*rate;
			document.getElementById('amount_'+i).value=number_format_common(amount,5,0);
			set_sum_value( 'amount_sum', 'amount_' );
			claculate_avg()
		}
    </script>
	</head>
	<body>
    <div align="center" style="width:99%;" >
    	<fieldset>
            <legend><? echo $body_part_id.'.'.$body_part[$body_part_id].' Costing '.$costing_per[$cbo_costing_per] ;?></legend>
        	<form id="consumptionform_1" autocomplete="off">
                <input type="hidden" id="cbo_company_id" name="cbo_company_id" value="<? echo $cbo_company_id; ?>"/>
                <input type="hidden" id="cbo_costing_per_id" name="cbo_costing_per_id" value="<? echo $cbo_costing_per; ?>"/>
                <input type="hidden" id="cons_breck_down" name="cons_breck_down"  width="500"  value="<? echo $cons_breck_downn;?>"/>
                <input type="hidden" id="job_plancut_qty" name="job_plancut_qty" value="<? echo $job_plancut_qty; ?>"/>
                <input type="hidden" id="item_ratio" name="item_ratio" value="<? echo $tot_set_qnty; ?>"/>
                <input type="hidden" id="total_item" name="item_ratio" value="<? echo $total_item; ?>"/>

                <!--<b>Copy</b> : <input type="checkbox" id="copy_val" name="copy_val" checked/>  -->
                <input type="radio" name="copy_basis" value="0" checked>Copy To  All
                <input type="radio" name="copy_basis" value="1">Copy Size Wise
                <input type="radio" name="copy_basis" value="2">Copy Color Wise
                <input type="radio" name="copy_basis" value="3">Copy Item Wise
                <input type="radio" name="copy_basis" value="4">Copy Po Wise
                <input type="reset" value="Reset">
            </form>
            <table width="930" cellspacing="0" class="rpt_table" border="0" id="tbl_consmption_cost" rules="all">
                <thead>
                    <tr>
                    	<th width="30">SL</th>
                        <th width="130">PO NO</th>
                        <th width="110">Country</th>
                        <th width="130">Gmts.Item</th>
                        <th width="100">Gmts Color</th>
                        <th width="80">Gmts Size</th>
                        <th width="75">Cons</th>
                        <th width="60">Rate</th>
                        <th width="90">Amount</th>
                        <th>&nbsp;</th>
                    </tr>
                </thead>
                <tbody>
					<?
                    $component_approved=0;
                    $sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=3 and job_no='$txt_job_no'");
                    foreach($sql as $row){
						if($row[csf('approved')]==1 || $row[csf('approved')]==3) { $component_approved=1; }
					}
					$data_array=explode("__",$cons_breck_downn);
					if($data_array[0]==""){
						$data_array=array();
                    }

					$country_array=array();
					$data_country=sql_select("select b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id ,c.country_id from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and b.job_no_mst='$txt_job_no' $country_cond   and a.status_active=1 and b.status_active=1 and c.status_active=1");
					foreach($data_country as $cou_row){
						 $country_array[$cou_row[csf('id')]][$cou_row[csf('item_number_id')]][$cou_row[csf('color_number_id')]][$cou_row[csf('size_number_id')]]['country_id'][$cou_row[csf('country_id')]]=$cou_row[csf('country_id')];
						 $country_array[$cou_row[csf('id')]][$cou_row[csf('item_number_id')]][$cou_row[csf('color_number_id')]][$cou_row[csf('size_number_id')]]['country_name'][$cou_row[csf('country_id')]]=$country_library[$cou_row[csf('country_id')]];
					}
					//print_r ($country_array);
                    $data_array=sql_select("select b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id ,min(c.id) as color_size_table_id,min(color_order) as color_order,min(size_order) as size_order,sum(plan_cut_qnty) as plan_cut_qnty, sum(c.order_quantity) as order_quantity from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c  where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id  and b.job_no_mst='$txt_job_no' $country_cond and a.garments_nature='$garments_nature' and a.status_active=1 and b.status_active=1 and c.status_active=1 group by b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id order by b.id,c.item_number_id,color_order,size_order");
                    //=======================================
					$is_booking_arr=array();
                    if($embupdateid != ""){
						$is_booking_arr=array();
						/*if($cbo_approved_status!=1)
						{*/
							$data_arr=sql_select("select po_break_down_id, pre_cost_fabric_cost_dtls_id from wo_booking_dtls where pre_cost_fabric_cost_dtls_id ='$embupdateid' and booking_type='6' and status_active=1 and is_deleted=0 group by po_break_down_id, pre_cost_fabric_cost_dtls_id");
							foreach($data_arr as $row)
							{
								$is_booking_arr[$row[csf('po_break_down_id')]]=$row[csf('pre_cost_fabric_cost_dtls_id')];
							}
							unset($data_arr);
						//}

						$row_arr_data="";
						$wo_pre_cos_fab_co_avg_con_dtls_data=sql_select("select id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id, item_number_id, color_number_id, size_number_id, requirment, rate, amount, color_size_table_id, country_id from wo_pre_cos_emb_co_avg_con_dtls where job_no='$txt_job_no' and pre_cost_emb_cost_dtls_id=$embupdateid order by id");
						foreach($wo_pre_cos_fab_co_avg_con_dtls_data as $emb_con_row){
							if($emb_con_row[csf('country_id')]=="") $emb_con_row[csf('country_id')]=0;
							$row_arr=$emb_con_row[csf('po_break_down_id')]."_".$emb_con_row[csf('item_number_id')]."_".$emb_con_row[csf('color_number_id')]."_".$emb_con_row[csf('size_number_id')]."_".$emb_con_row[csf('requirment')]."_".$emb_con_row[csf('rate')]."_".$emb_con_row[csf('amount')]."_".$emb_con_row[csf('color_size_table_id')]."_".$emb_con_row[csf('country_id')];
							$row_arr_data.=$row_arr."__";
						}
						$row_arr_data=rtrim($row_arr_data,"__");
						$data_array_cons=explode("__",$row_arr_data);
                    }

                    if($embupdateid == "") $data_array_cons=explode("__",$cons_breck_downn);

                    if($precostapproved==1 || $component_approved==1) $disabled=1; else $disabled=0;
					/*$cons_up=0;
					if(count($data_arr)>0 &&  $disabled!=1)
					{
						$disabled=1; $cons_up=1;
					}*/
                    //=======================================
                    if ( count($data_array)>0){
						$i=0;
						$pcsgmts=0;
						foreach( $data_array as $row )
						{
							$data=explode('_',$data_array_cons[$i]);
							$i++;
							if($empbudgeton==1) $pcsgmts=$row[csf('order_quantity')];
							else if($empbudgeton==2) $pcsgmts=$row[csf('plan_cut_qnty')];
							else $pcsgmts=$row[csf('plan_cut_qnty')];

							$country_string=implode(",",$country_array[$row[csf('id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['country_id']);
							$country_string_name=implode(",",$country_array[$row[csf('id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['country_name']);

							$po_country_arr=explode(",",$country_string);

							$countrydata=explode(",",$data[8]);
							$arr_d=array_diff($countrydata, $po_country_arr);
							$arr_d2=array_diff($countrydata, $arr_d);
							$country_name="";

							for($countryindex=0; $countryindex < count($arr_d2);$countryindex++){
								$country_name.=	$country_library[$countrydata[$countryindex]].",";
							}
							$country_idstring=implode(",",$arr_d2);

							if(count($arr_d)>0 && count($countrydata)>0 )
							{
								$country_name_pre="";
								for($countryindex=0; $countryindex < count($arr_d);$countryindex++){
									$country_name_pre.=	$country_library[$countrydata[$countryindex]].",";
								}
								$title="Country have Changed in po entry, you have to update this field, Previous Country was ".rtrim($country_name_pre,",")."";
								if(rtrim($country_name_pre,",")!=""){
									$bgc="#D41F00";
								}
							}
							else{
								$title=""; $bgc="#FFFFFF";
							}
							$cons_fld=0;
							if($disabled!=1)
							{
								//echo $is_booking_arr[$row[csf('id')]];
								if($is_booking_arr[$row[csf('id')]]!="" || $is_booking_arr[$row[csf('id')]]!=0) $cons_fld=1;
							}
							?>
							<tr id="break_<?=$i; ?>" align="center">
                                <td><?=$i; ?></td>
                                <td>
                                    <input type="text" id="pono_<?=$i;?>" name="pono_<?=$i;?>" class="text_boxes" style="width:118px" value="<?=$row[csf('po_number')]; ?>" readonly />
                                    <input type="hidden" id="ponoid_<?=$i;?>" name="ponoid_<?=$i;?>" class="text_boxes" style="width:85px" value="<?=$row[csf('id')]; ?>" readonly />
                                </td>
                                <td>
                                    <input type="hidden" id="cbocountry_<? echo $i;?>" name="cbocountry_<? echo $i;?>" style="width:75px" value="<? echo $country_string; ?>" readonly />
                                    <input type="text" id="cbocountryname_<? echo $i;?>" name="cbocountryname_<? echo $i;?>" onClick="open_country_popup('<? echo $i.'_2'; ?>')" class="text_boxes" style="width:98px; background-color:<? echo $bgc; ?>" value="<? echo $country_string_name; ?>" readonly title="<? echo $title; ?>" disabled />
                                </td>
                                <td><?=create_drop_down( "cbogmtsitem_".$i, 130, $garments_item,"", 0, "",$row[csf('item_number_id')], "",1); ?></td>
                                <td>
                                    <input type="text" id="pocolor_<? echo $i;?>"  name="pocolor_<? echo $i;?>" class="text_boxes" style="width:88px" value="<? echo $color_library[$row[csf('color_number_id')]]; ?>" readonly />
                                    <input type="hidden" id="pocolorid_<? echo $i;?>"  name="pocolorid_<? echo $i;?>" class="text_boxes" style="width:80px" value="<? echo $row[csf('color_number_id')]; ?>" readonly/>
                                </td>
                                <td>
                                    <input type="text" id="gmtssizes_<?=$i;?>" name="gmtssizes_<?=$i;?>" class="text_boxes" style="width:68px" value="<?=$size_library[$row[csf('size_number_id')]]; ?>" readonly>
                                    <input type="hidden" id="gmtssizesid_<? echo $i;?>"  name="gmtssizesid_<? echo $i;?>" class="text_boxes" style="width:50px" value="<? echo $row[csf('size_number_id')]; ?>" readonly />
                                </td>
                                <td>
                                    <input type="text" id="requirement_<? echo $i;?>" onChange="claculate_amount(<? echo $i;?>);copy_value(this.value,'requirement_',<? echo $i;?>);set_sum_value( 'requirement_sum', 'requirement_' )"  name="requirement_<? echo $i;?>" class="text_boxes_numeric" style="width:63px" value="<? if ($data[4]==""){ echo $price_quatation_requirment[$row[csf('size_number_id')]];} else { echo $data[4]; } ?>" <? if($cons_up==0) { if($disabled==1){ echo "disabled";} else{ echo "";} }?> />
                                </td>
                                <td>
                                    <input type="text" id="rate_<?=$i;?>"  name="rate_<?=$i;?>" onChange="claculate_amount(<?=$i;?>);copy_value(this.value,'rate_',<?=$i;?>)" onBlur="set_sum_value( 'rate_sum', 'rate_' )" class="text_boxes_numeric" style="width:48px"  value="<? echo $data[5]; ?>" <? if($disabled==1){ echo "disabled";} else{ echo "";} ?>/>
                                </td>
                                <td>
                                    <input type="text" id="amount_<?=$i;?>" name="amount_<? echo $i;?>" class="text_boxes_numeric" style="width:78px" value="<? echo $data[6]; ?>" readonly />
                                </td>
                                <td id="add_<?=$i;?>">
                                    <input type="hidden" id="pcsgmts_<? echo $i;?>"  name="pcsgmts_<? echo $i;?>"  onBlur="set_sum_value( 'pcs_sum', 'pcs_' ) " class="text_boxes_numeric" style="width:75px"  value="<? echo $pcsgmts; ?>">
                                    <input type="hidden" id="itempcsgmts_<? echo $i;?>"  name="itempcsgmts_<? echo $i;?>"  onBlur="set_sum_value( 'pcs_sum', 'pcs_' ) " class="text_boxes_numeric" style="width:75px"  value="<? echo $itemqty_array[$row[csf('item_number_id')]]; ?>">
                                    <input type="hidden" id="colorsizetableid_<? echo $i;?>"  name="colorsizetableid_<? echo $i;?>" class="text_boxes" style="width:85px" value="<? echo $row[csf('color_size_table_id')]; ?>" readonly/>
                                    <input type="button" id="decreaserow_<? echo $i;?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_delete_down_tr(<? echo $i;?>,'tbl_consmption_cost');" disabled/>
                                    <input type="hidden" id="approved_<? echo $i;?>"  name="approved_<? echo $i;?>"  class="text_boxes_numeric" style="width:75px"  value="<? echo $disabled; ?>">
                                </td>
							</tr>
							<?
						}
                    }
                    ?>
                </tbody>
            </table>
            <table width="930" cellspacing="0" class="rpt_table" border="0" rules="all">
                <tfoot>
                    <tr>
                        <th width="30">&nbsp;</th>
                        <th width="130">&nbsp;</th>
                        <th width="110">&nbsp;</th>
                        <th width="130">&nbsp;</th>
                        <th width="100">&nbsp;</th>
                        <th width="80">SUM:</th>
                        <th width="75"><input type="text" id="requirement_sum" name="requirement_sum" class="text_boxes_numeric" style="width:62px" readonly></th>
                        <th width="60"><input type="text" id="rate_sum" name="rate_sum" class="text_boxes_numeric" style="width:47px" readonly></th>
                        <th width="90">
                            <input type="text" id="amount_sum" name="amount_sum" class="text_boxes_numeric" style="width:77px" readonly>
                            <input type="hidden" id="plancutqty_sum" name="plancutqty_sum" class="text_boxes_numeric" style="width:70px" readonly>
                        </th>
                        <th>&nbsp;</th>
                    </tr>
                    <tr>
                        <th width="30">&nbsp;</th>
                        <th width="130">&nbsp;</th>
                        <th width="110">&nbsp;</th>
                        <th width="130">&nbsp;</th>
                        <th width="100">&nbsp;</th>
                        <th width="80">AVG:</th>
                        <th width="75"><input type="text" id="calculated_cons" name="calculated_cons" class="text_boxes_numeric" style="width:62px" value="<? echo $calculated_conss;?>" readonly></th>
                        <th width="60"><input type="text" id="calculated_rate"   name="calculated_rate" class="text_boxes_numeric" style="width:47px" readonly></th>
                        <th width="90">
                            <input type="text" id="calculated_amount" name="calculated_amount" class="text_boxes_numeric" style="width:77px" readonly>
                            <input type="hidden" id="calculated_plancutqty"    name="calculated_plancutqty" class="text_boxes_numeric" style="width:60px" readonly>
                        </th>
                        <th>&nbsp;</th>
                    </tr>
                </tfoot>
            </table>
			<script>
				set_sum_value( 'requirement_sum', 'requirement_');
				set_sum_value( 'rate_sum', 'rate_');
				set_sum_value( 'amount_sum', 'amount_');
            </script>
        </form>
        </fieldset>
    </div>
    <div align="center" style="width:100%;" >
        <fieldset>
            <table width="930" cellspacing="0" class="" border="0" rules="all">
                 <tr>
                    <td align="center" width="100%" class="button_container"> <input type="button" class="formbutton" value="Close" onClick="js_set_value();"/> </td>
                </tr>
            </table>
        </fieldset>
    </div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
    exit();
}

function create_consbreak_down_emb($job_no,$cons_value,$rate,$amount,$country="")
{
	$cbo_costing_per=return_field_value("costing_per", "wo_pre_cost_mst", "job_no=$job_no");
	$size_library_arr=return_library_array( "select id,size_name from lib_size where status_active=1 and is_deleted=0", "id", "size_name"  );

	$item_ratio_arr=array();
	$gmts_item_sql=sql_select("select gmts_item_id, set_item_ratio from  wo_po_details_mas_set_details  where job_no=$job_no");
	foreach($gmts_item_sql as $gmts_item_row){
		$item_ratio_arr[$gmts_item_row[csf('gmts_item_id')]]=$gmts_item_row[csf('set_item_ratio')];
	}
	$country_cond ="";

	$data_array=sql_select("select a.gmts_item_id,a.total_set_qnty,b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id ,min(c.id)as color_size_table_id, min(color_order) as color_order, min(size_order) as size_order, sum(plan_cut_qnty) as plan_cut_qnty,sum(order_quantity) as order_quantity from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id  and b.job_no_mst=$job_no $country_cond   and a.status_active=1 and b.status_active=1 and c.status_active=1 group by a.gmts_item_id,a.total_set_qnty,b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id order by b.id,c.item_number_id,color_order,size_order");

	if ( count($data_array)>0)
	{
		$cons_breck_down="";
		if($cbo_costing_per==1) $pcs_value=1*12;
		if($cbo_costing_per==2) $pcs_value=1*1;
		if($cbo_costing_per==3) $pcs_value=2*12;
		if($cbo_costing_per==4) $pcs_value=3*12;
		if($cbo_costing_per==5) $pcs_value=4*12;
		$oth=0;
		foreach( $data_array as $row )
		{
			$totitem=count($item_ratio_arr);
			$cons=def_number_format($cons_value/$totitem,5,"");
			$amount=def_number_format($cons*$rate,5,"");
			$pcs=$pcs_value*$item_ratio_arr[$row[csf('item_number_id')]];

			if($cons_breck_down=="")
			{
				$cons_breck_down.=$row[csf('id')].'_'.$row[csf('item_number_id')].'_'.$row[csf('color_number_id')].'_'.$row[csf('size_number_id')].'_'.$cons.'_'.$rate.'_'.$amount.'_'.$row[csf('color_size_table_id')].'_0';
			}
			else
			{
				$cons_breck_down.="__".$row[csf('id')].'_'.$row[csf('item_number_id')].'_'.$row[csf('color_number_id')].'_'.$row[csf('size_number_id')].'_'.$cons.'_'.$rate.'_'.$amount.'_'.$row[csf('color_size_table_id')].'_0';
			}
		}
		return $cons_breck_down;
	}
}

if ($action=="save_update_delet_embellishment_cost_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$sql=sql_select("select approval_need from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
	$app_nessity=2;
	foreach($sql as $row){
		$app_nessity=$row[csf('approval_need')];
	}

	$sql=sql_select("select approved from wo_price_quotation  where id=$txt_quotation_id");
	$quatation_approved=2;
	foreach($sql as $row){
		$quatation_approved=$row[csf('approved')];
	}

	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	//echo "10**",$is_copy_quatation."**". $app_nessity."**".$quatation_approved;
	//die;
	if($is_copy_quatation==1 && $app_nessity==1){
		if($quatation_approved==2 || $quatation_approved==0 || $quatation_approved==3){
			echo "quataNotApp**".str_replace("'","",$txt_job_no);
			disconnect($con);die;
		}
	}
	
	$materialReciveNo="";
	$sql=sql_select("select a.recv_number from inv_receive_master a, inv_transaction b, wo_po_break_down c where a.id=b.mst_id and b.job_no=c.job_no_mst and b.job_no=$update_id and a.entry_form=248 and c.is_confirmed=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by a.recv_number");
	foreach($sql as $row)
	{
		if($materialReciveNo=="") $materialReciveNo=$row[csf('recv_number')]; else $materialReciveNo.=','.$row[csf('recv_number')];
	}
	if($materialReciveNo!=""){
		echo "materialRecive**".$materialReciveNo;
		disconnect($con);die;
	}
	
	if($operation==0)
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		$approved=0;
		$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$update_id");
		foreach($sql as $row){
			if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
		}
		if($approved==1){
			echo "approved**".str_replace("'","",$update_id);
			disconnect($con);die;
		}
		if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0";disconnect($con); die;}
		$add_comma=0;
		$fail1=0;
		$id=return_next_id( "id", "wo_pre_cost_embe_cost_dtls", 1);

		$id1=return_next_id( "id", "wo_pre_cos_emb_co_avg_con_dtls", 1);

		$field_array="id, job_id, job_no, emb_name, emb_type, body_part_id, country, supplier_id, cons_dzn_gmts, rate, amount, budget_on, inserted_by, insert_date, status_active, is_deleted";
		$field_array1="id, job_id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id, item_number_id, color_number_id, size_number_id, requirment, rate, amount, color_size_table_id, country_id";
		for ($i=1;$i<=$total_row;$i++)
		{
			$cboembname="cboembname_".$i;
			$cboembtype="cboembtype_".$i;
			$cboembbodypart="cboembbodypart_".$i;
			$countryid="country_".$i;
			$cboembsupplierid="cboembsupplierid_".$i;
			$txtembconsdzngmts="txtembconsdzngmts_".$i;
			$txtembrate="txtembrate_".$i;
			$txtembamount="txtembamount_".$i;
			$cboembstatus="cboembstatus_".$i;
			$embupdateid="embupdateid_".$i;
			$consbreckdownemb="consbreckdownemb_".$i;
			$empbudgeton="empbudgeton_".$i;
			
			if(str_replace("'","",$$cboembsupplierid)=="") $cboembsupplierid=0; else $cboembsupplierid=str_replace("'","",$$cboembsupplierid);

			if ($i!=1) $data_array .=",";
			$data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cboembname.",".$$cboembtype.",".$$cboembbodypart.",".$$countryid.",'".$cboembsupplierid."',".$$txtembconsdzngmts.",".$$txtembrate.",".$$txtembamount.",".$$empbudgeton.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cboembstatus.",0)";
			//	CONS break down===============================================================================================

			if(str_replace("'",'',$$consbreckdownemb) !='')
			{
				$consbreckdown= $$consbreckdownemb;
			}
			else
			{
				$consbreckdown="'".create_consbreak_down_emb($update_id,str_replace("'",'',$$txtembconsdzngmts),str_replace("'",'',$$txtembrate),str_replace("'",'',$$txtembamount))."'";
			}

			if(str_replace("'",'',$consbreckdown) !='')
			{
				$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
				$counter=0;
				for($c=0;$c < count($consbreckdown_array);$c++)
				{
					$counter++;
					$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
					//"id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id,item_number_id, color_number_id, size_number_id, requirment,rate,amount,color_size_table_id"
					//ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid;
					if ($add_comma!=0) $data_array1 .=",";
					$data_array1 .="(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."')";

					$id1=$id1+1;
					$add_comma++;
					if ($data_array1!="" && $counter==100)
					{
						$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
						$counter=0;
						$data_array1="";
						$add_comma=0;
						if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
					}
				}
				if ($data_array1!="" && $counter!=100)
				{
					$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
					$counter=0;
					$data_array1="";
					$add_comma=0;
					if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
				}
			}
			//CONS break down end===============================================================================================
			$id=$id+1;
		}
		$rID=sql_insert("wo_pre_cost_embe_cost_dtls",$field_array,$data_array,0);
		//=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, emb_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtamountemb_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="emb_amount";
			$data_array2 ="".$txtamountemb_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		check_table_status( $_SESSION['menu_id'],0);
		//=======================sum End =================
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "0**".$new_job_no[0]."**".$rID;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "0**".$new_job_no[0]."**".$rID;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		disconnect($con);
		die;
	}
	else if($operation==1)
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		$component_approved=return_field_value("current_approval_status", "co_com_pre_costing_approval", "job_no=$update_id and cost_component_id=3");
		if($component_approved==3){
			$component_approved=1;
		}
		$approved=0;
		$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$update_id");
		foreach($sql as $row){
			if($row[csf('approved')]==3){
				$approved=1;
			}else{
				$approved=$row[csf('approved')];
			}
		}
		if($approved==1 || $component_approved==1){
			echo "approved**".str_replace("'","",$update_id);
			disconnect($con);die;
		}
		if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**1"; disconnect($con);die;}
		$field_array_up="job_no*emb_name*emb_type*body_part_id*country*supplier_id*cons_dzn_gmts*rate*amount*budget_on*updated_by*update_date*status_active*is_deleted";
		$field_array="id, job_id, job_no, emb_name, emb_type, body_part_id, country, supplier_id, cons_dzn_gmts, rate, amount, budget_on, inserted_by, insert_date, status_active, is_deleted";
		$field_array1="id, job_id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id, item_number_id, color_number_id, size_number_id, requirment, rate, amount, color_size_table_id, country_id";

		$add_co=0; $add_comma=0; $fail1=0;
		$id=return_next_id( "id", "wo_pre_cost_embe_cost_dtls", 1) ;
		$id1=return_next_id( "id", "wo_pre_cos_emb_co_avg_con_dtls", 1) ;

		for ($i=1;$i<=$total_row;$i++)
		{
			$cboembname="cboembname_".$i;
			$cboembtype="cboembtype_".$i;
			$cboembbodypart="cboembbodypart_".$i;
			$countryid="country_".$i;
			$cboembsupplierid="cboembsupplierid_".$i;
			$txtembconsdzngmts="txtembconsdzngmts_".$i;
			$txtembrate="txtembrate_".$i;
			$txtembamount="txtembamount_".$i;
			$cboembstatus="cboembstatus_".$i;
			$embupdateid="embupdateid_".$i;
			$consbreckdownemb="consbreckdownemb_".$i;
			$empbudgeton="empbudgeton_".$i;
			
			if(str_replace("'","",$$cboembsupplierid)=="") $cboembsupplierid=0; else $cboembsupplierid=str_replace("'","",$$cboembsupplierid);

			if(str_replace("'",'',$$embupdateid)!="")
			{
				$id_arr[]=str_replace("'",'',$$embupdateid);
				//$data_array_up[str_replace("'",'',$$embupdateid)] =explode(",",("".$update_id.",".$$cboembname.",".$$cboembtype.",".$$countryid.",".$$cboembsupplierid.",".$$txtembconsdzngmts.",".$$txtembrate.",".$$txtembamount.",".$$empbudgeton.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cboembstatus.",0"));

				$data_array_up[str_replace("'",'',$$embupdateid)] =explode("*",("".$update_id."*".$$cboembname."*".$$cboembtype."*".$$cboembbodypart."*".$$countryid."*'".$cboembsupplierid."'*".$$txtembconsdzngmts."*".$$txtembrate."*".$$txtembamount."*".$$empbudgeton."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*".$$cboembstatus."*0"));

				//$data_array_up[str_replace("'",'',$$updateidtrim)] =explode("*",("".$update_id."*".$$txtremark."*".$$cbogroup."*'".$txttrimdescription."'*".$$txtsupref."*".$$cboconsuom."*".$$txtconsdzngmts."*".$$txttrimrate."*".$$txttrimamount."*".$$cboapbrequired."*".$$cbonominasupplier."*'".$cons_breckdown."'*".$$country."*".$$calculatorstring."*".$$seq."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*".$$cbotrimstatus."*0"));
				//	CONS break down===============================================================================================
				if(str_replace("'",'',$$consbreckdownemb) !='')
				{
					$consbreckdown= $$consbreckdownemb;
				}
				else
				{
					//$consbreckdown="'".create_consbreak_down_emb( $update_id,str_replace("'",'', $$txtembconsdzngmts), str_replace( "'",'',$$txtembrate), str_replace("'",'',$$txtembamount))."'";
					$consbreckdown="";
				}
				if(str_replace("'",'',$consbreckdown) !='')
				{
					//echo "delete from wo_pre_cos_emb_co_avg_con_dtls where  pre_cost_emb_cost_dtls_id =".$$embupdateid."";
					$rID_de1=execute_query( "delete from wo_pre_cos_emb_co_avg_con_dtls where  pre_cost_emb_cost_dtls_id =".$$embupdateid."",0);
					$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
					$counter=0;
					for($c=0;$c < count($consbreckdown_array);$c++)
					{
						$counter++;
						$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
						//"id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id,item_number_id, color_number_id, size_number_id, requirment,rate,amount,color_size_table_id"
						//ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid;
						if ($add_comma!=0) $data_array1 .=",";
						$data_array1 .="(".$id1.",".$hidd_job_id.",".str_replace("'",'',$$embupdateid).",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."')";

						$id1=$id1+1;
						$add_comma++;
						if ($data_array1!="" && $counter==100)
						{
							//echo "insert into wo_pre_cos_emb_co_avg_con_dtls (".$field_array1.") values ".$data_array1;
							$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
							$counter=0;
							$data_array1="";
							$add_comma=0;
							if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
						}
					}

					if ($data_array1!="" && $counter!=100)
					{
						//echo "insert into wo_pre_cos_emb_co_avg_con_dtls (".$field_array1.") values ".$data_array1;
						$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
						$counter=0;
						$data_array1="";
						$add_comma=0;
						if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
					}
				}
				//CONS break down end===============================================================================================
			}
			if(str_replace("'",'',$$embupdateid)=="")
			{
				if ($add_co!=0) $data_array .=",";
				$data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cboembname.",".$$cboembtype.",".$$cboembbodypart.",".$$countryid.",'".$cboembsupplierid."',".$$txtembconsdzngmts.",".$$txtembrate.",".$$txtembamount.",".$$empbudgeton.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cboembstatus.",0)";
				//	CONS break down===============================================================================================
				if(str_replace("'",'',$$consbreckdownemb) !='')
				{
					$consbreckdown= $$consbreckdownemb;
				}
				else
				{
					$consbreckdown="'".create_consbreak_down_emb($update_id,str_replace("'",'',$$txtembconsdzngmts),str_replace("'",'',$$txtembrate),str_replace("'",'',$$txtembamount))."'";
				}
				if(str_replace("'",'',$consbreckdown) !='')
				{
					$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
					//$counter=0;
					for($c=0;$c < count($consbreckdown_array);$c++)
					{
						$counter++;
						$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
						//"id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id,item_number_id, color_number_id, size_number_id, requirment,rate,amount,color_size_table_id"
						//ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid;
						if ($add_comma!=0) $data_array1 .=",";
						$data_array1 .="(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."')";

						$id1=$id1+1;
						$add_comma++;
						if ($data_array1!="" && $counter==100)
						{
							$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
							$counter=0;
							$data_array1="";
							$add_comma=0;
							if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
						}
					}
					if ($data_array1!="" && $counter!=100)
					{
						$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
						$counter=0;
						$data_array1="";
						$add_comma=0;
						if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
					}
				}
				//CONS break down end===============================================================================================
				$id=$id+1;
				$add_co++;
			}
		}
		//echo "10**".bulk_update_sql_statement( "wo_pre_cost_embe_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ); die;
		$rID=execute_query(bulk_update_sql_statement( "wo_pre_cost_embe_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
		if($data_array !="")
		{
			$rID1=sql_insert("wo_pre_cost_embe_cost_dtls",$field_array,$data_array,0);
		}

		 //=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, emb_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtamountemb_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="emb_amount";
			$data_array2 ="".$txtamountemb_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		//=======================sum End =================
        check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{

			if($rID ){
				mysql_query("COMMIT");
				echo "1**".$new_job_no[0]."**".$rID;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "1**".$new_job_no[0]."**".$rID;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		disconnect($con);
		die;
	}
}
//*************************************************Embellishment Cost End ***********************************************
//*************************************************CM Cost Start **************************************
if ($action=="show_cm_cost_listview")
{
	$data=explode("_",$data);
	$costing_per=return_field_value("costing_per", "wo_pre_cost_mst", "job_no ='$data[0]'");
	if($costing_per==1) $header_td="1 Dzn";
	else if($costing_per==2) $header_td="1 Pcs";
	else if($costing_per==3) $header_td="2 Dzn";
	else if($costing_per==4) $header_td="3 Dzn";
	else if($costing_per==5) $header_td="4 Dzn";
	?>
		<h3 style="width:350px;" align="left" class="accordion_h" >CM Cost Details</h3>
		<div id="content_cm_cost">
        <fieldset style="width:350px">
            <form id="cm_cost_form" autocomplete="off">
            <table width="350" cellspacing="0" class="rpt_table" border="0" id="tbl_cm_cost" rules="all">
                <thead>
                    <tr>
                    	<th width="30">SL</th>
                        <th width="200">Particular</th>
                        <th width="100">Cost (<? echo $header_td ?>)</th>
                    </tr>
                </thead>
                <tbody>
					<?
                    $save_update=1;
                    //echo "select id, job_no, particular, rate from wo_pre_cost_cm_cost_dtls where status_active=1 and is_deleted=0 and job_no='$data[0]' order by id"; die;
                    $data_array=sql_select("select id, job_no, particular_id, cost from wo_pre_cost_cm_cost_dtls where status_active=1 and is_deleted=0 and job_no='$data[0]' order by id");

                    /*if(count($data_array)<1 && $data[2]==1)
                    {
						$data_array=sql_select("select id as pri_id, quotation_id, emb_name, emb_type, cons_dzn_gmts, rate, amount, status_active from wo_pri_quo_embe_cost_dtls where emb_name=3 and quotation_id='$data[1]'  and status_active=1 and is_deleted=0 order by id");// quotation_id='$data'
						$save_update=0;
                    }*/
                    if( count($data_array)>0)
                    {
						$i=0;
						foreach( $data_array as $row )
						{
							$i++;
							?>
							<tr id="cmcost_<?echo $i?>" align="center">
                                <td><? echo $i; ?></td>
                                <td><? echo $cm_cost_particular_arr[$row[csf('particular_id')]] ?>
                                <input type="hidden" id="txtparticular_<? echo $i; ?>" name="txtparticular_<? echo $i; ?>"  value="<? echo $row[csf("particular_id")]; ?>" />
                                <input type="hidden" id="txtcmdtlsid_<? echo $i; ?>" name="txtcmdtlsid_<? echo $i; ?>"  value="<? echo $row[csf("id")]; ?>" />
                                </td>
                                <td>
                                <input type="text" id="txtcmrate_<? echo $i; ?>" name="txtcmrate_<? echo $i; ?>" class="text_boxes_numeric" style="width:90px" onChange="calculate_cm_cost_dtls( <? echo $i;?> )" value="<? echo $row[csf("cost")]; ?>"/>
                                </td>
                                
                            </tr>
                            <?
						}
                    }
                    else
                    {
						$save_update=0; $i=0;
						$i++;
						foreach ($cm_cost_particular_arr as $key => $value) {						
						?>
						<tr id="cmcost_<?echo $i?>" align="center">
                            <td><? echo $key; ?></td>
                            <td><? echo $value; ?>
                            <input type="hidden" id="txtparticular_<? echo $key; ?>" name="txtparticular_<? echo $key; ?>" value="<? echo $key; ?>"/>
                            <input type="hidden" id="txtcmdtlsid_<? echo $key; ?>" name="txtcmdtlsid_<? echo $key; ?>"  value="" />
                            </td>
                            <td>
                            <input type="text" id="txtcmrate_<? echo $key; ?>" name="txtcmrate_<? echo $key; ?>" class="text_boxes_numeric" style="width:90px" onChange="calculate_cm_cost_dtls( <? echo $key;?> )" value="" />
                            </td>                            
                        </tr>
						<?
						}
                    }
                    ?>
                </tbody>
            </table>
            <table width="350" cellspacing="0" class="rpt_table" border="0" rules="all">
                <tfoot>
                    <tr>
                        <th width="30">&nbsp;</th>
                        <th width="200">Sum :</th>
                        <th width="100"><input type="text" id="txtratecm_sum" name="txtratecm_sum" class="text_boxes_numeric" style="width:90px" readonly /></th>
                    </tr>
                </tfoot>
            </table>
            <table width="350" cellspacing="0" class="" border="0">
                <tr>
                    <td align="center" height="15" width="100%"> </td>
                </tr>
                <tr>
                    <td align="center" width="100%" class="button_container">
                    <?
                    if ( count($data_array)>0)
                    {
                        echo load_submit_buttons( $permission, "fnc_cm_cost_dtls", $save_update,0,"reset_form('cm_cost_form','','',0)",7) ;
                    }
                    else
                    {
                        echo load_submit_buttons( $permission, "fnc_cm_cost_dtls", $save_update,0,"reset_form('cm_cost_form','','',0)",7) ;
                    }
                    ?>
                    </td>
                </tr>
            </table>
            </form>
        </fieldset>
	</div>

	<?


}

if ($action=="save_update_delete_cm_cost_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if($update_id){
		$approved=0;
		$sql=sql_select("select approved from wo_pre_cost_mst where job_no='$update_id'");
		foreach($sql as $row){
			$approved=$row[csf('approved')];
		}
		if($approved==1){
		echo "approved**".str_replace("'","",$update_id);
		disconnect($con);die;
		}
	}
	if($operation==0)
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		 $id=return_next_id( "id", "wo_pre_cost_cm_cost_dtls", 1 ) ;
		 $field_array="id, job_id, job_no, particular_id, cost, status_active, is_deleted, inserted_by, insert_date";
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cboparticular="txtparticular_".$i;
			 $rate="txtcmrate_".$i;
			 if ($i!=1) $data_array .=",";
			 $data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cboparticular.",".$$rate.",1,0,".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."')";
			 $id=$id+1;
		 }
		 //echo "10**INSERT INTO wo_pre_cost_cm_cost_dtls (".$field_array.") VALUES ".$data_array.""; die;
		 $rID=sql_insert("wo_pre_cost_cm_cost_dtls",$field_array,$data_array,0);
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "0**".$update_id."**".$rID;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$update_id."**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "0**".$update_id."**".$rID;
			}
			else{
				oci_rollback($con);
				echo "10**".$update_id."**".$rID;
			}
		}
		disconnect($con);
		die;
	}
	else if($operation==1)
	{
		$con = connect();
 		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
 		 $field_array_up="job_no*particular_id*cost*status_active*is_deleted*updated_by*update_date";

		 $add_co=0;

		 $col_lab=0;

		 for ($i=1;$i<=$total_row;$i++)
		 {
		 	$cboparticular="txtparticular_".$i;
			$rate="txtcmrate_".$i;
			$txtcmdtlsid="txtcmdtlsid_".$i;
			$id_arr[]=str_replace("'",'',$$txtcmdtlsid);

		 	$data_array_up[str_replace("'",'',$$txtcmdtlsid)] =explode(",",("".$update_id.",".$$cboparticular.",".$$rate.",1,0,".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."'"));
		 }
 		 $rID_up=execute_query(bulk_update_sql_statement( "wo_pre_cost_cm_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
		if($db_type==0)
		{

			if($rID_up ){
				mysql_query("COMMIT");
				echo "1**".$update_id."**".$rID_up;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$update_id."**".$rID_up;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID_up ){
				oci_commit($con);
				echo "1**".$update_id."**".$rID_up;
			}
			else{
				oci_rollback($con);
				echo "10**".$update_id."**".$rID_up;
			}
		}
		disconnect($con);
		die;
	}
}
//*************************************************CM Cost End ****************************************
//*************************************************Wash Cost Start ***********************************************

if ($action=="show_wash_cost_listview")
{
	$data=explode("_",$data);
	$header_td="";
	$costing_per=return_field_value("costing_per", "wo_pre_cost_mst", "job_no ='$data[0]'");
	if($costing_per==1) $header_td="Cons/ 1 Dzn Gmts";
	else if($costing_per==2) $header_td="Cons/ 1 Pcs Gmts";
	else if($costing_per==3) $header_td="Cons/ 2 Dzn Gmts";
	else if($costing_per==4) $header_td="Cons/ 3 Dzn Gmts";
	else if($costing_per==5) $header_td="Cons/ 4 Dzn Gmts";

	$conversion_from_chart=return_field_value("conversion_from_chart", "variable_order_tracking", "company_name='$data[3]'  and variable_list=21 and status_active=1 and is_deleted=0");
	if($conversion_from_chart=="") $conversion_from_chart=2;
	
	$component_approved=0;
	$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=4 and job_no='$data[0]'");
	foreach($sql as $row){
		if($row[csf('approved')]==1 || $row[csf('approved')]==3) { $component_approved=1; $approved_message="<marquee width='500'><p style='color:#f00; text-align:center;'> Approved</p></marquee>";}
	}
	$variArr=array();
	$sqlvari=sql_select("select embellishment_id,embellishment_budget_id from variable_order_tracking where company_name='$data[3]' and variable_list=56 and embellishment_id=3 and status_active=1 and is_deleted=0");
	foreach($sqlvari as $vari_row)
	{
		//$is_manula_approved=$sql_row[csf('pre_cost_approval')];
		$variArr[$vari_row[csf('embellishment_id')]]=$vari_row[csf('embellishment_budget_id')]?$vari_row[csf('embellishment_budget_id')]:2;
	}
	?>
    <h3 style="width:800px;" align="left" class="accordion_h" >+Wash Cost <?=$approved_message; ?></h3>
	<div id="content_embellishment_cost">
        <fieldset style="width:800px">
            <form id="wash_7" autocomplete="off">
            <table width="800" cellspacing="0" class="rpt_table" border="0" id="tbl_wash_cost" rules="all">
                <thead>
                    <tr>
                    	<th width="120">Name</th>
                        <th width="100">Type</th>
                        <th width="90">Country</th>
                        <th width="90"><?=$header_td; ?></th>
                        <th width="90">Rate</th>
                        <th width="100">Amount</th>
                        <th width="90">Status</th>
                        <th>&nbsp;</th>
                    </tr>
                </thead>
                <tbody>
					<?
                    $save_update=1;
                    $approved=return_field_value("approved", "wo_pre_cost_mst", "job_no='$data[0]'");
					if($approved==3) $approved=1;
					
                    if($approved==1 || $component_approved==1) $disabled=1; else $disabled=0;
                    $data_array=sql_select("select id, job_no, emb_name, emb_type, country, cons_dzn_gmts, rate, amount, status_active, budget_on from wo_pre_cost_embe_cost_dtls where emb_name=3 and job_no='$data[0]' order by id");
                    if(count($data_array)<1 && $data[2]==1 && $data[5]==2)//Price Quotation
                    {
						$data_array=sql_select("select id, quotation_id, emb_name, emb_type, cons_dzn_gmts, rate, amount, status_active from wo_pri_quo_embe_cost_dtls where emb_name=3 and quotation_id='$data[1]' order by id");
						$save_update=0;
                    }
					if (count($data_array)<1 && $data[2]==1 && $data[5]==7)//Quick Costing
					{
						$dataQc=sql_select("select id as pri_id, mst_id as quotation_id, 3 as emb_name, particular_type_id as emb_type, consumption, ex_percent, tot_cons as cons_dzn_gmts, rate, value as amount, status_active from qc_cons_rate_dtls where mst_id='$data[1]' and type=3 and tot_cons>0 and status_active=1 and is_deleted=0 order by id");
						$qcDataArr=array();
						foreach($dataQc as $erow)
						{
							$qcDataArr[$erow[csf('pri_id')]]=$erow[csf('cons_dzn_gmts')].'__'.$erow[csf('ex_percent')].'__'.$erow[csf('consumption')].'__'.$erow[csf('rate')].'__'.$erow[csf('amount')];
						}
						if (count($data_array) < 1)//Quick Costing
						{
							$data_array=$dataQc;
							$save_update=0;
						}
					}
                    if( count($data_array)>0)
                    {
						$i=0;
						foreach( $data_array as $row )
						{
							$i++;
							$country_text="";
							$countryarr=explode(",",$row[csf("country")]);
							for($cu=0 ;$cu< count($countryarr); $cu++){
								$country_text.= $country_library[trim($countryarr[$cu])].",";
							}
							$country_text=rtrim($country_text,",");
							?>
							<tr id="embellishment_<?=$i; ?>" align="center">
                                <td id="cboembnametd_<? echo $i;?>"><? echo create_drop_down( "cboembname_".$i, 120, $emblishment_name_array, "",1," -- Select Item --", $row[csf("emb_name")], "",1,'' ); ?></td>
                                <td id="embtypetd_<? echo $i;?>"><?  echo create_drop_down( "cboembtype_".$i, 100, $emblishment_wash_type,"", 1, "-- Select --", $row[csf("emb_type")], "check_duplicate_wash(".$i.")",$disabled,"" ); ?></td>
                                <td>
                                    <input type="text" id="countrytext_<?=$i; ?>" name="countrytext_<?=$i; ?>" class="text_boxes" style="width:78px" value="<?=$country_text;  ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> onDblClick="open_country_popup('<?=$i.'_2'; ?>');" placeholder="Browse" readonly/>
                                    <input type="hidden" id="country_<?=$i; ?>" name="country_<?=$i; ?>" class="text_boxes" style="width:70px" value="<?=$row[csf("country")]; ?>" />
                            	</td>
                                <td id="txtembconsdzngmtstd_<?=$i;?>">
                                <input type="text" id="txtembconsdzngmts_<?=$i; ?>" name="txtembconsdzngmts_<?=$i; ?>" class="text_boxes_numeric" style="width:78px" value="<?= $row[csf("cons_dzn_gmts")]; ?>" onChange="calculate_wash_cost(<?=$i;?>);" onDblClick="set_session_large_post_data_wash('requires/pre_cost_entry_controller_v2.php?action=consumption_popup_wash','Consumption Entry Form',<?=$i;?>);" placeholder="Browse" readonly/></td>
                                <td id="txtembratetd_<?=$i;?>">
                                <input type="text" id="txtembrate_<? echo $i; ?>" name="txtembrate_<? echo $i; ?>" class="text_boxes_numeric" style="width:78px" value="<? echo $row[csf("rate")]; ?>" onChange="calculate_wash_cost( <? echo $i;?> )" <? if($disabled==0){echo "";}else{echo "disabled";}?> readonly/>
                                </td>
                                <td id="txtembamounttd_<? echo $i;?>">
                                <input type="text" id="txtembamount_<? echo $i; ?>" name="txtembamount_<? echo $i; ?>" class="text_boxes_numeric" style="width:88px" value="<? echo $row[csf("amount")]; ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> readonly/>
                                </td>
                                <td id="cboembstatustd_<? echo $i;?>"><? echo create_drop_down( "cboembstatus_".$i, 90, $row_status,"", 0, "0", $row[csf("status_active")], '',$disabled,'' );  ?></td>
                                <td id="buttontd_<? echo $i;?>">
                                <input type="button" id="increaseemb_<? echo $i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_wash_cost(<? echo $i; ?>,<? echo $conversion_from_chart; ?> )"  <? if($disabled==0){echo "";}else{echo "disabled";}?>/>
                                <input type="button" id="decreaseemb_<? echo $i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<? echo $i; ?> ,'tbl_wash_cost' );" <? if($disabled==0){echo "";}else{echo "disabled";}?> />
                                <input type="hidden" id="embupdateid_<? echo $i; ?>" name="embupdateid_<? echo $i; ?>"  class="text_boxes" style="width:20px" value="<? echo  $row[csf("id")]; ?>"  />
                                <input type="hidden" id="embratelibid_<? echo $i; ?>" name="embratelibid_<? echo $i; ?>"  class="text_boxes" style="width:20px" value="<? echo  $row[csf("charge_lib_id")]; ?>"  />
                                <input type="hidden" id="consbreckdownwash_<? echo $i; ?>" name="consbreckdownwash_<? echo $i; ?>"  class="text_boxes" style="width:20px" value="<? //echo  $row[csf("id")]; ?>"  />
                                <input type="hidden" id="empbudgeton_<? echo $i; ?>" name="empbudgeton_<? echo $i; ?>"  class="text_boxes" style="width:20px" value="<? if($row[csf("budget_on")]){echo  $row[csf("budget_on")];}else{ echo $variArr[3]; } ?>"  />
                                </td>
                            </tr>
                            <?
						}
                    }
                    else
                    {
						$save_update=0; $i=0;
						$i++;
						?>
						<tr id="embellishment_1" align="center">
                            <td id="cboembnametd_<? echo $i;?>"><? echo create_drop_down( "cboembname_".$i, 120, $emblishment_name_array, "",1,"--Select--", 3, "",1,''); ?></td>
                            <td id="embtypetd_<? echo $i;?>"><? echo create_drop_down( "cboembtype_".$i, 100, $emblishment_wash_type,"", 1, "-- Select --", "", "check_duplicate_wash(".$i.")","","" ); ?></td>
                            <td>
                                <input  type="text" id="countrytext_<? echo $i; ?>" name="countrytext_<? echo $i; ?>" class="text_boxes" style="width:78px" value="" onDblClick="open_country_popup('<? echo $i.'_1'; ?>')" placeholder="Browse" readonly/>
                                <input type="hidden" id="country_<? echo $i; ?>" name="country_<? echo $i; ?>" class="text_boxes" style="width:75px" value="" />
                            </td>
                            <td id="txtembconsdzngmtstd_<? echo $i;?>">
                            	<input type="text" id="txtembconsdzngmts_<? echo $i; ?>" name="txtembconsdzngmts_<? echo $i; ?>" class="text_boxes_numeric" style="width:78px" value="" onChange="calculate_wash_cost( <? echo $i;?> )" onDblClick="set_session_large_post_data_wash('requires/pre_cost_entry_controller_v2.php?action=consumption_popup_wash', 'Consumption Entry Form',<? echo $i;?>)" placeholder="Browse" readonly />
                            </td>
                            <td id="txtembratetd_<? echo $i;?>">
                            	<input type="text" id="txtembrate_<? echo $i; ?>"  name="txtembrate_<? echo $i; ?>" class="text_boxes_numeric" style="width:78px" value="" onChange="calculate_wash_cost( <? echo $i;?> )" readonly />
                            </td>
                            <td id="txtembamounttd_<? echo $i;?>"><input type="text" id="txtembamount_<? echo $i; ?>"  name="txtembamount_<? echo $i; ?>" class="text_boxes_numeric" style="width:88px" value="" readonly /></td>
                            <td id="cboembstatustd_<? echo $i;?>"><? echo create_drop_down( "cboembstatus_".$i, 90, $row_status,"", 0, "0", '', '','','' );  ?></td>
                            <td id="buttontd_<? echo $i;?>">
                                <input type="button" id="increaseemb_<? echo $i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_wash_cost(<? echo $i; ?>,<? echo $conversion_from_chart; ?>)" />
                                <input type="button" id="decreaseemb_<? echo $i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<? echo $i; ?> ,'tbl_wash_cost');" />
                                <input type="hidden" id="embupdateid_<? echo $i; ?>" name="embupdateid_<? echo $i; ?>"  class="text_boxes" style="width:20px" value=""  />
                                <input type="hidden" id="embratelibid_<? echo $i; ?>" name="embratelibid_<? echo $i; ?>"  class="text_boxes" style="width:20px"  readonly/>
                                <input type="hidden" id="consbreckdownwash_<? echo $i; ?>" name="consbreckdownwash_<? echo $i; ?>" class="text_boxes" style="width:20px" value="" />
                                <input type="hidden" id="empbudgeton_<? echo $i; ?>" name="empbudgeton_<? echo $i; ?>"  class="text_boxes" style="width:20px" value="<? echo $variArr[3];?>"  />
                            </td>
						</tr>
						<?
                    }
                    ?>
                </tbody>
            </table>
            <table width="800" cellspacing="0" class="rpt_table" border="0" rules="all">
                <tfoot>
                    <tr>
                    	<th width="120">&nbsp;</th>
                        <th width="100">&nbsp;</th>
                        <th width="90">&nbsp;</th>
                        <th width="90">&nbsp;</th>
                        <th width="90">Sum :</th>
                        <th width="100"><input type="text" id="txtamountemb_sum" name="txtamountemb_sum" class="text_boxes_numeric" style="width:88px" readonly /></th>
                        <th width="90">&nbsp;</th>
                        <th>&nbsp;</th>
                    </tr>
                </tfoot>
            </table>
            <table width="800" cellspacing="0" class="" border="0">
                <tr>
                    <td align="center" height="15" width="100%"> </td>
                </tr>
                <tr>
                    <td align="center" width="100%" class="button_container">
                    <?
                    if ( count($data_array)>0)
                    {
                        echo load_submit_buttons( $permission, "fnc_wash_cost_dtls", $save_update,0,"reset_form('wash_7','','',0)",7) ;
                    }
                    else
                    {
                        echo load_submit_buttons( $permission, "fnc_wash_cost_dtls", $save_update,0,"reset_form('wash_7','','',0)",7) ;
                    }
                    ?>
                    </td>
                </tr>
            </table>
            </form>
        </fieldset>
	</div>
	<?
	exit();
}

if($action=="wash_chart_popup")
{
	echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
		function js_set_value(id,rate)
		{
			//var data=data.split("_");
			document.getElementById('charge_id').value=id;
			document.getElementById('charge_value').value=rate;
			parent.emailwindow.hide();
		}

		function toggle( x, origColor )
		{
			var newColor = 'yellow';
			document.getElementById(x).style.backgroundColor = ( newColor == document.getElementById(x).style.backgroundColor )? origColor : newColor;
		}
	</script>
	</head>
	<body>
        <div align="center">
        	<form>
                <input type="hidden" id="charge_id" name="charge_id" />
                <input type="hidden" id="charge_value" name="charge_value" />
                <?
					$company_arr=return_library_array( "select id, company_name from lib_company",'id','company_name');
					$color_library_arr=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
					$arr=array (0=>$company_arr,2=>$process_type,3=>$conversion_cost_head_array,4=>$color_library_arr,5=>$fabric_typee,7=>$unit_of_measurement,8=>$production_process,9=>$row_status);
                ?>
                <table width="900" class="rpt_table" border="1" rules="all" cellpadding="0" cellspacing="0">
                    <thead>
                        <th width="50">SL</th>
                        <th width="100">Company Name</th>
                        <th width="150">Const. Compo.</th>
                        <th width="70">Process Type</th>
                        <th width="70">Process Name</th>
                        <th width="70">Color</th>
                        <th width="80">Width/Dia type</th>
                        <th width="60">In House Rate</th>
                        <th width="80">UOM</th>
                        <th width="60">Rate type</th>
                        <th>Status</th>
                    </thead>
                </table>
                <div style=" width:917; overflow:scroll-y; max-height:300px">
                    <table width="900" class="rpt_table" border="1" rules="all" id="list_view" cellpadding="0" cellspacing="0">
						<?
                        $sql_data=sql_select("select id, comapny_id, const_comp, process_type_id, process_id, color_id, width_dia_id, in_house_rate, uom_id, rate_type_id, status_active from lib_subcon_charge where status_active=1 and is_deleted=0 and rate_type_id =7 and comapny_id=$cbo_company_name");

                        $i=1;
                        foreach($sql_data as $row)
                        {
							if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
							?>
							<tr bgcolor="<? echo $bgcolor; ?>" onClick="js_set_value(<? echo $row[csf("id")]?>, <? echo $row[csf("in_house_rate")]; ?>)" id="tr_<? echo $row[csf("id")]; ?>">
                                <td width="50"><? echo $i; ?></td>
                                <td width="100"><? echo $company_arr[$row[csf("comapny_id")]]; ?></td>
                                <td width="150"><? echo $row[csf("const_comp")]; ?></td>
                                <td width="70"><? echo $process_type[$row[csf("process_type_id")]]; ?></td>
                                <td width="70"><? echo $conversion_cost_head_array[$row[csf("process_id")]]; ?></td>
                                <td width="70"><? echo $color_library_arr[$row[csf("color_id")]]; ?></td>
                                <td width="80"><? echo $fabric_typee[$row[csf("width_dia_id")]]; ?></td>
                                <td width="60"><? echo $row[csf("in_house_rate")]; ?></td>
                                <td width="80"><? echo $unit_of_measurement[$row[csf("uom_id")]]; ?></td>
                                <td width="60"><? echo $production_process[$row[csf("rate_type_id")]]; ?></td>
                                <td><? echo $row_status[$row[csf("status_active")]]; ?></td>
							</tr>
							<?
							$i++;
                        }
                        ?>
                        <script>
							setFilterGrid("list_view",-1)
							toggle( "tr_"+"<? echo $ratelibid ?>", '#FFFFCC');
                        </script>
                    </table>
                </div>
            </form>
        </div>
	</body>
	</html>
	<?
	exit();
}

if($action=="save_post_session_wash"){
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$_SESSION['logic_erp']['cons_breck_downn_wash']="";
	$_SESSION['logic_erp']['cons_breck_downn_wash']=$cons_breck_downn_wash;
	echo 1;
	die;
}

if($action=="consumption_popup_wash")
{
	echo load_html_head_contents("Consumption Entry","../../../", 1, 1, $unicode,'','');
	extract($_REQUEST);
	$cons_breck_downn= $_SESSION['logic_erp']['cons_breck_downn_wash'];
	$itemqty_array=array();
	$job_plancut_qty=0;
	$country=rtrim($country,",");
	if($country=="") $country_cond=""; else $country_cond=" and c.country_id in($country)";

	$data_array_tot_job_qty=sql_select("select b.id, b.po_number, c.item_number_id, c.color_number_id, c.size_number_id, min(c.id) as color_size_table_id, min(color_order) as color_order, min(size_order) as size_order, sum(plan_cut_qnty) as plan_cut_qnty, sum(c.order_quantity) as order_quantity from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id  and b.job_no_mst='$txt_job_no' and a.garments_nature='$garments_nature' and a.status_active=1 and b.status_active=1 and c.status_active=1 $country_cond group by b.id, b.po_number, c.item_number_id, c.color_number_id, c.size_number_id order by b.id, c.item_number_id, color_order, size_order");
	foreach($data_array_tot_job_qty as $data_array_tot_job_qty_row )
	{
		//$itemqty_array[$data_array_tot_job_qty_row[csf('item_number_id')]]+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
		//$job_plancut_qty+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
		//$po_no_library[$data_array_tot_job_qty_row[csf('id')]]=$data_array_tot_job_qty_row[csf('po_number')];
		if($empbudgeton==1){
			$itemqty_array[$data_array_tot_job_qty_row[csf('item_number_id')]]+=$data_array_tot_job_qty_row[csf('order_quantity')];
			$job_plancut_qty+=$data_array_tot_job_qty_row[csf('order_quantity')];
		}
		else if($empbudgeton==2){
			$itemqty_array[$data_array_tot_job_qty_row[csf('item_number_id')]]+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
			$job_plancut_qty+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
		}else{
			$itemqty_array[$data_array_tot_job_qty_row[csf('item_number_id')]]+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
			$job_plancut_qty+=$data_array_tot_job_qty_row[csf('plan_cut_qnty')];
		}
		$po_no_library[$data_array_tot_job_qty_row[csf('id')]]=$data_array_tot_job_qty_row[csf('po_number')];
	}
	$item_idarr=explode(",",$item_id);
	$total_item=count($item_idarr);
	if($israte_popup==2)
	{
		$conversion_from_chart=return_field_value("conversion_from_chart", "variable_order_tracking", "company_name=$cbo_company_id and variable_list=21 and status_active=1 and is_deleted=0");
	}
	else $conversion_from_chart=2;

	$country_array=array();
	$data_country=sql_select("select b.id, b.po_number,c.item_number_id,c.color_number_id,c.size_number_id ,c.country_id from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and b.job_no_mst='$txt_job_no' $country_cond and a.status_active=1 and b.status_active=1 and c.status_active=1");
	foreach($data_country as $cou_row){
		 $country_array[$cou_row[csf('id')]][$cou_row[csf('item_number_id')]][$cou_row[csf('color_number_id')]][$cou_row[csf('size_number_id')]]['country_id'][$cou_row[csf('country_id')]]=$cou_row[csf('country_id')];
		 $country_array[$cou_row[csf('id')]][$cou_row[csf('item_number_id')]][$cou_row[csf('color_number_id')]][$cou_row[csf('size_number_id')]]['country_name'][$cou_row[csf('country_id')]]=$country_library[$cou_row[csf('country_id')]];
	}
	?>
	<script>
		var conversion_from_chart = '<?=$conversion_from_chart*1; ?>';
		function copy_value(value,field_id,i)
		{
			//var copy_val=document.getElementById('copy_val').checked;
			var gmtssizesid=document.getElementById('gmtssizesid_'+i).value;
			var pocolorid=document.getElementById('pocolorid_'+i).value;
			var ponoid=document.getElementById('ponoid_'+i).value;
			var cbogmtsitem=document.getElementById('cbogmtsitem_'+i).value;
			var librateid=document.getElementById('ratelibid_'+i).value;
			//alert(librateid);
			var rowCount = $('#tbl_consmption_cost tr').length-1;
			var copy_basis=$('input[name="copy_basis"]:checked').val()
			for(var j=i; j<=rowCount; j++)
			{
				if(document.getElementById('approved_'+j).value==0){
					if(field_id=='rate_'){
						if(copy_basis==0){
							document.getElementById(field_id+j).value=value;
							document.getElementById('ratelibid_'+j).value=librateid;
							claculate_amount(j);
						}
						else if(copy_basis==1){
							if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0){
								document.getElementById(field_id+j).value=value;
								document.getElementById('ratelibid_'+j).value=librateid;
								claculate_amount(j);
							}
						}
						else if(copy_basis==2){
							if( pocolorid==document.getElementById('pocolorid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0){
								document.getElementById(field_id+j).value=value;
								document.getElementById('ratelibid_'+j).value=librateid;
								claculate_amount(j);
							}
						}
						else if(copy_basis==3){
							if( cbogmtsitem==document.getElementById('cbogmtsitem_'+j).value && (document.getElementById('requirement_'+j).value*1) >0){
								document.getElementById(field_id+j).value=value;
								document.getElementById('ratelibid_'+j).value=librateid;
								claculate_amount(j);
							}
						}
						else if(copy_basis==4){
							if( ponoid==document.getElementById('ponoid_'+j).value && (document.getElementById('requirement_'+j).value*1) >0){
								document.getElementById(field_id+j).value=value;
								document.getElementById('ratelibid_'+j).value=librateid;
								claculate_amount(j);
							}
						}
					}

					if(field_id=='requirement_'){
						if(copy_basis==0){
							document.getElementById(field_id+j).value=value;
							claculate_amount(j) ;
						}
						else if(copy_basis==1){
							if( gmtssizesid==document.getElementById('gmtssizesid_'+j).value){
								document.getElementById(field_id+j).value=value;
								claculate_amount(j);
							}
						}
						else if(copy_basis==2){
							if( pocolorid==document.getElementById('pocolorid_'+j).value){
								document.getElementById(field_id+j).value=value;
								claculate_amount(j);
							}
						}
						else if(copy_basis==3){
							if( cbogmtsitem==document.getElementById('cbogmtsitem_'+j).value){
								document.getElementById(field_id+j).value=value;
								claculate_amount(j);
							}
						}
						else if(copy_basis==4){
							if( ponoid==document.getElementById('ponoid_'+j).value){
								document.getElementById(field_id+j).value=value;
								claculate_amount(j);
							}
						}
					}
				}//if(var approved=document.getElementById('approved_'+j).value==0)
			}
		}

		function fn_delete_down_tr(rowNo,table_id)
		{
			if(table_id=='tbl_consmption_cost')
			{
				var numRow = $('table#tbl_consmption_cost tbody tr').length;

				if(numRow==rowNo && rowNo!=1)
				{
					$('#tbl_consmption_cost tbody tr:last').remove();
					$('#tbl_msmnt_cost tbody tr:last').remove();
				}
				set_sum_value( 'requirement_sum', 'requirement_');
				set_sum_value( 'rate_sum', 'rate_');
				set_sum_value( 'amount_sum', 'amount_');
			}
		}

		function set_sum_value(des_fil_id,field_id)
		{
			if(des_fil_id=='requirement_sum') var ddd={dec_type:5,comma:0};
			if(des_fil_id=='amount_sum') var ddd={dec_type:5,comma:0};
			if(des_fil_id=='rate_sum') var ddd={dec_type:5,comma:0};

			var rowCount = $('#tbl_consmption_cost tr').length-1;
			math_operation( des_fil_id, field_id, '+', rowCount,ddd );
			claculate_avg();
		}

		function js_set_value()
		{
			var rowCount = $('#tbl_consmption_cost tr').length-1;
			var cons_breck_down="";
			for(var i=1; i<=rowCount; i++)
			{
				var ponoid=$('#ponoid_'+i).val(); if(ponoid=='') ponoid=0;
				var cbogmtsitem=$('#cbogmtsitem_'+i).val(); if(cbogmtsitem=='') cbogmtsitem=0;
				var pocolorid=$('#pocolorid_'+i).val(); if(pocolorid=='') pocolorid=0;
				var gmtssizesid=$('#gmtssizesid_'+i).val(); if(gmtssizesid=='') gmtssizesid=0;
				var requirement=$('#requirement_'+i).val(); if(requirement=='') requirement=0;
				var colorsizetableid=$('#colorsizetableid_'+i).val(); if(colorsizetableid=='') colorsizetableid=0;
				var rate=$('#rate_'+i).val(); if(rate=='') rate=0;
				var amount=$('#amount_'+i).val(); if(amount=='') amount=0;
				var ratelibid=$('#ratelibid_'+i).val(); if(ratelibid=='') ratelibid=0;
				var cbocountry=$('#cbocountry_'+i).val(); if(cbocountry=='') cbocountry=0;

				if(cons_breck_down=="")
				{
					cons_breck_down+=ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid+'_'+ratelibid+'_'+cbocountry;
				}
				else
				{
					cons_breck_down+="__"+ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid+'_'+ratelibid+'_'+cbocountry;
				}
			}
			document.getElementById('cons_breck_down').value=cons_breck_down;
			claculate_avg();
			parent.emailwindow.hide();
		}

		function claculate_avg()
		{
			var tot_plancut_qty=document.getElementById('job_plancut_qty').value*1
			var item_ratio=document.getElementById('item_ratio').value*1
			var calculated_cons=0; var avg_cons=0; var plancutqty=0; var calculated_amount=0;
			var rowCount = $('#tbl_consmption_cost tr').length-1;

			/*for(var j=1; j<=rowCount; j++){
			if(document.getElementById('requirement_'+j).value =='' || document.getElementById('requirement_'+j).value ==0){
			continue;
			}
			else{
			//plancutqty+=document.getElementById('pcsgmts_'+j).value*1;
			}
			}*/

			for(var i=1; i<=rowCount; i++)
			{
				if(document.getElementById('requirement_'+i).value =='' || document.getElementById('requirement_'+i).value ==0){
					continue;
				}
				else{
					//var tot_plancut_qty=document.getElementById('itempcsgmts_'+i).value*1
					var pcsgmts=document.getElementById('pcsgmts_'+i).value*1
					var plan_cut_percent=(pcsgmts/tot_plancut_qty)*100;
					var requirement=document.getElementById('requirement_'+i).value*1
					var calculated_cons_percent=(requirement*plan_cut_percent)/100;
					calculated_cons+=calculated_cons_percent;
					var amount=document.getElementById('amount_'+i).value*1
					var calculated_amount_percent=(amount*plan_cut_percent)/100;
					calculated_amount+=calculated_amount_percent;
				}
			}
			document.getElementById('calculated_cons').value=number_format_common(calculated_cons, 5, 0);
			document.getElementById('calculated_amount').value=number_format_common(calculated_amount, 5, 0);
			document.getElementById('calculated_rate').value=number_format_common(calculated_amount/calculated_cons, 5, 0);
		}

		function claculate_amount(i)
		{
			var rate=document.getElementById('rate_'+i).value;
			var requirement=document.getElementById('requirement_'+i).value;
			var amount= requirement*rate;
			document.getElementById('amount_'+i).value=number_format_common(amount,5,0);
			set_sum_value( 'amount_sum', 'amount_' );
			claculate_avg();
		}

		function fnc_conversion_from_chart()
		{
			var rowCount = $('#tbl_consmption_cost tr').length-1;
			for(var i=1; i<=rowCount; i++)
			{
				if(conversion_from_chart==1)
				{
					$('#rate_'+i).removeAttr("onDblClick").attr("onDblClick","set_wash_charge_unit_pop_up("+i+")");
					$('#rate_'+i).attr("placeholder","Browse");
					$('#rate_'+i).attr('readonly','readonly');
				}
				else
				{
					$('#rate_'+i).removeAttr("onDblClick");
					$('#rate_'+i).attr("placeholder","Write");
					$('#rate_'+i).removeAttr('readonly','readonly');
				}
			}
		}

		function set_wash_charge_unit_pop_up(i)
		{
			var cbo_company_name=document.getElementById('cbo_company_id').value;
			//var cbotypeconversion=document.getElementById('cbotypeconversion_'+i).value
			var txt_exchange_rate=document.getElementById('txt_exchange_rate').value;
			var ratelibid=document.getElementById('ratelibid_'+i).value;


			if(txt_exchange_rate==0 || txt_exchange_rate=="")
			{
				alert("Select Exchange Rate");
				return;
			}
			else
			{
				var page_link='pre_cost_entry_controller_v2.php?action=wash_chart_popup&cbo_company_name='+cbo_company_name+'&ratelibid='+ratelibid;;
				emailwindow=dhtmlmodal.open('EmailBox', 'iframe', page_link, 'Conversion Chart', 'width=1060px,height=450px,center=1,resize=1,scrolling=0','')
				emailwindow.onclose=function()
				{
					var charge_id=this.contentDoc.getElementById("charge_id");
					var charge_value=this.contentDoc.getElementById("charge_value");

					document.getElementById('ratelibid_'+i).value=charge_id.value;
					document.getElementById('rate_'+i).value=number_format_common(charge_value.value/txt_exchange_rate,5,0,document.getElementById('cbo_currercy').value);
					claculate_amount( i );
					var rate=$('#rate_'+i).val();
					copy_value(rate,'rate_',i);
				}
			}
		}
	</script>
	</head>
	<body>
        <div align="center" style="width:99%;" >
        <fieldset>
        <legend><?=$body_part_id.'.'.$body_part[$body_part_id].'   Costing '.$costing_per[$cbo_costing_per]; ?></legend>
            <form id="consumptionform_1" autocomplete="off">
                <input type="hidden" id="cbo_company_id" name="cbo_company_id" value="<? echo $cbo_company_id; ?>"/>
                <input type="hidden" id="cbo_costing_per_id" name="cbo_costing_per_id" value="<? echo $cbo_costing_per; ?>"/>
                <input type="hidden" id="cons_breck_down" name="cons_breck_down"  width="500"  value="<? echo $cons_breck_downn;?>"/>
                <input type="hidden" id="job_plancut_qty" name="job_plancut_qty" value="<? echo $job_plancut_qty; ?>"/>
                <input type="hidden" id="item_ratio" name="item_ratio" value="<? echo $tot_set_qnty; ?>"/>
                <input type="hidden" id="txt_exchange_rate" name="txt_exchange_rate" value="<? echo $txt_exchange_rate; ?>"/>
                <input type="hidden" id="cbo_currercy" name="cbo_currercy" value="<? echo $cbo_currercy; ?>"/>
                <!-- <b>Copy</b> : <input type="checkbox" id="copy_val" name="copy_val" checked/>  -->
                <input type="radio" name="copy_basis" value="0" checked>Copy To All
                <input type="radio" name="copy_basis" value="1">Copy Size Wise
                <input type="radio" name="copy_basis" value="2">Copy Color Wise
                <input type="radio" name="copy_basis" value="3">Copy Item Wise
                <input type="radio" name="copy_basis" value="4">Copy Po Wise
                <input type="reset" value="Reset">
            </form>
            <table width="850" cellspacing="0" class="rpt_table" border="0" id="tbl_consmption_cost" rules="all">
                <thead>
                    <tr>
                    	<th width="30">SL</th>
                        <th width="120">PO NO</th>
                        <th width="120">Country</th>
                        <th width="120">Gmts.Item</th>
                        <th width="100">Gmts Color</th>
                        <th width="80">Gmts Size</th>
                        <th width="75">Cons</th>
                        <th width="60">Rate</th>
                        <th width="90">Amount</th>
                    	<th>&nbsp;</th>
                    </tr>
                </thead>
                <tbody>
					<?
					$component_approved=0;
					$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=1 and job_no='$txt_job_no'");
					foreach($sql as $row){
						if($row[csf('approved')]==1 || $row[csf('approved')]==3) { $component_approved=1; }
					}
                    $data_array=explode("__",$cons_breck_downn);
                    if($data_array[0]==""){
                    	$data_array=array();
                    }
                    $data_array=sql_select("select b.id, b.po_number, c.item_number_id, c.color_number_id, c.size_number_id, min(c.id) as color_size_table_id, min(color_order) as color_order, min(size_order) as size_order, sum(plan_cut_qnty) as plan_cut_qnty, sum(c.order_quantity) as order_quantity from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id  and b.job_no_mst='$txt_job_no' and a.garments_nature='$garments_nature' and a.status_active=1 and b.status_active=1 and c.status_active=1 $country_cond group by b.id, b.po_number, c.item_number_id, c.color_number_id, c.size_number_id order by b.id, c.item_number_id, color_order, size_order");
                    //=======================================
                    if($embupdateid != ""){
						$row_arr_data="";
						$wo_pre_cos_fab_co_avg_con_dtls_data=sql_select("select id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id, item_number_id, color_number_id, size_number_id, requirment, rate, amount, color_size_table_id, rate_lib_id, country_id from wo_pre_cos_emb_co_avg_con_dtls where job_no='$txt_job_no' and pre_cost_emb_cost_dtls_id=$embupdateid order by id");
						foreach($wo_pre_cos_fab_co_avg_con_dtls_data as $wrow)
						{
							$row_arr=$wrow[csf('po_break_down_id')]."_".$wrow[csf('item_number_id')]."_".$wrow[csf('color_number_id')]."_".$wrow[csf('size_number_id')]."_".$wrow[csf('requirment')]."_".$wrow[csf('rate')]."_".$wrow[csf('amount')]."_".$wrow[csf('color_size_table_id')]."_".$wrow[csf('rate_lib_id')]."_".$wrow[csf('country_id')];
							$row_arr_data.=$row_arr."__";
						}
						$row_arr_data=rtrim($row_arr_data,"__");
						$data_array_cons=explode("__",$row_arr_data);
                    }

                    if($embupdateid == ""){
						$data_array_cons=explode("__",$cons_breck_downn);
						//print_r($data_array_cons);
                    }

                    if($precostapproved==1 || $component_approved==1) $disabled=1; else $disabled=0;
                    //=======================================
                    if ( count($data_array)>0)
					{
						$i=0;
						foreach( $data_array as $row )
						{
							$data=explode('_',$data_array_cons[$i]);
							$i++;
							if($empbudgeton==1) $pcsgmts=$row[csf('order_quantity')]; else if($empbudgeton==2) $pcsgmts=$row[csf('plan_cut_qnty')]; else $pcsgmts=$row[csf('plan_cut_qnty')];
							$country_string=implode(",",$country_array[$row[csf('id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['country_id']);
							$country_string_name=implode(",",$country_array[$row[csf('id')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['country_name']);

							$po_country_arr=explode(",",$country_string);


							$countrydata=explode(",",$data[9]);
							$arr_d=array_diff($countrydata, $po_country_arr);
							$arr_d2=array_diff($countrydata, $arr_d);
							$country_name="";

							for($countryindex=0; $countryindex < count($arr_d2);$countryindex++){
								$country_name.=	$country_library[$countrydata[$countryindex]].",";
							}
							$country_idstring=implode(",",$arr_d2);

							if(count($arr_d)>0 && count($countrydata)>0 )
							{
								$country_name_pre="";
								for($countryindex=0; $countryindex < count($arr_d);$countryindex++){
									$country_name_pre.=	$country_library[$countrydata[$countryindex]].",";
								}
								$title="Country have Changed in po entry, you have to update this field, Previous Country was ".rtrim($country_name_pre,",")."";
								if(rtrim($country_name_pre,",")!=""){
									$bgc="#D41F00";
								}
							}
							else{
								$title=""; $bgc="#FFFFFF";
							}
							?>
							<tr id="break_<?=$i; ?>" align="center">
                                <td><?=$i; ?></td>
                                <td>
                                    <input type="text" id="pono_<?=$i; ?>" name="pono_<?=$i; ?>" class="text_boxes" style="width:107px" value="<?=$row[csf('po_number')]; ?>" readonly />
                                    <input type="hidden" id="ponoid_<?=$i;?>" name="ponoid_<?=$i;?>" class="text_boxes" style="width:85px" value="<?=$row[csf('id')]; ?>" readonly />
                                </td>
                                <td>
                                    <input type="hidden" id="cbocountry_<? echo $i;?>" name="cbocountry_<? echo $i;?>" style="width:75px" value="<? echo $country_string; ?>" readonly />
                                    <input type="text" id="cbocountryname_<?=$i;?>" name="cbocountryname_<?=$i;?>" onClick="open_country_popup('<?=$i.'_2'; ?>')" class="text_boxes" style="width:107px; background-color:<?=$bgc; ?>" value="<?=$country_string_name; ?>" readonly title="<?=$title; ?>" disabled />
                                </td>
                                <td><?=create_drop_down( "cbogmtsitem_".$i, 120, $garments_item,"", 0, "",$row[csf('item_number_id')], "",""); ?></td>
                                <td>
                                    <input type="text" id="pocolor_<? echo $i;?>" name="pocolor_<? echo $i;?>" class="text_boxes" style="width:87px" value="<? echo $color_library[$row[csf('color_number_id')]]; ?>" readonly />
                                    <input type="hidden" id="pocolorid_<? echo $i;?>" name="pocolorid_<? echo $i;?>" class="text_boxes" style="width:85px" value="<? echo $row[csf('color_number_id')]; ?>" readonly/>
                                </td>
                                <td>
                                    <input type="text" id="gmtssizes_<? echo $i;?>" name="gmtssizes_<? echo $i;?>" class="text_boxes" style="width:67px" value="<? echo $size_library[$row[csf('size_number_id')]]; ?>" readonly>
                                    <input type="hidden" id="gmtssizesid_<? echo $i;?>" name="gmtssizesid_<? echo $i;?>" class="text_boxes" style="width:45px" value="<? echo $row[csf('size_number_id')]; ?>" readonly />
                                </td>
                                <td>
                                	<input type="text" id="requirement_<? echo $i;?>" onChange="claculate_amount(<? echo $i;?>);copy_value(this.value,'requirement_',<? echo $i;?>);set_sum_value( 'requirement_sum', 'requirement_' )"  name="requirement_<? echo $i;?>" class="text_boxes_numeric" style="width:62px" value="<? if ($data[4]==""){ echo $price_quatation_requirment[$row[csf('size_number_id')]];} else { echo $data[4]; } ?>" <? if($disabled==1){ echo "disabled";} else{ echo "";} ?> />
                                </td>
                                <td>
                                	<input type="text" id="rate_<? echo $i;?>" name="rate_<? echo $i;?>" onChange="claculate_amount(<? echo $i;?>); copy_value(this.value,'rate_',<? echo $i;?>)" onBlur="set_sum_value( 'rate_sum', 'rate_') " class="text_boxes_numeric" style="width:47px"  value="<? echo $data[5]; ?>" <? if($disabled==1){ echo "disabled";} else{ echo "";} ?>/>
                                    <input type="hidden" id="ratelibid_<? echo $i;?>" name="ratelibid_<? echo $i;?>" value="<? echo $row[csf('rate_lib_id')]; ?>"/>

                                </td>
                                <td>
                                	<input type="text" id="amount_<? echo $i;?>"  name="amount_<? echo $i;?>"   class="text_boxes_numeric" style="width:77px"  value="<? echo $data[6]; ?>" readonly />
                                </td>
                                <td id="add_<?=$i; ?>">
                                    <input type="hidden" id="pcsgmts_<? echo $i;?>" name="pcsgmts_<? echo $i;?>"  onBlur="set_sum_value( 'pcs_sum', 'pcs_' );" class="text_boxes_numeric" style="width:25px"  value="<? echo $pcsgmts; ?>">
                                    <input type="hidden" id="itempcsgmts_<? echo $i;?>"  name="itempcsgmts_<? echo $i;?>"  onBlur="set_sum_value( 'pcs_sum', 'pcs_' ) " class="text_boxes_numeric" style="width:25px"  value="<? echo $itemqty_array[$row[csf('item_number_id')]]; ?>">
                                    <input type="hidden" id="colorsizetableid_<? echo $i;?>"  name="colorsizetableid_<? echo $i;?>" class="text_boxes" style="width:45px" value="<? echo $row[csf('color_size_table_id')]; ?>" readonly/>
                                    <input type="button" id="decreaserow_<? echo $i;?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_delete_down_tr(<? echo $i;?>,'tbl_consmption_cost');" disabled/>
                                    <input type="hidden" id="approved_<? echo $i;?>"  name="approved_<? echo $i;?>"  class="text_boxes_numeric" style="width:35px"  value="<? echo $disabled; ?>">
                                </td>
							</tr>
							<?
						}
                    }
                    ?>
                </tbody>
            </table>
            <table width="850" cellspacing="0" class="rpt_table" border="0" rules="all">
                <tfoot>
                    <tr>
                        <th width="30">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="100">&nbsp;</th>
                        <th width="80">SUM:</th>
                        <th width="75"><input type="text" id="requirement_sum"  name="requirement_sum" class="text_boxes_numeric" style="width:62px" readonly></th>
                        <th width="60"><input type="text" id="rate_sum"    name="rate_sum" class="text_boxes_numeric" style="width:47px" readonly></th>
                        <th width="90">
                            <input type="text" id="amount_sum"    name="amount_sum" class="text_boxes_numeric" style="width:77px" readonly>
                            <input type="hidden" id="plancutqty_sum"    name="plancutqty_sum" class="text_boxes_numeric" style="width:70px" readonly>
                        </th>
                        <th>&nbsp;</th>
                    </tr>
                    <tr>
                        <th width="30">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="120">&nbsp;</th>
                        <th width="100">&nbsp;</th>
                        <th width="80">AVG:</th>
                        <th width="75"><input type="text" id="calculated_cons" name="calculated_cons" class="text_boxes_numeric" style="width:62px" value="<?=$calculated_conss;?>" readonly></th>
                        <th width="60"><input type="text" id="calculated_rate"   name="calculated_rate" class="text_boxes_numeric" style="width:47px" readonly></th>
                        <th width="90">
                            <input type="text" id="calculated_amount" name="calculated_amount" class="text_boxes_numeric" style="width:77px" readonly>
                            <input type="hidden" id="calculated_plancutqty"    name="calculated_plancutqty" class="text_boxes_numeric" style="width:60px" readonly>
                        </th>
                        <th>&nbsp;</th>
                    </tr>
                </tfoot>
            </table>
            <script>
				set_sum_value( 'requirement_sum', 'requirement_');
				set_sum_value( 'rate_sum', 'rate_');
				set_sum_value( 'amount_sum', 'amount_');
				fnc_conversion_from_chart();
            </script>
        </form>
        </fieldset>
        </div>
        <div align="center" style="width:100%;" >
        <fieldset>
            <table width="850" cellspacing="0" class="" border="0" rules="all">
                <tr>
                	<td align="center" width="100%" class="button_container"> <input type="button" class="formbutton" value="Close" onClick="js_set_value()"/> </td>
                </tr>
            </table>
        </fieldset>
        </div>
	</body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}

if ($action=="save_update_delet_wash_cost_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$sql=sql_select("select approval_need from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
	$app_nessity=2;
	foreach($sql as $row){
		$app_nessity=$row[csf('approval_need')];
	}

	$sql=sql_select("select approved from wo_price_quotation  where id=$txt_quotation_id");
	$quatation_approved=2;
	foreach($sql as $row){
		$quatation_approved=$row[csf('approved')];
	}

	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	//echo "10**",$is_copy_quatation."**". $app_nessity."**".$quatation_approved;
	//die;
	if($is_copy_quatation==1 && $app_nessity==1){
		if($quatation_approved==2 || $quatation_approved==0 || $quatation_approved==3){
			echo "quataNotApp**".str_replace("'","",$txt_job_no);
			disconnect($con);die;
		}
	}
	
	$materialReciveNo="";
	$sql=sql_select("select a.recv_number from inv_receive_master a, inv_transaction b, wo_po_break_down c where a.id=b.mst_id and b.job_no=c.job_no_mst and b.job_no=$update_id and a.entry_form=248 and c.is_confirmed=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by a.recv_number");
	foreach($sql as $row)
	{
		if($materialReciveNo=="") $materialReciveNo=$row[csf('recv_number')]; else $materialReciveNo.=','.$row[csf('recv_number')];
	}
	if($materialReciveNo!=""){
		echo "materialRecive**".$materialReciveNo;
		disconnect($con);die;
	}
	
	if($operation==0)
	{
		$con = connect();
		if($db_type==0) mysql_query("BEGIN");
		if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0"; die;}
		$approved=0;
		$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$update_id");
		foreach($sql as $row){
			if($row[csf('approved')]==3){
				$approved=1;
			}else{
				$approved=$row[csf('approved')];
			}
		}
		if($approved==1){
			echo "approved**".str_replace("'","",$update_id);
			disconnect($con);die;
		}
		 $add_comma=0;
		 $fail1=0;
		 $id=return_next_id( "id", "wo_pre_cost_embe_cost_dtls", 1 ) ;
		 $id1=return_next_id( "id", "wo_pre_cos_emb_co_avg_con_dtls", 1 ) ;
		 $field_array="id, job_id, job_no, emb_name, emb_type, country, cons_dzn_gmts, rate, amount, charge_lib_id, budget_on, inserted_by, insert_date, status_active, is_deleted";
		 $field_array1="id, job_id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id, item_number_id, color_number_id, size_number_id, requirment, rate, amount, color_size_table_id, rate_lib_id, country_id";

		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cboembname="cboembname_".$i;
			 $cboembtype="cboembtype_".$i;
			 $country="country_".$i;
			 $txtembconsdzngmts="txtembconsdzngmts_".$i;
			 $txtembrate="txtembrate_".$i;
			 $txtembamount="txtembamount_".$i;
			 $cboembstatus="cboembstatus_".$i;
			 $embupdateid="embupdateid_".$i;
			 $embratelibid="embratelibid_".$i;
			 $consbreckdownwash="consbreckdownwash_".$i;
			 $empbudgeton="empbudgeton_".$i;

			if ($i!=1) $data_array .=",";
			$data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cboembname.",".$$cboembtype.",".$$country.",".$$txtembconsdzngmts.",".$$txtembrate.",".$$txtembamount.",".$$embratelibid.",".$$empbudgeton.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cboembstatus.",0)";
			//	CONS break down===============================================================================================
			if(str_replace("'",'',$$consbreckdownwash) !='')
			 {
				$consbreckdown= $$consbreckdownwash;
			 }
			 else
			 {
				 $consbreckdown="'".create_consbreak_down_emb($update_id,str_replace("'",'',$$txtembconsdzngmts),str_replace("'",'',$$txtembrate),str_replace("'",'',$$txtembamount))."'";
				 // $consbreckdown="";
			 }
			if(str_replace("'",'',$consbreckdown) !='')
			{
				$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
				$counter=0;
				for($c=0;$c < count($consbreckdown_array);$c++)
				{
					$counter++;
					$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
					//"id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id,item_number_id, color_number_id, size_number_id, requirment,rate,amount,color_size_table_id"
					//ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid;
					if ($add_comma!=0) $data_array1 .=",";
					$data_array1 .="(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."')";

					$id1=$id1+1;
					$add_comma++;
					if ($data_array1!="" && $counter==100)
					{
						$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
						$counter=0;
						$data_array1="";
						$add_comma=0;
						if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
					}
				}
				if ($data_array1!="" && $counter!=100)
				{
					$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
					$counter=0;
					$data_array1="";
					$add_comma=0;
					if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
				}
			}
           //CONS break down end===============================================================================================
			$id=$id+1;
		}
		$rID=sql_insert("wo_pre_cost_embe_cost_dtls",$field_array,$data_array,0);
		//=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, emb_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtamountemb_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="emb_amount";
			$data_array2 ="".$txtamountemb_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		check_table_status( $_SESSION['menu_id'],0);
		//=======================sum End =================
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "0**".$new_job_no[0]."**".$rID;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "0**".$new_job_no[0]."**".$rID;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		disconnect($con);
		die;
	}
	else if($operation==1)
	{
		$con = connect();
		 if($db_type==0)
		 {
			mysql_query("BEGIN");
		 }

		$component_approved=return_field_value("current_approval_status", "co_com_pre_costing_approval", "job_no=$update_id and cost_component_id=4");
		if($component_approved==3){
			$component_approved=1;
		}
		 $approved=0;
		$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$update_id");
		foreach($sql as $row){
			if($row[csf('approved')]==3){
				$approved=1;
			}else{
				$approved=$row[csf('approved')];
			}
		}
		if($approved==1 || $component_approved==1){
			echo "approved**".str_replace("'","",$update_id);
			disconnect($con);die;
		}
		if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**1"; die;}
		 $field_array_up="job_no*emb_name*emb_type*country*cons_dzn_gmts*rate*amount*charge_lib_id*budget_on*updated_by*update_date*status_active*is_deleted";
		 $field_array="id, job_id, job_no, emb_name, emb_type, country, cons_dzn_gmts, rate, amount, charge_lib_id, budget_on, inserted_by, insert_date, status_active, is_deleted";
		 $field_array1="id, job_id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id, item_number_id, color_number_id, size_number_id, requirment, rate, amount, color_size_table_id, rate_lib_id, country_id";

		 $add_co=0; $add_comma=0; $fail1=0;
		 $id=return_next_id( "id", "wo_pre_cost_embe_cost_dtls", 1 ) ;
		 $id1=return_next_id( "id", "wo_pre_cos_emb_co_avg_con_dtls", 1 ) ;

		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cboembname="cboembname_".$i;
			 $cboembtype="cboembtype_".$i;
			 $country="country_".$i;
			 $txtembconsdzngmts="txtembconsdzngmts_".$i;
			 $txtembrate="txtembrate_".$i;
			 $txtembamount="txtembamount_".$i;
			 $cboembstatus="cboembstatus_".$i;
			 $embupdateid="embupdateid_".$i;
			 $embratelibid="embratelibid_".$i;
			 $consbreckdownwash="consbreckdownwash_".$i;
			 $empbudgeton="empbudgeton_".$i;
			if(str_replace("'",'',$$embupdateid)!="")
			{
                $id_arr[]=str_replace("'",'',$$embupdateid);
				$data_array_up[str_replace("'",'',$$embupdateid)] =explode("*",("".$update_id."*".$$cboembname."*".$$cboembtype."*".$$country."*".$$txtembconsdzngmts."*".$$txtembrate."*".$$txtembamount."*".$$embratelibid."*".$$empbudgeton."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*".$$cboembstatus."*0"));
				//	CONS break down===============================================================================================
				if(str_replace("'",'',$$consbreckdownwash) !='')
				 {
					$consbreckdown= $$consbreckdownwash;
				 }
				 else
				 {
					 //$consbreckdown="'".create_consbreak_down_emb($update_id,str_replace("'",'',$$txtembconsdzngmts),str_replace("'",'',$$txtembrate),str_replace("'",'',$$txtembamount))."'";
					  $consbreckdown="";
				 }

			if(str_replace("'",'',$consbreckdown) !='')
			{
				//echo "delete from wo_pre_cos_emb_co_avg_con_dtls where  pre_cost_emb_cost_dtls_id =".$$embupdateid."";
				$rID_de1=execute_query( "delete from wo_pre_cos_emb_co_avg_con_dtls where  pre_cost_emb_cost_dtls_id =".$$embupdateid."",0);
				$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
				$counter=0;
				for($c=0;$c < count($consbreckdown_array);$c++)
				{
					$counter++;
					$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
					//"id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id,item_number_id, color_number_id, size_number_id, requirment,rate,amount,color_size_table_id"
					//ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid;
					if ($add_comma!=0) $data_array1 .=",";
					$data_array1 .="(".$id1.",".$hidd_job_id.",".str_replace("'",'',$$embupdateid).",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."')";

					$id1=$id1+1;
					$add_comma++;
					if ($data_array1!="" && $counter==100)
					{
						//echo "insert into wo_pre_cos_emb_co_avg_con_dtls (".$field_array1.") values ".$data_array1;
						$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
						$counter=0;
						$data_array1="";
						$add_comma=0;
						if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
					}
				}

				if ($data_array1!="" && $counter!=100)
				{
					//echo "insert into wo_pre_cos_emb_co_avg_con_dtls (".$field_array1.") values ".$data_array1;
					$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
					$counter=0;
					$data_array1="";
					$add_comma=0;
					if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
				}
			}
           //CONS break down end===============================================================================================
			}
			if(str_replace("'",'',$$embupdateid)=="")
			{

				if ($add_co!=0) $data_array .=",";
				$data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cboembname.",".$$cboembtype.",".$$country.",".$$txtembconsdzngmts.",".$$txtembrate.",".$$txtembamount.",".$$embratelibid.",".$$empbudgeton.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cboembstatus.",0)";
				//	CONS break down===============================================================================================
				if(str_replace("'",'',$$consbreckdownwash) !='')
				 {
					$consbreckdown= $$consbreckdownwash;
				 }
				 else
				 {
					 $consbreckdown="'".create_consbreak_down_emb($update_id,str_replace("'",'',$$txtembconsdzngmts),str_replace("'",'',$$txtembrate),str_replace("'",'',$$txtembamount))."'";
					  //$consbreckdown="";
				 }
			if(str_replace("'",'',$consbreckdown) !='')
			{
				$consbreckdown_array=explode('__',str_replace("'",'',$consbreckdown));
				//$counter=0;
				for($c=0;$c < count($consbreckdown_array);$c++)
				{
					$counter++;
					$consbreckdownarr=explode('_',$consbreckdown_array[$c]);
					//"id, pre_cost_emb_cost_dtls_id, job_no, po_break_down_id,item_number_id, color_number_id, size_number_id, requirment,rate,amount,color_size_table_id"
					//ponoid+'_'+cbogmtsitem+'_'+pocolorid+'_'+gmtssizesid+'_'+requirement+'_'+rate+'_'+amount+'_'+colorsizetableid;
					if ($add_comma!=0) $data_array1 .=",";
					$data_array1 .="(".$id1.",".$hidd_job_id.",".$id.",".$update_id.",'".$consbreckdownarr[0]."','".$consbreckdownarr[1]."','".$consbreckdownarr[2]."','".$consbreckdownarr[3]."','".$consbreckdownarr[4]."','".$consbreckdownarr[5]."','".$consbreckdownarr[6]."','".$consbreckdownarr[7]."','".$consbreckdownarr[8]."','".$consbreckdownarr[9]."')";

					$id1=$id1+1;
					$add_comma++;
					if ($data_array1!="" && $counter==100)
					{
						$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
						$counter=0;
						$data_array1="";
						$add_comma=0;
						if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
					}
				}
				if ($data_array1!="" && $counter!=100)
				{
					$rID_in1=sql_insert("wo_pre_cos_emb_co_avg_con_dtls",$field_array1,$data_array1,1);
					$counter=0;
					$data_array1="";
					$add_comma=0;
					if( $rID_in1 && $fail1==0) { $rID_in1=1;  } else { $rID_in1=0; $fail1=1; }
				}
			}
           //CONS break down end===============================================================================================
				$id=$id+1;
				$add_co++;
			}
		 }
		 $rID=execute_query(bulk_update_sql_statement( "wo_pre_cost_embe_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
		 if($data_array !="")
		 {
			 $rID1=sql_insert("wo_pre_cost_embe_cost_dtls",$field_array,$data_array,0);
		 }
       // bulk_update_sql_statement( "wo_pre_cost_embe_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr );
		 //=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, emb_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtamountemb_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="emb_amount";
			$data_array2 ="".$txtamountemb_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		//=======================sum End =================
        check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "1**".$new_job_no[0]."**".$rID;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "1**".$new_job_no[0]."**".$rID;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		disconnect($con);
		die;
	}
}
//**************************************************************************Wash Cost End**********************************************
//*************************************************Commision Cost Start ***********************************************
if ($action=="show_commission_cost_listview")
{
	$data=explode("_",$data);
	$component_approved=0;
	$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=5 and job_no='$data[0]'");
	foreach($sql as $row){
		if($row[csf('approved')]==1 || $row[csf('approved')]==3) { $component_approved=1; $approved_message="<marquee width='500'><p style='color:#f00; text-align:center;'> Approved</p></marquee>";}
	}

?>
<h3 align="left" class="accordion_h">+Commission Cost <? echo $approved_message; ?></h3>
       <div id="content_commission_cost" align="center">
    	<fieldset>
        	<form id="commission_8" autocomplete="off">
            	<table width="580" cellspacing="0" class="rpt_table" border="0" id="tbl_commission_cost" rules="all">
                	<thead>
                    	<tr>
                        	<th width="150">Particulars</th> <th width="100">Commn. Base</th> <th width="90">Commn Rate</th> <th width="110">Amount</th> <th width="">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                    <?
					$save_update=1;
					$approved=return_field_value("approved", "wo_pre_cost_mst", "job_no='$data[0]'");
					if($approved==3){
						$approved=1;
					}
					if($approved==1 || $component_approved==1) $disabled=1; else $disabled=0;

					$data_array=sql_select("select id, job_no, particulars_id, commission_base_id, commision_rate,commission_amount,status_active from  wo_pre_cost_commiss_cost_dtls where job_no='$data[0]' order by id");// quotation_id='$data'
					if(count($data_array)<1 && $data[2]==1)
					{
					$data_array=sql_select("select id, quotation_id, particulars_id, commission_base_id, commision_rate,commission_amount,status_active from  wo_pri_quo_commiss_cost_dtls where quotation_id='$data[1]' order by id");// quotation_id='$data'
					$save_update=0;
					}
					if ( count($data_array)>0)
					{
						$i=0;
						foreach( $data_array as $row )
						{
							$i++;
							?>
                            	<tr id="commissiontr_1" align="center">
                                    <td>
									<?
									echo create_drop_down( "cboparticulars_".$i, 150, $commission_particulars, "",1," -- Select Item --", $row[csf("particulars_id")], "",$disabled,'' );
									//create_drop_down( $field_id, $field_width, $query, $field_list, $show_select, $select_text_msg, $selected_index, $onchange_func, $is_disabled, $array_index )
									?>
                                    </td>
                                    <td><?  echo create_drop_down( "cbocommissionbase_".$i, 100, $commission_base_array,"", 1, "-- Select --", $row[csf("commission_base_id")], "calculate_commission_cost(".$i.")",$disabled,"" ); ?></td>

                                   <td>
                                    <input type="text" id="txtcommissionrate_<? echo $i; ?>"  name="txtcommissionrate_<? echo $i; ?>" class="text_boxes_numeric" style="width:90px" value="<? echo $row[csf("commision_rate")];  ?>" onChange="calculate_commission_cost( <? echo $i;?> )" <? if($disabled==0){echo "";}else{echo "disabled";}?> />
                                    </td>
                                    <td>
                                    <input type="text" id="txtcommissionamount_<? echo $i; ?>"  name="txtcommissionamount_<? echo $i; ?>" class="text_boxes_numeric" style="width:110px" value="<? echo $row[csf("commission_amount")];  ?>" <? if($disabled==0){echo "";}else{echo "disabled";}?> readonly />
                                    </td>

                                    <td>
									<? echo create_drop_down( "cbocommissionstatus_".$i, 95, $row_status,"", 0, "0", $row[csf("status_active")], '',$disabled,'' );  ?>
                                    <input type="hidden" id="commissionupdateid_<? echo $i; ?>" name="commissionupdateid_<? echo $i; ?>"  class="text_boxes" style="width:20px" value="<? echo  $row[csf("id")]; ?>"  />
                                    </td>
                                </tr>
                            <?
						}
					}
					else
					{
						$save_update=0;
					?>
                    <tr id="commissiontr_1" align="center">
                                   <td>
									<?
									echo create_drop_down( "cboparticulars_1", 150, $commission_particulars, "",0,"", $row, '','','' );
									?>
                                    </td>
                                    <td><?  echo create_drop_down( "cbocommissionbase_1", 100, $commission_base_array,"", 1, "-- Select --", "", "calculate_commission_cost(1)","","" ); ?></td>
                                   <td>
                                    <input type="text" id="txtcommissionrate_1"  name="txtcommissionrate_1" class="text_boxes_numeric" style="width:90px" value="" onChange="calculate_commission_cost(1 )"/>
                                    </td>
                                    <td>
                                    <input type="text" id="txtcommissionamount_1"  name="txtcommissionamount_1" class="text_boxes_numeric" style="width:110px" value="" readonly />
                                    </td>
                                    <td>
									<? echo create_drop_down( "cbocommissionstatus_1", 95, $row_status,"", 0, "0", '', '','','' );  ?>
                                    <input type="hidden" id="commissionupdateid_1" name="commissionupdateid_1"  class="text_boxes" style="width:20px" value=""  />
                                    </td>
                                </tr>
                                <tr id="commissiontr_2" align="center">
                                   <td>
									<?
									echo create_drop_down( "cboparticulars_2", 150, $commission_particulars, "",0,"", $row, '','','' );
									?>
                                    </td>
                                    <td><?  echo create_drop_down( "cbocommissionbase_2", 100, $commission_base_array,"", 1, "-- Select --", "", "calculate_commission_cost(2)","","" ); ?></td>
                                   <td>
                                    <input type="text" id="txtcommissionrate_2"  name="txtcommissionrate_2" class="text_boxes_numeric" style="width:90px" value="" onChange="calculate_commission_cost(2)"/>
                                    </td>
                                    <td>
                                    <input type="text" id="txtcommissionamount_2"  name="txtcommissionamount_2" class="text_boxes_numeric" style="width:110px" value=""   />
                                    </td>
                                    <td>
									<? echo create_drop_down( "cbocommissionstatus_2", 95, $row_status,"", 0, "0", '', '','','' );  ?>
                                    <input type="hidden" id="commissionupdateid_2" name="commissionupdateid_2"  class="text_boxes" style="width:20px" value=""  />
                                    </td>
                                </tr>
                    <?
					}
					?>
                </tbody>
                </table>
                <table width="580" cellspacing="0" class="rpt_table" border="0" rules="all">
                <tfoot>
                    	<tr>
                            <th width="150" style="border:none"></th>
                            <th  width="100" align="right" style="border:none">SUM</th>
                            <th width="90">
                            <input type="text" id="txtratecommission_sum"  name="txtratecommission_sum" class="text_boxes_numeric" style="width:90px"  readonly />
                            </th>
                            <th width="110">
                            <input type="text" id="txtamountcommission_sum"  name="txtamountcommission_sum" class="text_boxes_numeric" style="width:110px"  readonly />
                            </th>
                            <th></th>
                        </tr>
                    </tfoot>
                </table>

                <table width="580" cellspacing="0" class="" border="0">
                	<tr>
                        <td align="center" height="15" width="100%"> </td>
                    </tr>
                	<tr>
                        <td align="center" width="100%" class="button_container">
						<?
						if ( count($data_array)>0)
					    {
							echo load_submit_buttons( $permission, "fnc_commission_cost_dtls", $save_update,0,"reset_form('commission_8','','',0)",7) ;
					    }
						else
						{
							echo load_submit_buttons( $permission, "fnc_commission_cost_dtls", $save_update,0,"reset_form('commission_8','','',0)",7) ;
						}
						?>
                        </td>
                    </tr>
                </table>
            </form>
        </fieldset>
        </div>
	<?
    exit();
}


if ($action=="save_update_delet_commission_cost_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$sql=sql_select("select approval_need from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
	$app_nessity=2;
	foreach($sql as $row){
		$app_nessity=$row[csf('approval_need')];
	}

	$sql=sql_select("select approved from wo_price_quotation  where id=$txt_quotation_id");
	$quatation_approved=2;
	foreach($sql as $row){
		$quatation_approved=$row[csf('approved')];
	}

	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	//echo "10**",$is_copy_quatation."**". $app_nessity."**".$quatation_approved;
	//die;
	if($is_copy_quatation==1 && $app_nessity==1){
		if($quatation_approved==2 || $quatation_approved==0 || $quatation_approved==3){
			echo "quataNotApp**".str_replace("'","",$txt_job_no);
			disconnect($con);die;
		}
	}
	
	$materialReciveNo="";
	$sql=sql_select("select a.recv_number from inv_receive_master a, inv_transaction b, wo_po_break_down c where a.id=b.mst_id and b.job_no=c.job_no_mst and b.job_no=$update_id and a.entry_form=248 and c.is_confirmed=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by a.recv_number");
	foreach($sql as $row)
	{
		if($materialReciveNo=="") $materialReciveNo=$row[csf('recv_number')]; else $materialReciveNo.=','.$row[csf('recv_number')];
	}
	if($materialReciveNo!=""){
		echo "materialRecive**".$materialReciveNo;
		disconnect($con);die;
	}
	
	
	if($operation==0)
	{
	    $con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		$approved=0;
		$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$update_id");
		foreach($sql as $row){
			if($row[csf('approved')]==3){
				$approved=1;
			}else{
				$approved=$row[csf('approved')];
			}
		}
		if($approved==1){
			echo "approved**".str_replace("'","",$update_id);
			disconnect($con);die;
		}
		 if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0"; die;}
		 $id=return_next_id( "id", "wo_pre_cost_commiss_cost_dtls", 1 ) ;
		 $field_array="id, job_id, job_no, particulars_id, commission_base_id, commision_rate, commission_amount, inserted_by, insert_date, status_active, is_deleted ";
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cboparticulars="cboparticulars_".$i;
			 $cbocommissionbase="cbocommissionbase_".$i;
			 $txtcommissionrate="txtcommissionrate_".$i;
			 $txtcommissionamount="txtcommissionamount_".$i;
			 $cbocommissionstatus="cbocommissionstatus_".$i;
			 $commissionupdateid="commissionupdateid_".$i;
			if ($i!=1) $data_array .=",";
			$data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cboparticulars.",".$$cbocommissionbase.",".$$txtcommissionrate.",".$$txtcommissionamount.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbocommissionstatus.",0)";
			$id=$id+1;
		 }
		 $rID=sql_insert("wo_pre_cost_commiss_cost_dtls",$field_array,$data_array,0);
		 //=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, commis_rate, commis_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtratecommission_sum.",".$txtamountcommission_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="commis_rate*commis_amount";
			$data_array2 ="".$txtratecommission_sum."*".$txtamountcommission_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		//=======================sum End =================
		$tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name,$txtamountcommission_sum);
		check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "0**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "0**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		disconnect($con);
		die;
	}
	else if($operation==1)
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		$component_approved=return_field_value("current_approval_status", "co_com_pre_costing_approval", "job_no=$update_id and cost_component_id=5");
		if($component_approved==3){
			$component_approved=1;
		}
		$approved=0;
		$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$update_id");
		foreach($sql as $row){
			if($approved==3){
				$approved=1;
			}else{
				$approved=$row[csf('approved')];
			}
		}
		if($approved==1 || $component_approved==1){
			echo "approved**".str_replace("'","",$update_id);
			disconnect($con);die;
		}
		 if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**1"; die;}
		 $field_array_up="particulars_id*commission_base_id*commision_rate*commission_amount*updated_by*update_date*status_active*is_deleted ";
		 $field_array="id, job_id, job_no, particulars_id, commission_base_id, commision_rate, commission_amount, inserted_by, insert_date, status_active, is_deleted ";
		 $add_comma=0;
		 $id=return_next_id( "id", "wo_pre_cost_commiss_cost_dtls", 1 ) ;
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cboparticulars="cboparticulars_".$i;
			 $cbocommissionbase="cbocommissionbase_".$i;
			 $txtcommissionrate="txtcommissionrate_".$i;
			 $txtcommissionamount="txtcommissionamount_".$i;
			 $cbocommissionstatus="cbocommissionstatus_".$i;
			 $commissionupdateid="commissionupdateid_".$i;
			if(str_replace("'",'',$$commissionupdateid)!="")
			{
				$id_arr[]=str_replace("'",'',$$commissionupdateid);
			    $data_array_up[str_replace("'",'',$$commissionupdateid)]=explode(",",("".$$cboparticulars.",".$$cbocommissionbase.",".$$txtcommissionrate.",".$$txtcommissionamount.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbocommissionstatus.",0"));
			}
			if(str_replace("'",'',$$commissionupdateid)=="")
			{
			    if ($add_comma!=0) $data_array .=",";
			    $data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cboparticulars.",".$$cbocommissionbase.",".$$txtcommissionrate.",".$$txtcommissionamount.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbocommissionstatus.",0)";
			    $id=$id+1;
				$add_comma++;
			}
		 }
         $rID=execute_query(bulk_update_sql_statement( "wo_pre_cost_commiss_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
		 if($data_array !="")
		 {
			 $rID=sql_insert("wo_pre_cost_commiss_cost_dtls",$field_array,$data_array,0);
		 }
 		 //=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, commis_rate, commis_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtratecommission_sum.",".$txtamountcommission_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="commis_rate*commis_amount";
			$data_array2 ="".$txtratecommission_sum."*".$txtamountcommission_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		//=======================sum End =================
		$tot_com_amount=update_comarcial_cost($update_id,$cbo_company_name);


		check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "1**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "1**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID."**".$tot_com_amount;
			}
		}
		disconnect($con);
		die;
	}
}

//*************************************************Commision Cost End ***********************************************
//*************************************************Comarcial Cost Start ***********************************************

if ($action=="curreir_cost_method")
{
	$data=explode("_",$data);
	$job_no=$data[0];
	$company_id=$data[1];
	$fabric_pre_cost=$data[2];
	$price_dzn=$data[3];
	$commission_pre_cost=$data[4];
	
	$sql_job=sql_select("select BUYER_NAME, BRAND_ID from WO_PO_DETAILS_MASTER where job_no='$job_no'");
	
	$buyerid=$sql_job[0]["BUYER_NAME"];
	$brandid=$sql_job[0]["BRAND_ID"];
	
	$currier_result=sql_select("select commercial_cost_method, commercial_cost_percent, editable, copy_quotation as based_on from variable_order_tracking where company_name=".$company_id."  and variable_list=57 and tna_integrated='$buyerid' and profit_calculative='$brandid' and status_active=1 and is_deleted=0");
	if(count($currier_result)<1)
	{
		$currier_result=sql_select("select commercial_cost_method, commercial_cost_percent, editable from variable_order_tracking where company_name=".$company_id."  and variable_list=57  and status_active=1 and is_deleted=0");
	}
	//$currier_result=sql_select($sql_currier_data);
	foreach($currier_result as $row)
	{
		$currier_cost_percent=0; $currier_cost_method=1;
		if($row[csf("based_on")]==2) $fixamount=$row[csf("commercial_cost_percent")]; 
		else 
		{
			$fixamount=0;
			$currier_cost_method=$row[csf("commercial_cost_method")];
			if($currier_cost_method=="" || $currier_cost_method==0) $currier_cost_percent=1; else $currier_cost_percent=$currier_cost_percent;
			$currier_cost_percent=$row[csf("commercial_cost_percent")];
			if($currier_cost_percent=="" || $currier_cost_percent==0) $currier_cost_percent=0; else  $currier_cost_percent=$currier_cost_percent;
		}

		$editable=$row[csf("editable")];
		$based_on=$row[csf("based_on")];
	}

   $fob_value=$price_dzn-$commission_pre_cost;
   $amount=0;
	if($currier_cost_method==1)
	{
		$data_array=sql_select("select (fab_amount+yarn_amount+trim_amount) as amount from wo_pre_cost_sum_dtls where job_no='$job_no' and status_active=1 and is_deleted=0");
		foreach( $data_array as $row )
		{
			$amount=def_number_format($row[csf("amount")],5,"");
		}
	}
	if($currier_cost_method==2)
	{
		$amount=def_number_format($price_dzn,5,"");
	}
	if($currier_cost_method==3) //On Net Selling
	{
		$amount=def_number_format($fob_value,5,"");
	}
	$currier_amount=def_number_format(($amount*($currier_cost_percent/100)),5,"");
	echo $currier_cost_method.'**'.$currier_amount.'**'.$editable.'**'.$based_on.'**'.$fixamount;
	exit();
} //Currier Cost Method end

if ($action=="show_comarcial_cost_listview")
{
	$data=explode("_",$data);
	
	$sql_job=sql_select("select BUYER_NAME, BRAND_ID from WO_PO_DETAILS_MASTER where job_no='$data[0]'");
	
	$buyerid=$sql_job[0]["BUYER_NAME"];
	$brandid=$sql_job[0]["BRAND_ID"];
	
	$commercial_cost_methodSql=sql_select("select commercial_cost_method, commercial_cost_percent, editable from variable_order_tracking where company_name=".$data[3]."  and variable_list=27 and tna_integrated='$buyerid' and profit_calculative='$brandid' and status_active=1 and is_deleted=0");
	if(count($commercial_cost_methodSql)<1)
	{
		$commercial_cost_methodSql=sql_select("select commercial_cost_method, commercial_cost_percent, editable from variable_order_tracking where company_name=".$data[3]."  and variable_list=27 and tna_integrated='$buyerid' and profit_calculative='0' and status_active=1 and is_deleted=0");
		//echo "select commercial_cost_method, commercial_cost_percent, editable from variable_order_tracking where company_name=".$data[3]."  and variable_list=27 and tna_integrated='$buyerid' and profit_calculative='0' and status_active=1 and is_deleted=0";
	}
	if(count($commercial_cost_methodSql)<1)
	{
		$commercial_cost_methodSql=sql_select("select commercial_cost_method, commercial_cost_percent, editable from variable_order_tracking where company_name=".$data[3]."  and variable_list=27 and tna_integrated='0' and profit_calculative='0' and status_active=1 and is_deleted=0");
	}
	
	$commercial_cost_method=1; $commercial_cost_percent=0; $editable=0;
	foreach( $commercial_cost_methodSql as $row )
	{
		if($row[csf("commercial_cost_method")]>0) $commercial_cost_method=$row[csf("commercial_cost_method")];
		if($row[csf("commercial_cost_percent")]>0) $commercial_cost_percent=$row[csf("commercial_cost_percent")];
		if($row[csf("editable")]>0) $editable=$row[csf("editable")];
	}

	$price_dzn=$data[4];
	$fob_value=$data[4]-$data[5];
	$amount=0;
	if($commercial_cost_method==1)
	{
		$data_array=sql_select("select (fab_amount+yarn_amount+trim_amount) as amount from wo_pre_cost_sum_dtls where job_no='$data[0]' and status_active=1 and is_deleted=0");
		foreach( $data_array as $row )
		{
			$amount=def_number_format($row[csf("amount")],5,"");
		}
	}
	else if($commercial_cost_method==2) $amount=def_number_format($price_dzn,5,"");
	else if($commercial_cost_method==3) $amount=def_number_format($fob_value,5,"");
	else if($commercial_cost_method==5 || $commercial_cost_method==6 || $commercial_cost_method==7)//Fabric Purchase + Trims Cost + Embellishment Cost + Garments Wash + Lab Test + Inspection + CM Cost + Freight + Courier Cost + Certificate Cost + Design Cost + Studio Cost + Operating Expenses
	{
		$amount=0;	
		$sql_fab="select amount as amount from wo_pre_cost_fabric_cost_dtls where job_no='$data[0]' and fabric_source in (1,2) and status_active=1 and is_deleted=0";
		$data_fab=sql_select($sql_fab);
		$fab_amount=0;
		foreach($data_fab as $row )
		{
			$fab_amount+=$row[csf("amount")];
		}
		unset($data_fab);
		$sql_yarn="select amount as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no='$data[0]' and status_active=1 and is_deleted=0";
		$data_yarn=sql_select($sql_yarn);
		$yarn_amount=0;
		foreach($data_yarn as $row )
		{
			$yarn_amount+=$row[csf("amount")];
		}
		unset($data_yarn);
		//$data_array=sql_select("select trims_cost, embel_cost, wash_cost, lab_test, inspection, cm_cost, freight, currier_pre_cost, certificate_pre_cost, design_pre_cost, studio_pre_cost, common_oh from wo_price_quotation_costing_mst where quotation_id=$quotation_id and status_active=1 and is_deleted=0");
		$data_array=sql_select("select fabric_cost, trims_cost, embel_cost, wash_cost, lab_test, inspection, cm_cost, freight, currier_pre_cost, certificate_pre_cost, design_cost, studio_cost, common_oh from wo_pre_cost_dtls where job_no='$data[0]' and status_active=1 and is_deleted=0");
		$ft_amount=0;
		foreach( $data_array as $row )
		{
			if($commercial_cost_method==5)
			{
				$ft_amount=$row[csf("trims_cost")]+$row[csf("embel_cost")]+$row[csf("wash_cost")]+$row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("cm_cost")]+$row[csf("freight")]+$row[csf("currier_pre_cost")]+$row[csf("certificate_pre_cost")]+$row[csf("design_cost")]+$row[csf("studio_cost")]+$row[csf("common_oh")];
			}
			else if($commercial_cost_method==6)
			{
				$ft_amount=$row[csf("trims_cost")]+$row[csf("embel_cost")]+$row[csf("wash_cost")]+$row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("freight")]+$row[csf("currier_pre_cost")]+$row[csf("certificate_pre_cost")]+$row[csf("design_cost")]+$row[csf("studio_cost")]+$row[csf("common_oh")];
			}
			else if($commercial_cost_method==7)
			{
				$ft_amount=$row[csf("fabric_cost")]+$row[csf("trims_cost")]+$row[csf("embel_cost")]+$row[csf("wash_cost")]+$row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("freight")]+$row[csf("currier_pre_cost")]+$row[csf("certificate_pre_cost")]+$row[csf("design_cost")]+$row[csf("studio_cost")]+$row[csf("common_oh")];
			}
		}
		unset($data_array);
		if($commercial_cost_method!=7)$amount=$ft_amount+$yarn_amount+$fab_amount;
		else $amount=$ft_amount;
	}
	$com_amount=def_number_format(($amount*($commercial_cost_percent/100)),5,"");
	//echo $commercial_cost_method.'=='.$com_amount;

	$component_approved=0;
	$sql=sql_select("select current_approval_status as approved from co_com_pre_costing_approval where cost_component_id=6 and job_no='$data[0]'");
	foreach($sql as $row){
		if($row[csf('approved')]==1 || $row[csf('approved')]==3) { $component_approved=1; $approved_message="<marquee width='500'><p style='color:#f00; text-align:center;'> Approved</p></marquee>";}
	}

	?>
	<h3 align="left" class="accordion_h" >+Commercial Cost <?=$approved_message; ?></h3>
       <div id="content_comarcial_cost"  align="center">
    	<fieldset>
        	<form id="comarcial_9" autocomplete="off">
            <input type="hidden" id="txt_commercial_cost_method" value="<?=$commercial_cost_method;?>"/>
            	<table width="540" cellspacing="0" class="rpt_table" border="0" id="tbl_comarcial_cost" rules="all">
                	<thead>
                    	<tr>
                        	<th width="150">Item</th><th width="90"> Rate In %</th><th width="110">Amount</th><th width="95">Status</th><th width=""></th>
                        </tr>
                    </thead>
                    <tbody>
                    <?
					$save_update=1;
					$approved=return_field_value("approved", "wo_pre_cost_mst", "job_no='$data[0]'");
					if($approved==3){
						$approved=1;
					}
					if($approved==1 || $component_approved==1) $disabled=1; else $disabled=0;

					if($editable==1) $readonly=0; else $readonly=1	;

					$data_array=sql_select("select id, job_no, item_id , rate,amount,status_active from  wo_pre_cost_comarci_cost_dtls where job_no='$data[0]' order by id");
					if(count($data_array)<1 && $data[2]==1)
					{
					$data_array=sql_select("select id, quotation_id, item_id, rate,amount,status_active from  wo_pri_quo_comarcial_cost_dtls where quotation_id='$data[1]' order by id");
					$save_update=0;
					}
					if(count($data_array)<1 && $data[2]==1 && $data[6]==2)
					{
						$data_array=sql_select("select id as pri_id, quotation_id, item_id, rate,amount,status_active from  wo_pri_quo_comarcial_cost_dtls where quotation_id='$data[1]'  and status_active=1 and is_deleted=0 order by id");
						$save_update=0;
					}
					if(count($data_array)<1 && $data[2]==1 && ($commercial_cost_percent*1)==0){
						if($cost_control_source==7) //Quick Costing[Sweater]=7
						{
							$data_array=sql_select("select  b.cost_sheet_id as quotation_id, 4 as item_id, sum(a.commercial_per) as rate, sum(b.commercial_cost) as amount from  qc_tot_cost_summary a, qc_confirm_dtls b where a.mst_id=b.cost_sheet_id and b.cost_sheet_id='$data[1]' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.cost_sheet_id");
							$save_update=0;
						}
					}
					if ( count($data_array)>0)
					{
						$i=0;
						foreach( $data_array as $row )
						{
							$i++;
							?>
                            <tr id="comarcialtr_<?=$i; ?>" align="center">
                               <td><?= create_drop_down( "cboitem_".$i, 150, $camarcial_items, "",1," -- Select Item --", $row[csf("item_id")], "",$disabled,'' ); ?></td>
                               <td><input type="text" id="txtcomarcialrate_<? echo $i; ?>"  name="txtcomarcialrate_<? echo $i; ?>" class="text_boxes_numeric" style="width:90px" value="<? echo $row[csf("rate")]; ?>" onChange="calculate_comarcial_cost( <? echo $i;?>,'cal_amount' )" <? if($disabled==0){echo "";}else{echo "disabled";}?> <? if($readonly==0){echo "";}else{echo "readonly";}?> /></td>
                                <td><input type="text" id="txtcomarcialamount_<?=$i; ?>"  name="txtcomarcialamount_<? echo $i; ?>" class="text_boxes_numeric" style="width:110px" value="<? echo $row[csf("amount")]; ?>" onChange="calculate_comarcial_cost(<? echo $i;?>,'cal_rate')" <? if($disabled==0){echo "";}else{echo "disabled";}?>  <? if($readonly==0){echo "";}else{echo "readonly";}?> /> </td>

                                <td><?=create_drop_down( "cbocomarcialstatus_".$i, 95, $row_status,"", 0, "0", $row[csf("status_active")], '',$disabled,'' );  ?></td>
                                <td>
                                <input type="button" id="increasecomarcial_<? echo $i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_comarcial_cost(<? echo $i; ?> )" <? if($disabled==0){echo "";}else{echo "disabled";}?> />
                                <input type="button" id="decreasecomarcial_<? echo $i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<? echo $i; ?> ,'tbl_comarcial_cost' );" <? if($disabled==0){echo "";}else{echo "disabled";}?>/>
                                <input type="hidden" id="comarcialupdateid_<? echo $i; ?>" name="comarcialupdateid_<? echo $i; ?>"  class="text_boxes" style="width:20px" value="<? echo  $row[csf("id")]; ?>"  />
                                 </td>
                            </tr>
                            <?
						}
					}
					else
					{
						$save_update=0;
						?>
						<tr id="comarcialtr_1" align="center">
						   <td>
							<?
							echo create_drop_down( "cboitem_1", 150, $camarcial_items, "",0,"", 4, '','','' );
							?>
							</td>
						   <td>
							<input type="text" id="txtcomarcialrate_1"  name="txtcomarcialrate_1" class="text_boxes_numeric" style="width:90px"  onChange="calculate_comarcial_cost(1,'cal_amount')" value="<? echo $commercial_cost_percent; ?>" <? if($readonly==0){echo "";}else{echo "readonly";}?> />
							</td>
							<td>
							<input type="text" id="txtcomarcialamount_1"  name="txtcomarcialamount_1" class="text_boxes_numeric" style="width:110px"   onChange="calculate_comarcial_cost(1,'cal_rate')"  value="<? echo $com_amount; ?>" <? if($readonly==0){echo "";}else{echo "readonly";}?> />
							</td>
							<td width="95"><? echo create_drop_down( "cbocomarcialstatus_1", 95, $row_status,"", 0, "0", '', '','','' );  ?></td>
							<td>
							<input type="button" id="increasecomarcial_1" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr_comarcial_cost(1 )" />
							<input type="button" id="decreasecomarcial_1" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(1 ,'tbl_comarcial_cost' );" />
							<input type="hidden" id="comarcialupdateid_1" name="comarcialupdateid_1"  class="text_boxes" style="width:20px" value=""  />                            </td>
						</tr>
						<?
					}
					?>
                </tbody>
                </table>
                <table width="540" cellspacing="0" class="rpt_table" border="0" rules="all">
                	<tfoot>
                    	<tr>
                            <th width="150">Sum</th>
                            <th width="90">
                            <input type="text" id="txtratecomarcial_sum"  name="txtratecomarcial_sum" class="text_boxes_numeric" style="width:90px"  readonly />
                            </th>
                            <th width="110">
                            <input type="text" id="txtamountcomarcial_sum"  name="txtamountcomarcial_sum" class="text_boxes_numeric" style="width:110px"  readonly />
                            </th>
                            <th width="95" style="border:none"></th>
                            <th width="" style="border:none"></th>
                        </tr>
                    </tfoot>
                </table>
                <table width="540" cellspacing="0" class="" border="0">
                	<tr>
                        <td align="center" height="15" width="100%"> </td>
                    </tr>
                	<tr>
                        <td align="center" width="100%" class="button_container">

						<?
						if ( count($data_array)>0)
					    {
							echo load_submit_buttons( $permission, "fnc_comarcial_cost_dtls", $save_update,0,"reset_form('comarcial_9','','',0)",9) ;
					    }
						else
						{
							echo load_submit_buttons( $permission, "fnc_comarcial_cost_dtls", $save_update,0,"reset_form('comarcial_9','','',0)",9) ;
						}
						?>
                        </td>
                    </tr>
                </table>

            </form>
        </fieldset>
        </div>
	<?
	exit();
}

if($action=="sum_comarcial_cost_value")
{
	$data=explode("_",$data);
	$job_no=$data[0];
	$commercial_cost_method=$data[1];
	$amount=0;
	if($commercial_cost_method==1)//Yarn+Trims+Fabric Purchase
	{
		$data_array=sql_select("select (fab_amount+yarn_amount+trim_amount) as amount from wo_pre_cost_sum_dtls where job_no ='$job_no' and status_active=1 and is_deleted=0");
		foreach( $data_array as $row )
		{
			$amount=$row[csf("amount")];
		}
	}
	else if($commercial_cost_method==5 || $commercial_cost_method==6 || $commercial_cost_method==7)//Fabric Purchase + Trims Cost + Embellishment Cost + Garments Wash + Lab Test + Inspection + CM Cost + Freight + Courier Cost + Certificate Cost + Design Cost + Studio Cost + Operating Expenses
	{
		$amount=0;	
		$sql_fab="select amount as amount from wo_pre_cost_fabric_cost_dtls where job_no='$job_no' and fabric_source in (1,2) and status_active=1 and is_deleted=0";
		$data_fab=sql_select($sql_fab);
		$fab_amount=0;
		foreach($data_fab as $row )
		{
			$fab_amount+=$row[csf("amount")];
		}
		unset($data_fab);
		$sql_yarn="select amount as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0";
		$data_yarn=sql_select($sql_yarn);
		$yarn_amount=0;
		foreach($data_yarn as $row )
		{
			$yarn_amount+=$row[csf("amount")];
		}
		unset($data_yarn);
		//$data_array=sql_select("select trims_cost, embel_cost, wash_cost, lab_test, inspection, cm_cost, freight, currier_pre_cost, certificate_pre_cost, design_pre_cost, studio_pre_cost, common_oh from wo_price_quotation_costing_mst where quotation_id=$quotation_id and status_active=1 and is_deleted=0");
		$data_array=sql_select("select fabric_cost, trims_cost, embel_cost, wash_cost, lab_test, inspection, cm_cost, freight, currier_pre_cost, certificate_pre_cost, design_cost, studio_cost, common_oh from wo_pre_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0");
		$ft_amount=0;
		foreach( $data_array as $row )
		{
			if($commercial_cost_method==5)
			{
				$ft_amount=$row[csf("trims_cost")]+$row[csf("embel_cost")]+$row[csf("wash_cost")]+$row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("cm_cost")]+$row[csf("freight")]+$row[csf("currier_pre_cost")]+$row[csf("certificate_pre_cost")]+$row[csf("design_cost")]+$row[csf("studio_cost")]+$row[csf("common_oh")];
			}
			else if($commercial_cost_method==6)
			{
				$ft_amount=$row[csf("trims_cost")]+$row[csf("embel_cost")]+$row[csf("wash_cost")]+$row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("freight")]+$row[csf("currier_pre_cost")]+$row[csf("certificate_pre_cost")]+$row[csf("design_cost")]+$row[csf("studio_cost")]+$row[csf("common_oh")];
			}
			else if($commercial_cost_method==7)
			{
				$ft_amount=$row[csf("fabric_cost")]+$row[csf("trims_cost")]+$row[csf("embel_cost")]+$row[csf("wash_cost")]+$row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("freight")]+$row[csf("currier_pre_cost")]+$row[csf("certificate_pre_cost")]+$row[csf("design_cost")]+$row[csf("studio_cost")]+$row[csf("common_oh")];
			}
		}
		unset($data_array);
		if($commercial_cost_method!=7) $amount=$ft_amount+$yarn_amount+$fab_amount;
		else $amount=$ft_amount;
	}
	echo $amount;
	die;
}

if($action == "trims_cost_template_name_popup")
{
	extract($_REQUEST);
    echo load_html_head_contents("Popup Info", "../../../", 1, 1, $unicode);?>
    <script>
        var selected_name = new Array();
    	function fnc_close(data) {
            var data=data.split('_');
            var check_trims_data = return_global_ajax_value( data[1], 'check_trims_data', '', 'quotation_entry_controller');
            if(check_trims_data == 1)
            {
                 var r=confirm("If you want to replace previous data then press Ok, otherwise press Cancel");
                if(r==false)
                {
                    parent.emailwindow.hide();
                    return;
                }
                else
                {
                    document.getElementById('hidden_template_name').value=data[0];
                    parent.emailwindow.hide();
                }
            }
            else
            {
                document.getElementById('hidden_template_name').value=data[0];
                parent.emailwindow.hide();
            }

        }
        function insert_template_data(data,id)
        {
            var template_data=return_global_ajax_value( data, 'get_template_data', '', 'pre_cost_entry_controller_v2');
            var template_data=trim(template_data) ;
            var tbl_row_count = document.getElementById( 'template_name_tbl' ).rows.length;
            tbl_row_count = tbl_row_count-1;
            for(var i=0; i<tbl_row_count; i++){
                var color = document.getElementById( 'tempname'+i ).style.backgroundColor;
                if(color == "yellow"){
                   if(id%2==0  ){
                    toggle( document.getElementById( 'tempname' + i ), '#FFFFFF');
                    }
                    if(id%2!=0 ){
                    toggle( document.getElementById( 'tempname' + i ), '#E9F3FF');
                    }
                }
            }
            if(template_data)
            {
            	if(id%2==0  ){
                    toggle( document.getElementById( 'tempname' + id ), '#FFFFFF');
                }
                if(id%2!=0 ){
                    toggle( document.getElementById( 'tempname' + id ), '#E9F3FF');
                }
                $("tbody#template_date").html('');
                $("tbody#template_date").append(template_data);
                $('#check_all_tbl').css('display','block');
            }
        }
        function check_all_data() {
            var tbl_row_count = document.getElementById( 'template_data_tbl' ).rows.length-1;
            tbl_row_count = tbl_row_count;

            if(document.getElementById('check_all').checked){
                for( var i = 1; i <= tbl_row_count; i++ ) {
	                document.getElementById( 'search' + i ).style.backgroundColor = 'yellow';
	                if( jQuery.inArray( $('#txttemplatedata_' + i).val(), selected_name ) == -1 ) {
	                    selected_name.push($('#txttemplatedata_' + i).val());
	                }
                }
                var templatedata='';
                for( var i = 0; i < selected_name.length; i++ ) {
                    templatedata += selected_name[i] + ',';
                }
                templatedata = templatedata.substr( 0, templatedata.length - 1 );
                $('#select_template_data').val( templatedata );
            }else{
                for( var i = 1; i <= tbl_row_count; i++ ) {
                    if(i%2==0  ){
                        document.getElementById('search'+i).style.backgroundColor = '#FFFFFF';
                    }
                    if(i%2!=0 ){
                        document.getElementById('search'+i).style.backgroundColor = '#E9F3FF';
                    }
                    for( var j = 0; j < selected_name.length; j++ ) {
                        if( selected_name[j] == $('#txttemplatedata_' + i).val() ) break;
                    }
                    selected_name.splice( j,1 );

                }
                var templatedata='';
                for( var i = 0; i < selected_name.length; i++ ) {
                    templatedata += selected_name[i] + ',';
                }
                templatedata = templatedata.substr( 0, templatedata.length - 1 );
                $('#select_template_data').val( templatedata );

            }

        }

        function toggle( x, origColor) {
            var newColor = 'yellow';
            if ( x.style ) {
                x.style.backgroundColor = (newColor == x.style.backgroundColor)? origColor : newColor;

            }
        }

        function onlyUnique(value, index, self) {
            return self.indexOf(value) === index;
        }

        function js_set_value( str) {
        	var tbl_row_count = document.getElementById( 'template_data_tbl' ).rows.length;
            tbl_row_count = tbl_row_count-1;
            if($("#search"+str).css("display") !='none'){
                if(str%2==0  ){
                    toggle( document.getElementById( 'search' + str ), '#FFFFFF');
                }
                if(str%2!=0 ){
                    toggle( document.getElementById( 'search' + str ), '#E9F3FF');
                }
                if( jQuery.inArray( $('#txttemplatedata_' + str).val(), selected_name ) == -1 ) {
                    selected_name.push($('#txttemplatedata_' + str).val());
                }
                else{
                    for( var i = 0; i < selected_name.length; i++ ) {
                        if( selected_name[i] == $('#txttemplatedata_' + str).val() ) break;
                    }
                    selected_name.splice( i,1 );
                }
            }
            var templatedata='';
            for( var i = 0; i < selected_name.length; i++ ) {
                templatedata += selected_name[i] + ',';
            }
            if(selected_name.length == tbl_row_count){
				document.getElementById("check_all").checked = true;
			}
			else{
				document.getElementById("check_all").checked = false;
			}
            templatedata = templatedata.substr( 0, templatedata.length - 1 );
            $('#select_template_data').val( templatedata );
        }
    </script>
    <?
    $template_name_sql=sql_select("select a.template_name from sweater_lib_trim_cost_temp a,sweater_lib_trim_cost_temp_dtls b where a.id=b.lib_trim_costing_temp_id and b.buyer_id =$buyer_name and a.is_deleted=0 group by  a.template_name");
	//echo "select distinct a.template_name from sweater_lib_trim_cost_temp a,sweater_lib_trim_cost_temp_dtls b where a.id=b.lib_trim_costing_temp_id and b.buyer_id =$buyer_name and a.is_deleted=0 group by  a.template_name";
  //  $template_name_sql=sql_select("select distinct template_name from sweater_lib_trim_cost_temp where is_deleted=0 and related_buyer in($buyer_name)");
	//echo "select distinct template_name from sweater_lib_trim_cost_temp where is_deleted=0 and related_buyer in($buyer_name)";
	//echo $buyer_name.'SASASAS';;

      ?>
    </head>
    <body>
    <div align="center" style="width:100%;">
    	<div style="width:200px; float: left">
	    	<table cellspacing="0" cellpadding="0" border="1" rules="all" width="200" class="rpt_table" align="left">
	    		<tr>
	    			<input id="hidden_template_name" type="hidden" name="hidden_template_name">
	    			<th width="100"><h3>Template Name</h3></th>
	    		</tr>
	    	</table>
            <table cellspacing="0" cellpadding="0" border="1" rules="all" class="rpt_table" align="left" width="200" id="template_name_tbl">
	    		<?
	    		$i=0;
	    		foreach ($template_name_sql as $row){
	    		if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF"; ?>
	    		<tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" onClick="insert_template_data('<? echo $row[csf("template_name")] ?>',<? echo $i ?>)" id="tempname<? echo $i; ?>">
	    			<td width="100" align="center"><span style="font-size: 14px"><? echo $row[csf("template_name")]; ?></span></td>
	    		</tr>
	    		<? $i++; } ?>

	    	</table>
    	</div>
        <table id="trmplate_data_tbl" cellspacing="0" cellpadding="0" border="1" rules="all" width="850" class="rpt_table">
            <input type="hidden" id="select_template_data" name="select_template_data"/>
            <thead>
                <tr>
                	<th width="50">SL</th>
                    <th width="100">User Code</th>
                    <th width="100">Group</th>
                    <th width="100">Description</th>
                    <th width="100">Brand/Sup Ref.</th>
                    <th width="100">Nominated Supp</th>
                    <th width="70">Cons UOM</th>
                    <th width="80">Apvl Req.</th>
                </tr>
            </thead>
        </table>
        <table id="template_data_tbl" cellspacing="0" cellpadding="0" border="1" rules="all" width="850" class="rpt_table">
            <tbody id="template_date">
            </tbody>
        </table>
        <table width="420" id="check_all_tbl" cellspacing="0" cellpadding="0" style="border:none; display: none; margin-top: 10px" align="center">
        <tr>
            <td align="center" height="30" width="200" valign="bottom">
                <div style="width:300px">

                    <div style="width:150px; float:left" align="left">
                        <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                    </div>
                    <div style="width:150px; float:left" align="left">
                        <input type="button" name="close" onClick="parent.emailwindow.hide();" class="formbutton" value="Close" style="width:100px" />
                    </div>
                </div>
            </td>
        </tr>
    </table>
    </div>
    </body>
    <script type="text/javascript">
        setFilterGrid("template_name_tbl",-1);
    </script>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
    exit();
}
if($action == "check_trims_data"){
     $trims_cost=sql_select("select id from wo_pre_cost_trim_cost_dtls where job_no='$data' and status_active=1 and is_deleted=0");
        if(count($trims_cost) > 0 ){
            echo 1;
            exit();
        }
        else{
            echo 0;
            exit();
        }
}

if($action == "get_template_data")
{
    $trim_variable=1;
    $trim_variable_sql=sql_select("select trim_rate from  variable_order_tracking where company_name='$data[4]' and variable_list=35 order by id");
    foreach($trim_variable_sql as $trim_variable_row)
    {
        $trim_variable= $trim_variable_row[csf('trim_rate')];
    }
    $lib_item_group_arr=return_library_array( "select item_name,id from lib_item_group where item_category=4 and is_deleted=0 and status_active=1 order by item_name", "id", "item_name");
    $trim_rate_from_library=return_library_array( "select a.id, min(b.rate) as rate from lib_item_group a, lib_item_group_rate b where a.id=b.mst_id and a.item_category=4 and a.status_active=1 and    a.is_deleted=0 group by a.id", "id", "rate");
    $supplier_library=return_library_array( "select a.supplier_name, a.id from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type in(4,5) and a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
    $data_array=sql_select("SELECT * from sweater_lib_trim_cost_temp where template_name='$data' and status_active=1 and is_deleted=0 order by id");
    $i=1;
    foreach( $data_array as $row )
    {
        $rate=$trim_rate_from_library[$row[csf('trims_group')]];
        $amount=$row[csf('cons_dzn_gmts')]*$trim_rate_from_library[$row[csf('trims_group')]];
        if($rate=="" || $rate==0)
        {
            $rate=$row[csf('purchase_rate')];
            $amount=$row[csf('amount')];
        }
        if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
		if($row[csf('total_cons')]=="" || $row[csf('total_cons')]==0) $row[csf('total_cons')]=$row[csf('cons_dzn_gmts')];
        $str="";
        $str=$lib_item_group_arr[$row[csf("trims_group")]].'***'.$row[csf('user_code')].'***'.$row[csf('trims_group')].'***'.$row[csf('cons_uom')].'***'.$row[csf('cons_dzn_gmts')].'***'.$row[csf('purchase_rate')].'***'.$row[csf('amount')].'***'.$row[csf('apvl_req')].'***'.$row[csf('supplyer')].'***'.$row[csf('sup_ref')].'***'.$row[csf('item_description')].'***'.$row[csf('id')].'***'.$row[csf('extra_rate')].'***'.$row[csf('total_cons')];
		
     ?>
        <tr bgcolor="<? echo $bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="search<? echo $i;?>" class="itemdata" onClick="js_set_value(<? echo $i; ?>)" >
        	<td width="50"><? echo $i ?></td>
            <td width="100">
                <? echo $row[csf("user_code")]; ?>
                <input type="hidden" name="txttemplatedata_<? echo $i; ?>" id="txttemplatedata_<? echo $i; ?>" value="<? echo $str; ?>"/>
                </td>
            <td width="100"><? echo $lib_item_group_arr[$row[csf("trims_group")]]; ?></td>
            <td width="100"><? echo $row[csf("item_description")];?></td>
            <td width="100"><? echo $row[csf("sup_ref")]; ?></td>
            <td width="100"><? echo $supplier_library[$row[csf("supplyer")]]; ?></td>
            <td width="80"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
            <td width="70"><? echo $yes_no[$row[csf("apvl_req")]]; ?></td>
        </tr>

    <?  $i++; } ?>
    <script type="text/javascript">
        setFilterGrid("template_data_tbl",-1);
    </script>
    <?
    exit();
}

if ($action=="save_update_delet_comarcial_cost_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$sql=sql_select("select approval_need from approval_setup_mst a,approval_setup_dtls b where a.id=b.mst_id and a.company_id=$cbo_company_name and b.page_id=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.setup_date");
	$app_nessity=2;
	foreach($sql as $row){
		$app_nessity=$row[csf('approval_need')];
	}

	$sql=sql_select("select approved from wo_price_quotation  where id=$txt_quotation_id");
	$quatation_approved=2;
	foreach($sql as $row){
		$quatation_approved=$row[csf('approved')];
	}

	$is_copy_quatation=str_replace("'","",$copy_quatation_id);
	//echo "10**",$is_copy_quatation."**". $app_nessity."**".$quatation_approved;
	//die;
	if($is_copy_quatation==1 && $app_nessity==1){
		if($quatation_approved==2 || $quatation_approved==0 || $quatation_approved==3){
			echo "quataNotApp**".str_replace("'","",$txt_job_no);
			disconnect($con);die;
		}
	}
	
	$materialReciveNo="";
	$sql=sql_select("select a.recv_number from inv_receive_master a, inv_transaction b, wo_po_break_down c where a.id=b.mst_id and b.job_no=c.job_no_mst and b.job_no=$update_id and a.entry_form=248 and c.is_confirmed=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by a.recv_number");
	foreach($sql as $row)
	{
		if($materialReciveNo=="") $materialReciveNo=$row[csf('recv_number')]; else $materialReciveNo.=','.$row[csf('recv_number')];
	}
	if($materialReciveNo!=""){
		echo "materialRecive**".$materialReciveNo;
		disconnect($con);die;
	}
	
	if($operation==0)
	{
	    $con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		$approved=0;
			$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$update_id");
			foreach($sql as $row){
				if($row[csf('approved')]==3){
					$approved=1;
				}else{
					$approved=$row[csf('approved')];
				}
			}
			if($approved==1){
				echo "approved**".str_replace("'","",$update_id);
			disconnect($con);	die;
			}
		 if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0";disconnect($con); die;}
		 $id=return_next_id( "id", "wo_pre_cost_comarci_cost_dtls", 1 ) ;
		 $field_array="id, job_id, job_no, item_id, rate, amount, inserted_by, insert_date, status_active, is_deleted ";
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cboitem="cboitem_".$i;
			 $txtcomarcialrate="txtcomarcialrate_".$i;
			 $txtcomarcialamount="txtcomarcialamount_".$i;
			 $cbocomarcialstatus="cbocomarcialstatus_".$i;
			 $comarcialupdateid="comarcialupdateid_".$i;
			 if ($i!=1) $data_array .=",";
			 $data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cboitem.",".$$txtcomarcialrate.",".$$txtcomarcialamount.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbocomarcialstatus.",0)";
			 $id=$id+1;
		 }
		 $rID=sql_insert("wo_pre_cost_comarci_cost_dtls",$field_array,$data_array,0);
		 //=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, comar_rate, comar_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtratecomarcial_sum.",".$txtamountcomarcial_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="comar_rate*comar_amount";
			$data_array2 ="".$txtratecomarcial_sum."*".$txtamountcomarcial_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		//=======================sum End =================
		check_table_status( $_SESSION['menu_id'],0);
		//echo "10**".$rID.'--'.$rID2; die;
		if($db_type==0)
		{
			if($rID )
			{
				mysql_query("COMMIT");
				echo "0**".$new_job_no[0]."**".$rID;
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID )
			{
				oci_commit($con);
				echo "0**".$new_job_no[0]."**".$rID;
			}
			else
			{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		disconnect($con);
		die;
	}
	else if($operation==1)
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		$component_approved=return_field_value("current_approval_status", "co_com_pre_costing_approval", "job_no=$update_id and cost_component_id=6");
		if($component_approved==3){
			$component_approved=1;
		}
		$approved=0;
		$sql=sql_select("select approved from wo_pre_cost_mst where job_no=$update_id");
		foreach($sql as $row){
			if($row[csf('approved')]==3){
				$approved=1;
			}else{
				$approved=$row[csf('approved')];
			}
		}
		if($approved==1 || $component_approved==1){
			echo "approved**".str_replace("'","",$update_id);
			disconnect($con);die;
		}
		 if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**1"; die;}
		 $field_array_up="item_id*rate*amount*updated_by*update_date*status_active*is_deleted ";
		 $field_array="id, job_id, job_no, item_id, rate, amount, inserted_by, insert_date, status_active, is_deleted ";
		 $add_comma=0;
		 $id=return_next_id( "id", "wo_pre_cost_comarci_cost_dtls", 1 ) ;
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $cboitem="cboitem_".$i;
			 $txtcomarcialrate="txtcomarcialrate_".$i;
			 $txtcomarcialamount="txtcomarcialamount_".$i;
			 $cbocomarcialstatus="cbocomarcialstatus_".$i;
			 $comarcialupdateid="comarcialupdateid_".$i;
			if(str_replace("'",'',$$comarcialupdateid)!="")
			{
				$id_arr[]=str_replace("'",'',$$comarcialupdateid);
			    $data_array_up[str_replace("'",'',$$comarcialupdateid)] =explode(",",("".$$cboitem.",".$$txtcomarcialrate.",".$$txtcomarcialamount.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbocomarcialstatus.",0"));
			}
			if(str_replace("'",'',$$comarcialupdateid)=="")
			{
			    if ($add_comma!=0) $data_array .=",";
			    $data_array .="(".$id.",".$hidd_job_id.",".$update_id.",".$$cboitem.",".$$txtcomarcialrate.",".$$txtcomarcialamount.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$$cbocomarcialstatus.",0)";
			    $id=$id+1;
			    $add_comma++;
			}
		 }
         $rID=execute_query(bulk_update_sql_statement( "wo_pre_cost_comarci_cost_dtls", "id", $field_array_up, $data_array_up, $id_arr ));
		 if($data_array !="")
		 {
			 $rID=sql_insert("wo_pre_cost_comarci_cost_dtls",$field_array,$data_array,0);
		 }
 		 //=======================sum=================
		$wo_pre_cost_sum_dtls_job_no="";
		$queryText= "select job_no from  wo_pre_cost_sum_dtls where job_no =$update_id";
		$nameArray=sql_select( $queryText );
	    foreach ($nameArray as $result)
		{
		    $wo_pre_cost_sum_dtls_job_no= $result[csf('job_no')];
		}
		if($wo_pre_cost_sum_dtls_job_no=="")
		{
			$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="id, job_id, job_no, comar_rate, comar_amount";
			$data_array2="(".$wo_pre_cost_sum_dtls_id.",".$hidd_job_id.",".$update_id.",".$txtratecomarcial_sum.",".$txtamountcomarcial_sum.")";
			$rID2=sql_insert("wo_pre_cost_sum_dtls",$field_array2,$data_array2,1);
		}
		if($wo_pre_cost_sum_dtls_job_no!="")
		{
			//$wo_pre_cost_sum_dtls_id=return_next_id( "id", "wo_pre_cost_sum_dtls", 1 ) ;
			$field_array2="comar_rate*comar_amount";
			$data_array2 ="".$txtratecomarcial_sum."*".$txtamountcomarcial_sum."";
			$rID2=sql_update("wo_pre_cost_sum_dtls",$field_array2,$data_array2,"job_no","".$update_id."",1);
		}
		//=======================sum End =================
		check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID )
			{
				mysql_query("COMMIT");
				echo "1**".$new_job_no[0]."**".$rID;
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID )
			{
				oci_commit($con);
				echo "1**".$new_job_no[0]."**".$rID;
			}
			else
			{
				oci_rollback($con);
				echo "10**".$new_job_no[0]."**".$rID;
			}
		}
		disconnect($con);
		die;
	}
}
//*************************************************Comarcial Cost End ***********************************************
/*if($action=="create_quotation_id_list_view")
{

	$data=explode('_',$data);
	//print_r($data);
	if ($data[0]!=0) $company=" and company_id='$data[0]'"; else { echo "Please Select Company First."; die; }

	if ($data[1]!=0) $buyer=" and buyer_id='$data[1]'"; else { echo "Please Select Buyer First."; die; }

	//if ($data[2]!=0) $buyer=" and a.buyer_name='$data[2]'"; else { echo "Please Select CHEK First."; die; } die;

	if ($data[2]!="" &&  $data[3]!="") $est_ship_date  = "and est_ship_date  between '".change_date_format($data[3], "yyyy-mm-dd", "-")."' and '".change_date_format($data[4], "yyyy-mm-dd", "-")."'"; else $est_ship_date ="";

	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$arr=array (1=>$comp,2=>$buyer_arr,5=>$pord_dept);
	$sql= "select id,company_id, buyer_id, style_ref,style_desc,pord_dept,offer_qnty,est_ship_date from  wo_price_quotation a where status_active=1  and is_deleted=0 $company $buyer order by id";
	echo  create_list_view("list_view", "Quotation ID,Company,Buyer Name,Style Ref,Style Desc.,Prod. Dept., Offer Qnty, Est Ship Date", "90,120,100,100,200,100,100","1000","320",0, $sql , "js_set_value", "id", "", 1, "0,company_id,buyer_id,0,0,pord_dept,0,0", $arr , "id,company_id,buyer_id,style_ref,style_desc,pord_dept,offer_qnty,est_ship_date", "",'','0,0,0,0,0,0,2,3') ;


} */

// report generate here
// report start

if($action=="preCostRpt"){
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";
	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($db_type==0){
	   $costing_date=change_date_format($txt_costing_date, "yyyy-mm-dd", "-");
	}
	if($db_type==2){
		$costing_date=change_date_format($txt_costing_date, "yyyy-mm-dd", "-",1)	;
	}
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and b.costing_date='".$txt_costing_date."'";
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');

	if($db_type==0){
		$sqlcpm=sql_select("select cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and '$costing_date' between applying_period_date and applying_period_to_date  and status_active=1 and is_deleted=0 LIMIT 1");
	}
	if($db_type==2){
		 $sqlcpm=sql_select("select cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and '$costing_date' between applying_period_date and applying_period_to_date and status_active=1 and is_deleted=0");
	}

	$cpm='';
	foreach($sqlcpm as $sqlcpmrow){
		$cpm=$sqlcpmrow[csf('cost_per_minute')];
	}
	if($db_type==0) $group_gsm="group_concat( distinct b.gsm_weight) AS gsm_weight";
	if($db_type==2) $group_gsm="listagg(b.gsm_weight ,',') within group (order by b.gsm_weight) AS gsm_weight";

	$gsm_weight_top=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and a.body_part_type=1","gsm_weight");
	$gsm_weight_bottom=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and a.body_part_type=20 ","gsm_weight");

	//echo $gsm_weight_top.'='.$gsm_weight_bottom;
	// $gsm_weight_top=return_field_value("gsm_weight", "wo_pre_cost_fabric_cost_dtls", "job_no=$txt_job_no and body_part_id=1");
	// $gsm_weight_bottom=return_field_value("gsm_weight", "wo_pre_cost_fabric_cost_dtls", "job_no=$txt_job_no and body_part_id=20");
	 $po_qty=0;
	 $po_plun_cut_qty=0;
	 $total_set_qnty=0;
	 $sql_po="select a.job_no,a.total_set_qnty,b.id,c.item_number_id,c.country_id,c.color_number_id,c.size_number_id,c.order_quantity ,c.plan_cut_qnty  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst   and b.id=c.po_break_down_id  and a.job_no =".$txt_job_no."   and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 order by b.id";
	$sql_po_data=sql_select($sql_po);
	foreach($sql_po_data as $sql_po_row)
	{
	$po_qty+=$sql_po_row[csf('order_quantity')];
	$po_plun_cut_qty+=$sql_po_row[csf('plan_cut_qnty')];
	$total_set_qnty=$sql_po_row[csf('total_set_qnty')];
	}
	$fab_knit_req_kg_avg=0;
	$fab_woven_req_yds_avg=0;

	if($db_type==0)
	{
	$sql = "select a.job_no,a.company_name,a.buyer_name,a.style_ref_no,a.gmts_item_id,a.order_uom,a.job_quantity,a.avg_unit_price,b.costing_per,b.budget_minute,b.approved,b.sew_smv,b.sew_effi_percent,c.fab_knit_req_kg,c.fab_knit_fin_req_kg,c.fab_woven_req_yds,c.fab_woven_fin_req_yds,c.fab_yarn_req_kg from wo_po_details_master a, wo_pre_cost_mst b left join wo_pre_cost_sum_dtls c on   b.job_no=c.job_no where a.job_no=b.job_no  and a.status_active=1 $job_no $company_name $cbo_buyer_name $txt_style_ref $txt_costing_date order by a.job_no";
	}
	if($db_type==2)
	{
	$sql = "select a.job_no,a.company_name,a.buyer_name,a.style_ref_no,a.gmts_item_id,a.order_uom,a.job_quantity,a.avg_unit_price,b.costing_per,b.budget_minute,b.approved,b.sew_smv,b.sew_effi_percent,c.fab_knit_req_kg,c.fab_knit_fin_req_kg,c.fab_woven_req_yds,c.fab_woven_fin_req_yds,c.fab_yarn_req_kg from wo_po_details_master a, wo_pre_cost_mst b left join wo_pre_cost_sum_dtls c on   b.job_no=c.job_no where a.job_no=b.job_no and a.status_active=1 $job_no $company_name $cbo_buyer_name $txt_style_ref order by a.job_no";
	}

	$data_array=sql_select($sql);


	?>
    <div style="width:850px; font-size:20px; font-weight:bold" align="center"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></div>
    <div style="width:850px; font-size:14px; font-weight:bold" align="center">Pre- Costing</div>
	<?
	$uom="";
	foreach ($data_array as $row)
	{
		$order_price_per_dzn=0;
		$order_job_qnty=0;
		$avg_unit_price=0;

		$order_values = $row[csf("job_quantity")]*$row[csf("avg_unit_price")];
		$result =sql_select("select po_number,grouping,file_no,pub_shipment_date from wo_po_break_down where job_no_mst=$txt_job_no and status_active=1 and is_deleted=0 order by pub_shipment_date DESC");
		$job_in_orders = '';$pulich_ship_date='';$job_in_file = '';$job_in_ref = '';
		foreach ($result as $val)
		{
			$job_in_orders .= $val[csf('po_number')].", ";
			$pulich_ship_date = $val[csf('pub_shipment_date')];
			$job_in_ref.=$val[csf('grouping')].",";
			$job_in_file.=$val[csf('file_no')].",";

		}
		$job_in_orders = substr(trim($job_in_orders),0,-1);

		$job_ref=array_unique(explode(",",rtrim($job_in_ref,", ")));
		$job_file=array_unique(explode(",",rtrim($job_in_file,", ")));

		foreach ($job_ref as $ref)
		{
			$ref_cond.=", ".$ref;
		}
		$file_con='';
		foreach ($job_file as $file)
		{
			if($file_con=='') $file_cond=$file; else $file_cond.=", ".$file;
		}

		?>
            	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
                	<tr>
                    	<td width="80">Job Number</td>
                        <td width="80"><b><? echo $row[csf("job_no")]; ?></b></td>
                        <td width="90">Buyer</td>
                        <td width="100"><b><? echo $buyer_arr[$row[csf("buyer_name")]]; ?></b></td>
                        <td width="80">Garments Item</td>
                        <?
							$grmnt_items = "";
							if($garments_item[$row[csf("gmts_item_id")]]=="")
							{

								$grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no=$txt_job_no");
								foreach($grmts_sql as $key=>$val){
									$grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].", ";
								}
								$grmnt_items = substr_replace($grmnt_items,"",-1,1);
							}else{
								$grmnt_items = $garments_item[$row[csf("gmts_item_id")]];
							}

						?>
                        <td width="100"><b><? echo $grmnt_items; ?></b></td>
                    </tr>
                    <tr>
                    	<td>Style Ref. No </td>
                        <td colspan="3"><b><? echo $row[csf("style_ref_no")]; ?></b></td>

                        <td>Job Qnty</td>
                        <td><b><? $uom=$row[csf("order_uom")]; echo $row[csf("job_quantity")]." ". $unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
                    </tr>
                    <tr>
                    	<td>Order Numbers</td>
                        <td colspan="3"><? echo $job_in_orders; ?></td>
                        <td>Plun Cut Qnty</td>
                        <td><b><? $uom=$row[csf("order_uom")]; echo $po_plun_cut_qty/$total_set_qnty." ". $unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
                    </tr>
                    <tr>
                    	<td>Knit Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_knit_req_kg")];$fab_knit_req_kg_avg+=$row[csf("fab_knit_req_kg")]; ?> (Kg)</b></td>

                        <td>Woven Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_woven_req_yds")];$fab_woven_req_yds_avg+= $row[csf("fab_woven_req_yds")];?> (Yds)</b></td>
                        <td>Price Per Unit</td>
                        <td><b><? echo $row[csf("avg_unit_price")]; ?> USD</b></td>
                    </tr>
                    <tr>
                    	<td>Avg Yarn Req</td>
                        <td><b><? echo $row[csf("fab_yarn_req_kg")] ?> (Kg)</b></td>
                        <td>Costing Per</td>
                        <td><b><? echo $costing_per[$row[csf("costing_per")]]; ?></b></td>
                        <td>Shipment Date </td>
                        <td><b><? echo change_date_format($pulich_ship_date); ?></b></td>
                    </tr>
                    <tr>
                    <td>Knit Fin Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_knit_fin_req_kg")] ?> (Kg)</b></td>
                        <td>Woven Fin Fabric Cons</td>
                        <td><b><? echo $row[csf("fab_woven_fin_req_yds")]; ?>(Yds)</b></td>
                    	<td>GSM </td>
                        <td><b><? //echo $gsm_weight_top.",".$gsm_weight_bottom

						$gsm_weights_top=implode(",",array_unique(explode(",",$gsm_weight_top)));
						$gsm_weight_bottom=implode(",",array_unique(explode(",",$gsm_weight_bottom)));
						if($gsm_weights_top!='') $gsm_weightTop=$gsm_weights_top;else $gsm_weightTop='';
						if($gsm_weight_bottom!='' && $gsm_weights_top!='') $gsm_weightBottom=" ,".$gsm_weight_bottom;
						else if($gsm_weight_bottom!='' && $gsm_weights_top=='') $gsm_weightBottom=$gsm_weight_bottom;
						else $gsm_weightBottom='';
						echo $gsm_weightTop .$gsm_weightBottom;
						 ?></b></td>

                    </tr>
                     <tr>
                     <td>SMV</td>
                    <td><b><? echo $row[csf("sew_smv")] ?> </b></td>
                     <td>CPM</td>
                    <td><b><? echo $cpm; ?> </b></td>
                    <td>Budget Minuite</td>
                        <td><b><? echo $row[csf("budget_minute")] ?> </b></td>
                    </tr>

                    <tr>
                    <td>Efficiency</td>
                    <td colspan="1"><b><? echo $row[csf("sew_effi_percent")] ?> </b></td>
                    <td>Internal Ref</td>
                    <td colspan="1"><b><? echo ltrim($ref_cond,", "); ?> </b></td>
                    <td>File No</td>
                    <td colspan="1"><b><? echo $file_cond; ?></b></td>
                    </tr>
                    <tr>
                    <td align="center" height="10" colspan="6" valign="top" id="app_sms" style="font-size:18px;"><font color="#FF0000"><? if( $row[csf("approved")]==1 || $row[csf("approved")]==3){echo "This Job is Approved ";} else {echo "";} ?> </font> </td>
                    </tr>
                </table>
            <?
			if($row[csf("costing_per")]==1){$order_price_per_dzn=12; $costing_for=" DZN";}
			else if($row[csf("costing_per")]==2){$order_price_per_dzn=1; $costing_for=" PCS";}
			else if($row[csf("costing_per")]==3){$order_price_per_dzn=24; $costing_for=" 2 DZN";}
			else if($row[csf("costing_per")]==4){$order_price_per_dzn=36; $costing_for=" 3 DZN";}
			else if($row[csf("costing_per")]==5){$order_price_per_dzn=48; $costing_for=" 4 DZN";}
			$order_job_qnty=$row[csf("job_quantity")];
			$avg_unit_price=$row[csf("avg_unit_price")];
	}//end first foearch


	//id, fab_yarn_req_kg,fab_woven_req_yds,fab_knit_req_kg,fab_amount,yarn_cons_qnty,yarn_amount,conv_req_qnty,conv_charge_unit,conv_amount,trim_cons,trim_rate,trim_amount,emb_amount,comar_rate,comar_amount,commis_rate,commis_amount
	// 	costing_per_id 	order_uom_id 	fabric_cost 	fabric_cost_percent 	trims_cost 	trims_cost_percent 	embel_cost
	//embel_cost_percent 	comm_cost 	comm_cost_percent 	commission 	commission_percent 	lab_test 	lab_test_percent 	inspection
	//inspection_percent 	cm_cost,cm_cost_percent 	freight,freight_percent,common_oh,common_oh_percent,total_cost ,total_cost_percent
	// 	price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
	//margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche


	//start	all summary report here -------------------------------------------
	$sql = "select fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,wash_cost,wash_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,currier_pre_cost,currier_percent,certificate_pre_cost,certificate_percent,common_oh,common_oh_percent,total_cost ,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
	from wo_pre_cost_dtls
	where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	$others_cost_value=0;
	$fabric_cost=0;
	$trims_cost=0;
	$embel_cost=0;
	$comm_cost=0;
	$commission=0;
	$lab_test=0;
	$inspection=0;
	$cm_cost=0;
	$freight=0;
	$currier_pre_cost=0;
	$certificate_pre_cost=0;
	$common_oh=0;
 	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80">SL</td>
                    <td width="300">Particulars</td>
                    <td width="100">Cost</td>
                    <td width="100">Amount (USD)</td>
                    <td width="180">% to Ord. Value</td>
                </tr>
            <?
			$price_dzn=0;
            $sl=0;
            foreach( $data_array as $row )
            {
			$fabric_cost=$row[csf("fabric_cost")];
			$trims_cost=$row[csf("trims_cost")];
			$embel_cost=$row[csf("embel_cost")];
			$comm_cost=$row[csf("comm_cost")];
			$commission=$row[csf("commission")];
			$lab_test=$row[csf("lab_test")];
			$inspection=$row[csf("inspection")];
			$cm_cost=$row[csf("cm_cost")];
			$freight=$row[csf("freight")];
			$currier_pre_cost=$row[csf("currier_pre_cost")];
			$certificate_pre_cost=$row[csf("certificate_pre_cost")];
			$common_oh=$row[csf("common_oh")];
				$sl=$sl+1;
  				$others_cost_value=$row[csf("total_cost")]-$row[csf("cm_cost")]-$row[csf("freight")]-$row[csf("comm_cost")]-$row[csf("commission")];
				if($zero_value==1)
				{

?>
                <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left"><b>Order Price/<? echo $costing_for; ?></b></td>
                    <td></td>
                    <td align="right"><b><? echo number_format($row[csf("price_dzn")],4);$price_dzn=$row[csf("price_dzn")];//$avg_unit_price*$order_price_per_dzn ?></b></td>
                    <td align="center"><? echo "100.00%"; ?></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">All Fabric Cost</td>
                    <td align="right"><? echo number_format($row[csf("fabric_cost")],4); ?></td>
                    <td align="right" rowspan="13">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("fabric_cost_percent")],2); ?>%</td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Trims Cost</td>
                    <td align="right"><? echo number_format($row[csf("trims_cost")],4); ?></td>
                    <td align="center"><? echo number_format($row[csf("trims_cost_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Embellishment Cost</td>
                    <td align="right"><? echo number_format($row[csf("embel_cost")],4); ?></td>
                    <td align="center"><? echo number_format($row[csf("embel_cost_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Gmts Wash</td>
                    <td align="right"><? echo number_format($row[csf("wash_cost")],4); ?></td>
                    <td align="center"><? echo number_format($row[csf("wash_cost_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commercial Cost</td>
                    <td align="right"><? echo number_format($row[csf("comm_cost")],4); ?></td>
                    <td align="center"><? echo number_format($row[csf("comm_cost_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commission Cost</td>
                    <td align="right"><? echo number_format($row[csf("commission")],4); ?></td>
                    <td align="center"><? echo number_format($row[csf("commission_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo number_format($row[csf("lab_test")],4); ?></td>
                    <td align="center"><? echo number_format($row[csf("lab_test_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo number_format($row[csf("inspection")],4); ?></td>
                    <td align="center"><? echo number_format($row[csf("inspection_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CM Cost</td>
                    <td align="right"><? echo number_format($row[csf("cm_cost")],4); ?></td>
                    <td align="center"><? echo number_format($row[csf("cm_cost_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo number_format($row[csf("freight")],4); ?></td>
                    <td align="center"><? echo number_format($row[csf("freight_percent")],2); ?>%</td>
                 </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Currier Cost</td>
                    <td align="right"><? echo number_format($row[csf("currier_pre_cost")],4); ?></td>
                    <td align="center"><? echo number_format($row[csf("currier_percent")],2); ?>%</td>
                 </tr>
                  <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Certificate Cost</td>
                    <td align="right"><? echo number_format($row[csf("certificate_pre_cost")],4); ?></td>
                    <td align="center"><? echo number_format($row[csf("certificate_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Office OH </td>
                    <td align="right"><? echo number_format($row[csf("common_oh")],4); ?></td>
                    <td align="center"><? echo number_format($row[csf("common_oh_percent")],2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"><b>Total Cost (2:14)</b></td>
                    <td>&nbsp;</td>
                    <td align="right"><b><? echo number_format($row[csf("total_cost")],4); ?></b></td>
                    <td align="center"><b><? echo number_format($row[csf("total_cost_percent")],2); ?>%</b></td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?> (1-15)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo number_format($row[csf("margin_dzn")],4); ?></td>
                    <td align="center"><b><? $margin_dzn_percent=($row[csf("margin_dzn")]/$row[csf("price_dzn")])*100; echo number_format($margin_dzn_percent,2); ?>%</b></td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Price /<? echo $costing_for; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo number_format($row[csf("price_pcs_or_set")],4); ?></td>
                    <td align="right"></td>
                </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Cost /<? echo $costing_for; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo number_format($row[csf("total_cost")]/$order_price_per_dzn,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo number_format($row[csf("margin_pcs_set")],4); ?></td>
                    <td align="right"></td>
                </tr>

            <?
				}
				else
				{
					?>
                 <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left"><b>Order Price/<? echo $costing_for; ?></b></td>
                    <td></td>
                    <td align="right"><b><? echo number_format($row[csf("price_dzn")],4);//$avg_unit_price*$order_price_per_dzn ?></b></td>
                    <td align="center"><? echo "100.00%"; ?></td>
                </tr>
                <?
				if($row[csf("fabric_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">All Fabric Cost</td>
                    <td align="right"><? echo number_format($row[csf("fabric_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("fabric_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("trims_cost")]!=0)
				{
				?>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Trims Cost</td>
                    <td align="right"><? echo number_format($row[csf("trims_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("trims_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("embel_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Embellishment Cost</td>
                    <td align="right"><? echo number_format($row[csf("embel_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("embel_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("wash_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Gmts Wash</td>
                    <td align="right"><? echo number_format($row[csf("wash_cost")],4); ?></td>
                    <td align="center"><? echo number_format($row[csf("wash_cost_percent")],2); ?>%</td>
                </tr>

                <?
				}
				if($row[csf("comm_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commercial Cost</td>
                    <td align="right"><? echo number_format($row[csf("comm_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("comm_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("commission")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commission Cost</td>
                    <td align="right"><? echo number_format($row[csf("commission")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("commission_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("lab_test")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo number_format($row[csf("lab_test")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("lab_test_percent")],2); ?>%</td>
                 </tr>
                <?
				}
				if($row[csf("inspection")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo number_format($row[csf("inspection")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("inspection_percent")],2); ?>%</td>
                 </tr>
                 <?
				}
				if($row[csf("cm_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CM Cost</td>
                    <td align="right"><? echo number_format($row[csf("cm_cost")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("cm_cost_percent")],2); ?>%</td>
                 </tr>
                 <?
				}
				if($row[csf("freight")]!=0)

				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo number_format($row[csf("freight")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("freight_percent")],2); ?>%</td>
                 </tr>
                <?
				}
				if($row[csf("common_oh")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Office OH </td>
                    <td align="right"><? echo number_format($row[csf("common_oh")],4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("common_oh_percent")],2); ?>%</td>
                 </tr>
                 <?
				}
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"><b>Total Cost (2:<? echo $sl-1;?>)</b></td>
                    <td>&nbsp;</td>
                    <td align="right"><b><? echo number_format($row[csf("total_cost")],4); ?></b></td>
                    <td align="center"><b><? echo number_format($row[csf("total_cost_percent")],2); ?>%</b></td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?> (1-<? echo $sl-1;?>)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo number_format($row[csf("margin_dzn")],4); ?></td>
                    <td align="center"><b><? $margin_dzn_percent=($row[csf("margin_dzn")]/$row[csf("price_dzn")])*100; echo number_format($margin_dzn_percent,2); ?>%</b></td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Price / <? echo $costing_for; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo number_format($row[csf("price_pcs_or_set")],4); ?></td>
                    <td align="right"></td>
                </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Cost /<? echo $costing_for; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo number_format($row[csf("total_cost")]/$order_price_per_dzn,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo number_format($row[csf("margin_pcs_set")],4); ?></td>
                    <td align="right"></td>
                </tr>
                    <?
				}
            }
            ?>
            </table>
      </div>
      <?
	//End all summary report here -------------------------------------------



	    $sql = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description,uom, avg_cons,avg_cons_yarn, fabric_source,gsm_weight, rate, amount,avg_finish_cons,status_active   from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no."";

		$data_array=sql_select($sql);
		$knit_fab="";$woven_fab="";
		$knit_subtotal_avg_cons=0;
		$knit_subtotal_amount=0;
		$woven_subtotal_avg_cons=0;
		$woven_subtotal_amount=0;
		$grand_total_amount=0;
        $i=3;$j=2;
		foreach( $data_array as $row )
        {
			$uom=$unit_of_measurement[$row[csf("uom")]];
            if($row[csf("fab_nature_id")]==2)//knit fabrics
			{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")].", ".$row[csf("gsm_weight")];
				if($row[csf("fabric_source")] !=2){
				$amount=$row[csf("avg_cons_yarn")]*$row[csf("rate")];
				}
				else{
				$amount=$row[csf("avg_cons")]*$row[csf("rate")];
				}
				$percent_to_order_value=$amount/$price_dzn*100;
				$i++;
                $knit_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.number_format($row[csf("avg_cons")],4).'</td>
					 <td align="right">'.number_format($row[csf("avg_cons_yarn")],4).'</td>
					  <td align="left">'.$uom.'</td>
                    <td align="right">'.number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.number_format($amount,4).'</td>
					<td align="right">'.number_format($percent_to_order_value,2).'%</td>
                </tr>';
					if($row[csf("uom")]==12){
						$knit_subtotal_avg_cons += $row[csf("avg_cons")];
						$knit_subtotal_avg_cons_yarn += $row[csf("avg_cons_yarn")];
						if($row[csf("fabric_source")] !=2){
						$knit_subtotal_amount += $row[csf("avg_cons_yarn")]*$row[csf("rate")];
						}
						else{
							$knit_subtotal_amount += $row[csf("avg_cons")]*$row[csf("rate")];
						}
					}
					if($row[csf("uom")]==27){
						$knit_subtotal_avg_cons_yds += $row[csf("avg_cons")];
						$knit_subtotal_avg_cons_yarn_yds += $row[csf("avg_cons_yarn")];
						if($row[csf("fabric_source")] !=2){
						$knit_subtotal_amount_yds += $row[csf("avg_cons_yarn")]*$row[csf("rate")];
						}
						else{
							$knit_subtotal_amount_yds += $row[csf("avg_cons")]*$row[csf("rate")];
						}
					}
			}

			if($row[csf("fab_nature_id")]==3)//woven fabrics
			{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")].", ".$row[csf("gsm_weight")];
				$amount=$row[csf("avg_cons_yarn")]*$row[csf("rate")];
				$percent_to_order_value=$amount/$price_dzn*100;
				$j++;
                $woven_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.number_format($row[csf("avg_cons")],4).'</td>
					<td align="right">'.number_format($row[csf("avg_cons_yarn")],4).'</td>
					 <td align="left">'.$uom.'</td>
                    <td align="right">'.number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.number_format($amount,4).'</td>
					<td align="right">'.number_format($percent_to_order_value,2).'%</td>
                </tr>';

				$woven_subtotal_avg_cons += $row[csf("avg_cons")];
				$woven_subtotal_avg_cons_yarn += $row[csf("avg_cons_yarn")];
				$woven_subtotal_amount += $row[csf("avg_cons_yarn")]*$row[csf("rate")];
			}
        }

		$knit_fab= '<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
					<label><b>All Fabric Cost  </b></label>
						<tr style="font-weight:bold"  align="center">
							<td width="80" rowspan="'.$i.'" ><div class="verticalText"><b>Knit Fabric</b></div></td>
							<td width="350">Description</td>
							<td width="100">Source</td>
							<td width="100">Fab. Cons/'.$costing_for.'</td>
							<td width="100">Avg. Fab. Cons/'.$costing_for.'</td>
							<td width="100">UOM</td>
							<td width="100">Rate (USD)</td>
							<td width="100">Amount (USD)</td>
							<td width="100">% to Ord. Value</td>
						</tr>'.$knit_fab;
		$woven_fab= '<tr><td colspan="8">&nbsp;</td></tr><tr>
						<td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;

		//knit fabrics table here
		$fab_knit_req_kg_avg_amount=$knit_subtotal_amount/$knit_subtotal_avg_cons*$fab_knit_req_kg_avg;
		$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total (Kg)</td>
						<td align="right">'.number_format($knit_subtotal_avg_cons,4).'</td>
						<td align="right">'.number_format($knit_subtotal_avg_cons_yarn,4).'</td>
						<td></td>
						<td></td>
						<td align="right">'.number_format($knit_subtotal_amount,4).'</td>
						<td align="right">'.number_format($knit_subtotal_amount/$price_dzn*100,2).'%</td>
					</tr>';
		$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total(Yds)</td>
						<td align="right">'.number_format($knit_subtotal_avg_cons_yds,4).'</td>
						<td align="right">'.number_format($knit_subtotal_avg_cons_yarn_yds,4).'</td>
						<td></td>
						<td></td>
						<td align="right">'.number_format($knit_subtotal_amount_yds,4).'</td>
						<td align="right">'.number_format($knit_subtotal_amount_yds/$price_dzn*100,2).'%</td>
					</tr>';
					/*$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total (Avg)</td>
						<td align="right">'.number_format($fab_knit_req_kg_avg,4).'</td>
						<td align="right">'.number_format($fab_knit_req_kg_avg,4).'</td>
						<td></td>
						<td align="right">'.number_format($fab_knit_req_kg_avg_amount,4).'</td>
					</tr>';*/
					if($zero_value==1)
					{
  		               echo $knit_fab;
					}
					else
					{
						if($row[csf("avg_cons")]>0)
						{
							echo $knit_fab;
						}
						else
						{
							echo "";
						}

					}

		//woven fabrics table here
		$fab_woven_req_yds_avg_amount=$woven_subtotal_amount/$woven_subtotal_avg_cons*$fab_woven_req_yds_avg;
		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total</td>
						<td align="right">'.number_format($woven_subtotal_avg_cons,4).'</td>
						<td align="right">'.number_format($woven_subtotal_avg_cons_yarn,4).'</td>
						<td></td>
						<td></td>
						<td align="right">'.number_format($woven_subtotal_amount,4).'</td>
						<td align="right">'.number_format($woven_subtotal_amount/$price_dzn*100,2).'%</td>
					</tr>';
					/*$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2" align="left">Sub Total (Avg)</td>
						<td align="right">'.number_format($fab_woven_req_yds_avg,4).'</td>
						<td align="right">'.number_format($fab_woven_req_yds_avg,4).'</td>
						<td></td>
						<td align="right">'.number_format($fab_woven_req_yds_avg_amount,4).'</td>
					</tr>';*/
   					$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="4" align="left">Total</td>
						<td align="right"></td>
						<td></td>
						<td></td>
						<td align="right">'.number_format(($woven_subtotal_amount+$knit_subtotal_amount),4).'</td>
						<td align="right">'.number_format((($woven_subtotal_amount+$knit_subtotal_amount)/$price_dzn*100),2).'%</td>
					</tr></table></div>';
					/*$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="4" align="left">Total (Avg)</td>
						<td align="right"></td>
						<td></td>
						<td align="right">'.number_format(($fab_woven_req_yds_avg_amount+$fab_knit_req_kg_avg_amount),4).'</td>
					</tr></table></div>';*/
        // echo $woven_fab;
		 if($zero_value==1)
					{
  		               echo $woven_fab;
					}
					else
					{
						if($row[csf("avg_cons")]>0)
						{
							echo $woven_fab;
						}
						else
						{
							echo "";
						}

					}
  		$grand_total_amount = $knit_subtotal_amount+$woven_subtotal_amount;
		//end 	All Fabric Cost part report-------------------------------------------


		//Start	Yarn Cost part report here -------------------------------------------
		$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count"  );
		//mysql
		/*$sql = "select id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, cons_ratio, sum(cons_qnty) as cons_qnty, rate, sum(amount) as amount
				from wo_pre_cost_fab_yarn_cost_dtls
				where job_no=".$txt_job_no." group by count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, rate";*/
				//oracle
				$sql = "select min(id) as id, count_id, copm_one_id, percent_one, copm_two_id, percent_two,color,type_id, min(cons_ratio) as cons_ratio , sum(cons_qnty) as cons_qnty,sum(avg_cons_qnty) as avg_cons_qnty, rate, sum(amount) as amount
				from wo_pre_cost_fab_yarn_cost_dtls
				where job_no=".$txt_job_no." group by count_id, copm_one_id, percent_one, copm_two_id, percent_two,color, type_id, rate";
		$data_array=sql_select($sql);
		if($zero_value==1)
		{
		?>
        <div style="margin-top:15px">
        	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="70" rowspan="<? echo count($data_array)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
                    <td width="350">Yarn Desc</td>
                    <td width="100">Yarn Qty</td>
                    <td width="100">Avg.Yarn Qty</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                   <td width="100">% to Ord. Value</td>
                </tr>
			<?
            $total_qnty=0;  $total_avg_qnty=0;$total_amount=0;
			foreach( $data_array as $row )
            {
				if($row[csf("percent_one")]==100)
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
            	else
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];

			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="right"><? echo number_format($row[csf("cons_qnty")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("avg_cons_qnty")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
				 $total_qnty += $row[csf("cons_qnty")];
				  $total_avg_qnty += $row[csf("avg_cons_qnty")];
				 $total_amount += $row[csf("amount")];
            }
            ?>
            	<tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo number_format($total_qnty,4); ?></td>
                     <td align="right"><? echo number_format($total_avg_qnty,4); ?></td>
                    <td></td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                    <td align="right"><? echo number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
        	</table>
      </div>
      <?
	  $grand_total_amount +=$total_amount;
	  }
	  else
	  {
		  if($fabric_cost>0)
		  {
		  ?>
           <div style="margin-top:15px">
        	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="70" rowspan="<? echo count($data_array)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
                    <td width="350">Yarn Desc</td>
                    <td width="100">Yarn Qnty</td>
                     <td width="100">Avg.Yarn Qnty</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
			<?
            $total_qnty=0;$total_amount=0;
			foreach( $data_array as $row )
            {
				if($row[csf("percent_one")]==100)
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
            	else
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];

			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="right"><? echo number_format($row[csf("cons_qnty")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("avg_cons_qnty")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")],4); ?></td>
                     <td align="right"><? echo number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
				 $total_qnty += $row[csf("cons_qnty")];
				  $total_avg_qnty += $row[csf("avg_cons_qnty")];
				 $total_amount += $row[csf("amount")];
            }
            ?>
            	<tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo number_format($total_qnty,4); ?></td>
                     <td align="right"><? echo number_format($total_avg_qnty,4); ?></td>
                    <td></td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                    <td align="right"><? echo number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
        	</table>
      </div>
      <?
	      $grand_total_amount +=$total_amount;
		  }
		  else
		  {
			 echo "";
		  }
	  }
	//End Yarn Cost part report here -------------------------------------------



  	//start	Conversion Cost to Fabric report here -------------------------------------------
   	$sql = "select a.id,a.fabric_description as fabric_description_id, a.job_no, a.cons_process, a.req_qnty,a.avg_req_qnty, a.charge_unit, a.amount, a.status_active,b.body_part_id,b.fab_nature_id,b.color_type_id,b.fabric_description
			from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id
			where a.job_no=".$txt_job_no." ";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($data_array)+3; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Avg. Cons/<? echo $costing_for; ?></td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                     <td width="100">% to Ord. Value</td>
                </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
			if($row[csf("fabric_description_id")] !=0)
			{
 				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
			}
			else
			{
				$item_descrition = "All Fabrics";
			}
			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="left"><? echo $conversion_cost_head_array[$row[csf("cons_process")]]; ?></td>
                    <td align="right"><? echo number_format($row[csf("req_qnty")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("avg_req_qnty")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("charge_unit")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="5">Total</td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                    <td align="right"><? echo  number_format($total_amount/$price_dzn*100,2);?>%</td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="5">Total Fabric Cost</td>
                    <td align="right"><? echo number_format(($grand_total_amount+$total_amount),4); ?></td>
                    <td align="right"><? echo number_format((($grand_total_amount+$total_amount)/$price_dzn*100),2); ?>%</td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($fabric_cost>0)
		{
	?>
     <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($data_array)+3; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Avg. Cons/<? echo $costing_for; ?></td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
			if($row[csf("fabric_description_id")] !=0)
			{
 				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
			}
			else
			{
				$item_descrition = "All Fabrics";
			}
			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="left"><? echo $conversion_cost_head_array[$row[csf("cons_process")]]; ?></td>
                    <td align="right"><? echo number_format($row[csf("req_qnty")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("avg_req_qnty")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("charge_unit")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">

                    <td colspan="5">Total</td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                    <td align="right"><? echo number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="5">Total Fabric Cost</td>
                    <td align="right"><? echo number_format(($grand_total_amount+$total_amount),4); ?></td>
                     <td align="right"><? echo number_format((($grand_total_amount+$total_amount)/$price_dzn*100),2); ?>%</td>
                </tr>
            </table>
      </div>
    <?
		}
		else
		{
			echo "";
		}
	}
	//End Conversion Cost to Fabric report here -------------------------------------------



  	//start	Trims Cost part report here -------------------------------------------
   	$sql = "select id, job_no, trim_group,description,brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,status_active,seq
			from wo_pre_cost_trim_cost_dtls
			where job_no=".$txt_job_no." order by seq";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row[csf("trim_group")], "id", "item_name"  );

			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                    <td align="left"><? echo $row[csf("description")]; ?></td>
                    <td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                    <td align="right"><? echo number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="6">Total</td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                    <td align="right"><? echo number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($trims_cost>0)
		{
	?>
    <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row[csf("trim_group")], "id", "item_name"  );

			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                    <td align="left"><? echo $row[csf("description")]; ?></td>
                    <td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                    <td align="right"><? echo number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="6">Total</td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                    <td align="right"><? echo number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
      </div>
	<?
		}
		else
		{
		   echo "";
		}
	}
	 //End Trims Cost Part report here -------------------------------------------



	//start	Embellishment Details part report here -------------------------------------------
    	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active
			from wo_pre_cost_embe_cost_dtls
			where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				$em_type ="";
				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")],4); ?></td>
                     <td align="right"><? echo number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                    <td align="right"><? echo number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($embel_cost>0)
		{
	?>
     <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/<? echo $costing_for; ?></td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
 				$em_type ="";
				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                    <td align="right"><? echo number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
      </div>
    <?
		}
		else
		{
			echo "";
		}
	}
	 //End Embellishment Details Part report here -------------------------------------------


  	//start	Commercial Cost part report here -------------------------------------------
   	$sql = "select id, job_no, item_id, rate, amount, status_active
			from  wo_pre_cost_comarci_cost_dtls
			where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate In %</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($comm_cost>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
			echo "";
		}

	}
	 //End Commercial Cost Part report here -------------------------------------------


  	//start	Commission Cost part report here -------------------------------------------
   	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active
			from  wo_pre_cost_commiss_cost_dtls
			where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>


        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                    <td align="right"><? echo number_format($row[csf("commision_rate")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("commission_amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("commission_amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3">Total</td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($commission>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                    <td align="right"><? echo number_format($row[csf("commision_rate")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("commission_amount")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("commission_amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3">Total</td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
		   echo "";
		}

	}
	 //End Commission Cost Part report here -------------------------------------------


	//start	Other Components part report here -------------------------------------------
   	$sql = "select id,job_no,costing_per_id,order_uom_id,fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,total_cost,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
			from wo_pre_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	if($zero_value==1)
	{
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Others Components</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
  			?>

                <tr>
                    <td align="left"s>Lab Test </td>
                    <td align="right"><? echo number_format($row[csf("lab_test")],4); ?></td>
                </tr>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo number_format($row[csf("inspection")],4); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo number_format($row[csf("cm_cost")],4); ?></td>
                </tr>
                <tr>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo number_format($row[csf("freight")],4); ?></td>
                </tr>
                <tr>
                    <td align="left">Office OH</td>
                    <td align="right"><? echo number_format($row[csf("common_oh")],4); ?></td>
                </tr>
            <?
                 $total_amount += $row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("cm_cost")]+$row[csf("freight")]+$row[csf("common_oh")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	}
	else
	{
		if($lab_test>0 || $inspection>0 || $cm_cost>0 || $freight>0 || $common_oh>0)
		{
		?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Others Components</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                 </tr>
            <?
            $total_amount=0;
            foreach( $data_array as $row )
            {
				if($row[csf("lab_test")]>0)
				{
  			?>


                <tr>
                    <td align="left"s>Lab Test </td>
                    <td align="right"><? echo number_format($row[csf("lab_test")],4); ?></td>
                </tr>
                <?
				}
				if($row[csf("inspection")]>0)
				{
				?>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo number_format($row[csf("inspection")],4); ?></td>
                </tr>
                <?
				}
				if($row[csf("cm_cost")]>0)
				{
				?>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo number_format($row[csf("cm_cost")],4); ?></td>
                </tr>
                <?
				}
				if($row[csf("freight")]>0)
				{
				?>
                <tr>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo number_format($row[csf("freight")],4); ?></td>
                </tr>
                 <?
				}
				if($row[csf("common_oh")]>0)
				{
				?>
                <tr>
                    <td align="left">Office OH</td>
                    <td align="right"><? echo number_format($row[csf("common_oh")],4); ?></td>
                </tr>
            <?
				}
                 $total_amount += $row[csf("lab_test")]+$row[csf("inspection")]+$row[csf("cm_cost")]+$row[csf("freight")]+$row[csf("common_oh")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                </tr>
            </table>
      </div>
        <?
		}
		else
		{
			echo "";
		}

	}
	 //End Other Components  Part report here -------------------------------------------



  	//start	CM on Net Order Value part report here -------------------------------------------
    	$sql = "select id,job_no,costing_per_id,order_uom_id,fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,total_cost,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
			from wo_pre_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	foreach( $data_array as $row );
	$order_net_value = 0;
	?>

        <div style="margin-top:15px">
        <div style="float:left">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
            <label><b>CM on Net Order Value</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">%</td>
                </tr>
                <tr>
                    <td align="left">Order Value </td>
                    <td align="right"><? echo number_format($order_values,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Commission </td>
                    <td align="right"><? $less_commission = $row[csf("commission")]/$order_price_per_dzn*$order_job_qnty; echo number_format($less_commission,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Commercial Cost </td>
                    <td align="right"><? $less_commercial = $row[csf("comm_cost")]/$order_price_per_dzn*$order_job_qnty; echo number_format($less_commercial,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Freight</td>
                    <td align="right"><? $less_freight = $row[csf("freight")]/$order_price_per_dzn*$order_job_qnty; echo number_format($less_freight,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Net Order Value</td>
                    <td align="right"><? $order_net_value=$order_values-($less_commission+$less_commercial+$less_freight);echo number_format($order_net_value,4); ?></td>
                    <td align="center"><? echo number_format($order_net_value/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">Other Cost</td>
                    <td align="right"><? $otherCost=$others_cost_value/$order_price_per_dzn*$order_job_qnty; echo number_format($otherCost,4); ?></td>
                    <td align="center"><? echo number_format($otherCost/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Value</td>
                    <td align="right"><? $cmValue = $order_net_value-$otherCost; echo number_format($cmValue,4); ?></td>
                    <td align="center"><? echo number_format($cmValue/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">CM /<? echo $costing_for; ?></td>
                    <td align="right"><? $cmPerDzn=$cmValue/$order_job_qnty*$order_price_per_dzn; echo number_format($cmPerDzn,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td align="left">CM Cost /<? echo $costing_for; ?></td>
                    <td align="right"><? echo number_format($row[csf("cm_cost")],4); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Margin /<? echo $costing_for; ?></td>
                    <td align="right"><? echo number_format($cmPerDzn-$row[csf("cm_cost")],4); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>

            </table>
      </div>
      <div style="margin-left:5px;float:left;">
      		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
            <label><b>Cost Summary for order quantity</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">%</td>
                </tr>

                <tr>
                    <td align="left">Total Order Value </td>
                    <td align="right"><? $total_order_val = $order_job_qnty*$avg_unit_price; echo number_format($total_order_val,4); ?></td>
                    <td align="center"><? echo number_format($total_order_val/$total_order_val*100,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Total Cost </td>
                    <td align="right"><?  $total_cost = $row[csf("total_cost")]/$order_price_per_dzn*$order_job_qnty; echo number_format($total_cost,4); ?></td>
                    <td align="center"><? echo number_format($total_cost/$total_order_val*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Margin </td>
                    <td align="right"><? $margin_val = $total_order_val-$total_cost; echo number_format($margin_val,4); ?></td>
                    <td align="center"><? echo number_format($margin_val/$total_order_val*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Margin /<? echo $costing_for; ?> </td>
                    <td align="right"><? echo number_format($margin_val/$order_job_qnty*$order_price_per_dzn,2); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>

           </table>
      </div>

       <?
     	 // image show here  -------------------------------------------
		$sql = "select id,master_tble_id,image_location
				from common_photo_library
				where master_tble_id=".$txt_job_no."";
		$data_array=sql_select($sql);
 	  ?>
          <div style="margin:15px 5px;float:left;width:500px" >
          	<? foreach($data_array AS $inf){ ?>
                <img  src='../../<? echo $inf[csf("image_location")]; ?>' height='97' width='89' />
            <?  } ?>
          </div>


      <div style="clear:both"></div>
      </div>
	<? echo "<br /><b>Note: Other Cost =  Fabric Cost + Trims Cost + Embellishment Cost + Lab Test + Inspection + Office OH</b><br /><br />"; ?>
    <br/>
 	<?
     echo signature_table(109, $cbo_company_name, "860px");
	 exit();
}//end master if condition-------------------------------------------------------


if($action=="preCostRpt2")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";

	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and b.costing_date='".$txt_costing_date."'";

	//array for display name
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');

	$po_qty=0; $po_plun_cut_qty=0; $total_set_qnty=0; $job_in_orders = '';$pulich_ship_date='';$job_in_file = '';$job_in_ref = '';
	$sql_po="select a.job_no, a.total_set_qnty, b.id, b.po_number, b.grouping, b.file_no, b.pub_shipment_date, c.item_number_id, c.country_id, c.color_number_id, c.size_number_id, c.order_quantity, c.plan_cut_qnty from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and a.job_no =".$txt_job_no." and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 order by b.id ASC";
	$sql_po_data=sql_select($sql_po); $gmts_item_color_qty_arr=array();
	foreach($sql_po_data as $sql_po_row)
	{
		$po_qty+=$sql_po_row[csf('order_quantity')];
		$po_plun_cut_qty+=$sql_po_row[csf('plan_cut_qnty')];
		$total_set_qnty=$sql_po_row[csf('total_set_qnty')];
		
		$job_in_orders .= $sql_po_row[csf('po_number')].",";
		$pulich_ship_date.= change_date_format($sql_po_row[csf('pub_shipment_date')]).",";
		$job_in_file .= $sql_po_row[csf('file_no')].",";
		$job_in_ref .= $sql_po_row[csf('grouping')].",";
		$gmts_item_color_qty_arr[$sql_po_row[csf('item_number_id')]][$sql_po_row[csf('color_number_id')]]+=$sql_po_row[csf('plan_cut_qnty')];
	}
	unset($sql_po_data);
	
	$job_in_orders = implode(", ",array_unique(explode(",",rtrim($job_in_orders,","))));
	$pulich_ship_date = implode(", ",array_unique(explode(",",rtrim($pulich_ship_date,","))));
	$job_ref=array_unique(explode(",",rtrim($job_in_ref,", ")));
	$job_file=array_unique(explode(",",rtrim($job_in_file,", ")));

	foreach ($job_ref as $ref){
		$ref_cond.=", ".$ref;
	}
	$file_con='';
	foreach ($job_file as $file){
		if($file_con=='') $file_cond=$file; else $file_cond.=", ".$file;
	}

	//echo $po_qty;

	$gmtsitem_ratio_array=array(); $grmnt_items = "";
	$gmtsitem_ratio_sql=sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no =".$txt_job_no."");// where job_no ='FAL-14-01157'
	foreach($gmtsitem_ratio_sql as $gmtsitem_ratio_sql_row){
		$gmtsitem_ratio_array[$gmtsitem_ratio_sql_row[csf('job_no')]][$gmtsitem_ratio_sql_row[csf('gmts_item_id')]]=$gmtsitem_ratio_sql_row[csf('set_item_ratio')];
		
		$grmnt_items .=$garments_item[$gmtsitem_ratio_sql_row[csf("gmts_item_id")]].", ";
	}
	unset($gmtsitem_ratio_sql);
	$costing_per_arr=return_library_array( "select job_no,costing_per from wo_pre_cost_mst where job_no =".$txt_job_no."", "job_no", "costing_per");// where job_no ='FAL-14-01157'
	$financial_para=array();
	$sql_std_para=sql_select("select interest_expense,income_tax,cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and status_active=1 and	is_deleted=0 order by id");
	foreach($sql_std_para as $sql_std_row){
		$financial_para[interest_expense]=$sql_std_row[csf('interest_expense')];
		$financial_para[income_tax]=$sql_std_row[csf('income_tax')];
		$financial_para[cost_per_minute]=$sql_std_row[csf('cost_per_minute')];
	}
	unset($sql_std_para);
	
	$fab_knit_req_kg_avg=0; $fab_woven_req_yds_avg=0;
	
	$sql = "select a.job_no, a.company_name, a.buyer_name, a.style_ref_no, a.quotation_id, a.gmts_item_id, a.order_uom, a.job_quantity, a.avg_unit_price, b.costing_per, b.budget_minute, b.sew_smv, b.cut_smv, b.sew_effi_percent, b.cut_effi_percent, b.approved, c.fab_knit_req_kg, c.fab_knit_fin_req_kg, c.fab_woven_req_yds, c.fab_woven_fin_req_yds, c.fab_yarn_req_kg from wo_po_details_master a, wo_pre_cost_mst b left join wo_pre_cost_sum_dtls c on b.job_no=c.job_no where a.job_no=b.job_no  and a.status_active=1 $job_no $company_name $cbo_buyer_name $txt_style_ref order by a.job_no";
	
	$avg_yarn_cons=0; $yarn_cons_lbs=0;
	$avg_yarn_sql = sql_select("select job_no, avg_cons_qnty, consdznlbs from wo_pre_cost_fab_yarn_cost_dtls where job_no=$txt_job_no and status_active=1 and is_deleted=0");
	foreach($avg_yarn_sql as $row)
	{
		$avg_yarn_cons+=$row[csf("avg_cons_qnty")];
		$yarn_cons_lbs+=$row[csf("consdznlbs")];
	}
	unset($avg_yarn_sql);
	
	$data_array=sql_select($sql);
	?>
    <div style="width:850px; font-size:20px; font-weight:bold" align="center"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></div>
    <div style="width:850px; font-size:14px; font-weight:bold" align="center">Pre- Costing</div>
	<?
	$uom=""; $sew_smv=0; $cut_smv=0; $sew_effi_percent=0; $cut_effi_percent=0;
	foreach ($data_array as $row)
	{
		$order_price_per_dzn=0; $order_job_qnty=0; $avg_unit_price=0;
		$sew_smv=$row[csf("sew_smv")];
	    $cut_smv=$row[csf("cut_smv")];
	    $sew_effi_percent=$row[csf("sew_effi_percent")];
	    $cut_effi_percent=$row[csf("cut_effi_percent")];
		$order_values = $row[csf("job_quantity")]*$row[csf("avg_unit_price")];


		?>
        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
            <tr>
                <td width="80">Job Number</td>
                <td width="80"><b><? echo $row[csf("job_no")]; ?></b></td>
                <td width="90">Buyer</td>
                <td width="100"><b><? echo $buyer_arr[$row[csf("buyer_name")]]; ?></b></td>
                <td width="80">Garments Item</td>
                <?
                    if($garments_item[$row[csf("gmts_item_id")]]=="") $grmnt_items = substr_replace($grmnt_items,"",-1,1);
                    else $grmnt_items = $garments_item[$row[csf("gmts_item_id")]];
                ?>
                <td width="100"><b><? echo $grmnt_items; ?></b></td>
            </tr>
            <tr>
                <td>Style Ref. No </td>
                <td colspan=""><b><? echo $row[csf("style_ref_no")]; ?></b></td>

                <td>Job Qty</td>
                <td><b><? $JobQty=$row[csf("job_quantity")]; $uom=$row[csf("order_uom")]; echo $row[csf("job_quantity")]." ". $unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
                 <td>Knitting Qty</td>
               <td><b><? echo $po_plun_cut_qty/$total_set_qnty." ". $unit_of_measurement[$row[csf("order_uom")]];?></b></td>
            </tr>
            <tr>
                <td>Order Numbers</td>
                <td colspan="5"><? echo $job_in_orders; ?></td>
            </tr>
            <tr>
                <td>Price Per Unit</td>
                <td><b><? echo $row[csf("avg_unit_price")]; ?> USD</b></td>
                <td>Costing Per</td>
                <td><b><? echo $costing_per[$row[csf("costing_per")]];?></b></td>
                <td>Budget Minuite</td>
                <td><b><? echo $row[csf("budget_minute")] ?> </b></td>
            </tr>
            <tr>
                <td>Shipment Date </td>
                <td colspan="3" style="word-break:break-all"><b><? echo $pulich_ship_date; ?></b></td>
                <td>Quotation ID</td>
                <td><b><? echo $row[csf("quotation_id")] ?> </b></td>
            </tr>
            <tr>
             	<td>Internal Ref</td>
                <td colspan="2"><b><? echo ltrim($ref_cond,", "); ?></b></td>
                <td>File No</td>
                <td colspan="2"><b><? echo $file_cond; ?></b></td>
            </tr>
            <tr>
             	<td>Avg Yarn Req</td>
                <td><b><? echo number_format($avg_yarn_cons,4); ?>(Kg)</b></td>
                <td><b><? echo number_format($yarn_cons_lbs,4); ?>(LBS)</b></td>
                <td>&nbsp;</td>
                <td colspan="2">&nbsp;</td>
            </tr>
            
            <tr>
                <td align="center" height="10" colspan="6" valign="top" id="app_sms" style="font-size:18px;"><font color="#FF0000"><? if( $row[csf("approved")]==1  ){echo "This Job is Approved ";} else if($row[csf("approved")]==3){echo "This Job is Partially Approved ";} else {echo "";} ?> </font> </td>
                
            </tr>
        </table>
		<?
        if($row[csf("costing_per")]==1){
            $order_price_per_dzn=12;
            $costing_for=" DZN";
        }
        else if($row[csf("costing_per")]==2){
            $order_price_per_dzn=1;
            $costing_for=" PCS";
        }
        else if($row[csf("costing_per")]==3){
            $order_price_per_dzn=24;
            $costing_for=" 2 DZN";
        }
        else if($row[csf("costing_per")]==4){
            $order_price_per_dzn=36;
            $costing_for=" 3 DZN";
        }
        else if($row[csf("costing_per")]==5){
            $order_price_per_dzn=48;
            $costing_for=" 4 DZN";
        }
        $order_job_qnty=$row[csf("job_quantity")];
        $avg_unit_price=$row[csf("avg_unit_price")];
	}
	unset($data_array);
	//end first foearch
	//start	all summary report here -------------------------------------------
	$condition= new condition();
	if(str_replace("'","",$txt_job_no) !=''){
		$condition->job_no("=$txt_job_no");
	}
	if(str_replace("'",'',$txt_po_breack_down_id) !=""){
		$condition->po_id("in($txt_po_breack_down_id)");
	}
	$condition->init();
	$fabric= new fabric($condition);
	$yarn= new yarn($condition);
	$conversion= new conversion($condition);
	$trim= new trims($condition);
	$emblishment= new emblishment($condition);
	$wash= new wash($condition);
	$other= new other($condition);
	$other_cost=$other->getAmountArray_by_job();
	$commercial= new commercial($condition);
	$commision= new commision($condition);

	$sql_new = "select job_no, fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent, wash_cost, wash_cost_percent, comm_cost, comm_cost_percent, commission, commission_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, freight, freight_percent, currier_pre_cost, currier_percent, certificate_pre_cost, certificate_percent, common_oh, common_oh_percent, depr_amor_pre_cost, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set, margin_pcs_set_percent, cm_for_sipment_sche, design_cost, design_percent, studio_cost, studio_percent
	from wo_pre_cost_dtls
	where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array_new=sql_select($sql_new);
	$summary_data=array();

	foreach( $data_array_new as $row_new )
	{
		$summary_data[price_dzn]=$row_new[csf("price_dzn")];
		$summary_data[price_dzn_job]=($po_qty/($total_set_qnty*$order_price_per_dzn))*$row_new[csf("price_dzn")];
		$summary_data[commission]=$row_new[csf("commission")];
		$summary_data[trims_cost]=$row_new[csf("trims_cost")];
		$summary_data[emb_cost]=$row_new[csf("embel_cost")];

		$summary_data[lab_test]=$row_new[csf("lab_test")];
		$summary_data[lab_test_job]=$other_cost[$row_new[csf("job_no")]]['lab_test'];

		$summary_data[inspection]=$row_new[csf("inspection")];
		$summary_data[inspection_job]=$other_cost[$row_new[csf("job_no")]]['inspection'];

		$summary_data[freight]=$row_new[csf("freight")];
		$summary_data[freight_job]=$other_cost[$row_new[csf("job_no")]]['freight'];

		$summary_data[design]=$row_new[csf("design_cost")];
		$summary_data[design_job]=$row_new[csf("design_cost")]/$order_price_per_dzn*$po_qty;

		$summary_data[studio]=$row_new[csf("studio_cost")];
		$summary_data[studio_job]=$row_new[csf("studio_cost")]/$order_price_per_dzn*$po_qty;

		$summary_data[currier_pre_cost]=$row_new[csf("currier_pre_cost")];
		$summary_data[currier_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['currier_pre_cost'];

		$summary_data[certificate_pre_cost]=$row_new[csf("certificate_pre_cost")];
		$summary_data[certificate_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['certificate_pre_cost'];
		$summary_data[wash_cost]=$row_new[csf("wash_cost")];

		$summary_data[OtherDirectExpenses]=$row_new[csf("lab_test")]+$row_new[csf("inspection")]+$row_new[csf("design_cost")]+$row_new[csf("studio_cost")]+$row_new[csf("freight")]+$row_new[csf("currier_pre_cost")]+$row_new[csf("certificate_pre_cost")]+$row_new[csf("wash_cost")];

		$summary_data[OtherDirectExpenses_job]=$summary_data[lab_test_job]+$summary_data[inspection_job]+$summary_data[design_job]+$summary_data[studio_job]+$summary_data[freight_job]+$summary_data[currier_pre_cost_job]+$summary_data[certificate_pre_cost_job];

		$summary_data[cm_cost]=$row_new[csf("cm_cost")];
		$summary_data[cm_cost_job]=$other_cost[$row_new[csf("job_no")]]['cm_cost'];

		$summary_data[comm_cost]=$row_new[csf("comm_cost")];
		
		$summary_data[yarn_fabric_dzn]=$row_new[csf("fabric_cost")];

		$summary_data[common_oh]=$row_new[csf("common_oh")];
		$summary_data[common_oh_job]=$other_cost[$row_new[csf("job_no")]]['common_oh'];
		$summary_data[depr_amor_pre_cost]=$row_new[csf("depr_amor_pre_cost")];
		$summary_data[depr_amor_pre_cost_job]=$other_cost[$row_new[csf("job_no")]]['depr_amor_pre_cost'];
	}
	unset($data_array_new);

	//Fabric =====================
	$fabric_qty=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$fabric_amount=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	 $sql_fabric = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description,uom, avg_cons,avg_cons_yarn, fabric_source,gsm_weight, rate, amount, avg_finish_cons, status_active  from wo_pre_cost_fabric_cost_dtls where job_no=".$txt_job_no."";
	$data_arr_fabric=sql_select($sql_fabric);
	foreach($data_arr_fabric as $fab_row){
		$summary_data[fabric_cost][$fab_row[csf("id")]]=$fab_row[csf("amount")];
		$summary_data[fabric_cost_job]+=$fabric_amount['knit']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
		$summary_data[fabric_cost_job]+=$fabric_amount['woven']['grey'][$fab_row[csf("id")]][$fab_row[csf("uom")]];
	}
	unset($data_arr_fabric);

	//Fabric End======================
	
	// Yarn===========================
	//$yarn= new yarn($condition);
	//$yarn_costing_arr=$yarn->get_By_Precostdtlsid_YarnQtyAmountArray();
    $job=$txt_job_no;
	$data_sql='select a.id, a.fabric_cost_dtls_id, a.job_no, a.count_id, a.copm_one_id, a.percent_one, a.copm_two_id, a.percent_two, a.type_id, a.cons_ratio, a.cons_qnty, a.rate, a.amount, a.avg_cons_qnty, a.supplier_id, a.color, a.consdznlbs, a.rate_dzn, 
	b.item_number_id, b.body_part_id, b.fabric_description, b.color_type_id, b.uom, c.color_number_id, c.stripe_color, c.measurement 
	
	from wo_pre_cost_fab_yarn_cost_dtls a, wo_pre_cost_fabric_cost_dtls b, wo_pre_stripe_color c where a.fabric_cost_dtls_id=b.id and b.id=c.pre_cost_fabric_cost_dtls_id and a.color=c.stripe_color and a.job_no ='.$txt_job_no.' and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1';
	$data_arr_yarn=sql_select($data_sql);
	foreach($data_arr_yarn as $yarn_row)
	{
		$poQty=0; $yarn_req_kg=0; $yarn_req_lbs=0; $amount_req=0;
		$poQty=$gmts_item_color_qty_arr[$yarn_row[csf('item_number_id')]][$yarn_row[csf('color_number_id')]];
		$yarn_req_kg=($yarn_row[csf('measurement')]/$order_price_per_dzn)*$poQty;
		$yarn_req_lbs=$yarn_req_kg*2.20462;
		
		//echo $yarn_row[csf('measurement')].'=='.$order_price_per_dzn.'=='.$poQty.'=='.$yarn_req_kg.'=='.$yarn_req_lbs.'<br>';
		$amount_req=$yarn_req_lbs*$yarn_row[csf('rate')];
		
		$summary_data[yarn_cost_job]+=00;
	}
	$knitting_qty=$po_plun_cut_qty/$total_set_qnty;
	//echo $summary_data[yarn_cost_job].'='.$po_plun_cut_qty;
	//$summary_data[yarn_cost]=($summary_data[yarn_cost_job]/$po_qty)*$order_price_per_dzn; 
	$summary_data[yarn_cost]=$summary_data[yarn_fabric_dzn];//($summary_data[yarn_cost_job]/$knitting_qty)*$order_price_per_dzn;
	//unset($data_arr_yarn);
	// Yarn End============================
	
	//start	Trims Cost part report here -------------------------------------------
	$sql_trim = "SELECT a.id, a.job_no, a.trim_group, a.description, a.brand_sup_ref, a.remark, a.cons_uom, a.cons_dzn_gmts, a.rate, a.amount, a.apvl_req, a.nominated_supp, a.status_active, a.seq, b.purchase_date, b.etd_date, b.eta_date, b.receive_date from wo_pre_cost_trim_cost_dtls a left join wo_pre_cost_trims_internal_dtls b on a.id=b.trims_id where a.job_no=".$txt_job_no." and a.status_active=1 and a.is_deleted=0 order by a.seq ASC";
	$data_array_trim=sql_select($sql_trim);
	$trim_amount_arr=$trim->getAmountArray_precostdtlsid();
	$trim_qty_arr=$trim->getQtyArray_by_precostdtlsid();
	$totTrim=0;
	$TrimData=array();
	$attribute_arr=array('trim_group','description','brand_sup_ref','remark','cons_uom','cons_dzn_gmts','rate', 'amount', 'apvl_req','nominated_supp', 'purchase_date', 'etd_date', 'eta_date', 'receive_date' );
	foreach( $data_array_trim as $row_trim ){
		$trim_qty=$trim_qty_arr[$row_trim[csf("id")]];
		$trim_amount=$trim_amount_arr[$row_trim[csf("id")]];
		$summary_data[trims_cost_job]+=$trim_amount;
		foreach($attribute_arr as $attr){
			$TrimData[$row_trim[csf('id')]][$attr]=$row_trim[csf($attr)];
		}
		$TrimData[$row_trim[csf('id')]]['tot_cons']=$trim_qty;
		$TrimData[$row_trim[csf('id')]]['tot_amount']=$trim_amount;		
		$totTrim+=$row_trim[csf('cons_dzn_gmts')];
	}
	unset($data_array_trim);
	//End	Trims Cost part report here -------------------------------------------
	//Emb cost Cost part report here -------------------------------------------
	
	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0 and emb_name in(1,2,4,5)";
	$data_array=sql_select($sql);
	$emblishment_qty=$emblishment->getQtyArray_by_jobAndEmblishmentid();
	$emblishment_amount=$emblishment->getAmountArray_by_jobAndEmblishmentid();
	
	$totEmb=0;
	$EmbData=array();
	
	foreach( $data_array as $row ){
		$embqty=$emblishment_qty[$row[csf("job_no")]][$row[csf("id")]];
		$embamount=$emblishment_amount[$row[csf("job_no")]][$row[csf("id")]];
		$summary_data[emb_cost_job]+=$embamount;
		$EmbData[$row[csf("id")]]['emb_name']=$row[csf("emb_name")];
		$EmbData[$row[csf("id")]]['emb_type']=$row[csf("emb_type")];
		$EmbData[$row[csf("id")]]['cons_dzn_gmts']=$row[csf("cons_dzn_gmts")];
		$EmbData[$row[csf("id")]]['rate']=$row[csf("rate")];
		$EmbData[$row[csf("id")]]['amount']=$row[csf("amount")];
		$EmbData[$row[csf("id")]]['tot_cons']=$embqty;
		$EmbData[$row[csf("id")]]['tot_amount']=$embamount;
		$totEmb+=$row[csf("cons_dzn_gmts")];
	}
	unset($data_array);
	//End Emb cost Cost part report here -------------------------------------------
	//Wash cost Cost part report here -------------------------------------------
	$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and emb_name =3 and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	$wash_qty=$wash->getQtyArray_by_jobAndEmblishmentid();
	$wash_amount=$wash->getAmountArray_by_jobAndEmblishmentid();
	foreach( $data_array as $row ){
		$washqty=$wash_qty[$row[csf("job_no")]][$row[csf("id")]];
		$washamount=$wash_amount[$row[csf("job_no")]][$row[csf("id")]];
		$summary_data[wash_cost_job]+=$washamount;
		$summary_data[OtherDirectExpenses_job]+=$washamount;
		$EmbData[$row[csf("id")]]['emb_name']=$row[csf("emb_name")];
		$EmbData[$row[csf("id")]]['emb_type']=$row[csf("emb_type")];
		$EmbData[$row[csf("id")]]['cons_dzn_gmts']=$row[csf("cons_dzn_gmts")];
		$EmbData[$row[csf("id")]]['rate']=$row[csf("rate")];
		$EmbData[$row[csf("id")]]['amount']=$row[csf("amount")];
		$EmbData[$row[csf("id")]]['tot_cons']=$washqty;
		$EmbData[$row[csf("id")]]['tot_amount']=$washamount;
		$totEmb+=$row[csf("cons_dzn_gmts")];
	}
	unset($data_array);
	//End Wash cost Cost part report here -------------------------------------------
	//Commision cost Cost part report here -------------------------------------------
	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls  where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	$commision_amount=$commision->getAmountArray_by_jobAndPrecostdtlsid();
	$totCommi=0;
	$CommiData=array();
	foreach( $data_array as $row ){
		$commisionamount=$commision_amount[$row[csf("job_no")]][$row[csf("id")]];
		$summary_data[commission_job]+=$commisionamount;
		$CommiData[$row[csf("id")]]['particulars_id']=$row[csf("particulars_id")];
		$CommiData[$row[csf("id")]]['commission_base_id']=$row[csf("commission_base_id")];
		$CommiData[$row[csf("id")]]['commision_rate']=$row[csf("commision_rate")];
		$CommiData[$row[csf("id")]]['commission_amount']=$row[csf("commission_amount")];
		$CommiData[$row[csf("id")]]['tot_commission_amount']=$commisionamount;
		$totCommi+=$row[csf("commission_amount")];
	}
	unset($data_array);
	//End Commision cost Cost part report here -------------------------------------------
	
	//Commarcial cost Cost part report here -------------------------------------------
	$sql = "select id, job_no, item_id, rate, amount, status_active from  wo_pre_cost_comarci_cost_dtls  where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	$commarcial_amount=$commercial->getAmountArray_by_jobAndPrecostdtlsid();
	
	$totCommar=0;
	$CommarData=array();
	foreach( $data_array as $row ){
		$commarcialamount=$commarcial_amount[$row[csf("job_no")]][$row[csf("id")]];
		$summary_data[comm_cost_job]+=$commarcialamount;
		$CommarData[$row[csf("id")]]['item_id']=$row[csf("item_id")];
		$CommarData[$row[csf("id")]]['rate']=$row[csf("rate")];
		$CommarData[$row[csf("id")]]['amount']=$row[csf("amount")];
		$CommarData[$row[csf("id")]]['tot_amount']=$commarcialamount;
		$totCommar+=$row[csf("amount")];
	}
	unset($data_array);
	//End Commarcial cost Cost part report here -------------------------------------------
	?>
	<div style="margin-top:15px">
		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:930px;text-align:center;" rules="all">
			<tr style="font-weight:bold">
				<td width="760" colspan="5">Order Profitability </td>
                <td rowspan="18" valign="top">
                    <table style="float:right;"  width="18%" class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all">
                        <caption><b> Item's View</b></caption>
                        <?
                        // image show here  -------------------------------------------
                        $sql = "select id, master_tble_id, image_location from common_photo_library where master_tble_id=".$txt_job_no." and file_type=1";
                        $photo_data_array=sql_select($sql);
                        foreach($photo_data_array as $inf)
                        {?>
                            <tr>
                            	<td align="center"><img src='../../<? echo $inf[csf("image_location")]; ?>' height='80px' width='150px' /></td>
                            </tr>
                        <? } ?>	
                    </table>
            	</td>
			</tr>
			<tr style="font-weight:bold">
				<td width="80">Line Items</td>
				<td width="380">Particulars</td>
				<td width="100">Amount (USD)/<? echo $costing_for; ?></td>
				<td width="100">Total Value</td>
				<td width="100">%</td>
			</tr>
			<tr>
				<td>1</td>
				<td align="left" style="font-weight:bold">Gross FOB Value</td>
				<td align="right" style="font-weight:bold"><? echo number_format($summary_data[price_dzn],4); ?></td>
				<td align="right" style="font-weight:bold"><? echo number_format($summary_data[price_dzn_job],4); ?></td>
				<td align="right" style="font-weight:bold"><? echo number_format(($summary_data[price_dzn_job]/$summary_data[price_dzn_job])*100,4);?></td>
			</tr>
			<tr>
				<td>2</td>
				<td align="left" style=" padding-left:15px">Less: commission</td>
				<td align="right"><? echo number_format($summary_data[commission],4); ?></td>
				<td align="right"><? echo number_format($summary_data[commission_job],4); ?></td>
				<td align="right"><? echo number_format(($summary_data[commission_job]/$summary_data[price_dzn_job])*100,4);?></td>
			</tr>
			<tr>
				<td>3</td>
				<?
				$NetFOBValue=$summary_data[price_dzn]-$summary_data[commission];
				$NetFOBValue_job=$summary_data[price_dzn_job]-$summary_data[commission_job];
				?>
				<td align="left" style="font-weight:bold"><b>Net FOB Value (1-2)</b></td>
				<td align="right" style="font-weight:bold"><? echo number_format($NetFOBValue,4); ?></td>
				<td align="right" style="font-weight:bold"><? echo number_format($NetFOBValue_job,4); ?></td>
				<td align="right" style="font-weight:bold"><? echo number_format(($NetFOBValue_job/$summary_data[price_dzn_job])*100,4);?></td>
			</tr>
			<tr>
				<td>4</td>
				<td align="left" style="font-weight:bold"><b>Less: Cost of Material & Services (5+6+7+8) </b></td>
				<?
				$Less_Cost_Material_Services=$summary_data[yarn_cost]+array_sum($summary_data[fabric_cost])+array_sum($conv_data[amount])+$summary_data[trims_cost]+$summary_data[emb_cost]+$summary_data[lab_test]+$summary_data[inspection]+$summary_data[design]+$summary_data[studio]+$summary_data[freight]+$summary_data[currier_pre_cost]+$summary_data[certificate_pre_cost]+$summary_data[wash_cost];
				
				$Less_Cost_Material_Services_job=$summary_data[yarn_cost_job]+$summary_data[fabric_cost_job]+$summary_data[trims_cost_job]+$summary_data[emb_cost_job]+$summary_data[OtherDirectExpenses_job];
				?>
				<td align="right" style="font-weight:bold"> <? echo number_format($Less_Cost_Material_Services,4); ?></td>
				<td align="right" style="font-weight:bold"><? echo number_format($Less_Cost_Material_Services_job,4); ?></td>
				<td align="right" style="font-weight:bold"><? echo number_format(($Less_Cost_Material_Services_job/$summary_data[price_dzn_job])*100,4);?></td>
			</tr>
			<tr>
				<td>5</td>
				<td align="left" style=" padding-left:100px;font-weight:bold">Yarn Cost</td>
				<td align="right" style="font-weight:bold"> <? echo number_format($summary_data[yarn_cost],4); ?></td>
				<td align="right" style="font-weight:bold"> <? echo number_format($summary_data[yarn_cost_job],4); ?></td>
				<td align="right" style="font-weight:bold"><? echo number_format(($summary_data[yarn_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
			</tr>
			<tr>
				<td>6</td>
				<td align="left" style=" padding-left:100px;font-weight:bold" ><b>Trim Cost </b></td>
				<td align="right" style="font-weight:bold"> <? echo number_format($summary_data[trims_cost],4); ?></td>
				<td align="right" style="font-weight:bold"><? echo number_format($summary_data[trims_cost_job],4)?></td>
				<td align="right" style="font-weight:bold"><? echo number_format(($summary_data[trims_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
			</tr>
			<tr>
				<td>7</td>
				<td align="left" style=" padding-left:100px;font-weight:bold"><b>Embelishment Cost </b></td>
				<td align="right" style="font-weight:bold"> <? echo number_format($summary_data[emb_cost],4); ?></td>
				<td align="right" style="font-weight:bold"><? echo number_format($summary_data[emb_cost_job],4); ?></td>
				<td align="right" style="font-weight:bold"><? echo number_format(($summary_data[emb_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
			</tr>
			<tr>
				<td valign="top">8</td>
				<td align="left" style=" padding-left:100px">
					<table>
						<tr>
							<td width="180" style="font-weight:bold">Other Direct Expenses</td>
						</tr>
					</table>
					<table border="1" class="rpt_table" rules="all">
						<tr><td width="180" align="left">Lab Test</td></tr>
						<tr><td width="180" align="left">Inspection</td></tr>
						<tr><td width="180" align="left">Design Cost</td></tr>
						<tr><td width="180" align="left">Studio Cost</td></tr>
						<tr><td width="180" align="left">Freight Cost</td></tr>
						<tr><td width="180" align="left">Courier Cost</td></tr>
						<tr><td width="180" align="left">Certificate Cost</td></tr>
						<tr><td width="180" align="left">Garments Wash Cost</td></tr>
					</table>
				</td>
				<td align="right" valign="top">
					<table>
						<tr>
							<td width="100" align="right" style="font-weight:bold"><? echo number_format($summary_data[OtherDirectExpenses],4); ?></td>
						</tr>
					</table>
					<table border="1" class="rpt_table" rules="all">
						<tr><td width="100" align="right"><? echo number_format($summary_data[lab_test],4);?></td></tr>
						<tr><td width="100" align="right"><? echo number_format($summary_data[inspection],4);?></td></tr>
						<tr><td width="100" align="right"><? echo number_format($summary_data[design],4);?></td></tr>
						<tr><td width="100" align="right"><? echo number_format($summary_data[studio],4);?></td></tr>
						<tr><td width="100" align="right"><? echo number_format($summary_data[freight],4);?></td></tr>
						<tr><td width="100" align="right"><? echo number_format($summary_data[currier_pre_cost],4);?></td></tr>
						<tr><td width="100" align="right"><? echo number_format($summary_data[certificate_pre_cost],4);?></td></tr>
						<tr><td width="100" align="right"><? echo number_format($summary_data[wash_cost],4);?></td></tr>
					</table>
				</td>
				<td align="right" valign="top">
					<table>
						<tr>
							<td width="100" align="right" style="font-weight:bold"><? echo number_format($summary_data[OtherDirectExpenses_job],4); ?></td>
						</tr>
					</table>
					<table border="1" class="rpt_table" rules="all">
						<tr><td width="100" align="right"><? echo number_format($summary_data[lab_test_job],4);?></td></tr>
						<tr><td width="100" align="right"><? echo number_format($summary_data[inspection_job],4);?></td></tr>
						<tr><td width="100" align="right"><? echo number_format($summary_data[design_job],4);?></td></tr>
						<tr><td width="100" align="right"><? echo number_format($summary_data[studio_job],4);?></td></tr>
						<tr><td width="100" align="right"><? echo number_format($summary_data[freight_job],4);?></td></tr>
						<tr><td width="100" align="right"><? echo number_format($summary_data[currier_pre_cost_job],4);?></td></tr>
						<tr><td width="100" align="right"><? echo number_format($summary_data[certificate_pre_cost_job],4);?></td></tr>
						<tr><td width="100" align="right"><? echo number_format($summary_data[wash_cost_job],4);?></td></tr>
					</table>
				</td>
				<td align="right" valign="top">
					<table>
						<tr>
							<td width="180" align="right" style="font-weight:bold"><? echo number_format(($summary_data[OtherDirectExpenses_job]/$summary_data[price_dzn_job])*100,4);?></td>
						</tr>
					</table>
					<table border="1" class="rpt_table" rules="all">
						<tr><td width="180" align="right"><? echo number_format(($summary_data[lab_test_job]/$summary_data[price_dzn_job])*100,4);?></td></tr>
						<tr><td width="180" align="right"><? echo number_format(($summary_data[inspection_job]/$summary_data[price_dzn_job])*100,4);?></td></tr>
						<tr><td width="180" align="right"><? echo number_format(($summary_data[design_job]/$summary_data[price_dzn_job])*100,4);?></td></tr>
						<tr><td width="180" align="right"><? echo number_format(($summary_data[studio_job]/$summary_data[price_dzn_job])*100,4);?></td></tr>
						<tr><td width="180" align="right"><? echo number_format(($summary_data[freight_job]/$summary_data[price_dzn_job])*100,4);?></td></tr>
						<tr><td width="180" align="right"><? echo number_format(($summary_data[currier_pre_cost_job]/$summary_data[price_dzn_job])*100,4);?></td></tr>
						<tr><td width="180" align="right"><? echo number_format(($summary_data[certificate_pre_cost_job]/$summary_data[price_dzn_job])*100,4);?></td></tr>
						<tr><td width="180" align="right"><? echo number_format(($summary_data[wash_cost_job]/$summary_data[price_dzn_job])*100,4);?></td></tr>
					</table>
				</td>
			</tr>
			<tr>
				<td>9</td>
				<td align="left" style="font-weight:bold">Contributions/Value Additions (3-4)</td>
				<?
				$Contribution_Margin=$NetFOBValue-$Less_Cost_Material_Services;
				$Contribution_Margin_job=$NetFOBValue_job-$Less_Cost_Material_Services_job;
				?>
				<td align="right" style="font-weight:bold"> <? echo number_format($Contribution_Margin,4); ?></td>
				<td align="right" style="font-weight:bold"><? echo number_format($Contribution_Margin_job,4); ?></td>
				<td align="right" style="font-weight:bold"><? echo number_format(($Contribution_Margin_job/$summary_data[price_dzn_job])*100,4);?></td>
			</tr>
			<tr>
				<td>10</td>
				<td align="left" style=" padding-left:15px">Less: CM Cost </td>
				<td align="right"><? echo number_format($summary_data[cm_cost],4); ?> </td>
				<td align="right"><? echo number_format($summary_data[cm_cost_job],4); ?></td>
				<td align="right"><? echo number_format(($summary_data[cm_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
			</tr>
			<tr>
				<td>11</td>
				<td align="left" style="font-weight:bold">Gross Profit (9-10)</td>
				<?
				$Gross_Profit=$Contribution_Margin-$summary_data[cm_cost];
				$Gross_Profit_job=$Contribution_Margin_job-$summary_data[cm_cost_job];
				?>
				<td align="right" style="font-weight:bold"> <? echo number_format($Gross_Profit,4); ?></td>
				<td align="right" style="font-weight:bold"><? echo number_format($Gross_Profit_job,4); ?></td>
				<td align="right" style="font-weight:bold"><? echo number_format(($Gross_Profit_job/$summary_data[price_dzn_job])*100,4);?></td>
			</tr>
			<tr>
				<td>12</td>
				<td align="left" style=" padding-left:15px">Less: Commercial Cost</td>
				<td align="right"> <? echo number_format( $summary_data[comm_cost],4); ?></td>
				<td align="right"><? echo number_format( $summary_data[comm_cost_job],4); ?></td>
				<td align="right"><? echo number_format(($summary_data[comm_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
			</tr>
			<tr>
				<td>13</td>
				<td align="left" style=" padding-left:15px">Less: Operating Expensees</td>
				<td align="right"><? echo number_format( $summary_data[common_oh],4); ?> </td>
				<td align="right"><? echo number_format( $summary_data[common_oh_job],4); ?> </td>
				<td align="right"><? echo number_format(($summary_data[common_oh_job]/$summary_data[price_dzn_job])*100,4);?></td>
			</tr>
			<tr>
				<td>14</td>
				<td align="left" style="font-weight:bold">Operating Profit/ Loss (11-(12+13))</td>
				<?
				$OperatingProfitLoss=$Gross_Profit-($summary_data[comm_cost]+$summary_data[common_oh]);
				$OperatingProfitLoss_job=$Gross_Profit_job-($summary_data[comm_cost_job]+$summary_data[common_oh_job]);
				?>
				<td align="right" style="font-weight:bold"> <? echo number_format($OperatingProfitLoss,4); ?></td>
				<td align="right" style="font-weight:bold"><? echo number_format($OperatingProfitLoss_job,4); ?></td>
				<td align="right" style="font-weight:bold"><? echo number_format(($OperatingProfitLoss_job/$summary_data[price_dzn_job])*100,4);?></td>
			</tr>
			<tr>
				<td>15</td>
				<td align="left" style=" padding-left:15px">Less: Depreciation & Amortization </td>
				<td align="right"> <? echo number_format( $summary_data[depr_amor_pre_cost],4); ?></td>
				<td align="right"><? echo number_format( $summary_data[depr_amor_pre_cost_job],4); ?></td>
				<td align="right"><? echo number_format(($summary_data[depr_amor_pre_cost_job]/$summary_data[price_dzn_job])*100,4);?></td>
			</tr>
			<tr>
				<?
				$interest_expense=$NetFOBValue*$financial_para[interest_expense]/100;
				$income_tax=$NetFOBValue*$financial_para[income_tax]/100;
				$interest_expense_job=$NetFOBValue_job*$financial_para[interest_expense]/100;
				$income_tax_job=$NetFOBValue_job*$financial_para[income_tax]/100;
				?>
				<td>16</td>
				<td align="left" style=" padding-left:15px">Less: Interest </td>
				<td align="right"> <? echo number_format( $interest_expense,4); ?></td>
				<td align="right"><? echo number_format( $interest_expense_job,4); ?></td>
				<td align="right"><? echo number_format(($interest_expense_job/$summary_data[price_dzn_job])*100,4);?></td>
			</tr>
			<tr>
				<td>17</td>
				<td align="left" style=" padding-left:15px">Less: Income Tax</td>
				<td align="right"> <? echo number_format( $income_tax,4); ?></td>
				<td align="right"><? echo number_format( $income_tax_job,4); ?></td>
				<td align="right"><? echo number_format(($income_tax_job/$summary_data[price_dzn_job])*100,4);?></td>
			</tr>
			<tr>
				<?
				$Netprofit=$OperatingProfitLoss-($summary_data[depr_amor_pre_cost]+$interest_expense+$income_tax);
				$Netprofit_job=$OperatingProfitLoss_job-($summary_data[depr_amor_pre_cost_job]+$interest_expense_job+$income_tax_job);
				?>
				<td>18</td>
				<td align="left" style="font-weight:bold">Net Profit (14-(15+16+17))</td>
				<td align="right" style="font-weight:bold"><? echo number_format( $Netprofit,4); ?> </td>
				<td align="right" style="font-weight:bold"><? echo number_format( $Netprofit_job,4); ?></td>
				<td align="right" style="font-weight:bold"><? echo number_format(($Netprofit_job/$summary_data[price_dzn_job])*100,4);?></td>
			</tr>
		</table>
	</div>
	<br/>
	<?
	$job="'".$txt_job_no."'";
		
	/*$data_sql='select a.id, a.fabric_cost_dtls_id, a.job_no, a.count_id, a.copm_one_id, a.percent_one, a.copm_two_id, a.percent_two, a.type_id, a.cons_ratio, a.cons_qnty, a.rate, a.amount, a.avg_cons_qnty, a.supplier_id, a.color, a.consdznlbs, a.rate_dzn, 
	b.item_number_id, b.body_part_id, b.fabric_description, b.color_type_id, b.uom, c.color_number_id, c.stripe_color, c.measurement 
	
	from wo_pre_cost_fab_yarn_cost_dtls a, wo_pre_cost_fabric_cost_dtls b, wo_pre_stripe_color c where a.fabric_cost_dtls_id=b.id and b.id=c.pre_cost_fabric_cost_dtls_id and a.color=c.stripe_color and a.job_no ='.$txt_job_no.' and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1';
	//echo $data_sql; die;
	$data=sql_select($data_sql);*/
	$lib_yarn_count=return_library_array( "select yarn_count, id from lib_yarn_count", "id", "yarn_count");
	
	?>  	
    <table id="table_header_1" class="rpt_table" width="1100" cellpadding="0" cellspacing="0" border="1" rules="all">
        <caption> <b style="float:left">Yarn Details :</b></caption>
        <thead>
            <th width="30">SL</th>
            <th width="100">Gmt Item</th>
            <th width="100">Body Part</th>
            <th width="200">Yarn. Desc</th>
            <th width="100">Color Type</th>
            <th width="100">Gmt Color</th>
            <th width="100">Yarn. Color</th>
            <th width="50">UOM</th> 
            <th width="90">Total Yarn (Kg)</th>
            <th width="90">Total Yarn (Lbs)</th>
            <th width="60">Rate /Lbs</th>
            <th>Total Amount</th>
        </thead>
        <tbody>
		<?
        $i=1; $totCons=0; $totReq=0; $totAmt=0;
        foreach ($data_arr_yarn as $yarn)
        {
			$poQty=0; $yarn_req_kg=0; $yarn_req_lbs=0;
			$poQty=$gmts_item_color_qty_arr[$yarn[csf('item_number_id')]][$yarn[csf('color_number_id')]];
            $yarn_req_kg=($yarn[csf('measurement')]/$order_price_per_dzn)*$poQty;
			$yarn_req_lbs=$yarn_req_kg*2.20462;
            $amount_req=$yarn_req_lbs*$yarn[csf('rate')];
            ?>
            <tr style="font-size:13px">
                <td><? echo $i; ?></td>
                <td style="word-break:break-all"><? echo $garments_item[$yarn[csf('item_number_id')]]; ?></td>
                <td style="word-break:break-all"><? echo $body_part[$yarn[csf('body_part_id')]]; ?></td>
                <td style="word-break:break-all"><? echo $lib_yarn_count[$yarn[csf('count_id')]]." ".$composition[$yarn[csf('copm_one_id')]]." ".$yarn_type[$yarn[csf('type_id')]]; ?></td>
                <td style="word-break:break-all"><? echo $color_type[$yarn[csf('color_type_id')]]; ?></td>
                <td style="word-break:break-all"><? echo $color_library[$yarn[csf('color_number_id')]]; ?></td>
                <td style="word-break:break-all"><? echo $color_library[$yarn[csf('color')]]; ?></td>
                <td><? echo $unit_of_measurement[$yarn[csf('uom')]]; ?></td> 
                <td align="right" title="<? echo "Stripe Cons=".$yarn[csf('measurement')]." /Costing Per=".$order_price_per_dzn."*Item Color Po Qty=".$poQty; ?>"><? echo number_format($yarn_req_kg,4); ?></td>
                <td align="right"><? echo number_format($yarn_req_lbs,4); ?> </td>
                <td align="right"><? echo number_format($yarn[csf('rate')],4); ?></td>
                <td align="right"><? echo number_format($amount_req,4); ?></td>
            </tr>
            <?
            $totConsKg+=$yarn_req_kg;
			$totConsLbs+=$yarn_req_lbs;
            $totAmt+=$amount_req;
            $i++;
        }
		unset($data);
        ?>
        </tbody>
        <tfoot>
            <tr style="font-weight:bold; font-size:12px; text-align:right">
                <td colspan="8">Total:</td>
                <td align="right"><? echo number_format($totConsKg,4); ?></td>
                <td align="right"><? echo number_format($totConsLbs,4); ?> </td>
                <td align="right">&nbsp;</td>
                <td align="right"><? echo number_format($totAmt,4); ?> </td>
            </tr>
        </tfoot>
    </table>
    <br/> 
    <table class="rpt_table" width="1150" cellpadding="0" cellspacing="0" border="1" rules="all">
        <caption> <b style="float:left">Trims Cost Details :</b></caption>
        <thead>
            <th width="30">SL</th>
            <th width="130">Item Group</th>
            <th width="130">Description</th>
            <th width="150">Supplier</th>
            <th width="100">UOM</th>
            <th width="50">Cons / <?=$costing_for;?></th> 
            <th width="90">Total Qty</th>
            <th width="60">Rate / UOM</th>
            <th width="60">Total Amount</th>
            <th width="60">Trims Pur. Order Date</th>
            <th width="60">Trims ETD</th>
            <th width="60">Trims ETA</th>
            <th width="60">Trims Receive Date</th>
        </thead>
        <tbody>
		<?
		$supplier_arr=return_library_array( "select id, supplier_name from  lib_supplier",'id','supplier_name');
		$item_group_arr=return_library_array( "select item_name,id from lib_item_group where item_category=4 order by item_name", "id", "item_name");
        $i=1; $totCons=0; $totReq=0; $totAmt=0;
        foreach ($TrimData as $tid=>$trow)
        {
            ?>
            <tr>
                <td><? echo $i; ?></td>
                <td style="word-break:break-all"><? echo $item_group_arr[$trow['trim_group']]; ?></td>
                <td style="word-break:break-all"><? echo $trow['description']; ?></td>
                <td style="word-break:break-all"><? echo $supplier_arr[$trow['nominated_supp']]; ?></td>
                <td style="word-break:break-all"><? echo $unit_of_measurement[$trow['cons_uom']]; ?></td>
                <td align="right"><? echo number_format($trow['cons_dzn_gmts'],4); ?></td> 
                <td align="right"><? echo number_format($trow['tot_cons'],4); ?> </td>
                <td align="right"><? echo number_format($trow['rate'],4); ?></td>
                <td align="right"><? echo number_format($trow['tot_amount'],4); ?></td>
                <td align="right"><? echo change_date_format($trow['purchase_date'],4); ?></td>
                <td align="right"><? echo change_date_format($trow['etd_date'],4); ?></td>
                <td align="right"><? echo change_date_format($trow['eta_date'],4); ?></td>
                <td align="right"><? echo change_date_format($trow['receive_date'],4); ?></td>
            </tr>
            <?
            $totTrimsAmt+=$trow['tot_amount'];
            $i++;
        }
        ?>
        </tbody>
        <tfoot>
            <tr style="font-weight:bold; text-align:right">
                <td colspan="8">Total:</td>
                <td align="right"><? echo number_format($totTrimsAmt,4); ?> </td>
            </tr>
        </tfoot>
    </table>
    <table class="rpt_table" width="350" cellpadding="0" cellspacing="0" border="1" rules="all" style="margin-top: 10px">
        <thead>
        	<tr>
        		<th colspan="3" align="center">CM Cost Details</th>
        	</tr>
        	<tr>        		
	            <th width="30">SL</th>
	            <th width="200">Particular</th>
                <th width="100">Cost Per <?=$costing_for;?></th>
	            <th width="100">Total Cost(&dollar;)</th>
        	</tr>
        </thead>
        <?
        $cm_cost_dtls=sql_select("SELECT particular_id,cost from WO_PRE_COST_CM_COST_DTLS where JOB_NO=".$txt_job_no." and status_active=1 and is_deleted=0");
        $i=1;$cost_per_dzn=0;
        foreach ($cm_cost_dtls as $row) {
        	$cost=$po_qty*($row[csf('cost')]/$order_price_per_dzn);
        	$total_cost+=$cost;$cost_per_dzn+=$row[csf('cost')];
        ?>
        	<tr>
        		<td><? echo $i; ?></td>
        		<td align="right" title="<? echo 'cost:'.$row[csf('cost')].'job Qty:'.$po_qty ?>"><? echo $cm_cost_particular_arr[$row[csf('particular_id')]]; ?></td>
                <td align="right"><? echo number_format($row[csf('cost')],2); ?></td>
        		<td align="right"><? echo number_format($cost,4); ?></td>
        	</tr>
        <?
        $i++;
    	}
        ?>
        <tr>
        	<th colspan="2">Total</th>
            <th width="100" align="right"><? echo number_format($cost_per_dzn,4); ?></th>
             <th width="100" align="right"><? echo number_format($total_cost,4); ?></th>
        </tr>
    </table>
	<?
    echo signature_table(109, $cbo_company_name, "860px");
    exit();
}

if($action=='mo_sheet') //Aziz-13-5-18
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$txt_job_no=str_replace("'","",$txt_job_no);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_buyer_name=str_replace("'","",$cbo_buyer_name);
	$txt_style_ref=str_replace("'","",$txt_style_ref);
	$txt_costing_date=str_replace("'","",$txt_costing_date);
	$txt_po_breack_down_id=str_replace("'","",$txt_po_breack_down_id);
	$cbo_costing_per=str_replace("'","",$cbo_costing_per);
	if(str_replace("'",'',$txt_po_breack_down_id)=="") $txt_po_breack_down_id_cond=''; else $txt_po_breack_down_id_cond=" and b.id in(".$txt_po_breack_down_id.")";
	
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$supplier_name_arr=return_library_array( "select id, supplier_name from lib_supplier",'id','supplier_name');
	
	$result =sql_select("select a.job_no, a.buyer_name, a.style_ref_no, a.ship_mode, a.order_uom, a.gmts_item_id, b.id as po_id, b.po_number, b.po_received_date, b.pub_shipment_date, b.file_no, b.grouping, c.costing_date, c.costing_per, d.item_number_id, d.color_number_id, d.size_number_id, d.order_quantity as order_quantity, d.plan_cut_qnty as plan_cut from wo_po_details_master a, wo_po_break_down b, wo_pre_cost_mst c, wo_po_color_size_breakdown d where a.job_no=b.job_no_mst and b.id=d.po_break_down_id and c.job_no=b.job_no_mst and c.job_no=a.job_no and b.job_no_mst='$txt_job_no' $txt_po_breack_down_id_cond and b.status_active=1 and b.is_deleted=0 and d.status_active=1 and d.is_deleted=0 order by  d.color_order, d.size_order ASC");
	
	$job_in_orders = array(); $job_in_ship_arr = array(); $job_in_ref = array(); $job_in_file = array(); $posize_array=array(); $color_size_array=array(); $color_size_plan_arr=array();
	$pulich_ship_date=''; $shipment_date_arr='';
	
	foreach ($result as $val)
	{
		$job_in_orders_arr[$val[csf('po_id')]]=$val[csf('po_number')];
		$job_in_ship_arr[$val[csf('po_id')]]= $val[csf('pub_shipment_date')];
		$job_in_recvDate_arr[$val[csf('po_id')]]= change_date_format($val[csf('po_received_date')]);
		$job_in_ref_arr[$val[csf('po_id')]]= $val[csf('grouping')];
		$job_in_file_arr[$val[csf('po_id')]]= $val[csf('file_no')];
		
		$gmts_item_id=$val[csf('gmts_item_id')];
		$order_uom=$val[csf('order_uom')];
		$shipment_date_arr.=change_date_format($val[csf('pub_shipment_date')]).',';
		
		$job_no=$val[csf('job_no')];
		$buyer_name=$buyer_arr[$val[csf('buyer_name')]];
		$style_ref_no=$val[csf('style_ref_no')];
		
		$costing_date=$val[csf('costing_date')];
		$costing_per_name=$costing_per[$val[csf('costing_per')]];
		
		$posize_array[$val[csf("size_number_id")]]=$val[csf("size_number_id")];
		$color_size_plan_arr[$val[csf("po_id")]][$val[csf("item_number_id")]][$val[csf("color_number_id")]]+=$val[csf("plan_cut")];
		$color_size_array[$val[csf("po_id")]][$val[csf("item_number_id")]][$val[csf("color_number_id")]]+=$val[csf("order_quantity")];
		$po_size_qty_array[$val[csf("po_id")]][$val[csf("color_number_id")]][$val[csf("size_number_id")]]['po_qty']+=$val[csf("order_quantity")];
		$po_array[$val[csf("po_id")]]['po_no']=$val[csf("po_number")];
		$po_array[$val[csf("po_id")]]['item_number_id']=$val[csf("item_number_id")];
		
		$po_color_array[$val[csf("po_id")]][$val[csf("item_number_id")]]['color_number_id'].=$val[csf("color_number_id")].',';
		
		$item_color_size_array[$val[csf("item_number_id")]][$val[csf("color_number_id")]]+=$val[csf("plan_cut")];
		
		if($val[csf("costing_per")]==1) $order_price_per_dzn=12; 
        else if($val[csf("costing_per")]==2) $order_price_per_dzn=1;
        else if($val[csf("costing_per")]==3) $order_price_per_dzn=24;
        else if($val[csf("costing_per")]==4)$order_price_per_dzn=36; 
		else if($val[csf("costing_per")]==5) $order_price_per_dzn=48;
	}
	unset($result);
	$ref_cond=implode(",",array_unique($job_in_ref_arr));
	$file_con=implode(",",array_unique($job_in_file_arr));
	$shipment_date=rtrim($shipment_date_arr,',');
	$shipment_date=implode(",",array_unique(explode(",",$shipment_date)));
	
	$recv_date=implode(",",array_unique($job_in_recvDate_arr));
	//$shipment_date=implode(",",array_unique($job_in_ship_arr));
	$job_in_orders=implode(",",$job_in_orders_arr);
	//print_r($job_in_orders_arr);
	?>
	<style type="text/css" media="print">
		table { page-break-inside:auto; }
		@media print 
		{
			thead {display: table-header-group;}
		}
		@media print 
		{
			table 
			{
				page-break-inside: avoid;
			}
		}  
	</style>
	<div style="width:1100px; margin:0 auto">
    <div style="width:1100px; font-size:20px; font-weight:bold" align="center"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></div>
    <div style="width:1100px; font-size:14px; font-weight:bold" align="center">MO Sheet</div>
	<br>
	 <div style="font-family:'Arial Narrow';">
        <table style="width:560px; font-family:Arial Narrow" border="0" >
			<table width="50%" class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all">
				<tr>
					<td width="80">Job No</td>
					<td width="80"><b><? echo $job_no; ?></b></td>
				</tr>
				<tr>
					<td>Buyer</td>
					<td><b><? echo $buyer_name; ?></b></td>
				</tr>
				<tr>
					<td>PO  Number</td>
					<td><b><? echo $job_in_orders; ?></b></td>
				</tr>
				<tr>
					<td>Style Number</td>
					<td><b><? echo $style_ref_no; ?></b></td>
				</tr>
				<tr>
					<td>Item</td>
					<td><b><? 
						$gmts_item=''; $gmts_item_id=explode(",",$gmts_item_id);
							foreach($gmts_item_id as $item_id)
							{
								if($gmts_item=="") $gmts_item=$garments_item[$item_id]; else $gmts_item.=", ".$garments_item[$item_id];
							}
							echo $gmts_item;
					 ?></b></td>
				</tr>
				<tr>
					<td>Shipment Date</td>
					<td><b><? echo $shipment_date; ?></b></td>
				</tr>
				<tr>
					<td>PO Receive Date</td>
					<td><b><? echo $recv_date; ?></b></td>
				</tr>
				<tr>
					<td>Costing Date</td>
					<td><b><? echo change_date_format($costing_date); ?></b></td>
				</tr>
					<td>Costing Per</td>
					<td><b><? echo $costing_per_name; ?></b></td>
				</tr>
			</table>
            <table style="float:right; margin-top:-207px;" width="40%" class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all">
                <caption><b>Item's View</b></caption>
                <tr>
					<?
                    // image show here  -------------------------------------------
                    $sql = "select id,master_tble_id,image_location from common_photo_library where master_tble_id='$txt_job_no' and file_type=1";
                    $photo_data_array=sql_select($sql);
                    foreach($photo_data_array as $inf){ ?>
                    	<td align="center"><img  src='../../<? echo $inf[csf("image_location")]; ?>' height='80px' width='200px' /></td>
                    <? } ?>	
                </tr>
            </table>
		</table>
		<br/>
	<?
	$po_rowspan_arr=array();$po_item_rowspan_arr=array();
	foreach($color_size_array as $pokey=>$po_data)
	{
		$po_row_span=0;
		foreach($po_data as $itemkey=>$item_data)
		{
			$item_row_span=0;$color_row_span=0;
			foreach($item_data as $colorkey=>$val)
			{
				$item_row_span++;
				$po_row_span++;
				//$po_item_color_rowspan_arr[$pokey][$itemkey][$colorkey]=$color_row_span;
				$color_row_span++;
			}
			$itempo_rowspan_arr[$pokey][$itemkey][$colorkey]=$color_row_span;
			$po_item_rowspan_arr[$pokey][$itemkey]=$item_row_span;
			$po_rowspan_arr[$pokey]=$po_row_span;
		}
	}
	//print_r($itempo_rowspan_arr);
	?>
	<br/>
	<div style="width:1100px;">
        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:auto;text-align:center; font-family:Arial Narrow" rules="all">
            <label style="text-align:center"><b>Size and Color  Breakdown:</b></label>
            <tr style="font-weight:bold">
                <td width="20">SL.</td>
                <td width="110">Buyer PO</td>
                <td width="110">Item</td>
                <td width="120">Color</td>
                <?
                foreach ($posize_array as $sizid)
                {
					?>
					<th width="60"><strong><? echo  $size_library[$sizid];  ?></strong></th>
					<?
                }
                ?>
                <td width="70">Total Order Qty.</td>
                <td>Total Plan Qty.</td>
            </tr>
            <?
            $k=1; $total_qnty=0;$grd_total_qnty=0; $color_po_qty_arr=array();
            foreach ($color_size_array as $pokey=>$po_data)
            {
				$m=1;
				foreach ($po_data as $itemkey=>$item_data)
				{
					$n=1;
					foreach ($item_data as $colorkey=>$color_data)
					{
						$po_rowspan=$po_rowspan_arr[$pokey];
						$item_po_rowspan=$po_item_rowspan_arr[$pokey][$itemkey];
						$item_po_rowspan_row=$itempo_rowspan_arr[$itemkey][$colorkey];
						
						$color_number_id=rtrim($po_color_array[$pokey][$itemkey]['color_number_id']);
						$color_ids=explode(",",$color_number_id);
						$color_row=count($color_row);
						?>
						<tr>
							<?
                            if($m==1)
                            {
                                ?>
                                <td rowspan="<? echo $po_rowspan;?>"><? echo $k;?></td>
                                <td rowspan="<? echo $po_rowspan;?>" align="left"><? echo $po_array[$pokey]['po_no']; ?></td>
                                <?
                            }
                            if($n==1)
                            {
                                ?>
                                <td  rowspan="<? echo $item_po_rowspan;?>" align="left"><? echo $garments_item[$itemkey]; ?></td>
                                <?
                            }
                            ?>
                            <td align="left"><? echo $color_library[$colorkey]; ?></td>
							<?
                            $po_size_qty=0;$tot_qnty=array();
                            foreach ($posize_array as $sizval)
                            {
                                $size_count=count($sizval);
                                $po_size_qty=$po_size_qty_array[$pokey][$colorkey][$sizval]['po_qty']
                                ?>
                                <td align="right"><? echo number_format($po_size_qty,0); ?></td>
                                <?
                                $tot_qnty[$pokey][$colorkey]+=$po_size_qty;
                                $tot_qnty_size[$sizval]+=$po_size_qty;
                                $tot_qnty_item_size[$sizval]+=$po_size_qty;
                                $grd_tot_qnty_size[$sizval]+=$po_size_qty;
                                $size_tot_qty+=$item_color_size_array[$pokey][$itemkey][$colorkey];
                                $color_po_qty_arr[$colorkey]+=$po_size_qty;
                            }
							$plan_cut=0;
							$plan_cut=$color_size_plan_arr[$pokey][$itemkey][$colorkey];
                            ?>
                            <td align="right"><? echo number_format($tot_qnty[$pokey][$colorkey],0); ?></td>
                            <td align="right"><? echo number_format($plan_cut,0); ?></td>
						</tr>
						<?
						$total_qnty+=$tot_qnty[$pokey][$colorkey];
						$total_item_qnty+=$tot_qnty_item_size[$pokey][$colorkey];
						$grd_total_qnty+=$tot_qnty[$pokey][$colorkey];
						
						$total_plan_qnty+=$plan_cut;
						$grd_plan_total_qnty+=$plan_cut;
						$m++;$n++;
					}
				}
				?>
				<tr>
                    <td colspan="4" align="right"><strong>PO Sub Total :</strong></td>
                    <?
                    foreach ($posize_array as $sizval)
                    {
                        ?>
                        <td align="right"><b><?php echo number_format($tot_qnty_size[$sizval],0);unset($tot_qnty_size[$sizval]); ?></b></td>
                        <?
                    }
                    ?>
                    <td align="right"><b><?php echo number_format($total_qnty,0);unset($total_qnty); ?></b></td>
                    <td align="right"><b><?php echo number_format($total_plan_qnty,0);unset($total_plan_qnty); ?></b></td>
				</tr>
				<?
				$k++;
            }
            ?>
            <tr>
                <td colspan="4" align="right"><strong>Job Total :</strong></td>
                <?
                foreach ($posize_array as $sizval)
                {
                    ?>
                    <td align="right"><b><?php echo number_format($grd_tot_qnty_size[$sizval],0); ?></b></td>
                    <?
                }
                ?>
                <td align="right"><b><?php echo number_format($grd_total_qnty,0); ?></b></td>
                <td align="right"><b><?php echo number_format($grd_plan_total_qnty,0); ?></b></td>
            </tr>
        </table>
	</div>
    <br/>
    <?
    $data_sql="select a.id, a.fabric_cost_dtls_id, a.job_no, a.count_id, a.copm_one_id, a.percent_one, a.copm_two_id, a.percent_two, a.type_id, a.cons_ratio, a.cons_qnty, a.rate, a.amount, a.avg_cons_qnty, a.supplier_id, a.color, a.consdznlbs, a.rate_dzn, 
	b.item_number_id, b.body_part_id, b.fabric_description, b.color_type_id, b.uom, c.color_number_id, c.stripe_color, c.measurement 
	
	from wo_pre_cost_fab_yarn_cost_dtls a, wo_pre_cost_fabric_cost_dtls b, wo_pre_stripe_color c where a.fabric_cost_dtls_id=b.id and b.id=c.pre_cost_fabric_cost_dtls_id and a.color=c.stripe_color and a.job_no ='$txt_job_no' and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1";
	//echo $data_sql; die;
	$data=sql_select($data_sql);
	$lib_yarn_count=return_library_array( "select yarn_count, id from lib_yarn_count", "id", "yarn_count");
	
	?>  	
    <table id="table_header_1" class="rpt_table" width="1100" cellpadding="0" cellspacing="0" border="1" rules="all">
        <caption> <b style="float:left">Yarn Details :</b></caption>
        <thead>
            <th width="30">SL</th>
            <th width="100">Gmt Item</th>
            <th width="100">Body Part</th>
            <th width="200">Yarn. Desc</th>
            <th width="100">Color Type</th>
            <th width="100">Gmt Color</th>
            <th width="100">Yarn. Color</th>
            <th width="50">UOM</th> 
            <th width="90">Total Yarn (Kg)</th>
            <th width="90">Total Yarn (Lbs)</th>
            <th width="60">Rate /Lbs</th>
            <th>Total Amount</th>
        </thead>
        <tbody>
		<?
        $i=1; $totCons=0; $totReq=0; $totAmt=0;
        foreach ($data as $yarn)
        {
			$poQty=0; $yarn_req_kg=0; $yarn_req_lbs=0;
			$poQty=$item_color_size_array[$yarn[csf('item_number_id')]][$yarn[csf('color_number_id')]];
            $yarn_req_kg=($yarn[csf('measurement')]/$order_price_per_dzn)*$poQty;
			$yarn_req_lbs=$yarn_req_kg*2.20462;
            $amount_req=$yarn_req_lbs*$yarn[csf('rate')];
            ?>
            <tr style="font-size:13px">
                <td><? echo $i; ?></td>
                <td style="word-break:break-all"><? echo $garments_item[$yarn[csf('item_number_id')]]; ?></td>
                <td style="word-break:break-all"><? echo $body_part[$yarn[csf('body_part_id')]]; ?></td>
                <td style="word-break:break-all"><? echo $lib_yarn_count[$yarn[csf('count_id')]]." ".$composition[$yarn[csf('copm_one_id')]]." ".$yarn_type[$yarn[csf('type_id')]]; ?></td>
                <td style="word-break:break-all"><? echo $color_type[$yarn[csf('color_type_id')]]; ?></td>
                <td style="word-break:break-all"><? echo $color_library[$yarn[csf('color_number_id')]]; ?></td>
                <td style="word-break:break-all"><? echo $color_library[$yarn[csf('color')]]; ?></td>
                <td><? echo $unit_of_measurement[$yarn[csf('uom')]]; ?></td> 
                <td align="right" title="<? echo "Stripe Cons=".$yarn[csf('measurement')]." /Costing Per=".$order_price_per_dzn."*Item Color Po Qty=".$poQty; ?>"><? echo number_format($yarn_req_kg,4); ?></td>
                <td align="right"><? echo number_format($yarn_req_lbs,4); ?> </td>
                <td align="right"><? echo number_format($yarn[csf('rate')],4); ?></td>
                <td align="right"><? echo number_format($amount_req,4); ?></td>
            </tr>
            <?
            $totConsKg+=$yarn_req_kg;
			$totConsLbs+=$yarn_req_lbs;
            $totAmt+=$amount_req;
            $i++;
        }
		unset($data);
        ?>
        </tbody>
        <tfoot>
            <tr style="font-weight:bold; font-size:12px; text-align:right">
                <td colspan="8">Total:</td>
                <td align="right"><? echo number_format($totConsKg,4); ?></td>
                <td align="right"><? echo number_format($totConsLbs,4); ?> </td>
                <td align="right">&nbsp;</td>
                <td align="right"><? echo number_format($totAmt,4); ?> </td>
            </tr>
        </tfoot>
    </table>
    <br/>  	
	<?
    $condition= new condition();
    if($txt_po_breack_down_id!='' || $txt_po_breack_down_id!=0)
    {
    	$condition->po_id("in($txt_po_breack_down_id)"); 
    }
    if(str_replace("'","",$txt_job_no)!='')
    {
    	$condition->job_no("in('$txt_job_no')");
    }
    
    $condition->init();
    //$fabric= new fabric($condition);
    $trims= new trims($condition);
    $emblishment= new emblishment($condition);
    $wash= new wash($condition);
    //$fabric_qty_arr=$fabric->getQtyArray_by_FabriccostidAndGmtscolor_knitAndwoven_greyAndfinish();
    
    $item_group_arr=return_library_array( "select item_name,id from lib_item_group where item_category=4 order by item_name", "id", "item_name");
    $supplier_library=return_library_array( "select a.supplier_name,a.id from  lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id  and a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
    
    $trims_qty_arr=$trims->getQtyArray_by_jobItemidDescriptionGmtcolorAndSizeid();
	$trims_amt_arr=$trims->getAmountArray_by_jobItemidDescriptionGmtcolorAndSizeid();
    $trims_item_qty_arr=$trims->getQtyArray_by_jobAndItemid();
    $trims_desc_qty_arr=$trims->getQtyArray_by_jobItemidAndDescription();
	$trims_desc_amt_arr=$trims->getAmountArray_by_jobItemidAndDescription();
    //print_r($trims_amt_arr);
    
    $sql_trim_color="select c.id, c.job_no, c.trim_group, c.description, c.brand_sup_ref, c.nominated_supp, c.cons_uom, c.remark, d.wo_pre_cost_trim_cost_dtls_id as fab_dtl_id, d.item_size, d.color_number_id, d.item_number_id, d.size_number_id, d.excess_per, d.cons, d.tot_cons from wo_pre_cost_trim_cost_dtls c, wo_pre_cost_trim_co_cons_dtls d
    where c.job_no=d.job_no and d.wo_pre_cost_trim_cost_dtls_id=c.id and c.status_active=1 and c.is_deleted=0 and d.cons>0 and c.job_no='$txt_job_no' order by c.id, c.trim_group";
    $trim_result=sql_select($sql_trim_color);
    foreach($trim_result as $row)
    {
		$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['description']=$row[csf("description")];
		$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['nominated_supp']=$row[csf("nominated_supp")];
		$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['size_number_id']=$row[csf("size_number_id")];
		$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['job_no']=$row[csf("job_no")];
		$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['item_size']=$row[csf("item_size")];
		$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['remark']=$row[csf("remark")];
		$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['cons_uom']=$row[csf("cons_uom")];
		$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['cons']+=$row[csf("cons")];
		
		$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['tot_size_cons']+=$trims_qty_arr[$row[csf("job_no")]][$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]];
		$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['amount']+=$trims_amt_arr[$row[csf("job_no")]][$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("size_number_id")]];
		
		$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['tot_cons']+=$row[csf("tot_cons")];
		$trims_color_arr[$row[csf("trim_group")]][$row[csf("description")]][$row[csf("color_number_id")]][$row[csf("item_size")]]['excess_per']=$row[csf("excess_per")];
    }
	unset($trim_result);
	
    foreach($trims_color_arr as $trim_key=>$trim_data)
    {
		$trim_color_rowspan=0;
		foreach($trim_data as $desc_key=>$desc_data)
		{
			$trim_desc_rowspan=0;
			foreach($desc_data as $gmt_color_key=>$color_data)
			{
				$item_size_rowspan=0;
				foreach($color_data as $size_key=>$val)
				{
					$item_size_rowspan++;
					$trim_desc_rowspan++;
					$trim_color_rowspan++;
				}
				$item_size_rowspan_arr[$trim_key][$desc_key][$gmt_color_key]=$item_size_rowspan;
				$trim_desc_rowspan_arr[$trim_key][$desc_key]=$trim_desc_rowspan;
				$trim_size_rowspan_arr[$trim_key]=$trim_color_rowspan;
			}
		}
    }
    //print_r($trim_size_rowspan_arr);
    ?>
    <table id="table_header_1" class="rpt_table" width="1100" cellpadding="0" cellspacing="0" border="1" rules="all">
        <caption> <b style="float:left">Trims Details:</b></caption>
        <thead>
            <th width="30">SL</th>
            <th width="100">Item</th>
            <th width="120">Description</th>
            <th width="100">Remarks</th>
            <th width="100">Supplier</th>
            <th width="100">Gmt Color</th>
            <th width="100">Item Size</th>
            <th width="50">UOM</th> 
            <th width="80">Cons</th>
            <th width="80">Exs %</th>
            <th width="80">Total Cons. </th>
            <th width="80">Total Qty </th>
            <th width="80">Rate</th>
            <th width="80">Amount</th>
            <th width="80">Item Total Qty.</th>
            <th width="80">Item Total Amount</th>
        </thead>
        <tbody>
        <?
        $j=1; $total_trim_cons=$total_tot_trim_cons=$total_tot_item_qty_cons=$total_trim_qty_cons=0;
        foreach($trims_color_arr as $trim_key=>$trim_data)
        {
			$k=1;
			foreach($trim_data as $desc_key=>$desc_data)
			{
				$n=1;
				foreach($desc_data as $gmt_color_key=>$color_data)
				{
					$m=1;
					foreach($color_data as $size_key=>$val)
					{
						if($j%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
						if($col_size_cons_arr[$trim_key][$gmt_color_key]>0)
						{
							$tot_size_qty=$col_size_cons_arr[$trim_key][$gmt_color_key];
						}
						if($item_tot_cons_arr[$trim_key]>0)
						{
							$item_tot_size_qty=$item_tot_cons_arr[$trim_key];
						}
						$job_no=$val['job_no'];
						$item_size=$val['item_size'];
						$tot_size_cons=$val['tot_size_cons'];
						
						$gmt_item_desc_qty=$trims_desc_qty_arr[$job_no][$trim_key][$desc_key];
						$gmt_item_desc_amt=$trims_desc_amt_arr[$job_no][$trim_key][$desc_key];
						//$gmt_item_desc_qty=$trims_item_qty_arr[$job_no][$trim_key];
						$gmt_size_qty=$tot_size_cons;//$trims_qty_arr[$job_no][$trim_key][$desc_key][$gmt_color_key][$size_key];
						$rate=$val['amount']/$gmt_size_qty;
						?>
						<tr bgcolor="<? echo $bgcolor;?>" onClick="change_color('tr_<? echo $j; ?>','<? echo $bgcolor;?>')" id="tr_<? echo $j; ?>">  <?
							if($k==1){ 
								?>
								<td rowspan="<? echo $trim_size_rowspan_arr[$trim_key]?>"><? echo $j; ?></td>
								<td rowspan="<?  echo $trim_size_rowspan_arr[$trim_key];?>"><? echo $item_group_arr[$trim_key]; ?></td> 
								<?
							}
							if($n==1)
							{ 
								?>
								<td rowspan="<?  echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>"><? echo  $desc_key; ?></td> 
								<td rowspan="<? echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>" align="center" style="word-break:break-all"><? echo $val['remark']; ?></td>
								<td rowspan="<? echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>" align="center" style="word-break:break-all"><? echo $supplier_library[$val['nominated_supp']]; ?></td>
								<?
							}
							if($m==1){ 
								?>
								<td rowspan="<? echo $item_size_rowspan_arr[$trim_key][$desc_key][$gmt_color_key];?>" align="center" style="word-break:break-all"><? echo $color_library[$gmt_color_key]; ?></td>
								<?
							}
							?>
							<td title="<? echo $size_library[$size_key];?>" align="center" style="word-break:break-all"><? if($val['item_size']=='0' || $val['item_size']=='') echo ''; else echo $val['item_size']; ?></td>
							<td align="center"><? echo $unit_of_measurement[$val['cons_uom']]; ?></td>
							<td align="right" style="word-break:break-all"><? echo number_format($val['tot_cons'],4); ?></td>
							<td align="right" style="word-break:break-all"><? echo number_format($val['excess_per'],4); ?></td>
							<td align="center" style="word-break:break-all"><? echo number_format($val['cons'],4); ?></td>
							<td align="right" style="word-break:break-all"><? echo number_format($gmt_size_qty,4); ?></td>
							<td align="center" style="word-break:break-all"><? echo number_format($rate,4); ?></td>
                            <td align="center" style="word-break:break-all"><? echo number_format($val['amount'],4); ?></td>
							<?
							if($n==1){ 
								?>
								<td rowspan="<? echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>" align="center" style="word-break:break-all"><? echo number_format($gmt_item_desc_qty,4); ?></td>
                                <td rowspan="<? echo $trim_desc_rowspan_arr[$trim_key][$desc_key];?>" align="center" style="word-break:break-all"><? echo  number_format($gmt_item_desc_amt,4); ?></td>
								<?
							}
							?>
						</tr>
						<?
						$total_tot_trim_qty+=$val['cons'];
						$total_trim_cons+=$val['tot_cons'];
						$total_trim_qty_cons+=$gmt_size_qty;
						
						$total_trim_amount+=$val['amount'];
						
						//$total_tot_trim_cons+=$val['tot_cons'];
						$k++;$m++;$n++;
					}
				}
				$total_tot_item_qty_cons+=$gmt_item_desc_qty;
				$total_tot_item_amt+=$gmt_item_desc_amt;
			}
			$j++;
        }
        ?>
        </tbody>
        <tfoot>
            <tr>
                <th colspan="8" align="right"> Grand Total</th>
                <th align="right"><? echo number_format($total_trim_cons,4); ?></th>
                <th>&nbsp;</th>
                <th align="right"><? echo number_format($total_tot_trim_qty,4); ?></th>
                <th align="right"><? echo number_format($total_trim_qty_cons,4); ?></th>
                <th>&nbsp;</th>
                <th align="right"><? echo number_format($total_trim_amount,4); ?></th>
                <th align="right"><? echo number_format($total_tot_item_qty_cons,4); ?></th>
                <th align="right"><? echo number_format($total_tot_item_amt,4); ?></th>
            </tr>
        </tfoot>
    </table>
    <br/>
    	<table class="rpt_table" width="1030" cellpadding="0" cellspacing="0" border="1" rules="all">
            <caption> <b style="float:left">Embellishment Details :</b></caption>
            <thead>
                <th width="30">SL</th>
                <th width="120">Embellishment Name</th>
                <th width="120">Embellishment Type</th>
                <th width="120">Body Part</th>
                <th width="150">Supplier</th>
                
                <th width="60">Uom</th>
                <th width="70">Cons.</th>
                <th width="80">Total Qty</th>
                <th width="60">Rate</th>
                <th width="100">Total Amount</th>
                <th>Remarks</th>
            </thead>
            <?
            $emblishment_qty_name_type_arr=$emblishment->getQtyArray_by_jobEmbnameAndEmbtype();
            $emblishment_amount_name_type_arr=$emblishment->getAmountArray_by_jobEmbnameAndEmbtype();
            $wash_type_name_qty_arr=$wash->getQtyArray_by_jobEmbnameAndEmbtype();
            $wash_type_name_amount_arr=$wash->getAmountArray_by_jobEmbnameAndEmbtype();
            
            $sql_emblish="select a.order_uom,c.id, c.job_no,c.supplier_id,c.body_part_id, c.emb_name,c.emb_type,c.cons_dzn_gmts,c.rate, c.amount from wo_po_details_master a, wo_po_break_down b,wo_pre_cost_embe_cost_dtls c  where a.job_no=b.job_no_mst and c.job_no=b.job_no_mst and c.job_no=a.job_no  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.job_no='$txt_job_no' order by c.id";
            
            $result_emblish=sql_select($sql_emblish);
            $emblish_detail_arr=array();
            foreach($result_emblish as $row)
            {
				$item_descrition =$row[csf("description")];
				$embl_rowspan+=1;
				$emblish_detail_arr[$row[csf("emb_name")]][$row[csf("emb_type")]]['emb_name']=$row[csf("emb_name")];
				$emblish_detail_arr[$row[csf("emb_name")]][$row[csf("emb_type")]]['emb_type']=$row[csf("emb_type")];
				$emblish_detail_arr[$row[csf("emb_name")]][$row[csf("emb_type")]]['supplier_id']=$row[csf("supplier_id")];
				$emblish_detail_arr[$row[csf("emb_name")]][$row[csf("emb_type")]]['body_part_id']=$row[csf("body_part_id")];
				$emblish_detail_arr[$row[csf("emb_name")]][$row[csf("emb_type")]]['cons_dzn_gmts']=$row[csf("cons_dzn_gmts")];
				$emblish_detail_arr[$row[csf("emb_name")]][$row[csf("emb_type")]]['amount']=$row[csf("amount")];
				$emblish_detail_arr[$row[csf("emb_name")]][$row[csf("emb_type")]]['order_uom']=$row[csf("order_uom")];
				$emblish_detail_arr[$row[csf("emb_name")]][$row[csf("emb_type")]]['rate']=$row[csf("rate")];
				$emblish_detail_arr[$row[csf("emb_name")]][$row[csf("emb_type")]]['job_no'].=$row[csf("job_no")].',';
				$emblish_detail_arr[$row[csf("emb_name")]][$row[csf("emb_type")]]['desc']=$item_descrition;
            }
			unset($result_emblish);
            //echo $embl_rowspan;
            //print_r($conv_rowspan_arr);
            $i=$m=1; $grand_total_embl_amount=$grand_total_cons_dzn_gmts=0;
            foreach($emblish_detail_arr as $emb_name=>$enm_val)
            {
				foreach($enm_val as $emb_type=>$val)
				{
					if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					$job_no=rtrim($val[('job_no')],','); 
					$job_nos=array_unique(explode(",",$job_no));
					//$emb_name=$val[('emb_name')];$emb_type=$val[('emb_type')];
					
					if($emb_name==1)$em_type = $emblishment_print_type[$emb_type];
					else if($emb_name==2)$em_type = $emblishment_embroy_type[$emb_type];
					else if($emb_name==3)$em_type = $emblishment_wash_type[$emb_type];
					else if($emb_name==4)$em_type = $emblishment_spwork_type[$emb_type];
					
					$cons_dzn_gmts=0;$embl_amount=0;
					foreach($job_nos as $jno)
					{
						if($emb_name !=3){
							$wash_qty=$emblishment_qty_name_type_arr[$jno][$emb_name][$emb_type];
							$wash_amt=$emblishment_amount_name_type_arr[$jno][$emb_name][$emb_type];
							if($wash_amt) $wash_amt=$wash_amt;else $wash_amt=0;
							if($wash_qty) $wash_qty=$wash_qty;else $wash_qty=0;
							if(($wash_qty!="" || $wash_amt!=0) && ($wash_qty!="" || $wash_amt!=0))
							{
								$em_amount=$emblishment_amount_name_type_arr[$jno][$emb_name][$emb_type];
								$cons_dzn=$emblishment_qty_name_type_arr[$jno][$emb_name][$emb_type];
								if($em_amount) $em_amount=$em_amount;else $em_amount=0;
								if($cons_dzn) $cons_dzn=$cons_dzn;else $cons_dzn=0;
								
								$cons_dzn_gmts+=$cons_dzn;
								$embl_amount+=$em_amount;
							}
						}
						else if($emb_name ==3){
							$wash_qty=$wash_type_name_qty_arr[$jno][$emb_name][$emb_type];
							$wash_amt=$wash_type_name_amount_arr[$jno][$emb_name][$emb_type];
							if($wash_amt) $wash_amt=$wash_amt;else $wash_amt=0;
							if($wash_qty) $wash_qty=$wash_qty;else $wash_qty=0;
							if(($wash_qty!="" || $wash_amt!=0) && ($wash_qty!="" || $wash_amt!=0))
							{
								$embl_amt=$wash_type_name_amount_arr[$jno][$emb_name][$emb_type];
								$cons_dzn=$wash_type_name_qty_arr[$jno][$emb_name][$emb_type];
								if($embl_amt) $embl_amt=$embl_amt;else $embl_amt=0;
								if($cons_dzn) $cons_dzn=$cons_dzn;else $cons_dzn=0;
								$cons_dzn_gmts+=$wash_type_name_qty_arr[$jno][$emb_name][$emb_type];
								$embl_amount+=$embl_amt;
							}			
						}
					}
					//wash_type_name_amount_arr
					//echo $embl_amount.','; 
					
					$rate=$embl_amount/$cons_dzn_gmts;
					?>
					<tr bgcolor="<? echo $bgcolor;?>" onClick="change_color('tremb_<? echo $i; ?>','<? echo $bgcolor;?>')" id="tremb_<? echo $i; ?>"> 					 
                        <td><? echo $i; ?></td>	
                        <td style="word-break:break-all"><? echo $emblishment_name_array[$emb_name]; ?></td>
                        <td style="word-break:break-all"><? echo $em_type; ?></td>
                        <td style="word-break:break-all"><? echo $body_part[$val[('body_part_id')]]; ?></td>
                        <td style="word-break:break-all"><? echo $supplier_library[$val['supplier_id']]; ?></td> 
                        <td style="word-break:break-all"><? echo $unit_of_measurement[$val[('order_uom')]]; ?></td>
                        <td align="right"><? echo number_format($val[('cons_dzn_gmts')],4); ?></td>
                        <td align="right"><? echo number_format($cons_dzn_gmts,4); ?></td>
                        <td align="right"><? echo number_format($rate,4); ?></td>
                        <td align="right"><? echo number_format($embl_amount,4); ?></td>
                        <td style="word-break:break-all"><? //echo $val[('supplier_id')]; ?></td>
					</tr>
					<?
					$grand_total_cons_dzn_gmts+=$val[('cons_dzn_gmts')];
					$grand_total_embl_qty+=$cons_dzn_gmts;
					$grand_total_embl_amount+=$embl_amount;
					$i++;//$m++;
				}
            }
            ?>
            <tfoot>
                <tr>
                    <th align="right" colspan="6"><strong>Grand Total</strong> </th>
                    <th align="right"><strong><? echo number_format($grand_total_cons_dzn_gmts,4);?></strong></th>
                    <th align="right"><? echo number_format($grand_total_embl_qty,4);?></th>
                    <th align="right">&nbsp;</th>
                    <th align="right"><? echo number_format($grand_total_embl_amount,4); ?> </th>
                    <th align="right">&nbsp;</th>
                </tr>
            </tfoot>
        </table>
    </div>
    </div>
    <? echo signature_table(109, $cbo_company_name, "860px");
	exit();	
}

if($action=="budgete_cost_validate")
{
	$cost_sheet_id=$data;
	$str_data="";
	if($cost_sheet_id!=0)
	{
		$is_approved=0;
		$approved_sql=sql_select("select approved from qc_confirm_mst where cost_sheet_id='$cost_sheet_id'");
		$is_approved=$approved_sql[0][csf('approved')];
		$commercial_cost_sql=sql_select("select commercial_cost from qc_tot_cost_summary where mst_id='$cost_sheet_id' and status_active=1 and is_deleted=0");
		$commercial_cost=$commercial_cost_sql[0][csf('commercial_cost')];
		$sql="select fab_cons_kg, fab_cons_mtr, fab_cons_yds, fab_amount, sp_oparation_amount, wash_amount, acc_amount, fright_amount, lab_amount, misce_amount, other_amount, comm_amount, fob_amount, cm_amount, commercial_cost, rmg_ratio from qc_confirm_dtls where cost_sheet_id='$cost_sheet_id' and status_active=1 and is_deleted=0";
		$dataArr=sql_select($sql);
		$fab_cons_kg=$fab_cons_mtr=$fab_cons_yds=$fab_amount=$sp_oparation_amount=$wash_amount=$acc_amount=$fright_amount=$lab_amount=$misce_amount=$other_amount=$comm_amount=$fob_amount=$cm_amount=$rmg_ratio=0;//$commercial_cost=

		foreach($dataArr as $row)
		{
			$fab_cons_kg+=$row[csf("fab_cons_kg")];
			$fab_cons_mtr+=$row[csf("fab_cons_mtr")];
			$fab_cons_yds+=$row[csf("fab_cons_yds")];
			$fab_amount+=$row[csf("fab_amount")];
			$sp_oparation_amount+=$row[csf("sp_oparation_amount")];
			$wash_amount+=$row[csf("wash_amount")];
			$acc_amount+=$row[csf("acc_amount")];
			$fright_amount+=$row[csf("fright_amount")];
			$lab_amount+=$row[csf("lab_amount")];
			$misce_amount+=$row[csf("misce_amount")];
			$other_amount+=$row[csf("other_amount")];
			$comm_amount+=$row[csf("comm_amount")];
			$fob_amount+=$row[csf("fob_amount")];
			$cm_amount+=$row[csf("cm_amount")];
			$rmg_ratio+=$row[csf("rmg_ratio")];
			//$commercial_cost+=$row[csf("commercial_cost")];
		}
		$str_data=fn_number_format($fab_cons_kg,4)."##".fn_number_format($fab_cons_mtr,4)."##".fn_number_format($fab_cons_yds,4)."##".fn_number_format($fab_amount,4)."##".fn_number_format($sp_oparation_amount,4)."##".fn_number_format($wash_amount,4)."##".fn_number_format($acc_amount,4)."##".fn_number_format($fright_amount,4)."##".fn_number_format($lab_amount,4)."##".fn_number_format($misce_amount,4)."##".fn_number_format($other_amount,4)."##".fn_number_format($comm_amount,4)."##".fn_number_format($fob_amount,4)."##".fn_number_format($cm_amount,4)."##".fn_number_format($commercial_cost,4)."##".fn_number_format($rmg_ratio,4)."##".$is_approved;
	}
	echo $str_data;
	exit();
}
if($action=="short_quatation_validate")
{
	$str_data=sql_select( "select short_quatation_on_budget as yesno  from  variable_order_tracking where company_name='$data' and variable_list=89 order by id" );
	echo $str_data[0][csf('yesno')];
	exit();

}
if($action=="preCostRpt3")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if($db_type==0)
	{
		$costing_date=change_date_format(str_replace("'","",$txt_costing_date), "yyyy-mm-dd", "-");
		$limit_cond="LIMIT 1";
		$group_gsm="group_concat( distinct b.gsm_weight)";
	}
	else if($db_type==2)
	{
		$costing_date=change_date_format(str_replace("'","",$txt_costing_date), "yyyy-mm-dd", "-",1);
		$limit_cond="";
		$group_gsm="listagg(b.gsm_weight ,',') within group (order by b.gsm_weight)";
	}

	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and b.costing_date='".$txt_costing_date."'";

	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');

	$sqlcpm=sql_select("select cost_per_minute from lib_standard_cm_entry where company_id=$cbo_company_name and '$costing_date' between applying_period_date and applying_period_to_date and status_active=1 and is_deleted=0 $limit_cond");

	$cpm='';
	foreach($sqlcpm as $sqlcpmrow){
		$cpm=$sqlcpmrow[csf('cost_per_minute')];
	}
	unset($sqlcpm);

	$po_qty=0; $po_plun_cut_qty=0;
	$sql_po="select a.job_no, a.buyer_name, a.gmts_item_id, a.style_ref_no, a.total_set_qnty, a.set_smv, a.company_name, a.order_uom, a.job_quantity, a.avg_unit_price, b.id, b.po_number, b.pub_shipment_date, c.item_number_id, c.country_id, c.color_number_id, c.size_number_id, c.order_quantity, c.plan_cut_qnty

	from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c

	where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and a.job_no =".$txt_job_no." and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 order by b.id";
	$sql_po_data=sql_select($sql_po); $job_data_arr=array(); $po_data_arr=array();
	foreach($sql_po_data as $jrow)
	{
		$job_data_arr[$jrow[csf('job_no')]]['jdata']=$jrow[csf('buyer_name')].'___'.$jrow[csf('gmts_item_id')].'___'.$jrow[csf('style_ref_no')].'___'.$jrow[csf('total_set_qnty')].'___'.$jrow[csf('set_smv')].'___'.$jrow[csf('company_name')].'___'.$jrow[csf('order_uom')].'___'.$jrow[csf('job_quantity')].'___'.$jrow[csf('avg_unit_price')];

		$po_data_arr[$jrow[csf('job_no')]][$jrow[csf('id')]]['pdata']=$jrow[csf('po_number')].'___'.$jrow[csf('pub_shipment_date')];

		$po_qty+=$jrow[csf('order_quantity')];
		$po_plun_cut_qty+=$jrow[csf('plan_cut_qnty')];
	}
	unset($sql_po_data);

	$mst_sql = "select a.job_no, a.costing_date, a.costing_per, a.budget_minute, a.approved, a.sew_smv, a.sew_effi_percent, a.exchange_rate, a.inserted_by, a.incoterm, c.fab_knit_req_kg, c.fab_knit_fin_req_kg, c.fab_woven_req_yds, c.fab_woven_fin_req_yds, c.fab_yarn_req_kg from wo_pre_cost_mst a left join wo_pre_cost_sum_dtls c on a.job_no=c.job_no where a.status_active=1 and a.job_no=".$txt_job_no."";

	$mst_sql_res=sql_select($mst_sql); $pre_mst_arr=array();
	foreach($mst_sql_res as $mrow)
	{
		$pre_mst_arr[$mrow[csf('job_no')]]['mdata']=$mrow[csf('costing_date')].'___'.$mrow[csf('costing_per')].'___'.$mrow[csf('budget_minute')].'___'.$mrow[csf('approved')].'___'.$mrow[csf('sew_effi_percent')].'___'.$mrow[csf('inserted_by')].'___'.$mrow[csf('sew_smv')].'___'.$mrow[csf('exchange_rate')].'___'.$mrow[csf('incoterm')];
		$pre_mst_arr[$mrow[csf('job_no')]]['knit_req_kg']+=$mrow[csf('fab_knit_req_kg')];
		$pre_mst_arr[$mrow[csf('job_no')]]['fin_req_kg']+=$mrow[csf('fab_knit_fin_req_kg')];
		$pre_mst_arr[$mrow[csf('job_no')]]['woven_req_yds']+=$mrow[csf('fab_woven_req_yds')];
		$pre_mst_arr[$mrow[csf('job_no')]]['woven_fin_req_yds']+=$mrow[csf('fab_woven_fin_req_yds')];
		$pre_mst_arr[$mrow[csf('job_no')]]['yarn_req_kg']+=$mrow[csf('fab_yarn_req_kg')];
	}
	unset($mst_sql_res);

	$job_no=str_replace("'","",$txt_job_no);

	$exjob_data=explode("___",$job_data_arr[$job_no]['jdata']);

	$buyer_id=$exjob_data[0];
	$gmts_item_id=$exjob_data[1];
	$style_ref_no=$exjob_data[2];
	$total_set_qnty=$exjob_data[3];
	$set_smv=$exjob_data[4];
	$company_name=$exjob_data[5];
	$order_uom=$exjob_data[6];
	$job_qty=$exjob_data[7];
	$avg_unit_price=$exjob_data[8];

	$po_id=''; $po_no=""; $pubship_date='';

	foreach($po_data_arr[$job_no] as $pid=>$podata)
	{
		$ex_po=0;
		//echo $podata['pdata'].'==';
		$ex_po=explode("___",$podata['pdata']);
		if($po_id=="") $po_id=$pid; else $po_id.=', '.$pid;
		if($po_no=="") $po_no=$ex_po[0]; else $po_no.=', '.$ex_po[0];
		if($pubship_date=="") $pubship_date=change_date_format($ex_po[1]); else $pubship_date.=', '.change_date_format($ex_po[1]);
	}

	$exmst_data=explode("___",$pre_mst_arr[$job_no]['mdata']);

	$costing_date=$exmst_data[0];
	$costing_per=$exmst_data[1];
	$budget_minute=$exmst_data[2];
	$approved=$exmst_data[3];
	$sew_effi_percent=$exmst_data[4];
	$inserted_by=$exmst_data[5];
	$pre_sew_smv=$exmst_data[6];
	$exchange_rate=$exmst_data[7];
	$incoterm=$exmst_data[8];

	$gsm_sql="select $group_gsm AS gsm_weight from lib_body_part a, wo_pre_cost_fabric_cost_dtls b where a.id=b.body_part_id and b.job_no='$job_no' and a.body_part_type in (1,20)";
	$gsm_sql_res=sql_select($gsm_sql); $gsm_weight='';
	foreach($gsm_sql_res as $grow)
	{
		if($gsm_weight=="") $gsm_weight=$grow[csf('gsm_weight')]; else $gsm_weight.=','.$grow[csf('gsm_weight')];
	}
	unset($gsm_sql_res);

	$imge_arr=return_library_array( "select master_tble_id, image_location from common_photo_library where form_name='company_details' and file_type=1 and master_tble_id='$company_name'",'master_tble_id','image_location');
    $image_location=return_field_value("image_location","common_photo_library","master_tble_id='$job_no'");
	ob_start();//part 0;
	if($presentation_type==2) $path="../../../"; else $path="../../";

	?>
    <div style="width:850px;">
        <table width="100%" border="0">
            <tr>
                <td rowspan="3" width="25%">
					<? if ($img_path) { ?> <img  src='<? echo $img_path.$imge_arr[$company_name]; ?>' height='80' />
                    <? } else { ?> <img  src='<? echo $path.$imge_arr[$company_name]; ?>' height='80' />
                    <? } ?>
                </td>
                <td align="center"><b style="font-size:20px;"><? echo $comp[$company_name]; ?></b></td>
                <td rowspan="3" width="25%" align="right">
					<? if ($img_path) { ?> <img  src='<? echo $img_path.$image_location; ?>' height='80' />
                    <? } else { ?> <img  src='<? echo $path.$image_location; ?>' height='80' />
                    <? } ?>
                </td>
            </tr>
            <tr><td align="center"><b style="font-size:14px;">PRE-COSTING SHEET</b></td></tr>
            <tr>
                <td align="center">
                	<? if( $approved==1 || $approved==3){echo "<div style='font-size:18px; color:#F00; background:#CCC;'>THIS COST SHEET IS APPROVED </div>"; } else {echo "&nbsp;";} ?>
                </td>
            </tr>
        </table>
    </div>
    <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
        <tr>
            <td width="130">Job No.</td><td width="140"><b><? echo $job_no; ?></b></td>
            <td width="130">Buyer</td><td width="140"><b><? echo $buyer_arr[$buyer_id];?></b></td>
            <td width="130">Garments Item</td>
				<?
					$grmnt_items = "";
					$ex_gmt_id=explode(",",$gmts_item_id);
					foreach($ex_gmt_id as $gmt_id)
					{
						if($grmnt_items=="") $grmnt_items=$garments_item[$gmt_id]; else $grmnt_items.=', '.$garments_item[$gmt_id];
					}
                ?>
            <td><b><? echo $grmnt_items; ?></b></td>
        </tr>
        <tr>
            <td>Style Ref. No</td><td><b><? echo $style_ref_no; ?></b></td>
            <td>Costing Date</td><td><? echo change_date_format($costing_date);?></td>
            <td>Job Qty</td><td><b><? echo number_format($job_qty)." ". $unit_of_measurement[$order_uom]; ?></b></td>
        </tr>
        <tr>
            <td>Order No.</td><td colspan="3"><? echo $po_no; ?></td>
            <td>Plan Cut Qty [Cut % <? echo number_format((($po_plun_cut_qty/$total_set_qnty-$job_qty)/$job_qty)*100,2);?>]</td>
            <td><b><? echo number_format($po_plun_cut_qty/$total_set_qnty)." ". $unit_of_measurement[$order_uom]; ?></b></td>
        </tr>
        <tr>
            <td>Knit Fabric Cons</td>
            <td><b><? echo $pre_mst_arr[$job_no]['knit_req_kg']; $fab_knit_req_kg_avg+=$pre_mst_arr[$job_no]['knit_req_kg']; ?> (Kg)</b></td>
            <td>Woven Fabric Cons</td>
            <td><b><? echo $pre_mst_arr[$job_no]['woven_req_yds']; $fab_woven_req_yds_avg+=$pre_mst_arr[$job_no]['woven_req_yds']; ?> (Yds)</b></td>
            <td>Price Per Unit</td><td><b><? echo number_format($avg_unit_price,2); ?> USD</b></td>
        </tr>
        <tr>
            <td>Avg Yarn Req</td><td><b><? echo $pre_mst_arr[$job_no]['yarn_req_kg']; ?> (Kg)</b></td>
            <td>Woven Fin Fabric Cons</td><td><b><? echo $pre_mst_arr[$job_no]['woven_fin_req_yds']; ?>(Yds)</b></td>
            <td>Order Value</td><td><b><? $order_value=$job_qty*$avg_unit_price; echo number_format($order_value,2); ?></b></td>
        </tr>
        <tr>
            <td>Knit Fin Fabric Cons</td><td><b><? echo $pre_mst_arr[$job_no]['fin_req_kg']; ?> (Kg)</b></td>
            <td>Costing Per</td><td><b><? echo $costing_per[$costing_per]; ?></b></td>
            <td>Inco Term</td><td><b><? echo $incoterm[$incoterm]; ?></b></td>
        </tr>
        <tr>
            <td>GSM</td><td><b><? echo $gsm_weight; ?></b></td>
            <td>SMV</td><td><b><? echo number_format($pre_sew_smv,2); ?> </b></td>
            <td>Efficiency %</td><td><b><? echo $sew_effi_percent; ?> </b></td>
        </tr>
        <tr>
            <td>Exchange Rate</td><td><b><? echo $exchange_rate; ?></b></td>
            <td>Budget SAH</td><td><b><? echo number_format(($pre_sew_smv*$job_qty)/60,2); ?></b></td>
            <td>Shipment Date</td><td><b><? echo $pubship_date;?></b></td>
        </tr>
    </table>
    <?
	if($costing_per==1) { $order_price_per_dzn=12; $costing_for=" DZN"; }
	else if($costing_per==2) { $order_price_per_dzn=1; $costing_for=" PCS"; }
	else if($costing_per==3) { $order_price_per_dzn=24;$costing_for=" 2 DZN"; }
	else if($costing_per==4) { $order_price_per_dzn=36;$costing_for=" 3 DZN"; }
	else if($costing_per==5) { $order_price_per_dzn=48;$costing_for=" 4 DZN"; }

	$dtlssql = "select fabric_cost, fabric_cost_percent, trims_cost, trims_cost_percent, embel_cost, embel_cost_percent, wash_cost, wash_cost_percent, comm_cost, comm_cost_percent, commission, commission_percent, lab_test, lab_test_percent, inspection, inspection_percent, cm_cost, cm_cost_percent, freight, freight_percent, currier_pre_cost, currier_percent, certificate_pre_cost, certificate_percent, common_oh, common_oh_percent, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set, margin_pcs_set_percent, cm_for_sipment_sche, interest_cost, interest_percent, incometax_cost, incometax_percent, deffdlc_cost, deffdlc_percent from wo_pre_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0";
	$dtlssql_res=sql_select($dtlssql);

	$fabric_cost=$trims_cost=$embel_cost=$wash_cost=$comm_cost=$commission=$lab_test=$inspection=$cm_cost=$freight=$currier_pre_cost=$certificate_pre_cost=$common_oh=$total_cost=$price_dzn=$margin_dzn=$price_pcs_or_set=$margin_pcs_set=$cm_for_sipment_sche=$interest_cost=$incometax_cost=$deffdlc_cost=0;

	$fabric_cost_percent=$trims_cost_percent=$embel_cost_percent=$embel_cost_percent=$wash_cost_percent=$comm_cost_percent=$commission_percent=$lab_test_percent=$inspection_percent=$cm_cost_percent=$freight_percent=$currier_percent=$certificate_percent=$common_oh_percent=$total_cost_percent=$price_dzn_percent=$margin_dzn_percent=$price_pcs_or_set=$price_pcs_or_set_percent=$margin_pcs_set_percent=$interest_percent=$incometax_percent=$deffdlc_percent=0;

	$fabric_cost=$dtlssql_res[0][csf('fabric_cost')];
	$fabric_cost_percent=$dtlssql_res[0][csf('fabric_cost_percent')];
	$trims_cost=$dtlssql_res[0][csf('trims_cost')];
	$trims_cost_percent=$dtlssql_res[0][csf('trims_cost_percent')];
	$embel_cost=$dtlssql_res[0][csf('embel_cost')];

	$embel_cost_percent=$dtlssql_res[0][csf('embel_cost_percent')];
	$wash_cost=$dtlssql_res[0][csf('wash_cost')];
	$wash_cost_percent=$dtlssql_res[0][csf('wash_cost_percent')];
	$comm_cost=$dtlssql_res[0][csf('comm_cost')];
	$comm_cost_percent=$dtlssql_res[0][csf('comm_cost_percent')];
	$commission=$dtlssql_res[0][csf('commission')];
	$commission_percent=$dtlssql_res[0][csf('commission_percent')];
	$lab_test=$dtlssql_res[0][csf('lab_test')];
	$lab_test_percent=$dtlssql_res[0][csf('lab_test_percent')];
	$inspection=$dtlssql_res[0][csf('inspection')];
	$inspection_percent=$dtlssql_res[0][csf('inspection_percent')];
	$cm_cost=$dtlssql_res[0][csf('cm_cost')];
	$cm_cost_percent=$dtlssql_res[0][csf('cm_cost_percent')];
	$freight=$dtlssql_res[0][csf('freight')];
	$freight_percent=$dtlssql_res[0][csf('freight_percent')];
	$currier_pre_cost=$dtlssql_res[0][csf('currier_pre_cost')];
	$currier_percent=$dtlssql_res[0][csf('currier_percent')];
	$certificate_pre_cost=$dtlssql_res[0][csf('certificate_pre_cost')];
	$certificate_percent=$dtlssql_res[0][csf('certificate_percent')];
	$common_oh=$dtlssql_res[0][csf('common_oh')];
	$common_oh_percent=$dtlssql_res[0][csf('common_oh_percent')];

	$total_cost=$dtlssql_res[0][csf('total_cost')];
	$total_cost_percent=$dtlssql_res[0][csf('total_cost_percent')];
	$price_dzn=$dtlssql_res[0][csf('price_dzn')];
	$price_dzn_percent=$dtlssql_res[0][csf('price_dzn_percent')];
	$margin_dzn=$dtlssql_res[0][csf('margin_dzn')];
	$margin_dzn_percent=$dtlssql_res[0][csf('margin_dzn_percent')];
	$price_pcs_or_set=$dtlssql_res[0][csf('price_pcs_or_set')];
	$price_pcs_or_set_percent=$dtlssql_res[0][csf('price_pcs_or_set_percent')];
	$margin_pcs_set=$dtlssql_res[0][csf('margin_pcs_set')];
	$margin_pcs_set_percent=$dtlssql_res[0][csf('margin_pcs_set_percent')];
	$cm_for_sipment_sche=$dtlssql_res[0][csf('cm_for_sipment_sche')];
	$interest_cost=$dtlssql_res[0][csf('interest_cost')];
	$interest_percent=$dtlssql_res[0][csf('interest_percent')];
	$incometax_cost=$dtlssql_res[0][csf('incometax_cost')];
	$incometax_percent=$dtlssql_res[0][csf('incometax_percent')];
	$deffdlc_cost=$dtlssql_res[0][csf('deffdlc_cost')];
	$deffdlc_percent=$dtlssql_res[0][csf('deffdlc_percent')];
	unset($dtlssql_res);
	$others_cost_value=0; $costOfFabriTrimsEmbWash=0;
	$others_cost_value=$total_cost-$cm_cost-$freight-$comm_cost-$commission;
	$costOfFabriTrimsEmbWash=($fabric_cost+$trims_cost+$embel_cost+$wash_cost);

	 $sl=1;
	?>
    <div style="margin-top:15px">
        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px; text-align:center;" rules="all">
            <tr style="font-weight:bold">

                <td width="80">SL</td>
                <td width="300">Particulars</td>
                <td width="100">Cost</td>
                <td width="100">Amount (USD)</td>
                <td>% to Ord. Value</td>
            </tr>
            <? if($zero_value==1) { ?>
                <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left">Gross FOB Value/ DZN</td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo $grfobv_dzn=number_format($avg_unit_price*12,2) ; ?></td>
                    <td align="right">100.00%</td>

                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: Commision/ DZN</td>
                    <td align="right"><? echo number_format($commission,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo number_format(($commission/$grfobv_dzn)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Net FOB Value (1-2)</td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? $net_fob_value=$grfobv_dzn-$commission; echo number_format($net_fob_value,2); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">All Fabric Cost</td>
                    <td align="right"><? echo number_format($fabric_cost,4); ?></td>
                    <td align="right" rowspan="13">&nbsp;</td>
                    <td align="right"><? echo number_format($fabric_cost_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Trims Cost</td>
                    <td align="right"><? echo number_format($trims_cost,4); ?></td>
                    <td align="right"><? echo number_format($trims_cost_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Embellishment Cost</td>
                    <td align="right"><? echo number_format($embel_cost,4); ?></td>
                    <td align="right"><? echo number_format($embel_cost_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Gmts Wash</td>
                    <td align="right"><? echo number_format($wash_cost,4); ?></td>
                    <td align="right"><? echo number_format($wash_cost_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commercial Cost</td>
                    <td align="right"><? echo number_format($comm_cost,4); ?></td>
                    <td align="right"><? echo number_format($comm_cost_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo number_format($lab_test,4); ?></td>
                    <td align="right"><? echo number_format($lab_test_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo number_format($inspection,4); ?></td>
                    <td align="right"><? echo number_format($inspection_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Gmts Freight Cost</td>
                    <td align="right"><? echo number_format($freight,4); ?></td>
                    <td align="right"><? echo number_format($freight_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Currier Cost</td>
                    <td align="right"><? echo number_format($currier_pre_cost,4); ?></td>
                    <td align="right"><? echo number_format($currier_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Certificate Cost </td>
                    <td align="right"><? echo number_format($certificate_pre_cost,4); ?></td>
                    <td align="right"><? echo number_format($certificate_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Deffd.Lc.Cost (<? echo number_format($deffdlc_percent,2); ?>%)</td>
                    <td align="right"><? echo number_format($deffdlc_cost,4); ?></td>
                    <td align="right"><? echo number_format($deffdlc_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Tax (<? echo number_format($incometax_percent,2); ?>%)</td>
                    <td align="right"><? echo number_format($incometax_cost,4); ?></td>
                    <td align="right"><? echo number_format($incometax_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Finance Charge (<? echo number_format($interest_percent,2); ?>% )</td>
                    <td align="right"><? echo number_format($interest_cost,4); ?></td>
                    <td align="right"><? echo number_format($interest_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"><b>Total Material & Service Cost (4:16)</b></td>
                    <td>&nbsp;</td>
                    <td align="right"><b><?
                        $total_material_cost=$fabric_cost+$trims_cost+$embel_cost+$wash_cost+$comm_cost+$lab_test+$inspection+$freight+$currier_pre_cost+$certificate_pre_cost+$interest_cost+$incometax_cost+$deffdlc_cost;

                        $total_material_cost_percent=$fabric_cost_percent+$trims_cost_percent+$embel_cost_percent+$wash_cost_percent+$comm_cost_percent+$lab_test_percent+$inspection_percent+$freight_percent+$currier_percent+$certificate_percent+$interest_percent+$incometax_percent+$deffdlc_percent;

                        echo number_format($total_material_cost,2); ?></b></td>
                    <td align="right"><b><? echo number_format($total_material_cost_percent,2); ?>%</b></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Contribution Margin/Dzn (3-17)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? $cm_value_contribution_margine=$net_fob_value-$total_material_cost; echo number_format($cm_value_contribution_margine,2); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td><?  echo ++$sl; ?></td>
                    <td align="left">Factory Overhead (FOH)/Dzn</td>
                    <td>&nbsp;</td>
                    <td align="right"><? $foh=$cm_cost; echo number_format($foh,2); ?></td>
                    <td align="right"><? echo number_format($cm_cost_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?> (18-19)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? $margin_dozon=$cm_value_contribution_margine-$foh; echo number_format($margin_dozon,3); ?></td>
                    <td align="right"><b><? $margin_dzn_percent=($margin_dozon/$grfobv_dzn)*100; echo number_format($margin_dzn_percent,2); ?>%</b></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $unit_of_measurement[$uom]; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? $margin_pcs=$margin_dozon/12; echo number_format($margin_pcs,3); ?></td>
                    <td align="right"><? echo number_format($margin_pcs/($grfobv_dzn/12)*100,2); ?>%</td>
                </tr>
                <tr bgcolor="#CCCCCC">
                    <td><? echo ++$sl; ?></td>
                    <td align="left">EPM (Per Pcs CM/SMV)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? $margin_pcs=number_format(($cm_value_contribution_margine/12)/$pre_sew_smv,3); echo $margin_pcs; ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr bgcolor="#CCCCCC">
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CPM (Cost Per Minute)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo number_format((($cpm/$exchange_rate)/$sew_effi_percent)*100,3); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr bgcolor="#CCCCCC">
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Contribution Margin %</td>
                    <td>&nbsp;</td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo number_format($cm_value_contribution_margine/$net_fob_value*100,2); ?>%</td>
                </tr>
            <? } else { ?>
                <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left">Gross FOB Value/ DZN</td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo $grfobv_dzn=number_format($avg_unit_price*12,4); ?></td>
                    <td align="right">100.00%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: Commision/ DZN</td>
                    <td align="right"><? echo number_format($commission,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo number_format(($commission/$grfobv_dzn)*100,2);?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Net FOB Value (1-2)</td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo $net_fob_value=$grfobv_dzn-$commission; ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <?
                if($fabric_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">All Fabric Cost</td>
                        <td align="right"><? echo number_format($fabric_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo number_format($fabric_cost_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($trims_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Trims Cost</td>
                        <td align="right"><? echo number_format($trims_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo number_format($trims_cost_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($embel_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Embellishment Cost</td>
                        <td align="right"><? echo number_format($embel_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo number_format($embel_cost_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($wash_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Gmts Wash</td>
                        <td align="right"><? echo number_format($wash_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo number_format($wash_cost_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($comm_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Commercial Cost</td>
                        <td align="right"><? echo number_format($comm_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo number_format($comm_cost_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($commission!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Commission Cost</td>
                        <td align="right"><? echo number_format($commission,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo number_format($commission_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($lab_test!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Lab Test</td>
                        <td align="right"><? echo number_format($lab_test,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo number_format($lab_test_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($inspection!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Inspection Cost</td>
                        <td align="right"><? echo number_format($inspection,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo number_format($inspection_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($freight!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Gmts Freight Cost</td>
                        <td align="right"><? echo number_format($freight,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="center"><? echo number_format($freight_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($currier_pre_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Currier Cost</td>
                        <td align="right"><? echo number_format($currier_pre_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="right"><? echo number_format($currier_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($certificate_pre_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>

                        <td align="left">Certificate Cost</td>
                        <td align="right"><? echo number_format($certificate_pre_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="right"><? echo number_format($certificate_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($deffdlc_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Deffd.Lc.Cost (<? echo number_format($deffdlc_percent,2); ?>%)</td>
                        <td align="right"><? echo number_format($deffdlc_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="right"><? echo number_format($deffdlc_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($incometax_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Tax (<? echo number_format($incometax_percent,2); ?>%)</td>
                        <td align="right"><? echo number_format($incometax_cost,4); ?></td>
                        <td align="right">&nbsp;</td>
                        <td align="right"><? echo number_format($incometax_percent,2); ?>%</td>
					</tr>
					<?
                }
                ?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Tax (<? echo number_format($interest_percent,2); ?>%)</td>
                    <td align="right"><? echo number_format($interest_cost,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo number_format($interest_percent,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"><b>Total Material & Service Cost (4:14)</b></td>
                    <td>&nbsp;</td>
                    <td align="right"><b><?
						$total_material_cost=($fabric_cost+$trims_cost+$embel_cost+$wash_cost+$comm_cost+$lab_test+$inspection+$freight+$currier_pre_cost+$certificate_pre_cost+$interest_cost+$incometax_cost+$deffdlc_cost);
						echo number_format($total_material_cost,2); ?></b></td>
                    <td align="center"><b><?
						$total_material_cost_percent=$fabric_cost_percent+$trims_cost_percent+$embel_cost_percent+$wash_cost_percent+$comm_cost_percent+$lab_test_percent+$inspection_percent+$freight_percent+$currier_percent+$certificate_percent+$interest_percent+$incometax_percent+$deffdlc_percent;
						echo number_format($total_material_cost_percent,2); ?>%</b></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Contribution Margin/Dzn</td>
                    <td>&nbsp;</td>
                    <td align="right"><? $cm_value_contribution_margine=$price_dzn-$total_material_cost; echo number_format($cm_value_contribution_margine,2); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>
                <?
                if($cm_cost!=0)
                {
					?>
					<tr>
                        <td><? echo ++$sl; ?></td>
                        <td align="left">Factory Overhead (FOH)/Dzn</td>
                        <td>&nbsp;</td>
                        <td align="right"><? echo number_format($cm_cost,2); ?></td>
                        <td align="center"><? echo number_format($cm_cost_percent,2); ?>%</td>
					</tr>
					<?
                }
                ?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?> (16-17)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? $margin_dozon=$cm_value_contribution_margine-$foh;echo  number_format($margin_dozon,2);?></td>
                    <td align="right"><b><? $margin_dzn_percent=($margin_dozon/$grfobv_dzn)*100; echo number_format($margin_dzn_percent,2); ?>%</b></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $unit_of_measurement[$uom]; ?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo number_format($margin_pcs_set,2); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr style="background:#CCCCCC;">
                    <td><? echo ++$sl; ?></td>
                    <td align="left">EPM (Per Pcs CM/SMV)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo $margin_pcs=number_format(($cm_value_contribution_margine/12)/$sew_smv,3); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr style="background:#CCCCCC;">
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CPM (Cost Per Minute)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo number_format((($cpm/$exchange_rate)/$sew_effi_percent)*100,3); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr style="background:#CCCCCC;">
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Contribution Margin %</td>
                    <td>&nbsp;</td>
                    <td align="right">&nbsp;</td>
                    <td align="right"><? echo number_format($cm_value_contribution_margine/$net_fob_value*100,2); ?>%</td>
                </tr>
                <?
				}
				?>
            </table>
    </div>
	<?
    $sql_fab = "select id, job_no, body_part_id, fab_nature_id, color_type_id, fabric_description, avg_cons, avg_cons_yarn, fabric_source, gsm_weight, rate, amount, avg_finish_cons, status_active from wo_pre_cost_fabric_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0";

    $sql_fab_res=sql_select($sql_fab);

	$i=2;$j=2;
	foreach( $sql_fab_res as $row )
	{
		if($row[csf("fab_nature_id")]==2)//knit fabrics
		{
			$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")].", ".$row[csf("gsm_weight")];
			if($row[csf("fabric_source")] !=2){
				$amount=$row[csf("avg_cons_yarn")]*$row[csf("rate")];
			}
			else{
				$amount=$row[csf("avg_cons")]*$row[csf("rate")];
			}
			$percent_to_order_value=$amount/$price_dzn*100;
			$i++;
			$knit_fab .= '<tr>
					<td align="left">'.$item_descrition.'</td>
					<td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
					<td align="right">'.number_format($row[csf("avg_cons")],4).'</td>
					<td align="right">'.number_format($row[csf("avg_cons_yarn")],4).'</td>
					<td align="right">'.number_format($row[csf("rate")],4).'</td>
					<td align="right">'.number_format($amount,2).'</td>
					<td align="right">'.number_format($percent_to_order_value,2).'%</td>
				</tr>';

			$knit_subtotal_avg_cons += $row[csf("avg_cons")];
			$knit_subtotal_avg_cons_yarn += $row[csf("avg_cons_yarn")];
			if($row[csf("fabric_source")] !=2){
				$knit_subtotal_amount += $row[csf("avg_cons_yarn")]*$row[csf("rate")];
			}
			else{
				$knit_subtotal_amount += $row[csf("avg_cons")]*$row[csf("rate")];
			}
		}

		if($row[csf("fab_nature_id")]==3)//woven fabrics
		{
			$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")].", ".$row[csf("gsm_weight")];
			$amount=$row[csf("avg_cons")]*$row[csf("rate")];
			$percent_to_order_value=$amount/$price_dzn*100;
			$j++;
			$woven_fab .= '<tr>
				<td align="left">'.$item_descrition.'</td>
				<td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
				<td align="right">'.number_format($row[csf("avg_cons")],4).'</td>
				<td align="right">'.number_format($row[csf("avg_cons_yarn")],4).'</td>
				<td align="right">'.number_format($row[csf("rate")],4).'</td>
				<td align="right">'.number_format($amount,2).'</td>
				<td align="right">'.number_format($percent_to_order_value,2).'%</td>
			</tr>';

			$woven_subtotal_avg_cons += $row[csf("avg_cons")];
			$woven_subtotal_avg_cons_yarn += $row[csf("avg_cons_yarn")];
			$woven_subtotal_amount += $row[csf("avg_cons")]*$row[csf("rate")];
		}
	}
	unset($sql_fab_res);
	$knit_fab= '<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
					<label><b>All Fabric Cost  </b></label>
						<tr style="font-weight:bold"  align="center">
							<td width="80" rowspan="'.$i.'" ><div class="verticalText"><b>Knit Fabric</b></div></td>
							<td width="350">Description</td>
							<td width="100">Source</td>
							<td width="100">Fab. Cons/Dzn</td>
							<td width="100">Avg. Fab. Cons/Dzn</td>
							<td width="100">Rate (USD)</td>
							<td width="100">Amount (USD)</td>
							<td width="100">% to Ord. Value</td>
						</tr>'.$knit_fab;
	$woven_fab= '<tr><td colspan="7">&nbsp;</td></tr><tr>
					<td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;
	//knit fabrics table here
	$fab_knit_req_kg_avg_amount=$knit_subtotal_amount/$knit_subtotal_avg_cons*$fab_knit_req_kg_avg;
	$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2" align="left">Sub Total</td>
					<td align="right">'.number_format($knit_subtotal_avg_cons,4).'</td>
					<td align="right">'.number_format($knit_subtotal_avg_cons_yarn,4).'</td>
					<td></td>
					<td align="right">'.number_format($knit_subtotal_amount,2).'</td>
					<td align="right">'.number_format($knit_subtotal_amount/$price_dzn*100,2).'%</td>
				</tr>';
				if($zero_value==1) echo $knit_fab;
				else
				{
					if($row[csf("avg_cons")]>0) echo $knit_fab; else echo "";
				}

	//woven fabrics table here
	$fab_woven_req_yds_avg_amount=$woven_subtotal_amount/$woven_subtotal_avg_cons*$fab_woven_req_yds_avg;
	$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
					<td colspan="2" align="left">Sub Total</td>
					<td align="right">'.number_format($woven_subtotal_avg_cons,4).'</td>
					<td align="right">'.number_format($woven_subtotal_avg_cons_yarn,4).'</td>
					<td></td>
					<td align="right">'.number_format($woven_subtotal_amount,2).'</td>
					<td align="right">'.number_format($woven_subtotal_amount/$price_dzn*100,2).'%</td>
				</tr>';

	$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
		<td colspan="4" align="left">Total</td>
		<td align="right"></td>
		<td></td>
		<td align="right">'.number_format(($woven_subtotal_amount+$knit_subtotal_amount),2).'</td>
		<td align="right">'.number_format((($woven_subtotal_amount+$knit_subtotal_amount)/$price_dzn*100),2).'%</td>
	</tr></table></div>';

	if($zero_value==1) echo $woven_fab;
	else
	{
		if($row[csf("avg_cons")]>0) echo $woven_fab; else echo "";
	}
	$grand_total_amount = $knit_subtotal_amount+$woven_subtotal_amount;

	$lib_yarn_count=return_library_array( "select yarn_count, id from lib_yarn_count", "id", "yarn_count"  );

	$sql_yarn = "select min(id) as id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, color, type_id, min(cons_ratio) as cons_ratio, sum(cons_qnty) as cons_qnty, sum(avg_cons_qnty) as avg_cons_qnty, rate, sum(amount) as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0 group by count_id, copm_one_id, percent_one, copm_two_id, percent_two,color, type_id, rate";
	$sql_yarn_res=sql_select($sql_yarn);

	if($zero_value==1)
	{
		?>
		<div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="70" rowspan="<? echo count($sql_yarn_res)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
                    <td width="350">Yarn Desc</td>
                    <td width="100">Yarn Qnty</td>
                    <td width="100">Avg.Yarn Qnty</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td>% to Ord. Value</td>
                </tr>
                <?
                $total_qnty=0; $total_avg_qnty=0; $total_amount=0;
                foreach( $sql_yarn_res as $row )
                {
					if($row[csf("percent_one")]==100)
						$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
					else
						$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];

					?>
					<tr>
                        <td align="left"><? echo $item_descrition; ?></td>
                        <td align="right"><? echo number_format($row[csf("cons_qnty")],4); ?></td>
                        <td align="right"><? echo number_format($row[csf("avg_cons_qnty")],4); ?></td>
                        <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                        <td align="right"><? echo number_format($row[csf("amount")],2); ?></td>
                        <td align="right"><? echo number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
					</tr>
					<?
					$total_qnty += $row[csf("cons_qnty")];
					$total_avg_qnty += $row[csf("avg_cons_qnty")];
					$total_amount += $row[csf("amount")];
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo number_format($total_qnty,4); ?></td>
                    <td align="right"><? echo number_format($total_avg_qnty,4); ?></td>
                    <td></td>
                    <td align="right"><? echo number_format($total_amount,2); ?></td>
                    <td align="right"><? echo number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
		</div>
		<?
		$grand_total_amount +=$total_amount;
	}
	else
	{
		if($fabric_cost>0)
		{
			?>
			<div style="margin-top:15px">
                <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                    <tr style="font-weight:bold">
                        <td width="70" rowspan="<? echo count($sql_yarn_res)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
                        <td width="350">Yarn Desc</td>
                        <td width="100">Yarn Qnty</td>
                        <td width="100">Avg.Yarn Qnty</td>
                        <td width="100">Rate (USD)</td>
                        <td width="100">Amount (USD)</td>
                        <td>% to Ord. Value</td>
                    </tr>
                    <?
                    $total_qnty=0;$total_amount=0;
                    foreach( $sql_yarn_res as $row )
                    {
						if($row[csf("percent_one")]==100)
							$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
						else
							$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];

						?>
						<tr>
                            <td align="left"><? echo $item_descrition; ?></td>
                            <td align="right"><? echo number_format($row[csf("cons_qnty")],4); ?></td>
                            <td align="right"><? echo number_format($row[csf("avg_cons_qnty")],4); ?></td>
                            <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                            <td align="right"><? echo number_format($row[csf("amount")],2); ?></td>
                            <td align="right"><? echo number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
						</tr>
						<?
						$total_qnty += $row[csf("cons_qnty")];
						$total_avg_qnty += $row[csf("avg_cons_qnty")];
						$total_amount += $row[csf("amount")];
                    }
                    ?>
                    <tr class="rpt_bottom" style="font-weight:bold">
                        <td>Total</td>
                        <td align="right"><? echo number_format($total_qnty,4); ?></td>
                        <td align="right"><? echo number_format($total_avg_qnty,4); ?></td>
                        <td></td>
                        <td align="right"><? echo number_format($total_amount,2); ?></td>
                        <td align="right"><? echo number_format($total_amount/$price_dzn*100,2); ?>%</td>
                    </tr>
                </table>
			</div>
			<?
			$grand_total_amount +=$total_amount;
		}
		else
		{
			echo "";
		}
	}
	unset($sql_yarn_res);
	//End Yarn Cost part report here -------------------------------------------
	//start	Conversion Cost to Fabric report here -------------------------------------------
   	$sql_conv = "select a.id, a.fabric_description as fabric_description_id, a.job_no, a.cons_process, a.req_qnty, a.avg_req_qnty, a.charge_unit, a.amount, a.status_active, b.body_part_id, b.fab_nature_id, b.color_type_id, b.fabric_description from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id where a.job_no='$job_no' and b.status_active=1 and b.is_deleted=0 ";
	$sql_conv_res=sql_select($sql_conv);
	$conData=array();
	$totPro=array();
	foreach($sql_conv_res as $rows){
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['fabric_description_id']=$rows[csf('fabric_description_id')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['job_no']=$rows[csf('job_no')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['cons_process']=$rows[csf('cons_process')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['req_qnty']=$rows[csf('req_qnty')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['avg_req_qnty']=$rows[csf('avg_req_qnty')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['charge_unit']=$rows[csf('charge_unit')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['amount']=$rows[csf('amount')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['status_active']=$rows[csf('status_active')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['body_part_id']=$rows[csf('body_part_id')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['fab_nature_id']=$rows[csf('fab_nature_id')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['color_type_id']=$rows[csf('color_type_id')];
		$conData[$rows[csf('cons_process')]][$rows[csf('id')]]['fabric_description']=$rows[csf('fabric_description')];
		$totPro[$rows[csf('cons_process')]]=$rows[csf('cons_process')];
	}
	//unset($sql_conv_res);
	if($zero_value==1)
	{
		?>
        <div style="margin-top:15px">
        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <tr style="font-weight:bold">
                <td width="80" rowspan="<? echo count($sql_conv_res)+3+count($totPro); ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                <td width="350">Particulars</td>
                <td width="100">Process</td>
                <td width="100">Cons/Dzn</td>
                <td width="100">Avg. Cons/Dzn</td>
                <td width="100">Rate (USD)</td>
                <td width="100">Amount (USD)</td>
                <td>% to Ord. Value</td>
            </tr>
            <?
            $total_amount=0;
            $total_req_qnty=0;
            $total_avg_req_qnty=0;
            $total_charge_unit=0;
            foreach( $conData as $processId=>$idArr )
            {
				$sub_total_amount=0;
				$sub_total_req_qnty=0;
				$sub_total_avg_req_qnty=0;
				$sub_total_charge_unit=0;
				foreach( $idArr as $id=>$row )
				{
					if($row['fabric_description_id']!=0)
					{
						$item_descrition = $body_part[$row["body_part_id"]].", ".$color_type[$row["color_type_id"]].", ".$row["fabric_description"];
					}
					else
					{
						$item_descrition = "All Fabrics";
					}
					?>
					<tr>
                        <td align="left"><? echo $item_descrition; ?></td>
                        <td align="left"><? echo $conversion_cost_head_array[$row["cons_process"]]; ?></td>
                        <td align="right"><? echo number_format($row["req_qnty"],4); ?></td>
                        <td align="right"><? echo number_format($row["avg_req_qnty"],4); ?></td>
                        <td align="right"><? echo number_format($row["charge_unit"],4); ?></td>
                        <td align="right"><? echo number_format($row["amount"],2); ?></td>
                        <td align="right"><? echo number_format($row["amount"]/$price_dzn*100,2); ?>%</td>
					</tr>
					<?
					$sub_total_amount+= $row["amount"];
					$sub_total_req_qnty+= $row["req_qnty"];
					$sub_total_avg_req_qnty+= $row["avg_req_qnty"];
					$sub_total_charge_unit+= $row["charge_unit"];

					$total_amount += $row["amount"];
					$total_req_qnty+= $row["req_qnty"];
					$total_avg_req_qnty+= $row["avg_req_qnty"];
					$total_charge_unit+= $row["charge_unit"];
				}
				?>
				<tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Sub Total</td>
                    <td align="right"><? echo  number_format( $sub_total_req_qnty,4);?></td>
                    <td align="right"><? echo number_format($sub_total_avg_req_qnty,4); ?></td>
                    <td align="right"><? //echo  number_format($sub_total_charge_unit,4);?></td>
                    <td align="right"><? echo number_format($sub_total_amount,2); ?></td>
                    <td align="right"><? echo  number_format($sub_total_amount/$price_dzn*100,2);?>%</td>
				</tr>
				<?
            }
            ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="2">Conversion Total Cost</td>
                <td align="right"><? //echo number_format($total_req_qnty,4);?></td>
                <td align="right"><? //echo number_format($total_avg_req_qnty,4); ?></td>
                <td align="right"><? //echo number_format($total_charge_unit,4);?></td>
                <td align="right"><? echo number_format($total_amount,2); ?></td>
                <td align="right"><? echo number_format($total_amount/$price_dzn*100,2);?>%</td>
            </tr>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td align="left" colspan="5">Total Fabric Cost</td>
                <td align="right"><? echo number_format(($grand_total_amount+$total_amount),2); ?></td>
                <td align="right"><? echo number_format((($grand_total_amount+$total_amount)/$price_dzn*100),2); ?>%</td>
            </tr>
        </table>
        </div>
        <?
	}
	else
	{
		if($fabric_cost>0)
		{
			?>
			<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($sql_conv_res)+3+count($totPro); ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Avg. Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td>% to Ord. Value</td>
                </tr>
                <?
                $total_amount=0;
                $total_req_qnty=0;
                $total_avg_req_qnty=0;
                $total_charge_unit=0;
                foreach( $conData as $processId=>$idArr )
                {
					$sub_total_amount=0;
					$sub_total_req_qnty=0;
					$sub_total_avg_req_qnty=0;
					$sub_total_charge_unit=0;
					foreach( $idArr as $id=>$row )
					{
						if($row["fabric_description_id"] !=0)
						{
							$item_descrition = $body_part[$row["body_part_id"]].", ".$color_type[$row["color_type_id"]].", ".$row["fabric_description"];
						}
						else
						{
							$item_descrition = "All Fabrics";
						}
						?>
						<tr>
                            <td align="left"><? echo $item_descrition; ?></td>
                            <td align="left"><? echo $conversion_cost_head_array[$row["cons_process"]]; ?></td>
                            <td align="right"><? echo number_format($row["req_qnty"],4); ?></td>
                            <td align="right"><? echo number_format($row["avg_req_qnty"],4); ?></td>
                            <td align="right"><? echo number_format($row["charge_unit"],4); ?></td>
                            <td align="right"><? echo number_format($row["amount"],2); ?></td>
                            <td align="right"><? echo number_format($row["amount"]/$price_dzn*100,2); ?>%</td>
						</tr>
						<?
						$sub_total_amount+= $row["amount"];
						$sub_total_req_qnty+= $row["req_qnty"];
						$sub_total_avg_req_qnty+= $row["avg_req_qnty"];
						$sub_total_charge_unit+= $row["charge_unit"];

						$total_amount += $row["amount"];
						$total_req_qnty+= $row["req_qnty"];
						$total_avg_req_qnty+= $row["avg_req_qnty"];
						$total_charge_unit+= $row["charge_unit"];
					}
					?>
                    <tr class="rpt_bottom" style="font-weight:bold">
                        <td colspan="2">Sub Total</td>
                        <td align="right"><? echo  number_format( $sub_total_req_qnty,4);?></td>
                        <td align="right"><? echo number_format($sub_total_avg_req_qnty,4); ?></td>
                        <td align="right"><? //echo  number_format($sub_total_charge_unit,4);?></td>
                        <td align="right"><? echo number_format($sub_total_amount,2); ?></td>
                        <td align="right"><? echo  number_format($sub_total_amount/$price_dzn*100,2);?>%</td>
                    </tr>
                    <?
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? //echo number_format($total_req_qnty,4);?></td>
                    <td align="right"><? //echo number_format($total_avg_req_qnty,4); ?></td>
                    <td align="right"><? //echo number_format($total_charge_unit,4);?></td>
                    <td align="right"><? echo number_format($total_amount,2); ?></td>
                    <td align="right"><? echo number_format($total_amount/$price_dzn*100,2);?>%</td>
                </tr>
                    <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="left" colspan="5">Total Fabric Cost</td>
                    <td align="right"><? echo number_format(($grand_total_amount+$total_amount),2); ?></td>
                    <td align="right"><? echo number_format((($grand_total_amount+$total_amount)/$price_dzn*100),2); ?>%</td>
                </tr>
			</table>
			</div>
			<?
		}
		else
		{
			echo "";
		}
	}
	unset($sql_conv_res);
	//End Conversion Cost to Fabric report here -------------------------------------------
	//start	Trims Cost part report here -------------------------------------------
	$trim_group=return_library_array( "select item_name,id from  lib_item_group", "id", "item_name");
   	$sql_trim = "select id, job_no, trim_group, description, brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp, status_active from wo_pre_cost_trim_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0 ";
	$sql_trim_res=sql_select($sql_trim);
	if($zero_value==1)
	{
		?>
		<div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td>% to Ord. Value</td>
                </tr>
                <?
                $total_amount=0;
                foreach( $sql_trim_res as $row )
                {
					?>
					<tr>
                        <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                        <td align="left"><? echo $row[csf("description")]; ?></td>
                        <td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                        <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                        <td align="right"><? echo number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                        <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                        <td align="right"><? echo number_format($row[csf("amount")],2); ?></td>
                        <td align="right"><? echo number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
					</tr>
					<?
					$total_amount += $row[csf("amount")];
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="6">Total</td>
                    <td align="right"><? echo number_format($total_amount,2); ?></td>
                    <td align="right"><? echo number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
		</div>
		<?
	}
	else
	{
		if($trims_cost>0)
		{
			?>
			<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="100">UOM</td>
                    <td width="100">Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
                <?
                $total_amount=0;
                foreach( $sql_trim_res as $row )
                {
					?>
					<tr>
                        <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                        <td align="left"><? echo $row[csf("description")]; ?></td>
                        <td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                        <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                        <td align="right"><? echo number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                        <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                        <td align="right"><? echo number_format($row[csf("amount")],2); ?></td>
                        <td align="right"><? echo number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
                    </tr>
                    <?
                    $total_amount += $row[csf("amount")];
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="6">Total</td>
                    <td align="right"><? echo number_format($total_amount,2); ?></td>
                    <td align="right"><? echo number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
            </table>
			</div>
			<?
		}
		else
		{
			echo "";
		}
	}
	unset($sql_trim_res);
	//End Trims Cost Part report here -------------------------------------------
	//start	Embellishment Details part report here -------------------------------------------
    $sql_emb = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount, status_active from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0 and emb_name !=3";
	$sql_emb_res=sql_select($sql_emb);
	if($zero_value==1)
	{
		?>
		<div style="margin-top:15px">
		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
		<label><b>Embellishment Details</b></label>
            <tr style="font-weight:bold">
                <td width="150">Particulars</td>
                <td width="150">Type</td>
                <td width="150">Cons/Dzn</td>
                <td width="100">Rate (USD)</td>
                <td width="100">Amount (USD)</td>
                <td>% to Ord. Value</td>
            </tr>
            <?
            $total_amount=0;
            foreach( $sql_emb_res as $row )
            {
				$em_type ='';
				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
				if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
				?>
				<tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")],2); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
				</tr>
				<?
				$total_amount += $row[csf("amount")];
            }
            ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="4">Total</td>
                <td align="right"><? echo number_format($total_amount,2); ?></td>
                <td align="right"><? echo number_format($total_amount/$price_dzn*100,2); ?>%</td>
            </tr>
		</table>
		</div>
		<?
	}
	else
	{
		if($embel_cost>0)
		{
			?>
			<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
			<label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Cons/Dzn</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td>% to Ord. Value</td>
                </tr>
                <?
                $total_amount=0;
                foreach( $sql_emb_res as $row )
                {
					$em_type ="";
					//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
					if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
					else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
					else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
					else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
					else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
					?>
					<tr>
                        <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                        <td align="left"><? echo $em_type; ?></td>
                        <td align="right"><? echo number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                        <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                        <td align="right"><? echo number_format($row[csf("amount")],2); ?></td>
                        <td align="right"><? echo number_format($row[csf("amount")]/$price_dzn*100,2); ?>%</td>
					</tr>
					<?
					$total_amount += $row[csf("amount")];
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo number_format($total_amount,2); ?></td>
                    <td align="right"><? echo number_format($total_amount/$price_dzn*100,2); ?>%</td>
                </tr>
			</table>
			</div>
			<?
		}
		else
		{
			echo "";
		}
	}
	unset($sql_emb_res);
	//End Embellishment Details Part report here -------------------------------------------
	//start	Commercial Cost part report here -------------------------------------------
   	$sql_commarcial = "select id, job_no, item_id, rate, amount, status_active from  wo_pre_cost_comarci_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0 ";
	$sql_commarcial_res=sql_select($sql_commarcial);
	if($zero_value==1)
	{
		?>
        <div style="margin-top:15px">
        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
        <label><b>Commercial Cost</b></label>
            <tr style="font-weight:bold">
                <td width="250">Particulars</td>
                <td width="100">Rate In %</td>
                <td width="100">Amount (USD)</td>
                <td>% to Ord. Value</td>
            </tr>
            <?
            $total_amount=0;
            foreach( $sql_commarcial_res as $row )
            {
				?>
				<tr>
                    <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")],2); ?></td>
                    <td align="right"><? $ccp=($row[csf("amount")]/$grfobv_dzn)*100; echo number_format($ccp,2); ?>%</td>
				</tr>
				<?
				$total_amount += $row[csf("amount")];
				$tot_ccp+=$ccp;
            }
            ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="2">Total</td>
                <td align="right"><? echo number_format($total_amount,2); ?></td>
                <td align="right"><? echo number_format($tot_ccp,2); ?></td>
            </tr>
        </table>
        </div>
        <?
	}
	else
	{
		if($comm_cost>0)
		{
			?>
			<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
			<label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="250">Particulars</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td>% to Ord. Value</td>
                </tr>
                <?
                $total_amount=0;
                foreach( $sql_commarcial_res as $row )
                {
					?>
					<tr>
                        <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                        <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                        <td align="right"><? echo number_format($row[csf("amount")],2); ?></td>
                        <td align="right"><? $ccp=($row[csf("amount")]/$grfobv_dzn)*100; echo number_format($ccp,2);?>%</td>
					</tr>
					<?
					$total_amount += $row[csf("amount")];
					$tot_ccp+=$ccp;
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? echo number_format($total_amount,2); ?></td>
                    <td align="right"><? echo number_format($tot_ccp,2); ?></td>
                </tr>
			</table>
			</div>
			<?
		}
		else
		{
			echo "";
		}
	}
	unset($sql_commarcial_res);
	//End Commercial Cost Part report here -------------------------------------------
	//start	Commission Cost part report here -------------------------------------------
   	$sql_commission = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls where job_no='$job_no' and status_active=1 and is_deleted=0";
	$sql_commission_res=sql_select($sql_commission);
	if($zero_value==1)
	{
		?>
		<div style="margin-top:15px">
		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
		<label><b>Commission Cost</b></label>
            <tr style="font-weight:bold">
                <td width="150">Particulars</td>
                <td width="150">Commission Basis</td>
                <td width="100">Rate (USD)</td>
                <td width="100">Amount (USD)</td>
                <td>% to Ord. Value</td>
            </tr>
            <?
            $total_amount=0;
            foreach( $sql_commission_res as $row )
            {
				?>
				<tr>
                    <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                    <td align="right"><? echo number_format($row[csf("commision_rate")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("commission_amount")],2); ?></td>
                    <td align="right"><? $cca=($row[csf("commission_amount")]/$grfobv_dzn)*100; echo number_format($cca,2); ?>%</td>
				</tr>
				<?
				$total_amount += $row[csf("commission_amount")];
				$total_cca += $cca;
            }
            ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="3">Total</td>
                <td align="right"><? echo number_format($total_amount,2); ?></td>
                <td align="right"><? echo number_format($total_cca,2); ?></td>
            </tr>
		</table>
		</div>
		<?
	}
	else
	{
		if($commission>0)
		{
			?>
			<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
			<label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate (USD)</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
                <?
                $total_amount=0;
                foreach( $sql_commission_res as $row )
                {
					?>
					<tr>
                        <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                        <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                        <td align="right"><? echo number_format($row[csf("commision_rate")],4); ?></td>

                        <td align="right"><? echo number_format($row[csf("commission_amount")],2); ?></td>
                        <td align="right"><? $cca=($row[csf("commission_amount")]/$grfobv_dzn)*100; echo number_format($cca,2); ?>%</td>
					</tr>
					<?
					$total_amount += $row[csf("commission_amount")];
					$total_cca += $cca;
                }
                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3">Total</td>
                    <td align="right"><? echo number_format($total_amount,4); ?></td>
                    <td align="right"><? echo number_format($total_cca,2); ?></td>
                </tr>
			</table>
			</div>
			<?
		}
		else
		{
		   echo "";
		}
	}
	unset($sql_commission_res);
	//End Commission Cost Part report here -------------------------------------------
	//start	Other Components part report here -------------------------------------------

	if($zero_value==1)
	{
		?>
		<div style="margin-top:15px">
		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
		<label><b>Others Components</b></label>
            <tr style="font-weight:bold">
                <td width="250">Particulars</td>
                <td width="100">Amount (USD)</td>
                <td width="100">% to Ord. Value</td>
            </tr>
            <tr>
                <td align="left"s>Gmts Wash</td>
                <td align="right"><? echo number_format($wash_cost,2); ?></td>
                <td align="right"><? $ogw=($wash_cost/$grfobv_dzn)*100; echo number_format($ogw,2); ?>%</td>
            </tr>
            <tr>
                <td align="left"s>Lab Test </td>
                <td align="right"><? echo number_format($lab_test,2); ?></td>
                <td align="right"><? $olt=($lab_test/$grfobv_dzn)*100; echo number_format($olt,2); ?>%</td>
            </tr>
            <tr>
                <td align="left">Inspection Cost</td>
                <td align="right"><? echo number_format($inspection,2); ?></td>
                <td align="right"><? $oic=($inspection/$grfobv_dzn)*100; echo number_format($oic,2); ?>%</td>
            </tr>
            <tr>
                <td align="left">Factory Overhead (FOH)/Dzn</td>
                <td align="right"><? echo number_format($cm_cost,2); ?></td>
                <td align="right"><? $ofoh=($cm_cost/$grfobv_dzn)*100; echo number_format($ofoh,2); ?>%</td>
            </tr>
            <tr>
                <td align="left">Gmts Freight Cost</td>
                <td align="right"><? echo number_format($freight,2); ?></td>
                <td align="right"><? $ogfc=($freight/$grfobv_dzn)*100; echo number_format($ogfc,2); ?>%</td>
            </tr>
            <tr>
                <td align="left">Currier Cost</td>
                <td align="right"><? echo number_format($currier_pre_cost,2); ?></td>
                <td align="right"><? $ocrc=($currier_pre_cost/$grfobv_dzn)*100; echo number_format($ocrc,2); ?>%</td>
            </tr>
            <tr>
                <td align="left">Certificate Cost</td>
                <td align="right"><? echo number_format($certificate_pre_cost,2); ?></td>
                <td align="right"><? $ocfc=($certificate_pre_cost/$grfobv_dzn)*100; echo number_format($ocfc,2); ?>%</td>
            </tr>
            <tr>
                <td align="left">Deffd.Lc.Cost Charge (<? echo number_format($deffdlc_percent,2); ?>%)</td>
                <td align="right"><? echo number_format($deffdlc_cost,2); ?></td>
                <td align="right"><? echo number_format($deffdlc_percent,2); ?>%</td>
            </tr>
            <tr>
                <td align="left">Finance Charge (<? echo number_format($interest_percent,2); ?>%)</td>
                <td align="right"><? echo number_format($interest_cost,2); ?></td>
                <td align="right"><? echo number_format($interest_percent,2); ?>%</td>

            </tr>
            <tr>
                <td align="left">Tax(<? echo number_format($incometax_percent,2); ?>%)</td>
                <td align="right"><? echo number_format($incometax_cost,2); ?></td>
                <td align="right"><? echo number_format($incometax_percent,2); ?>%</td>
            </tr>
				<?
                	$total_amount += $wash_cost+$lab_test+$inspection+($cm_cost)+$freight+$currier_pre_cost+$certificate_pre_cost+$deffdlc_cost+$interest_cost+$incometax_cost;
                	$total_parcent += $ogw+$olt+$oic+$ofoh+$ogfc+$ocrc+$ocfc+$deffdlc_percent+$interest_percent+$incometax_percent;
                ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td>Total</td>
                <td align="right"><? echo number_format($total_amount,2); ?></td>
                <td align="right"><? echo number_format($total_parcent,2);?>%</td>
            </tr>
		</table>
		</div>
		<?
	}
	else
	{
		if($lab_test>0 || $inspection>0 || $cm_cost>0 || $freight>0 || $common_oh>0)
		{
			?>
			<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
			<label><b>Others Components</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">% to Ord. Value</td>
                </tr>
                <?
                if($wash_cost>0)
                {
					?>
					<tr>
                        <td align="left"s>Gmts Wash</td>
                        <td align="right"><? echo number_format($wash_cost,2); ?></td>
                        <td align="right"><? $ogw=($wash_cost/$grfobv_dzn)*100; echo number_format($ogw,2); ?>%</td>
					</tr>
					<?
                }
                if($lab_test>0)
                {
                ?>
                <tr>
                    <td align="left"s>Lab Test </td>
                    <td align="right"><? echo number_format($lab_test,2); ?></td>
                    <td align="right"><? $olt=($lab_test/$grfobv_dzn)*100; echo number_format($olt,2); ?>%</td>
                </tr>
                <?
                }
                if($inspection>0)
                {
					?>
					<tr>
                        <td align="left">Inspection Cost</td>
                        <td align="right"><? echo number_format($inspection,2); ?></td>
                        <td align="right"><? $oic=($inspection/$grfobv_dzn)*100; echo number_format($oic,2); ?>%</td>
					</tr>
					<?
                }
                if($cm_cost>0)
                {
					?>
					<tr>
                        <td align="left">Factory Overhead (FOH)/Dzn</td>
                        <td align="right"><? echo number_format($cm_cost,2); ?></td>
                        <td align="right"><? $ofoh=($cm_cost/$grfobv_dzn)*100; echo number_format($ofoh,2); ?>%</td>
					</tr>
					<?
                }
                if($freight>0)
                {
					?>
					<tr>
                        <td align="left">Gmts Freight Cost</td>
                        <td align="right"><? echo number_format($freight,2); ?></td>
                        <td align="right"><? $ogfc=($freight/$grfobv_dzn)*100; echo number_format($ogfc,2); ?>%</td>
					</tr>
					<?
                }
                if($currier_pre_cost>0)
                {
					?>
					<tr>
                        <td align="left">Currier Cost</td>
                        <td align="right"><? echo number_format($currier_pre_cost,2); ?></td>
                        <td align="right"><? $ocrc=($currier_pre_cost/$grfobv_dzn)*100; echo number_format($ocrc,2); ?>%</td>
					</tr>
					<?
                }
                if($certificate_pre_cost>0)

                {
					?>
					<tr>
                        <td align="left">Certificate Cost</td>
                        <td align="right"><? echo number_format($certificate_pre_cost,2); ?></td>
                        <td align="right"><? $ocfc=($certificate_pre_cost/$grfobv_dzn)*100; echo number_format($ocfc,2); ?>%</td>
					</tr>
					<?
                }
                if($common_oh>0)
                {
					?>
					<!-- <tr>
                        <td align="left">Office OH</td>
                        <td align="right"><? //echo number_format($common_oh,4); ?></td>
                        <td align="right"><? //$ooh=($common_oh/$grfobv_dzn)*100; echo number_format($ooh,4); ?>%</td>
					</tr>-->
					<?
                }
                if($deffdlc_cost>0)
                {
					?>
					<tr>
                        <td align="left">Deffd.Lc.Cost Charge (<? echo number_format($deffdlc_percent,2); ?>%)</td>
                        <td align="right"><? echo number_format($deffdlc_cost,2); ?></td>
                        <td align="right"><? echo number_format($deffdlc_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($interest_cost>0)
                {
					?>
					<tr>
                        <td align="left">Finance Charge (<? echo number_format($interest_percent,2); ?>%)</td>
                        <td align="right"><? echo number_format($interest_cost,2); ?></td>
                        <td align="right"><? echo number_format($interest_percent,2); ?>%</td>
					</tr>
					<?
                }
                if($incometax_cost>0)
                {
					?>
					<tr>
                        <td align="left">Tax(<? echo number_format($incometax_percent,2); ?>%)</td>
                        <td align="right"><? echo number_format($incometax_cost,2); ?></td>
                        <td align="right"><? echo number_format($incometax_percent,2); ?>%</td>
					</tr>
					<?
                }
                $total_amount += $wash_cost+$lab_test+$inspection+$cm_cost+$freight+$currier_pre_cost+$certificate_pre_cost+$deffdlc_cost+$interest_cost+$incometax_cost;
                $total_parcent += $ogw+$olt+$oic+$ofoh+$ogfc+$ocrc+$ocfc+$deffdlc_percent+$interest_percent+$incometax_percent;

                ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo number_format($total_amount,2); ?></td>
                    <td align="right"><? echo number_format($total_parcent,2);?>%</td>
                </tr>
			</table>
			</div>
			<?
		}
		else
		{
			echo "";
		}
	}
	//End Other Components  Part report here -------------------------------------------
	//start	CM on Net Order Value part report here -------------------------------------------
	$order_net_value = 0;
	?>
    <div style="margin-top:15px">
    <div style="float:left">
        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
        <label><b>CM on Net Order Value</b></label>
            <tr style="font-weight:bold">
                <td width="150">Particulars</td>
                <td width="100">Amount (USD)</td>
                <td width="100">%</td>
            </tr>
            <tr>
                <td align="left">Order Value </td>
                <td align="right"><? echo number_format($order_value,2); ?></td>
                <td align="right">&nbsp;</td>
            </tr>
            <tr>
                <td align="left">Less Commission </td>
                <td align="right"><? $less_commission = $commission/$order_price_per_dzn*$job_qty; echo number_format($less_commission,2); ?></td>
                <td align="right">&nbsp;</td>
            </tr>
            <tr>
                <td align="left">Less Commercial Cost </td>
                <td align="right"><? $less_commercial = $comm_cost/$order_price_per_dzn*$job_qty; echo number_format($less_commercial,2); ?></td>
                <td align="right">&nbsp;</td>
            </tr>
            <tr>
                <td align="left">Less Freight</td>
                <td align="right"><? $less_freight = $freight/$order_price_per_dzn*$job_qty; echo number_format($less_freight,2); ?></td>
                <td align="right">&nbsp;</td>
            </tr>
            <tr>
                <td align="left">Net Order Value</td>
                <td align="right"><? $order_net_value=$order_value-($less_commission+$less_commercial+$less_freight);echo number_format($order_net_value,2); ?></td>
                <td align="right"><? echo number_format($order_net_value/$order_net_value*100,2); ?></td>
            </tr>
            <tr>
                <td align="left">Other Cost</td>
                <td align="right"><? $otherCost=$others_cost_value/$order_price_per_dzn*$job_qty; echo number_format($otherCost,2); ?></td>
                <td align="right"><? echo number_format($otherCost/$order_net_value*100,2); ?></td>
            </tr>
            <tr>
                <td align="left">CM(Contribution Margin)</td>
                <td align="right"><? $cmValue = $order_net_value-$otherCost; echo number_format($cmValue,2); ?></td>
                <td align="right"><? echo number_format($cmValue/$order_net_value*100,2); ?></td>
            </tr>
            <tr>
                <td align="left">CM /<? echo $costing_for; ?></td>
                <td align="right"><? $cmPerDzn=$cmValue/$job_qty*$order_price_per_dzn; echo number_format($cmPerDzn,4); ?></td>
                <td align="center"></td>
            </tr>
            <tr>
                <td align="left">FOH/<? echo $costing_for; ?></td>
                <td align="right"><? echo number_format($cm_cost,2); ?></td>
                <td align="center">&nbsp;</td>
            </tr>
            <tr>
                <td align="left">Margin /<? echo $costing_for; ?></td>
                <td align="right"><? echo number_format($cmPerDzn-$cm_cost,2); ?></td>
                <td align="center">&nbsp;</td>
            </tr>
        </table>
  </div>
  <div style="margin-left:5px;float:left;">
        <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
        <label><b>Cost Summary for order quantity</b></label>
            <tr style="font-weight:bold">
                <td width="150">Particulars</td>
                <td width="100">Amount (USD)</td>
                <td width="100">%</td>
            </tr>
            <tr>
                <td align="left">Total Order Value </td>
                <td align="right"><? $total_order_val = $job_qty*$avg_unit_price; echo number_format($total_order_val,2); ?></td>
                <td align="right"><? echo number_format($total_order_val/$total_order_val*100,2); ?></td>
            </tr>
             <tr>
                <td align="left">Total Cost </td>
                <td align="right"><?  $total_cost = $total_cost/$order_price_per_dzn*$job_qty; echo number_format($total_cost,2); ?></td>
                <td align="right"><? echo number_format($total_cost/$total_order_val*100,2); ?></td>
            </tr>
             <tr>
                <td align="left">Margin </td>
                <td align="right"><? $margin_val = $total_order_val-$total_cost; echo number_format($margin_val,2); ?></td>
                <td align="right"><? echo number_format($margin_val/$total_order_val*100,2); ?></td>
            </tr>
             <tr>
                <td align="left">Margin /<? echo $costing_for; ?> </td>
                <td align="right"><? echo number_format($margin_val/$job_qty*$order_price_per_dzn,2); ?></td>
                <td align="right">&nbsp;</td>
            </tr>
       </table>
    </div>
        <div style="clear:both"></div>
    </div>
    <?
    echo "<br /><b>Note: Other Cost = Fabric Cost + Trims Cost + Embellishment Cost + Gmts Wash + Lab Test + Inspection + Currier Cost + <br />Certificate Cost + Finance Charge+ Deffd.Lc.Cost+Tax</b>";

    $user_sql = "select a.id, a.user_full_name, b.custom_designation from user_passwd a, lib_designation b where a.valid=1 and b.id=a.designation";

    $user_data_array=sql_select($user_sql);
    foreach($user_data_array as $row){
        $user_arr[$row[csf(id)]]=$row[csf(user_full_name)].'<br><span style="font-size:10px;">('.$row[csf(custom_designation)].')</span>';
    }
    unset($user_data_array);

	$sql="select bypass, buyer_id, sequence_no, user_id FROM electronic_approval_setup where company_id='$company_name' and FIND_IN_SET(buyer_id, $buyer_id)>0 and page_id=869 and is_deleted=0 order by sequence_no asc";
	$data_array=sql_select($sql);
	foreach($data_array as $row){
		$electronic_data[$row[csf(sequence_no)]] = $row[csf(user_id)];
		$user_wise_sequence[$row[csf(user_id)]] = $row[csf(sequence_no)];
	}
	unset($data_array);
	$startSequence = min($user_wise_sequence);
	$endSequence = max($user_wise_sequence);

	$sql="select min(b.current_approval_status) as cstatus, b.approved_by, b.mst_id FROM co_com_pre_costing_approval b where b.job_no='$job_no' and b.approved_by not in (".$electronic_data[$endSequence].") group by b.mst_id,b.approved_by";

	$data_array=sql_select($sql);
	foreach($data_array as $row){
		if($row[csf(cstatus)]!=0){$check_app_data[$row[csf(approved_by)]] = $row[csf(approved_by)];}
		$mst_id = $row[csf(mst_id)];//for Higher Auth Check;
		$higher_auth_id = $row[csf(approved_by)];//for Higher Auth Check;
	}
	unset($data_array);


	$sql="select min(b.current_approval_status) as cstatus, b.approved_by FROM co_com_pre_costing_approval b where b.job_no='$job_no' and b.approved_by in (".$electronic_data[$endSequence].") group by b.approved_by";

	$data_array=sql_select($sql);
	foreach($data_array as $row){
		if($row[csf(cstatus)]!=0){$last_app_data = $row[csf(approved_by)];}
	}
	unset($data_array);

//---------------------------------------------Higher Auth Check;
	$app_history_data=return_library_array( "select sequence_no, approved_by from approval_history where mst_id=$mst_id and entry_form=15",'sequence_no','approved_by');

	if(count($check_app_data)==1 && (!in_array($higher_auth_id,$app_history_data))){
		$last_app_data=$app_history_data[$endSequence];
		$check_app_data=array();
		foreach($app_history_data as $sec=>$user){
			if($sec!=$endSequence){$check_app_data[$user] =$user;}
		}
		$align='center';
	}
	else
	{
		$higher_auth_id	=0;
		$align='right';
	}
	//--------------------------------------------------------
	?>
    <br /><br />
	<table class="rpt_table" border="0" cellpadding="1" cellspacing="1" style="text-align:center;" rules="all" width="850">
		<tr>
        	<td style="border:none; line-height:13px;" align="left"><? echo $user_arr[$prepared_app_data]; ?></td>
            <?
			foreach($check_app_data as $check_user){
				echo '<td style="border:none; line-height:13px;" align="center">'.$user_arr[$check_user].'</td>';
			}
			?>
            <td style="border:none; line-height:13px;" align="<? echo $align;?>"><? echo $user_arr[$last_app_data]; ?></td>
       		<?
			if($higher_auth_id!=0){
				echo '<td style="border:none; line-height:13px;" align="right">'.$user_arr[$higher_auth_id].'</td>';
			}
			?>

        </tr>
		<tr style="alignment-baseline:baseline;">
        	<td width="" style="text-decoration:overline; border:none" align="left">Prepared By</td>
            <?
			foreach($check_app_data as $check_user){
				echo '<td width="" style="text-decoration:overline; border:none" align="center">Checked By</td>';
			}
			?>
            <td width="" style="text-decoration:overline; border:none" align="<? echo $align;?>">Approved By</td>
       		<?
			if($higher_auth_id!=0){
				echo '<td width="" style="text-decoration:overline; border:none" align="right">Unapproved/Approved</td>';
			}
			?>
        </tr>
    </table>
 	<?
	//$part[9]=ob_get_contents();ob_end_clean();
	//$html='';
	//foreach(explode(',',str_replace("'","",$print_option_id)) as $part_id)
	//{
		//$html.=$part[$part_id];
	//}

	//if($html!=''){echo $part[0].$html.$part[9];}else{echo $part[0].$part[1].$part[2].$part[3].$part[4].$part[5].$part[6].$part[7].$part[8].$part[9];};
	exit();
}

if($action=="bomRpt2")
{
	///extract($_REQUEST);
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and c.costing_date='".$txt_costing_date."'";
	if(str_replace("'",'',$txt_po_breack_down_id)=="")
	{
		$txt_po_breack_down_id_cond='';
		$txt_po_breack_down_id_cond1='';
		$txt_po_breack_down_id_cond2='';
		$txt_po_breack_down_id_cond3='';
	}
	else
	{
		$txt_po_breack_down_id_cond=" and b.id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond1=" and id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond2=" and po_break_down_id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond3=" and b.id in(".$txt_po_breack_down_id.")";
	}

	//array for display name
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');

	$gmtsitem_ratio_array=array();
	$grmnt_items = "";
    $grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no=$txt_job_no");
	foreach($grmts_sql as $key=>$val)
	{
		$grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].",";
		$gmtsitem_ratio_array[$val[csf('job_no')]][$val[csf('gmts_item_id')]]=$val[csf('set_item_ratio')];
	}
	$grmnt_items = rtrim($grmnt_items,",");

	if($db_type==0) ///fab_knit_fin_req_kg,fab_knit_req_kg
	{
	   $sql = "select a.job_no,a.company_name, a.buyer_name,a.style_ref_no, a.gmts_item_id,a.order_uom, a.avg_unit_price,sum(b.plan_cut) as job_quantity,sum(b.po_quantity) as ord_qty, c.costing_per,c.budget_minute,c.approved, d.fab_knit_req_kg,d.fab_knit_fin_req_kg, d.fab_woven_req_yds,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg
			from wo_po_details_master a,wo_po_break_down b, wo_pre_cost_mst c left join wo_pre_cost_sum_dtls d on   c.job_no=d.job_no and d.status_active=1 and d.is_deleted=0
			where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no  and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref $txt_costing_date group by a.job_no,a.company_name, a.buyer_name,a.style_ref_no, a.gmts_item_id,a.order_uom, a.avg_unit_price, c.costing_per,c.approved,c.budget_minute, d.fab_knit_req_kg, d.fab_woven_req_yds,d.fab_knit_fin_req_kg,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg order by a.job_no";
	}
	if($db_type==2)
	{
	    $sql = "select a.job_no,a.company_name, a.buyer_name,a.style_ref_no, a.gmts_item_id,a.order_uom, a.avg_unit_price,sum(b.plan_cut) as job_quantity,sum(b.po_quantity) as ord_qty, c.costing_per,c.budget_minute,c.approved,   d.fab_knit_fin_req_kg, d.fab_knit_req_kg, d.fab_woven_req_yds,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg
			from wo_po_details_master a,wo_po_break_down b, wo_pre_cost_mst c left join  wo_pre_cost_sum_dtls d on  c.job_no=d.job_no and d.status_active=1 and d.is_deleted=0
			where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no  and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref group by a.job_no,a.company_name, a.buyer_name,a.style_ref_no, a.gmts_item_id,a.order_uom, a.avg_unit_price, c.costing_per,c.approved,c.budget_minute, d.fab_knit_req_kg, d.fab_woven_req_yds,d.fab_knit_fin_req_kg,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg  order by a.job_no"; //a.job_quantity as job_quantity,
	}
	//echo $sql;die;
	$data_array=sql_select($sql);
	$plan_cut_qty=$data_array[0][csf('job_quantity')];
	$po_quantity=$data_array[0][csf('ord_qty')];
	//echo $plan_cut_qty;
	//echo $order_value=$plan_cut_qty*$data_array[0][csf('avg_unit_price')];
	$variArr=array();
	$sqlvari=sql_select("select embellishment_id,embellishment_budget_id from variable_order_tracking where company_name=$cbo_company_name and variable_list=56 and status_active=1 and is_deleted=0");
	//$embel_type_id=0;$embel_type_id=0;
	foreach($sqlvari as $vari_row)
	{
		//$is_manula_approved=$sql_row[csf('pre_cost_approval')];
		$embel_type_id=$vari_row[csf('embellishment_id')];
		$embelt_budget_qty_id_arr[$embel_type_id]=$vari_row[csf('embellishment_budget_id')];
	}
	
	?>
    <div style="width:852px; margin:0 auto">
    <div style="width:850px; font-size:20px; font-weight:bold" align="center"><? echo $comp[str_replace("'","",$cbo_company_name)]; ?></div>
    <div style="width:850px; font-size:14px; font-weight:bold" align="center">BOM Report 2</div>
	<?
	foreach ($data_array as $row)
	{
		$order_price_per_dzn=0;
		$order_job_qnty=0;
		$ord_qty=0;
		$avg_unit_price=0;
		$order_values = $row[csf("ord_qty")]*$row[csf("avg_unit_price")];
		$result =sql_select("select po_number,pub_shipment_date,file_no,excess_cut,grouping from wo_po_break_down where job_no_mst=$txt_job_no $txt_po_breack_down_id_cond1 and status_active=1 and is_deleted=0 order by pub_shipment_date DESC");
		//$tot_row=count($result);
		$job_in_orders = '';$pulich_ship_date='';$job_in_ref = '';$job_in_file = '';
		$tot_excess_cut=0;$tot_row=0;
		foreach ($result as $val)
		{
			$job_in_orders .= $val[csf('po_number')].", ";
			$pulich_ship_date = $val[csf('pub_shipment_date')];
			if($val[csf('excess_cut')]>0)
			{
				$tot_row++;
			}
			$tot_excess_cut+= $val[csf('excess_cut')];
			//$job_in_ref .= $val[csf('grouping')].", ";
			//$job_in_file .= $val[csf('file_no')].", ";
			if($job_in_ref=='') $job_in_ref= $val[csf('grouping')]; else $job_in_ref.=",". $val[csf('grouping')];
			if($job_in_file=='') $job_in_file= $val[csf('file_no')]; else $job_in_file.=",". $val[csf('file_no')];
		}
		$avg_excess_cut=$tot_excess_cut/$tot_row;

		$job_in_orders = substr(trim($job_in_orders),0,-1);
		$job_ref=array_unique(explode(",",$job_in_ref));
		$job_file=array_unique(explode(",",rtrim($job_in_file,",")));
		//print_r($job_ref);
		$ref_cond='';
		foreach ($job_ref as $ref)
		{
			//$ref_cond.=", ".$ref;
			if($ref_cond=='') $ref_cond=$ref; else $ref_cond.=", ".$ref;
		}
		$file_con='';
		foreach ($job_file as $file)
		{
			if($file_con=='') $file_cond=$file; else $file_cond.=", ".$file;
		}


		?>
            	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px" rules="all">
                	<tr>
                    	<td width="80">Job Number</td>
                        <td width="80"><b><? echo $row[csf("job_no")]; ?></b></td>
                        <td width="90">Buyer</td>
                        <td width="100"><b><? echo $buyer_arr[$row[csf("buyer_name")]]; ?></b></td>
                        <td width="80">Plan Cut Qnty</td>
                        <td width="100"><b><? echo $row[csf("job_quantity")]." ".$unit_of_measurement[$row[csf("order_uom")]]; $uom=$row[csf("order_uom")]; ?></b></td>
                    </tr>
                    <tr>
                        <td>Order Qty</td>
                        <td><b><? $tot_order_value=$row[csf("ord_qty")]*$row[csf("avg_unit_price")];$order_qty=$row[csf("ord_qty")];
						echo $row[csf("ord_qty")]." ".$unit_of_measurement[$row[csf("order_uom")]]; ?></b></td>
                    	<td>Style Ref. No</td>
                        <td><b><? echo $row[csf("style_ref_no")]; ?></b></td>

                        <td>Price Per Unit</td>
                        <td><b><? echo $row[csf("avg_unit_price")]; ?></b></td>
                    </tr>
                    <tr>
                    	<td>Order Numbers</td>
                        <td colspan="5"><? echo $job_in_orders; ?></td>
                    </tr>
                    <tr>
                    	<td>Garments Item</td>
                        <td colspan="3"><b><? echo $grmnt_items; ?></b></td>
                        <td>Shipment Date</td>
                        <td><b><? echo change_date_format($pulich_ship_date); ?></b></td>
                    </tr>
                     <tr>
                    	<td>Avg Cons. Grey</td>
                        <td align=""><b><? echo number_format($row[csf("fab_knit_req_kg")]+$row[csf("fab_woven_req_yds")],2); ?></b></td>
                        <td>Avg Cons. Fin.</td>
                        <td align=""><b><? echo number_format($row[csf("fab_knit_fin_req_kg")]+$row[csf("fab_woven_fin_req_yds")],2); ?></b></td>
                        <td>Plan Cut%</td>
                        <td><b><? echo number_format($avg_excess_cut,2); ?></b></td>
                    </tr>
                    <tr>
                    <td>Budget Minuite</td>
                        <td><b><? echo $row[csf("budget_minute")] ?> </b></td>
                        <td align="center" height="10" colspan="6" valign="top" id="app_sms" style="font-size:18px;"><font color="#FF0000"><? if( $row[csf("approved")]==1 || $row[csf("approved")]==3){echo "This Job is Approved ";} else {echo "";} ?> </font> </td>
                    </tr>
                     <tr>
                    	<td>Internal Ref</td>
                        <td colspan="2"><b><? echo ltrim($ref_cond,", "); ?></b></td>
                        <td>File No</td>
                        <td colspan="2"><b><? echo $file_cond; ?></b></td>
                    </tr>
                </table>

            <?
			if($row[csf("costing_per")]==1){$order_price_per_dzn=12;$costing_for=" DZN";}
			else if($row[csf("costing_per")]==2){$order_price_per_dzn=1;$costing_for=" PCS";}
			else if($row[csf("costing_per")]==3){$order_price_per_dzn=24;$costing_for=" 2 DZN";}
			else if($row[csf("costing_per")]==4){$order_price_per_dzn=36;$costing_for=" 3 DZN";}
			else if($row[csf("costing_per")]==5){$order_price_per_dzn=48;$costing_for=" 4 DZN";}
			$order_job_qnty=$row[csf("job_quantity")];
			$avg_unit_price=$row[csf("avg_unit_price")];
			$ord_qty=$row[csf("ord_qty")];
	}//end first foearch

	//All Cost start here...
	//start	all summary report here -------------------------------------------
	//job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref
	 $sql = "select fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,wash_cost,wash_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,currier_pre_cost,currier_percent,certificate_pre_cost,certificate_percent,common_oh,common_oh_percent,total_cost,deffdlc_cost,deffdlc_percent,interest_cost,interest_percent,incometax_cost,incometax_percent,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,depr_amor_pre_cost,depr_amor_po_price,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
			from wo_pre_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	$others_cost_value=0;
	$fabric_cost=0;
	$trims_cost=0;
	$embel_cost=0;
	$comm_cost=0;
	$commission=0;
	$lab_test=0;
	$inspection=0;
	$cm_cost=0;
	$freight=0;
	$currier_pre_cost=0;
	$certificate_pre_cost=0;
	$common_oh=0;
 	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80">SL</td>
                    <td width="300">Particulars</td>
                    <td width="100">Cost</td>
                    <td width="100">Amount (USD)</td>
                    <td width="180">% to Ord. Value</td>
                </tr>
            <?
			$po_no=str_replace("'","",$txt_po_breack_down_id);
			$condition= new condition();
			if(str_replace("'","",$txt_job_no) !=''){
				  $condition->job_no("=$txt_job_no");
			 }

			  if(str_replace("'","",$txt_po_breack_down_id)!='')
			 {
				$condition->po_id("in($po_no)");
			 }
			  $condition->init();
			//$yarn= new yarn($condition);


           $fabric= new fabric($condition);
		   //echo $fabric->getQuery(); die;
		  //$fabric_costing_arr=$fabric->getQtyArray_by_job_knitAndwoven_greyAndfinish_production();
		   $yarn= new yarn($condition);
		// echo $yarn->getQuery(); die;
			$yarn_costing_arr=$yarn->getJobWiseYarnAmountArray();
			//print_r($yarn_costing_arr);
			$fabric= new fabric($condition);
			$fabric_costing_arr2=$fabric->getAmountArray_by_job_knitAndwoven_greyAndfinish();

			$conversion= new conversion($condition);
			$conversion_costing_arr_process=$conversion->getAmountArray_by_job();
			$trims= new trims($condition);
			//echo $trims->getQuery(); die;
			$trims_costing_arr=$trims->getAmountArray_by_job();
			$emblishment= new emblishment($condition);
			$emblishment_costing_arr=$emblishment->getAmountArray_by_job();
			$wash= new wash($condition);
			//echo $wash->getQuery(); die;
			$emblishment_costing_arr_wash=$wash->getAmountArray_by_job();
		    $commercial= new commercial($condition);
			$commercial_costing_arr=$commercial->getAmountArray_by_job();
			$commission= new commision($condition);
			$commission_costing_arr=$commission->getAmountArray_by_job();
			$other= new other($condition);
			$other_costing_arr=$other->getAmountArray_by_job();

			$job_no=str_replace("'","",$txt_job_no);

			$price_dzn=0;
            $sl=0;
            foreach( $data_array as $row )
            {
			//$fab_production_knit=$fabric_costing_arr['knit']['grey'][$job_no];
			//$fab_production_finish=$fabric_costing_arr['finish']['grey'][$job_no];

			$fab_purchase_knit2=array_sum($fabric_costing_arr2['knit']['grey'][$job_no]);
			$fab_purchase_woven2=array_sum($fabric_costing_arr2['woven']['grey'][$job_no]);

			$yarn_costing=$yarn_costing_arr[$job_no];
			$tot_fabric_cost=$fab_purchase_knit2+$fab_purchase_woven2;
			$conversion_cost=array_sum($conversion_costing_arr_process[$job_no]);
			//$testing_cost=$other_costing_arr[$job_no]['lab_test'];
			$freight_cost=$other_costing_arr[$job_no]['freight'];
			$inspection_cost=$other_costing_arr[$job_no]['inspection'];
			$certificate_cost=$other_costing_arr[$job_no]['certificate_pre_cost'];
			$common_oh=$other_costing_arr[$job_no]['common_oh'];
			$currier_cost=$other_costing_arr[$job_no]['currier_pre_cost'];
			$cm_cost=$other_costing_arr[$job_no]['cm_cost'];
			$lab_test_cost=$other_costing_arr[$job_no]['lab_test'];
			$depr_amor_pre_cost=$other_costing_arr[$job_no]['depr_amor_pre_cost'];
			$deffdlc_cost=$other_costing_arr[$job_no]['deffdlc_cost'];
			$fabric_cost=$tot_fabric_cost;
			$trims_cost=$trims_costing_arr[$job_no];
			$embel_cost=$emblishment_costing_arr[$job_no];
			$wash=$emblishment_costing_arr_wash[$job_no];
			$commercial_cost=$commercial_costing_arr[$job_no];
			$comm_cost=$row[csf("comm_cost")];
			$cm_cost_dzn=$row[csf("cm_cost")];
			$deffdlc_cost_dzn=$row[csf("deffdlc_cost")];
			$interest_cost=$row[csf("interest_cost")];
			$incometax_cost=$row[csf("incometax_cost")];
			//deffdlc_cost,deffdlc_percent,interest_cost,interest_percent,incometax_cost,incometax_percent
			$deffdlc_percent=$row[csf("deffdlc_percent")];
			$interest_percent=$row[csf("interest_percent")];
			$incometax_percent=$row[csf("incometax_percent")];
			$depr_amor_po_price=$row[csf("depr_amor_po_price")];
			$depr_amor_pre_cost_dzn=$row[csf("depr_amor_pre_cost")];
			//interest_cost,interest_percent,incometax_cost
			$commission=$commission_costing_arr[$job_no];
			$lab_test=$lab_test_cost;
			$inspection=$inspection_cost;
			$cm_cost=$cm_cost;
			$freight=$freight_cost;
			$currier_pre_cost=$currier_cost;
			$certificate_pre_cost=$certificate_cost;
			$common_oh=$common_oh;

			$all_total_cost=$tot_fabric_cost+$yarn_costing+$conversion_cost+$trims_cost+$embel_cost+$wash+$commercial_cost+$commission+$lab_test_cost+$cm_cost+$currier_pre_cost+$inspection_cost+$freight+$common_oh+$certificate_pre_cost+$depr_amor_pre_cost+$interest_cost+$incometax_cost+$deffdlc_cost;
				$sl=$sl+1;
  				$others_cost_value=$all_total_cost-$cm_cost-$freight-$commercial_cost-$commission;
				if($zero_value==1)
				{
				?>
                <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left"><b>Order Value</b></td>
                    <td></td>
                    <td align="right"><b><? echo number_format($tot_order_value,4);$price_dzn=$tot_order_value;//$avg_unit_price*$order_price_per_dzn ?></b></td>
                    <td align="center"><? echo "100.00%"; ?></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">All Fabric Cost</td>
                    <td align="right"><? $tot_fab_cot=$tot_fabric_cost+$yarn_costing+$conversion_cost;
					echo number_format($tot_fabric_cost+$yarn_costing+$conversion_cost,2); ?></td>
                    <td align="right" rowspan="17">&nbsp;</td>
                    <td align="center"><? echo number_format(($tot_fab_cot/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Trims Cost</td>
                    <td align="right"><? echo number_format($trims_cost,4); ?></td>
                    <td align="center"><? echo number_format(($trims_cost/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Embellishment Cost</td>
                    <td align="right"><? echo number_format($embel_cost,4); ?></td>
                    <td align="center"><? echo number_format(($embel_cost/$tot_order_value)*100,2);//number_format($row[csf("embel_cost_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Gmts Wash</td>
                    <td align="right"><? echo number_format($wash,4); ?></td>
                    <td align="center"><? echo number_format(($wash/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commercial Cost</td>
                    <td align="right"><? echo number_format($commercial_cost,4); ?></td>
                    <td align="center"><? echo number_format(($commercial_cost/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commission Cost</td>
                    <td align="right"><? echo number_format($commission,4); ?></td>
                    <td align="center"><? echo number_format(($commission/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Depc. & Amort.</td>
                    <td align="right"><? echo number_format($depr_amor_pre_cost,4); ?></td>
                    <td align="center"><? echo number_format(($depr_amor_pre_cost/$tot_order_value)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo number_format($lab_test_cost,4); ?></td>
                    <td align="center"><? echo number_format(($lab_test_cost/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo number_format($inspection_cost,4); ?></td>
                    <td align="center"><? echo number_format(($inspection_cost/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CM Cost</td>
                    <td align="right"><? echo number_format($cm_cost,4); ?></td>
                    <td align="center"><? echo number_format(($cm_cost/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo number_format($freight,4); ?></td>
                    <td align="center"><? echo number_format(($freight/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Currier Cost</td>
                    <td align="right"><? echo number_format($currier_pre_cost,4); ?></td>
                    <td align="center"><? echo number_format(($currier_pre_cost/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                  <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Certificate Cost</td>
                    <td align="right"><? echo number_format($certificate_pre_cost,4); ?></td>
                    <td align="center"><? echo number_format(($certificate_pre_cost/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Deffd. LC/DC Cost</td>
                    <td align="right"><? echo number_format($deffdlc_cost,4); ?></td>
                    <td align="center"><? echo number_format(($deffdlc_cost/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                  <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Interest </td>
                    <td align="right"><? echo number_format($row[csf("interest_cost")],4); ?></td>
                    <td align="center"><? echo number_format(($row[csf("interest_cost")]/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                  <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Income Tax</td>
                    <td align="right"><? echo number_format($row[csf("incometax_cost")],4); ?></td>
                    <td align="center"><? echo number_format(($row[csf("incometax_cost")]/$tot_order_value)*100,2); ?>%</td>
                 </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Office OH </td>
                    <td align="right"><? echo number_format($common_oh,4); ?></td>
                    <td align="center"><? echo number_format(($common_oh/$tot_order_value)*100,2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"><b>Total Cost (2:18)</b></td>
                    <td>&nbsp;</td>
                    <td align="right"><b><? echo number_format($all_total_cost,4); ?></b></td>
                    <td align="center"><b><? echo number_format(($all_total_cost/$tot_order_value)*100,2); ?>%</b></td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?> (1-19)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? $tot_mergin=$tot_order_value-$all_total_cost;echo number_format(($tot_mergin/$order_qty)*12,2);
					 //echo number_format($tot_mergin,4);
					$marging_dzn=($tot_mergin/$order_qty)*12;
					  ?></td>
                    <td align="center"><b><? $margin_dzn_percent=($tot_mergin/$tot_order_value)*100;
					 echo number_format($margin_dzn_percent,2); ?>%</b></td>
                </tr>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Price / <? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo number_format($row[csf("price_pcs_or_set")],4); ?></td>
                    <td align="right"></td>
                </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Cost /<? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo number_format($all_total_cost/$order_price_per_dzn,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo number_format($marging_dzn/12,2); ?></td>
                    <td align="right"></td>
                </tr>
            	<?
				}
				else
				{
					?>
                 <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left"><b>Order Price/<? echo $costing_for; ?></b></td>
                    <td></td>
                    <td align="right"><b><? echo number_format($row[csf("price_dzn")],4);//$avg_unit_price*$order_price_per_dzn ?></b></td>
                    <td align="center"><? echo "100.00%"; ?></td>
                </tr>
                <?
				if($row[csf("fabric_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">All Fabric Cost</td>
                    <td align="right"><? echo number_format($tot_fabric_cost+$yarn_costing+$conversion_cost,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("fabric_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("trims_cost")]!=0)
				{
				?>

                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Trims Cost</td>
                    <td align="right"><? echo number_format($trims_cost,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("trims_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("embel_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Embellishment Cost</td>
                    <td align="right"><? echo number_format($embel_cost,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("embel_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("wash_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Gmts Wash</td>
                    <td align="right"><? echo number_format($wash,4); ?></td>
                    <td align="center"><? echo number_format($row[csf("wash_cost_percent")],2); ?>%</td>
                </tr>

                <?
				}
				if($row[csf("comm_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commercial Cost</td>
                    <td align="right"><? echo number_format($commercial_cost,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("comm_cost_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("commission")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Commission Cost</td>
                    <td align="right"><? echo number_format($commission,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("commission_percent")],2); ?>%</td>
                </tr>
                <?
				}
				if($row[csf("lab_test")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo number_format($lab_test_cost,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("lab_test_percent")],2); ?>%</td>
                 </tr>
                <?
				}
				if($row[csf("inspection")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo number_format($inspection_cost,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("inspection_percent")],2); ?>%</td>
                 </tr>
                 <?
				}
				if($row[csf("cm_cost")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CM Cost</td>
                    <td align="right"><? echo number_format($cm_cost,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("cm_cost_percent")],2); ?>%</td>
                 </tr>
                 <?
				}
				if($row[csf("freight")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo number_format($freight,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("freight_percent")],2); ?>%</td>
                 </tr>
                <?
				}
				if($row[csf("common_oh")]!=0)
				{
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Office OH </td>
                    <td align="right"><? echo number_format($common_oh,4); ?></td>
                    <td align="right">&nbsp;</td>
                    <td align="center"><? echo number_format($row[csf("common_oh_percent")],2); ?>%</td>
                 </tr>
                 <?
				}
				?>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left"><b>Total Cost (2:<? echo $sl-1;?>)</b></td>
                    <td>&nbsp;</td>
                    <td align="right"><b><? echo number_format($all_total_cost,4); ?></b></td>
                    <td align="center"><b><? echo number_format($row[csf("total_cost_percent")],2); ?>%</b></td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $costing_for; ?> (1-<? echo $sl-1;?>)</td>
                    <td>&nbsp;</td>
                    <td align="right"><? $tot_mergin=$tot_order_value-$all_total_cost;echo number_format(($tot_mergin/$order_qty)*12,2);
					 //echo number_format($tot_mergin,4);
					$marging_dzn=($tot_mergin/$order_qty)*12;
					  ?></td>
                    <td align="center"><b><? $margin_dzn_percent=($tot_mergin/$tot_order_value)*100;
					 echo number_format($margin_dzn_percent,2); ?>%</b></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Price / <? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo number_format($row[csf("price_pcs_or_set")],4); ?></td>
                    <td align="right"></td>
                </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Cost /<? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo number_format($all_total_cost/$order_price_per_dzn,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Margin/<? echo $unit_of_measurement[$uom];?></td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo number_format($marging_dzn/12,2); ?></td>
                    <td align="right"></td>
                </tr>
                    <?
				}
            }
            ?>
            </table>
      </div>
      <?
	//End all summary report here -------------------------------------------






	//2 Fabric Cost part here-------------------------------------------
	$sql = "select id, job_no,item_number_id, body_part_id, fab_nature_id, color_type_id, fabric_description, avg_cons, fabric_source, rate, amount,avg_finish_cons,status_active from wo_pre_cost_fabric_cost_dtls
			where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);

		$knit_fab="";$woven_fab="";
		$knit_subtotal_amount=0;
		$woven_subtotal_amount=0;$knit_subtotal_amount_dzn=0;$knit_subtotal_amount_kg=0;$woven_subtotal_amount_dzn=0;$woven_subtotal_amount_kg=0;
        $i=2;$j=2;
		foreach( $data_array as $row )
        {
			    $set_item_ratio=return_field_value("set_item_ratio"," wo_po_details_mas_set_details", "job_no='".$row[csf('job_no')]."' and gmts_item_id='".$row[csf('item_number_id')]."'");

			   $fincons=0;
			   $greycons=0;
			   $order_qty_fab=0;
			   $fab_dtls_data=sql_select("select po_break_down_id,color_number_id,gmts_sizes,cons,requirment from wo_pre_cos_fab_co_avg_con_dtls where pre_cost_fabric_cost_dtls_id=".$row[csf("id")]." $txt_po_breack_down_id_cond2 and cons !=0");
			   foreach($fab_dtls_data as $fab_dtls_data_row )
			   {
				  // echo "select sum(c.plan_cut_qnty) as order_quantity  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and  b.id=".$fab_dtls_data_row[csf('po_break_down_id')]." and item_number_id='".$row[csf('item_number_id')]."' and size_number_id='".$fab_dtls_data_row[csf('gmts_sizes')]."' and  color_number_id= '".$fab_dtls_data_row[csf('color_number_id')]."' and a.status_active=1 and b.status_active=1 and c.status_active=1";
					 $sql_po_qty_fab=sql_select("select sum(c.plan_cut_qnty) as order_quantity  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and  b.id=".$fab_dtls_data_row[csf('po_break_down_id')]." and c.item_number_id='".$row[csf('item_number_id')]."' and size_number_id='".$fab_dtls_data_row[csf('gmts_sizes')]."' and  color_number_id= '".$fab_dtls_data_row[csf('color_number_id')]."' and a.status_active=1 and b.status_active=1 and c.status_active=1");

					 list($sql_po_qty_row_fab)=$sql_po_qty_fab;
	                 $po_qty_fab=$sql_po_qty_row_fab[csf('order_quantity')];
					 //$cons+=($fab_dtls_data_row[csf("cons")]/($order_price_per_dzn*$set_item_ratio))*($po_qty_fab*$set_item_ratio);
					 //echo "(".$po_qty_fab."/(".$order_price_per_dzn."*".$set_item_ratio."))*".$fab_dtls_data_row[csf("cons")]."<br/>";
					 $fincons+=($po_qty_fab/($order_price_per_dzn*$set_item_ratio))*$fab_dtls_data_row[csf("cons")];
					 $greycons+=($po_qty_fab/($order_price_per_dzn*$set_item_ratio))*$fab_dtls_data_row[csf("requirment")];
					 $order_qty_fab+=$po_qty_fab;
			   }
			//$row[csf("avg_cons")] = $greycons;
			//$row[csf("avg_finish_cons")] = $fincons;
			$knit_cost_dzn=$row[csf("amount")];$woven_cost_dzn=$row[csf("amount")];
 			$row[csf("amount")] = ($row[csf("amount")]/($order_price_per_dzn*$set_item_ratio))*($order_qty_fab*$set_item_ratio);
			//$row[csf("avg_cons")] = ($row[csf("avg_cons")]/($order_price_per_dzn*$set_item_ratio))*($order_job_qnty*$set_item_ratio);
			//$row[csf("avg_finish_cons")] = ($row[csf("avg_finish_cons")]/($order_price_per_dzn*$set_item_ratio))*($order_job_qnty*$set_item_ratio);
 			//$row[csf("amount")] = ($row[csf("amount")]/($order_price_per_dzn*$set_item_ratio))*($order_job_qnty*$set_item_ratio);

			if($row[csf("fab_nature_id")]==2)//knit fabrics
			{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];

 				$i++;
                $knit_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.number_format($greycons,4).'</td>
 					<td align="right">'.number_format($fincons,4).'</td>
                    <td align="right">'.number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.number_format($row[csf("amount")],4).'</td>
                </tr>';
				$knit_subtotal_avg_cons+=$greycons;
				$knit_subtotal_avg_finish_cons+=$fincons;
            	$knit_subtotal_amount+=$row[csf("amount")];
				$knit_subtotal_amount_dzn+=$knit_cost_dzn;
				$knit_subtotal_amount_kg=$knit_subtotal_amount/$knit_subtotal_amount_dzn;
			}
			if($row[csf("fab_nature_id")]==3)//woven fabrics
			{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				$j++;
                 $woven_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.number_format($greycons,4).'</td>
 					<td align="right">'.number_format($fincons,4).'</td>
                    <td align="right">'.number_format($row[csf("rate")],4).'</td>
                    <td align="right">'.number_format($row[csf("amount")],4).'</td>
                </tr>';
				$woven_subtotal_avg_cons+=$greycons;
				$woven_subtotal_avg_finish_cons+=$fincons;
				$woven_subtotal_amount+=$row[csf("amount")];
				$woven_subtotal_amount_dzn+=$woven_cost_dzn;

				$woven_subtotal_amount_kg=$woven_subtotal_amount/$woven_subtotal_amount_dzn;
			}
        }

		$knit_fab= '<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
						<tr style="font-weight:bold"  align="center">
							<td width="80" rowspan="'.$i.'" ><div class="verticalText"><b>Knit Fabric</b></div></td>
							<td width="300">Description</td>
							<td width="100">Source</td>
							<td width="100">Gray Fabric Qnty</td>
							<td width="100">Finish Fab Qnty</td>
 							<td width="50">Rate</td>
							<td width="50">Amount</td>
						</tr>'.$knit_fab;
		$woven_fab = '<tr><td colspan="7">&nbsp;</td></tr><tr>
						<td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;

		//knit fabrics table here
		$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2">Total</td>
						<td align="right">'.number_format($knit_subtotal_avg_cons,4).'</td>
						<td align="right">'.number_format($knit_subtotal_avg_finish_cons,4).'</td>
						<td align="right"></td>
						<td align="right">'.number_format($knit_subtotal_amount,4).'</td>
					</tr>';
  		echo $knit_fab;

		//woven fabrics table here
		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="2">Total</td>
						<td align="right">'.number_format($woven_subtotal_avg_cons,4).'</td>
						<td align="right">'.number_format($woven_subtotal_avg_finish_cons,4).'</td>
						<td align="right"></td>
						<td align="right">'.number_format($woven_subtotal_amount,4).'</td>
					</tr>
   					</table></div>';
        echo $woven_fab;

		//end 	All Fabric Cost part report-------------------------------------------


		//Start	Yarn Cost part report here -------------------------------------------
		$yarn_data_array=array();
		$sql_y=sql_select("select c.item_number_id,c.order_quantity ,c.plan_cut_qnty,f.job_no,f.color,f.count_id,f.copm_one_id,f.percent_one,f.copm_two_id,f.percent_two,f.type_id,f.cons_ratio,f.cons_qnty,f.avg_cons_qnty,f.rate,f.amount,e.requirment   from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_fabric_cost_dtls d,wo_pre_cos_fab_co_avg_con_dtls e,wo_pre_cost_fab_yarn_cost_dtls f where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no and a.job_no=f.job_no and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes and d.id=f.fabric_cost_dtls_id and a.job_no=".$txt_job_no." $txt_po_breack_down_id_cond3 and e.cons !=0    and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1");//C.COLOR_NUMBER_ID=E.COLOR_NUMBER_ID and C.SIZE_NUMBER_ID=E.GMTS_SIZES and D.ID=F.FABRIC_COST_DTLS_ID

		foreach($sql_y as $sql_y_r)
		{

			$set_item_ratio=$gmtsitem_ratio_array[$sql_y_r[csf('job_no')]][$sql_y_r[csf('item_number_id')]];
			//$cons_qnty = def_number_format(($sql_y_r[csf("cons_qnty")]*($sql_y_r[csf("plan_cut_qnty")]/($order_price_per_dzn*$set_item_ratio))),5,"");
			$cons_qnty = def_number_format((($sql_y_r[csf("requirment")]*$sql_y_r[csf("cons_ratio")]/100)*($sql_y_r[csf("plan_cut_qnty")]/($order_price_per_dzn*$set_item_ratio))),5,"");
			$avg_cons_qnty = def_number_format(($sql_y_r[csf("avg_cons_qnty")]*($sql_y_r[csf("plan_cut_qnty")]/($order_price_per_dzn*$set_item_ratio))),5,"");
			//$amount = $sql_y_r[csf("amount")]*($sql_y_r[csf("plan_cut_qnty")]/($order_price_per_dzn*$set_item_ratio));
			 $amount = def_number_format(($cons_qnty*$sql_y_r[csf("rate")]),5,"");
			//$amount = def_number_format(($avg_cons_qnty*$sql_y_r[csf("rate")]),5,"");

			$yarn_data_array[$sql_y_r[csf("count_id")]][$sql_y_r[csf("copm_one_id")]][$sql_y_r[csf("percent_one")]][$sql_y_r[csf("copm_two_id")]][$sql_y_r[csf("percent_two")]][$sql_y_r[csf("type_id")]][$sql_y_r[csf("color")]][$sql_y_r[csf("rate")]][qnty]+=$cons_qnty;
			$yarn_data_array[$sql_y_r[csf("count_id")]][$sql_y_r[csf("copm_one_id")]][$sql_y_r[csf("percent_one")]][$sql_y_r[csf("copm_two_id")]][$sql_y_r[csf("percent_two")]][$sql_y_r[csf("type_id")]][$sql_y_r[csf("color")]][$sql_y_r[csf("rate")]][avg_qnty]+=$avg_cons_qnty;
			$yarn_data_array[$sql_y_r[csf("count_id")]][$sql_y_r[csf("copm_one_id")]][$sql_y_r[csf("percent_one")]][$sql_y_r[csf("copm_two_id")]][$sql_y_r[csf("percent_two")]][$sql_y_r[csf("type_id")]][$sql_y_r[csf("color")]][$sql_y_r[csf("rate")]][amount]+=$amount;
		}
		$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count"  );
		//Mysql
		/*$sql = "select id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, cons_ratio, sum(cons_qnty) as cons_qnty, rate, sum(amount) as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no=".$txt_job_no." group by count_id, copm_one_id, percent_one, copm_two_id, percent_two, type_id, rate";*/
				//oracle
				 $sql = "select min(id) as id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, color,type_id, min(cons_ratio) as cons_ratio, sum(cons_qnty) as cons_qnty, rate, sum(amount) as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no=".$txt_job_no." group by count_id, copm_one_id, percent_one, copm_two_id, percent_two, color,type_id, rate";
		        $data_array=sql_select($sql);
		?>
        <div style="margin-top:15px">
        	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="70" rowspan="<? echo count($data_array)+2; ?>"><div class="verticalText"><b>Yarn Cost</b></div></td>
                    <td width="350">Yarn Desc</td>
                    <td width="100">Yarn Qnty</td>
                    <td width="100">Avg.Yarn Qnty</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                </tr>
			<?
			$total_yarn_qty = 0;
            $total_yarn_amount = 0; $total_yarn_cost_dzn=0; $total_yarn_cost_kg=0; $total_yarn_avg_cons_qty=0;
			foreach( $data_array as $row )
            {
				if($row[csf("percent_one")]==100)
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
            	else
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];

 				$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("copm_two_id")]][$row[csf("percent_two")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]][qnty];
				$rowavgcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("copm_two_id")]][$row[csf("percent_two")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]][avg_qnty];
				$rowamount = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("copm_two_id")]][$row[csf("percent_two")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]][amount];
			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="right"><? echo number_format($rowcons_qnty,4); ?></td>
                    <td align="right"><? echo number_format($rowavgcons_qnty,4); ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo number_format($rowamount,4); ?></td>
                </tr>
            <?
			      $total_yarn_qty+=$rowcons_qnty;
				  $total_avg_yarn_qty+=$rowavgcons_qnty;
				  $total_yarn_amount +=$rowamount;
				  $total_yarn_cost_dzn+=$row[csf("amount")];
				  $total_yarn_avg_cons_qty+=$rowavgcons_qnty;
				  $total_yarn_cost_kg=$total_yarn_amount/$total_yarn_qty;
            }
            ?>
            	<tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo number_format($total_yarn_qty,4); ?></td>
                    <td align="right"><? echo number_format($total_avg_yarn_qty,4); ?></td>
                    <td></td>
                    <td align="right"><? echo number_format($total_yarn_amount,4); ?></td>
                </tr>
        	</table>
      </div>
      <?

	//End Yarn Cost part report here -------------------------------------------

	//start	Conversion Cost to Fabric report here -------------------------------------------
	$stripe_color_array=array();
	$stripe_color_req_array=array();
	$sql_stripe=sql_select("select h.pre_cost_fabric_cost_dtls_id , h.color_number_id , h.stripe_color,h.fabreq  from wo_po_details_master a,wo_pre_stripe_color h where yarn_dyed=1 and a.job_no=".$txt_job_no." and a.job_no=h.job_no");
	foreach($sql_stripe as $row_stripe)
	{
		$stripe_color_array[$row_stripe[csf('pre_cost_fabric_cost_dtls_id')]][$row_stripe[csf('color_number_id')]][$row_stripe[csf('stripe_color')]]=$row_stripe[csf('stripe_color')];
		$stripe_color_req_array[$row_stripe[csf('pre_cost_fabric_cost_dtls_id')]][$row_stripe[csf('color_number_id')]][$row_stripe[csf('stripe_color')]]=$row_stripe[csf('fabreq')];

	}

	$contrast_color_array=array();
	$sql_contrast=sql_select("select g.pre_cost_fabric_cost_dtls_id , g.gmts_color_id , g.contrast_color_id  from wo_po_details_master a,wo_pre_cos_fab_co_color_dtls g where 1=1 and a.job_no=".$txt_job_no." and a.job_no=g.job_no");
	foreach($sql_contrast as $row_contrast){
		$contrast_color_array[$row_contrast[csf('pre_cost_fabric_cost_dtls_id')]][$row_contrast[csf('gmts_color_id')]]=$row_contrast[csf('contrast_color_id')];
	}

	$rateArray=array();
	$sql_rate=sql_select("select f.id , f.color_break_down  from wo_po_details_master a,wo_pre_cost_fab_conv_cost_dtls f where 1=1 and a.job_no=".$txt_job_no." and a.job_no=f.job_no");
	foreach($sql_rate as $row_rate){
		    $id=$row_rate[csf('id')];
			$colorBreakDown=$row_rate[csf('color_break_down')];
			if($colorBreakDown !="")
			{
				$arr_1=explode("__",$colorBreakDown);
				for($ci=0;$ci<count($arr_1);$ci++)
				{
				$arr_2=explode("_",$arr_1[$ci]);
				$rateArray[$id][$arr_2[0]]=$arr_2[1];
				}
			}
	}
	//print_r($contrast_color_array);
  $conv_data=array();
   $sql_conv="select a.job_no,b.id,c.item_number_id,c.country_id,c.color_number_id,c.size_number_id,c.order_quantity ,c.plan_cut_qnty ,d.id as pre_cost_dtls_id,d.fab_nature_id,d.color_size_sensitive,d.color_type_id,e.cons,e.requirment,f.id as fid,f.cons_process,f.req_qnty,f.process_loss,f.avg_req_qnty,f.charge_unit,f.amount,f.color_break_down   from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_fabric_cost_dtls d,wo_pre_cos_fab_co_avg_con_dtls e,wo_pre_cost_fab_conv_cost_dtls f where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no and a.job_no=f.job_no and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes and d.id=f.fabric_description  and e.cons !=0  and a.job_no=".$txt_job_no." $txt_po_breack_down_id_cond3  and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1
UNION ALL
select a.job_no,b.id,c.item_number_id,c.country_id,c.color_number_id,c.size_number_id,c.order_quantity ,c.plan_cut_qnty ,d.id as pre_cost_dtls_id,d.fab_nature_id,d.color_size_sensitive,d.color_type_id,e.cons,e.requirment,f.id as fid,f.cons_process,f.req_qnty,f.process_loss,f.avg_req_qnty,f.charge_unit,f.amount,f.color_break_down   from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_fabric_cost_dtls d,wo_pre_cos_fab_co_avg_con_dtls e,wo_pre_cost_fab_conv_cost_dtls f where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no and a.job_no=f.job_no and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes and f.fabric_description=0  and e.cons !=0  and a.job_no=".$txt_job_no." $txt_po_breack_down_id_cond3 and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 ";
$data_arr_conv=sql_select($sql_conv);
foreach($data_arr_conv as $conv_row)
{
    $costing_per_qty=0;
	$costing_per=$costing_per_arr[$conv_row[csf('job_no')]];
	if($costing_per==1)
	{
	$costing_per_qty=12	;
	}
	if($costing_per==2)
	{
	$costing_per_qty=1;
	}
	if($costing_per==3)
	{
	$costing_per_qty=24	;
	}
	if($costing_per==4)
	{
	$costing_per_qty=36	;
	}
	if($costing_per==5)
	{
	$costing_per_qty=48	;
	}

	$set_item_ratio=$gmtsitem_ratio_array[$conv_row[csf('job_no')]][$conv_row[csf('item_number_id')]];

	$requirment=0;
	$convqnty=0;
	$avgconvqnty=0;
	$convamount=0;
	$convrate=0;
	$stripe_color_arr=$stripe_color_array[$conv_row[csf('pre_cost_dtls_id')]][$conv_row[csf('color_number_id')]];
	if(($conv_row[csf('color_type_id')]==2 || $conv_row[csf('color_type_id')]==3 || $conv_row[csf('color_type_id')]==4 || $conv_row[csf('color_type_id')]==6) && $conv_row[csf('cons_process')]==30 && count($stripe_color_arr)>0){
		//echo $conv_row[csf('pre_cost_dtls_id')];
		$qnty=0;
		$avgqnty=0;
		$convrate=0;
		$amt=0;
		foreach($stripe_color_arr as $stripe_color_id){
			$stripe_color_cons_dzn=$stripe_color_req_array[$conv_row[csf('pre_cost_dtls_id')]][$conv_row[csf('color_number_id')]][$stripe_color_id];
			$requirment=$stripe_color_cons_dzn-($stripe_color_cons_dzn*$conv_row[csf("process_loss")])/100;
	        $qnty=def_number_format(($conv_row[csf("plan_cut_qnty")]/($order_price_per_dzn*$set_item_ratio))*$requirment,5,"");
	        $avgqnty=def_number_format(($conv_row[csf("plan_cut_qnty")]/($order_price_per_dzn*$set_item_ratio))*$requirment,5,"");
			$convrate=$rateArray[$conv_row[csf('fid')]][$stripe_color_id];
			if($convrate>0){
			$amt=def_number_format($qnty*$convrate,5,"");
			$convqnty+=$qnty;
			$avgconvqnty+=$avgqnty;
			$convamount+=$amt;
			}
		}
	}
	else if($conv_row[csf('cons_process')]!=30){

		$convrate=0;
		$requirment=$conv_row[csf("requirment")]-($conv_row[csf("requirment")]*$conv_row[csf("process_loss")])/100;
	    $convqnty =def_number_format(($conv_row[csf("plan_cut_qnty")]/($order_price_per_dzn*$set_item_ratio))*$requirment,5,"");
	    $avgconvqnty =def_number_format(($conv_row[csf("plan_cut_qnty")]/($order_price_per_dzn*$set_item_ratio))*$requirment,5,"");
		$rateColorId=$conv_row[csf('color_number_id')];
		if($conv_row[csf('color_size_sensitive')]==3){
			$rateColorId=$contrast_color_array[$conv_row[csf('pre_cost_dtls_id')]][$conv_row[csf('color_number_id')]];
		}else{
			$rateColorId=$conv_row[csf('color_number_id')];
		}


		if($conv_row[csf('color_break_down')] !=""){
			$convrate=$rateArray[$conv_row[csf('fid')]][$rateColorId];
		}
		else{
			$convrate=$conv_row[csf('charge_unit')];
		}
		$convamount=def_number_format($convqnty*$convrate,5,"");
	}
	$conv_data[$conv_row[csf('fid')]]['conv_qnty']+=$convqnty;
	$conv_data[$conv_row[csf('fid')]]['avg_conv_qnty']+=$avgconvqnty;
	$conv_data[$conv_row[csf('fid')]]['conv_amount']+=$convamount;
}

	$sql_count = "select a.cons_process as cons_process from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id where a.job_no=".$txt_job_no." group by a.cons_process order by  a.cons_process";
	$tot_data_array=sql_select($sql_count);
	foreach( $tot_data_array as $row ){
			 $process_id=$row[csf("cons_process")];
			 $process_row+=count($row[csf("cons_process")]);
	 }
	 $sql = "select a.id,a.fabric_description as pre_cost_fabric_cost_dtls_id, a.job_no, a.cons_process, a.req_qnty, a.charge_unit,a.amount,a.color_break_down, a.status_active,b.body_part_id,b.fab_nature_id,b.color_type_id,b.fabric_description,b.item_number_id from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id where a.job_no=".$txt_job_no." order by  a.cons_process";
	 $data_array=sql_select($sql);
 	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
                <tr style="font-weight:bold">
                    <td width="80" rowspan="<? echo count($data_array)+2+$process_row; ?>"><div class="verticalText"><b>Conversion Cost to Fabric</b></div></td>
                    <td width="350">Particulars</td>
                    <td width="100">Process</td>
                    <td width="100">Required</td>
                    <td width="100">Avg.Required</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                </tr>
            <?
            $total_conversion_cost=0;$total_conversion_cost_dzn=0;$total_conversion_cost_kg=0;
			$total_convsion_qty=0;
			$total_avg_convsion_qty=0;$grand_total_conv_qnty=0;$grand_total_avg_convsion_qty=0;$grand_total_conversion_cost=0;
			$process_array_check=array();$k=1;
            foreach( $data_array as $row )
            {
			//echo count($data_array);
			   /* $color_id_string="";
				$color_break_down_arr=explode("__",$row[csf("color_break_down")]);
				for($co=0; $co<=count($color_break_down_arr); $co++)
				{
					$color_break_down_arr_row=explode("_",$color_break_down_arr[$co]);

					//for($cow=0; $cow<=count($color_break_down_arr_row);  $cow++)
					//{
						if($color_break_down_arr_row[1] !=0)
						{
				          $color_id_string.=$color_break_down_arr_row[0].",";
						}
					//}
				}
				$color_id_string=rtrim($color_id_string,",");
				if($color_id_string =="")
				{
					$color_cond="";
				}
				else
				{
				  $color_cond="and c.color_number_id in(".$color_id_string.")";
				}

				$po_break_down_id_string="";*/
				if($row[csf("pre_cost_fabric_cost_dtls_id")] ==0)
				{
				/*	//$po_data_array=sql_select("Select distinct po_break_down_id from  wo_pre_cos_fab_co_avg_con_dtls where job_no='".$row[csf("job_no")]."' and cons !=0");
					$po_data_array=sql_select("select c.plan_cut_qnty/a.total_set_qnty as order_quantity  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_fabric_cost_dtls d,wo_pre_cos_fab_co_avg_con_dtls f where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=f.job_no  and b.id=c.po_break_down_id and b.id=f.po_break_down_id and c.po_break_down_id=f.po_break_down_id and c.item_number_id=d.item_number_id and a.job_no='".$row[csf("job_no")]."' $txt_po_breack_down_id_cond3 and f.cons !=0   $color_cond and a.status_active=1 and b.status_active=1 and c.status_active=1 group by c.id,c.plan_cut_qnty,a.total_set_qnty");
					$po_qty_con=0;
					foreach($po_data_array as $po_data_array_row)
					{
					  $po_qty_con+=$po_data_array_row[csf('order_quantity')];
					}

 				$req_qnty_c = $row[csf("req_qnty")]/$order_price_per_dzn*($po_qty_con);

				$amount_c = $row[csf("amount")]/$order_price_per_dzn*($po_qty_con);*/
				$item_descrition = "All Fabrics";
				}
				else
				{
					/*$po_data_array=sql_select("Select distinct po_break_down_id from  wo_pre_cos_fab_co_avg_con_dtls where pre_cost_fabric_cost_dtls_id=".$row[csf("pre_cost_fabric_cost_dtls_id")]." $txt_po_breack_down_id_cond2 and cons !=0");
					foreach($po_data_array as $po_data_array_row)
					{
					$po_break_down_id_string.=$po_data_array_row[csf('po_break_down_id')].",";
					}

					$sql_po_qty_con=sql_select("select sum(c.plan_cut_qnty) as order_quantity  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and  b.id in(".rtrim($po_break_down_id_string,",").") and c.item_number_id='".$row[csf('item_number_id')]."' $color_cond and a.status_active=1 and b.status_active=1 and c.status_active=1");
				 list($sql_po_qty_row_con)=$sql_po_qty_con;
	             $po_qty_con=$sql_po_qty_row_con[csf('order_quantity')];

				$set_item_ratio=return_field_value("set_item_ratio"," wo_po_details_mas_set_details", "job_no='".$row[csf('job_no')]."' and gmts_item_id='".$row[csf('item_number_id')]."'");
 				$req_qnty_c = $row[csf("req_qnty")]/$order_price_per_dzn*($po_qty_con);
				$amount_c = $row[csf("amount")]/$order_price_per_dzn*($po_qty_con);*/
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				}

				$process_id=$row[csf("cons_process")];
				if (!in_array($process_id,$process_array_check) )
						{
							if($k!=1)
							{
								?>
                               <tr>
                                    <td>&nbsp;</td>
                                    <td><strong>Sub. Total : </strong></td>
                                    <td align="right"><strong><? echo number_format($total_convsion_qty,4); ?></strong></td>
                                    <td align="right"><strong><? echo number_format($total_avg_convsion_qty,4); ?></strong></td>
                                    <td>&nbsp;</td>
                                    <td align="right"><strong><? echo number_format($total_conversion_cost,4); ?></strong></td>
                                </tr>
                                <?
							}
							?>
                            <?
							unset($total_convsion_qty);
							unset($total_avg_convsion_qty);
							unset($total_conversion_cost);
							$process_array_check[]=$process_id;
							$k++;
						}
			?>
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="left"><? echo $conversion_cost_head_array[$row[csf("cons_process")]]; ?></td>
                    <td align="right"><? echo number_format($conv_data[$row[csf('id')]]['conv_qnty'],4); ?></td>
                    <td align="right"><? echo number_format($conv_data[$row[csf('id')]]['avg_conv_qnty'],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("charge_unit")],4); ?></td>
                    <td align="right"><? echo number_format($conv_data[$row[csf('id')]]['conv_amount'],4); ?></td>
                </tr>
            <?
			$total_convsion_qty+=$conv_data[$row[csf('id')]]['conv_qnty'];
			$total_avg_convsion_qty+=$conv_data[$row[csf('id')]]['avg_conv_qnty'];
            $total_conversion_cost += $conv_data[$row[csf('id')]]['conv_amount'];
			$grand_total_conv_qnty+=$conv_data[$row[csf('id')]]['conv_qnty'];
			$grand_total_avg_convsion_qty+=$conv_data[$row[csf('id')]]['avg_conv_qnty'];
			$grand_total_conversion_cost+= $conv_data[$row[csf('id')]]['conv_amount'];
			$total_conversion_cost_dzn+=$row[csf('amount')];
			$total_conversion_cost_kg=$grand_total_conversion_cost/$total_avg_yarn_qty;//$grand_total_avg_convsion_qty;
            }
            ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td>&nbsp;</td>
                <td align="right">Sub. Total</td>
                <td align="right"><? echo number_format($total_convsion_qty,4); ?></td>
                <td align="right"><? echo number_format($total_avg_convsion_qty,4); ?></td>
                <td>&nbsp;</td>
                <td align="right"><? echo number_format($total_conversion_cost,4); ?></td>
            </tr>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="2" align="right">Grand Total</td>
                <td align="right"><? echo number_format($grand_total_conv_qnty,4); ?></td>
                <td align="right"><? echo number_format($grand_total_avg_convsion_qty,4); ?></td>
                <td>&nbsp;</td>
                <td align="right"><? echo number_format($grand_total_conversion_cost,4); ?></td>
            </tr>
            </table>
      </div>
      <?
	//End Conversion Cost to Fabric report here -------------------------------------------



	//start	Trims Cost part report here -------------------------------------------
    	$sql = "select id, job_no, trim_group,description,brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,status_active from wo_pre_cost_trim_cost_dtls  where job_no=".$txt_job_no."";
		$data_array=sql_select($sql);
 	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Trims Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Item Group</td>
                    <td width="150">Description</td>
                    <td width="150">Brand/Supp Ref</td>
                    <td width="100">UOM</td>
                    <td width="100">Consumption</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                </tr>
            <?
			$trim_qty_arr=$trims->getQtyArray_by_precostdtlsid();
			//print_r($trim_qty);
			$trim_amount_arr=$trims->getAmountArray_precostdtlsid();
			
            $total_trims_cost=0;  $total_trims_qty=0;$total_trims_cost_dzn=0;$total_trims_cost_kg=0;
            foreach( $data_array as $row ){
				
				$row[csf("cons_dzn_gmts")]=$trim_qty_arr[$row[csf("id")]];
				$row[csf("amount")]=$trim_amount_arr[$row[csf("id")]];
				
				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row[csf("trim_group")], "id", "item_name" );
			?>
                <tr>
                    <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                    <td align="left"><? echo $row[csf("description")]; ?></td>
                    <td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                    <td align="right"><? echo number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_trims_cost += $row[csf("amount")];
				 $total_trims_qty += $row[csf("cons_dzn_gmts")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="6">Total</td>
                    <td align="right"><? echo number_format($total_trims_cost,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	 //End Trims Cost Part report here -------------------------------------------



	 //start	Embellishment Details part report here -------------------------------------------
		$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no."";
		$data_array=sql_select($sql);
	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Embellishment Details</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Type</td>
                    <td width="150">Gmts. Qnty (Dzn)</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                 </tr>
            <?
			$emblishment_qty_arr=$emblishment->getQtyArray_by_jobAndEmblishmentid();

			$emblishment_amount_arr=$emblishment->getAmountArray_by_jobAndEmblishmentid();
			$wash= new wash($condition);
			$wash_qty_arr=$wash->getQtyArray_by_jobAndEmblishmentid();
			$wash_amount_arr=$wash->getAmountArray_by_jobAndEmblishmentid();
			//print_r($wash_qty_arr);
            $total_embellishment_amt=0;$total_embellishment_amt_dzn=0;
            foreach( $data_array as $row )
            {
				$em_type ="";
				$total_embellishment_amt_dzn += $row[csf("amount")];
				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row[csf("emb_name")]==1) $em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
				
				$embell_budget_qty_id=$embelt_budget_qty_id_arr[$row[csf("emb_name")]];
				//echo $ord_qty.'=='.$plan_cut_qty.'=='.$embelt_budget_qty_id;
				/*if($embell_budget_qty_id==1) //Order Qty
				{
					$row[csf("cons_dzn_gmts")] = $row[csf("cons_dzn_gmts")]/$order_price_per_dzn*$po_quantity;
					$row[csf("amount")] = $row[csf("amount")]/$order_price_per_dzn*$po_quantity;
					
				}
				else //Plan Cut
				{
					$row[csf("cons_dzn_gmts")] = $row[csf("cons_dzn_gmts")]/$order_price_per_dzn*$plan_cut_qty;
					$row[csf("amount")] = $row[csf("amount")]/$order_price_per_dzn*$plan_cut_qty;
				}*/
				if($row[csf("emb_name")]!=3){
				$row[csf("cons_dzn_gmts")]=$emblishment_qty_arr[$row[csf("job_no")]][$row[csf("id")]];
				$row[csf("amount")]=$emblishment_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
				}
				else {
				$row[csf("cons_dzn_gmts")]=$wash_qty_arr[$row[csf("job_no")]][$row[csf("id")]];
				$row[csf("amount")]=$wash_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
				}
				
				
				
			?>
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo number_format($row[csf("cons_dzn_gmts")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo number_format($row[csf("amount")],4); ?></td>
                </tr>
            <?
                 $total_embellishment_amt += $row[csf("amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="4">Total</td>
                    <td align="right"><? echo number_format($total_embellishment_amt,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	 //End Embellishment Details Part report here -------------------------------------------



	 //start	Commercial Cost part report here -------------------------------------------
   	$sql = "select id, job_no, item_id, rate, amount, status_active
			from  wo_pre_cost_comarci_cost_dtls
			where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	?>

        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commercial Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                 </tr>
            <?
			$commercial= new commercial($condition);
			$commarcial_amount_arr=$commercial->getAmountArray_by_jobAndPrecostdtlsid();
			
            $total_commercial_cost=0;$total_commercial_cost_dzn=0;
            foreach( $data_array as $row )
            {
				$total_commercial_cost_dzn+= $row[csf("amount")];

				$amount =$commarcial_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
  			?>
                <tr>
                    <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],4); ?></td>
                    <td align="right"><? echo number_format($amount,4); ?></td>
                </tr>
            <?
                 $total_commercial_cost += $amount;

            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="2">Total</td>
                    <td align="right"><? echo number_format($total_commercial_cost,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	 //End Commercial Cost Part report here -------------------------------------------


  	//start	Commission Cost part report here -------------------------------------------
   	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls  where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:850px;text-align:center;" rules="all">
            <label><b>Commission Cost</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="150">Commission Basis</td>
                    <td width="100">Rate</td>
                    <td width="100">Amount</td>
                 </tr>
            <?
			$commission= new commision($condition);
			$commission_amount_arr=$commission->getAmountArray_by_jobAndPrecostdtlsid();
			//print_r($commission_amount_arr);
            $total_commission_cost=0;   $total_commission_cost_dzn=0;
            foreach( $data_array as $row )
            {
				$commission_amount=$commission_amount_arr[$row[csf("job_no")]][$row[csf("id")]];// $row[csf("commission_amount")]/$order_price_per_dzn*$ord_qty;
  			?>
                <tr>
                    <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                    <td align="right"><? echo number_format($row[csf("commision_rate")],4); ?></td>
                    <td align="right"><? echo number_format($commission_amount,4); ?></td>
                </tr>
            <?
                 $total_commission_cost += $commission_amount;
				 $total_commission_cost_dzn+=$row[csf("commission_amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td colspan="3">Total</td>
                    <td align="right"><? echo number_format($total_commission_cost,4); ?></td>
                </tr>
            </table>
      </div>
      <?
	//End Commission Cost Part report here -------------------------------------------


	//start	Other Components part report here -------------------------------------------
   	$sql = "select id,job_no,costing_per_id,order_uom_id,fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,currier_pre_cost, currier_percent, 	certificate_pre_cost, certificate_percent, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche  from wo_pre_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	?>

        <div style="margin-top:15px">
         <table>
         <tr>
         <td>
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:450px;text-align:center;" rules="all">
            <label><b>Others Components</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount</td>
                 </tr>
            <?
            $total_other_components=0;$lab_test_dzn=0;
			$lab_test = 0;
			$inspection = 0;
			$cm_cost = 0;
			$freight = 0;
			$common_oh = 0;
           foreach( $data_array as $row )
           {
				$lab_test = $lab_test_cost;
				$inspection = $inspection_cost;
				$cm_cost=$other_costing_arr[$row[csf("job_no")]]['cm_cost'];
				$freight = $freight_cost;
				$common_oh = $common_oh;
				$currier_pre_cost = $currier_cost;
				$certificate_pre_cost = $certificate_cost;
				$lab_test_dzn=$row[csf("lab_test")];
				$inspection_dzn=$row[csf("inspection")];
				$cm_cost_dzn =$row[csf("cm_cost")];
				$common_oh_dzn =$row[csf("common_oh")];
				$freight_dzn =$row[csf("freight")];
				$currier_pre_cost_dzn = $row[csf("currier_pre_cost")];
				$certificate_pre_cost_dzn = $row[csf("certificate_pre_cost")];


   			?>
                <tr>
                    <td align="left"s>Lab Test </td>
                    <td align="right"><? echo number_format($lab_test,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo number_format($inspection,4); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo number_format($cm_cost,4); ?></td>
                </tr>

                <tr>
                    <td align="left">Depc. & Amort.</td>
                    <td align="right"><? echo number_format($depr_amor_pre_cost,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo number_format($freight,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Currier Cost </td>
                    <td align="right"><? echo number_format($currier_pre_cost,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Certificate Cost </td>
                    <td align="right"><? echo number_format($certificate_pre_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Deffd. LC/DC Cost </td>
                    <td align="right"><? echo number_format($deffdlc_cost,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Interest </td>
                    <td align="right"><? echo number_format($interest_cost,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Income Tax </td>
                    <td align="right"><? echo number_format($incometax_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Office OH</td>
                    <td align="right"><? echo number_format($common_oh,4); ?></td>
                </tr>
            <?
                 $total_other_components += $lab_test+$inspection+$cm_cost+$freight+$currier_pre_cost+$certificate_pre_cost+$common_oh+$depr_amor_pre_cost+$deffdlc_cost+$incometax_cost+$interest_cost;
           }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Total</td>
                    <td align="right"><? echo number_format($total_other_components,4); ?></td>
                </tr>
            </table>
            </td>
            <td valign="top" rowspan="2">

            <?
     	 // image show here  -------------------------------------------
		 $sql = "select id,master_tble_id,image_location
				from common_photo_library
				where master_tble_id=$txt_job_no limit 1";
		$data_array=sql_select($sql);
 	  ?>
          <div style="margin:15px 5px;float:right;width:500px" >
          	<? foreach($data_array AS $inf){ ?>
                <img  src='../../<? echo $inf[csf("image_location")]; ?>' height='400' width='300' />
            <?  } ?>
          </div>
          </td>
          </tr>
          <tr>
          <td>
			<?
            $total_summary_amount = 0;
            $total_summary_amount = $total_commission_cost+$total_commercial_cost+$total_embellishment_amt+$total_trims_cost+$grand_total_conversion_cost+$total_yarn_amount +$woven_subtotal_amount+$knit_subtotal_amount+$lab_test+$inspection+$cm_cost+$freight+$currier_pre_cost+$certificate_pre_cost+$common_oh+$depr_amor_pre_cost+$deffdlc_cost+$interest_cost+$interest_cost;
            ?>
	 <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:500px;text-align:center" rules="all">
            <label><b>Summary</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Cost Summary</td>
                    <td width="100">Cost/DZN</td>
                    <td width="100">Cost/Kg</td>
                    <td width="100">Total</td>
                 </tr>
                 <tr>
                    <td align="left">Knit Fabric (Purchase) </td>
                    <td align="right"><? echo number_format($knit_subtotal_amount_dzn,4); ?></td>
                    <td align="right"><? echo number_format($knit_subtotal_amount_kg,4); ?></td>
                    <td align="right"><? echo number_format($knit_subtotal_amount,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Woven Fabric (Purchase)</td>
                    <td align="right"><? echo number_format($woven_subtotal_amount_dzn,4); ?></td>
                    <td align="right"><? echo number_format($woven_subtotal_amount_kg,4); ?></td>
                    <td align="right"><? echo number_format($woven_subtotal_amount,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Yarn</td>
                    <td align="right"><? echo number_format($total_yarn_cost_dzn,4); ?></td>
                    <td align="right"><? echo number_format($total_yarn_cost_kg,4); ?></td>
                    <td align="right"><? echo number_format($total_yarn_amount,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Conversion to Fabric</td>
                    <td align="right"><? echo number_format($total_conversion_cost_dzn,4); ?></td>
                    <td align="right"><? echo number_format($total_conversion_cost_kg,4); ?></td>
                    <td align="right"><? echo number_format($grand_total_conversion_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Trims</td>
                    <td align="right"><? echo number_format($total_trims_cost_dzn,4); ?></td>
                    <td align="right" rowspan="15"><? //echo number_format($total_trims_cost_kg,4); ?></td>
                    <td align="right"><? echo number_format($total_trims_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Embellishment</td>
                    <td align="right"><? echo number_format($total_embellishment_amt_dzn,4); ?></td>
                    <td align="right"><? echo number_format($total_embellishment_amt,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Commercial</td>
                    <td align="right"><? echo number_format($total_commercial_cost_dzn,4); ?></td>
                    <td align="right"><? echo number_format($total_commercial_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Commission</td>
                    <td align="right"><? echo number_format($total_commission_cost_dzn,4); ?></td>
                    <td align="right"><? echo number_format($total_commission_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Depc. & Amort.</td>
                    <td align="right"><? echo number_format($depr_amor_pre_cost_dzn,4); ?></td>
                    <td align="right"><? echo number_format($depr_amor_pre_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Lab Test</td>
                    <td align="right"><? echo number_format($lab_test_dzn,4); ?></td>
                    <td align="right"><? echo number_format($lab_test,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Inspection Cost</td>
                    <td align="right"><? echo number_format($inspection_dzn,4); ?></td>
                    <td align="right"><? echo number_format($inspection,4); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Cost - IE</td>
                    <td align="right"><? echo number_format($cm_cost_dzn,4); ?></td>
                    <td align="right"><? echo number_format($cm_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Freight Cost</td>
                    <td align="right"><? echo number_format($freight_dzn,4); ?></td>
                    <td align="right"><? echo number_format($freight,4); ?></td>
                </tr>

                 <tr>
                    <td align="left">Currier Cost </td>
                    <td align="right"><? echo number_format($currier_pre_cost_dzn,4); ?></td>
                    <td align="right"><? echo number_format($currier_pre_cost,4); ?></td>
                </tr>

                 <tr>
                    <td align="left">Certificate Cost </td>
                    <td align="right"><? echo number_format($certificate_pre_cost_dzn,4); ?></td>
                    <td align="right"><? echo number_format($certificate_pre_cost,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Deffd. LC/DC Cost </td>
                    <td align="right"><? echo number_format($deffdlc_cost_dzn,4); ?></td>
                    <td align="right"><? echo number_format($deffdlc_cost,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Interest </td>
                    <td align="right"><? echo number_format($interest_percent,4); ?></td>
                    <td align="right"><? echo number_format($interest_cost,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Income Tax </td>
                    <td align="right"><? echo number_format($incometax_percent,4); ?></td>
                    <td align="right"><? echo number_format($interest_cost,4); ?></td>
                </tr>
                <tr>
                    <td align="left">Office OH</td>
                    <td align="right"><? echo number_format($common_oh_dzn,4); ?></td>
                    <td align="right"><? echo number_format($common_oh,4); ?></td>
                </tr>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td align="right" colspan="3">Total</td>
                    <td align="right"><? echo number_format($total_summary_amount,4); ?></td>
                </tr>
            </table>
          </td>
          </tr>
          </table>
          <?
          //start	CM on Net Order Value part report here -------------------------------------------
    	$sql = "select id,job_no,costing_per_id,order_uom_id,fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,total_cost,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
			from wo_pre_cost_dtls
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	foreach( $data_array as $row );
	$order_net_value = 0;
	?>

        <div style="margin-top:15px">
        <div style="float:left">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
            <label><b>CM on Net Order Value</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">%</td>
                </tr>
                <tr>
                    <td align="left">Order Value </td>
                    <td align="right"><?  echo number_format($order_values,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Commission </td>
                    <td align="right"><? $less_commission=$commission_costing_arr[$job_no];//$less_commission = $row[csf("commission")]/$order_price_per_dzn*$order_job_qnty;
					echo number_format($less_commission,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Commercial Cost </td>
                    <td align="right"><? $less_commercial=$commercial_costing_arr[$job_no];//$less_commercial = $row[csf("comm_cost")]/$order_price_per_dzn*$order_job_qnty;
					 echo number_format($less_commercial,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Less Freight</td>
                    <td align="right"><? $less_freight=$other_costing_arr[$job_no]['freight'];//$less_freight = $row[csf("freight")]/$order_price_per_dzn*$order_job_qnty;
					echo number_format($less_freight,4); ?></td>
                    <td align="right">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Net Order Value</td>
                    <td align="right"><? $order_net_value=$order_values-($less_commission+$less_commercial+$less_freight);echo number_format($order_net_value,4); ?></td>
                    <td align="center"><? echo number_format($order_net_value/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">Other Cost</td>
                    <td align="right">
					<?
					//echo $others_cost_value;
					$otherCost=$others_cost_value;
					//	$otherCost=$others_cost_value/$order_price_per_dzn*$order_job_qnty;
					echo number_format($otherCost,4);
					?>
                    </td>
                    <td align="center"><? echo number_format($otherCost/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">CM(Contribution Margin)</td>
                    <td align="right"><? $cmValue = $order_net_value-$otherCost; echo number_format($cmValue,4); ?></td>
                    <td align="center"><? echo number_format($cmValue/$order_net_value*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">CM /<? echo $costing_for; ?></td>
                    <td align="right"><? $cmPerDzn=$cmValue/$order_qty*$order_price_per_dzn; echo number_format($cmPerDzn,4); ?></td>
                    <td align="center"></td>
                </tr>
                <tr>
                    <td align="left">CM Cost /<? echo $costing_for; ?></td>
                    <td align="right"><?
					$cm_cost=$cm_cost_dzn;//$other_costing_arr[$job_no]['cm_cost'];
					echo number_format($cm_cost,4); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>
                <tr>
                    <td align="left">Margin /<? echo $costing_for; ?></td>
                    <td align="right"><? echo number_format($cmPerDzn-$cm_cost,4); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>

            </table>
      </div>
      <div style="margin-left:5px;float:left;">
      		<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:420px;text-align:center;" rules="all">
            <label><b>Cost Summary for order quantity</b></label>
                <tr style="font-weight:bold">
                    <td width="150">Particulars</td>
                    <td width="100">Amount (USD)</td>
                    <td width="100">%</td>
                </tr>
                <tr>
                    <td align="left">Total Order Value </td>
                    <td align="right"><? $total_order_val = $order_values;//$order_job_qnty*$avg_unit_price;
					 echo number_format($total_order_val,4); ?></td>
                    <td align="center"><? echo number_format($total_order_val/$total_order_val*100,4); ?></td>
                </tr>
                 <tr>
                    <td align="left">Total Cost </td>
                    <td align="right"><?  $total_cost = $total_summary_amount;//$all_total_cost;
					echo number_format($total_cost,4);//$total_cost = $row[csf("total_cost")]/$order_price_per_dzn*$order_job_qnty; echo number_format($total_cost,4); ?></td>
                    <td align="center"><? echo number_format($total_cost/$total_order_val*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Margin </td>
                    <td align="right"><? $margin_val = $total_order_val-$total_cost; echo number_format($margin_val,4); ?></td>
                    <td align="center"><? echo number_format($margin_val/$total_order_val*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Margin /<? echo $costing_for; ?> </td>
                    <td align="right"><? echo number_format($margin_val/$order_qty*$order_price_per_dzn,2); ?></td>
                    <td align="center">&nbsp;</td>
                </tr>
           </table>
      </div>
       <?
     	 // image show here  -------------------------------------------
		$sql = "select id,master_tble_id,image_location
				from common_photo_library
				where master_tble_id=".$txt_job_no."";
		$data_array=sql_select($sql);
 	  ?>
          <div style="margin:15px 5px;float:left;width:500px" >
          	<? foreach($data_array AS $inf){ ?>
                <img  src='../../<? echo $inf[csf("image_location")]; ?>' height='97' width='89' />
            <?  } ?>
          </div>
      <div style="clear:both"></div>
      </div>
    <!--End CM on Net Order Value Part report here ------------------------------------------->
	<? echo "<br /><b>Note: Other Cost =  Fabric Cost + Trims Cost + Embellishment Cost + Lab Test + Inspection + Office OH</b><br /><br />"; ?>
      </div>


      <!--End CM on Net Order Value Part report here ------------------------------------------->

    <br/>
     <?  echo signature_table(109, $cbo_company_name, "890px");?>
	</div>
	 <?
	 exit();
}
if($action=="bomRpt3")
{
	///extract($_REQUEST);
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process )); 

	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and c.costing_date='".$txt_costing_date."'";
	if(str_replace("'",'',$txt_po_breack_down_id)=="") 
	{
		$txt_po_breack_down_id_cond=''; 
		$txt_po_breack_down_id_cond1=''; 
		$txt_po_breack_down_id_cond2=''; 
		$txt_po_breack_down_id_cond3=''; 
	}
	else
	{
		$txt_po_breack_down_id_cond=" and b.id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond1=" and id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond2=" and po_break_down_id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond3=" and b.id in(".$txt_po_breack_down_id.")";
	}
 	
	//array for display name
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	
	if($db_type==0) $group_gsm="group_concat( distinct b.gsm_weight) AS gsm_weight";
	if($db_type==2) $group_gsm="listagg(b.gsm_weight ,',') within group (order by b.gsm_weight) AS gsm_weight";
	
	$gsm_weight_top=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and a.body_part_type in(1,20)","gsm_weight");
	//$gsm_weight_bottom=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and a.body_part_type=20 ","gsm_weight");
	//echo $gsm_weight_bottom.'DD';
	$gmtsitem_ratio_array=array();
	$grmnt_items = "";
    $grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no=$txt_job_no");
	foreach($grmts_sql as $key=>$val)
	{
		$grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].",";
		$gmtsitem_ratio_array[$val[csf('job_no')]][$val[csf('gmts_item_id')]]=$val[csf('set_item_ratio')];	
	}
	$grmnt_items = rtrim($grmnt_items,","); 
	
	if($db_type==0) ///fab_knit_fin_req_kg,fab_knit_req_kg
	{	
	   $sql = "select a.job_no,a.company_name, a.buyer_name,a.style_ref_no,a.ship_mode, a.gmts_item_id,a.order_uom, a.avg_unit_price,sum(b.plan_cut) as job_quantity,sum(b.po_quantity) as ord_qty, c.costing_per,c.budget_minute,c.costing_date,c.approved,c.exchange_rate ,a.quotation_id,c.incoterm,c.sew_effi_percent, d.fab_knit_req_kg,d.fab_knit_fin_req_kg, d.fab_woven_req_yds,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg
			from wo_po_details_master a,wo_po_break_down b, wo_pre_cost_mst c left join wo_pre_cost_sum_dtls d on   c.job_no=d.job_no and d.status_active=1 and d.is_deleted=0
			where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no  and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref $txt_costing_date group by a.job_no,a.company_name, a.buyer_name,a.style_ref_no, a.gmts_item_id,a.order_uom, a.avg_unit_price, c.costing_per,c.approved,c.budget_minute,c.incoterm,c.sew_effi_percent, d.fab_knit_req_kg, d.fab_woven_req_yds,d.fab_knit_fin_req_kg,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg order by a.job_no"; 
	}
	if($db_type==2)
	{	
	   $sql = "select a.job_no,a.company_name, a.buyer_name,a.ship_mode,a.style_ref_no, a.gmts_item_id,a.order_uom, a.avg_unit_price,sum(b.plan_cut) as job_quantity,sum(b.po_quantity) as ord_qty, c.costing_per,c.costing_date,c.budget_minute,c.approved,a.quotation_id,c.exchange_rate ,c.incoterm,c.sew_effi_percent,d.fab_knit_fin_req_kg, d.fab_knit_req_kg, d.fab_woven_req_yds,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg
			from wo_po_details_master a,wo_po_break_down b, wo_pre_cost_mst c left join  wo_pre_cost_sum_dtls d on  c.job_no=d.job_no and d.status_active=1 and d.is_deleted=0
			where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no  and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref group by a.job_no,a.company_name, a.buyer_name,a.style_ref_no, a.gmts_item_id,a.order_uom,a.ship_mode, a.avg_unit_price,c.incoterm,c.costing_date,c.exchange_rate ,a.quotation_id,c.costing_per,c.sew_effi_percent,c.approved,c.budget_minute, d.fab_knit_req_kg, d.fab_woven_req_yds,d.fab_knit_fin_req_kg,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg  order by a.job_no"; //a.job_quantity as job_quantity,
	}
	//echo $sql;die;
	$data_array=sql_select($sql);
	$plan_cut_qty=$data_array[0][csf('job_quantity')];
	
	$preCost_histry=sql_select( "select min(a.sew_smv) as sew_smv,min(a.sew_effi_percent) as sew_effi_percent,min(b.margin_dzn_percent) as margin_dzn_percent ,min(b.fabric_cost_percent) as  fabric_cost_percent,min(b.trims_cost_percent ) as trims_cost_percent,min(b.embel_cost_percent) as embel_cost_percent,min(b.wash_cost_percent) as wash_cost_percent ,min(b.comm_cost_percent) as comm_cost_percent ,min(b.commission_percent) as commission_percent,min(b.lab_test_percent) as lab_test_percent,min(b.inspection_percent) as inspection_percent,min(b.cm_cost_percent) as cm_cost_percent,min(b.freight_percent) as freight_percent,min(b.currier_percent) as currier_percent,min(b.certificate_percent) as certificate_percent,min(b.common_oh_percent) as common_oh_percent    from  wo_pre_cost_mst_histry a,wo_pre_cost_dtls_histry b where a.job_no=b.job_no and a.job_no=$txt_job_no"); 
	
	list($preCost_histry_row)=$preCost_histry;
	$opert_profitloss_percent=$preCost_histry_row[csf('margin_dzn_percent')];
	$fabric_cost_percent=$preCost_histry_row[csf('fabric_cost_percent')];
	$trims_cost_percent=$preCost_histry_row[csf('trims_cost_percent')];
	$embel_cost_percent=$preCost_histry_row[csf('embel_cost_percent')];
	$wash_cost_percent=$preCost_histry_row[csf('wash_cost_percent')];
	$comm_cost_percent=$preCost_histry_row[csf('comm_cost_percent')];
	$commission_percent=$preCost_histry_row[csf('commission_percent')];
	$common_oh_percent=$preCost_histry_row[csf('common_oh_percent')];
	
	$lab_test_percent=$preCost_histry_row[csf('lab_test_percent')];
	$inspection_percent=$preCost_histry_row[csf('inspection_percent')];
	$cm_cost_percent=$preCost_histry_row[csf('cm_cost_percent')];
	$freight_percent=$preCost_histry_row[csf('freight_percent')];
	$currier_percent=$preCost_histry_row[csf('currier_percent')];
	$certificate_percent=$preCost_histry_row[csf('certificate_percent')];
	//$currier_percent=$preCost_histry_row[csf('currier_percent')];
	$sew_effi_percent=$preCost_histry_row[csf('sew_effi_percent')];
	$sew_smv=$preCost_histry_row[csf('sew_smv')];
	$preCost_approved=sql_select( "select max(b.approved_no) as approved_no from wo_pre_cost_mst a, approval_history b where a.id=b.mst_id and a.job_no=$txt_job_no and b.entry_form=15"); 
	//echo "select max(b.approved_no) as approved_no from wo_pre_cost_mst a, approval_history b where a.id=b.mst_id and a.job_no=$txt_job_no and b.entry_form=15";
	list($preCost_approved_row)=$preCost_approved;
	$approved_no_row=$preCost_approved_row[csf('approved_no')];
	 if($approved_no_row>1){
	 	$revised_no=$approved_no_row-1;
	 }
	 $company_id=str_replace("'","",$cbo_company_name);
	?>
    <div style="width:972px; margin:0 auto">
	 
    <div style="width:970px; font-size:20px; font-weight:bold" align="center"><b style="float:left"> <img  src='../../<? echo $imge_arr[$company_id]; ?>' height='40px' width='100px' /></b><? echo $comp[str_replace("'","",$cbo_company_name)]; ?><b style="float:right; font-size:14px; font-weight:bold"> <?  echo '&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;';?>  </b></div>
    <div style="width:970px; font-size:14px; font-weight:bold" align="center"><b style="float:left"></b>Bill Of Materials (BOM) Report<b style="float:right; font-size:14px; font-weight:bold"> <? if($revised_no!=0) echo 'Revised No &nbsp;:'.$revised_no;else echo " &nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;";?>  &nbsp;  </b> </div>
	<?
	foreach ($data_array as $row)
	{	
		$order_price_per_dzn=0;
		$order_job_qnty=0;
		$ord_qty=0;
		$avg_unit_price=0;
		$order_values = $row[csf("ord_qty")]*$row[csf("avg_unit_price")];
		$result =sql_select("select po_number,pub_shipment_date,file_no,excess_cut,grouping from wo_po_break_down where job_no_mst=$txt_job_no $txt_po_breack_down_id_cond1 and status_active=1 and is_deleted=0 order by pub_shipment_date DESC");
		//$tot_row=count($result);
		$job_in_orders = '';$pulich_ship_date='';$job_in_ref = '';$job_in_file = '';
		$tot_excess_cut=0;$tot_row=0;
		foreach ($result as $val)
		{
			$job_in_orders .= $val[csf('po_number')].", ";
			$pulich_ship_date = $val[csf('pub_shipment_date')];
			if($val[csf('excess_cut')]>0)
			{
				$tot_row++;	
			}
			$tot_excess_cut+= $val[csf('excess_cut')];
			//$job_in_ref .= $val[csf('grouping')].", ";
			//$job_in_file .= $val[csf('file_no')].", ";
		//	if($job_in_ref=='') $job_in_ref= $val[csf('grouping')]; else $job_in_ref.=",". $val[csf('grouping')];
		//	if($job_in_file=='') $job_in_file= $val[csf('file_no')]; else $job_in_file.=",". $val[csf('file_no')];
		}
		$job_in_orders = substr(trim($job_in_orders),0,-1);
		//$sew_effi_percent=$row[csf("sew_effi_percent")];
		
		?>
            	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px" rules="all">
				<caption><? if($approved_no_row!=0) echo "<font color='red' style=' font-size:15px; font-weight:bold'>THIS JOB IS APPROVED</font> ";else "";?> </caption>
                	<tr>
                    	<td>Job No</td>
                        <td><b><? echo $row[csf("job_no")]; ?></b></td>
                        <td>Buyer</td>
                        <td><b><? echo $buyer_arr[$row[csf("buyer_name")]]; ?></b></td>
                        <td>Style Ref. No</td>
                        <td><b><? echo $row[csf("style_ref_no")]; ?></b></td>
						<td>Garments Item</td>
                        <td><b><? echo $grmnt_items; ?></b></td>
                    </tr>
                    <tr>
                        <td>Inco Term</td>
                        <td><b><? echo $incoterm[$row[csf("incoterm")]]; ?></b></td>
                    	<td>Costing for</td>
                        <td><b><? echo $costing_per[$row[csf("costing_per")]]; ?></b></td>
                      
                        <td>Sew. Effi. %</td>
                        <td><b><? echo $row[csf("sew_effi_percent")]; ?></b></td>
						<td>Order UOM</td>
                        <td><? echo $unit_of_measurement[$row[csf("order_uom")]]; ?></td>
                    </tr>
                </table>

            <?	
			if($row[csf("costing_per")]==1){$order_price_per_dzn=12;$costing_for=" DZN";}
			else if($row[csf("costing_per")]==2){$order_price_per_dzn=1;$costing_for=" PCS";}
			else if($row[csf("costing_per")]==3){$order_price_per_dzn=24;$costing_for=" 2 DZN";}
			else if($row[csf("costing_per")]==4){$order_price_per_dzn=36;$costing_for=" 3 DZN";}
			else if($row[csf("costing_per")]==5){$order_price_per_dzn=48;$costing_for=" 4 DZN";}
			$order_job_qnty=$row[csf("job_quantity")];
			$avg_unit_price=$row[csf("avg_unit_price")];
			$ord_qty=$row[csf("ord_qty")];
	}//end first foearch
	  $sql_po = "select a.job_no,a.company_name,a.set_smv , a.total_set_qnty,b.id as po_id,(b.plan_cut) as plan_cut,(b.po_quantity) as ord_qty,b.excess_cut,b.unit_price,b.po_total_price,b.po_number ,b.shiping_status,b.pub_shipment_date,b.is_confirmed ,b.insert_date,c.incoterm
			from wo_po_details_master a,wo_po_break_down b, wo_pre_cost_mst c 
			where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no  and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref "; 
			$po_data_array=sql_select($sql_po);
			foreach($po_data_array as $row)
			{
				$insert_date=explode(" ",$row[csf("insert_date")]);
				$insert_date=$insert_date[0];
				$po_wise_arr[$row[csf("po_id")]]['ord_qty']=$row[csf("ord_qty")]*$row[csf("total_set_qnty")];
				$po_wise_arr[$row[csf("po_id")]]['plan_cut']=$row[csf("plan_cut")];
				$po_wise_arr[$row[csf("po_id")]]['excess_cut']=$row[csf("excess_cut")];
				$po_wise_arr[$row[csf("po_id")]]['unit_price']=$row[csf("unit_price")];
				$po_wise_arr[$row[csf("po_id")]]['po_total_price']=$row[csf("po_total_price")];
				$po_wise_arr[$row[csf("po_id")]]['shiping_status']=$row[csf("shiping_status")];
				$po_wise_arr[$row[csf("po_id")]]['pub_shipment_date']=$row[csf("pub_shipment_date")];
				$po_wise_arr[$row[csf("po_id")]]['is_confirmed']=$row[csf("is_confirmed")];
				$po_wise_arr[$row[csf("po_id")]]['insert_date']=$insert_date;
				$po_wise_arr[$row[csf("po_id")]]['po_number']=$row[csf("po_number")];
				$po_wise_arr[$row[csf("po_id")]]['set_smv']=$row[csf("set_smv")];
				
				$incoterm_id=$row[csf("incoterm")];
				
			}
			?>
			<br/>
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px" rules="all">
				<caption> <b>Order Info </b></caption>
                	<thead>
                    	<th width="20">SL</th>
						<th width="80">Order No</th>
                        <th width="80">Order Qty(Pcs)</th>
                        <th width="60">Excess Cut %</th>
                        <th width="80">Plan Cut Qty</th>
                        <th width="60">Unit Price</td>
                        <th width="80">Order Value</th>
						<th width="60">SMV</th>
                        <th width="80">TTL SAH</th>
						<th width="80">Ship date</th>
						<th width="80">Insert date</th>
						<th width="80">Order Status</th>
						<th width="">Ship Status</th>
                    </tr>
					<?
					$p=1;$total_po_qty=$total_plan_cut_qty=$total_po_value=$total_ttl_sah=0;
					foreach($po_wise_arr as $poKey=>$val)
					{
					?>
                    <tr>
                        <td><? echo $p; ?></td>
						<td><p><? echo $val["po_number"]; ?></p></td>
                        <td align="right"><p><? echo number_format($val["ord_qty"],0); ?></p></td>
                    	<td align="right"><b><? echo $val["excess_cut"]; ?></p></td>
                        <td align="right"><p><? echo number_format($val["plan_cut"],0); ?></p></td>
                        <td align="right"><p><? echo number_format($val["unit_price"],3); ?></p></td>
                        <td align="right"><p><? echo  number_format($val["po_total_price"],2); ?></p></td>
						<td align="right"><p><? echo  number_format($val["set_smv"],3); ?></p></td>
                        <td align="right"><? $ttl_sah=($val["plan_cut"]*$val["set_smv"])/60; echo number_format($ttl_sah,2); ?></td>
						<td><p><? echo  date('d-M-y',strtotime($val["pub_shipment_date"])); //change_date_format?></p></td>
                        <td><p><? echo date('d-M-y',strtotime($insert_date)); ?></p></td>
                      
						<td><p><? echo $order_status[$val["is_confirmed"]]; ?></p></td>
                        <td><p><? echo $shipment_status[$val["shiping_status"]]; ?></p></td>
                    </tr>
					<?
					$p++;
					$total_po_qty+=$val["ord_qty"];
					$total_plan_cut_qty+=$val["plan_cut"];
					$total_po_value+=$val["po_total_price"];
					$total_ttl_sah+=$ttl_sah;
					//$total_ttl_sah+=$ttl_sah;
					//$total_ttl_sah+=$ttl_sah;
					}
					?>
					<tfoot>
					<th colspan="2">Job Total</th>
					<th align="right"><? echo number_format($total_po_qty,0); ?></th>
					<th align="right" title="Total ((Plan Cut-PO Qty)/Po Qty)*100"><? $excec_per=(($total_plan_cut_qty-$total_po_qty)/$total_po_qty)*100;echo  number_format($excec_per,0); ?></th>
					
					<th align="right"><? echo  number_format($total_plan_cut_qty,0); ?></th>
					<th align="right"><? $job_po_rate=$total_po_value/$total_po_qty;echo  number_format($job_po_rate,3); ?></th>
					<th align="right"><? echo  number_format($total_po_value,2); ?></th>
					<th align="right" title="Total TTL SAH*60/Plan Cuts"><?  $tot_smv=($total_ttl_sah*60)/$total_plan_cut_qty;echo  number_format($tot_smv,3); ?></th>
					<th align="right"><?  echo  number_format($total_ttl_sah,2); ?></th>
					<th align="right"><? //echo  number_format($total_po_qty,0); ?></th>
					<th align="right"><? //echo  number_format($total_po_qty,0); ?></th>
					<th><? //echo  number_format($total_po_qty,0); ?></th>
					<th><? //echo  number_format($total_po_qty,0); ?></th>
					</tfoot>
                </table>
				<br/>
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px" rules="all">
				<?
				$po_no=str_replace("'","",$txt_po_breack_down_id);
			$condition= new condition();
			if(str_replace("'","",$txt_job_no) !=''){
				  $condition->job_no("=$txt_job_no");
			 }
			 
			  if(str_replace("'","",$txt_po_breack_down_id)!='')
			 {
				$condition->po_id("in($po_no)"); 
			 }
			  $condition->init();
			//$yarn= new yarn($condition);
			
			
           $fabric= new fabric($condition);
		   //echo $fabric->getQuery(); die;
		  //$fabric_costing_arr=$fabric->getQtyArray_by_job_knitAndwoven_greyAndfinish_production();
		   $yarn= new yarn($condition);
			$yarn_costing_arr=$yarn->getJobWiseYarnAmountArray();
			$fabric= new fabric($condition);
			$fabric_costing_arr2=$fabric->getAmountArray_by_job_knitAndwoven_greyAndfinish();
			
			$fabric_qty_arr=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
			$fabric_amount_arr=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
				
			$conversion= new conversion($condition);
			$conversion_costing_arr_process=$conversion->getAmountArray_by_job();
			$trims= new trims($condition);
			//echo $trims->getQuery(); die;
			$trims_costing_arr=$trims->getAmountArray_by_job();
			$emblishment= new emblishment($condition);
			$emblishment_costing_arr=$emblishment->getAmountArray_by_job();
			$wash= new wash($condition);
			//echo $wash->getQuery(); die;
			$emblishment_costing_arr_wash=$wash->getAmountArray_by_job();
		    $commercial= new commercial($condition);
			$commercial_costing_arr=$commercial->getAmountArray_by_job();
			$commission= new commision($condition);
			$commission_costing_arr=$commission->getAmountArray_by_job();
			$other= new other($condition);
			$other_costing_arr=$other->getAmountArray_by_job();
			
			$job_no=str_replace("'","",$txt_job_no);
			//All Cost start here...
			///----------------AAA---------
			$ttl_conversion_cost=array_sum($conversion_costing_arr_process[$job_no]);
			$ttl_trims_cost=$trims_costing_arr[$job_no];
			$ttl_emblishment_cost=$emblishment_costing_arr[$job_no]+$emblishment_costing_arr_wash[$job_no];
			$ttl_commercial_cost=$commercial_costing_arr[$job_no];
			$ttl_commission_cost=$commission_costing_arr[$job_no];
			
			$ttl_cm_cost=$other_costing_arr[$job_no]['cm_cost'];
			$ttl_freight_cost=$other_costing_arr[$job_no]['freight'];
			$ttl_inspection_cost=$other_costing_arr[$job_no]['inspection'];
			$ttl_certificate_cost=$other_costing_arr[$job_no]['certificate_pre_cost'];
			$ttl_common_oh=$other_costing_arr[$job_no]['common_oh'];
			$ttl_currier_cost=$other_costing_arr[$job_no]['currier_pre_cost'];
			$ttl_lab_test_cost=$other_costing_arr[$job_no]['lab_test'];
			$ttl_depr_amor_pre_cost=$other_costing_arr[$job_no]['depr_amor_pre_cost'];
			$ttl_deffdlc_cost=$other_costing_arr[$job_no]['deffdlc_cost'];
			
			$ttl_other_cost=$ttl_cm_cost+$ttl_freight_cost+$ttl_inspection_cost+$ttl_certificate_cost+$ttl_common_oh+$ttl_currier_cost+$ttl_lab_test_cost+$ttl_depr_amor_pre_cost+$ttl_deffdlc_cost;
			//echo $ttl_conversion_cost.'='.$ttl_trims_cost.'='.$ttl_emblishment_cost.'='.$ttl_commercial_cost.'='.$ttl_commission_cost.'='.$ttl_other_cost;
			$ttl_total_cost=$ttl_conversion_cost+$ttl_trims_cost+$ttl_emblishment_cost+$ttl_commercial_cost+$ttl_commission_cost+$ttl_other_cost;
			$costing_per_unit_budget=$ttl_total_cost/$total_po_qty;
			
				
			$fab_knit_req_kg=$data_array[0][csf('fab_knit_req_kg')];
			$fab_knit_fin_req_kg=$data_array[0][csf('fab_knit_fin_req_kg')];
			$fab_woven_req_yds=$data_array[0][csf('fab_woven_req_yds')];
			$fab_woven_fin_req_yds=$data_array[0][csf('fab_woven_fin_req_yds')];
			$fab_yarn_req_kg=$data_array[0][csf('fab_yarn_req_kg')];
			$exchange_rate=$data_array[0][csf('exchange_rate')];
			$avg_unit_price=$data_array[0][csf('avg_unit_price')];
			$ship_mode=$data_array[0][csf('ship_mode')];
			$quotation_id=$data_array[0][csf('quotation_id')];
			$costing_date=$data_array[0][csf('costing_date')];
			$gsm_weights_top=implode(",",array_unique(explode(",",$gsm_weight_top)));
			//$gsm_weight_bottom=implode(",",array_unique(explode(",",$gsm_weight_bottom)));
			//if($gsm_weights_top!='') $gsm_weightTop=$gsm_weights_top;else $gsm_weightTop='';
			
						//echo $gsm_weightTop .$gsm_weightBottom;
				?>
                	<tr>
                    	<td>Knit Fabric Cons</td>
                        <td align="right" ><b><? echo $fab_knit_req_kg; ?></b></td>
                        <td>Woven Fab. Cons	</td>
                        <td align="right" ><b><? echo $fab_woven_req_yds; ?></b></td>
                        <td>Quotation Id</td>
                        <td><b><? echo $quotation_id; ?></b></td>
						<td>Costing Date</td>
                        <td><b><? echo  date('d-M-y',strtotime($costing_date)); ?></b></td>
                    </tr>
                    <tr>
                        <td>Avg Yarn Req</td>
                        <td align="right"><b><? echo $fab_yarn_req_kg; ?></b></td>
                    	<td>Woven Fin Fabric Cons</td>
                        <td align="right" ><b><? echo $fab_woven_fin_req_yds; ?></b></td>
                      
                        <td>Exchange Rate</td>
                        <td align="right" ><b><? echo $exchange_rate; ?></b></td>
						<td>Avg Unit Price</td>
                        <td align="right" ><? echo number_format($avg_unit_price,3); ?></td>
                    </tr>
					 <tr>
                        <td>Knit Fin Fab. Cons </td>
                        <td align="right"><b><? echo $fab_knit_fin_req_kg; ?></b></td>
                    	<td>Incoterm</td>
                        <td><b><? echo $incoterm[$incoterm_id]; ?></b></td>
                      
                        <td>Ship Mode</td>
                        <td><b><? echo $shipment_mode[$ship_mode]; ?></b></td>
						<td>Cost Per Unit As Budget</td>
                        <td align="right"  title="Total Cost<? echo $ttl_total_cost;?>/Total PO Qty Pcs"><? echo number_format($costing_per_unit_budget,3); ?></td>
                    </tr>
					<tr>
						<td><b> SMV % (As 1st App) : &nbsp;<? echo $sew_smv;?></b></td>
						<td><b> Efficiency %(As 1st App) :&nbsp;<? echo $sew_effi_percent;?> </b></td>
						<td align="right" colspan="3">Net Pft/Loss %(As 1st App)</td>
                        <td align="right" ><b><? echo $opert_profitloss_percent;?></b></td>
                    	<td title="Total Cost/Total PO Qty">Net Profit/Loss %</td>
                        <td align="right" ><b>
						<? 
						$operatin_profit_loss_per=(($avg_unit_price-$costing_per_unit_budget)/$avg_unit_price)*100;
						echo number_format($operatin_profit_loss_per,2);
						 ?>
                        </b>
                        </td>
					</tr>
                </table>
				
			<?
			
	//$ttl_commercial_cost=$commercial_costing_arr[$job_no];
		//2 Fabric Cost part here------------------------------------------- 	   	
	$sql = "select id, job_no,item_number_id,gsm_weight, uom,body_part_id, fab_nature_id, color_type_id, fabric_description, avg_cons, fabric_source, rate, amount,avg_finish_cons,status_active from wo_pre_cost_fabric_cost_dtls 
			where job_no=".$txt_job_no."";
		$data_array=sql_select($sql);
		
		$knit_fab="";$woven_fab=""; 
		$knit_subtotal_amount=0;
		$woven_subtotal_amount=0;$knit_subtotal_amount_dzn=0;$knit_subtotal_amount_kg=0;$woven_subtotal_amount_dzn=0;$woven_subtotal_amount_kg=$knit_subtotal_avg_cons_dzn=$knit_subtotal_avg_finish_cons_dzn=0;
        $i=2;$j=2;
		foreach( $data_array as $row )
        {
			    $set_item_ratio=return_field_value("set_item_ratio"," wo_po_details_mas_set_details", "job_no='".$row[csf('job_no')]."' and gmts_item_id='".$row[csf('item_number_id')]."'");
			 
			   $fincons=0;
			   $greycons=0;
			   $order_qty_fab=0;
			   $fab_dtls_data=sql_select("select po_break_down_id,color_number_id,gmts_sizes,cons,requirment from wo_pre_cos_fab_co_avg_con_dtls where pre_cost_fabric_cost_dtls_id=".$row[csf("id")]." $txt_po_breack_down_id_cond2 and cons !=0");
			   foreach($fab_dtls_data as $fab_dtls_data_row )
			   {
					 $sql_po_qty_fab=sql_select("select sum(c.plan_cut_qnty) as order_quantity  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and  b.id=".$fab_dtls_data_row[csf('po_break_down_id')]." and c.item_number_id='".$row[csf('item_number_id')]."' and size_number_id='".$fab_dtls_data_row[csf('gmts_sizes')]."' and  color_number_id= '".$fab_dtls_data_row[csf('color_number_id')]."' and a.status_active=1 and b.status_active=1 and c.status_active=1");
					 list($sql_po_qty_row_fab)=$sql_po_qty_fab;
	                 $po_qty_fab=$sql_po_qty_row_fab[csf('order_quantity')];
					 $order_qty_fab+=$po_qty_fab;
			   }
			$knit_cost_dzn=$row[csf("amount")];$woven_cost_dzn=$row[csf("amount")];
			if($row[csf("fab_nature_id")]==2)//knit fabrics
			{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				$fincons=$fabric_qty_arr['knit']['finish'][$row[csf("id")]][$row[csf("uom")]];
			    $greycons=$fabric_qty_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$row[csf("amount")]=$fabric_amount_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];
 				$i++;	
                $knit_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="right">'.$row[csf("gsm_weight")].'</td>
					<td align="right">'.number_format($row[csf("avg_cons")],3).'</td>
					<td align="right">'.number_format($greycons,2).'</td>
 					<td align="right">'.number_format($row[csf("avg_finish_cons")],3).'</td>
					<td align="right">'.number_format($fincons,2).'</td>
                    <td align="right">'.$unit_of_measurement[$row[csf("uom")]].'</td>
					<td align="right">'.number_format($row[csf("rate")],3).'</td>
                    <td align="right">'.number_format($knit_cost_dzn,2).'</td>
					<td align="right">'.number_format($row[csf("amount")],2).'</td> 
					<td align="right">'.number_format((($row[csf("amount")]/$total_po_value)*100),2).'</td> 
                </tr>';	
				$knit_subtotal_avg_cons_dzn+=$row[csf("avg_cons")];
				$knit_subtotal_avg_cons+=$greycons;
				$knit_subtotal_avg_finish_cons+=$fincons;
				$knit_subtotal_avg_finish_cons_dzn+=$row[csf("avg_finish_cons")];
            	$knit_subtotal_amount+=$row[csf("amount")];
				$knit_subtotal_amount_dzn+=$knit_cost_dzn;
				$knit_subtotal_amount_kg=$knit_subtotal_amount/$knit_subtotal_amount_dzn;
			}			
			if($row[csf("fab_nature_id")]==3)//woven fabrics
			{
				$fincons=$fabric_qty_arr['woven']['finish'][$row[csf("id")]][$row[csf("uom")]];
			    $greycons=$fabric_qty_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$row[csf("amount")]=$fabric_amount_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				$j++;
                 $woven_fab .= '<tr>
                    <td align="left">'.$item_descrition.'</td>
                    <td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
                    <td align="center">'.$row[csf("gsm_weight")].'</td>
					<td align="right">'.number_format($row[csf("avg_cons")],3).'</td>
					<td align="right">'.number_format($greycons,2).'</td>
					<td align="right">'.number_format($row[csf("avg_finish_cons")],3).'</td>
 					<td align="right">'.number_format($fincons,2).'</td>
                    <td align="right">'.$unit_of_measurement[$row[csf("uom")]].'</td>
					<td align="right">'.number_format($row[csf("rate")],3).'</td>
					<td align="right">'.number_format($woven_cost_dzn,2).'</td>
                    <td align="right">'.number_format($row[csf("amount")],2).'</td> 
					<td align="right">'.number_format((($row[csf("amount")]/$total_po_value)*100),2).'</td> 
                </tr>';	
				$woven_subtotal_avg_cons+=$greycons;
				$woven_subtotal_avg_cons_dzn+=$row[csf("avg_cons")];
				$woven_subtotal_avg_finish_cons+=$fincons;
				$woven_subtotal_avg_finish_cons_dzn+=$row[csf("avg_finish_cons")];
				$woven_subtotal_amount+=$row[csf("amount")];
				$woven_subtotal_amount_dzn+=$woven_cost_dzn;
				$woven_subtotal_amount_kg=$woven_subtotal_amount/$woven_subtotal_amount_dzn;
			}
        }	
	 
		$knit_fab= '<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">		
					
					
					<label  style="float:left;background:#CCCCCC;font-size:larger;"><b>All Fabric Cost </b> </label>	
							
						<tr style="font-weight:bold"  align="center">
							<td width="80" rowspan="'.$i.'" ><div class="verticalText"><b>Knit Fabric</b></div></td>
							<td width="300">Description</td>
							<td width="100">Source</td>
							<td width="50">GSM</td>
							<td width="100">Fab. Cons/ Dzn</td>
							<td width="100">Gray Fabric Qnty</td>
							<td width="100">Finish Cons/ Dzn</td>
							<td width="100">Finish Fab Qnty</td>
							<td width="50">UOM</td>
 							<td width="50">Rate</td>
							<td width="50">Amount/ Dzn</td>
							<td width="50">TTL Amount</td>
							<td width="50">% to Ord. Value</td>
						</tr>'.$knit_fab;
		$woven_fab = '<tr>
						<td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;	
						
		//knit fabrics table here 
		$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="3">Knit Total</td>
						<td align="right">'.number_format($knit_subtotal_avg_cons_dzn,3).'</td>
						<td align="right">'.number_format($knit_subtotal_avg_cons,2).'</td>
						<td align="right">'.number_format($knit_subtotal_avg_finish_cons_dzn,3).'</td>
						<td align="right">'.number_format($knit_subtotal_avg_finish_cons,2).'</td>
						<td align="right"></td>
						<td align="right"></td>
						<td align="right">'.number_format($knit_subtotal_amount_dzn,2).'</td>
						<td align="right">'.number_format($knit_subtotal_amount,2).'</td>
						<td align="right">'.number_format((($knit_subtotal_amount/$total_po_value)*100),2).'</td> 
					</tr>';
  		echo $knit_fab;
		//woven fabrics table here 
		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="3">Woven Total</td>
						<td align="right">'.number_format($woven_subtotal_avg_cons_dzn,3).'</td>
						<td align="right">'.number_format($woven_subtotal_avg_cons,2).'</td>
						<td align="right">'.number_format($woven_subtotal_avg_finish_cons_dzn,3).'</td>
						<td align="right">'.number_format($woven_subtotal_avg_finish_cons,2).'</td>
						<td align="right"></td>
						<td align="right"></td>
						<td align="right">'.number_format($woven_subtotal_amount_dzn,2).'</td>
						<td align="right">'.number_format($woven_subtotal_amount,2).'</td>
						<td align="right">'.number_format((($woven_subtotal_amount/$total_po_value)*100),2).'</td> 
					</tr>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="3">Fabric Total</td>
						<td align="right"></td>
						<td align="right">'.number_format($knit_subtotal_avg_cons_dzn+$woven_subtotal_avg_cons_dzn,3).'</td>
						<td align="right">'.number_format($knit_subtotal_avg_cons+$woven_subtotal_avg_cons,2).'</td>
						<td align="right">'.number_format($knit_subtotal_avg_finish_cons_dzn+$woven_subtotal_avg_finish_cons_dzn,3).'</td>
						<td align="right">'.number_format($knit_subtotal_avg_finish_cons+$woven_subtotal_avg_finish_cons,2).'</td>
						<td align="right"></td>
						<td align="right"></td>
						<td align="right">'.number_format($knit_subtotal_amount_dzn+$woven_subtotal_amount_dzn,2).'</td>
						<td align="right">'.number_format($knit_subtotal_amount+$woven_subtotal_amount,2).'</td>
						<td align="right">'.number_format((((knit_subtotal_amount+$woven_subtotal_amount)/$total_po_value)*100),2).'</td> 
					</tr>
   					</table></div>';
      	  echo $woven_fab;           		
				//end 	All Fabric Cost part report-------------------------------------------
			$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count"  );
				 $sql = "select min(id) as id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, color,type_id, min(cons_ratio) as cons_ratio, sum(cons_qnty) as cons_qnty, rate, sum(amount) as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no=".$txt_job_no." group by count_id, copm_one_id, percent_one, copm_two_id, percent_two, color,type_id, rate";
				 
		        $data_array=sql_select($sql); 
				$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
				//print_r($yarn_data_array);
			
		?>
        <div style="margin-top:15px">
        	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">
		
			<label  style="float:left;background:#CCCCCC; font-size:larger;"><b>Yarn Cost </b> </label>	
                <tr style="font-weight:bold">
                   
                    <td width="350">Yarn Desc</td>
                    <td width="80">Yarn Qnty/Dzn</td> 
					<td width="80">TTL Yarn Qnty</td>
                 
                    <td width="80">Rate</td>
                    <td width="80">Amount/Dzn</td>
					<td width="80">TTL Amount</td>
					<td width="">% to Ord. Value</td>
                </tr>
			<?
			$total_yarn_qty = 0;
            $total_yarn_amount = 0; $total_yarn_cost_dzn=$total_yarn_qty_dzn=0; $total_yarn_cost_kg=0; $total_yarn_avg_cons_qty=0;
			foreach( $data_array as $row )
            { 
				if($row[csf("percent_one")]==100)
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
            	else
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
 				$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
				$rowavgcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
				$rowamount = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];
			?>	 
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="right"><? echo number_format($row[csf("cons_qnty")],3); ?></td>
					<td align="right"><? echo number_format($rowcons_qnty,2); ?></td>
                   
                    <td align="right"><? echo number_format($row[csf("rate")],3); ?></td>
					<td align="right"><? echo number_format($row[csf("amount")],2); ?></td>
                    <td align="right"><? echo number_format($rowamount,2); ?></td>
					<td align="right"><? echo number_format(($rowamount/$total_po_value)*100,2); ?></td>
                </tr>
            <?  
			      $total_yarn_qty+=$rowcons_qnty;
				  $total_yarn_qty_dzn+=$row[csf("cons_qnty")];
				  $total_avg_yarn_qty+=$rowavgcons_qnty;
				  $total_yarn_amount +=$rowamount;
				  $total_yarn_cost_dzn+=$row[csf("amount")];
				  $total_yarn_avg_cons_qty+=$rowavgcons_qnty;
				  $total_yarn_cost_kg=$total_yarn_amount/$total_yarn_qty;
            }
            ?>
            	<tr class="rpt_bottom" style="font-weight:bold">
                    <td>Yarn Total</td>
                    <td align="right"><? echo number_format($total_yarn_qty_dzn,3); ?></td>
					<td align="right"><? echo number_format($total_yarn_qty,2); ?></td>
                    
                    <td></td>
					<td align="right"><? echo number_format($total_yarn_cost_dzn,3); ?></td>
                    <td align="right"><? echo number_format($total_yarn_amount,2); ?></td>
					<td align="right"><? echo number_format(($total_yarn_amount/$total_po_value)*100,2); ?></td>
                </tr>
        	</table>
      </div>
      <?
		//End Yarn Cost part report here -------------------------------------------
		
		//start	Conversion Cost to Fabric report here -------------------------------------------
		$sql_count = "select a.cons_process as cons_process from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id where a.job_no=".$txt_job_no." group by a.cons_process order by  a.cons_process";
		$tot_data_array=sql_select($sql_count);
		foreach( $tot_data_array as $row ){
				 $process_id=$row[csf("cons_process")];
				 $process_row+=count($row[csf("cons_process")]);
		 }
		 $sql = "select a.id,a.fabric_description as pre_cost_fabric_cost_dtls_id, a.job_no, a.cons_process, a.req_qnty, a.charge_unit,a.amount,a.color_break_down, a.status_active,b.body_part_id,b.uom ,b.fab_nature_id,b.color_type_id,b.fabric_description,b.item_number_id from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id where a.job_no=".$txt_job_no." order by  a.cons_process";
		 $data_array=sql_select($sql);
 	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">
			
			<label  style="float:left;background:#CCCCCC; font-size:larger"><b>Conversion Cost to Fabric </b> </label>	
                <tr style="font-weight:bold">
                    <td width="230">Particulars</td>
                    <td width="110">Process</td>
                    <td width="60">Cons/Dzn</td>
					<td width="80">TTL Required</td>
					<td width="60">Uom</td>
                   
                    <td width="60">Rate</td>
					<td width="70">Amount/Dzn</td>
                    <td width="80">TTL Amount</td>
					<td width="60">% to Ord. Value</td>
                </tr>
            <?
			$conv_data_qty=$conversion->getQtyArray_by_conversionid();
			$conv_data_amt=$conversion->getAmountArray_by_conversionid();
	
            $total_conversion_cost=$total_convsion_qty_dzn=$total_conversion_cost_dzn=0;$total_conversion_cost_dzn=0;$total_conversion_cost_kg=0;
			$total_convsion_qty=0;
			$total_avg_convsion_qty=0;$grand_total_conv_qnty=0;$grand_total_avg_convsion_qty=$grand_total_conversion_cost_dzn=$grand_total_avg_convsion_qty_dzn=0;$grand_total_conversion_cost=0;
			$process_array_check=array();$k=1;
            foreach( $data_array as $row )
            { 
			
				$convsion_qty=$conv_data_qty[$row[csf('id')]][$row[csf('uom')]];
				$conversion_cost=$conv_data_amt[$row[csf('id')]][$row[csf('uom')]];
				
				if($row[csf("pre_cost_fabric_cost_dtls_id")] ==0)
				{
				$item_descrition = "All Fabrics";
				}
				else
				{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				}
				
				$process_id=$row[csf("cons_process")];
				if (!in_array($process_id,$process_array_check) )
						{
							if($k!=1)
							{
								?>
                               <tr>
                                    <td>&nbsp;</td>
                                    <td><strong>Process Total </strong></td>
                                    <td align="right"><strong><? echo number_format($total_convsion_qty_dzn,3); ?></strong></td>
									<td align="right"><strong><? echo number_format($total_convsion_qty,2); ?></strong></td>
									<td align="right"><strong><? //echo number_format($total_convsion_qty,4); ?></strong></td>
                                   
                                    <td>&nbsp;</td>
									<td align="right"><strong><? echo number_format($total_conversion_cost_dzn,3); ?></strong></td>
                                    <td align="right"><strong><? echo number_format($total_conversion_cost,2); ?></strong></td>
									<td align="right"><? echo number_format(($total_conversion_cost/$total_po_value)*100,2); ?></td>
                                </tr>
                                <?
							}
							?>
                            <?
							unset($total_convsion_qty_dzn);unset($total_conversion_cost_dzn);
							unset($total_convsion_qty);
							unset($total_avg_convsion_qty);
							unset($total_conversion_cost);
							unset($total_convsion_qty_dzn);
							$process_array_check[]=$process_id; 
							$k++;    
						}
			?>	 
                <tr>
                    <td align="left"><? echo $item_descrition; ?></td>
                    <td align="left"><? echo $conversion_cost_head_array[$row[csf("cons_process")]]; ?></td>
                    <td align="right"><? echo number_format($row[csf("req_qnty")],3); ?></td>
					<td align="right"><? echo number_format($convsion_qty,2); ?></td>
					<td align="right"><? echo  $unit_of_measurement[$row[csf('uom')]]; ?></td>
                  
                    <td align="right"><? echo number_format($row[csf("charge_unit")],3); ?></td>
					<td align="right"><? echo number_format($row[csf('amount')],2); ?></td>
                    <td align="right"><? echo number_format($conversion_cost,2); ?></td>
					<td align="right"><? echo number_format(($conversion_cost/$total_po_value)*100,2); ?></td>
                </tr>
            <?
				$total_convsion_qty+=$convsion_qty;
				$total_convsion_qty_dzn+=$row[csf("req_qnty")];
				$total_avg_convsion_qty+=$row[csf("req_qnty")];
				$total_conversion_cost += $conversion_cost;
			//	$total_conversion_cost_dzn += $row[csf('amount')];
				$grand_total_conv_qnty+=$convsion_qty;
				$grand_total_avg_convsion_qty+=$convsion_qty;
				$grand_total_avg_convsion_qty_dzn+=$row[csf("req_qnty")];
				$grand_total_conversion_cost+= $conversion_cost;
				$grand_total_conversion_cost_dzn+= $row[csf('amount')];
				$total_conversion_cost_dzn+=$row[csf('amount')];
				$total_conversion_cost_kg=$grand_total_conversion_cost/$total_avg_yarn_qty;//$grand_total_avg_convsion_qty;
           	 }
            ?>
            <tr class="rpt_bottom" style="font-weight:bold">
                <td>&nbsp;</td>
                <td align="right">Process Total</td>
                <td align="right"><? echo number_format($total_convsion_qty_dzn,3); ?></td>
				 <td align="right"><? echo number_format($total_convsion_qty,2); ?></td>
				 <td align="right"><? //echo number_format($total_convsion_qty,4); ?></td>
                
                <td>&nbsp;</td> 
				<td align="right"><? echo number_format($total_conversion_cost_dzn,3); ?></td>                   
                <td align="right"><? echo number_format($total_conversion_cost,2); ?></td>
				<td align="right"><? echo number_format(($total_conversion_cost/$total_po_value)*100,2); ?></td>
            </tr>   
            <tr class="rpt_bottom" style="font-weight:bold">
                <td colspan="2" align="right">Conversion Total</td>
                <td align="right"><? echo number_format($grand_total_avg_convsion_qty_dzn,3); ?></td>
				<td align="right"><? echo number_format($grand_total_conv_qnty,2); ?></td>
				<td align="right"><? //echo number_format($grand_total_conv_qnty,4); ?></td>
               
                <td>&nbsp;</td> 
				 <td align="right"><? echo number_format($grand_total_conversion_cost_dzn,3); ?></td>                
                <td align="right"><? echo number_format($grand_total_conversion_cost,2); ?></td>
				<td align="right"><? echo number_format(($grand_total_conversion_cost/$total_po_value)*100,2); ?></td>
            </tr>     
			  <tr class="rpt_bottom" style="font-weight:bold">
			  	<td>Total Fabric Cost</td>
                <td align="right" colspan="5">Previous Fabric cost/Dzn (As 1st Approval) : <? echo number_format($fabric_cost_percent,4); ?> </td>
				<td align="right" title="Fabric Cost+Yarn+Conversion(Dzn)"><? $total_fab_cost_dzn=$knit_subtotal_amount_dzn+$woven_subtotal_amount_dzn+$total_yarn_cost_dzn+$grand_total_conversion_cost_dzn;echo number_format($total_fab_cost_dzn,2); ?></td>
				<td align="right"><? $all_fab_cost=$knit_subtotal_amount+$woven_subtotal_amount+$total_yarn_amount+$grand_total_conversion_cost; echo number_format($all_fab_cost,2); ?></td>
				<td align="right"><? echo number_format(($all_fab_cost/$total_po_value)*100,2); ?></td>
			  </tr>           
            </table>
      </div>
      <?
	//End Conversion Cost to Fabric report here -------------------------------------------
	
	
	
	//start	Trims Cost part report here -------------------------------------------
	$supplier_library_fabric=return_library_array( "select a.id, a.supplier_name from lib_supplier a where a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
	
    	$sql = "select id, job_no, trim_group,description,brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp,status_active from wo_pre_cost_trim_cost_dtls  where job_no=".$txt_job_no."";
		$data_array=sql_select($sql);
 	?>
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">
           
			<label  style="float:left;background:#CCCCCC; font-size:larger"><b>Trims Cost</b> </label>	
                <tr style="font-weight:bold">
                    <td width="110">Item Group</td>
                    <td width="150">Description</td>
					<td width="100">Nominated Supp</td>
                    <td width="100">Brand/Supp Ref</td>
                    <td width="60">UOM</td>
                    <td width="80">Cons/Dzn</td>
					<td width="100">TTL Required</td>
                    <td width="80">Rate</td>
                    <td width="80">Amount/Dzn</td>
					<td width="80">Amount</td>
					<td width="60">% to Ord. Value</td>
                </tr>
            <?
			$trim_qty_arr=$trims->getQtyArray_by_precostdtlsid();
			//print_r($trim_qty);
			$trim_amount_arr=$trims->getAmountArray_precostdtlsid();
            $total_trims_cost=0;  $total_trims_qty=$total_trims_cost_dzn=0;$total_trims_cost_dzn=0;$total_trims_cost_kg=0;
            foreach( $data_array as $row ){ 
				
				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row[csf("trim_group")], "id", "item_name" ); 
				$cons_dzn_gmts= $row[csf("cons_dzn_gmts")];
				$amount_dzn= $row[csf("amount")];
				$pre_trims_qty=$trim_qty_arr[$row[csf("id")]];
				$pre_trims_amount=$trim_amount_arr[$row[csf("id")]];           	 
			?>	 
                <tr>
                    <td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
                    <td align="left"><? echo $row[csf("description")]; ?></td>
                    <td align="left"><? echo $supplier_library_fabric[$row[csf("nominated_supp")]]; ?></td>
					<td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
                    <td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
                    <td align="right"><? echo number_format($cons_dzn_gmts,3); ?></td>
					<td align="right"><? echo number_format($pre_trims_qty,2); ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],3); ?></td>
					 <td align="right"><? echo number_format($amount_dzn,2); ?></td>
                    <td align="right"><? echo number_format($pre_trims_amount,2); ?></td>
					<td align="right"><? echo number_format(($pre_trims_amount/$total_po_value)*100,2); ?></td>
                </tr>
            <?
                 $total_trims_cost += $pre_trims_amount;
				 $total_trims_cost_dzn += $amount_dzn;
				  $total_trims_qty += $pre_trims_qty;
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Trims Total</td>
					<td colspan="7">Previous Trims cost/Dzn (As 1st Approval)=<? echo $trims_cost_percent;?></td>                   
                    
					<td align="right"><? echo number_format($total_trims_cost_dzn,2); ?></td>
					<td align="right"><? echo number_format($total_trims_cost,2); ?></td>
					<td align="right"><? echo number_format(($total_trims_cost/$total_po_value)*100,2); ?></td>
                </tr>                
            </table>
      </div>
      <?
	 //End Trims Cost Part report here -------------------------------------------	
	 
	 //start	Embellishment Details part report here -------------------------------------------
	 
		$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no."";
		$data_array=sql_select($sql);
	?> 
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">
         
			<label  style="float:left;background:#CCCCCC; font-size:larger"><b>Embellishment Cost</b> </label>	
                <tr style="font-weight:bold">
                    <td width="170">Particulars</td>
                    <td width="170">Type</td>
                    <td width="100">Cons/Dzn</td>
					<td width="120">TTL Gmts. Qnty</td>
                    <td width="80">Rate</td>
					<td width="100">Amount/Dzn</td>
                    <td width="120">TTL Amount</td>
					<td width="100">% to Ord. Value</td>
                 </tr>
            <?
			$emblishment_qty_arr=$emblishment->getQtyArray_by_jobAndEmblishmentid();
			
			$emblishment_amount_arr=$emblishment->getAmountArray_by_jobAndEmblishmentid();
			$wash_qty_arr=$wash->getQtyArray_by_jobAndEmblishmentid();
			$wash_amount_arr=$wash->getAmountArray_by_jobAndEmblishmentid();
			
            $total_embellishment_amt=0;$total_embellishment_amt_dzn=0;  
            foreach( $data_array as $row )
            {
				$em_type =""; 
				//$total_embellishment_amt_dzn += $row[csf("amount")];
				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
 				if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
				//$row[csf("cons_dzn_gmts")] = $row[csf("cons_dzn_gmts")]/$order_price_per_dzn*$order_job_qnty;
				//$row[csf("amount")] = $row[csf("amount")]/$order_price_per_dzn*$order_job_qnty;
				if($row[csf("emb_name")] !=3){
					$embl_cons_gmts=$emblishment_qty_arr[$row[csf("job_no")]][$row[csf("id")]];
					$embl_amount=$emblishment_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
				}
				else if($row[csf("emb_name")] ==3){
					$embl_cons_gmts=$wash_qty_arr[$row[csf("job_no")]][$row[csf("id")]];
					$embl_amount=$wash_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
				}
				
			?>	 
                <tr>
                    <td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
                    <td align="left"><? echo $em_type; ?></td>
                    <td align="right"><? echo number_format($row[csf("cons_dzn_gmts")],3); ?></td>
					<td align="right"><? echo number_format($embl_cons_gmts,0); ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],3); ?></td>
					<td align="right"><? echo number_format($row[csf("amount")],2); ?></td>
                    <td align="right"><? echo number_format($embl_amount,2); ?></td>
					<td align="right"><? echo number_format(($embl_amount/$total_po_value)*100,2); ?></td>
                </tr>
            <?
                 $total_embellishment_amt += $embl_amount;
				 $total_embellishment_amt_dzn += $row[csf("amount")];
				 $total_embellishment_qty += $embl_cons_gmts;
				  $total_embellishment_qty_dzn += $row[csf("cons_dzn_gmts")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Embellishment Total</td> 
					<td colspan="2">Previous Embel.cost/Dzn(As 1st Approval)=<? echo $embel_cost_percent;?></td>                    
                    <td align="right"><? echo number_format($total_embellishment_qty,0); ?></td>
					<td align="right"><? //echo number_format($total_embellishment_qty,4); ?></td>
					<td align="right"><? echo number_format($total_embellishment_amt_dzn,2); ?></td>
					<td align="right"><? echo number_format($total_embellishment_amt,2); ?></td>
					<td align="right"><? echo number_format(($total_embellishment_amt/$total_po_value)*100,2); ?></td>
                </tr>                
            </table>
      </div>
      <?
	 //End Embellishment Details Part report here -------------------------------------------	
	 //start	Commercial Cost part report here -------------------------------------------
   	$sql = "select id, job_no, item_id, rate, amount, status_active from  wo_pre_cost_comarci_cost_dtls  where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	?> 
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">
           
			<label  style="float:left;background:#CCCCCC; font-size:larger"><b>Commercial Cost</b> </label>	

                <tr style="font-weight:bold">
                    <td width="250">Particulars</td>
                    
					<td width="100">Rate</td>
					<td width="200">Amount/Dzn</td>
                    <td width="100">TTL Amount</td>
					<td width="100">% to Ord. Value</td>
                 </tr>
            <?
			$commarcial_amount=$commercial->getAmountArray_by_jobAndPrecostdtlsid();
            $total_commercial_cost=0;$total_commercial_cost_dzn=0;
            foreach( $data_array as $row )
            { 
				$total_commercial_cost_dzn+= $row[csf("amount")];
				$amount = $commarcial_amount[$row[csf("job_no")]][$row[csf("id")]];;
  			?>	 
                <tr>
                    <td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
                    <td align="right"><? echo number_format($row[csf("rate")],3); ?></td>
					<td align="right"><? echo number_format($row[csf("amount")],2); ?></td>
					<td align="right"><? echo number_format($amount,2); ?></td>
					<td align="right"><? echo number_format(($amount/$total_po_value)*100,2); ?></td>
                </tr>
            <?
                 $total_commercial_cost_dzn += $row[csf("amount")];
				  $total_commercial_cost += $amount;
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Commercial Total</td>                    
					<td align="right" colspan="2">Previous Commercial/Dzn (As 1st Approval)=<?  echo number_format($comm_cost_percent,4); ?></td>
					<td align="right"><? echo number_format($total_commercial_cost,2); ?></td>
					<td align="right"><? echo number_format(($total_commercial_cost/$total_po_value)*100,2); ?></td>
                </tr>                
            </table>
      </div>
      <?
	 //End Commercial Cost Part report here -------------------------------------------	
  
  	//start	Commission Cost part report here -------------------------------------------
   	$sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls  where job_no=".$txt_job_no."";
	$data_array=sql_select($sql);
	?> 
        <div style="margin-top:15px">
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">
          
			<label  style="float:left;background:#CCCCCC; font-size:larger"><b>Commission Cost</b> </label>	
                <tr style="font-weight:bold">
                    <td width="250">Particulars</td>
                    <td width="250">Commission Basis</td>
                    <td width="100">Rate</td>
					<td width="100">Amount/Dzn</td>
                    <td width="100">TTL Amount</td>
					<td width="100">% to Ord. Value</td>
                 </tr>
            <?
			$commission_amount_arr=$commission->getAmountArray_by_jobAndPrecostdtlsid();
            $total_commission_cost=0;   $total_commission_cost_dzn=0;
            foreach( $data_array as $row )
            { 
				$commission_amount = $commission_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
  			?>	 
                <tr>
                    <td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
                    <td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
                    <td align="right"><? echo number_format($row[csf("commision_rate")],3); ?></td>
					 <td align="right"><? echo number_format($row[csf("commission_amount")],2); ?></td>
                    <td align="right"><? echo number_format($commission_amount,2); ?></td>
					<td align="right"><? echo number_format(($commission_amount/$total_po_value)*100,2); ?></td>
                </tr>
            <?
                 $total_commission_cost += $commission_amount;
				 $total_commission_cost_dzn+=$row[csf("commission_amount")];
				 $total_commission_cost_dzn+=$row[csf("commission_amount")];
            }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Commission Total</td>
					<td colspan="2">Previous Commission/Dzn (As 1st Approval)=<? echo $commission_percent;?></td>                    
					<td align="right"><? echo number_format($total_commission_cost_dzn,2); ?></td>
					<td align="right"><? echo number_format($total_commission_cost,2); ?></td>
					<td align="right"><? echo number_format(($total_commission_cost/$total_po_value)*100,2); ?></td>
                </tr>                
            </table>
      </div>
		<br/>
		  <?
	//start	Other Components part report here -------------------------------------------
   	$sql = "select id,job_no,costing_per_id,order_uom_id,fabric_cost,fabric_cost_percent,trims_cost,depr_amor_pre_cost,deffdlc_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,incometax_cost,interest_cost,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,currier_pre_cost, currier_percent,certificate_pre_cost, certificate_percent, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche  from wo_pre_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	?> 
         <div style="margin-top:15px">
         <table>
         <tr>
         <td>
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:620px;text-align:center;" rules="all">
            
			<label  style="background:#CCCCCC; font-size:larger"><b style="float:left;background:#CCCCCC;">Others Cost</b> </label>	
                <tr style="font-weight:bold">
                    <td width="220">Particulars</td>
                    <td width="100"> Cost/Dzn (As 1st Approval)</td>
					<td width="100">Amount/Dzn</td>
					<td width="100">TTL Amount</td>
					<td width="100">% to Ord. Value</td>
                 </tr>
            <?
            $total_other_components=0;$lab_test_dzn=0;
			$lab_test = 0;
			$inspection = 0;
			$cm_cost = 0;
			$freight = 0;
			$common_oh = 0;
           foreach( $data_array as $row )
           { 
				$job_no=$row[csf("job_no")];
				$cm_cost=$other_costing_arr[$row[csf("job_no")]]['cm_cost'];
				$freight_cost=$other_costing_arr[$job_no]['freight'];
				$inspection_cost=$other_costing_arr[$job_no]['inspection'];
				$certificate_cost=$other_costing_arr[$job_no]['certificate_pre_cost'];
				$common_oh=$other_costing_arr[$job_no]['common_oh'];
				$currier_cost=$other_costing_arr[$job_no]['currier_pre_cost'];
				$lab_test_cost=$other_costing_arr[$job_no]['lab_test'];
				$depr_amor_pre_cost=$other_costing_arr[$job_no]['depr_amor_pre_cost'];
				$deffdlc_cost=$other_costing_arr[$job_no]['deffdlc_cost'];
				//$freight = $freight_cost;
				//$common_oh = $common_oh;
				//$currier_pre_cost = $currier_cost;
				//$certificate_pre_cost = $certificate_cost;
				$lab_test_dzn=$row[csf("lab_test")];
				$inspection_dzn=$row[csf("inspection")];
				$cm_cost_dzn =$row[csf("cm_cost")];
				$common_oh_dzn =$row[csf("common_oh")];
				$freight_dzn =$row[csf("freight")];
				$currier_pre_cost_dzn = $row[csf("currier_pre_cost")];
				$certificate_pre_cost_dzn = $row[csf("certificate_pre_cost")];
				$deffdlc_cost_dzn = $row[csf("deffdlc_cost")];
				$depr_amor_pre_cost_dzn = $row[csf("depr_amor_pre_cost")];
				$interest_cost_dzn=$row[csf("interest_cost")];
				$incometax_cost_dzn=$row[csf("incometax_cost")];
   			?>	 
                <tr>
                    <td align="left">Lab Test </td>
                    <td align="right"><? echo number_format($lab_test_percent,3); ?></td>
					<td align="right"><? echo number_format($lab_test_dzn,3); ?></td>
					<td align="right"><? echo number_format($lab_test_cost,2); ?></td>
					<td align="right"><? echo number_format(($lab_test_cost/$total_po_value)*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">Inspection Cost</td>
					<td align="right"><? echo number_format($inspection_percent,3); ?></td>
					<td align="right"><? echo number_format($inspection_dzn,3); ?></td>
					<td align="right"><? echo number_format($inspection_cost,2); ?></td>
					<td align="right"><? echo number_format(($inspection_cost/$total_po_value)*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">CM Cost</td>
                    <td align="right"><? echo number_format($cm_cost_percent,3); ?></td>
					<td align="right"><? echo number_format($cm_cost_dzn,3); ?></td>
					<td align="right"><? echo number_format($cm_cost,2); ?></td>
					<td align="right"><? echo number_format(($cm_cost/$total_po_value)*100,2); ?></td>
                </tr>
                
                 <tr>
                    <td align="left">Gmts Freight Cost</td>
                    <td align="right"><? echo number_format($freight_percent,3); ?></td>
					<td align="right"><? echo number_format($freight_dzn,3); ?></td>
					<td align="right"><? echo number_format($freight_cost,2); ?></td>
					<td align="right"><? echo number_format(($freight_cost/$total_po_value)*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Currier Cost </td>
					<td align="right"><? echo number_format($currier_percent,3); ?></td>
					<td align="right"><? echo number_format($currier_pre_cost_dzn,3); ?></td>
					<td align="right"><? echo number_format($currier_cost,2); ?></td>
					<td align="right"><? echo number_format(($currier_cost/$total_po_value)*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Certificate Cost </td>
                    <td align="right"><? echo number_format($certificate_percent,3); ?></td>
					<td align="right"><? echo number_format($certificate_pre_cost_dzn,3); ?></td>
					 <td align="right"><? echo number_format($certificate_cost,2); ?></td>
					<td align="right"><? echo number_format(($certificate_cost/$total_po_value)*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">Deffd. LC/DC Cost </td>
                    <td align="right"><? echo number_format($deffdlc_cost,3); ?></td>
					 <td align="right"><? echo number_format($deffdlc_cost_dzn,3); ?></td>
					 <td align="right"><? echo number_format($deffdlc_cost,2); ?></td>
					 <td align="right"><? echo number_format(($deffdlc_cost/$total_po_value)*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Interest </td>
					<td align="right"><? echo number_format($interest_cost,3); ?></td>
					<td align="right"><? echo number_format($interest_cost_dzn,3); ?></td>
					<td align="right"><? echo number_format($interest_cost,2); ?></td>
					<td align="right"><? echo number_format(($interest_cost/$total_po_value)*100,2); ?></td>
                </tr>
                 <tr>
                    <td align="left">Income Tax </td>
                    <td align="right"><? echo number_format($incometax_cost,3); ?></td>
					<td align="right"><? echo number_format($incometax_cost_dzn,3); ?></td>
					<td align="right"><? echo number_format($incometax_cost,2); ?></td>
					<td align="right"><? echo number_format(($incometax_cost/$total_po_value)*100,2); ?></td>
                </tr>
                <tr>
                    <td align="left">Operating Expensees</td>
                    <td align="right"><? echo number_format($common_oh_percent,3); ?></td>
					<td align="right"><? echo number_format($common_oh_dzn,3); ?></td>
					<td align="right"><? echo number_format($common_oh,2); ?></td>
					<td align="right"><? echo number_format(($common_oh/$total_po_value)*100,2); ?></td>
                </tr>
				 <tr>
                    <td align="left">Depreciation & Amortization </td>
                    <td align="right"><? //echo number_format($common_oh,4); ?></td>
					<td align="right"><? echo number_format($depr_amor_pre_cost_dzn,3); ?></td>
					<td align="right"><? echo number_format($depr_amor_pre_cost,2); ?></td>
					<td align="right"><? echo number_format(($depr_amor_pre_cost/$total_po_value)*100,2); ?></td>
                </tr>
            <?
                 $total_other_components_dzn = $lab_test_dzn+$inspection_dzn+$cm_cost_dzn+$freight_dzn+$currier_pre_cost_dzn+$certificate_pre_cost_dzn+$deffdlc_cost_dzn+$interest_cost_dzn+$incometax_cost_dzn+$common_oh_dzn+$depr_amor_pre_cost_dzn;
				   $total_other_components =$lab_test_cost+$inspection_cost+$cm_cost+$freight_cost+$currier_cost+$certificate_cost+$deffdlc_cost+$interest_cost+$incometax_cost+$common_oh+$depr_amor_pre_cost;
           }
            ?>
                <tr class="rpt_bottom" style="font-weight:bold">
                    <td>Others Total</td>                    
                    <td align="right"><? // echo number_format($total_other_components,4); ?></td>
					<td align="right"><? echo number_format($total_other_components_dzn,3); ?></td>
					<td align="right"><? echo number_format($total_other_components,2); ?></td>
					<td align="right"><? echo number_format(($total_other_components/$total_po_value)*100,2); ?></td>
                </tr> 
            </table>
            </td>
				   <td colspan="5"   valign="top">
				  	<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:260px; margin-top:20px" rules="all">
					 <?
						// image show here  -------------------------------------------
						 $sql = "select id,master_tble_id,image_location from common_photo_library   where master_tble_id=$txt_job_no and file_type=1  and rownum=1 ";
						$photo_data_array=sql_select($sql);
					 ?> 
					<? foreach($photo_data_array AS $inf){ ?>
						  <tr class="rpt_bottom" style="font-weight:bold">
							<td align="center"><img  src='../../<? echo $inf[csf("image_location")]; ?>' height='250px' width='250px' /></td>
						 </tr>
					<?  } ?>			
		
		 	 	</table>
				   </td>
          </tr>
		  </table>
 		<br/>
      <?
			//End Commission Cost Part report here -------------------------------------------	
		  
			//start	all summary report here -------------------------------------------
			//job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref
			 $sql = "select fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,wash_cost,wash_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,currier_pre_cost,currier_percent,certificate_pre_cost,certificate_percent,common_oh,common_oh_percent,total_cost,deffdlc_cost,deffdlc_percent,interest_cost,interest_percent,incometax_cost,incometax_percent,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,depr_amor_pre_cost,depr_amor_po_price,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
					from wo_pre_cost_dtls
					where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
			$data_array=sql_select($sql);
			$others_cost_value=0;
			$fabric_cost=0;
			$trims_cost=0;
			$embel_cost=0;
			$comm_cost=0;
			$commission=0;
			$lab_test=0;
			$inspection=0;
			$cm_cost=0;
			$freight=0;
			$currier_pre_cost=0;
			$certificate_pre_cost=0;
			$common_oh=0;
 	?>

        <div style="margin-top:15px">
		 <table>
		 <tr>
		 <td>
            <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:650px;text-align:center;" rules="all">
			<caption><label  style="background:#CCCCCC; font-size:larger"><b style="float:left;background:#CCCCCC;">Order Profitability Summary</b> </label> </caption>	
                <tr style="font-weight:bold">
                    <td width="80">SL</td>
                    <td width="250">Particulars</td>
                    <td width="100">Amount/Dzn</td>
                    <td width="100">TTL Amount</td>
                    <td width="100">% to Ord. Value</td>                     
                </tr>
            <?
			$cm_cost_method_based_on=return_field_value("cm_cost_method_based_on", "variable_order_tracking", "company_name=$cbo_company_name  and variable_list=22 and status_active=1 and is_deleted=0");
			if($cm_cost_method_based_on=="") $cm_cost_method_based_on=0;else $cm_cost_method_based_on=$cm_cost_method_based_on;
			if($cm_cost_method_based_on==1)
			{
				$based_on_date=return_field_value("costing_date", "wo_pre_cost_mst", "job_no=".$txt_job_no." and status_active=1 and is_deleted=0 ");
			}
			else if($cm_cost_method_based_on==2)
			{
					$based_on_date=return_field_value("min(shipment_date) as shipment_date", "wo_po_break_down", "job_no_mst=".$txt_job_no." and status_active=1 and is_deleted=0 ","shipment_date");
			}
			else if($cm_cost_method_based_on==3)
			{
					$based_on_date=return_field_value("max(shipment_date) as shipment_date", "wo_po_break_down", "job_no_mst=".$txt_job_no." and status_active=1 and is_deleted=0 ","shipment_date");
			}
			else if($cm_cost_method_based_on==4)
			{
					$based_on_date=return_field_value("min(pub_shipment_date) as pub_shipment_date", "wo_po_break_down", "job_no_mst=".$txt_job_no." and status_active=1 and is_deleted=0 ","pub_shipment_date");
			}
			else if($cm_cost_method_based_on==5)
			{
					$based_on_date=return_field_value("max(pub_shipment_date) as pub_shipment_date", "wo_po_break_down", "job_no_mst=".$txt_job_no." and status_active=1 and is_deleted=0 ","pub_shipment_date");
			}
			else
			{
				$based_on_date=return_field_value("costing_date", "wo_pre_cost_mst", "job_no=".$txt_job_no." and status_active=1 and is_deleted=0 ");
			}
			//echo $based_on_date.'fddf';
			$based_on_date_new =change_date_format($based_on_date,'','',1);
			
			$financial_para=array();
			$sql_std_para=sql_select("select cost_per_minute,interest_expense,income_tax,applying_period_date as from_period_date,applying_period_to_date from lib_standard_cm_entry where company_id=$cbo_company_name and status_active=1 and is_deleted=0  order by id desc");	
			foreach($sql_std_para as $row)
			{
				$applying_period_date=change_date_format($row[csf('from_period_date')],'','',1);
				$applying_period_to_date=change_date_format($row[csf('applying_period_to_date')],'','',1);
				$diff=datediff('d',$applying_period_date,$applying_period_to_date);
				for($j=0;$j<$diff;$j++)
				{
					$newdate =change_date_format(add_date(str_replace("'","",$applying_period_date),$j),'','',1);
					if($based_on_date_new==$newdate)
					{
					//echo $row[csf('cost_per_minute')].',';
					$financial_para[$newdate]['cost_per_minute']=$row[csf('cost_per_minute')];
					$financial_para[$newdate]['interest_expense']=$row[csf('interest_expense')];
					$financial_para[$newdate]['income_tax']=$row[csf('income_tax')];
					}
				}
			
			}
			$cpm_budget=$financial_para[$based_on_date_new]['cost_per_minute']/$sew_effi_percent;
				//echo $financial_para[$based_on_date_new]['cost_per_minute'].'ddd'.$sew_effi_percent;
			$price_dzn=0;
            $sl=0;
            foreach( $data_array as $row )
            { 
			//$fab_production_knit=$fabric_costing_arr['knit']['grey'][$job_no];
			//$fab_production_finish=$fabric_costing_arr['finish']['grey'][$job_no];
			
			$fab_purchase_knit2=array_sum($fabric_costing_arr2['knit']['grey'][$job_no]);
			$fab_purchase_woven2=array_sum($fabric_costing_arr2['woven']['grey'][$job_no]);
		
			$yarn_costing=$yarn_costing_arr[$job_no];
			$tot_fabric_cost=$fab_purchase_knit2+$fab_purchase_woven2;
			$conversion_cost=array_sum($conversion_costing_arr_process[$job_no]);
			//$testing_cost=$other_costing_arr[$job_no]['lab_test'];
			$freight_cost=$other_costing_arr[$job_no]['freight'];
			$inspection_cost=$other_costing_arr[$job_no]['inspection'];
			$certificate_cost=$other_costing_arr[$job_no]['certificate_pre_cost'];
			$common_oh=$other_costing_arr[$job_no]['common_oh'];
			$currier_cost=$other_costing_arr[$job_no]['currier_pre_cost'];
			$cm_cost=$other_costing_arr[$job_no]['cm_cost'];
			$lab_test_cost=$other_costing_arr[$job_no]['lab_test'];
			$depr_amor_pre_cost=$other_costing_arr[$job_no]['depr_amor_pre_cost'];
			$deffdlc_cost=$other_costing_arr[$job_no]['deffdlc_cost'];
			$fabric_cost=$tot_fabric_cost;
			$trims_cost=$trims_costing_arr[$job_no];
			$embel_cost=$emblishment_costing_arr[$job_no];
			$wash=$emblishment_costing_arr_wash[$job_no];
			$commercial_cost=$commercial_costing_arr[$job_no];
			$comm_cost_dzn=$row[csf("comm_cost")];
			$cm_cost_dzn=$row[csf("cm_cost")];
			$price_dzn=$row[csf("price_dzn")];
			$total_cost_dzn=$row[csf("total_cost")];
			$deffdlc_cost_dzn=$row[csf("deffdlc_cost")];
			$interest_cost_dzn=$row[csf("interest_cost")];
			$incometax_cost_dzn=$row[csf("incometax_cost")];
			$commission_dzn=$row[csf("commission")];
			$operatin_expense_dzn=$row[csf("common_oh")];
			//deffdlc_cost,deffdlc_percent,interest_cost,interest_percent,incometax_cost,incometax_percent
			$deffdlc_percent=$row[csf("deffdlc_percent")];
			$interest_percent=$row[csf("interest_percent")];
			$incometax_percent=$row[csf("incometax_percent")];
			$depr_amor_po_price=$row[csf("depr_amor_po_price")];
			$depr_amor_pre_cost_dzn=$row[csf("depr_amor_pre_cost")];
			//interest_cost,interest_percent,incometax_cost
			$tot_commission=$commission_costing_arr[$job_no];
			$lab_test=$lab_test_cost;
			$inspection=$inspection_cost;
			$cm_cost=$cm_cost;
			$freight=$freight_cost;
			$currier_pre_cost=$currier_cost;
			$certificate_pre_cost=$certificate_cost;
			$sl=$sl+1;
  			$others_cost_value=$all_total_cost-$cm_cost-$freight-$commercial_cost-$commission;
?>	 
                <tr>
                    <td><? echo $sl; ?></td>
                    <td align="left"><b>Gross FOB Value/ DZN</b></td>
                 	 <td align="right"><b><? echo number_format($price_dzn,3); ?></b></td>
                    <td align="right"><b><? echo number_format($total_po_value,2);//$price_dzn=$tot_order_value; ?></b></td>
                    <td align="center"><? echo "100.00%"; ?></td>
					
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less Commission</td>
                    <td align="right"><? echo number_format($commission_dzn,3); ?></td>
                    <td align="right"><? echo number_format($tot_commission,2); ?></td>
                    <td align="center"><? echo number_format(($tot_commission/$total_po_value)*100,2); ?>%</td>
                </tr>
              
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Net FOB Value (1-2)</td>
                    <td align="right"><? $net_fob_value_dzn=$price_dzn-$commission_dzn; echo number_format($net_fob_value_dzn,3); ?></td>
					 <td align="right"><? $net_fob_value=$total_po_value-$tot_commission;echo number_format($net_fob_value,2); ?></td>
                    <td align="center"><? echo number_format(($net_fob_value/$total_po_value)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: Material & Services Cost</td>
                    <td align="right"><? $total_material_services_dzn=$total_fab_cost_dzn+$total_trims_cost_dzn+$total_embellishment_amt_dzn+$lab_test_dzn+$inspection_dzn+$freight_dzn+$currier_pre_cost_dzn+$certificate_pre_cost_dzn+$deffdlc_cost_dzn;
									$total_material_services=$total_trims_cost+$all_fab_cost+$total_embellishment_amt+$lab_test_cost+$inspection_cost+$freight_cost+$currier_cost+$certificate_cost+$deffdlc_cost;

						echo number_format($total_material_services_dzn,3); ?></td>
					 <td align="right"><? echo number_format($total_material_services,2); ?></td>
                    <td align="center"><? echo number_format(($total_material_services/$total_po_value)*100,2);//number_format($row[csf("embel_cost_percent")],2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Contributions/Value Additions (3-4)</td>
                    <td align="right"><? $contributions_value_dzn=$net_fob_value_dzn-$total_material_services_dzn;
							$contributions_value=$net_fob_value-$total_material_services;
							echo number_format($contributions_value_dzn,3); ?></td>
					 <td align="right"><? echo number_format($contributions_value,2); ?></td>
                    <td align="center"><? echo number_format(($contributions_value/$total_po_value)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: CM Cost </td>
                    <td align="right"><? echo number_format($cm_cost_dzn,3); ?></td>
					 <td align="right"><? echo number_format($cm_cost,2); ?></td>
                    <td align="center"><? echo number_format(($cm_cost/$total_po_value)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Gross Profit(5-6)</td>
                    <td align="right"><? $gross_profit_dzn=$contributions_value_dzn-$cm_cost_dzn;
					$gross_profit_loss=$contributions_value-$cm_cost;
					
					echo number_format($gross_profit_dzn,3); ?></td>
					 <td align="right"><? echo number_format($gross_profit_loss,2); ?></td>
                    <td align="center"><? echo number_format(($gross_profit_loss/$total_po_value)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: Commercial Cost</td>
                    <td align="right"><? echo number_format($comm_cost_dzn,3); ?></td>
					 <td align="right"><? echo number_format($commercial_cost,2); ?></td>
                    <td align="center"><? echo number_format(($commercial_cost/$total_po_value)*100,2); ?>%</td>
                </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: Operating Expensees</td>
                    <td align="right"><? echo number_format($operatin_expense_dzn,3); ?></td>
					<td align="right"><? echo number_format($common_oh,2); ?></td>
                    <td align="center"><? echo number_format(($common_oh/$total_po_value)*100,2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Operating Profit/Loss [7-(8+9)]</td>
                    <td align="right">
					<? 
					$operating_profit_dzn=$gross_profit_dzn-($comm_cost_dzn+$operatin_expense_dzn);
					$operating_profit_loss=$gross_profit_loss-($commercial_cost+$operatin_expense_dzn);
					echo number_format($operating_profit_dzn,3); 
					?>
                    </td>
					<td align="right"><? echo number_format($operating_profit_loss,2); ?></td>
                    <td align="center"><? echo number_format(($operating_profit_loss/$total_po_value)*100,2); ?>%</td>
                 </tr>
                <tr> 
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: Depreciation & Amortization </td>
                    <td align="right"><? echo number_format($depr_amor_pre_cost_dzn,3); ?></td>
					<td align="right"><? echo number_format($depr_amor_pre_cost,2); ?></td>
                    <td align="center"><? echo number_format(($depr_amor_pre_cost/$total_po_value)*100,2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: Interest</td>
                    <td align="right"><? echo number_format($interest_cost_dzn,3); ?></td>
					<td align="right"><? //echo number_format($interest_cost_dzn,4); ?></td>
                    <td align="center"><? echo number_format(($interest_cost_dzn/$total_po_value)*100,2); ?>%</td>
                 </tr>
                 <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Less: Income Tax</td>
                    <td align="right"><? echo number_format($incometax_cost_dzn,3); ?></td>
					 <td align="right"><? //echo number_format($incometax_cost_dzn,4); ?></td>
                    <td align="center"><? echo number_format(($incometax_cost_dzn/$total_po_value)*100,2); ?>%</td>
                 </tr>
                  <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">Net Profit [10-(11+12+13)]</td>
                    <td align="right"><? $net_profit_dzn=$operating_profit_dzn-($depr_amor_pre_cost_dzn+$interest_cost_dzn+$incometax_cost_dzn);
					$net_profit=$operating_profit_loss-($depr_amor_pre_cost);
					echo number_format($net_profit_dzn,3); ?></td>
					 <td align="center"><? echo number_format($net_profit,2); ?></td>
                    <td align="center"><? echo number_format(($net_profit/$total_po_value)*100,2); ?>%</td>
                 </tr>
                <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">EPM (Per Pcs CM/SMV)</td>
					 <td align="right" colspan="3"><? $epm_per_pcs=($contributions_value_dzn/12)/$tot_smv;echo number_format($epm_per_pcs,4); ?></td>
                 </tr>
                  <tr>
                    <td><? echo ++$sl; ?></td>
                    <td align="left">CPM </td>
                    <td align="right" colspan="3"><? echo number_format($cpm_budget,4); ?></td>
                 </tr>
            <?
            }
			$total_job_cost=$total_trims_cost+$grand_total_conversion_cost+$total_embellishment_amt+$total_other_components+$total_commercial_cost+$total_commission_cost;
            ?>
            </table>
			</td>
			<td valign="top"> 
			 <div style="margin-top:0px;">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1"style="width:320px;text-align:center;" rules="all">
				<label><b>Cost Summary on Total Order Qty</b></label>
					<tr style="font-weight:bold">
						<td width="130">Particulars</td>
						<td width="80">Amount (USD)</td>
						<td width="80">%</td>
					</tr>            
					<tr>
						<td align="left">Total Order Value </td>
						<td align="right"><? 
						 echo number_format($total_po_value,4); ?></td>
						<td align="center"><? echo number_format($total_po_value/$total_po_value*100,2); ?></td>
					</tr> 
					 <tr>
						<td align="left">Total Cost </td>
						<td align="right" title="Total Trims+Conversion+Emblish+Other+Commercail+Commission "><?  //$total_cost = $total_job_cost;//$all_total_cost; 
						echo number_format($total_job_cost,2);//$total_cost = $row[csf("total_cost")]/$order_price_per_dzn*$order_job_qnty; echo number_format($total_cost,4); ?></td>
						<td align="center"><? echo number_format($total_job_cost/$total_po_value*100,2); ?></td>
					</tr>
					 <tr>
						<td align="left">Total Margin </td>
						<td align="right" title="Total Order Value-Total Cost"><? $total_margin_val = $total_po_value-$total_job_cost; echo number_format($total_margin_val,2); ?></td>
						<td align="center"><? echo number_format(($total_margin_val/$total_po_value*100),2); ?></td>
					</tr>
					 <tr>
						<td align="left">Margin /Dzn </td>
						<td align="right"><?
							$ord_val_dzn_per=($job_po_rate*12)*100;
							
						 $margin_dzn=$total_margin_val/$total_po_qty;echo number_format($margin_dzn,2); ?></td>
						<td align="center"><? echo number_format($margin_dzn/$ord_val_dzn_per,2); ?></td>
					</tr>
					<tr>
						<td align="left">Margin /Pcs </td>
						<td align="right"><? $margin_pcs=$margin_dzn/12;echo number_format($margin_pcs,2); ?></td>
						<td align="center"><? echo number_format(($margin_pcs/$job_po_rate)*100,2); ?></td>
					</tr>
          		 </table>
				 </div>
			</td>
			</tr>
			
			 </table>
			
      </div>
	      <?
		//End all summary report here -------------------------------------------
	
		?>
		 <br/>
    	 <?  echo signature_table(109, $cbo_company_name, "970px");?>
     	 </div>
      
	 <?
	 exit();
}

if($action=="cost_control_source")
{
	$company_id=$data;
	$cost_control_source=0;
	if($company_id!=0)
	{
		$sql="select id, cost_control_source from variable_order_tracking where company_name='$company_id' and variable_list=53 order by id";
		$dataArr=sql_select($sql);
		$cost_control_source=$dataArr[0][csf('cost_control_source')];
	}
	echo $cost_control_source;
	exit();
}

if ($action == "supplier_name")
{
	$sql = "select c.id, c.supplier_name as label from lib_supplier_tag_company a, lib_supplier_party_type b, lib_supplier c where c.id=b.supplier_id and a.supplier_id = b.supplier_id and a.tag_company='$data' and b.party_type =23 and c.status_active=1 and c.is_deleted=0 group by c.id, c.supplier_name order by supplier_name";
	$result = sql_select($sql);
	$supplierArr = array();
	foreach($result as $key => $val){
		$supplierArr[$key]["id"]=$val[csf("id")];
		$supplierArr[$key]["label"]=$val[csf("label")];
	}
	echo json_encode($supplierArr);
    exit();
}

if($action=="validate_is_booking_create")
{
	$exdata=explode("__", $data);
	$upid=$exdata[0]; $booking_type=$exdata[1]; $jobno=$exdata[2];
	
	$approved=0;
	$sql=sql_select("select approved from wo_pre_cost_mst where job_no='$jobno'");
	foreach($sql as $row){
		if($row[csf('approved')]==3) $approved=1; else $approved=$row[csf('approved')];
	}
	if($approved==1){
		echo "approved***".str_replace("'","",$jobno);
		die;
	}
	
	$amount=0;
	$data_array=sql_select("select booking_no from wo_booking_dtls where pre_cost_fabric_cost_dtls_id ='$upid' and booking_type='$booking_type' and status_active=1 and is_deleted=0 group by booking_no");
	$booking_no='';
	foreach( $data_array as $row )
	{
		if($booking_no=="") $booking_no=$row[csf("booking_no")]; else $booking_no.=', '.$row[csf("booking_no")];
	}

	if (count($data_array)>0) echo "1***".$booking_no; else echo "0***".$booking_no;
	die;
}

if ($action=="unapp_request_popup")
{
	$menu_id=$_SESSION['menu_id'];
	$user_id=$_SESSION['logic_erp']['user_id'];

	echo load_html_head_contents("Un Approval Request","../../../", 1, 1, $unicode);
	extract($_REQUEST);

	$data_all=explode('_',$data);
	$job_no=$data_all[0];
	$unapp_request=$data_all[1];

	$precost_id=return_field_value("id", "wo_pre_cost_mst", "job_no='$job_no' and status_active=1 and is_deleted=0");

	if($unapp_request=="")
	{
		$sql_request="select MAX(id) as id from fabric_booking_approval_cause where entry_form=15 and user_id='$user_id' and booking_id='$precost_id' and approval_type=2 and status_active=1 and is_deleted=0";//page_id='$menu_id' and

		$nameArray_request=sql_select($sql_request);
		foreach($nameArray_request as $row)
		{
			$unapp_request=return_field_value("approval_cause", "fabric_booking_approval_cause", "id='".$row[csf('id')]."' and status_active=1 and is_deleted=0");
		}
	}
	?>
    <script>

		$( document ).ready(function() {
			document.getElementById("unappv_request").value='<? echo preg_replace('/[\r\n]+/','\n',$unapp_request); ?>';
		});

		var permission='<? echo $permission; ?>';

		function fnc_appv_entry(operation)
		{
			var unappv_request = $('#unappv_request').val();

			if (form_validation('unappv_request','Un Approval Request')==false)
			{
				if (unappv_request=='')
				{
					alert("Please write request.");
				}
				return;
			}
			else
			{

				var data="action=save_update_delete_unappv_request&operation="+operation+get_submitted_data_string('unappv_request*precost_id*page_id*user_id',"../../../");
				//alert (data);return;
				freeze_window(operation);
				http.open("POST","pre_cost_entry_controller_v2.php",true);
				http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
				http.send(data);
				http.onreadystatechange=fnc_appv_entry_Reply_info;
			}
		}

		function fnc_appv_entry_Reply_info()
		{
			if(http.readyState == 4)
			{
				var reponse=trim(http.responseText).split('**');
				show_msg(reponse[0]);

				set_button_status(1, permission, 'fnc_appv_entry',1);
				release_freezing();
			}
		}

		function fnc_close()
		{
			unappv_request= $("#unappv_request").val();
			document.getElementById('hidden_appv_cause').value=unappv_request;
			parent.emailwindow.hide();
		}

    </script>
    <body>
		<div align="center" style="width:100%;">
        <? echo load_freeze_divs ("../../",$permission,1); ?>
        <form name="size_1" id="size_1">
			<fieldset style="width:450px;">
            <table align="center" cellspacing="0" width="450" class="rpt_table" border="1" rules="all" id="size_tbl" >
                <tr id="row_1">
                    <td width="150" align="center" >
                    	<textarea name="unappv_request" id="unappv_request" class="text_area" style="width:430px; height:100px;" maxlength="500" title="Maximum 500 Character"></textarea>
                        <Input type="hidden" name="precost_id" class="text_boxes" ID="precost_id" value="<? echo $precost_id; ?>" style="width:30px" />
                        <Input type="hidden" name="page_id" class="text_boxes" ID="page_id" value="<? echo $menu_id; ?>" style="width:30px" />
                        <Input type="hidden" name="user_id" class="text_boxes" ID="user_id" value="<? echo $user_id; ?>" style="width:30px" />
                    </td>
                </tr>
            </table>

            <table align="center" cellspacing="0" width="450" class="rpt_table" border="1" rules="all" id="" >
                <tr>
                    <td align="center" class="button_container">
                        <?
						//print_r ($id_up_all);
                            if($id_up!='')
                            {
                                echo load_submit_buttons($permission, "fnc_appv_entry", 1,0,"reset_form('size_1','','','','','');",1);
                            }
                            else
                            {
                                echo load_submit_buttons($permission, "fnc_appv_entry", 0,0,"reset_form('size_1','','','','','');",1);
                            }
                        ?>
                        <input type="hidden" name="hidden_appv_cause" id="hidden_appv_cause" class="text_boxes /">

                    </td>
                </tr>
                <tr>
                    <td align="center">
                        <input type="button" name="close" class="formbutton" value="Close" id="main_close" onClick="fnc_close();" style="width:100px" />
                    </td>
                </tr>
            </table>
            </fieldset>
            </form>
        </div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
	exit();
}

if ($action=="save_update_delete_unappv_request")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));

	//echo "shajjad_".$unappv_request.'_'.$wo_id.'_'.$page_id.'_'.$user_id; die;

	if ($operation==0)  // Insert Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		$approved_no=return_field_value("MAX(approved_no) as approved_no","approval_history","entry_form=15 and mst_id=$precost_id","approved_no")+1;

		$unapproved_request=return_field_value("id","fabric_booking_approval_cause","entry_form=15 and user_id=$user_id and booking_id=$precost_id and approval_type=2 and approval_no='$approved_no'");//page_id=$page_id and

		if($unapproved_request=="")
		{
			$id_mst=return_next_id( "id", "fabric_booking_approval_cause", 1 ) ;

			$field_array="id,page_id,entry_form,user_id,booking_id,approval_type,approval_no,approval_cause,inserted_by,insert_date,status_active,is_deleted";
			$data_array="(".$id_mst.",".$page_id.",15,".$user_id.",".$precost_id." ,2,'".$approved_no."',".$unappv_request.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
			//echo "10**";
			//echo "INSERT INTO fabric_booking_approval_cause (".$field_array.") VALUES ".$data_array; die;
			$rID=sql_insert("fabric_booking_approval_cause",$field_array,$data_array,0);
			//echo $rID; die;

			if($db_type==0)
			{
				if($rID )
				{
					mysql_query("COMMIT");
					echo "0**".$rID."**".str_replace("'","",$precost_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					mysql_query("ROLLBACK");
					echo "10**".$rID;
				}
			}
			else if($db_type==2)
			{
				if($rID )
				{
					oci_commit($con);
					echo "0**".$rID."**".str_replace("'","",$precost_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					oci_rollback($con);
					echo "10**".$rID;
				}
			}
			disconnect($con);
			die;
		}
		else
		{
			$con = connect();
			if($db_type==0)
			{
				mysql_query("BEGIN");
			}

			$field_array="page_id*entry_form*user_id*booking_id*approval_type*approval_no*approval_cause*updated_by*update_date*status_active*is_deleted";
			$data_array="".$page_id."*15*".$user_id."*".$precost_id."*2*'".$approved_no."'*".$unappv_request."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*1*0";

			$rID=sql_update("fabric_booking_approval_cause",$field_array,$data_array,"id","".$unapproved_request."",0);

			if($db_type==0)
			{
				if($rID )
				{
					mysql_query("COMMIT");
					echo "1**".$rID."**".str_replace("'","",$precost_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					mysql_query("ROLLBACK");
					echo "10**".$rID;
				}
			}
			else if($db_type==2)
			{
				if($rID )
				{
					oci_commit($con);
					echo "1**".$rID."**".str_replace("'","",$precost_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					oci_rollback($con);
					echo "10**".$rID;
				}
			}

			disconnect($con);
			die;
		}
	}
	else if ($operation==1)  // Update Here
	{

	}
	exit();
}

if($action=="avgWeightCalSheet")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";
	$buyer_arr=return_library_array( "select id,buyer_name from lib_buyer", "id","buyer_name");
	$merchandiser_arr=return_library_array( "select id,team_member_name from lib_mkt_team_member_info", "id","team_member_name");
	$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count");
	$size_arr=return_library_array( "select id, size_name from lib_size", "id", "size_name");
	$color_arr=return_library_array( "select id, color_name from lib_color", "id", "color_name");

	$sql_mst="Select a.id, a.buyer_name, a.style_ref_no, a.dealing_marchant, b.costing_date, b.costing_per from wo_po_details_master a, wo_pre_cost_mst b where a.job_no=b.job_no and a.job_no=$txt_job_no and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";
	$dataArray=sql_select($sql_mst);
	
	$costing_per=0;
	
	if($dataArray[0][csf('costing_per')]==1) $costing_per=12;
	else if($dataArray[0][csf('costing_per')]==2) $costing_per=1;
	else if($dataArray[0][csf('costing_per')]==3) $costing_per=24;
	else if($dataArray[0][csf('costing_per')]==4) $costing_per=36;
	else if($dataArray[0][csf('costing_per')]==5) $costing_per=48;
	
	$yarn_mst_sql="select id, item_number_id, lib_yarn_count_deter_id, construction, composition, fabric_description, msmnt_break_down from wo_pre_cost_fabric_cost_dtls where job_no=$txt_job_no and status_active=1 and is_deleted=0 order by id";
	
	//print_r($yarn_mst_sql_res);
	
	$yarn_mst_sql_res=sql_select($yarn_mst_sql); 
	$yarn_des=""; $lib_yarn_count_deter_id=''; $msmnt_break_down=array(); $fabwiseitemarr=array(); $gmtsitemidarray=array();
	//echo "<pre>";
	//print_r($yarn_mst_sql_res);die;
	foreach($yarn_mst_sql_res as $row)
	{
		$gmtsitemidarray[$row[csf('item_number_id')]]=$row[csf('item_number_id')];
		$fabwiseitemarr[$row[csf('id')]]=$row[csf('item_number_id')];
		if($yarn_des=="") $yarn_des=$row[csf('fabric_description')]; else $yarn_des.=','.$row[csf('fabric_description')];
		if($lib_yarn_count_deter_id=="") $lib_yarn_count_deter_id=$row[csf('lib_yarn_count_deter_id')]; else $lib_yarn_count_deter_id.=','.$row[csf('lib_yarn_count_deter_id')];
		if(!empty($row[csf('msmnt_break_down')])){
			//if($msmnt_break_down=="") $msmnt_break_down=$row[csf('msmnt_break_down')]->load(); else $msmnt_break_down.=','.$row[csf('msmnt_break_down')]->load();
			
			$msmnt_break_down[$row[csf('item_number_id')]].=','.$row[csf('msmnt_break_down')]->load();
			//print_r($row[csf('msmnt_break_down')]->load());
		}
	}
	//die;
	//echo $msmnt_break_down;
	$yarn_des=implode(",",array_unique(explode(",",$yarn_des)));
	
	
	//print_r($msmnt_break_down);
	$count_name="";
	if($lib_yarn_count_deter_id!="")
	{
		$sql_count="select mst_id, count_id from lib_yarn_count_determina_dtls where mst_id in ($lib_yarn_count_deter_id) and is_deleted=0 order by a.id";
		$count_data=sql_select($sql_count);
		foreach($count_data as $row)
		{
			if($count_name=="") $count_name=$lib_yarn_count[$row[csf('count_id')]]; else $count_name.=', '.$lib_yarn_count[$row[csf('count_id')]];
		}
	}
	
	$count_name=implode(",",array_unique(explode(",",$count_name)));
	?>
     <div style="width:930px">
     	<table width="930" cellpadding="0" cellspacing="0" id="caption"  align="left">
            <tr>  
                <td align="center" width="100%" class="form_caption"><strong style="font-size:18px">Average Weight Calculation Sheet For Job: <? echo str_replace("'","",$txt_job_no); ?></strong></td>
            </tr>
        </table>
        <table width="930" cellspacing="0" align="" border="0">
            <tr>
                <td width="140"><strong>Costing Date:</strong></td><td width="170"><? echo change_date_format($dataArray[0][csf('costing_date')]); ?></td>
                <td width="140"><strong>Buyer: </strong></td><td width="170px"><? echo $buyer_arr[$dataArray[0][csf('buyer_name')]]; ?></td>
                <td width="130"><strong>Style Ref.:</strong></td><td><? echo $dataArray[0][csf('style_ref_no')]; ?></td>
            </tr>
            <tr>
                <td><strong>Merchandiser:</strong></td><td><? echo $merchandiser_arr[$dataArray[0][csf('dealing_marchant')]]; ?></td>
                <td><strong>Sample Ref.: </strong></td><td><? //echo $buyer_arr[$dataArray[0][csf('buyer_name')]]; ?></td>
                <td><strong>Sample Size:</strong></td><td><? //echo $dataArray[0][csf('style_ref_no')]; ?></td>
            </tr>
            <tr>
                <td><strong>Yarn Composition:</strong></td><td colspan="3"><? echo $yarn_des; ?></td>
                <td><strong>Yarn Count: </strong></td><td><? echo $count_name; ?></td>
            </tr>
            <tr>
                <td><strong>Color:</strong></td><td><? //echo $merchandiser_arr[$dataArray[0][csf('dealing_marchant')]]; ?></td>
                <td><strong>Technical Manager: </strong></td><td><? //echo $buyer_arr[$dataArray[0][csf('buyer_name')]]; ?></td>
                <td><strong>Yarn Controller:</strong></td><td><? //echo $dataArray[0][csf('style_ref_no')]; ?></td>
            </tr>
        </table>
        
        <? foreach ($gmtsitemidarray as $gid) { ?> <br>
        <table cellspacing="0" width="930" border="1" rules="all" class="rpt_table" >
            <thead bgcolor="#dddddd">
            	<tr>
                	<th colspan="11" bgcolor="#CCCCCC" align="center">Sample Information</th>
                </tr>
                <tr>
                	<th rowspan="2">Gmts Item</th>
                	<th colspan="2">Body</th>
                    <th colspan="2">Sleeve</th>
                    <th rowspan="2" width="80">Size</th>
                    <th rowspan="2" width="100">Weight (GM)</th>
                    <th rowspan="2" width="80">For 1 Pcs</th>
                    <th rowspan="2" width="100">Total Weights (GM)</th>
                    <th rowspan="2" width="100">Grading Factor</th>
                    <th rowspan="2">Remarks</th>
                </tr>
                <tr>
                	<th width="50">Length</th>
                    <th width="50">Width</th>
                    <th width="50">Length</th>
                    <th width="50">Width</th>
                </tr>
            </thead>
            <tbody>
            <?
			//print_r($msmnt_break_down);
			$msmnt_break_down_arr=array_filter(explode(',',$msmnt_break_down[$gid]));
			$rowspan=count($msmnt_break_down_arr); $q=0;
			foreach($msmnt_break_down_arr as $dat_str)
			{
				//msmnt_breack_down+=comsizename+'_'+comsizecons+'_'+comlenth+'_'+comwidth+'_'+comcons+'_'+comlenthsl+'_'+comwidthsl;
				$exdata=explode('_',$dat_str);
				$comsizename=$exdata[0];
				$comsizecons=$exdata[1]*1000;
				$comlenth=$exdata[2];
				$comwidth=$exdata[3];
				$comcons=$exdata[4];
				$comlenthsl=$exdata[5];
				$comwidthsl=$exdata[6];
				
				$grading_factor=$comsizecons/(($comlenth*$comwidth)+($comlenthsl*$comwidthsl));
				?>
					<tr>
						<? if($q==0) { ?>
						<td align="center" rowspan="<?=$rowspan; ?>"><? echo $garments_item[$gid]; ?></td>
						<? $q++; } ?>
						<td align="center"><? echo $comlenth; ?></td>
						<td align="center"><? echo $comwidth; ?></td>
						<td align="center"><? echo $comlenthsl; ?></td>
						<td align="center"><? echo $comwidthsl; ?></td>
						<td align="center"><? echo $comsizename; ?></td>
						<td align="center"><? echo number_format($comsizecons,8,".",""); ?></td>
						<td align="center"><? echo '1'; ?></td>
						<td align="center"><? echo number_format(($comsizecons*1),8,".",""); ?></td>
						<td align="center"><? echo number_format($grading_factor,8,".",""); ?></td>
						<td align="center">&nbsp;</td>
					</tr>
				<?
			}
			?>
            </tbody>
        </table>
        <br>
        <table cellspacing="0" width="930" border="1" rules="all" class="rpt_table" >
            <thead bgcolor="#dddddd">
            	<tr>
                	<th colspan="12" bgcolor="#CCCCCC" align="center">CALCULATIONS  OF AVERAGE WEIGHTS</th>
                </tr>
                <tr>
                	<th rowspan="2">Gmts Item</th>
                	<th colspan="2">Body</th>
                    <th colspan="2">Sleeve</th>
                    <th rowspan="2" width="80">Size</th>
                    <th rowspan="2" width="100">Weight (GM)</th>
                    <th rowspan="2" width="80">Plan Qty (Pcs)</th>
                    <th rowspan="2" width="90">Total Weights (KG)</th>
                    <th rowspan="2" width="90">Total Weights (LBS)</th>
                    <th rowspan="2" width="90">Average Weight % (LBS)</th>
                    <th rowspan="2">Remarks</th>
                </tr>
                <tr>
                	<th width="50">Length</th>
                    <th width="50">Width</th>
                    <th width="50">Length</th>
                    <th width="50">Width</th>
                </tr>
            </thead>
            <tbody>
				<?
                $data_cons=array();
                $fab_co_avg_con_dtls_data=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_sizes, length, dia_width, length_sleeve, width_sleeve, requirment, remarks from wo_pre_cos_fab_co_avg_con_dtls where job_no=$txt_job_no and status_active=1 and is_deleted=0 order by id");
                foreach($fab_co_avg_con_dtls_data as $fab_co_avg_row)
                {
                    $data_cons[$fabwiseitemarr[$fab_co_avg_row[csf('pre_cost_fabric_cost_dtls_id')]]][$fab_co_avg_row[csf('gmts_sizes')]]=$fab_co_avg_row[csf('length')]."_".$fab_co_avg_row[csf('dia_width')]."_".$fab_co_avg_row[csf('length_sleeve')]."_".$fab_co_avg_row[csf('width_sleeve')]."_".$fab_co_avg_row[csf('requirment')]."_".$fab_co_avg_row[csf('remarks')];
                }
                
                $data_array=sql_select("select item_number_id, min(id) as color_size_table_id, min(size_order) as size_order, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown where job_no_mst=$txt_job_no and item_number_id='$gid' and status_active=1 and is_deleted=0 group by item_number_id, size_number_id order by size_order ASC"); 
                $data_all_arr=array(); $grand_paln_qty=$grand_weight=$grand_tot_weight_lbs=$grand_avg_weight=0;
                foreach($data_array as $row)
                {
                    $body_lenth=$body_width=$sleeve_lenth=$sleeve_width=$actual_cons=$avg_weight=$tot_weight=0;
                    $size_data=''; $remarks='';
                    $size_data=explode('_',$data_cons[$row[csf('item_number_id')]][$row[csf('size_number_id')]]);
                    
                    $body_lenth=$size_data[0];
                    $body_width=$size_data[1];
                    $sleeve_lenth=$size_data[2];
                    $sleeve_width=$size_data[3];
                    $actual_cons=($size_data[4])/$costing_per;
                    $remarks=$size_data[5];
                    
                    $tot_weight=($actual_cons*$row[csf('plan_cut_qnty')]);
                    $weight_lbs=$tot_weight*2.20462;
                    
                    $data_all_arr[$row[csf('item_number_id')]][$row[csf('size_number_id')]]['body_lenth']=$body_lenth;
                    $data_all_arr[$row[csf('item_number_id')]][$row[csf('size_number_id')]]['body_width']=$body_width;
                    $data_all_arr[$row[csf('item_number_id')]][$row[csf('size_number_id')]]['sleeve_lenth']=$sleeve_lenth;
                    $data_all_arr[$row[csf('item_number_id')]][$row[csf('size_number_id')]]['sleeve_width']=$sleeve_width;
                    $data_all_arr[$row[csf('item_number_id')]][$row[csf('size_number_id')]]['actual_cons']=$actual_cons;
                    $data_all_arr[$row[csf('item_number_id')]][$row[csf('size_number_id')]]['plan_qty']=$row[csf('plan_cut_qnty')];
                    $data_all_arr[$row[csf('item_number_id')]][$row[csf('size_number_id')]]['tot_weight']=$tot_weight;
                    $data_all_arr[$row[csf('item_number_id')]][$row[csf('size_number_id')]]['weight_lbs']=$weight_lbs;
                    $data_all_arr[$row[csf('item_number_id')]][$row[csf('size_number_id')]]['remarks']=$remarks;
                    $grand_tot_weight_lbs+=$weight_lbs;
                }
                $i=1; $samplerowspna=0;
                foreach($data_all_arr as $gitem_id=>$gitemrow)	
                {
                    $samplerowspna=count($gitemrow); $m=0;
                    foreach($gitemrow as $size_id=>$row_d)	
                    {
                        if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
                        $avg_weight=($row_d['weight_lbs']/$grand_tot_weight_lbs)*100;
                        $weight=($row_d['actual_cons']*1000);
                        ?>
                        <tr bgcolor="<? echo $bgcolor; ?>">
                            <? if($m==0) { ?>
                            <td align="center" rowspan="<?=$samplerowspna; ?>"><? echo $garments_item[$gitem_id]; ?></td>
                            <? $m++; } ?>
                            <td align="center"><? echo $row_d['body_lenth']; ?></td>
                            <td align="center"><? echo $row_d['body_width']; ?></td>
                            <td align="center"><? echo $row_d['sleeve_lenth']; ?></td>
                            <td align="center"><? echo $row_d['sleeve_width']; ?></td>
                            <td align="center" style="word-wrap: break-word;word-break: break-all;"><? echo $size_arr[$size_id]; ?></td>
                            <td align="right"><? echo number_format($weight,4,".",""); ?></td>
                            <td align="right"><? echo $row_d['plan_qty']; ?></td>
                            <td align="right"><? echo number_format($row_d['tot_weight'],4,".",""); ?></td>
                            <td align="right"><? echo number_format($row_d['weight_lbs'],4,".",""); ?></td>
                            <td align="right"><? echo number_format($avg_weight,4,".",""); ?></td>
                            <td style="word-wrap: break-word;word-break: break-all;"><? echo $row_d['remarks']; ?>&nbsp;</td>
                        </tr>
                        <?
                        $grand_paln_qty+=$row_d['plan_qty'];
                        $grand_weight+=$row_d['tot_weight'];
                        $i++;
                    }
                }
                
                $grand_avg_weight=$grand_tot_weight_lbs/$grand_paln_qty;
                ?>
                <tr bgcolor="#dddddd">
                    <td align="right" colspan="6">Total:</td>
                    <td align="right" title="Avg.=(Total Weights (KG)/Plan Qty (Pcs))*1000"><? echo number_format((($grand_weight/$grand_paln_qty)*1000),4,".",""); ?></td>
                    <td align="right"><? echo $grand_paln_qty; ?></td>
                    <td align="right"><? echo number_format($grand_weight,4,".",""); ?></td>
                    <td align="right"><? echo number_format($grand_tot_weight_lbs,4,".",""); ?></td>
                    <td align="right"><? echo number_format($grand_avg_weight,4,".",""); ?></td>
                    <td>&nbsp;</td>
                </tr>
            </tbody>
        </table>
        <br>
        <table cellspacing="0" width="930" border="1" rules="all" class="rpt_table" >
            <thead bgcolor="#dddddd">
                <tr>
                    <th width="120">Garments Item</th>
                    <th width="150">Garments Color</th>
                    <th width="100">Order Qty</th>
                    <th width="100">Plan Qty.</th>
                    <th width="80">Sample Yarn Color</th>
                    <th width="70">Sample Color %</th>
                    <th width="200">Yarn Color</th>
                    <th>Process Loss %</th>
                </tr>
            </thead>
            <tbody>
            <?
            $po_qty_sql="select item_number_id, color_number_id, order_quantity as order_qty, plan_cut_qnty as plan_cut from wo_po_color_size_breakdown where job_no_mst=$txt_job_no and item_number_id='$gid' and status_active=1 and is_deleted=0";
            
            $po_qty_sql_res=sql_select($po_qty_sql); $po_qty_arr=array();
            foreach($po_qty_sql_res as $row)
            {
                $po_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]]['order_qty']+=$row[csf('order_qty')];
                $po_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]]['plan_cut']+=$row[csf('plan_cut')];
            }
            unset($po_qty_sql_res);
            
            $stripe_sql="select b.id, b.job_no, b.item_number_id, b.pre_cost_fabric_cost_dtls_id, b.color_number_id, b.stripe_color, b.sample_color, b.sample_per, b.cons, b.excess_per from wo_po_color_size_breakdown a, wo_pre_stripe_color b where a.job_no_mst=b.job_no and a.color_number_id=b.color_number_id and b.job_no =$txt_job_no and b.item_number_id='$gid' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 order by a.color_order, b.id ASC";
            $stripe_sql_res=sql_select($stripe_sql);
            
            $stripe_gmts_item_arr=array(); $stripe_gmts_color_arr=array(); $stripe_data_arr=array();
            foreach($stripe_sql_res as $row)
            {
                $stripe_gmts_item_arr[$row[csf('item_number_id')]][$row[csf('id')]]=$row[csf('id')];
                $stripe_gmts_color_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('id')]]=$row[csf('id')];
                $stripe_data_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('sample_color')]]=$row[csf('sample_per')].'___'.$row[csf('stripe_color')].'___'.$row[csf('excess_per')];
            }
            unset($stripe_sql_res); $tot_order_qty=$tot_plan_qty=0;
            foreach($stripe_data_arr as $gmts_itemid=>$gmts_itemid_data)
            {
                $n=0; $stripecount_row=count($stripe_gmts_item_arr[$gmts_itemid]);
                foreach($gmts_itemid_data as $gmts_color=>$sample_data)
                {
                    $count_row=count($stripe_gmts_color_arr[$gmts_itemid][$gmts_color]);
                    $order_qty=0; $plan_cut=0;
                    $order_qty=$po_qty_arr[$gmts_itemid][$gmts_color]['order_qty']; 
                    $plan_cut=$po_qty_arr[$gmts_itemid][$gmts_color]['plan_cut'];
                    
                    $i=1;
                    foreach($sample_data as $yarn_color=>$data)
                    {
                        $ex_data=explode("___",$data);
                        ?>
                        <tr>
                            <?
                            if($n==0) { ?>
                                <td rowspan="<? echo $stripecount_row; ?>" style="word-break:break-all"><? echo $garments_item[$gmts_itemid]; ?></td>
                            <? $n++; }
                            if($i==1)
                            {
                                ?>
                                <td rowspan="<? echo $count_row; ?>" style="word-break:break-all"><? echo $color_arr[$gmts_color]; ?></td>
                                <td rowspan="<? echo $count_row; ?>" align="right"><? echo number_format($order_qty,0,'',','); ?></td>
                                <td rowspan="<? echo $count_row; ?>" align="right"><? echo number_format($plan_cut,0,'',','); ?></td>
                                <?
                                $tot_order_qty+=$order_qty;
                                $tot_plan_qty+=$plan_cut;
                            }
                            ?>
                            <td align="center"><? echo $color_arr[$yarn_color]; ?></td>
                            <td align="right"><? echo $ex_data[0]; ?></td>
                            <td style="word-break:break-all"><? echo $color_arr[$ex_data[1]]; ?></td>
                            <td align="right"><? echo $ex_data[2]; ?></td>
                        </tr>
                        <?
                        $i++;
                    }
                }
            }
            ?>
            </tbody>
            <tfoot>
                <tr bgcolor="#dddddd">
                    <td colspan="2">Total:</td>
                    <td align="right"><? echo number_format($tot_order_qty,0,'',','); ?></td>
                    <td align="right"><? echo number_format($tot_plan_qty,0,'',','); ?></td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td>&nbsp;</td>
                </tr>
            </tfoot>
        </table>
        <?
	}
	echo signature_table(109, $cbo_company_name, "930");
	exit();
}

if($action=="conversion_color_popup"){
	echo load_html_head_contents("Popup Info","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
<script>
var costype=<? echo $cbotypeconversion ?>;
var israte_popup=2;
function set_conversion_charge_unit(i,conversion_from_chart){
	if(israte_popup==2)
	{
	//if(costype==31){
		if(conversion_from_chart==1){
			document.getElementById('unitcharge_'+i).readOnly=true
			set_conversion_charge_unit_pop_up(i)
		}
		else{
			document.getElementById('unitcharge_'+i).readOnly=false
		}
	//}
	}
	else
	{
		if(costype==31){
			if(conversion_from_chart==1){
				document.getElementById('unitcharge_'+i).readOnly=true
				set_conversion_charge_unit_pop_up(i)
			}
			else{
				document.getElementById('unitcharge_'+i).readOnly=false
			}
		}
	}
}

function set_conversion_charge_unit_pop_up(i){
    var cbo_company_name=document.getElementById('cbo_company_name').value;
	var cbotypeconversion=document.getElementById('cbotypeconversion').value
	var txt_exchange_rate=document.getElementById('txt_exchange_rate').value
	var coversionchargelibraryid=document.getElementById('coversionchargelibraryid_'+i).value
	if(cbo_company_name==0){
		alert("Select Company");
		return;
	}
	if(cbotypeconversion==0){
		alert("Select Process");
		return;
	}
	if(txt_exchange_rate==0 || txt_exchange_rate==""){
		alert("Select Exchange Rate");
		return;
	}
	else{
	var page_link='pre_cost_entry_controller_v2.php?action=conversion_chart_popup&cbo_company_name='+cbo_company_name+'&cbotypeconversion='+cbotypeconversion+'&coversionchargelibraryid='+coversionchargelibraryid;
	emailwindow=dhtmlmodal.open('EmailBox', 'iframe', page_link, 'Conversion Chart', 'width=1060px,height=450px,center=1,resize=1,scrolling=0','../')
	emailwindow.onclose=function(){
			var charge_id=this.contentDoc.getElementById("charge_id");
			var charge_value=this.contentDoc.getElementById("charge_value");
			document.getElementById('coversionchargelibraryid_'+i).value=charge_id.value;
			document.getElementById('unitcharge_'+i).value=number_format_common(charge_value.value/txt_exchange_rate,5,0,document.getElementById('cbo_currercy').value);
			calculate_amount(i)
			claculate_avg()
		}
	}
}

function js_set_value_color(){
	var rowCount = $('#tbl_color_details tr').length-3;
	var color_breck_down="";
	var coversionchargelibraryid_baeck_down="";
	for(var i=1; i<=rowCount; i++){
		var unitcharge = $('#unitcharge_'+i).val();
		if(trim(unitcharge) ==''){
			unitcharge=0;
		}
		var coversionchargelibraryid= $('#coversionchargelibraryid_'+i).val();
		if(coversionchargelibraryid==''){
			coversionchargelibraryid=0;
		}
		if(color_breck_down==""){
			color_breck_down=$('#gmtscolorid_'+i).val()+'_'+trim(unitcharge)+'_'+coversionchargelibraryid+'_'+$('#fabriccolorid_'+i).val()+'_'+$('#cons_'+i).val();
		}
		else{
			color_breck_down+="__"+$('#gmtscolorid_'+i).val()+'_'+trim(unitcharge)+'_'+coversionchargelibraryid+'_'+$('#fabriccolorid_'+i).val()+'_'+$('#cons_'+i).val();
		}

		if(coversionchargelibraryid_baeck_down==""){
			coversionchargelibraryid_baeck_down=$('#coversionchargelibraryid_'+i).val()
		}
		else{
			coversionchargelibraryid_baeck_down+="_"+$('#coversionchargelibraryid_'+i).val();
		}
	}
	document.getElementById('color_breck_down').value=color_breck_down;
	document.getElementById('chargelibid_breck_down').value=coversionchargelibraryid_baeck_down;
	parent.emailwindow.hide();
}

function claculate_avg_old(){
	var significant_row=0;
	var total_value=0;
	var rowCount = $('#tbl_color_details tr').length-3;
	for(var i=1; i<=rowCount; i++){
		if(document.getElementById('unitcharge_'+i).value =='' || document.getElementById('unitcharge_'+i).value ==0){
			continue;
		}
		else{
			significant_row=significant_row+1;
			total_value+=(document.getElementById('unitcharge_'+i).value)*1
		}
	}
	var avg_total_value=total_value/significant_row;
	document.getElementById('total_value').value=total_value
	document.getElementById('avg_total_value').value=number_format_common(avg_total_value, 1, 0);
}
function claculate_avg(){
	//var significant_row=0;
	var totalunitcharge=0;
	var total_value=0;
	var total_amount=0;
	var totalreqqty=0;
	var rowCount = $('#tbl_color_details tr').length-3;
	for(var i=1; i<=rowCount; i++){
		if(document.getElementById('unitcharge_'+i).value =='' || document.getElementById('unitcharge_'+i).value ==0){
			continue;
		}
		else{
			//significant_row=significant_row+1;
			var reqqty =document.getElementById('reqqty_'+i).value*1;
			//alert(reqqty);
			totalreqqty+=reqqty;
			var unitcharge=document.getElementById('unitcharge_'+i).value*1;
			totalunitcharge+=unitcharge;
			var value=unitcharge*reqqty;
			total_value+=value;
			var cons =document.getElementById('cons_'+i).value*1;
			var amount=unitcharge*cons;
			total_amount+=amount;
		}
	}
	var orderQty=document.getElementById('orderQty').value*1
	var itemRatio=document.getElementById('itemRatio').value*1
	var avg_total_value=total_value/totalreqqty;
	var avg_total_cons=(totalreqqty/orderQty)*costPer*itemRatio
	var avg_total_amount=(total_value/orderQty)*costPer*itemRatio
	document.getElementById('total_value').value=totalunitcharge
	document.getElementById('total_amount').value=total_amount
	document.getElementById('avg_total_value').value=number_format_common(avg_total_value, 5, 0);
	document.getElementById('avg_total_cons').value=number_format_common(avg_total_cons, 5, 0);
	document.getElementById('avg_total_amount').value=number_format_common(avg_total_amount, 5, 0);
}
function calculate_amount(i){
	//alert(i);
	var cons=document.getElementById('cons_'+i).value*1
	var unitcharge=document.getElementById('unitcharge_'+i).value*1
	var amount= cons*unitcharge;
	document.getElementById('amount_'+i).value=number_format_common(amount, 5, 0);
}
var costPer=<? echo $CostPerQty; ?>

</script>
</head>
<body>
    <?
	$condition= new condition();
	if(str_replace("'","",$job_no) !=''){
		$condition->job_no("='$job_no'");
	}
	$condition->init();
	$GmtsitemRatioArr=$condition->getGmtsitemRatioArr();
	$CostingPerArr=$condition->getCostingPerArr();
	$CostPerQty= $CostingPerArr[str_replace("'","",$job_no)];
	//$GmtsitemRatio=$GmtsitemRatioArr[str_replace("'","",$job_no)][$cbogmtsitem];

	$fabric= new fabric($condition);
	$fabric_costing_arr=$fabric->getQtyArray_by_FabriccostidAndGmtscolor_knitAndwoven_greyAndfinish();

	//print_r($fabric_costing_arr);
	$data_array_update=array();
    $data_array=explode("__",$colorbreakdown);
	if($data_array[0]=="")
	{
		$data_array=array();
	}
	if ( count($data_array)>0)
	{
		$i=0;
		$total_value=0;
		foreach( $data_array as $row )
		{
			$i++;
			$data=explode('_',$row);
			$data_array_update[$data[0]][$data[3]][unitcharge]=$data[1];
			$data_array_update[$data[0]][$data[3]][coversionchargelibraryid]=$data[2];
		}
	}
	if($cbotypeconversion==31) { if($conversion_from_chart==1) $charge_readonly="readonly"; else $charge_readonly=""; } else $charge_readonly="";

	/*else
	{*/
	if($cbocosthead !=0)
	{
	$GmtsitemRatio=0;
	$plan_cut_qntyarray=array();
	$sql_data=sql_select("select a.job_no,c.color_number_id,c.plan_cut_qnty,d.color_size_sensitive,d.item_number_id,f.contrast_color_id AS fabric_color  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_fabric_cost_dtls d,wo_pre_cos_fab_co_avg_con_dtls e left join wo_pre_cos_fab_co_color_dtls f on e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.gmts_color_id  where 1=1  and d.id='$cbocosthead' and a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no  and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and  c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes   and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1");//and e.cons !=0

	foreach($sql_data as $row){
		$plan_cut_qnty+=$row[csf('plan_cut_qnty')];
		$plan_cut_qntyarray[$row[csf('color_number_id')]]+=$row[csf('plan_cut_qnty')];
		$GmtsitemRatio=$GmtsitemRatioArr[$row[csf('job_no')]][$row[csf('item_number_id')]];
	}

		$tdColor="Color";
		$color_size_sensitive=return_field_value("color_size_sensitive", "wo_pre_cost_fabric_cost_dtls", "id=$cbocosthead");
		$color_type_id=return_field_value("color_type_id", "wo_pre_cost_fabric_cost_dtls", "id=$cbocosthead");

		if($color_type_id !=2 && $color_type_id !=3 && $color_type_id !=4 && $color_type_id !=6 && $color_type_id !=31  && $color_type_id !=32 && $color_type_id !=33 && $color_type_id !=34)
		{
			//$data_array=sql_select("select distinct a.color_number_id from  wo_po_color_size_breakdown a,wo_pre_cos_fab_co_avg_con_dtls b  where a.id=b.color_size_table_id and b.pre_cost_fabric_cost_dtls_id='$cbocosthead' and a.status_active=1 and  a.is_deleted=0 ");
			$data_array=sql_select("select c.color_number_id,d.color_size_sensitive,f.contrast_color_id AS fabric_color  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_fabric_cost_dtls d,wo_pre_cos_fab_co_avg_con_dtls e left join wo_pre_cos_fab_co_color_dtls f on e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.gmts_color_id  where 1=1  and d.id='$cbocosthead' and a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no  and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and  c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes    and e.cons !=0   and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 group by c.color_number_id,f.contrast_color_id,d.color_size_sensitive ");
			$tdColor="Gmts Color";
		}
		else if($cbotypeconversion==30 && ($color_type_id ==2 || $color_type_id ==3 || $color_type_id ==4 || $color_type_id ==6 || $color_type_id ==31 || $color_type_id ==32 || $color_type_id ==33 || $color_type_id ==34))
		{
			//$data_array=sql_select("select  stripe_color as color_number_id , fabreqtotkg as req_qty from wo_pre_stripe_color where pre_cost_fabric_cost_dtls_id='$cbocosthead' and status_active=1 and  is_deleted=0");

			$data_array=sql_select("select c.color_number_id,d.color_size_sensitive,f.id,f.stripe_color AS fabric_color ,f.fabreq as  fabreq, f.fabreqtotkg as req_qty from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_fabric_cost_dtls d,wo_pre_cos_fab_co_avg_con_dtls e left join wo_pre_stripe_color f on e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.color_number_id and f.yarn_dyed=1  where 1=1  and d.id='$cbocosthead' and a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no  and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and  c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes    and e.cons !=0   and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 group by c.color_number_id,d.color_size_sensitive,f.id ,f.stripe_color,f.fabreq,f.fabreqtotkg  order by c.color_number_id");
			$tdColor="Stripe Color";
			if(count($data_array) <=0){
				//$data_array=sql_select("select distinct a.color_number_id from  wo_po_color_size_breakdown a,wo_pre_cos_fab_co_avg_con_dtls b  where a.id=b.color_size_table_id and b.pre_cost_fabric_cost_dtls_id='$cbocosthead' and a.status_active=1  and  a.is_deleted=0 ");
				$data_array=sql_select("select c.color_number_id,d.color_size_sensitive,f.contrast_color_id AS fabric_color  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_fabric_cost_dtls d,wo_pre_cos_fab_co_avg_con_dtls e left join wo_pre_cos_fab_co_color_dtls f on e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.gmts_color_id  where 1=1  and d.id='$cbocosthead' and a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no  and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and  c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes    and e.cons !=0   and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 group by c.color_number_id,f.contrast_color_id,d.color_size_sensitive");
				$tdColor="Stripe Color";
			}
		}
		/*else if($color_size_sensitive==3)
		{
		 	$data_array=sql_select("select  contrast_color_id as color_number_id, gmts_color_id from wo_pre_cos_fab_co_color_dtls where pre_cost_fabric_cost_dtls_id='$cbocosthead'");
			$tdColor="Contrast Color";
		}
		else if($color_size_sensitive==0)
		{
			$data_array=sql_select("select  color as color_number_id  from wo_pre_cost_fabric_cost_dtls where id='$cbocosthead'");
			$tdColor="Color";
		}*/
		else{

			$data_array=sql_select("select c.color_number_id,d.color_size_sensitive,f.contrast_color_id AS fabric_color  from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_fabric_cost_dtls d,wo_pre_cos_fab_co_avg_con_dtls e left join wo_pre_cos_fab_co_color_dtls f on e.pre_cost_fabric_cost_dtls_id=f.pre_cost_fabric_cost_dtls_id and e.color_number_id=f.gmts_color_id  where 1=1  and d.id='$cbocosthead' and a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no  and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and  c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes    and e.cons !=0   and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 group by c.color_number_id,f.contrast_color_id,d.color_size_sensitive");
			$tdColor="Gmts Color";
		}
		?>
        
        <form id="contrastcolor_1" autocomplete="off">
            <input type="hidden" id="color_breck_down" />
            <input type="hidden" id="chargelibid_breck_down" />
            <input type="hidden" id="cbo_company_name" value="<? echo $cbo_company_name;?>" />
            <input type="hidden" id="cbotypeconversion" value="<? echo $cbotypeconversion;?>" />
            <input type="hidden" id="txt_exchange_rate" value="<? echo $txt_exchange_rate;?>" />
            <input type="hidden" id="cbo_currercy" value="<? echo $cbo_currercy;?>" />
            <input type="hidden" id="orderQty" value="<? echo $plan_cut_qnty;?>" />
            <input type="hidden" id="itemRatio" value="<? echo $GmtsitemRatio;?>" />
            <table width="300" cellspacing="0" class="rpt_table" border="0" id="tbl_color_details" rules="all">
                <thead>
                <tr>
                <th width="30">Sl</th>
                <th width="120" title="<? echo $tdColor; ?>">Gmts Color</th>
                <th width="120" title="<? echo $tdColor; ?>">Fabric Color</th>
                <th width="60">Cons</th>
                <th>Charge/Unit</th>
                <!--<th>Amount</th>-->
                </tr>
                </thead>
                <tbody>
		<?
		$i=0;
		$avg_num=0;
		$totalCons=0;
		$total_value=0;
		//print_r($data_array);
		foreach( $data_array as $row ){

			$i++;
			//echo $row[csf('color_size_sensitive')];
			$colorreqqty=0;
			if($color_size_sensitive==1 && $color_type_id !=2 && $color_type_id !=3 && $color_type_id !=4 && $color_type_id !=6 && $color_type_id !=31 && $color_type_id !=32 && $color_type_id !=33 && $color_type_id !=34){
				$colorreqqty=array_sum($fabric_costing_arr['knit']['grey'][$cbocosthead][$row[csf('color_number_id')]]);
			}
			else if($color_size_sensitive==1 && $cbotypeconversion==30 && ($color_type_id ==2 || $color_type_id ==3 || $color_type_id ==4 || $color_type_id ==6 || $color_type_id ==31 || $color_type_id ==32 || $color_type_id ==33 || $color_type_id ==34)){
				$colorreqqty=$row[csf('req_qty')];
				if($row[csf('req_qty')]==""){
					$colorreqqty=array_sum($fabric_costing_arr['knit']['grey'][$cbocosthead][$row[csf('color_number_id')]]);
				}
			}
			else if($color_size_sensitive==3){
				$colorreqqty=array_sum($fabric_costing_arr['knit']['grey'][$cbocosthead][$row[csf('gmts_color_id')]]);
			}
			else{
				$colorreqqty=array_sum($fabric_costing_arr['knit']['grey'][$cbocosthead][$row[csf('color_number_id')]]);
			}

			//echo $cbocosthead."=".$row[csf('gmts_color_id')]."<br/>";
			$fab_colo=$row[csf('fabric_color')];
			if($row[csf('color_size_sensitive')]==1 && $cbotypeconversion !=30){
				$fab_colo=$row[csf('color_number_id')];
			}

			if($cbotypeconversion !=30){
			$colorreqqty=array_sum($fabric_costing_arr['knit']['grey'][$cbocosthead][$row[csf('color_number_id')]]);
			$DznGreyreq=(array_sum($fabric_costing_arr['knit']['grey'][$cbocosthead][$row[csf('color_number_id')]])/$plan_cut_qntyarray[$row[csf('color_number_id')]])*$CostPerQty*$GmtsitemRatio;
			}
			if($cbotypeconversion ==30){
			$colorreqqty=$row[csf('req_qty')];
			$DznGreyreq=$row[csf('fabreq')];
			}

			$unitcharge=0;
			if($data_array_update[$row[csf('color_number_id')]][$fab_colo][unitcharge]==""){
			$unitcharge=$conversion_qnty;
			}
			else{
			$unitcharge=$data_array_update[$row[csf('color_number_id')]][$fab_colo][unitcharge];
			}
			$total_value+=$unitcharge;
			if($unitcharge > 0){
			$avg_num+=1;
			}
			$totalCons+=$DznGreyreq;;
			/*if($row[csf('color_size_sensitive')]==1 $cbotypeconversion !=30){
				$fab_colo=$row[csf('color_number_id')];
			}*/
	?>
            <tr>
                <td><? echo $i; ?></td>
                <td>
                <input type="hidden" id="gmtscolorid_<? echo $i;?>"   name="gmtscolorid_<? echo $i;?>" style="width:50px"  class="text_boxes"   value="<? echo $row[csf('color_number_id')]; ?>"  readonly/>
                <input type="hidden" id="reqqty_<? echo $i;?>"   name="reqqty_<? echo $i;?>" style="width:50px"  class="text_boxes"   value="<? echo $colorreqqty; ?>"  readonly/>
                <input type="text" id="gmtscolor_<? echo $i;?>"   name="gmtscolor_<? echo $i;?>" style="width:120px"  class="text_boxes"   value="<? echo $color_library[$row[csf('color_number_id')]]; ?>"   readonly/>

                </td>
                 <td>
                <input type="hidden" id="fabriccolorid_<? echo $i;?>"   name="fabriccolorid_<? echo $i;?>" style="width:50px"  class="text_boxes"   value="<? echo $fab_colo; ?>"  readonly/>
                <input type="text" id="fabriccolor_<? echo $i;?>"   name="fabriccolor_<? echo $i;?>" style="width:120px"  class="text_boxes"   value="<? echo $color_library[$fab_colo]; ?>"   readonly/>

                </td>
                  <td>
                <input type="text" id="cons_<? echo $i;?>"   name="cons_<? echo $i;?>" value="<? echo $DznGreyreq; ?>" style="width:150px"  class="text_boxes_numeric" readonly/>
                </td>

                <td>
                <input type="text" id="unitcharge_<? echo $i;?>" name="unitcharge_<? echo $i;?>" value="<? echo trim($unitcharge); ?>" onChange="claculate_avg(); calculate_amount(<? echo $i; ?>)" onClick="set_conversion_charge_unit(<? echo $i; ?>,<? echo $conversion_from_chart; ?>)" style="width:150px" class="text_boxes_numeric" <? echo $charge_readonly; ?>/>
                <input type="hidden" id="coversionchargelibraryid_<? echo $i;?>"   name="coversionchargelibraryid_<? echo $i;?>" value="<? echo $data_array_update[$row[csf('color_number_id')]][coversionchargelibraryid]; ?>"  readonly/>
                                <input type="hidden" id="amount_<? echo $i;?>"   name="amount_<? echo $i;?>" value="<? //echo $DznGreyreq; ?>" style="width:150px"  class="text_boxes_numeric" readonly/>

                </td>
                <!--<td>
                </td>-->
            </tr>
		<?
        }
        }
        else
        {
            $color_array=array();
            $color_size_sensitive_array=sql_select("select  id,color_size_sensitive  from wo_pre_cost_fabric_cost_dtls where job_no='".$job_no."' and fabric_source=1");
            foreach( $color_size_sensitive_array as $color_size_sensitive_row ){
                if($color_size_sensitive_row[csf('color_size_sensitive')]==1){
                    $data_array1=sql_select("select distinct a.color_number_id as color_number_id  from  wo_po_color_size_breakdown a,wo_pre_cos_fab_co_avg_con_dtls b  where a.id=b.color_size_table_id and b.pre_cost_fabric_cost_dtls_id='".$color_size_sensitive_row[csf('id')]."' and a.status_active=1 and  a.is_deleted=0 ");
                    //echo "select distinct a.color_number_id as color_number_id  from  wo_po_color_size_breakdown a,wo_pre_cos_fab_co_avg_con_dtls b  where a.id=b.color_size_table_id and b.pre_cost_fabric_cost_dtls_id='".$color_size_sensitive_row[csf('id')]."' and a.status_active=1 and  a.is_deleted=0 ";
                    foreach( $data_array1 as $row1 ){
                        if (array_key_exists($row1[csf('color_number_id')], $color_array)) {
                            continue;
                        }
                        else{
                            $color_array[$row1[csf('color_number_id')]]=$row1[csf('color_number_id')];
                        }
                    }


                }
                if($color_size_sensitive_row[csf('color_size_sensitive')]==3)
                {

                    $data_array2=sql_select("select  contrast_color_id as color_number_id  from wo_pre_cos_fab_co_color_dtls where pre_cost_fabric_cost_dtls_id='".$color_size_sensitive_row[csf('id')]."'");
                    //echo "select  contrast_color_id as color_number_id  from wo_pre_cos_fab_co_color_dtls where id='".$color_size_sensitive_row[csf('id')]."'";
                    foreach( $data_array2 as $row2 )
                    {
                        if (array_key_exists($row2[csf('color_number_id')], $color_array))
                        {
                            continue;
                        }
                        else
                        {
                            $color_array[$row2[csf('color_number_id')]]=$row2[csf('color_number_id')];
                        }
                    }

                }
                if($color_size_sensitive_row[csf('color_size_sensitive')]==0)
                {
                    $data_array3=sql_select("select  color as color_number_id  from wo_pre_cost_fabric_cost_dtls where id='".$color_size_sensitive_row[csf('id')]."'");
                    foreach( $data_array3 as $row3 )
                    {
                        if (array_key_exists($row3[csf('color_number_id')], $color_array))
                        {
                            continue;
                        }
                        else
                        {
                            $color_array[$row3[csf('color_number_id')]]=$row3[csf('color_number_id')];
                        }
                    }
                }
            }
            $i=0;
            $avg_num=0;
            $total_value=0;
            foreach( $color_array as $key=>$value )
            {
            $unitcharge=0;
            if($data_array_update[$value][unitcharge]=="")
            {
            $unitcharge=$conversion_qnty;
            }
            else
            {
            $unitcharge=$data_array_update[$value][unitcharge];
            }
            $total_value+=$unitcharge;

            if($unitcharge > 0)
            {
            $avg_num+=1;
            }

            $i++;
		?>
            <tr>
                <td><? echo $i; ?></td>
                <td> <input type="hidden" id="gmtscolorid_<? echo $i;?>"   name="gmtscolorid_<? echo $i;?>" style="width:50px"  class="text_boxes"   value="<? echo $value; ?>"  readonly/>
                <input type="text" id="gmtscolor_<? echo $i;?>"   name="gmtscolor_<? echo $i;?>" style="width:120px"  class="text_boxes"   value="<? echo $color_library[$value]; ?>"  readonly/></td>
                <td> <input type="hidden" id="fabriccolorid_<? echo $i;?>"   name="fabriccolorid_<? echo $i;?>" style="width:50px"  class="text_boxes"   value="<? echo $value; ?>"  readonly/>
                <input type="text" id="fabriccolor_<? echo $i;?>"   name="fabriccolor_<? echo $i;?>" style="width:120px"  class="text_boxes"   value="<? echo $color_library[$value]; ?>"  readonly/></td>
                 <td>
                <input type="text" id="cons_<? echo $i;?>"   name="cons_<? echo $i;?>" value="<? //echo $unitcharge; ?>" style="width:150px"  class="text_boxes_numeric"/>
                                <input type="hidden" id="amount_<? echo $i;?>"   name="amount_<? echo $i;?>" value="<? //echo $DznGreyreq; ?>" style="width:150px"  class="text_boxes_numeric" readonly/>

                </td>

                <td>
                <input type="text" id="unitcharge_<? echo $i;?>"   name="unitcharge_<? echo $i;?>" style="width:150px" onChange="claculate_avg()" onClick="set_conversion_charge_unit(<? echo $i; ?>,<? echo $conversion_from_chart; ?>)" value="<? echo trim($unitcharge); ?>"  class="text_boxes_numeric" <? echo $charge_readonly; ?>/>
                <input type="hidden" id="coversionchargelibraryid_<? echo $i;?>"   name="coversionchargelibraryid_<? echo $i;?>" value="<? echo $data_array_update[$row[csf('color_number_id')]][coversionchargelibraryid]; ?>"  readonly/>
                </td>
                <!--<td>
                </td>-->
            </tr>

			<?
            }
        }
        //}
        ?>
</tbody>
<tfoot>
<tr>
			<th><? echo $avg_num;  ?></th>
			<th>
            Total
			</th>
            <th>

			</th>
            <th>
            <input type="text" id="total_cons"   name="total_cons" style="width:150px" value="<? echo $totalCons; ?>"  class="text_boxes_numeric"/>
			</th>
			<th>
            <input type="text" id="total_value"   name="total_value" style="width:150px" value="<? echo $total_value; ?>"  class="text_boxes_numeric"/>
            <input type="hidden" id="total_amount"   name="total_amount" style="width:150px" value="<? echo def_number_format(($total_value/$avg_num),$cbo_currercy,0); ?>"  class="text_boxes_numeric"/>
            </th>
            <!--<th>

            </th>-->
		</tr>
        <tr>
			<th></th>
			<th>
            Avg Total
			</th>
            <th>

			</th>
            <th>
            <input type="text" id="avg_total_cons"   name="avg_total_cons" style="width:150px" value="<? //echo $total_value; ?>"  class="text_boxes_numeric"/>
			</th>
			<th><input type="text" id="avg_total_value"   name="avg_total_value" style="width:150px" value="<? //echo def_number_format(($total_value/$avg_num),$cbo_currercy,0); ?>"  class="text_boxes_numeric"/>
                        <input type="hidden" id="avg_total_amount"   name="avg_total_amount" style="width:150px" value="<? //echo def_number_format(($total_value/$avg_num),$cbo_currercy,0); ?>"  class="text_boxes_numeric"/>
</th>
           <!-- <th>
			</th>-->
		</tr>
</tfoot>
</table>
 <table width="300" cellspacing="0" class="" border="0">

                	<tr>
                        <td align="center" height="15" width="100%"> </td>
                    </tr>
                	<tr>
                        <td align="center" width="100%" class="button_container">

						        <input type="button" class="formbutton" value="Close" onClick="js_set_value_color()"/>

                        </td>
                    </tr>
                </table>
</form>
</body>
<script>
claculate_avg();
</script>
<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
</html>
    <?
	exit();
}
?>
