<?
/*-------------------------------------------- Comments
Version                  :  V1
Purpose			         : 	This form will create Woven Garments Fabric Booking
Functionality	         :
JS Functions	         :
Created by		         :	Monzu
Creation date 	         : 	27-12-2012
Updated by 		         :
Update date		         :
QC Performed BY	         :
QC Date			         :
Comments		         : From this version oracle conversion is start
						   Date 08-08-15, Merchandizing >Main Fabric booking > Fabric booking booking GR > Cuff - Color Size Breakdown in Pcs > Contrast color is not showing. Issue id=5749 update by jahid
-----------------------------------------------------*/

header('Content-type:text/html; charset=utf-8');
session_start();
if( $_SESSION['logic_erp']['user_id'] == "" ) header("location:login.php");
include('../../../includes/common.php');
$data=$_REQUEST['data'];
$action=$_REQUEST['action'];
$permission=$_SESSION['page_permission'];
$user_id=$_SESSION['logic_erp']['user_id'];
$buyer_cond=set_user_lavel_filtering(' and buy.id','buyer_id');
$company_cond=set_user_lavel_filtering(' and comp.id','company_id');
include('../../../includes/class4/class.conditions.php');
include('../../../includes/class4/class.reports.php');
include('../../../includes/class4/class.fabrics.php');
include('../../../includes/class4/class.yarns.php');
include('../../../includes/class4/class.trims.php');
//echo $permission;

$userCredential = sql_select("SELECT unit_id as company_id, brand_id FROM user_passwd where id=$user_id");

$brand_id = $userCredential[0][csf('brand_id')];
$brand_cond="";

if ($brand_id !='') {
    $brand_cond = " and id in ( $brand_id)";
}
//---------------------------------------------------- Start---------------------------------------------------------------------------
function load_drop_down_suplier($paymode,$company){
	$cbo_supplier_name='';
	if($paymode==5 || $paymode==3){
		//echo "select id,company_name from lib_company where status_active=1 and is_deleted=0 order by company_name";
		$cbo_supplier_name= create_drop_down( "cbo_supplier_name", 140, "select id,company_name from lib_company where status_active=1 and is_deleted=0 order by company_name", "id,company_name",1, "-- Select Supplier --", "", "validate_suplier()",0,"" );
	}
	else{
		$suplier_data=sql_select("select a.id,a.supplier_name,a.tag_company from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type=9 and   a.status_active =1 and a.is_deleted=0 order by supplier_name");

		foreach($suplier_data as $val){
				 $companyArr=explode(",",$val[csf('tag_company')]);
				 foreach($companyArr as $cid){
					if($company==$cid){
						$suplierArr[$val[csf('id')]]=$val[csf('supplier_name')];
					}
				 }
		}
		$cbo_supplier_name= create_drop_down( "cbo_supplier_name", 140, $suplierArr,"", 1, "-- Select Supplier --", $selected, "",0 );
	}
	return $cbo_supplier_name;
}

if ($action=="load_drop_down_buyer"){
	echo create_drop_down( "cbo_buyer_name", 140, "select buy.id,buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active=1 and buy.is_deleted=0 $buyer_cond and b.buyer_id=buy.id and b.tag_company='$data' and buy.id in (select  buyer_id from  lib_buyer_party_type where party_type in (1,3,21,90)) group by buy.id,buy.buyer_name order by buyer_name","id,buyer_name", 1, "-- Select Buyer --", $selected, "load_drop_down( 'requires/partial_fabric_booking_controller', this.value, 'load_drop_down_brand', 'brand_td');","","" );
	exit();
}

if ($action=="load_drop_down_buyer_popup"){
	echo create_drop_down( "cbo_buyer_name", 150, "select buy.id,buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active=1 and buy.is_deleted=0 $buyer_cond and b.buyer_id=buy.id and b.tag_company='$data' and buy.id in (select  buyer_id from  lib_buyer_party_type where party_type in (1,3,21,90)) group by buy.id,buy.buyer_name order by buyer_name","id,buyer_name", 1, "-- Select Buyer --", $selected, "","0","" );
	exit();
}

if ($action=="load_drop_down_suplier"){
	list($data,$company)=explode("_",$data);
	if($data==5 || $data==3){
	echo create_drop_down( "cbo_supplier_name", 140, "select id,company_name from lib_company where status_active=1 and is_deleted=0 order by company_name", "id,company_name",1, "-- Select Supplier --", "", "validate_suplier()",0,"" );
	}
	else{

		$suplier_data=sql_select("select a.id,a.supplier_name,a.tag_company from lib_supplier a, lib_supplier_party_type b where a.id=b.supplier_id and b.party_type=9 and   a.status_active =1 and a.is_deleted=0 order by supplier_name");

		foreach($suplier_data as $val){
				 $companyArr=explode(",",$val[csf('tag_company')]);
				 foreach($companyArr as $cid){
					if($company==$cid){
						$suplierArr[$val[csf('id')]]=$val[csf('supplier_name')];
					}
				 }
		}

	echo create_drop_down( "cbo_supplier_name", 140, $suplierArr,"", 1, "-- Select Supplier --", $selected, "fill_attention(this.value)",0 );
	}
	exit();
}

if($action=="get_attention_name"){
	$data=explode("_",$data);
	$contact_person='';
	if($data[1] !=5){
		$sql=sql_select("select id,contact_person from lib_supplier  where id=$data[0] and  status_active =1 and is_deleted=0");
	}
	if($data[1] ==5){
		$sql=sql_select("select id,contract_person as contact_person from  lib_company  where id=$data[0] and  status_active =1 and is_deleted=0");
	}
	foreach($sql as $row){
		$contact_person=$row[csf('contact_person')];
	}
	echo $contact_person;
}

if ($action=="load_drop_down_brand")
{
	echo create_drop_down( "cbo_brand_id", 140, "select id, brand_name from lib_buyer_brand where buyer_id='$data' and status_active =1 and is_deleted=0 $brand_cond order by brand_name ASC","id,brand_name", 1, "-Brand-", $selected, "" );
	exit();
}

if($action=="check_conversion_rate"){
	$data=explode("**",$data);
	if($db_type==0){
		$conversion_date=change_date_format($data[1], "Y-m-d", "-",1);
	}
	else{
		$conversion_date=change_date_format($data[1], "d-M-y", "-",1);
	}
	$currency_rate=set_conversion_rate( $data[0], $conversion_date ,$data[2]);
	echo "1"."_".$currency_rate;
	exit();
}

if($action=="check_month_maintain"){
	$sql_result=sql_select("select tna_integrated from variable_order_tracking where company_name='$data' and variable_list=14 and status_active=1 and is_deleted=0");
	//echo "select tna_integrated from variable_order_tracking where company_name='$data' and variable_list=14 and status_active=1 and is_deleted=0";
	$maintain_setting=$sql_result[0][csf('tna_integrated')];
	if($maintain_setting==1){
		echo "1"."_";
	}
	else{
		echo "0"."_";
	}
	exit();
}

if ($action=="fabric_booking_popup")
{
	echo load_html_head_contents("Booking Search","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
	function set_checkvalue()
	{
			if(document.getElementById('chk_job_wo_po').value==0) document.getElementById('chk_job_wo_po').value=1;
			else document.getElementById('chk_job_wo_po').value=0;
	}
	function js_set_value(booking_no){
		document.getElementById('selected_booking').value=booking_no;
		parent.emailwindow.hide();
	}
	</script>
	</head>
	<body>
        <div align="center" style="width:100%;" >
        <form name="searchorderfrm_1"  id="searchorderfrm_1" autocomplete="off">
            <table width="100%" cellspacing="0" cellpadding="0" border="1" class="rpt_table" rules="all">
                <thead>
                    <tr>
                        <th colspan="11">
                        <?
                        // echo create_drop_down( "cbo_search_category", 140, $string_search_type,'', 1, "-- Search Catagory --" );
                        ?>
                        <input type="hidden" id="cbo_search_category">
                        </th>
                    </tr>
                    <tr>
                        <th width="150">Company Name</th>
                        <th width="150">Buyer Name</th>
                        <th width="80">Booking No</th>
                        <th width="80">Job No</th>
                        <th width="80">File No</th>
                        <th width="80">Internal Ref.</th>
                        <th width="80">Style Ref </th>
                        <th width="80">Order No</th>
                        <th width="130" colspan="2">Date Range</th>
                        <th><input type="checkbox" value="0" onClick="set_checkvalue()" id="chk_job_wo_po">WO Without Item</th>
                    </tr>
                </thead>
                <tr class="general">
                    <td>
                    <input type="hidden" id="selected_booking">
                    <?
					//echo "select id,company_name from lib_company comp where status_active=1 and is_deleted=0 and core_business not in(3) $company_cond order by company_name";
                    echo create_drop_down( "cbo_company_mst", 150, "select id,company_name from lib_company comp where status_active=1 and is_deleted=0 and core_business not in(3) $company_cond order by company_name","id,company_name",1, "-- Select Company --", '', "load_drop_down( 'partial_fabric_booking_controller', this.value, 'load_drop_down_buyer_popup', 'buyer_td' );",1);
                    ?>
                    </td>
                    <td id="buyer_td">
                    <? echo create_drop_down( "cbo_buyer_name", 150, $blank_array,"", 1, "-- Select Buyer --" );?>
                    </td>
                    <td><input name="txt_booking_prifix" id="txt_booking_prifix" class="text_boxes" style="width:70px"></td>
                    <td><input name="txt_job_prifix" id="txt_job_prifix" class="text_boxes" style="width:70px"></td>
                    <td><input name="txt_file_no" id="txt_file_no" class="text_boxes" style="width:70px"></td>
                    <td><input name="txt_internal_ref" id="txt_internal_ref" class="text_boxes" style="width:70px"></td>
                    <td><input name="txt_style" id="txt_style" class="text_boxes" style="width:70px"></td>
                    <td><input name="txt_order_search" id="txt_order_search" class="text_boxes" style="width:70px"></td>
                    <td><input name="txt_date_from" id="txt_date_from" class="datepicker" style="width:60px"></td>
                    <td><input name="txt_date_to" id="txt_date_to" class="datepicker" style="width:60px"></td>
                    <td align="center">
                    <input type="button" name="button2" class="formbutton" value="Show" onClick="show_list_view ( document.getElementById('cbo_company_mst').value+'_'+document.getElementById('cbo_buyer_name').value+'_'+document.getElementById('txt_date_from').value+'_'+document.getElementById('txt_date_to').value+'_'+document.getElementById('txt_job_prifix').value+'_'+document.getElementById('cbo_year_selection').value+'_'+document.getElementById('txt_booking_prifix').value+'_'+document.getElementById('cbo_search_category').value+'_'+document.getElementById('txt_file_no').value+'_'+document.getElementById('txt_internal_ref').value+'_'+document.getElementById('txt_style').value+'_'+document.getElementById('txt_order_search').value+'_'+document.getElementById('chk_job_wo_po').value, 'create_booking_search_list_view', 'search_div', 'partial_fabric_booking_controller','setFilterGrid(\'list_view\',-1)');" style="width:100px;" /></td>
                </tr>
                <tr>
                    <td colspan="11" align="center" valign="middle">
                    	<?=load_month_buttons(1); ?>
                    </td>
                </tr>
            </table>
            <div id="search_div"></div>
        </form>
        </div>
	</body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    <script type="text/javascript">
		$("#cbo_company_mst").val(<?=$company; ?>);
		load_drop_down( 'partial_fabric_booking_controller', $("#cbo_company_mst").val(), 'load_drop_down_buyer_popup', 'buyer_td' );
	</script>
	</html>
	<?
	exit();
}

if ($action=="create_booking_search_list_view")
{
	$data=explode('_',$data);
	if ($data[0]!=0) $company="  a.company_id='$data[0]'"; else { echo "Please Select Company First."; die; }
	if ($data[1]!=0) $buyer=" and a.buyer_id='$data[1]'"; else $buyer="";
	if($db_type==0) $year_cond=" and SUBSTRING_INDEX(b.insert_date, '-', 1)=$data[5]";
	if($db_type==2) $year_cond=" and to_char(b.insert_date,'YYYY')=$data[5]";
	if($db_type==0) $booking_year_cond=" and SUBSTRING_INDEX(a.insert_date, '-', 1)=$data[5]";
	if($db_type==2) $booking_year_cond=" and to_char(a.insert_date,'YYYY')=$data[5]";
	if($data[7]==1){
		if (str_replace("'","",$data[6])!="") $booking_cond=" and a.booking_no_prefix_num='$data[6]'"; else $booking_cond="";
		if (str_replace("'","",$data[4])!="") $job_cond=" and c.job_no_prefix_num='$data[4]'"; else $job_cond="";
		if (trim($data[10])!="") $style_cond=" and c.style_ref_no ='$data[10]'"; //else  $style_cond="";
		if (trim($data[9])!="") $ref_cond=" and d.grouping ='$data[9]'";// echo  $ref_cond; //else  $style_cond="";
		if (str_replace("'","",$data[11])!="") $order_cond=" and d.po_number = '$data[11]'"; //else  $order_cond="";
	}
	if($data[7]==2){
		if (str_replace("'","",$data[6])!="") $booking_cond=" and a.booking_no_prefix_num like '$data[6]%' $booking_year_cond "; else $booking_cond="";
		if (str_replace("'","",$data[4])!="") $job_cond=" and c.job_no_prefix_num like '$data[4]%' $year_cond "; else $job_cond="";
		if (trim($data[10])!="") $style_cond=" and c.style_ref_no like '$data[10]%'"; //else  $style_cond="";
		if (trim($data[9])!="") $ref_cond=" and d.grouping like '$data[9]%'"; //else  $style_cond="";
		if (str_replace("'","",$data[11])!="") $order_cond=" and d.po_number like '$data[11]%'  "; //else  $order_cond="";
	}

	if($data[7]==3){
		if (str_replace("'","",$data[6])!="") $booking_cond=" and a.booking_no_prefix_num like '%$data[6]' $booking_year_cond "; else  $booking_cond="";
		if (str_replace("'","",$data[4])!="") $job_cond=" and c.job_no_prefix_num like '%$data[4]' $year_cond "; else $job_cond="";
		if (trim($data[10])!="") $style_cond=" and c.style_ref_no like'%$data[10]'"; //else  $style_cond="";
		if (trim($data[9])!="") $ref_cond=" and d.grouping like '%$data[9]'"; //else  $style_cond="";
		if (str_replace("'","",$data[11])!="") $order_cond=" and d.po_number like '%$data[11]'  "; //else  $order_cond="";
	}
	if($data[7]==4 || $data[7]==0){
		if (str_replace("'","",$data[6])!="") $booking_cond=" and a.booking_no_prefix_num like '%$data[6]%' $booking_year_cond  "; else  $booking_cond="";
		if (str_replace("'","",$data[4])!="") $job_cond=" and c.job_no_prefix_num like '%$data[4]%'  $year_cond  "; else  $job_cond="";
		if (trim($data[10])!="") $style_cond=" and c.style_ref_no like '%$data[10]%'"; //else  $style_cond="";
			if (trim($data[9])!="") $ref_cond=" and d.grouping like '%$data[9]%'"; //else  $style_cond="";
		if (str_replace("'","",$data[11])!="") $order_cond=" and d.po_number like '%$data[11]%'  "; //else  $order_cond="";
	}

	$file_no = str_replace("'","",$data[8]);
	$internal_ref = str_replace("'","",$data[9]);
	if ($file_no=="") $file_no_cond=""; else $file_no_cond=" and d.file_no='".trim($file_no)."' ";
	if ($internal_ref=="") $internal_ref_cond=""; else $internal_ref_cond=" and d.grouping='".trim($internal_ref)."' ";

	if($db_type==0){
		if ($data[2]!="" &&  $data[3]!="") $booking_date  = "and a.booking_date  between '".change_date_format($data[2], "yyyy-mm-dd", "-")."' and '".change_date_format($data[3], "yyyy-mm-dd", "-")."'"; else $booking_date ="";
	}
	if($db_type==2){
		if ($data[2]!="" &&  $data[3]!="") $booking_date  = "and a.booking_date  between '".change_date_format($data[2], "yyyy-mm-dd", "-",1)."' and '".change_date_format($data[3], "yyyy-mm-dd", "-",1)."'"; else $booking_date ="";
	}

	$po_array=array();
	$job_prefix_num=array();
	$sql_po= sql_select("select a.booking_no, a.po_break_down_id, a.job_no from wo_booking_mst a where $company $buyer $booking_date and a.booking_type=1 and a.is_short=2 and a.entry_form=108 and a.status_active=1 and a.is_deleted=0 order by a.booking_no");
	foreach($sql_po as $row){
		$po_id=explode(",",$row[csf("po_break_down_id")]);
		$job_prefix_arr=explode("-",$row[csf("job_no")]);
		$po_number_string="";
		foreach($po_id as $key=> $value ){
			$po_number_string.=$po_number[$value].",";
		}
		$po_array[$row[csf("po_break_down_id")]]=rtrim($po_number_string,",");
		$job_prefix_num[$row[csf("job_no")]]=ltrim($job_prefix_arr[2],0);
	}

	$approved=array(0=>"No",1=>"Yes",2=>"No",3=>"Yes");
	$is_ready=array(0=>"No",1=>"Yes",2=>"No");
	$buyer_arr=return_library_array( "select id, short_name from lib_buyer",'id','short_name');
	$comp=return_library_array( "select id, company_short_name from lib_company",'id','company_short_name');
	$suplier=return_library_array( "select id, short_name from lib_supplier",'id','short_name');
	$arr=array (2=>$comp,3=>$buyer_arr,4=>$job_prefix_num,6=>$po_array,9=>$item_category,10=>$fabric_source,11=>$suplier,12=>$approved,13=>$is_ready);
	if($data[12]==0)
	{
		 $sql="select min(a.id) as id, a.booking_no_prefix_num, a.pay_mode, a.booking_no, a.company_id, a.buyer_id, a.booking_date, a.delivery_date, a.item_category, a.fabric_source, a.supplier_id, a.is_approved, a.ready_to_approved, c.gmts_item_id, c.job_no_prefix_num, c.style_ref_no, d.po_number, d.grouping, d.file_no
		from wo_booking_mst a, wo_booking_dtls b, wo_po_details_master c, wo_po_break_down d
		where a.booking_no=b.booking_no and b.job_no=c.job_no and b.job_no=d.job_no_mst and b.po_break_down_id=d.id and a.booking_type=1 and a.entry_form=108 and  a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and $company $buyer $booking_date $booking_cond $style_cond $ref_cond $order_cond $job_cond
		group by a.booking_no_prefix_num, a.pay_mode, a.booking_no, a.company_id, a.buyer_id, a.booking_date, a.delivery_date, a.item_category, a.fabric_source, a.supplier_id, a.is_approved, a.ready_to_approved, c.job_no_prefix_num, c.gmts_item_id, c.style_ref_no, d.po_number, d.grouping, d.file_no order by id DESC";
	}
	else
	{
		 $sql="select min(a.id) as id, a.job_no as job_no_prefix_num, a.booking_no_prefix_num, a.pay_mode, a.booking_no, company_id, a.buyer_id, a.supplier_id, a.booking_date, a.delivery_date, a.item_category, a.fabric_source, a.is_approved
		 from wo_booking_mst a
		 where a.booking_no not in ( select a.booking_no from wo_booking_mst a, wo_booking_dtls b, wo_po_break_down c where a.booking_no=b.booking_no and b.po_break_down_id=c.id and a.booking_type=1 and a.entry_form=108 and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and $company $buyer $booking_date $booking_cond $job_cond $file_no_cond $internal_ref_cond group by a.booking_no_prefix_num, a.booking_no,company_id,a.supplier_id,a.booking_date,a.delivery_date) and a.booking_type=1 and a.entry_form=108 and a.status_active =1 and a.is_deleted=0 and $company $buyer $supplier_id $booking_date $booking_cond
		 group by a.booking_no_prefix_num, a.booking_no, a.job_no, company_id, a.buyer_id, a.supplier_id, a.pay_mode, a.booking_date, a.delivery_date, a.item_category, a.fabric_source, a.is_approved order by id DESC";
	}
	?>
    <div>
        <table width="1160" cellspacing="0" cellpadding="0" border="1" class="rpt_table" rules="all">
            <thead>
                <tr>
                    <th width="30">SL</th>
                    <th width="60">Booking No</th>
                    <th width="60">Booking Date</th>
                    <th width="90">Buyer</th>
                    <th width="90">Job No</th>
                    <th width="90">Style Ref.</th>
                    <th width="100">Gmts Item </th>
                    <th width="80">PO number</th>
                    <th width="80">Internal Ref</th>
                    <th width="80">File No</th>
                    <th width="80">Fab. Nature</th>
                    <th width="80">Fab. Source</th>
                    <th width="60">Pay Mode</th>
                    <th width="60">Supplier</th>
                    <th width="50">Approved</th>
                    <th>Ready to Approved</th>
                </tr>
            </thead>
        </table>
        <div style="width:1160px; max-height:400px; overflow-y:scroll" id="scroll_body">
            <table width="1140" cellspacing="0" cellpadding="0" border="1" class="rpt_table" rules="all" id="list_view">
                <tbody>
                <?
                $k=1;
				
                $result_data=sql_select($sql);
                foreach($result_data as $row)
				{
					if($k%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					?>
					<tr onClick="js_set_value('<? echo $row[csf("booking_no")]?>')" style="cursor:pointer" bgcolor="<? echo $bgcolor;?>" >
                        <td width="30"><? echo $k; ?></td>
                        <td width="60"><? echo $row[csf("booking_no_prefix_num")];?></td>
                        <td width="60"><? echo change_date_format($row[csf("booking_date")],"dd-mm-yyyy","-");?></td>
                        <td width="90"><? echo $buyer_arr[$row[csf("buyer_id")]];?></td>
                        <td width="90" style="word-break:break-all"><? echo $row[csf("job_no_prefix_num")];?></td>
                        <td width="90" style="word-break:break-all"><? echo $row[csf("style_ref_no")];?></td>
                        <td width="100" style="word-break:break-all"><?
                        $gmts_item=''; $gmts_item_id=explode(",",$row[csf('gmts_item_id')]);
                        foreach($gmts_item_id as $item_id)
                        {
                        	if($gmts_item=="") $gmts_item=$garments_item[$item_id]; else $gmts_item.=", ".$garments_item[$item_id];
                        }
                        echo $gmts_item;?> </td>
                        <td width="80" style="word-wrap: break-word;word-break: break-all;"><? echo $row[csf("po_number")];?></td>
                        <td width="80" style="word-break:break-all"><? echo $row[csf("grouping")];?></td>
                        <td width="80" style="word-break:break-all"><? echo $row[csf("file_no")];?></td>
                        <td width="80" style="word-break:break-all"><? echo $item_category[$row[csf("item_category")]];?></td>
                        <td width="80"><? echo $fabric_source[$row[csf("fabric_source")]];?></td>
                        <td width="60"><? echo $pay_mode[$row[csf("pay_mode")]];?></td>
                        <td width="60" style="word-break:break-all">
                        <?
                        if($row[csf("pay_mode")]==3 || $row[csf("pay_mode")]==5) echo $comp[$row[csf("supplier_id")]];
                        else echo $suplier[$row[csf("supplier_id")]];
                        ?>
                        </td>
                        <td width="50" style="word-break:break-all"><? echo $approved[$row[csf("is_approved")]];?></td>
                        <td><? echo $is_ready[$row[csf("ready_to_approved")]];?></td>
					</tr>
					<?
					$k++;
                }
                ?>
                </tbody>
            </table>
        </div>
    </div>
	<?
    exit();
}

if ($action=="populate_data_from_search_popup")
{
	 $sql= "select id,booking_no, booking_date, company_id, buyer_id, job_no, po_break_down_id, item_category, fabric_source, currency_id, exchange_rate, pay_mode, booking_month, supplier_id, attention, booking_percent, delivery_date,fabric_start_date, source, booking_year, colar_excess_percent, cuff_excess_percent, is_approved, ready_to_approved, is_apply_last_update, rmg_process_breakdown, fabric_composition, uom, remarks, cbo_level, brand_id, isgreyfab_purchase, ship_mode, pay_term, tenor, shippingmark_breck_down from wo_booking_mst where booking_no='$data' and status_active =1 and is_deleted=0";

	 $data_array=sql_select($sql);
	 foreach ($data_array as $row)
	 {
		echo "document.getElementById('cbo_company_name').value = '".$row[csf("company_id")]."';\n";
		echo "document.getElementById('cbo_buyer_name').value = '".$row[csf("buyer_id")]."';\n";
		echo "load_drop_down('requires/partial_fabric_booking_controller', '".$row[csf("buyer_id")]."', 'load_drop_down_brand', 'brand_td');\n";
		echo "document.getElementById('cbo_brand_id').value = '".$row[csf("brand_id")]."';\n";
		echo "document.getElementById('txt_booking_no').value = '".$row[csf("booking_no")]."';\n";
		echo "document.getElementById('update_id').value = '".$row[csf("id")]."';\n";
		echo "document.getElementById('cbo_fabric_natu').value = '".$row[csf("item_category")]."';\n";
		echo "document.getElementById('cbo_fabric_source').value = '".$row[csf("fabric_source")]."';\n";
		echo "document.getElementById('cbo_currency').value = '".$row[csf("currency_id")]."';\n";
		echo "document.getElementById('txt_exchange_rate').value = '".$row[csf("exchange_rate")]."';\n";
		echo "document.getElementById('cbo_pay_mode').value = '".$row[csf("pay_mode")]."';\n";
		echo "document.getElementById('txt_booking_date').value = '".change_date_format($row[csf("booking_date")],'dd-mm-yyyy','-')."';\n";
		echo "document.getElementById('cbo_booking_month').value = '".$row[csf("booking_month")]."';\n";
		echo "document.getElementById('txt_attention').value = '".$row[csf("attention")]."';\n";
		echo "document.getElementById('txt_booking_percent').value = '".$row[csf("booking_percent")]."';\n";
		echo "document.getElementById('txt_delivery_date').value = '".change_date_format($row[csf("delivery_date")],'dd-mm-yyyy','-')."';\n";
	    echo "document.getElementById('txt_fabric_start_date').value = '".change_date_format($row[csf("fabric_start_date")],'dd-mm-yyyy','-')."';\n";
		echo "document.getElementById('cbo_source').value = '".$row[csf("source")]."';\n";
		echo "fnc_greyFabPurchase('".$row[csf("pay_mode")]."');\n";
		if($row[csf("isgreyfab_purchase")]==0 || $row[csf("isgreyfab_purchase")]=="") $row[csf("isgreyfab_purchase")]=2;
		echo "document.getElementById('cbo_greyfab_purch').value = '".$row[csf("isgreyfab_purchase")]."';\n";
		echo "document.getElementById('cbo_booking_year').value = '".$row[csf("booking_year")]."';\n";
		echo "document.getElementById('txt_colar_excess_percent').value = '".$row[csf("colar_excess_percent")]."';\n";
		echo "document.getElementById('txt_cuff_excess_percent').value = '".$row[csf("cuff_excess_percent")]."';\n";
		if($row[csf("is_approved")]==3){
			$is_approved=1;
		}
		else{
			$is_approved=$row[csf("is_approved")];
		}
		echo "document.getElementById('id_approved_id').value = '".$is_approved."';\n";
		echo "document.getElementById('cbo_ready_to_approved').value = '".$row[csf("ready_to_approved")]."';\n";
		echo "document.getElementById('processloss_breck_down').value = '".$row[csf("rmg_process_breakdown")]."';\n";
		echo "document.getElementById('txt_fabriccomposition').value = '".$row[csf("fabric_composition")]."';\n";
		$supplier_dropdwan=load_drop_down_suplier($row[csf("pay_mode")],$row[csf("company_id")]);
		echo "document.getElementById('sup_td').innerHTML = '".$supplier_dropdwan."';\n";
		echo "document.getElementById('cbo_supplier_name').value = '".$row[csf("supplier_id")]."';\n";
		echo "document.getElementById('cbouom').value = '".$row[csf("uom")]."';\n";
		echo "document.getElementById('txt_remark').value = '".$row[csf("remarks")]."';\n";
		echo "document.getElementById('cbo_level').value = '".$row[csf("cbo_level")]."';\n";
		echo "document.getElementById('cbo_shipmode').value = '".$row[csf("ship_mode")]."';\n";
		echo "document.getElementById('cbo_payterm').value = '".$row[csf("pay_term")]."';\n";
		echo "document.getElementById('txt_tenor').value = '".$row[csf("tenor")]."';\n";
		echo "document.getElementById('hiddshippingmark_breck_down').value = '".$row[csf("shippingmark_breck_down")]."';\n";
		$sql_request="select MAX(id) as id, approval_cause from fabric_booking_approval_cause where entry_form=7 and user_id='$user_id' and booking_id=".$row[csf("id")]." and approval_type=2 and status_active=1 and is_deleted=0 group by approval_cause order by id desc";// page_id='$menu_id'
		//echo $sql_request;
		$nameArray_request=sql_select($sql_request);
		
		foreach($nameArray_request as $approw)
		{
			$approval_cause=$approw[csf("approval_cause")];
		}
		
		$un_sql_request="select MAX(id) as id,max(approval_no) as approved_no from fabric_booking_approval_cause where entry_form=7  and booking_id=".$row[csf("id")]." and approval_type=2 and status_active=1 and is_deleted=0  ";// page_id='$menu_id'
			
		// echo $sql_request;
		$nameArray_un_request=sql_select($un_sql_request);
		$cause_approved_no='';
		foreach($nameArray_un_request as $approw)
		{
			$cause_approved_no=$approw[csf("approved_no")];
		}
		//echo "select max(approved_no) as max_approved_no from approval_history where mst_id='".$row[csf('id')]."'  and entry_form=7 ";
		 $max_approved_no=return_field_value("max(approved_no) as max_approved_no", "approval_history", "mst_id='".$row[csf('id')]."'  and entry_form=7","max_approved_no");
		
		if($max_approved_no!=$cause_approved_no)
		{
			$approval_cause='';	
		}
		
		if($row[csf("is_approved")]==1){
			echo "document.getElementById('app_sms2').innerHTML = 'This booking is approved.';\n";
			echo "document.getElementById('txt_un_appv_request').disabled = '".false."';\n";
			echo "document.getElementById('txt_un_appv_request').value = '".str_replace(array("&", "*", "(", ")", "=","'","_",",","\r", "\n",'"','#'), "", $approval_cause)."';\n";
		}
		else if($row[csf("is_approved")]==3){ //ISD-22-05697 by Kausar
			echo "document.getElementById('app_sms2').innerHTML = 'This booking is partial approved.';\n";
			echo "document.getElementById('txt_un_appv_request').disabled = '".false."';\n";
			echo "document.getElementById('txt_un_appv_request').value = '".str_replace(array("&", "*", "(", ")", "=","'","_",",","\r", "\n",'"','#'), "", $approval_cause)."';\n";
		}
		else{
			echo "document.getElementById('app_sms2').innerHTML = '';\n";
			echo "document.getElementById('txt_un_appv_request').disabled = '".true."';\n";
		}

		$colar_culff_percent=return_field_value("colar_culff_percent", "variable_order_tracking", "company_name='".$row[csf("company_id")]."'  and variable_list=40 and status_active=1 and is_deleted=0");
		if($colar_culff_percent==1){
			echo "$('#txt_colar_excess_percent').removeAttr('disabled')".";\n";
			echo "$('#txt_cuff_excess_percent').removeAttr('disabled')".";\n";
		}
		if($colar_culff_percent==2){
			echo "$('#txt_colar_excess_percent').attr('disabled','true')".";\n";
		    echo "$('#txt_cuff_excess_percent').attr('disabled','true')".";\n";
		}
		$sql_delevary=sql_select("select max(c.task_start_date) as task_finish_date from tna_process_mst c,wo_booking_dtls b where c.po_number_id=b.po_break_down_id and b.booking_no in('".$data."') and c.task_number in(73) and c.is_deleted = 0 and c.status_active=1");
		//echo "select max(c.task_start_date) as task_finish_date from tna_process_mst c,wo_booking_dtls b where c.po_number_id=b.po_break_down_id and c.b.booking_no in('".$data."') and c.task_number in(73) and c.is_deleted = 0 and c.status_active=1";
		if(count($sql_delevary)>0)
		{
		foreach($sql_delevary as $row_delevary){
				if($row_delevary[csf("task_finish_date")]!="")
				{
					echo "document.getElementById('txt_delivery_date').value = '".change_date_format($row_delevary[csf("task_finish_date")],'dd-mm-yyyy','-')."';\n";
					echo "document.getElementById('txt_tna_date').value = '".change_date_format($row_delevary[csf("task_finish_date")],'dd-mm-yyyy','-')."';\n";
				}
			}
		}
	}
	$booking_dtls_data=sql_select("SELECT b.job_no, b.po_break_down_id from wo_booking_mst a join wo_booking_dtls b on a.id=b.booking_mst_id where a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and a.booking_no='$data' group by b.job_no, b.po_break_down_id");
	if(count($booking_dtls_data)>0){
		foreach($booking_dtls_data as $row){
			$job_dtls_arr[$row[csf('job_no')]]=$row[csf('job_no')];
			$po_dtls_arr[$row[csf('po_break_down_id')]]=$row[csf('po_break_down_id')];
		}
		echo "document.getElementById('txt_job_no_str').value = '".implode(",",$job_dtls_arr)."';\n";
		echo "document.getElementById('order_no_id_str').value = '".implode(",",$po_dtls_arr)."';\n";
	}
	
	
	 exit();
}

if ($action=="fabric_search_popup")
{
	echo load_html_head_contents("Order Search","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	$postatus="";
	if(trim($txt_booking_no)!="")
	{
		$sqlBooking=sql_select("Select po_break_down_id from wo_booking_dtls where booking_no='$txt_booking_no' and is_deleted = 0 and status_active=1");
		$pobooking=$sqlBooking[0][csf('po_break_down_id')];
		
		$sql_result=sql_select("select is_confirmed from wo_po_break_down where id='$pobooking'");
		$postatus=$sql_result[0][csf('is_confirmed')];
	}
	
	?>
	<script>
		var selected_id = new Array, selected_name = new Array();
		function check_all_data() {
			var tbl_row_count = document.getElementById( 'list_view' ).rows.length;
			tbl_row_count = tbl_row_count-1;
			for( var i = 1; i <= tbl_row_count; i++ ) {
					js_set_value( i );
			}
		}

		function toggle( x, origColor ) {
			var newColor = 'yellow';
			if ( x.style ) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}

		var selected_id = new Array();
		var selected_item=new Array();
		var selected_po=new Array();

		function js_set_value( str ) {
			if($("#search"+str).css("display") !='none'){
				var postr=$('#txt_po_id' + str).val();
				
				//$sql_row['id'].'_'.$sql_row['is_confirmed'].'_'.$sql_row['fabric_source'].'_'.$maintain_textile; ?>
				var podata=postr.split("_");
				podata[3]=podata[3].replace("'", "");
				//alert( $('#txtpostatus').val()+'_'+podata[1]+'_'+podata[2]+'_'+podata[3] )
				if( $('#txtpostatus').val()!="" && ($('#txtpostatus').val()!=podata[1] && podata[2]==1 && podata[3]==2))
				{
					alert('PO Status Mixing Not Allowed.');
					return;
				}
				else
				{
					document.getElementById('txtpostatus').value=podata[1];
				}
				
				var txt_tna_date_check=$('#txt_tna_date_check' + str).val();
				if(txt_tna_date_check==1)
				{
					alert('TNA process not found for this PO');
				}
				else{
					toggle( document.getElementById( 'search' + str ), '#FFFFCC' );
					if( jQuery.inArray( $('#txt_individual_id' + str).val(), selected_id ) == -1 ) {
						selected_id.push( $('#txt_individual_id' + str).val() );
						selected_item.push($('#pre_cost_dtls_id' + str).val());
						selected_po.push(podata[0]);
					}
					else{
						for( var i = 0; i < selected_id.length; i++ ) {
							if( selected_id[i] == $('#txt_individual_id' + str).val() ) break;
						}
						selected_id.splice( i, 1 );
						selected_item.splice( i,1 );
						selected_po.splice( i,1 );
					}
				}
			}
			var id = '';
			var pre_cost_dtls_id='';
			var txt_po_id='';
			for( var i = 0; i < selected_id.length; i++ ) {
				id += selected_id[i] + ',';
				pre_cost_dtls_id+=selected_item[i]+ ',';
				txt_po_id+=selected_po[i]+ ',';
			}
			id = id.substr( 0, id.length - 1 );
			pre_cost_dtls_id = pre_cost_dtls_id.substr( 0, pre_cost_dtls_id.length - 1 );
			txt_po_id = txt_po_id.substr( 0, txt_po_id.length - 1 );
			$('#txt_selected_id').val( id );
			$('#txt_pre_cost_dtls_id').val( pre_cost_dtls_id );
			$('#txt_selected_po').val( txt_po_id );
		}

		/*function fnc_job_pop(page_link,title){
			//alert(title)
			var cbo_company_mst=$('#cbo_company_mst').val();
			var cbo_buyer_name=$('#cbo_buyer_name').val();
		page_link=page_link+"&cbo_company_mst="+cbo_company_mst+"&cbo_buyer_name="+cbo_buyer_name;
		emailwindow=dhtmlmodal.open('EmailBox', 'iframe', page_link, 'Job Search', 'width=1200px,height=300px,center=1,resize=1,scrolling=0','../../')

		emailwindow.onclose=function(){
			var theform=this.contentDoc.forms[0];
			var job_no=this.contentDoc.getElementById("job_no");
			var year=this.contentDoc.getElementById("cbo_job_year");
			if (job_no.value!=""){
				$('#txt_job_prifix').val( job_no.value );
				$('#cbo_job_year').val( year.value );
				show_list_view ( document.getElementById('cbo_company_mst').value+'_'+document.getElementById('cbo_buyer_name').value+'_'+document.getElementById('cbo_job_year').value+'_'+document.getElementById('txt_job_prifix').value+'_'+document.getElementById('txt_internal_ref').value+'_'+document.getElementById('txt_file_no').value+'_'+document.getElementById('txt_style').value+'_'+document.getElementById('txt_order_search').value+'_'+document.getElementById('txt_date_from').value+'_'+document.getElementById('txt_date_to').value+'_'+document.getElementById('cbo_currency').value+'_'+document.getElementById('cbo_fabric_natu').value+'_'+document.getElementById('cbouom').value+'_'+document.getElementById('cbo_fabric_source').value+'_'+document.getElementById('cbo_string_search_type').value, 'fabric_search_list_view', 'search_div', 'partial_fabric_booking_controller', 'setFilterGrid(\'list_view\',-1)');
			}
		}
	}*/
	</script>
	</head>
	<body>
        <div align="center" style="width:100%;" >
            <form name="searchpofrm_1" id="searchpofrm_1">
                <table  width="850" class="rpt_table" align="center" rules="all">
                    <thead>
                        <tr>
                            <th colspan="10" align="center"><?=create_drop_down( "cbo_string_search_type", 130, $string_search_type,'', 1, "-- Searching Type --",1 ); ?></th>
                        </tr>
                        <tr>
                            <th width="140">Company</th>
                            <th width="150">Buyer</th>
                            <th width="60">Job No</th>
                            <th width="70">Internal Ref</th>
                            <th width="70">File No</th>
                            <th width="70">Style Ref </th>
                            <th width="70">Order No</th>
                            <th width="120" colspan="2">Pub.Ship Date Range</th>
                            <th>&nbsp;</th>
                        </tr>
                    </thead>
                    <tr class="general">
                    	<?php 
						//echo $cbo_supplier_name;

                    		$onchange_company="";
                    		$cbo_buyer_name=str_replace("'","",$cbo_buyer_name);
                    		if(empty($cbo_buyer_name))
                    		{
                    			$onchange_company="load_drop_down( 'partial_fabric_booking_controller', this.value, 'load_drop_down_buyer_popup', 'buyer_td' );";
                    		}

                    	 ?>
                        <td><?=create_drop_down( "cbo_company_mst", 140, "select id,company_name from lib_company comp where status_active=1 and is_deleted=0 $company_cond order by company_name","id,company_name",1, "- Select Company -", str_replace("'","",$cbo_company_name),$onchange_company ,"1"); ?>
                        </td>
                        <td id="buyer_td"><?=create_drop_down( "cbo_buyer_name", 150, "select buy.id,buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active=1 and buy.is_deleted=0 $buyer_cond and b.buyer_id=buy.id and b.tag_company=$cbo_company_name and buy.id in (select  buyer_id from  lib_buyer_party_type where party_type in (1,3,21,90)) group by buy.id, buy.buyer_name order by buyer_name","id,buyer_name", 1, "-- Select Buyer --", str_replace("'","",$cbo_buyer_name), "","1" ); ?>
                        </td>
                        <td><input name="txt_job_prifix" id="txt_job_prifix" class="text_boxes" style="width:50px" onDblClick="fnc_jobpopup();"></td>
                        <td><input name="txt_internal_ref" id="txt_internal_ref" class="text_boxes" style="width:60px"></td>
                        <td><input name="txt_file_no" id="txt_file_no" class="text_boxes" style="width:60px"></td>
                        <td><input name="txt_style" id="txt_style" class="text_boxes" style="width:60px"></td>
                        <td><input name="txt_order_search" id="txt_order_search" class="text_boxes" style="width:60px"></td>
                        <td><input name="txt_date_from" id="txt_date_from" class="datepicker" style="width:50px" value=""/></td>
                        <td><input name="txt_date_to" id="txt_date_to" class="datepicker" style="width:50px" value=""/></td>
                        <td align="center">
                            <input type="hidden" name="cbo_currency" id="cbo_currency" class="text_boxes" style="width:60px" value="<?=str_replace("'","",$cbo_currency); ?>"  />
                            <input type="hidden" name="cbo_fabric_natu" id="cbo_fabric_natu" class="text_boxes" style="width:60px" value="<?=str_replace("'","",$cbo_fabric_natu); ?>"  />
                            <input type="hidden" name="cbouom" id="cbouom" class="text_boxes" style="width:60px" value="<?=str_replace("'","",$cbouom); ?>"  />
                            <input type="hidden" name="cbo_fabric_source" id="cbo_fabric_source" class="text_boxes" style="width:60px" value="<?=str_replace("'","",$cbo_fabric_source); ?>"  />
                            <input type="button" name="button2" class="formbutton" value="Show" onClick="show_list_view ( document.getElementById('cbo_company_mst').value+'_'+document.getElementById('cbo_buyer_name').value+'_'+document.getElementById('cbo_year_selection').value+'_'+document.getElementById('txt_job_prifix').value+'_'+document.getElementById('txt_internal_ref').value+'_'+document.getElementById('txt_file_no').value+'_'+document.getElementById('txt_style').value+'_'+document.getElementById('txt_order_search').value+'_'+document.getElementById('txt_date_from').value+'_'+document.getElementById('txt_date_to').value+'_'+document.getElementById('cbo_currency').value+'_'+document.getElementById('cbo_fabric_natu').value+'_'+document.getElementById('cbouom').value+'_'+document.getElementById('cbo_fabric_source').value+'_'+document.getElementById('cbo_string_search_type').value+'_'+'<?=$cbo_brand_id; ?>'+'_'+'<?=$cbo_supplier_name; ?>'+'_'+'<?=$cbo_pay_mode; ?>', 'fabric_search_list_view', 'search_div', 'partial_fabric_booking_controller', 'setFilterGrid(\'list_view\',-1)');" style="width:70px;" />
                        </td>
                    </tr>
                    <tr>
                        <td colspan="10" align="center">
                        	<?=load_month_buttons(1); ?>
                            <input type="hidden" class="text_boxes" readonly style="width:550px" id="txt_selected_po">
                            <input type="hidden" id="txt_selected_id">
                            <input type="hidden" id="txt_pre_cost_dtls_id">
                            <input type="hidden" id="txtpostatus" value="<?=$postatus; ?>">
                        </td>
                    </tr>
                    <tr>
                        <td colspan="4" align="right">
                            <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data();" /> Check / Uncheck All
                        </td>
                        <td colspan="6" align="left">
                            <input type="button" name="close" onClick="parent.emailwindow.hide();"  class="formbutton" value="Close" style="width:100px" />
                        </td>
                    </tr>
                </table>
                
            </form>
        </div>
        <div id="search_div" align="center"></div>
	</body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    <script type="text/javascript">$("#cbo_buyer_name").val(<?=$cbo_buyer_name; ?>);</script>
    <script type="text/javascript">
	function fnc_jobpopup()
	{
		var cbo_company_mst=$('#cbo_company_mst').val();
		var cbo_buyer_name=$('#cbo_buyer_name').val();
		
		var page_link='partial_fabric_booking_controller.php?action=job_search_popup';
		//alert(page_link);
		page_link=page_link+"&cbo_company_mst="+cbo_company_mst+"&cbo_buyer_name="+cbo_buyer_name;
		emailwindow=dhtmlmodal.open('EmailBox', 'iframe', page_link, 'Job Search', 'width=1200px,height=300px,center=1,resize=1,scrolling=0','../../')
		emailwindow.onclose=function(){
			var theform=this.contentDoc.forms[0];
			var job_no=this.contentDoc.getElementById("job_no");
			var year=this.contentDoc.getElementById("cbo_job_year");
			
			if (job_no.value!=""){
				$('#txt_job_prifix').val( job_no.value );
				$('#cbo_job_year').val( year.value );
				show_list_view ( document.getElementById('cbo_company_mst').value+'_'+document.getElementById('cbo_buyer_name').value+'_'+document.getElementById('cbo_job_year').value+'_'+document.getElementById('txt_job_prifix').value+'_'+document.getElementById('txt_internal_ref').value+'_'+document.getElementById('txt_file_no').value+'_'+document.getElementById('txt_style').value+'_'+document.getElementById('txt_order_search').value+'_'+document.getElementById('txt_date_from').value+'_'+document.getElementById('txt_date_to').value+'_'+document.getElementById('cbo_currency').value+'_'+document.getElementById('cbo_fabric_natu').value+'_'+document.getElementById('cbouom').value+'_'+document.getElementById('cbo_fabric_source').value+'_'+document.getElementById('cbo_string_search_type').value, 'fabric_search_list_view', 'search_div', 'partial_fabric_booking_controller', 'setFilterGrid(\'list_view\',-1)');
			}
		}
	}
	</script>  
	</html>
	<?
	exit();
}

if ($action=="fabric_search_list_view"){
	$data=explode('_',$data);
	$company=$data[0];
	$buyer=$data[1];
	$cbo_job_year=$data[2];
	$job=$data[3];
	$internal_ref=$data[4];
	$file_no=$data[5];
	$style=$data[6];
	$order_search=$data[7];
	$date_from=$data[8];
	$date_to=$data[9];
	$cbo_currency=$data[10];
	$cbo_fabric_natu=$data[11];
	$cbouom=$data[12];
	$cbo_fabric_source=$data[13];
	$search_category=$data[14];
	$cbo_brand_id=$data[15];
	$cbo_supplier_name=$data[16];
	$cbo_pay_mode=$data[17];
	if ($company!=0) $company_cond=" and a.company_name='$company'"; else { echo "Please Select Company First."; die; }
	if ($buyer!=0) $buyer_cond=" and a.buyer_name='$buyer'"; else{ echo "Please Select Buyer First."; die; }
	
	if ($cbo_currency!="") $currency_cond=" and a.currency_id='$cbo_currency'"; else{ echo "Please Select Currency First."; die; }
	if($cbo_fabric_source==2 && $cbo_currency==1) //Purchase//Tk  //For BDT ---issue id-4843 Saeed vai
	{
		$currency_cond="";
	}
	
	if ($cbo_fabric_natu!="") $fabric_natu_cond=" and d.fab_nature_id='$cbo_fabric_natu'"; else{ echo "Please Select Fabric Nature First."; die; }
	if ($cbouom!=0) $uom_cond=" and d.uom='$cbouom'";
	if ($cbo_fabric_source!="") $fabric_source_cond=" and d.fabric_source='$cbo_fabric_source'"; else{ echo "Please Select Fabric Source  First."; die; }
	if ($cbo_brand_id=="" || $cbo_brand_id==0) $brandCond=""; else $brandCond=" and a.brand_id='$cbo_brand_id'";

	
	if ($date_from!="" &&  $date_to!="") $shipment_date = "and b.pub_shipment_date between '".change_date_format($date_from, "yyyy-mm-dd", "-",1)."' and '".change_date_format($date_to, "yyyy-mm-dd", "-",1)."'"; else $shipment_date ="";
	
	$year_cond=" and to_char(a.insert_date,'YYYY')=$cbo_job_year";
	if (str_replace("'","",$job)=="" && str_replace("'","",$style)=="" && str_replace("'","",$internal_ref)=="" && str_replace("'","",$date_from)=="" && str_replace("'","",$date_to)=="" && str_replace("'","",$order_search)=="")
	{
		//echo $job.'='.$style;
		echo "Please Insert Job Or Style/Ref No Or Pub.Ship Date Range Or Order No First."; die;
	}
	$sql_result=sql_select("select tna_integrated from variable_order_tracking where company_name='$company' and variable_list=14 and status_active=1 and is_deleted=0");
	$maintain_setting=$sql_result[0][csf('tna_integrated')];
	
	$sqltextileref=sql_select("select production_entry from variable_settings_production where company_name='$company' and variable_list=66 and status_active=1 and is_deleted=0");
	$maintain_textile=$sqltextileref[0][csf('production_entry')];

	$job_cond=""; $order_cond=""; $style_cond="";
	if($search_category==1){
		if (str_replace("'","",$job)!="") $job_cond=" and a.job_no_prefix_num='$job'";
		if (str_replace("'","",$order_search)!="") $order_cond=" and b.po_number = '$order_search'";
		if (trim($style)!="") $style_cond=" and a.style_ref_no ='$style'";
		if (trim($internal_ref) !="") $internal_ref_cond=" and b.grouping = '$internal_ref'";
		if (trim($file_no) !="")  $file_no_cond=" and b.file_no='$file_no' ";
	}
	else if($search_category==2){
		if (str_replace("'","",$job)!="") $job_cond=" and a.job_no_prefix_num like '$job%'";
		if (str_replace("'","",$order_search)!="") $order_cond=" and b.po_number like '$order_search%'  ";
		if (trim($style)!="") $style_cond=" and a.style_ref_no like '$style%'  ";
		if (trim($internal_ref) !="") $internal_ref_cond=" and b.grouping like '$internal_ref%'";
		if (trim($file_no) !="")  $file_no_cond=" and b.file_no like '$file_no%' ";
	}
	else if($search_category==3){
		if (str_replace("'","",$job)!="") $job_cond=" and a.job_no_prefix_num like '%$job'";
		if (str_replace("'","",$order_search)!="") $order_cond=" and b.po_number like '%$order_search'  ";
		if (trim($style)!="") $style_cond=" and a.style_ref_no like '%$style'";
		if (trim($internal_ref) !="")  $internal_ref_cond=" and b.grouping like '%$internal_ref'";
		if (trim($file_no) !="")  $file_no_cond=" and b.file_no like '%$file_no' ";
	}
	else if($search_category==4 || $search_category==0){
		if (str_replace("'","",$job)!="") $job_cond=" and a.job_no_prefix_num like '%$job%'";
		if (str_replace("'","",$order_search)!="") $order_cond=" and b.po_number like '%$order_search%'  ";
		if (trim($style)!="") $style_cond=" and a.style_ref_no like '%$style%'";
		if (trim($internal_ref)!="")  $internal_ref_cond=" and b.grouping like '%$internal_ref%'";
		if (trim($file_no) !="")  $file_no_cond=" and b.file_no like '%$file_no%' ";
	}

	$condition= new condition();
	if(str_replace("'","",$company) !=''){
		$condition->company_name("=$company");
	}
	if(str_replace("'","",$buyer) !=''){
		$condition->buyer_name("=$buyer");
	}
	if(str_replace("'","",$job) !=''){
		$condition->job_no_prefix_num("=$job");
	}
	if(str_replace("'","",$date_from)!='' && str_replace("'","",$date_to)!=''){
		$condition->pub_shipment_date(" between '".change_date_format($date_from, "yyyy-mm-dd", "-",1)."' and '".change_date_format($date_to, "yyyy-mm-dd", "-",1)."'");
	}
	if(str_replace("'","",$order_search)!='') {
		$condition->po_number("='$order_search'");
	}
	if(str_replace("'","",$internal_ref) !=''){
		$condition->grouping("='$internal_ref'");
	}
	if(str_replace("'","",$file_no)!='') {
		$condition->file_no("='$file_no'");
	}
	$condition->init();
	$fabric= new fabric($condition);
	//echo $fabric->getQuery();die;

	$req_qty_arr=$fabric->getQtyArray_by_orderAndFabriccostid_knitAndwoven_greyAndfinish();
	
	$fabric_source_sql=sql_select("SELECT b.id as fabric_id, b.fabric_source  from wo_po_details_master a join wo_pre_cost_fabric_cost_dtls b on a.id=b.job_id where a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 ".$company_cond . $buyer_cond. $year_cond.$job_cond.$style_cond."");
	foreach ($fabric_source_sql as $row) {
		$fabric_source_arr[$row[csf('fabric_id')]]=$row[csf('fabric_source')];
	}
	unset($fabric_source_sql);

	$cu_booking_data_arr=array();
	$sql='SELECT b.pre_cost_fabric_cost_dtls_id AS "pre_cost_fabric_cost_dtls_id",b.po_break_down_id AS "po_break_down_id", b.color_number_id AS "color_number_id" ,a.id AS "booking_id",a.fin_fab_qnty AS "fin_fab_qnty",a.grey_fab_qnty AS "grey_fab_qnty",a.dia_width AS "dia_width" from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_details_master c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.po_break_down_id=b.po_break_down_id and a.gmts_color_id=b.color_number_id and a.dia_width=b.dia_width and a.job_no=b.job_no and a.job_no=c.job_no and  c.job_no_prefix_num ='.$job.' and a.booking_type=1 and a.status_active=1 and a.is_deleted=0 group by b.pre_cost_fabric_cost_dtls_id, b.po_break_down_id, b.color_number_id, a.id, a.fin_fab_qnty, a.grey_fab_qnty, a.dia_width';
	$dataArray=sql_select($sql);
	foreach($dataArray as $dataArray_row){
		$cu_booking_data_arr[$dataArray_row['pre_cost_fabric_cost_dtls_id']][$dataArray_row['po_break_down_id']]+=$dataArray_row['grey_fab_qnty'];
	}
	unset($dataArray);
	$nominated_supp_cond="";
	if($cbo_pay_mode==1 || $cbo_pay_mode==2 || $cbo_pay_mode==4)
	{
		  $nominated_supp_cond=" and (d.nominated_supp=$cbo_supplier_name  or d.nominated_supp=0)";
	}
	//echo $nominated_supp_cond;die;

	  $sql= 'SELECT a.job_no AS "job_no", b.id AS "id", b.po_number AS "po_number", b.is_confirmed as "is_confirmed", c.item_number_id AS "item_number_id", d.id AS "pre_cost_dtls_id",d.nominated_supp AS "nominated_supp", d.body_part_id AS "body_part_id", d.construction AS "construction", d.composition AS "composition", d.fab_nature_id AS "fab_nature_id", d.fabric_source AS "fabric_source", d.color_type_id AS "color_type_id", d.lib_yarn_count_deter_id AS "lib_yarn_count_deter_id", d.uom AS "uom", d.gsm_weight AS "gsm_weight", min(e.id) AS "eid" from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c, wo_pre_cost_fabric_cost_dtls d, wo_pre_cos_fab_co_avg_con_dtls e where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no  and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes and e.cons !=0 and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 '.$company_cond . $buyer_cond. $year_cond. $job_cond. $internal_ref_cond. $file_no_cond . $style_cond. $order_cond. $shipment_date. $currency_cond.  $fabric_natu_cond. $uom_cond. $fabric_source_cond.$brandCond.$nominated_supp_cond ." group by a.job_no, b.id, b.po_number, b.is_confirmed, c.item_number_id, d.id, d.color_type_id, d.body_part_id, d.construction, d.composition, d.fab_nature_id, d.fabric_source,d.nominated_supp, d.lib_yarn_count_deter_id, d.uom, d.gsm_weight";
	//echo $sql;die;
	$sql_data=sql_select($sql);

	$po_id_arr=array(); $tna_data=array();
	if($maintain_setting==1)
	{
		foreach ($sql_data as $row) 
		{
			array_push($po_id_arr, $row['id']);
		}
	
		$po_id_cond=where_con_using_array($po_id_arr,0,"po_number_id");
	
		$tan_sql=sql_select("select po_number_id, task_start_date from tna_process_mst where status_active=1 and is_deleted=0 $po_id_cond");	
		foreach ($tan_sql as $tna_value) {
			//$tna_data[$tna_value[csf('id')]]=$tna_value[csf('task_start_date')];
			$tna_data[$tna_value[csf('po_number_id')]]=1;
		}
		unset($tan_sql);
	}
	?>
    <div>
     	<table cellspacing="0" cellpadding="0" border="1" rules="all" width="1150" class="rpt_table">
            <thead>
                <th width="30">SL</th>
                <th width="80">Job No</th>
                <th width="80">Po No</th>
                <th width="80">Order Status</th>
                <th width="100">Item</th>
                <th width="100">Body Part</th>
                <th width="100">Color Type</th>
                 
                <th width="100">Construction</th>
                <th width="180">Composition</th>
                <th width="70">Gsm</th>
                <th width="80">Fabric Nature</th>
                <th width="70">Fabric Soutce</th>
                <th>UOM</th>
            </thead>
     	</table>
     </div>
     <div style="width:1150px; max-height:270px;overflow-y:scroll;" >
     <table cellspacing="0" cellpadding="0" border="1" rules="all" width="1130" class="rpt_table" id="list_view">
    <?
	$i=1;
	if(count($sql_data)>0){
		foreach($sql_data as $sql_row){
			
			/*$nominated_supp=$sql_row['nominated_supp'];
			if($cbo_pay_mode==1 || $cbo_pay_mode==2 || $cbo_pay_mode==4)
			{
				echo $nominated_supp.'TT';
			}*/
			
			$reqQty=0;
			if($cbo_fabric_natu==2){
				$reqQty=$req_qty_arr['knit']['grey'][$sql_row['id']][$sql_row['pre_cost_dtls_id']][$sql_row['uom']];
			}
			if($cbo_fabric_natu==3){
				$reqQty=$req_qty_arr['woven']['grey'][$sql_row['id']][$sql_row['pre_cost_dtls_id']][$sql_row['uom']];
			}

			$cuBooking=$cu_booking_data_arr[$sql_row['pre_cost_dtls_id']][$sql_row['id']];
			$balQty=number_format($reqQty-$cuBooking,4,".","");

			$tna_date=$tna_data[$sql_row['id']];
			if($maintain_setting==1 && $tna_date=="") $tna_check=1;  else $tna_check=0;

			if($balQty >0 ){
				if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
				?>
				<tr style="text-decoration:none; cursor:pointer" bgcolor="<?=$bgcolor; ?>" id="search<?=$i; ?>" onClick="js_set_value(<?=$i; ?>);">
					<td width="30"><?=$i; ?>
						<input type="hidden" name="txt_individual_id" id="txt_individual_id<?=$i; ?>" value="<?=$sql_row['eid']; ?>"/>
						<input type="hidden" name="pre_cost_dtls_id" id="pre_cost_dtls_id<?=$i; ?>" value="<?=$sql_row['pre_cost_dtls_id']; ?>"/>
						<input type="hidden" name="txt_po_id" id="txt_po_id<?=$i; ?>" value="'<?=$sql_row['id'].'_'.$sql_row['is_confirmed'].'_'.$sql_row['fabric_source'].'_'.$maintain_textile; ?>'"/>
						<input type="hidden" name="txt_tna_date_check" id="txt_tna_date_check<?=$i; ?>" value="<?=$tna_check; ?>"/>
					</td>
					<td width="80" style="word-break:break-all"><?=$sql_row['job_no']; ?></td>
					<td width="80" style="word-break:break-all"><?=$sql_row['po_number']; ?></td>
					<td width="80" style="word-break:break-all"><?=$order_status[$sql_row['is_confirmed']]; ?></td>
					<td width="100" style="word-break:break-all"><?=$garments_item[$sql_row['item_number_id']]; ?></td>
					<td width="100" style="word-break:break-all"><?=$body_part[$sql_row['body_part_id']]; ?></td>
					<td width="100" style="word-break:break-all"><?=$color_type[$sql_row['color_type_id']]; ?></td>
					<td width="100" style="word-break:break-all"><?=$sql_row['construction']; ?></td>
					<td width="180" style="word-break:break-all"><?=$sql_row['composition']; ?></td>
					<td width="70" style="word-break:break-all"><?=$sql_row['gsm_weight']; ?></td>
					<td width="80" style="word-break:break-all"><?=$item_category[$sql_row['fab_nature_id']]; ?></td>
					<td width="70" style="word-break:break-all"><?=$fabric_source[$sql_row['fabric_source']]; ?></td>
					<td><?=$unit_of_measurement[$sql_row['uom']]; ?></td>
				</tr>
				<?
				$i++;
			}
		}
	}
	else{
		foreach ($fabric_source_arr as $fs_id) {
			if($fs_id != $cbo_fabric_source){
				echo "<span style='font-size:24px; font-weight:bold; color:#FF0000; margin-top:10px'>Mismatch Fabric Source or Related Components with budget</span>";
				exit();
			}
		}
	}
	?>
    </table>
	</div>
    <?
	exit();
}

if ($action=="job_search_popup"){
	echo load_html_head_contents("Order Search","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
		function js_set_value( str_data ){
			$('#job_no').val( str_data );
			parent.emailwindow.hide();
		}
	</script>
	</head>
	<body>
        <div align="center" style="width:100%;" >
            <form name="searchpofrm_1" id="searchpofrm_1">
            <table width="940"  align="center" rules="all">
                <tr>
                <td align="center" width="100%">
                <table  width="940" class="rpt_table" align="center" rules="all">
                    <thead>
                        <tr>
                            <th colspan="11" align="center"><? echo create_drop_down( "cbo_string_search_type", 130, $string_search_type,'', 1, "-- Searching Type --",1 ); ?></th>
                        </tr>
                        <tr>
                            <th width="140">Company</th>
                            <th width="150">Buyer</th>
                            <th width="60">Year</th>
                            <th width="60">Job No</th>
                            <th width="70">Internal Ref</th>
                            <th width="70">File No</th>
                            <th width="70">Style Ref </th>
                            <th width="70">Order No</th>
                            <th width="170" colspan="2">Date Range</th>
                            <th>&nbsp;</th>
                        </tr>
                    </thead>
                    <tr>
                        <td><?
						//load_drop_down( 'partial_fabric_booking_controller', this.value, 'load_drop_down_buyer_popup', 'buyer_td' );
						 echo create_drop_down( "cbo_company_mst", 140, "select id,company_name from lib_company comp where status_active=1 and is_deleted=0 $company_cond order by company_name","id,company_name",1, "- Select Company -", str_replace("'","",$cbo_company_mst), "","1"); ?>
                        </td>
                        <td id="buyer_td">
                        <? echo create_drop_down( "cbo_buyer_name", 150, "select buy.id,buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active=1 and buy.is_deleted=0 $buyer_cond and b.buyer_id=buy.id and b.tag_company=$cbo_company_mst and buy.id in (select  buyer_id from  lib_buyer_party_type where party_type in (1,3,21,90)) order by buyer_name","id,buyer_name", 1, "-- Select Buyer --", str_replace("'","",$cbo_buyer_name), "","1" ); ?>
                        </td>
                        <td><? echo create_drop_down( "cbo_job_year", 60, $year,"", 1, "-- Select --", date('Y'), "",0 ); ?></td>
                        <td><input name="txt_job_prifix" id="txt_job_prifix" class="text_boxes" style="width:50px"></td>
                        <td><input name="txt_internal_ref" id="txt_internal_ref" class="text_boxes" style="width:60px"></td>
                        <td><input name="txt_file_no" id="txt_file_no" class="text_boxes" style="width:60px"></td>
                        <td><input name="txt_style" id="txt_style" class="text_boxes" style="width:60px"></td>
                        <td><input name="txt_order_search" id="txt_order_search" class="text_boxes" style="width:60px"></td>
                        <td><input name="txt_date_from" id="txt_date_from" class="datepicker" style="width:60px" value=""/></td>
                        <td><input name="txt_date_to" id="txt_date_to" class="datepicker" style="width:60px" value=""/></td>
                        <td align="center">
                        <input type="hidden" name="cbo_currency" id="cbo_currency" class="text_boxes" style="width:60px" value="<? echo str_replace("'","",$cbo_currency); ?>"  />
                        <input type="hidden" name="cbo_fabric_natu" id="cbo_fabric_natu" class="text_boxes" style="width:60px" value="<? echo str_replace("'","",$cbo_fabric_natu); ?>"  />
                        <input type="hidden" name="cbouom" id="cbouom" class="text_boxes" style="width:60px" value="<? echo str_replace("'","",$cbouom); ?>"  />
                        <input type="hidden" name="cbo_fabric_source" id="cbo_fabric_source" class="text_boxes" style="width:60px" value="<? echo str_replace("'","",$cbo_fabric_source); ?>"  />
                        <input type="button" name="button2" class="formbutton" value="Show" onClick="show_list_view ( document.getElementById('cbo_company_mst').value+'_'+document.getElementById('cbo_buyer_name').value+'_'+document.getElementById('txt_date_from').value+'_'+document.getElementById('txt_date_to').value+'_'+document.getElementById('txt_job_prifix').value+'_'+document.getElementById('txt_order_search').value+'_'+document.getElementById('txt_style').value+'_'+document.getElementById('cbo_string_search_type').value+'_'+document.getElementById('txt_internal_ref').value+'_'+document.getElementById('txt_file_no').value+'_'+document.getElementById('cbo_job_year').value+'_'+document.getElementById('cbo_currency').value+'_'+document.getElementById('cbo_fabric_natu').value+'_'+document.getElementById('cbouom').value+'_'+document.getElementById('cbo_fabric_source').value, 'create_job_search_list_view', 'search_div', 'partial_fabric_booking_controller', 'setFilterGrid(\'list_view\',-1)')" style="width:70px;" />
                        </td>
                    </tr>
                    <tr>
                        <td colspan="11" align="center">
                        <input type="hidden" id="job_no">
                        </td>
                    </tr>
                </table>
                </td>
                </tr>
                <tr>
                <td align="center" >
                <input type="button" name="close" onClick="parent.emailwindow.hide();"  class="formbutton" value="Close" style="width:100px" />
                </td>
                </tr>
                <tr>
                <td id="search_div" align="center">
                </td>
                </tr>
                <tr>
                <td id="search_div" align="center">
                <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                </td>
                </tr>
            </table>
            </form>
        </div>
	</body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}

if($action=="create_job_search_list_view")
{
	$data=explode('_',$data);
	//print_r($data);
	if ($data[0]!=0) $company=" and a.company_name='$data[0]'"; else { echo "Please Select Company First."; die; }
	//if (str_replace("'","",$data[4])==""){echo "Please Insert Job First."; die;}
	if ($data[1]!=0) $buyer=" and a.buyer_name='$data[1]'"; else $buyer=""; //{ echo "Please Select Buyer First."; die; }
	if ($data[13]!=0) $uom_cond=" and d.uom='$data[13]'"; else $uom_cond=""; //{ echo "Please Select Buyer First."; die; }

	if($db_type==0) $year_cond=" and SUBSTRING_INDEX(a.insert_date, '-', 1)=$data[10]";
	if($db_type==2) $year_cond=" and to_char(a.insert_date,'YYYY')=$data[10]";

	$job_cond="";
	$order_cond="";
	$style_cond="";
	if($data[7]==1)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num='$data[4]'"; //else  $job_cond="";
		if (str_replace("'","",$data[5])!="") $order_cond=" and b.po_number = '$data[5]'  "; //else  $order_cond="";
		if (trim($data[6])!="") $style_cond=" and a.style_ref_no ='$data[6]'"; //else  $style_cond="";
	}
	else if($data[7]==2)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num like '$data[4]%'"; //else  $job_cond="";
		if (str_replace("'","",$data[5])!="") $order_cond=" and b.po_number like '$data[5]%'  "; //else  $order_cond="";
		if (trim($data[6])!="") $style_cond=" and a.style_ref_no like '$data[6]%'  "; //else  $style_cond="";
	}
	else if($data[7]==3)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num like '%$data[4]'"; //else  $job_cond="";
		if (str_replace("'","",$data[5])!="") $order_cond=" and b.po_number like '%$data[5]'  "; //else  $order_cond="";
		if (trim($data[6])!="") $style_cond=" and a.style_ref_no like '%$data[6]'"; //else  $style_cond="";
	}
	else if($data[7]==4 || $data[7]==0)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num like '%$data[4]%'"; //else  $job_cond="";
		if (str_replace("'","",$data[5])!="") $order_cond=" and b.po_number like '%$data[5]%'  "; //else  $order_cond="";
		if (trim($data[6])!="") $style_cond=" and a.style_ref_no like '%$data[6]%'"; //else  $style_cond="";
	}

	$internal_ref = str_replace("'","",$data[8]);
	$file_no = str_replace("'","",$data[9]);
	if ($file_no=="") $file_no_cond=""; else $file_no_cond=" and b.file_no='".trim($file_no)."' ";
	if ($internal_ref=="") $internal_ref_cond=""; else $internal_ref_cond=" and b.grouping like '%".trim($internal_ref)."%' ";

	if($db_type==0)
	{
		if ($data[2]!="" &&  $data[3]!="") $shipment_date = "and b.pub_shipment_date between '".change_date_format($data[2], "yyyy-mm-dd", "-")."' and '".change_date_format($data[3], "yyyy-mm-dd", "-")."'"; else $shipment_date ="";
	}

	else if($db_type==2)
	{
		if ($data[2]!="" &&  $data[3]!="") $shipment_date = "and b.pub_shipment_date between '".change_date_format($data[2], "yyyy-mm-dd", "-",1)."' and '".change_date_format($data[3], "yyyy-mm-dd", "-",1)."'"; else $shipment_date ="";
	}

	$buyer_arr=return_library_array( "select id, short_name from lib_buyer",'id','short_name');
	$comp=return_library_array( "select id, company_short_name from lib_company",'id','company_short_name');
	  $sql= 'select a.job_no_prefix_num AS "job_no_prefix_num",a.buyer_name AS "buyer_name", a.job_no AS "job_no",a.style_ref_no AS "style_ref_no", b.id AS "id",b.po_number AS "po_number", b.po_quantity AS "po_quantity",b.shipment_date AS "shipment_date", b.grouping AS "grouping", b.file_no AS "file_no" from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c  where   a.job_no=b.job_no_mst and a.job_no=c.job_no_mst   and b.id=c.po_break_down_id  and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 '.$shipment_date. $buyer. $company.  $job_cond. $order_cond. $style_cond. $file_no_cond. $internal_ref_cond. $year_cond.' group by a.job_no_prefix_num,a.job_no,a.buyer_name,a.style_ref_no,b.id,b.po_number,b.po_quantity,b.shipment_date,b.grouping,b.file_no order by b.id DESC';

	?>
    <div>
     	<table cellspacing="0" cellpadding="0" border="1" rules="all" width="870" class="rpt_table">
            <thead>
                <th width="30">SL</th>
                <th width="80">Buyer</th>
                <th width="80">Job No</th>
                <th width="100">Style Ref.</th>
                <th width="100">PO number</th>
                <th width="80">PO Qty</th>
                <th width="70">Shipment Date</th>
                <th width="70">Internal Ref</th>
                <th>File No</th>
            </thead>
     	</table>
     </div>
     <div style="width:870px; max-height:270px;overflow-y:scroll;" >
        <table cellspacing="0" cellpadding="0" border="1" rules="all" width="850" class="rpt_table" id="list_view">
			<?
			$i=1; $result = sql_select($sql);
            foreach( $result as $row )
            {
                if ($i%2==0)  $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
				?>
					<tr id="tr_<? echo $i; ?>" bgcolor="<? echo $bg_color; ?>" style="text-decoration:none;cursor:pointer" onClick="js_set_value('<? echo $row['job_no_prefix_num']; ?>');" >
						<td width="30" align="center"><? echo $i; ?></td>
						<td width="80"><? echo $buyer_arr[$row['buyer_name']]; ?></td>
                        <td width="80"><? echo $row['job_no_prefix_num']; ?></td>
                        <td width="100"><? echo $row['style_ref_no'];  ?></td>
						<td width="100"><? echo $row['po_number']; ?></td>
						<td width="80" align="right"><? echo number_format($row['po_quantity']);?> </td>
                        <td width="70"><? echo change_date_format($row['shipment_date']); ?></td>
                        <td width="70"><? echo $row['grouping'];  ?></td>
						<td><? echo $row['file_no'];  ?></td>
					</tr>
				<?
				$i++;
            }
			?>
			</table>
		</div>
	<?
	exit();
}

if ($action=="order_search_popup"){
	echo load_html_head_contents("Order Search","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
		var selected_id = new Array, selected_name = new Array();
		function check_all_data(){
			var tbl_row_count = document.getElementById( 'list_view' ).rows.length-1;
			tbl_row_count = tbl_row_count;
			for( var i = 1; i <= tbl_row_count; i++ ){
				if($("#tr_"+i).css("display") !='none'){
				document.getElementById("tr_"+i).click();
				}
			}
		}

		function toggle( x, origColor ){
			var newColor = 'yellow';
			document.getElementById(x).style.backgroundColor = ( newColor == document.getElementById(x).style.backgroundColor )? origColor : newColor;
		}

		function js_set_value( str_data,tr_id ){
			var str_all=str_data.split("_");
			var str_po=str_all[1];
			var str=str_all[0];
			if ( document.getElementById('job_no').value!="" && document.getElementById('job_no').value!=str_all[2] ){
				alert('No Job Mix Allowed')
				return;
			}
			if(str_all[3]==1)
			{
				alert('This PO Without TNA Process. But TNA Integrated Yes in Merchandising Variable Settings.')
				return;
			}
			toggle( tr_id, '#FFFFCC');
			document.getElementById('job_no').value=str_all[2];

			if( jQuery.inArray( str , selected_id ) == -1 ){
				selected_id.push( str );
				selected_name.push( str_po );
			}
			else{
				for( var i = 0; i < selected_id.length; i++ ){
					if( selected_id[i] == str ) break;
				}

				selected_id.splice( i, 1 );
				selected_name.splice( i, 1 );
				//alert(selected_id.length)
				if(selected_id.length==0){
					document.getElementById('job_no').value="";
				}
			}
			var id = '' ; var name = '';
			for( var i = 0; i < selected_id.length; i++ ){
				id += selected_id[i] + ',';
				name += selected_name[i] + ',';
			}
			id = id.substr( 0, id.length - 1 );
			name = name.substr( 0, name.length - 1 );
			$('#po_number_id').val( id );
			$('#po_number').val( name );
		}
	</script>
	</head>
	<body>
        <div align="center" style="width:100%;" >
            <form name="searchpofrm_1" id="searchpofrm_1">
            <table width="940"  align="center" rules="all">
                <tr>
                <td align="center" width="100%">
                <table  width="940" class="rpt_table" align="center" rules="all">
                    <thead>
                        <tr>
                            <th colspan="11" align="center"><? echo create_drop_down( "cbo_string_search_type", 130, $string_search_type,'', 1, "-- Searching Type --",1 ); ?></th>
                        </tr>
                        <tr>
                            <th width="140">Company</th>
                            <th width="150">Buyer</th>
                            <th width="60">Year</th>
                            <th width="60">Job No</th>
                            <th width="70">Internal Ref</th>
                            <th width="70">File No</th>
                            <th width="70">Style Ref </th>
                            <th width="70">Order No</th>
                            <th width="170" colspan="2">Date Range</th>
                            <th>&nbsp;</th>
                        </tr>
                    </thead>
                    <tr>
                        <td><? echo create_drop_down( "cbo_company_mst", 140, "select id,company_name from lib_company comp where status_active=1 and is_deleted=0 $company_cond order by company_name","id,company_name",1, "- Select Company -", str_replace("'","",$cbo_company_name), "load_drop_down( 'partial_fabric_booking_controller', this.value, 'load_drop_down_buyer_popup', 'buyer_td' );","1"); ?>
                        </td>
                        <td id="buyer_td">
                        <? echo create_drop_down( "cbo_buyer_name", 150, "select buy.id,buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active=1 and buy.is_deleted=0 $buyer_cond and b.buyer_id=buy.id and b.tag_company=$cbo_company_name and buy.id in (select  buyer_id from  lib_buyer_party_type where party_type in (1,3,21,90)) group by buy.id, buy.buyer_name order by buyer_name","id,buyer_name", 1, "-- Select Buyer --", str_replace("'","",$cbo_buyer_name), "","1" ); ?>
                        </td>
                        <td><? echo create_drop_down( "cbo_job_year", 60, $year,"", 1, "-- Select --", date('Y'), "",0 ); ?></td>
                        <td><input name="txt_job_prifix" id="txt_job_prifix" class="text_boxes" style="width:50px"></td>
                        <td><input name="txt_internal_ref" id="txt_internal_ref" class="text_boxes" style="width:60px"></td>
                        <td><input name="txt_file_no" id="txt_file_no" class="text_boxes" style="width:60px"></td>
                        <td><input name="txt_style" id="txt_style" class="text_boxes" style="width:60px"></td>
                        <td><input name="txt_order_search" id="txt_order_search" class="text_boxes" style="width:60px"></td>
                        <td><input name="txt_date_from" id="txt_date_from" class="datepicker" style="width:60px" value=""/></td>
                        <td><input name="txt_date_to" id="txt_date_to" class="datepicker" style="width:60px" value=""/></td>
                        <td align="center">
                        <input type="hidden" name="cbo_currency" id="cbo_currency" class="text_boxes" style="width:60px" value="<? echo str_replace("'","",$cbo_currency); ?>"  />
                        <input type="hidden" name="cbo_fabric_natu" id="cbo_fabric_natu" class="text_boxes" style="width:60px" value="<? echo str_replace("'","",$cbo_fabric_natu); ?>"  />
                        <input type="hidden" name="cbouom" id="cbouom" class="text_boxes" style="width:60px" value="<? echo str_replace("'","",$cbouom); ?>"  />
                        <input type="hidden" name="cbo_fabric_source" id="cbo_fabric_source" class="text_boxes" style="width:60px" value="<? echo str_replace("'","",$cbo_fabric_source); ?>"  />
                        <input type="button" name="button2" class="formbutton" value="Show" onClick="show_list_view ( document.getElementById('cbo_company_mst').value+'_'+document.getElementById('cbo_buyer_name').value+'_'+document.getElementById('txt_date_from').value+'_'+document.getElementById('txt_date_to').value+'_'+document.getElementById('txt_job_prifix').value+'_'+document.getElementById('txt_order_search').value+'_'+document.getElementById('txt_style').value+'_'+document.getElementById('cbo_string_search_type').value+'_'+document.getElementById('txt_internal_ref').value+'_'+document.getElementById('txt_file_no').value+'_'+document.getElementById('cbo_job_year').value+'_'+document.getElementById('cbo_currency').value+'_'+document.getElementById('cbo_fabric_natu').value+'_'+document.getElementById('cbouom').value+'_'+document.getElementById('cbo_fabric_source').value, 'create_po_search_list_view', 'search_div', 'partial_fabric_booking_controller', 'setFilterGrid(\'list_view\',-1)')" style="width:70px;" />
                        </td>
                    </tr>
                    <tr>
                        <td colspan="11" align="center">
                        <strong>Selected PO Number:</strong> &nbsp;<input type="text" class="text_boxes" readonly style="width:550px" id="po_number">
                        <input type="hidden" id="po_number_id">
                        <input type="hidden" id="job_no">
                        </td>
                    </tr>
                </table>
                </td>
                </tr>
                <tr>
                <td align="center" >
                <input type="button" name="close" onClick="parent.emailwindow.hide();"  class="formbutton" value="Close" style="width:100px" />
                </td>
                </tr>
                <tr>
                <td id="search_div" align="center">
                </td>
                </tr>
                <tr>
                <td id="search_div" align="center">
                <input type="checkbox" name="check_all" id="check_all" onClick="check_all_data()" /> Check / Uncheck All
                </td>
                </tr>
            </table>
            </form>
        </div>
	</body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}

if($action=="create_po_search_list_view")
{
	$data=explode('_',$data);
	//print_r($data);
	if ($data[0]!=0) $company=" and a.company_name='$data[0]'"; else { echo "Please Select Company First."; die; }
	if (str_replace("'","",$data[4])==""){echo "Please Insert Job First."; die;}
	if ($data[1]!=0) $buyer=" and a.buyer_name='$data[1]'"; else $buyer=""; //{ echo "Please Select Buyer First."; die; }
	if ($data[13]!=0) $uom_cond=" and d.uom='$data[13]'"; else $uom_cond=""; //{ echo "Please Select Buyer First."; die; }

	if($db_type==0) $year_cond=" and SUBSTRING_INDEX(a.insert_date, '-', 1)=$data[10]";
	if($db_type==2) $year_cond=" and to_char(a.insert_date,'YYYY')=$data[10]";

	$sql_result=sql_select("select tna_integrated from variable_order_tracking where company_name='$data[0]' and variable_list=14 and status_active=1 and is_deleted=0");
	$maintain_setting=$sql_result[0][csf('tna_integrated')];

	$job_cond="";
	$order_cond="";
	$style_cond="";
	if($data[7]==1)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num='$data[4]'"; //else  $job_cond="";
		if (str_replace("'","",$data[5])!="") $order_cond=" and b.po_number = '$data[5]'  "; //else  $order_cond="";
		if (trim($data[6])!="") $style_cond=" and a.style_ref_no ='$data[6]'"; //else  $style_cond="";
	}
	else if($data[7]==2)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num like '$data[4]%'"; //else  $job_cond="";
		if (str_replace("'","",$data[5])!="") $order_cond=" and b.po_number like '$data[5]%'  "; //else  $order_cond="";
		if (trim($data[6])!="") $style_cond=" and a.style_ref_no like '$data[6]%'  "; //else  $style_cond="";
	}
	else if($data[7]==3)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num like '%$data[4]'"; //else  $job_cond="";
		if (str_replace("'","",$data[5])!="") $order_cond=" and b.po_number like '%$data[5]'  "; //else  $order_cond="";
		if (trim($data[6])!="") $style_cond=" and a.style_ref_no like '%$data[6]'"; //else  $style_cond="";
	}
	else if($data[7]==4 || $data[7]==0)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num like '%$data[4]%'"; //else  $job_cond="";
		if (str_replace("'","",$data[5])!="") $order_cond=" and b.po_number like '%$data[5]%'  "; //else  $order_cond="";
		if (trim($data[6])!="") $style_cond=" and a.style_ref_no like '%$data[6]%'"; //else  $style_cond="";
	}

	$internal_ref = str_replace("'","",$data[8]);
	$file_no = str_replace("'","",$data[9]);
	if ($file_no=="") $file_no_cond=""; else $file_no_cond=" and b.file_no='".trim($file_no)."' ";
	if ($internal_ref=="") $internal_ref_cond=""; else $internal_ref_cond=" and b.grouping like '%".trim($internal_ref)."%' ";

	if($db_type==0)
	{
		if ($data[2]!="" &&  $data[3]!="") $shipment_date = "and b.pub_shipment_date between '".change_date_format($data[2], "yyyy-mm-dd", "-")."' and '".change_date_format($data[3], "yyyy-mm-dd", "-")."'"; else $shipment_date ="";
	}

	else if($db_type==2)
	{
		if ($data[2]!="" &&  $data[3]!="") $shipment_date = "and b.pub_shipment_date between '".change_date_format($data[2], "yyyy-mm-dd", "-",1)."' and '".change_date_format($data[3], "yyyy-mm-dd", "-",1)."'"; else $shipment_date ="";
	}

	$tna_date_arr=array();
	$sql_tna=sql_select("select po_number_id, max(task_start_date) as task_finish_date from tna_process_mst where task_number in(73) and is_deleted=0 and status_active=1 group by po_number_id");
	foreach($sql_tna as $row)
	{
		$tna_date_arr[$row[csf("po_number_id")]]=1;
	}
	unset($sql_tna);

	$buyer_arr=return_library_array( "select id, short_name from lib_buyer",'id','short_name');
	$comp=return_library_array( "select id, company_short_name from lib_company",'id','company_short_name');
	 $sql= 'select a.job_no_prefix_num AS "job_no_prefix_num" ,a.buyer_name AS "buyer_name", a.job_no AS "job_no",a.style_ref_no AS "style_ref_no", b.id AS "id",b.po_number AS "po_number", b.po_quantity AS "po_quantity",b.shipment_date AS "shipment_date", b.grouping AS "grouping", b.file_no AS "file_no" from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c,wo_pre_cost_fabric_cost_dtls d,wo_pre_cos_fab_co_avg_con_dtls e  where   a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and a.job_no=d.job_no and a.job_no=e.job_no  and b.id=c.po_break_down_id and d.id=e.pre_cost_fabric_cost_dtls_id and c.po_break_down_id=e.po_break_down_id and  c.item_number_id= d.item_number_id and c.color_number_id=e.color_number_id and c.size_number_id=e.gmts_sizes and a.currency_id='.$data[11].' and d.fab_nature_id='.$data[12].'  and d.fabric_source='.$data[14].'     and e.cons !=0   and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1  and b.shiping_status not in(3) '.$shipment_date. $buyer. $company.  $job_cond. $order_cond. $style_cond. $file_no_cond. $internal_ref_cond. $year_cond. $uom_cond.' group by a.job_no_prefix_num,a.job_no,a.buyer_name,a.style_ref_no,b.id,b.po_number,b.po_quantity,b.shipment_date,b.grouping,b.file_no';

	?>
    <div>
     	<table cellspacing="0" cellpadding="0" border="1" rules="all" width="870" class="rpt_table">
            <thead>
                <th width="30">SL</th>
                <th width="80">Buyer</th>
                <th width="80">Job No</th>
                <th width="100">Style Ref.</th>
                <th width="100">PO number</th>
                <th width="80">PO Qty</th>
                <th width="70">Shipment Date</th>
                <th width="70">Internal Ref</th>
                <th>File No</th>
            </thead>
     	</table>
     </div>
     <div style="width:870px; max-height:270px;overflow-y:scroll;" >
        <table cellspacing="0" cellpadding="0" border="1" rules="all" width="850" class="rpt_table" id="list_view">
			<?
			$i=1; $result = sql_select($sql);
            foreach( $result as $row )
            {
                if ($i%2==0)  $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
				if($maintain_setting==1 && $tna_date_arr[$row["id"]]=="") $tna_check=1;  else $tna_check=0;
				?>
					<tr id="tr_<? echo $i; ?>" bgcolor="<? echo $bg_color; ?>" style="text-decoration:none;cursor:pointer" onClick="js_set_value('<? echo $row['id'].'_'.$row['po_number'].'_'.$row['job_no'].'_'.$tna_check; ?>','tr_<? echo $i; ?>');" >
						<td width="30" align="center"><? echo $i; ?></td>
						<td width="80"><? echo $buyer_arr[$row['buyer_name']]; ?></td>
                        <td width="80"><? echo $row['job_no_prefix_num']; ?></td>
                        <td width="100"><? echo $row['style_ref_no'];  ?></td>
						<td width="100"><? echo $row['po_number']; ?></td>
						<td width="80" align="right"><? echo number_format($row['po_quantity']);?> </td>
                        <td width="70"><? echo change_date_format($row['shipment_date']); ?></td>
                        <td width="70"><? echo $row['grouping'];  ?></td>
						<td><? echo $row['file_no'];  ?></td>
					</tr>
				<?
				$i++;
            }
			?>
			</table>
		</div>
	<?
	exit();
}

if ($action=="populate_order_data_from_search_popup")
{
	$data=explode("_",$data);
	//$fabric_description_array=array();
	/*if ($data[2]!=0) $uom_cond=" and a.uom='$data[2]'"; else $uom_cond="";
	 $sql='select a.id AS "id", a.body_part_id AS "body_part_id",a.color_type_id AS "color_type_id",a.fabric_description AS "fabric_description", a.gsm_weight AS "gsm_weight" from wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b  where a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id='.$data[1].' and a.fabric_source='.$data[3].' and b.po_break_down_id in ('.$data[0].')'.$uom_cond.' and a.is_deleted=0 and a.status_active=1 group by a.id, a.body_part_id,a.color_type_id,a.fabric_description,a.gsm_weight';
	$sql_data=sql_select($sql);
	foreach($sql_data as $sql_row){
		$fabric_description_array[$sql_row['id']]=$body_part[$sql_row['body_part_id']].', '.$color_type[$sql_row['color_type_id']].', '.$sql_row['fabric_description'].', '.$sql_row['gsm_weight'];
	}
	 $cbo_fabric_description=create_drop_down( "cbo_fabric_description",500, $fabric_description_array,"", 1, "-- Select --", $selected, "fnc_generate_booking()",0 );
	 echo "document.getElementById('fabric_description_td').innerHTML = '". $cbo_fabric_description."';\n";*/

	 //$sql_delevary=sql_select("select task_number,max(task_finish_date) as task_finish_date from tna_process_mst where po_number_id in(".$data.") and task_number in(73) and is_deleted = 0 and 	status_active=1 group by task_number"); for group
	$sql_delevary=sql_select("select task_number,min(task_start_date) as task_finish_date from tna_process_mst where po_number_id in(".$data[0].") and task_number in(73) and is_deleted = 0 and 	status_active=1 group by task_number");// added for urmi req from fakhrul
	//echo "select task_number,min(task_start_date) as task_finish_date from tna_process_mst where po_number_id in(".$data[0].") and task_number in(73) and is_deleted = 0 and 	status_active=1 group by task_number";
	foreach($sql_delevary as $row_delevary)
	{
	   echo "document.getElementById('txt_delivery_date').value = '".change_date_format($row_delevary[csf("task_finish_date")],'dd-mm-yyyy','-')."';\n";
	   echo "document.getElementById('txt_tna_date').value = '".change_date_format($row_delevary[csf("task_finish_date")],'dd-mm-yyyy','-')."';\n";
	}
}

if ($action=="generate_fabric_booking") 
{
	extract($_REQUEST);
	$txt_order_no_id=str_replace("'","",$txt_order_no_id);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$cbo_currency=str_replace("'","",$cbo_currency);
	$txt_booking_date=str_replace("'","",$txt_booking_date);
	$company_id=str_replace("'","",$cbo_company_name);
	$fabric_cost_dtls_id=implode(",",array_unique(explode(",",str_replace("'","",$cbo_fabric_description))));
	$cbouom=str_replace("'","",$cbouom); 
	
	 $poidCond=implode(",",$poIdChkArr);
	// echo $txt_booking_date.'d';
		
		 
	
	$cu_booking_data_arr=array();
	$sql='select b.pre_cost_fabric_cost_dtls_id AS "pre_cost_fabric_cost_dtls_id", b.po_break_down_id AS "po_break_down_id", b.color_number_id AS "color_number_id", a.id AS "booking_id", a.fin_fab_qnty AS "fin_fab_qnty", a.grey_fab_qnty AS "grey_fab_qnty", a.dia_width AS "dia_width", a.pre_cost_remarks AS "pre_cost_remarks" from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.po_break_down_id=b.po_break_down_id and a.gmts_color_id=b.color_number_id and a.dia_width=b.dia_width and  a.po_break_down_id in('.$txt_order_no_id.') and b.cons>0  and a.booking_type=1 and a.status_active=1 and a.is_deleted=0 group by b.pre_cost_fabric_cost_dtls_id, b.po_break_down_id, b.color_number_id, a.id, a.fin_fab_qnty, a.grey_fab_qnty, a.dia_width, a.pre_cost_remarks';
	$dataArray=sql_select($sql);
	foreach($dataArray as $dataArray_row){
		$cu_booking_data_arr[$dataArray_row['pre_cost_fabric_cost_dtls_id']][$dataArray_row['color_number_id']][$dataArray_row['dia_width']][$dataArray_row['pre_cost_remarks']]['cu_booking_qty'][$dataArray_row['po_break_down_id']]+=$dataArray_row['grey_fab_qnty'];
	}
	$condition= new condition();
	if(str_replace("'","",$txt_order_no_id) !=''){
		$condition->po_id("in($txt_order_no_id)");
	}
	$condition->init();
	$fabric= new fabric($condition);
	$req_qty_arr=$fabric->getQtyArray_by_OrderFabriccostidGmtscolorDiaWidthAndRemarks_knitAndwoven_greyAndfinish();
	$req_amount_arr=$fabric->getAmountArray_by_OrderFabriccostidGmtscolorDiaWidthAndRemarks_knitAndwoven_greyAndfinish();
	
	$color_library=return_library_array( "select id,color_name from lib_color", "id", "color_name");
	//$po_number_arr=return_library_array( "select id,po_number from wo_po_break_down where id in($txt_order_no_id)", "id", "po_number");
 	$currency_rate=1;
	if($cbo_currency==1 && $cbo_fabric_source==2)//Tk Id-4843 NR as per Saeed vi
	{
		if($db_type==0)
		{
		$conversion_date=change_date_format($txt_booking_date, "Y-m-d", "-",1);
		}
		else
		{
		$conversion_date=change_date_format($txt_booking_date, "d-M-y", "-",1);
		}
		$currency_rate=set_conversion_rate( 2, $conversion_date ,$company_id);	
	}
	//echo $currency_rate.'D';
	$job_sql=sql_select("select a.company_name, a.job_no, b.id, b.po_number, min(c.id) as cid, sum(c.plan_cut_qnty) as plan_cut_qnty from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where b.id in(".$txt_order_no_id.") and b.job_no_mst=a.job_no and b.id=c.po_break_down_id and b.job_no_mst=c.job_no_mst and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 group by a.company_name, a.job_no, b.id, b.po_number, c.color_number_id, c.size_number_id, c.item_number_id");
	 $po_number_arr=array(); $paln_cut_qnty_array=array(); $popaln_cut_qnty_array=array();
	foreach($job_sql as $jrow)
	{
		$po_number_arr[$jrow[csf("id")]]=$jrow[csf("po_number")];
		$paln_cut_qnty_array[$jrow[csf("cid")]]=$jrow[csf("plan_cut_qnty")];
		$popaln_cut_qnty_array[$jrow[csf("id")]]+=$jrow[csf("plan_cut_qnty")];
		$txt_job_no=$jrow[csf("job_no")];
	}
	unset($job_sql);
	$item_ratio_array=return_library_array("select gmts_item_id, set_item_ratio from wo_po_details_mas_set_details where job_no ='$txt_job_no'", "gmts_item_id", "set_item_ratio");
	
	$sql='SELECT a.id AS "id", a.job_no AS "job_no", a.uom AS "uom", a.item_number_id AS "item_number_id", a.body_part_id AS "body_part_id", a.color_type_id AS "color_type_id", a.width_dia_type AS "width_dia_type", a.construction AS "construction", a.composition AS "composition", a.gsm_weight AS "gsm_weight", a.costing_per AS "costing_per", b.po_break_down_id AS "po_break_down_id", b.color_number_id AS "color_number_id", b.dia_width AS "dia_width", b.remarks AS "remarks", c.contrast_color_id AS "contrast_color_id", a.color_size_sensitive AS "color_size_sensitive", d.hs_code as "hs_code" 
	
	from wo_pre_cost_fabric_cost_dtls a join wo_pre_cos_fab_co_avg_con_dtls b on a.id=b.pre_cost_fabric_cost_dtls_id join lib_yarn_count_determina_mst d on d.id=a.lib_yarn_count_deter_id left join wo_pre_cos_fab_co_color_dtls c on  b.pre_cost_fabric_cost_dtls_id=c.pre_cost_fabric_cost_dtls_id and b.color_number_id=c.gmts_color_id   where a.id in('.$fabric_cost_dtls_id.') and b.po_break_down_id in ('.$txt_order_no_id.') and b.cons>0  and a.is_deleted=0 and a.status_active=1 and  d.is_deleted=0 and d.status_active=1 group by a.id, a.job_no, a.uom, a.item_number_id, a.body_part_id, a.color_type_id, a.width_dia_type, a.construction, a.composition, a.gsm_weight, a.costing_per, b.po_break_down_id, b.color_number_id, b.dia_width, b.remarks, c.contrast_color_id, a.color_size_sensitive, d.hs_code';
	//echo $sql; die;
	//echo $txt_order_no_id;
	$sql_data=sql_select($sql);
	
	$powiseCostingPerReqQtyArr=array();
	foreach ($req_qty_arr as $knitwoven=>$knitwovendata)
	{
		foreach ($knitwovendata['grey'] as $poid=>$podata)
		{
			foreach ($podata as $bomid=>$bomdata)
			{
				foreach ($bomdata as $colorid=>$colordata)
				{
					foreach ($colordata as $diawidth=>$diawidthdata)
					{
						foreach ($diawidthdata as $remarks=>$remarksdata)
						{
							foreach ($remarksdata as $uom=>$uomdata)
							{
								$powiseCostingPerReqQtyArr[$bomid][$poid]['greyreqqty']+=$uomdata;
							}
						}
					}
				}
			}
		}
	}
	//print_r($powiseCostingPerReqQtyArr[34805][60978]);
	$job_level_arr=array();
	foreach($sql_data as $sql_row){
		$bom_fabric_dtls_id=$sql_row['id'];
		$poid=$sql_row['po_break_down_id'];
		if($sql_row['color_size_sensitive'] == 3) $item_color=$sql_row['contrast_color_id']; else $item_color=0;
		
		if($item_color== "" || $item_color==0) $item_color=$sql_row['color_number_id'];
		
		if($cbo_fabric_natu==2){
			$req_qty=$req_qty_arr['knit']['grey'][$poid][$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']][$sql_row['uom']];
			$finishreq_qty=$req_qty_arr['knit']['finish'][$poid][$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']][$sql_row['uom']];
			$req_amt=$req_amount_arr['knit']['grey'][$poid][$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']][$sql_row['uom']];
			 if($req_amt>0)
			{
			$rate=$req_amt/$req_qty;
			}
			else $rate=0;
			
			if($req_amt) $req_amt=$req_amt;else $req_amt=0;
			if($finishreq_qty) $finishreq_qty=$finishreq_qty;else $finishreq_qty=0;
			if($req_qty) $req_qty=$req_qty;else $req_qty=0;
		}
		if($cbo_fabric_natu==3){
			$req_qty=$req_qty_arr['woven']['grey'][$poid][$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']][$sql_row['uom']];
			$finishreq_qty=$req_qty_arr['woven']['finish'][$poid][$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']][$sql_row['uom']];
			$req_amt=$req_amount_arr['woven']['grey'][$poid][$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']][$sql_row['uom']];
			 if($req_amt>0)
			{
			$rate=$req_amt/$req_qty;
			}
			else $rate=0;
			 
			if($req_amt) $req_amt=$req_amt;else $req_amt=0;
			if($finishreq_qty) $finishreq_qty=$finishreq_qty;else $finishreq_qty=0;
			if($req_qty) $req_qty=$req_qty;else $req_qty=0;
		}
		if($cbo_currency==1 && $cbo_fabric_source==2)//Tk Id-4843 NR as per Saeed vi
		{
			$req_amt=$req_amt*$currency_rate;
			$rate=$rate*$currency_rate;
		}
		$cu_booking_qty=$cu_booking_data_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['cu_booking_qty'][$poid];
		$bal_qty=$req_qty-$cu_booking_qty;
		$bal_amt=$bal_qty*$rate;
		
		if($bal_amt) $bal_amt=$bal_amt;else $bal_amt=0;
		if($bal_qty) $bal_qty=$bal_qty;else $bal_qty=0;
		
		if($sql_row['hs_code']=="") $sql_row['hs_code']="";else $sql_row['hs_code']=$sql_row['hs_code'];
		
		$costing_per=0;
		if($sql_row["costing_per"]==1) $costing_per=12;
		else if($sql_row["costing_per"]==2) $costing_per=1;
		else if($sql_row["costing_per"]==3) $costing_per=24;
		else if($sql_row["costing_per"]==4) $costing_per=36;
		else if($sql_row["costing_per"]==5) $costing_per=48;
		else $costing_per=0;
		
		$itempoWiseReqQty=0;
			
		$itempoWiseReqQty=($powiseCostingPerReqQtyArr[$bom_fabric_dtls_id][$poid]['greyreqqty']/($popaln_cut_qnty_array[$poid]/$item_ratio_array[$sql_row['item_number_id']]))*$costing_per;
		
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['job_no'][$poid]=$sql_row['job_no'];
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['po_id'][$poid]=$poid;
		
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['po_number'][$poid]=$po_number_arr[$poid];
		//=================
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['pre_cost_fabric_cost_dtls_id'][$poid]=$bom_fabric_dtls_id;
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['body_part_id'][$poid]=$sql_row['body_part_id'];
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['construction'][$poid]=$sql_row['construction'];
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['composition'][$poid]=$sql_row['composition'];
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['gsm_weight'][$poid]=$sql_row['gsm_weight'];
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['dia_width'][$poid]=$sql_row['dia_width'];
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['pre_cost_remarks'][$poid]=$sql_row['remarks'];
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['hs_code'][$poid]=$sql_row['hs_code'];
		
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['color_type_id'][$poid]=$sql_row['color_type_id'];
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['width_dia_type'][$poid]=$sql_row['width_dia_type'];
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['uom'][$poid]=$sql_row['uom'];
		//============
		
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['color_number_id'][$poid]=$sql_row['color_number_id'];
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['item_color'][$poid]=$item_color;
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['req_qty'][$poid]=$req_qty;
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['finreq_qty'][$poid]=$finishreq_qty;
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['req_amt'][$poid]=$req_amt;
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['bal_qty'][$poid]=$bal_qty;
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['bal_amt'][$poid]=$bal_amt;
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['rate'][$poid]=$rate;
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['reqqtycostingper'][$poid]=$itempoWiseReqQty;
	}
	//print_r($job_level_arr);
	?>
	<table width="1750" class="rpt_table" border="0" rules="all">
        <thead>
            <th width="80">Job No</th>
            <th width="70">Po No</th>
            <th width="100">Body Part</th>
            <th width="80">Color Type</th>
            <th width="80">Dia Width Type</th>
            <th width="100">Construction</th>
            <th width="150">Composition</th>
            <th width="60">Gsm</th>
            <th width="90">Gmts. Color</th>
            <th width="110">Item Color</th>
            <th width="60">Dia</th>
            <th width="80">HS Code</th>
            <th width="80">Process</th>
            <th width="80">Balance Qty</th>
            <th width="80">WO. Qty</th>
            <th width="70">Adj. Qty</th>
            <th width="80">Ac.WO. Qty</th>
            <th width="50">UOM</th>
            <th width="60" title="Ex-Rate: <?=$currency_rate;?>"><? if($cbo_currency==1 && $cbo_fabric_source==2) echo 'Rate Tk';else echo 'Rate'; ?></th>
            <th width="100">Amount</th>
            <th>Remark</th>
        </thead>
	</table>
	<table width="1750" class="rpt_table" id="tbl_fabric_booking" border="0" rules="all">
        <tbody>
        <?
        if(str_replace("'","",$cbo_level)==1){
			$i=1;
			foreach($sql_data as $sql_row){
				$bom_fabric_dtls_id=$sql_row['id'];
				$job_no=$sql_row['job_no'];
				$po_break_down_id=$sql_row['po_break_down_id'];
				$body_part_id=$sql_row['body_part_id'];
				$construction=$sql_row['construction'];
				$compositi=$sql_row['composition'];
				$gsm_weight=$sql_row['gsm_weight'];
				$color_type_id=$sql_row['color_type_id'];
				$width_dia_type=$sql_row['width_dia_type'];
				$hscode=$sql_row['hs_code'];
				
				$color_number_id=$sql_row['color_number_id'];
				if($sql_row['color_size_sensitive'] == 3) $item_color=$sql_row['contrast_color_id']; else $item_color=0;		
				if($item_color== "" || $item_color==0) $item_color=$sql_row['color_number_id'];
				
				$dia_width=$sql_row['dia_width'];
				$pre_cost_remarks=$sql_row['remarks'];
				
				if($cbo_fabric_natu==2){
					$req_qty=$req_qty_arr['knit']['grey'][$sql_row['po_break_down_id']][$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']][$sql_row['uom']];
					$finishreq_qty=$req_qty_arr['knit']['finish'][$sql_row['po_break_down_id']][$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']][$sql_row['uom']];
					$req_amt=$req_amount_arr['knit']['grey'][$sql_row['po_break_down_id']][$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']][$sql_row['uom']];
					$rate=$req_amt/$req_qty;
				}
				if($cbo_fabric_natu==3){
					$req_qty=$req_qty_arr['woven']['grey'][$sql_row['po_break_down_id']][$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']][$sql_row['uom']];
					$finishreq_qty=$req_qty_arr['woven']['finish'][$sql_row['po_break_down_id']][$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']][$sql_row['uom']];
					$req_amt=$req_amount_arr['woven']['grey'][$sql_row['po_break_down_id']][$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']][$sql_row['uom']];
					$rate=$req_amt/$req_qty;
				}
				$cu_booking_qty=$cu_booking_data_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['cu_booking_qty'][$sql_row['po_break_down_id']];
				$bal_qty=$req_qty-$cu_booking_qty;
				
				if($cbo_currency==1 && $cbo_fabric_source==2) //Tk Id-4843 NR as per Saeed vi
				{
					$req_amt=$req_amt*$currency_rate;
					$rate=$rate*$currency_rate;
				}
				$bal_amt=$bal_qty*$rate;
				
				$costing_per=0;
				if($sql_row["costing_per"]==1) $costing_per=12;
				else if($sql_row["costing_per"]==2) $costing_per=1;
				else if($sql_row["costing_per"]==3) $costing_per=24;
				else if($sql_row["costing_per"]==4) $costing_per=36;
				else if($sql_row["costing_per"]==5) $costing_per=48;
				else $costing_per=0;
				
				$itempoWiseReqQty=0;
					
				$itempoWiseReqQty=($powiseCostingPerReqQtyArr[$bom_fabric_dtls_id][$sql_row['po_break_down_id']]['greyreqqty']/($popaln_cut_qnty_array[$sql_row['po_break_down_id']]/$item_ratio_array[$sql_row['item_number_id']]))*$costing_per;
				
				if(number_format($bal_qty,4,'.','') >0){
					if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					?>
					<tr bgcolor="<?=$bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="search<?=$i; ?>">
                        <td width="80" style="word-break:break-all"><?=$job_no; ?>
                        	<input type="hidden" id="txtjob_<?=$i;?>" value="<?=$job_no;?>" readonly />
                        </td>
                        <td width="70" style="word-break: break-all;word-wrap: break-word;"><?=$po_number_arr[$po_break_down_id]; ?>
                        	<input type="hidden" id="txtpoid_<?=$i;?>" value="<?=$po_break_down_id;?>"  readonly  />
                        </td>
                        <td width="100" style="word-break:break-all"><?=$body_part[$body_part_id]; ?>
                            <input type="hidden" id="txtpre_cost_fabric_cost_dtls_id_<? echo $i;?>" value="<? echo $bom_fabric_dtls_id;?>"  readonly  />
                            <input type="hidden" id="txtbodypart_<? echo $i;?>" value="<? echo $body_part_id;?>"  readonly  />
                        </td>
                        <td width="80" style="word-break:break-all"><?=$color_type[$color_type_id]; ?>
                        	<input type="hidden" id="txtcolortype_<? echo $i;?>" value="<? echo $color_type_id;?>"  readonly  />
                        </td>
                        <td width="80" style="word-break:break-all"><?=$fabric_typee[$width_dia_type]; ?>
                        	<input type="hidden" id="txtwidthtype_<? echo $i;?>" value="<? echo $width_dia_type;?>"  readonly  />
                        </td>
                        <td width="100" style="word-break:break-all"><?=$construction; ?>
                        	<input type="hidden" id="txtconstruction_<? echo $i;?>" value="<? echo $construction;?>"  readonly  />
                        </td>
                        <td width="150" style="word-break:break-all"><?=$compositi; ?>
                        	<input type="hidden" id="txtcompositi_<? echo $i;?>" value="<? echo $compositi;?>"  readonly  />
                        </td>
                        <td width="60" style="word-break:break-all"><?=$gsm_weight; ?>
                        	<input type="hidden" id="txtgsm_weight_<? echo $i;?>" value="<? echo $gsm_weight;?>"  readonly  />
                        </td>
                        <td width="90" style="word-break:break-all"><?=$color_library[$color_number_id]; ?>
                        	<input type="hidden" id="txtgmtcolor_<? echo $i;?>" value="<? echo $color_number_id;?>"  readonly  />
                        </td>
                        <td width="110" style="word-break:break-all"><?=$color_library[$item_color]; ?>
                        	<input type="hidden" id="txtitemcolor_<? echo $i;?>" value="<? echo $item_color;?>"  readonly  />
                        </td>
                        <td width="60" style="word-break:break-all"><?=$dia_width; ?>
                        	<input type="hidden" id="txtdia_<? echo $i;?>" value="<? echo $dia_width;?>"  readonly  />
                        </td>
						<td width="80">
							<input type="text" style="width:80%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px; text-align:right; background-color:<?=$bgcolor; ?>" id="txthscode_<?=$i;?>" value="<?=$hscode;?>" />
                        </td>
                        <td width="80" style="word-break:break-all"><?=$pre_cost_remarks; ?>
                        	<input type="hidden" id="process_<? echo $i;?>" value="<? echo $pre_cost_remarks;?>"  readonly  />
                        </td>
                        <td width="80">	
                            <input type="text" style="width:80%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px; text-align:right; background-color:<?=$bgcolor; ?>" id="txtbalqnty_<?=$i;?>" value="<?=number_format($bal_qty,4,'.','');?>" readonly />
                            <input type="hidden" id="txtreqqnty_<?=$i;?>" value="<?=number_format($req_qty,4,'.','');?>"  readonly  />
                            <input type="hidden" id="txtfinreqqnty_<?=$i;?>" value="<?=number_format($finishreq_qty,4,'.','');?>" class="text_boxes_numeric" readonly />
                            <input type="hidden" id="cuqnty_<?=$i;?>" value="<?=number_format($cu_booking_qty,4,'.','');?>"  readonly  />
                            <input type="hidden" id="preconskg_<?=$i; ?>" style="width:20px;" value="<?=$itempoWiseReqQty; ?>"/>
                        </td>
                        <td width="80">
                            <input type="text" style="width:90%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px;  text-align:right; background-color:#FFC" id="txtwoq_<? echo $i;?>" value="<? echo number_format($bal_qty,4,'.','');?>" onChange="claculate_acwoQty(<? echo $i; ?>)" />
                            <input type="hidden"  style="width:90%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px;  text-align:right; background-color:#FFC" id="txtwoqprev_<? echo $i;?>" value="<? echo number_format($bal_qty,4,'.','');?>" class="text_boxes_numeric" readonly />
                        </td>
                        <td width="70">
                            <input type="text"  style="width:90%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px;  text-align:right; background-color:#FFC" id="txtadj_<? echo $i;?>" value="<? //echo number_format($adj_qty,4,'.','');?>" class="text_boxes_numeric"  onChange="claculate_acwoQty(<? echo $i; ?>)"  />
                        </td>
                        <td width="80">
                            <input type="text"  style="width:90%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px;  text-align:right; background-color:#FFC" id="txtacwoq_<? echo $i;?>" value="<? echo number_format($bal_qty,4,'.','');?>" class="text_boxes_numeric"  readonly />
                        </td>
                        <td width="50" align="center"><? echo $unit_of_measurement[$sql_row['uom']]; ?></td>
                        <td width="60">
                            <input type="text"  style="width:70%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px;  text-align:right; background-color:<? echo $bgcolor; ?>" id="txtrate_<? echo $i;?>" value="<? echo number_format($rate,4,'.','');?>"  class="text_boxes_numeric" onChange="claculate_amount(<? echo $i; ?>)" data-pre-cost-rate="<? echo number_format($rate,4,'.','');?>" data-current-rate="<? echo number_format($rate,4,'.','');?>"  />
                        </td>
                        <td width="100">
                            <input type="text"  style="width:90%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px;  text-align:right; background-color:<? echo $bgcolor; ?>" id="txtamount_<? echo $i;?>" value="<? echo number_format($bal_amt,4,'.','');?>" class="text_boxes_numeric" readonly  />
                        </td>
                        <td>
                            <input type="text"  style="width:100%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px;  background-color:<? echo $bgcolor; ?>" id="txtremark_<? echo $i;?>" value="" />
                            <input type="hidden"   id="bookingid_<? echo $i;?>" value=""  readonly  />
                        </td>
					</tr>
					<?
					$i++;
				}
			}
        }
        if(str_replace("'","",$cbo_level)==2){
			$i=1;
			foreach($job_level_arr as $precost_id){
				foreach($precost_id as $color_id){
					foreach($color_id as $diawith){
						foreach($diawith as $remarks){
							$job_no=implode(",",array_unique($remarks['job_no']));
							$po_break_down_id=implode(",",array_unique($remarks['po_id']));
							$po_number=implode(",",array_unique($remarks['po_number']));
							$bom_fabric_dtls_id=implode(",",array_unique($remarks['pre_cost_fabric_cost_dtls_id']));
							$body_part_id=implode(",",array_unique($remarks['body_part_id']));
							$construction=implode(",",array_unique($remarks['construction']));
							$compositi=implode(",",array_unique($remarks['composition']));
							$gsm_weight=implode(",",array_unique($remarks['gsm_weight']));
							$color_type_id=implode(",",array_unique($remarks['color_type_id']));
							$width_dia_type=implode(",",array_unique($remarks['width_dia_type']));
							$uom=implode(",",array_unique($remarks['uom']));
							
							$color_number_id=implode(",",array_unique($remarks['color_number_id']));
							$item_color=implode(",",array_unique($remarks['item_color']));
							$dia_width=implode(",",array_unique($remarks['dia_width']));
							$pre_cost_remarks=implode(",",array_unique($remarks['pre_cost_remarks']));
							$hscode=implode(",",array_unique($remarks['hs_code']));
							
							$req_qty=array_sum($remarks['req_qty']);
							$finishreq_qty=array_sum($remarks['finreq_qty']);
							$rate=array_sum($remarks['rate']);
							$req_amt=array_sum($remarks['req_amt']);
							$bal_qty=array_sum($remarks['bal_qty']);
							$bal_amt=array_sum($remarks['bal_amt']);
							$rate=$req_amt/$req_qty;
							$bal_amt=$bal_qty*$rate;
							$cu_booking_qty=array_sum($cu_booking_data_arr[$bom_fabric_dtls_id][$color_number_id][$dia_width][$pre_cost_remarks]['cu_booking_qty']);
							
							if(number_format($bal_qty,4,'.','') >0){
								if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
								?>
								<tr bgcolor="<?=$bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="search<?=$i;?>">
                                    <td width="80" style="word-break:break-all"><?=$job_no; ?>
                                    	<input type="hidden" id="txtjob_<? echo $i;?>" value="<? echo $job_no;?>"  readonly  />
                                    </td>
                                    <td width="70" style="word-break: break-all;word-wrap: break-word;"><A href="#" onClick="setdata('<?=$po_number; ?>');">View</A>
                                        <input type="hidden" id="txtpoid_<? echo $i;?>" value="<? echo $po_break_down_id;?>"  readonly  />
                                    </td>
                                    <td width="100" style="word-break:break-all"><? echo $body_part[$body_part_id]; ?>
                                        <input type="hidden" id="txtpre_cost_fabric_cost_dtls_id_<? echo $i;?>" value="<? echo $bom_fabric_dtls_id;?>"  readonly  />
                                        <input type="hidden" id="txtbodypart_<? echo $i;?>" value="<? echo $body_part_id;?>"  readonly  />
                                    </td>
                                    <td width="80" style="word-break:break-all"><? echo $color_type[$color_type_id]; ?>
                                        <input type="hidden" id="txtcolortype_<? echo $i;?>" value="<? echo $color_type_id;?>"  readonly  />
                                    </td>
                                    <td width="80" style="word-break:break-all"><? echo $fabric_typee[$width_dia_type]; ?>
                                        <input type="hidden" id="txtwidthtype_<? echo $i;?>" value="<? echo $width_dia_type;?>"  readonly  />
                                    </td>
                                    <td width="100" style="word-break:break-all"><? echo $construction; ?>
                                        <input type="hidden" id="txtconstruction_<? echo $i;?>" value="<? echo $construction;?>"  readonly  />
                                    </td>
                                    <td width="150" style="word-break:break-all"><? echo $compositi; ?>
                                        <input type="hidden" id="txtcompositi_<? echo $i;?>" value="<? echo $compositi;?>"  readonly  />
                                    </td>
                                    <td width="60" style="word-break:break-all"><? echo $gsm_weight; ?>
                                    	<input type="hidden" id="txtgsm_weight_<? echo $i;?>" value="<? echo $gsm_weight;?>"  readonly  />
                                    </td>
                                    <td width="90" style="word-break:break-all"><? echo $color_library[$color_number_id]; ?>
                                    	<input type="hidden" id="txtgmtcolor_<? echo $i;?>" value="<? echo $color_number_id;?>"  readonly  />
                                    </td>
                                    <td width="110" style="word-break:break-all"><? echo $color_library[$item_color]; ?>
                                    	<input type="hidden" id="txtitemcolor_<? echo $i;?>" value="<? echo $item_color;?>"  readonly  />
                                    </td>
                                    <td width="60" style="word-break:break-all"><? echo $dia_width; ?>
                                   		<input type="hidden" id="txtdia_<? echo $i;?>" value="<? echo $dia_width;?>"  readonly  />
                                    </td>
									<td width="80">
										<input type="text" style="width:80%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px; text-align:right;" id="txthscode_<?=$i;?>" value="<?=$hscode;?>" class="text_boxes" />
									</td>
                                    <td width="80" style="word-break:break-all"><? echo $pre_cost_remarks; ?>
                                    	<input type="hidden" id="process_<? echo $i;?>" value="<? echo $pre_cost_remarks;?>"  readonly  />
                                    </td>
                                    <td width="80">	
                                        <input type="text" style="width:80%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px; text-align:right;" id="txtbalqnty_<? echo $i;?>" value="<? echo number_format($bal_qty,4,'.','');?>" class="text_boxes_numeric" readonly />
                                        <input type="hidden" id="txtreqqnty_<? echo $i;?>" value="<? echo number_format($req_qty,4,'.','');?>"  readonly  />
                                        <input type="hidden" id="txtfinreqqnty_<?=$i;?>" value="<?=number_format($finishreq_qty,4,'.','');?>" readonly />
                                        <input type="hidden" id="cuqnty_<? echo $i;?>" value="<? echo number_format($cu_booking_qty,4,'.','');?>"  readonly  />
                                        <input type="hidden" id="preconskg_<?=$i; ?>" style="width:20px;" value=""/>
                                    </td>
                                    <td width="80">
                                        <input type="text"  style="width:90%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px;  text-align:right; background-color:#FFC" id="txtwoq_<? echo $i;?>" value="<? echo number_format($bal_qty,4,'.','');?>"  class="text_boxes_numeric" onChange="claculate_acwoQty(<? echo $i; ?>)"   />
                                        <input type="hidden"  style="width:100%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px;  text-align:right; background-color:#FFC" id="txtwoqprev_<? echo $i;?>" value="<? echo number_format($bal_qty,4,'.','');?>" readonly />
                                    </td>
                                    <td width="70"><input type="text"  style="width:90%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px;  text-align:right; background-color:#FFC" id="txtadj_<? echo $i;?>" value=""  class="text_boxes_numeric" onChange="claculate_acwoQty(<? echo $i; ?>)"  />
                                    </td>
                                    <td width="80"><input type="text"  style="width:90%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px;  text-align:right; background-color:#FFC" id="txtacwoq_<? echo $i;?>" value="<? echo number_format($bal_qty,4,'.','');?>"  class="text_boxes_numeric"  readonly  /></td>
                                    <td width="50" align="center"><? echo $unit_of_measurement[$uom]; ?></td>
                                    <td width="60"><input type="text"  style="width:90%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px;  text-align:right; background-color:<? echo $bgcolor; ?>" id="txtrate_<? echo $i;?>" value="<? echo number_format($rate,4,'.','');?>"  class="text_boxes_numeric" onChange="claculate_amount(<? echo $i; ?>)" data-pre-cost-rate="<? echo number_format($rate,4,'.','');?>" data-current-rate="<? echo number_format($rate,4,'.','');?>"  /></td>
                                    <td width="100">
                                    	<input type="text"  style="width:90%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px;  text-align:right; background-color:<? echo $bgcolor; ?>" id="txtamount_<? echo $i;?>" value="<? echo number_format($bal_amt,4,'.','');?>"  class="text_boxes_numeric"  readonly  />
                                    </td>
                                    <td>
                                        <input type="text"  style="width:100%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px;   background-color:<? echo $bgcolor; ?>" id="txtremark_<? echo $i;?>" value=""    />
                                        <input type="hidden"   id="bookingid_<?=$i;?>" value=""  readonly  />
                                    </td>
								</tr>
								<?
								$i++;
							}
						}
					}
				}
			}
        }
        ?>
        </tbody>
	</table>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	<input type='hidden' id='json_data' name="json_data" value='<?=json_encode($job_level_arr); ?>'/>
	<?
	//ISD-22-30488 for Urmi
	 $sql_pre=sql_select("select a.job_id,a.update_by_fabrice from wo_pre_cost_mst a,wo_po_break_down b where a.job_id=b.job_id and  b.id in($txt_order_no_id) and a.update_by_fabrice>0 and a.status_active=1 and b.status_active=1");
		foreach($sql_pre as $row){
			$job_idArr[$row[csf('job_id')]]=$row[csf('job_id')];
		}
		unset($sql_pre);
		$job_ids=implode(",",$job_idArr);
		$con = connect();
		 $update_rID1= execute_query( "update wo_pre_cost_mst set update_by_fabrice=0 where job_id in($job_ids) and status_active=1 and is_deleted=0",0);
		 oci_commit($con);
	exit();
}

if ($action=="show_fabric_booking"){
	echo load_html_head_contents("Partial Booking Details","../../../", 1, 1, $unicode);
	extract($_REQUEST);

	$txt_order_no_id=str_replace("'","",$txt_order_no_id);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$cbo_currency=str_replace("'","",$cbo_currency);
	$company_id=str_replace("'","",$cbo_company_name);
	$txt_booking_date=str_replace("'","",$txt_booking_date);
	$fabric_cost_dtls_id=implode(",",array_unique(explode(",",str_replace("'","",$cbo_fabric_description))));
	$cbouom=str_replace("'","",$cbouom);

	$currency_rate=1;
	if($cbo_currency==1 && $cbo_fabric_source==2)//Tk Id-4843 NR as per Saeed vi
	{
		if($db_type==0)
		{
		$conversion_date=change_date_format($txt_booking_date, "Y-m-d", "-",1);
		}
		else
		{
		$conversion_date=change_date_format($txt_booking_date, "d-M-y", "-",1);
		}
		$currency_rate=set_conversion_rate(2,$conversion_date,$company_id);	
	}
	//echo $txt_booking_date.'='.$currency_rate;
	
	$cu_booking_data_arr=array();
	$sql_cu='SELECT a.pre_cost_fabric_cost_dtls_id AS "pre_cost_fabric_cost_dtls_id", a.po_break_down_id AS "po_break_down_id", a.gmts_color_id AS "color_number_id", a.id AS "booking_id", a.fin_fab_qnty AS "fin_fab_qnty", a.grey_fab_qnty AS "grey_fab_qnty", a.adjust_qty AS "adjust_qty", a.dia_width AS "dia_width", a.pre_cost_remarks AS "pre_cost_remarks",c.currency_id as "currency_id" from wo_booking_mst c,wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b  where a.pre_cost_fabric_cost_dtls_id=b.id  and c.id=a.booking_mst_id  and  a.po_break_down_id in('.$txt_order_no_id.')   and a.booking_type=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0  and c.status_active=1 and c.is_deleted=0';
	//group by a.pre_cost_fabric_cost_dtls_id,a.po_break_down_id,a.gmts_color_id,a.id,a.fin_fab_qnty,a.grey_fab_qnty,a.adjust_qty,a.dia_width,a.pre_cost_remarks
	$dataArray_cu=sql_select($sql_cu);
	foreach($dataArray_cu as $dataArray_row){
		/*$priv_currency_id=$dataArray_row['currency_id'];
		//echo $cbo_currency.'='.$priv_currency_id.'<br>';
		if($cbo_currency==1 && $priv_currency_id==2)
		{
			$priv_currency_id=$dataArray_row['currency_id'];
		}*/
		
		$cu_booking_data_arr[$dataArray_row['pre_cost_fabric_cost_dtls_id']][$dataArray_row['color_number_id']][$dataArray_row['dia_width']][$dataArray_row['pre_cost_remarks']]['cu_booking_qty'][$dataArray_row['po_break_down_id']]+=$dataArray_row['grey_fab_qnty'];
	}
	unset($dataArray_cu);
	
	$companyId=return_field_value("company_id", "wo_booking_mst", "booking_no=".$txt_booking_no." and status_active=1 and is_deleted=0");
	
	$variable_textile_sales_maintain = sql_select("select production_entry from variable_settings_production where company_name='$companyId' and variable_list=66 and status_active=1");

	if($variable_textile_sales_maintain[0][csf('production_entry')] ==2) $textile_sales_maintain = 1; else $textile_sales_maintain = 0;

	$booking_data_arr=array();//cbo_currency
	$sql_pre='select a.pre_cost_fabric_cost_dtls_id AS "pre_cost_fabric_cost_dtls_id", a.po_break_down_id AS "po_break_down_id", a.gmts_color_id AS "color_number_id", a.id AS "booking_id", a.fin_fab_qnty AS "fin_fab_qnty", a.grey_fab_qnty AS "grey_fab_qnty", a.rate AS "rate", a.amount AS "amount", a.adjust_qty AS "adjust_qty", a.remark AS "remark", a.dia_width AS "dia_width", a.pre_cost_remarks AS "pre_cost_remarks", a.hs_code as "hs_code" from wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b  where a.pre_cost_fabric_cost_dtls_id=b.id and a.po_break_down_id in('.$txt_order_no_id.')  and a.booking_no='.$txt_booking_no.' and a.booking_type=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 ';
	$result_dataArray=sql_select($sql_pre);
	$booking_data_arr=array();
	foreach($result_dataArray as $row)
	{
		
		
		$booking_data_arr[$row['pre_cost_fabric_cost_dtls_id']][$row['color_number_id']][$row['dia_width']][$row['pre_cost_remarks']]['booking_qty'][$row['po_break_down_id']]+=$row['grey_fab_qnty'];
		
		
		//echo $dataArray_row['grey_fab_qnty'].'<br>';
		if($textile_sales_maintain==1)
		{
			$booking_data_arr[$row['pre_cost_fabric_cost_dtls_id']][$row['color_number_id']][$row['dia_width']][$row['pre_cost_remarks']]['ac_booking_qty'][$row['po_break_down_id']]+=$row['grey_fab_qnty']-$row['adjust_qty'];
		}
		else
		{
			$booking_data_arr[$row['pre_cost_fabric_cost_dtls_id']][$row['color_number_id']][$row['dia_width']][$row['pre_cost_remarks']]['ac_booking_qty'][$row['po_break_down_id']]+=$row['fin_fab_qnty']-$row['adjust_qty'];
		}
		
		$booking_data_arr[$row['pre_cost_fabric_cost_dtls_id']][$row['color_number_id']][$row['dia_width']][$row['pre_cost_remarks']]['rate'][$row['po_break_down_id']]=$row['rate'];
		$booking_data_arr[$row['pre_cost_fabric_cost_dtls_id']][$row['color_number_id']][$row['dia_width']][$row['pre_cost_remarks']]['amount'][$row['po_break_down_id']]+=$row['amount'];
		$booking_data_arr[$row['pre_cost_fabric_cost_dtls_id']][$row['color_number_id']][$row['dia_width']][$row['pre_cost_remarks']]['adjust_qty'][$row['po_break_down_id']]+=$row['adjust_qty'];
		$booking_data_arr[$row['pre_cost_fabric_cost_dtls_id']][$row['color_number_id']][$row['dia_width']][$row['pre_cost_remarks']]['remark'][$row['po_break_down_id']]=$row['remark'];
		$booking_data_arr[$row['pre_cost_fabric_cost_dtls_id']][$row['color_number_id']][$row['dia_width']][$row['pre_cost_remarks']]['hscode'][$row['po_break_down_id']]=$row['hs_code'];

		$booking_data_arr[$row['pre_cost_fabric_cost_dtls_id']][$row['color_number_id']][$row['dia_width']][$row['pre_cost_remarks']]['booking_id'][$row['po_break_down_id']]=$row['booking_id'];

	}
	unset($result_dataArray);	
	$condition= new condition();
	if(str_replace("'","",$txt_order_no_id) !=''){
		$condition->po_id("in($txt_order_no_id)");
	}
	$condition->init();
	$fabric= new fabric($condition);

	$req_qty_arr=$fabric->getQtyArray_by_OrderFabriccostidGmtscolorDiaWidthAndRemarks_knitAndwoven_greyAndfinish();
	$req_amount_arr=$fabric->getAmountArray_by_OrderFabriccostidGmtscolorDiaWidthAndRemarks_knitAndwoven_greyAndfinish();

	$color_library=return_library_array( "select id,color_name from lib_color", "id", "color_name");
	
	$job_sql=sql_select("select a.company_name, a.job_no, b.id, b.po_number,b.grouping, min(c.id) as cid, sum(c.plan_cut_qnty) as plan_cut_qnty from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where b.id in(".$txt_order_no_id.") and b.job_no_mst=a.job_no and b.id=c.po_break_down_id and b.job_no_mst=c.job_no_mst and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1 group by a.company_name, a.job_no, b.id, b.po_number,b.grouping, c.color_number_id, c.size_number_id, c.item_number_id");
	 $po_number_arr=array(); $paln_cut_qnty_array=array(); $popaln_cut_qnty_array=array();$internal_ref_arr=array();
	foreach($job_sql as $jrow)
	{
		$po_number_arr[$jrow[csf("id")]]=$jrow[csf("po_number")];
		$internal_ref_arr[$jrow[csf("id")]]=$jrow[csf("grouping")];
		$paln_cut_qnty_array[$jrow[csf("cid")]]=$jrow[csf("plan_cut_qnty")];
		$popaln_cut_qnty_array[$jrow[csf("id")]]+=$jrow[csf("plan_cut_qnty")];
		$txt_job_no=$jrow[csf("job_no")];
	}
	unset($job_sql);
	$item_ratio_array=return_library_array("select gmts_item_id, set_item_ratio from wo_po_details_mas_set_details where job_no ='$txt_job_no'", "gmts_item_id", "set_item_ratio");

	$sql='select a.id AS "id", a.job_no AS "job_no", a.uom AS "uom", a.item_number_id as "item_number_id", a.body_part_id AS "body_part_id", a.color_type_id AS "color_type_id", a.width_dia_type AS "width_dia_type", a.construction AS "construction", a.composition AS "composition", a.gsm_weight AS "gsm_weight", a.costing_per AS "costing_per", b.po_break_down_id AS "po_break_down_id", b.color_number_id AS "color_number_id", b.dia_width AS "dia_width", b.remarks AS "remarks",b.itrm_ref AS "itrm_ref", c.contrast_color_id AS "contrast_color_id" from wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b left join wo_pre_cos_fab_co_color_dtls c on  b.pre_cost_fabric_cost_dtls_id=c.pre_cost_fabric_cost_dtls_id and b.color_number_id=gmts_color_id  where a.id=b.pre_cost_fabric_cost_dtls_id  and  a.id in('.$fabric_cost_dtls_id.') and b.po_break_down_id in ('.$txt_order_no_id.') and b.cons>0  and a.is_deleted=0 and a.status_active=1 group by a.id, a.job_no, a.uom, a.item_number_id, a.body_part_id, a.color_type_id, a.width_dia_type, a.construction, a.composition, a.gsm_weight, a.costing_per, b.color_number_id, b.po_break_down_id, b.dia_width,b.itrm_ref, b.remarks, c.contrast_color_id';
	//echo $sql;
	$sql_data=sql_select($sql);
	
	$powiseCostingPerReqQtyArr=array();
	foreach ($req_qty_arr as $knitwoven=>$knitwovendata)
	{
		foreach ($knitwovendata['grey'] as $poid=>$podata)
		{
			foreach ($podata as $bomid=>$bomdata)
			{
				foreach ($bomdata as $colorid=>$colordata)
				{
					foreach ($colordata as $diawidth=>$diawidthdata)
					{
						foreach ($diawidthdata as $remarks=>$remarksdata)
						{
							foreach ($remarksdata as $uom=>$uomdata)
							{
								$powiseCostingPerReqQtyArr[$bomid][$poid]['greyreqqty']+=$uomdata;
							}
						}
					}
				}
			}
		}
	}
	
	$job_level_arr=array();
	foreach($sql_data as $sql_row){
		$bom_fabric_dtls_id=$sql_row['id'];
		$item_color=$sql_row['contrast_color_id'];
		$poid=$sql_row['po_break_down_id'];
		if($item_color== "" || $item_color==0) $item_color=$sql_row['color_number_id'];
		
		if($cbo_fabric_natu==2){
			$req_qty=$req_qty_arr['knit']['grey'][$poid][$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']][$sql_row['uom']];
			$finishreq_qty=$req_qty_arr['knit']['finish'][$poid][$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']][$sql_row['uom']];
			$req_amt=$req_amount_arr['knit']['grey'][$poid][$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']][$sql_row['uom']];
			$rate=$req_amt/$req_qty;
		}
		if($cbo_fabric_natu==3){
			$req_qty=$req_qty_arr['woven']['grey'][$poid][$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']][$sql_row['uom']];
			$finishreq_qty=$req_qty_arr['woven']['finish'][$poid][$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']][$sql_row['uom']];
			$req_amt=$req_amount_arr['woven']['grey'][$poid][$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']][$sql_row['uom']];
			$rate=$req_amt/$req_qty;
		}
		if($cbo_currency==1 && $cbo_fabric_source==2)//Purchase //Tk Issue Id-4843 NR as per Saeed vi
		{
			$rate=$rate*$currency_rate;
			$req_amt=$req_amt*$currency_rate;
		}
		$cu_booking_qty=$cu_booking_data_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['cu_booking_qty'][$poid];
		$booking_qty=$booking_data_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['booking_qty'][$poid];
		$ac_booking_qty=$booking_data_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['ac_booking_qty'][$poid];
		$adjust_qty=$booking_data_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['adjust_qty'][$poid];
		$remark=$booking_data_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['remark'][$poid];
		$hscode=$booking_data_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['hscode'][$poid];
		$rate=$booking_data_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['rate'][$poid];
		$amount=$booking_data_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['amount'][$poid];

		$booking_id=$booking_data_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['booking_id'][$poid];

		$bal_qty=$req_qty-$cu_booking_qty;
		$bal_amt=$bal_qty-$rate;
		
		$costing_per=0;
		if($sql_row["costing_per"]==1) $costing_per=12;
		else if($sql_row["costing_per"]==2) $costing_per=1;
		else if($sql_row["costing_per"]==3) $costing_per=24;
		else if($sql_row["costing_per"]==4) $costing_per=36;
		else if($sql_row["costing_per"]==5) $costing_per=48;
		else $costing_per=0;
		
		$itempoWiseReqQty=0;
			
		$itempoWiseReqQty=($powiseCostingPerReqQtyArr[$bom_fabric_dtls_id][$poid]['greyreqqty']/($popaln_cut_qnty_array[$poid]/$item_ratio_array[$sql_row['item_number_id']]))*$costing_per;

		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['job_no'][$poid]=$sql_row['job_no'];
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['po_id'][$poid]=$poid;
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['po_number'][$poid]=$po_number_arr[$poid];
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['internal_ref'][$poid]=$internal_ref_arr[$poid];
		//=================
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['pre_cost_fabric_cost_dtls_id'][$poid]=$bom_fabric_dtls_id;
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['body_part_id'][$poid]=$sql_row['body_part_id'];
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['construction'][$poid]=$sql_row['construction'];
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['itrm_ref'][$poid]=$sql_row['itrm_ref'];
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['composition'][$poid]=$sql_row['composition'];
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['gsm_weight'][$poid]=$sql_row['gsm_weight'];
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['dia_width'][$poid]=$sql_row['dia_width'];
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['pre_cost_remarks'][$poid]=$sql_row['remarks'];
	    $job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['color_type_id'][$poid]=$sql_row['color_type_id'];
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['width_dia_type'][$poid]=$sql_row['width_dia_type'];
		//============
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['color_number_id'][$poid]=$sql_row['color_number_id'];
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['item_color'][$poid]=$item_color;
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['req_qty'][$poid]=$req_qty;
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['finreq_qty'][$poid]=$finishreq_qty;
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['req_amt'][$poid]=$req_amt;
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['bal_qty'][$poid]=$bal_qty;
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['bal_amt'][$poid]=$bal_amt;
		
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['booking_id'][$poid]=$booking_id;
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['booking_qty'][$poid]=$booking_qty;
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['ac_booking_qty'][$poid]=$ac_booking_qty;
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['adjust_qty'][$poid]=$adjust_qty;
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['remark'][$poid]=$remark;
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['hscode'][$poid]=$hscode;

		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['rate'][$poid]=$rate;
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['amount'][$poid]=$amount;
		$job_level_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['reqqtycostingper'][$poid]=$itempoWiseReqQty;
	}
	?>
	<div>
	<? echo load_freeze_divs ("../../../",$permission);  ?>
        <table width="1920" class="rpt_table" border="0" rules="all">
            <thead>
                <th width="80">Job No</th>
				<th width="80">Internal Ref.</th>
                <th width="70">Po No</th>
                <th width="100">Body Part</th>
                <th width="80">Color Type</th>
                <th width="80">Dia Width Type</th>
                <th width="100">Construction</th>
                <th width="150">Composition</th>
                <th width="60">Gsm</th>
                <th width="90">Gmts. Color</th>
                <th width="110">Item Color</th>
				<th width="90">Item Ref.</th>
                <th width="60">Dia</th>
                <th width="80">Process</th>
                <th width="80">HS Code</th>
                <th width="80">Balance Qty</th>
                <th width="80">WO. Qty</th>
                <th width="70">Adj. Qty</th>
                <th width="80">Ac.WO. Qty</th>
                <th width="50">UOM</th>
                <th width="60"><? if($cbo_currency==1) echo "Rate Tk";else echo "Rate";?></th>
                <th width="100">Amount</th>
                <th>Remark</th>
            </thead>
        </table>
        <table width="1920" class="rpt_table" id="tbl_fabric_booking" border="0" rules="all">
            <tbody>
            <?
            /*echo '<pre>';
            print_r($job_level_arr); die;*/
            if(str_replace("'","",$cbo_level)==1)
			{
				$i=1;
				foreach($sql_data as $sql_row)
				{
					$bom_fabric_dtls_id=$sql_row['id'];
					$job_no=$sql_row['job_no'];
					$po_break_down_id=$sql_row['po_break_down_id'];
					$body_part_id=$sql_row['body_part_id'];
					$construction=$sql_row['construction'];
					$compositi=$sql_row['composition'];
					$gsm_weight=$sql_row['gsm_weight'];
					$color_type_id=$sql_row['color_type_id'];
					$width_dia_type=$sql_row['width_dia_type'];
					$itrm_ref=$sql_row['itrm_ref'];
					
					
					$color_number_id=$sql_row['color_number_id'];
					$item_color=$sql_row['contrast_color_id'];
					if($item_color== "" || $item_color==0) $item_color=$sql_row['color_number_id'];
					
					$dia_width=$sql_row['dia_width'];
					$pre_cost_remarks=$sql_row['remarks'];
					
					
					if($cbo_fabric_natu==2)
					{
						$req_qty=$req_qty_arr['knit']['grey'][$sql_row['po_break_down_id']][$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']][$sql_row['uom']];
						$finishreq_qty=$req_qty_arr['knit']['finish'][$sql_row['po_break_down_id']][$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']][$sql_row['uom']];
						$req_amt=$req_amount_arr['knit']['grey'][$sql_row['po_break_down_id']][$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']][$sql_row['uom']];
						//$rate=$req_amt/$req_qty;
					}
					if($cbo_fabric_natu==3)
					{
						$req_qty=$req_qty_arr['woven']['grey'][$sql_row['po_break_down_id']][$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']][$sql_row['uom']];
						$finishreq_qty=$req_qty_arr['woven']['finish'][$sql_row['po_break_down_id']][$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']][$sql_row['uom']];
						$req_amt=$req_amount_arr['woven']['grey'][$sql_row['po_break_down_id']][$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']][$sql_row['uom']];
						//$rate=$req_amt/$req_qty;
					}
					$cu_booking_qty=$cu_booking_data_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['cu_booking_qty'][$sql_row['po_break_down_id']];
					$booking_qty=$booking_data_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['booking_qty'][$sql_row['po_break_down_id']];
					$ac_booking_qty=$booking_data_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['ac_booking_qty'][$sql_row['po_break_down_id']];
					$adjust_qty=$booking_data_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['adjust_qty'][$sql_row['po_break_down_id']];
					$remark=$booking_data_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['remark'][$sql_row['po_break_down_id']];
					$hscode=$booking_data_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['hscode'][$sql_row['po_break_down_id']];
					if($remark=="") $remark=$pre_cost_remarks;
					$rate=$booking_data_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['rate'][$sql_row['po_break_down_id']];
					$amount=$booking_data_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['amount'][$sql_row['po_break_down_id']];
					$booking_id=$booking_data_arr[$bom_fabric_dtls_id][$sql_row['color_number_id']][$sql_row['dia_width']][$sql_row['remarks']]['booking_id'][$sql_row['po_break_down_id']];
					$rate=$amount/$ac_booking_qty;
					$bal_qty=$req_qty-$cu_booking_qty;
					$bal_amt=$bal_qty-$amount;
					$pre_cost_rate=$req_amt/$req_qty;
					
					$costing_per=0;
					if($sql_row["costing_per"]==1) $costing_per=12;
					else if($sql_row["costing_per"]==2) $costing_per=1;
					else if($sql_row["costing_per"]==3) $costing_per=24;
					else if($sql_row["costing_per"]==4) $costing_per=36;
					else if($sql_row["costing_per"]==5) $costing_per=48;
					else $costing_per=0;
					
					$itempoWiseReqQty=0;
						
					$itempoWiseReqQty=($powiseCostingPerReqQtyArr[$bom_fabric_dtls_id][$sql_row['po_break_down_id']]['greyreqqty']/($popaln_cut_qnty_array[$sql_row['po_break_down_id']]/$item_ratio_array[$sql_row['item_number_id']]))*$costing_per;
					
					if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
					?>
					<tr bgcolor="<?=$bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="search<?=$i; ?>">
                        <td width="80" style="word-break:break-all"><?=$job_no; ?><input type="hidden" id="txtjob_<?=$i;?>" value="<?=$job_no;?>" readonly /></td>
						<td width="80" style="word-break: break-all;word-wrap: break-word;"><?=$internal_ref_arr[$po_break_down_id]; ?>
                        	<input type="hidden" id="txtref_<? echo $i;?>" value="<? echo $po_break_down_id;?>"  readonly  />
                        </td>
                        <td width="70" style="word-break: break-all;word-wrap: break-word;"><?=$po_number_arr[$po_break_down_id]; ?>
                        	<input type="hidden" id="txtpoid_<? echo $i;?>" value="<? echo $po_break_down_id;?>"  readonly  />
                        </td>
                        <td width="100" style="word-break:break-all"><?=$body_part[$body_part_id]; ?>
                            <input type="hidden" id="txtpre_cost_fabric_cost_dtls_id_<? echo $i;?>" value="<? echo $bom_fabric_dtls_id;?>"  readonly  />
                            <input type="hidden" id="txtbodypart_<? echo $i;?>" value="<? echo $body_part_id;?>"  readonly  />
                        </td>
                        <td width="80" style="word-break:break-all"><?=$color_type[$color_type_id]; ?>
                        	<input type="hidden" id="txtcolortype_<? echo $i;?>" value="<? echo $color_type_id;?>"  readonly  />
                        </td>
                        <td width="80" style="word-break:break-all"><?=$fabric_typee[$width_dia_type]; ?>
                        	<input type="hidden" id="txtwidthtype_<? echo $i;?>" value="<? echo $width_dia_type;?>"  readonly  />
                        </td>
                        <td width="100" style="word-break:break-all"><?=$construction; ?>
                        	<input type="hidden" id="txtconstruction_<? echo $i;?>" value="<? echo $construction;?>"  readonly  />
                        </td>
                        <td width="150" style="word-break:break-all"><?=$compositi; ?>
                        	<input type="hidden" id="txtcompositi_<? echo $i;?>" value="<? echo $compositi;?>"  readonly  />
                        </td>
                        <td width="60" style="word-break:break-all"><?=$gsm_weight; ?>
                        	<input type="hidden" id="txtgsm_weight_<? echo $i;?>" value="<? echo $gsm_weight;?>"  readonly  />
                        </td>
                        <td width="90" style="word-break:break-all"><?=$color_library[$color_number_id]; ?>
                        	<input type="hidden" id="txtgmtcolor_<? echo $i;?>" value="<? echo $color_number_id;?>"  readonly  />
                        </td>
                        <td width="110" style="word-break:break-all"><?=$color_library[$item_color]; ?>
                        	<input type="hidden" id="txtitemcolor_<? echo $i;?>" value="<? echo $item_color;?>"  readonly  />
                        </td>
						<td width="90" style="word-break:break-all"><?=$itrm_ref; ?>
                        	<input type="hidden" id="txtitrmref_<? echo $i;?>" value="<? echo $itrm_ref;?>"  readonly  />
                        </td>
                        <td width="60" style="word-break:break-all"><?=$dia_width; ?>
                        	<input type="hidden" id="txtdia_<? echo $i;?>" value="<? echo $dia_width;?>"  readonly  />
                        </td>
                        <td width="80" style="word-break:break-all"><?=$pre_cost_remarks; ?>
                        	<input type="hidden" id="process_<? echo $i;?>" value="<? echo $pre_cost_remarks;?>"  readonly  />
                        </td>

                        <td width="80">
							<input type="text"  style="width:80%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px; text-align:right;" class="text_boxes" id="txthscode_<?=$i;?>" value="<?=$hscode;?>" />
                        </td>
                        <td width="80">
                            <input type="text" style="width:80%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px; text-align:right;" id="txtbalqnty_<?=$i;?>" value="<?=number_format($bal_qty,4,'.','');?>" class="text_boxes_numeric" readonly />
                            <input type="hidden" id="txtreqqnty_<?=$i;?>" value="<?=number_format($req_qty,4,'.','');?>" class="text_boxes_numeric" readonly />
                            <input type="hidden" id="txtfinreqqnty_<?=$i;?>" value="<?=number_format($finishreq_qty,4,'.','');?>" class="text_boxes_numeric" readonly />
                            <input type="hidden" id="cuqnty_<?=$i;?>" value="<?=number_format($cu_booking_qty,4,'.','');?>" class="text_boxes_numeric" readonly />
                            <input type="hidden" id="preconskg_<?=$i; ?>" style="width:20px;" value="<?=$itempoWiseReqQty; ?>"/>
                        </td>
                        <td width="80">
                            <input type="text" style="width:100%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px; text-align:right; background-color:#FFC" id="txtwoq_<?=$i;?>" value="<?=number_format($booking_qty,4,'.','');?>" class="text_boxes_numeric" onChange="claculate_acwoQty(<?=$i; ?>)"  />
                            <input type="hidden" style="width:90%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px; text-align:right; background-color:#FFC" id="txtwoqprev_<? echo $i;?>" value="<? echo number_format($booking_qty,4,'.','');?>" class="text_boxes_numeric" readonly />
                        </td>
                        <td width="70">
                        	<input type="text" style="width:90%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px; text-align:right; background-color:#FFC" id="txtadj_<?=$i;?>" value="<?=number_format($adjust_qty,4,'.','');?>" class="text_boxes_numeric" onChange="claculate_acwoQty(<?=$i; ?>)"  />
                        </td>
                        <td width="80"><input type="text" style="width:90%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px;  text-align:right; background-color:#FFC" id="txtacwoq_<?=$i;?>" value="<?=number_format($ac_booking_qty,4,'.','');?>" class="text_boxes_numeric" readonly />
                        </td>
                        <td width="50" align="center"><?=$unit_of_measurement[$sql_row['uom']]; ?></td>
                        <td width="60"><input type="text" style="width:70%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px; text-align:right; background-color:<?=$bgcolor; ?>" id="txtrate_<?=$i;?>" value="<?=number_format($rate,4,'.','');?>" class="text_boxes_numeric" onChange="claculate_amount(<?=$i; ?>)" data-pre-cost-rate="<?=number_format($pre_cost_rate,4,'.','');?>" data-current-rate="<?=number_format($rate,4,'.','');?>" /></td>
                        <td width="100">
                        	<input type="text" style="width:90%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px; text-align:right; background-color:<?=$bgcolor; ?>" id="txtamount_<?=$i;?>" value="<?=number_format($amount,4,'.','');?>" class="text_boxes_numeric" readonly />
                        </td>
                        <td>
                            <input type="text"  style="width:100%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px;   background-color:<? echo $bgcolor; ?>" id="txtremark_<? echo $i;?>" value="<? echo $remark;?>"    />
                            <input type="hidden"   id="bookingid_<? echo $i;?>" value="<? echo $booking_id;?>"  readonly  />
                        </td>
					</tr>
					<?
					$i++;
				}
            }
            if(str_replace("'","",$cbo_level)==2){
				$i=1;
				foreach($job_level_arr as $precost_id)
				{
					foreach($precost_id as $color_id)
					{
						foreach($color_id as $diawith)
						{
							foreach($diawith as $remarks)
							{
								$job_no=implode(",",array_unique($remarks['job_no']));
								$po_break_down_id=implode(",",array_unique($remarks['po_id']));
								$po_number=implode(",",array_unique($remarks['po_number']));
								$internal_ref=implode(",",array_unique($remarks['internal_ref']));
								$bom_fabric_dtls_id=implode(",",array_unique($remarks['pre_cost_fabric_cost_dtls_id']));
								$body_part_id=implode(",",array_unique($remarks['body_part_id']));
								$construction=implode(",",array_unique($remarks['construction']));
								$compositi=implode(",",array_unique($remarks['composition']));
								$gsm_weight=implode(",",array_unique($remarks['gsm_weight']));
								$color_type_id=implode(",",array_unique($remarks['color_type_id']));
								$width_dia_type=implode(",",array_unique($remarks['width_dia_type']));
								$color_number_id=implode(",",array_unique($remarks['color_number_id']));
								$item_color=implode(",",array_unique($remarks['item_color']));
								$itrm_ref=implode(",",array_unique($remarks['itrm_ref']));
								$dia_width=implode(",",array_unique($remarks['dia_width']));
								$pre_cost_remarks=implode(",",array_unique($remarks['pre_cost_remarks']));
								$hscode=implode(",",array_unique($remarks['hscode']));
								
								$booking_id=implode(",",array_unique($remarks['booking_id']));
								$req_qty=array_sum($remarks['req_qty']);
								$finishreq_qty=array_sum($remarks['finreq_qty']);
								$req_amt=array_sum($remarks['req_amt']);
								$bal_qty=array_sum($remarks['bal_qty']);
								//$bal_amt=array_sum($color_id['bal_amt']);
								$booking_qty=array_sum($remarks['booking_qty']);
								$ac_booking_qty=array_sum($remarks['ac_booking_qty']);
								$adjust_qty=array_sum($remarks['adjust_qty']);
								$remark=implode(",",array_unique($remarks['remark']));
								
								$rate=array_sum($remarks['rate']);
								$amount=array_sum($remarks['amount']);
								$rate=$amount/$ac_booking_qty;
								
								$pre_cost_rate=$req_amt/$req_qty;
								$cu_booking_qty=array_sum($cu_booking_data_arr[$bom_fabric_dtls_id][$color_number_id][$dia_width][$pre_cost_remarks]['cu_booking_qty']);
								if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
								?>
								<tr bgcolor="<?=$bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="search<?=$i;?>">
                                    <td width="80" style="word-break:break-all"><?=$job_no; ?><input type="hidden" id="txtjob_<?=$i;?>" value="<?=$job_no;?>" readonly /></td>
									<td width="80" style="word-break:break-all"><?=$internal_ref; ?><input type="hidden" id="txtref_<?=$i;?>" value="<?=$internal_ref;?>" readonly /></td>
                                    <td width="70" style="word-break: break-all;word-wrap: break-word;">
                                        <A href="#" onClick="setdata('<?=$po_number;?>' )">View</A>
                                        <input type="hidden" id="txtpoid_<?=$i;?>" value="<?=$po_break_down_id;?>" readonly />
                                    </td>
                                    <td width="100" style="word-break:break-all"><?=$body_part[$body_part_id]; ?>
                                        <input type="hidden" id="txtpre_cost_fabric_cost_dtls_id_<?=$i;?>" value="<?=$bom_fabric_dtls_id;?>" readonly />
                                        <input type="hidden" id="txtbodypart_<?=$i;?>" value="<?=$body_part_id;?>" readonly />
                                    </td>
                                    <td width="80" style="word-break:break-all"><?=$color_type[$color_type_id]; ?>
                                        <input type="hidden" id="txtcolortype_<?=$i;?>" value="<?=$color_type_id;?>" readonly />
                                    </td>
                                    <td width="80" style="word-break:break-all"><?=$fabric_typee[$width_dia_type]; ?>
                                        <input type="hidden" id="txtwidthtype_<?=$i;?>" value="<?=$width_dia_type;?>"  readonly  />
                                    </td>
                                    <td width="100" style="word-break:break-all"><?=$construction; ?>
                                        <input type="hidden" id="txtconstruction_<?=$i;?>" value="<?=$construction;?>"  readonly  />
                                    </td>
                                    <td width="150" style="word-break:break-all"><?=$compositi; ?>
                                        <input type="hidden" id="txtcompositi_<?=$i;?>" value="<?=$compositi;?>"  readonly  />
                                    </td>
                                    <td width="60" style="word-break:break-all"><?=$gsm_weight; ?>
                                        <input type="hidden" id="txtgsm_weight_<?=$i;?>" value="<?=$gsm_weight;?>"  readonly  />
                                    </td>
                                    <td width="90" style="word-break:break-all"><?=$color_library[$color_number_id]; ?>
                                        <input type="hidden" id="txtgmtcolor_<?=$i;?>" value="<?=$color_number_id;?>"  readonly  />
                                    </td>
                                    <td width="110" style="word-break:break-all"><?=$color_library[$item_color]; ?>
                                        <input type="hidden" id="txtitemcolor_<?=$i;?>" value="<?=$item_color;?>"  readonly  />
                                    </td>
									<td width="90" style="word-break:break-all"><?=$itrm_ref; ?>
                                        <input type="hidden" id="txtitrmref_<?=$i;?>" value="<?=$itrm_ref;?>"  readonly  />
                                    </td>
                                    <td width="60" style="word-break:break-all"><?=$dia_width; ?>
                                        <input type="hidden" id="txtdia_<?=$i;?>" value="<?=$dia_width;?>"  readonly  />
                                    </td>
                                    <td width="80" style="word-break:break-all"><?=$pre_cost_remarks; ?>
                                        <input type="hidden" id="process_<?=$i;?>" value="<?=$pre_cost_remarks;?>"  readonly  />
                                    </td>
                                    <td width="80">
										<input type="text"  style="width:80%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px; text-align:right; background-color:<?=$bgcolor; ?>" id="txthscode_<?=$i;?>" value="<?=$hscode;?>" />
			                        </td>
                                    <td width="80">
                                        <input type="text" style="width:80%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px; text-align:right; background-color:<?=$bgcolor; ?>" id="txtbalqnty_<?=$i;?>" value="<?=number_format($bal_qty,4,'.','');?>" class="text_boxes_numeric" readonly />
                                        <input type="hidden" id="txtreqqnty_<?=$i;?>" value="<?=number_format($req_qty,4,'.','');?>" class="text_boxes_numeric" readonly />
                                        <input type="hidden" id="txtfinreqqnty_<?=$i;?>" value="<?=number_format($finishreq_qty,4,'.','');?>" class="text_boxes_numeric" readonly />
                                        <input type="hidden" id="cuqnty_<?=$i;?>" value="<?=number_format($cu_booking_qty,4,'.',''); ?>" class="text_boxes_numeric" readonly />
                                        <input type="hidden" id="preconskg_<?=$i; ?>" style="width:20px;" value=""/>
                                    </td>
                                    <td width="80">
                                        <input type="text" style="width:90%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px; text-align:right; background-color:#FFC" id="txtwoq_<?=$i;?>" value="<?=number_format($booking_qty,4,'.','');?>" class="text_boxes_numeric" onChange="claculate_acwoQty(<?=$i; ?>)" />
                                        <input type="hidden" style="width:100%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px;  text-align:right; background-color:#FFC" id="txtwoqprev_<?=$i;?>" value="<?=number_format($booking_qty,4,'.','');?>" class="text_boxes_numeric" readonly />
                                     </td>
                                    <td width="70">
                                        <input type="text" style="width:90%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px;  text-align:right; background-color:#FFC" id="txtadj_<?=$i;?>" value="<?=number_format($adjust_qty,4,'.','');?>" class="text_boxes_numeric" onChange="claculate_acwoQty(<?=$i; ?>)" />
                                    </td>
                                    <td width="80">
                                        <input type="text"  style="width:90%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px;  =text-align:right; background-color:#FFC" id="txtacwoq_<?=$i;?>" value="<?=number_format($ac_booking_qty,4,'.','');?>" class="text_boxes_numeric" readonly   />
                                    </td>
                                    </td>
                                    <td width="50" align="center"><?=$unit_of_measurement[$sql_row['uom']]; ?></td>
                                    <td width="60"><input type="text" style="width:80%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px;  text-align:right; background-color:<?=$bgcolor; ?>" id="txtrate_<?=$i;?>" value="<?=number_format($rate,4,'.','');?>" class="text_boxes_numeric" onChange="claculate_amount(<?=$i; ?>)" data-pre-cost-rate="<?=number_format($pre_cost_rate,4,'.','');?>" data-current-rate="<?=number_format($rate,4,'.','');?>" /></td>
                                    <td width="100">
                                        <input type="text" style="width:90%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px; text-align:right; background-color:<?=$bgcolor; ?>" id="txtamount_<?=$i;?>" value="<?=number_format($amount,4,'.','');?>" class="text_boxes_numeric" readonly  />
                                    </td>
                                    <td>
                                        <input type="text" style="width:100%;height:100%; font-family:Verdana, Geneva, sans-serif; font-size:11px; background-color:<?=$bgcolor; ?>" id="txtremark_<?=$i;?>" value="<?=$remark;?>" />
                                        <input type="hidden" id="bookingid_<?=$i;?>" value="<?=$booking_id;?>" readonly />
                                    </td>
								</tr>
								<?
								$i++;
							}
						}
					}
				}
            }
            ?>
            </tbody>
        </table>
        <input type='hidden' id='json_data' name="json_data" value='<?=json_encode($job_level_arr); ?>'/>
        <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</div>
	<?
	exit();
}

if($action=="show_fabric_booking_list")
{
	extract($_REQUEST);
	$txt_order_no_id=str_replace("'","",$txt_order_no_id);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$pre_cost_fabric_cost_dtls_id=str_replace("'","",$cbo_fabric_description);
	$cbouom=str_replace("'","",$cbouom);
	$cbo_level=str_replace("'","",$cbo_level);
	
	$color_library=return_library_array( "select id,color_name from lib_color", "id", "color_name");
	
	$companyId=return_field_value("company_id", "wo_booking_mst", "booking_no=".$txt_booking_no." and status_active=1 and is_deleted=0");
	//echo "select company_id from wo_booking_mst where booking_no=".$txt_booking_no." and status_active=1 and is_deleted=0";
	
	$variable_textile_sales_maintain = sql_select("select production_entry from variable_settings_production where company_name='$companyId' and variable_list=66 and status_active=1");
	//echo "select production_entry from variable_settings_production where company_name='$companyId' and variable_list=66 and status_active=1";

	if($variable_textile_sales_maintain[0][csf('production_entry')] ==2) $textile_sales_maintain = 1; else $textile_sales_maintain = 0;
	
	$job_level_arr=array(); $fabric_description_array=array(); $color_Arr=array(); $Dia_Arr=array();
	$sql='select a.id AS "id",a.job_no AS "job_no", a.po_break_down_id AS "po_break_down_id",a.grey_fab_qnty AS "grey_fab_qnty",a.fin_fab_qnty AS "fin_fab_qnty",a.adjust_qty "adjust_qty",a.rate AS "rate",a.amount AS "amount",a.gmts_color_id AS "gmts_color_id",a.dia_width AS "dia_width", b.id AS "pre_cost_fabric_cost_dtls_id", b.body_part_id AS "body_part_id",b.color_type_id AS "color_type_id",b.fabric_description AS "fabric_description", b.gsm_weight AS "gsm_weight",b.uom AS "uom" from wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b  where a.pre_cost_fabric_cost_dtls_id=b.id and a.status_active =1 and a.is_deleted=0  and a.booking_no='.$txt_booking_no.'';
	
	$dataArray=sql_select($sql); $poidArr=array();
	foreach($dataArray as $sql_row){
		$poidArr[$sql_row['po_break_down_id']]=$sql_row['po_break_down_id'];
	}
	
	$po_number_arr=return_library_array( "select id,po_number from wo_po_break_down where id in (".implode(",",$poidArr).")", "id", "po_number");
	$internal_ref_arr=return_library_array( "select id,grouping from wo_po_break_down where id in (".implode(",",$poidArr).")", "id", "grouping");
	
	foreach($dataArray as $sql_row){
		$job_level_arr[$sql_row['pre_cost_fabric_cost_dtls_id']]['job_no'][$sql_row['id']]=$sql_row['job_no'];
		$job_level_arr[$sql_row['pre_cost_fabric_cost_dtls_id']]['po_id'][$sql_row['id']]=$sql_row['po_break_down_id'];
		$job_level_arr[$sql_row['pre_cost_fabric_cost_dtls_id']]['po_number'][$sql_row['id']]=$po_number_arr[$sql_row['po_break_down_id']];
		$job_level_arr[$sql_row['pre_cost_fabric_cost_dtls_id']]['internal_ref'][$sql_row['id']]=$internal_ref_arr[$sql_row['po_break_down_id']];
		$job_level_arr[$sql_row['pre_cost_fabric_cost_dtls_id']]['booking_id'][$sql_row['id']]=$sql_row['id'];
		$job_level_arr[$sql_row['pre_cost_fabric_cost_dtls_id']]['grey_fab_qnty'][$sql_row['id']]+=$sql_row['grey_fab_qnty'];
		
		if($textile_sales_maintain==1)
		{
			$job_level_arr[$sql_row['pre_cost_fabric_cost_dtls_id']]['fin_fab_qnty'][$sql_row['id']]+=$sql_row['grey_fab_qnty']-$sql_row['adjust_qty'];
		}
		else
		{
			$job_level_arr[$sql_row['pre_cost_fabric_cost_dtls_id']]['fin_fab_qnty'][$sql_row['id']]+=$sql_row['fin_fab_qnty']-$sql_row['adjust_qty'];
		}
		$job_level_arr[$sql_row['pre_cost_fabric_cost_dtls_id']]['adjust_qty'][$sql_row['id']]+=$sql_row['adjust_qty'];
		$job_level_arr[$sql_row['pre_cost_fabric_cost_dtls_id']]['amount'][$sql_row['id']]+=$sql_row['amount'];
	
		//$job_level_arr[$sql_row['pre_cost_fabric_cost_dtls_id']]['amount'][$sql_row['id']]+=$sql_row['amount'];
	
		$fabric_description_array[$sql_row['pre_cost_fabric_cost_dtls_id']]=$body_part[$sql_row['body_part_id']].', '.$color_type[$sql_row['color_type_id']].', '.$sql_row['fabric_description'].', '.$sql_row['gsm_weight'].', '.$unit_of_measurement[$sql_row['uom']];
		$color_Arr[$sql_row['pre_cost_fabric_cost_dtls_id']][$sql_row['gmts_color_id']]=$color_library[$sql_row['gmts_color_id']];
		$Dia_Arr[$sql_row['pre_cost_fabric_cost_dtls_id']][$sql_row['dia_width']]=$sql_row['dia_width'];
	}
	?>
	<table width="1280" class="rpt_table" border="0" rules="all">
        <thead>
            <th width="50"></th>
            <th width="80">Job No</th>
			<th width="80">Internal Ref</th>
            <th width="80">Po Number</th>
            <th width="250">Fab. Description</th>
            <th width="130">Gmts Color</th>
            <th width="70">Dia</th>
            <th width="100">WO. Qty.</th>
            <th width="100">Adj. Qty.</th>
            <th width="100">Ac. Wo. Qty.</th>
            <th width="60">Rate</th>
            <th width="80">Amount</th>
            <th><input type="checkbox" name="chkdeleteall" id="chkdeleteall" value="2" ><A href="#" onClick="deletedata();">Delete All</A></th>
        </thead>
	</table>
	<div style="max-height:200px; overflow-y:scroll; width:1280px"  align="left">
        <table width="1263" class="rpt_table" id="tbl_fabric_booking_list" border="0" rules="all">
            <tbody>
            <? $i=1;
            if($cbo_level==11){
                foreach($dataArray as $row){
                    $job_no=$row['job_no'];
                    $po_break_down_id=$row['po_break_down_id'];
                    $po_number=$po_number_arr[$row['po_break_down_id']];
					$internal_ref=$internal_ref_arr[$row['po_break_down_id']];
                    $fabric_des=$fabric_description_array[$row['pre_cost_fabric_cost_dtls_id']];
                    $GmtColor=$color_Arr[$row['pre_cost_fabric_cost_dtls_id']];
                    $booking_id=$row['id'];
                    $grey_fab_qnty=$row['grey_fab_qnty'];
                    $adjust_qty=$row['adjust_qty'];
                    $fin_fab_qnty=$row['fin_fab_qnty'];
                    $amount=$row['amount'];
                    $rate=$amount/$fin_fab_qnty;
                    ?>
                    <tr>
                        <td width="50">
                            <A href="#" onClick="set_data('<?=$po_break_down_id; ?>','<?=$po_number; ?>','<?=$row['pre_cost_fabric_cost_dtls_id']; ?>','<?=$booking_id; ?>');">Edit</A>
                        </td>
                        <td width="80"><?=$job_no; ?></td>
						<td width="80"><?=$internal_ref; ?></td>
                        <td width="80" style="word-break: break-all;word-wrap: break-word;"><A href="#" onClick="setdata('<?=$po_number; ?>');">View</A><? //echo $po_number; ?></td>
                        <td width="250"><?=$fabric_des; ?></td>
                        <td width="100" align="right"><?=number_format($grey_fab_qnty,4,'.',''); ?></td>
                        <td width="100" align="right"><?=number_format($grey_fab_qnty,4,'.',''); ?></td>
                        <td width="100" align="right"><?=number_format($adjust_qty,4,'.',''); ?></td>
                        <td width="100" align="right"><?=number_format($fin_fab_qnty,4,'.',''); ?></td>
                        <td width="60" align="right"><?=number_format($rate,4,'.','');?></td>
                        <td width="80" align="right"><?=number_format($amount,4,'.','');?></td>
                        <td>
                        <A href="#" onClick="deletedata('<?=$po_break_down_id; ?>','<?=$po_number; ?>','<?=$row['pre_cost_fabric_cost_dtls_id']; ?>','<?=$booking_id; ?>');">Delete</A>
                        </td>
                    </tr>
                    <?
                }
            }
            if($cbo_level==2 || $cbo_level==1){
                $i=1;
                foreach($job_level_arr as $key=>$precost_id){
                    $job_no=implode(",",array_unique($precost_id['job_no']));
                    $po_break_down_id=implode(",",array_unique($precost_id['po_id']));
                    $po_number=implode(",",array_unique($precost_id['po_number']));
					$internal_ref=implode(",",array_unique($precost_id['internal_ref']));
                    $grey_fab_qnty=array_sum($precost_id['grey_fab_qnty']);
                    $adjust_qty=array_sum($precost_id['adjust_qty']);
                    $fin_fab_qnty=array_sum($precost_id['fin_fab_qnty']);
                    $booking_id=implode(",",array_unique($precost_id['booking_id']));
                    //$rate=array_sum($precost_id['rate']);
                    $amount=array_sum($precost_id['amount']);
                    $rate=$amount/$fin_fab_qnty;
                    ?>
                    <tr bgcolor="<?=$bgcolor; ?>" style="text-decoration:none; cursor:pointer" id="search<?=$i; ?>" >
                        <td width="50" align="center"><A href="#" onClick="set_data('<?=$po_break_down_id; ?>','<?=$po_number; ?>','<?=$key; ?>','<?=$booking_id; ?>');">Edit</A></td>
                        <td width="80"><?=$job_no; ?></td>
						<td width="80" align="center"><?=$internal_ref; ?></td>
                        <td width="80" style="word-break: break-all;word-wrap: break-word;" align="center"><A href="#" onClick="setdata('<?=$po_number; ?>' )">View</A></td>
                        <td width="250" style="word-break: break-all;word-wrap: break-word"><?=$fabric_description_array[$key]; ?></td>
                        <td width="130" style="word-break: break-all;word-wrap: break-word"><?=implode(",",$color_Arr[$key]); ?></td>
                        <td width="70" style="word-break: break-all;word-wrap: break-word" align="center"><?=implode(",",$Dia_Arr[$key]); ?></td>
                        <td width="100" align="right"><?=number_format($grey_fab_qnty,4,'.','');?></td>
                        <td width="100" align="right"><?=number_format($adjust_qty,4,'.','');?></td>
                        <td width="100" align="right"><?=number_format($fin_fab_qnty,4,'.',''); ?></td>
                        <td width="60" align="right"><?=number_format($rate,4,'.',''); ?></td>
                        <td width="80" align="right"><?=number_format($amount,4,'.','');?></td>
                        <td align="center">
                       		<input type="checkbox" name="chkdelete_<?=$i; ?>" id="chkdelete_<?=$i; ?>" value="2" ><input type="hidden" id="txtdelete<?=$i; ?>" name="txtdelete<?=$i; ?>" value="<?=$booking_id?>"/> 
                        </td>
                    </tr>
                    <?
					$i++;
                }
            }
            ?>
            </tbody>
        </table>
	</div>
	<?
	exit();
}

if ($action=="save_update_delete")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if ($operation==0){
		$con = connect();
		if($db_type==0){
			mysql_query("BEGIN");
		}
		
		if($db_type==0) $date_cond=" YEAR(insert_date)";
		else if($db_type==2) $date_cond="to_char(insert_date,'YYYY')";
		
		$new_booking_no=explode("*",return_mrr_number( str_replace("'","",$cbo_company_name), '', 'Fb', date("Y",time()), 5, "select booking_no_prefix, booking_no_prefix_num from wo_booking_mst where company_id=$cbo_company_name and booking_type=1 and $date_cond=".date('Y',time())." order by id desc ", "booking_no_prefix", "booking_no_prefix_num" ));
		
		$id=return_next_id( "id", "wo_booking_mst", 1); // cbo_fabric_natu
		$field_array="id, booking_type, is_short, booking_no_prefix, booking_no_prefix_num, booking_no, company_id, buyer_id, item_category, fabric_source, currency_id, exchange_rate, pay_mode, source, booking_date, delivery_date,fabric_start_date, booking_month, booking_year, supplier_id, attention, booking_percent, colar_excess_percent, cuff_excess_percent, ready_to_approved, inserted_by, insert_date, rmg_process_breakdown, fabric_composition, uom, remarks, entry_form, cbo_level, brand_id, isgreyfab_purchase, ship_mode, pay_term, tenor, shippingmark_breck_down";
		 $data_array ="(".$id.",1,2,'".$new_booking_no[1]."',".$new_booking_no[2].",'".$new_booking_no[0]."',".$cbo_company_name.",".$cbo_buyer_name.",".$cbo_fabric_natu.",".$cbo_fabric_source.",".$cbo_currency.",".$txt_exchange_rate.",".$cbo_pay_mode.",".$cbo_source.",".$txt_booking_date.",".$txt_delivery_date.",".$txt_fabric_start_date.",".$cbo_booking_month.",".$cbo_booking_year.",".$cbo_supplier_name.",".$txt_attention.",".$txt_booking_percent.",".$txt_colar_excess_percent.",".$txt_cuff_excess_percent.",".$cbo_ready_to_approved.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',".$processloss_breck_down.",".$txt_fabriccomposition.",".$cbouom.",".$txt_remark.",108,".$cbo_level.",".$cbo_brand_id.",".$cbo_greyfab_purch.",".$cbo_shipmode.",".$cbo_payterm.",".$txt_tenor.",".$hiddshippingmark_breck_down.")";
		$rID=sql_insert("wo_booking_mst",$field_array,$data_array,0);
		if($db_type==0){
			if($rID){
				mysql_query("COMMIT");
				echo "0**".$new_booking_no[0]."**".$id;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**";
			}
		}
		else if($db_type==2 || $db_type==1 ){
			if($rID){
				oci_commit($con);
				echo "0**".$new_booking_no[0]."**".$id;
			}
			else{
				oci_rollback($con);
				echo "10**";
			}
		}
		disconnect($con);
		die;
	}
	else if ($operation==1){
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		$is_approved=0;
		$sql=sql_select("select is_approved from wo_booking_mst where booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
		foreach($sql as $row){
			if($row[csf('is_approved')]==3) $is_approved=1; else $is_approved=$row[csf('is_approved')];
		}
		if($is_approved==1){
			echo "approved**".str_replace("'","",$txt_booking_no);
			disconnect($con);die;
		}

		$pi_number=return_field_value( "pi_number", "com_pi_master_details a,com_pi_item_details b"," a.id=b.pi_id and b.work_order_no=$txt_booking_no and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0");
		if($pi_number){
			echo "pi1**".str_replace("'","",$txt_booking_no)."**".$pi_number;
			disconnect($con);die;
		}

		$receive_mrr=0;
		$sqlre=sql_select("select recv_number from inv_receive_master where booking_no=$txt_booking_no  and status_active=1 and is_deleted=0");
		foreach($sqlre as $rows){
			$receive_mrr=$rows[csf('recv_number')];
		}
		if($receive_mrr){
			echo "rec1**".str_replace("'","",$txt_booking_no)."**".$receive_mrr;
			disconnect($con);die;
		}

		$issue_mrr=0;
		$sqlis=sql_select("select issue_number from inv_issue_master where booking_no=$txt_booking_no  and status_active=1 and is_deleted=0");
		foreach($sqlis as $rows){
			$issue_mrr=$rows[csf('issue_number')];
		}
		if($issue_mrr){
			echo "iss1**".str_replace("'","",$txt_booking_no)."**".$issue_mrr;
			disconnect($con);die;
		}

		$field_array="item_category*fabric_source*currency_id*exchange_rate*pay_mode*source*booking_date*delivery_date*fabric_start_date*booking_month*booking_year*supplier_id*attention*booking_percent*colar_excess_percent*cuff_excess_percent*ready_to_approved*updated_by*update_date*rmg_process_breakdown*fabric_composition*uom*remarks*cbo_level*brand_id*isgreyfab_purchase*ship_mode*pay_term*tenor*shippingmark_breck_down";
		 $data_array ="".$cbo_fabric_natu."*".$cbo_fabric_source."*".$cbo_currency."*".$txt_exchange_rate."*".$cbo_pay_mode."*".$cbo_source."*".$txt_booking_date."*".$txt_delivery_date."*".$txt_fabric_start_date."*".$cbo_booking_month."*".$cbo_booking_year."*".$cbo_supplier_name."*".$txt_attention."*".$txt_booking_percent."*".$txt_colar_excess_percent."*".$txt_cuff_excess_percent."*".$cbo_ready_to_approved."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*".$processloss_breck_down."*".$txt_fabriccomposition."*".$cbouom."*".$txt_remark."*".$cbo_level."*".$cbo_brand_id."*".$cbo_greyfab_purch."*".$cbo_shipmode."*".$cbo_payterm."*".$txt_tenor."*".$hiddshippingmark_breck_down."";
		$rID=sql_update("wo_booking_mst",$field_array,$data_array,"id","".$update_id."",0);

		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "1**".str_replace("'","",$txt_booking_no)."**".str_replace("'","",$update_id);
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".str_replace("'","",$txt_booking_no);
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "1**".str_replace("'","",$txt_booking_no)."**".str_replace("'","",$update_id);
			}
			else{
				oci_roolback($con);
				echo "10**".str_replace("'","",$txt_booking_no);
			}
		}
		disconnect($con);
		die;
	}
	else if ($operation==2)   // Delete Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		$is_approved=0;
		$sql=sql_select("select is_approved from wo_booking_mst where booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
		foreach($sql as $row){
			if($row[csf('is_approved')]==3) $is_approved=1; else $is_approved=$row[csf('is_approved')];
		}
		if($is_approved==1){
			echo "approved**".str_replace("'","",$txt_booking_no);
			disconnect($con);die;
		}

		$pi_number=return_field_value( "pi_number", "com_pi_master_details a,com_pi_item_details b"," a.id=b.pi_id and b.work_order_no=$txt_booking_no and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0");
		if($pi_number){
			echo "pi1**".str_replace("'","",$txt_booking_no)."**".$pi_number;
			disconnect($con);die;
		}

		$pplbook=0;
		$ppl=sql_select("select b.id from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and a.booking_no=$txt_booking_no and a.is_sales!=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.id");
		foreach($ppl as $pplrow){
			$pplbook=$pplrow[csf('id')];
		}

		if($pplbook!=0){
			echo "PPL**".str_replace("'","",$txt_booking_no)."**".$pplbook;
			disconnect($con);die;
		}

		$sales_order=0;
		$sqls=sql_select("select job_no from fabric_sales_order_mst where sales_booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
		foreach($sqls as $rows){
			$sales_order=$rows[csf('job_no')];
		}
		if($sales_order){
			echo "sal1**".str_replace("'","",$txt_booking_no)."**".$sales_order;
			disconnect($con);die;
		}

		$receive_mrr=0;
		$sqlre=sql_select("select recv_number from inv_receive_master where booking_no=$txt_booking_no  and status_active=1 and is_deleted=0");
		foreach($sqlre as $rows){
			$receive_mrr=$rows[csf('recv_number')];
		}
		if($receive_mrr){
			echo "rec1**".str_replace("'","",$txt_booking_no)."**".$receive_mrr;
			disconnect($con);die;
		}

		$issue_mrr=0;
		$sqlis=sql_select("select issue_number from inv_issue_master where booking_no=$txt_booking_no  and status_active=1 and is_deleted=0");
		foreach($sqlis as $rows){
			$issue_mrr=$rows[csf('issue_number')];
		}
		if($issue_mrr){
			echo "iss1**".str_replace("'","",$txt_booking_no)."**".$issue_mrr;
			disconnect($con);die;
		}
		$delete_cause=str_replace("'","",$delete_cause);
		$delete_cause=str_replace('"','',$delete_cause);
		$delete_cause=str_replace('(','',$delete_cause);
		$delete_cause=str_replace(')','',$delete_cause);

		/*$field_array="updated_by*update_date*status_active*is_deleted";
		$data_array="".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*'2'*'1'";
		$rID=sql_delete("wo_booking_mst",$field_array,$data_array,"id","".$update_id."",1);*/
		//$rID=execute_query( "delete from wo_booking_mst where  booking_no =".$txt_booking_no."",0);
		//$rID1=execute_query( "delete from wo_booking_dtls where  booking_no =".$txt_booking_no."",0);
		$rID=execute_query( "update wo_booking_mst set status_active=0,is_deleted=1,delete_cause='$delete_cause',updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."'   where  booking_no=$txt_booking_no",0);
		$rID1=execute_query( "update wo_booking_dtls set status_active=0,is_deleted=1,delete_cause='$delete_cause',updated_by=".$_SESSION['logic_erp']['user_id'].", update_date='".$pc_date_time."'   where  booking_no=$txt_booking_no",0);

		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "2**".str_replace("'","",$txt_booking_no);
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".str_replace("'","",$txt_booking_no);
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "2**".str_replace("'","",$txt_booking_no);
			}
			else{
				oci_rollback($con);
				echo "10**".str_replace("'","",$txt_booking_no);
			}
		}
		disconnect($con);
		die;
	}
}

if($action=="save_update_delete_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	//$json_data=json_decode(str_replace("'","",$json_data));
	$variable_textile_sales_maintain = sql_select("select production_entry from variable_settings_production where company_name=$cbo_company_name and variable_list=66 and status_active=1");

	if($variable_textile_sales_maintain[0][csf('production_entry')] ==2) $textile_sales_maintain = 1; else $textile_sales_maintain = 0;
	$jobnoArr=array();
	for ($i=1; $i<=$total_row; $i++)
	{
		$txtjob="txtjob_".$i;
		$txtpoid_="txtpoid_".$i;
		
		$jobnoArr[]="'".str_replace("'","",$$txtjob)."'";
	}
	
	$sqljob=sql_select("select id from wo_po_details_master where job_no in (".implode(",",$jobnoArr).") and status_active=1 and is_deleted=0");
	foreach($sqljob as $row)
	{
		$jobidArr[$row[csf('id')]]=$row[csf('id')];
	}
	
	if ($operation==0){
		$con = connect();
		if($db_type==0){
			mysql_query("BEGIN");
		}

		$is_approved=0;
		$sql=sql_select("select is_approved from wo_booking_mst where booking_no=$txt_booking_no");
		foreach($sql as $row){
			if($row[csf('is_approved')]==3) $is_approved=1; else $is_approved=$row[csf('is_approved')];
		}
		if($is_approved==1){
			echo "approved**".str_replace("'","",$txt_booking_no);
			disconnect($con);die;
		}

		if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0"; disconnect($con); die; }
		 $id_dtls=return_next_id( "id", "wo_booking_dtls", 1 ) ;
		 $field_array1="id, is_short, booking_mst_id, pre_cost_fabric_cost_dtls_id, po_break_down_id, job_no, booking_no, booking_type, color_type, construction, copmposition, gsm_weight, dia_width, fabric_color_id, gmts_color_id, fin_fab_qnty, grey_fab_qnty, adjust_qty, rate, amount, process_loss_percent, remark, pre_cost_remarks, hs_code, precons, inserted_by, insert_date, status_active, is_deleted";
		 $j=1;
		 $new_array_color=array(); $poIdChkArr=array();
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $txtjob="txtjob_".$i;
			 $txtpoid_="txtpoid_".$i;
			//=========
			$txtpre_cost_fabric_cost_dtls_id="txtpre_cost_fabric_cost_dtls_id_".$i;
			$txtcolortype_="txtcolortype_".$i;
			$txtconstruction_="txtconstruction_".$i;
			$txtcompositi_="txtcompositi_".$i;
			$txtgsm_weight_="txtgsm_weight_".$i;
			$txtdia_="txtdia_".$i;
			//============

			 $txtgmtcolor="txtgmtcolor_".$i;
			 $txtitemcolor="txtitemcolor_".$i;
			 $txtbalqnty="txtbalqnty_".$i;
			 $txtreqqnty="txtreqqnty_".$i;
			 $txtfinreqqnty="txtfinreqqnty_".$i;
			 $txtwoq="txtwoq_".$i;
			 $txtadj="txtadj_".$i;
			 $txtrate="txtrate_".$i;
			 $txtamount="txtamount_".$i;
			 $txtremark="txtremark_".$i;
			 $txtacwoq="txtacwoq_".$i;
			 $process="process_".$i;
			 $hscode="hscode_".$i;
			 $preconskg="preconskg_".$i;

			 $precostid=str_replace("'","",$$txtpre_cost_fabric_cost_dtls_id);
			 $colorid=str_replace("'","",$$txtgmtcolor);
             $reqqnty=str_replace("'","",$$txtreqqnty);
			 $finreqqnty=str_replace("'","",$$txtfinreqqnty);
			 $woq=str_replace("'","",$$txtwoq);
			 $acwoq=str_replace("'","",$$txtacwoq);
			 $rate=str_replace("'","",$$txtrate);
			 $amount=str_replace("'","",$$txtamount);
			 $poId=str_replace("'","",$$txtpoid_);
			 
			 $poIdChkArr[$poId]=$poId;
			 
			 $processLossPer=0;
			 $processLossPer=(($reqqnty-$finreqqnty)/$finreqqnty)*100;
			 
			 $avgFinKg=$finreqqnty/$reqqnty;
			 
			 $finAcWoQty=$acwoq*$avgFinKg;
			$finWoQty=$greyWoQty=$pLossPer=0;
			if($textile_sales_maintain==1)
			{
				$finWoQty=$finAcWoQty;
				$greyWoQty=$woq;
				$pLossPer=number_format($processLossPer,2,'.','');
			}
			else
			{
				$finWoQty=$acwoq;
				$greyWoQty=$woq;
				$pLossPer=number_format($processLossPer,2,'.','');
			}
			 
			 //foreach($json_data->$precostid->$colorid->po_id as $poId){
				 if($woq>0){
				 if ($j!=1) $data_array1 .=",";
					 $data_array1 .="(".$id_dtls.",2,".$update_id.",".$precostid.",".$$txtpoid_.",".$$txtjob.",".$txt_booking_no.",1,".$$txtcolortype_.",".$$txtconstruction_.",".$$txtcompositi_.",".$$txtgsm_weight_.",".$$txtdia_.",".$$txtitemcolor.",".$$txtgmtcolor.",".$finWoQty.",".$greyWoQty.",".$$txtadj.",".$rate.",".$amount.",".$pLossPer.",".$$txtremark.",".$$process.",".$$hscode.",".$$preconskg.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
					 if($str_po_id=="") $str_po_id=$poId; else $str_po_id.='*'.$poId;
					 $id_dtls=$id_dtls+1;
					 $j++;
				 }
			 //}
		 }
		 //echo $data_array1;
		 $poidCond=implode(",",$poIdChkArr);
		 $sql_pre=sql_select("select a.update_by_fabrice from wo_pre_cost_mst a,wo_po_break_down b where a.job_id=b.job_id and  b.id in($poidCond) and a.update_by_fabrice>0 and a.status_active=1 and b.status_active=1");
		foreach($sql_pre as $row){
			$update_by_fabrice=$row[csf('update_by_fabrice')];
		}
		if($update_by_fabrice==1)
		{
			echo "budget_updated**".str_replace("'","",$txt_booking_no);
			disconnect($con);die;	
		}
		
		 $flag=1;
		 if(str_replace("'","",$lib_tna_intregrate)==1)
		 {
			 $delivery_date=fnc_delivery_date($str_po_id,str_replace("'","",$txt_booking_no));
			 //$rID_date."**".$delivery_date;
			 $ex_date=explode("**",$delivery_date);
			 $rID_date=$ex_date[0];
			 //$delivery_date
			 if($ex_date[0]==1) $flag=1; else $flag=0;
		 }

		 //echo "10**".$delivery_date; die;
		 $rID=sql_insert("wo_booking_dtls",$field_array1,$data_array1,0);
		 if($rID==1 && $flag==1) $flag=1; else $flag=0;

		 if($flag==1)
		 {
			 $rID1= execute_query( "update fabric_sales_order_mst set is_apply_last_update=2 where sales_booking_no ='".str_replace("'", "", $txt_booking_no)."' and status_active=1 and is_deleted=0",0);
			 if( $rID1==1 && $flag==1) $flag=1; else $flag=0;
		 }

		 check_table_status( $_SESSION['menu_id'],0);
		 if($db_type==0){
			if($flag==1){
				mysql_query("COMMIT");
				echo "0**".$rID;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$rID;
			}
		 }
		 else if($db_type==2 || $db_type==1 ){
			if($flag==1){
				oci_commit($con);
				echo "0**".$rID;
			}
			else{
				oci_rollback($con);
				echo "10**".$rID;
			}
		 }
		 disconnect($con);
		 die;
	}
	else if ($operation==1)
	{
		$con = connect();
		if($db_type==0){
			mysql_query("BEGIN");
		}
		$is_approved=0;
		$sql=sql_select("select is_approved from wo_booking_mst where booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
		foreach($sql as $row){
			if($row[csf('is_approved')]==3) $is_approved=1; else $is_approved=$row[csf('is_approved')];
		}
		if($is_approved==1){
			echo "approved**".str_replace("'","",$txt_booking_no);
			disconnect($con);die;
		}

		$pi_number=return_field_value( "pi_number", "com_pi_master_details a,com_pi_item_details b"," a.id=b.pi_id and b.work_order_no=$txt_booking_no and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0");
		if($pi_number){
			echo "pi1**".str_replace("'","",$txt_booking_no)."**".$pi_number;
			disconnect($con);die;
		}

		$receive_mrr=0;
		$sqlre=sql_select("select recv_number from inv_receive_master where booking_no=$txt_booking_no  and status_active=1 and is_deleted=0");
		foreach($sqlre as $rows){
			$receive_mrr=$rows[csf('recv_number')];
		}
		if($receive_mrr){
			echo "rec1**".str_replace("'","",$txt_booking_no)."**".$receive_mrr;
			disconnect($con);die;
		}

		$issue_mrr=0;
		$sqlis=sql_select("select issue_number from inv_issue_master where booking_no=$txt_booking_no  and status_active=1 and is_deleted=0");
		foreach($sqlis as $rows){
			$issue_mrr=$rows[csf('issue_number')];
		}
		if($issue_mrr){
			echo "iss1**".str_replace("'","",$txt_booking_no)."**".$issue_mrr;
			disconnect($con);die;
		}
		
		
		$po_arr=array(); $olddtlsidArr=array(); $preDataArr=array();
		if(str_replace("'","",$txt_booking_no)!=''){
			$sql_po= sql_select("select b.id as dtlsid, b.po_break_down_id, b.pre_cost_fabric_cost_dtls_id, b.fabric_color_id, b.color_type, b.construction, b.copmposition, b.gsm_weight, b.dia_width from wo_booking_mst a, wo_booking_dtls b where a.booking_no=b.booking_no and a.booking_type=1 and a.is_short=2 and a.entry_form=108 and b.booking_no=$txt_booking_no and a.status_active=1 and  a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0");
			foreach($sql_po as $pdata){
				$po_arr[$pdata[csf('po_break_down_id')]]=$pdata[csf('po_break_down_id')];
				$olddtlsidArr[$pdata[csf('dtlsid')]]=$pdata[csf('dtlsid')];
				$strold=$pdata[csf('construction')].$pdata[csf('fabric_color_id')].$pdata[csf('copmposition')].$pdata[csf('color_type')].$pdata[csf('gsm_weight')].$pdata[csf('dia_width')];
				$preDataArr[$pdata[csf('pre_cost_fabric_cost_dtls_id')]][$pdata[csf('po_break_down_id')]][$strold]=$strold;
			}
		}
		
		$field_array_up1="color_type*construction*copmposition*gsm_weight*dia_width*fabric_color_id*gmts_color_id*fin_fab_qnty*grey_fab_qnty*adjust_qty*rate*amount*process_loss_percent*remark*pre_cost_remarks*hs_code*precons*updated_by*update_date";
		$new_array_color=array(); $str_po_id=""; $plandatachnage=0;
		for ($i=1;$i<=$total_row;$i++){

			$txtjob="txtjob_".$i;
			$txtpoid="txtpoid_".$i;
			 //=========
			$txtpre_cost_fabric_cost_dtls_id="txtpre_cost_fabric_cost_dtls_id_".$i;
			$txtcolortype_="txtcolortype_".$i;
			$txtconstruction_="txtconstruction_".$i;
			$txtcompositi_="txtcompositi_".$i;
			$txtgsm_weight_="txtgsm_weight_".$i;
			$txtdia_="txtdia_".$i;
			//============
			 $txtgmtcolor="txtgmtcolor_".$i;
			 $txtitemcolor="txtitemcolor_".$i;
			 $txtbalqnty="txtbalqnty_".$i;
			 $txtreqqnty="txtreqqnty_".$i;
			 $txtfinreqqnty="txtfinreqqnty_".$i;
			 $txtwoq="txtwoq_".$i;
			 $txtadj="txtadj_".$i;

			 $txtrate="txtrate_".$i;
			 $txtamount="txtamount_".$i;
			 $bookingid="bookingid_".$i;
			 $txtremark="txtremark_".$i;
			 $txtacwoq="txtacwoq_".$i;
			 $process="process_".$i;
			 $hscode="hscode_".$i;
			 $preconskg="preconskg_".$i;

			 $precostid=str_replace("'","",$cbo_fabric_description);
			 $colorid=str_replace("'","",$$txtgmtcolor);
             $reqqnty=str_replace("'","",$$txtreqqnty);
			 $finreqqnty=str_replace("'","",$$txtfinreqqnty);
			 $woq=str_replace("'","",$$txtwoq);
			 $acwoq=str_replace("'","",$$txtacwoq);
			 $rate=str_replace("'","",$$txtrate);
			 $amount=str_replace("'","",$$txtamount);
			 
			 $processLossPer=0;
			 $processLossPer=(($reqqnty-$finreqqnty)/$finreqqnty)*100;
			 
			 $avgFinKg=$finreqqnty/$reqqnty;
			 
			 $finAcWoQty=$acwoq*$avgFinKg;
			$finWoQty=$greyWoQty=$pLossPer=0;
			if($textile_sales_maintain==1)
			{
				$finWoQty=$finAcWoQty;
				$greyWoQty=$woq;
				$pLossPer=number_format($processLossPer,2,'.','');
			}
			else
			{
				$finWoQty=$acwoq;
				$greyWoQty=$woq;
				$pLossPer=number_format($processLossPer,2,'.','');
			}
			
			$strnew=str_replace("'",'',$$txtconstruction_).str_replace("'",'',$$txtitemcolor).str_replace("'",'',$$txtcompositi_).str_replace("'",'',$$txtcolortype_).str_replace("'",'',$$txtgsm_weight_).str_replace("'",'',$$txtdia_);
			 
			 if($preDataArr[str_replace("'",'',$$txtpre_cost_fabric_cost_dtls_id)][str_replace("'",'',$$txtpoid)][$strnew]=="")
			 {
				$plandatachnage=1; 
			 }

			$poId=str_replace("'","",$$txtpoid);
			 if(str_replace("'",'',$$bookingid)!=""){
				$id_arr[]=str_replace("'",'',$$bookingid);
				$data_array_up1[str_replace("'",'',$$bookingid)] =explode("*",("".$$txtcolortype_."*".$$txtconstruction_."*".$$txtcompositi_."*".$$txtgsm_weight_."*".$$txtdia_."*".$$txtitemcolor."*".$$txtgmtcolor."*".$finWoQty."*".$greyWoQty."*".$$txtadj."*".$rate."*".$amount."*".$pLossPer."*".$$txtremark."*".$$process."*".$$hscode."*".$$preconskg."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'"));
				if($str_po_id=="") $str_po_id=$poId; else $str_po_id.='*'.$poId;
			 }
		 }
		 $flag=1;
		 if(str_replace("'","",$lib_tna_intregrate)==1)
		 {
			 $delivery_date=fnc_delivery_date($str_po_id,str_replace("'","",$txt_booking_no));
			 //$rID_date."**".$delivery_date;
			 $ex_date=explode("**",$delivery_date);
			 $rID_date=$ex_date[0];
			 //$delivery_date
			 if($ex_date[0]==1) $flag=1; else $flag=0;
		 }
		 $rID=execute_query(bulk_update_sql_statement( "wo_booking_dtls", "id", $field_array_up1, $data_array_up1, $id_arr ),1);
		 if($rID==1 && $flag==1) $flag=1; else $flag=0;

		 if($flag==1)
		 {
			 $rID1= execute_query( "update fabric_sales_order_mst set is_apply_last_update=2 where sales_booking_no ='".str_replace("'", "", $txt_booking_no)."' and status_active=1 and is_deleted=0",0);
			 if( $rID1==1 && $flag==1) $flag=1; else $flag=0;
		 }
		// $plandatachnage=1;
		if($plandatachnage==1)
		{
			fnc_isdyeingplan("WO_PO_DETAILS_MASTER", $jobidArr);
			fnc_isdyeingplan("WO_BOOKING_DTLS", $newidarr);
		}

        check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($flag==1){
				mysql_query("COMMIT");
				echo "1**".$rID;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($flag==1)
			{
				oci_commit($con);
				echo "1**".$rID;
			}
			else{
				oci_rollback($con);
				echo "10**".$rID;
			}
		}
		disconnect($con);
		die;
	}
	else if($operation==2) // Delete Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		$fabric_source=0;

	    $is_approved=0;
		$sql=sql_select("select is_approved from wo_booking_mst where booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
		foreach($sql as $row){
			if($row[csf('is_approved')]==3) $is_approved=1; else $is_approved=$row[csf('is_approved')];
		}
		if($is_approved==1){
			echo "approved**".str_replace("'","",$txt_booking_no);
			disconnect($con);die;
		}

		$pi_number=return_field_value( "pi_number", "com_pi_master_details a,com_pi_item_details b"," a.id=b.pi_id and b.work_order_no=$txt_booking_no and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0");
		if($pi_number){
			echo "pi1**".str_replace("'","",$txt_booking_no)."**".$pi_number;
			disconnect($con);die;
		}

		$pplbook=0;
		$ppl=sql_select("select b.id from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and a.booking_no=$txt_booking_no and a.is_sales!=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.id");
		foreach($ppl as $pplrow){
			$pplbook=$pplrow[csf('id')];
		}

		if($pplbook!=0){
			echo "PPL**".str_replace("'","",$txt_booking_no)."**".$pplbook;
			disconnect($con);die;
		}

		/*$sales_order=0;//ISD-23-25847
		$sqls=sql_select("select job_no from fabric_sales_order_mst where sales_booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
		foreach($sqls as $rows){
			$sales_order=$rows[csf('job_no')];
		}
		if($sales_order){
			echo "sal1**".str_replace("'","",$txt_booking_no)."**".$sales_order;
			disconnect($con);die;
		}*/

		$receive_mrr=0;
		$sqlre=sql_select("select recv_number from inv_receive_master where booking_no=$txt_booking_no  and status_active=1 and is_deleted=0");
		foreach($sqlre as $rows){
			$receive_mrr=$rows[csf('recv_number')];
		}
		if($receive_mrr){
			echo "rec1**".str_replace("'","",$txt_booking_no)."**".$receive_mrr;
			disconnect($con);die;
		}

		$issue_mrr=0;
		$sqlis=sql_select("select issue_number from inv_issue_master where booking_no=$txt_booking_no  and status_active=1 and is_deleted=0");
		foreach($sqlis as $rows){
			$issue_mrr=$rows[csf('issue_number')];
		}
		if($issue_mrr){
			echo "iss1**".str_replace("'","",$txt_booking_no)."**".$issue_mrr;
			disconnect($con);die;
		}
		$lib_yarn_count_deter_id=0;
		$sql=sql_select("select lib_yarn_count_deter_id from wo_pre_cost_fabric_cost_dtls where id=$cbo_fabric_description");
		foreach($sql as $row){
			$lib_yarn_count_deter_id=$row[csf('lib_yarn_count_deter_id')];
		}

		/*$recv_number=return_field_value( "recv_number", "inv_receive_master"," booking_no=$txt_booking_no  and status_active=1 and  is_deleted=0");
		if($recv_number){
			echo "recv1**".str_replace("'","",$txt_booking_no)."**".$recv_number;
			die;
		}*/

		/*if($fabric_source==1){
			$sql=sql_select("select a.recv_number from inv_receive_master a, pro_grey_prod_entry_dtls b where a.id=b.mst_id and  a.booking_no=$txt_booking_no and a.entry_form in(2,22,58) and a.receive_basis=1 and b.febric_description_id=$lib_yarn_count_deter_id  and a.status_active=1 and  a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0");
			$recv_number=0;
			foreach($sql as $row){
				$recv_number=$row[csf('recv_number')];
		    }
			if($recv_number){
				echo "recv1**".str_replace("'","",$txt_booking_no)."**".$recv_number;
				die;
			}
		}

		if($fabric_source==2){
			$sql=sql_select("select a.recv_number from inv_receive_master a, pro_grey_prod_entry_dtls b where a.id=b.mst_id and  a.booking_no=$txt_booking_no and a.entry_form in(22,7,37,68) and a.receive_basis=1 and b.febric_description_id=$lib_yarn_count_deter_id  and a.status_active=1 and  a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0");
			$recv_number=0;
			foreach($sql as $row){
				$recv_number=$row[csf('recv_number')];
		    }
			if($recv_number){
				echo "recv1**".str_replace("'","",$txt_booking_no)."**".$recv_number;
				die;
			}
		}*/

		/*$field_array="updated_by*update_date*status_active*is_deleted";
		$data_array="".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*'0'*'1'";
		$txt_all_update_id=str_replace("*",",",str_replace("'","",$txt_all_update_id));
		$rID=sql_multirow_update("wo_booking_dtls",$field_array,$data_array,"id","".$txt_all_update_id."",1);*/
		$delete_cause=str_replace("'","",$delete_cause);
		$delete_cause=str_replace('"','',$delete_cause);
		$delete_cause=str_replace('(','',$delete_cause);
		$delete_cause=str_replace(')','',$delete_cause);

		 for ($i=1;$i<=$total_row;$i++){

			// $txtjob="txtjob_".$i;
			 //$txtpoid_="txtpoid_".$i;
			 //$txtpre_cost_fabric_cost_dtls_id="txtpre_cost_fabric_cost_dtls_id_".$i;
			 $bookingid="bookingid_".$i;
			 //$precostid=str_replace("'","",$cbo_fabric_description);
			// $rID=execute_query( "delete from wo_booking_dtls where  pre_cost_fabric_cost_dtls_id in (".str_replace("'","",$precostid).")",0);
			 //$rID=execute_query( "update wo_booking_dtls set status_active=0,is_deleted=1,updated_by=".$_SESSION['logic_erp']['user_id'].",update_date='".$pc_date_time."' where  pre_cost_fabric_cost_dtls_id in (".str_replace("'","",$precostid).") and booking_no=$txt_booking_no",0);
			 if(trim(str_replace("'","",$$bookingid))!="")
			 {
			 $rID=execute_query( "update wo_booking_dtls set status_active=0,is_deleted=1,delete_cause='$delete_cause',updated_by=".$_SESSION['logic_erp']['user_id'].",update_date='".$pc_date_time."' where  id in (".str_replace("'","",$$bookingid).") and booking_no=$txt_booking_no",0);
			 }
		 }
		//$rID1=sql_delete("wo_booking_dtls",$field_array,$data_array,"booking_no","".$txt_booking_no."",1);
		if($db_type==0)
		{
			if($rID)
			{
				mysql_query("COMMIT");
				echo "2**".str_replace("'","",$txt_job_no)."**".str_replace("'","",$txt_booking_no)."**".str_replace("'","",$cbo_colorsizesensitive);
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "10**".str_replace("'","",$txt_job_no)."**".str_replace("'","",$txt_booking_no)."**".str_replace("'","",$cbo_colorsizesensitive);
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID){
				oci_commit($con);
				echo "2**".str_replace("'","",$txt_job_no)."**".str_replace("'","",$txt_booking_no)."**".str_replace("'","",$cbo_colorsizesensitive);
			}
			else{
				oci_rollback($con);
				echo "10**".str_replace("'","",$txt_job_no)."**".str_replace("'","",$txt_booking_no)."**".str_replace("'","",$cbo_colorsizesensitive);
			}
		}
		disconnect($con);
		die;
	}
}

if ($action=="save_update_delete_dtls_job_level")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$json_data=json_decode(str_replace("'","",$json_data));
	
	$variable_textile_sales_maintain = sql_select("select production_entry from variable_settings_production where company_name=$cbo_company_name and variable_list=66 and status_active=1");

	if($variable_textile_sales_maintain[0][csf('production_entry')] ==2) $textile_sales_maintain = 1; else $textile_sales_maintain = 0;
	
	//print_r($json_data);
	if ($operation==0)  // Insert Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		$is_approved=0;
		$sql=sql_select("select is_approved from wo_booking_mst where booking_no=$txt_booking_no");
		foreach($sql as $row){
			if($row[csf('is_approved')]==3){
				$is_approved=1;
			}else{
				$is_approved=$row[csf('is_approved')];
			}
		}
		if($is_approved==1){
			echo "approved**".str_replace("'","",$txt_booking_no);
			disconnect($con);die;
		}

		 if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0";disconnect($con); die;}
		 $id_dtls=return_next_id( "id", "wo_booking_dtls", 1 ) ;
		 $field_array1="id, is_short, booking_mst_id, pre_cost_fabric_cost_dtls_id, po_break_down_id, job_no, booking_no, booking_type, color_type, construction,itrm_ref, copmposition, gsm_weight, dia_width, fabric_color_id, gmts_color_id, fin_fab_qnty, grey_fab_qnty, adjust_qty, rate, amount, process_loss_percent, remark, pre_cost_remarks, hs_code, precons, inserted_by, insert_date, status_active, is_deleted";
		 $j=1;
		 $new_array_color=array(); $str_po_id="";
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $txtjob="txtjob_".$i;
			 $txtpoid_="txtpoid_".$i;
			 //=========
			$txtpre_cost_fabric_cost_dtls_id="txtpre_cost_fabric_cost_dtls_id_".$i;
			$txtcolortype_="txtcolortype_".$i;
			$txtconstruction_="txtconstruction_".$i;
			$txtitrmref_="txtitrmref_".$i;	
			$txtcompositi_="txtcompositi_".$i;
			$txtgsm_weight_="txtgsm_weight_".$i;
			$txtdia_="txtdia_".$i;
			//============
			 $txtgmtcolor="txtgmtcolor_".$i;
			 $txtitemcolor="txtitemcolor_".$i;
			 $txtbalqnty="txtbalqnty_".$i;
			 $txtreqqnty="txtreqqnty_".$i;
			 $txtfinreqqnty="txtfinreqqnty_".$i;
			 $txtadj="txtadj_".$i;
			 $txtwoq="txtwoq_".$i;
			 $txtrate="txtrate_".$i;
			 $txtamount="txtamount_".$i;
			 $txtremark="txtremark_".$i;
			 $txtacwoq="txtacwoq_".$i;
			 $process="process_".$i;
			 $hscode="hscode_".$i;

			 $precostid=str_replace("'","",$$txtpre_cost_fabric_cost_dtls_id);
			 $colorid=str_replace("'","",$$txtgmtcolor);
			 $dia=str_replace("'","",$$txtdia_);
			 $process_p=str_replace("'","",$$process);
             $reqqnty=str_replace("'","",$$txtreqqnty);
			 $finreqqnty=str_replace("'","",$$txtfinreqqnty);
			 $woq=str_replace("'","",$$txtwoq);
			 $acwoq=str_replace("'","",$$txtacwoq);
			 $adq=str_replace("'","",$$txtadj);
			 $rate=str_replace("'","",$$txtrate);
			 $poids=str_replace("'","",$$txtpoid_);
			 $poIdChkArr[$poids]=$poids;
			//echo $dia."ppp";
			 //print_r($json_data->$precostid->$colorid->$dia);
			 
			 $processLossPer=0;
			 $processLossPer=(($reqqnty-$finreqqnty)/$finreqqnty)*100;
			 
			 $avgFinKg=$finreqqnty/$reqqnty;

			 foreach($json_data->$precostid->$colorid->$dia->$process_p->po_id as $poId){
				 if($woq>0){
					 $wQty=($json_data->$precostid->$colorid->$dia->$process_p->req_qty->$poId/$reqqnty)*$woq;
					 $AcwQty=($json_data->$precostid->$colorid->$dia->$process_p->req_qty->$poId/$reqqnty)*$acwoq;
					 $adjQty=($json_data->$precostid->$colorid->$dia->$process_p->req_qty->$poId/$reqqnty)*$adq;
					 $reqqtycostingper=$json_data->$precostid->$colorid->$dia->$process_p->reqqtycostingper->$poId;
					 
					 $finAcWoQty=$AcwQty*$avgFinKg;
					 // echo $json_data->$precostid->$colorid->$dia->$process_p->finreq_qty->$poId.'='.number_format($AcwQty).'='.number_format($finAcWoQty).'<br>';
					$finWoQty=$greyWoQty=$pLossPer=0;
					if($textile_sales_maintain==1)
					{
						$finWoQty=$finAcWoQty;
						$greyWoQty=$wQty;
						$pLossPer=number_format($processLossPer,2,'.','');
					}
					else
					{
						$finWoQty=$AcwQty;
						$greyWoQty=$wQty;
						$pLossPer=number_format($processLossPer,2,'.','');
					}
					 
					 $amount=$AcwQty*$rate;
					 if ($j!=1) $data_array1 .=",";
					 $data_array1 .="(".$id_dtls.",2,".$update_id.",".$precostid.",".$poId.",".$$txtjob.",".$txt_booking_no.",1,".$$txtcolortype_.",".$$txtconstruction_.",".$$txtitrmref_.",".$$txtcompositi_.",".$$txtgsm_weight_.",".$$txtdia_.",".$$txtitemcolor.",".$$txtgmtcolor.",".$finWoQty.",".$wQty.",".$adjQty.",".$rate.",".$amount.",".$pLossPer.",".$$txtremark.",".$$process.",".$$hscode.",'".$reqqtycostingper."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
					 if($str_po_id=="") $str_po_id=$poId; else $str_po_id.='*'.$poId;
					 $id_dtls=$id_dtls+1;
					 $j++;
				 }
			 }
		 }
		 
		//check_table_status( $_SESSION['menu_id'],0);
		//echo "10**insert into wo_booking_dtls (".$field_array1.") values ".$data_array1; check_table_status( $_SESSION['menu_id'],0);die;
		// echo "10**".$rID.'=='.$flag; die;
		$poidCond=implode(",",$poIdChkArr);
		 $sql_pre=sql_select("select a.update_by_fabrice from wo_pre_cost_mst a,wo_po_break_down b where a.job_id=b.job_id and  b.id in($poidCond) and a.update_by_fabrice>0 and a.status_active=1 and b.status_active=1");
		foreach($sql_pre as $row){
			$update_by_fabrice=$row[csf('update_by_fabrice')];
		}
		if($update_by_fabrice==1)
		{
			echo "budget_updated**".str_replace("'","",$txt_booking_no);
			disconnect($con);die;	
		}
		//check_table_status( $_SESSION['menu_id'],0);
	
		//echo "10**insert into wo_booking_dtls (".$field_array1.") values ".$data_array1; check_table_status( $_SESSION['menu_id'],0);die;
		// echo "10**".$rID.'=='.$flag; 
		 	//echo "10**=select a.update_by_fabrice from wo_pre_cost_mst a,wo_po_break_down b where a.job_id=b.job_id and  b.id in($poidCond) and a.update_by_fabrice>0 and a.status_active=1 and b.status_active=1";
		// die;
		
		$flag=1;
		if(str_replace("'","",$lib_tna_intregrate)==1)
		{
			$delivery_date=fnc_delivery_date($str_po_id,str_replace("'","",$txt_booking_no));
			//$rID_date."**".$delivery_date;
			$ex_date=explode("**",$delivery_date);
			$rID_date=$ex_date[0];
			//$delivery_date
			if($ex_date[0]==1) $flag=1; else $flag=0;
		}

		 $rID=sql_insert("wo_booking_dtls",$field_array1,$data_array1,0);
		 if($rID==1 && $flag==1) $flag=1; else $flag=0;
		
		 if($flag==1)
		 {
			 $rID1= execute_query( "update fabric_sales_order_mst set is_apply_last_update=2 where sales_booking_no =".$txt_booking_no." and status_active=1 and is_deleted=0",0);
			 if( $rID1==1 && $flag==1) $flag=1; else $flag=0;
		 }
		 check_table_status( $_SESSION['menu_id'],0);
		 if($db_type==0){
			if($flag==1){
				mysql_query("COMMIT");
				echo "0**".$rID;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$rID;
			}
		 }
		 else if($db_type==2 || $db_type==1 ){
			if($flag==1){
				oci_commit($con);
				echo "0**".$rID;
			}
			else{
				oci_rollback($con);
				echo "10**".$rID;
			}
		 }
		 disconnect($con);
		 die;
	}
	else if ($operation==1)
	{
		 $con = connect();
		 if($db_type==0){
			mysql_query("BEGIN");
		 }
		 $is_approved=0;
		$sql=sql_select("select is_approved from wo_booking_mst where booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
		foreach($sql as $row){
			if($row[csf('is_approved')]==3) $is_approved=1; else $is_approved=$row[csf('is_approved')];
		}
		if($is_approved==1){
			echo "approved**".str_replace("'","",$txt_booking_no);
			disconnect($con);die;
		}

		$pi_number=return_field_value( "pi_number", "com_pi_master_details a,com_pi_item_details b"," a.id=b.pi_id and b.work_order_no=$txt_booking_no and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0");
		if($pi_number){
			echo "pi1**".str_replace("'","",$txt_booking_no)."**".$pi_number;
			disconnect($con);die;
		}
		$receive_mrr=0;
		$sqlre=sql_select("select recv_number from inv_receive_master where booking_no=$txt_booking_no  and status_active=1 and is_deleted=0");
		foreach($sqlre as $rows){
			$receive_mrr=$rows[csf('recv_number')];
		}
		if($receive_mrr){
			echo "rec1**".str_replace("'","",$txt_booking_no)."**".$receive_mrr;
			disconnect($con);die;
		}

		$issue_mrr=0;
		$sqlis=sql_select("select issue_number from inv_issue_master where booking_no=$txt_booking_no  and status_active=1 and is_deleted=0");
		foreach($sqlis as $rows){
			$issue_mrr=$rows[csf('issue_number')];
		}
		if($issue_mrr){
			echo "iss1**".str_replace("'","",$txt_booking_no)."**".$issue_mrr;
			disconnect($con);die;
		}
		 $field_array_up1="is_short*color_type*construction*itrm_ref*copmposition*gsm_weight*dia_width*fabric_color_id*gmts_color_id*fin_fab_qnty*grey_fab_qnty*adjust_qty*rate*amount*process_loss_percent*remark*pre_cost_remarks*hs_code*precons*updated_by*update_date";
		 $new_array_color=array(); $str_po_id=""; $plandatachnage=0; //echo "10**";
		 for ($i=1;$i<=$total_row;$i++){
			 $txtjob="txtjob_".$i;
			 $txtpoid_="txtpoid_".$i;
			 //=========
			$txtpre_cost_fabric_cost_dtls_id="txtpre_cost_fabric_cost_dtls_id_".$i;
			$txtcolortype_="txtcolortype_".$i;
			$txtconstruction_="txtconstruction_".$i;
			$txtitrmref_="txtitrmref_".$i;
			$txtcompositi_="txtcompositi_".$i;
			$txtgsm_weight_="txtgsm_weight_".$i;
			$txtdia_="txtdia_".$i;
			//============
			 $txtgmtcolor="txtgmtcolor_".$i;
			 $txtitemcolor="txtitemcolor_".$i;
			 $txtbalqnty="txtbalqnty_".$i;
			 $txtreqqnty="txtreqqnty_".$i;
			 $txtfinreqqnty="txtfinreqqnty_".$i;
			 $txtadj="txtadj_".$i;
			 $txtwoq="txtwoq_".$i;
			 $txtrate="txtrate_".$i;
			 $txtamount="txtamount_".$i;
			 $bookingid="bookingid_".$i;
			 $txtremark="txtremark_".$i;
			 $txtacwoq="txtacwoq_".$i;
			 $process="process_".$i;
			 $hscode="hscode_".$i;

			 $precostid=str_replace("'","",$$txtpre_cost_fabric_cost_dtls_id);
			 $colorid=str_replace("'","",$$txtgmtcolor);
			 $dia=str_replace("'","",$$txtdia_);
			 $process_p=str_replace("'","",$$process);

             $reqqnty=str_replace("'","",$$txtreqqnty);
			 $finreqqnty=str_replace("'","",$$txtfinreqqnty);
			 $woq=str_replace("'","",$$txtwoq);
			 $acwoq=str_replace("'","",$$txtacwoq);
			 $adq=str_replace("'","",$$txtadj);
			 $rate=str_replace("'","",$$txtrate);
			 
			 $processLossPer=0;
			 $processLossPer=(($reqqnty-$finreqqnty)/$finreqqnty)*100;
			 
			 $avgFinKg=$finreqqnty/$reqqnty;
			 
			 $strnew=str_replace("'",'',$$txtconstruction_).str_replace("'",'',$$txtitemcolor).str_replace("'",'',$$txtcompositi_).str_replace("'",'',$$txtcolortype_).str_replace("'",'',$$txtgsm_weight_).str_replace("'",'',$$txtdia_);
			 
			 if($preDataArr[str_replace("'",'',$$txtpre_cost_fabric_cost_dtls_id)][str_replace("'",'',$$txtpoid_)][$strnew]=="")
			 {
				$plandatachnage=1; 
			 }
			 
			//print_r($json_data->$precostid->$colorid->$dia->$process_p);
			 foreach($json_data->$precostid->$colorid->$dia->$process_p->po_id as $poId){
				 $wQty=($json_data->$precostid->$colorid->$dia->$process_p->req_qty->$poId/$reqqnty)*$woq;
				 $AcwQty=($json_data->$precostid->$colorid->$dia->$process_p->req_qty->$poId/$reqqnty)*$acwoq;
				 $adjQty=($json_data->$precostid->$colorid->$dia->$process_p->req_qty->$poId/$reqqnty)*$adq;
				 $reqqtycostingper=$json_data->$precostid->$colorid->$dia->$process_p->reqqtycostingper->$poId;
				 
				 $finAcWoQty=$AcwQty*$avgFinKg;
				// echo $json_data->$precostid->$colorid->$dia->$process_p->finreq_qty->$poId.'='.number_format($AcwQty).'='.number_format($finAcWoQty).'<br>';
				$finWoQty=$greyWoQty=$pLossPer=0;
				if($textile_sales_maintain==1)
				{
					$finWoQty=$finAcWoQty;
					$greyWoQty=$wQty;
					$pLossPer=number_format($processLossPer,2,'.','');
				}
				else
				{
					$finWoQty=$AcwQty;
					$greyWoQty=$wQty;
					$pLossPer=number_format($processLossPer,2,'.','');
				}
				 
				$amount=$AcwQty*$rate;
				if(str_replace("'",'',$$bookingid)!="")
				{
					$newidarr[]=str_replace("'",'',$json_data->$precostid->$colorid->$dia->$process_p->booking_id->$poId);
					$id_arr[]=str_replace("'",'',$json_data->$precostid->$colorid->$dia->$process_p->booking_id->$poId);
					$data_array_up1[str_replace("'",'',$json_data->$precostid->$colorid->$dia->$process_p->booking_id->$poId)] =explode("*",("2*".$$txtcolortype_."*".$$txtconstruction_."*".$$txtitrmref_."*".$$txtcompositi_."*".$$txtgsm_weight_."*".$$txtdia_."*".$$txtitemcolor."*".$$txtgmtcolor."*".$finWoQty."*".$wQty."*".$adjQty."*".$rate."*".$amount."*".$pLossPer."*".$$txtremark."*".$$process."*".$$hscode."*'".$reqqtycostingper."'*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'"));
					if($str_po_id=="") $str_po_id=$poId; else $str_po_id.='*'.$poId;
				}
			}
		}
		 //check_table_status( $_SESSION['menu_id'],0);
		 //die;
		 $flag=1;
		 if(str_replace("'","",$lib_tna_intregrate)==1)
		 {
			 $delivery_date=fnc_delivery_date($str_po_id,str_replace("'","",$txt_booking_no));
			 //$rID_date."**".$delivery_date;
			 $ex_date=explode("**",$delivery_date);
			 $rID_date=$ex_date[0];
			 //$delivery_date
			 if($ex_date[0]==1) $flag=1; else $flag=0;
		 }

		 //echo "10**".$delivery_date; die;
		 //echo "10**". bulk_update_sql_statement( "wo_booking_dtls", "id", $field_array_up1, $data_array_up1, $id_arr ); die;
		 $rID=execute_query(bulk_update_sql_statement( "wo_booking_dtls", "id", $field_array_up1, $data_array_up1, $id_arr ),1);
		 if($rID==1 && $flag==1) $flag=1; else $flag=0;

		 if($flag==1)
		 {
			 $rID1= execute_query( "update fabric_sales_order_mst set is_apply_last_update=2 where sales_booking_no =".$txt_booking_no." and status_active=1 and is_deleted=0",0);
			 if( $rID1==1 && $flag==1) $flag=1; else $flag=0;
		 }
		 // $plandatachnage=1;
		if($plandatachnage==1)
		{
			fnc_isdyeingplan("WO_PO_DETAILS_MASTER", $jobidArr);
			fnc_isdyeingplan("WO_BOOKING_DTLS", $newidarr);
		}
         check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($flag==1){
				mysql_query("COMMIT");
				echo "1**".$rID;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$rID;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($flag==1)
			{
				oci_commit($con);
				echo "1**".$rID;
			}
			else{
				oci_rollback($con);
				echo "10**".$rID;
			}
		}
		disconnect($con);
		die;
	}
	else if ($operation==2)   // Delete Here
	{
		$con = connect();
		if($db_type==0){
			mysql_query("BEGIN");
		}

		$is_approved=0;
		$sql=sql_select("select is_approved from wo_booking_mst where booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
		foreach($sql as $row){
			if($row[csf('is_approved')]==3) $is_approved=1; else $is_approved=$row[csf('is_approved')];
		}
		if($is_approved==1){
			echo "approved**".str_replace("'","",$txt_booking_no);
		disconnect($con);	die;
		}

		$pi_number=return_field_value( "pi_number", "com_pi_master_details a,com_pi_item_details b"," a.id=b.pi_id and b.work_order_no=$txt_booking_no and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0");
		if($pi_number){
			echo "pi1**".str_replace("'","",$txt_booking_no)."**".$pi_number;
			disconnect($con);die;
		}

		$pplbook=0;
		$ppl=sql_select("select b.id from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and a.booking_no=$txt_booking_no and a.is_sales!=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.id");
		foreach($ppl as $pplrow){
			$pplbook=$pplrow[csf('id')];
		}

		if($pplbook!=0){
			echo "PPL**".str_replace("'","",$txt_booking_no)."**".$pplbook;
			disconnect($con);die;
		}

		/*$sales_order=0;
		$sqls=sql_select("select job_no from fabric_sales_order_mst where sales_booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
		foreach($sqls as $rows){
			$sales_order=$rows[csf('job_no')];
		}
		if($sales_order){
			echo "sal1**".str_replace("'","",$txt_booking_no)."**".$sales_order;
			die;
		}*/

		$receive_mrr=0;
		$sqlre=sql_select("select recv_number from inv_receive_master where booking_no=$txt_booking_no  and status_active=1 and is_deleted=0");
		foreach($sqlre as $rows){
			$receive_mrr=$rows[csf('recv_number')];
		}
		if($receive_mrr){
			echo "rec1**".str_replace("'","",$txt_booking_no)."**".$receive_mrr;
			disconnect($con);die;
		}

		$issue_mrr=0;
		$sqlis=sql_select("select issue_number from inv_issue_master where booking_no=$txt_booking_no  and status_active=1 and is_deleted=0");
		foreach($sqlis as $rows){
			$issue_mrr=$rows[csf('issue_number')];
		}
		if($issue_mrr){
			//echo "iss1**".str_replace("'","",$txt_booking_no)."**".$issue_mrr;
			//disconnect($con);die;
		}
		$lib_yarn_count_deter_id=0;
		$sql=sql_select("select lib_yarn_count_deter_id from wo_pre_cost_fabric_cost_dtls where id=$cbo_fabric_description");
		foreach($sql as $row){
			$lib_yarn_count_deter_id=$row[csf('lib_yarn_count_deter_id')];
		}

		$delete_cause=str_replace("'","",$delete_cause);
		$delete_cause=str_replace('"','',$delete_cause);
		$delete_cause=str_replace('(','',$delete_cause);
		$delete_cause=str_replace(')','',$delete_cause);
		//echo "10**";
		for ($i=1;$i<=$total_row;$i++){
			 //$txtjob="txtjob_".$i;
			 //$txtpoid_="txtpoid_".$i;
			 //$txtpre_cost_fabric_cost_dtls_id="txtpre_cost_fabric_cost_dtls_id_".$i;
			 $bookingid="bookingid_".$i;
			 //$precostid=str_replace("'","",$cbo_fabric_description);
			 //$rID=execute_query( "delete from wo_booking_dtls where  pre_cost_fabric_cost_dtls_id in (".str_replace("'","",$precostid).")",0);
			 //$rID=execute_query( "update wo_booking_dtls set status_active=0,is_deleted=1,updated_by=".$_SESSION['logic_erp']['user_id'].",update_date='".$pc_date_time."' where  pre_cost_fabric_cost_dtls_id in (".str_replace("'","",$precostid).") and booking_no=$txt_booking_no",0);
			 if(trim(str_replace("'","",$$bookingid))!="")
			 {
			 //echo "update wo_booking_dtls set status_active=0,is_deleted=6,delete_cause='$delete_cause',updated_by=".$_SESSION['logic_erp']['user_id'].",update_date='".$pc_date_time."' where  id in (".str_replace("'","",$$bookingid).") and booking_no=$txt_booking_no";
			 //die;
			 $rID=execute_query( "update wo_booking_dtls set status_active=0,is_deleted=1,delete_cause='$delete_cause',updated_by=".$_SESSION['logic_erp']['user_id'].",update_date='".$pc_date_time."' where  id in (".str_replace("'","",$$bookingid).") and booking_no=$txt_booking_no",0);
			 }
		 }
		 //die;
		if($db_type==0)
		{
			if($rID)
			{
				mysql_query("COMMIT");
				echo "2**".str_replace("'","",$txt_job_no)."**".str_replace("'","",$txt_booking_no)."**".str_replace("'","",$cbo_colorsizesensitive);
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "10**".str_replace("'","",$txt_job_no)."**".str_replace("'","",$txt_booking_no)."**".str_replace("'","",$cbo_colorsizesensitive);
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID){
				oci_commit($con);
				echo "2**".str_replace("'","",$txt_job_no)."**".str_replace("'","",$txt_booking_no)."**".str_replace("'","",$cbo_colorsizesensitive);
			}
			else{
				oci_rollback($con);
				echo "10**".str_replace("'","",$txt_job_no)."**".str_replace("'","",$txt_booking_no)."**".str_replace("'","",$cbo_colorsizesensitive);
			}
		}
		disconnect($con);
		die;
	}
}

function fnc_delivery_date($str_po_id,$bookingNo)
{
	$sqlbook=sql_select("select po_break_down_id from wo_booking_dtls where booking_no='$bookingNo' and status_active=1 and is_deleted=0");
	foreach($sqlbook as $rows)
	{
		if($str_po_id=="") $str_po_id=$rows[csf('po_break_down_id')]; else $str_po_id.='*'.$rows[csf('po_break_down_id')];
	}
	$poids=implode(",",array_filter(array_unique(explode('*',$str_po_id))));

	$sql_tna=sql_select("select min(task_start_date) as task_start_date from tna_process_mst where po_number_id in(".$poids.") and task_number in(73) and is_deleted = 0 and status_active=1");

	$delivery_date="'".$sql_tna[0][csf('task_start_date')]."'";
	$rID_date=execute_query( "update wo_booking_mst set delivery_date=$delivery_date where booking_no='$bookingNo'",0);
	return $rID_date."**".$delivery_date;
	
	
}

if($action=="check_is_booking_used")
{
	$txt_booking_no="'".$data."'";
	if($data!="")
	{
		$is_approved=0;
		$sql=sql_select("select is_approved from wo_booking_mst where booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
		foreach($sql as $row){
			if($row[csf('is_approved')]==3) $is_approved=1; else $is_approved=$row[csf('is_approved')];
		}
		if($is_approved==1){
			echo "approved**".str_replace("'","",$txt_booking_no);
			disconnect($con);die;
		}

		$pi_number=return_field_value( "pi_number", "com_pi_master_details a,com_pi_item_details b"," a.id=b.pi_id and b.work_order_no=$txt_booking_no and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0");
		if($pi_number){
			echo "pi1**".str_replace("'","",$txt_booking_no)."**".$pi_number;
			disconnect($con);die;
		}

		$pplbook=0;
		$ppl=sql_select("select b.id from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and a.booking_no=$txt_booking_no and a.is_sales!=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.id");
		foreach($ppl as $pplrow){
			$pplbook=$pplrow[csf('id')];
		}

		if($pplbook!=0){
			echo "PPL**".str_replace("'","",$txt_booking_no)."**".$pplbook;
			disconnect($con);die;
		}

		/*$sales_order=0;
		$sqls=sql_select("select job_no from fabric_sales_order_mst where sales_booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
		foreach($sqls as $rows){
			$sales_order=$rows[csf('job_no')];
		}
		if($sales_order){
			echo "sal1**".str_replace("'","",$txt_booking_no)."**".$sales_order;
			die;
		}*/

		$receive_mrr=0;
		$sqlre=sql_select("select recv_number from inv_receive_master where booking_no=$txt_booking_no  and status_active=1 and is_deleted=0");
		foreach($sqlre as $rows){
			$receive_mrr=$rows[csf('recv_number')];
		}
		if($receive_mrr){
			echo "rec1**".str_replace("'","",$txt_booking_no)."**".$receive_mrr;
			disconnect($con);die;
		}

		$issue_mrr=0;
		$sqlis=sql_select("select issue_number from inv_issue_master where booking_no=$txt_booking_no  and status_active=1 and is_deleted=0");
		foreach($sqlis as $rows){
			$issue_mrr=$rows[csf('issue_number')];
		}
		if($issue_mrr){
			echo "iss1**".str_replace("'","",$txt_booking_no)."**".$issue_mrr;
			disconnect($con);die;
		}
	}
	exit();
}

if($action=="delete_booking_item")
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}
  $rID = execute_query( "update wo_booking_dtls set status_active=0,is_deleted=1 where  booking_no ='$data'",0);
   if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "0**".str_replace(",","",$txt_booking_no);
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".str_replace(",","",$txt_booking_no);
			}
		}

		if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "0**".str_replace(",","",$txt_booking_no);
			}
			else{
				oci_rollback($con);
				echo "10**".str_replace(",","",$txt_booking_no);
			}
		}
}


if($action=="booking_surch_option")
{
	extract($_REQUEST);
	echo load_html_head_contents("Popup Info","../../../", '', '', $unicode);
	?>
    <script>

		var selected_id = new Array;
		var selected_name = new Array;
		var selected_no = new Array;
    	function check_all_data()
		{
			var tbl_row_count = document.getElementById( 'list_view' ).rows.length;
			var onclickString=paramArr=functionParam="";
			for( var i = 1; i <= tbl_row_count; i++ )
			{
				onclickString = $('#tr_' + i).attr('onclick');
				paramArr = onclickString.split("'");
				functionParam = paramArr[1];
				js_set_value( functionParam );

			}
		}

		function toggle( x, origColor ) {
			var newColor = 'yellow';
			if ( x.style ) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}

		function js_set_value( strCon )
		{
			//alert(strCon);
				var splitSTR = strCon.split("_");
				var str_or = splitSTR[0];
				var selectID = splitSTR[1];
				var selectDESC = splitSTR[2];
				//$('#txt_individual_id' + str).val(splitSTR[1]);
				//$('#txt_individual' + str).val('"'+splitSTR[2]+'"');

				toggle( document.getElementById( 'tr_' + str_or ), '#FFFFCC' );

				if( jQuery.inArray( str_or, selected_no ) == -1 ) {
					selected_id.push( selectID );
					selected_name.push( selectDESC );
					selected_no.push( str_or );
				}
				else {
					for( var i = 0; i < selected_id.length; i++ ) {
						if( selected_id[i] == selectID ) break;
					}
					selected_id.splice( i, 1 );
					selected_name.splice( i, 1 );
					selected_no.splice( i, 1 );
				}
				var id = ''; var name = ''; var job = ''; var num='';
				for( var i = 0; i < selected_id.length; i++ ) {
					id += selected_id[i] + ',';
					name += selected_name[i] + ',';
					num += selected_no[i] + ',';
				}
				id 		= id.substr( 0, id.length - 1 );
				name 	= name.substr( 0, name.length - 1 );
				num 	= num.substr( 0, num.length - 1 );
				//alert(num);
				$('#txt_selected_id').val( id );
				$('#txt_selected').val( name );
				$('#txt_selected_no').val( num );
		}

		function frm_close()
		{
			parent.emailwindow.hide();
		}
    </script>
    <?
	$select_rpt_option_arr=array(1=>"Size and Color Breakdown",2=>"Main Booking Info",3=>"Collar / Cuff -  Colour Size Brakedown in Pcs",4=>"Yarn Required Summary",5=>"Allocated Yarn",6=>"Conversion Charge",7=>"Embellishment",8=>"Approved Instructions",9=>"Special  Instruction",10=>"Comments",11=>"TNA Information");
	//echo $sql;die;
	?>

    <div style="width:500px;">
    <table width="500" cellpadding="0" cellspacing="0" class="rpt_table" border="1" rules="all" id="" align="left">
    	<thead>
        	<tr>
                <th width="50">Sl</th>
                <th>Report Option</th>
            </tr>
        </thead>
    </table>
    <table width="500" cellpadding="0" cellspacing="0" class="rpt_table" border="1" rules="all" id="list_view" align="left">
        <tbody>
			<?
            $i=1;
            foreach($select_rpt_option_arr as $id=>$val)
            {
                if ($i%2==0)
                $bgcolor="#E9F3FF";
                else
                $bgcolor="#FFFFFF";
                ?>
                <tr bgcolor="<? echo $bgcolor; ?>" id="tr_<? echo $i; ?>" onClick="js_set_value('<? echo $i."_".$id."_".$val; ?>')" style="cursor:pointer">
                    <td width="50"  align="center"><? echo $i; ?></td>
                    <td><? echo $val; ?></td>
                </tr>
                <?
                $i++;
            }
            ?>
            <tr>
                <td  style="vertical-align:middle; padding-left:20px;" colspan="2"><input type="checkbox" id="all_check" onClick="check_all_data('all_check')" />&nbsp;Check All / Un-Check All
                <input type='hidden' id='txt_selected_id' />
                <input type='hidden' id='txt_selected' />
                <input type='hidden' id='txt_selected_no' />
                </td>
            </tr>
        </tbody>
    </table>
    <br>
    <div style="width:100%"><p align="center"><input type="button" id="btn_close" class="formbutton" style="width:100px;" value="Close" onClick="frm_close();" ></p></div>
    </div>

    <script language="javascript" type="text/javascript">
	var category_no='<? echo $booking_option_no;?>';
	var category_id='<? echo $booking_option_id;?>';
	var category_des='<? echo $booking_option;?>';
	var cate_ref="";
	if(category_no!="")
	{
		category_no_arr=category_no.split(",");
		category_id_arr=category_id.split(",");
		category_des_arr=category_des.split(",");
		var str_ref="";
		for(var k=0;k<category_no_arr.length; k++)
		{
			cate_ref=category_no_arr[k]+'_'+category_id_arr[k]+'_'+category_des_arr[k];
			js_set_value(cate_ref);
		}
	}
	</script>
    <?
	exit();
}

if($action=="terms_condition_popup")
{
	echo load_html_head_contents("Order Search","../../../", 1, 1, $unicode);
	extract($_REQUEST);

?>
	<script>
function add_break_down_tr(i)
 {
	var row_num=$('#tbl_termcondi_details tr').length-1;
	if (row_num!=i){
		return false;
	}
	else{
		i++;
		 $("#tbl_termcondi_details tr:last").clone().find("input,select").each(function() {
			$(this).attr({
			  'id': function(_, id) { var id=id.split("_"); return id[0] +"_"+ i },
			  'name': function(_, name) { return name + i },
			  'value': function(_, value) { return value }
			});
		  }).end().appendTo("#tbl_termcondi_details");
		  $('#tbl_termcondi_details tr:last td:eq(0)').html(i);
		  $('#increase_'+i).removeAttr("onClick").attr("onClick","add_break_down_tr("+i+");");
		  $('#decrease_'+i).removeAttr("onClick").attr("onClick","fn_deletebreak_down_tr("+i+")");
		  $('#termscondition_'+i).val("");
	}
}

function fn_deletebreak_down_tr(rowNo,tr){
	/*var numRow = $('table#tbl_termcondi_details tbody tr').length;
	if(numRow==rowNo && rowNo!=1){
		$('#tbl_termcondi_details tbody tr:last').remove();
	}*/
	if(rowNo!=1){
		 var index = $(tr).closest("tr").index();
		 $("table#tbl_termcondi_details tbody tr:eq("+index+")").remove();
		 var numRow = $('table#tbl_termcondi_details tbody tr').length;
		for(i = rowNo;i <= numRow;i++)
		{
			$("table#tbl_termcondi_details  tr:eq("+i+")").find("input,select").each(function() {
			$(this).attr({
			'id': function(_, id) { var id=id.split("_"); return id[0] +"_"+ i },
			//'name': function(_, name) { var name=name.split("_"); return name[0] +"_"+ i},
			'value': function(_, value) { return value }
			});
			var trr=$('table#tbl_termcondi_details tr:eq('+i+') td:eq(0)').html(i);
			$('#increase_'+i).removeAttr("onClick").attr("onClick","add_break_down_tr("+i+");");
			$('#decrease_'+i).removeAttr("onClick").attr("onClick","fn_deletebreak_down_tr("+i+",this)");
			//$('#termscondition_'+i).val("");
			})
		}
	}
}

function fnc_fabric_booking_terms_condition( operation ){
	var row_num=$('#tbl_termcondi_details tr').length-1;
	var data_all="";
	for (var i=1; i<=row_num; i++){

		if (form_validation('termscondition_'+i,'Term Condition')==false){
			return;
		}
		data_all=data_all+get_submitted_data_string('txt_booking_no*termscondition_'+i,"../../../",i);
	}
	var data="action=save_update_delete_fabric_booking_terms_condition&operation="+operation+'&total_row='+row_num+data_all;
	freeze_window(operation);
	http.open("POST","partial_fabric_booking_controller.php",true);
	http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
	http.send(data);
	http.onreadystatechange = fnc_fabric_booking_terms_condition_reponse;
}

function fnc_fabric_booking_terms_condition_reponse(){
	if(http.readyState == 4){
	    var reponse=trim(http.responseText).split('**');
		if (reponse[0].length>2) reponse[0]=10;
		release_freezing();
		if(reponse[0]==0 || reponse[0]==1){
			parent.emailwindow.hide();
		}
	}
}
function open_extra_terms_popup(page_link,title){
	    var txt_booking_no=document.getElementById('txt_booking_no').value
	    page_link=page_link+'&txt_booking_no='+txt_booking_no;
		emailwindow=dhtmlmodal.open('EmailBox', 'iframe', page_link, title, 'width=500px,height=400px,center=1,resize=1,scrolling=0','../../')
		emailwindow.onclose=function()
		{
			var theform=this.contentDoc.forms[0];
			var theemail=this.contentDoc.getElementById("terms_breck_down");
			if (theemail.value!="")
			{
				var counter=$('#tbl_termcondi_details tr').length-1;
				var data=JSON.parse(theemail.value);
				for(var i=0;i<data.length;i++){
					//alert(data[i])
					counter++;
					$('#tbl_termcondi_details tbody').append(
					'<tr id="settr_1" align="center">'
					+ '<td>'+counter+'</td><td><input type="text" name="termscondition_'+counter+'" class="text_boxes" id="termscondition_'+counter+'"  style="width:95%;" value="'+data[i]+'"/></td><td><input type="button" class="formbutton" id="increase_'+counter+'"  style="width:30px;" value="+" onClick="add_break_down_tr('+counter+')"/><input type="button" class="formbutton" id="decrease_'+counter+'"  style="width:30px;" value="-" onClick="javascript:fn_deletebreak_down_tr('+counter+')"/></td>'+ '</tr>'
				);
				}
				//alert(data[0])
				//alert(JSON.parse(theemail.value).length)
			}
		}
}
    </script>

</head>
<body>
<div align="center" style="width:100%;" >
 <? echo load_freeze_divs ("../../../",$permission);  ?>
<fieldset>
        	<form id="termscondi_1" autocomplete="off" name="termscondi_1">
           <input type="hidden" id="txt_booking_no" name="txt_booking_no" value="<? echo str_replace("'","",$txt_booking_no); ?>"/>


            <table width="650" cellspacing="0" class="rpt_table" border="0" id="tbl_termcondi_details" rules="all">
                	<thead>
                    	<tr>
                        	<th width="50">Sl</th><th width="530">Terms</th><th ></th>
                        </tr>
                    </thead>
                    <tbody>
                    <?
					$data_array=sql_select("select id, terms from  wo_booking_terms_condition where booking_no=$txt_booking_no order by id");// quotation_id='$data'
					if ( count($data_array)>0)
					{
						$i=0;
						foreach( $data_array as $row )
						{
							$i++;
							?>
                            	<tr id="settr_1" align="center">
                                    <td>
                                    <? echo $i;?>
                                    </td>
                                    <td>
                                    <input type="text" id="termscondition_<? echo $i;?>"   name="termscondition_<? echo $i;?>" style="width:95%"  class="text_boxes"  value="<? echo $row[csf('terms')]; ?>"  />
                                    </td>
                                    <td>
                                    <input type="button" id="increase_<? echo $i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr(<? echo $i; ?> )" />
                                    <input type="button" id="decrease_<? echo $i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<? echo $i; ?>,this);" />
                                    </td>
                                </tr>
                            <?
						}
					}
					else
					{
					$data_array=sql_select("select id, terms from  lib_terms_condition where is_default=1 and page_id=108");// quotation_id='$data'
					foreach( $data_array as $row )
						{
							$i++;
					?>
                    <tr id="settr_1" align="center">
                                    <td>
                                    <? echo $i;?>
                                    </td>
                                    <td>
                                    <input type="text" id="termscondition_<? echo $i;?>"   name="termscondition_<? echo $i;?>" style="width:95%"  class="text_boxes"  value="<? echo $row[csf('terms')]; ?>"  />
                                    </td>
                                    <td>
                                    <input type="button" id="increase_<? echo $i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr(<? echo $i; ?> )" />
                                    <input type="button" id="decrease_<? echo $i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<? echo $i; ?> ,this);" />
                                    </td>
                                </tr>
                    <?
						}
					}
					?>
                </tbody>
                </table>

                <table width="650" cellspacing="0" class="" border="0">
                	<tr>
                        <td align="center" height="15" width="100%">
                        <input type="button" id="set_button4" class="image_uploader" style="width:160px;" value="Add More.." onClick="open_extra_terms_popup('partial_fabric_booking_controller.php?action=extra_terms_popup','Terms Condition')" />
                        </td>
                    </tr>
                	<tr>
                        <td align="center" width="100%" class="button_container">
						        <?
 									echo load_submit_buttons( $permissions, "fnc_fabric_booking_terms_condition", 1,1 ,"reset_form('termscondi_1','','','','')",11) ;

									?>
                        </td>
                    </tr>
                </table>
            </form>
        </fieldset>
</div>
</body>
<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
</html>
<?
exit();
}

if($action=="extra_terms_popup")
{
	echo load_html_head_contents("Order Search","../../../", 1, 1, $unicode);
	extract($_REQUEST);
?>
	<script>
	function toggle( x, origColor ) {
			var newColor = 'yellow';
			if ( x.style ) {
				x.style.backgroundColor = ( newColor == x.style.backgroundColor )? origColor : newColor;
			}
		}
		var selected_id = new Array();
		var selected_item=new Array();
	function js_set_value(counter,id,terms){
		toggle( document.getElementById( 'search' + counter ), '#FFFFCC' );
	
		if( jQuery.inArray( id, selected_id ) == -1 ) {
	
			selected_id.push( id );
			selected_item.push(terms);
		}
		else{
			for( var i = 0; i < selected_id.length; i++ ) {
				if( selected_id[i] == id ) break;
			}
			selected_id.splice( i, 1 );
			selected_item.splice( i,1 );
		}
	
		var ids = '';
		var termCon='';
		for( var i = 0; i < selected_id.length; i++ ) {
			///alert(selected_id[i])
			ids += selected_id[i] + ',';
			termCon+=selected_item[i]+ ',';
		}
		ids = ids.substr( 0, ids.length - 1 );
		termCon = termCon.substr( 0, termCon.length - 1 );
		//alert(termCon);
		//alert(JSON.stringify(selected_item));
		$('#terms_breck_down').val( JSON.stringify(selected_item) );
		$('#txt_pre_cost_dtls_id').val( ids );
		//$('#txt_selected_po').val( txt_po_id );
		//parent.emailwindow.hide();
	}
    </script>

</head>

<body>
<div align="center" style="width:100%;" >
 <? echo load_freeze_divs ("../../../",$permission);  ?>
<fieldset>
    <form autocomplete="off">
    <input style="width:60px;" type="hidden" class="text_boxes"  name="terms_breck_down" id="terms_breck_down" />
    <input style="width:60px;" type="hidden" class="text_boxes"  name="txt_pre_cost_dtls_id" id="txt_pre_cost_dtls_id" />
    <table width="400" class="rpt_table" border="1" rules="all">
        <thead>
            <th width="40">SL</th>
            <th>Terms</th>
        </thead>
        <tbody>
			<?
            $i=1;
            $data_array=sql_select("select id, terms from  lib_terms_condition where is_default=0 and page_id=108");// quotation_id='$data'
            foreach( $data_array as $row )
            {
				if ($i%2==0)  $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
				?>
				<tr style="text-decoration:none; cursor:pointer" bgcolor="<?=$bgcolor; ?>" id="search<?=$i; ?>" onClick="js_set_value(<?=$i ;?>,'<?=$row[csf('id')];?>','<?=$row[csf('terms')]; ?>');">
                    <td width="40"><? echo $i;?></td>
                    <td><?=$row[csf('terms')]; ?></td>
				</tr>
				<?
				$i++;
			}
            ?>
            </tbody>
    </table>
    <table width="400" class="rpt_table" border="1" rules="all">
        <tr>
            <td align="center"  class="button_container" colspan="2">
                <input type="button" class="formbutton" value="Close" onClick="parent.emailwindow.hide();"/>
            </td>
        </tr>
    </table>
    </form>
</fieldset>
</div>
</body>
<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
</html>
<?
exit();
}

if($action=="shipping_mark_popup")
{
	echo load_html_head_contents("Shipping Mark ","../../../", 1, 1, $unicode);
	extract($_REQUEST);
?>
	<script>
	function js_set_value()
	{
		var shippingmark_breck_down=$('#txt_company_name').val()+'~!~'+$('#txt_address').val()+'~!~'+$('#txt_phone').val()+'~!~'+$('#txt_pax').val()+'~!~'+$('#txt_mail').val()+'~!~'+$('#txt_web').val();
		var shippingmark_breck_down=shippingmark_breck_down.replace(/[ $ & () * ' " \r \n ]/g, '');//replace(/&()'"*<>{}/g,'');
		document.getElementById('hiddshippingmark_breck_down').value=shippingmark_breck_down;
		parent.emailwindow.hide();
	}
    </script>
    </head>
    
    <body>
    <div align="center" style="width:100%;" >
    <div style="display:none"><?=load_freeze_divs ("../../../",$permission); ?></div>
	<? 
	//echo $shippingmark_breck_down;
		if($shippingmark_breck_down=="")
		{
			$compnay_id=$compnay_id;
			$country_full_name = return_library_array("SELECT id,country_name from lib_country", "id", "country_name");
			
			$sqlCom="select company_name, email, website, plot_no, level_no, road_no, block_no, country_id, province, city, zip_code, contact_no from lib_company where id='$compnay_id' and status_active=1 and is_deleted=0";
			$sqlComRes=sql_select($sqlCom);
			$comName=$comAdd=$comPhone=$comPax=$comEmail=$comWeb="";
			foreach( $sqlComRes as $row)
			{
				$comName=$row[csf("company_name")];
				
				if($row[csf("level_no")])		$level_no 	= $row[csf("level_no")].', ';
				if($row[csf("plot_no")])		$plot_no 	=$row[csf("plot_no")].', ';
				if($row[csf("road_no")]) 		$road_no 	=$row[csf("road_no")].', ';
				if($row[csf("block_no")]!='')	$block_no 	=$row[csf("block_no")].', ';
				if($row[csf("zip_code")]!='')	$zip_code 	= ' -'.$row[csf("zip_code")].' , ';
				if($row[csf("city")]!='') 		$city 		= ($zip_code!="")?$row[csf("city")]:$row[csf("city")]." ,";
				if($row[csf("country_id")]!='')	$country 	= $country_full_name[$row[csf("country_id")]].'.';
				
				$comAdd=$level_no.$plot_no.$road_no.$block_no.$city.$zip_code.$country;
				$comPhone=$row[csf("contact_no")];
				$comEmail=$row[csf("email")];
				$comWeb=$row[csf("website")];
			}
			$shippingmark_breck_down=$comName.'~!~'.$comAdd.'~!~'.$comPhone.'~!~'.$comPax.'~!~'.$comEmail.'~!~'.$comWeb;
		}
		$data=explode("~!~",$shippingmark_breck_down); 
    ?>
    <fieldset>
        <form autocomplete="off">
        <input style="width:60px;" type="hidden" class="text_boxes" name="hiddshippingmark_breck_down" id="hiddshippingmark_breck_down" />
            <table width="400" class="rpt_table" border="1" rules="all">
                <thead>
                    <th>Shipping Marks [One Side]</th>
                </thead>
                <tr>
                    <td><input style="width:380px;" type="text" class="text_boxes" name="txt_company_name" id="txt_company_name" value="<?=$data[0]; ?>" placeholder="Company Name" /></td>
                </tr>
                <tr>
                    <td><input style="width:380px;" type="text" class="text_boxes" name="txt_address" id="txt_address" value="<?=$data[1]; ?>" placeholder="Address" /></td>
                </tr>
                <tr>
                    <td><input style="width:380px;" type="text" class="text_boxes" name="txt_phone" id="txt_phone" value="<?=$data[2]; ?>" placeholder="Phone" /></td>
                </tr>
                <tr>
                    <td><input style="width:380px;" type="text" class="text_boxes" name="txt_pax" id="txt_pax" value="<?=$data[3]; ?>" placeholder="Pax" /></td>
                </tr>
                <tr>
                    <td><input style="width:380px;" type="text" class="text_boxes" name="txt_mail" id="txt_mail" value="<?=$data[4]; ?>" placeholder="Mail" /></td>
                </tr>
                <tr>
                    <td><input style="width:380px;" type="text" class="text_boxes" name="txt_web" id="txt_web" value="<?=$data[5]; ?>" placeholder="Web" /></td>
                </tr>
                <tr>
                    <td align="center"  class="button_container">
                    	<input type="button" class="formbutton" value="Close" onClick="js_set_value();"/>
                    </td>
                </tr>
            </table>
        </form>
    </fieldset>
    </div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
	exit();
}

if($action=="rmg_process_loss_popup")
{
	echo load_html_head_contents("Order Search","../../../", 1, 1, $unicode);
	extract($_REQUEST);
?>
	<script>
	function js_set_value_set()
	{
		var cutting_per=$('#cutting_per').val();
		if(cutting_per=="") cutting_per=0;
		
		var embbroidery_per=$('#embbroidery_per').val();
		if(embbroidery_per=="") embbroidery_per=0;
		
		var printing_per=$('#printing_per').val();
		if(printing_per=="") printing_per=0;
		
		var wash_per=$('#wash_per').val();
		if(wash_per=="") wash_per=0;
		
		var sew_per=$('#sew_per').val();
		if(sew_per=="") sew_per=0;
		
		var fin_per=$('#fin_per').val();
		if(fin_per=="") fin_per=0;
		
		var knitt_per=$('#knitt_per').val();
		if(knitt_per=="") knitt_per=0;
		
		var dying_per=$('#dying_per').val();
		if(dying_per=="") dying_per=0;
		
		var extracutt_per=$('#extracutt_per').val();
		if(extracutt_per=="") extracutt_per=0;
		
		var other_per=$('#other_per').val();
		if(other_per=="") other_per=0;
		
		var neck_sleev_printing_per=$('#neck_sleev_printing_per').val();
		if(neck_sleev_printing_per=="") neck_sleev_printing_per=0;
		
		var gmt_other_per=$('#gmt_other_per').val();
		if(gmt_other_per=="") gmt_other_per=0;
		
		var yarn_dyeing_per=$('#yarn_dyeing_per').val();
		if(yarn_dyeing_per=="") yarn_dyeing_per=0;
		
		var all_over_print_per=$('#all_over_print_per').val();
		if(all_over_print_per=="") all_over_print_per=0;
		
		var lay_wash_per=$('#lay_wash_per').val();
		if(lay_wash_per=="") lay_wash_per=0;
		
		var gmtfinish_per=$('#gmtfinish_per').val();
		if(gmtfinish_per=="") gmtfinish_per=0;
		
		var processloss_breck_down=cutting_per+'_'+embbroidery_per+'_'+printing_per+'_'+wash_per+'_'+sew_per+'_'+fin_per+'_'+knitt_per+'_'+dying_per+'_'+extracutt_per+'_'+other_per+'_'+neck_sleev_printing_per+'_'+gmt_other_per+'_'+yarn_dyeing_per+'_'+all_over_print_per+'_'+lay_wash_per+'_'+gmtfinish_per;
		document.getElementById('processloss_breck_down').value=processloss_breck_down;
		parent.emailwindow.hide();
	}
    </script>
    </head>
    
    <body>
    <div align="center" style="width:100%;" >
     <? echo load_freeze_divs ("../../../",$permission);
     $data=explode("_",$processloss_breck_down);
     ?>
    <fieldset>
        <form autocomplete="off">
        <input style="width:60px;" type="hidden" class="text_boxes"  name="processloss_breck_down" id="processloss_breck_down" />
            <table width="180" class="rpt_table" border="1" rules="all">
                <tr>
                    <td width="130"> Cut Panel rejection <!--  Extra Cutting %  breack Down 8--></td>
                    <td><input style="width:60px;" type="text" class="text_boxes_numeric" name="extracutt_per" id="extracutt_per" value="<?=$data[8]; ?>" /></td>
                </tr>
                <tr>
                    <td width="130">Chest Printing <!-- Printing % breack Down 2--></td>
                    <td><input style="width:60px;" type="text" class="text_boxes_numeric" name="printing_per" id="printing_per" value="<?=$data[2]; ?>" /></td>
                </tr>
                <tr>
                    <td width="130">Neck/Sleeve Printing <!-- new breack Down 10--></td>
                    <td><input style="width:60px;" type="text" class="text_boxes_numeric" name="neck_sleev_printing_per" id="neck_sleev_printing_per" value="<?=$data[10]; ?>" /></td>
                </tr>
                <tr>
                    <td width="130">Embroidery  <!-- Embroidery  % breack Down 1--></td>
                    <td><input style="width:60px;" type="text" class="text_boxes_numeric" name="embbroidery_per" id="embbroidery_per" value="<?=$data[1]; ?>" /></td>
                </tr>
                <tr>
                    <td width="130">Sewing/Input <!-- Sewing % breack Down 4--></td>
                    <td><input style="width:60px;" type="text" class="text_boxes_numeric" name="sew_per" id="sew_per" value="<?=$data[4]; ?>" /></td>
                </tr>
                <tr>
                    <td width="130">Garments Wash  <!-- Washing % breack Down 3--></td>
                    <td><input style="width:60px;" type="text" class="text_boxes_numeric" name="wash_per" id="wash_per" value="<?=$data[3]; ?>" /></td>
                </tr>
                <tr>
                    <td width="130">Gmts Finishing  <!-- Washing % breack Down 3--></td>
                    <td><input style="width:60px;" type="text" class="text_boxes_numeric" name="gmtfinish_per" id="gmtfinish_per" value="<?=$data[15]; ?>" /></td>
                </tr>
                <tr>
                    <td width="130">Others  <!-- New breack Down 11--></td>
                    <td><input style="width:60px;" type="text" class="text_boxes_numeric" name="gmt_other_per" id="gmt_other_per" value="<?=$data[11]; ?>" /></td>
                </tr>
                <tr>
                    <td width="130">Knitting   <!-- Knitting % breack Down 6--></td>
                    <td><input style="width:60px;" type="text" class="text_boxes_numeric" name="knitt_per" id="knitt_per" value="<?=$data[6]; ?>" /></td>
                </tr>
                <tr>
                    <td width="130">Yarn Dyeing   <!-- New breack Down 12--></td>
                    <td><input style="width:60px;" type="text" class="text_boxes_numeric" name="yarn_dyeing_per" id="yarn_dyeing_per" value="<?=$data[12]; ?>" /></td>
                </tr>
                <tr>
                    <td width="130">Dyeing & Finishing   <!-- Finishing % breack Down 5--></td>
                    <td><input style="width:60px;" type="text" class="text_boxes_numeric" name="fin_per" id="fin_per" value="<?=$data[5]; ?>" /></td>
                </tr>
                <tr>
                    <td width="130">All Over Print  <!-- New breack Down 13--></td>
                    <td><input style="width:60px;" type="text" class="text_boxes_numeric" name="all_over_print_per" id="all_over_print_per" value="<?=$data[13]; ?>" /></td>
                </tr>
                <tr>
                    <td width="130">Lay Wash (Fabric)  <!-- New breack Down 14--></td>
                    <td><input style="width:60px;" type="text" class="text_boxes_numeric" name="lay_wash_per" id="lay_wash_per" value="<?=$data[14]; ?>" /></td>
                </tr>
                <tr>
                    <td width="130">Dying  <!--breack Down 7--></td>
                    <td><input style="width:60px;" type="text" class="text_boxes_numeric"  name="dying_per" id="dying_per" value="<?=$data[7]; ?>" /></td>
                </tr>
                <tr>
                    <td width="130">Cutting (Febric) <!-- Cutting % breack Down 0--></td>
                    <td><input style="width:60px;" type="text" class="text_boxes_numeric"  name="cutting_per" id="cutting_per" value="<?=$data[0]; ?>" /></td>
                </tr>
                <tr>
                    <td width="130">Others <!--breack Down 9--></td>
                    <td><input style="width:60px;" type="text" class="text_boxes_numeric"  name="other_per" id="other_per" value="<?=$data[9]; ?>" /></td>
                </tr>
                <tr>
                    <td align="center"  class="button_container" colspan="2">
                    	<input type="button" class="formbutton" value="Close" onClick="js_set_value_set();"/>
                    </td>
                </tr>
            </table>
        </form>
    </fieldset>
    </div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
	exit();
}

if($action=="load_color_size_form")
{
	$color_library=return_library_array( "select id,color_name from lib_color", "id", "color_name");
	$size_library=return_library_array( "select id,size_name from lib_size", "id", "size_name");
	$data=explode("**",$data);
	$fabric_cost_id=trim($data[0]);
	$booking_no=trim($data[1]);
	$cbo_level=trim($data[3]);
	$permission=$_SESSION['page_permission'];
	//echo $permission.'PP';
	$job_no="";
	$bodyPart=0;
	$body_part_type=0;
	$sql=sql_select("select a.job_no,a.body_part_id,b.body_part_type from wo_pre_cost_fabric_cost_dtls a, lib_body_part b   where a.body_part_id=b.id and  a.id='$fabric_cost_id' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0");
	foreach($sql as $row){
		$job_no=$row[csf('job_no')];
	    $bodyPart=$row[csf('body_part_id')];
		$body_part_type=$row[csf('body_part_type')];
	}
	$book_data=array();
	 $sql="select id,booking_no,job_no,po_break_down_id, pre_cost_fabric_cost_dtls_id, gmts_color_id, size_number_id, item_size,gmts_qty,excess_per,qty  from wo_booking_colar_culff_dtls where booking_no ='$booking_no' and pre_cost_fabric_cost_dtls_id= '$fabric_cost_id' and status_active=1 and is_deleted=0 ";
	$sql_data=sql_select($sql);

	foreach($sql_data as $sql_data_row){
		$book_data[$sql_data_row[csf('po_break_down_id')]][$sql_data_row[csf('gmts_color_id')]][$sql_data_row[csf('size_number_id')]]['gmts_qty']=$sql_data_row[csf('gmts_qty')];
		$book_data[$sql_data_row[csf('po_break_down_id')]][$sql_data_row[csf('gmts_color_id')]][$sql_data_row[csf('size_number_id')]]['excess_per']=$sql_data_row[csf('excess_per')];
	   $book_data[$sql_data_row[csf('po_break_down_id')]][$sql_data_row[csf('gmts_color_id')]][$sql_data_row[csf('size_number_id')]]['qty']=$sql_data_row[csf('qty')];
	   $book_data[$sql_data_row[csf('po_break_down_id')]][$sql_data_row[csf('gmts_color_id')]][$sql_data_row[csf('size_number_id')]]['dtls_id']=$sql_data_row[csf('id')];


	}
	 $sql="select e.colar_excess_percent,e.cuff_excess_percent,e.item_size,e.body_part_id,e.po_break_down_id,f.size_number_id,f.color_number_id,f.color_order,f.size_order,sum(f.plan_cut_qnty) as plan_cut_qnty,g.po_number from wo_po_color_size_breakdown f join (select a.colar_excess_percent,a.cuff_excess_percent,b.job_no,b.po_break_down_id,c.id, c.body_part_id,c.color_type_id ,c.fabric_description ,c.gsm_weight,d.color_number_id,d.gmts_sizes ,d.dia_width,d.item_size from wo_booking_mst a,wo_booking_dtls b,wo_pre_cost_fabric_cost_dtls c, wo_pre_cos_fab_co_avg_con_dtls d where a.booking_no=b.booking_no and b.job_no=c.job_no and b.pre_cost_fabric_cost_dtls_id=c.id and c.id=d.pre_cost_fabric_cost_dtls_id and b.po_break_down_id=d.po_break_down_id and d.color_number_id=b.gmts_color_id and d.dia_width=b.dia_width  and c.id = '$fabric_cost_id' and a.booking_no='$booking_no' and b.is_deleted=0 and b.status_active=1 and c.is_deleted=0 and c.status_active=1) e on e.job_no=f.job_no_mst and e.po_break_down_id=f.po_break_down_id and e.color_number_id=f.color_number_id and e.gmts_sizes=f.size_number_id and f.status_active=1 and f.is_deleted=0 join wo_po_break_down g on g.id=f.po_break_down_id and g.job_no_mst=f.job_no_mst group by e.colar_excess_percent,e.cuff_excess_percent,e.item_size,e.body_part_id,e.po_break_down_id,f.size_number_id,f.color_number_id,f.color_order,f.size_order,g.po_number  order by f.color_order,f.size_order";
	$sqldata=sql_select($sql);
		?>
        <input style="width:125px;" type="hidden" class="text_boxes"  name="txt_body_part" id="txt_body_part" value="<? echo $bodyPart;  ?>" />
        <input style="width:125px;" type="hidden" class="text_boxes"  name="txt_job" id="txt_job" value="<? echo $job_no;  ?>" />

            <table width="550" class="rpt_table" border="1" rules="all" id="colar_cuff_tbl">
                <thead>
                    <tr>
                        <th width="130">PO Number</th>
                        <th>Gmts Color</th>
                        <th>Gmts Size</th>
                        <th>Item Size</th>
                        <th>Gmts Qty (Pcs)</th>
                        <th>Excess %</th>
                        <th><? echo $body_part[$bodyPart]; ?> Qty (Pcs)</th>
                    </tr>
                </thead>
                <tbody>
            <?
			    $i=1;
				$gmt_tot_pcs=0;
				$gmt_tot = 0;
				foreach($sqldata as $row){
					$excess_per=0;
					if($row[csf('body_part_id')]==2){
						$excess_per=$row[csf('colar_excess_percent')];
					}
					if($row[csf('body_part_id')]==3){
						$excess_per=$row[csf('cuff_excess_percent')];
					}
					$gmts_qty=$row[csf('plan_cut_qnty')];
					//$totQtyPcs+=$gmts_qty;
					$qty=0;
					if($body_part_type==50){
						$qty=$gmts_qty*2;
					}else{
						$qty=$gmts_qty*1;
					}

					//$totQty+=$qty;
					
			?>
                <tr>
                <td width="130">
                 <input style="width:125px;" type="text" class="text_boxes"  name="po_number_<? echo $i ?>" id="po_number_<? echo $i ?>" value="<? echo $row[csf('po_number')]; ?>" readonly />
				 <? $dtls_id=$book_data[$row[csf('po_break_down_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['dtls_id'];?>
                 <input style="width:60px;" type="hidden" class="text_boxes"  name="po_id_<? echo $i ?>" id="po_id_<? echo $i ?>" value="<? echo $row[csf('po_break_down_id')];  ?>"  /> <input style="width:30px;" type="hidden" class="text_boxes"  name="update_dtls_id_<? echo $i ?>" id="update_dtls_id_<? echo $i ?>" value="<? echo $dtls_id;  ?>"  />
				  <input style="width:30px;" type="hidden" class="text_boxes"  name="body_part_type_id_<? echo $i ?>" id="body_part_type_id_<? echo $i ?>" value="<? echo $body_part_type;  ?>"  />
                </td>
                <td>
               <input style="width:60px;" type="text" class="text_boxes"  name="color_number_<? echo $i ?>" id="color_number_<? echo $i ?>" value="<? echo $color_library[$row[csf('color_number_id')]];  ?>" readonly />
                 <input style="width:60px;" type="hidden" class="text_boxes"  name="color_id_<? echo $i ?>" id="color_id_<? echo $i ?>" value="<? echo $row[csf('color_number_id')];  ?>" readonly  />
                </td>
                <td>
               	<input style="width:60px;" type="text" class="text_boxes"  name="size_number_<? echo $i ?>" id="size_number_<? echo $i ?>" value="<? echo $size_library[$row[csf('size_number_id')]];  ?>" readonly />
                 <input style="width:60px;" type="hidden" class="text_boxes"  name="size_id_<? echo $i ?>" id="size_id_<? echo $i ?>" value="<? echo $row[csf('size_number_id')];  ?>"  />
                </td>
                 <td>
               <input style="width:60px;" type="text" class="text_boxes"  name="item_size_<? echo $i ?>" id="item_size_<? echo $i ?>" value="<? echo $row[csf('item_size')];  ?>"  readonly/>
                </td>
                <td>
                <input style="width:60px;" type="text" class="text_boxes_numeric"  name="gmts_qty_<? echo $i ?>" id="gmts_qty_<? echo $i ?>"  onChange="calculate_qty(<? echo $i; ?>,<? echo $body_part_type ?>)" value="<? if($book_data[$row[csf('po_break_down_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['gmts_qty']){echo $book_data[$row[csf('po_break_down_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['gmts_qty'];}else{ echo $gmts_qty;} ?>"  />
                </td>
                 <td>
                <input style="width:60px;" type="text" class="text_boxes_numeric"  name="excess_per_<? echo $i ?>" id="excess_per_<? echo $i ?>"  onChange="calculate_qty(<? echo $i; ?>,<? echo $body_part_type ?>);copy_value(<? echo $i; ?>,'excessper')" value="<? if( $book_data[$row[csf('po_break_down_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['excess_per']){echo $book_data[$row[csf('po_break_down_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['excess_per'];} else{echo $excess_per;;}?>"  />
                </td>
                <td>

                <input style="width:60px;" type="text" class="text_boxes_numeric"  name="qty_<? echo $i ?>" id="qty_<? echo $i ?>" value="<? if($book_data[$row[csf('po_break_down_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['qty']){echo $book_data[$row[csf('po_break_down_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['qty'];}else{echo $qty;} ?>"  readonly />
                </td>
                </tr>

                <?
				$i++;
				$gmt_tot_pcs+=$book_data[$row[csf('po_break_down_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['gmts_qty'];
				$gmt_tot+=$book_data[$row[csf('po_break_down_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['qty'];;
				if($dtls_id>0) $button_id=1;else $button_id=0;
				}
				//echo $button_id.'AAAAAAAAAAAA';
				?>
                </tbody>
				<tfoot>
					<th colspan="4">Total</th>
					<th style="text-align:center"><input type="text" name="txtTotQtyPcs" id="txtTotQtyPcs" class="text_boxes_numeric" style="width:60px" value=" <? echo $gmt_tot_pcs; ?>" disabled/></th>
					<th></th>
					<th style="text-align:center"><input type="text" name="txtTotQty" id="txtTotQty" class="text_boxes_numeric" style="width:60px" value="<? echo $gmt_tot_pcs; ?>" disabled/></th>							
				</tfoot>
                </table>
                <table>
                <tr>
                <td align="center"  class="button_container" colspan="7">
              <?
			  if(count($sql_data)>0)
			  {
				 echo load_submit_buttons( $permission, "fnc_colar_culff_dtls", 1,0,"",2);
			  }
			  else
			  {
			  	echo load_submit_buttons( $permission, "fnc_colar_culff_dtls", 0,0,"",2);
			  }
			   ?>
                </td>
                </tr>
            </table>
        <?
		exit();
}

if($action=='save_update_delete_colar_culff_dtls')
{

	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));

	if ($operation==0)  //Insert Here
	{
		 $con = connect();
		 if($db_type==0)
		 {
			mysql_query("BEGIN");
		 }

		 $booking=trim(str_replace("'", '', $booking_no));

		 $id=return_next_id( "id", "wo_booking_colar_culff_dtls",1);
		 $field_array="id,booking_no,job_no,po_break_down_id, pre_cost_fabric_cost_dtls_id, gmts_color_id, size_number_id, item_size,gmts_qty,excess_per,qty,inserted_by,insert_date";
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $po_id="po_id_".$i;
			 $color_id="color_id_".$i;
			 $size_id="size_id_".$i;
			 $item_size="item_size_".$i;
			 $gmts_qty="gmts_qty_".$i;
			 $excess_per="excess_per_".$i;
			 $qty="qty_".$i;
			 $update_dtls_id="update_dtls_id_".$i;
			if ($i!=1) $data_array .=",";
			$data_array .="(".$id.",'".trim($booking)."',".$txt_job.",".$$po_id.",".$cbo_fabric_part.",".$$color_id.",".$$size_id.",".$$item_size.",".$$gmts_qty.",".$$excess_per.",".$$qty.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."')";
			$id=$id+1;
		 }
		 		// echo "10**insert into wo_booking_colar_culff_dtls (".$field_array.") values ".$data_array; die;
		$rID1=execute_query( "update  wo_booking_colar_culff_dtls set status_active=0,is_deleted=1  where  pre_cost_fabric_cost_dtls_id =$cbo_fabric_part",1);

		 $rID=sql_insert("wo_booking_colar_culff_dtls",$field_array,$data_array,0);
		 //echo "insert into wo_booking_colar_culff_dtls (".$field_array.") values ".$data_array;
		if($db_type==0)
		{
			if($rID)
			{
				mysql_query("COMMIT");
				echo "0**".$booking_no."**".$rID;
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "10**".$booking_no."**".$rID;
			}
		}

		if($db_type==2 || $db_type==1 )
		{
			if($rID)
			{
				oci_commit($con);
				echo "0**".$booking_no."**".$rID;
			}
			else
			{
				oci_rollback($con);
				echo "10**".$booking_no."**".$rID;
			}
		}
		disconnect($con);
		die;
	}

	else if ($operation==1)   // Update Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		 $booking=trim(str_replace("'", '', $booking_no));
		 $is_approved=0;
		$sql=sql_select("select is_approved from wo_booking_mst where booking_no=$booking_no");
		foreach($sql as $row){
			if($row[csf('is_approved')]==3){
				$is_approved=1;
			}else{
				$is_approved=$row[csf('is_approved')];
			}
		}
		if($is_approved==1){
			echo "approved**".str_replace("'","",$txt_booking_no);
		disconnect($con);	die;
		}
		 $id=return_next_id( "id", "wo_booking_colar_culff_dtls",1);
		$field_array_up="job_no*po_break_down_id*pre_cost_fabric_cost_dtls_id*gmts_color_id*size_number_id*item_size*gmts_qty*excess_per*qty*updated_by*update_date*status_active*is_deleted";
		$field_array="id,booking_no,job_no,po_break_down_id, pre_cost_fabric_cost_dtls_id, gmts_color_id, size_number_id, item_size,gmts_qty,excess_per,qty,inserted_by,insert_date";
			$new_data =1;
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $po_id="po_id_".$i;
			 $color_id="color_id_".$i;
			 $size_id="size_id_".$i;
			 $item_size="item_size_".$i;
			 $gmts_qty="gmts_qty_".$i;
			 $excess_per="excess_per_".$i;
			 $qty="qty_".$i;
			 $update_dtls_id="update_dtls_id_".$i;
			 if(str_replace("'",'',$$update_dtls_id)>0)
			 {
				$updateID_array[]=str_replace("'",'',$$update_dtls_id);
				$data_array_up[str_replace("'",'',$$update_dtls_id)]=explode("*",("".$txt_job."*".$$po_id."*".$cbo_fabric_part."*".$$color_id."*".$$size_id."*".$$item_size."*".$$gmts_qty."*".$$excess_per."*".$$qty."*'".$_SESSION['logic_erp']['user_id']."'*'".$pc_date_time."'*1*0"));
			}
			else
			{
				if ($new_data!=1) $data_array .=",";
				$data_array .="(".$id.",'".trim($booking)."',".$txt_job.",".$$po_id.",".$cbo_fabric_part.",".$$color_id.",".$$size_id.",".$$item_size.",".$$gmts_qty.",".$$excess_per.",".$$qty.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."')";
				$id=$id+1;
				$new_data++;
			}
		 }
		 $flag=1;
		 if(count($data_array_up)>0){
		 	$rID=execute_query(bulk_update_sql_statement("wo_booking_colar_culff_dtls","id",$field_array_up,$data_array_up,$updateID_array),1);
		 	if($rID) $flag=1; else $flag=0;
		 }
		 
		 if($data_array!='')
		 {
		  $rID1=sql_insert("wo_booking_colar_culff_dtls",$field_array,$data_array,0);
		  if($rID1) $flag=1; else $flag=0;
		  //echo "10** Insert into wo_booking_colar_culff_dtls ($field_array) values $data_array"; die;
		  if($flag==1)
			{
				if($rID1) $flag=1; else $flag=0;
			}
		 }

		//echo "10**".bulk_update_sql_statement("wo_booking_colar_culff_dtls","id",$field_array_up,$data_array_up,$updateID_array);die;

			//if($dtlsrID) $flag=1; else $flag=0;


	//============================================================================================

		if($db_type==0)
		{
			if($flag==1)
			{
				mysql_query("COMMIT");
				echo "1**".$booking."**".$flag;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$booking."**".$flag;
			}
		}

		if($db_type==2 || $db_type==1 )
		{
			if($flag==1)
			{
				oci_commit($con);
				echo "1**".$booking."**".$flag;
			}
			else{
				oci_rollback($con);
				echo "10**".$booking."**".$flag;
			}
		}
		disconnect($con);
		die;
	}
	else if ($operation==2)   // Delete Here
	{
		$con = connect();
		//$field_array="status_active*is_deleted";
		//$data_array="'2'*'1'";
		//$rID=sql_delete("wo_po_color_size_breakdown",$field_array,$data_array,"id","".$hiddenid."",1);
		 $is_approved=0;
		$sql=sql_select("select is_approved from wo_booking_mst where booking_no=$booking_no");
		foreach($sql as $row){
			if($row[csf('is_approved')]==3){
				$is_approved=1;
			}else{
				$is_approved=$row[csf('is_approved')];
			}
		}
		if($is_approved==1){
			echo "approved**".str_replace("'","",$txt_booking_no);
			disconnect($con);die;
		}
		$rID=execute_query( "update  wo_booking_colar_culff_dtls set status_active=0,is_deleted=1  where  pre_cost_fabric_cost_dtls_id =$cbo_fabric_part and job_no=".$txt_job." ",1);
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "2**".$txt_job."**".$rID;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$txt_job."**".$rID;
			}
		}

		if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "2**".$txt_job_no."**".$rID;
			}
			else{
				oci_rollback($con);
				echo "10**".$txt_job_no."**".$rID;
			}
		}
		disconnect($con);
		//echo "2****".$rID;
	}


}
if($action=="show_list_view")
{
	$FabricPart=array();
	$txt_booking_no=$data;
	$sql=sql_select("select b.job_no,b.po_break_down_id,c.id, c.body_part_id,c.color_type_id ,c.fabric_description ,c.gsm_weight from wo_booking_mst a,wo_booking_dtls b,wo_pre_cost_fabric_cost_dtls c,lib_body_part d where a.booking_no=b.booking_no and b.job_no=c.job_no and b.pre_cost_fabric_cost_dtls_id=c.id  and c.body_part_id=d.id  and a.booking_no='$txt_booking_no' and d.body_part_type in(40,50)  and c.is_deleted=0 and c.status_active=1 and d.is_deleted=0 and d.status_active=1");

	  foreach($sql as $row){
		  $FabricPart[$row[csf('id')]]=$body_part[$row[csf('body_part_id')]].', '.$color_type[$row[csf("color_type_id")]].', '.$row[csf("fabric_description")].', '.$row[csf("gsm_weight")];
	  }

	 $sql="select booking_no,job_no,pre_cost_fabric_cost_dtls_id,sum(gmts_qty) as gmts_qty,avg(excess_per) as excess_per,sum(qty) as qty  from wo_booking_colar_culff_dtls where booking_no ='$data' and status_active=1 and is_deleted=0 group by booking_no,job_no,pre_cost_fabric_cost_dtls_id";
	$sql_data=sql_select($sql);
	?>
	 <table width="550" class="rpt_table" border="1" rules="all">
            <thead>
            <tr>
                <th>
                Sl
                </th>
                <th>
                Job No
                </th>
                <th>
                Body Part
                </th>
                <th>
                Gmts Qty (Pcs)
                </th>
                <th>
                Excess %
                </th>
                <th>
                 Qty (Pcs)
                </th>
                </tr>
                </thead>
                <tbody>
                <?
				$i=1;
				foreach($sql_data as $row){
				?>
                <tr onClick="show_sub_form_with_data('<? echo $row[csf('booking_no')]  ?>','<? echo $row[csf('pre_cost_fabric_cost_dtls_id')] ?>');">
                <td>
               <? echo $i; ?>
                </td>
                <td>
                 <? echo $row[csf('job_no')]; ?>
                </td>
                <td>
                <? echo $FabricPart[$row[csf('pre_cost_fabric_cost_dtls_id')]];  ?>
                </td>
                <td align="right">
                 <? echo $row[csf('gmts_qty')]; 
				 $tot_gmt_qty+=$row[csf('gmts_qty')];
				 ?>
                </td>
                <td align="right">
                <? echo number_format($row[csf('excess_per')],2); ?>
                </td>
                <td align="right">
                 <? echo $row[csf('qty')]; 
				 $tot_qty+=$row[csf('qty')];
				 ?>
                </td>
                </tr>
                <?
				}
				?>
                </tbody>
				<tfoot>
					<tr>
					<td colspan="3" align="right">Total</td>
					<td align="right"><? echo $tot_gmt_qty; ?></td>
					<td align="right">&nbsp;</td>
					<td align="right"><? echo $tot_qty; ?></td>
					</tr>
				</tfoot>
                </table>
                <?


}

if($action == "check_booking_approved"){
	$is_approved=0;
	$sql=sql_select("select is_approved from wo_booking_mst where booking_no='$data'");
	foreach($sql as $row){
		if($row[csf('is_approved')]==3){
			$is_approved=1;
		}else{
			$is_approved=$row[csf('is_approved')];
		}
	}
	if($is_approved==1){
		echo "approved";
		disconnect($con);die;
	}
}

if($action=="colur_cuff_popup")
{
	echo load_html_head_contents("Order Search","../../../", 1, 1, $unicode);
	extract($_REQUEST);

 ?>

	<script>
var permission='<? echo $permission; ?>';

function show_sub_form()
{
show_list_view(document.getElementById('cbo_fabric_part').value+'**'+document.getElementById('booking_no').value+'**'+document.getElementById('cbo_level').value+'**'+<? echo "'$permission'";?>,'load_color_size_form','form_data_con','partial_fabric_booking_controller','');
}

function show_list()
{
	//echo $txt_booking_no.'fff';
	var booking_no='<? echo $txt_booking_no;?>';

	show_list_view(booking_no,'show_list_view','list_view_con','partial_fabric_booking_controller','');
}
function show_sub_form_with_data(booking_no,fabric_cost_id){
	document.getElementById('cbo_fabric_part').value=fabric_cost_id;
	document.getElementById('booking_no').value=booking_no;
	show_list_view(document.getElementById('cbo_fabric_part').value+'**'+document.getElementById('booking_no').value+'**'+'00'+'**'+<? echo "'$permissions'";?>,'load_color_size_form','form_data_con','partial_fabric_booking_controller','');
	set_button_status(1, permission, 'fnc_colar_culff_dtls',1);

}

function calculate_qty(i,body_part_type){
	var gmts_qty=(document.getElementById('gmts_qty_'+i).value)*1;
	var excess_per=(document.getElementById('excess_per_'+i).value)*1;
	var txt_body_part=(document.getElementById('txt_body_part').value)*1;
	var qty=0;
	/*if(txt_body_part==3){
		qty=gmts_qty*2
	}else{
		qty=gmts_qty*1;
	}*/
	body_part_type=body_part_type*1;
	if(body_part_type==50){
		qty=gmts_qty*2
	}else{
		qty=gmts_qty*1;
	}

	var excess=(qty*excess_per)/100;
	qty=Math.ceil(qty+excess);
	document.getElementById('qty_'+i).value=qty;
	calculate_tot_qnty();
}
function calculate_tot_qnty() {
			var rowCount=$('#colar_cuff_tbl tbody tr').length;
			var tot_gmtQty=0;
			var tot_gmtpartQty=0;
			for(var j=1; j<=rowCount; j++)
			{
					var gmtQty=$("#gmts_qty_"+j).val()*1;
					var gmtpartQty=$("#qty_"+j).val()*1;
					var tot_gmtQty=gmtQty+tot_gmtQty;
					var tot_gmtpartQty=gmtpartQty+tot_gmtpartQty;
			}
			//alert(tot_gmtpartQty);
			$('#txtTotQtyPcs').val(tot_gmtQty);
			$('#txtTotQty').val(tot_gmtpartQty);
		}

function fnc_colar_culff_dtls( operation ){
		freeze_window(operation);
		var delete_cause='';
		var booking_no=document.getElementById('booking_no').value;
		var booking=return_global_ajax_value(booking_no, 'check_booking_approved', '', 'partial_fabric_booking_controller');
		if(operation == 1 || operation == 2){
			if(booking == 'approved'){
				alert("This booking is approved So Update/Delete Not Possible");
				release_freezing();
				return;
			}
		}
		if(operation==2){
			delete_cause = prompt("Please enter your delete cause", "");
			if(delete_cause==""){
				alert("You have to enter a delete cause");
				release_freezing();
				return;
			}
			if(delete_cause==null){
				release_freezing();
				return;
			}
			var r=confirm("Press OK to Delete Or Press Cancel");
			if(r==false){
				release_freezing();
				return;
			}
		}

		var row_num=$('#colar_cuff_tbl tbody tr').length;
		//update_dtls_id_
		var data_all="";
		for (var i=1; i<=row_num; i++){
			data_all=data_all+get_submitted_data_string('cbo_fabric_part*booking_no*cbo_level*txt_body_part*txt_job*po_id_'+i+'*color_id_'+i+'*size_id_'+i+'*item_size_'+i+'*gmts_qty_'+i+'*excess_per_'+i+'*qty_'+i+'*update_dtls_id_'+i,"../../../",i);
		}
		//$('#txt_tot_row').val(row_num);
		var data="action=save_update_delete_colar_culff_dtls&operation="+operation+'&total_row='+row_num+data_all+"&delete_cause="+delete_cause;

		http.open("POST","partial_fabric_booking_controller.php",true);
		http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
		http.send(data);
		http.onreadystatechange = fnc_colar_culff_dtls_reponse;
	}

	function fnc_colar_culff_dtls_reponse(){
		if(http.readyState == 4){
			 var reponse=trim(http.responseText).split('**');
			 if(parseInt(trim(reponse[0]))==0 || parseInt(trim(reponse[0]))==1 || parseInt(trim(reponse[0]))==2){
				show_list();
				reset_form('','form_data_con','','');
				release_freezing();
				//show_msg(trim(reponse[0]));
			 }
			  if(parseInt(trim(reponse[0]))==0 || parseInt(trim(reponse[0]))==1){
			  	set_button_status(1, permission, 'fnc_colar_culff_dtls',1);
					release_freezing();
			 }
			 if(trim(reponse[0])=='approved'){
				 alert("This booking is approved So Update/Delete Not Possible");
				 release_freezing();
				 return;
			 }
			 if(trim(reponse[0])=='sal1'){
				 alert("Sales Order  found :"+trim(reponse[2])+"\n So Update/Delete Not Possible");
				 release_freezing();
				 return;
			 }
			 if(trim(reponse[0])=='pi1'){
				alert("PI Number Found :"+trim(reponse[2])+"\n So Update/Delete Not Possible")
				release_freezing();
				return;
			}
			if(trim(reponse[0])=='recv1'){
			alert("Receive Number Found :"+trim(reponse[2])+"\n So Delete Not Possible")
		    release_freezing();
		    return;
		    }
			 release_freezing();
		}
	}

	function copy_value(row_id,type)
	{
	 	var copy_val=document.getElementById('check_excess_id').checked;

		//alert(body_part_type_id);
		var rowCount=$('#colar_cuff_tbl tbody tr').length;
		if(copy_val==true)
		  {
		 // alert(rowCount);

		   	for(var j=row_id; j<=rowCount; j++)
		  	{
				  if(type=='excessper')
				  {

					 var body_part_type_id=document.getElementById('body_part_type_id_'+j).value*1;
					  var excess_per=(document.getElementById('excess_per_'+row_id).value)*1;
					  document.getElementById('excess_per_'+j).value=excess_per;
					  calculate_qty(j,body_part_type_id);

				  }
			 } //Loop End
		  }

	 }
    </script>

</head>

<body>
<div align="center" style="width:100%;" >
 <? echo load_freeze_divs ("../../../",$permission);  ?>
 <?
 //$sql="select a.id from lib_body_part a, wo_pre_cost_fabric_cost_dtls b ,wo_booking_dtls c   where a.id=b.body_part_id and b.job_no=c.job_no and b.id=c.pre_cost_fabric_cost_dtls_id   and a.body_part_type=40 and a.status_active=1 and a.is_deleted=0";
//echo  "select b.job_no,b.po_break_down_id,c.id, c.body_part_id,c.color_type_id ,c.fabric_description ,c.gsm_weight from wo_booking_mst a,wo_booking_dtls b,wo_pre_cost_fabric_cost_dtls c,lib_body_part d where a.booking_no=b.booking_no and b.job_no=c.job_no and b.pre_cost_fabric_cost_dtls_id=c.id and and c.body_part_id=d.id c.body_part_id in (2,3) and a.booking_no='$txt_booking_no' and d.body_part_type=40  and c.is_deleted=0 and c.status_active=1 and d.is_deleted=0 and d.status_active=1";
  $FabricPart=array();
  $sql=sql_select("select b.job_no,b.po_break_down_id,c.id, c.body_part_id,c.color_type_id ,c.fabric_description ,c.gsm_weight from wo_booking_mst a,wo_booking_dtls b,wo_pre_cost_fabric_cost_dtls c,lib_body_part d where a.booking_no=b.booking_no and b.job_no=c.job_no and b.pre_cost_fabric_cost_dtls_id=c.id  and c.body_part_id=d.id  and a.booking_no='$txt_booking_no' and d.body_part_type in(40,50) and c.is_deleted=0 and c.status_active=1 and d.is_deleted=0 and d.status_active=1");//and c.body_part_id in (2,3)
  foreach($sql as $row){
	  $FabricPart[$row[csf('id')]]=$body_part[$row[csf('body_part_id')]].', '.$color_type[$row[csf("color_type_id")]].', '.$row[csf("fabric_description")].', '.$row[csf("gsm_weight")];
  }
  if(count($FabricPart)==0){
	  echo "No Colar Or Cullf Found in this Booking";

	  die;
  }
 ?>
<fieldset>
    <form autocomplete="off">
        <table width="550" class="rpt_table" border="1" rules="all">
            <tr>
            <td>Body Part</td>
            <td>
            <?
            echo create_drop_down( "cbo_fabric_part", 400, $FabricPart,"", 1, "-- Select--", 0, "","","");
            ?>
			 <input style="width:40px;" type="checkbox" class="text_boxes"  name="check_excess_id" id="check_excess_id" checked="checked"  />

            <input style="width:60px;" type="hidden" class="text_boxes"  name="booking_no" id="booking_no" value="<? echo trim($txt_booking_no); ?> " />
			 <input style="width:60px;" type="hidden" class="text_boxes"  name="cbo_level" id="cbo_level" value="<? echo $cbo_level; ?> " />
            </td>
            <td><input type="button" class="formbutton" value="Show" onClick="show_sub_form()"/> </td>
            </tr>
        </table>

    <div id="form_data_con">
    </div>
    </form>
    <div id="list_view_con">
    </div>
</fieldset>
</div>
</body>
<script>
show_list('<? echo $txt_booking_no?>');
</script>
<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
</html>
<?
exit();
}

if($action=="save_update_delete_fabric_booking_terms_condition")
{
$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));

	if ($operation==0)  // Insert Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0"; disconnect($con);die;}
		 $id=return_next_id( "id", "wo_booking_terms_condition", 1 ) ;
		 $field_array="id,booking_no,terms";
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $termscondition="termscondition_".$i;
			if ($i!=1) $data_array .=",";
			$data_array .="(".$id.",".$txt_booking_no.",".$$termscondition.")";
			$id=$id+1;
		 }
		// echo  $data_array;
		$rID_de3=execute_query( "delete from wo_booking_terms_condition where  booking_no =".$txt_booking_no."",0);

		 $rID=sql_insert("wo_booking_terms_condition",$field_array,$data_array,1);
		 check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "0**".$new_booking_no[0];
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_booking_no[0];
			}
		}

		if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "0**".$new_booking_no[0];
			}
			else{
				oci_rollback($con);
				echo "10**".$new_booking_no[0];
			}
		}
		disconnect($con);
		die;
	}
}

if($action=="show_fabric_booking_report_urmi"){
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$company_library=return_library_array( "select id,company_name from lib_company", "id", "company_name");
	$color_library=return_library_array( "select id,color_name from lib_color", "id", "color_name");
	$size_library=return_library_array( "select id,size_name from lib_size", "id", "size_name");
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	//$supplier_address_arr=return_library_array( "select id,address_1 from   lib_supplier",'id','address_1');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$brand_name_arr=return_library_array( "select id,brand_name from lib_buyer_brand",'id','brand_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	//$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	//$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	$season_arr=return_library_array("select id,season_name from lib_buyer_season","id","season_name");

	$uom=0;
	$job_data_arr=array();
	$nameArray_buyer=sql_select( "select  a.style_ref_no,a.style_description, a.job_no, a.style_owner, a.buyer_name, a.client_id, a.dealing_marchant, a.season, a.season_matrix, a.total_set_qnty, a.product_dept, a.product_code, a.pro_sub_dep, a.gmts_item_id, a.order_repeat_no, a.qlty_label,a.season_buyer_wise from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0");
	foreach ($nameArray_buyer as $result_buy){
	$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
	$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
	$job_data_arr['total_set_qnty'][$result_buy[csf('job_no')]]=$result_buy[csf('total_set_qnty')];
	$job_data_arr['product_dept'][$result_buy[csf('job_no')]]=$product_dept[$result_buy[csf('product_dept')]];
	$job_data_arr['product_code'][$result_buy[csf('job_no')]]=$result_buy[csf('product_code')];
	$job_data_arr['pro_sub_dep'][$result_buy[csf('job_no')]]=$pro_sub_dept_array[$result_buy[csf('pro_sub_dep')]];
	$job_data_arr['gmts_item_id'][$result_buy[csf('job_no')]]=$result_buy[csf('gmts_item_id')];
	$job_data_arr['style_ref_no'][$result_buy[csf('job_no')]]=$result_buy[csf('style_ref_no')];
	$job_data_arr['style_description'][$result_buy[csf('job_no')]]=$result_buy[csf('style_description')];
	$job_data_arr['dealing_marchant'][$result_buy[csf('job_no')]]=$marchentrArr[$result_buy[csf('dealing_marchant')]];
	$job_data_arr['season_matrix'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_matrix')]];
	$job_data_arr['season_buyer_wise'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_buyer_wise')]];
	$job_data_arr['order_repeat_no'][$result_buy[csf('job_no')]]=$result_buy[csf('order_repeat_no')];
	$job_data_arr['qlty_label'][$result_buy[csf('job_no')]]=$quality_label[$result_buy[csf('qlty_label')]];
	$job_data_arr['client'][$result_buy[csf('job_no')]]=$result_buy[csf('client_id')];
	}

	$job_no= implode(",",array_unique($job_data_arr['job_no']));
	$job_no_in= implode(",",array_unique($job_data_arr['job_no_in']));
	$product_depertment=implode(",",array_unique($job_data_arr['product_dept']));
	$product_code=implode(",",array_unique($job_data_arr['product_code']));
	$pro_sub_dep=implode(",",array_unique($job_data_arr['pro_sub_dep']));
	$gmts_item_id=implode(",",array_unique($job_data_arr['gmts_item_id']));
	$style_sting=implode(",",array_unique($job_data_arr['style_ref_no']));
	$style_description=implode(",",array_unique($job_data_arr['style_description']));
	$dealing_marchant=implode(",",array_unique($job_data_arr['dealing_marchant']));
	$season_matrix=implode(",",array_unique($job_data_arr['season_matrix']));
	$season_buyer_wise=implode(",",array_unique($job_data_arr['season_buyer_wise']));
	$order_repeat_no= implode(",",array_unique($job_data_arr['order_repeat_no']));
	$qlty_label= implode(",",array_unique($job_data_arr['qlty_label']));
	$client_id= implode(",",array_unique($job_data_arr['client']));
	?>
	<div style="width:1330px" align="center">
	<?php
	$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and a.status_active =1 and a.is_deleted=0 ");
	list($nameArray_approved_row) = $nameArray_approved;
	$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0 ");
	list($nameArray_approved_date_row) = $nameArray_approved_date;
	$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0 ");
	list($nameArray_approved_comments_row) = $nameArray_approved_comments;
	$path = str_replace("'", "", $path);
	if ($path != "") {
		$path = $path;
	} else {
		$path = "../../";
	}
	ob_start();
	?>										<!--    Header Company Information         -->
	<style type="text/css">
		 .table_valign { vertical-align: top;word-break: break-all;word-wrap: break-word; }
	</style>
	<table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black"  >
	<tr>
	<td width="100">
	<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
	</td>
	<td width="1250">
	<table width="100%" cellpadding="0" cellspacing="0"  >
	<tr>
	<td align="center" style="font-size:20px;">
	<?php
	echo $company_library[$cbo_company_name];
	?>
	</td>
	<td rowspan="3" width="250">

	<span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($job_no,"'"); ?></b></span><br/>
	<?
	if($nameArray_approved_row[csf('approved_no')]>1)
	{
	?>
	<b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
	<br/>
	Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
	<?
	}
	?>


	</td>
	</tr>
	<tr>
	<td align="center" style="font-size:14px">
	<?
	$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
	if($txt_job_no!="")
	{
	$location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'");
	}
	else
	{
	$location="";
	}

	foreach ($nameArray as $result)
	{
	echo  $location_name_arr[$location];
	?>

	Email Address: <? echo $result[csf('email')];?>
	Website No: <? echo $result[csf('website')]; ?>

	<?

	}

	?>
	</td>
	</tr>
	<tr>
	<td align="center" style="font-size:20px">
	<strong><? if($report_title !=""){ echo $report_title;} else { echo "General Work Order";}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
	</td>
	</tr>
	</table>
	</td>
	</tr>
	</table>
	<?
	$po_data=array();
	if($db_type==0){
	$nameArray_job=sql_select( "select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,DATEDIFF(pub_shipment_date,po_received_date) date_diff,MIN(po_received_date) as po_received_date ,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status  from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0   group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
	}
	if($db_type==2){
	$nameArray_job=sql_select( "select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,(pub_shipment_date-po_received_date) date_diff,MIN(po_received_date) as po_received_date,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status   from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0  group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
	}
	foreach ($nameArray_job as $result_job){
		$po_data['po_id'][$result_job[csf('id')]]=$result_job[csf('id')];
		$po_data['po_number'][$result_job[csf('id')]]=$result_job[csf('po_number')];
		$po_data['leadtime'][$result_job[csf('id')]]=$result_job[csf('date_diff')];
		$po_data['po_quantity'][$result_job[csf('id')]]=$result_job[csf('po_quantity')];
		$po_data['po_received_date'][$result_job[csf('id')]]=change_date_format($result_job[csf('po_received_date')],'dd-mm-yyyy','-');
		$ddd=strtotime($result_job[csf('pub_shipment_date')]);
		$po_data['pub_shipment_date'][$ddd]=$ddd;
		$po_data['pub_shipment_date_po'][$result_job[csf('id')]]=$result_job[csf('pub_shipment_date')];
		
		$po_data['insert_date'][$result_job[csf('id')]]=$result_job[csf('insert_date')];

		if($result_job[csf('shiping_status')]==1){
		$shiping_status= "FP";
		}
		else if($result_job[csf('shiping_status')]==2){
		$shiping_status= "PS";
		}
		else if($result_job[csf('shiping_status')]==3){
		$shiping_status= "FS";
		}
		$po_data['shiping_status'][$result_job[csf('id')]]=$shiping_status;
		$po_data['file_no'][$result_job[csf('id')]]=$result_job[csf('file_no')];
		$po_data['grouping'][$result_job[csf('id')]]=$result_job[csf('grouping')];
	}
	$txt_order_no_id=implode(",",array_unique($po_data['po_id']));
	$leadtime=implode(",",array_unique($po_data['leadtime']));
	$po_quantity=array_sum($po_data['po_quantity']);
	$po_received_date=implode(",",array_unique($po_data['po_received_date']));
	$po_number=implode(",",array_unique($po_data['po_number']));
	$shipment_date=date('d-m-Y',min($po_data['pub_shipment_date']));
	$maxshipment_date=date('d-m-Y',max($po_data['pub_shipment_date']));
	$shiping_status=implode(",",array_unique($po_data['shiping_status']));
	$file_no=implode(",",array_unique($po_data['file_no']));
	$grouping=implode(",",array_unique($po_data['grouping']));



	$colar_excess_percent=0;
	$cuff_excess_percent=0;
	$rmg_process_breakdown=0;
	$nameArray=sql_select( "select a.buyer_id,a.brand_id,a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.update_date,a.uom,a.remarks,a.pay_mode,a.fabric_composition from wo_booking_mst a  where   a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 ");
	foreach ($nameArray as $result)
	{
		$brand_name=$result[csf('brand_id')];
		$total_set_qnty=$result[csf('total_set_qnty')];
		$colar_excess_percent=$result[csf('colar_excess_percent')];
		$cuff_excess_percent=$result[csf('cuff_excess_percent')];
		$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
		foreach ($po_data['po_id'] as $po_id=>$po_val){
			$daysInHand.=(datediff('d',date('d-m-Y',time()),$po_data['pub_shipment_date_po'][$po_id])-1).",";
			$booking_date=$result[csf('update_date')];
			if($booking_date=="" || $booking_date=="0000-00-00 00:00:00"){
			$booking_date=$result[csf('insert_date')];
			}
			$WOPreparedAfter.=(datediff('d',$po_data['insert_date'][$po_id],$booking_date)-1).",";
		}
	?>
	<table width="100%" style="border:1px solid black;table-layout: fixed;" id="table_h" >
	<tr>
	<td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
	</tr>
	<tr>
	<td width="200"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
	<td width="220">:&nbsp;<span style="font-size:18px"><b><? $buyer_name_str=""; if($client_id!=0) $buyer_name_str=$buyer_name_arr[$result[csf('buyer_id')]]."-".$buyer_name_arr[$client_id]; else $buyer_name_str=$buyer_name_arr[$result[csf('buyer_id')]]; echo $buyer_name_str; ?></b></span></td>
	<td width="200"><span style="font-size:12px"><b>Dept.</b></span></td>
	<td width="220">:&nbsp;
	<?
	echo $product_depertment ;
	if($product_code !=""){
	echo " (".$product_code.")";
	}
	if($pro_sub_dep != ""){
	echo " (".$pro_sub_dep.")";
	}
	?>
	</td>
	<td width="200"><span style="font-size:12px"><b>Order Qnty</b></span></td>
	<td>:&nbsp; <?  echo $po_quantity;//." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?> </td>
	</tr>
	<tr>

	<td style="font-size:12px"><b>Garments Item</b></td>
	<td>:&nbsp;
	<?
	$gmts_item_name="";
	$gmts_item=explode(',',$gmts_item_id);
	for($g=0;$g<=count($gmts_item); $g++)
	{
	$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
	}
	echo rtrim($gmts_item_name,',');
	?>
	</td>
	<td style="font-size:12px"><b>Booking Release Date</b></td>
	<td>:&nbsp;
	<?
	$booking_date=$result[csf('update_date')];
	if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
	{
	$booking_date=$result[csf('insert_date')];
	}
	echo change_date_format($booking_date,'dd-mm-yyyy','-','');
	?>&nbsp;&nbsp;&nbsp;</td>
	<td style="font-size:18px"><b>Style Ref.</b>   </td>
	<td style="font-size:18px">:&nbsp;<b>
	<?
	echo $style_sting;
	?>
	</b>
	</td>
	</tr>
	<tr>
	<td style="font-size:12px"><b>Style Des.</b></td>
	<td>:&nbsp;<? echo $style_description;?></td>
	<td style="font-size:12px"><b>Season</b></td>
	<td>:&nbsp;<?  if($season_matrix!="") echo $season_matrix; else echo $season_buyer_wise; ?></td>
	<td style="font-size:12px"><b>Dealing Merchant</b></td>
	<td>:&nbsp;<? echo $dealing_marchant; ?></td>
	</tr>

	<tr>
	<td style="font-size:12px"><b>Supplier Name</b>   </td>
	<td>:&nbsp;
	<?
	if($result[csf('pay_mode')]==5){
	echo $company_library[$result[csf('supplier_id')]];
	}
	else{
	echo $supplier_name_arr[$result[csf('supplier_id')]];
	}
	?>    </td>
	<td style="font-size:12px"><b>Delivery Date</b></td>
	<td>:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
	<td style="font-size:18px"><b>Booking No </b>   </td>
	<td style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?> <? //echo "(".$unit_of_measurement[$result[csf('uom')]].")"; $uom=$result[csf('uom')];?></td>
	</tr>
	<tr>
		<td  class="table_valign"><p><b>Attention</b></p></td>
		<td class="table_valign" ><p>:&nbsp;<? echo $result[csf('attention')]; ?></p></td>
		<td class="table_valign"><p><b>Lead Time </b> </p>  </td>
		<td class="table_valign"><p>:&nbsp;
			<?
			echo $leadtime;
			?> </p>
		</td>
		<td class="table_valign" ><p><b>Po Received Date</b></p></td>
		<td class="table_valign" width="150" ><p>:&nbsp;<? echo $po_received_date; ?></p></td>
	</tr>
	<tr>
		<td class="table_valign"><p><b>Order No</b></p></td>
		<td class="table_valign"><p>:&nbsp;<? echo $po_number; ?></p></td>
		<td class="table_valign"><p><b>Brand Name</b></p></td>
		<td class="table_valign"><p>:&nbsp;<? echo $brand_name_arr[$result[csf('brand_id')]]; ?></p></td>
		<td class="table_valign"><p><b>Repeat No</b></p></td>
		<td class="table_valign"><p>:&nbsp;<? echo $order_repeat_no; ?></p></td>
	</tr>
	<tr>
	<td style="font-size:12px"><b>Shipment Date</b></td>
	<td colspan="3" style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> : First:&nbsp;<? echo rtrim($shipment_date,", "); //echo $max_pub_shipment_date; ?>, Last: <? echo $maxshipment_date; ?></td>
	<td  style="font-size:12px"><b>Quality Label</b></td>
	<td  >:&nbsp;<? echo $qlty_label; ?></td>
	</tr>
	</tr>
	<tr>
	<td style="font-size:12px"><b>WO Prepared After</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
	<?
	$WOPreparedAfter=implode(",",array_unique(explode(",",chop($WOPreparedAfter,","))));
	echo $WOPreparedAfter.' Days' ;
	?></td>

	<td style="font-size:12px"><b>Ship.days in Hand</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
	<?
	$daysInHand=implode(",",array_unique(explode(",",chop($daysInHand,","))));
	echo $daysInHand.' Days' ;
	?></td>

	<td style="font-size:12px"><b>Ex-factory status</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
	<?
	echo $shiping_status;
	?></td>

	</tr>
	<tr>
	<td style="font-size:18px"><b>Internal Ref No</b></td>
	<td style="font-size:18px"> :&nbsp;<b><? echo $grouping; ?></b></td>
	<td style="font-size:18px"><b>File no</b></td>
	<td style="font-size:18px"> :&nbsp;<b><? echo  $file_no;?></b></td>
	<td style="font-size:18px"><b>Currency</b></td>
	<td style="font-size:18px"> :&nbsp;<b><? echo  $currency[$result[csf("currency_id")]];?></b></td>
	</tr>
	<tr>
	<td style="font-size:18px"><b>Rmarks</b></td>
	<td style="font-size:18px" colspan="5"> :<? echo $result[csf('remarks')]?></td>
	</tr>
	<tr>
	<td style="font-size:18px"><b>Fabric Composition</b></td>
	<td style="font-size:18px" colspan="5"> :<? echo $result[csf('fabric_composition')]?></td>
	</tr>

	</table>
	<?
	}

	if($cbo_fabric_source==1 || $cbo_fabric_source==2){
	$nameArray_size=sql_select( "select  size_number_id,min(id) as id,	min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  	is_deleted=0 and status_active!=0 group by size_number_id order by size_order");
	?>
	<table width="100%" >
	<tr>
	<td width="800">
	<div id="div_size_color_matrix" style="float:left; max-width:1000;">
	<fieldset id="div_size_color_matrix" style="max-width:1000;">
	<legend>Size and Color Breakdown</legend>
	<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
	<tr>
	<td style="border:1px solid black"><strong>Color/Size</strong></td>
	<td style="border:1px solid black; width:130px" align="center"><strong>Article No./Item Code</strong></td>
	<?
	foreach($nameArray_size  as $result_size)
	{	     ?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?	}    ?>
	<td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
	<td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
	<td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
	</tr>
	<?
	$color_size_order_qnty_array=array();
	$color_size_qnty_array=array();
	$size_tatal=array();
	$size_tatal_order=array();
	for($c=0;$c<count($gmts_item); $c++)
	{
	$item_size_tatal=array();
	$item_size_tatal_order=array();
	$item_grand_total=0;
	$item_grand_total_order=0;
	$nameArray_color=sql_select( "select listagg(article_number ,',') within group (order by article_number) as article_number,color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active!=0 group by color_number_id  order by color_order");
	 
	?>
	<tr>
	<td style="border:1px solid black" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>

	</tr>
	<?
	foreach($nameArray_color as $result_color)
	{
	?>
	<tr>
	<td align="center" style="border:1px solid black"><? echo $color_library[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
	<td align="center" style="border:1px solid black">
	<? 
		$article_nos=implode(",",array_unique(explode(",",$result_color[csf('article_number')])));
		echo $article_nos;
	?>
	</td>
	<?
	$color_total=0;
	$color_total_order=0;

	foreach($nameArray_size  as $result_size)
	{
	$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active!=0 and is_deleted =0");
	foreach($nameArray_color_size_qnty as $result_color_size_qnty)
	{
	?>
	<td style="border:1px solid black; text-align:right">
	<?
	if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
	{
	echo number_format($result_color_size_qnty[csf('order_quantity')],0);
	$color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
	$color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
	$item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
	$item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
	$grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
	$grand_total_order +=$result_color_size_qnty[csf('order_quantity')];




	$color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
	$color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
	if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
	{
	$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
	$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
	}
	else
	{
	$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
	$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
	}
	if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
	{
	$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
	$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
	}
	else
	{
	$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
	$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
	}
	}
	else echo "0";
	?>
	</td>

	<?
	}
	}
	?>
	<td style="border:1px solid black; text-align:right"><?  echo number_format(round($color_total_order),0); ?></td>

	<td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?>
	</td>
	<td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total),0); ?></td>
	</tr>
	<?
	}
	
	?>

	<td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
	<td></td>
	<?
	foreach($nameArray_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:right"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total_order),0); ?></td>
	<td  style="border:1px solid black;  text-align:right"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
	<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total),0); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td style="border:1px solid black" align="center" colspan="<? echo count($nameArray_size)+4; ?>"><strong>&nbsp;</strong></td>
	</tr>
	<tr>
	<tr>
	<td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
	<td></td>
	<?
	foreach($nameArray_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:right"><? echo $size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total_order),0); ?></td>
	<td  style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
	<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total),0); ?></td>
	</tr>
	</table>
	</fieldset>
	</div>
	</td>
	<td width="200" valign="top" align="left">
	<div id="div_size_color_matrix" style="float:left;">
	<?
	$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown);
	 
	?>
	<fieldset>
	<legend>RMG Process Loss % </legend>
	<table width="180" class="rpt_table" border="1" rules="all">
	<?
	if(number_format($rmg_process_breakdown_arr[8],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Cut Panel rejection <!-- Extra Cutting % breack Down 8-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[8],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[2],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Chest Printing <!-- Printing % breack Down 2-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[2],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[10],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Neck/Sleeve Printing <!-- New breack Down 10-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[10],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[1],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Embroidery   <!-- Embroidery  % breack Down 1-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[1],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[4],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Sewing /Input<!-- Sewing % breack Down 4-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[4],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[3],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Garments Wash <!-- Washing %breack Down 3-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[3],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[15],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Gmts Finishing <!-- Washing %breack Down 3-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[15],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[11],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Others <!-- New breack Down 11-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[11],2);
	?>
	</td>
	</tr>
	<?
	}
	$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
	if($gmts_pro_sub_tot>0)
	{
	?>
	<tr>
	<td width="130">
	Sub Total <!-- New breack Down 11-->
	</td>
	<td align="right">
	<?

	echo number_format($gmts_pro_sub_tot,2);
	?>
	</td>
	</tr>
	<?
	}
	?>
	</table>
	</fieldset>


	<fieldset>
	<legend>Fabric Process Loss % </legend>
	<table width="180" class="rpt_table" border="1" rules="all">
	<?
	if(number_format($rmg_process_breakdown_arr[6],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Knitting  <!--  Knitting % breack Down 6-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[6],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[12],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Yarn Dyeing  <!--  New breack Down 12-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[12],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[5],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Dyeing & Finishing  <!-- Finishing % breack Down 5-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[5],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[13],2)>0)
	{
	?>
	<tr>
	<td width="130">
	All Over Print <!-- new  breack Down 13-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[13],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[14],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Lay Wash (Fabric) <!-- new  breack Down 14-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[14],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[7],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Dying   <!-- breack Down 7-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[7],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[0],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Cutting (Fabric) <!-- Cutting % breack Down 0-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[0],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[9],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Others  <!-- Others% breack Down 9-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[9],2);
	?>
	</td>
	</tr>
	<?
	}
	$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
	if($fab_proce_sub_tot>0)
	{
	?>
	<tr>
	<td width="130">
	Sub Total  <!-- Others% breack Down 9-->
	</td>
	<td align="right">
	<?

	echo number_format($fab_proce_sub_tot,2);
	?>
	</td>
	</tr>
	<?
	}
	if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
	{
	?>
	<tr>
	<td width="130">
	Grand Total  <!-- Others% breack Down 9-->
	</td>
	<td align="right">
	<?
	echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2);
	?>
	</td>
	</tr>
	<?
	}
	?>
	</table>
	</fieldset>
	</div>
	</td>
	<td width="330" valign="top" align="left">
	<?
	$nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id in($job_no_in) and file_type=1");
	?>
	<div id="div_size_color_matrix" style="float:left;">
	<fieldset>
	<legend>Image</legend>
	<table width="310">
	<tr>
	<?
	$img_counter = 0;
	foreach($nameArray_imge as $result_imge)
	{
	if($path=="")
	{
	$path='../../';
	}
	?>
	<td>
	<img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />
	</td>
	<?

	$img_counter++;
	}
	?>
	</tr>
	</table>
	</fieldset>
	</div>
	</td>
	</tr>
	</table>
	<?
	}// if($cbo_fabric_source==1) end

	?>
	<br/>
	<!--  Here will be the main portion  -->
	<?
	$costing_per="";
	$costing_per_qnty=0;
	$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no in($job_no_in)");
	if($costing_per_id==1)
	{
	$costing_per="1 Dzn";
	$costing_per_qnty=12;

	}
	if($costing_per_id==2)
	{
	$costing_per="1 Pcs";
	$costing_per_qnty=1;

	}
	if($costing_per_id==3)
	{
	$costing_per="2 Dzn";
	$costing_per_qnty=24;

	}
	if($costing_per_id==4)
	{
	$costing_per="3 Dzn";
	$costing_per_qnty=36;

	}
	if($costing_per_id==5)
	{
	$costing_per="4 Dzn";
	$costing_per_qnty=48;
	}
	//$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no in($job_no_in)");
	$sql_pre=sql_select("select process_loss_method,uom from wo_pre_cost_fabric_cost_dtls where job_no in($job_no_in) and status_active=1");
	//echo "select process_loss_method,uom from wo_pre_cost_fabric_cost_dtls where job_no in($job_no_in) and status_active=1";die;
	foreach($sql_pre as $row)
	{
		$process_loss_method= $row[csf('process_loss_method')];
		$uom_arr[$row[csf('uom')]]=$unit_of_measurement[$row[csf('uom')]];
	}
	unset($sql_pre);
	$sql_lab=sql_select("select lapdip_no,job_no_mst,color_name_id from wo_po_lapdip_approval_info where job_no_mst in($job_no_in)  and approval_status=3 and status_active=1");
	//echo "select process_loss_method,uom from wo_pre_cost_fabric_cost_dtls where job_no in($job_no_in) and status_active=1";die;
	foreach($sql_lab as $row)
	{
		//$process_loss_method= $row[csf('process_loss_method')];
		$labdip_arr[$row[csf('job_no_mst')]][$row[csf('color_name_id')]]=$row[csf('lapdip_no')];
	}
	unset($sql_lab);

	//$uom_arr=array(1=>"Pcs",12=>"Kg",23=>"Mtr",27=>"Yds");
	 
	$color_wise_wo_sql=sql_select("select  a.uom,a.item_number_id as item,a.body_part_id as body_id,a.color_type_id as c_type,a.construction,a.composition,a.gsm_weight,d.dia_width,d.pre_cost_remarks,d.fabric_color_id,(d.fin_fab_qnty) as fin_fab_qnty,(d.grey_fab_qnty) as grey_fab_qnty,(d.rate) as rate,(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and a.job_no in($job_no_in) and
	d.status_active=1 and
	d.is_deleted=0
	");
	
	$fab_qty_arr=array();
	foreach($color_wise_wo_sql as $row)
	{
		//$process_loss_method= $row[csf('process_loss_method')];
	$fab_qty_arr[$row[csf('uom')]][$row[csf('item')]][$row[csf('body_id')]][$row[csf('c_type')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('dia_width')]][$row[csf('pre_cost_remarks')]][$row[csf('fabric_color_id')]]['fin_qty']+=$row[csf('fin_fab_qnty')];
	$fab_qty_arr[$row[csf('uom')]][$row[csf('item')]][$row[csf('body_id')]][$row[csf('c_type')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('dia_width')]][$row[csf('pre_cost_remarks')]][$row[csf('fabric_color_id')]]['grey_qty']+=$row[csf('grey_fab_qnty')];
	$fab_qty_arr[$row[csf('uom')]][$row[csf('item')]][$row[csf('body_id')]][$row[csf('c_type')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('dia_width')]][$row[csf('pre_cost_remarks')]][$row[csf('fabric_color_id')]]['amount']+=$row[csf('amount')];
	
	$fab_tot_qty_arr[$row[csf('uom')]][$row[csf('item')]][$row[csf('body_id')]][$row[csf('c_type')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('dia_width')]][$row[csf('pre_cost_remarks')]]['fin_qty']+=$row[csf('fin_fab_qnty')];
	$fab_tot_qty_arr[$row[csf('uom')]][$row[csf('item')]][$row[csf('body_id')]][$row[csf('c_type')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('dia_width')]][$row[csf('pre_cost_remarks')]]['grey_qty']+=$row[csf('grey_fab_qnty')];
	$fab_tot_qty_arr[$row[csf('uom')]][$row[csf('item')]][$row[csf('body_id')]][$row[csf('c_type')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('dia_width')]][$row[csf('pre_cost_remarks')]]['amount']+=$row[csf('amount')];
	}
	unset($sql_lab);
	
	
	foreach($uom_arr as $uom_id=>$uom_val){
	if($cbo_fabric_source==1){
	$nameArray_fabric_description= sql_select("select a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , b.dia_width,d.pre_cost_remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_number_id=d.gmts_color_id and
	b.dia_width=d.dia_width and
	b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=$uom_id and

	d.status_active=1 and
	d.is_deleted=0 and
	b.cons>0
	group by a.id,a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,b.dia_width,d.pre_cost_remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	if(count($nameArray_fabric_description)>0){
	?>

	<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
	<caption>Fabric Details in <? echo $uom_val ?></caption>
	<tr align="center">
	<th colspan="3" align="left">Item Name</th>
	<?

	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('body_part_id')] == "")
	echo "<td colspan='3'>&nbsp</td>";
	else
	echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
	}
	?>
	<td  rowspan="11" width="50"><p>Total Finish Fabric (Kg)</p></td>

	<td  rowspan="11" width="50"><p>Avg Rate <? echo "(".$unit_of_measurement[$uom].")";?></p></td>
	<td  rowspan="11" width="50"><p>Amount </p></td>

	</tr>
	<tr align="center">
	<th colspan="3" align="left">Body Part</th>
	<?

	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('body_part_id')] == "")
	echo "<td colspan='3'>&nbsp</td>";
	else
	echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th colspan="3" align="left">Color Type</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
	else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th colspan="3" align="left">Fabric Construction</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
	else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
	}
	?>


	</tr>
	<tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
	else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
	}
	?>

	</tr>
	<tr align="center"><th  colspan="3" align="left">GSM</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
	else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
	}
	?>

	</tr>
	<tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
	else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
	}
	?>

	</tr>
	<tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
	else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
	}
	?>
	</tr>
    <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('pre_cost_remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('pre_cost_remarks')]."</td>";
		}
		?>

       </tr>
	<tr>
	<th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
	</tr>
	<tr>
	<th  width="120" align="left">Fabric Color</th>
	<th  width="120" align="left">Body Color</th>
	<th  width="120" align="left">Lab Dip No</th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
	}
	?>
	</tr>
	<?
	$gmt_color_library=array();
	$gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
	FROM
	wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
	WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=$uom_id  and a.fabric_source =$cbo_fabric_source and
	a.job_no in ($job_no_in)");
	foreach( $gmt_color_data as $gmt_color_row){
	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
	}
	$grand_total_fin_fab_qnty=0;
	$grand_total_amount=0;
	$color_wise_wo_sql=sql_select("select b.fabric_color_id
	FROM
	wo_pre_cost_fabric_cost_dtls a,
	wo_booking_dtls b
	WHERE
	a.id=b.pre_cost_fabric_cost_dtls_id and
	a.uom=$uom_id and
	b.booking_no =$txt_booking_no and
	b.status_active=1 and
	b.is_deleted=0
	group by b.fabric_color_id");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	?>
	<tr>
	<td  width="120" align="left">
	<?
	echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
	?>
	</td>
	<td>
	<?
	echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
	?>
	</td>
	<td  width="120" align="left">
	<?
	$lapdip_no="";
	$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
	if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
	?>
	</td>
	<?
	$total_fin_fab_qnty=0;
	$total_amount=0;

	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	/*if($db_type==0)
	{
	$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=$uom_id and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
	d.fabric_color_id='".$color_wise_wo_result[csf('fabric_color_id')]."' and
	d.status_active=1 and
	d.is_deleted=0
	");
	}
	if($db_type==2)
	{
	$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=$uom_id and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
	nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
	d.status_active=1 and
	d.is_deleted=0
	");
	}
	list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;*/
	$uom=$uom_id;
	$itemid=$result_fabric_description[csf('item_number_id')];
	$body_id=$result_fabric_description[csf('body_part_id')];
	$c_type=$result_fabric_description[csf('color_type_id')];
	$construction=$result_fabric_description[csf('construction')];
	$composition=$result_fabric_description[csf('composition')];
	$gsm_weight=$result_fabric_description[csf('gsm_weight')];
	$dia_width=$result_fabric_description[csf('dia_width')];
	$pre_remarks=$result_fabric_description[csf('pre_cost_remarks')];
	$fab_color=$color_wise_wo_result[csf('fabric_color_id')];
	
	$fin_qty=$fab_qty_arr[$uom][$itemid][$body_id][$c_type][$construction][$composition][$gsm_weight][$dia_width][$pre_remarks][$fab_color]['fin_qty'];
	$amount=$fab_qty_arr[$uom][$itemid][$body_id][$c_type][$construction][$composition][$gsm_weight][$dia_width][$pre_remarks][$fab_color]['amount'];
	
	?>
	<td width='50' align='right'>
	<?
	if($fin_qty!="")
	{
	echo def_number_format($fin_qty,2) ;
	$total_fin_fab_qnty+=$fin_qty;
	}
	?>
	</td>
	<td width='50' align='right' >
	<?
	if($amount!="")
	{
	echo def_number_format($amount/$fin_qty,5);
	}
	?>
	</td>
	<td width='50' align='right' >
	<?
	$amount=def_number_format($amount,2,'',0);
	if($amount!="")
	{
	echo $amount;
	$total_amount+=$amount;
	}
	?>
	</td>
	<?
	}
	?>
	<td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
	<td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
	<td align="right">
	<?
	echo def_number_format($total_amount,2);

	?>
	</td>
	</tr>
	<?
	}
	?>
	<tr style=" font-weight:bold">
	<th  width="120" align="left">&nbsp;</th>
	<td  width="120" align="left">&nbsp;</td>
	<td  width="120" align="left"><strong>Total</strong></td>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=$uom_id and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
	d.status_active=1 and
	d.is_deleted=0
	");
	list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty*/
	$uom=$uom_id;
	$itemid=$result_fabric_description[csf('item_number_id')];
	$body_id=$result_fabric_description[csf('body_part_id')];
	$c_type=$result_fabric_description[csf('color_type_id')];
	$construction=$result_fabric_description[csf('construction')];
	$composition=$result_fabric_description[csf('composition')];
	$gsm_weight=$result_fabric_description[csf('gsm_weight')];
	$dia_width=$result_fabric_description[csf('dia_width')];
	$pre_remarks=$result_fabric_description[csf('pre_cost_remarks')];
	//$fab_color=$color_wise_wo_result[csf('fabric_color_id')];
	
	$fin_qty=$fab_tot_qty_arr[$uom][$itemid][$body_id][$c_type][$construction][$composition][$gsm_weight][$dia_width][$pre_remarks]['fin_qty'];
//	$amount=$fab_tot_qty_arr[$uom][$itemid][$body_id][$c_type][$construction][$composition][$gsm_weight][$dia_width][$pre_remarks]['amount'];
	
	?>
	<td width='50' align='right'><?  echo def_number_format($fin_qty,2) ;?></td>
	<td width='50' align='right'></td>
	<td width='50' align='right'></td>
	<?
	}
	?>
	<td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
	<td align="right"><? echo def_number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
	<td align="right">
	<?
	echo def_number_format($grand_total_amount,2);
	?>
	</td>
	</tr>
	<!--<tr style="font-weight:bold">
	<th  width="120" align="left">&nbsp;</th>
	<td  width="120" align="left">&nbsp;</td>
	<td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=$uom_id and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.status_active=1 and
	d.is_deleted=0
	");
	list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty*/
	?>
	<td width='50' align='right'></td>
	<td width='50' align='right'></td>
	<td width='50' align='right'></td>
	<?
	}
	?>
	<td align="right">
	<?
	//$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
	//echo number_format($consumption_per_unit_fab,2);
	?>
	</td>
	<td align="right">
	<?
	//$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
	//echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
	?>
	</td>
	<td align="right" title="Only Allow Round Figer">
	<?
	//echo number_format($consumption_per_unit_amuont,2);
	?>
	</td>
	</tr> -->
	</table>
	<br/>
	<?
	}
	}
	}
	//===========================

	foreach($uom_arr as $uom_id=>$uom_val){
	if($cbo_fabric_source==2){
	$nameArray_fabric_description= sql_select("select a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , b.dia_width,d.pre_cost_remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_number_id=d.gmts_color_id and
	b.dia_width=d.dia_width and
	b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and a.job_no in($job_no_in) and
	a.uom=$uom_id and
	d.status_active=1 and
	d.is_deleted=0  and
	b.cons>0
	group by a.id,a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,b.dia_width,d.pre_cost_remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	if(count($nameArray_fabric_description)>0){

	?>
	<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
	<caption>Fabric Details in <? echo $uom_val;?></caption>
	<tr align="center">
	<th colspan="3" align="left">Item Name</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('body_part_id')] == "")
	echo "<td colspan='3'>&nbsp</td>";
	else
	echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
	}
	?>
	<td  rowspan="11" width="50"><p>Total Finish Fabric</p></td>

	<td  rowspan="11" width="50"><p>Avg Rate</p></td>
	<td  rowspan="11" width="50"><p>Amount </p></td>
	</tr>
	<tr align="center">
	<th colspan="3" align="left">Body Part</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('body_part_id')] == "")
	echo "<td colspan='3'>&nbsp</td>";
	else
	echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th colspan="3" align="left">Color Type</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
	else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th colspan="3" align="left">Fabric Construction</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
	else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
	else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th  colspan="3" align="left">GSM</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
	else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
	else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
	}
	?>

	</tr>
	<tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
	else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
	}
	?>

	</tr>
    <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('pre_cost_remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('pre_cost_remarks')]."</td>";
		}
		?>

       </tr>
	<tr>
	<th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
	</tr>
	<tr>
	<th  width="120" align="left">Fabric Color</th>
	<th  width="120" align="left">Body Color</th>
	<th  width="120" align="left">Lab Dip No</th>
	<?
	if($cbo_fabric_source==2)
	{
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
	}
	}
	else
	{
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	echo "<th width='50'>Fab. Qty</th>";
	}
	}

	?>
	</tr>
	<?
	$gmt_color_library=array();
 
	$gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
	FROM
	wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
	WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=$uom_id  and a.fabric_source =$cbo_fabric_source and
	a.job_no in ($job_no_in)");
	foreach( $gmt_color_data as $gmt_color_row){
	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
	}
	$grand_total_fin_fab_qnty=0;
	$grand_total_amount=0;
	$color_wise_wo_sql=sql_select("select b.fabric_color_id
	FROM
	wo_pre_cost_fabric_cost_dtls a,
	wo_booking_dtls b
	WHERE
	a.id=b.pre_cost_fabric_cost_dtls_id and
	a.uom=$uom_id and
	b.booking_no =$txt_booking_no and a.job_no in($job_no_in) and
	b.status_active=1 and
	b.is_deleted=0
	group by b.fabric_color_id");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
		
	?>
	<tr>
	<td  width="120" align="left">
	<?
	echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
	?>
	</td>
	<td>
	<?
	echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
	?>
	</td>
	<td  width="120" align="left">
	<?
	$lapdip_no="";
	$lapdip_no=$labdip_arr[$job_no][$color_wise_wo_result[csf('fabric_color_id')]];
	//$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
	if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
	?>
	</td>
	<?
	$total_fin_fab_qnty=0;
	$total_amount=0;

	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if($db_type==0)
	{
	/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and a.job_no in($job_no_in) and
	a.uom=$uom_id and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
	d.fabric_color_id='".$color_wise_wo_result[csf('fabric_color_id')]."' and
	d.status_active=1 and
	d.is_deleted=0
	");*/
	}
	if($db_type==2)
	{
	/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and a.job_no in($job_no_in) and
	a.uom=$uom_id and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
	nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
	d.status_active=1 and
	d.is_deleted=0
	");*/
	}
	
	//list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
	$uom=$uom_id;
	$itemid=$result_fabric_description[csf('item_number_id')];
	$body_id=$result_fabric_description[csf('body_part_id')];
	$c_type=$result_fabric_description[csf('color_type_id')];
	$construction=$result_fabric_description[csf('construction')];
	$composition=$result_fabric_description[csf('composition')];
	$gsm_weight=$result_fabric_description[csf('gsm_weight')];
	$dia_width=$result_fabric_description[csf('dia_width')];
	$pre_remarks=$result_fabric_description[csf('pre_cost_remarks')];
	$fab_color=$color_wise_wo_result[csf('fabric_color_id')];
	
	$fin_qty=$fab_qty_arr[$uom][$itemid][$body_id][$c_type][$construction][$composition][$gsm_weight][$dia_width][$pre_remarks][$fab_color]['fin_qty'];
	$amount=$fab_qty_arr[$uom][$itemid][$body_id][$c_type][$construction][$composition][$gsm_weight][$dia_width][$pre_remarks][$fab_color]['amount'];
	?>
	<td width='50' align='right'>
	<?
	if($fin_qty!="")
	{
	echo def_number_format($fin_qty,2) ;
	$total_fin_fab_qnty+=$fin_qty;
	}
	?>
	</td>
	<td width='50' align='right' >
	<?
	if($amount!="")
	{
	echo def_number_format($amount/$fin_qty,5);
	}
	?>
	</td>
	<td width='50' align='right' >
	<?
	$amount=def_number_format($amount,2,'',0);
	if($amount!="")
	{
	echo $amount;
	$total_amount+=$amount;
	}
	?>
	</td>
	<?
	}
	?>
	<td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
	<td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
	<td align="right">
	<?
	echo def_number_format($total_amount,2);

	?>
	</td>
	</tr>
	<?
	}
	?>
	<tr style=" font-weight:bold">
	<th  width="120" align="left">&nbsp;</th>
	<td  width="120" align="left">&nbsp;</td>
	<td  width="120" align="left"><strong>Total</strong></td>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and a.job_no in($job_no_in) and
	a.uom=$uom_id and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
	d.status_active=1 and
	d.is_deleted=0
	");
	list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty*/
	$uom=$uom_id;
	$itemid=$result_fabric_description[csf('item_number_id')];
	$body_id=$result_fabric_description[csf('body_part_id')];
	$c_type=$result_fabric_description[csf('color_type_id')];
	$construction=$result_fabric_description[csf('construction')];
	$composition=$result_fabric_description[csf('composition')];
	$gsm_weight=$result_fabric_description[csf('gsm_weight')];
	$dia_width=$result_fabric_description[csf('dia_width')];
	$pre_remarks=$result_fabric_description[csf('pre_cost_remarks')];
	//$fab_color=$color_wise_wo_result[csf('fabric_color_id')];
	
	$fin_qty=$fab_tot_qty_arr[$uom][$itemid][$body_id][$c_type][$construction][$composition][$gsm_weight][$dia_width][$pre_remarks]['fin_qty'];
	$amount=$fab_tot_qty_arr[$uom][$itemid][$body_id][$c_type][$construction][$composition][$gsm_weight][$dia_width][$pre_remarks]['amount'];
	
	?>
	<td width='50' align='right'><?  echo def_number_format($fin_qty,2) ;?></td>
	<td width='50' align='right' ></td>
	<td width='50' align='right' ></td>
	<?
	}
	?>
	<td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
	<td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
	<td align="right">
	<?
	echo def_number_format($grand_total_amount,2);
	?>
	</td>
	</tr>
	<!--<tr style="font-weight:bold">
	<th  width="120" align="left">&nbsp;</th>
	<td  width="120" align="left">&nbsp;</td>
	<td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=$uom_id and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.status_active=1 and
	d.is_deleted=0
	");
	list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty*/

	?>
	<td width='50' align='right'></td>
	<td width='50' align='right'></td>
	<td width='50' align='right'></td>
	<?
	}
	?>
	<td align="right">
	<?
	//$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
	//echo number_format($consumption_per_unit_fab,2);
	?>
	</td>
	<td align="right">
	<?
	//$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
	//echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
	?>
	</td>
	<td align="right" title="Only Allow Round Figer">
	<?
	//echo number_format($consumption_per_unit_amuont,2);
	?>
	</td>
	</tr> -->
	</table>
	<br/>
	<?
	}
	}
	}
	//===========================
	?>
    <?
	
	$sql_data=sql_select("select a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,a.uom,b.dia_width,b.pre_cost_remarks,b.fabric_color_id,b.remark, sum(b.grey_fab_qnty) as grey_fab_qnty,sum(b.adjust_qty)as adjust_qty,sum(b.fin_fab_qnty) as fin_fab_qnty,avg(b.rate) as rate,sum(b.grey_fab_qnty*b.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and a.job_no in ($job_no_in) and b.adjust_qty>0 and b.status_active=1 and b.is_deleted=0 group by a.id,a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,a.uom,b.dia_width,b.pre_cost_remarks,b.fabric_color_id,b.remark order by a.id,a.body_part_id");

		?>
		<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

        <tr>
        <td colspan="7">
        <strong>Fabric Stock Adjustment Details</strong>
        </td>

        </tr>

        <tr>
        <td>
        Fabrication
        </td>
        <td>
        Process
        </td>
        <td>
        Fabric Color
        </td>
        <td>
        Required
        </td>
        <td>
        Stock Used
        </td>
        <td>
        Booking Qty
        </td><td>
        Uom
        </td>
         <td>
        Remarks
        </td>
        </tr>
        <?
		if(count($sql_data)>0)
		{
		foreach($sql_data as $row){
			//die;
		?>
          <tr>
        <td>
        <? echo $body_part[$row[csf('body_part_id')]].",".$color_type[$row[csf('color_type_id')]].",".$row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$fabric_typee[$row[csf('width_dia_type')]].",".$row[csf('dia_width')]  ?>
        </td>
        <td>
        <? echo $row[csf('pre_cost_remarks')];  ?>
        </td>
        <td>
        <? echo $color_library[$row[csf('fabric_color_id')]];  ?>
        </td>
        <td align="right">
        <? echo number_format($row[csf('grey_fab_qnty')],4);  ?>
        </td>
        <td align="right">
         <? echo number_format($row[csf('adjust_qty')],4) ; ?>
        </td>
        <td align="right">
       <? echo number_format($row[csf('fin_fab_qnty')],4);  ?>
        </td>
         <td>
        <? echo $unit_of_measurement[$row[csf('uom')]];  ?>
        </td>
         <td>
         <? echo $row[csf('remark')];  ?>
        </td>
        </tr>
        <?
		}
		
		} //Empty eheck end
		?>
        </table>


	<?
	//echo $cbo_fabric_source;
	if($cbo_fabric_source==1 || $cbo_fabric_source==2){
	?>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
	<tr>
	<?
 $sql_excess_per="select a.po_break_down_id,a.gmts_color_id,a.size_number_id,a.excess_per,b.body_part_id FROM wo_booking_colar_culff_dtls a,wo_pre_cost_fabric_cost_dtls b where
	   a.pre_cost_fabric_cost_dtls_id=b.id and a.booking_no =$txt_booking_no and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).")  and b.body_part_id in(2,3) and a.status_active=1 ";
	$resultData=sql_select($sql_excess_per);
	foreach($resultData as $row)
	{
		if($row[csf("body_part_id")]==2)
		{
		$color_ex_arr[$row[csf("gmts_color_id")]][$row[csf("size_number_id")]]=$row[csf("excess_per")];	
		}
		if($row[csf("body_part_id")]==3) //cuff
		{
		$color_cuff_ex_arr[$row[csf("gmts_color_id")]][$row[csf("size_number_id")]]=$row[csf("excess_per")];	
		}
	}
	unset($resultData);
	
		$color_wise_wo_sql_size=sql_select( "select size_number_id,color_number_id,(plan_cut_qnty) as plan_cut_qnty, (order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).")     and  status_active!=0 and is_deleted =0");
	foreach($color_wise_wo_sql_size as $row)
	{
	$color_qty_arr[$row[csf("color_number_id")]][$row[csf("size_number_id")]]['plan']+=$row[csf("plan_cut_qnty")];
	$color_qty_arr[$row[csf("color_number_id")]][$row[csf("size_number_id")]]['qty']+=$row[csf("order_quantity")];	
	}
	unset($color_wise_wo_sql_size);
	
		
	
	$nameArray_item_size=sql_select( "select min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_id=b.job_id and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.job_no in ($job_no_in)  and a.body_part_id=2  and c.job_id=a.job_id and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");//and c.job_no_mst=a.job_no
	 
	if(count($nameArray_item_size)>0)
	{
	?>
	<td width="49%">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr>
	<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Collar -  Colour Size Brakedown in Pcs</b></td>
	</tr>
	<tr>
	<td width="70">Size</td>
	<?
	//echo "shakil****"; die;
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?
	}
	?>
	<td rowspan="2" align="center"><strong>Total</strong></td>
	<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
	</tr>
	<tr>
	<td>Collar Size</td>

	<?
	foreach($nameArray_item_size  as $result_item_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
	<?
	}
	?>
	<?
	$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.job_no in ($job_no_in)  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by c.color_number_id,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
	");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	$color_total_collar=0;
	$color_total_collar_order_qnty=0;
	$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
	$constrast_color_arr=array();
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
	for($i=0;$i<count($constrast_color);$i++)
	{
	$constrast_color2=explode('_',$constrast_color[$i]);
	$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
	}
	}
	?>
	<tr>
	<td>
	<?
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
	$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
	}
	else
	{
	echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
	$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
	}
	?>
	</td>
	<?

	foreach($nameArray_item_size  as $result_size)
	{
		 /*$sql_excess_per="select a.po_break_down_id,a.gmts_color_id,a.size_number_id,a.excess_per,b.body_part_id FROM wo_booking_colar_culff_dtls a,wo_pre_cost_fabric_cost_dtls b where
	   a.pre_cost_fabric_cost_dtls_id=b.id and a.booking_no =$txt_booking_no and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  a.size_number_id =".$result_size[csf('size_number_id')]." and a.gmts_color_id =".$color_wise_wo_result[csf('color_number_id')]." and b.body_part_id=2 and a.status_active=1 ";
	$resultData=sql_select($sql_excess_per);
	list($excess_percent)=$resultData;*/
	$colar_excess_percent=$color_ex_arr[$color_wise_wo_result[csf("color_number_id")]][$result_size[csf('size_number_id')]];//$excess_percent[csf('excess_per')];

	?>
	<td align="center" style="border:1px solid black" title="<? echo $colar_excess_percentage;?>">
	<?


	/*$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active!=0 and is_deleted =0");
	list($plan_cut_qnty)=$color_wise_wo_sql_qnty;*/
	$plan_cut=$color_qty_arr[$color_wise_wo_result[csf("color_number_id")]][$result_size[csf("size_number_id")]]['plan'];//$plan_cut_qnty[csf('plan_cut_qnty')];
	$colar_excess_per=($plan_cut*$colar_excess_percent)/100;
	echo number_format($plan_cut+$colar_excess_per,0);
	$color_total_collar+=$plan_cut+$colar_excess_per;
	$color_total_collar_order_qnty+=$plan_cut;
	$grand_total_collar+=$plan_cut+$colar_excess_per;
	$grand_total_collar_order_qnty+=$plan_cut;
	?>
	</td>
	<?
	}
	?>
	<td align="center"><? echo number_format($color_total_collar,0); ?></td>
	<td align="center"><? echo number_format((($color_total_collar-$color_total_collar_order_qnty)/$color_total_collar_order_qnty)*100,2); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td>Size Total</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:center"><? $colar_excess_pers=($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]+$colar_excess_pers,0); ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar,0); ?></td>
	<td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_collar-$grand_total_collar_order_qnty)/$grand_total_collar_order_qnty)*100,2); ?></td>
	</tr>
	</table>
	</td>
	<td width="2%">
	</td>
	<?
	}
	?>
	<?
	$nameArray_item_size=sql_select( "select min(c.id) as id, b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.job_no in ($job_no_in)   and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");

	if(count($nameArray_item_size)>0)
	{
	?>
	<td width="49%">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr>
	<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Cuff -  Colour Size Brakedown in Pcs</b></td>
	</tr>
	<tr>
	<td width="70">Size</td>

	<?

	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?
	}

	?>
	<td rowspan="2" align="center"><strong>Total</strong></td>
	<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
	</tr>
	<tr>
	<td>Cuff Size</td>

	<?
	foreach($nameArray_item_size  as $result_item_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
	<?
	}
	?>
	<?
	$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.job_no in ($job_no_in)  and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and  d.status_active=1 and d.is_deleted=0 group by c.color_number_id ,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
	");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	$color_total_cuff=0;
	$color_total_cuff_order_qnty=0;
	$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
	$constrast_color_arr=array();
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
	for($i=0;$i<count($constrast_color);$i++)
	{
	$constrast_color2=explode('_',$constrast_color[$i]);
	$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
	}
	}
	?>
	<tr>
	<td>
	<?
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]);
	$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
	}
	else
	{
	echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
	$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
	}
	?>
	</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
		 /*$sql_excess_cuff="select a.po_break_down_id,a.gmts_color_id,a.size_number_id,a.excess_per,b.body_part_id FROM wo_booking_colar_culff_dtls a,wo_pre_cost_fabric_cost_dtls b where
	 a.booking_no =$txt_booking_no and a.pre_cost_fabric_cost_dtls_id=b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  a.size_number_id =".$result_size[csf('size_number_id')]." and a.gmts_color_id =".$color_wise_wo_result[csf('color_number_id')]." and b.body_part_id=3 and a.status_active=1 ";
	$resultData_cuff=sql_select($sql_excess_cuff);*/
	//list($cuff_excess_percent)=$resultData_cuff;
	$cuff_excess_percent=$color_cuff_ex_arr[$color_wise_wo_result[csf("color_number_id")]][$result_size[csf("size_number_id")]];//$cuff_excess_percent[csf('excess_per')];
	?>
	<td align="center" style="border:1px solid black">
	<?
	/*$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active!=0 and is_deleted =0");
	list($plan_cut_qnty)=$color_wise_wo_sql_qnty;*/
	$plan_cut=$color_qty_arr[$color_wise_wo_result[csf("color_number_id")]][$result_size[csf("size_number_id")]]['plan'];//$plan_cut_qnty[csf('plan_cut_qnty')];
	$cuff_excess_per=(($plan_cut*2)*$cuff_excess_percent)/100;
	echo number_format($plan_cut*2+$cuff_excess_per,0);
	$color_total_cuff+=$plan_cut*2+$cuff_excess_per;
	$color_total_cuff_order_qnty+=$plan_cut*2;
	$grand_total_cuff+=$plan_cut*2+$cuff_excess_per;
	$grand_total_cuff_order_qnty+=$plan_cut*2;
	?>
	</td>
	<?
	}
	?>
	<td align="center"><? echo number_format($color_total_cuff,0); ?></td>
	<td align="center"><? echo number_format((($color_total_cuff-$color_total_cuff_order_qnty)/$color_total_cuff_order_qnty)*100,2); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td>Size Total</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:center"><? $cuff_excess_pers=(($size_tatal[$result_size[csf('size_number_id')]]*2)*$cuff_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]*2+$cuff_excess_pers,0); ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_cuff,0); ?></td>
	<td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_cuff-$grand_total_cuff_order_qnty)/$grand_total_cuff_order_qnty)*100,2); ?></td>
	</tr>
	</table>
	</td>
	<?
	}
	?>
	</tr>
	</table>
	<br/>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
	<tr>
	<?

	$nameArray_item_size=sql_select( "select min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.job_no in ($job_no_in)   and a.body_part_id=172  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
	if(count($nameArray_item_size)>0)
	{
	?>
	<td width="49%">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr>
	<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Collar Tipping -  Colour Size Brakedown in Pcs</b></td>
	</tr>
	<tr>
	<td width="70">Size</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?
	}
	?>
	<td rowspan="2" align="center"><strong>Total</strong></td>
	<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
	</tr>
	<tr>
	<td>Collar Size</td>
	<?
	foreach($nameArray_item_size  as $result_item_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
	<?
	}
	?>
	<?
	$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.job_no in ($job_no_in) and a.body_part_id=172  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by c.color_number_id,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
	");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	$color_total_collar_tipping=0;
	$color_total_collar_tipping_order_qnty=0;
	$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
	$constrast_color_arr=array();
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
	for($i=0;$i<count($constrast_color);$i++)
	{
	$constrast_color2=explode('_',$constrast_color[$i]);
	$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
	}
	}
	?>
	<tr>
	<td>
	<?
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
	$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
	}
	else
	{
	echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
	$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
	}
	?>
	</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
		$sql_excess_collarTip="select a.po_break_down_id,a.gmts_color_id,a.size_number_id,a.excess_per,b.body_part_id FROM wo_booking_colar_culff_dtls a,wo_pre_cost_fabric_cost_dtls b where
	 a.booking_no =$txt_booking_no and a.pre_cost_fabric_cost_dtls_id=b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  a.size_number_id =".$result_size[csf('size_number_id')]." and a.gmts_color_id =".$color_wise_wo_result[csf('color_number_id')]." and b.body_part_id=172 and a.status_active=1 ";
	$resultData_collar_tip=sql_select($sql_excess_collarTip);
	list($collarTip_excess_percent)=$resultData_collar_tip;
	$colar_excess_percent=$collarTip_excess_percent[csf('excess_per')];

	?>
	<td align="center" style="border:1px solid black">
	<?
	/*$color_tipping_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active!=0 and is_deleted =0");

	list($plan_cut_qnty)=$color_tipping_wise_wo_sql_qnty;*/
	$plan_cut=$color_qty_arr[$color_wise_wo_result[csf("color_number_id")]][$result_size[csf("size_number_id")]]['plan'];//$plan_cut_qnty[csf('plan_cut_qnty')];
	$colar_excess_per=($plan_cut*$colar_excess_percent)/100;
	echo number_format($plan_cut+$colar_excess_per,0);
	$color_total_collar_tipping+=$plan_cut+$colar_excess_per;
	$color_total_collar_tipping_order_qnty+=$plan_cut;
	$grand_total_collar_tipping+=$plan_cut+$colar_excess_per;
	$grand_total_collar_tipping_order_qnty+=$plan_cut;
	?>
	</td>
	<?
	}
	?>
	<td align="center"><? echo number_format($color_total_collar_tipping,0); ?></td>
	<td align="center"><? echo number_format((($color_total_collar_tipping-$color_total_collar_tipping_order_qnty)/$color_total_collar_tipping_order_qnty)*100,2); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td>Size Total</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:center"><? $colar_excess_pers=($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]+$colar_excess_pers,0); ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar_tipping,0); ?></td>
	<td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_collar_tipping-$grand_total_collar_tipping_order_qnty)/$grand_total_collar_tipping_order_qnty)*100,2); ?></td>
	</tr>
	</table>
	</td>
	<td width="2%">
	</td>
	<?
	}
	?>
	<?
	$nameArray_item_size=sql_select( "select min(c.id) as id, b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.job_no in ($job_no_in)  and a.body_part_id=214  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
	if(count($nameArray_item_size)>0)
	{
	?>
	<td width="49%">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr>
	<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Cuff Tipping -  Colour Size Brakedown in Pcs</b></td>
	</tr>
	<tr>
	<td width="70">Size</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?
	}
	?>
	<td rowspan="2" align="center"><strong>Total</strong></td>
	<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
	</tr>
	<tr>
	<td>Cuff Size</td>
	<?
	foreach($nameArray_item_size  as $result_item_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
	<?
	}
	?>
	<?
	$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=214 and a.job_no in ($job_no_in) and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and  d.status_active=1 and d.is_deleted=0 group by c.color_number_id ,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
	");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	$color_total_cuff_tipping=0;
	$color_total_cuff_tipping_order_qnty=0;
	$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
	$constrast_color_arr=array();
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
	for($i=0;$i<count($constrast_color);$i++)
	{
	$constrast_color2=explode('_',$constrast_color[$i]);
	$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
	}
	}
	?>
	<tr>
	<td>
	<?
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]);
	$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
	}
	else
	{
	echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
	$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
	}
	?>
	</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
		$sql_excess_cuffTip="select a.po_break_down_id,a.gmts_color_id,a.size_number_id,a.excess_per,b.body_part_id FROM wo_booking_colar_culff_dtls a,wo_pre_cost_fabric_cost_dtls b where
	 a.booking_no =$txt_booking_no and a.pre_cost_fabric_cost_dtls_id=b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  a.size_number_id =".$result_size[csf('size_number_id')]." and a.gmts_color_id =".$color_wise_wo_result[csf('color_number_id')]." and b.body_part_id=214 and a.status_active=1 ";
	$resultData_cuff_tip=sql_select($sql_excess_cuffTip);
	list($cuffTip_excess_percent)=$resultData_cuff_tip;
	$cuff_excess_percent=$cuffTip_excess_percent[csf('excess_per')];

	?>
	<td align="center" style="border:1px solid black">
	<?
	/*$cuff_tipping_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active!=0 and is_deleted =0");
	list($plan_cut_qnty)=$cuff_tipping_wise_wo_sql_qnty;*/
	$plan_cut=$color_qty_arr[$color_wise_wo_result[csf("color_number_id")]][$result_size[csf("size_number_id")]]['plan'];//$plan_cut_qnty[csf('plan_cut_qnty')];
	$cuff_tipping_excess_per=(($plan_cut*2)*$cuff_excess_percent)/100;
	echo number_format($plan_cut*2+$cuff_tipping_excess_per,0);
	$color_total_cuff_tipping+=$plan_cut*2+$cuff_tipping_excess_per;
	$color_total_cuff_tipping_order_qnty+=$plan_cut*2;
	$grand_total_cuff_tipping+=$plan_cut*2+$cuff_excess_per;
	$grand_total_cuff_tipping_order_qnty+=$plan_cut*2;
	?>
	</td>
	<?
	}
	?>
	<td align="center"><? echo number_format($color_total_cuff_tipping,0); ?></td>
	<td align="center" title="<? echo $color_total_cuff_tipping."**".$color_total_cuff_tipping_order_qnty; ?>"><? echo number_format((($color_total_cuff_tipping-$color_total_cuff_tipping_order_qnty)/$color_total_cuff_tipping_order_qnty)*100,2); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td>Size Total</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:center"><? $cuff_excess_pers=(($size_tatal[$result_size[csf('size_number_id')]]*2)*$cuff_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]*2+$cuff_excess_pers,0); ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_cuff_tipping,0); ?></td>
	<td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_cuff_tipping-$grand_total_cuff_tipping_order_qnty)/$grand_total_cuff_tipping_order_qnty)*100,2); ?></td>
	</tr>
	</table>
	</td>
	<?
	}
	?>
	</tr>
	</table>
	<br/>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
	<tr>
	<td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
	<thead>
	<tr>
	<th width="3%"></th><th width="97%" align="left"><u>Special Instruction</u></th>
	</tr>
	</thead>
	<tbody>
	<?
	$data_array=sql_select("select id, terms from  wo_booking_terms_condition where booking_no=$txt_booking_no");
	if ( count($data_array)>0)
	{
	$i=0;
	foreach( $data_array as $row )
	{
	$i++;
	?>
	<tr id="settr_1" valign="top">
	<td style="vertical-align:top">
	<? echo $i;?>
	</td>
	<td>
	<strong style="font-size:20px"> <? echo $row[csf('terms')]; ?></strong>
	</td>
	</tr>
	<?
	}
	}
	?>
	</tbody>
	</table>
	</td>
	<td width="2%">
	</td>
	<td width="49%" valign="top">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr align="center">
	<td><b>Approved Instructions</b></td>
	</tr>
	<tr>
	<td>
	<?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
	</td>
	</tr>
	</table>
	<br />
	</td>
	</tr>
	</table>
     <br>
      <br>
        <?
    
	 $desg_name=return_library_array( "select id, custom_designation from lib_designation", "id", "custom_designation"  );
	 $data_array=sql_select("select b.approved_by,b.approved_no, b.approved_date, c.user_full_name,c.designation from  wo_booking_mst a , approval_history b, user_passwd c where a.id=b.mst_id and b.approved_by=c.id and a.booking_no=$txt_booking_no and b.entry_form=7 order by b.id asc");
	?>
       <table  width="100%" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="3" style="border:1px solid black;">Approval Status</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th>
                <th width="50%" style="border:1px solid black;">Name/Designation</th>
                <th width="27%" style="border:1px solid black;">Approval Date</th>
                <th width="20%" style="border:1px solid black;">Approval No</th>
                </tr>
            </thead>
            <tbody>
            <?
			$i=1;
			foreach($data_array as $row){
			?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td><td width="50%" style="border:1px solid black;"><? echo $row[csf('user_full_name')].'/'.$desg_name[$row[csf('designation')]];?></td><td width="27%" style="border:1px solid black;"><? echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); //echo change_date_format($row[csf('approved_date')],"dd-mm-yyyy","-");?></td><td width="20%" style="border:1px solid black;"><? echo $row[csf('approved_no')];?></td>
                </tr>
                <?
				$i++;
			}
				?>
            </tbody>
        </table>
        
        <?
		//$sqlHis="select approval_cause from approval_cause_refusing_his where entry_form=7 and booking_id='$wo_id' and approval_type=2 and status_active=1 and is_deleted=0 order by id Desc";
		$booking_id=return_field_value( "id", "wo_booking_mst","booking_no=$txt_booking_no");
		$user_nameArr=return_library_array( "select id, user_name from user_passwd ", "id", "user_name"  );
	//	$un_approve_reques_data_array=sql_select("select a.id,a.cause_id,a.approval_cause, a.user_id, a.insert_date from approval_cause_refusing_his a, fabric_booking_approval_cause b where b.id=a.cause_id and b.booking_id=$booking_id and b.entry_form=7 and a.approval_type=2 order by a.id");
		$un_approve_reques_data_array=sql_select("select b.id,b.approval_cause, b.user_id, b.insert_date from fabric_booking_approval_cause b where  b.booking_id=$booking_id and b.entry_form=7 and b.approval_type=2 order by b.id");
	 
	foreach($un_approve_reques_data_array as $hrow)
		{
			$approval_data=$hrow[csf('id')];
			$unapprove_cause_arr[$approval_data]['insert_date']=$hrow[csf('insert_date')];
			$unapprove_cause_arr[$approval_data]['user_id']=$hrow[csf('user_id')];
			$unapprove_cause_arr[$approval_data]['approval_cause']=$hrow[csf('approval_cause')];
			$causeArrChk[$hrow[csf('approval_cause')].'_'.$hrow[csf('id')]]=$hrow[csf('approval_cause')].'_'.$hrow[csf('id')];
		}
		
		/*$un_approve_reques_data_cause_array=sql_select("select b.id,b.approval_cause,b.user_id,b.insert_date,b.update_date from fabric_booking_approval_cause b where  b.booking_id=$booking_id and b.entry_form=7 and b.approval_type=2 and b.status_active=1 order by b.id");
		//echo "select b.id,b.approval_cause,b.user_id,b.insert_date,b.update_date from fabric_booking_approval_cause b where  b.booking_id=$booking_id and b.entry_form=12 and b.approval_type=2 and b.status_active=1 order by b.id";
		foreach($un_approve_reques_data_cause_array as $hrow)
		{
			if($causeArrChk[$hrow[csf('approval_cause')].'_'.$hrow[csf('id')]]=='')
			{
			$insert_date=$hrow[csf('insert_date')];
			if(strtotime($hrow[csf('update_date')])>0)
			{
				$insert_date=$hrow[csf('update_date')];	
			}
			$approval_data=$hrow[csf('id')];
			$unapprove_cause_arr[$approval_data]['insert_date']=$insert_date;
			$unapprove_cause_arr[$approval_data]['user_id']=$hrow[csf('user_id')];
			$unapprove_cause_arr[$approval_data]['approval_cause']=$hrow[csf('approval_cause')];
			}
		}*/
		
		
		?>
         <br>
		<table align="center" cellspacing="0" width="100%" class="rpt_table" border="1" rules="all">
			<thead>
				<th width="30">SL</th>
                <th width="200">Rev. Date</th>
                <th width="200">Rev. By</th>
				<th>Reason of Revision</th>
			</thead>
		 <tbody>
			<?
			$i=1;
			foreach($unapprove_cause_arr as $cause=>$hrow)
			{
				if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
				$causeArr=explode("_",$cause);
				?>
				<tr bgcolor="<?=$bgcolor; ?>" onClick="change_color('tr_<?=$i; ?>','<?=$bgcolor; ?>');">
                  	<td width="30"><?=$i; ?></td>
					<td width="200"><?=$hrow[('insert_date')]; ?></td>
                    <td width="200"><?=$user_nameArr[$hrow[('user_id')]]; ?></td>
					<td style="word-break:break-all"><?=$hrow[('approval_cause')]; ?></td>
				</tr>
				<?
				$i++;
			}
			?>
            </tbody>
        </table>
            
	<br>
	<?
	//------------------------------ Query for TNA start-----------------------------------
	$po_id_all=str_replace("'","",$txt_order_no_id);
	$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
	$tna_start_sql=sql_select( "select id,po_number_id,
	(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
	(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
	(case when task_number=60 then task_start_date else null end) as knitting_start_date,
	(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
	(case when task_number=61 then task_start_date else null end) as dying_start_date,
	(case when task_number=61 then task_finish_date else null end) as dying_end_date,
	(case when task_number=73 then task_start_date else null end) as finishing_start_date,
	(case when task_number=73 then task_finish_date else null end) as finishing_end_date,
	(case when task_number=84 then task_start_date else null end) as cutting_start_date,
	(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
	(case when task_number=86 then task_start_date else null end) as sewing_start_date,
	(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
	(case when task_number=110 then task_start_date else null end) as exfact_start_date,
	(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
	(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
	(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
	from tna_process_mst
	where status_active=1 and po_number_id in($po_id_all)");
	$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
	$tna_date_task_arr=array();
	foreach($tna_start_sql as $row)
	{
	if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
	{
	if($tna_fab_start=="")
	{
	$tna_fab_start=$row[csf("fab_booking_start_date")];
	}
	}
	if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
	}
	if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
	}
	if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
	}
	if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
	}
	if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
	}

	if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
	}
	if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
	}
	}
	//------------------------------ Query for TNA end-----------------------------------
	?>
	<fieldset id="div_size_color_matrix" style="max-width:1000; display:none">
	<legend>TNA Information</legend>
	<table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
	<tr>
	<td rowspan="2" align="center" valign="top">SL</td>
	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
	<td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
	<td colspan="2" align="center" valign="top"><b>Knitting</b></td>
	<td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
	<td colspan="2" align="center" valign="top"><b>Finishing Fabric</b></td>
	<td colspan="2" align="center" valign="top"><b>Cutting </b></td>
	<td colspan="2" align="center" valign="top"><b>Sewing </b></td>
	<td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
	</tr>
	<tr>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	</tr>
	<?
	$i=1;
	foreach($tna_date_task_arr as $order_id=>$row)
	{
	?>
	<tr>
	<td><? echo $i; ?></td>
	<td><? echo $po_num_arr[$order_id]; ?></td>
	<td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
	<td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
	<td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
	</tr>
	<?
	$i++;
	}
	?>
	</table>
	</fieldset>
	<?
	}// fabric Source End
	?>
	<?
	//echo signature_table(1, $cbo_company_name, "1330px");
	echo signature_table(121, $cbo_company_name, "1330px", 1);
	echo "****".custom_file_name($txt_booking_no,$style_sting,$job_no);
	?>
	</div>
	<?

	$html = ob_get_contents();
	ob_clean();
	list($is_mail_send,$mail)=explode('___',$mail_send_data);

	if($is_mail_send==1){
		require_once('../../../mailer/class.phpmailer.php');
		require_once('../../../auto_mail/setting/mail_setting.php');
		$mailBody = preg_replace("/<img[^>]+\>/i", " ", $html); 
		$mailBody="<br>".$mail_body	;	
		$mailToArr=array();
		$mailSql = "select b.EMAIL  from wo_booking_mst a,LIB_SUPPLIER b where b.id=a.supplier_id and a.booking_no=$txt_booking_no";
	//echo $mailSql;die;
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
		}
		
		
		$mailSql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=99 and b.mail_user_setup_id=c.id  and c.IS_DELETED=0 and c.STATUS_ACTIVE=1";
		//echo $mailSql;die;
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
		}
		if($mail!=''){$mailToArr[]=$mail;}

		$to=implode(',',$mailToArr);
		$subject="Partial fabric booking";
		$header=mailHeader();
		echo $to;
		echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
		
	}
	else{
		echo $html;
	}
	exit();
}

if($action=="show_fabric_booking_report_urmi_29-4-21"){
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$company_library=return_library_array( "select id,company_name from lib_company", "id", "company_name");
	$color_library=return_library_array( "select id,color_name from lib_color", "id", "color_name");
	$size_library=return_library_array( "select id,size_name from lib_size", "id", "size_name");
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	//$supplier_address_arr=return_library_array( "select id,address_1 from   lib_supplier",'id','address_1');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	//$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	//$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	$season_arr=return_library_array("select id,season_name from lib_buyer_season","id","season_name");

	$uom=0;
	$job_data_arr=array();
	$nameArray_buyer=sql_select( "select  a.style_ref_no,a.style_description, a.job_no, a.style_owner, a.buyer_name, a.client_id, a.dealing_marchant, a.season, a.season_matrix, a.total_set_qnty, a.product_dept, a.product_code, a.pro_sub_dep, a.gmts_item_id, a.order_repeat_no, a.qlty_label,a.season_buyer_wise from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0");
	foreach ($nameArray_buyer as $result_buy){
	$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
	$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
	$job_data_arr['total_set_qnty'][$result_buy[csf('job_no')]]=$result_buy[csf('total_set_qnty')];
	$job_data_arr['product_dept'][$result_buy[csf('job_no')]]=$product_dept[$result_buy[csf('product_dept')]];
	$job_data_arr['product_code'][$result_buy[csf('job_no')]]=$result_buy[csf('product_code')];
	$job_data_arr['pro_sub_dep'][$result_buy[csf('job_no')]]=$pro_sub_dept_array[$result_buy[csf('pro_sub_dep')]];
	$job_data_arr['gmts_item_id'][$result_buy[csf('job_no')]]=$result_buy[csf('gmts_item_id')];
	$job_data_arr['style_ref_no'][$result_buy[csf('job_no')]]=$result_buy[csf('style_ref_no')];
	$job_data_arr['style_description'][$result_buy[csf('job_no')]]=$result_buy[csf('style_description')];
	$job_data_arr['dealing_marchant'][$result_buy[csf('job_no')]]=$marchentrArr[$result_buy[csf('dealing_marchant')]];
	$job_data_arr['season_matrix'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_matrix')]];
	$job_data_arr['season_buyer_wise'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_buyer_wise')]];
	$job_data_arr['order_repeat_no'][$result_buy[csf('job_no')]]=$result_buy[csf('order_repeat_no')];
	$job_data_arr['qlty_label'][$result_buy[csf('job_no')]]=$quality_label[$result_buy[csf('qlty_label')]];
	$job_data_arr['client'][$result_buy[csf('job_no')]]=$result_buy[csf('client_id')];
	}

	$job_no= implode(",",array_unique($job_data_arr['job_no']));
	$job_no_in= implode(",",array_unique($job_data_arr['job_no_in']));
	$product_depertment=implode(",",array_unique($job_data_arr['product_dept']));
	$product_code=implode(",",array_unique($job_data_arr['product_code']));
	$pro_sub_dep=implode(",",array_unique($job_data_arr['pro_sub_dep']));
	$gmts_item_id=implode(",",array_unique($job_data_arr['gmts_item_id']));
	$style_sting=implode(",",array_unique($job_data_arr['style_ref_no']));
	$style_description=implode(",",array_unique($job_data_arr['style_description']));
	$dealing_marchant=implode(",",array_unique($job_data_arr['dealing_marchant']));
	$season_matrix=implode(",",array_unique($job_data_arr['season_matrix']));
	$season_buyer_wise=implode(",",array_unique($job_data_arr['season_buyer_wise']));
	$order_repeat_no= implode(",",array_unique($job_data_arr['order_repeat_no']));
	$qlty_label= implode(",",array_unique($job_data_arr['qlty_label']));
	$client_id= implode(",",array_unique($job_data_arr['client']));
	?>
	<div style="width:1330px" align="center">
	<?php
	$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and a.status_active =1 and a.is_deleted=0 ");
	list($nameArray_approved_row) = $nameArray_approved;
	$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0 ");
	list($nameArray_approved_date_row) = $nameArray_approved_date;
	$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0 ");
	list($nameArray_approved_comments_row) = $nameArray_approved_comments;
	$path = str_replace("'", "", $path);
	if ($path != "") {
		$path = $path;
	} else {
		$path = "../../";
	}

	?>										<!--    Header Company Information         -->
	<style type="text/css">
		 .table_valign { vertical-align: top;word-break: break-all;word-wrap: break-word; }
	</style>
	<table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black"  >
	<tr>
	<td width="100">
	<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
	</td>
	<td width="1250">
	<table width="100%" cellpadding="0" cellspacing="0"  >
	<tr>
	<td align="center" style="font-size:20px;">
	<?php
	echo $company_library[$cbo_company_name];
	?>
	</td>
	<td rowspan="3" width="250">

	<span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($job_no,"'"); ?></b></span><br/>
	<?
	if($nameArray_approved_row[csf('approved_no')]>1)
	{
	?>
	<b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
	<br/>
	Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
	<?
	}
	?>


	</td>
	</tr>
	<tr>
	<td align="center" style="font-size:14px">
	<?
	$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
	if($txt_job_no!="")
	{
	$location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'");
	}
	else
	{
	$location="";
	}

	foreach ($nameArray as $result)
	{
	echo  $location_name_arr[$location];
	?>

	Email Address: <? echo $result[csf('email')];?>
	Website No: <? echo $result[csf('website')]; ?>

	<?

	}

	?>
	</td>
	</tr>
	<tr>
	<td align="center" style="font-size:20px">
	<strong><? if($report_title !=""){ echo $report_title;} else { echo "General Work Order";}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
	</td>
	</tr>
	</table>
	</td>
	</tr>
	</table>
	<?
	$po_data=array();
	if($db_type==0){
	$nameArray_job=sql_select( "select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,DATEDIFF(pub_shipment_date,po_received_date) date_diff,MIN(po_received_date) as po_received_date ,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status  from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0   group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
	}
	if($db_type==2){
	$nameArray_job=sql_select( "select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,(pub_shipment_date-po_received_date) date_diff,MIN(po_received_date) as po_received_date,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status   from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0  group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
	}
	foreach ($nameArray_job as $result_job){
		$po_data['po_id'][$result_job[csf('id')]]=$result_job[csf('id')];
		$po_data['po_number'][$result_job[csf('id')]]=$result_job[csf('po_number')];
		$po_data['leadtime'][$result_job[csf('id')]]=$result_job[csf('date_diff')];
		$po_data['po_quantity'][$result_job[csf('id')]]=$result_job[csf('po_quantity')];
		$po_data['po_received_date'][$result_job[csf('id')]]=change_date_format($result_job[csf('po_received_date')],'dd-mm-yyyy','-');
		$ddd=strtotime($result_job[csf('pub_shipment_date')]);
		$po_data['pub_shipment_date'][$ddd]=$ddd;
		$po_data['insert_date'][$result_job[csf('id')]]=$result_job[csf('insert_date')];

		if($result_job[csf('shiping_status')]==1){
		$shiping_status= "FP";
		}
		else if($result_job[csf('shiping_status')]==2){
		$shiping_status= "PS";
		}
		else if($result_job[csf('shiping_status')]==3){
		$shiping_status= "FS";
		}
		$po_data['shiping_status'][$result_job[csf('id')]]=$shiping_status;
		$po_data['file_no'][$result_job[csf('id')]]=$result_job[csf('file_no')];
		$po_data['grouping'][$result_job[csf('id')]]=$result_job[csf('grouping')];
	}
	$txt_order_no_id=implode(",",array_unique($po_data['po_id']));
	$leadtime=implode(",",array_unique($po_data['leadtime']));
	$po_quantity=array_sum($po_data['po_quantity']);
	$po_received_date=implode(",",array_unique($po_data['po_received_date']));
	$po_number=implode(",",array_unique($po_data['po_number']));
	$shipment_date=date('d-m-Y',min($po_data['pub_shipment_date']));
	$maxshipment_date=date('d-m-Y',max($po_data['pub_shipment_date']));
	$shiping_status=implode(",",array_unique($po_data['shiping_status']));
	$file_no=implode(",",array_unique($po_data['file_no']));
	$grouping=implode(",",array_unique($po_data['grouping']));



	$colar_excess_percent=0;
	$cuff_excess_percent=0;
	$rmg_process_breakdown=0;
	$nameArray=sql_select( "select a.buyer_id,a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.update_date,a.uom,a.remarks,a.pay_mode,a.fabric_composition from wo_booking_mst a  where   a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 ");
	foreach ($nameArray as $result)
	{
		$total_set_qnty=$result[csf('total_set_qnty')];
		$colar_excess_percent=$result[csf('colar_excess_percent')];
		$cuff_excess_percent=$result[csf('cuff_excess_percent')];
		$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
		foreach ($po_data['po_id'] as $po_id=>$po_val){
			$daysInHand.=(datediff('d',date('d-m-Y',time()),$po_data['pub_shipment_date'][$po_id])-1).",";
			$booking_date=$result[csf('update_date')];
			if($booking_date=="" || $booking_date=="0000-00-00 00:00:00"){
			$booking_date=$result[csf('insert_date')];
			}
			$WOPreparedAfter.=(datediff('d',$po_data['insert_date'][$po_id],$booking_date)-1).",";
		}
	?>
	<table width="100%" style="border:1px solid black;table-layout: fixed;" id="table_h" >
	<tr>
	<td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
	</tr>
	<tr>
	<td width="200"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
	<td width="220">:&nbsp;<span style="font-size:18px"><b><? $buyer_name_str=""; if($client_id!=0) $buyer_name_str=$buyer_name_arr[$result[csf('buyer_id')]]."-".$buyer_name_arr[$client_id]; else $buyer_name_str=$buyer_name_arr[$result[csf('buyer_id')]]; echo $buyer_name_str; ?></b></span></td>
	<td width="200"><span style="font-size:12px"><b>Dept.</b></span></td>
	<td width="220">:&nbsp;
	<?
	echo $product_depertment ;
	if($product_code !=""){
	echo " (".$product_code.")";
	}
	if($pro_sub_dep != ""){
	echo " (".$pro_sub_dep.")";
	}
	?>
	</td>
	<td width="200"><span style="font-size:12px"><b>Order Qnty</b></span></td>
	<td>:&nbsp; <?  echo $po_quantity;//." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?> </td>
	</tr>
	<tr>

	<td style="font-size:12px"><b>Garments Item</b></td>
	<td>:&nbsp;
	<?
	$gmts_item_name="";
	$gmts_item=explode(',',$gmts_item_id);
	for($g=0;$g<=count($gmts_item); $g++)
	{
	$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
	}
	echo rtrim($gmts_item_name,',');
	?>
	</td>
	<td style="font-size:12px"><b>Booking Release Date</b></td>
	<td>:&nbsp;
	<?
	$booking_date=$result[csf('update_date')];
	if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
	{
	$booking_date=$result[csf('insert_date')];
	}
	echo change_date_format($booking_date,'dd-mm-yyyy','-','');
	?>&nbsp;&nbsp;&nbsp;</td>
	<td style="font-size:18px"><b>Style Ref.</b>   </td>
	<td style="font-size:18px">:&nbsp;<b>
	<?
	echo $style_sting;
	?>
	</b>
	</td>
	</tr>
	<tr>
	<td style="font-size:12px"><b>Style Des.</b></td>
	<td>:&nbsp;<? echo $style_description;?></td>
	<td style="font-size:12px"><b>Season</b></td>
	<td>:&nbsp;<?  if($season_matrix!="") echo $season_matrix; else echo $season_buyer_wise; ?></td>
	<td style="font-size:12px"><b>Dealing Merchandiser</b></td>
	<td>:&nbsp;<? echo $dealing_marchant; ?></td>
	</tr>

	<tr>
	<td style="font-size:12px"><b>Supplier Name</b>   </td>
	<td>:&nbsp;
	<?
	if($result[csf('pay_mode')]==5){
	echo $company_library[$result[csf('supplier_id')]];
	}
	else{
	echo $supplier_name_arr[$result[csf('supplier_id')]];
	}
	?>    </td>
	<td style="font-size:12px"><b>Delivery Date</b></td>
	<td>:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
	<td style="font-size:18px"><b>Booking No </b>   </td>
	<td style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?> <? //echo "(".$unit_of_measurement[$result[csf('uom')]].")"; $uom=$result[csf('uom')];?></td>
	</tr>
	<tr>
		<td  class="table_valign"><p><b>Attention</b></p></td>
		<td class="table_valign" ><p>:&nbsp;<? echo $result[csf('attention')]; ?></p></td>
		<td class="table_valign"><p><b>Lead Time </b> </p>  </td>
		<td class="table_valign"><p>:&nbsp;
			<?
			echo $leadtime;
			?> </p>
		</td>
		<td class="table_valign" ><p><b>Po Received Date</b></p></td>
		<td class="table_valign" width="150" ><p>:&nbsp;<? echo $po_received_date; ?></p></td>
	</tr>
	<tr>
		<td class="table_valign"><p><b>Order No</b></p></td>
		<td class="table_valign" width="350"  colspan="3"><p>:&nbsp;<? echo $po_number; ?></p></td>
		<td class="table_valign"><p><b>Repeat No</b></p></td>
		<td class="table_valign"><p>:&nbsp;<? echo $order_repeat_no; ?></p></td>
	</tr>
	<tr>
	<td style="font-size:12px"><b>Shipment Date</b></td>
	<td colspan="3" style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> : First:&nbsp;<? echo rtrim($shipment_date,", "); //echo $max_pub_shipment_date; ?>, Last: <? echo $maxshipment_date; ?></td>
	<td  style="font-size:12px"><b>Quality Label</b></td>
	<td  >:&nbsp;<? echo $qlty_label; ?></td>
	</tr>
	</tr>
	<tr>
	<td style="font-size:12px"><b>WO Prepared After</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
	<?
	$WOPreparedAfter=implode(",",array_unique(explode(",",chop($WOPreparedAfter,","))));
	echo $WOPreparedAfter.' Days' ;
	?></td>

	<td style="font-size:12px"><b>Ship.days in Hand</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
	<?
	$daysInHand=implode(",",array_unique(explode(",",chop($daysInHand,","))));
	echo $daysInHand.' Days' ;
	?></td>

	<td style="font-size:12px"><b>Ex-factory status</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
	<?
	echo $shiping_status;
	?></td>

	</tr>
	<tr>
	<td style="font-size:18px"><b>Internal Ref No</b></td>
	<td style="font-size:18px"> :&nbsp;<b><? echo $grouping; ?></b></td>
	<td style="font-size:18px"><b>File no</b></td>
	<td style="font-size:18px"> :&nbsp;<b><? echo  $file_no;?></b></td>
	<td style="font-size:18px"><b>Currency</b></td>
	<td style="font-size:18px"> :&nbsp;<b><? echo  $currency[$result[csf("currency_id")]];?></b></td>
	</tr>
	<tr>
	<td style="font-size:18px"><b>Rmarks</b></td>
	<td style="font-size:18px" colspan="5"> :<? echo $result[csf('remarks')]?></td>
	</tr>
	<tr>
	<td style="font-size:18px"><b>Fabric Composition</b></td>
	<td style="font-size:18px" colspan="5"> :<? echo $result[csf('fabric_composition')]?></td>
	</tr>

	</table>
	<?
	}

	if($cbo_fabric_source==1 || $cbo_fabric_source==2){
	$nameArray_size=sql_select( "select  size_number_id,min(id) as id,	min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  	is_deleted=0 and status_active!=0 group by size_number_id order by size_order");
	?>
	<table width="100%" >
	<tr>
	<td width="800">
	<div id="div_size_color_matrix" style="float:left; max-width:1000;">
	<fieldset id="div_size_color_matrix" style="max-width:1000;">
	<legend>Size and Color Breakdown</legend>
	<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
	<tr>
	<td style="border:1px solid black"><strong>Color/Size</strong></td>
	<?
	foreach($nameArray_size  as $result_size)
	{	     ?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?	}    ?>
	<td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
	<td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
	<td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
	</tr>
	<?
	$color_size_order_qnty_array=array();
	$color_size_qnty_array=array();
	$size_tatal=array();
	$size_tatal_order=array();
	for($c=0;$c<count($gmts_item); $c++)
	{
	$item_size_tatal=array();
	$item_size_tatal_order=array();
	$item_grand_total=0;
	$item_grand_total_order=0;
	$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active!=0 group by color_number_id  order by color_order");
	?>
	<tr>
	<td style="border:1px solid black" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>

	</tr>
	<?
	foreach($nameArray_color as $result_color)
	{
	?>
	<tr>
	<td align="center" style="border:1px solid black"><? echo $color_library[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
	<?
	$color_total=0;
	$color_total_order=0;

	foreach($nameArray_size  as $result_size)
	{
	$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active!=0 and is_deleted =0");
	foreach($nameArray_color_size_qnty as $result_color_size_qnty)
	{
	?>
	<td style="border:1px solid black; text-align:right">
	<?
	if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
	{
	echo number_format($result_color_size_qnty[csf('order_quantity')],0);
	$color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
	$color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
	$item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
	$item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
	$grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
	$grand_total_order +=$result_color_size_qnty[csf('order_quantity')];


	$color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
	$color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
	if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
	{
	$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
	$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
	}
	else
	{
	$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
	$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
	}
	if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
	{
	$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
	$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
	}
	else
	{
	$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
	$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
	}
	}
	else echo "0";
	?>
	</td>

	<?
	}
	}
	?>
	<td style="border:1px solid black; text-align:right"><?  echo number_format(round($color_total_order),0); ?></td>

	<td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?>
	</td>
	<td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total),0); ?></td>
	</tr>
	<?
	}
	?>

	<td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
	<?
	foreach($nameArray_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:right"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total_order),0); ?></td>
	<td  style="border:1px solid black;  text-align:right"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
	<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total),0); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td style="border:1px solid black" align="center" colspan="<? echo count($nameArray_size)+3; ?>"><strong>&nbsp;</strong></td>
	</tr>
	<tr>
	<tr>
	<td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
	<?
	foreach($nameArray_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:right"><? echo $size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total_order),0); ?></td>
	<td  style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
	<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total),0); ?></td>
	</tr>
	</table>
	</fieldset>
	</div>
	</td>
	<td width="200" valign="top" align="left">
	<div id="div_size_color_matrix" style="float:left;">
	<?
	$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
	?>
	<fieldset>
	<legend>RMG Process Loss % </legend>
	<table width="180" class="rpt_table" border="1" rules="all">
	<?
	if(number_format($rmg_process_breakdown_arr[8],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Cut Panel rejection <!-- Extra Cutting % breack Down 8-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[8],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[2],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Chest Printing <!-- Printing % breack Down 2-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[2],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[10],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Neck/Sleeve Printing <!-- New breack Down 10-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[10],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[1],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Embroidery   <!-- Embroidery  % breack Down 1-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[1],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[4],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Sewing /Input<!-- Sewing % breack Down 4-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[4],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[3],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Garments Wash <!-- Washing %breack Down 3-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[3],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[15],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Gmts Finishing <!-- Washing %breack Down 3-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[15],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[11],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Others <!-- New breack Down 11-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[11],2);
	?>
	</td>
	</tr>
	<?
	}
	$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
	if($gmts_pro_sub_tot>0)
	{
	?>
	<tr>
	<td width="130">
	Sub Total <!-- New breack Down 11-->
	</td>
	<td align="right">
	<?

	echo number_format($gmts_pro_sub_tot,2);
	?>
	</td>
	</tr>
	<?
	}
	?>
	</table>
	</fieldset>


	<fieldset>
	<legend>Fabric Process Loss % </legend>
	<table width="180" class="rpt_table" border="1" rules="all">
	<?
	if(number_format($rmg_process_breakdown_arr[6],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Knitting  <!--  Knitting % breack Down 6-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[6],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[12],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Yarn Dyeing  <!--  New breack Down 12-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[12],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[5],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Dyeing & Finishing  <!-- Finishing % breack Down 5-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[5],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[13],2)>0)
	{
	?>
	<tr>
	<td width="130">
	All Over Print <!-- new  breack Down 13-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[13],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[14],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Lay Wash (Fabric) <!-- new  breack Down 14-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[14],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[7],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Dying   <!-- breack Down 7-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[7],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[0],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Cutting (Fabric) <!-- Cutting % breack Down 0-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[0],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[9],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Others  <!-- Others% breack Down 9-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[9],2);
	?>
	</td>
	</tr>
	<?
	}
	$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
	if(fab_proce_sub_tot>0)
	{
	?>
	<tr>
	<td width="130">
	Sub Total  <!-- Others% breack Down 9-->
	</td>
	<td align="right">
	<?

	echo number_format($fab_proce_sub_tot,2);
	?>
	</td>
	</tr>
	<?
	}
	if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
	{
	?>
	<tr>
	<td width="130">
	Grand Total  <!-- Others% breack Down 9-->
	</td>
	<td align="right">
	<?
	echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2);
	?>
	</td>
	</tr>
	<?
	}
	?>
	</table>
	</fieldset>
	</div>
	</td>
	<td width="330" valign="top" align="left">
	<?
	$nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id in($job_no_in) and file_type=1");
	?>
	<div id="div_size_color_matrix" style="float:left;">
	<fieldset>
	<legend>Image</legend>
	<table width="310">
	<tr>
	<?
	$img_counter = 0;
	foreach($nameArray_imge as $result_imge)
	{
	if($path=="")
	{
	$path='../../';
	}
	?>
	<td>
	<img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />
	</td>
	<?

	$img_counter++;
	}
	?>
	</tr>
	</table>
	</fieldset>
	</div>
	</td>
	</tr>
	</table>
	<?
	}// if($cbo_fabric_source==1) end

	?>
	<br/>
	<!--  Here will be the main portion  -->
	<?
	$costing_per="";
	$costing_per_qnty=0;
	$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no in($job_no_in)");
	if($costing_per_id==1)
	{
	$costing_per="1 Dzn";
	$costing_per_qnty=12;

	}
	if($costing_per_id==2)
	{
	$costing_per="1 Pcs";
	$costing_per_qnty=1;

	}
	if($costing_per_id==3)
	{
	$costing_per="2 Dzn";
	$costing_per_qnty=24;

	}
	if($costing_per_id==4)
	{
	$costing_per="3 Dzn";
	$costing_per_qnty=36;

	}
	if($costing_per_id==5)
	{
	$costing_per="4 Dzn";
	$costing_per_qnty=48;
	}
	//$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no in($job_no_in)");
	
	$sql_pre=sql_select("select process_loss_method,uom from wo_pre_cost_fabric_cost_dtls where job_no in($job_no_in) and status_active=1");
	//echo "select process_loss_method,uom from wo_pre_cost_fabric_cost_dtls where job_no in($job_no_in) and status_active=1";die;
	foreach($sql_pre as $row)
	{
		$process_loss_method= $row[csf('process_loss_method')];
		$uom_arr[$row[csf('uom')]]=$row[csf('uom')];
	}

	//$uom_arr=array(1=>"Pcs",12=>"Kg",23=>"Mtr",27=>"Yds");
	foreach($uom_arr as $uom_id=>$uom_val){
	if($cbo_fabric_source==1){
	$nameArray_fabric_description= sql_select("select a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , b.dia_width,d.pre_cost_remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_number_id=d.gmts_color_id and
	b.dia_width=d.dia_width and
	b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=$uom_id and
	d.status_active=1 and
	d.is_deleted=0 and
	b.cons>0
	group by a.id,a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,b.dia_width,d.pre_cost_remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	if(count($nameArray_fabric_description)>0){
	?>

	<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
	<caption>Fabric Details in <? echo $uom_val ?></caption>
	<tr align="center">
	<th colspan="3" align="left">Item Name</th>
	<?

	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('body_part_id')] == "")
	echo "<td colspan='3'>&nbsp</td>";
	else
	echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
	}
	?>
	<td  rowspan="11" width="50"><p>Total Finish Fabric (Kg)</p></td>

	<td  rowspan="11" width="50"><p>Avg Rate <? echo "(".$unit_of_measurement[$uom].")";?></p></td>
	<td  rowspan="11" width="50"><p>Amount </p></td>

	</tr>
	<tr align="center">
	<th colspan="3" align="left">Body Part</th>
	<?

	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('body_part_id')] == "")
	echo "<td colspan='3'>&nbsp</td>";
	else
	echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th colspan="3" align="left">Color Type</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
	else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th colspan="3" align="left">Fabric Construction</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
	else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
	}
	?>


	</tr>
	<tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
	else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
	}
	?>

	</tr>
	<tr align="center"><th  colspan="3" align="left">GSM</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
	else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
	}
	?>

	</tr>
	<tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
	else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
	}
	?>

	</tr>
	<tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
	else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
	}
	?>
	</tr>
    <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('pre_cost_remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('pre_cost_remarks')]."</td>";
		}
		?>

       </tr>
	<tr>
	<th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
	</tr>
	<tr>
	<th  width="120" align="left">Fabric Color</th>
	<th  width="120" align="left">Body Color</th>
	<th  width="120" align="left">Lab Dip No</th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
	}
	?>
	</tr>
	<?
	$gmt_color_library=array();
	$gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
	FROM
	wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
	WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=$uom_id  and a.fabric_source =$cbo_fabric_source and
	a.job_no in ($job_no_in)");
	foreach( $gmt_color_data as $gmt_color_row){
	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
	}
	$grand_total_fin_fab_qnty=0;
	$grand_total_amount=0;
	$color_wise_wo_sql=sql_select("select b.fabric_color_id
	FROM
	wo_pre_cost_fabric_cost_dtls a,
	wo_booking_dtls b
	WHERE
	a.id=b.pre_cost_fabric_cost_dtls_id and
	a.uom=$uom_id and
	b.booking_no =$txt_booking_no and
	b.status_active=1 and
	b.is_deleted=0
	group by b.fabric_color_id");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	?>
	<tr>
	<td  width="120" align="left">
	<?
	echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
	?>
	</td>
	<td>
	<?
	echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
	?>
	</td>
	<td  width="120" align="left">
	<?
	$lapdip_no="";
	$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
	if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
	?>
	</td>
	<?
	$total_fin_fab_qnty=0;
	$total_amount=0;

	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if($db_type==0)
	{
	$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=$uom_id and
	a.id='".$result_fabric_description[csf('fabric_cost_dtls_id')]."' and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
	d.fabric_color_id='".$color_wise_wo_result[csf('fabric_color_id')]."' and
	d.status_active=1 and
	d.is_deleted=0
	");
	}
	if($db_type==2)
	{
	$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=$uom_id and
	a.id='".$result_fabric_description[csf('fabric_cost_dtls_id')]."' and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
	nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
	d.status_active=1 and
	d.is_deleted=0
	");
	}
	list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
	?>
	<td width='50' align='right'>
	<?
	if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
	{
	echo def_number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;
	$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('fin_fab_qnty')];
	}
	?>
	</td>
	<td width='50' align='right' >
	<?
	if($color_wise_wo_result_qnty[csf('rate')]!="")
	{
	echo def_number_format($color_wise_wo_result_qnty[csf('rate')],5);
	}
	?>
	</td>
	<td width='50' align='right' >
	<?
	$amount=def_number_format($color_wise_wo_result_qnty[csf('amount')],2,'',0);
	if($amount!="")
	{
	echo $amount;
	$total_amount+=$amount;
	}
	?>
	</td>
	<?
	}
	?>
	<td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
	<td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
	<td align="right">
	<?
	echo def_number_format($total_amount,2);

	?>
	</td>
	</tr>
	<?
	}
	?>
	<tr style=" font-weight:bold">
	<th  width="120" align="left">&nbsp;</th>
	<td  width="120" align="left">&nbsp;</td>
	<td  width="120" align="left"><strong>Total</strong></td>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=$uom_id and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
	d.status_active=1 and
	d.is_deleted=0
	");
	list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
	?>
	<td width='50' align='right'><?  echo def_number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;?></td>
	<td width='50' align='right'></td>
	<td width='50' align='right'></td>
	<?
	}
	?>
	<td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
	<td align="right"><? echo def_number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
	<td align="right">
	<?
	echo def_number_format($grand_total_amount,2);
	?>
	</td>
	</tr>
	<!--<tr style="font-weight:bold">
	<th  width="120" align="left">&nbsp;</th>
	<td  width="120" align="left">&nbsp;</td>
	<td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=$uom_id and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.status_active=1 and
	d.is_deleted=0
	");
	list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty*/
	?>
	<td width='50' align='right'></td>
	<td width='50' align='right'></td>
	<td width='50' align='right'></td>
	<?
	}
	?>
	<td align="right">
	<?
	//$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
	//echo number_format($consumption_per_unit_fab,2);
	?>
	</td>
	<td align="right">
	<?
	//$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
	//echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
	?>
	</td>
	<td align="right" title="Only Allow Round Figer">
	<?
	//echo number_format($consumption_per_unit_amuont,2);
	?>
	</td>
	</tr> -->
	</table>
	<br/>
	<?
	}
	}
	}
	//===========================

	foreach($uom_arr as $uom_id=>$uom_val){
	if($cbo_fabric_source==2){
	$nameArray_fabric_description= sql_select("select a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , b.dia_width,d.pre_cost_remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_number_id=d.gmts_color_id and
	b.dia_width=d.dia_width and
	b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=$uom_id and
	d.status_active=1 and
	d.is_deleted=0  and
	b.cons>0
	group by a.id,a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,b.dia_width,d.pre_cost_remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	if(count($nameArray_fabric_description)>0){
	?>
	<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
	<caption>Fabric Details in <? echo $uom_val;?></caption>
	<tr align="center">
	<th colspan="3" align="left">Item Name</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('body_part_id')] == "")
	echo "<td colspan='3'>&nbsp</td>";
	else
	echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
	}
	?>
	<td  rowspan="11" width="50"><p>Total Finish Fabric</p></td>

	<td  rowspan="11" width="50"><p>Avg Rate</p></td>
	<td  rowspan="11" width="50"><p>Amount </p></td>
	</tr>
	<tr align="center">
	<th colspan="3" align="left">Body Part</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('body_part_id')] == "")
	echo "<td colspan='3'>&nbsp</td>";
	else
	echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th colspan="3" align="left">Color Type</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
	else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th colspan="3" align="left">Fabric Construction</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
	else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
	else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th  colspan="3" align="left">GSM</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
	else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
	else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
	}
	?>

	</tr>
	<tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
	else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
	}
	?>

	</tr>
    <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('pre_cost_remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('pre_cost_remarks')]."</td>";
		}
		?>

       </tr>
	<tr>
	<th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
	</tr>
	<tr>
	<th  width="120" align="left">Fabric Color</th>
	<th  width="120" align="left">Body Color</th>
	<th  width="120" align="left">Lab Dip No</th>
	<?
	if($cbo_fabric_source==2)
	{
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
	}
	}
	else
	{
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	echo "<th width='50'>Fab. Qty</th>";
	}
	}

	?>
	</tr>
	<?
	$gmt_color_library=array();

	$gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
	FROM
	wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
	WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=$uom_id  and a.fabric_source =$cbo_fabric_source and
	a.job_no in ($job_no_in)");
	foreach( $gmt_color_data as $gmt_color_row){
	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
	}
	$grand_total_fin_fab_qnty=0;
	$grand_total_amount=0;
	$color_wise_wo_sql=sql_select("select b.fabric_color_id
	FROM
	wo_pre_cost_fabric_cost_dtls a,
	wo_booking_dtls b
	WHERE
	a.id=b.pre_cost_fabric_cost_dtls_id and
	a.uom=$uom_id and
	b.booking_no =$txt_booking_no and
	b.status_active=1 and
	b.is_deleted=0
	group by b.fabric_color_id");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	?>
	<tr>
	<td  width="120" align="left">
	<?
	echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
	?>
	</td>
	<td>
	<?
	echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
	?>
	</td>
	<td  width="120" align="left">
	<?
	$lapdip_no="";
	$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
	if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
	?>
	</td>
	<?
	$total_fin_fab_qnty=0;
	$total_amount=0;

	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if($db_type==0)
	{
	$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=$uom_id and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
	d.fabric_color_id='".$color_wise_wo_result[csf('fabric_color_id')]."' and
	d.status_active=1 and
	d.is_deleted=0
	");
	}
	if($db_type==2)
	{
	$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=$uom_id and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
	nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
	d.status_active=1 and
	d.is_deleted=0
	");
	}
	list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
	?>
	<td width='50' align='right'>
	<?
	if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
	{
	echo def_number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;
	$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('fin_fab_qnty')];
	}
	?>
	</td>
	<td width='50' align='right' >
	<?
	if($color_wise_wo_result_qnty[csf('rate')]!="")
	{
	echo def_number_format($color_wise_wo_result_qnty[csf('rate')],5);
	}
	?>
	</td>
	<td width='50' align='right' >
	<?
	$amount=def_number_format($color_wise_wo_result_qnty[csf('amount')],2,'',0);
	if($amount!="")
	{
	echo $amount;
	$total_amount+=$amount;
	}
	?>
	</td>
	<?
	}
	?>
	<td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
	<td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
	<td align="right">
	<?
	echo def_number_format($total_amount,2);

	?>
	</td>
	</tr>
	<?
	}
	?>
	<tr style=" font-weight:bold">
	<th  width="120" align="left">&nbsp;</th>
	<td  width="120" align="left">&nbsp;</td>
	<td  width="120" align="left"><strong>Total</strong></td>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=$uom_id and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
	d.status_active=1 and
	d.is_deleted=0
	");
	list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
	?>
	<td width='50' align='right'><?  echo def_number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;?></td>
	<td width='50' align='right' ></td>
	<td width='50' align='right' ></td>
	<?
	}
	?>
	<td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
	<td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
	<td align="right">
	<?
	echo def_number_format($grand_total_amount,2);
	?>
	</td>
	</tr>
	<!--<tr style="font-weight:bold">
	<th  width="120" align="left">&nbsp;</th>
	<td  width="120" align="left">&nbsp;</td>
	<td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=$uom_id and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.status_active=1 and
	d.is_deleted=0
	");
	list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty*/

	?>
	<td width='50' align='right'></td>
	<td width='50' align='right'></td>
	<td width='50' align='right'></td>
	<?
	}
	?>
	<td align="right">
	<?
	//$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
	//echo number_format($consumption_per_unit_fab,2);
	?>
	</td>
	<td align="right">
	<?
	//$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
	//echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
	?>
	</td>
	<td align="right" title="Only Allow Round Figer">
	<?
	//echo number_format($consumption_per_unit_amuont,2);
	?>
	</td>
	</tr> -->
	</table>
	<br/>
	<?
	}
	}
	}
	//===========================
	?>
    <?
	$sql_data=sql_select("select a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,a.uom,b.dia_width,b.pre_cost_remarks,b.fabric_color_id,b.remark, sum(b.grey_fab_qnty) as grey_fab_qnty,sum(b.adjust_qty)as adjust_qty,sum(b.fin_fab_qnty) as fin_fab_qnty,avg(b.rate) as rate,sum(b.grey_fab_qnty*b.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.adjust_qty>0 and b.status_active=1 and b.is_deleted=0 group by a.id,a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,a.uom,b.dia_width,b.pre_cost_remarks,b.fabric_color_id,b.remark order by a.id,a.body_part_id");

		?>
		<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

        <tr>
        <td colspan="7">
        <strong>Fabric Stock Adjustment Details</strong>
        </td>

        </tr>

        <tr>
        <td>
        Fabrication
        </td>
        <td>
        Process
        </td>
        <td>
        Fabric Color
        </td>
        <td>
        Required
        </td>
        <td>
        Stock Used
        </td>
        <td>
        Booking Qty
        </td><td>
        Uom
        </td>
         <td>
        Remarks
        </td>
        </tr>
        <?
		foreach($sql_data as $row){
		?>
          <tr>
        <td>
        <? echo $body_part[$row[csf('body_part_id')]].",".$color_type[$row[csf('color_type_id')]].",".$row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$fabric_typee[$row[csf('width_dia_type')]].",".$row[csf('dia_width')]  ?>
        </td>
        <td>
        <? echo $row[csf('pre_cost_remarks')];  ?>
        </td>
        <td>
        <? echo $color_library[$row[csf('fabric_color_id')]];  ?>
        </td>
        <td align="right">
        <? echo number_format($row[csf('grey_fab_qnty')],4);  ?>
        </td>
        <td align="right">
         <? echo number_format($row[csf('adjust_qty')],4) ; ?>
        </td>
        <td align="right">
       <? echo number_format($row[csf('fin_fab_qnty')],4);  ?>
        </td>
         <td>
        <? echo $unit_of_measurement[$row[csf('uom')]];  ?>
        </td>
         <td>
         <? echo $row[csf('remark')];  ?>
        </td>
        </tr>
        <?
		}
		?>
        </table>


	<?
	//echo $cbo_fabric_source;
	if($cbo_fabric_source==1 || $cbo_fabric_source==2){
	?>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
	<tr>
	<?

	$nameArray_item_size=sql_select( "select min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
	if(count($nameArray_item_size)>0)
	{
	?>
	<td width="49%">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr>
	<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Collar -  Colour Size Brakedown in Pcs</b></td>
	</tr>
	<tr>
	<td width="70">Size</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?
	}
	?>
	<td rowspan="2" align="center"><strong>Total</strong></td>
	<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
	</tr>
	<tr>
	<td>Collar Size</td>

	<?
	foreach($nameArray_item_size  as $result_item_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
	<?
	}
	?>
	<?
	$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by c.color_number_id,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
	");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	$color_total_collar=0;
	$color_total_collar_order_qnty=0;
	$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
	$constrast_color_arr=array();
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
	for($i=0;$i<count($constrast_color);$i++)
	{
	$constrast_color2=explode('_',$constrast_color[$i]);
	$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
	}
	}
	?>
	<tr>
	<td>
	<?
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
	$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
	}
	else
	{
	echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
	$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
	}
	?>
	</td>
	<?

	foreach($nameArray_item_size  as $result_size)
	{
		 $sql_excess_per="select a.po_break_down_id,a.gmts_color_id,a.size_number_id,a.excess_per,b.body_part_id FROM wo_booking_colar_culff_dtls a,wo_pre_cost_fabric_cost_dtls b where
	 a.booking_no =$txt_booking_no and a.pre_cost_fabric_cost_dtls_id=b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  a.size_number_id =".$result_size[csf('size_number_id')]." and a.gmts_color_id =".$color_wise_wo_result[csf('color_number_id')]." and b.body_part_id=2 and a.status_active=1 ";
	$resultData=sql_select($sql_excess_per);
	list($excess_percent)=$resultData;
	$colar_excess_percent=$excess_percent[csf('excess_per')];

	?>
	<td align="center" style="border:1px solid black" title="<? echo $colar_excess_percentage;?>">
	<?


	$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active!=0 and is_deleted =0");
	list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
	$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
	$colar_excess_per=($plan_cut*$colar_excess_percent)/100;
	echo number_format($plan_cut+$colar_excess_per,0);
	$color_total_collar+=$plan_cut+$colar_excess_per;
	$color_total_collar_order_qnty+=$plan_cut;
	$grand_total_collar+=$plan_cut+$colar_excess_per;
	$grand_total_collar_order_qnty+=$plan_cut;
	?>
	</td>
	<?
	}
	?>
	<td align="center"><? echo number_format($color_total_collar,0); ?></td>
	<td align="center"><? echo number_format((($color_total_collar-$color_total_collar_order_qnty)/$color_total_collar_order_qnty)*100,2); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td>Size Total</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:center"><? $colar_excess_pers=($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]+$colar_excess_pers,0); ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar,0); ?></td>
	<td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_collar-$grand_total_collar_order_qnty)/$grand_total_collar_order_qnty)*100,2); ?></td>
	</tr>
	</table>
	</td>
	<td width="2%">
	</td>
	<?
	}
	?>
	<?
	$nameArray_item_size=sql_select( "select min(c.id) as id, b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");

	if(count($nameArray_item_size)>0)
	{
	?>
	<td width="49%">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr>
	<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Cuff -  Colour Size Brakedown in Pcs</b></td>
	</tr>
	<tr>
	<td width="70">Size</td>

	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?
	}
	?>
	<td rowspan="2" align="center"><strong>Total</strong></td>
	<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
	</tr>
	<tr>
	<td>Cuff Size</td>

	<?
	foreach($nameArray_item_size  as $result_item_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
	<?
	}
	?>
	<?
	$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and  d.status_active=1 and d.is_deleted=0 group by c.color_number_id ,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
	");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	$color_total_cuff=0;
	$color_total_cuff_order_qnty=0;
	$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
	$constrast_color_arr=array();
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
	for($i=0;$i<count($constrast_color);$i++)
	{
	$constrast_color2=explode('_',$constrast_color[$i]);
	$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
	}
	}
	?>
	<tr>
	<td>
	<?
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]);
	$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
	}
	else
	{
	echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
	$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
	}
	?>
	</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
		 $sql_excess_cuff="select a.po_break_down_id,a.gmts_color_id,a.size_number_id,a.excess_per,b.body_part_id FROM wo_booking_colar_culff_dtls a,wo_pre_cost_fabric_cost_dtls b where
	 a.booking_no =$txt_booking_no and a.pre_cost_fabric_cost_dtls_id=b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  a.size_number_id =".$result_size[csf('size_number_id')]." and a.gmts_color_id =".$color_wise_wo_result[csf('color_number_id')]." and b.body_part_id=3 and a.status_active=1 ";
	$resultData_cuff=sql_select($sql_excess_cuff);
	list($cuff_excess_percent)=$resultData_cuff;
	$cuff_excess_percent=$cuff_excess_percent[csf('excess_per')];
	?>
	<td align="center" style="border:1px solid black">
	<?
	$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active!=0 and is_deleted =0");
	list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
	$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
	$cuff_excess_per=(($plan_cut*2)*$cuff_excess_percent)/100;
	echo number_format($plan_cut*2+$cuff_excess_per,0);
	$color_total_cuff+=$plan_cut*2+$cuff_excess_per;
	$color_total_cuff_order_qnty+=$plan_cut*2;
	$grand_total_cuff+=$plan_cut*2+$cuff_excess_per;
	$grand_total_cuff_order_qnty+=$plan_cut*2;
	?>
	</td>
	<?
	}
	?>
	<td align="center"><? echo number_format($color_total_cuff,0); ?></td>
	<td align="center"><? echo number_format((($color_total_cuff-$color_total_cuff_order_qnty)/$color_total_cuff_order_qnty)*100,2); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td>Size Total</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:center"><? $cuff_excess_pers=(($size_tatal[$result_size[csf('size_number_id')]]*2)*$cuff_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]*2+$cuff_excess_pers,0); ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_cuff,0); ?></td>
	<td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_cuff-$grand_total_cuff_order_qnty)/$grand_total_cuff_order_qnty)*100,2); ?></td>
	</tr>
	</table>
	</td>
	<?
	}
	?>
	</tr>
	</table>
	<br/>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
	<tr>
	<?

	$nameArray_item_size=sql_select( "select min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=172  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
	if(count($nameArray_item_size)>0)
	{
	?>
	<td width="49%">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr>
	<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Collar Tipping -  Colour Size Brakedown in Pcs</b></td>
	</tr>
	<tr>
	<td width="70">Size</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?
	}
	?>
	<td rowspan="2" align="center"><strong>Total</strong></td>
	<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
	</tr>
	<tr>
	<td>Collar Size</td>
	<?
	foreach($nameArray_item_size  as $result_item_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
	<?
	}
	?>
	<?
	$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=172  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by c.color_number_id,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
	");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	$color_total_collar_tipping=0;
	$color_total_collar_tipping_order_qnty=0;
	$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
	$constrast_color_arr=array();
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
	for($i=0;$i<count($constrast_color);$i++)
	{
	$constrast_color2=explode('_',$constrast_color[$i]);
	$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
	}
	}
	?>
	<tr>
	<td>
	<?
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
	$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
	}
	else
	{
	echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
	$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
	}
	?>
	</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
		$sql_excess_collarTip="select a.po_break_down_id,a.gmts_color_id,a.size_number_id,a.excess_per,b.body_part_id FROM wo_booking_colar_culff_dtls a,wo_pre_cost_fabric_cost_dtls b where
	 a.booking_no =$txt_booking_no and a.pre_cost_fabric_cost_dtls_id=b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  a.size_number_id =".$result_size[csf('size_number_id')]." and a.gmts_color_id =".$color_wise_wo_result[csf('color_number_id')]." and b.body_part_id=172 and a.status_active=1 ";
	$resultData_collar_tip=sql_select($sql_excess_collarTip);
	list($collarTip_excess_percent)=$resultData_collar_tip;
	$colar_excess_percent=$collarTip_excess_percent[csf('excess_per')];

	?>
	<td align="center" style="border:1px solid black">
	<?
	$color_tipping_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active!=0 and is_deleted =0");

	list($plan_cut_qnty)=$color_tipping_wise_wo_sql_qnty;
	$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
	$colar_excess_per=($plan_cut*$colar_excess_percent)/100;
	echo number_format($plan_cut+$colar_excess_per,0);
	$color_total_collar_tipping+=$plan_cut+$colar_excess_per;
	$color_total_collar_tipping_order_qnty+=$plan_cut;
	$grand_total_collar_tipping+=$plan_cut+$colar_excess_per;
	$grand_total_collar_tipping_order_qnty+=$plan_cut;
	?>
	</td>
	<?
	}
	?>
	<td align="center"><? echo number_format($color_total_collar_tipping,0); ?></td>
	<td align="center"><? echo number_format((($color_total_collar_tipping-$color_total_collar_tipping_order_qnty)/$color_total_collar_tipping_order_qnty)*100,2); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td>Size Total</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:center"><? $colar_excess_pers=($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]+$colar_excess_pers,0); ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar_tipping,0); ?></td>
	<td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_collar_tipping-$grand_total_collar_tipping_order_qnty)/$grand_total_collar_tipping_order_qnty)*100,2); ?></td>
	</tr>
	</table>
	</td>
	<td width="2%">
	</td>
	<?
	}
	?>
	<?
	$nameArray_item_size=sql_select( "select min(c.id) as id, b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=214  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
	if(count($nameArray_item_size)>0)
	{
	?>
	<td width="49%">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr>
	<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Cuff Tipping -  Colour Size Brakedown in Pcs</b></td>
	</tr>
	<tr>
	<td width="70">Size</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?
	}
	?>
	<td rowspan="2" align="center"><strong>Total</strong></td>
	<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
	</tr>
	<tr>
	<td>Cuff Size</td>
	<?
	foreach($nameArray_item_size  as $result_item_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
	<?
	}
	?>
	<?
	$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=214  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and  d.status_active=1 and d.is_deleted=0 group by c.color_number_id ,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
	");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	$color_total_cuff_tipping=0;
	$color_total_cuff_tipping_order_qnty=0;
	$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
	$constrast_color_arr=array();
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
	for($i=0;$i<count($constrast_color);$i++)
	{
	$constrast_color2=explode('_',$constrast_color[$i]);
	$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
	}
	}
	?>
	<tr>
	<td>
	<?
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]);
	$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
	}
	else
	{
	echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
	$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
	}
	?>
	</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
		$sql_excess_cuffTip="select a.po_break_down_id,a.gmts_color_id,a.size_number_id,a.excess_per,b.body_part_id FROM wo_booking_colar_culff_dtls a,wo_pre_cost_fabric_cost_dtls b where
	 a.booking_no =$txt_booking_no and a.pre_cost_fabric_cost_dtls_id=b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  a.size_number_id =".$result_size[csf('size_number_id')]." and a.gmts_color_id =".$color_wise_wo_result[csf('color_number_id')]." and b.body_part_id=214 and a.status_active=1 ";
	$resultData_cuff_tip=sql_select($sql_excess_cuffTip);
	list($cuffTip_excess_percent)=$resultData_cuff_tip;
	$cuff_excess_percent=$cuffTip_excess_percent[csf('excess_per')];

	?>
	<td align="center" style="border:1px solid black">
	<?
	$cuff_tipping_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active!=0 and is_deleted =0");
	list($plan_cut_qnty)=$cuff_tipping_wise_wo_sql_qnty;
	$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
	$cuff_tipping_excess_per=(($plan_cut*2)*$cuff_excess_percent)/100;
	echo number_format($plan_cut*2+$cuff_tipping_excess_per,0);
	$color_total_cuff_tipping+=$plan_cut*2+$cuff_tipping_excess_per;
	$color_total_cuff_tipping_order_qnty+=$plan_cut*2;
	$grand_total_cuff_tipping+=$plan_cut*2+$cuff_excess_per;
	$grand_total_cuff_tipping_order_qnty+=$plan_cut*2;
	?>
	</td>
	<?
	}
	?>
	<td align="center"><? echo number_format($color_total_cuff_tipping,0); ?></td>
	<td align="center" title="<? echo $color_total_cuff_tipping."**".$color_total_cuff_tipping_order_qnty; ?>"><? echo number_format((($color_total_cuff_tipping-$color_total_cuff_tipping_order_qnty)/$color_total_cuff_tipping_order_qnty)*100,2); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td>Size Total</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:center"><? $cuff_excess_pers=(($size_tatal[$result_size[csf('size_number_id')]]*2)*$cuff_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]*2+$cuff_excess_pers,0); ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_cuff_tipping,0); ?></td>
	<td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_cuff_tipping-$grand_total_cuff_tipping_order_qnty)/$grand_total_cuff_tipping_order_qnty)*100,2); ?></td>
	</tr>
	</table>
	</td>
	<?
	}
	?>
	</tr>
	</table>
	<br/>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
	<tr>
	<td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
	<thead>
	<tr>
	<th width="3%"></th><th width="97%" align="left"><u>Special Instruction</u></th>
	</tr>
	</thead>
	<tbody>
	<?
	$data_array=sql_select("select id, terms from  wo_booking_terms_condition where booking_no=$txt_booking_no");
	if ( count($data_array)>0)
	{
	$i=0;
	foreach( $data_array as $row )
	{
	$i++;
	?>
	<tr id="settr_1" valign="top">
	<td style="vertical-align:top">
	<? echo $i;?>
	</td>
	<td>
	<strong style="font-size:20px"> <? echo $row[csf('terms')]; ?></strong>
	</td>
	</tr>
	<?
	}
	}
	?>
	</tbody>
	</table>
	</td>
	<td width="2%">
	</td>
	<td width="49%" valign="top">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr align="center">
	<td><b>Approved Instructions</b></td>
	</tr>
	<tr>
	<td>
	<?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
	</td>
	</tr>
	</table>
	<br />
	</td>
	</tr>
	</table>
	<br>
	<?
	//------------------------------ Query for TNA start-----------------------------------
	$po_id_all=str_replace("'","",$txt_order_no_id);
	$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
	$tna_start_sql=sql_select( "select id,po_number_id,
	(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
	(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
	(case when task_number=60 then task_start_date else null end) as knitting_start_date,
	(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
	(case when task_number=61 then task_start_date else null end) as dying_start_date,
	(case when task_number=61 then task_finish_date else null end) as dying_end_date,
	(case when task_number=73 then task_start_date else null end) as finishing_start_date,
	(case when task_number=73 then task_finish_date else null end) as finishing_end_date,
	(case when task_number=84 then task_start_date else null end) as cutting_start_date,
	(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
	(case when task_number=86 then task_start_date else null end) as sewing_start_date,
	(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
	(case when task_number=110 then task_start_date else null end) as exfact_start_date,
	(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
	(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
	(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
	from tna_process_mst
	where status_active=1 and po_number_id in($po_id_all)");
	$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
	$tna_date_task_arr=array();
	foreach($tna_start_sql as $row)
	{
	if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
	{
	if($tna_fab_start=="")
	{
	$tna_fab_start=$row[csf("fab_booking_start_date")];
	}
	}
	if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
	}
	if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
	}
	if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
	}
	if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
	}
	if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
	}
	if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
	}
	if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
	}
	}
	//------------------------------ Query for TNA end-----------------------------------
	?>
	<fieldset id="div_size_color_matrix" style="max-width:1000; display:none">
	<legend>TNA Information</legend>
	<table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
	<tr>
	<td rowspan="2" align="center" valign="top">SL</td>
	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
	<td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
	<td colspan="2" align="center" valign="top"><b>Knitting</b></td>
	<td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
	<td colspan="2" align="center" valign="top"><b>Finishing Fabric</b></td>
	<td colspan="2" align="center" valign="top"><b>Cutting </b></td>
	<td colspan="2" align="center" valign="top"><b>Sewing </b></td>
	<td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
	</tr>
	<tr>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	</tr>
	<?
	$i=1;
	foreach($tna_date_task_arr as $order_id=>$row)
	{
	?>
	<tr>
	<td><? echo $i; ?></td>
	<td><? echo $po_num_arr[$order_id]; ?></td>
	<td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
	<td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
	<td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
	</tr>
	<?
	$i++;
	}
	?>
	</table>
	</fieldset>
	<?
	}// fabric Source End
	?>
	<?
	//echo signature_table(1, $cbo_company_name, "1330px");
	echo signature_table(121, $cbo_company_name, "1330px", 1);
	echo "****".custom_file_name($txt_booking_no,$style_sting,$job_no);
	?>
	</div>
	<?
}
if($action=="print_booking_10"){
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$show_yarn_rate=str_replace("'","",$show_yarn_rate);
	$cbo_template_id = str_replace("'", "", $cbo_template_id);

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$company_library=return_library_array( "select id,company_name from lib_company", "id", "company_name");
	$color_library=return_library_array( "select id,color_name from lib_color", "id", "color_name");
	$size_library=return_library_array( "select id,size_name from lib_size", "id", "size_name");
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	//$supplier_address_arr=return_library_array( "select id,address_1 from   lib_supplier",'id','address_1');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	//$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	//$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	$season_arr=return_library_array("select id,season_name from lib_buyer_season","id","season_name");

	$uom=0;
	$job_data_arr=array();
	$nameArray_buyer=sql_select( "select  a.style_ref_no,a.style_description,a.order_uom, a.job_no, a.style_owner, a.buyer_name, a.client_id, a.dealing_marchant, a.season, a.season_matrix, a.total_set_qnty, a.product_dept, a.product_code, a.pro_sub_dep, a.gmts_item_id, a.order_repeat_no, a.qlty_label,a.season_buyer_wise, a.factory_marchant from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0");
	foreach ($nameArray_buyer as $result_buy){
	$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
	$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
	$job_data_arr['total_set_qnty'][$result_buy[csf('job_no')]]=$result_buy[csf('total_set_qnty')];
	$job_data_arr['product_dept'][$result_buy[csf('job_no')]]=$product_dept[$result_buy[csf('product_dept')]];
	$job_data_arr['product_code'][$result_buy[csf('job_no')]]=$result_buy[csf('product_code')];
	$job_data_arr['pro_sub_dep'][$result_buy[csf('job_no')]]=$pro_sub_dept_array[$result_buy[csf('pro_sub_dep')]];
	$job_data_arr['gmts_item_id'][$result_buy[csf('job_no')]]=$result_buy[csf('gmts_item_id')];
	$job_data_arr['style_ref_no'][$result_buy[csf('job_no')]]=$result_buy[csf('style_ref_no')];
	$job_data_arr['style_description'][$result_buy[csf('job_no')]]=$result_buy[csf('style_description')];
	$job_data_arr['dealing_marchant'][$result_buy[csf('job_no')]]=$marchentrArr[$result_buy[csf('dealing_marchant')]];
	$job_data_arr['factory_marchant'][$result_buy[csf('job_no')]]=$marchentrArr[$result_buy[csf('factory_marchant')]];
	$job_data_arr['season_matrix'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_matrix')]];
	$job_data_arr['season_buyer_wise'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_buyer_wise')]];
	$job_data_arr['order_repeat_no'][$result_buy[csf('job_no')]]=$result_buy[csf('order_repeat_no')];
	$job_data_arr['qlty_label'][$result_buy[csf('job_no')]]=$quality_label[$result_buy[csf('qlty_label')]];
	$job_data_arr['client'][$result_buy[csf('job_no')]]=$result_buy[csf('client_id')];
	$job_data_arr['order_uom'][$result_buy[csf('job_no')]]=$result_buy[csf('order_uom')];
	}

	$job_no= implode(",",array_unique($job_data_arr['job_no']));
	$job_no_in= implode(",",array_unique($job_data_arr['job_no_in']));
	$product_depertment=implode(",",array_unique($job_data_arr['product_dept']));
	$product_code=implode(",",array_unique($job_data_arr['product_code']));
	$pro_sub_dep=implode(",",array_unique($job_data_arr['pro_sub_dep']));
	$gmts_item_id=implode(",",array_unique($job_data_arr['gmts_item_id']));
	$style_sting=implode(",",array_unique($job_data_arr['style_ref_no']));
	$style_description=implode(",",array_unique($job_data_arr['style_description']));
	$dealing_marchant=implode(",",array_unique($job_data_arr['dealing_marchant']));
	$factory_marchant=implode(",",array_unique($job_data_arr['factory_marchant']));
	$season_matrix=implode(",",array_unique($job_data_arr['season_matrix']));
	$season_buyer_wise=implode(",",array_unique($job_data_arr['season_buyer_wise']));
	$order_repeat_no= implode(",",array_unique($job_data_arr['order_repeat_no']));
	$qlty_label= implode(",",array_unique($job_data_arr['qlty_label']));
	$client_id= implode(",",array_unique($job_data_arr['client']));
	?>
	<div style="width:1330px" align="center">
	<?php
	$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and a.status_active =1 and a.is_deleted=0 ");
	list($nameArray_approved_row) = $nameArray_approved;
	$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0 ");
	list($nameArray_approved_date_row) = $nameArray_approved_date;
	$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0 ");
	list($nameArray_approved_comments_row) = $nameArray_approved_comments;
	$path = str_replace("'", "", $path);
	if ($path != "") {
		$path = $path;
	} else {
		$path = "../../";
	}

	?>										<!--    Header Company Information         -->
	<style type="text/css">
		 .table_valign { vertical-align: top;word-break: break-all;word-wrap: break-word; }
	</style>
	<table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black"  >
	<tr>
	<td width="100">
	<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
	</td>
	<td width="1250">
	<table width="100%" cellpadding="0" cellspacing="0"  >
	<tr>
	<td align="center" style="font-size:20px;">
	<?php
	echo $company_library[$cbo_company_name];
	?>
	</td>
	<td rowspan="3" width="250">

	<span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($job_no,"'"); ?></b></span><br/>
	<?
	if($nameArray_approved_row[csf('approved_no')]>1)
	{
	?>
	<b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
	<br/>
	Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
	<?
	}
	?>


	</td>
	</tr>
	<tr>
	<td align="center" style="font-size:14px">
	<?
	$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
	if($txt_job_no!="")
	{
	$location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'");
	}
	else
	{
	$location="";
	}

	foreach ($nameArray as $result)
	{
	echo  $location_name_arr[$location];
	?>

	Email Address: <? echo $result[csf('email')];?>
	Website No: <? echo $result[csf('website')]; ?>

	<?

	}

	?>
	</td>
	</tr>
	<tr>
	<td align="center" style="font-size:20px">
	<strong><? if($report_title !=""){ echo $report_title;} else { echo "General Work Order";}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
	</td>
	</tr>
	</table>
	</td>
	</tr>
	</table>
	<?
	$po_data=array();
	if($db_type==0){
	$nameArray_job=sql_select( "select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,DATEDIFF(pub_shipment_date,po_received_date) date_diff,MIN(po_received_date) as po_received_date ,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status  from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0   group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
	}
	if($db_type==2){
	$nameArray_job=sql_select( "SELECT b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,(pub_shipment_date-po_received_date) date_diff,MIN(po_received_date) as po_received_date,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status, c.order_uom, c.factory_marchant   from wo_booking_dtls a, wo_po_break_down b , wo_po_details_master c where a.po_break_down_id=b.id and b.job_id = c.id and b.job_id = c.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0  group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no,pub_shipment_date,po_received_date, b.po_quantity, b.insert_date,b.shiping_status, c.order_uom, c.factory_marchant");
	}

	foreach ($nameArray_job as $result_job){
		$po_data['po_id'][$result_job[csf('id')]]=$result_job[csf('id')];
		$po_data['po_number'][$result_job[csf('id')]]=$result_job[csf('po_number')];
		$po_data['leadtime'][$result_job[csf('id')]]=$result_job[csf('date_diff')];
		$po_data['po_quantity'][$result_job[csf('id')]]=$result_job[csf('po_quantity')];
		$po_data['po_received_date'][$result_job[csf('id')]]=change_date_format($result_job[csf('po_received_date')],'dd-mm-yyyy','-');
		$ddd=strtotime($result_job[csf('pub_shipment_date')]);
		$po_data['pub_shipment_date'][$ddd]=$ddd;
		$po_data['pub_shipment_date_po'][$result_job[csf('id')]]=$result_job[csf('pub_shipment_date')];
		$po_data['insert_date'][$result_job[csf('id')]]=$result_job[csf('insert_date')];

		if($result_job[csf('shiping_status')]==1){
		$shiping_status= "FP";
		}
		else if($result_job[csf('shiping_status')]==2){
		$shiping_status= "PS";
		}
		else if($result_job[csf('shiping_status')]==3){
		$shiping_status= "FS";
		}
		$po_data['shiping_status'][$result_job[csf('id')]]=$shiping_status;
		$po_data['file_no'][$result_job[csf('id')]]=$result_job[csf('file_no')];
		$po_data['grouping'][$result_job[csf('id')]]=$result_job[csf('grouping')];
		$uom_wise_qty[$result_job[csf('order_uom')]] += $result_job[csf('po_quantity')];
	}
	$txt_order_no_id=implode(",",array_unique($po_data['po_id']));
	$leadtime=implode(",",array_unique($po_data['leadtime']));
	$po_quantity=array_sum($po_data['po_quantity']);
	$po_received_date=implode(",",array_unique($po_data['po_received_date']));
	$po_number=implode(",",array_unique($po_data['po_number']));
	$shipment_date=date('d-m-Y',min($po_data['pub_shipment_date']));
	$maxshipment_date=date('d-m-Y',max($po_data['pub_shipment_date']));
	$shiping_status=implode(",",array_unique($po_data['shiping_status']));
	$file_no=implode(",",array_unique($po_data['file_no']));
	$grouping=implode(",",array_unique($po_data['grouping']));

	$colar_excess_percent=0;
	$cuff_excess_percent=0;
	$rmg_process_breakdown=0;
	$nameArray=sql_select( "select a.buyer_id,a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.update_date,a.uom,a.remarks,a.pay_mode,a.fabric_composition from wo_booking_mst a  where   a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 ");
	foreach ($nameArray as $result)
	{
		$total_set_qnty=$result[csf('total_set_qnty')];
		$colar_excess_percent=$result[csf('colar_excess_percent')];
		$cuff_excess_percent=$result[csf('cuff_excess_percent')];
		$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
		foreach ($po_data['po_id'] as $po_id=>$po_val){
			$daysInHand.=(datediff('d',date('d-m-Y',time()),$po_data['pub_shipment_date_po'][$po_id])-1).",";
			$booking_date=$result[csf('update_date')];
			if($booking_date=="" || $booking_date=="0000-00-00 00:00:00"){
			$booking_date=$result[csf('insert_date')];
			}
			$WOPreparedAfter.=(datediff('d',$po_data['insert_date'][$po_id],$booking_date)-1).",";
		}
	?>
	<table width="100%" style="border:1px solid black;table-layout: fixed;" id="table_h" >
	<tr>
	<td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
	</tr>
	<tr>
	<th>Buyer/Agent Name</th>	
	<td>:&nbsp;<? $buyer_name_str=""; if($client_id!=0) $buyer_name_str=$buyer_name_arr[$result[csf('buyer_id')]]."-".$buyer_name_arr[$client_id]; else $buyer_name_str=$buyer_name_arr[$result[csf('buyer_id')]];  if($show_yarn_rate!=0) { echo $buyer_name_str; } ?></b></td>
	<th>Product Depertment</th>
	<td>:&nbsp;
	<?
	echo $product_depertment ;
	if($product_code !=""){
	echo " (".$product_code.")";
	}
	if($pro_sub_dep != ""){
	echo " (".$pro_sub_dep.")";
	}
	?>
	</td>
	<th>Order Qnty</th>
	<td>:&nbsp;<? 
		$l=1; 
		foreach ($uom_wise_qty as $uomid => $qty) {
			if($l==1){
				$poqtydata .= $qty."(".$unit_of_measurement[$uomid].")" ;	
			}
			else{
				$poqtydata .= $qty."(".$unit_of_measurement[$uomid]."), " ;
			}
			
		}
		echo $poqtydata; ?>
			
	</td>
	</tr>
	<tr>

	<td><b>Garments Item</b></td>
	<td>:&nbsp;
	<?
	$gmts_item_name="";
	$gmts_item=explode(',',$gmts_item_id);
	for($g=0;$g<=count($gmts_item); $g++)
	{
	$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
	}
	echo rtrim($gmts_item_name,',');
	?>
	</td>
	<td><b>Booking Release Date</b></td>
	<td>:&nbsp;
	<?
	$booking_date=$result[csf('update_date')];
	if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
	{
	$booking_date=$result[csf('insert_date')];
	}
	echo change_date_format($booking_date,'dd-mm-yyyy','-','');
	?>&nbsp;&nbsp;&nbsp;</td>
	<td><b>Style Ref.</b>   </td>
	<td style="font-size:18px">:&nbsp;<b>
	<?
	if($show_yarn_rate!=0) { echo $style_sting; }
	?>
	</b>
	</td>
	</tr>
	<tr>
	<td><b>Style Des.</b></td>
	<td>:&nbsp;<? echo $style_description;?></td>	
	<td><b>Dealing Merchandiser</b></td>
	<td>:&nbsp;<? echo $dealing_marchant; ?></td>
	<td><b>Factory Merchandiser</b></td>
	<td>:&nbsp;<? echo $factory_marchant; ?></td>
	</tr>

	<tr>
	<td><b>Supplier Name</b> </td>
	<td>:&nbsp;
	<?
	if($result[csf('pay_mode')]==5){
	echo $company_library[$result[csf('supplier_id')]];
	}
	else{
	echo $supplier_name_arr[$result[csf('supplier_id')]];
	}
	?>    </td>
	<td><b>Delivery Date</b></td>
	<td>:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
	<td><b>Booking No </b>   </td>
	<td>:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?> <? //echo "(".$unit_of_measurement[$result[csf('uom')]].")"; $uom=$result[csf('uom')];?></td>
	</tr>
	<tr>
		<td  class="table_valign"><p><b>Attention</b></p></td>
		<td class="table_valign" ><p>:&nbsp;<? echo $result[csf('attention')]; ?></p></td>
		<td class="table_valign"><p><b>Lead Time </b> </p>  </td>
		<td class="table_valign"><p>:&nbsp;
			<?
			echo $leadtime;
			?> </p>
		</td>
		<td class="table_valign" ><p><b>Po Received Date</b></p></td>
		<td class="table_valign"><p>:&nbsp;<? echo $po_received_date; ?></p></td>
	</tr>
	<tr>
		<td class="table_valign"><b>Order No</b></td>
		<td class="table_valign" colspan="3">:&nbsp;<? echo $po_number; ?></td>
		<td class="table_valign"><b>Repeat No</b></td>
		<td class="table_valign">:&nbsp;<? echo $order_repeat_no; ?></td>
	</tr>
	<tr>
	<td><b>Shipment Date</b></td>
	<td colspan="3" style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> : First:&nbsp;<? echo rtrim($shipment_date,", "); //echo $max_pub_shipment_date; ?>, Last: <? echo $maxshipment_date; ?></td>
	<td><b>Quality Label</b></td>
	<td  >:&nbsp;<? echo $qlty_label; ?></td>
	</tr>
	</tr>
	<tr>
	<td><b>WO Prepared After</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
	<?
	$WOPreparedAfter=implode(",",array_unique(explode(",",chop($WOPreparedAfter,","))));
	echo $WOPreparedAfter.' Days' ;
	?></td>

	<td><b>Ship.days in Hand</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
	<?
	$daysInHand=implode(",",array_unique(explode(",",chop($daysInHand,","))));
	echo $daysInHand.' Days' ;
	?></td>

	<td><b>Ex-factory status</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
	<?
	echo $shiping_status;
	?></td>

	</tr>
	<tr>
	<td><b>Internal Ref No</b></td>
	<td> :&nbsp;<b><? echo $grouping; ?></b></td>
	<td><b>File no</b></td>
	<td> :&nbsp;<b><? echo  $file_no;?></b></td>
	<td><b>Currency</b></td>
	<td> :&nbsp;<b><? echo  $currency[$result[csf("currency_id")]];?></b></td>
	</tr>
	<tr>
	<td><b>Rmarks</b></td>
	<td colspan="3"> :<? echo $result[csf('remarks')]?></td>
	<td><b>Season</b></td>
	<td>:&nbsp;<?  if($season_matrix!="") echo $season_matrix; else echo $season_buyer_wise; ?></td>
	</tr>
	<tr>
	<td><b>Fabric Composition</b></td>
	<td colspan="5"> :<? echo $result[csf('fabric_composition')]?></td>
	</tr>

	</table>
	<?
	}

	if($cbo_fabric_source==1 || $cbo_fabric_source==2){
	$nameArray_size=sql_select( "select  size_number_id,min(id) as id,	min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  	is_deleted=0 and status_active!=0 group by size_number_id order by size_order");
	?>
	<table width="100%" >
	<tr>
	<td width="800">
	<div id="div_size_color_matrix" style="float:left; max-width:1000;">
	<fieldset id="div_size_color_matrix" style="max-width:1000;">
	<legend>Size and Color Breakdown</legend>
	<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
	<tr>
	<td style="border:1px solid black"><strong>Color/Size</strong></td>
	<?
	foreach($nameArray_size  as $result_size)
	{	     ?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?	}    ?>
	<td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
	<td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
	<td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
	</tr>
	<?
	$color_size_order_qnty_array=array();
	$color_size_qnty_array=array();
	$size_tatal=array();
	$size_tatal_order=array();
	for($c=0;$c<count($gmts_item); $c++)
	{
	$item_size_tatal=array();
	$item_size_tatal_order=array();
	$item_grand_total=0;
	$item_grand_total_order=0;
	$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active!=0 group by color_number_id  order by color_order");
	?>
	<tr>
	<td style="border:1px solid black" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>

	</tr>
	<?
	foreach($nameArray_color as $result_color)
	{
	?>
	<tr>
	<td align="center" style="border:1px solid black"><? echo $color_library[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
	<?
	$color_total=0;
	$color_total_order=0;

	foreach($nameArray_size  as $result_size)
	{
	$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active!=0 and is_deleted =0");
	foreach($nameArray_color_size_qnty as $result_color_size_qnty)
	{
	?>
	<td style="border:1px solid black; text-align:right">
	<?
	if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
	{
	echo number_format($result_color_size_qnty[csf('order_quantity')],0);
	$color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
	$color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
	$item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
	$item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
	$grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
	$grand_total_order +=$result_color_size_qnty[csf('order_quantity')];


	$color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
	$color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
	if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
	{
	$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
	$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
	}
	else
	{
	$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
	$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
	}
	if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
	{
	$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
	$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
	}
	else
	{
	$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
	$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
	}
	}
	else echo "0";
	?>
	</td>

	<?
	}
	}
	?>
	<td style="border:1px solid black; text-align:right"><?  echo number_format(round($color_total_order),0); ?></td>

	<td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?>
	</td>
	<td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total),0); ?></td>
	</tr>
	<?
	}
	?>

	<td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
	<?
	foreach($nameArray_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:right"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total_order),0); ?></td>
	<td  style="border:1px solid black;  text-align:right"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
	<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total),0); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td style="border:1px solid black" align="center" colspan="<? echo count($nameArray_size)+3; ?>"><strong>&nbsp;</strong></td>
	</tr>
	<tr>
	<tr>
	<td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
	<?
	foreach($nameArray_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:right"><? echo $size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total_order),0); ?></td>
	<td  style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
	<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total),0); ?></td>
	</tr>
	</table>
	</fieldset>
	</div>
	</td>
	<td width="200" valign="top" align="left">
	<div id="div_size_color_matrix" style="float:left;">
	<?
	$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
	?>
	<fieldset>
	<legend>RMG Process Loss % </legend>
	<table width="180" class="rpt_table" border="1" rules="all">
	<?
	if(number_format($rmg_process_breakdown_arr[8],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Cut Panel rejection <!-- Extra Cutting % breack Down 8-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[8],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[2],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Chest Printing <!-- Printing % breack Down 2-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[2],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[10],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Neck/Sleeve Printing <!-- New breack Down 10-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[10],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[1],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Embroidery   <!-- Embroidery  % breack Down 1-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[1],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[4],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Sewing /Input<!-- Sewing % breack Down 4-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[4],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[3],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Garments Wash <!-- Washing %breack Down 3-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[3],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[15],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Gmts Finishing <!-- Washing %breack Down 3-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[15],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[11],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Others <!-- New breack Down 11-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[11],2);
	?>
	</td>
	</tr>
	<?
	}
	$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
	if($gmts_pro_sub_tot>0)
	{
	?>
	<tr>
	<td width="130">
	Sub Total <!-- New breack Down 11-->
	</td>
	<td align="right">
	<?

	echo number_format($gmts_pro_sub_tot,2);
	?>
	</td>
	</tr>
	<?
	}
	?>
	</table>
	</fieldset>


	<fieldset>
	<legend>Fabric Process Loss % </legend>
	<table width="180" class="rpt_table" border="1" rules="all">
	<?
	if(number_format($rmg_process_breakdown_arr[6],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Knitting  <!--  Knitting % breack Down 6-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[6],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[12],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Yarn Dyeing  <!--  New breack Down 12-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[12],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[5],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Dyeing & Finishing  <!-- Finishing % breack Down 5-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[5],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[13],2)>0)
	{
	?>
	<tr>
	<td width="130">
	All Over Print <!-- new  breack Down 13-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[13],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[14],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Lay Wash (Fabric) <!-- new  breack Down 14-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[14],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[7],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Dying   <!-- breack Down 7-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[7],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[0],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Cutting (Fabric) <!-- Cutting % breack Down 0-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[0],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[9],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Others  <!-- Others% breack Down 9-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[9],2);
	?>
	</td>
	</tr>
	<?
	}
	$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
	if(fab_proce_sub_tot>0)
	{
	?>
	<tr>
	<td width="130">
	Sub Total  <!-- Others% breack Down 9-->
	</td>
	<td align="right">
	<?

	echo number_format($fab_proce_sub_tot,2);
	?>
	</td>
	</tr>
	<?
	}
	if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
	{
	?>
	<tr>
	<td width="130">
	Grand Total  <!-- Others% breack Down 9-->
	</td>
	<td align="right">
	<?
	echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2);
	?>
	</td>
	</tr>
	<?
	}
	?>
	</table>
	</fieldset>
	</div>
	</td>
	<td width="330" valign="top" align="left">
	<?
	$nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id in($job_no_in) and file_type=1");
	?>
	<div id="div_size_color_matrix" style="float:left;">
	<fieldset>
	<legend>Image</legend>
	<table width="310">
	<tr>
	<?
	$img_counter = 0;
	foreach($nameArray_imge as $result_imge)
	{
	if($path=="")
	{
	$path='../../';
	}
	?>
	<td>
	<img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />
	</td>
	<?

	$img_counter++;
	}
	?>
	</tr>
	</table>
	</fieldset>
	</div>
	</td>
	</tr>
	</table>
	<?
	}// if($cbo_fabric_source==1) end

	?>
	<br/>
	<!--  Here will be the main portion  -->
	<?
	$costing_per="";
	$costing_per_qnty=0;
	$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no in($job_no_in)");
	if($costing_per_id==1)
	{
	$costing_per="1 Dzn";
	$costing_per_qnty=12;

	}
	if($costing_per_id==2)
	{
	$costing_per="1 Pcs";
	$costing_per_qnty=1;

	}
	if($costing_per_id==3)
	{
	$costing_per="2 Dzn";
	$costing_per_qnty=24;

	}
	if($costing_per_id==4)
	{
	$costing_per="3 Dzn";

	$costing_per_qnty=36;

	}
	if($costing_per_id==5)
	{
	$costing_per="4 Dzn";
	$costing_per_qnty=48;
	}
	$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no in($job_no_in)");

	$uom_arr=array(1=>"Pcs",12=>"Kg",23=>"Mtr",27=>"Yds");
	foreach($uom_arr as $uom_id=>$uom_val){
	if($cbo_fabric_source==1){
	$nameArray_fabric_description= sql_select("SELECT a.job_no, a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , b.dia_width,d.pre_cost_remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_number_id=d.gmts_color_id and b.dia_width=d.dia_width and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.uom=$uom_id and d.status_active=1 and d.is_deleted=0 and b.cons>0 group by a.job_no, a.id,a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,b.dia_width,d.pre_cost_remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width"); 

	if(count($nameArray_fabric_description)>0){
	?>

	<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
	<caption style="font-weight: bold; font-size: 18px">Fabric Details in <? echo $uom_val ?></caption>
	<tr align="center">
	<th colspan="3" align="left">Job</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{	if( $result_fabric_description[csf('job_no')] == "")
		echo "<td colspan='3'>&nbsp</td>";
		else
		echo "<td colspan='3'>". $result_fabric_description[csf('job_no')]."</td>";
	}
	?>	
	<td  rowspan="13" width="50"><p>Total Finish Fabric</p></td>

	<td  rowspan="13" width="50"><p>Avg Rate</p></td>
	<td  rowspan="13" width="50"><p>Amount </p></td>
	</tr>
	<tr align="center">
		<th colspan="3" align="left">Style</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{   if( $result_fabric_description[csf('job_no')] == "")
		{
			echo "<td colspan='3'>&nbsp</td>";
		}		
		else
		{
			if($show_yarn_rate!=0) { 
			echo "<td colspan='3'>". $job_data_arr['style_ref_no'][$result_fabric_description[csf('job_no')]]."</td>";
			}
			else{
				echo "<td colspan='3'>&nbsp</td>";
			}
		}		
	}?>	
	</tr>
	<tr align="center">
	<th colspan="3" align="left">Item Name</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('body_part_id')] == "")
	echo "<td colspan='3'>&nbsp</td>";
	else
	echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
	}
	?>
	</tr>
	<tr align="center">
	<th colspan="3" align="left">Body Part</th>
	<?

	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('body_part_id')] == "")
	echo "<td colspan='3'>&nbsp</td>";
	else
	echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th colspan="3" align="left">Color Type</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
	else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th colspan="3" align="left">Fabric Construction</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
	else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
	}
	?>


	</tr>
	<tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
	else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
	}
	?>

	</tr>
	<tr align="center"><th  colspan="3" align="left">GSM</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
	else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
	}
	?>

	</tr>
	<tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
	else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
	}
	$order_uom=$job_data_arr['order_uom'][$result_fabric_description[csf('job_no')]];
	?>

	</tr>
	<tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per.'  ('.$unit_of_measurement[$order_uom].')'; ?></th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
	else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],4)."</td>";
	}
	?>
	</tr>
    <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('pre_cost_remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('pre_cost_remarks')]."</td>";
		}
		?>

       </tr>
	<tr>
	<th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
	</tr>
	<tr>
	<th  width="120" align="left">Fabric Color</th>
	<th  width="120" align="left">Body Color</th>
	<th  width="120" align="left">Lab Dip No</th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
	}
	?>
	</tr>
	<?
	$gmt_color_library=array();
	$gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
	FROM
	wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
	WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=$uom_id  and a.fabric_source =$cbo_fabric_source and
	a.job_no in ($job_no_in)");
	foreach( $gmt_color_data as $gmt_color_row){
	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
	}
	$grand_total_fin_fab_qnty=0;
	$grand_total_amount=0;
	$color_wise_wo_sql=sql_select("select b.fabric_color_id
	FROM
	wo_pre_cost_fabric_cost_dtls a,
	wo_booking_dtls b
	WHERE
	a.id=b.pre_cost_fabric_cost_dtls_id and
	a.uom=$uom_id and
	b.booking_no =$txt_booking_no and
	b.status_active=1 and
	b.is_deleted=0
	group by b.fabric_color_id");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	?>
	<tr>
	<td  width="120" align="left">
	<?
	echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
	?>
	</td>
	<td>
	<?
	echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
	?>
	</td>
	<td  width="120" align="left">
	<?
	$lapdip_no="";
	$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
	if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
	?>
	</td>
	<?
	$total_fin_fab_qnty=0;
	$total_amount=0;

	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if($db_type==0)
	{
	$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=$uom_id and
	a.id='".$result_fabric_description[csf('fabric_cost_dtls_id')]."' and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
	d.fabric_color_id='".$color_wise_wo_result[csf('fabric_color_id')]."' and
	d.status_active=1 and
	d.is_deleted=0
	");
	}
	if($db_type==2)
	{
	$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=$uom_id and
	a.id='".$result_fabric_description[csf('fabric_cost_dtls_id')]."' and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
	nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
	d.status_active=1 and
	d.is_deleted=0
	");
	}
	list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
	?>
	<td width='50' align='right'>
	<?
	if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
	{
	echo def_number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;
	$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('fin_fab_qnty')];
	}
	?>
	</td>
	<td width='50' align='right' >
	<?
	if($color_wise_wo_result_qnty[csf('rate')]!="")
	{
	if($show_yarn_rate!=0) { echo def_number_format($color_wise_wo_result_qnty[csf('rate')],5); }
	
	}
	?>
	</td>
	<td width='50' align='right' >
	<?
	$amount=def_number_format($color_wise_wo_result_qnty[csf('amount')],2,'',0);
	if($amount!="")
	{
	echo $amount;
	$total_amount+=$amount;
	}
	?>
	</td>
	<?
	}
	?>
	<td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
	<td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
	<td align="right">
	<?
	echo def_number_format($total_amount,2);

	?>
	</td>
	</tr>
	<?
	}
	?>
	<tr style=" font-weight:bold">
	<th  width="120" align="left">&nbsp;</th>
	<td  width="120" align="left">&nbsp;</td>
	<td  width="120" align="left"><strong>Total</strong></td>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=$uom_id and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
	d.status_active=1 and
	d.is_deleted=0
	");
	list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
	?>
	<td width='50' align='right'><?  echo def_number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;?></td>
	<td width='50' align='right'></td>
	<td width='50' align='right'></td>
	<?
	}
	?>
	<td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
	<td align="right"><? echo def_number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
	<td align="right">
	<?
	echo def_number_format($grand_total_amount,2);
	?>
	</td>
	</tr>	
	</table>
	<br/>
	<?
	}
	}
	}
	//===========================

	foreach($uom_arr as $uom_id=>$uom_val){
	if($cbo_fabric_source==2){
	$nameArray_fabric_description= sql_select("SELECT a.job_no, a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , b.dia_width,d.pre_cost_remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_number_id=d.gmts_color_id and b.dia_width=d.dia_width and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.uom=$uom_id and d.status_active=1 and d.is_deleted=0  and b.cons>0 group by a.id,a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,b.dia_width,d.pre_cost_remarks,a.job_no order by fabric_cost_dtls_id,a.body_part_id,b.dia_width"); 
	if(count($nameArray_fabric_description)>0){
	?>
	<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
	<caption style="font-weight: bold; font-size: 18px">Fabric Details in <? echo $uom_val;?></caption>
	<tr align="center">
	<th colspan="3" align="left">Job</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{	if( $result_fabric_description[csf('job_no')] == "")
		echo "<td colspan='3'>&nbsp</td>";
		else
		echo "<td colspan='3'>". $result_fabric_description[csf('job_no')]."</td>";
	}
	?>	
	<td  rowspan="13" width="50"><p>Total Finish Fabric</p></td>

	<td  rowspan="13" width="50"><p>Avg Rate</p></td>
	<td  rowspan="13" width="50"><p>Amount </p></td>
	</tr>
	<tr align="center">
		<th colspan="3" align="left">Style</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{   
		if( $result_fabric_description[csf('job_no')] == "")
		{
			echo "<td colspan='3'>&nbsp</td>";
		}		
		else
		{
			if($show_yarn_rate!=0) { 
			echo "<td colspan='3'>". $job_data_arr['style_ref_no'][$result_fabric_description[csf('job_no')]]."</td>";
			}
			else{
				echo "<td colspan='3'>&nbsp</td>";
			}
		}
	}?>	
	</tr>
	<tr align="center">
	<th colspan="3" align="left">Item Name</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('body_part_id')] == "")
	echo "<td colspan='3'>&nbsp</td>";
	else
	echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
	}
	?>
	</tr>
	<tr align="center">
	<th colspan="3" align="left">Body Part</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('body_part_id')] == "")
	echo "<td colspan='3'>&nbsp</td>";
	else
	echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th colspan="3" align="left">Color Type</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
	else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th colspan="3" align="left">Fabric Construction</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
	else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
	else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th  colspan="3" align="left">GSM</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
	else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
	else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
	}
	$order_uom=$job_data_arr['order_uom'][$result_fabric_description[csf('job_no')]];
	?>

	</tr>
	<tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per.'  ('.$unit_of_measurement[$order_uom].')'; ?></th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
	else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],4)."</td>";
	}
	?>

	</tr>
    <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('pre_cost_remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('pre_cost_remarks')]."</td>";
		}
		?>

       </tr>
	<tr>
	<th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
	</tr>
	<tr>
	<th  width="120" align="left">Fabric Color</th>
	<th  width="120" align="left">Body Color</th>
	<th  width="120" align="left">Lab Dip No</th>
	<?
	if($cbo_fabric_source==2)
	{
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
	}
	}
	else
	{
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	echo "<th width='50'>Fab. Qty</th>";
	}
	}

	?>
	</tr>
	<?
	$gmt_color_library=array();

	$gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
	FROM
	wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
	WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=$uom_id  and a.fabric_source =$cbo_fabric_source and
	a.job_no in ($job_no_in)");
	foreach( $gmt_color_data as $gmt_color_row){
	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
	}
	$grand_total_fin_fab_qnty=0;
	$grand_total_amount=0;
	$color_wise_wo_sql=sql_select("select b.fabric_color_id
	FROM
	wo_pre_cost_fabric_cost_dtls a,
	wo_booking_dtls b
	WHERE
	a.id=b.pre_cost_fabric_cost_dtls_id and
	a.uom=$uom_id and
	b.booking_no =$txt_booking_no and
	b.status_active=1 and
	b.is_deleted=0
	group by b.fabric_color_id");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	?>
	<tr>
	<td  width="120" align="left">
	<?
	echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
	?>
	</td>
	<td>
	<?
	echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
	?>
	</td>
	<td  width="120" align="left">
	<?
	$lapdip_no="";
	$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
	if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
	?>
	</td>
	<?
	$total_fin_fab_qnty=0;
	$total_amount=0;

	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if($db_type==0)
	{
	$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=$uom_id and
	a.id='".$result_fabric_description[csf('fabric_cost_dtls_id')]."' and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
	d.fabric_color_id='".$color_wise_wo_result[csf('fabric_color_id')]."' and
	d.status_active=1 and
	d.is_deleted=0
	");
	}
	if($db_type==2)
	{
	$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=$uom_id and
	a.id='".$result_fabric_description[csf('fabric_cost_dtls_id')]."' and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
	nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
	d.status_active=1 and
	d.is_deleted=0
	");
	}
	list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
	?>
	<td width='50' align='right'>
	<?
	if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
	{
	echo def_number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;
	$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('fin_fab_qnty')];
	}
	?>
	</td>
	<td width='50' align='right' >
	<?
	if($color_wise_wo_result_qnty[csf('rate')]!="")
	{
	//echo def_number_format($color_wise_wo_result_qnty[csf('rate')],5);
	if($show_yarn_rate!=0) { echo def_number_format($color_wise_wo_result_qnty[csf('rate')],5); }
	}
	?>
	</td>
	<td width='50' align='right' >
	<?
	$amount=def_number_format($color_wise_wo_result_qnty[csf('amount')],2,'',0);
	if($amount!="")
	{
	echo $amount;
	$total_amount+=$amount;
	}
	?>
	</td>
	<?
	}
	?>
	<td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
	<td align="right"><? if($show_yarn_rate!=0) { echo def_number_format($total_amount/$total_fin_fab_qnty,2);  }?><? $grand_total_amount+=$total_amount; ?></td>
	<td align="right">
	<?
	echo def_number_format($total_amount,2);

	?>
	</td>
	</tr>
	<?
	}
	?>
	<tr style=" font-weight:bold">
	<th  width="120" align="left">&nbsp;</th>
	<td  width="120" align="left">&nbsp;</td>
	<td  width="120" align="left"><strong>Total</strong></td>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=$uom_id and
	a.id='".$result_fabric_description[csf('fabric_cost_dtls_id')]."' and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
	d.status_active=1 and
	d.is_deleted=0
	");
	list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
	?>
	<td width='50' align='right'><?  echo def_number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;?></td>
	<td width='50' align='right' ></td>
	<td width='50' align='right' ></td>
	<?
	}
	?>
	<td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
	<td align="right"><? if($show_yarn_rate!=0) { echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2); } //echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
	<td align="right">
	<?
	echo def_number_format($grand_total_amount,2);
	?>
	</td>
	</tr>
	</table>
	<br/>
	<?
	}
	}
	}
	//===========================
	 
    //Collar Cuff && Item Size Dtls
  		if($cbo_fabric_source==1 || $cbo_fabric_source==2)
		{
			$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no in($job_no_in)");
			//echo "select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no in($job_no_in)";
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}
			
			

			$collar_cuff_percent_arr=array(); $collar_cuff_body_arr=array(); $collar_cuff_color_arr=array(); $collar_cuff_size_arr=array(); $collar_cuff_item_size_arr=array(); $color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.item_number_id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=b.color_size_table_id and d.gmts_color_id=b.color_number_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);
			
			$itemIdArr=array();

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				if(!empty($collar_cuff_row[csf('item_size')]))
				{
					$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				}
				
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];
				
				$itemIdArr[$collar_cuff_row[csf('body_part_type')]].=$collar_cuff_row[csf('item_number_id')].',';
			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res);
			//$count_collar_cuff=count($collar_cuff_size_arr);
			$booking_po_id=$txt_order_no_id;
			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select item_number_id, color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($booking_po_id) and status_active=1 and is_deleted =0  group by item_number_id, color_number_id, size_number_id");
			//echo  "select item_number_id, color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($booking_po_id) and status_active=1 and is_deleted =0  group by item_number_id, color_number_id, size_number_id";
			//and item_number_id in (".implode(",",$itemIdArr).")
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}
			unset($color_wise_wo_sql_qnty);

			
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				$gmtsItemId=array_filter(array_unique(explode(",",$itemIdArr[$body_type])));
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;

					?>
                    <div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin:5px; margin-bottom:5px; position:relative;font-size:18px;">
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size</td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 foreach($size_number  as $item_size=>$val)
									 {
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									 }
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }
                            ?>
                        </tr>
                            <?

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													$plan_cut=0;
													foreach($gmtsItemId as $giid)
													{
														if($body_type==50) $plan_cut+=($order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'])*2;
														else $plan_cut+=$order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'];
													}
													
                                                    //$ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';

												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
                                                    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        
                        <tr>
                            <td>Size Total</td>
								<?
                               // foreach($pre_size_total_arr  as $size_qty)
                               // {
                                	foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
									{
										$size_qty=$pre_size_total_arr[$size_number_id];
										?>
										<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
										<?
									}

                               // }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>
                <br/>
                <?
            }
        }

        ?>

       		 <table width="98%">
       		 	<tr>
       		 		<td width="45%" style="float: left;">
       		 			<?php 

       		 				$sql_purchase="SELECT a.booking_no, a.uom, sum(b.fin_fab_qnty) as qnty , b.construction, b.copmposition, b.gsm_weight as dia, b.dia_width as gsm from wo_booking_mst a, wo_booking_dtls b where     a.booking_no = b.booking_no and a.fabric_source = 2 and b.job_no = '$txt_job_no' and b.status_active = 1 and b.is_deleted = 0 and a.status_active = 1 and a.is_deleted = 0 and  a.booking_type=1 group by a.booking_no, a.uom, b.construction, b.copmposition, b.dia, b.gsm_weight, b.dia_width"; 
       		 				//echo $sql_purchase;
							$purchase_res=sql_select($sql_purchase);
							?>
							<table  width="98%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

 			                   <thead>
				                   <tr align="center">
				                    	<th colspan="5"><b>Purchased Booking Info</b></th>
				                    </tr>
				                    <tr align="center">
					                    <th>Sl</th>
					                    <th>Booking No</th>
					                    <th>Fabric Data</th>
					                    <th>UOM</th>
					                    <th>Qnty</th>
					                   
				                    </tr>
 			                   </thead>
 			                   <tbody>
 			                   		<?

 			                   			foreach ($purchase_res as  $row) 
 			                   			{
 			                   				?>
 			                   				<tr>
 			                   					<td><?=$p++;?></td>
 			                   					<td><p><?=$row[csf('booking_no')];?></p></td>
 			                   					<td><p><?=$row[csf('construction')] .", ".$row[csf('copmposition')].", ".$row[csf('gsm')].", ".$row[csf('dia')];?></p></td>
 			                   					<td><p><?=$unit_of_measurement[$row[csf('uom')]];?></p></td>
 			                   					<td><p><?=number_format($row[csf('qnty')],2);?></p></td>
 			                   				</tr>
 			                   				<?
 			                   			}


 			                   		?>
 			                   </tbody>
 			                   
 			            </table>

       		 			 
       		 		</td>
       		 		<td width="45%" style="float: right;">
 			       		 <table  width="98%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

 			                   <tr align="center">
 			                    	<td colspan="10"><b>Dyes To Match</b></td>
 			                    </tr>
 			                    <tr align="center">
 				                    <td>Sl</td>
 				                    <td>Item</td>
 				                    <td>Item Description</td>
 				                    <td>Body Color</td>
 				                    <td>Item Color</td>
 				                    <td>Finish Qty.</td>
 				                    <td>UOM</td>
 			                    </tr>
 			                    <?
 								$lib_item_group_arr=return_library_array( "select item_name, id from lib_item_group where item_category=4 and is_deleted=0  and  status_active=1 order by item_name", "id", "item_name");
 								$sql=sql_select("select id from wo_booking_mst where booking_no=$txt_booking_no");
 								$bookingId=0;
 								foreach($sql as $row){
 									$bookingId= $row[csf('id')];
 								}
 								$co=0;
 								$sql_data=sql_select("select a.fabric_color,a.item_color,a.precost_trim_cost_id,b.trim_group,b.cons_uom,sum(qty) as qty, b.description   from wo_dye_to_match a, wo_pre_cost_trim_cost_dtls b where a.precost_trim_cost_id=b.id and a.booking_id=$bookingId and a.qty>0 and a.status_active=1 and b.status_active=1  group by a.fabric_color,a.item_color,a.precost_trim_cost_id,b.trim_group,b.cons_uom, b.description order by a.fabric_color");

 								foreach($sql_data  as $row)
 			                    {
 									$co++;
 									?>
 				                    <tr>
 				                    <td><? echo $co; ?></td>
 				                    <td> <? echo $lib_item_group_arr[$row[csf('trim_group')]];?></td>
 				                    <td><p> <? echo $row[csf('description')];?></p></td>
 				                    <td><? echo $color_library[$row[csf('fabric_color')]];?></td>
 				                    <td><? echo $color_library[$row[csf('item_color')]];?></td>
 				                    <td align="right"><? echo $row[csf('qty')];?></td>
 				                    <td><? echo $unit_of_measurement[$row[csf('cons_uom')]];?></td>
 				                    </tr>

 				                    <?
 								}
 								?>
 			            </table>
       		 		</td>
       		 	</tr>
       		 </table>
            <br>

        <?

		 $condition= new condition();
		if(str_replace("'","",$txt_order_no_id) !=''){
			$condition->po_id("in(".str_replace("'","",$txt_order_no_id).")");
		}

		$condition->init();
		$cos_per_arr=$condition->getCostingPerArr();
		$yarn= new yarn($condition);
		$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');

		$yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.count_id, a.copm_one_id, a.percent_one, a.color, a.type_id, sum(a.cons_qnty) as yarn_required, a.rate  from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no='$job_no' and b.booking_no=$txt_booking_no  and  a.status_active=1 and a.is_deleted=0 group by a.count_id,a.copm_one_id,a.percent_one,a.color,a.type_id,a.rate order by id");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;font-size:18px;" >
            <tr>
                <td width="49%" valign="top">
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Yarn Required Summary (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                    <td>Rate</td>
                    <?
					}
					?>
                    <td>Cons for <? echo $costing_per; ?> Gmts</td>
                    <td>Total (KG)</td>
                    </tr>
                    <?
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
						$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
						$rowcons_Amt = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];


						$rate=$rowcons_Amt/$rowcons_qnty;
						$rowcons_qnty =($rowcons_qnty/100)*$booking_percent;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					$yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
					$yarn_des.=$color_library[$row[csf('color')]]." ";
					$yarn_des.=$yarn_type[$row[csf('type_id')]];
					echo $yarn_des;
					?>
                    </td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                     <td><? echo number_format($row[csf('rate')],4); ?></td>
                     <?
					}
					 ?>
                    <td><?  echo number_format(($rowcons_qnty/$po_qnty_tot)*$cos_per_arr[$job_no],4);//echo number_format($row[csf('yarn_required')],4); ?></td>

                    <td align="right">
					<? echo number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                    <td></td>
                    <?
                    }
					?>
                    <td></td>
                    <td align="right"><? echo number_format($total_yarn,2); ?></td>
                    </tr>
                    </table>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                <?
				$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id order by a.id");
				if(count($yarn_sql_array)>0)
				{
				?>
                   <table  width="100%"  style="font-size:18px;" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Allocated Yarn</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>


                    <td>Allocated Qty (Kg)</td>
                    </tr>
                    <?
					$total_allo=0;
					$item=return_library_array( "select id, product_name_details from   product_details_master",'id','product_name_details');
					$supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?

					echo $item[$row[csf('item_id')]];
					?>
                    </td>
                    <td>
                    <?

					echo $supplier[$row[csf('supplier_id')]];
					?>
                    </td>
                    <td>
					<?

					echo $row[csf('lot')];
					?>
                    </td>
                    <td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>


                    <td></td>
                    <td></td>
                    <td align="right"><? echo number_format($total_allo,4); ?></td>
                    </tr>
                    </table>
                    <?
				}
				else
				{
					$is_yarn_allocated=return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_name and variable_list=18 and item_category_id=1");
					if($is_yarn_allocated==1)
					{
					?>
					<font style=" font-size:30px"><b> </b></font>
                    <?
					}
					else
					{
						echo "";
					}
				}
					?>
                </td>
                 <td width="49%" valign="top" align="center">
                	
               	
                </td>
            </tr>
        </table>
        <br/>
        <?
		$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;font-size:18px;">
            <tr>
                <td width="49%" valign="top">
                <?
				if(count($sql_embelishment)>0)
				{
				?>
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;font-size:18px;">
                    <tr align="center">
                    <td colspan="7"><b>Embelishment (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Embelishment Name</td>
                    <td>Embelishment Type</td>
                    <td>Cons <? echo $costing_per; ?> Gmts</td>
                    <td>Rate</td>
                    <td>Amount</td>

                    </tr>
                    <?
					$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
					$i=0;
					//$total_yarn=0;
					foreach($sql_embelishment  as $row_embelishment)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					echo $emblishment_name_array[$row_embelishment[csf('emb_name')]];
					?>
                    </td>
                    <td>
                    <?
					if($row_embelishment[csf('emb_name')]==1)
					{
					echo $emblishment_print_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==2)
					{
					echo $emblishment_embroy_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==3)
					{
					echo $emblishment_wash_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==4)
					{
					echo $emblishment_spwork_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==5)
					{
					echo $emblishment_gmts_type[$row_embelishment[csf('emb_type')]];
					}
					?>

                    </td>
                    <td>
                    <?
					echo $row_embelishment[csf('cons_dzn_gmts')];
					?>
                    </td>
                    <td>
					<?
					echo $row_embelishment[csf('rate')];
					?>
                    </td>

                    <td>
					<?
					echo $row_embelishment[csf('amount')];
					?>
                    </td>


                    </tr>
                    <?
					}
					?>

                    </table>
                    <?
				}
					?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                				<?
                				$lib_designation_arr=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");
									 $user_lib_designation_arr=return_library_array("SELECT id,designation from user_passwd", "id", "designation");
									 $user_lib_name_arr=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");

								$mst_id=return_field_value("id as mst_id","wo_booking_mst","booking_no=$txt_booking_no","mst_id");
                				 $unapprove_data_array=sql_select("select b.approved_by,b.approved_date,b.un_approved_reason,b.un_approved_date,b.approved_no from   approval_history b where b.mst_id=$mst_id and b.entry_form=7  order by b.approved_date,b.approved_by");


                				if(count($unapprove_data_array)>0)
                				{
                				$sql_unapproved=sql_select("select booking_id,approval_cause from fabric_booking_approval_cause where  entry_form=7 and approval_type=2 and is_deleted=0 and status_active=1 and booking_id=$mst_id");
                					$unapproved_request_arr=array();
                					foreach($sql_unapproved as $rowu)
                					{
                						$unapproved_request_arr[$rowu[csf('booking_id')]]=$rowu[csf('approval_cause')];
                					}
                		 		?>
                		       <table  width="100%" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
                		            <thead>
                		            <tr style="border:1px solid black;">
                		                <th colspan="6" style="border:1px solid black;">Approval/Un Approval History</th>
                		                </tr>
                		                <tr style="border:1px solid black;">
                		                <th width="3%" style="border:1px solid black;">Sl</th>
                						<th width="30%" style="border:1px solid black;">Name</th>
                						<th width="20%" style="border:1px solid black;">Designation</th>
                						<th width="5%" style="border:1px solid black;">Approval Status</th>
                						<th width="20%" style="border:1px solid black;">Reason For Un Approval</th>
                						<th width="22%" style="border:1px solid black;"> Date</th>

                		                </tr>
                		            </thead>
                		            <tbody>
                		            <?
                					$i=1;
                					foreach($unapprove_data_array as $row){

                					?>
                		            <tr style="border:1px solid black;">
                		                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
                						<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
                						<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
                						<td width="5%" style="border:1px solid black; text-align:center"><? echo 'Yes';?></td>
                						<td width="20%" style="border:1px solid black;"><? echo '';?></td>
                						<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); else echo "";?></td>
                		            </tr>
                		                <?
                						$i++;
                						$un_approved_date= explode(" ",$row[csf('un_approved_date')]);
                						$un_approved_date=$un_approved_date[0];
                						if($db_type==0) //Mysql
                						{
                							if($un_approved_date=="" || $un_approved_date=="0000-00-00") $un_approved_date="";else $un_approved_date=$un_approved_date;
                						}
                						else
                						{
                							if($un_approved_date=="") $un_approved_date="";else $un_approved_date=$un_approved_date;
                						}

                						if($un_approved_date!="")
                						{
                						?>
                					<tr style="border:1px solid black;">
                		                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
                						<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
                						<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
                						<td width="5%" style="border:1px solid black;text-align:center;"><? echo 'No';?></td>
                						<td width="20%" style="border:1px solid black;text-align:center"><? echo $unapproved_request_arr[$mst_id];?></td>
                						<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('un_approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('un_approved_date')])); else echo "";?></td>
                		              </tr>

                		                <?
                						$i++;
                						}

                					}
                						?>
                		            </tbody>
                		        </table>
                				<?
                				}
                				?>

                </td>
            </tr>
        </table>
        <br/>
        <table  width="100%" style="margin: 0px;padding: 0px;">
        <?php $stripe_color_wise=array(); ?>
       
        <tr>
        	<td width="70%" style="float: left;">
        		<table  class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all" width="100%"   style="font-family:Arial Narrow;font-size:18px;margin: 0px;padding: 0px;" >
        		       
        		        <tr>
        		            <td align="center" colspan="9">  Stripe Details</td>
        		            
    		            </tr>
        		        <?
        				$color_name_arr=return_library_array( "select id,color_name from lib_color",'id','color_name');
        				$sql_stripe=("select c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.id as did,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,d.uom  from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no='$job_no'  and d.job_no='$job_no' and b.booking_no=$txt_booking_no  and c.color_type_id in (2,6,33,34) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and 	b.is_deleted=0  group by c.id,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,d.uom,c.composition,c.construction,b.dia_width order by d.id ");        				
        				$result_data=sql_select($sql_stripe);
        				foreach($result_data as $row)
        				{
        					$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
        					$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
        					$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
        					$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
        					$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

        					$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
        					$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
        					$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
        					$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
        					$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
        				}
        				?>
        		            <tr>
	        		            <td align="center" width="30"> SL</td>
	        		            <td align="center" width="100"> Body Part</td>
	        		            <td align="center" width="80"> Fabric Color</td>
	        		            <td align="center" width="70"> Fabric Qty(KG)</td>
	        		            <td align="center" width="70"> Stripe Color</td>
	        		            <td align="center" width="70"> Stripe Measurement</td>
	        		            <td align="center" width="70"> Stripe Uom</td>
	        		            <td  align="center" width="70"> Qty.(KG)</td>
	        		            <td  align="center" width="70"> Y/D Req.</td>
        		            </tr>
        		            <?
        					//if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
        					//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";
        						//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";


        					$i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
        		            foreach($stripe_arr as $body_id=>$body_data)
        		            {
        						foreach($body_data as $color_id=>$color_val)
        						{
        							$rowspan=count($color_val['stripe_color']);
        							$composition=$stripe_arr2[$body_id][$color_id]['composition'];
        							$construction=$stripe_arr2[$body_id][$color_id]['construction'];
        							$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
        							$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
        							$dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];

        							if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
        							else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";

        							$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
        								WHERE a.job_no=b.job_no and
        								a.id=b.pre_cost_fabric_cost_dtls_id and
        								c.job_no_mst=a.job_no and
        								c.id=b.color_size_table_id and
        								b.po_break_down_id=d.po_break_down_id and
        								b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
        								d.booking_no =$txt_booking_no and
        								a.body_part_id='".$body_id."' and
        								a.color_type_id='".$color_type_id."' and
        								a.construction='".$construction."' and
        								a.composition='".$composition."' and
        								a.gsm_weight='".$gsm_weight."' and
        								$color_cond and
        								d.status_active=1 and
        								d.is_deleted=0
        								");
        						
        								list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;
        							?>
        							<tr>
	        							<?
	        							$color_qty=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
	        							?>
	        							<td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
	        							<td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
	        							<td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
	        							<td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?>&nbsp; </td>
	        							<?
	        							$total_fab_qty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
	        							$sk=0;
	        							foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
	        							{

	        								$measurement=$color_val['measurement'][$strip_color_id];
	        								$uom=$color_val['uom'][$strip_color_id];
	        								$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
	        								$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
	        								if($sk>0)
	        								{
	        									echo "<tr>";
	        								}
	        								?>
	        							
		        								<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
		        								<td align="right"> <? echo  number_format($measurement,2); ?> &nbsp; </td>
		        		                        <td> <? echo  $unit_of_measurement[$uom]; ?></td>
		        								<td align="right"> <? echo  number_format($fabreqtotkg,2); ?> &nbsp;</td>
		        								<td> <? echo  $yes_no[$yarn_dyed]; ?></td>
	        								
	        								<?
	        								if($sk>0)
	        								{
	        									echo "</tr>";
	        								}
	        								$sk++;
	        								$total_fabreqtotkg+=$fabreqtotkg;
	        								$stripe_color_wise[$color_name_arr[$s_color_val]]+=$fabreqtotkg;
	        							}
	        							$i++;
	        							?>
        							</tr>
        							<?
        						}
        					}
        					?>
	        		            <tfoot>
		        		            <tr>
			        		            <td colspan="3">Total </td>
			        		            <td align="right">  <? echo  number_format($total_fab_qty,2); ?> &nbsp;</td>
			        		            <td></td>
			        		            <td></td>
			        		            <td></td>
			        		            <td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> &nbsp;</td>
			        		        </tr>
	        		            </tfoot>
        		            </table>
        	</td>
        	
        	<td width="20%" style="float: right;">
        		        <table  class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all" width="100%"   style="font-family:Arial Narrow;font-size:18px;margin: 0px;padding: 0px;"  >
        		       

        		        <tr>
        		            <td align="left" colspan="3"> Stripe  Color wise Summary</td>
        		            
        		           
        		           
    		            </tr>
        		        <?
        				
        				?>
        		            <tr>
	        		            <td width="30"> SL</td>
	        		            
	        		            <td width="70"> Stripe Color</td>
	        		           
	        		            <td  width="70"> Qty.(KG)</td>
	        		           
        		            </tr>
        		            <?

        					$i=1;$total_stripe_qnt=0;        		            
        						foreach($stripe_color_wise as $color=>$val)
        						{
        							
        							
        							?>
        							<tr>
	        							<td> <? echo $i; ?></td>
	        							
	        							<td > <? echo $color; ?></td>
	        							<td align="right"> <?php echo number_format($val,2); ?></td>
	        						</tr>
        							
        							<?
        							$total_stripe_qnt+=$val;
        							
        							$i++;
        						}
        					
        					?>
        		            <tfoot>
        		            <tr>
        		            
        		            <td></td>
        		            <td></td>
        		            
        		            <td align="right"><? echo  number_format($total_stripe_qnt,2); ?> </td>
        		            </tr>
        		            </tfoot>
        		            </table>
        	</td>
        </tr>
         </table >
      
        <br/>
        <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;font-size:18px;">
        <tr align="center">
        <td colspan="10"><b> Comments(Production) </b></td>
        </tr>
        <tr align="center">
        <td>Sl</td>
        <td>Po NO</td>
        <td>Ship Date</td>
        <td>Pre-Cost Qty</td>
        <td>Mn.Book Qty</td>
        <td>Sht.Book Qty</td>
        <td>Smp.Book Qty</td>
        <td>Tot.Book Qty</td>
        <td>Balance</td>
        <td>Comments</td>
        </tr>
        <?
        $cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
        $cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
        if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
        if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
        $paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");
        $item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no ='$txt_job_no'", "gmts_item_id", "set_item_ratio");

        $nameArray=sql_select("
        select
        a.id,
        a.item_number_id,
        a.costing_per,
        b.po_break_down_id,
        b.color_size_table_id,
        b.requirment,
        c.po_number
        FROM
        wo_pre_cost_fabric_cost_dtls a,
        wo_pre_cos_fab_co_avg_con_dtls b,
        wo_po_break_down c
        WHERE
        a.job_no=b.job_no and
        a.job_no=c.job_no_mst and
        a.id=b.pre_cost_fabric_cost_dtls_id and
        b.po_break_down_id=c.id and
        b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0
        order by id");

        $count=0;
        $tot_grey_req_as_pre_cost_arr=array();
        foreach ($nameArray as $result)
        {
        if (count($nameArray)>0 )
        {
        if($result[csf("costing_per")]==1)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(12*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==2)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(1*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==3)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(24*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==4)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(36*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==5)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(48*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        $tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
        }
        }

        $total_pre_cost=0;
        $total_booking_qnty_main=0;
        $total_booking_qnty_short=0;
        $total_booking_qnty_sample=0;
        $total_tot_bok_qty=0;
        $tot_balance=0;
        $booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

        $booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
        $booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
        $sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.po_number order by pub_shipment_date asc");
        foreach($sql_data  as $row)
        {
        $col++;
        ?>
        <tr align="center">
        <td><? echo $col; ?></td>
        <td><? echo $row[csf("po_number")]; ?></td>
        <td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
        <td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
        <td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
        <td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
        <td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
        <td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
        <td align="right">
        <? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
        </td>
        <td>
        <?
        if( $balance>0)
        {
        echo "Less Booking";
        }
        else if ($balance<0)
        {
        echo "Extra Booking";
        }
        else
        {
        echo "";
        }
        ?>
        </td>
        </tr>
        <?
        }
        ?>
        <tfoot>
        <tr>
        <td colspan="3">Total:</td>
        <td align="right"><? echo number_format($total_pre_cost,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
        <td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
        <td align="right"><? echo number_format($tot_balance,2); ?></td>
        <td></td>
        </tr>
        </tfoot>
        </table>

        <?
         if(count($purchase_res))
        {
        	?>
         <br/>
        <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;font-size:18px;">
        <tr align="center">
        <td colspan="10"><b> Comments(Purchase)</b></td>
        </tr>
        <tr align="center">
        <td>Sl</td>
        <td>Po NO</td>
        <td>Ship Date</td>
        <td>Pre-Cost Qty</td>
        <td>Purchase<br>Booking Qty</td>
        <td>Sht.Book Qty</td>
        <td>Smp.Book Qty</td>
        <td>Tot.Book Qty</td>
        <td>Balance</td>
        <td>Comments</td>
        </tr>
        <?
        $cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
        $cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
        if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
        if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
        $paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");
        $item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no ='$txt_job_no'", "gmts_item_id", "set_item_ratio");

        $nameArray=sql_select("select a.id, a.item_number_id, a.costing_per, b.po_break_down_id, b.color_size_table_id, b.requirment, c.po_number FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_break_down c WHERE a.job_no=b.job_no and a.job_no=c.job_no_mst and a.id=b.pre_cost_fabric_cost_dtls_id and b.po_break_down_id=c.id and c.job_no_mst = '$txt_job_no'  and a.fab_nature_id=3 and   a.fabric_source = '2'  and a.status_active=1 and a.is_deleted=0 order by id");

        $count=0;
        $tot_grey_req_as_pre_cost_arr=array();
        foreach ($nameArray as $result)
        {
        if (count($nameArray)>0 )
        {
        if($result[csf("costing_per")]==1)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(12*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==2)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(1*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==3)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(24*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==4)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(36*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        if($result[csf("costing_per")]==5)
        {
        $tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(48*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
        }
        $tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
        }
        }

        $total_pre_cost=0;
        $total_booking_qnty_main=0;
        $total_booking_qnty_short=0;
        $total_booking_qnty_sample=0;
        $total_tot_bok_qty=0;
        $tot_balance=0;
        $booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and   a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.job_no = '$txt_job_no' and a.booking_type =1  and c.fabric_source = 2  and a.is_short=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");


        $booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.job_no = '$txt_job_no' and a.booking_type =1 and c.fabric_source=2 and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
        $booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.job_no = '$txt_job_no' and a.booking_type =4 and c.fabric_source=2 and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
        $sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.job_no_mst='$txt_job_no' group by a.po_number order by pub_shipment_date asc");
        foreach($sql_data  as $row)
        {
        $col++;
        ?>
        <tr align="center">
        <td><? echo $col; ?></td>
        <td><? echo $row[csf("po_number")]; ?></td>
        <td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
        <td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
        <td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
        <td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
        <td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
        <td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
        <td align="right">
        <? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
        </td>
        <td>
        <?
        if( $balance>0)
        {
        echo "Less Booking";
        }
        else if ($balance<0)
        {
        echo "Extra Booking";
        }
        else
        {
        echo "";
        }
        ?>
        </td>
        </tr>
        <?
        }
        ?>
        <tfoot>
        <tr>
        <td colspan="3">Total:</td>
        <td align="right"><? echo number_format($total_pre_cost,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
        <td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
        <td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
        <td align="right"><? echo number_format($tot_balance,2); ?></td>
        <td></td>
        </tr>
       
        </tfoot>
        </table>
         <?
        	}
        ?>
       <br>

		<fieldset id="div_size_color_matrix" style="max-width:1000;">
		<?
		//------------------------------ Query for TNA start-----------------------------------
				$po_id_all=str_replace("'","",$txt_order_no_id);
				$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
				$tna_start_sql=sql_select( "select id,po_number_id,
								(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
								(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
								(case when task_number=60 then task_start_date else null end) as knitting_start_date,
								(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
								(case when task_number=61 then task_start_date else null end) as dying_start_date,
								(case when task_number=61 then task_finish_date else null end) as dying_end_date,
								(case when task_number=64 then task_start_date else null end) as finishing_start_date,
								(case when task_number=64 then task_finish_date else null end) as finishing_end_date,
								(case when task_number=84 then task_start_date else null end) as cutting_start_date,
								(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
								(case when task_number=86 then task_start_date else null end) as sewing_start_date,
								(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
								(case when task_number=110 then task_start_date else null end) as exfact_start_date,
								(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
								(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
								(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
								from tna_process_mst
								where status_active=1 and po_number_id in($po_id_all)");
				$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
				$tna_date_task_arr=array();
				foreach($tna_start_sql as $row)
				{
					if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
					{
						if($tna_fab_start=="")
						{
							$tna_fab_start=$row[csf("fab_booking_start_date")];
						}
					}


					if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
					}
					if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
					}
					if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
					}
					if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
					}

					if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
					}
					if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
					}
					if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
					}
				}

			//------------------------------ Query for TNA end-----------------------------------
		?>
        <legend>TNA Information</legend>
        <!--<span style="font-size:180; font-weight:bold;"></span>-->
        <table width="100%" style="border:1px solid black;font-size:17px; font-family:Arial Narrow;" border="1" cellpadding="2" cellspacing="0" rules="all">
            <tr>
            	<td rowspan="2" align="center" valign="top">SL</td>
            	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
                <td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
                <td colspan="2" align="center" valign="top"><b>Knitting</b></td>
                <td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
                <td colspan="2" align="center" valign="top"><b>Finish Fabric Prod.</b></td>
                <td colspan="2" align="center" valign="top"><b>Cutting </b></td>
                <td colspan="2" align="center" valign="top"><b>Sewing </b></td>
                <td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
            </tr>
            <tr>
            	<td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

            </tr>
            <?
			$i=1;
			foreach($tna_date_task_arr as $order_id=>$row)
			{
				 //$tna_date_task_arr//knitting_start_date dying_start_date finishing_start_date cutting_start_date sewing_start_date exfact_start_date
				?>
                <tr>
                	<td><? echo $i; ?></td>
                    <td><? echo $po_num_arr[$order_id]; ?></td>
                    <td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
                	<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
                </tr>
                <?
				$i++;
			}
			?>

        </table>
        </fieldset>
        <?
		}// fabric Source End
	$sql_data=sql_select("select a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,a.uom,b.dia_width,b.pre_cost_remarks,b.fabric_color_id,b.remark, sum(b.grey_fab_qnty) as grey_fab_qnty,sum(b.adjust_qty)as adjust_qty,sum(b.fin_fab_qnty) as fin_fab_qnty,avg(b.rate) as rate,sum(b.grey_fab_qnty*b.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.adjust_qty>0 and b.status_active=1 and b.is_deleted=0 group by a.id,a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,a.uom,b.dia_width,b.pre_cost_remarks,b.fabric_color_id,b.remark order by a.id,a.body_part_id");

		?>
		<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

        <tr>
        <td colspan="7">
        <strong>Fabric Stock Adjustment Details</strong>
        </td>

        </tr>

        <tr>
        <td>
        Fabrication
        </td>
        <td>
        Process
        </td>
        <td>
        Fabric Color
        </td>
        <td>
        Required
        </td>
        <td>
        Stock Used
        </td>
        <td>
        Booking Qty
        </td><td>
        Uom
        </td>
         <td>
        Remarks
        </td>
        </tr>
        <?
		foreach($sql_data as $row){
		?>
          <tr>
        <td>
        <? echo $body_part[$row[csf('body_part_id')]].",".$color_type[$row[csf('color_type_id')]].",".$row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$fabric_typee[$row[csf('width_dia_type')]].",".$row[csf('dia_width')]  ?>
        </td>
        <td>
        <? echo $row[csf('pre_cost_remarks')];  ?>
        </td>
        <td>
        <? echo $color_library[$row[csf('fabric_color_id')]];  ?>
        </td>
        <td align="right">
        <? echo number_format($row[csf('grey_fab_qnty')],4);  ?>
        </td>
        <td align="right">
         <? echo number_format($row[csf('adjust_qty')],4) ; ?>
        </td>
        <td align="right">
       <? echo number_format($row[csf('fin_fab_qnty')],4);  ?>
        </td>
         <td>
        <? echo $unit_of_measurement[$row[csf('uom')]];  ?>
        </td>
         <td>
         <? echo $row[csf('remark')];  ?>
        </td>
        </tr>
        <?
		}
		?>
        </table>


	<?
	//echo $cbo_fabric_source;
	if($cbo_fabric_source==1 || $cbo_fabric_source==2){
	?>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
	<tr>
	<?

	$nameArray_item_size=sql_select( "select min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
	if(count($nameArray_item_size)>0)
	{
	?>
	<td width="49%">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr>
	<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Collar -  Colour Size Brakedown in Pcs</b></td>
	</tr>
	<tr>
	<td width="70">Size</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?
	}
	?>
	<td rowspan="2" align="center"><strong>Total</strong></td>
	<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
	</tr>
	<tr>
	<td>Collar Size</td>

	<?
	foreach($nameArray_item_size  as $result_item_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
	<?
	}
	?>
	<?
	$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by c.color_number_id,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
	");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	$color_total_collar=0;
	$color_total_collar_order_qnty=0;
	$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
	$constrast_color_arr=array();
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
	for($i=0;$i<count($constrast_color);$i++)
	{
	$constrast_color2=explode('_',$constrast_color[$i]);
	$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
	}
	}
	?>
	<tr>
	<td>
	<?
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
	$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
	}
	else
	{
	echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
	$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
	}
	?>
	</td>
	<?

	foreach($nameArray_item_size  as $result_size)
	{
		 $sql_excess_per="select a.po_break_down_id,a.gmts_color_id,a.size_number_id,a.excess_per,b.body_part_id FROM wo_booking_colar_culff_dtls a,wo_pre_cost_fabric_cost_dtls b where
	 a.booking_no =$txt_booking_no and a.pre_cost_fabric_cost_dtls_id=b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  a.size_number_id =".$result_size[csf('size_number_id')]." and a.gmts_color_id =".$color_wise_wo_result[csf('color_number_id')]." and b.body_part_id=2 and a.status_active=1 ";
	$resultData=sql_select($sql_excess_per);
	list($excess_percent)=$resultData;
	$colar_excess_percent=$excess_percent[csf('excess_per')];

	?>
	<td align="center" style="border:1px solid black" title="<? echo $colar_excess_percentage;?>">
	<?


	$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active!=0 and is_deleted =0");
	list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
	$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
	$colar_excess_per=($plan_cut*$colar_excess_percent)/100;
	echo number_format($plan_cut+$colar_excess_per,0);
	$color_total_collar+=$plan_cut+$colar_excess_per;
	$color_total_collar_order_qnty+=$plan_cut;
	$grand_total_collar+=$plan_cut+$colar_excess_per;
	$grand_total_collar_order_qnty+=$plan_cut;
	?>
	</td>
	<?
	}
	?>
	<td align="center"><? echo number_format($color_total_collar,0); ?></td>
	<td align="center"><? echo number_format((($color_total_collar-$color_total_collar_order_qnty)/$color_total_collar_order_qnty)*100,2); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td>Size Total</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:center"><? $colar_excess_pers=($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]+$colar_excess_pers,0); ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar,0); ?></td>
	<td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_collar-$grand_total_collar_order_qnty)/$grand_total_collar_order_qnty)*100,2); ?></td>
	</tr>
	</table>
	</td>
	<td width="2%">
	</td>
	<?
	}
	?>
	<?
	$nameArray_item_size=sql_select( "select min(c.id) as id, b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");

	if(count($nameArray_item_size)>0)
	{
	?>
	<td width="49%">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr>
	<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Cuff -  Colour Size Brakedown in Pcs</b></td>
	</tr>
	<tr>
	<td width="70">Size</td>

	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?
	}
	?>
	<td rowspan="2" align="center"><strong>Total</strong></td>
	<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
	</tr>
	<tr>
	<td>Cuff Size</td>

	<?
	foreach($nameArray_item_size  as $result_item_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
	<?
	}
	?>
	<?
	$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and  d.status_active=1 and d.is_deleted=0 group by c.color_number_id ,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
	");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	$color_total_cuff=0;
	$color_total_cuff_order_qnty=0;
	$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
	$constrast_color_arr=array();
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
	for($i=0;$i<count($constrast_color);$i++)
	{
	$constrast_color2=explode('_',$constrast_color[$i]);
	$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
	}
	}
	?>
	<tr>
	<td>
	<?
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]);
	$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
	}
	else
	{
	echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
	$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
	}
	?>
	</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
		 $sql_excess_cuff="select a.po_break_down_id,a.gmts_color_id,a.size_number_id,a.excess_per,b.body_part_id FROM wo_booking_colar_culff_dtls a,wo_pre_cost_fabric_cost_dtls b where
	 a.booking_no =$txt_booking_no and a.pre_cost_fabric_cost_dtls_id=b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  a.size_number_id =".$result_size[csf('size_number_id')]." and a.gmts_color_id =".$color_wise_wo_result[csf('color_number_id')]." and b.body_part_id=3 and a.status_active=1 ";
	$resultData_cuff=sql_select($sql_excess_cuff);
	list($cuff_excess_percent)=$resultData_cuff;
	$cuff_excess_percent=$cuff_excess_percent[csf('excess_per')];
	?>
	<td align="center" style="border:1px solid black">
	<?
	$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active!=0 and is_deleted =0");
	list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
	$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
	$cuff_excess_per=(($plan_cut*2)*$cuff_excess_percent)/100;
	echo number_format($plan_cut*2+$cuff_excess_per,0);
	$color_total_cuff+=$plan_cut*2+$cuff_excess_per;
	$color_total_cuff_order_qnty+=$plan_cut*2;
	$grand_total_cuff+=$plan_cut*2+$cuff_excess_per;
	$grand_total_cuff_order_qnty+=$plan_cut*2;
	?>
	</td>
	<?
	}
	?>
	<td align="center"><? echo number_format($color_total_cuff,0); ?></td>
	<td align="center"><? echo number_format((($color_total_cuff-$color_total_cuff_order_qnty)/$color_total_cuff_order_qnty)*100,2); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td>Size Total</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:center"><? $cuff_excess_pers=(($size_tatal[$result_size[csf('size_number_id')]]*2)*$cuff_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]*2+$cuff_excess_pers,0); ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_cuff,0); ?></td>
	<td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_cuff-$grand_total_cuff_order_qnty)/$grand_total_cuff_order_qnty)*100,2); ?></td>
	</tr>
	</table>
	</td>
	<?
	}
	?>
	</tr>
	</table>
	<br/>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
	<tr>
	<?

	$nameArray_item_size=sql_select( "select min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=172  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
	if(count($nameArray_item_size)>0)
	{
	?>
	<td width="49%">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr>
	<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Collar Tipping -  Colour Size Brakedown in Pcs</b></td>
	</tr>
	<tr>
	<td width="70">Size</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?
	}
	?>
	<td rowspan="2" align="center"><strong>Total</strong></td>
	<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
	</tr>
	<tr>
	<td>Collar Size</td>
	<?
	foreach($nameArray_item_size  as $result_item_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
	<?
	}
	?>
	<?
	$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=172  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by c.color_number_id,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
	");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	$color_total_collar_tipping=0;
	$color_total_collar_tipping_order_qnty=0;
	$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
	$constrast_color_arr=array();
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
	for($i=0;$i<count($constrast_color);$i++)
	{
	$constrast_color2=explode('_',$constrast_color[$i]);
	$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
	}
	}
	?>
	<tr>
	<td>
	<?
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
	$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
	}
	else
	{
	echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
	$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
	}
	?>
	</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
		$sql_excess_collarTip="select a.po_break_down_id,a.gmts_color_id,a.size_number_id,a.excess_per,b.body_part_id FROM wo_booking_colar_culff_dtls a,wo_pre_cost_fabric_cost_dtls b where
	 a.booking_no =$txt_booking_no and a.pre_cost_fabric_cost_dtls_id=b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  a.size_number_id =".$result_size[csf('size_number_id')]." and a.gmts_color_id =".$color_wise_wo_result[csf('color_number_id')]." and b.body_part_id=172 and a.status_active=1 ";
	$resultData_collar_tip=sql_select($sql_excess_collarTip);
	list($collarTip_excess_percent)=$resultData_collar_tip;
	$colar_excess_percent=$collarTip_excess_percent[csf('excess_per')];

	?>
	<td align="center" style="border:1px solid black">
	<?
	$color_tipping_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active!=0 and is_deleted =0");

	list($plan_cut_qnty)=$color_tipping_wise_wo_sql_qnty;
	$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
	$colar_excess_per=($plan_cut*$colar_excess_percent)/100;
	echo number_format($plan_cut+$colar_excess_per,0);
	$color_total_collar_tipping+=$plan_cut+$colar_excess_per;
	$color_total_collar_tipping_order_qnty+=$plan_cut;
	$grand_total_collar_tipping+=$plan_cut+$colar_excess_per;
	$grand_total_collar_tipping_order_qnty+=$plan_cut;
	?>
	</td>
	<?
	}
	?>
	<td align="center"><? echo number_format($color_total_collar_tipping,0); ?></td>
	<td align="center"><? echo number_format((($color_total_collar_tipping-$color_total_collar_tipping_order_qnty)/$color_total_collar_tipping_order_qnty)*100,2); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td>Size Total</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:center"><? $colar_excess_pers=($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]+$colar_excess_pers,0); ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar_tipping,0); ?></td>
	<td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_collar_tipping-$grand_total_collar_tipping_order_qnty)/$grand_total_collar_tipping_order_qnty)*100,2); ?></td>
	</tr>
	</table>
	</td>
	<td width="2%">
	</td>
	<?
	}
	?>
	<?
	$nameArray_item_size=sql_select( "select min(c.id) as id, b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=214  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
	if(count($nameArray_item_size)>0)
	{
	?>
	<td width="49%">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr>
	<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Cuff Tipping -  Colour Size Brakedown in Pcs</b></td>
	</tr>
	<tr>
	<td width="70">Size</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?
	}
	?>
	<td rowspan="2" align="center"><strong>Total</strong></td>
	<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
	</tr>
	<tr>
	<td>Cuff Size</td>
	<?
	foreach($nameArray_item_size  as $result_item_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
	<?
	}
	?>
	<?
	$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=214  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and  d.status_active=1 and d.is_deleted=0 group by c.color_number_id ,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
	");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	$color_total_cuff_tipping=0;
	$color_total_cuff_tipping_order_qnty=0;
	$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
	$constrast_color_arr=array();
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
	for($i=0;$i<count($constrast_color);$i++)
	{
	$constrast_color2=explode('_',$constrast_color[$i]);
	$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
	}
	}
	?>
	<tr>
	<td>
	<?
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]);
	$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
	}
	else
	{
	echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
	$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
	}
	?>
	</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
		$sql_excess_cuffTip="select a.po_break_down_id,a.gmts_color_id,a.size_number_id,a.excess_per,b.body_part_id FROM wo_booking_colar_culff_dtls a,wo_pre_cost_fabric_cost_dtls b where
	 a.booking_no =$txt_booking_no and a.pre_cost_fabric_cost_dtls_id=b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  a.size_number_id =".$result_size[csf('size_number_id')]." and a.gmts_color_id =".$color_wise_wo_result[csf('color_number_id')]." and b.body_part_id=214 and a.status_active=1 ";
	$resultData_cuff_tip=sql_select($sql_excess_cuffTip);
	list($cuffTip_excess_percent)=$resultData_cuff_tip;
	$cuff_excess_percent=$cuffTip_excess_percent[csf('excess_per')];

	?>
	<td align="center" style="border:1px solid black">
	<?
	$cuff_tipping_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active!=0 and is_deleted =0");
	list($plan_cut_qnty)=$cuff_tipping_wise_wo_sql_qnty;
	$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
	$cuff_tipping_excess_per=(($plan_cut*2)*$cuff_excess_percent)/100;
	echo number_format($plan_cut*2+$cuff_tipping_excess_per,0);
	$color_total_cuff_tipping+=$plan_cut*2+$cuff_tipping_excess_per;
	$color_total_cuff_tipping_order_qnty+=$plan_cut*2;
	$grand_total_cuff_tipping+=$plan_cut*2+$cuff_excess_per;
	$grand_total_cuff_tipping_order_qnty+=$plan_cut*2;
	?>
	</td>
	<?
	}
	?>
	<td align="center"><? echo number_format($color_total_cuff_tipping,0); ?></td>
	<td align="center" title="<? echo $color_total_cuff_tipping."**".$color_total_cuff_tipping_order_qnty; ?>"><? echo number_format((($color_total_cuff_tipping-$color_total_cuff_tipping_order_qnty)/$color_total_cuff_tipping_order_qnty)*100,2); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td>Size Total</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:center"><? $cuff_excess_pers=(($size_tatal[$result_size[csf('size_number_id')]]*2)*$cuff_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]*2+$cuff_excess_pers,0); ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_cuff_tipping,0); ?></td>
	<td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_cuff_tipping-$grand_total_cuff_tipping_order_qnty)/$grand_total_cuff_tipping_order_qnty)*100,2); ?></td>
	</tr>
	</table>
	</td>
	<?
	}
	?>
	</tr>
	</table>
	<br/>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
	<tr>
	<td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
	<thead>
	<tr>
	<th width="3%"></th><th width="97%" align="left"><u>Special Instruction</u></th>
	</tr>
	</thead>
	<tbody>
	<?
	$data_array=sql_select("select id, terms from  wo_booking_terms_condition where booking_no=$txt_booking_no");
	if ( count($data_array)>0)
	{
	$i=0;
	foreach( $data_array as $row )
	{
	$i++;
	?>
	<tr id="settr_1" valign="top">
	<td style="vertical-align:top">
	<? echo $i;?>
	</td>
	<td>
	<strong style="font-size:20px"> <? echo $row[csf('terms')]; ?></strong>
	</td>
	</tr>
	<?
	}
	}
	?>
	</tbody>
	</table>
	</td>
	<td width="2%">
	</td>
	<td width="49%" valign="top">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr align="center">
	<td><b>Approved Instructions</b></td>
	</tr>
	<tr>
	<td>
	<?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
	</td>
	</tr>
	</table>
	<br />
	</td>
	</tr>
	</table>
	<br>
	<?
	//------------------------------ Query for TNA start-----------------------------------
	$po_id_all=str_replace("'","",$txt_order_no_id);
	$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
	$tna_start_sql=sql_select( "select id,po_number_id,
	(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
	(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
	(case when task_number=60 then task_start_date else null end) as knitting_start_date,
	(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
	(case when task_number=61 then task_start_date else null end) as dying_start_date,
	(case when task_number=61 then task_finish_date else null end) as dying_end_date,
	(case when task_number=73 then task_start_date else null end) as finishing_start_date,
	(case when task_number=73 then task_finish_date else null end) as finishing_end_date,
	(case when task_number=84 then task_start_date else null end) as cutting_start_date,
	(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
	(case when task_number=86 then task_start_date else null end) as sewing_start_date,
	(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
	(case when task_number=110 then task_start_date else null end) as exfact_start_date,
	(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
	(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
	(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
	from tna_process_mst
	where status_active=1 and po_number_id in($po_id_all)");
	$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
	$tna_date_task_arr=array();
	foreach($tna_start_sql as $row)
	{
	if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
	{
	if($tna_fab_start=="")
	{
	$tna_fab_start=$row[csf("fab_booking_start_date")];
	}
	}
	if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
	}
	if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
	}
	if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
	}
	if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
	}
	if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
	}
	if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
	}
	if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
	}
	}
	//------------------------------ Query for TNA end-----------------------------------
	?>
	<fieldset id="div_size_color_matrix" style="max-width:1000; display:none">
	<legend>TNA Information</legend>
	<table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
	<tr>
	<td rowspan="2" align="center" valign="top">SL</td>
	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
	<td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
	<td colspan="2" align="center" valign="top"><b>Knitting</b></td>
	<td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
	<td colspan="2" align="center" valign="top"><b>Finishing Fabric</b></td>
	<td colspan="2" align="center" valign="top"><b>Cutting </b></td>
	<td colspan="2" align="center" valign="top"><b>Sewing </b></td>
	<td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
	</tr>
	<tr>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	</tr>
	<?
	$i=1;
	foreach($tna_date_task_arr as $order_id=>$row)
	{
	?>
	<tr>
	<td><? echo $i; ?></td>
	<td><? echo $po_num_arr[$order_id]; ?></td>
	<td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
	<td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
	<td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
	</tr>
	<?
	$i++;
	}
	?>
	</table>
	</fieldset>
	<?
	}// fabric Source End
	?>
	<?
	//echo signature_table(1, $cbo_company_name, "1330px");
	echo signature_table(121, $cbo_company_name, "1330px",$cbo_template_id, 1,1);
	echo "****".custom_file_name($txt_booking_no,$style_sting,$job_no);
	?>
	</div>
	<?
}
if($action=="show_fabric_booking_report_urmi_per_job"){ 


	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$company_library=return_library_array( "select id,company_name from lib_company", "id", "company_name");
	$color_library=return_library_array( "select id,color_name from lib_color", "id", "color_name");
	$size_library=return_library_array( "select id,size_name from lib_size", "id", "size_name");
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	//$supplier_address_arr=return_library_array( "select id,address_1 from   lib_supplier",'id','address_1');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	//$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	//$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	$season_arr=return_library_array("select id,season_name from lib_buyer_season","id","season_name");
	$uom=0;
	$joball=array();
	/*$nameArray_per_job=sql_select( "select  a.job_no,a.style_ref_no  from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by a.job_no,a.style_ref_no");
	foreach ($nameArray_per_job as $row_per_job){ 
	
	$joball['job_no'][$row_per_job[csf('job_no')]]=$row_per_job[csf('job_no')];
	$joball['style_ref_no'][$row_per_job[csf('job_no')]]=$row_per_job[csf('style_ref_no')];
	}
unset($nameArray_per_job);*/
	$uom=0;
	$job_data_arr=array();
	$nameArray_buyer=sql_select( "select a.id as job_id, a.style_ref_no, a.style_description, a.job_no, a.style_owner, a.buyer_name, a.client_id, a.dealing_marchant, a.season, a.season_matrix, a.total_set_qnty, a.product_dept, a.product_code, a.pro_sub_dep, a.gmts_item_id, a.order_repeat_no, a.qlty_label,a.season_buyer_wise from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0 ");
	foreach ($nameArray_buyer as $result_buy){
		$job_data_arr['job_id'][$result_buy[csf('job_id')]]=$result_buy[csf('job_id')];
		$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
		$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
		$job_data_arr['total_set_qnty'][$result_buy[csf('job_no')]]=$result_buy[csf('total_set_qnty')];
		$job_data_arr['product_dept'][$result_buy[csf('job_no')]]=$product_dept[$result_buy[csf('product_dept')]];
		$job_data_arr['product_code'][$result_buy[csf('job_no')]]=$result_buy[csf('product_code')];
		$job_data_arr['pro_sub_dep'][$result_buy[csf('job_no')]]=$pro_sub_dept_array[$result_buy[csf('pro_sub_dep')]];
		$job_data_arr['gmts_item_id'][$result_buy[csf('job_no')]]=$result_buy[csf('gmts_item_id')];
		$job_data_arr['style_ref_no'][$result_buy[csf('job_no')]]=$result_buy[csf('style_ref_no')];
		$job_data_arr['style_description'][$result_buy[csf('job_no')]]=$result_buy[csf('style_description')];
		$job_data_arr['dealing_marchant'][$result_buy[csf('job_no')]]=$marchentrArr[$result_buy[csf('dealing_marchant')]];
		$job_data_arr['season_matrix'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_matrix')]];
		$job_data_arr['season_buyer_wise'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_buyer_wise')]];
		$job_data_arr['order_repeat_no'][$result_buy[csf('job_no')]]=$result_buy[csf('order_repeat_no')];
		$job_data_arr['qlty_label'][$result_buy[csf('job_no')]]=$quality_label[$result_buy[csf('qlty_label')]];
		$job_data_arr['client'][$result_buy[csf('job_no')]]=$result_buy[csf('client_id')];
		
		$joball['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
		$joball['style_ref_no'][$result_buy[csf('job_no')]]=$result_buy[csf('style_ref_no')];
	}

	$job_ids= implode(",",array_unique($job_data_arr['job_id']));
	$job_no= implode(",",array_unique($job_data_arr['job_no']));
	$job_no_in= implode(",",array_unique($job_data_arr['job_no_in']));
	$product_depertment=implode(",",array_unique($job_data_arr['product_dept']));
	$product_code=implode(",",array_unique($job_data_arr['product_code']));
	$pro_sub_dep=implode(",",array_unique($job_data_arr['pro_sub_dep']));
	$gmts_item_id=implode(",",array_unique($job_data_arr['gmts_item_id']));
	$style_sting=implode(",",array_unique($job_data_arr['style_ref_no']));
	$style_description=implode(",",array_unique($job_data_arr['style_description']));
	$dealing_marchant=implode(",",array_unique($job_data_arr['dealing_marchant']));
	$season_matrix=implode(",",array_unique($job_data_arr['season_matrix']));
	$season_buyer_wise=implode(",",array_unique($job_data_arr['season_buyer_wise']));
	$order_repeat_no= implode(",",array_unique($job_data_arr['order_repeat_no']));
	$qlty_label= implode(",",array_unique($job_data_arr['qlty_label']));
	$client_id= implode(",",array_unique($job_data_arr['client']));
	?>
    <style>
     .table_valign { vertical-align: top;word-break: break-all;word-wrap: break-word; }
@media print {
    .gg {page-break-after: always;}
}
</style>
	<div style="width:1330px" align="center">

	<?php
$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and a.status_active =1 and a.is_deleted=0");
list($nameArray_approved_row) = $nameArray_approved;
$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
list($nameArray_approved_date_row) = $nameArray_approved_date;
$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
list($nameArray_approved_comments_row) = $nameArray_approved_comments;
$path = str_replace("'", "", $path);
if ($path != "") {
	$path = $path;
} else {
	$path = "../../";
}
ob_start();
?>										<!--    Header Company Information         -->
	<table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black" >
	<tr>
	<td width="100">
	<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
	</td>
	<td width="1250">
	<table width="100%" cellpadding="0" cellspacing="0"  >
	<tr>
	<td align="center" style="font-size:20px;">
	<?php
echo $company_library[$cbo_company_name];
?>
	</td>
	<td rowspan="3" width="250">

	<span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($job_no,"'"); ?></b></span><br/>
	<?
	if($nameArray_approved_row[csf('approved_no')]>1)
	{
	?>
	<b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
	<br/>
	Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
	<?
	}
	?>


	</td>
	</tr>
	<tr>
	<td align="center" style="font-size:14px"><p>
	<?
		$country_full_name = return_library_array("SELECT id,country_name from lib_country", "id", "country_name");
		$sqlCom="select company_name, email, website, plot_no, level_no, road_no, block_no, country_id, province, city, zip_code, contact_no from lib_company where id='$cbo_company_name' and status_active=1 and is_deleted=0";
		$sqlComRes=sql_select($sqlCom);
		$comName=$comAdd=$comPhone=$comPax=$comEmail=$comWeb=""; $consigneeDtls="";
		foreach( $sqlComRes as $row)
		{
			$comName=$row[csf("company_name")];
			
			if($row[csf("level_no")])		$level_no 	= $row[csf("level_no")].', ';
			if($row[csf("plot_no")])		$plot_no 	=$row[csf("plot_no")].', ';
			if($row[csf("road_no")]) 		$road_no 	=$row[csf("road_no")].', ';
			if($row[csf("block_no")]!='')	$block_no 	=$row[csf("block_no")].', ';
			if($row[csf("zip_code")]!='')	$zip_code 	= ' -'.$row[csf("zip_code")].' , ';
			if($row[csf("city")]!='') 		$city 		= ($zip_code!="")?$row[csf("city")]:$row[csf("city")]." ,";
			if($row[csf("country_id")]!='')	$country 	= $country_full_name[$row[csf("country_id")]].'.,';
			
			$comAdd="Level No-".$level_no."Plot No-".$plot_no."Road No-".$road_no."Block No-".$block_no.$city.$zip_code.$country.$row[csf("email")].",".$row[csf("website")];
			$comPhone=$row[csf("contact_no")];
			$comEmail=$row[csf("email")];
			$comWeb=$row[csf("website")];
		}



	
	echo $comAdd;

	?></p>
	</td>
	</tr>
	<tr>
	<td align="center" style="font-size:20px">
	<strong><? if($report_title !=""){ echo $report_title;} else { echo "General Work Order";}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
	</td>
	</tr>
	</table>
	</td>
	</tr>
	</table>
	<?

//echo $job_ids;die;
	$po_data=array();
	if($db_type==0){
	$nameArray_job=sql_select( "select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,DATEDIFF(pub_shipment_date,po_received_date) date_diff,MIN(po_received_date) as po_received_date ,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status  from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no in($job_no_in)  group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
	}
	if($db_type==2){
	$nameArray_job=sql_select( "select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,(pub_shipment_date-po_received_date) date_diff,MIN(po_received_date) as po_received_date,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status   from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and  b.job_id in($job_ids)   group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
	}
	foreach ($nameArray_job as $result_job){
		$po_data['po_id'][$result_job[csf('id')]]=$result_job[csf('id')];
		$po_data['po_number'][$result_job[csf('id')]]=$result_job[csf('po_number')];
		$po_data['leadtime'][$result_job[csf('id')]]=$result_job[csf('date_diff')];
		$po_data['po_quantity'][$result_job[csf('id')]]=$result_job[csf('po_quantity')];
		$po_data['po_received_date'][$result_job[csf('id')]]=change_date_format($result_job[csf('po_received_date')],'dd-mm-yyyy','-');
		$ddd=strtotime($result_job[csf('pub_shipment_date')]);
		$po_data['pub_shipment_date'][$ddd]=$ddd;
		//$po_data['pub_shipment_date'][$result_job[csf('id')]]=change_date_format($result_job[csf('pub_shipment_date')],'dd-mm-yyyy','-');
		$po_data['insert_date'][$result_job[csf('id')]]=$result_job[csf('insert_date')];

		if($result_job[csf('shiping_status')]==1){
		$shiping_status= "FP";
		}
		else if($result_job[csf('shiping_status')]==2){
		$shiping_status= "PS";
		}
		else if($result_job[csf('shiping_status')]==3){
		$shiping_status= "FS";
		}
		$po_data['shiping_status'][$result_job[csf('id')]]=$shiping_status;
		$po_data['file_no'][$result_job[csf('id')]]=$result_job[csf('file_no')];
		$po_data['grouping'][$result_job[csf('id')]]=$result_job[csf('grouping')];
	}
	$txt_order_no_id=implode(",",array_unique($po_data['po_id']));
	$leadtime=implode(",",array_unique($po_data['leadtime']));
	$po_quantity=array_sum($po_data['po_quantity']);
	$po_received_date=implode(",",array_unique($po_data['po_received_date']));
	$po_number=implode(",",array_unique($po_data['po_number']));
	$shipment_date=date('d-m-Y',min($po_data['pub_shipment_date']));
	$maxshipment_date=date('d-m-Y',max($po_data['pub_shipment_date']));
	//$shipment_date=implode(",",array_unique($po_data['pub_shipment_date']));
	$shiping_status=implode(",",array_unique($po_data['shiping_status']));
	$file_no=implode(",",array_unique($po_data['file_no']));
	$grouping=implode(",",array_unique($po_data['grouping']));


	$colar_excess_percent=0;
	$cuff_excess_percent=0;
	$rmg_process_breakdown=0;
	$nameArray=sql_select( "select a.buyer_id, a.booking_no, a.booking_date, a.supplier_id, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.rmg_process_breakdown, a.insert_date, a.update_date, a.uom, a.remarks, a.pay_mode, a.fabric_composition from wo_booking_mst a where a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0");
	foreach ($nameArray as $result)
	{
		$total_set_qnty=$result[csf('total_set_qnty')];
		$colar_excess_percent=$result[csf('colar_excess_percent')];
		$cuff_excess_percent=$result[csf('cuff_excess_percent')];
		$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
		foreach ($po_data['po_id'] as $po_id=>$po_val){
			$daysInHand.=(datediff('d',date('d-m-Y',time()),$po_data['pub_shipment_date'][$po_id])-1).",";
			$booking_date=$result[csf('update_date')];
			if($booking_date=="" || $booking_date=="0000-00-00 00:00:00"){
			$booking_date=$result[csf('insert_date')];
			}
			$WOPreparedAfter.=(datediff('d',$po_data['insert_date'][$po_id],$booking_date)-1).",";
		}
	?>
	<table width="100%" style="border:1px solid black;table-layout: fixed;" >
	<tr>
	<td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
	</tr>
	<tr>
	<td width="200"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
	<td width="220">:&nbsp;<span style="font-size:18px"><b><? $buyer_name_str=""; if($client_id!=0) $buyer_name_str=$buyer_name_arr[$result[csf('buyer_id')]]."-".$buyer_name_arr[$client_id]; else $buyer_name_str=$buyer_name_arr[$result[csf('buyer_id')]]; echo $buyer_name_str; ?></b></span></td>
	<td width="200"><span style="font-size:12px"><b>Dept.</b></span></td>
	<td width="220">:&nbsp;
	<?
	echo $product_depertment ;
	if($product_code !=""){
	echo " (".$product_code.")";
	}
	if($pro_sub_dep != ""){
	echo " (".$pro_sub_dep.")";
	}
	?>
	</td>
	<td width="200"><span style="font-size:12px"><b>Order Qnty</b></span></td>
	<td>:&nbsp; <?  echo $po_quantity;//." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?> </td>
	</tr>
	<tr>

	<td style="font-size:12px"><b>Garments Item</b></td>
	<td>:&nbsp;
	<?
	$gmts_item_name="";
	$gmts_item=explode(',',$gmts_item_id);
	for($g=0;$g<=count($gmts_item); $g++)
	{
	$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
	}
	echo rtrim($gmts_item_name,',');
	?>
	</td>
	<td style="font-size:12px"><b>Booking Release Date</b></td>
	<td>:&nbsp;
	<?
	$booking_date=$result[csf('update_date')];
	if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
	{
	$booking_date=$result[csf('insert_date')];
	}
	echo change_date_format($booking_date,'dd-mm-yyyy','-','');
	?>&nbsp;&nbsp;&nbsp;</td>
	<td style="font-size:18px"><b>Style Ref.</b>   </td>
	<td style="font-size:18px">:&nbsp;<b>
	<?
	echo $style_sting;
	?>
	</b>
	</td>
	</tr>
	<tr>
	<td style="font-size:12px"><b>Style Des.</b></td>
	<td>:&nbsp;<? echo $style_description;?></td>
	<td style="font-size:12px"><b>Season</b></td>
	<td>:&nbsp;<?  if($season_matrix!="") echo $season_matrix; else echo $season_buyer_wise; ?></td>
	<td style="font-size:12px"><b>Dealing Merchant</b></td>
	<td>:&nbsp;<? echo $dealing_marchant; ?></td>
	</tr>

	<tr>
	<td style="font-size:12px"><b>Supplier Name</b>   </td>
	<td>:&nbsp;
	<?
	if($result[csf('pay_mode')]==5){
	echo $company_library[$result[csf('supplier_id')]];
	}
	else{
	echo $supplier_name_arr[$result[csf('supplier_id')]];
	}
	?>    </td>
	<td style="font-size:12px"><b>Delivery Date</b></td>
	<td>:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
	<td style="font-size:18px"><b>Booking No </b>   </td>
	<td style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?> <? //echo "(".$unit_of_measurement[$result[csf('uom')]].")"; $uom=$result[csf('uom')];?></td>
	</tr>
	<tr>
		<td   class="table_valign"><p><b>Attention</b></p></td>
		<td  class="table_valign"  ><p>:&nbsp;<? echo $result[csf('attention')]; ?></p></td>
		<td  class="table_valign"><p><b>Lead Time </b>  </p> </td>
		<td  class="table_valign"><p>:&nbsp;
			<?
			echo $leadtime;
			?> </p>
		</td>
		<td  class="table_valign"><p><b>Po Received Date</b></p></td>
		<td class="table_valign"><p>:&nbsp;<? echo $po_received_date; ?></p></td>
	</tr>
	<tr>
		<td class="table_valign"><p><b>Order No</b></p></td>
		<td class="table_valign" width="350" ><p>:&nbsp;<? echo $po_number; ?></p></td>
		<td class="table_valign" ><p><b>Fabric Nature</b></p></td>
		<td  class="table_valign"><p>:&nbsp;<?=$item_category_type_arr[$cbo_fabric_natu]; ?></p></td>
		
		<td class="table_valign" ><p><b>Repeat No</b></p></td>
		<td  class="table_valign"><p>:&nbsp;<? echo $order_repeat_no; ?></p></td>
	</tr>
	<tr>
	<td style="font-size:12px"><b>Shipment Date</b></td>
<td colspan="3" style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> : First:&nbsp;<? echo rtrim($shipment_date,", "); //echo $max_pub_shipment_date; ?>, Last: <? echo $maxshipment_date; ?></td>
	<td  style="font-size:12px"><b>Quality Label</b></td>
	<td  >:&nbsp;<? echo $qlty_label; ?></td>
	</tr>
	</tr>
	<tr>
	<td style="font-size:12px"><b>WO Prepared After</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
	<?
	$WOPreparedAfter=implode(",",array_unique(explode(",",chop($WOPreparedAfter,","))));
	echo $WOPreparedAfter.' Days' ;
	?></td>

	<td style="font-size:12px"><b>Ship.days in Hand</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
	<?
	$daysInHand=implode(",",array_unique(explode(",",chop($daysInHand,","))));
	echo $daysInHand.' Days' ;
	?></td>

	<td style="font-size:12px"><b>Ex-factory status</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
	<?
	echo $shiping_status;
	?></td>

	</tr>
	<tr>
	<td style="font-size:18px"><b>Internal Ref No</b></td>
	<td style="font-size:18px"> :&nbsp;<b><? echo $grouping; ?></b></td>
	<td style="font-size:18px"><b>File no</b></td>
	<td style="font-size:18px"> :&nbsp;<b><? echo  $file_no;?></b></td>
	<td style="font-size:18px"><b>Currency</b></td>
	<td style="font-size:18px"> :&nbsp;<b><? echo  $currency[$result[csf("currency_id")]];?></b></td>
	</tr>
	<tr>
	<td style="font-size:18px"><b>Rmarks</b></td>
	<td style="font-size:18px" colspan="5"> :<? echo $result[csf('remarks')]?></td>
	</tr>
	<tr>
	<td style="font-size:18px"><b>Fabric Composition</b></td>
	<td style="font-size:18px" colspan="5"> :<? echo $result[csf('fabric_composition')]?></td>
	</tr>

	</table>
	<?
	}

	if($cbo_fabric_source==1 || $cbo_fabric_source==2){
	$nameArray_size=sql_select( "select  size_number_id,min(id) as id,	min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).")   and  job_id in($job_ids) and 	is_deleted=0 and status_active!=0 group by size_number_id order by size_order");
	?>
	<table width="100%" >
	<tr>
	<td width="800">
	<div id="div_size_color_matrix" style="float:left; max-width:1000;">
	<fieldset id="div_size_color_matrix" style="max-width:1000;">
	<legend>Size and Color Breakdown</legend>
	<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
	<tr>
	<td style="border:1px solid black"><strong>Color/Size</strong></td>
	<?
	foreach($nameArray_size  as $result_size)
	{	     ?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?	}    ?>
	<td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
	<td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
	<td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
	</tr>
	<?
	$color_size_order_qnty_array=array();
	$color_size_qnty_array=array();
	$size_tatal=array();
	$size_tatal_order=array();
	for($c=0;$c<count($gmts_item); $c++)
	{
	$item_size_tatal=array();
	$item_size_tatal_order=array();
	$item_grand_total=0;
	$item_grand_total_order=0;
	$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and job_id in($job_ids) and is_deleted=0 and status_active!=0 group by color_number_id  order by color_order");
	?>
	<tr>
	<td style="border:1px solid black" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>

	</tr>
	<?
	foreach($nameArray_color as $result_color)
	{
	?>
	<tr>
	<td align="center" style="border:1px solid black"><? echo $color_library[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
	<?
	$color_total=0;
	$color_total_order=0;

	foreach($nameArray_size  as $result_size)
	{
	$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and job_id in($job_ids) and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active!=0 and is_deleted =0");
	foreach($nameArray_color_size_qnty as $result_color_size_qnty)
	{
	?>
	<td style="border:1px solid black; text-align:right">
	<?
	if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
	{
	echo number_format($result_color_size_qnty[csf('order_quantity')],0);
	$color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
	$color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
	$item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
	$item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
	$grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
	$grand_total_order +=$result_color_size_qnty[csf('order_quantity')];


	$color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
	$color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
	if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
	{
	$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
	$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
	}
	else
	{
	$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
	$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
	}
	if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
	{
	$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
	$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
	}
	else
	{
	$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
	$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
	}
	}
	else echo "0";
	?>
	</td>

	<?
	}
	}
	?>
	<td style="border:1px solid black; text-align:right"><?  echo number_format(round($color_total_order),0); ?></td>

	<td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?>
	</td>
	<td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total),0); ?></td>
	</tr>
	<?
	}
	?>

	<td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
	<?
	foreach($nameArray_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:right"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total_order),0); ?></td>
	<td  style="border:1px solid black;  text-align:right"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
	<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total),0); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td style="border:1px solid black" align="center" colspan="<? echo count($nameArray_size)+3; ?>"><strong>&nbsp;</strong></td>
	</tr>
	<tr>
	<tr>
	<td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
	<?
	foreach($nameArray_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:right"><? echo $size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total_order),0); ?></td>
	<td  style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
	<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total),0); ?></td>
	</tr>
	</table>
	</fieldset>
	</div>
	</td>
	<td width="200" valign="top" align="left">
	<div id="div_size_color_matrix" style="float:left;">
	<?
	$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
	?>
	<fieldset>
	<legend>RMG Process Loss % </legend>
	<table width="180" class="rpt_table" border="1" rules="all">
	<?
	if(number_format($rmg_process_breakdown_arr[8],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Cut Panel rejection <!-- Extra Cutting % breack Down 8-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[8],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[2],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Chest Printing <!-- Printing % breack Down 2-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[2],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[10],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Neck/Sleeve Printing <!-- New breack Down 10-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[10],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[1],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Embroidery   <!-- Embroidery  % breack Down 1-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[1],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[4],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Sewing /Input<!-- Sewing % breack Down 4-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[4],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[3],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Garments Wash <!-- Washing %breack Down 3-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[3],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[15],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Gmts Finishing <!-- Washing %breack Down 3-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[15],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[11],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Others <!-- New breack Down 11-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[11],2);
	?>
	</td>
	</tr>
	<?
	}
	$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
	if($gmts_pro_sub_tot>0)
	{
	?>
	<tr>
	<td width="130">
	Sub Total <!-- New breack Down 11-->
	</td>
	<td align="right">
	<?

	echo number_format($gmts_pro_sub_tot,2);
	?>
	</td>
	</tr>
	<?
	}
	?>
	</table>
	</fieldset>


	<fieldset>
	<legend>Fabric Process Loss % </legend>
	<table width="180" class="rpt_table" border="1" rules="all">
	<?
	if(number_format($rmg_process_breakdown_arr[6],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Knitting  <!--  Knitting % breack Down 6-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[6],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[12],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Yarn Dyeing  <!--  New breack Down 12-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[12],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[5],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Dyeing & Finishing  <!-- Finishing % breack Down 5-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[5],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[13],2)>0)
	{
	?>
	<tr>
	<td width="130">
	All Over Print <!-- new  breack Down 13-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[13],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[14],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Lay Wash (Fabric) <!-- new  breack Down 14-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[14],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[7],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Dying   <!-- breack Down 7-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[7],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[0],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Cutting (Fabric) <!-- Cutting % breack Down 0-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[0],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[9],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Others  <!-- Others% breack Down 9-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[9],2);
	?>
	</td>
	</tr>
	<?
	}
	$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
	if($fab_proce_sub_tot>0)
	{
	?>
	<tr>
	<td width="130">
	Sub Total  <!-- Others% breack Down 9-->
	</td>
	<td align="right">
	<?

	echo number_format($fab_proce_sub_tot,2);
	?>
	</td>
	</tr>
	<?
	}
	if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
	{
	?>
	<tr>
	<td width="130">
	Grand Total  <!-- Others% breack Down 9-->
	</td>
	<td align="right">
	<?
	echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2);
	?>
	</td>
	</tr>
	<?
	}
	?>
	</table>
	</fieldset>
	</div>
	</td>
	<td width="330" valign="top" align="left">
	<?
	$nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id in($job_no_in) and file_type=1");
	?>
	<div id="div_size_color_matrix" style="float:left;">
	<fieldset>
	<legend>Image</legend>
	<table width="310">
	<tr>
	<?
	$img_counter = 0;
	foreach($nameArray_imge as $result_imge)
	{
	if($path=="")
	{
	$path='../../';
	}
	?>
	<td>
	<img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />
	</td>
	<?

	$img_counter++;
	}
	?>
	</tr>
	</table>
	</fieldset>
	</div>
	</td>
	</tr>
	</table>
	<?
	}// if($cbo_fabric_source==1) end

	?>
	<br/>
	<!--  Here will be the main portion  -->
	<?
	$costing_per="";
	$costing_per_qnty=0;
	$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no in($job_no_in)");
	if($costing_per_id==1)
	{
	$costing_per="1 Dzn";
	$costing_per_qnty=12;

	}
	if($costing_per_id==2)
	{
	$costing_per="1 Pcs";
	$costing_per_qnty=1;

	}
	if($costing_per_id==3)
	{
	$costing_per="2 Dzn";
	$costing_per_qnty=24;

	}
	if($costing_per_id==4)
	{
	$costing_per="3 Dzn";
	$costing_per_qnty=36;

	}
	if($costing_per_id==5)
	{
	$costing_per="4 Dzn";
	$costing_per_qnty=48;
	}
	$uom_arr=array();
	$sql_fab=sql_select("select job_no,uom,process_loss_method from wo_pre_cost_fabric_cost_dtls where job_no in($job_no_in)");
	foreach($sql_fab as $row)
	{
		$uom_arr[$row[csf('uom')]]=$row[csf('uom')];
		$process_loss_method=$row[csf('process_loss_method')];
	}
	
	//$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no in($job_no_in)");

	//$uom_arr=array(1=>"Pcs",12=>"Kg",23=>"Mtr",27=>"Yds");
	if($cbo_fabric_source==1)
	{
			$gmt_color_library=array();
				$gmt_color_data=sql_select("select a.uom,b.gmts_color_id, b.contrast_color_id
				FROM
				wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
				WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu    and a.fabric_source =$cbo_fabric_source and
				 a.job_id in($job_ids)");
				
				if(count($gmt_color_data)>0)
				{
				foreach( $gmt_color_data as $gmt_color_row){
				$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
				}
				}
				unset($gmt_color_data);
			$color_wise_wo_sql=sql_select("select b.fabric_color_id
				FROM
				wo_pre_cost_fabric_cost_dtls a,
				wo_booking_dtls b
				WHERE
				a.id=b.pre_cost_fabric_cost_dtls_id and
				 
				b.booking_no =$txt_booking_no and
				 a.job_id in($job_ids) and 
				b.status_active=1 and b.fin_fab_qnty>0 and
				b.is_deleted=0
				group by b.fabric_color_id");
				
				foreach($color_wise_wo_sql as $row)
				{
					$color_wise_wo_arr[$row[csf('fabric_color_id')]]=$row[csf('fabric_color_id')];
				}
				unset($color_wise_wo_sql);
				
				$sql_labdip=sql_select("select lapdip_no,job_no_mst,color_name_id as color from wo_po_lapdip_approval_info where job_no_mst in($job_no_in) and approval_status=3 ");
				foreach($sql_labdip as $row)
				{
					$labdip_arr[$row[csf('job_no_mst')]][$row[csf('color')]]=$row[csf('lapdip_no')];
				}
				unset($sql_labdip);
				
				$color_wise_wo_sql_qnty=sql_select("select a.id,a.uom,a.item_number_id as item_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,d.pre_cost_remarks,d.fabric_color_id,d.dia_width, sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
				WHERE
				a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id and
			    a.color_type_id=d.color_type  and
				d.gsm_weight=a.gsm_weight and
				d.booking_no =$txt_booking_no and
				a.job_id in($job_ids) and
				d.status_active=1 and d.fin_fab_qnty>0 and
				d.is_deleted=0 group by  a.id,a.uom,a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,d.pre_cost_remarks,d.fabric_color_id,d.dia_width");
				
				foreach($color_wise_wo_sql_qnty as $row)
				{
					$fab_color_wise_wo_sql_qnty_arr[$row[csf('id')]][$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('fabric_color_id')]][$row[csf('dia_width')]]['fin_fab_qnty']=$row[csf('fin_fab_qnty')];
					
				$color_wise_wo_sql_qnty_arr[$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('fabric_color_id')]][$row[csf('dia_width')]]['fin_fab_qnty']=$row[csf('fin_fab_qnty')];
				
				$color_wise_wo_sql_qnty_arr[$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('fabric_color_id')]][$row[csf('dia_width')]]['grey_fab_qnty']=$row[csf('grey_fab_qnty')];
				
				$color_wise_wo_sql_qnty_arr[$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('fabric_color_id')]][$row[csf('dia_width')]]['rate']=$row[csf('rate')];
				
				$color_wise_wo_sql_qnty_arr[$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('fabric_color_id')]][$row[csf('dia_width')]]['amount']=$row[csf('amount')];
				//without Color
				$without_color_wise_wo_sql_qnty_arr[$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('dia_width')]]['fin_fab_qnty']+=$row[csf('fin_fab_qnty')];
				
				}
				unset($color_wise_wo_sql_qnty);
	}
				
	foreach($uom_arr as $uom_id=>$uom_val)
	{
		if($cbo_fabric_source==1)
		{
			$nameArray_fabric_description= sql_select("select a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , b.dia_width,d.pre_cost_remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
			WHERE a.job_no=b.job_no and
			a.id=b.pre_cost_fabric_cost_dtls_id and
			c.job_no_mst=a.job_no and
			c.id=b.color_size_table_id and
			b.po_break_down_id=d.po_break_down_id and
			b.color_number_id=d.gmts_color_id and
			b.dia_width=d.dia_width and
			b.gmts_sizes=c.size_number_id and
			b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
			d.booking_no =$txt_booking_no and
			a.job_id in($job_ids) and
			a.uom=$uom_id and
			d.status_active=1 and
			d.is_deleted=0 and
			b.cons>0
			group by a.id,a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,b.dia_width,d.pre_cost_remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
			
			if(count($nameArray_fabric_description)>0)
			{
				?>

				<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
				<caption>Fabric Details in <? echo $unit_of_measurement[$uom_val]; ?></caption>
				<tr align="center">
				<th colspan="3" align="left">Item Name</th>
				<?

				foreach($nameArray_fabric_description  as $result_fabric_description)
				{
				if( $result_fabric_description[csf('body_part_id')] == "")
				echo "<td colspan='3'>&nbsp</td>";
				else
				echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
				}
				?>
				<td  rowspan="11" width="50"><p>Total Finish Fabric (Kg)</p></td>

				<td  rowspan="11" width="50"><p>Avg Rate <? echo "(".$unit_of_measurement[$uom].")";?></p></td>
				<td  rowspan="11" width="50"><p>Amount </p></td>

				</tr>
				<tr align="center">
				<th colspan="3" align="left">Body Part</th>
				<?

				foreach($nameArray_fabric_description  as $result_fabric_description)
				{
				if( $result_fabric_description[csf('body_part_id')] == "")
				echo "<td colspan='3'>&nbsp</td>";
				else
				echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
				}
				?>
				</tr>
				<tr align="center"><th colspan="3" align="left">Color Type</th>
				<?
				foreach($nameArray_fabric_description  as $result_fabric_description)
				{
				if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
				else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
				}
				?>
				</tr>
				<tr align="center"><th colspan="3" align="left">Fabric Construction</th>
				<?
				foreach($nameArray_fabric_description  as $result_fabric_description)
				{
				if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
				else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
				}
				?>


				</tr>
				<tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
				<?
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
				else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
				}
				?>

				</tr>
				<tr align="center"><th  colspan="3" align="left">GSM</th>
				<?
				foreach($nameArray_fabric_description  as $result_fabric_description)
				{
				if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
				else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
				}
				?>

				</tr>
				<tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
				<?
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
				else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
				}
				?>

				</tr>
				<tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
				<?
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
				else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
				}
				?>
				</tr>
			    <tr align="center"><th   colspan="3" align="left">Remarks</th>
			        <?
					foreach($nameArray_fabric_description as $result_fabric_description)
					{
						if( $result_fabric_description[csf('pre_cost_remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('pre_cost_remarks')]."</td>";
					}
					?>

			       </tr>
				<tr>
				<th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
				</tr>
				<tr>
				<th  width="120" align="left">Fabric Color</th>
				<th  width="120" align="left">Body Color</th>
				<th  width="120" align="left">Lab Dip No</th>
				<?
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
				}
				?>
				</tr>
				<?
				/*$gmt_color_library=array();
				$gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
				FROM
				wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
				WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=$uom_id  and a.fabric_source =$cbo_fabric_source and
				a.job_no in ($job_no_in)");
				foreach( $gmt_color_data as $gmt_color_row){
				$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
				}
				$grand_total_fin_fab_qnty=0;
				$grand_total_amount=0;
				$color_wise_wo_sql=sql_select("select b.fabric_color_id
				FROM
				wo_pre_cost_fabric_cost_dtls a,
				wo_booking_dtls b
				WHERE
				a.id=b.pre_cost_fabric_cost_dtls_id and
				a.uom=$uom_id and
				b.booking_no =$txt_booking_no and
				b.job_no='".$row_per_job[csf('job_no')]."' and
				b.status_active=1 and
				b.is_deleted=0
				group by b.fabric_color_id");*/
				//if(count($color_wise_wo_arr)>0)
				foreach($color_wise_wo_arr as $color=>$color_wise_wo_result)
				{
				?>
				<tr>
				<td  width="120" align="left">
				<?
				echo $color_library[$color];
				?>
				</td>
				<td>
				<?
				echo implode(",",$gmt_color_library[$color]);
				?>
				</td>
				<td  width="120" align="left">
				<?
				$lapdip_no="";
				//$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
				$lapdip_no=$labdip_arr[$job_no][$color];
				if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
				?>
				</td>
				<?
				$total_fin_fab_qnty=0;
				$total_amount=0;

				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				/*if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
				WHERE
				a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				d.job_no='".$row_per_job[csf('job_no')]."' and
				a.uom=$uom_id and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
				d.fabric_color_id='".$color_wise_wo_result[csf('fabric_color_id')]."' and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				if($db_type==2)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
				WHERE
				a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				d.job_no='".$row_per_job[csf('job_no')]."' and
				a.uom=$uom_id and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and

				d.is_deleted=0
				");
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty*/
				$fabric_cost_dtls_id=$result_fabric_description[csf('fabric_cost_dtls_id')];  
				//$fin_fab_qnty=$color_wise_wo_sql_qnty_arr[$uom_id][$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('pre_cost_remarks')]][$color][$result_fabric_description[csf('dia_width')]]['fin_fab_qnty'];
				$fin_fab_qnty=$fab_color_wise_wo_sql_qnty_arr[$fabric_cost_dtls_id][$uom_id][$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('pre_cost_remarks')]][$color][$result_fabric_description[csf('dia_width')]]['fin_fab_qnty'];
			$grey_fab_qnty=$color_wise_wo_sql_qnty_arr[$uom_id][$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('pre_cost_remarks')]][$color][$result_fabric_description[csf('dia_width')]]['grey_fab_qnty'];
			$rate=$color_wise_wo_sql_qnty_arr[$uom_id][$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('pre_cost_remarks')]][$color][$result_fabric_description[csf('dia_width')]]['rate'];
			
			$amount=$color_wise_wo_sql_qnty_arr[$uom_id][$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('pre_cost_remarks')]][$color][$result_fabric_description[csf('dia_width')]]['amount'];
			
				?>
				<td width='50' align='right'>
				<?
				if($fin_fab_qnty!="")
				{
				echo def_number_format($fin_fab_qnty,2) ;
				$total_fin_fab_qnty+=$fin_fab_qnty;
				}
				?>
				</td>
				<td width='50' align='right' >
				<?
				if($rate!="")
				{
				echo def_number_format($rate,5);
				}
				?>
				</td>
				<td width='50' align='right' >
				<?
				$amount=def_number_format($amount,2,'',0);
				if($amount!="")
				{
				echo $amount;
				$total_amount+=$amount;
				}
				?>
				</td>
				<?
				}
				?>
				<td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
				<td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
				<td align="right">
				<?
				echo def_number_format($total_amount,2);

				?>
				</td>
				</tr>
				<?
				}
				?>
				<tr style=" font-weight:bold">
				<th  width="120" align="left">&nbsp;</th>
				<td  width="120" align="left">&nbsp;</td>
				<td  width="120" align="left"><strong>Total</strong></td>
				<?
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
				WHERE
				a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				d.job_no='".$row_per_job[csf('job_no')]."' and
				a.uom=$uom_id and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
				d.status_active=1 and
				d.is_deleted=0
				");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty*/
				$fin_fab_qnty=$without_color_wise_wo_sql_qnty_arr[$uom_id][$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('pre_cost_remarks')]][$result_fabric_description[csf('dia_width')]]['fin_fab_qnty'];
				?>
				<td width='50' align='right'><?  echo def_number_format($fin_fab_qnty,2) ;?></td>
				<td width='50' align='right'></td>
				<td width='50' align='right'></td>
				<?
				}
				?>
				<td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
				<td align="right"><? echo def_number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
				<td align="right">
				<?
				echo def_number_format($grand_total_amount,2);
				?>
				</td>
				</tr>
				<!--<tr style="font-weight:bold">
				<th  width="120" align="left">&nbsp;</th>
				<td  width="120" align="left">&nbsp;</td>
				<td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
				<?
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
				WHERE
				a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.uom=$uom_id and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.status_active=1 and
				d.is_deleted=0
				");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty*/
				?>
				<td width='50' align='right'></td>
				<td width='50' align='right'></td>
				<td width='50' align='right'></td>
				<?
				}
				?>
				<td align="right">
				<?
				//$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
				//echo number_format($consumption_per_unit_fab,2);
				?>
				</td>
				<td align="right">
				<?
				//$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
				//echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
				?>
				</td>
				<td align="right" title="Only Allow Round Figer">
				<?
				//echo number_format($consumption_per_unit_amuont,2);
				?>
				</td>
				</tr> -->
				</table>
				<br/>
				<?
			}
		}
	}
	//===========================
				$gmt_color_library=array();
				$gmt_color_data=sql_select("select a.uom,b.gmts_color_id, b.contrast_color_id
				FROM
				wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
				WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu    and a.fabric_source =$cbo_fabric_source and
				 a.job_id in($job_ids)");
				
				if(count($gmt_color_data)>0)
				{
				foreach( $gmt_color_data as $gmt_color_row){
				$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
				}
				}
				unset($gmt_color_data);
			$color_wise_wo_sql=sql_select("select b.fabric_color_id
				FROM
				wo_pre_cost_fabric_cost_dtls a,
				wo_booking_dtls b
				WHERE
				a.id=b.pre_cost_fabric_cost_dtls_id and
				 
				b.booking_no =$txt_booking_no and
				 a.job_id in($job_ids) and 
				b.status_active=1 and b.fin_fab_qnty>0 and
				b.is_deleted=0
				group by b.fabric_color_id");
				
				foreach($color_wise_wo_sql as $row)
				{
					$color_wise_wo_arr[$row[csf('fabric_color_id')]]=$row[csf('fabric_color_id')];
				}
				unset($color_wise_wo_sql);
				
				$sql_labdip=sql_select("select lapdip_no,job_no_mst,color_name_id as color from wo_po_lapdip_approval_info where job_no_mst in($job_no_in) and approval_status=3 ");
				foreach($sql_labdip as $row)
				{
					$labdip_arr[$row[csf('job_no_mst')]][$row[csf('color')]]=$row[csf('lapdip_no')];
				}
				
				unset($sql_labdip);
				
				$sql_plan=sql_select( "select size_number_id,color_number_id,(plan_cut_qnty) as plan_cut_qnty, (order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).")   and  job_no_mst in($job_no_in)  and  status_active=1 and is_deleted =0");
	//echo "select process_loss_method,uom from wo_pre_cost_fabric_cost_dtls where job_no in($job_no_in) and status_active=1";die;
				foreach($sql_plan as $row)
				{
					//$process_loss_method= $row[csf('process_loss_method')];
					$color_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']+=$row[csf('plan_cut_qnty')];
					$color_qty_arr[$row[csf('color_number_id')]][$row[csf('size_number_id')]]['qty']+=$row[csf('order_quantity')];
				}
				unset($sql_plan);
	
				
				$color_wise_wo_sql_qnty=sql_select("select a.id, a.uom,a.item_number_id as item_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,d.pre_cost_remarks,d.fabric_color_id,d.dia_width, sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
				WHERE
				a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id and
			    a.color_type_id=d.color_type  and
				d.gsm_weight=a.gsm_weight and
				d.booking_no =$txt_booking_no and
				a.job_id in($job_ids) and
				d.status_active=1 and d.fin_fab_qnty>0 and
				d.is_deleted=0 group by  a.id,a.uom,a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,d.pre_cost_remarks,d.fabric_color_id,d.dia_width");
				
				foreach($color_wise_wo_sql_qnty as $row)
				{
				$fab_color_wise_wo_sql_qnty_arr[$row[csf('id')]][$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('fabric_color_id')]][$row[csf('dia_width')]]['fin_fab_qnty']=$row[csf('fin_fab_qnty')];
				$fab_color_wise_wo_sql_qnty_arr[$row[csf('id')]][$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('fabric_color_id')]][$row[csf('dia_width')]]['amount']=$row[csf('amount')];
				$fab_color_wise_wo_sql_qnty_arr[$row[csf('id')]][$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('fabric_color_id')]][$row[csf('dia_width')]]['rate']=$row[csf('rate')];
				
				$color_wise_wo_sql_qnty_arr[$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('fabric_color_id')]][$row[csf('dia_width')]]['fin_fab_qnty']=$row[csf('fin_fab_qnty')];
				
				$color_wise_wo_sql_qnty_arr[$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('fabric_color_id')]][$row[csf('dia_width')]]['grey_fab_qnty']=$row[csf('grey_fab_qnty')];
				
				$color_wise_wo_sql_qnty_arr[$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('fabric_color_id')]][$row[csf('dia_width')]]['rate']=$row[csf('rate')];
				
				$color_wise_wo_sql_qnty_arr[$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('fabric_color_id')]][$row[csf('dia_width')]]['amount']=$row[csf('amount')];
				//without Color
				$without_color_wise_wo_sql_qnty_arr[$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('dia_width')]]['fin_fab_qnty']+=$row[csf('fin_fab_qnty')];
			
				$fab_without_color_wise_wo_sql_qnty_arr[$row[csf('id')]][$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('dia_width')]]['fin_fab_qnty']+=$row[csf('fin_fab_qnty')];
				
				//$fab_without_color_wise_wo_sql_qnty_arr[$row[csf('id')]][$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('dia_width')]]['fin_fab_qnty']+=$row[csf('fin_fab_qnty')];
				
				}
				unset($color_wise_wo_sql_qnty);
				
				
	foreach($uom_arr as $uom_id=>$uom_val)
	{
		if($cbo_fabric_source==2)
		{
			$nameArray_fabric_description= sql_select("select a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , b.dia_width,d.pre_cost_remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
			WHERE a.job_id=b.job_id and
			a.id=b.pre_cost_fabric_cost_dtls_id and
			c.job_id=a.job_id and
		  a.color_type_id=d.color_type  and
			d.gsm_weight=a.gsm_weight and
			c.id=b.color_size_table_id and
			b.po_break_down_id=d.po_break_down_id and
			b.color_number_id=d.gmts_color_id and
			c.color_number_id=d.gmts_color_id and
			b.gmts_sizes=c.size_number_id and
			b.dia_width=d.dia_width and
			d.fabric_color_id>0 and
			b.remarks=d.pre_cost_remarks and
			
			b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
			d.booking_no =$txt_booking_no and
			a.job_id in($job_ids) and 
			a.uom=$uom_id and 
			d.status_active=1 and
			d.is_deleted=0  and
			d.fin_fab_qnty>0 and
			b.cons>0
			group by a.id,a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,b.dia_width,d.pre_cost_remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
			
			
			//echo "=".count($nameArray_fabric_description);die;
			
			//echo "ABA";die;
			if(count($nameArray_fabric_description)>0)
			{
				?>
				<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
				<caption>Fabric Details in <? echo $unit_of_measurement[$uom_val];?></caption>
				<tr align="center">
				<th colspan="3" align="left">Item Name</th>
				<?
				foreach($nameArray_fabric_description  as $result_fabric_description)
				{
				if( $result_fabric_description[csf('body_part_id')] == "")
				echo "<td colspan='3'>&nbsp</td>";
				else
				echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
				}
				?>
				<td  rowspan="11" width="50"><p>Total Finish Fabric</p></td>

				<td  rowspan="11" width="50"><p>Avg Rate</p></td>
				<td  rowspan="11" width="50"><p>Amount </p></td>
				</tr>
				<tr align="center">
				<th colspan="3" align="left">Body Part</th>
				<?
				foreach($nameArray_fabric_description  as $result_fabric_description)
				{
				if( $result_fabric_description[csf('body_part_id')] == "")
				echo "<td colspan='3'>&nbsp</td>";
				else
				echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
				}
				?>
				</tr>
				<tr align="center"><th colspan="3" align="left">Color Type</th>
				<?
				foreach($nameArray_fabric_description  as $result_fabric_description)
				{
				if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
				else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
				}
				?>
				</tr>
				<tr align="center"><th colspan="3" align="left">Fabric Construction</th>
				<?
				foreach($nameArray_fabric_description  as $result_fabric_description)

				{
				if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
				else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
				}
				?>
				</tr>
				<tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
				<?
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
				else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
				}
				?>
				</tr>
				<tr align="center"><th  colspan="3" align="left">GSM</th>
				<?
				foreach($nameArray_fabric_description  as $result_fabric_description)
				{
				if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
				else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
				}
				?>
				</tr>
				<tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
				<?
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
				else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
				}
				?>

				</tr>
				<tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
				<?
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
				else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
				}
				?>

				</tr>
			    <tr align="center"><th   colspan="3" align="left">Remarks</th>
			        <?
					foreach($nameArray_fabric_description as $result_fabric_description)
					{
						if( $result_fabric_description[csf('pre_cost_remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('pre_cost_remarks')]."</td>";
					}
					?>

			       </tr>
				<tr>
				<th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
				</tr>
				<tr>
				<th  width="120" align="left">Fabric Color</th>
				<th  width="120" align="left">Body Color</th>
				<th  width="120" align="left">Lab Dip No</th>
				<?
				if($cbo_fabric_source==2)
				{
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
				}
				}
				else
				{
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				echo "<th width='50'>Fab. Qty</th>";
				}
				}

				?>
				</tr>
				<?
				/*$gmt_color_library=array();

				$gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
				FROM
				wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
				WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=$uom_id  and a.fabric_source =$cbo_fabric_source and
				a.job_no in ($job_no_in)");
				if(count($gmt_color_data)>0)
				{
				foreach( $gmt_color_data as $gmt_color_row){
				$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
				}
				}*/
				$grand_total_fin_fab_qnty=0;
				$grand_total_amount=0;
				/*$color_wise_wo_sql=sql_select("select b.fabric_color_id
				FROM
				wo_pre_cost_fabric_cost_dtls a,
				wo_booking_dtls b
				WHERE
				a.id=b.pre_cost_fabric_cost_dtls_id and
				a.uom=$uom_id and
				b.booking_no =$txt_booking_no and
				b.job_no in ($job_no_in) and
				b.status_active=1 and b.fin_fab_qnty>0 and
				b.is_deleted=0
				group by b.fabric_color_id");*/
				//$color_wise_wo_arr[$row[csf('fabric_color_id')]];
				//if(count($color_wise_wo_sql)>0)
				if(count($color_wise_wo_arr)>0)
				{
				foreach($color_wise_wo_arr as $color=>$color_wise_wo_result)
				{
				?>
				<tr>
				<td  width="120" align="left">
				<?
				echo $color_library[$color];
				?>
				</td>
				<td>
				<?
				echo implode(",",$gmt_color_library[$color]);
				?>
				</td>
				<td  width="120" align="left">
				<?
				$lapdip_no="";
				//$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
				$lapdip_no=$labdip_arr[$job_no][$color];
				if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
				?>
				</td>
				<?
				$total_fin_fab_qnty=0;
				$total_amount=0;
				if(count($nameArray_fabric_description)>0)
				{
					foreach($nameArray_fabric_description as $result_fabric_description)
					{
				if($db_type==0)
				{
				/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
				WHERE
				a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				 
				d.job_no in ($job_no_in) and
				a.uom=$uom_id and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
				d.fabric_color_id='".$color."' and
				d.status_active=1 and
				d.is_deleted=0
				");*/
				}
				if($db_type==2)
				{
					
				/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
				WHERE
				a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id and
			    a.color_type_id=d.color_type  and
				d.gsm_weight=a.gsm_weight and
				d.booking_no =$txt_booking_no and
				d.job_no in ($job_no_in) and
				a.uom=$uom_id and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color."',0) and
				d.status_active=1 and d.fin_fab_qnty>0 and
				d.is_deleted=0
				");*/
			//	$color_wise_wo_sql_qnty_arr[$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('fabric_color_id')]][$row[csf('dia_width')]]['fin_fab_qnty']=$row[csf('fin_fab_qnty')];
				
			
				}
				$fabric_cost_dtls_id=$result_fabric_description[csf('fabric_cost_dtls_id')];
				$fin_fab_qnty=$fab_color_wise_wo_sql_qnty_arr[$fabric_cost_dtls_id][$uom_id][$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('pre_cost_remarks')]][$color][$result_fabric_description[csf('dia_width')]]['fin_fab_qnty'];
			$grey_fab_qnty=$color_wise_wo_sql_qnty_arr[$uom_id][$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('pre_cost_remarks')]][$color][$result_fabric_description[csf('dia_width')]]['grey_fab_qnty'];
			$rate=$fab_color_wise_wo_sql_qnty_arr[$fabric_cost_dtls_id][$uom_id][$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('pre_cost_remarks')]][$color][$result_fabric_description[csf('dia_width')]]['rate'];
			
			$amount=$fab_color_wise_wo_sql_qnty_arr[$fabric_cost_dtls_id][$uom_id][$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('pre_cost_remarks')]][$color][$result_fabric_description[csf('dia_width')]]['amount'];
			
				//echo count($color_wise_wo_sql_qnty)."=D";die;
				//if(count($color_wise_wo_sql_qnty)>0)
				//list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
				?>
				<td width='50' align='right'>
				<?
				if($fin_fab_qnty!="")
				{
				echo def_number_format($fin_fab_qnty,2) ;
				$total_fin_fab_qnty+=$fin_fab_qnty;
				}
				?>
				</td>
				<td width='50' align='right' >
				<?
				if($rate!="")
				{
				echo def_number_format($rate,5);
				}
				?>
				</td>
				<td width='50' align='right' >
				<?
				$amount=def_number_format($amount,2,'',0);
				if($amount!="")
				{
				echo $amount;
				$total_amount+=$amount;
				}
				?>
				</td>
				<?
				}
				}
				?>
				<td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
				<td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
				<td align="right">
				<?
				echo def_number_format($total_amount,2);

				?>
				</td>
				</tr>
				<?
				}
				}
				?>
				<tr style=" font-weight:bold">
				<th  width="120" align="left">&nbsp;</th>
				<td  width="120" align="left">&nbsp;</td>
				<td  width="120" align="left"><strong>Total</strong></td>
				<?
				if(count($nameArray_fabric_description)>0)
				{
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
				WHERE
				a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id and
			    a.color_type_id=d.color_type  and
				d.gsm_weight=a.gsm_weight and
				d.booking_no =$txt_booking_no and
				d.job_no in ($job_no_in) and
				a.uom=$uom_id and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
				d.status_active=1 and d.fin_fab_qnty>0 and
				d.is_deleted=0
				");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty*/ 
				$fabric_cost_dtls_id=$result_fabric_description[csf('fabric_cost_dtls_id')];
					$fin_fab_qnty=$fab_without_color_wise_wo_sql_qnty_arr[$fabric_cost_dtls_id][$uom_id][$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('pre_cost_remarks')]][$result_fabric_description[csf('dia_width')]]['fin_fab_qnty'];
				?>
				<td width='50' align='right'><?  echo def_number_format($fin_fab_qnty,2) ;?></td>
				<td width='50' align='right' ></td>
				<td width='50' align='right' ></td>
				<?
				}
				}
				?>
				<td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
				<td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
				<td align="right">
				<?
				echo def_number_format($grand_total_amount,2);
				?>
				</td>
				</tr>
				<!--<tr style="font-weight:bold">
				<th  width="120" align="left">&nbsp;</th>
				<td  width="120" align="left">&nbsp;</td>
				<td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
				<?
				if(count($nameArray_fabric_description)>0)
				{
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
				WHERE
				a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.uom=$uom_id and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.status_active=1 and
				d.is_deleted=0
				");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty*/

				?>
				<td width='50' align='right'></td>
				<td width='50' align='right'></td>
				<td width='50' align='right'></td>
				<?
				}
				}
				?>
				<td align="right">
				<?
				//$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
				//echo number_format($consumption_per_unit_fab,2);
				?>
				</td>
				<td align="right">
				<?
				//$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
				//echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
				?>
				</td>
				<td align="right" title="Only Allow Round Figer">
				<?
				//echo number_format($consumption_per_unit_amuont,2);
				?>
				</td>
				</tr> -->
				</table>
				<br/>
				<?
			}
		}
	}
	//===========================
	?>
    <?
	//echo "AA";die;
	$sql_data=sql_select("select a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,a.uom,b.dia_width,b.pre_cost_remarks,b.fabric_color_id,b.remark, sum(b.grey_fab_qnty) as grey_fab_qnty,sum(b.adjust_qty)as adjust_qty,sum(b.fin_fab_qnty) as fin_fab_qnty,avg(b.rate) as rate,sum(b.grey_fab_qnty*b.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and a.color_type_id=d.color_type and d.gsm_weight=a.gsm_weight and b.grey_fab_qnty>0  and b.booking_no =$txt_booking_no and  b.job_no in($job_no_in) and  and b.adjust_qty>0 and b.status_active=1 and b.is_deleted=0 group by a.id,a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,a.uom,b.dia_width,b.pre_cost_remarks,b.fabric_color_id,b.remark order by a.id,a.body_part_id");

		?>
		<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

        <tr>
        <td colspan="7">
        <strong>Fabric Stock Adjustment Details</strong>
        </td>

        </tr>

        <tr>
        <td>
        Fabrication
        </td>
        <td>
        Process
        </td>
        <td>
        Fabric Color
        </td>
        <td>
        Required
        </td>
        <td>
        Stock Used
        </td>
        <td>
        Booking Qty
        </td><td>
        Uom
        </td>
         <td>
        Remarks
        </td>
        </tr>
        <?
		if(count($sql_data)>0)
		{
		foreach($sql_data as $row){
		?>
          <tr>
        <td>
        <? echo $body_part[$row[csf('body_part_id')]].",".$color_type[$row[csf('color_type_id')]].",".$row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$fabric_typee[$row[csf('width_dia_type')]].",".$row[csf('dia_width')]  ?>
        </td>
        <td>
        <? echo $row[csf('pre_cost_remarks')];  ?>
        </td>
        <td>
        <? echo $color_library[$row[csf('fabric_color_id')]];  ?>
        </td>
        <td align="right">
        <? echo number_format($row[csf('grey_fab_qnty')],4);  ?>
        </td>
        <td align="right">
         <? echo number_format($row[csf('adjust_qty')],4) ; ?>
        </td>
        <td align="right">
       <? echo number_format($row[csf('fin_fab_qnty')],4);  ?>
        </td>
         <td>
        <? echo $unit_of_measurement[$row[csf('uom')]];  ?>
        </td>
         <td>
         <? echo $row[csf('remark')];  ?>
        </td>
        </tr>
        <?
		}
		}
		?>
        </table>


	<?
//echo	"G".die;
	if($cbo_fabric_source==1 || $cbo_fabric_source==2){
	?>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
	<tr>
	<?
	$nameArray_item_size=sql_select( "select min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_id=b.job_id and a.job_id=c.job_id and a.id=b.pre_cost_fabric_cost_dtls_id and c.id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active =1 and d.is_deleted=0  and  d.job_no in($job_no_in)  and a.body_part_id=2     and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
	
	if(count($nameArray_item_size)>0)
	{
	?>
	<td width="49%">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr>
	<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Collar -  Colour Size Brakedown in Pcs</b></td>
	</tr>
	<tr>
	<td width="70">Size</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?
	}
	?>
	<td rowspan="2" align="center"><strong>Total</strong></td>
	<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
	</tr>
	<tr>
	<td>Collar Size</td>

	<?
	foreach($nameArray_item_size  as $result_item_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
	<?
	}
	?>
	<?
	//and c.id=d.color_size_table_id
	$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active =1 and d.is_deleted=0 and  d.job_no in($job_no_in)   and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id  and c.color_number_id=d.gmts_color_id and d.status_active=1 and d.is_deleted=0 group by c.color_number_id,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
	");
	
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	$color_total_collar=0;
	$color_total_collar_order_qnty=0;
	$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
	$constrast_color_arr=array();
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
	for($i=0;$i<count($constrast_color);$i++)
	{
	$constrast_color2=explode('_',$constrast_color[$i]);
	$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
	}
	}
	?>
	<tr>
	<td>
	<?
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
	$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
	}
	else
	{
	echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
	$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
	}
	?>
	</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black">
	 <?
	/*$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."  and  job_no_mst in($job_no_in)  and  status_active=1 and is_deleted =0");
	list($plan_cut_qnty)=$color_wise_wo_sql_qnty;*/
	$plan_cut=$color_qty_arr[$color_wise_wo_result[csf('color_number_id')]][$result_size[csf('size_number_id')]]['plan'];//$plan_cut_qnty[csf('plan_cut_qnty')];
	$colar_excess_per=($plan_cut*$colar_excess_percent)/100;
	echo number_format($plan_cut+$colar_excess_per,0);
	$color_total_collar+=$plan_cut+$colar_excess_per;
	$color_total_collar_order_qnty+=$plan_cut;
	$grand_total_collar+=$plan_cut+$colar_excess_per;
	$grand_total_collar_order_qnty+=$plan_cut;
	?>
	</td>
	<?
	}
	?>
	<td align="center"><? echo number_format($color_total_collar,0); ?></td>
	<td align="center"><? echo number_format((($color_total_collar-$color_total_collar_order_qnty)/$color_total_collar_order_qnty)*100,2); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td>Size Total</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:center"><? $colar_excess_pers=($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]+$colar_excess_pers,0); ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar,0); ?></td>
	<td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_collar-$grand_total_collar_order_qnty)/$grand_total_collar_order_qnty)*100,2); ?></td>
	</tr>
	</table>
	</td>
	<td width="2%">
	</td>
	<?
	}
	?>
	<?
	$nameArray_item_size=sql_select( "select min(c.id) as id, b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and  d.job_no in($job_no_in) and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");

	if(count($nameArray_item_size)>0)
	{
	?>
	<td width="49%">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr>
	<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Cuff -  Colour Size Brakedown in Pcs</b></td>
	</tr>
	<tr>
	<td width="70">Size</td>

	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?
	}
	?>
	<td rowspan="2" align="center"><strong>Total</strong></td>
	<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
	</tr>
	<tr>
	<td>Cuff Size</td>

	<?
	foreach($nameArray_item_size  as $result_item_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
	<?
	}
	?>
	<?
	$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and  d.job_no in($job_no_in) and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id  and  d.status_active=1 and d.is_deleted=0 group by c.color_number_id ,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
	");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	$color_total_cuff=0;
	$color_total_cuff_order_qnty=0;
	$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
	$constrast_color_arr=array();
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
	for($i=0;$i<count($constrast_color);$i++)
	{
	$constrast_color2=explode('_',$constrast_color[$i]);
	$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
	}
	}
	?>
	<tr>
	<td>
	<?
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]);
	$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
	}
	else
	{
	echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
	$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
	}
	?>
	</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black">
	<?
	/*$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  job_no_mst in($job_no_in) and  status_active=1 and is_deleted =0");
	list($plan_cut_qnty)=$color_wise_wo_sql_qnty;*/
	$plan_cut=$plan_cut=$color_qty_arr[$color_wise_wo_result[csf('color_number_id')]][$result_size[csf('size_number_id')]]['plan'];//$plan_cut_qnty[csf('plan_cut_qnty')];
	$cuff_excess_per=(($plan_cut*2)*$cuff_excess_percent)/100;
	echo number_format($plan_cut*2+$cuff_excess_per,0);
	$color_total_cuff+=$plan_cut*2+$cuff_excess_per;
	$color_total_cuff_order_qnty+=$plan_cut*2;
	$grand_total_cuff+=$plan_cut*2+$cuff_excess_per;
	$grand_total_cuff_order_qnty+=$plan_cut*2;
	?>
	</td>
	<?
	}
	?>
	<td align="center"><? echo number_format($color_total_cuff,0); ?></td>
	<td align="center"><? echo number_format((($color_total_cuff-$color_total_cuff_order_qnty)/$color_total_cuff_order_qnty)*100,2); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td>Size Total</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:center"><? $cuff_excess_pers=(($size_tatal[$result_size[csf('size_number_id')]]*2)*$cuff_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]*2+$cuff_excess_pers,0); ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_cuff,0); ?></td>
	<td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_cuff-$grand_total_cuff_order_qnty)/$grand_total_cuff_order_qnty)*100,2); ?></td>
	</tr>
	</table>
	</td>
	<?
	}
	?>
	</tr>
	</table>
	<br/>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
	<tr>
	<?
	$nameArray_item_size=sql_select( "select min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.job_no in($job_no_in)  and a.body_part_id=172  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
	if(count($nameArray_item_size)>0)
	{
	?>
	<td width="49%">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr>
	<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Collar Tipping -  Colour Size Brakedown in Pcs</b></td>
	</tr>
	<tr>
	<td width="70">Size</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?
	}
	?>
	<td rowspan="2" align="center"><strong>Total</strong></td>
	<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
	</tr>
	<tr>
	<td>Collar Size</td>
	<?
	foreach($nameArray_item_size  as $result_item_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
	<?
	}
	?>
	<?
	$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and  d.job_no in($job_no_in) and a.body_part_id=172  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by c.color_number_id,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
	");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	$color_total_collar_tipping=0;
	$color_total_collar_tipping_order_qnty=0;
	$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
	$constrast_color_arr=array();
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
	for($i=0;$i<count($constrast_color);$i++)
	{
	$constrast_color2=explode('_',$constrast_color[$i]);
	$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
	}
	}
	?>
	<tr>
	<td>
	<?
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
	$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
	}
	else
	{
	echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
	$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
	}
	?>
	</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black">
	<?
	/*$color_tipping_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]." and  job_no_mst in($job_no_in)   and  status_active=1 and is_deleted =0");

	list($plan_cut_qnty)=$color_tipping_wise_wo_sql_qnty;*/
	$plan_cut=$color_qty_arr[$color_wise_wo_result[csf('color_number_id')]][$result_size[csf('size_number_id')]]['plan'];//$plan_cut_qnty[csf('plan_cut_qnty')];
	$colar_excess_per=($plan_cut*$colar_excess_percent)/100;
	echo number_format($plan_cut+$colar_excess_per,0);
	$color_total_collar_tipping+=$plan_cut+$colar_excess_per;
	$color_total_collar_tipping_order_qnty+=$plan_cut;
	$grand_total_collar_tipping+=$plan_cut+$colar_excess_per;
	$grand_total_collar_tipping_order_qnty+=$plan_cut;
	?>
	</td>
	<?
	}
	?>
	<td align="center"><? echo number_format($color_total_collar_tipping,0); ?></td>
	<td align="center"><? echo number_format((($color_total_collar_tipping-$color_total_collar_tipping_order_qnty)/$color_total_collar_tipping_order_qnty)*100,2); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td>Size Total</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:center"><? $colar_excess_pers=($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]+$colar_excess_pers,0); ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar_tipping,0); ?></td>
	<td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_collar_tipping-$grand_total_collar_tipping_order_qnty)/$grand_total_collar_tipping_order_qnty)*100,2); ?></td>
	</tr>
	</table>
	</td>
	<td width="2%">
	</td>
	<?
	}
	?>
	<?
	$nameArray_item_size=sql_select( "select min(c.id) as id, b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.job_no in($job_no_in)  and a.body_part_id=214  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
	if(count($nameArray_item_size)>0)
	{
	?>
	<td width="49%">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr>
	<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Cuff Tipping -  Colour Size Brakedown in Pcs</b></td>
	</tr>
	<tr>
	<td width="70">Size</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?
	}
	?>
	<td rowspan="2" align="center"><strong>Total</strong></td>
	<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
	</tr>
	<tr>
	<td>Cuff Size</td>
	<?
	foreach($nameArray_item_size  as $result_item_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
	<?
	}
	?>
	<?
	$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and d.job_no in($job_no_in) and a.body_part_id=214  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and  d.status_active=1 and d.is_deleted=0 group by c.color_number_id ,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
	");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	$color_total_cuff_tipping=0;
	$color_total_cuff_tipping_order_qnty=0;
	$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
	$constrast_color_arr=array();
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
	for($i=0;$i<count($constrast_color);$i++)
	{
	$constrast_color2=explode('_',$constrast_color[$i]);
	$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
	}
	}
	?>
	<tr>
	<td>
	<?
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]);
	$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
	}
	else
	{
	echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
	$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
	}
	?>
	</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black">
	<?
	/*$cuff_tipping_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and job_no_mst in($job_no_in)    and  status_active=1 and is_deleted =0");
	list($plan_cut_qnty)=$cuff_tipping_wise_wo_sql_qnty;*/
	$plan_cut=$color_qty_arr[$color_wise_wo_result[csf('color_number_id')]][$result_size[csf('size_number_id')]]['plan'];//$plan_cut_qnty[csf('plan_cut_qnty')];
	$cuff_tipping_excess_per=(($plan_cut*2)*$cuff_excess_percent)/100;
	echo number_format($plan_cut*2+$cuff_tipping_excess_per,0);
	$color_total_cuff_tipping+=$plan_cut*2+$cuff_tipping_excess_per;
	$color_total_cuff_tipping_order_qnty+=$plan_cut*2;
	$grand_total_cuff_tipping+=$plan_cut*2+$cuff_excess_per;
	$grand_total_cuff_tipping_order_qnty+=$plan_cut*2;
	?>
	</td>
	<?
	}
	?>
	<td align="center"><? echo number_format($color_total_cuff_tipping,0); ?></td>
	<td align="center" title="<? echo $color_total_cuff_tipping."**".$color_total_cuff_tipping_order_qnty; ?>"><? echo number_format((($color_total_cuff_tipping-$color_total_cuff_tipping_order_qnty)/$color_total_cuff_tipping_order_qnty)*100,2); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td>Size Total</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:center"><? $cuff_excess_pers=(($size_tatal[$result_size[csf('size_number_id')]]*2)*$cuff_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]*2+$cuff_excess_pers,0); ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_cuff_tipping,0); ?></td>
	<td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_cuff_tipping-$grand_total_cuff_tipping_order_qnty)/$grand_total_cuff_tipping_order_qnty)*100,2); ?></td>
	</tr>
	</table>
	</td>
	<?
	}
	?>
	</tr>
	</table>
	<br/>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
	<tr>
	<td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
	<thead>
	<tr>
	<th width="3%"></th><th width="97%" align="left"><u>Special Instruction</u></th>
	</tr>
	</thead>
	<tbody>
	<?
	$data_array=sql_select("select id, terms from  wo_booking_terms_condition where booking_no=$txt_booking_no");
	if ( count($data_array)>0)
	{
	$i=0;
	foreach( $data_array as $row )
	{
	$i++;
	?>
	<tr id="settr_1" valign="top">
	<td style="vertical-align:top">
	<? echo $i;?>
	</td>
	<td>
	<strong style="font-size:20px"> <? echo $row[csf('terms')]; ?></strong>
	</td>
	</tr>
	<?
	}
	}
	?>
	</tbody>
	</table>
	</td>
	<td width="2%">
	</td>
	<td width="49%" valign="top">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr align="center">
	<td><b>Approved Instructions</b></td>
	</tr>
	<tr>
	<td>
	<?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
	</td>
	</tr>
	</table>
	<br />
	</td>
	</tr>
	</table>
	<br>
	<?
	//------------------------------ Query for TNA start-----------------------------------
	$po_id_all=str_replace("'","",$txt_order_no_id);
	$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
	$tna_start_sql=sql_select( "select id,po_number_id,
	(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
	(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
	(case when task_number=60 then task_start_date else null end) as knitting_start_date,
	(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
	(case when task_number=61 then task_start_date else null end) as dying_start_date,
	(case when task_number=61 then task_finish_date else null end) as dying_end_date,
	(case when task_number=73 then task_start_date else null end) as finishing_start_date,
	(case when task_number=73 then task_finish_date else null end) as finishing_end_date,

	(case when task_number=84 then task_start_date else null end) as cutting_start_date,
	(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
	(case when task_number=86 then task_start_date else null end) as sewing_start_date,
	(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
	(case when task_number=110 then task_start_date else null end) as exfact_start_date,
	(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
	(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
	(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
	from tna_process_mst
	where status_active=1 and po_number_id in($po_id_all) and  job_no_mst in($job_no_in) ");
	$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
	$tna_date_task_arr=array();
	foreach($tna_start_sql as $row)
	{
	if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
	{
	if($tna_fab_start=="")
	{
	$tna_fab_start=$row[csf("fab_booking_start_date")];
	}
	}
	if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
	}
	if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
	}
	if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
	}
	if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
	}
	if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
	}
	if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
	}
	if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
	}
	}
	//------------------------------ Query for TNA end-----------------------------------
	?>
	<fieldset id="div_size_color_matrix" style="max-width:1000; display:none">
	<legend>TNA Information</legend>
	<table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
	<tr>
	<td rowspan="2" align="center" valign="top">SL</td>
	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
	<td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
	<td colspan="2" align="center" valign="top"><b>Knitting</b></td>
	<td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
	<td colspan="2" align="center" valign="top"><b>Finishing Fabric</b></td>
	<td colspan="2" align="center" valign="top"><b>Cutting </b></td>
	<td colspan="2" align="center" valign="top"><b>Sewing </b></td>
	<td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
	</tr>
	<tr>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	</tr>
	<?
	$i=1;
	foreach($tna_date_task_arr as $order_id=>$row)
	{
	?>
	<tr>
	<td><? echo $i; ?></td>
	<td><? echo $po_num_arr[$order_id]; ?></td>
	<td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
	<td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
	<td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
	</tr>
	<?
	$i++;
	}
	?>
	</table>
	</fieldset>
	<?
	}// fabric Source End
	?>
	<?
	//echo signature_table(1, $cbo_company_name, "1330px");
	echo signature_table(121, $cbo_company_name, "1330px", 1);
	?>
    <p class="gg"></p>

    <?
	 
	
$job_no_all= implode(",",array_unique($joball['job_no']));
	$style_sting_all=implode(",",array_unique($joball['style_ref_no']));

	echo "****".custom_file_name($txt_booking_no,$style_sting_all,$job_no_all);
	?>
	</div>
	<?
	
	$html = ob_get_contents();
	ob_clean();
	list($is_mail_send,$mail)=explode('___',$mail_send_data);

	if($is_mail_send==1){
		require_once('../../../mailer/class.phpmailer.php');
		require_once('../../../auto_mail/setting/mail_setting.php');
		$mailBody = preg_replace("/<img[^>]+\>/i", " ", $html); 
		$mailBody="<br>".$mail_body	;	
		$mailToArr=array();
		$mailSql = "select b.EMAIL  from wo_booking_mst a,LIB_SUPPLIER b where b.id=a.supplier_id and a.booking_no=$txt_booking_no";
	//echo $mailSql;die;
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
		}
		
		
		$mailSql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=99 and b.mail_user_setup_id=c.id  and c.IS_DELETED=0 and c.STATUS_ACTIVE=1";
		//echo $mailSql;die;
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
		}
		if($mail!=''){$mailToArr[]=$mail;}

		$to=implode(',',$mailToArr);
		$subject="Partial fabric booking";
		$header=mailHeader();
		echo $to;
		echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
		
	}
	else{
		echo $html;
	}
	exit(); 

}

if($action=="show_fabric_booking_report_urmi_per_job_29_4-2021"){ 


	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$company_library=return_library_array( "select id,company_name from lib_company", "id", "company_name");
	$color_library=return_library_array( "select id,color_name from lib_color", "id", "color_name");
	$size_library=return_library_array( "select id,size_name from lib_size", "id", "size_name");
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	//$supplier_address_arr=return_library_array( "select id,address_1 from   lib_supplier",'id','address_1');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	//$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	//$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	$season_arr=return_library_array("select id,season_name from lib_buyer_season","id","season_name");
	$uom=0;
	$joball=array();
	/*$nameArray_per_job=sql_select( "select  a.job_no,a.style_ref_no  from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by a.job_no,a.style_ref_no");
	foreach ($nameArray_per_job as $row_per_job){ 
	
	$joball['job_no'][$row_per_job[csf('job_no')]]=$row_per_job[csf('job_no')];
	$joball['style_ref_no'][$row_per_job[csf('job_no')]]=$row_per_job[csf('style_ref_no')];
	}
	unset($nameArray_per_job);*/
	$uom=0;
	$job_data_arr=array();
	$nameArray_buyer=sql_select( "select a.id as job_id, a.style_ref_no, a.style_description, a.job_no, a.style_owner, a.buyer_name, a.client_id, a.dealing_marchant, a.season, a.season_matrix, a.total_set_qnty, a.product_dept, a.product_code, a.pro_sub_dep, a.gmts_item_id, a.order_repeat_no, a.qlty_label,a.season_buyer_wise from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0 ");
	foreach ($nameArray_buyer as $result_buy){
		$job_data_arr['job_id'][$result_buy[csf('job_id')]]=$result_buy[csf('job_id')];
		$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
		$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
		$job_data_arr['total_set_qnty'][$result_buy[csf('job_no')]]=$result_buy[csf('total_set_qnty')];
		$job_data_arr['product_dept'][$result_buy[csf('job_no')]]=$product_dept[$result_buy[csf('product_dept')]];
		$job_data_arr['product_code'][$result_buy[csf('job_no')]]=$result_buy[csf('product_code')];
		$job_data_arr['pro_sub_dep'][$result_buy[csf('job_no')]]=$pro_sub_dept_array[$result_buy[csf('pro_sub_dep')]];
		$job_data_arr['gmts_item_id'][$result_buy[csf('job_no')]]=$result_buy[csf('gmts_item_id')];
		$job_data_arr['style_ref_no'][$result_buy[csf('job_no')]]=$result_buy[csf('style_ref_no')];
		$job_data_arr['style_description'][$result_buy[csf('job_no')]]=$result_buy[csf('style_description')];
		$job_data_arr['dealing_marchant'][$result_buy[csf('job_no')]]=$marchentrArr[$result_buy[csf('dealing_marchant')]];
		$job_data_arr['season_matrix'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_matrix')]];
		$job_data_arr['season_buyer_wise'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_buyer_wise')]];
		$job_data_arr['order_repeat_no'][$result_buy[csf('job_no')]]=$result_buy[csf('order_repeat_no')];
		$job_data_arr['qlty_label'][$result_buy[csf('job_no')]]=$quality_label[$result_buy[csf('qlty_label')]];
		$job_data_arr['client'][$result_buy[csf('job_no')]]=$result_buy[csf('client_id')];
		
		$joball['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
		$joball['style_ref_no'][$result_buy[csf('job_no')]]=$result_buy[csf('style_ref_no')];
	}

	$job_ids= implode(",",array_unique($job_data_arr['job_id']));
	$job_no= implode(",",array_unique($job_data_arr['job_no']));
	$job_no_in= implode(",",array_unique($job_data_arr['job_no_in']));
	$product_depertment=implode(",",array_unique($job_data_arr['product_dept']));
	$product_code=implode(",",array_unique($job_data_arr['product_code']));
	$pro_sub_dep=implode(",",array_unique($job_data_arr['pro_sub_dep']));
	$gmts_item_id=implode(",",array_unique($job_data_arr['gmts_item_id']));
	$style_sting=implode(",",array_unique($job_data_arr['style_ref_no']));
	$style_description=implode(",",array_unique($job_data_arr['style_description']));
	$dealing_marchant=implode(",",array_unique($job_data_arr['dealing_marchant']));
	$season_matrix=implode(",",array_unique($job_data_arr['season_matrix']));
	$season_buyer_wise=implode(",",array_unique($job_data_arr['season_buyer_wise']));
	$order_repeat_no= implode(",",array_unique($job_data_arr['order_repeat_no']));
	$qlty_label= implode(",",array_unique($job_data_arr['qlty_label']));
	$client_id= implode(",",array_unique($job_data_arr['client']));
	?>
    <style>
     .table_valign { vertical-align: top;word-break: break-all;word-wrap: break-word; }
@media print {
    .gg {page-break-after: always;}
}
</style>
	<div style="width:1330px" align="center">

	<?php
$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and a.status_active =1 and a.is_deleted=0");
list($nameArray_approved_row) = $nameArray_approved;
$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
list($nameArray_approved_date_row) = $nameArray_approved_date;
$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
list($nameArray_approved_comments_row) = $nameArray_approved_comments;
$path = str_replace("'", "", $path);
if ($path != "") {
	$path = $path;
} else {
	$path = "../../";
}

?>										<!--    Header Company Information         -->
	<table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black" >
	<tr>
	<td width="100">
	<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
	</td>
	<td width="1250">
	<table width="100%" cellpadding="0" cellspacing="0"  >
	<tr>
	<td align="center" style="font-size:20px;">
	<?php
echo $company_library[$cbo_company_name];
?>
	</td>
	<td rowspan="3" width="250">

	<span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($job_no,"'"); ?></b></span><br/>
	<?
	if($nameArray_approved_row[csf('approved_no')]>1)
	{
	?>
	<b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
	<br/>
	Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
	<?
	}
	?>


	</td>
	</tr>
	<tr>
	<td align="center" style="font-size:14px">
	<?
	$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
	if($txt_job_no!="")
	{
	$location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'");
	}
	else
	{
	$location="";
	}

	foreach ($nameArray as $result)
	{
	echo  $location_name_arr[$location];
	?>

	Email Address: <? echo $result[csf('email')];?>
	Website No: <? echo $result[csf('website')]; ?>

	<?

	}

	?>
	</td>
	</tr>
	<tr>
	<td align="center" style="font-size:20px">
	<strong><? if($report_title !=""){ echo $report_title;} else { echo "General Work Order";}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
	</td>
	</tr>
	</table>
	</td>
	</tr>
	</table>
	<?

//echo $job_ids;die;
	$po_data=array();
	if($db_type==0){
	$nameArray_job=sql_select( "select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,DATEDIFF(pub_shipment_date,po_received_date) date_diff,MIN(po_received_date) as po_received_date ,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status  from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no in($job_no_in)  group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
	}
	if($db_type==2){
	$nameArray_job=sql_select( "select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,(pub_shipment_date-po_received_date) date_diff,MIN(po_received_date) as po_received_date,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status   from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and  b.job_id in($job_ids)   group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
	}
	foreach ($nameArray_job as $result_job){
		$po_data['po_id'][$result_job[csf('id')]]=$result_job[csf('id')];
		$po_data['po_number'][$result_job[csf('id')]]=$result_job[csf('po_number')];
		$po_data['leadtime'][$result_job[csf('id')]]=$result_job[csf('date_diff')];
		$po_data['po_quantity'][$result_job[csf('id')]]=$result_job[csf('po_quantity')];
		$po_data['po_received_date'][$result_job[csf('id')]]=change_date_format($result_job[csf('po_received_date')],'dd-mm-yyyy','-');
		$ddd=strtotime($result_job[csf('pub_shipment_date')]);
		$po_data['pub_shipment_date'][$ddd]=$ddd;
		//$po_data['pub_shipment_date'][$result_job[csf('id')]]=change_date_format($result_job[csf('pub_shipment_date')],'dd-mm-yyyy','-');
		$po_data['insert_date'][$result_job[csf('id')]]=$result_job[csf('insert_date')];

		if($result_job[csf('shiping_status')]==1){
		$shiping_status= "FP";
		}
		else if($result_job[csf('shiping_status')]==2){
		$shiping_status= "PS";
		}
		else if($result_job[csf('shiping_status')]==3){
		$shiping_status= "FS";
		}
		$po_data['shiping_status'][$result_job[csf('id')]]=$shiping_status;
		$po_data['file_no'][$result_job[csf('id')]]=$result_job[csf('file_no')];
		$po_data['grouping'][$result_job[csf('id')]]=$result_job[csf('grouping')];
	}
	$txt_order_no_id=implode(",",array_unique($po_data['po_id']));
	$leadtime=implode(",",array_unique($po_data['leadtime']));
	$po_quantity=array_sum($po_data['po_quantity']);
	$po_received_date=implode(",",array_unique($po_data['po_received_date']));
	$po_number=implode(",",array_unique($po_data['po_number']));
	$shipment_date=date('d-m-Y',min($po_data['pub_shipment_date']));
	$maxshipment_date=date('d-m-Y',max($po_data['pub_shipment_date']));
	//$shipment_date=implode(",",array_unique($po_data['pub_shipment_date']));
	$shiping_status=implode(",",array_unique($po_data['shiping_status']));
	$file_no=implode(",",array_unique($po_data['file_no']));
	$grouping=implode(",",array_unique($po_data['grouping']));


	$colar_excess_percent=0;
	$cuff_excess_percent=0;
	$rmg_process_breakdown=0;
	$nameArray=sql_select( "select a.buyer_id, a.booking_no, a.booking_date, a.supplier_id, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.rmg_process_breakdown, a.insert_date, a.update_date, a.uom, a.remarks, a.pay_mode, a.fabric_composition from wo_booking_mst a where a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0");
	foreach ($nameArray as $result)
	{
		$total_set_qnty=$result[csf('total_set_qnty')];
		$colar_excess_percent=$result[csf('colar_excess_percent')];
		$cuff_excess_percent=$result[csf('cuff_excess_percent')];
		$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
		foreach ($po_data['po_id'] as $po_id=>$po_val){
			$daysInHand.=(datediff('d',date('d-m-Y',time()),$po_data['pub_shipment_date'][$po_id])-1).",";
			$booking_date=$result[csf('update_date')];
			if($booking_date=="" || $booking_date=="0000-00-00 00:00:00"){
			$booking_date=$result[csf('insert_date')];
			}
			$WOPreparedAfter.=(datediff('d',$po_data['insert_date'][$po_id],$booking_date)-1).",";
		}
	?>
	<table width="100%" style="border:1px solid black;table-layout: fixed;" >
	<tr>
	<td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
	</tr>
	<tr>
	<td width="200"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
	<td width="220">:&nbsp;<span style="font-size:18px"><b><? $buyer_name_str=""; if($client_id!=0) $buyer_name_str=$buyer_name_arr[$result[csf('buyer_id')]]."-".$buyer_name_arr[$client_id]; else $buyer_name_str=$buyer_name_arr[$result[csf('buyer_id')]]; echo $buyer_name_str; ?></b></span></td>
	<td width="200"><span style="font-size:12px"><b>Dept.</b></span></td>
	<td width="220">:&nbsp;
	<?
	echo $product_depertment ;
	if($product_code !=""){
	echo " (".$product_code.")";
	}
	if($pro_sub_dep != ""){
	echo " (".$pro_sub_dep.")";
	}
	?>
	</td>
	<td width="200"><span style="font-size:12px"><b>Order Qnty</b></span></td>
	<td>:&nbsp; <?  echo $po_quantity;//." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?> </td>
	</tr>
	<tr>

	<td style="font-size:12px"><b>Garments Item</b></td>
	<td>:&nbsp;
	<?
	$gmts_item_name="";
	$gmts_item=explode(',',$gmts_item_id);
	for($g=0;$g<=count($gmts_item); $g++)
	{
	$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
	}
	echo rtrim($gmts_item_name,',');
	?>
	</td>
	<td style="font-size:12px"><b>Booking Release Date</b></td>
	<td>:&nbsp;
	<?
	$booking_date=$result[csf('update_date')];
	if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
	{
	$booking_date=$result[csf('insert_date')];
	}
	echo change_date_format($booking_date,'dd-mm-yyyy','-','');
	?>&nbsp;&nbsp;&nbsp;</td>
	<td style="font-size:18px"><b>Style Ref.</b>   </td>
	<td style="font-size:18px">:&nbsp;<b>
	<?
	echo $style_sting;
	?>
	</b>
	</td>
	</tr>
	<tr>
	<td style="font-size:12px"><b>Style Des.</b></td>
	<td>:&nbsp;<? echo $style_description;?></td>
	<td style="font-size:12px"><b>Season</b></td>
	<td>:&nbsp;<?  if($season_matrix!="") echo $season_matrix; else echo $season_buyer_wise; ?></td>
	<td style="font-size:12px"><b>Dealing Merchandiser</b></td>
	<td>:&nbsp;<? echo $dealing_marchant; ?></td>
	</tr>

	<tr>
	<td style="font-size:12px"><b>Supplier Name</b>   </td>
	<td>:&nbsp;
	<?
	if($result[csf('pay_mode')]==5){
	echo $company_library[$result[csf('supplier_id')]];
	}
	else{
	echo $supplier_name_arr[$result[csf('supplier_id')]];
	}
	?>    </td>
	<td style="font-size:12px"><b>Delivery Date</b></td>
	<td>:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
	<td style="font-size:18px"><b>Booking No </b>   </td>
	<td style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?> <? //echo "(".$unit_of_measurement[$result[csf('uom')]].")"; $uom=$result[csf('uom')];?></td>
	</tr>
	<tr>
		<td   class="table_valign"><p><b>Attention</b></p></td>
		<td  class="table_valign"  ><p>:&nbsp;<? echo $result[csf('attention')]; ?></p></td>
		<td  class="table_valign"><p><b>Lead Time </b>  </p> </td>
		<td  class="table_valign"><p>:&nbsp;
			<?
			echo $leadtime;
			?> </p>
		</td>
		<td  class="table_valign"><p><b>Po Received Date</b></p></td>
		<td class="table_valign"><p>:&nbsp;<? echo $po_received_date; ?></p></td>
	</tr>
	<tr>
		<td class="table_valign"><p><b>Order No</b></p></td>
		<td class="table_valign" width="350" colspan="3"><p>:&nbsp;<? echo $po_number; ?></p></td>
		<td class="table_valign" ><p><b>Repeat No</b></p></td>
		<td  class="table_valign"><p>:&nbsp;<? echo $order_repeat_no; ?></p></td>
	</tr>
	<tr>
	<td style="font-size:12px"><b>Shipment Date</b></td>
<td colspan="3" style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> : First:&nbsp;<? echo rtrim($shipment_date,", "); //echo $max_pub_shipment_date; ?>, Last: <? echo $maxshipment_date; ?></td>
	<td  style="font-size:12px"><b>Quality Label</b></td>
	<td  >:&nbsp;<? echo $qlty_label; ?></td>
	</tr>
	</tr>
	<tr>
	<td style="font-size:12px"><b>WO Prepared After</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
	<?
	$WOPreparedAfter=implode(",",array_unique(explode(",",chop($WOPreparedAfter,","))));
	echo $WOPreparedAfter.' Days' ;
	?></td>

	<td style="font-size:12px"><b>Ship.days in Hand</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
	<?
	$daysInHand=implode(",",array_unique(explode(",",chop($daysInHand,","))));
	echo $daysInHand.' Days' ;
	?></td>

	<td style="font-size:12px"><b>Ex-factory status</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
	<?
	echo $shiping_status;
	?></td>

	</tr>
	<tr>
	<td style="font-size:18px"><b>Internal Ref No</b></td>
	<td style="font-size:18px"> :&nbsp;<b><? echo $grouping; ?></b></td>
	<td style="font-size:18px"><b>File no</b></td>
	<td style="font-size:18px"> :&nbsp;<b><? echo  $file_no;?></b></td>
	<td style="font-size:18px"><b>Currency</b></td>
	<td style="font-size:18px"> :&nbsp;<b><? echo  $currency[$result[csf("currency_id")]];?></b></td>
	</tr>
	<tr>
	<td style="font-size:18px"><b>Rmarks</b></td>
	<td style="font-size:18px" colspan="5"> :<? echo $result[csf('remarks')]?></td>
	</tr>
	<tr>
	<td style="font-size:18px"><b>Fabric Composition</b></td>
	<td style="font-size:18px" colspan="5"> :<? echo $result[csf('fabric_composition')]?></td>
	</tr>

	</table>
	<?
	}

	if($cbo_fabric_source==1 || $cbo_fabric_source==2){
	$nameArray_size=sql_select( "select  size_number_id,min(id) as id,	min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).")   and  job_id in($job_ids) and 	is_deleted=0 and status_active!=0 group by size_number_id order by size_order");
	?>
	<table width="100%" >
	<tr>
	<td width="800">
	<div id="div_size_color_matrix" style="float:left; max-width:1000;">
	<fieldset id="div_size_color_matrix" style="max-width:1000;">
	<legend>Size and Color Breakdown</legend>
	<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
	<tr>
	<td style="border:1px solid black"><strong>Color/Size</strong></td>
	<?
	foreach($nameArray_size  as $result_size)
	{	     ?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?	}    ?>
	<td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
	<td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
	<td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
	</tr>
	<?
	$color_size_order_qnty_array=array();
	$color_size_qnty_array=array();
	$size_tatal=array();
	$size_tatal_order=array();
	for($c=0;$c<count($gmts_item); $c++)
	{
	$item_size_tatal=array();
	$item_size_tatal_order=array();
	$item_grand_total=0;
	$item_grand_total_order=0;
	$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and job_id in($job_ids) and is_deleted=0 and status_active!=0 group by color_number_id  order by color_order");
	?>
	<tr>
	<td style="border:1px solid black" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>

	</tr>
	<?
	foreach($nameArray_color as $result_color)
	{
	?>
	<tr>
	<td align="center" style="border:1px solid black"><? echo $color_library[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
	<?
	$color_total=0;
	$color_total_order=0;

	foreach($nameArray_size  as $result_size)
	{
	$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and job_id in($job_ids) and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active!=0 and is_deleted =0");
	foreach($nameArray_color_size_qnty as $result_color_size_qnty)
	{
	?>
	<td style="border:1px solid black; text-align:right">
	<?
	if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
	{
	echo number_format($result_color_size_qnty[csf('order_quantity')],0);
	$color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
	$color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
	$item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
	$item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
	$grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
	$grand_total_order +=$result_color_size_qnty[csf('order_quantity')];


	$color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
	$color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
	if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
	{
	$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
	$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
	}
	else
	{
	$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
	$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
	}
	if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
	{
	$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
	$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
	}
	else
	{
	$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
	$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
	}
	}
	else echo "0";
	?>
	</td>

	<?
	}
	}
	?>
	<td style="border:1px solid black; text-align:right"><?  echo number_format(round($color_total_order),0); ?></td>

	<td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?>
	</td>
	<td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total),0); ?></td>
	</tr>
	<?
	}
	?>

	<td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
	<?
	foreach($nameArray_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:right"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total_order),0); ?></td>
	<td  style="border:1px solid black;  text-align:right"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
	<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total),0); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td style="border:1px solid black" align="center" colspan="<? echo count($nameArray_size)+3; ?>"><strong>&nbsp;</strong></td>
	</tr>
	<tr>
	<tr>
	<td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
	<?
	foreach($nameArray_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:right"><? echo $size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total_order),0); ?></td>
	<td  style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
	<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total),0); ?></td>
	</tr>
	</table>
	</fieldset>
	</div>
	</td>
	<td width="200" valign="top" align="left">
	<div id="div_size_color_matrix" style="float:left;">
	<?
	$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
	?>
	<fieldset>
	<legend>RMG Process Loss % </legend>
	<table width="180" class="rpt_table" border="1" rules="all">
	<?
	if(number_format($rmg_process_breakdown_arr[8],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Cut Panel rejection <!-- Extra Cutting % breack Down 8-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[8],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[2],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Chest Printing <!-- Printing % breack Down 2-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[2],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[10],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Neck/Sleeve Printing <!-- New breack Down 10-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[10],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[1],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Embroidery   <!-- Embroidery  % breack Down 1-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[1],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[4],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Sewing /Input<!-- Sewing % breack Down 4-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[4],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[3],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Garments Wash <!-- Washing %breack Down 3-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[3],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[15],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Gmts Finishing <!-- Washing %breack Down 3-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[15],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[11],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Others <!-- New breack Down 11-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[11],2);
	?>
	</td>
	</tr>
	<?
	}
	$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
	if($gmts_pro_sub_tot>0)
	{
	?>
	<tr>
	<td width="130">
	Sub Total <!-- New breack Down 11-->
	</td>
	<td align="right">
	<?

	echo number_format($gmts_pro_sub_tot,2);
	?>
	</td>
	</tr>
	<?
	}
	?>
	</table>
	</fieldset>


	<fieldset>
	<legend>Fabric Process Loss % </legend>
	<table width="180" class="rpt_table" border="1" rules="all">
	<?
	if(number_format($rmg_process_breakdown_arr[6],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Knitting  <!--  Knitting % breack Down 6-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[6],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[12],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Yarn Dyeing  <!--  New breack Down 12-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[12],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[5],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Dyeing & Finishing  <!-- Finishing % breack Down 5-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[5],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[13],2)>0)
	{
	?>
	<tr>
	<td width="130">
	All Over Print <!-- new  breack Down 13-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[13],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[14],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Lay Wash (Fabric) <!-- new  breack Down 14-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[14],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[7],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Dying   <!-- breack Down 7-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[7],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[0],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Cutting (Fabric) <!-- Cutting % breack Down 0-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[0],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[9],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Others  <!-- Others% breack Down 9-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[9],2);
	?>
	</td>
	</tr>
	<?
	}
	$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
	if(fab_proce_sub_tot>0)
	{
	?>
	<tr>
	<td width="130">
	Sub Total  <!-- Others% breack Down 9-->
	</td>
	<td align="right">
	<?

	echo number_format($fab_proce_sub_tot,2);
	?>
	</td>
	</tr>
	<?
	}
	if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
	{
	?>
	<tr>
	<td width="130">
	Grand Total  <!-- Others% breack Down 9-->
	</td>
	<td align="right">
	<?
	echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2);
	?>
	</td>
	</tr>
	<?
	}
	?>
	</table>
	</fieldset>
	</div>
	</td>
	<td width="330" valign="top" align="left">
	<?
	$nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id in($job_no_in) and file_type=1");
	?>
	<div id="div_size_color_matrix" style="float:left;">
	<fieldset>
	<legend>Image</legend>
	<table width="310">
	<tr>
	<?
	$img_counter = 0;
	foreach($nameArray_imge as $result_imge)
	{
	if($path=="")
	{
	$path='../../';
	}
	?>
	<td>
	<img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />
	</td>
	<?

	$img_counter++;
	}
	?>
	</tr>
	</table>
	</fieldset>
	</div>
	</td>
	</tr>
	</table>
	<?
	}// if($cbo_fabric_source==1) end

	?>
	<br/>
	<!--  Here will be the main portion  -->
	<?
	$costing_per="";
	$costing_per_qnty=0;
	$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no in($job_no_in)");
	if($costing_per_id==1)
	{
	$costing_per="1 Dzn";
	$costing_per_qnty=12;

	}
	if($costing_per_id==2)
	{
	$costing_per="1 Pcs";
	$costing_per_qnty=1;

	}
	if($costing_per_id==3)
	{
	$costing_per="2 Dzn";
	$costing_per_qnty=24;

	}
	if($costing_per_id==4)
	{
	$costing_per="3 Dzn";
	$costing_per_qnty=36;

	}
	if($costing_per_id==5)
	{
	$costing_per="4 Dzn";
	$costing_per_qnty=48;
	}
	$uom_arr=array();
	$sql_fab=sql_select("select job_no,uom,process_loss_method from wo_pre_cost_fabric_cost_dtls where job_no in($job_no_in)");
	foreach($sql_fab as $row)
	{
		$uom_arr[$row[csf('uom')]]=$row[csf('uom')];
		$process_loss_method=$row[csf('process_loss_method')];
	}
	
	//$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no in($job_no_in)");

	//$uom_arr=array(1=>"Pcs",12=>"Kg",23=>"Mtr",27=>"Yds");
	if($cbo_fabric_source==1)
	{
			$gmt_color_library=array();
				$gmt_color_data=sql_select("select a.uom,b.gmts_color_id, b.contrast_color_id
				FROM
				wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
				WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu    and a.fabric_source =$cbo_fabric_source and
				 a.job_id in($job_ids)");
				
				if(count($gmt_color_data)>0)
				{
				foreach( $gmt_color_data as $gmt_color_row){
				$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
				}
				}
				unset($gmt_color_data);
			$color_wise_wo_sql=sql_select("select b.fabric_color_id
				FROM
				wo_pre_cost_fabric_cost_dtls a,
				wo_booking_dtls b
				WHERE
				a.id=b.pre_cost_fabric_cost_dtls_id and
				 
				b.booking_no =$txt_booking_no and
				 a.job_id in($job_ids) and 
				b.status_active=1 and b.fin_fab_qnty>0 and
				b.is_deleted=0
				group by b.fabric_color_id");
				
				foreach($color_wise_wo_sql as $row)
				{
					$color_wise_wo_arr[$row[csf('fabric_color_id')]]=$row[csf('fabric_color_id')];
				}
				unset($color_wise_wo_sql);
				
				$sql_labdip=sql_select("select lapdip_no,job_no_mst,color_name_id as color from wo_po_lapdip_approval_info where job_no_mst in($job_no_in) and approval_status=3 ");
				foreach($sql_labdip as $row)
				{
					$labdip_arr[$row[csf('job_no_mst')]][$row[csf('color')]]=$row[csf('lapdip_no')];
				}
				unset($sql_labdip);
				
				$color_wise_wo_sql_qnty=sql_select("select a.id, a.uom,a.item_number_id as item_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,d.pre_cost_remarks,d.fabric_color_id,d.dia_width, sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
				WHERE
				a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id and
			    a.color_type_id=d.color_type  and
				d.gsm_weight=a.gsm_weight and
				d.booking_no =$txt_booking_no and
				a.job_id in($job_ids) and
				d.status_active=1 and d.fin_fab_qnty>0 and
				d.is_deleted=0 group by a.uom,a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,d.pre_cost_remarks,d.fabric_color_id,d.dia_width");
				
				foreach($color_wise_wo_sql_qnty as $row)
				{
				$color_wise_wo_sql_qnty_arr[$row[csf('id')]][$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('fabric_color_id')]][$row[csf('dia_width')]]['fin_fab_qnty']=$row[csf('fin_fab_qnty')];
				
				$color_wise_wo_sql_qnty_arr[$row[csf('id')]][$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('fabric_color_id')]][$row[csf('dia_width')]]['grey_fab_qnty']=$row[csf('grey_fab_qnty')];
				
				$color_wise_wo_sql_qnty_arr[$row[csf('id')]][$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('fabric_color_id')]][$row[csf('dia_width')]]['rate']=$row[csf('rate')];
				
				$color_wise_wo_sql_qnty_arr[$row[csf('id')]][$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('fabric_color_id')]][$row[csf('dia_width')]]['amount']=$row[csf('amount')];
				//without Color
				$without_color_wise_wo_sql_qnty_arr[$row[csf('id')]][$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('dia_width')]]['fin_fab_qnty']+=$row[csf('fin_fab_qnty')];
				
				}
				unset($color_wise_wo_sql_qnty);
	}
				
	foreach($uom_arr as $uom_id=>$uom_val)
	{
		if($cbo_fabric_source==1)
		{
			$nameArray_fabric_description= sql_select("select a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , b.dia_width,d.pre_cost_remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
			WHERE a.job_no=b.job_no and
			a.id=b.pre_cost_fabric_cost_dtls_id and
			c.job_no_mst=a.job_no and
			c.id=b.color_size_table_id and
			b.po_break_down_id=d.po_break_down_id and
			b.color_number_id=d.gmts_color_id and
			b.dia_width=d.dia_width and
			b.gmts_sizes=c.size_number_id and
			b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
			d.booking_no =$txt_booking_no and
			a.job_id in($job_ids) and
			a.uom=$uom_id and
			d.status_active=1 and
			d.is_deleted=0 and
			b.cons>0
			group by a.id,a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,b.dia_width,d.pre_cost_remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
			
			if(count($nameArray_fabric_description)>0)
			{
				?>

				<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
				<caption>Fabric Details in <? echo $unit_of_measurement[$uom_val]; ?></caption>
				<tr align="center">
				<th colspan="3" align="left">Item Name</th>
				<?

				foreach($nameArray_fabric_description  as $result_fabric_description)
				{
				if( $result_fabric_description[csf('body_part_id')] == "")
				echo "<td colspan='3'>&nbsp</td>";
				else
				echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
				}
				?>
				<td  rowspan="11" width="50"><p>Total Finish Fabric (Kg)</p></td>

				<td  rowspan="11" width="50"><p>Avg Rate <? echo "(".$unit_of_measurement[$uom].")";?></p></td>
				<td  rowspan="11" width="50"><p>Amount </p></td>

				</tr>
				<tr align="center">
				<th colspan="3" align="left">Body Part</th>
				<?

				foreach($nameArray_fabric_description  as $result_fabric_description)
				{
				if( $result_fabric_description[csf('body_part_id')] == "")
				echo "<td colspan='3'>&nbsp</td>";
				else
				echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
				}
				?>
				</tr>
				<tr align="center"><th colspan="3" align="left">Color Type</th>
				<?
				foreach($nameArray_fabric_description  as $result_fabric_description)
				{
				if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
				else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
				}
				?>
				</tr>
				<tr align="center"><th colspan="3" align="left">Fabric Construction</th>
				<?
				foreach($nameArray_fabric_description  as $result_fabric_description)
				{
				if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
				else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
				}
				?>


				</tr>
				<tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
				<?
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
				else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
				}
				?>

				</tr>
				<tr align="center"><th  colspan="3" align="left">GSM</th>
				<?
				foreach($nameArray_fabric_description  as $result_fabric_description)
				{
				if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
				else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
				}
				?>

				</tr>
				<tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
				<?
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
				else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
				}
				?>

				</tr>
				<tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
				<?
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
				else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
				}
				?>
				</tr>
			    <tr align="center"><th   colspan="3" align="left">Remarks</th>
			        <?
					foreach($nameArray_fabric_description as $result_fabric_description)
					{
						if( $result_fabric_description[csf('pre_cost_remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('pre_cost_remarks')]."</td>";
					}
					?>

			       </tr>
				<tr>
				<th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
				</tr>
				<tr>
				<th  width="120" align="left">Fabric Color</th>
				<th  width="120" align="left">Body Color</th>
				<th  width="120" align="left">Lab Dip No</th>
				<?
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
				}
				?>
				</tr>
				<?
				/*$gmt_color_library=array();
				$gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
				FROM
				wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
				WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=$uom_id  and a.fabric_source =$cbo_fabric_source and
				a.job_no in ($job_no_in)");
				foreach( $gmt_color_data as $gmt_color_row){
				$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
				}
				$grand_total_fin_fab_qnty=0;
				$grand_total_amount=0;
				$color_wise_wo_sql=sql_select("select b.fabric_color_id
				FROM
				wo_pre_cost_fabric_cost_dtls a,
				wo_booking_dtls b
				WHERE
				a.id=b.pre_cost_fabric_cost_dtls_id and
				a.uom=$uom_id and
				b.booking_no =$txt_booking_no and
				b.job_no='".$row_per_job[csf('job_no')]."' and
				b.status_active=1 and
				b.is_deleted=0
				group by b.fabric_color_id");*/
				//if(count($color_wise_wo_arr)>0)
				foreach($color_wise_wo_arr as $color=>$color_wise_wo_result)
				{
				?>
				<tr>
				<td  width="120" align="left">
				<?
				echo $color_library[$color];
				?>
				</td>
				<td>
				<?
				echo implode(",",$gmt_color_library[$color]);
				?>
				</td>
				<td  width="120" align="left">
				<?
				$lapdip_no="";
				//$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
				$lapdip_no=$labdip_arr[$job_no][$color];
				if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
				?>
				</td>
				<?
				$total_fin_fab_qnty=0;
				$total_amount=0;

				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				/*if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
				WHERE
				a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				d.job_no='".$row_per_job[csf('job_no')]."' and
				a.uom=$uom_id and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
				d.fabric_color_id='".$color_wise_wo_result[csf('fabric_color_id')]."' and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				if($db_type==2)
				{
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
				WHERE
				a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				d.job_no='".$row_per_job[csf('job_no')]."' and
				a.uom=$uom_id and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
				d.status_active=1 and
				d.is_deleted=0
				");
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty*/
				$fabric_cost_dtls_id=$result_fabric_description[csf('fabric_cost_dtls_id')];
				$fin_fab_qnty=$color_wise_wo_sql_qnty_arr[$fabric_cost_dtls_id][$uom_id][$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('pre_cost_remarks')]][$color][$result_fabric_description[csf('dia_width')]]['fin_fab_qnty'];
			$grey_fab_qnty=$color_wise_wo_sql_qnty_arr[$fabric_cost_dtls_id][$uom_id][$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('pre_cost_remarks')]][$color][$result_fabric_description[csf('dia_width')]]['grey_fab_qnty'];
			$rate=$color_wise_wo_sql_qnty_arr[$fabric_cost_dtls_id][$uom_id][$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('pre_cost_remarks')]][$color][$result_fabric_description[csf('dia_width')]]['rate'];
			
			$amount=$color_wise_wo_sql_qnty_arr[$fabric_cost_dtls_id][$uom_id][$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('pre_cost_remarks')]][$color][$result_fabric_description[csf('dia_width')]]['amount'];
			
				?>
				<td width='50' align='right'>
				<?
				if($fin_fab_qnty!="")
				{
				echo def_number_format($fin_fab_qnty,2) ;
				$total_fin_fab_qnty+=$fin_fab_qnty;
				}
				?>
				</td>
				<td width='50' align='right' >
				<?
				if($rate!="")
				{
				echo def_number_format($rate,5);
				}
				?>
				</td>
				<td width='50' align='right' >
				<?
				$amount=def_number_format($amount,2,'',0);
				if($amount!="")
				{
				echo $amount;
				$total_amount+=$amount;
				}
				?>
				</td>
				<?
				}
				?>
				<td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
				<td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
				<td align="right">
				<?
				echo def_number_format($total_amount,2);

				?>
				</td>
				</tr>
				<?
				}
				?>
				<tr style=" font-weight:bold">
				<th  width="120" align="left">&nbsp;</th>
				<td  width="120" align="left">&nbsp;</td>
				<td  width="120" align="left"><strong>Total</strong></td>
				<?
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
				WHERE
				a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				d.job_no='".$row_per_job[csf('job_no')]."' and
				a.uom=$uom_id and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
				d.status_active=1 and
				d.is_deleted=0
				");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty*/
				$fabric_cost_dtls_id=$result_fabric_description[csf('fabric_cost_dtls_id')];
				$fin_fab_qnty=$without_color_wise_wo_sql_qnty_arr[$fabric_cost_dtls_id][$uom_id][$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('pre_cost_remarks')]][$result_fabric_description[csf('dia_width')]]['fin_fab_qnty'];
				?>
				<td width='50' align='right'><?  echo def_number_format($fin_fab_qnty,2) ;?></td>
				<td width='50' align='right'></td>
				<td width='50' align='right'></td>
				<?
				}
				?>
				<td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
				<td align="right"><? echo def_number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
				<td align="right">
				<?
				echo def_number_format($grand_total_amount,2);
				?>
				</td>
				</tr>
				<!--<tr style="font-weight:bold">
				<th  width="120" align="left">&nbsp;</th>
				<td  width="120" align="left">&nbsp;</td>
				<td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
				<?
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
				WHERE
				a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.uom=$uom_id and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.status_active=1 and
				d.is_deleted=0
				");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty*/
				?>
				<td width='50' align='right'></td>
				<td width='50' align='right'></td>
				<td width='50' align='right'></td>
				<?
				}
				?>
				<td align="right">
				<?
				//$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
				//echo number_format($consumption_per_unit_fab,2);
				?>
				</td>
				<td align="right">
				<?
				//$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
				//echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
				?>
				</td>
				<td align="right" title="Only Allow Round Figer">
				<?
				//echo number_format($consumption_per_unit_amuont,2);
				?>
				</td>
				</tr> -->
				</table>
				<br/>
				<?
			}
		}
	}
	//===========================
				$gmt_color_library=array();
				$gmt_color_data=sql_select("select a.uom,b.gmts_color_id, b.contrast_color_id
				FROM
				wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
				WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu    and a.fabric_source =$cbo_fabric_source and
				 a.job_id in($job_ids)");
				
				if(count($gmt_color_data)>0)
				{
				foreach( $gmt_color_data as $gmt_color_row){
				$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
				}
				}
				unset($gmt_color_data);
			$color_wise_wo_sql=sql_select("select b.fabric_color_id
				FROM
				wo_pre_cost_fabric_cost_dtls a,
				wo_booking_dtls b
				WHERE
				a.id=b.pre_cost_fabric_cost_dtls_id and
				 
				b.booking_no =$txt_booking_no and
				 a.job_id in($job_ids) and 
				b.status_active=1 and b.fin_fab_qnty>0 and
				b.is_deleted=0
				group by b.fabric_color_id");
				
				foreach($color_wise_wo_sql as $row)
				{
					$color_wise_wo_arr[$row[csf('fabric_color_id')]]=$row[csf('fabric_color_id')];
				}
				unset($color_wise_wo_sql);
				
				$sql_labdip=sql_select("select lapdip_no,job_no_mst,color_name_id as color from wo_po_lapdip_approval_info where job_no_mst in($job_no_in) and approval_status=3 ");
				foreach($sql_labdip as $row)
				{
					$labdip_arr[$row[csf('job_no_mst')]][$row[csf('color')]]=$row[csf('lapdip_no')];
				}
				unset($sql_labdip);
				
				$color_wise_wo_sql_qnty=sql_select("select a.id,a.uom,a.item_number_id as item_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,d.pre_cost_remarks,d.fabric_color_id,d.dia_width, sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
				WHERE
				a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id and
			    a.color_type_id=d.color_type  and
				d.gsm_weight=a.gsm_weight and
				d.booking_no =$txt_booking_no and
				a.job_id in($job_ids) and
				d.status_active=1 and d.fin_fab_qnty>0 and
				d.is_deleted=0 group by  a.id,a.uom,a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,d.pre_cost_remarks,d.fabric_color_id,d.dia_width");
				
				foreach($color_wise_wo_sql_qnty as $row)
				{
				$color_wise_wo_sql_qnty_arr[$row[csf('id')]][$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('fabric_color_id')]][$row[csf('dia_width')]]['fin_fab_qnty']=$row[csf('fin_fab_qnty')];
				
				$color_wise_wo_sql_qnty_arr[$row[csf('id')]][$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('fabric_color_id')]][$row[csf('dia_width')]]['grey_fab_qnty']=$row[csf('grey_fab_qnty')];
				
				$color_wise_wo_sql_qnty_arr[$row[csf('id')]][$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('fabric_color_id')]][$row[csf('dia_width')]]['rate']=$row[csf('rate')];
				
				$color_wise_wo_sql_qnty_arr[$row[csf('id')]][$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('fabric_color_id')]][$row[csf('dia_width')]]['amount']=$row[csf('amount')];
				//without Color
				$without_color_wise_wo_sql_qnty_arr[$row[csf('id')]][$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('dia_width')]]['fin_fab_qnty']+=$row[csf('fin_fab_qnty')];
				
				}
				unset($color_wise_wo_sql_qnty);
				
				
	foreach($uom_arr as $uom_id=>$uom_val)
	{
		if($cbo_fabric_source==2)
		{
			$nameArray_fabric_description= sql_select("select a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , b.dia_width,d.pre_cost_remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
			WHERE a.job_id=b.job_id and
			a.id=b.pre_cost_fabric_cost_dtls_id and
			c.job_id=a.job_id and
		  a.color_type_id=d.color_type  and
			d.gsm_weight=a.gsm_weight and
			c.id=b.color_size_table_id and
			b.po_break_down_id=d.po_break_down_id and
			b.color_number_id=d.gmts_color_id and
			c.color_number_id=d.gmts_color_id and
			b.gmts_sizes=c.size_number_id and
			b.dia_width=d.dia_width and
			d.fabric_color_id>0 and
			b.remarks=d.pre_cost_remarks and
			
			b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
			d.booking_no =$txt_booking_no and
			a.job_id in($job_ids) and 
			a.uom=$uom_id and 
			d.status_active=1 and
			d.is_deleted=0  and
			d.fin_fab_qnty>0 and
			b.cons>0
			group by a.id,a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,b.dia_width,d.pre_cost_remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
			
			
			//echo "=".count($nameArray_fabric_description);die;
			
			//echo "ABA";die;
			if(count($nameArray_fabric_description)>0)
			{
				?>
				<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
				<caption>Fabric Details in <? echo $unit_of_measurement[$uom_val];?></caption>
				<tr align="center">
				<th colspan="3" align="left">Item Name</th>
				<?
				foreach($nameArray_fabric_description  as $result_fabric_description)
				{
				if( $result_fabric_description[csf('body_part_id')] == "")
				echo "<td colspan='3'>&nbsp</td>";
				else
				echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
				}
				?>
				<td  rowspan="11" width="50"><p>Total Finish Fabric</p></td>

				<td  rowspan="11" width="50"><p>Avg Rate</p></td>
				<td  rowspan="11" width="50"><p>Amount </p></td>
				</tr>
				<tr align="center">
				<th colspan="3" align="left">Body Part</th>
				<?
				foreach($nameArray_fabric_description  as $result_fabric_description)
				{
				if( $result_fabric_description[csf('body_part_id')] == "")
				echo "<td colspan='3'>&nbsp</td>";
				else
				echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
				}
				?>
				</tr>
				<tr align="center"><th colspan="3" align="left">Color Type</th>
				<?
				foreach($nameArray_fabric_description  as $result_fabric_description)
				{
				if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
				else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
				}
				?>
				</tr>
				<tr align="center"><th colspan="3" align="left">Fabric Construction</th>
				<?
				foreach($nameArray_fabric_description  as $result_fabric_description)

				{
				if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
				else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
				}
				?>
				</tr>
				<tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
				<?
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
				else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
				}
				?>
				</tr>
				<tr align="center"><th  colspan="3" align="left">GSM</th>
				<?
				foreach($nameArray_fabric_description  as $result_fabric_description)
				{
				if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
				else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
				}
				?>
				</tr>
				<tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
				<?
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
				else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
				}
				?>

				</tr>
				<tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
				<?
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
				else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
				}
				?>

				</tr>
			    <tr align="center"><th   colspan="3" align="left">Remarks</th>
			        <?
					foreach($nameArray_fabric_description as $result_fabric_description)
					{
						if( $result_fabric_description[csf('pre_cost_remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('pre_cost_remarks')]."</td>";
					}
					?>

			       </tr>
				<tr>
				<th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
				</tr>
				<tr>
				<th  width="120" align="left">Fabric Color</th>
				<th  width="120" align="left">Body Color</th>
				<th  width="120" align="left">Lab Dip No</th>
				<?
				if($cbo_fabric_source==2)
				{
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
				}
				}
				else
				{
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				echo "<th width='50'>Fab. Qty</th>";
				}
				}

				?>
				</tr>
				<?
				/*$gmt_color_library=array();

				$gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
				FROM
				wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
				WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=$uom_id  and a.fabric_source =$cbo_fabric_source and
				a.job_no in ($job_no_in)");
				if(count($gmt_color_data)>0)
				{
				foreach( $gmt_color_data as $gmt_color_row){
				$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
				}
				}*/
				$grand_total_fin_fab_qnty=0;
				$grand_total_amount=0;
				/*$color_wise_wo_sql=sql_select("select b.fabric_color_id
				FROM
				wo_pre_cost_fabric_cost_dtls a,
				wo_booking_dtls b
				WHERE
				a.id=b.pre_cost_fabric_cost_dtls_id and
				a.uom=$uom_id and
				b.booking_no =$txt_booking_no and
				b.job_no in ($job_no_in) and
				b.status_active=1 and b.fin_fab_qnty>0 and
				b.is_deleted=0
				group by b.fabric_color_id");*/
				//$color_wise_wo_arr[$row[csf('fabric_color_id')]];
				//if(count($color_wise_wo_sql)>0)
				if(count($color_wise_wo_arr)>0)
				{
				foreach($color_wise_wo_arr as $color=>$color_wise_wo_result)
				{
				?>
				<tr>
				<td  width="120" align="left">
				<?
				echo $color_library[$color];
				?>
				</td>
				<td>
				<?
				echo implode(",",$gmt_color_library[$color]);
				?>
				</td>
				<td  width="120" align="left">
				<?
				$lapdip_no="";
				//$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
				$lapdip_no=$labdip_arr[$job_no][$color];
				if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
				?>
				</td>
				<?
				$total_fin_fab_qnty=0;
				$total_amount=0;
				if(count($nameArray_fabric_description)>0)
				{
					foreach($nameArray_fabric_description as $result_fabric_description)
					{
				if($db_type==0)
				{
				/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
				WHERE
				a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				 
				d.job_no in ($job_no_in) and
				a.uom=$uom_id and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
				d.fabric_color_id='".$color."' and
				d.status_active=1 and
				d.is_deleted=0
				");*/
				}
				if($db_type==2)
				{
					
				/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
				WHERE
				a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id and
			    a.color_type_id=d.color_type  and
				d.gsm_weight=a.gsm_weight and
				d.booking_no =$txt_booking_no and
				d.job_no in ($job_no_in) and
				a.uom=$uom_id and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
				nvl(d.fabric_color_id,0)=nvl('".$color."',0) and
				d.status_active=1 and d.fin_fab_qnty>0 and
				d.is_deleted=0
				");*/
			//	$color_wise_wo_sql_qnty_arr[$row[csf('uom')]][$row[csf('item_id')]][$row[csf('body_part_id')]][$row[csf('color_type_id')]][$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('pre_cost_remarks')]][$row[csf('fabric_color_id')]][$row[csf('dia_width')]]['fin_fab_qnty']=$row[csf('fin_fab_qnty')];
				
			
				}
				$fabric_cost_dtls_id=$result_fabric_description[csf('item_number_id')];
				$fin_fab_qnty=$color_wise_wo_sql_qnty_arr[$fabric_cost_dtls_id][$uom_id][$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('pre_cost_remarks')]][$color][$result_fabric_description[csf('dia_width')]]['fin_fab_qnty'];
			$grey_fab_qnty=$color_wise_wo_sql_qnty_arr[$fabric_cost_dtls_id][$uom_id][$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('pre_cost_remarks')]][$color][$result_fabric_description[csf('dia_width')]]['grey_fab_qnty'];
			$rate=$color_wise_wo_sql_qnty_arr[$fabric_cost_dtls_id][$uom_id][$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('pre_cost_remarks')]][$color][$result_fabric_description[csf('dia_width')]]['rate'];
			
			$amount=$color_wise_wo_sql_qnty_arr[$fabric_cost_dtls_id][$uom_id][$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('pre_cost_remarks')]][$color][$result_fabric_description[csf('dia_width')]]['amount'];
			
				//echo count($color_wise_wo_sql_qnty)."=D";die;
				//if(count($color_wise_wo_sql_qnty)>0)
				//list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
				?>
				<td width='50' align='right'>
				<?
				if($fin_fab_qnty!="")
				{
				echo def_number_format($fin_fab_qnty,2) ;
				$total_fin_fab_qnty+=$fin_fab_qnty;
				}
				?>
				</td>
				<td width='50' align='right' >
				<?
				if($rate!="")
				{
				echo def_number_format($rate,5);
				}
				?>
				</td>
				<td width='50' align='right' >
				<?
				$amount=def_number_format($amount,2,'',0);
				if($amount!="")
				{
				echo $amount;
				$total_amount+=$amount;
				}
				?>
				</td>
				<?
				}
				}
				?>
				<td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
				<td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
				<td align="right">
				<?
				echo def_number_format($total_amount,2);

				?>
				</td>
				</tr>
				<?
				}
				}
				?>
				<tr style=" font-weight:bold">
				<th  width="120" align="left">&nbsp;</th>
				<td  width="120" align="left">&nbsp;</td>
				<td  width="120" align="left"><strong>Total</strong></td>
				<?
				if(count($nameArray_fabric_description)>0)
				{
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
				WHERE
				a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id and
			    a.color_type_id=d.color_type  and
				d.gsm_weight=a.gsm_weight and
				d.booking_no =$txt_booking_no and
				d.job_no in ($job_no_in) and
				a.uom=$uom_id and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
				d.status_active=1 and d.fin_fab_qnty>0 and
				d.is_deleted=0
				");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty*/ 
				$fabric_cost_dtls_id=$result_fabric_description[csf('fabric_cost_dtls_id')];
					$fin_fab_qnty=$without_color_wise_wo_sql_qnty_arr[$fabric_cost_dtls_id][$uom_id][$result_fabric_description[csf('item_number_id')]][$result_fabric_description[csf('body_part_id')]][$result_fabric_description[csf('color_type_id')]][$result_fabric_description[csf('construction')]][$result_fabric_description[csf('composition')]][$result_fabric_description[csf('gsm_weight')]][$result_fabric_description[csf('pre_cost_remarks')]][$result_fabric_description[csf('dia_width')]]['fin_fab_qnty'];
				?>
				<td width='50' align='right'><?  echo def_number_format($fin_fab_qnty,2) ;?></td>
				<td width='50' align='right' ></td>
				<td width='50' align='right' ></td>
				<?
				}
				}
				?>
				<td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
				<td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
				<td align="right">
				<?
				echo def_number_format($grand_total_amount,2);
				?>
				</td>
				</tr>
				<!--<tr style="font-weight:bold">
				<th  width="120" align="left">&nbsp;</th>
				<td  width="120" align="left">&nbsp;</td>
				<td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
				<?
				if(count($nameArray_fabric_description)>0)
				{
				foreach($nameArray_fabric_description as $result_fabric_description)
				{
				/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
				WHERE
				a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.uom=$uom_id and
				a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.status_active=1 and
				d.is_deleted=0
				");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty*/

				?>
				<td width='50' align='right'></td>
				<td width='50' align='right'></td>
				<td width='50' align='right'></td>
				<?
				}
				}
				?>
				<td align="right">
				<?
				//$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
				//echo number_format($consumption_per_unit_fab,2);
				?>
				</td>
				<td align="right">
				<?
				//$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
				//echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
				?>
				</td>
				<td align="right" title="Only Allow Round Figer">
				<?
				//echo number_format($consumption_per_unit_amuont,2);
				?>
				</td>
				</tr> -->
				</table>
				<br/>
				<?
			}
		}
	}
	//===========================
	?>
    <?
	//echo "AA";die;
	$sql_data=sql_select("select a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,a.uom,b.dia_width,b.pre_cost_remarks,b.fabric_color_id,b.remark, sum(b.grey_fab_qnty) as grey_fab_qnty,sum(b.adjust_qty)as adjust_qty,sum(b.fin_fab_qnty) as fin_fab_qnty,avg(b.rate) as rate,sum(b.grey_fab_qnty*b.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and a.color_type_id=d.color_type and d.gsm_weight=a.gsm_weight and b.grey_fab_qnty>0  and b.booking_no =$txt_booking_no and  b.job_no in($job_no_in) and  and b.adjust_qty>0 and b.status_active=1 and b.is_deleted=0 group by a.id,a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,a.uom,b.dia_width,b.pre_cost_remarks,b.fabric_color_id,b.remark order by a.id,a.body_part_id");

		?>
		<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

        <tr>
        <td colspan="7">
        <strong>Fabric Stock Adjustment Details</strong>
        </td>

        </tr>

        <tr>
        <td>
        Fabrication
        </td>
        <td>
        Process
        </td>
        <td>
        Fabric Color
        </td>
        <td>
        Required
        </td>
        <td>
        Stock Used
        </td>
        <td>
        Booking Qty
        </td><td>
        Uom
        </td>
         <td>
        Remarks
        </td>
        </tr>
        <?
		foreach($sql_data as $row){
		?>
          <tr>
        <td>
        <? echo $body_part[$row[csf('body_part_id')]].",".$color_type[$row[csf('color_type_id')]].",".$row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$fabric_typee[$row[csf('width_dia_type')]].",".$row[csf('dia_width')]  ?>
        </td>
        <td>
        <? echo $row[csf('pre_cost_remarks')];  ?>
        </td>
        <td>
        <? echo $color_library[$row[csf('fabric_color_id')]];  ?>
        </td>
        <td align="right">
        <? echo number_format($row[csf('grey_fab_qnty')],4);  ?>
        </td>
        <td align="right">
         <? echo number_format($row[csf('adjust_qty')],4) ; ?>
        </td>
        <td align="right">
       <? echo number_format($row[csf('fin_fab_qnty')],4);  ?>
        </td>
         <td>
        <? echo $unit_of_measurement[$row[csf('uom')]];  ?>
        </td>
         <td>
         <? echo $row[csf('remark')];  ?>
        </td>
        </tr>
        <?
		}
		?>
        </table>


	<?
//echo	"G".die;
	if($cbo_fabric_source==1 || $cbo_fabric_source==2){
	?>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
	<tr>
	<?
	$nameArray_item_size=sql_select( "select min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_id=b.job_id and a.job_id=c.job_id and a.id=b.pre_cost_fabric_cost_dtls_id and c.id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active =1 and d.is_deleted=0  and  d.job_no in($job_no_in)  and a.body_part_id=2     and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
	if(count($nameArray_item_size)>0)
	{
	?>
	<td width="49%">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr>
	<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Collar -  Colour Size Brakedown in Pcs</b></td>
	</tr>
	<tr>
	<td width="70">Size</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?
	}
	?>
	<td rowspan="2" align="center"><strong>Total</strong></td>
	<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
	</tr>
	<tr>
	<td>Collar Size</td>

	<?
	foreach($nameArray_item_size  as $result_item_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
	<?
	}
	?>
	<?
	$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active =1 and d.is_deleted=0 and  d.job_no in($job_no_in)   and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and c.color_number_id=d.gmts_color_id and d.status_active=1 and d.is_deleted=0 group by c.color_number_id,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
	");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	$color_total_collar=0;
	$color_total_collar_order_qnty=0;
	$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
	$constrast_color_arr=array();
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
	for($i=0;$i<count($constrast_color);$i++)
	{
	$constrast_color2=explode('_',$constrast_color[$i]);
	$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
	}
	}
	?>
	<tr>
	<td>
	<?
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
	$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
	}
	else
	{
	echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
	$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
	}
	?>
	</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black">
	<?
	$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."  and  job_no_mst in($job_no_in)  and  status_active=1 and is_deleted =0");
	list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
	$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
	$colar_excess_per=($plan_cut*$colar_excess_percent)/100;
	echo number_format($plan_cut+$colar_excess_per,0);
	$color_total_collar+=$plan_cut+$colar_excess_per;
	$color_total_collar_order_qnty+=$plan_cut;
	$grand_total_collar+=$plan_cut+$colar_excess_per;
	$grand_total_collar_order_qnty+=$plan_cut;
	?>
	</td>
	<?
	}
	?>
	<td align="center"><? echo number_format($color_total_collar,0); ?></td>
	<td align="center"><? echo number_format((($color_total_collar-$color_total_collar_order_qnty)/$color_total_collar_order_qnty)*100,2); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td>Size Total</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:center"><? $colar_excess_pers=($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]+$colar_excess_pers,0); ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar,0); ?></td>
	<td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_collar-$grand_total_collar_order_qnty)/$grand_total_collar_order_qnty)*100,2); ?></td>
	</tr>
	</table>
	</td>
	<td width="2%">
	</td>
	<?
	}
	?>
	<?
	$nameArray_item_size=sql_select( "select min(c.id) as id, b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and  d.job_no in($job_no_in) and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");

	if(count($nameArray_item_size)>0)
	{
	?>
	<td width="49%">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr>
	<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Cuff -  Colour Size Brakedown in Pcs</b></td>
	</tr>
	<tr>
	<td width="70">Size</td>

	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?
	}
	?>
	<td rowspan="2" align="center"><strong>Total</strong></td>
	<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
	</tr>
	<tr>
	<td>Cuff Size</td>

	<?
	foreach($nameArray_item_size  as $result_item_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
	<?
	}
	?>
	<?
	$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and  d.job_no in($job_no_in) and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and  d.status_active=1 and d.is_deleted=0 group by c.color_number_id ,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
	");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	$color_total_cuff=0;
	$color_total_cuff_order_qnty=0;
	$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
	$constrast_color_arr=array();
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
	for($i=0;$i<count($constrast_color);$i++)
	{
	$constrast_color2=explode('_',$constrast_color[$i]);
	$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
	}
	}
	?>
	<tr>
	<td>
	<?
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]);
	$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
	}
	else
	{
	echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
	$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
	}
	?>
	</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black">
	<?
	$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  job_no_mst in($job_no_in) and  status_active=1 and is_deleted =0");
	list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
	$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
	$cuff_excess_per=(($plan_cut*2)*$cuff_excess_percent)/100;
	echo number_format($plan_cut*2+$cuff_excess_per,0);
	$color_total_cuff+=$plan_cut*2+$cuff_excess_per;
	$color_total_cuff_order_qnty+=$plan_cut*2;
	$grand_total_cuff+=$plan_cut*2+$cuff_excess_per;
	$grand_total_cuff_order_qnty+=$plan_cut*2;
	?>
	</td>
	<?
	}
	?>
	<td align="center"><? echo number_format($color_total_cuff,0); ?></td>
	<td align="center"><? echo number_format((($color_total_cuff-$color_total_cuff_order_qnty)/$color_total_cuff_order_qnty)*100,2); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td>Size Total</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:center"><? $cuff_excess_pers=(($size_tatal[$result_size[csf('size_number_id')]]*2)*$cuff_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]*2+$cuff_excess_pers,0); ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_cuff,0); ?></td>
	<td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_cuff-$grand_total_cuff_order_qnty)/$grand_total_cuff_order_qnty)*100,2); ?></td>
	</tr>
	</table>
	</td>
	<?
	}
	?>
	</tr>
	</table>
	<br/>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
	<tr>
	<?
	$nameArray_item_size=sql_select( "select min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.job_no in($job_no_in)  and a.body_part_id=172  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
	if(count($nameArray_item_size)>0)
	{
	?>
	<td width="49%">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr>

	<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Collar Tipping -  Colour Size Brakedown in Pcs</b></td>
	</tr>
	<tr>
	<td width="70">Size</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?
	}
	?>
	<td rowspan="2" align="center"><strong>Total</strong></td>
	<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
	</tr>
	<tr>
	<td>Collar Size</td>
	<?
	foreach($nameArray_item_size  as $result_item_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
	<?
	}
	?>
	<?
	$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and  d.job_no in($job_no_in) and a.body_part_id=172  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by c.color_number_id,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
	");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	$color_total_collar_tipping=0;
	$color_total_collar_tipping_order_qnty=0;
	$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
	$constrast_color_arr=array();
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
	for($i=0;$i<count($constrast_color);$i++)
	{
	$constrast_color2=explode('_',$constrast_color[$i]);
	$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
	}
	}
	?>
	<tr>
	<td>
	<?
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
	$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
	}
	else
	{
	echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
	$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
	}
	?>
	</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black">
	<?
	$color_tipping_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]." and  job_no_mst in($job_no_in)   and  status_active=1 and is_deleted =0");

	list($plan_cut_qnty)=$color_tipping_wise_wo_sql_qnty;
	$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
	$colar_excess_per=($plan_cut*$colar_excess_percent)/100;
	echo number_format($plan_cut+$colar_excess_per,0);
	$color_total_collar_tipping+=$plan_cut+$colar_excess_per;
	$color_total_collar_tipping_order_qnty+=$plan_cut;
	$grand_total_collar_tipping+=$plan_cut+$colar_excess_per;
	$grand_total_collar_tipping_order_qnty+=$plan_cut;
	?>
	</td>
	<?
	}
	?>
	<td align="center"><? echo number_format($color_total_collar_tipping,0); ?></td>
	<td align="center"><? echo number_format((($color_total_collar_tipping-$color_total_collar_tipping_order_qnty)/$color_total_collar_tipping_order_qnty)*100,2); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td>Size Total</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:center"><? $colar_excess_pers=($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]+$colar_excess_pers,0); ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar_tipping,0); ?></td>
	<td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_collar_tipping-$grand_total_collar_tipping_order_qnty)/$grand_total_collar_tipping_order_qnty)*100,2); ?></td>
	</tr>
	</table>
	</td>
	<td width="2%">
	</td>
	<?
	}
	?>
	<?
	$nameArray_item_size=sql_select( "select min(c.id) as id, b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.job_no in($job_no_in)  and a.body_part_id=214  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
	if(count($nameArray_item_size)>0)
	{
	?>
	<td width="49%">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr>
	<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Cuff Tipping -  Colour Size Brakedown in Pcs</b></td>
	</tr>
	<tr>
	<td width="70">Size</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?
	}
	?>
	<td rowspan="2" align="center"><strong>Total</strong></td>
	<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
	</tr>
	<tr>
	<td>Cuff Size</td>
	<?
	foreach($nameArray_item_size  as $result_item_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
	<?
	}
	?>
	<?
	$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and d.job_no in($job_no_in) and a.body_part_id=214  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and  d.status_active=1 and d.is_deleted=0 group by c.color_number_id ,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
	");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	$color_total_cuff_tipping=0;
	$color_total_cuff_tipping_order_qnty=0;
	$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
	$constrast_color_arr=array();
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
	for($i=0;$i<count($constrast_color);$i++)
	{
	$constrast_color2=explode('_',$constrast_color[$i]);
	$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
	}
	}
	?>
	<tr>
	<td>
	<?
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]);
	$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
	}
	else
	{
	echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
	$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
	}
	?>
	</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black">
	<?
	$cuff_tipping_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and job_no_mst in($job_no_in)    and  status_active=1 and is_deleted =0");
	list($plan_cut_qnty)=$cuff_tipping_wise_wo_sql_qnty;
	$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
	$cuff_tipping_excess_per=(($plan_cut*2)*$cuff_excess_percent)/100;
	echo number_format($plan_cut*2+$cuff_tipping_excess_per,0);
	$color_total_cuff_tipping+=$plan_cut*2+$cuff_tipping_excess_per;
	$color_total_cuff_tipping_order_qnty+=$plan_cut*2;
	$grand_total_cuff_tipping+=$plan_cut*2+$cuff_excess_per;
	$grand_total_cuff_tipping_order_qnty+=$plan_cut*2;
	?>
	</td>
	<?
	}
	?>
	<td align="center"><? echo number_format($color_total_cuff_tipping,0); ?></td>
	<td align="center" title="<? echo $color_total_cuff_tipping."**".$color_total_cuff_tipping_order_qnty; ?>"><? echo number_format((($color_total_cuff_tipping-$color_total_cuff_tipping_order_qnty)/$color_total_cuff_tipping_order_qnty)*100,2); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td>Size Total</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:center"><? $cuff_excess_pers=(($size_tatal[$result_size[csf('size_number_id')]]*2)*$cuff_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]*2+$cuff_excess_pers,0); ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_cuff_tipping,0); ?></td>
	<td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_cuff_tipping-$grand_total_cuff_tipping_order_qnty)/$grand_total_cuff_tipping_order_qnty)*100,2); ?></td>
	</tr>
	</table>
	</td>
	<?
	}
	?>
	</tr>
	</table>
	<br/>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
	<tr>
	<td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
	<thead>
	<tr>
	<th width="3%"></th><th width="97%" align="left"><u>Special Instruction</u></th>
	</tr>
	</thead>
	<tbody>
	<?
	$data_array=sql_select("select id, terms from  wo_booking_terms_condition where booking_no=$txt_booking_no");
	if ( count($data_array)>0)
	{
	$i=0;
	foreach( $data_array as $row )
	{
	$i++;
	?>
	<tr id="settr_1" valign="top">
	<td style="vertical-align:top">
	<? echo $i;?>
	</td>
	<td>
	<strong style="font-size:20px"> <? echo $row[csf('terms')]; ?></strong>
	</td>
	</tr>
	<?
	}
	}
	?>
	</tbody>
	</table>
	</td>
	<td width="2%">
	</td>
	<td width="49%" valign="top">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr align="center">
	<td><b>Approved Instructions</b></td>
	</tr>
	<tr>
	<td>
	<?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
	</td>
	</tr>
	</table>
	<br />
	</td>
	</tr>
	</table>
	<br>
	<?
	//------------------------------ Query for TNA start-----------------------------------
	$po_id_all=str_replace("'","",$txt_order_no_id);
	$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
	$tna_start_sql=sql_select( "select id,po_number_id,
	(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
	(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
	(case when task_number=60 then task_start_date else null end) as knitting_start_date,
	(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
	(case when task_number=61 then task_start_date else null end) as dying_start_date,
	(case when task_number=61 then task_finish_date else null end) as dying_end_date,
	(case when task_number=73 then task_start_date else null end) as finishing_start_date,
	(case when task_number=73 then task_finish_date else null end) as finishing_end_date,
	(case when task_number=84 then task_start_date else null end) as cutting_start_date,
	(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
	(case when task_number=86 then task_start_date else null end) as sewing_start_date,
	(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
	(case when task_number=110 then task_start_date else null end) as exfact_start_date,
	(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
	(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
	(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
	from tna_process_mst
	where status_active=1 and po_number_id in($po_id_all) and  job_no_mst in($job_no_in) ");
	$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
	$tna_date_task_arr=array();
	foreach($tna_start_sql as $row)
	{
	if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
	{
	if($tna_fab_start=="")
	{
	$tna_fab_start=$row[csf("fab_booking_start_date")];
	}
	}
	if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
	}
	if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
	}
	if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
	}
	if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
	}
	if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
	}
	if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
	}
	if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
	}
	}
	//------------------------------ Query for TNA end-----------------------------------
	?>
	<fieldset id="div_size_color_matrix" style="max-width:1000; display:none">
	<legend>TNA Information</legend>
	<table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
	<tr>
	<td rowspan="2" align="center" valign="top">SL</td>
	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
	<td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
	<td colspan="2" align="center" valign="top"><b>Knitting</b></td>
	<td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
	<td colspan="2" align="center" valign="top"><b>Finishing Fabric</b></td>
	<td colspan="2" align="center" valign="top"><b>Cutting </b></td>
	<td colspan="2" align="center" valign="top"><b>Sewing </b></td>
	<td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
	</tr>
	<tr>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	</tr>
	<?
	$i=1;
	foreach($tna_date_task_arr as $order_id=>$row)
	{
	?>
	<tr>
	<td><? echo $i; ?></td>
	<td><? echo $po_num_arr[$order_id]; ?></td>
	<td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
	<td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
	<td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
	</tr>
	<?
	$i++;
	}
	?>
	</table>
	</fieldset>
	<?
	}// fabric Source End
	?>
	<?
	//echo signature_table(1, $cbo_company_name, "1330px");
	echo signature_table(121, $cbo_company_name, "1330px", 1);
	?>
    <p class="gg"></p>

    <?
	 
	
$job_no_all= implode(",",array_unique($joball['job_no']));
	$style_sting_all=implode(",",array_unique($joball['style_ref_no']));

	echo "****".custom_file_name($txt_booking_no,$style_sting_all,$job_no_all);
	?>
	</div>
	<?
	exit();  

}

if($action=="show_fabric_booking_report_urmi_per_job_29-10-2020") //
{

	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$company_library=return_library_array( "select id,company_name from lib_company", "id", "company_name");
	$color_library=return_library_array( "select id,color_name from lib_color", "id", "color_name");
	$size_library=return_library_array( "select id,size_name from lib_size", "id", "size_name");
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	//$supplier_address_arr=return_library_array( "select id,address_1 from   lib_supplier",'id','address_1');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	//$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	//$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	$season_arr=return_library_array("select id,season_name from lib_buyer_season","id","season_name");
	$uom=0;
	$joball=array();
	$nameArray_per_job=sql_select( "select  a.job_no,a.style_ref_no  from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by a.job_no,a.style_ref_no");
	foreach ($nameArray_per_job as $row_per_job){
	$joball['job_no'][$row_per_job[csf('job_no')]]=$row_per_job[csf('job_no')];
	$joball['style_ref_no'][$row_per_job[csf('job_no')]]=$row_per_job[csf('style_ref_no')];

	$uom=0;
	$job_data_arr=array();
	$nameArray_buyer=sql_select( "select a.style_ref_no, a.style_description, a.job_no, a.style_owner, a.buyer_name, a.client_id, a.dealing_marchant, a.season, a.season_matrix, a.total_set_qnty, a.product_dept, a.product_code, a.pro_sub_dep, a.gmts_item_id, a.order_repeat_no, a.qlty_label,a.season_buyer_wise from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0 and a.job_no='".$row_per_job[csf('job_no')]."'");
	foreach ($nameArray_buyer as $result_buy){
		$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
		$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
		$job_data_arr['total_set_qnty'][$result_buy[csf('job_no')]]=$result_buy[csf('total_set_qnty')];
		$job_data_arr['product_dept'][$result_buy[csf('job_no')]]=$product_dept[$result_buy[csf('product_dept')]];
		$job_data_arr['product_code'][$result_buy[csf('job_no')]]=$result_buy[csf('product_code')];
		$job_data_arr['pro_sub_dep'][$result_buy[csf('job_no')]]=$pro_sub_dept_array[$result_buy[csf('pro_sub_dep')]];
		$job_data_arr['gmts_item_id'][$result_buy[csf('job_no')]]=$result_buy[csf('gmts_item_id')];
		$job_data_arr['style_ref_no'][$result_buy[csf('job_no')]]=$result_buy[csf('style_ref_no')];
		$job_data_arr['style_description'][$result_buy[csf('job_no')]]=$result_buy[csf('style_description')];
		$job_data_arr['dealing_marchant'][$result_buy[csf('job_no')]]=$marchentrArr[$result_buy[csf('dealing_marchant')]];
		$job_data_arr['season_matrix'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_matrix')]];
		$job_data_arr['season_buyer_wise'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_buyer_wise')]];
		$job_data_arr['order_repeat_no'][$result_buy[csf('job_no')]]=$result_buy[csf('order_repeat_no')];
		$job_data_arr['qlty_label'][$result_buy[csf('job_no')]]=$quality_label[$result_buy[csf('qlty_label')]];
		$job_data_arr['client'][$result_buy[csf('job_no')]]=$result_buy[csf('client_id')];
	}

	$job_no= implode(",",array_unique($job_data_arr['job_no']));
	$job_no_in= implode(",",array_unique($job_data_arr['job_no_in']));
	$product_depertment=implode(",",array_unique($job_data_arr['product_dept']));
	$product_code=implode(",",array_unique($job_data_arr['product_code']));
	$pro_sub_dep=implode(",",array_unique($job_data_arr['pro_sub_dep']));
	$gmts_item_id=implode(",",array_unique($job_data_arr['gmts_item_id']));
	$style_sting=implode(",",array_unique($job_data_arr['style_ref_no']));
	$style_description=implode(",",array_unique($job_data_arr['style_description']));
	$dealing_marchant=implode(",",array_unique($job_data_arr['dealing_marchant']));
	$season_matrix=implode(",",array_unique($job_data_arr['season_matrix']));
	$season_buyer_wise=implode(",",array_unique($job_data_arr['season_buyer_wise']));
	$order_repeat_no= implode(",",array_unique($job_data_arr['order_repeat_no']));
	$qlty_label= implode(",",array_unique($job_data_arr['qlty_label']));
	$client_id= implode(",",array_unique($job_data_arr['client']));
	?>
    <style>
     .table_valign { vertical-align: top;word-break: break-all;word-wrap: break-word; }
@media print {
    .gg {page-break-after: always;}
}
</style>
	<div style="width:1330px" align="center">

	<?php
$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and a.status_active =1 and a.is_deleted=0");
list($nameArray_approved_row) = $nameArray_approved;
$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
list($nameArray_approved_date_row) = $nameArray_approved_date;
$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
list($nameArray_approved_comments_row) = $nameArray_approved_comments;
$path = str_replace("'", "", $path);
if ($path != "") {
	$path = $path;
} else {
	$path = "../../";
}

?>										<!--    Header Company Information         -->
	<table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black" >
	<tr>
	<td width="100">
	<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
	</td>
	<td width="1250">
	<table width="100%" cellpadding="0" cellspacing="0"  >
	<tr>
	<td align="center" style="font-size:20px;">
	<?php
echo $company_library[$cbo_company_name];
?>
	</td>
	<td rowspan="3" width="250">

	<span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($job_no,"'"); ?></b></span><br/>
	<?
	if($nameArray_approved_row[csf('approved_no')]>1)
	{
	?>
	<b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
	<br/>
	Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
	<?
	}
	?>


	</td>
	</tr>
	<tr>
	<td align="center" style="font-size:14px">
	<?
	$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
	if($txt_job_no!="")
	{
	$location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'");
	}
	else
	{
	$location="";
	}

	foreach ($nameArray as $result)
	{
	echo  $location_name_arr[$location];
	?>

	Email Address: <? echo $result[csf('email')];?>
	Website No: <? echo $result[csf('website')]; ?>

	<?

	}

	?>
	</td>
	</tr>
	<tr>
	<td align="center" style="font-size:20px">
	<strong><? if($report_title !=""){ echo $report_title;} else { echo "General Work Order";}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
	</td>
	</tr>
	</table>
	</td>
	</tr>
	</table>
	<?


	$po_data=array();
	if($db_type==0){
	$nameArray_job=sql_select( "select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,DATEDIFF(pub_shipment_date,po_received_date) date_diff,MIN(po_received_date) as po_received_date ,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status  from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no='".$row_per_job[csf('job_no')]."'  group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
	}
	if($db_type==2){
	$nameArray_job=sql_select( "select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,(pub_shipment_date-po_received_date) date_diff,MIN(po_received_date) as po_received_date,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status   from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no='".$row_per_job[csf('job_no')]."' group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
	}
	foreach ($nameArray_job as $result_job){
		$po_data['po_id'][$result_job[csf('id')]]=$result_job[csf('id')];
		$po_data['po_number'][$result_job[csf('id')]]=$result_job[csf('po_number')];
		$po_data['leadtime'][$result_job[csf('id')]]=$result_job[csf('date_diff')];
		$po_data['po_quantity'][$result_job[csf('id')]]=$result_job[csf('po_quantity')];
		$po_data['po_received_date'][$result_job[csf('id')]]=change_date_format($result_job[csf('po_received_date')],'dd-mm-yyyy','-');
		$ddd=strtotime($result_job[csf('pub_shipment_date')]);
		$po_data['pub_shipment_date'][$ddd]=$ddd;
		//$po_data['pub_shipment_date'][$result_job[csf('id')]]=change_date_format($result_job[csf('pub_shipment_date')],'dd-mm-yyyy','-');
		$po_data['insert_date'][$result_job[csf('id')]]=$result_job[csf('insert_date')];

		if($result_job[csf('shiping_status')]==1){
		$shiping_status= "FP";
		}
		else if($result_job[csf('shiping_status')]==2){
		$shiping_status= "PS";
		}
		else if($result_job[csf('shiping_status')]==3){
		$shiping_status= "FS";
		}
		$po_data['shiping_status'][$result_job[csf('id')]]=$shiping_status;
		$po_data['file_no'][$result_job[csf('id')]]=$result_job[csf('file_no')];
		$po_data['grouping'][$result_job[csf('id')]]=$result_job[csf('grouping')];
	}
	$txt_order_no_id=implode(",",array_unique($po_data['po_id']));
	$leadtime=implode(",",array_unique($po_data['leadtime']));
	$po_quantity=array_sum($po_data['po_quantity']);
	$po_received_date=implode(",",array_unique($po_data['po_received_date']));
	$po_number=implode(",",array_unique($po_data['po_number']));
	$shipment_date=date('d-m-Y',min($po_data['pub_shipment_date']));
	$maxshipment_date=date('d-m-Y',max($po_data['pub_shipment_date']));
	//$shipment_date=implode(",",array_unique($po_data['pub_shipment_date']));
	$shiping_status=implode(",",array_unique($po_data['shiping_status']));
	$file_no=implode(",",array_unique($po_data['file_no']));
	$grouping=implode(",",array_unique($po_data['grouping']));


	$colar_excess_percent=0;
	$cuff_excess_percent=0;
	$rmg_process_breakdown=0;
	$nameArray=sql_select( "select a.buyer_id, a.booking_no, a.booking_date, a.supplier_id, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.rmg_process_breakdown, a.insert_date, a.update_date, a.uom, a.remarks, a.pay_mode, a.fabric_composition from wo_booking_mst a where a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0");
	foreach ($nameArray as $result)
	{
		$total_set_qnty=$result[csf('total_set_qnty')];
		$colar_excess_percent=$result[csf('colar_excess_percent')];
		$cuff_excess_percent=$result[csf('cuff_excess_percent')];
		$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
		foreach ($po_data['po_id'] as $po_id=>$po_val){
			$daysInHand.=(datediff('d',date('d-m-Y',time()),$po_data['pub_shipment_date'][$po_id])-1).",";
			$booking_date=$result[csf('update_date')];
			if($booking_date=="" || $booking_date=="0000-00-00 00:00:00"){
			$booking_date=$result[csf('insert_date')];
			}
			$WOPreparedAfter.=(datediff('d',$po_data['insert_date'][$po_id],$booking_date)-1).",";
		}
	?>
	<table width="100%" style="border:1px solid black;table-layout: fixed;" >
	<tr>
	<td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
	</tr>
	<tr>
	<td width="200"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
	<td width="220">:&nbsp;<span style="font-size:18px"><b><? $buyer_name_str=""; if($client_id!=0) $buyer_name_str=$buyer_name_arr[$result[csf('buyer_id')]]."-".$buyer_name_arr[$client_id]; else $buyer_name_str=$buyer_name_arr[$result[csf('buyer_id')]]; echo $buyer_name_str; ?></b></span></td>
	<td width="200"><span style="font-size:12px"><b>Dept.</b></span></td>
	<td width="220">:&nbsp;
	<?
	echo $product_depertment ;
	if($product_code !=""){
	echo " (".$product_code.")";
	}
	if($pro_sub_dep != ""){
	echo " (".$pro_sub_dep.")";
	}
	?>
	</td>
	<td width="200"><span style="font-size:12px"><b>Order Qnty</b></span></td>
	<td>:&nbsp; <?  echo $po_quantity;//." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?> </td>
	</tr>
	<tr>

	<td style="font-size:12px"><b>Garments Item</b></td>
	<td>:&nbsp;
	<?
	$gmts_item_name="";
	$gmts_item=explode(',',$gmts_item_id);
	for($g=0;$g<=count($gmts_item); $g++)
	{
	$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
	}
	echo rtrim($gmts_item_name,',');
	?>
	</td>
	<td style="font-size:12px"><b>Booking Release Date</b></td>
	<td>:&nbsp;
	<?
	$booking_date=$result[csf('update_date')];
	if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
	{
	$booking_date=$result[csf('insert_date')];
	}
	echo change_date_format($booking_date,'dd-mm-yyyy','-','');
	?>&nbsp;&nbsp;&nbsp;</td>
	<td style="font-size:18px"><b>Style Ref.</b>   </td>
	<td style="font-size:18px">:&nbsp;<b>
	<?
	echo $style_sting;
	?>
	</b>
	</td>
	</tr>
	<tr>
	<td style="font-size:12px"><b>Style Des.</b></td>
	<td>:&nbsp;<? echo $style_description;?></td>
	<td style="font-size:12px"><b>Season</b></td>
	<td>:&nbsp;<?  if($season_matrix!="") echo $season_matrix; else echo $season_buyer_wise; ?></td>
	<td style="font-size:12px"><b>Dealing Merchandiser</b></td>
	<td>:&nbsp;<? echo $dealing_marchant; ?></td>
	</tr>

	<tr>
	<td style="font-size:12px"><b>Supplier Name</b>   </td>
	<td>:&nbsp;
	<?
	if($result[csf('pay_mode')]==5){
	echo $company_library[$result[csf('supplier_id')]];
	}
	else{
	echo $supplier_name_arr[$result[csf('supplier_id')]];
	}
	?>    </td>
	<td style="font-size:12px"><b>Delivery Date</b></td>
	<td>:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
	<td style="font-size:18px"><b>Booking No </b>   </td>
	<td style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?> <? //echo "(".$unit_of_measurement[$result[csf('uom')]].")"; $uom=$result[csf('uom')];?></td>
	</tr>
	<tr>
		<td   class="table_valign"><p><b>Attention</b></p></td>
		<td  class="table_valign"  ><p>:&nbsp;<? echo $result[csf('attention')]; ?></p></td>
		<td  class="table_valign"><p><b>Lead Time </b>  </p> </td>
		<td  class="table_valign"><p>:&nbsp;
			<?
			echo $leadtime;
			?> </p>
		</td>
		<td  class="table_valign"><p><b>Po Received Date</b></p></td>
		<td class="table_valign"><p>:&nbsp;<? echo $po_received_date; ?></p></td>
	</tr>
	<tr>
		<td class="table_valign"><p><b>Order No</b></p></td>
		<td class="table_valign" width="350" colspan="3"><p>:&nbsp;<? echo $po_number; ?></p></td>
		<td class="table_valign" ><p><b>Repeat No</b></p></td>
		<td  class="table_valign"><p>:&nbsp;<? echo $order_repeat_no; ?></p></td>
	</tr>
	<tr>
	<td style="font-size:12px"><b>Shipment Date</b></td>
<td colspan="3" style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> : First:&nbsp;<? echo rtrim($shipment_date,", "); //echo $max_pub_shipment_date; ?>, Last: <? echo $maxshipment_date; ?></td>
	<td  style="font-size:12px"><b>Quality Label</b></td>
	<td  >:&nbsp;<? echo $qlty_label; ?></td>
	</tr>
	</tr>
	<tr>
	<td style="font-size:12px"><b>WO Prepared After</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
	<?
	$WOPreparedAfter=implode(",",array_unique(explode(",",chop($WOPreparedAfter,","))));
	echo $WOPreparedAfter.' Days' ;
	?></td>

	<td style="font-size:12px"><b>Ship.days in Hand</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
	<?
	$daysInHand=implode(",",array_unique(explode(",",chop($daysInHand,","))));
	echo $daysInHand.' Days' ;
	?></td>

	<td style="font-size:12px"><b>Ex-factory status</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
	<?
	echo $shiping_status;
	?></td>

	</tr>
	<tr>
	<td style="font-size:18px"><b>Internal Ref No</b></td>
	<td style="font-size:18px"> :&nbsp;<b><? echo $grouping; ?></b></td>
	<td style="font-size:18px"><b>File no</b></td>
	<td style="font-size:18px"> :&nbsp;<b><? echo  $file_no;?></b></td>
	<td style="font-size:18px"><b>Currency</b></td>
	<td style="font-size:18px"> :&nbsp;<b><? echo  $currency[$result[csf("currency_id")]];?></b></td>
	</tr>
	<tr>
	<td style="font-size:18px"><b>Rmarks</b></td>
	<td style="font-size:18px" colspan="5"> :<? echo $result[csf('remarks')]?></td>
	</tr>
	<tr>
	<td style="font-size:18px"><b>Fabric Composition</b></td>
	<td style="font-size:18px" colspan="5"> :<? echo $result[csf('fabric_composition')]?></td>
	</tr>

	</table>
	<?
	}

	if($cbo_fabric_source==1 || $cbo_fabric_source==2){
	$nameArray_size=sql_select( "select  size_number_id,min(id) as id,	min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and   job_no_mst='".$row_per_job[csf('job_no')]."' and 	is_deleted=0 and status_active!=0 group by size_number_id order by size_order");
	?>
	<table width="100%" >
	<tr>
	<td width="800">
	<div id="div_size_color_matrix" style="float:left; max-width:1000;">
	<fieldset id="div_size_color_matrix" style="max-width:1000;">
	<legend>Size and Color Breakdown</legend>
	<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
	<tr>
	<td style="border:1px solid black"><strong>Color/Size</strong></td>
	<?
	foreach($nameArray_size  as $result_size)
	{	     ?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?	}    ?>
	<td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
	<td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
	<td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
	</tr>
	<?
	$color_size_order_qnty_array=array();
	$color_size_qnty_array=array();
	$size_tatal=array();
	$size_tatal_order=array();
	for($c=0;$c<count($gmts_item); $c++)
	{
	$item_size_tatal=array();
	$item_size_tatal_order=array();
	$item_grand_total=0;
	$item_grand_total_order=0;
	$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and job_no_mst='".$row_per_job[csf('job_no')]."' and is_deleted=0 and status_active!=0 group by color_number_id  order by color_order");
	?>
	<tr>
	<td style="border:1px solid black" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>

	</tr>
	<?
	foreach($nameArray_color as $result_color)
	{
	?>
	<tr>
	<td align="center" style="border:1px solid black"><? echo $color_library[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
	<?
	$color_total=0;
	$color_total_order=0;

	foreach($nameArray_size  as $result_size)
	{
	$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and job_no_mst='".$row_per_job[csf('job_no')]."' and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active!=0 and is_deleted =0");
	foreach($nameArray_color_size_qnty as $result_color_size_qnty)
	{
	?>
	<td style="border:1px solid black; text-align:right">
	<?
	if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
	{
	echo number_format($result_color_size_qnty[csf('order_quantity')],0);
	$color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
	$color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
	$item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
	$item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
	$grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
	$grand_total_order +=$result_color_size_qnty[csf('order_quantity')];


	$color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
	$color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
	if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
	{
	$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
	$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
	}
	else
	{
	$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
	$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
	}
	if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
	{
	$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
	$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
	}
	else
	{
	$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
	$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
	}
	}
	else echo "0";
	?>
	</td>

	<?
	}
	}
	?>
	<td style="border:1px solid black; text-align:right"><?  echo number_format(round($color_total_order),0); ?></td>

	<td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?>
	</td>
	<td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total),0); ?></td>
	</tr>
	<?
	}
	?>

	<td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
	<?
	foreach($nameArray_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:right"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total_order),0); ?></td>
	<td  style="border:1px solid black;  text-align:right"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
	<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total),0); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td style="border:1px solid black" align="center" colspan="<? echo count($nameArray_size)+3; ?>"><strong>&nbsp;</strong></td>
	</tr>
	<tr>
	<tr>
	<td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
	<?
	foreach($nameArray_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:right"><? echo $size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total_order),0); ?></td>
	<td  style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
	<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total),0); ?></td>
	</tr>
	</table>
	</fieldset>
	</div>
	</td>
	<td width="200" valign="top" align="left">
	<div id="div_size_color_matrix" style="float:left;">
	<?
	$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
	?>
	<fieldset>
	<legend>RMG Process Loss % </legend>
	<table width="180" class="rpt_table" border="1" rules="all">
	<?
	if(number_format($rmg_process_breakdown_arr[8],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Cut Panel rejection <!-- Extra Cutting % breack Down 8-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[8],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[2],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Chest Printing <!-- Printing % breack Down 2-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[2],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[10],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Neck/Sleeve Printing <!-- New breack Down 10-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[10],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[1],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Embroidery   <!-- Embroidery  % breack Down 1-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[1],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[4],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Sewing /Input<!-- Sewing % breack Down 4-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[4],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[3],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Garments Wash <!-- Washing %breack Down 3-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[3],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[15],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Gmts Finishing <!-- Washing %breack Down 3-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[15],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[11],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Others <!-- New breack Down 11-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[11],2);
	?>
	</td>
	</tr>
	<?
	}
	$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
	if($gmts_pro_sub_tot>0)
	{
	?>
	<tr>
	<td width="130">
	Sub Total <!-- New breack Down 11-->
	</td>
	<td align="right">
	<?

	echo number_format($gmts_pro_sub_tot,2);
	?>
	</td>
	</tr>
	<?
	}
	?>
	</table>
	</fieldset>


	<fieldset>
	<legend>Fabric Process Loss % </legend>
	<table width="180" class="rpt_table" border="1" rules="all">
	<?
	if(number_format($rmg_process_breakdown_arr[6],2)>0)
	{
	?>
	<tr>
	<td width="130">

	Knitting  <!--  Knitting % breack Down 6-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[6],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[12],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Yarn Dyeing  <!--  New breack Down 12-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[12],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[5],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Dyeing & Finishing  <!-- Finishing % breack Down 5-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[5],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[13],2)>0)
	{
	?>
	<tr>
	<td width="130">
	All Over Print <!-- new  breack Down 13-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[13],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[14],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Lay Wash (Fabric) <!-- new  breack Down 14-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[14],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[7],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Dying   <!-- breack Down 7-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[7],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[0],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Cutting (Fabric) <!-- Cutting % breack Down 0-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[0],2);
	?>
	</td>
	</tr>
	<?
	}
	if(number_format($rmg_process_breakdown_arr[9],2)>0)
	{
	?>
	<tr>
	<td width="130">
	Others  <!-- Others% breack Down 9-->
	</td>
	<td align="right">
	<?
	echo number_format($rmg_process_breakdown_arr[9],2);
	?>
	</td>
	</tr>
	<?
	}
	$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
	if(fab_proce_sub_tot>0)
	{
	?>
	<tr>
	<td width="130">
	Sub Total  <!-- Others% breack Down 9-->
	</td>
	<td align="right">
	<?

	echo number_format($fab_proce_sub_tot,2);
	?>
	</td>
	</tr>
	<?
	}
	if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
	{
	?>
	<tr>
	<td width="130">
	Grand Total  <!-- Others% breack Down 9-->
	</td>
	<td align="right">
	<?
	echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2);
	?>
	</td>
	</tr>
	<?
	}
	?>
	</table>
	</fieldset>
	</div>
	</td>
	<td width="330" valign="top" align="left">
	<?
	$nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id in($job_no_in) and file_type=1");
	?>
	<div id="div_size_color_matrix" style="float:left;">
	<fieldset>
	<legend>Image</legend>
	<table width="310">
	<tr>
	<?
	$img_counter = 0;
	foreach($nameArray_imge as $result_imge)
	{
	if($path=="")
	{
	$path='../../';
	}
	?>
	<td>
	<img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />
	</td>
	<?

	$img_counter++;
	}
	?>
	</tr>
	</table>
	</fieldset>
	</div>
	</td>
	</tr>
	</table>
	<?
	}// if($cbo_fabric_source==1) end

	?>
	<br/>
	<!--  Here will be the main portion  -->
	<?
	$costing_per="";
	$costing_per_qnty=0;
	$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no in($job_no_in)");
	if($costing_per_id==1)
	{
	$costing_per="1 Dzn";
	$costing_per_qnty=12;

	}
	if($costing_per_id==2)
	{
	$costing_per="1 Pcs";
	$costing_per_qnty=1;

	}
	if($costing_per_id==3)
	{
	$costing_per="2 Dzn";
	$costing_per_qnty=24;

	}
	if($costing_per_id==4)
	{
	$costing_per="3 Dzn";
	$costing_per_qnty=36;

	}
	if($costing_per_id==5)
	{
	$costing_per="4 Dzn";
	$costing_per_qnty=48;
	}
	$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no in($job_no_in)");

	$uom_arr=array(1=>"Pcs",12=>"Kg",23=>"Mtr",27=>"Yds");
	foreach($uom_arr as $uom_id=>$uom_val){
	if($cbo_fabric_source==1){
	$nameArray_fabric_description= sql_select("select a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , b.dia_width,d.pre_cost_remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_number_id=d.gmts_color_id and
	b.dia_width=d.dia_width and
	b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	d.job_no='".$row_per_job[csf('job_no')]."' and
	a.uom=$uom_id and
	d.status_active=1 and
	d.is_deleted=0 and
	b.cons>0
	group by a.id,a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,b.dia_width,d.pre_cost_remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	if(count($nameArray_fabric_description)>0){
	?>

	<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
	<caption>Fabric Details in <? echo $uom_val ?></caption>
	<tr align="center">
	<th colspan="3" align="left">Item Name</th>
	<?

	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('body_part_id')] == "")
	echo "<td colspan='3'>&nbsp</td>";
	else
	echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
	}
	?>
	<td  rowspan="11" width="50"><p>Total Finish Fabric (Kg)</p></td>

	<td  rowspan="11" width="50"><p>Avg Rate <? echo "(".$unit_of_measurement[$uom].")";?></p></td>
	<td  rowspan="11" width="50"><p>Amount </p></td>

	</tr>
	<tr align="center">
	<th colspan="3" align="left">Body Part</th>
	<?

	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('body_part_id')] == "")
	echo "<td colspan='3'>&nbsp</td>";
	else
	echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th colspan="3" align="left">Color Type</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
	else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th colspan="3" align="left">Fabric Construction</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
	else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
	}
	?>


	</tr>
	<tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
	else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
	}
	?>

	</tr>
	<tr align="center"><th  colspan="3" align="left">GSM</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
	else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
	}
	?>

	</tr>
	<tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
	else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
	}
	?>

	</tr>
	<tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
	else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
	}
	?>
	</tr>
    <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('pre_cost_remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('pre_cost_remarks')]."</td>";
		}
		?>

       </tr>
	<tr>
	<th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
	</tr>
	<tr>
	<th  width="120" align="left">Fabric Color</th>
	<th  width="120" align="left">Body Color</th>
	<th  width="120" align="left">Lab Dip No</th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
	}
	?>
	</tr>
	<?
	$gmt_color_library=array();
	$gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
	FROM
	wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
	WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=$uom_id  and a.fabric_source =$cbo_fabric_source and
	a.job_no in ($job_no_in)");
	foreach( $gmt_color_data as $gmt_color_row){
	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
	}
	$grand_total_fin_fab_qnty=0;
	$grand_total_amount=0;
	$color_wise_wo_sql=sql_select("select b.fabric_color_id
	FROM
	wo_pre_cost_fabric_cost_dtls a,
	wo_booking_dtls b
	WHERE
	a.id=b.pre_cost_fabric_cost_dtls_id and
	a.uom=$uom_id and
	b.booking_no =$txt_booking_no and
	b.job_no='".$row_per_job[csf('job_no')]."' and
	b.status_active=1 and
	b.is_deleted=0
	group by b.fabric_color_id");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	?>
	<tr>
	<td  width="120" align="left">
	<?
	echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
	?>
	</td>
	<td>
	<?
	echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
	?>
	</td>
	<td  width="120" align="left">
	<?
	$lapdip_no="";
	$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
	if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
	?>
	</td>
	<?
	$total_fin_fab_qnty=0;
	$total_amount=0;

	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if($db_type==0)
	{
	$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	d.job_no='".$row_per_job[csf('job_no')]."' and
	a.uom=$uom_id and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
	d.fabric_color_id='".$color_wise_wo_result[csf('fabric_color_id')]."' and
	d.status_active=1 and
	d.is_deleted=0
	");
	}
	if($db_type==2)
	{
	$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	d.job_no='".$row_per_job[csf('job_no')]."' and
	a.uom=$uom_id and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
	nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
	d.status_active=1 and
	d.is_deleted=0
	");
	}
	list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
	?>
	<td width='50' align='right'>
	<?
	if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
	{
	echo def_number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;
	$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('fin_fab_qnty')];
	}
	?>
	</td>
	<td width='50' align='right' >
	<?
	if($color_wise_wo_result_qnty[csf('rate')]!="")
	{
	echo def_number_format($color_wise_wo_result_qnty[csf('rate')],5);
	}
	?>
	</td>
	<td width='50' align='right' >
	<?
	$amount=def_number_format($color_wise_wo_result_qnty[csf('amount')],2,'',0);
	if($amount!="")
	{
	echo $amount;
	$total_amount+=$amount;
	}
	?>
	</td>
	<?
	}
	?>
	<td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
	<td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
	<td align="right">
	<?
	echo def_number_format($total_amount,2);

	?>
	</td>
	</tr>
	<?
	}
	?>
	<tr style=" font-weight:bold">
	<th  width="120" align="left">&nbsp;</th>
	<td  width="120" align="left">&nbsp;</td>
	<td  width="120" align="left"><strong>Total</strong></td>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	d.job_no='".$row_per_job[csf('job_no')]."' and
	a.uom=$uom_id and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
	d.status_active=1 and
	d.is_deleted=0
	");
	list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
	?>
	<td width='50' align='right'><?  echo def_number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;?></td>
	<td width='50' align='right'></td>
	<td width='50' align='right'></td>
	<?
	}
	?>
	<td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
	<td align="right"><? echo def_number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
	<td align="right">
	<?
	echo def_number_format($grand_total_amount,2);
	?>
	</td>
	</tr>
	<!--<tr style="font-weight:bold">
	<th  width="120" align="left">&nbsp;</th>
	<td  width="120" align="left">&nbsp;</td>
	<td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=$uom_id and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.status_active=1 and
	d.is_deleted=0
	");
	list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty*/
	?>
	<td width='50' align='right'></td>
	<td width='50' align='right'></td>
	<td width='50' align='right'></td>
	<?
	}
	?>
	<td align="right">
	<?
	//$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
	//echo number_format($consumption_per_unit_fab,2);
	?>
	</td>
	<td align="right">
	<?
	//$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
	//echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
	?>
	</td>
	<td align="right" title="Only Allow Round Figer">
	<?
	//echo number_format($consumption_per_unit_amuont,2);
	?>
	</td>
	</tr> -->
	</table>
	<br/>
	<?
	}
	}
	}
	//===========================

	foreach($uom_arr as $uom_id=>$uom_val){
	if($cbo_fabric_source==2){
	$nameArray_fabric_description= sql_select("select a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , b.dia_width,d.pre_cost_remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_number_id=d.gmts_color_id and
	b.dia_width=d.dia_width and
	b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	d.job_no='".$row_per_job[csf('job_no')]."' and
	a.uom=$uom_id and
	d.status_active=1 and
	d.is_deleted=0  and
	b.cons>0
	group by a.id,a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,b.dia_width,d.pre_cost_remarks order by fabric_cost_dtls_id,a.body_part_id,b.dia_width");
	if(count($nameArray_fabric_description)>0){
	?>
	<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
	<caption>Fabric Details in <? echo $uom_val;?></caption>
	<tr align="center">
	<th colspan="3" align="left">Item Name</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('body_part_id')] == "")
	echo "<td colspan='3'>&nbsp</td>";
	else
	echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
	}
	?>
	<td  rowspan="11" width="50"><p>Total Finish Fabric</p></td>

	<td  rowspan="11" width="50"><p>Avg Rate</p></td>
	<td  rowspan="11" width="50"><p>Amount </p></td>
	</tr>
	<tr align="center">
	<th colspan="3" align="left">Body Part</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('body_part_id')] == "")
	echo "<td colspan='3'>&nbsp</td>";
	else
	echo "<td colspan='3'>".$body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th colspan="3" align="left">Color Type</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
	else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th colspan="3" align="left">Fabric Construction</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)

	{
	if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
	else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
	else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th  colspan="3" align="left">GSM</th>
	<?
	foreach($nameArray_fabric_description  as $result_fabric_description)
	{
	if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
	else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
	}
	?>
	</tr>
	<tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
	else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
	}
	?>

	</tr>
	<tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
	else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
	}
	?>

	</tr>
    <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('pre_cost_remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('pre_cost_remarks')]."</td>";
		}
		?>

       </tr>
	<tr>
	<th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
	</tr>
	<tr>
	<th  width="120" align="left">Fabric Color</th>
	<th  width="120" align="left">Body Color</th>
	<th  width="120" align="left">Lab Dip No</th>
	<?
	if($cbo_fabric_source==2)
	{
	foreach($nameArray_fabric_description as $result_fabric_description)

	{
	echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
	}
	}
	else
	{
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	echo "<th width='50'>Fab. Qty</th>";
	}
	}

	?>
	</tr>
	<?
	$gmt_color_library=array();

	$gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
	FROM
	wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
	WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=$uom_id  and a.fabric_source =$cbo_fabric_source and
	a.job_no in ($job_no_in)");
	foreach( $gmt_color_data as $gmt_color_row){
	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
	}
	$grand_total_fin_fab_qnty=0;
	$grand_total_amount=0;
	$color_wise_wo_sql=sql_select("select b.fabric_color_id
	FROM
	wo_pre_cost_fabric_cost_dtls a,
	wo_booking_dtls b
	WHERE
	a.id=b.pre_cost_fabric_cost_dtls_id and
	a.uom=$uom_id and
	b.booking_no =$txt_booking_no
	and b.job_no='".$row_per_job[csf('job_no')]."' and
	b.status_active=1 and
	b.is_deleted=0
	group by b.fabric_color_id");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	?>
	<tr>
	<td  width="120" align="left">
	<?
	echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
	?>
	</td>
	<td>
	<?
	echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
	?>
	</td>
	<td  width="120" align="left">
	<?
	$lapdip_no="";
	$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
	if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
	?>
	</td>
	<?
	$total_fin_fab_qnty=0;
	$total_amount=0;

	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	if($db_type==0)
	{
	$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	d.job_no='".$row_per_job[csf('job_no')]."' and
	a.uom=$uom_id and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
	d.fabric_color_id='".$color_wise_wo_result[csf('fabric_color_id')]."' and
	d.status_active=1 and
	d.is_deleted=0
	");
	}
	if($db_type==2)
	{
	$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	d.job_no='".$row_per_job[csf('job_no')]."' and
	a.uom=$uom_id and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
	nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
	d.status_active=1 and
	d.is_deleted=0
	");
	}
	list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
	?>
	<td width='50' align='right'>
	<?
	if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
	{
	echo def_number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;
	$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('fin_fab_qnty')];
	}
	?>
	</td>
	<td width='50' align='right' >
	<?
	if($color_wise_wo_result_qnty[csf('rate')]!="")
	{
	echo def_number_format($color_wise_wo_result_qnty[csf('rate')],5);
	}
	?>
	</td>
	<td width='50' align='right' >
	<?
	$amount=def_number_format($color_wise_wo_result_qnty[csf('amount')],2,'',0);
	if($amount!="")
	{
	echo $amount;
	$total_amount+=$amount;
	}
	?>
	</td>
	<?
	}
	?>
	<td align="right"><? echo def_number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
	<td align="right"><? echo def_number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
	<td align="right">
	<?
	echo def_number_format($total_amount,2);

	?>
	</td>
	</tr>
	<?
	}
	?>
	<tr style=" font-weight:bold">
	<th  width="120" align="left">&nbsp;</th>
	<td  width="120" align="left">&nbsp;</td>
	<td  width="120" align="left"><strong>Total</strong></td>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	d.job_no='".$row_per_job[csf('job_no')]."' and
	a.uom=$uom_id and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.pre_cost_remarks='".$result_fabric_description[csf('pre_cost_remarks')]."' and
	d.status_active=1 and
	d.is_deleted=0
	");
	list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
	?>
	<td width='50' align='right'><?  echo def_number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;?></td>
	<td width='50' align='right' ></td>
	<td width='50' align='right' ></td>
	<?
	}
	?>
	<td align="right"><? echo def_number_format($grand_total_fin_fab_qnty,2);?></td>
	<td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
	<td align="right">
	<?
	echo def_number_format($grand_total_amount,2);
	?>
	</td>
	</tr>
	<!--<tr style="font-weight:bold">
	<th  width="120" align="left">&nbsp;</th>
	<td  width="120" align="left">&nbsp;</td>
	<td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
	<?
	foreach($nameArray_fabric_description as $result_fabric_description)
	{
	/*$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.grey_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	a.uom=$uom_id and
	a.item_number_id='".$result_fabric_description[csf('item_number_id')]."' and
	a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
	a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
	a.construction='".$result_fabric_description[csf('construction')]."' and
	a.composition='".$result_fabric_description[csf('composition')]."' and
	a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
	d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
	d.status_active=1 and
	d.is_deleted=0
	");
	list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty*/

	?>
	<td width='50' align='right'></td>
	<td width='50' align='right'></td>
	<td width='50' align='right'></td>
	<?
	}
	?>
	<td align="right">
	<?
	//$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
	//echo number_format($consumption_per_unit_fab,2);
	?>
	</td>
	<td align="right">
	<?
	//$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
	//echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
	?>
	</td>
	<td align="right" title="Only Allow Round Figer">
	<?
	//echo number_format($consumption_per_unit_amuont,2);
	?>
	</td>
	</tr> -->
	</table>
	<br/>
	<?
	}
	}
	}
	//===========================
	?>
    <?
	$sql_data=sql_select("select a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,a.uom,b.dia_width,b.pre_cost_remarks,b.fabric_color_id,b.remark, sum(b.grey_fab_qnty) as grey_fab_qnty,sum(b.adjust_qty)as adjust_qty,sum(b.fin_fab_qnty) as fin_fab_qnty,avg(b.rate) as rate,sum(b.grey_fab_qnty*b.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no='".$row_per_job[csf('job_no')]."' and b.adjust_qty>0 and b.status_active=1 and b.is_deleted=0 group by a.id,a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,a.uom,b.dia_width,b.pre_cost_remarks,b.fabric_color_id,b.remark order by a.id,a.body_part_id");

		?>
		<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

        <tr>
        <td colspan="7">
        <strong>Fabric Stock Adjustment Details</strong>
        </td>

        </tr>

        <tr>
        <td>
        Fabrication
        </td>
        <td>
        Process
        </td>
        <td>
        Fabric Color
        </td>
        <td>
        Required
        </td>
        <td>
        Stock Used
        </td>
        <td>
        Booking Qty
        </td><td>
        Uom
        </td>
         <td>
        Remarks
        </td>
        </tr>
        <?
		foreach($sql_data as $row){
		?>
          <tr>
        <td>
        <? echo $body_part[$row[csf('body_part_id')]].",".$color_type[$row[csf('color_type_id')]].",".$row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$fabric_typee[$row[csf('width_dia_type')]].",".$row[csf('dia_width')]  ?>
        </td>
        <td>
        <? echo $row[csf('pre_cost_remarks')];  ?>
        </td>
        <td>
        <? echo $color_library[$row[csf('fabric_color_id')]];  ?>
        </td>
        <td align="right">
        <? echo number_format($row[csf('grey_fab_qnty')],4);  ?>
        </td>
        <td align="right">
         <? echo number_format($row[csf('adjust_qty')],4) ; ?>
        </td>
        <td align="right">
       <? echo number_format($row[csf('fin_fab_qnty')],4);  ?>
        </td>
         <td>
        <? echo $unit_of_measurement[$row[csf('uom')]];  ?>
        </td>
         <td>
         <? echo $row[csf('remark')];  ?>
        </td>
        </tr>
        <?
		}
		?>
        </table>


	<?
	if($cbo_fabric_source==1 || $cbo_fabric_source==2){
	?>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
	<tr>
	<?
	$nameArray_item_size=sql_select( "select min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active =1 and d.is_deleted=0 and d.job_no='".$row_per_job[csf('job_no')]."'  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
	if(count($nameArray_item_size)>0)
	{
	?>
	<td width="49%">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr>
	<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Collar -  Colour Size Brakedown in Pcs</b></td>
	</tr>
	<tr>
	<td width="70">Size</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?
	}
	?>
	<td rowspan="2" align="center"><strong>Total</strong></td>
	<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
	</tr>
	<tr>
	<td>Collar Size</td>

	<?
	foreach($nameArray_item_size  as $result_item_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
	<?
	}
	?>
	<?
	$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active =1 and d.is_deleted=0 and d.job_no='".$row_per_job[csf('job_no')]."' and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and c.color_number_id=d.gmts_color_id and d.status_active=1 and d.is_deleted=0 group by c.color_number_id,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
	");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	$color_total_collar=0;
	$color_total_collar_order_qnty=0;
	$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
	$constrast_color_arr=array();
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
	for($i=0;$i<count($constrast_color);$i++)
	{
	$constrast_color2=explode('_',$constrast_color[$i]);
	$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
	}
	}
	?>
	<tr>
	<td>
	<?
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
	$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
	}
	else
	{
	echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
	$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
	}
	?>
	</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black">
	<?
	$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and job_no_mst='".$row_per_job[csf('job_no')]."' and  status_active=1 and is_deleted =0");
	list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
	$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
	$colar_excess_per=($plan_cut*$colar_excess_percent)/100;
	echo number_format($plan_cut+$colar_excess_per,0);
	$color_total_collar+=$plan_cut+$colar_excess_per;
	$color_total_collar_order_qnty+=$plan_cut;
	$grand_total_collar+=$plan_cut+$colar_excess_per;
	$grand_total_collar_order_qnty+=$plan_cut;
	?>
	</td>
	<?
	}
	?>
	<td align="center"><? echo number_format($color_total_collar,0); ?></td>
	<td align="center"><? echo number_format((($color_total_collar-$color_total_collar_order_qnty)/$color_total_collar_order_qnty)*100,2); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td>Size Total</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:center"><? $colar_excess_pers=($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]+$colar_excess_pers,0); ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar,0); ?></td>
	<td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_collar-$grand_total_collar_order_qnty)/$grand_total_collar_order_qnty)*100,2); ?></td>
	</tr>
	</table>
	</td>
	<td width="2%">
	</td>
	<?
	}
	?>
	<?
	$nameArray_item_size=sql_select( "select min(c.id) as id, b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.job_no='".$row_per_job[csf('job_no')]."'  and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");

	if(count($nameArray_item_size)>0)
	{
	?>
	<td width="49%">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr>
	<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Cuff -  Colour Size Brakedown in Pcs</b></td>
	</tr>
	<tr>
	<td width="70">Size</td>

	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?
	}
	?>
	<td rowspan="2" align="center"><strong>Total</strong></td>
	<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
	</tr>
	<tr>
	<td>Cuff Size</td>

	<?
	foreach($nameArray_item_size  as $result_item_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
	<?
	}
	?>
	<?
	$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.job_no='".$row_per_job[csf('job_no')]."' and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and  d.status_active=1 and d.is_deleted=0 group by c.color_number_id ,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
	");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	$color_total_cuff=0;
	$color_total_cuff_order_qnty=0;
	$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
	$constrast_color_arr=array();
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
	for($i=0;$i<count($constrast_color);$i++)
	{
	$constrast_color2=explode('_',$constrast_color[$i]);
	$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
	}
	}
	?>
	<tr>
	<td>
	<?
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]);
	$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
	}
	else
	{
	echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
	$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
	}
	?>
	</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black">
	<?
	$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and job_no_mst='".$row_per_job[csf('job_no')]."' and  status_active=1 and is_deleted =0");
	list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
	$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
	$cuff_excess_per=(($plan_cut*2)*$cuff_excess_percent)/100;
	echo number_format($plan_cut*2+$cuff_excess_per,0);
	$color_total_cuff+=$plan_cut*2+$cuff_excess_per;
	$color_total_cuff_order_qnty+=$plan_cut*2;
	$grand_total_cuff+=$plan_cut*2+$cuff_excess_per;
	$grand_total_cuff_order_qnty+=$plan_cut*2;
	?>
	</td>
	<?
	}
	?>
	<td align="center"><? echo number_format($color_total_cuff,0); ?></td>
	<td align="center"><? echo number_format((($color_total_cuff-$color_total_cuff_order_qnty)/$color_total_cuff_order_qnty)*100,2); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td>Size Total</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:center"><? $cuff_excess_pers=(($size_tatal[$result_size[csf('size_number_id')]]*2)*$cuff_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]*2+$cuff_excess_pers,0); ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_cuff,0); ?></td>
	<td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_cuff-$grand_total_cuff_order_qnty)/$grand_total_cuff_order_qnty)*100,2); ?></td>
	</tr>
	</table>
	</td>
	<?
	}
	?>
	</tr>
	</table>
	<br/>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
	<tr>
	<?
	$nameArray_item_size=sql_select( "select min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.job_no='".$row_per_job[csf('job_no')]."'  and a.body_part_id=172  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
	if(count($nameArray_item_size)>0)
	{
	?>
	<td width="49%">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr>
	<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Collar Tipping -  Colour Size Brakedown in Pcs</b></td>
	</tr>
	<tr>
	<td width="70">Size</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?
	}
	?>
	<td rowspan="2" align="center"><strong>Total</strong></td>
	<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
	</tr>
	<tr>
	<td>Collar Size</td>
	<?
	foreach($nameArray_item_size  as $result_item_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
	<?
	}
	?>
	<?
	$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.job_no='".$row_per_job[csf('job_no')]."' and a.body_part_id=172  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by c.color_number_id,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
	");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	$color_total_collar_tipping=0;
	$color_total_collar_tipping_order_qnty=0;
	$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
	$constrast_color_arr=array();
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
	for($i=0;$i<count($constrast_color);$i++)
	{
	$constrast_color2=explode('_',$constrast_color[$i]);
	$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
	}
	}
	?>
	<tr>
	<td>
	<?
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
	$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
	}
	else
	{
	echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
	$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
	}
	?>
	</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black">
	<?
	$color_tipping_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]." and job_no_mst='".$row_per_job[csf('job_no')]."'   and  status_active=1 and is_deleted =0");

	list($plan_cut_qnty)=$color_tipping_wise_wo_sql_qnty;
	$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
	$colar_excess_per=($plan_cut*$colar_excess_percent)/100;
	echo number_format($plan_cut+$colar_excess_per,0);
	$color_total_collar_tipping+=$plan_cut+$colar_excess_per;
	$color_total_collar_tipping_order_qnty+=$plan_cut;
	$grand_total_collar_tipping+=$plan_cut+$colar_excess_per;
	$grand_total_collar_tipping_order_qnty+=$plan_cut;
	?>
	</td>
	<?
	}
	?>
	<td align="center"><? echo number_format($color_total_collar_tipping,0); ?></td>
	<td align="center"><? echo number_format((($color_total_collar_tipping-$color_total_collar_tipping_order_qnty)/$color_total_collar_tipping_order_qnty)*100,2); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td>Size Total</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:center"><? $colar_excess_pers=($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]+$colar_excess_pers,0); ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar_tipping,0); ?></td>
	<td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_collar_tipping-$grand_total_collar_tipping_order_qnty)/$grand_total_collar_tipping_order_qnty)*100,2); ?></td>
	</tr>
	</table>
	</td>
	<td width="2%">
	</td>
	<?
	}
	?>
	<?
	$nameArray_item_size=sql_select( "select min(c.id) as id, b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.job_no='".$row_per_job[csf('job_no')]."'  and a.body_part_id=214  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
	if(count($nameArray_item_size)>0)
	{
	?>
	<td width="49%">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr>
	<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Cuff Tipping -  Colour Size Brakedown in Pcs</b></td>
	</tr>
	<tr>
	<td width="70">Size</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?
	}
	?>
	<td rowspan="2" align="center"><strong>Total</strong></td>
	<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
	</tr>
	<tr>
	<td>Cuff Size</td>
	<?
	foreach($nameArray_item_size  as $result_item_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
	<?
	}
	?>
	<?
	$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.job_no='".$row_per_job[csf('job_no')]."' and a.body_part_id=214  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and  d.status_active=1 and d.is_deleted=0 group by c.color_number_id ,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
	");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
	$color_total_cuff_tipping=0;
	$color_total_cuff_tipping_order_qnty=0;
	$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
	$constrast_color_arr=array();
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
	for($i=0;$i<count($constrast_color);$i++)
	{
	$constrast_color2=explode('_',$constrast_color[$i]);
	$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
	}
	}
	?>
	<tr>
	<td>
	<?
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
	echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]);
	$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
	}
	else
	{
	echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
	$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
	}
	?>
	</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black">
	<?
	$cuff_tipping_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]." and job_no_mst='".$row_per_job[csf('job_no')]."'   and  status_active=1 and is_deleted =0");
	list($plan_cut_qnty)=$cuff_tipping_wise_wo_sql_qnty;
	$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
	$cuff_tipping_excess_per=(($plan_cut*2)*$cuff_excess_percent)/100;
	echo number_format($plan_cut*2+$cuff_tipping_excess_per,0);
	$color_total_cuff_tipping+=$plan_cut*2+$cuff_tipping_excess_per;
	$color_total_cuff_tipping_order_qnty+=$plan_cut*2;
	$grand_total_cuff_tipping+=$plan_cut*2+$cuff_excess_per;
	$grand_total_cuff_tipping_order_qnty+=$plan_cut*2;
	?>
	</td>
	<?
	}
	?>
	<td align="center"><? echo number_format($color_total_cuff_tipping,0); ?></td>
	<td align="center" title="<? echo $color_total_cuff_tipping."**".$color_total_cuff_tipping_order_qnty; ?>"><? echo number_format((($color_total_cuff_tipping-$color_total_cuff_tipping_order_qnty)/$color_total_cuff_tipping_order_qnty)*100,2); ?></td>
	</tr>
	<?
	}
	?>
	<tr>
	<td>Size Total</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td style="border:1px solid black;  text-align:center"><? $cuff_excess_pers=(($size_tatal[$result_size[csf('size_number_id')]]*2)*$cuff_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]*2+$cuff_excess_pers,0); ?></td>
	<?
	}
	?>
	<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_cuff_tipping,0); ?></td>
	<td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_cuff_tipping-$grand_total_cuff_tipping_order_qnty)/$grand_total_cuff_tipping_order_qnty)*100,2); ?></td>
	</tr>
	</table>
	</td>
	<?
	}
	?>
	</tr>
	</table>
	<br/>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
	<tr>
	<td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
	<thead>
	<tr>
	<th width="3%"></th><th width="97%" align="left"><u>Special Instruction</u></th>
	</tr>
	</thead>
	<tbody>
	<?
	$data_array=sql_select("select id, terms from  wo_booking_terms_condition where booking_no=$txt_booking_no");
	if ( count($data_array)>0)
	{
	$i=0;
	foreach( $data_array as $row )
	{
	$i++;
	?>
	<tr id="settr_1" valign="top">
	<td style="vertical-align:top">
	<? echo $i;?>
	</td>
	<td>
	<strong style="font-size:20px"> <? echo $row[csf('terms')]; ?></strong>
	</td>
	</tr>
	<?
	}
	}
	?>
	</tbody>
	</table>
	</td>
	<td width="2%">
	</td>
	<td width="49%" valign="top">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr align="center">
	<td><b>Approved Instructions</b></td>
	</tr>
	<tr>
	<td>
	<?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
	</td>
	</tr>
	</table>
	<br />
	</td>
	</tr>
	</table>
	<br>
	<?
	//------------------------------ Query for TNA start-----------------------------------
	$po_id_all=str_replace("'","",$txt_order_no_id);
	$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
	$tna_start_sql=sql_select( "select id,po_number_id,
	(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
	(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
	(case when task_number=60 then task_start_date else null end) as knitting_start_date,
	(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
	(case when task_number=61 then task_start_date else null end) as dying_start_date,
	(case when task_number=61 then task_finish_date else null end) as dying_end_date,
	(case when task_number=73 then task_start_date else null end) as finishing_start_date,
	(case when task_number=73 then task_finish_date else null end) as finishing_end_date,
	(case when task_number=84 then task_start_date else null end) as cutting_start_date,
	(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
	(case when task_number=86 then task_start_date else null end) as sewing_start_date,
	(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
	(case when task_number=110 then task_start_date else null end) as exfact_start_date,
	(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
	(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
	(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
	from tna_process_mst
	where status_active=1 and po_number_id in($po_id_all) and job_no_mst='".$row_per_job[csf('job_no')]."'");
	$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
	$tna_date_task_arr=array();
	foreach($tna_start_sql as $row)
	{
	if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
	{
	if($tna_fab_start=="")
	{
	$tna_fab_start=$row[csf("fab_booking_start_date")];
	}
	}
	if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
	}
	if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
	}
	if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
	}
	if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
	}
	if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
	}
	if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
	}
	if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
	{
	$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
	$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
	}
	}
	//------------------------------ Query for TNA end-----------------------------------
	?>
	<fieldset id="div_size_color_matrix" style="max-width:1000; display:none">
	<legend>TNA Information</legend>
	<table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
	<tr>
	<td rowspan="2" align="center" valign="top">SL</td>
	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
	<td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
	<td colspan="2" align="center" valign="top"><b>Knitting</b></td>
	<td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
	<td colspan="2" align="center" valign="top"><b>Finishing Fabric</b></td>
	<td colspan="2" align="center" valign="top"><b>Cutting </b></td>
	<td colspan="2" align="center" valign="top"><b>Sewing </b></td>
	<td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
	</tr>
	<tr>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	<td width="85" align="center" valign="top"><b>Start Date</b></td>
	<td width="85" align="center" valign="top"><b>End Date</b></td>
	</tr>
	<?
	$i=1;
	foreach($tna_date_task_arr as $order_id=>$row)
	{
	?>
	<tr>
	<td><? echo $i; ?></td>
	<td><? echo $po_num_arr[$order_id]; ?></td>
	<td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
	<td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
	<td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
	<td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
	<td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
	</tr>
	<?
	$i++;
	}
	?>
	</table>
	</fieldset>
	<?
	}// fabric Source End
	?>
	<?
	//echo signature_table(1, $cbo_company_name, "1330px");
	echo signature_table(121, $cbo_company_name, "1330px", 1);
	?>
    <p class="gg"></p>

    <?
	}
$job_no_all= implode(",",array_unique($joball['job_no']));
	$style_sting_all=implode(",",array_unique($joball['style_ref_no']));

	echo "****".custom_file_name($txt_booking_no,$style_sting_all,$job_no_all);
	?>
	</div>
	<?

}

if ($action=="unapp_request_popup")
{
	$menu_id=$_SESSION['menu_id'];
	$user_id=$_SESSION['logic_erp']['user_id'];

	echo load_html_head_contents("Un Approval Request","../../../", 1, 1, $unicode);
	extract($_REQUEST);

	$data_all=explode('_',$data);
	$booking_no=$data_all[0];
	//$unapp_request=$data_all[1];

	$wo_id=return_field_value("id", "wo_booking_mst", "booking_no='$booking_no' and status_active=1 and is_deleted=0");

	if($unapp_request=="")
	{
		$sql_request="select MAX(id) as id from fabric_booking_approval_cause where page_id='$menu_id' and entry_form=7 and user_id='$user_id' and booking_id='$wo_id' and approval_type=2 and status_active=1 and is_deleted=0";

			$dd="";
		$nameArray_request=sql_select($sql_request);
		foreach($nameArray_request as $row)
		{
			//$unapp_request=return_field_value("approval_cause", "fabric_booking_approval_cause", "id='".$row[csf('id')]."' and status_active=1 and is_deleted=0");
				$dd=sql_select("select approval_cause from fabric_booking_approval_cause where id=".$row[csf('id')]." and status_active=1 and is_deleted=0");
				//$unapp_request=htmlentities($dd[0][csf('approval_cause')]);
		}
	}
	
	 $up_sql="select approval_cause,id from fabric_booking_approval_cause where booking_id=".$wo_id." and status_active=1 and is_deleted=0 order by id desc";
	//echo "select approval_cause from fabric_booking_approval_cause where booking_id=".$wo_id." and status_active=1 and is_deleted=0";
	$up_nameArray_request=sql_select($up_sql);
	foreach($up_nameArray_request as $row)
	{
		$unappv_req=$row[csf('approval_cause')];
	}
	
	$un_sql_request="select MAX(id) as id,max(approval_no) as approved_no from fabric_booking_approval_cause where entry_form=7  and booking_id=".$wo_id." and approval_type=2 and status_active=1 and is_deleted=0";// page_id='$menu_id'
		//echo $sql_request;
		$nameArray_un_request=sql_select($un_sql_request);
		$cause_approved_no='';
		foreach($nameArray_un_request as $approw)
		{
			$cause_approved_no=$approw[csf("approved_no")];
		}
		
		$max_approved_no=return_field_value("max(approved_no) as max_approved_no", "approval_history", "mst_id='".$wo_id."'  and entry_form=7","max_approved_no");
		
	 // echo $max_approved_no.'_'.$cause_approved_no.'_'.$unappv_req;
	 if(count($up_nameArray_request)>0 && $max_approved_no!=$cause_approved_no)
	{ 
		$unappv_req='';$button_chk=0;
	}
	else { $unappv_req=$unappv_req;$button_chk=1;}
	


	?>
    <script>

		$( document ).ready(function() {
			//document.getElementById("unappv_request").value='<? //echo str_replace("<br />","\n",$dd[0][csf('approval_cause')]); ?>';
		});

		var permission='<? echo $permission; ?>';

		function fnc_appv_entry(operation)
		{
			var unappv_request = $('#unappv_request').val();

			if (form_validation('unappv_request','Un Approval Request')==false)
			{
				if (unappv_request=='')
				{
					alert("Please write request.");
				}
				return;
			}
			else
			{

				var data="action=save_update_delete_unappv_request&operation="+operation+get_submitted_data_string('unappv_request*wo_id*page_id*user_id',"../../../");
				//alert (data);return;
				freeze_window(operation);
				http.open("POST","partial_fabric_booking_controller.php",true);
				http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
				http.send(data);
				http.onreadystatechange=fnc_appv_entry_Reply_info;
			}
		}

		function fnc_appv_entry_Reply_info()
		{
			if(http.readyState == 4)
			{
				// alert(http.responseText);//return;
				var reponse=trim(http.responseText).split('**');
				show_msg(reponse[0]);

				//set_button_status(1, permission, 'fnc_appv_entry',1);
				set_button_status(1, permission, 'fnc_appv_entry',1);
				document.getElementById('hidden_appv_cause').value=reponse[3];
				parent.emailwindow.hide();
				
				release_freezing();

				//generate_worder_mail(reponse[2],reponse[3],reponse[4],reponse[5]);
			}
		}

		function fnc_close()
		{
			unappv_request= $("#unappv_request").val();

			document.getElementById('hidden_appv_cause').value=unappv_request;

			parent.emailwindow.hide();
		}

    </script>
    <body>
		<div align="center" style="width:100%;">
        <? echo load_freeze_divs ("../../",$permission,1); ?>
        <form name="size_1" id="size_1">
			<fieldset style="width:450px;">
            <table align="center" cellspacing="0" width="450" class="rpt_table" border="1" rules="all" id="size_tbl" >
                <tr id="row_1">
                    <td width="150" align="center" >
                    	<textarea name="unappv_request" id="unappv_request" class="text_area" style="width:430px; height:100px;" maxlength="500" title="Maximum 500 Character" ><? echo str_replace("<br />","\n",$unappv_req); ?></textarea>
                        <Input type="hidden" name="wo_id" class="text_boxes" ID="wo_id" value="<? echo $wo_id; ?>" style="width:30px" />
                        <Input type="hidden" name="page_id" class="text_boxes" ID="page_id" value="<? echo $menu_id; ?>" style="width:30px" />
                        <Input type="hidden" name="user_id" class="text_boxes" ID="user_id" value="<? echo $user_id; ?>" style="width:30px" />
                    </td>
                </tr>
            </table>

            <table align="center" cellspacing="0" width="450" class="rpt_table" border="1" rules="all" id="" >

                <tr>
                    <td align="center" class="button_container">
                        <?
						//print_r ($id_up_all);
                            if(count($up_nameArray_request)>0 && $button_chk==1)
                            {
                                echo load_submit_buttons($permission, "fnc_appv_entry", 1,0,"reset_form('size_1','','','','','');",1);
                            }
                            else
                            {
                                echo load_submit_buttons($permission, "fnc_appv_entry", 0,0,"reset_form('size_1','','','','','');",1);
                            }
                        ?>
                        <input type="hidden" name="hidden_appv_cause" id="hidden_appv_cause" class="text_boxes /">

                    </td>
                </tr>
                <tr>
                    <td align="center">
                        <input type="button" name="close" class="formbutton" value="Close" id="main_close" onClick="fnc_close();" style="width:100px" />
                    </td>
                </tr>
            </table>
            </fieldset>
            </form>
              <? //fabric_booking_approval_cause
			// $sqlHis="select approval_cause from fabric_booking_approval_cause where entry_form=7 and booking_id='$wo_id' and approval_type=2 and status_active=1 and is_deleted=0 order by id Desc";
			 $sqlHis="select approval_cause from approval_cause_refusing_his where entry_form=7 and booking_id='$wo_id' and approval_type=2 and status_active=1 and is_deleted=0 order by id Desc";
			$sqlHisRes=sql_select($sqlHis);
			//$sqlHisRes=sql_select($sqlHis);
		?>
		<table align="center" cellspacing="0" width="420" class="rpt_table" border="1" rules="all">
			<thead>
				<th width="30">SL</th>
				<th>Unapproved Request History</th>
			</thead>
		</table>
		<div style="width:420px; overflow-y:scroll; max-height:260px;" align="center">
			<table align="center" cellspacing="0" width="403" class="rpt_table" border="1" rules="all">
			<?
			$i=1;
			foreach($sqlHisRes as $hrow)
			{
				if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
				?>
				<tr bgcolor="<?=$bgcolor; ?>" onClick="change_color('tr_<?=$i; ?>','<?=$bgcolor; ?>');">
					<td width="30"><?=$i; ?></td>
					<td style="word-break:break-all"><?=$hrow[csf('approval_cause')]; ?></td>
				</tr>
				<?
				$i++;
			}
			?>
			</table>
		</div>
        </div>
      
        
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
	exit();
}


if ($action=="save_update_delete_unappv_request")
{

	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));


	//echo "shajjad_".$unappv_request.'_'.$wo_id.'_'.$page_id.'_'.$user_id; die;
	
	//=============Issue Id=29451 for  Urmi=====================
	
	$approved_no=return_field_value("MAX(approved_no) as approved_no","approval_history","entry_form=7 and mst_id=$wo_id","approved_no");
	//echo "10**select approval_cause from approval_cause_refusing_his where approval_cause='".str_replace("'", "", $unappv_request)."' and entry_form=12 and booking_id='".str_replace("'", "", $wo_id)."' and approval_type=2 and status_active=1 and is_deleted=0"; die;
	$flag=1;
	/*if(is_duplicate_field( "approval_cause", "approval_cause_refusing_his", "approval_cause='".str_replace("'", "", $unappv_request)."' and entry_form=7 and booking_id='".str_replace("'", "", $wo_id)."' and approval_type=2 and status_active=1 and is_deleted=0" )==1)
	{
		//
	}
	else
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		//$id_his=return_next_id( "id", "approval_cause_refusing_his", 1);
		$idpre=return_field_value("max(id) as id", "fabric_booking_approval_cause", "booking_id=".$wo_id." and entry_form=7 and approval_type=2 group by booking_id","id");
		$sqlHis="insert into approval_cause_refusing_his( id, cause_id, page_id, entry_form, user_id, booking_id, approval_type, approval_no, approval_history_id, approval_cause, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, not_approval_cause)
			select '', id, page_id, entry_form, user_id, booking_id, approval_type, approval_no, approval_history_id, approval_cause, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, not_approval_cause from fabric_booking_approval_cause where booking_id=".$wo_id." and approval_type=2 and entry_form=7 and id ='$idpre'";
		
		if(count($sqlHis)>0)
		{
			$rID3=execute_query($sqlHis,0);
			if($flag==1)
			{
				if($rID3==1) $flag=1; else $flag=0;
			}
		}
	}*/
	

	if ($operation==0)  // Insert Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		$approved_no=return_field_value("MAX(approved_no) as approved_no","approval_history","entry_form=7 and mst_id=$wo_id","approved_no");

		$unapproved_request=return_field_value("id","fabric_booking_approval_cause","page_id=$page_id and entry_form=7 and user_id=$user_id and booking_id=$wo_id and approval_type=2 and approval_no=$approved_no");

		if($unapproved_request=="")
		{
			$textToStore = nl2br(htmlentities(str_replace("'","",$unappv_request), ENT_QUOTES, 'UTF-8'));

			$id_mst=return_next_id( "id", "fabric_booking_approval_cause", 1 ) ;

			$field_array="id,page_id,entry_form,user_id,booking_id,approval_type,approval_no,approval_cause,inserted_by,insert_date,status_active,is_deleted";
			$data_array="(".$id_mst.",".$page_id.",7,".$user_id.",".$wo_id." ,2,".$approved_no.",'".$textToStore."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
			$rID=sql_insert("fabric_booking_approval_cause",$field_array,$data_array,0);
			//echo $rID; die;

			if($db_type==0)
			{
				if($rID )
				{
					mysql_query("COMMIT");
					echo "0**".$rID."**".str_replace("'","",$wo_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					mysql_query("ROLLBACK");
					echo "10**".$rID;
				}
			}
			if($db_type==2)
			{
				if($rID )
				{
					oci_commit($con);
					echo "0**".$rID."**".str_replace("'","",$wo_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					oci_rollback($con);
					echo "10**".$rID;
				}
			}
			if($db_type==1 )
			{

				echo "0**".$rID."**".$wo_id;
			}
			disconnect($con);
			die;
		}
		else
		{
			$con = connect();
			if($db_type==0)
			{
				mysql_query("BEGIN");
			}
			$update_id=return_field_value("max(id) as id", "fabric_booking_approval_cause", "booking_id=".$wo_id." and entry_form=7 and approval_type=2 group by booking_id","id");

			$field_array="page_id*entry_form*user_id*booking_id*approval_type*approval_no*approval_cause*updated_by*update_date*status_active*is_deleted";
			$data_array="".$page_id."*7*".$user_id."*".$wo_id."*2*".$approved_no."*".$unappv_request."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*1*0";

			 $rID=sql_update("fabric_booking_approval_cause",$field_array,$data_array,"id","".$update_id."",0);

			if($db_type==0)
			{
				if($rID )
				{
					mysql_query("COMMIT");
					echo "1**".$rID."**".str_replace("'","",$wo_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					mysql_query("ROLLBACK");
					echo "10**".$rID;
				}
			}
			else if($db_type==2)
			{
				if($rID )
				{
					oci_commit($con);
					echo "1**".$rID."**".str_replace("'","",$wo_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					oci_rollback($con);
					echo "10**".$rID;
				}
			}
			if($db_type==1 )
			{
				echo "1**".$rID."**".str_replace("'","",$wo_id);
			}
			disconnect($con);
			die;
		}
	}
	if ($operation==1)  // Update Here
	{
			$con = connect();
			if($db_type==0)
			{
				mysql_query("BEGIN");
			}
			$update_id=return_field_value("max(id) as id", "fabric_booking_approval_cause", "booking_id=".$wo_id." and entry_form=7 and approval_type=2 group by booking_id","id");

			$field_array="page_id*entry_form*user_id*booking_id*approval_type*approval_no*approval_cause*updated_by*update_date*status_active*is_deleted";
			$data_array="".$page_id."*7*".$user_id."*".$wo_id."*2*".$approved_no."*".$unappv_request."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*1*0";

			 $rID=sql_update("fabric_booking_approval_cause",$field_array,$data_array,"id","".$update_id."",0);

			if($db_type==0)
			{
				if($rID )
				{
					mysql_query("COMMIT");
					echo "1**".$rID."**".str_replace("'","",$wo_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					mysql_query("ROLLBACK");
					echo "10**".$rID;
				}
			}

			if($db_type==2)
			{
				if($rID )
				{
					oci_commit($con);
					echo "1**".$rID."**".str_replace("'","",$wo_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					oci_rollback($con);
					echo "10**".$rID;
				}
			}
			if($db_type==1 )
			{
				echo "1**".$rID."**".str_replace("'","",$wo_id);
			}
			disconnect($con);
			die;
	}
}
if ($action=="save_update_delete_unappv_request_not")
{

	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));


	//echo "shajjad_".$unappv_request.'_'.$wo_id.'_'.$page_id.'_'.$user_id; die;

	if ($operation==0)  // Insert Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		$approved_no=return_field_value("MAX(approved_no)","approval_history","entry_form=7 and mst_id=$wo_id");

		$unapproved_request=return_field_value("id","fabric_booking_approval_cause","page_id=$page_id and entry_form=7 and user_id=$user_id and booking_id=$wo_id and approval_type=2 and approval_no=$approved_no");

		if($unapproved_request=="")
		{
			$textToStore = nl2br(htmlentities(str_replace("'","",$unappv_request), ENT_QUOTES, 'UTF-8'));

			$id_mst=return_next_id( "id", "fabric_booking_approval_cause", 1 ) ;

			$field_array="id,page_id,entry_form,user_id,booking_id,approval_type,approval_no,approval_cause,inserted_by,insert_date,status_active,is_deleted";
			$data_array="(".$id_mst.",".$page_id.",7,".$user_id.",".$wo_id." ,2,".$approved_no.",'".$textToStore."',".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
			$rID=sql_insert("fabric_booking_approval_cause",$field_array,$data_array,0);
			//echo $rID; die;

			if($db_type==0)
			{
				if($rID )
				{
					mysql_query("COMMIT");
					echo "0**".$rID."**".str_replace("'","",$wo_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					mysql_query("ROLLBACK");
					echo "10**".$rID;
				}
			}
			if($db_type==2)
			{
				if($rID )
				{
					oci_commit($con);
					echo "0**".$rID."**".str_replace("'","",$wo_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					oci_rollback($con);
					echo "10**".$rID;
				}
			}
			if($db_type==1 )
			{

				echo "0**".$rID."**".$wo_id;
			}
			disconnect($con);
			die;
		}
		else
		{
			$con = connect();
			if($db_type==0)
			{
				mysql_query("BEGIN");
			}

			$field_array="page_id*entry_form*user_id*booking_id*approval_type*approval_no*approval_cause*updated_by*update_date*status_active*is_deleted";
			$data_array="".$page_id."*7*".$user_id."*".$wo_id."*2*".$approved_no."*".$unappv_request."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*1*0";

			 $rID=sql_update("fabric_booking_approval_cause",$field_array,$data_array,"id","".$unapproved_request."",0);

			if($db_type==0)
			{
				if($rID )
				{
					mysql_query("COMMIT");
					echo "1**".$rID."**".str_replace("'","",$wo_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					mysql_query("ROLLBACK");
					echo "10**".$rID;
				}
			}

			if($db_type==2)
			{
				if($rID )
				{
					oci_commit($con);
					echo "1**".$rID."**".str_replace("'","",$wo_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					oci_rollback($con);
					echo "10**".$rID;
				}
			}
			if($db_type==1 )
			{
				echo "1**".$rID."**".str_replace("'","",$wo_id);
			}
			disconnect($con);
			die;
		}
	}
	if ($operation==1)  // Update Here
	{
	}
}

if($action=="print_booking_5") //Aziz->>> 22-11-17
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$path=str_replace("'","",$path);
	if($path!="") $path=$path; else $path="../../";

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' or form_name='knit_order_entry' and file_type=1",'master_tble_id','image_location');
	$company_library=return_library_array( "select id,company_name from lib_company where status_active=1 and is_deleted=0", "id", "company_name");
	$color_library=return_library_array( "select id,color_name from lib_color ", "id", "color_name");
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier  where status_active=1 and is_deleted=0",'id','supplier_name');
	$supplier_address_arr=return_library_array( "select id,address_1 from   lib_supplier  where status_active=1 and is_deleted=0",'id','address_1');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info  where status_active=1 and is_deleted=0","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer  where status_active=1 and is_deleted=0",'id','buyer_name');
	$nameArray_approved=sql_select( "select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and a.status_active =1 and a.is_deleted=0");
	list($nameArray_approved_row)=$nameArray_approved;

	$job_po_arr=array();
	$ref_no='';$job_no_aarr='';
	$nameArray_per_job=sql_select( "select  a.job_no,a.style_ref_no,b.po_break_down_id,c.po_number,c.grouping  from wo_po_details_master a, wo_booking_dtls b, wo_po_break_down c where c.id=b.po_break_down_id and a.job_no=b.job_no and  a.job_no=c.job_no_mst and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by a.job_no,a.style_ref_no,b.po_break_down_id,c.grouping,c.po_number");
	foreach ($nameArray_per_job as $row_per_job){
	$job_no_aarr.="'".$row_per_job[csf('job_no')]."'".',';
	$job_po_arr[$row_per_job[csf('job_no')]].=$row_per_job[csf('po_number')].',';
	if($ref_no=='') $ref_no=$row_per_job[csf('grouping')]; else $ref_no.=",".$row_per_job[csf('grouping')];

	}
	$job_nos=rtrim($job_no_aarr,',');
	$job_nos=implode(",",array_unique(explode(",",$job_nos)));
	//$ref_no=$ref_no;
	$ref_nos=implode(",",array_unique(explode(",",$ref_no)));
	//$job_nos=explode(",",$job_nos);
	//print_r($job_no_aarr);
	$job_data_arr=array();
	$nameArray_buyer=sql_select( "select  a.style_ref_no,a.style_description, a.job_no, a.style_owner, a.buyer_name, a.dealing_marchant,a.season,a.season_matrix,a.total_set_qnty,a.product_dept,a.product_code,a.pro_sub_dep,a.gmts_item_id ,a.order_repeat_no,a.qlty_label  from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0 and a.job_no in(".$job_nos.") order by a.job_no ");
	foreach ($nameArray_buyer as $result_buy){
	$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
	$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
	$dealing_marchant.=$marchentrArr[$result_buy[csf('dealing_marchant')]].',';
 	}

  //print_r($job_data_arr);
	$dealing_marchant=rtrim($dealing_marchant,',');
	$dealing_marchants=implode(",",array_unique(explode(",",$dealing_marchant)));
	//$dealing_marchants=implode(",",array_unique($job_data_arr['dealing_marchant']));
	$nameArray=sql_select( "select a.buyer_id,a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.fabric_source,a.remarks,a.pay_mode,a.fabric_composition from wo_booking_mst a   where  a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0");
	foreach ($nameArray as $result_job){
		$booking_date=$result_job[csf('booking_date')];
		$buyer_id=$result_job[csf('buyer_id')];
		$currency_id=$result_job[csf('currency_id')];
		$attention=$result_job[csf('attention')];
		$delivery_date=$result_job[csf('delivery_date')];
		$supplier_id=$result_job[csf('supplier_id')];
		$remarks=$result_job[csf('remarks')];
		$pay_mode=$result_job[csf('pay_mode')];
	}
	//echo $booking_date.'ddd';
	ob_start();
	?>
    <style>

	@media print
	{
	     .page-break { height:0; page-break-before:always; margin:0; border-top:none; }
	}
     body, p, span, td, a {font-size:10pt;font-family: Arial;}
     body{margin-left:2em; margin-right:2em; font-family: "Arial Narrow", Arial, sans-serif;}
	</style>
	<div style="width:1310px" align="center">
	<table width="100%" cellpadding="0" cellspacing="0" style="border:0px solid black" >
	<tr>
	<td width="100">
	<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
	</td>
	<td width="1250">
	<table width="100%" cellpadding="0" cellspacing="0"  border="0" >
	<tr>
	<td align="center">
		<h3>
	<?php
	echo $company_library[$cbo_company_name];
	?>
	</h3>
	</td>
	<td rowspan="3" width="250">
	<span><b> Booking No:&nbsp;&nbsp;<? echo trim($txt_booking_no,"'"); ?></b></span><br/>
    <span><b> Booking Date :&nbsp;&nbsp;<? echo change_date_format($booking_date); ?></b></span><br/>
	<?
	if($nameArray_approved_row[csf('approved_no')]>1)
	{
	?>
	<b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
	<br/>
	Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
	<?
	}
	?>
	</td>
	</tr>
	<tr>
	<td align="center">
	<?
			$country_full_name = return_library_array("SELECT id,country_name from lib_country", "id", "country_name");
			$sqlCom="select company_name, email, website, plot_no, level_no, road_no, block_no, country_id, province, city, zip_code, contact_no from lib_company where id='$cbo_company_name' and status_active=1 and is_deleted=0";
			$sqlComRes=sql_select($sqlCom);
			$comName=$comAdd=$comPhone=$comPax=$comEmail=$comWeb=""; $consigneeDtls="";
			foreach( $sqlComRes as $row)
			{
				$comName=$row[csf("company_name")];
				
				if($row[csf("level_no")])		$level_no 	= $row[csf("level_no")].', ';
				if($row[csf("plot_no")])		$plot_no 	=$row[csf("plot_no")].', ';
				if($row[csf("road_no")]) 		$road_no 	=$row[csf("road_no")].', ';
				if($row[csf("block_no")]!='')	$block_no 	=$row[csf("block_no")].', ';
				if($row[csf("zip_code")]!='')	$zip_code 	= ' -'.$row[csf("zip_code")].' , ';
				if($row[csf("city")]!='') 		$city 		= ($zip_code!="")?$row[csf("city")]:$row[csf("city")]." ,";
				if($row[csf("country_id")]!='')	$country 	= $country_full_name[$row[csf("country_id")]].'.,';
				
				$comAdd="Level No-".$level_no."Plot No-".$plot_no."Road No-".$road_no."Block No-".$block_no.$city.$zip_code.$country.$row[csf("email")].",".$row[csf("website")];
				$comPhone=$row[csf("contact_no")];
				$comEmail=$row[csf("email")];
				$comWeb=$row[csf("website")];
			}

			echo $comAdd;
	?>
	</td>
	</tr>
	<tr>
	<td align="center">
	<strong><? if($report_title !=""){ echo $report_title.'-'.$fabric_source[$cbo_fabric_source];}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
	</td>
	</tr>
	</table>
	</td>
	</tr>
    </table>
    <table width="100%" style="border:0px solid black;table-layout: fixed;" >
	<tr>
	<td width="200"><span><b>To </b></span></td>
	<td width="280">&nbsp;<span></span></td>
	<td width="200"><span><b>Buyer</b></span></td>
    <td width="230"><span> :&nbsp;<b><? echo $buyer_name_arr[$buyer_id]; ?></b></span></td>
	</tr>
	<tr>
	<td width="200"><b>Supplier Name</b>   </td>
	<td width="280">:&nbsp;
	<?
	if($pay_mode==5 || $pay_mode==3){
	echo $company_library[$supplier_id];
	$suplier_address=$city.','.$email;
	}
	else{
	echo $supplier_name_arr[$supplier_id];
	$suplier_address=$supplier_address_arr[$supplier_id];
	}
	?>    </td>
	<td width="200"><b>Dealing Marchant</b></td>
	<td width="" colspan="2">:&nbsp;<? echo $dealing_marchants;?></td>
	</tr>
	<tr>
	<td width="200"><b>Address</b></td>
	<td width="280">:&nbsp;<? echo $suplier_address; ?></td>
	<td width="200"><b>Currency </b>   </td>
	<td width="230">:&nbsp;
	<?
	echo $currency[$currency_id];
	?>
	</td>
    <tr>
	<td width="200"><b>Attention</b></td>
	<td  width="280">:&nbsp;<? echo $attention; ?></td>
	<td width="200"><b>Internal Ref. No </b>   </td>
	<td colspan="2">:&nbsp;
	<?
	echo $ref_nos;
	?>
	</td>
	</tr>
	<tr>
	<td width="200"><b>Delivery Date</b></td>
	<td width="280">:&nbsp;<? echo change_date_format($delivery_date); ?></td>
	<td><b></b></td>
	<td>&nbsp;<? //echo $order_repeat_no; ?></td>
	</tr>
	<tr>
	<td width="200"><b>Remark</b></td>
	<td> :<? echo $remarks;?></td>
	
	<td width="200"><b>Fabric Nature </b>   </td>
	<td width="230">:&nbsp;<?=$item_category[$cbo_fabric_natu]; ?>	</td>
	<td><b></b></td>
	<td>&nbsp;<? //echo $order_repeat_no; ?></td>
	</tr>
	</table>
    <?
	//echo "select  a.job_no,a.body_part_id,b.color_number_id,avg(b.process_loss_percent) as loss FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls  b 	WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and  a.job_no in(".$job_nos.")  group by a.job_no,a.body_part_id,b.color_number_id";
	$color_wise_process_loss=sql_select("select  a.id, a.job_no,a.body_part_id,b.color_number_id,a.process_loss_method,b.process_loss_percent as loss FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls  b 	WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and  a.job_no in(".$job_nos.") and b.process_loss_percent>0 group by a.id, a.job_no,a.body_part_id,a.process_loss_method,b.color_number_id,b.process_loss_percent");
	foreach($color_wise_process_loss as $val)
	{
		$loss_arr[$val[csf("id")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['loss']=$val[csf("loss")];
		$loss_arr[$val[csf("id")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['loss_method']=$val[csf("process_loss_method")];
	}
	if($job_nos!='')
	{
		$lab_dip=sql_select("select  b.job_no,a.labtest_no FROM wo_labtest_mst a, wo_labtest_dtls  b WHERE a.id=b.mst_id and b.job_no in(".$job_nos.") ");
		foreach($lab_dip as $row)
		{
			$lab_dip_arr[$row[csf("job_no")]]['labtest_no']=$row[csf("labtest_no")];

		}
	}
	//wo_labtest_mst
   $sql_booking="select  a.job_no,a.id as fabric_cost_dtls_id, a.body_part_id,a.color_type_id as c_type, a.construction, a.composition, a.gsm_weight as gsm, d.dia_width as dia,a.uom,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,avg(d.rate) as rates,sum(d.amount) as amounts ,d.remark,c.style_ref_no,c.job_no_prefix_num,d.fabric_color_id as fab_color,d.gmts_color_id as gmt_color
	FROM wo_pre_cost_fabric_cost_dtls a,  wo_booking_dtls d,wo_po_details_master c
	WHERE   a.job_no=d.job_no and a.id=d.pre_cost_fabric_cost_dtls_id  and a.job_no=c.job_no  and d.job_no=c.job_no
	and d.booking_no =$txt_booking_no and d.job_no in(".$job_nos.") and d.status_active=1 and d.is_deleted=0
	group by  a.job_no,a.id, a.body_part_id,a.color_type_id, a.construction, a.composition,d.fabric_color_id,d.gmts_color_id, a.gsm_weight, d.dia_width,a.uom,c.style_ref_no,c.job_no_prefix_num,d.remark order by a.job_no,d.fabric_color_id ";
	//echo $sql_booking;die;
	 $result_set=sql_select($sql_booking);
	 foreach( $result_set as $row)
	 {
		$body_part_id=$body_part[$row[csf("body_part_id")]];
		$uom_data_arr[$row[csf("uom")]]=$unit_of_measurement[$row[csf("uom")]];
		$construction=$row[csf("construction")];
		$compositions= $row[csf("composition")];
		$item_desc=$body_part_id.','.$row[csf("construction")].','.$compositions;
		/*$process_loss=$loss_arr[$row[csf("job_no")]][$row[csf("body_part_id")]][$row[csf("fab_color")]]['loss'];
		$process_loss_method=$loss_arr[$row[csf("job_no")]][$row[csf("body_part_id")]][$row[csf("fab_color")]]['loss_method'];*/

		$process_loss=$loss_arr[$row[csf("fabric_cost_dtls_id")]][$row[csf("job_no")]][$row[csf("body_part_id")]][$row[csf("gmt_color")]]['loss'];
		$process_loss_method=$loss_arr[$row[csf("fabric_cost_dtls_id")]][$row[csf("job_no")]][$row[csf("body_part_id")]][$row[csf("gmt_color")]]['loss_method'];
		if($process_loss=='') $process_loss=0;else $process_loss=$process_loss;
		if($process_loss_method=='') $process_loss_method=0;else $process_loss_method=$process_loss_method;

		$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['uom']=$row[csf("uom")];
		$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['style_ref_no']=$row[csf("style_ref_no")];
		$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['job_prefix']=$row[csf("job_no_prefix_num")];
		$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['style_ref_no']=$row[csf("style_ref_no")];

		$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['fin_qty']+=$row[csf("fin_fab_qntys")];
		$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['grey_qty']+=$row[csf("grey_fab_qntys")];
		$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['amounts']+=$row[csf("amounts")];
		$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['rates']=$row[csf("rates")];
		$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['p_loss']=$process_loss;
		$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['p_loss_method']=$process_loss_method;
		$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['remark']=$row[csf("remark")];
	 }
	 //print_r($uom_data_arr);
	 $fab_row_span_arr=array();
	foreach($fabric_detail_arr as $job_key=>$job_data)
	{
		$desc_rowspan=0;
		foreach($job_data as $desc_key=>$desc_data)
		{
			foreach($desc_data as $gsm_key=>$gsm_data)
			{
				foreach($gsm_data as $dia_key=>$dia_data)
				{
					foreach($dia_data as $c_type_key=>$color_data)
					{
						foreach($color_data as $gmt_color_key=>$gmt_color_data)
						{
							foreach($gmt_color_data as $fab_color_key=>$val)
							{
								$desc_rowspan++;
							}
							$fab_row_span_arr[$job_key]=$desc_rowspan;
						}
					}
				}
			}
		}
	}
	foreach($uom_data_arr as $uom_id=>$uom_val)
	{
	?>
    <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
	<caption> <strong><? //echo $uom_val;?></strong> </caption>
	<tr>
        <th  width="30" align="center">SL</th>
        <th  width="70" align="center">Job No</th>
        <th  width="120" align="center">Style Ref</th>
        <th  width="120" align="center">Order No</th>
        <th  width="300" align="center">Item Description</th>
        <th  width="50" align="center">GSM</th>
        <th  width="60" align="center">Fabric Dia</th>
        <th  width="80" align="center">Color Type</th>
        <th  width="100" align="center">Gmts Color</th>
        <th  width="100" align="center">Fabric Color</th>
        <th  width="120" align="center">Lab Dip No</th>
        <th  width="50" align="center">UOM</th>
        <th width='100' align="center">Finish Fab. Qty</th>
        <th width='100' align="center">Grey Fab. Qty</th>
		<?php
		if($show_yarn_rate==1){?>
        <th width='80' align="center">Avg Rate</th>
        <th width='100' align="center">Amount</th>
		<? }?>
        <th width='200' align="center">Remark</th>
	</tr>
   <?
	// print_r($body_rowspan_arr);
	$k=$p=1;$total_fin_qty=$total_grey_qty=$total_amount=0;
	foreach($fabric_detail_arr as $job_key=>$job_data)
	{
		$y=1;
		foreach($job_data as $desc_key=>$desc_data)
		{
			foreach($desc_data as $gsm_key=>$gsm_data)
			{
				foreach($gsm_data as $dia_key=>$dia_data)
				{
					foreach($dia_data as $c_type_key=>$color_data)
					{
						foreach($color_data as $gmt_color_key=>$gmt_color_data)
						{
							foreach($gmt_color_data as $fab_color_key=>$val)
							{
								$po_nos=rtrim($job_po_arr[$job_key],',');
								$po_nos=implode(",",array_unique(explode(",",$po_nos)));
								$fab_row_span=$fab_row_span_arr[$job_key];
								$p_loss_method=$val['p_loss_method'];
								$process_loss=$val['p_loss'];
								$labtest_no=$lab_dip_arr[$job_key]['labtest_no'];
								if($process_loss) $process_loss=$process_loss;else $process_loss=0;
								//echo $process_loss.'d';
								if($p_loss_method==1) //markup
								{

									$fin_qty=$val['fin_qty']-(($val['fin_qty']*$process_loss)/(100+$process_loss));
								}
								else if($p_loss_method==2) //margin
								{
									$fin_qty=$val['fin_qty']-(($val['fin_qty']*$process_loss)/100);
								}
								else $fin_qty=$val['fin_qty'];
								if($uom_id==$val['uom'])
								{
								?>
								<tr>
									<?
                                    if($y==1)
									{
									?>
									<td width="30"  rowspan="<? echo $fab_row_span;?>"><? echo $p; ?></td>
									<td width="70" align="center" rowspan="<? echo $fab_row_span;?>"><p><? echo $val['job_prefix']; ?>&nbsp;</p></td>
									<td width="120" rowspan="<? echo $fab_row_span;?>"><p><? echo $val['style_ref_no']; ?>&nbsp;</p></td>
									<td  style="word-break:break-all;word-wrap: break-word;" width="120" rowspan="<? echo $fab_row_span;?>"><p><? echo $po_nos; ?>&nbsp;</p></td>
                                    <?
									}
									?>
									<td width="300"><p><? echo $desc_key; ?>&nbsp;</p></td>
									<td width="50"><p><? echo $gsm_key; ?>&nbsp;</p></td>
									<td width="60"><p><? echo $dia_key; ?>&nbsp;</p></td>
									<td width="80"><p><? echo $color_type[$c_type_key]; ?>&nbsp;</p></td>
									<td width="100"><p><? echo $color_library[$gmt_color_key]; ?>&nbsp;</p></td>
									<td width="100"><p><? echo $color_library[$fab_color_key]; ?>&nbsp;</p></td>
                                    <td width="120"><p><? echo $labtest_no; ?>&nbsp;</p></td>
									<td width="50"><p><? echo $unit_of_measurement[$val['uom']]; ?>&nbsp;</p></td>
									<td width="100" align="right" title="(Markup/Margin Method) Process Loss=<? echo $process_loss;?>,Fin Qty=<? echo $val['fin_qty'];?>"><p><? echo number_format($fin_qty,2); ?>&nbsp;</p></td>
									<td width="100" align="right"><p><? echo number_format($val['grey_qty'],2); ?>&nbsp;</p></td>
									<?php
										if($show_yarn_rate==1){?>
									<td width="80" align="right"><p><? echo number_format($val['rates'],4); ?>&nbsp;</p></td>
									<td width="100" align="right"><p><? echo number_format($val['amounts'],4); ?>&nbsp;</p></td>
									<? }?>
									<td width="200"><p><? echo $val['remark']; ?>&nbsp;</p></td>
								</tr>
								<?
								$k++;$y++;
								$total_fin_qty+=$fin_qty;
								$total_grey_qty+=$val['grey_qty'];
								$total_amount+=$val['amounts'];
								}
							}
						}
					}
				}
			}
		}
		$p++;
	}
	?>
                            <tfoot>
                            <tr>
                            <th colspan="12" align="right"> Total </th>
                             <th align="right"> <? echo number_format($total_fin_qty,2); ?> </th>
                             <th align="right"> <? echo number_format($total_grey_qty,2); ?> </th>
							 <?php
								if($show_yarn_rate==1){?>
                             <th align="right"> <? //echo number_format($total_fin_qty,2); ?> </th>
                             <th align="right"> <? echo number_format($total_amount,4); ?> </th>
							 <? }?>
                            </tr>
                            </tfoot>
                            </table>
                            <?
	}
							$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count");
							if($job_nos!='')
							{
								$condition= new condition();
								if(str_replace("'","",$job_nos) !=''){
								$condition->job_no("in($job_nos)");
								}
								//".$job_nos."
								$condition->init();
								$yarn= new yarn($condition);
								//echo $yarn->getQuery(); die;
								$yarn_type_qty_arr=$yarn->getCountCompositionAndTypeWiseYarnQtyArray();
							}
							//print_r($yarn_type_qty_arr);
							$sql_yarn="select c.count_id,c.copm_one_id,c.percent_one,c.type_id,c.cons_qnty from wo_pre_cost_fab_yarn_cost_dtls c where c.job_no in(".$job_nos.") and c.status_active=1 ";
							$result_yarn=sql_select($sql_yarn);
							foreach($result_yarn as $row)
							{
								$yarn_data_arr[$row[csf('count_id')]][$row[csf('copm_one_id')]][$row[csf('type_id')]]['cons_qnty']+=$row[csf('cons_qnty')];
								$yarn_data_arr[$row[csf('count_id')]][$row[csf('copm_one_id')]][$row[csf('type_id')]]['percent_one']=$row[csf('percent_one')];
							}

							if($cbo_fabric_source!=2){

							



							?>
                        <table class="rpt_table" width="70%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
                        <caption> <strong>Yarn Information</strong> </caption>

                            <tr>
                                <th  width="30" align="center">SL</th>
                                <th  width="100" align="center">Count</th>
                                <th  width="100" align="center">Composite</th>
                                <th  width="100" align="center">Type</th>
                                <th  width="100" align="center">Qty</th>
                            </tr>


                        <?
						$k=1;$total_req_qty=0;
                        foreach($yarn_data_arr as $count=>$count_data)
						{
							 foreach($count_data as $composition_ids=>$comp_data)
							{
								 foreach($comp_data as $type_id=>$val)
								{

									$cons_qnty=$yarn_type_qty_arr[$count][$composition_ids][$val['percent_one']][$type_id];
						?>
                        <tr>
                            <td width="30"><p><? echo $k; ?>&nbsp;</p></td>
                            <td width="100"><p><? echo $lib_yarn_count[$count]; ?>&nbsp;</p></td>
                            <td width="100"><p><? echo $composition[$composition_ids].' '.$val['percent_one'].'%'; ?>&nbsp;</p></td>
                             <td width="100"><p><? echo $yarn_type[$type_id]; ?>&nbsp;</p></td>
                            <td width="100" align="right"><p><? echo number_format($cons_qnty,2); ?>&nbsp;</p></td>
                        </tr>
                        <?
								}
							}
							$k++;
							$total_req_qty+=$cons_qnty;
						}
						?>


						<tr>
							<th align="right" colspan="4">Total </th>
							<th  align="right"><p><?  echo number_format($total_req_qty,2); ?>&nbsp;</p></th>
						</tr>

                        </table>
                            <br>
						   <?
							}
                              echo signature_table(121, $cbo_company_name, "1000px");
                           ?>

	</div>
    <?
	
	$html = ob_get_contents();
	ob_clean();
	list($is_mail_send,$mail)=explode('___',$mail_send_data);

	if($is_mail_send==1){
		require_once('../../../mailer/class.phpmailer.php');
		require_once('../../../auto_mail/setting/mail_setting.php');
		$mailBody = preg_replace("/<img[^>]+\>/i", " ", $html); 
		$mailBody="<br>".$mail_body	;	
		$mailToArr=array();
		$mailSql = "select b.EMAIL  from wo_booking_mst a,LIB_SUPPLIER b where b.id=a.supplier_id and a.booking_no=$txt_booking_no";
	//echo $mailSql;die;
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
		}
		
		
		$mailSql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=99 and b.mail_user_setup_id=c.id  and c.IS_DELETED=0 and c.STATUS_ACTIVE=1";
		//echo $mailSql;die;
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
		}
		if($mail!=''){$mailToArr[]=$mail;}

		$to=implode(',',$mailToArr);
		$subject="Partial fabric booking";
		$header=mailHeader();
		echo $to;
		echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
		
	}
	else{
		echo $html;
	}
	exit(); 
}

if($action=="print_booking_11 _bk") //Zakaria joy (27-03-22)
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$path=str_replace("'","",$path);
	if($path!="") $path=$path; else $path="../../";

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' or form_name='knit_order_entry' and file_type=1",'master_tble_id','image_location');
	$company_library=return_library_array( "select id,company_name from lib_company where status_active=1 and is_deleted=0", "id", "company_name");
	$color_library=return_library_array( "select id,color_name from lib_color ", "id", "color_name");
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier  where status_active=1 and is_deleted=0",'id','supplier_name');
	$contact_email_arr=return_library_array( "select id,email from   lib_supplier  where status_active=1 and is_deleted=0",'id','email');
	$contact_no_arr=return_library_array( "select id,contact_no from   lib_supplier  where status_active=1 and is_deleted=0",'id','contact_no');
	$supplier_address_arr=return_library_array( "select id,address_1 from   lib_supplier  where status_active=1 and is_deleted=0",'id','address_1');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info  where status_active=1 and is_deleted=0","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer  where status_active=1 and is_deleted=0",'id','buyer_name');
	$nameArray_approved=sql_select( "select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and a.status_active =1 and a.is_deleted=0");

	$data_img=sql_select("select image_location,master_tble_id  from common_photo_library  where   form_name='fabric_color_img' and is_deleted=0 and file_type=1");
	$fabric_composition = return_library_array("select id, fabric_composition_name from  lib_fabric_composition where status_active=1 and is_deleted=0 order by fabric_composition_name", "id", "fabric_composition_name");
	$system_img_arr=array();
	foreach($data_img as $row)
	{
	  $system_img_arr[$row[csf('master_tble_id')]]['img']=$row[csf('image_location')];
	}
	list($nameArray_approved_row)=$nameArray_approved;

	$job_po_arr=array();
	$ref_no='';$job_no_aarr='';
	$nameArray_per_job=sql_select( "select  a.job_no,a.style_ref_no,b.po_break_down_id,c.po_number,c.grouping  from wo_po_details_master a, wo_booking_dtls b, wo_po_break_down c where c.id=b.po_break_down_id and a.job_no=b.job_no and  a.job_no=c.job_no_mst and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by a.job_no,a.style_ref_no,b.po_break_down_id,c.grouping,c.po_number");
	foreach ($nameArray_per_job as $row_per_job)
	{
		$job_no_aarr.="'".$row_per_job[csf('job_no')]."'".',';
		$job_po_arr[$row_per_job[csf('job_no')]].=$row_per_job[csf('po_number')].',';
		if($ref_no=='') $ref_no=$row_per_job[csf('grouping')]; else $ref_no.=",".$row_per_job[csf('grouping')];
		
		$po_data_arr[$row_per_job[csf('po_break_down_id')]]['po_no']=$row_per_job[csf('po_number')];
		$po_data_arr[$row_per_job[csf('po_break_down_id')]]['ref_no']=$row_per_job[csf('grouping')];

	}
	$job_nos=rtrim($job_no_aarr,',');
	$job_nos=implode(",",array_unique(explode(",",$job_nos)));
	//$ref_no=$ref_no;
	$ref_nos=implode(",",array_unique(explode(",",$ref_no)));
	$job_no_mst_cond=where_con_using_array(array_unique(explode(",",$job_nos)),0,"job_no_mst");
	$int_ref_arr=return_library_array( "select job_no_mst,grouping from wo_po_break_down  where status_active=1 and is_deleted=0 $job_no_mst_cond",'job_no_mst','grouping');
	$job_data_arr=array();
	$nameArray_buyer=sql_select( "select  a.style_ref_no,a.style_description, a.job_no, a.style_owner, a.buyer_name, a.dealing_marchant,a.season,a.season_matrix,a.total_set_qnty,a.product_dept,a.product_code,a.pro_sub_dep,a.gmts_item_id ,a.order_repeat_no,a.qlty_label ,b.booking_no,a.ship_mode from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0 and a.job_no in(".$job_nos.") order by a.job_no ");
	
	foreach ($nameArray_buyer as $result_buy)
	{
		$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
		$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
		$dealing_marchant.=$marchentrArr[$result_buy[csf('dealing_marchant')]].',';

			$ship_mode_arr[$result_buy[csf('booking_no')]][$result_buy[csf('ship_mode')]]=$shipment_mode[$result_buy[csf('ship_mode')]];
 	}

  	//print_r($job_data_arr);
	$dealing_marchant=rtrim($dealing_marchant,',');
	$dealing_marchants=implode(",",array_unique(explode(",",$dealing_marchant)));
	//$dealing_marchants=implode(",",array_unique($job_data_arr['dealing_marchant']));
	$nameArray=sql_select( "select a.buyer_id,a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.fabric_source,a.remarks,a.pay_mode,a.fabric_composition,a.ship_mode from wo_booking_mst a   where  a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0");
	//print_r($shipment_mode);
	foreach ($nameArray as $result_job)
	{
		$booking_date=$result_job[csf('booking_date')];
		$buyer_id=$result_job[csf('buyer_id')];
		$currency_id=$result_job[csf('currency_id')];
		$attention=$result_job[csf('attention')];
		$delivery_date=$result_job[csf('delivery_date')];
		$supplier_id=$result_job[csf('supplier_id')];
		$remarks=$result_job[csf('remarks')];
		$paymode=$result_job[csf('pay_mode')];
		$ship_mode=$shipment_mode[$result_job[csf('ship_mode')]];
		if(empty($ship_mode))
		{
			$ship_mode=implode(",",$ship_mode_arr[$result_job[csf('booking_no')]][$result_job[csf('ship_mode')]]);
		}
		
	}
	if($currency_id==1){$paysa_sent="Paisa";} else if($currency_id==2){$paysa_sent="CENTS";}

	?>
    <style>

		@media print
		{
		     .page-break { height:0; page-break-before:always; margin:0; border-top:none; }
		}
	     body, p, span, td, a {font-size:10pt;font-family: Arial;}
	     body{margin-left:2em; margin-right:2em; font-family: "Arial Narrow", Arial, sans-serif;}
	</style>
	<div style="width:1310px" align="center">
		<table width="100%" cellpadding="0" cellspacing="0" style="border:0px solid black" >
			<tr>
				<td width="100">
					<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
				</td>
				<td width="1250">
					<table width="100%" cellpadding="0" cellspacing="0"  border="0" >
						<tr>
							<td align="center"><p><b style="font-size:xx-large">
								<?php
								echo $company_library[$cbo_company_name].'</b>';
								$country_arr=return_library_array( "select id, country_name from lib_country",'id','country_name');
								$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
								if($txt_job_no!="")
								{
									$location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'");
								}
								else
								{
									$location="";
								}
								foreach ($nameArray as $result)
								{
									$email=$result[csf('email')];
									$city=$result[csf('city')];
									//echo  $location_name_arr[$location];
									?> 
								   <br>
									 <? echo $result[csf('plot_no')]."-".$result[csf('level_no')].",".$result[csf('road_no')].",".$result[csf('block_no')]."<br>".$result[csf('city')].",".$result[csf('zip_code')].",".$country_arr[$result[csf('country_id')]]."<br>";?>
									Email Address: <? echo $email;?>
									Website: <? echo $result[csf('website')]; ?>
									<?
								}

								?>
								</p>
							</td>
							<td rowspan="3" width="250">
								<span><b> Booking No:&nbsp;&nbsp;<? echo trim($txt_booking_no,"'"); ?></b></span><br/>
							    <span><b> Booking Date :&nbsp;&nbsp;<? echo change_date_format($booking_date); ?></b></span><br/>
								<?
								if($nameArray_approved_row[csf('approved_no')]>1)
								{
									?>
									<b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
									<br/>
									Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
									<?
								}
								?>
							</td>
						</tr>
						<tr>
							<td align="center">
							<strong><? if($report_title !=""){ echo $report_title;}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
							</td>
						</tr>
						<tr>
							<td align="center">&nbsp;
							
							</td>
						</tr>
					</table>
				</td>
			</tr>
	    </table>
	    <table width="100%" style="border:0px solid black;table-layout: fixed;" >
				<tr>
					<td width="200"><span><b>To </b></span></td>
					<td width="280">&nbsp;<span></span></td>
					<td width="200"><span><b>Buyer</b></span></td>
				    <td width="230"><span> :&nbsp;<? echo $buyer_name_arr[$buyer_id]; ?></span></td>
				</tr>
				<tr>
					<td width="200"><b>To Messers </b>   </td>
					<td width="280">:&nbsp;
					<?
					if($paymode==5 || $paymode==3){
					echo $company_library[$supplier_id];
					$suplier_address=$city.','.$email;
					}
					else{
					echo $supplier_name_arr[$supplier_id];
					$suplier_address=$supplier_address_arr[$supplier_id];
					}
					?>    </td>
					<td width="200"><b>Dealing Marchant</b></td>
					<td width="" colspan="2">:&nbsp;<? echo $dealing_marchants;?></td>
				</tr>
				<tr>
					<td width="200"><b>Address</b></td>
					<td width="280">:&nbsp;<? echo $suplier_address; ?></td>
					<td width="200"><b>Currency </b>   </td>
					<td width="230">:&nbsp;
					<? 
					echo $currency[$currency_id];
					?>
					</td>
				</tr>
				
			    <tr>
					<td width="200"><b>Contact Person</b></td>
					<td  width="280">:&nbsp;<? echo $attention; ?></td>
					<td width="200">Pay Mode </td>
					<td colspan="2">:<?php echo $pay_mode[$paymode]; ?>
					
					</td>
				</tr>
				<tr>
					<td width="200"><b>Email</b></td>
					<td width="280">:&nbsp;<? echo $contact_email_arr[$supplier_id]; ?></td>
					<td width="200"><b>Delivery Date</b></td>
					<td width="280">:&nbsp;<? echo change_date_format($delivery_date); ?></td>
				
				</tr>
				<tr>
				
					<td width="200"><b>Contact No</b></td>
					<td width="280">:&nbsp;<? echo $contact_no_arr[$supplier_id]; ?></td>
					<td><b>Ship Mode</b></td>
					<td>:&nbsp;<?=$ship_mode;?></td>	
				</tr>
				<tr>
					<td width="200"><b>Remark</b></td>
					<td conspan="4"> :<? echo $remarks;?></td>
				</tr>
		</table>
	    <?
	    
		$color_wise_process_loss=sql_select("select  a.id, a.job_no,a.body_part_id,b.color_number_id,a.process_loss_method,b.process_loss_percent as loss FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls  b 	WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and  a.job_no in(".$job_nos.") and b.process_loss_percent>0 group by a.id, a.job_no,a.body_part_id,a.process_loss_method,b.color_number_id,b.process_loss_percent");
		foreach($color_wise_process_loss as $val)
		{
			$loss_arr[$val[csf("id")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['loss']=$val[csf("loss")];
			$loss_arr[$val[csf("id")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['loss_method']=$val[csf("process_loss_method")];
		}
		$sample_booking_arr=array();
		if($job_nos!='')
		{
			$lab_dip=sql_select("select lapdip_no, color_name_id, job_no_mst from wo_po_lapdip_approval_info where job_no_mst in(".$job_nos.") and status_active=1 and is_deleted=0 and approval_status=3");
			foreach($lab_dip as $row)
			{
				$lab_dip_arr[$row[csf("job_no_mst")]]['labtest_no']=$row[csf("lapdip_no")];

			}
			$sample_booking=sql_select("SELECT b.job_no, b.po_break_down_id as po_id, b.pre_cost_fabric_cost_dtls_id, b.fabric_color_id, b.gmts_color_id, b.fin_fab_qnty, c.lib_yarn_count_deter_id as yarn_id from wo_booking_mst a join wo_booking_dtls b on a.id=b.booking_mst_id join wo_pre_cost_fabric_cost_dtls c on c.id = b.pre_cost_fabric_cost_dtls_id where a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and b.booking_type=4 and b.is_short=2 and b.job_no in(".$job_nos.") group by b.job_no, b.po_break_down_id, b.pre_cost_fabric_cost_dtls_id, b.fabric_color_id, b.gmts_color_id, b.fin_fab_qnty, c.lib_yarn_count_deter_id");
			if(count($sample_booking)>0){
				foreach($sample_booking as $row){
					$sample_key=$row[csf('po_id')].'*'.$row[csf('yarn_id')].'*'.$row[csf('fabric_color_id')].'*'.$row[csf('gmts_color_id')];
					$sample_booking_arr[$sample_key]+=$row[csf('fin_fab_qnty')];
				}
				
			}
		}

		$sql_pre="select a.pre_cost_fabric_cost_dtls_id  , a.po_break_down_id  , a.gmts_color_id color_number_id, a.id booking_id, sum(a.fin_fab_qnty) fin_fab_qnty,sum(a.grey_fab_qnty) grey_fab_qnty, a.rate , a.amount  , a.adjust_qty  , a.remark  , a.dia_width  , a.pre_cost_remarks  , a.hs_code,a.gsm_weight,b.job_id,b.lib_yarn_count_deter_id yarn_id,a.color_type,b.body_part_id   from wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b  where a.pre_cost_fabric_cost_dtls_id=b.id   and a.job_no in(".$job_nos.")  and a.booking_no=$txt_booking_no   and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.pre_cost_fabric_cost_dtls_id, a.po_break_down_id,a.gmts_color_id,a.id, a.rate , a.amount  , a.adjust_qty  , a.remark  , a.dia_width  , a.pre_cost_remarks  , a.hs_code,a.gsm_weight,b.job_id,b.lib_yarn_count_deter_id,a.color_type,b.body_part_id  ";
		$sql_pre_data=sql_select($sql_pre);
		foreach($sql_pre_data as $row){
			$main_keys=$row[csf('job_id')].'*'.$row[csf('yarn_id')].'*'.$row[csf('hs_code')];
			$booking_qnty_arr[$main_keys][$row[csf('po_break_down_id')]][$row[csf('gsm_weight')]][$row[csf('color_type')]][$row[csf('color_number_id')]]+=$row[csf('grey_fab_qnty')];
		}


	   $sql_booking="SELECT a.id as job_id, a.job_no_prefix_num, a.job_no,a.gmts_item_id, a.style_ref_no, d.po_break_down_id as po_id,c.body_part_id, c.uom, c.id as fabric_cost_dtls_id, d.color_type, d.construction, d.copmposition,g.itrm_ref, d.gsm_weight, d.dia_width, d.fin_fab_qnty, d.grey_fab_qnty, d.rate,d.amount ,d.remark, d.hs_code,  e.id as yarn_id, e.supplier_reference , e.fabric_composition_id, d.fabric_color_id as fab_color, d.gmts_color_id as gmt_color, f.contrast_color_id, c.color_size_sensitive 
	   from wo_po_details_master a , wo_pre_cost_fabric_cost_dtls c,lib_yarn_count_determina_mst e,wo_pre_cos_fab_co_avg_con_dtls g,wo_booking_dtls d  left join wo_pre_cos_fab_co_color_dtls f on  f.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and  f.gmts_color_id=d.gmts_color_id and f.status_active=1 and f.is_deleted=0  where   
	   a.id=c.job_id  and c.id=d.pre_cost_fabric_cost_dtls_id  and c.id=g.pre_cost_fabric_cost_dtls_id and d.gmts_color_id = g.color_number_id and e.id=c.lib_yarn_count_deter_id  and a.status_active=1 and a.is_deleted=0   and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0  and d.booking_no =$txt_booking_no and a.job_no in(".$job_nos.")   order by a.job_no";


		//echo $sql_booking;die;
		 $result_set=sql_select($sql_booking);
		 foreach($result_set as $row){
			 $main_key=$row[csf('job_id')].'*'.$row[csf('yarn_id')].'*'.$row[csf('hs_code')];
			 $summary_key=$row[csf('fabric_composition_id')].'*'.$row[csf('construction')].'*'.$row[csf('copmposition')];
			 
			 $po_no= $po_data_arr[$row[csf('po_id')]]['po_no'];
			$ref_no=$po_data_arr[$row[csf('po_id')]]['ref_no'];

			 $fabric_detail_arr[$main_key]['job_num']=$row[csf('job_no_prefix_num')];
			 $fabric_detail_arr[$main_key]['job_no']=$row[csf('job_no')];
			 $fabric_detail_arr[$main_key]['item']=$garments_item[$row[csf('gmts_item_id')]];
			 $fabric_detail_arr[$main_key]['hs_code']=$row[csf('hs_code')];
			 $fabric_detail_arr[$main_key]['style_ref_no']=$row[csf('style_ref_no')];
			 $fabric_detail_arr[$main_key]['yarn_id']=$row[csf('yarn_id')];
			 $fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['po_number']=$po_no;
			 $fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['grouping']=$ref_no;
			 $fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['article_no']=$row[csf('supplier_reference')];			 
			 $fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['construction']=$row[csf('construction')];
			 $fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['copmposition']=$row[csf('copmposition')];
			 
			 $fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['gsm_data'][$row[csf('gsm_weight')]]['gsm_weight']=$row[csf('gsm_weight')];
			 $fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['gsm_data'][$row[csf('gsm_weight')]]['dia_width'].=$row[csf('dia_width')].",";
			 $fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['gsm_data'][$row[csf('gsm_weight')]]['colortype_data'][$row[csf('color_type')]]['color_type']=$color_type[$row[csf('color_type')]];
			 $fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['gsm_data'][$row[csf('gsm_weight')]]['colortype_data'][$row[csf('color_type')]]['body_part'][$row[csf('body_part_id')]]=$body_part[$row[csf('body_part_id')]];
			 $fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['gsm_data'][$row[csf('gsm_weight')]]['colortype_data'][$row[csf('color_type')]]['+'][$row[csf('gmt_color')]]['gmt_color']=$row[csf('gmt_color')];
			 $fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['gsm_data'][$row[csf('gsm_weight')]]['colortype_data'][$row[csf('color_type')]]['color_data'][$row[csf('gmt_color')]]['fab_color']=$row[csf('fab_color')];
			 $fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['gsm_data'][$row[csf('gsm_weight')]]['colortype_data'][$row[csf('color_type')]]['color_data'][$row[csf('gmt_color')]]['fab_qty']=$booking_qnty_arr[$main_key][$row[csf('po_id')]][$row[csf('gsm_weight')]][$row[csf('color_type')]][$row[csf('gmt_color')]];
			 $fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['gsm_data'][$row[csf('gsm_weight')]]['colortype_data'][$row[csf('color_type')]]['color_data'][$row[csf('gmt_color')]]['rate']=$row[csf('rate')];
			 $fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['gsm_data'][$row[csf('gsm_weight')]]['colortype_data'][$row[csf('color_type')]]['color_data'][$row[csf('gmt_color')]]['uom']=$row[csf('uom')];
			 $fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['gsm_data'][$row[csf('gsm_weight')]]['colortype_data'][$row[csf('color_type')]]['color_data'][$row[csf('gmt_color')]]['remark']=$row[csf('remark')];
			 $fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['gsm_data'][$row[csf('gsm_weight')]]['colortype_data'][$row[csf('color_type')]]['color_data'][$row[csf('gmt_color')]]['dia_width']=$row[csf('dia_width')];
			 $fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['gsm_data'][$row[csf('gsm_weight')]]['colortype_data'][$row[csf('color_type')]]['color_data'][$row[csf('gmt_color')]]['itrm_ref'].=$row[csf('itrm_ref')].',';
			 $fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['gsm_data'][$row[csf('gsm_weight')]]['colortype_data'][$row[csf('color_type')]]['color_data'][$row[csf('gmt_color')]]['fabric_cost_dtls_id']=$row[csf('fabric_cost_dtls_id')];

			 $fabric_summ_arr[$summary_key]['item']=$fabric_composition[$row[csf('fabric_composition_id')]];
			 $fabric_summ_arr[$summary_key]['construction']=$row[csf('construction')];
			 $fabric_summ_arr[$summary_key]['copmposition']=$row[csf('copmposition')];
			 $fabric_summ_arr[$summary_key]['color_data'][$row[csf('fab_color')]]['fab_color']=$row[csf('fab_color')];
			 $fabric_summ_arr[$summary_key]['color_data'][$row[csf('fab_color')]]['fab_qty']+=$row[csf('fin_fab_qnty')];
			 $fabric_summ_arr[$summary_key]['fab_total_qty']+=$row[csf('fin_fab_qnty')];
		 }
		/*  echo '<pre>';
		 print_r($fabric_detail_arr); die;   */
		?>
		<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
			<caption> <strong><? //echo $uom_val;?></strong> </caption>
			<tr>
				<th  width="30" align="center">SL</th>
				<th  width="70" align="center">Job No</th>
				<th  width="70" align="center">Item</th>
				<th  width="70" align="center">HS Code</th>
				<th  width="100" align="center">Style Ref</th>
				<th  width="100" align="center">Order No</th>
				<th  width="100" align="center">Internal Ref.</th>			
				<th  width="140" align="center">Construction</th>
				<th  width="150" align="center">Composition</th>
				<th  width="50" align="center">GSM</th>					
				<th  width="150" align="center">Body Part</th>
				<th  width="80" align="center">Color Type</th>
				<th  width="60" align="center">Min. CutableWidth</th>		
				<th  width="100" align="center">Gmts Color</th>
				<th  width="100" align="center">Fabric Color</th>
				<th  width="120" align="center">Lab Dip No</th>
				<th  width="90" align="center">Item Ref</th>			
				<th width='100' align="center">Bulk Qty</th>
				<th width='100' align="center">Sample Qty</th>
				<th width='100' align="center" title="Bulk+Sample">Total Qty</th>
				<th  width="50" align="center">Unit</th>
				<th width='80' align="center">Rate</th>
				<th width='100' align="center">Total Value</th>
				<th width='100' align="center">Image</th>
				<th width='200' align="center">Remark</th>
			</tr>
			<?
			$i=1;
			foreach($fabric_detail_arr as $mkey=>$mdata){
				foreach($mdata['po_data'] as $poid=>$podata){
					foreach($podata['gsm_data'] as $gsmid=>$gsmdata){
						foreach($gsmdata['colortype_data'] as $colordataarr)
							foreach($colordataarr['color_data'] as $colordata){
								$jobwisespan[$mkey] +=1;
								$powisespan[$mkey][$poid] +=1;
								$powisegsmspan[$mkey][$gsmid][$poid] +=1;
						}	
					}				
				}
			}
			
			foreach($fabric_detail_arr as $key=>$maindata){
				$mainspan=$jobwisespan[$key];
				$lab_test=$lab_dip_arr[$maindata['job_no']]['labtest_no'];
			?>
				<tr>
					<td rowspan=<?= $mainspan ?>><?= $i  ?></td>
					<td rowspan=<?= $mainspan ?>><?= $maindata['job_num']  ?></td>
					<td rowspan=<?= $mainspan ?>><?= $maindata['item'] ?></td>
					<td rowspan=<?= $mainspan ?>><?= $maindata['hs_code']  ?></td>
					<td rowspan=<?= $mainspan ?>><?= $maindata['style_ref_no']  ?></td>
					<?  
					$z=1;
					foreach($maindata['po_data'] as $poid=>$po_data){
						if($z!=1) echo '<tr>';
						//$pospan=count($po_data['color_data']);
						$pospan=$powisespan[$key][$poid];
						?>
						<td rowspan=<?= $pospan  ?>><?= $po_data['po_number']  ?></td>
						<td rowspan=<?= $pospan  ?>><?= $po_data['grouping']  ?></td>
						<? //if($z==1){ ?>					
						<td rowspan=<?= $pospan  ?>><?= $po_data['construction']  ?></td>
						<td rowspan=<?= $pospan  ?>><?= $po_data['copmposition']  ?></td>
						<?
						$g=1;
						foreach($po_data['gsm_data'] as $gsmid=>$gsm_data){
							if($g!=1) echo '<tr>';
							$gsmspan=$powisegsmspan[$key][$gsmid][$poid];
							//$gsmspan=count($gsm_data['gsm_data']);
							$dia_width_val=implode(",",array_filter(array_unique(explode(",",$gsm_data['dia_width']))));?>
						<td rowspan=<?= $gsmspan  ?>><?= $gsm_data['gsm_weight']  ?></td>					
						<? 
						//}
						$x=1;
						foreach($gsm_data['colortype_data'] as $colortype_data){
							$colorspan=count($colortype_data['color_data']);
							if($x!=1) echo '<tr>';
							?>
							<td rowspan=<?= $colorspan  ?>><?= implode(", ", $colortype_data['body_part'])  ?></td>
							<td rowspan=<?= $colorspan  ?>><?= $colortype_data['color_type']  ?></td>
							
							<?
							$k=1;
							foreach($colortype_data['color_data'] as $color_data){
								$smkey=$poid.'*'.$gsmid.'*'.$maindata['yarn_id'].'*'.$color_data['fab_color'].'*'.$color_data['gmt_color'];
								$sample_qty=$sample_booking_arr[$smkey];
								//$total_qty=ceil($color_data['fab_qty'])+$sample_qty;
								// Plz dont used ceil- page dtls and print not match for it.
								$total_qty=ceil(number_format($color_data['fab_qty']+$sample_qty,4,".",""));
								$total_sample_qty+=$sample_qty;
								$grand_total_qty+=ceil(number_format($total_qty,4,".",""));
								$grand_total_value=$grand_total_value+$total_qty*$color_data['rate'];
								//$total_fin_qty+=ceil($color_data['fab_qty']);
								$total_fin_qty+=ceil(number_format($color_data['fab_qty'],4,".",""));;
								$item_refs=implode(",",array_filter(array_unique(explode(",",$color_data['itrm_ref']))));
								if($k!=1) echo '<tr>';
								?>
								<td align="center" ><?= $color_data['dia_width'] ?></td>
								<td><?= $color_library[$color_data['gmt_color']]  ?></td>
								<td><?= $color_library[$color_data['fab_color']]  ?></td>
								<td><?= $lab_test ?></td>
								<!-- <td align="right"><?= $item_refs ?>if($season_matrix!="") echo $season_matrix; else echo $season_buyer_wise;</td> -->
								<td align="right"><? if($item_refs!="") echo $item_refs; else echo " ";?></td>
								<td align="right"><?= ceil(number_format($color_data['fab_qty'],4,".",""))  ?></td>
								<td align="right"><?= number_format($sample_qty,0) ?></td>
								<td align="right"><?=ceil($total_qty); ?></td>
								<? if($k==1){ ?>
								<td rowspan=<?= $colorspan ?>><?= $unit_of_measurement[$color_data['uom']]  ?></td>
								<? } ?>
								<td align="right"><?= $color_data['rate'] ?></td>
								<td align="right"><?= number_format( $total_qty*$color_data['rate'],4 ) ?></td>
								<td><?
									$img_ref_id=$color_data['fabric_cost_dtls_id'].'_'.$color_data['fab_color'];
									$fab_color_img=$system_img_arr[$img_ref_id]['img'];
									if($fab_color_img !=''){
									?>
								<img src='../../<? echo $fab_color_img; ?>' height='50' width='70' align="middle" />
								<? } ?></td>
								<td><?= $color_data['remark'] ?></td>
								<? 
								$k++;					
							}
							$x++;
						}
						$g++;
					}
						
					$z++;
					} ?>
				</tr>
				<? 
				$i++;
			}
			?>
				<tfoot>
					<tr>
							<th colspan="17" align="right"> Total </th>
							<th align="right"> <? echo $total_fin_qty; ?> </th> 
							<th align="right"> <? echo ceil($total_sample_qty); ?> </th> 
							<th align="right"> <? echo $grand_total_qty; ?> </th>							
							<th align="right"></th>
							<th align="right"></th>
							<th align="right"> <? echo number_format($grand_total_value,2); ?> </th>
							<th align="right"></th>
							<th align="right"></th>
					</tr>
					<tr>
                   <td colspan="25" align="left"><b>In Word: <? echo number_to_words(def_number_format($grand_total_value,2),$currency[$currency_id],$paysa_sent); ?></b></td>
               		</tr>
				</tfoot>
		</table>
		<!-- <table class="rpt_table" width="720"  border="1" cellpadding="0" cellspacing="0" rules="all" style="margin-top: 10px; float:left;">
			<tr><td colspan="6"><strong>Summarry</strong></td></tr>
			<tr>
				<th width="220">Item</th>
				<th width="200">Construction</th>
				<th width="200">Composition</th>
				<th width="80">Fabric Color</th>
				<th width="60">Total Qty</th>
				<th width="60">Grand Total</th>
			</tr>
			<?
				foreach($fabric_summ_arr as $color_data){
					$row_span=count($color_data['color_data']);
					?>
						<tr>
							<td rowspan="<?= $row_span ?>"><?= $color_data['item'] ?></td>
							<td rowspan="<?= $row_span ?>"><?= $color_data['construction'] ?></td>
							<td rowspan="<?= $row_span ?>"><?= $color_data['copmposition'] ?></td>
							<? $sk=1;
							foreach($color_data['color_data'] as $color_dtls){
								if($sk!=1) echo '<tr>';
							?>
								<td><?= $color_library[$color_dtls['fab_color']];  ?></td>								
								<td><?= ceil($color_dtls['fab_qty']);  ?></td>
								<? if($sk==1){ ?>
								<td rowspan="<?= $row_span ?>"><?= ceil($color_data['fab_total_qty'])  ?></td>
								<? } ?>								
							<? $sk++;
							} 
							
							?>
							
						</tr>
					<?
				}
			?>
		</table> -->
	   <?
          echo signature_table(121, $cbo_company_name, "1000px");
       ?>

	</div>
    <?

}

if($action=="print_booking_11") //Zakaria joy (27-03-22)
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$path=str_replace("'","",$path);
	if($path!="") $path=$path; else $path="../../";

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' or form_name='knit_order_entry' and file_type=1",'master_tble_id','image_location');
	$company_library=return_library_array( "select id,company_name from lib_company where status_active=1 and is_deleted=0", "id", "company_name");
	$color_library=return_library_array( "select id,color_name from lib_color ", "id", "color_name");
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier  where status_active=1 and is_deleted=0",'id','supplier_name');
	$contact_email_arr=return_library_array( "select id,email from   lib_supplier  where status_active=1 and is_deleted=0",'id','email');
	$contact_no_arr=return_library_array( "select id,contact_no from   lib_supplier  where status_active=1 and is_deleted=0",'id','contact_no');
	$supplier_address_arr=return_library_array( "select id,address_1 from   lib_supplier  where status_active=1 and is_deleted=0",'id','address_1');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info  where status_active=1 and is_deleted=0","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer  where status_active=1 and is_deleted=0",'id','buyer_name');
	$nameArray_approved=sql_select( "select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and a.status_active =1 and a.is_deleted=0");

	$data_img=sql_select("select image_location,master_tble_id  from common_photo_library  where   form_name='fabric_color_img' and is_deleted=0 and file_type=1");
	$fabric_composition = return_library_array("select id, fabric_composition_name from  lib_fabric_composition where status_active=1 and is_deleted=0 order by fabric_composition_name", "id", "fabric_composition_name");
	$system_img_arr=array();
	foreach($data_img as $row)
	{
	  $system_img_arr[$row[csf('master_tble_id')]]['img']=$row[csf('image_location')];
	}
	list($nameArray_approved_row)=$nameArray_approved;

	$job_po_arr=array();
	$ref_no='';$job_no_aarr='';
	$nameArray_per_job=sql_select( "select  a.job_no,a.style_ref_no,b.po_break_down_id,c.po_number,c.grouping  from wo_po_details_master a, wo_booking_dtls b, wo_po_break_down c where c.id=b.po_break_down_id and a.job_no=b.job_no and  a.job_no=c.job_no_mst and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by a.job_no,a.style_ref_no,b.po_break_down_id,c.grouping,c.po_number");
	foreach ($nameArray_per_job as $row_per_job)
	{
		$job_no_aarr.="'".$row_per_job[csf('job_no')]."'".',';
		$job_po_arr[$row_per_job[csf('job_no')]].=$row_per_job[csf('po_number')].',';
		if($ref_no=='') $ref_no=$row_per_job[csf('grouping')]; else $ref_no.=",".$row_per_job[csf('grouping')];
		
		$po_data_arr[$row_per_job[csf('po_break_down_id')]]['po_no']=$row_per_job[csf('po_number')];
		$po_data_arr[$row_per_job[csf('po_break_down_id')]]['ref_no']=$row_per_job[csf('grouping')];

	}
	$job_nos=rtrim($job_no_aarr,',');
	$job_nos=implode(",",array_unique(explode(",",$job_nos)));
	//$ref_no=$ref_no;
	$ref_nos=implode(",",array_unique(explode(",",$ref_no)));
	$job_no_mst_cond=where_con_using_array(array_unique(explode(",",$job_nos)),0,"job_no_mst");
	$int_ref_arr=return_library_array( "select job_no_mst,grouping from wo_po_break_down  where status_active=1 and is_deleted=0 $job_no_mst_cond",'job_no_mst','grouping');
	$job_data_arr=array();
	$nameArray_buyer=sql_select( "select  a.style_ref_no,a.style_description, a.job_no, a.style_owner, a.buyer_name, a.dealing_marchant,a.season,a.season_matrix,a.total_set_qnty,a.product_dept,a.product_code,a.pro_sub_dep,a.gmts_item_id ,a.order_repeat_no,a.qlty_label ,b.booking_no,a.ship_mode from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0 and a.job_no in(".$job_nos.") order by a.job_no ");
	
	foreach ($nameArray_buyer as $result_buy)
	{
		$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
		$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
		$dealing_marchant.=$marchentrArr[$result_buy[csf('dealing_marchant')]].',';

			$ship_mode_arr[$result_buy[csf('booking_no')]][$result_buy[csf('ship_mode')]]=$shipment_mode[$result_buy[csf('ship_mode')]];
 	}

  	//print_r($job_data_arr);
	$dealing_marchant=rtrim($dealing_marchant,',');
	$dealing_marchants=implode(",",array_unique(explode(",",$dealing_marchant)));
	//$dealing_marchants=implode(",",array_unique($job_data_arr['dealing_marchant']));
	$nameArray=sql_select( "select a.buyer_id,a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.fabric_source,a.remarks,a.pay_mode,a.fabric_composition,a.ship_mode from wo_booking_mst a   where  a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0");
	//print_r($shipment_mode);
	foreach ($nameArray as $result_job)
	{
		$booking_date=$result_job[csf('booking_date')];
		$buyer_id=$result_job[csf('buyer_id')];
		$currency_id=$result_job[csf('currency_id')];
		$attention=$result_job[csf('attention')];
		$delivery_date=$result_job[csf('delivery_date')];
		$supplier_id=$result_job[csf('supplier_id')];
		$remarks=$result_job[csf('remarks')];
		$paymode=$result_job[csf('pay_mode')];
		$ship_mode=$shipment_mode[$result_job[csf('ship_mode')]];
		if(empty($ship_mode))
		{
			$ship_mode=implode(",",$ship_mode_arr[$result_job[csf('booking_no')]][$result_job[csf('ship_mode')]]);
		}
		
	}
	if($currency_id==1){$paysa_sent="Paisa";} else if($currency_id==2){$paysa_sent="CENTS";}

	?>
    <style>

		@media print
		{
		     .page-break { height:0; page-break-before:always; margin:0; border-top:none; }
		}
	     body, p, span, td, a {font-size:10pt;font-family: Arial;}
	     body{margin-left:2em; margin-right:2em; font-family: "Arial Narrow", Arial, sans-serif;}
	</style>
	<div style="width:1310px" align="center">
		<table width="100%" cellpadding="0" cellspacing="0" style="border:0px solid black" >
			<tr>
				<td width="100">
					<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
				</td>
				<td width="1250">
					<table width="100%" cellpadding="0" cellspacing="0"  border="0" >
						<tr>
							<td align="center"><p><b style="font-size:xx-large">
								<?php
								echo $company_library[$cbo_company_name].'</b>';
								$country_arr=return_library_array( "select id, country_name from lib_country",'id','country_name');
								$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
								if($txt_job_no!="")
								{
									$location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'");
								}
								else
								{
									$location="";
								}
								foreach ($nameArray as $result)
								{
									$email=$result[csf('email')];
									$city=$result[csf('city')];
									//echo  $location_name_arr[$location];
									?> 
								   <br>
									 <? echo $result[csf('plot_no')]."-".$result[csf('level_no')].",".$result[csf('road_no')].",".$result[csf('block_no')]."<br>".$result[csf('city')].",".$result[csf('zip_code')].",".$country_arr[$result[csf('country_id')]]."<br>";?>
									Email Address: <? echo $email;?>
									Website: <? echo $result[csf('website')]; ?>
									<?
								}

								?>
								</p>
							</td>
							<td rowspan="3" width="250">
								<span><b> Booking No:&nbsp;&nbsp;<? echo trim($txt_booking_no,"'"); ?></b></span><br/>
							    <span><b> Booking Date :&nbsp;&nbsp;<? echo change_date_format($booking_date); ?></b></span><br/>
								<?
								if($nameArray_approved_row[csf('approved_no')]>1)
								{
									?>
									<b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
									<br/>
									Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
									<?
								}
								?>
							</td>
						</tr>
						<tr>
							<td align="center">
							<strong><? if($report_title !=""){ echo $report_title;}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
							</td>
						</tr>
						<tr>
							<td align="center">&nbsp;
							
							</td>
						</tr>
					</table>
				</td>
			</tr>
	    </table>
	    <table width="100%" style="border:0px solid black;table-layout: fixed;" >
				<tr>
					<td width="200"><span><b>To </b></span></td>
					<td width="280">&nbsp;<span></span></td>
					<td width="200"><span><b>Buyer</b></span></td>
				    <td width="230"><span> :&nbsp;<? echo $buyer_name_arr[$buyer_id]; ?></span></td>
				</tr>
				<tr>
					<td width="200"><b>To Messers </b>   </td>
					<td width="280">:&nbsp;
					<?
					if($paymode==5 || $paymode==3){
					echo $company_library[$supplier_id];
					$suplier_address=$city.','.$email;
					}
					else{
					echo $supplier_name_arr[$supplier_id];
					$suplier_address=$supplier_address_arr[$supplier_id];
					}
					?>    </td>
					<td width="200"><b>Dealing Marchant</b></td>
					<td width="" colspan="2">:&nbsp;<? echo $dealing_marchants;?></td>
				</tr>
				<tr>
					<td width="200"><b>Address</b></td>
					<td width="280">:&nbsp;<? echo $suplier_address; ?></td>
					<td width="200"><b>Currency </b>   </td>
					<td width="230">:&nbsp;
					<? 
					echo $currency[$currency_id];
					?>
					</td>
				</tr>
				
			    <tr>
					<td width="200"><b>Contact Person</b></td>
					<td  width="280">:&nbsp;<? echo $attention; ?></td>
					<td width="200">Pay Mode </td>
					<td colspan="2">:<?php echo $pay_mode[$paymode]; ?>
					
					</td>
				</tr>
				<tr>
					<td width="200"><b>Email</b></td>
					<td width="280">:&nbsp;<? echo $contact_email_arr[$supplier_id]; ?></td>
					<td width="200"><b>Delivery Date</b></td>
					<td width="280">:&nbsp;<? echo change_date_format($delivery_date); ?></td>
				
				</tr>
				<tr>
				
					<td width="200"><b>Contact No</b></td>
					<td width="280">:&nbsp;<? echo $contact_no_arr[$supplier_id]; ?></td>
					<td><b>Ship Mode</b></td>
					<td>:&nbsp;<?=$ship_mode;?></td>	
				</tr>
				<tr>
					<td width="200"><b>Remark</b></td>
					<td conspan="4"> :<? echo $remarks;?></td>
				</tr>
		</table>
	    <?
	    
		$color_wise_process_loss=sql_select("select  a.id, a.job_no,a.body_part_id,b.color_number_id,a.process_loss_method,b.process_loss_percent as loss FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls  b 	WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and  a.job_no in(".$job_nos.") and b.process_loss_percent>0 group by a.id, a.job_no,a.body_part_id,a.process_loss_method,b.color_number_id,b.process_loss_percent");
		foreach($color_wise_process_loss as $val)
		{
			$loss_arr[$val[csf("id")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['loss']=$val[csf("loss")];
			$loss_arr[$val[csf("id")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['loss_method']=$val[csf("process_loss_method")];
		}
		$sample_booking_arr=array();
		if($job_nos!='')
		{
			$lab_dip=sql_select("select lapdip_no, color_name_id, job_no_mst from wo_po_lapdip_approval_info where job_no_mst in(".$job_nos.") and status_active=1 and is_deleted=0 and approval_status=3");
			foreach($lab_dip as $row)
			{
				$lab_dip_arr[$row[csf("job_no_mst")]]['labtest_no']=$row[csf("lapdip_no")];

			}
			$sample_booking=sql_select("SELECT b.job_no, b.po_break_down_id as po_id, b.pre_cost_fabric_cost_dtls_id, b.fabric_color_id, b.gmts_color_id, b.fin_fab_qnty, c.lib_yarn_count_deter_id as yarn_id from wo_booking_mst a join wo_booking_dtls b on a.id=b.booking_mst_id join wo_pre_cost_fabric_cost_dtls c on c.id = b.pre_cost_fabric_cost_dtls_id where a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and b.booking_type=4 and b.is_short=2 and b.job_no in(".$job_nos.") group by b.job_no, b.po_break_down_id, b.pre_cost_fabric_cost_dtls_id, b.fabric_color_id, b.gmts_color_id, b.fin_fab_qnty, c.lib_yarn_count_deter_id");
			if(count($sample_booking)>0){
				foreach($sample_booking as $row){
					$sample_key=$row[csf('po_id')].'*'.$row[csf('yarn_id')].'*'.$row[csf('fabric_color_id')].'*'.$row[csf('gmts_color_id')];
					$sample_booking_arr[$sample_key]+=$row[csf('fin_fab_qnty')];
				}
				
			}
		}

		$sql_summary="select a.fabric_color_id,sum(a.grey_fab_qnty) as grey_sum_fab_qnty, a.dia_width, a.gsm_weight,a.color_type,b.construction,b.composition   from wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b  where a.pre_cost_fabric_cost_dtls_id=b.id   and a.job_no in(".$job_nos.")  and a.booking_no=$txt_booking_no   and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.fabric_color_id,a.dia_width, a.gsm_weight,a.color_type,b.construction,b.composition";
		$sql_sum_data=sql_select($sql_summary);
		foreach($sql_sum_data as $row){
			$booking_sum_qnty_arr[$row[csf('construction')]][$row[csf('composition')]][$row[csf('gsm_weight')]][$row[csf('color_type')]][$row[csf('dia_width')]][$row[csf('fabric_color_id')]]+=$row[csf('grey_sum_fab_qnty')];
		}
	
		$sql_pre="select a.pre_cost_fabric_cost_dtls_id  , a.po_break_down_id  , a.gmts_color_id color_number_id, a.id booking_id, sum(a.fin_fab_qnty) fin_fab_qnty,sum(a.grey_fab_qnty) grey_fab_qnty, a.rate , a.amount  , a.adjust_qty  , a.remark  , a.dia_width  , a.pre_cost_remarks  , a.hs_code,a.gsm_weight,b.job_id,b.lib_yarn_count_deter_id yarn_id,a.color_type,b.body_part_id   from wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b  where a.pre_cost_fabric_cost_dtls_id=b.id   and a.job_no in(".$job_nos.")  and a.booking_no=$txt_booking_no   and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.pre_cost_fabric_cost_dtls_id, a.po_break_down_id,a.gmts_color_id,a.id, a.rate , a.amount  , a.adjust_qty  , a.remark  , a.dia_width  , a.pre_cost_remarks  , a.hs_code,a.gsm_weight,b.job_id,b.lib_yarn_count_deter_id,a.color_type,b.body_part_id  ";
		$sql_pre_data=sql_select($sql_pre);
		foreach($sql_pre_data as $row){
			$main_keys=$row[csf('job_id')].'*'.$row[csf('yarn_id')].'*'.$row[csf('hs_code')];
			$booking_qnty_arr[$main_keys][$row[csf('po_break_down_id')]][$row[csf('gsm_weight')]][$row[csf('color_type')]][$row[csf('color_number_id')]]+=$row[csf('grey_fab_qnty')];
		}


	   $sql_booking="SELECT a.id as job_id, a.job_no_prefix_num, a.job_no,a.gmts_item_id, a.style_ref_no, d.po_break_down_id as po_id,c.body_part_id, c.uom, c.id as fabric_cost_dtls_id, d.color_type, d.construction, d.copmposition,g.itrm_ref, d.gsm_weight, d.dia_width, d.fin_fab_qnty, d.grey_fab_qnty, d.rate,d.amount ,d.remark, d.hs_code,  e.id as yarn_id, e.supplier_reference , e.fabric_composition_id, d.fabric_color_id as fab_color, d.gmts_color_id as gmt_color, f.contrast_color_id, c.color_size_sensitive 
	   from wo_po_details_master a , wo_pre_cost_fabric_cost_dtls c,lib_yarn_count_determina_mst e,wo_pre_cos_fab_co_avg_con_dtls g,wo_booking_dtls d  left join wo_pre_cos_fab_co_color_dtls f on  f.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and  f.gmts_color_id=d.gmts_color_id and f.status_active=1 and f.is_deleted=0  where   
	   a.id=c.job_id  and c.id=d.pre_cost_fabric_cost_dtls_id  and c.id=g.pre_cost_fabric_cost_dtls_id and d.gmts_color_id = g.color_number_id and e.id=c.lib_yarn_count_deter_id  and a.status_active=1 and a.is_deleted=0   and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and g.status_active=1 and g.is_deleted=0 and d.booking_no =$txt_booking_no and a.job_no in(".$job_nos.")   order by a.job_no";


		//echo $sql_booking;die;
		 $result_set=sql_select($sql_booking);
		 foreach($result_set as $row){
			$main_key=$row[csf('job_id')].'*'.$row[csf('yarn_id')].'*'.$row[csf('hs_code')];
			$summary_key=$row[csf('construction')].'*'.$row[csf('copmposition')].'*'.$row[csf('gsm_weight')].'*'.$row[csf('color_type')].'*'.$row[csf('dia_width')];
			
			$po_no= $po_data_arr[$row[csf('po_id')]]['po_no'];
			$ref_no=$po_data_arr[$row[csf('po_id')]]['ref_no'];

			$fabric_detail_arr[$main_key]['job_num']=$row[csf('job_no_prefix_num')];
			$fabric_detail_arr[$main_key]['job_no']=$row[csf('job_no')];
			$fabric_detail_arr[$main_key]['item']=$garments_item[$row[csf('gmts_item_id')]];
			$fabric_detail_arr[$main_key]['hs_code']=$row[csf('hs_code')];
			$fabric_detail_arr[$main_key]['style_ref_no']=$row[csf('style_ref_no')];
			$fabric_detail_arr[$main_key]['yarn_id']=$row[csf('yarn_id')];
			$fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['po_number']=$po_no;
			$fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['grouping']=$ref_no;
			$fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['article_no']=$row[csf('supplier_reference')];			 
			$fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['construction']=$row[csf('construction')];
			$fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['copmposition']=$row[csf('copmposition')];
			
			$fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['gsm_data'][$row[csf('gsm_weight')]]['gsm_weight']=$row[csf('gsm_weight')];
			$fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['gsm_data'][$row[csf('gsm_weight')]]['dia_width'].=$row[csf('dia_width')].",";
			$fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['gsm_data'][$row[csf('gsm_weight')]]['colortype_data'][$row[csf('color_type')]]['color_type']=$color_type[$row[csf('color_type')]];
			$fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['gsm_data'][$row[csf('gsm_weight')]]['colortype_data'][$row[csf('color_type')]]['body_part'][$row[csf('body_part_id')]]=$body_part[$row[csf('body_part_id')]];
			$fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['gsm_data'][$row[csf('gsm_weight')]]['colortype_data'][$row[csf('color_type')]]['+'][$row[csf('gmt_color')]]['gmt_color']=$row[csf('gmt_color')];
			$fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['gsm_data'][$row[csf('gsm_weight')]]['colortype_data'][$row[csf('color_type')]]['color_data'][$row[csf('gmt_color')]]['fab_color']=$row[csf('fab_color')];
			$fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['gsm_data'][$row[csf('gsm_weight')]]['colortype_data'][$row[csf('color_type')]]['color_data'][$row[csf('gmt_color')]]['fab_qty']=$booking_qnty_arr[$main_key][$row[csf('po_id')]][$row[csf('gsm_weight')]][$row[csf('color_type')]][$row[csf('gmt_color')]];
			$fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['gsm_data'][$row[csf('gsm_weight')]]['colortype_data'][$row[csf('color_type')]]['color_data'][$row[csf('gmt_color')]]['rate']=$row[csf('rate')];
			$fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['gsm_data'][$row[csf('gsm_weight')]]['colortype_data'][$row[csf('color_type')]]['color_data'][$row[csf('gmt_color')]]['uom']=$row[csf('uom')];
			$fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['gsm_data'][$row[csf('gsm_weight')]]['colortype_data'][$row[csf('color_type')]]['color_data'][$row[csf('gmt_color')]]['remark']=$row[csf('remark')];
			$fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['gsm_data'][$row[csf('gsm_weight')]]['colortype_data'][$row[csf('color_type')]]['color_data'][$row[csf('gmt_color')]]['dia_width']=$row[csf('dia_width')];
			$fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['gsm_data'][$row[csf('gsm_weight')]]['colortype_data'][$row[csf('color_type')]]['color_data'][$row[csf('gmt_color')]]['itrm_ref'].=$row[csf('itrm_ref')].',';
			$fabric_detail_arr[$main_key]['po_data'][$row[csf('po_id')]]['gsm_data'][$row[csf('gsm_weight')]]['colortype_data'][$row[csf('color_type')]]['color_data'][$row[csf('gmt_color')]]['fabric_cost_dtls_id']=$row[csf('fabric_cost_dtls_id')];

			$fabric_summ_arr[$summary_key]['construction']=$row[csf('construction')];
			$fabric_summ_arr[$summary_key]['copmposition']=$row[csf('copmposition')];
			$fabric_summ_arr[$summary_key]['gsm_weight']=$row[csf('gsm_weight')];
			$fabric_summ_arr[$summary_key]['color_type']=$color_type[$row[csf('color_type')]];
			$fabric_summ_arr[$summary_key]['dia_width']=$row[csf('dia_width')];
			$fabric_summ_arr[$summary_key]['itrm_ref']=$row[csf('itrm_ref')];
			$fabric_summ_arr[$summary_key]['uom']=$row[csf('uom')];
			$fabric_summ_arr[$summary_key]['color_data'][$row[csf('fab_color')]]['fab_color']=$row[csf('fab_color')];
			$fabric_summ_arr[$summary_key]['color_data'][$row[csf('fab_color')]]['fabric_qty']=$booking_sum_qnty_arr[$row[csf('construction')]][$row[csf('copmposition')]][$row[csf('gsm_weight')]][$row[csf('color_type')]][$row[csf('dia_width')]][$row[csf('fab_color')]];
			$fabric_summ_arr[$summary_key]['color_data'][$row[csf('fab_color')]]['rate']=$row[csf('rate')];
		 }
		   /* echo '<pre>';
		 print_r($fabric_summ_array); die;   */
		?>
		<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
			<caption> <strong><? //echo $uom_val;?></strong> </caption>
			<tr>
				<th  width="30" align="center">SL</th>
				<th  width="70" align="center">Job No</th>
				<th  width="70" align="center">Item</th>
				<th  width="70" align="center">HS Code</th>
				<th  width="100" align="center">Style Ref</th>
				<th  width="100" align="center">Order No</th>
				<th  width="100" align="center">Internal Ref.</th>			
				<th  width="140" align="center">Construction</th>
				<th  width="150" align="center">Composition</th>
				<th  width="50" align="center">GSM</th>					
				<th  width="150" align="center">Body Part</th>
				<th  width="80" align="center">Color Type</th>
				<th  width="60" align="center">Min. CutableWidth</th>		
				<th  width="100" align="center">Gmts Color</th>
				<th  width="100" align="center">Fabric Color</th>
				<th  width="120" align="center">Lab Dip No</th>
				<th  width="90" align="center">Item Ref</th>			
				<th width='100' align="center">Bulk Qty</th>
				<th width='100' align="center">Sample Qty</th>
				<th width='100' align="center" title="Bulk+Sample">Total Qty</th>
				<th  width="50" align="center">Unit</th>
				<th width='80' align="center">Rate</th>
				<th width='100' align="center">Total Value</th>
				<th width='100' align="center">Image</th>
				<th width='200' align="center">Remark</th>
			</tr>
			<?
			$i=1;
			foreach($fabric_detail_arr as $mkey=>$mdata){
				foreach($mdata['po_data'] as $poid=>$podata){
					foreach($podata['gsm_data'] as $gsmid=>$gsmdata){
						foreach($gsmdata['colortype_data'] as $colordataarr)
							foreach($colordataarr['color_data'] as $colordata){
								$jobwisespan[$mkey] +=1;
								$powisespan[$mkey][$poid] +=1;
								$powisegsmspan[$mkey][$gsmid][$poid] +=1;
						}	
					}				
				}
			}
			
			foreach($fabric_detail_arr as $key=>$maindata){
				$mainspan=$jobwisespan[$key];
				$lab_test=$lab_dip_arr[$maindata['job_no']]['labtest_no'];
			?>
				<tr>
					<td rowspan=<?= $mainspan ?>><?= $i  ?></td>
					<td rowspan=<?= $mainspan ?>><?= $maindata['job_num']  ?></td>
					<td rowspan=<?= $mainspan ?>><?= $maindata['item'] ?></td>
					<td rowspan=<?= $mainspan ?>><?= $maindata['hs_code']  ?></td>
					<td rowspan=<?= $mainspan ?>><?= $maindata['style_ref_no']  ?></td>
					<?  
					$z=1;
					foreach($maindata['po_data'] as $poid=>$po_data){
						if($z!=1) echo '<tr>';
						//$pospan=count($po_data['color_data']);
						$pospan=$powisespan[$key][$poid];
						?>
						<td rowspan=<?= $pospan  ?>><?= $po_data['po_number']  ?></td>
						<td rowspan=<?= $pospan  ?>><?= $po_data['grouping']  ?></td>
						<? //if($z==1){ ?>					
						<td rowspan=<?= $pospan  ?>><?= $po_data['construction']  ?></td>
						<td rowspan=<?= $pospan  ?>><?= $po_data['copmposition']  ?></td>
						<?
						$g=1;
						foreach($po_data['gsm_data'] as $gsmid=>$gsm_data){
							if($g!=1) echo '<tr>';
							$gsmspan=$powisegsmspan[$key][$gsmid][$poid];
							//$gsmspan=count($gsm_data['gsm_data']);
							$dia_width_val=implode(",",array_filter(array_unique(explode(",",$gsm_data['dia_width']))));?>
						<td rowspan=<?= $gsmspan  ?>><?= $gsm_data['gsm_weight']  ?></td>					
						<? 
						//}
						$x=1;
						foreach($gsm_data['colortype_data'] as $colortype_data){
							$colorspan=count($colortype_data['color_data']);
							if($x!=1) echo '<tr>';
							?>
							<td rowspan=<?= $colorspan  ?>><?= implode(", ", $colortype_data['body_part'])  ?></td>
							<td rowspan=<?= $colorspan  ?>><?= $colortype_data['color_type']  ?></td>
							
							<?
							$k=1;
							foreach($colortype_data['color_data'] as $color_data){
								$smkey=$poid.'*'.$gsmid.'*'.$maindata['yarn_id'].'*'.$color_data['fab_color'].'*'.$color_data['gmt_color'];
								$sample_qty=$sample_booking_arr[$smkey];
								//$total_qty=ceil(number_format($color_data['fab_qty']+$sample_qty,4,".",""));
								//$grand_total_qty+=ceil(number_format($total_qty,4,".",""));
								$total_qty=ceil($color_data['fab_qty']+$sample_qty);
								$grand_total_qty+=ceil($total_qty);
								$total_sample_qty+=$sample_qty;
								$grand_total_value=$grand_total_value+$total_qty*$color_data['rate'];
								//$total_fin_qty+=ceil($color_data['fab_qty']);
								//$total_fin_qty+=ceil(number_format($color_data['fab_qty'],4,".",""));
								$total_fin_qty+=ceil($color_data['fab_qty']);
								$item_refs=implode(",",array_filter(array_unique(explode(",",$color_data['itrm_ref']))));
								if($k!=1) echo '<tr>';
								?>
								<td align="center" ><?= $color_data['dia_width'] ?></td>
								<td><?= $color_library[$color_data['gmt_color']]  ?></td>
								<td><?= $color_library[$color_data['fab_color']]  ?></td>
								<td><?= $lab_test ?></td>
								<!-- <td align="right"><?= $item_refs ?>if($season_matrix!="") echo $season_matrix; else echo $season_buyer_wise;</td> -->
								<td align="right"><? if($item_refs!="") echo $item_refs; else echo " ";?></td>
								<td align="right"><?= ceil($color_data['fab_qty'])//= ceil(number_format($color_data['fab_qty'],4,".",""))  ?></td>
								<td align="right"><?= ceil(number_format($sample_qty,0)) ?></td>
								<td align="right"><?= ceil($total_qty)//=ceil($total_qty); ?></td>
								<? if($k==1){ ?>
								<td rowspan=<?= $colorspan ?>><?= $unit_of_measurement[$color_data['uom']]  ?></td>
								<? } ?>
								<td align="right"><?= $color_data['rate'] ?></td>
								<td align="right"><?= ceil(number_format( $total_qty*$color_data['rate'],4 )) ?></td>
								<td><?
									$img_ref_id=$color_data['fabric_cost_dtls_id'].'_'.$color_data['fab_color'];
									$fab_color_img=$system_img_arr[$img_ref_id]['img'];
									if($fab_color_img !=''){
									?>
								<img src='../../<? echo $fab_color_img; ?>' height='50' width='70' align="middle" />
								<? } ?></td>
								<td><?= $color_data['remark'] ?></td>
								<? 
								$k++;					
							}
							$x++;
						}
						$g++;
					}
						
					$z++;
					} ?>
				</tr>
				<? 
				$i++;
			}
			?>
				<tfoot>
					<tr>
							<th colspan="17" align="right"> Total </th>
							<th align="right"> <? echo ceil($total_fin_qty); ?> </th> 
							<th align="right"> <? echo $total_sample_qty;//echo ceil($total_sample_qty); ?> </th> 
							<th align="right"> <? echo ceil($grand_total_qty); ?> </th>							
							<th align="right"></th>
							<th align="right"></th>
							<th align="right"> <? echo ceil(number_format($grand_total_value,2)); ?> </th>
							<th align="right"></th>
							<th align="right"></th>
					</tr>
					<tr>
                   <td colspan="25" align="left"><b>In Word: <? echo number_to_words(def_number_format($grand_total_value,2),$currency[$currency_id],$paysa_sent); ?></b></td>
               		</tr>
				</tfoot>
		</table>
		<table class="rpt_table" width="920"  border="1" cellpadding="0" cellspacing="0" rules="all" style="margin-top: 10px; float:left;">
			<tr><td colspan="10"><strong>Fabric Booking Summary</strong></td></tr>
			<tr>
				<th width="200">Construction</th>
				<th width="200">Composition</th>
				<th width="70">GSM</th>
				<th width="70">Color Type</th>
				<th width="80">Min. CutableWidth</th>
				<th width="80">Fabric Color</th>
				<th width="120">Item Ref</th>
				<th width="80">Unit</th>
				<th width="60">Total Qty</th>
				<th width="60">Total Value</th>
			</tr>
			<?
			$summary_fab_qnty=$summary_fab_value=0;
				foreach($fabric_summ_arr as $color_data){
					$row_span=count($color_data['color_data']);
					?>
						<tr>
							<td align='center' rowspan="<?= $row_span ?>"><?= $color_data['construction'] ?></td>
							<td align='center' rowspan="<?= $row_span ?>"><?= $color_data['copmposition'] ?></td>
							<td align='center' rowspan="<?= $row_span ?>"><?= $color_data['gsm_weight'] ?></td>
							<td align='center' rowspan="<?= $row_span ?>"><?= $color_data['color_type'] ?></td>
							<td align='center' rowspan="<?= $row_span ?>"><?= $color_data['dia_width'] ?></td>
							<? $sk=1;$sub_summary_fab_qnty=$sub_summary_fab_value=0;
							foreach($color_data['color_data'] as $color_dtls){
								if($sk!=1) echo '<tr>';
							?>
								
								<td align='center'><?= $color_library[$color_dtls['fab_color']];  ?></td>
								<? if($sk==1){ ?> 	
								<td rowspan="<?= $row_span ?>" align='center'><?= $color_data['itrm_ref'];  ?></td>						
								<td rowspan="<?= $row_span ?>" align='center'><?= $unit_of_measurement[$color_data['uom']];  ?></td>
								<? } ?>	
								<td align='right'><?=  ceil($color_dtls['fabric_qty']);  ?></td>
								<td align='right' ><?=  ceil($color_dtls['fabric_qty']*$color_dtls['rate'])  ?></td>							
							<? $sk++;
							$sub_summary_fab_qnty+=ceil($color_dtls['fabric_qty']);
							$sub_summary_fab_value+=ceil($color_dtls['fabric_qty']*$color_dtls['rate']);

							} 
							
							?>
							
						</tr>
						<tr>
						<th colspan="8" align="right"> Total </th>
						<th align="right"> <? echo ceil($sub_summary_fab_qnty); ?> </th> 
						<th align="right"> <? echo ceil($sub_summary_fab_value); ?> </th> 
					</tr>
					<?
					$summary_fab_qnty+=$sub_summary_fab_qnty;
					$summary_fab_value+=$sub_summary_fab_value;
				}

			?>
			<tfoot>
				<tr>
					<th colspan="8" align="right"> Total </th>
					<th align="right"> <? echo ceil($summary_fab_qnty); ?> </th> 
					<th align="right"> <? echo ceil($summary_fab_value); ?> </th> 
				</tr>
			</tfoot>
		</table> 
	   <?
          echo signature_table(121, $cbo_company_name, "1000px");
       ?>

	</div>
    <?

}
if($action=="print_booking_13") //md mamun ahmed sagor->>>>06-03-2022
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$path=str_replace("'","",$path);
	if($path!="") $path=$path; else $path="../../";

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' or form_name='knit_order_entry' and file_type=1",'master_tble_id','image_location');
	$company_library=return_library_array( "select id,company_name from lib_company where status_active=1 and is_deleted=0", "id", "company_name");
	$color_library=return_library_array( "select id,color_name from lib_color ", "id", "color_name");
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier  where status_active=1 and is_deleted=0",'id','supplier_name');
	$contact_email_arr=return_library_array( "select id,email from   lib_supplier  where status_active=1 and is_deleted=0",'id','email');
	$contact_no_arr=return_library_array( "select id,contact_no from   lib_supplier  where status_active=1 and is_deleted=0",'id','contact_no');
	$supplier_address_arr=return_library_array( "select id,address_1 from   lib_supplier  where status_active=1 and is_deleted=0",'id','address_1');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info  where status_active=1 and is_deleted=0","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer  where status_active=1 and is_deleted=0",'id','buyer_name');
	$nameArray_approved=sql_select( "select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and a.status_active =1 and a.is_deleted=0");

	$data_img=sql_select("select image_location,master_tble_id  from common_photo_library  where   form_name='fabric_color_img' and is_deleted=0 and file_type=1");
	$user_lib_name_arr=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");
	$system_img_arr=array();
	foreach($data_img as $row)
	{
	  $system_img_arr[$row[csf('master_tble_id')]]['img']=$row[csf('image_location')];
	}
	list($nameArray_approved_row)=$nameArray_approved;

	$job_po_arr=array();
	$ref_no='';$job_no_aarr='';
	$nameArray_per_job=sql_select( "select  a.job_no,a.style_ref_no,b.po_break_down_id,c.po_number,c.grouping  from wo_po_details_master a, wo_booking_dtls b, wo_po_break_down c where c.id=b.po_break_down_id and a.job_no=b.job_no and  a.job_no=c.job_no_mst and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by a.job_no,a.style_ref_no,b.po_break_down_id,c.grouping,c.po_number");
	foreach ($nameArray_per_job as $row_per_job)
	{
		$job_no_aarr.="'".$row_per_job[csf('job_no')]."'".',';
		$job_po_arr[$row_per_job[csf('job_no')]].=$row_per_job[csf('po_number')].',';
		if($ref_no=='') $ref_no=$row_per_job[csf('grouping')]; else $ref_no.=",".$row_per_job[csf('grouping')];

	}
	$job_nos=rtrim($job_no_aarr,',');
	$job_nos=implode(",",array_unique(explode(",",$job_nos)));
	//$ref_no=$ref_no;
	$ref_nos=implode(",",array_unique(explode(",",$ref_no)));
	$job_no_mst_cond=where_con_using_array(array_unique(explode(",",$job_nos)),0,"job_no_mst");
	$int_ref_arr=return_library_array( "select job_no_mst,grouping from wo_po_break_down  where status_active=1 and is_deleted=0 $job_no_mst_cond",'job_no_mst','grouping');
	//echo "select job_no_mst,grouping from wo_po_break_down  where status_active=1 and is_deleted=0 $job_no_mst_cond";
	//$job_nos=explode(",",$job_nos);
	//print_r($job_no_aarr);
	$job_data_arr=array();
	$nameArray_buyer=sql_select( "select  a.style_ref_no,a.style_description, a.job_no, a.style_owner, a.buyer_name, a.dealing_marchant,a.season,a.season_matrix,a.total_set_qnty,a.product_dept,a.product_code,a.pro_sub_dep,a.gmts_item_id ,a.order_repeat_no,a.qlty_label ,b.booking_no,a.ship_mode from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0 and a.job_no in(".$job_nos.") order by a.job_no ");
	
	foreach ($nameArray_buyer as $result_buy)
	{
		$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
		$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
		$dealing_marchant.=$marchentrArr[$result_buy[csf('dealing_marchant')]].',';

			$ship_mode_arr[$result_buy[csf('booking_no')]][$result_buy[csf('ship_mode')]]=$shipment_mode[$result_buy[csf('ship_mode')]];
 	}

  //print_r($job_data_arr);
	$dealing_marchant=rtrim($dealing_marchant,',');
	$dealing_marchants=implode(",",array_unique(explode(",",$dealing_marchant)));
	//$dealing_marchants=implode(",",array_unique($job_data_arr['dealing_marchant']));
	$nameArray=sql_select( "select a.buyer_id,a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.fabric_source,a.remarks,a.pay_mode,a.fabric_composition,a.ship_mode,a.tenor,a.pay_term,a.inserted_by from wo_booking_mst a   where  a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0");
	$season_arr=return_library_array("select id,season_name from lib_buyer_season","id","season_name");

	//print_r($shipment_mode);
	foreach ($nameArray as $result_job)
	{
		$booking_date=$result_job[csf('booking_date')];
		$buyer_id=$result_job[csf('buyer_id')];
		$currency_id=$result_job[csf('currency_id')];
		$attention=$result_job[csf('attention')];
		$delivery_date=$result_job[csf('delivery_date')];
		$supplier_id=$result_job[csf('supplier_id')];
		$remarks=$result_job[csf('remarks')];
		$paymode=$result_job[csf('pay_mode')];
		$tenor=$result_job[csf('tenor')];
		$payterm=$result_job[csf('pay_term')];
		$fab_source=$fabric_source[$result_job[csf('fabric_source')]];
		$ship_mode=$shipment_mode[$result_job[csf('ship_mode')]];
		$inserted_by=$result_job[csf('inserted_by')];
		if(empty($ship_mode))
		{
			$ship_mode=implode(",",$ship_mode_arr[$result_job[csf('booking_no')]][$result_job[csf('ship_mode')]]);
		}
		
	}
	//echo $booking_date.'ddd';
	ob_start();
	?>
    <style>

		@media print
		{
		     .page-break { height:0; page-break-before:always; margin:0; border-top:none; }
		}
	     body, p, span, td, a {font-size:10pt;font-family: Arial;}
	     body{margin-left:2em; margin-right:2em; font-family: "Arial Narrow", Arial, sans-serif;}
	</style>
	<div style="width:1310px" align="center">
		<table width="100%" cellpadding="0" cellspacing="0" style="border:0px solid black" >
			<tr>
				<td width="100">
					<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
				</td>
				<td width="1250">
					<table width="100%" cellpadding="0" cellspacing="0"  border="0" >
						<tr>
							<td align="center"><p><b style="font-size:xx-large">
								<?php
								echo $company_library[$cbo_company_name].'</b>';
								$country_arr=return_library_array( "select id, country_name from lib_country",'id','country_name');
								$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
								// echo "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name";
								if($txt_job_no!="")
								{
									$location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'");
								}
								else
								{
									$location="";
								}
								foreach ($nameArray as $result)
								{
									$email=$result[csf('email')];
									$city=$result[csf('city')];
									//echo  $location_name_arr[$location];
									?> 
								   <br>
									 <? echo $result[csf('plot_no')]."-".$result[csf('level_no')].",".$result[csf('road_no')].",".$result[csf('block_no')]."<br>".$result[csf('city')].",".$result[csf('zip_code')].",".$country_arr[$result[csf('country_id')]]."<br>";?>
									Email Address: <? echo $email;?>
									Website: <? echo $result[csf('website')]; ?>
									<?
								}

								?>
								</p>
							</td>
							<td rowspan="3" width="250">
								<!-- <span><b> Booking No:&nbsp;&nbsp;<? echo trim($txt_booking_no,"'"); ?></b></span><br/>
							    <span><b> Booking Date :&nbsp;&nbsp;<? //echo change_date_format($booking_date); ?></b></span><br/> -->
								<?
								if($nameArray_approved_row[csf('approved_no')]>1)
								{
									?>
									<b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
									<br/>
									Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
									<?
								}
								?>
							</td>
						</tr>
						<tr>
							<td align="center">
							<strong><? if($report_title !=""){ echo $report_title.":-".trim($txt_booking_no,"'");}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
							</td>
						</tr>
						<tr>
							<td align="center">&nbsp;
							
							</td>
						</tr>
					</table>
				</td>
			</tr>
	    </table>
	    <table width="100%" style="border:0px solid black;table-layout: fixed;" >
				<tr>
					<td width="200"><span><b>To </b></span></td>
					<td width="280">&nbsp;<span></span></td>
					<td width="200"><span><b>Booking Date</b></span></td>
				    <td width="230"><span> :&nbsp;<b><? echo change_date_format($booking_date);  ?></b></span></td>
					<td width="200"><b>Delivery Date</b></td>
					<td width="230">:&nbsp;<b><? echo change_date_format($delivery_date); ?></b></td>
				</tr>
				<tr>
					<td width="200"><b>Supplier Name </b>   </td>
					<td width="280">:&nbsp;
					<?
					$supp_address=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website,contact_no from lib_company where id=$supplier_id");

				



					if($paymode==5 || $paymode==3){
					echo $company_library[$supplier_id];
				
					$suplier_address=$supp_address[0][csf('plot_no')]."-".$supp_address[0][csf('level_no')].",".$supp_address[0][csf('road_no')].",".$supp_address[0][csf('block_no')]."<br>".$supp_address[0][csf('city')].",".$supp_address[0][csf('zip_code')].",".$country_arr[$supp_address[0][csf('country_id')]];
					}
					else{
					echo $supplier_name_arr[$supplier_id];
					$suplier_address=$supplier_address_arr[$supplier_id];
					}
					?>    </td>
					<td><b>Ship Mode</b></td>
					<td>:&nbsp;<?=$ship_mode;?></td>	
					<td width="200"><span><b>Pay Term</b></span></td>
				    <td width="230"><span> :&nbsp;<? echo $pay_term[$payterm]; ?></span></td>
				</tr>
				<tr>
					<td width="200"><b>Address</b></td>
					<td width="280">:&nbsp;<? echo $suplier_address; ?></td>
					<td width="200"><span><b>Buyer</b></span></td>
				    <td width="230"><span> :&nbsp;<? echo $buyer_name_arr[$buyer_id]; ?></span></td>
					<td width="200"><span><b>Tenor</b></span></td>
				    <td width="230"><span> :&nbsp;<? echo $tenor; ?></span></td>
				</tr>
				
				<tr>
					<td width="200"><b>Contact No</b></td>
					<td width="280">:&nbsp;<? echo $supp_address[0][csf('contact_no')]; ?></td>
					<td width="200"><b>Dealing Marchant</b></td>
					<td width="" >:&nbsp;<? echo $dealing_marchants;?></td>
				
					<td width="200"><span><b>Pay Mode </b></span></td>
				    <td width="230"><span> :<?php echo $pay_mode[$paymode]; ?></span></td>
				
				</tr>
				<tr>
				
					<td width="200"><b>Contact Person</b></td>
					<td  width="280">:&nbsp;<? echo $attention; ?></td>
					<td width="200"><span><b>Fabric Source</b></span></td>
				    <td width="230"><span> :&nbsp;<? echo $fab_source; ?></span></td>
					<td width="200"><b>Currency </b>   </td>
					<td width="230">:&nbsp;
					<? 
					echo $currency[$currency_id];
					?>
					</td>
				
				</tr>

				<tr>
					<td width="200"><b>Remark</b></td>
					<td conspan="6"> :<? echo $remarks;?></td>
				</tr>
		</table>
	    <?
	    
		$color_wise_process_loss=sql_select("select  a.id, a.job_no,a.body_part_id,b.color_number_id,a.process_loss_method,b.process_loss_percent as loss FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls  b 	WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and  a.job_no in(".$job_nos.") and b.process_loss_percent>0 group by a.id, a.job_no,a.body_part_id,a.process_loss_method,b.color_number_id,b.process_loss_percent");
		foreach($color_wise_process_loss as $val)
		{
			$loss_arr[$val[csf("id")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['loss']=$val[csf("loss")];
			$loss_arr[$val[csf("id")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['loss_method']=$val[csf("process_loss_method")];
		}
		if($job_nos!='')
		{
			//$lab_dip=sql_select("select  b.job_no,a.labtest_no FROM wo_labtest_mst a, wo_labtest_dtls  b WHERE a.id=b.mst_id and b.job_no in(".$job_nos.") ");
			$lab_dip=sql_select("select lapdip_no, color_name_id, job_no_mst from wo_po_lapdip_approval_info where job_no_mst in(".$job_nos.") and status_active=1 and is_deleted=0 and approval_status=3");
			foreach($lab_dip as $row)
			{
				$lab_dip_arr[$row[csf("job_no_mst")]]['labtest_no']=$row[csf("lapdip_no")];

			}
		}
		//wo_labtest_mst
	   $sql_booking="SELECT  a.job_no,a.id as fabric_cost_dtls_id, a.body_part_id,a.color_type_id as c_type, a.construction, a.composition, a.gsm_weight as gsm, d.dia_width as dia,a.uom,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,avg(d.rate) as rates,sum(d.amount) as amounts ,d.remark,c.style_ref_no,c.job_no_prefix_num,d.fabric_color_id as fab_color,d.gmts_color_id as gmt_color,c.season_buyer_wise,a.source_id 
		FROM wo_pre_cost_fabric_cost_dtls a,  wo_booking_dtls d,wo_po_details_master c
		WHERE   a.job_no=d.job_no and a.id=d.pre_cost_fabric_cost_dtls_id  and a.job_no=c.job_no  and d.job_no=c.job_no
		and d.booking_no =$txt_booking_no and d.job_no in(".$job_nos.") and d.status_active=1 and d.is_deleted=0
		group by  a.job_no,a.id, a.body_part_id,a.color_type_id, a.construction, a.composition,d.fabric_color_id,d.gmts_color_id, a.gsm_weight, d.dia_width,a.uom,c.style_ref_no,c.job_no_prefix_num,d.remark,c.season_buyer_wise,a.source_id  order by a.job_no,d.fabric_color_id ";
		//echo $sql_booking;die;
		 $result_set=sql_select($sql_booking);
		 foreach( $result_set as $row)
		 {
				$body_part_id=$body_part[$row[csf("body_part_id")]];
				$uom_data_arr[$row[csf("uom")]]=$unit_of_measurement[$row[csf("uom")]];
				$construction=$row[csf("construction")];
				$compositions= $row[csf("composition")];
				$item_desc=$body_part_id.'***'.$row[csf("construction")].'***'.$compositions;
				/*$process_loss=$loss_arr[$row[csf("job_no")]][$row[csf("body_part_id")]][$row[csf("fab_color")]]['loss'];
				$process_loss_method=$loss_arr[$row[csf("job_no")]][$row[csf("body_part_id")]][$row[csf("fab_color")]]['loss_method'];*/

				$process_loss=$loss_arr[$row[csf("fabric_cost_dtls_id")]][$row[csf("job_no")]][$row[csf("body_part_id")]][$row[csf("gmt_color")]]['loss'];
				$process_loss_method=$loss_arr[$row[csf("fabric_cost_dtls_id")]][$row[csf("job_no")]][$row[csf("body_part_id")]][$row[csf("gmt_color")]]['loss_method'];
				if($process_loss=='') $process_loss=0;else $process_loss=$process_loss;
				if($process_loss_method=='') $process_loss_method=0;else $process_loss_method=$process_loss_method;

				$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['uom']=$row[csf("uom")];
				$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['fabric_cost_dtls_id']=$row[csf("fabric_cost_dtls_id")];
				$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['fab_color_id']=$row[csf("fab_color")];
				$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['style_ref_no']=$row[csf("style_ref_no")];
				$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['job_prefix']=$row[csf("job_no_prefix_num")];

				$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['job_no']=$row[csf("job_no")];

				$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['style_ref_no']=$row[csf("style_ref_no")];

				$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['fin_qty']+=$row[csf("fin_fab_qntys")];
				$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['grey_qty']+=$row[csf("grey_fab_qntys")];
				$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['amounts']+=$row[csf("amounts")];
				$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['rates']=$row[csf("rates")];
				$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['p_loss']=$process_loss;
				$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['p_loss_method']=$process_loss_method;
				$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['remark']=$row[csf("remark")];
				$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['season_buyer_wise']=$row[csf("season_buyer_wise")];
				$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['source_id']=$row[csf("source_id")];
		 }
		 //print_r($uom_data_arr);
		 $fab_row_span_arr=array();
		foreach($fabric_detail_arr as $job_key=>$job_data)
		{
			$desc_rowspan=0;
			foreach($job_data as $desc_key=>$desc_data)
			{
				foreach($desc_data as $gsm_key=>$gsm_data)
				{
					foreach($gsm_data as $dia_key=>$dia_data)
					{
						foreach($dia_data as $c_type_key=>$color_data)
						{
							foreach($color_data as $gmt_color_key=>$gmt_color_data)
							{
								foreach($gmt_color_data as $fab_color_key=>$val)
								{
									$desc_rowspan++;
								}
								$fab_row_span_arr[$job_key]=$desc_rowspan;
							}
						}
					}
				}
			}
		}
		foreach($uom_data_arr as $uom_id=>$uom_val)
		{
			?>
		   		<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
					<caption> <strong><? //echo $uom_val;?></strong> </caption>
					<tr>
				        <th  width="30" align="center">SL</th>
				        <th  width="70" align="center">Job No</th>
				        <th  width="120" align="center">Style Ref</th>
				        <th  width="120" align="center">Season</th>
				        <th  width="120" align="center">Order No</th>
				        <th  width="150" align="center">Body Part</th>
				        <th  width="150" align="center">Construction</th>
				        <th  width="150" align="center">Composition</th>
						<th  width="100" align="center">Source</th>
				        <th  width="50" align="center">GSM</th>
				        <th  width="60" align="center">Dia</th>
				        <th  width="80" align="center">Color Type</th>
				        <th  width="100" align="center">Gmts Color</th>
				        <th  width="100" align="center">Fabric Color</th>
				        <th  width="120" align="center">Lab Dip/ Pantone No</th>
						<th width='100' align="center">Fabric Image</th>				
				        <th width='100' align="center">Finish Fab. Qty</th>
						<th  width="50" align="center">UOM</th>
				       
				        <th width='80' align="center">Avg Rate</th>
				        <th width='100' align="center">Amount</th>
				       
				        <th width='200' align="center">Remark</th>
					</tr>
				   <?
					// print_r($body_rowspan_arr);
					$k=$p=1;$total_fin_qty=$total_grey_qty=$total_amount=0;
					foreach($fabric_detail_arr as $job_key=>$job_data)
					{
						$y=1;
						foreach($job_data as $desc_key=>$desc_data)
						{
							foreach($desc_data as $gsm_key=>$gsm_data)
							{
								foreach($gsm_data as $dia_key=>$dia_data)
								{
									foreach($dia_data as $c_type_key=>$color_data)
									{
										foreach($color_data as $gmt_color_key=>$gmt_color_data)
										{
											foreach($gmt_color_data as $fab_color_key=>$val)
											{
												$po_nos=rtrim($job_po_arr[$job_key],',');
												$po_nos=implode(",",array_unique(explode(",",$po_nos)));
												$fab_row_span=$fab_row_span_arr[$job_key];
												$p_loss_method=$val['p_loss_method'];
												$process_loss=$val['p_loss'];
												$labtest_no=$lab_dip_arr[$job_key]['labtest_no'];
												if($process_loss) $process_loss=$process_loss;else $process_loss=0;
												//echo $process_loss.'d';
												if($p_loss_method==1) //markup
												{

													$fin_qty=$val['fin_qty']-(($val['fin_qty']*$process_loss)/(100+$process_loss));
												}
												else if($p_loss_method==2) //margin
												{
													$fin_qty=$val['fin_qty']-(($val['fin_qty']*$process_loss)/100);
												}
												else $fin_qty=$val['fin_qty'];
												if($uom_id==$val['uom'])
												{
													$body_construction_composition_data=explode("***", $desc_key);
													$body_part='';
													$construction='';
													$composition='';
													if(count($body_construction_composition_data))
													{
														$body_part=$body_construction_composition_data[0];
													}
													if(count($body_construction_composition_data)>0)
													{
														$construction=$body_construction_composition_data[1];
													}
													if(count($body_construction_composition_data)>1)
													{
														$composition=$body_construction_composition_data[2];
													}
													?>
													<tr>
														<?
					                                    if($y==1)
														{
															?>
															<td width="30"  rowspan="<? echo $fab_row_span;?>"><? echo $p; ?></td>
															<td width="70" align="center" rowspan="<? echo $fab_row_span;?>"><p><? echo $val['job_no']; ?>&nbsp;</p></td>
															<td width="120" rowspan="<? echo $fab_row_span;?>"><p><? echo $val['style_ref_no']; ?>&nbsp;</p></td>
															<td width="120" rowspan="<? echo $fab_row_span;?>"><p><? echo $season_arr[$val['season_buyer_wise']]; ?>&nbsp;</p></td>
															<td  style="word-break:break-all;word-wrap: break-word;" width="120" rowspan="<? echo $fab_row_span;?>"><p><? echo $po_nos; ?>&nbsp;</p></td>
						                                    <?
														}

														?>
														<td width="150"><p><? echo $body_part; ?>&nbsp;</p></td>
														<td width="150"><p><? echo $construction; ?>&nbsp;</p></td>
														<td width="150"><p><? echo $composition; ?>&nbsp;</p></td>
														<td width="100"><p><? echo $commission_particulars[$val['source_id']]; ?>&nbsp;</p></td>
														<td width="50"><p><? echo $gsm_key; ?>&nbsp;</p></td>
														<td width="60"><p><? echo $dia_key; ?>&nbsp;</p></td>
														<td width="80"><p><? echo $color_type[$c_type_key]; ?>&nbsp;</p></td>
														<td width="100"><p><? echo $color_library[$gmt_color_key]; ?>&nbsp;</p></td>
														<td width="100"><p><? echo $color_library[$fab_color_key]; ?>&nbsp;</p></td>
					                                    <td width="120"><p><? echo $labtest_no; ?>&nbsp;</p></td>
														<?
															$img_ref_id=$val[('fabric_cost_dtls_id')].'_'.$val[('fab_color_id')];
	   														$fab_color_img=$system_img_arr[$img_ref_id]['img'];
														?>
														<td><img src='../../<? echo $fab_color_img; ?>' height='50' width='70' align="middle" /></td>
														
														<td width="100" align="right" title="(Markup/Margin Method) Process Loss=<? echo $process_loss;?>,Fin Qty=<? echo $val['fin_qty'];?>"><p><? echo number_format($val['fin_qty'],2); ?>&nbsp;</p></td>
														<td width="50"><p><? echo $unit_of_measurement[$val['uom']]; ?>&nbsp;</p></td>
												
														<td width="80" align="right"><p><? echo number_format($val['rates'],2); ?>&nbsp;</p></td>
														<td width="100" align="right"><p><? echo number_format($val['amounts'],2); ?>&nbsp;</p></td>
														
														<td width="200"><p><? echo $val['remark']; ?>&nbsp;</p></td>
													</tr>
													<?
													$k++;$y++;
													//$total_fin_qty+=$fin_qty;
													$total_fin_qty+=$val['fin_qty'];
													$total_grey_qty+=$val['grey_qty'];
													$total_amount+=$val['amounts'];
												}
											}
										}
									}
								}
							}
						}
						$p++;
					}
					?>
				        <tfoot>
				            <tr>
				                 <th colspan="16" align="right"> Total </th>
				                 <th align="right"> <? echo number_format($total_fin_qty,2); ?> </th>                  
				                 <th align="right"> <? //echo number_format($total_fin_qty,2); ?> </th>
								 <th align="right"> <? //echo number_format($total_fin_qty,2); ?> </th>
				                 <th align="right"> <? echo number_format($total_amount,2); ?> </th>
				            </tr>
				        </tfoot>
			    </table>
			    <?
		}
		$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count");
		if($job_nos!='')
		{
			$condition= new condition();
			if(str_replace("'","",$job_nos) !=''){
			$condition->job_no("in($job_nos)");
			}
			//".$job_nos."
			$condition->init();
			$yarn= new yarn($condition);
			//echo $yarn->getQuery(); die;
			$yarn_type_qty_arr=$yarn->getCountCompositionAndTypeWiseYarnQtyArray();
		}
		//print_r($yarn_type_qty_arr);
		$sql_yarn="select c.count_id,c.copm_one_id,c.percent_one,c.type_id,c.cons_qnty from wo_pre_cost_fab_yarn_cost_dtls c where c.job_no in(".$job_nos.") and c.status_active=1 ";
		$result_yarn=sql_select($sql_yarn);
		foreach($result_yarn as $row)
		{
			$yarn_data_arr[$row[csf('count_id')]][$row[csf('copm_one_id')]][$row[csf('type_id')]]['cons_qnty']+=$row[csf('cons_qnty')];
			$yarn_data_arr[$row[csf('count_id')]][$row[csf('copm_one_id')]][$row[csf('type_id')]]['percent_one']=$row[csf('percent_one')];
		}

		?>
		<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
	<tr>
	<td width="49%" style=" border-color:#000; border-width:thin" valign="top">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0">
	<thead>
	<tr>
	<th width="3%"></th><th width="97%" align="left"><u>Special Instruction</u></th>
	</tr>
	</thead>
	<tbody>
	<?
	$data_array=sql_select("select id, terms from  wo_booking_terms_condition where booking_no=$txt_booking_no");
	if ( count($data_array)>0)
	{
	$i=0;
	foreach( $data_array as $row )
	{
	$i++;
	?>
	<tr id="settr_1" valign="top">
	<td style="vertical-align:top">
	<? echo $i;?>
	</td>
	<td>
	<strong style="font-size:14px"> <? echo $row[csf('terms')]; ?></strong>
	</td>
	</tr>
	<?
	}
	}
	?>
	</tbody>
	</table>
                  
        <br>
	   <?
	   
		  echo signature_table(121, $cbo_company_name, "1000px",$template_id, 40, $user_lib_name_arr[$inserted_by]);
       ?>

	</div>
    <?

	$html = ob_get_contents();
	ob_clean();
	list($is_mail_send,$mail)=explode('___',$mail_send_data);
	
	if($is_mail_send==1){
		require_once('../../../mailer/class.phpmailer.php');
		require_once('../../../auto_mail/setting/mail_setting.php');
		$mailBody = preg_replace("/<img[^>]+\>/i", " ", $html); 
		$mailBody="<br>".$mail_body	;	
		$mailToArr=array();
		$mailSql = "select b.EMAIL  from wo_booking_mst a,LIB_SUPPLIER b where b.id=a.supplier_id and a.booking_no=$txt_booking_no";
	 //echo $mailSql;die;
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
		}
		
		
		$mailSql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=99 and b.mail_user_setup_id=c.id  and c.IS_DELETED=0 and c.STATUS_ACTIVE=1";
		//echo $mailSql;die;
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
		}
		if($mail!=''){$mailToArr[]=$mail;}

		$to=implode(',',$mailToArr);
		$subject="Partial fabric booking";
		$header=mailHeader();
		echo $to;
		echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
		
	}
	else{
		echo $html;
	}
	exit();


}

if($action=="print_booking_19") //md mamun ahmed sagor->>>>30-07-2022
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$show_yarn_rate=str_replace("'","",$show_yarn_rate);

	$path=str_replace("'","",$path);
	if($path!="") $path=$path; else $path="../../";

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' or form_name='knit_order_entry' and file_type=1",'master_tble_id','image_location');
	$company_library=return_library_array( "select id,company_name from lib_company where status_active=1 and is_deleted=0", "id", "company_name");
	$color_library=return_library_array( "select id,color_name from lib_color ", "id", "color_name");
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier  where status_active=1 and is_deleted=0",'id','supplier_name');
	$contact_email_arr=return_library_array( "select id,email from   lib_supplier  where status_active=1 and is_deleted=0",'id','email');
	$contact_no_arr=return_library_array( "select id,contact_no from   lib_supplier  where status_active=1 and is_deleted=0",'id','contact_no');
	$supplier_address_arr=return_library_array( "select id,address_1 from   lib_supplier  where status_active=1 and is_deleted=0",'id','address_1');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info  where status_active=1 and is_deleted=0","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer  where status_active=1 and is_deleted=0",'id','buyer_name');
	$po_number_arr=return_library_array( "select id,po_number from wo_po_break_down  where status_active=1 and is_deleted=0",'id','po_number');
	$nameArray_approved=sql_select( "select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and a.status_active =1 and a.is_deleted=0");

	$data_img=sql_select("select image_location,master_tble_id  from common_photo_library  where   form_name='fabric_color_img' and is_deleted=0 and file_type=1");
	$user_lib_name_arr=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");
	$system_img_arr=array();
	foreach($data_img as $row)
	{
	  $system_img_arr[$row[csf('master_tble_id')]]['img']=$row[csf('image_location')];
	}
	list($nameArray_approved_row)=$nameArray_approved;

	$job_po_arr=array();
	$ref_no='';$job_no_aarr='';
	$nameArray_per_job=sql_select( "select  a.job_no,a.style_ref_no,b.po_break_down_id,c.po_number,c.grouping  from wo_po_details_master a, wo_booking_dtls b, wo_po_break_down c where c.id=b.po_break_down_id and a.job_no=b.job_no and  a.job_no=c.job_no_mst and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by a.job_no,a.style_ref_no,b.po_break_down_id,c.grouping,c.po_number");
	foreach ($nameArray_per_job as $row_per_job)
	{
		$job_no_aarr.="'".$row_per_job[csf('job_no')]."'".',';
		$job_po_arr[$row_per_job[csf('job_no')]].=$row_per_job[csf('po_number')].',';
		if($ref_no=='') $ref_no=$row_per_job[csf('grouping')]; else $ref_no.=",".$row_per_job[csf('grouping')];

	}
	$job_nos=rtrim($job_no_aarr,',');
	$job_nos=implode(",",array_unique(explode(",",$job_nos)));
	//$ref_no=$ref_no;
	$ref_nos=implode(",",array_unique(explode(",",$ref_no)));
	$job_no_mst_cond=where_con_using_array(array_unique(explode(",",$job_nos)),0,"job_no_mst");
	$int_ref_arr=return_library_array( "select job_no_mst,grouping from wo_po_break_down  where status_active=1 and is_deleted=0 $job_no_mst_cond",'job_no_mst','grouping');
	//echo "select job_no_mst,grouping from wo_po_break_down  where status_active=1 and is_deleted=0 $job_no_mst_cond";
	//$job_nos=explode(",",$job_nos);
	//print_r($job_no_aarr);
	$job_data_arr=array();
	$nameArray_buyer=sql_select( "select  a.style_ref_no,a.style_description, a.job_no, a.style_owner, a.buyer_name, a.dealing_marchant,a.season,a.season_matrix,a.total_set_qnty,a.product_dept,a.product_code,a.pro_sub_dep,a.gmts_item_id ,a.order_repeat_no,a.qlty_label ,b.booking_no,a.ship_mode from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0 and a.job_no in(".$job_nos.") order by a.job_no ");
	
	foreach ($nameArray_buyer as $result_buy)
	{
		$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
		$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
		$dealing_marchant.=$marchentrArr[$result_buy[csf('dealing_marchant')]].',';

			$ship_mode_arr[$result_buy[csf('booking_no')]][$result_buy[csf('ship_mode')]]=$shipment_mode[$result_buy[csf('ship_mode')]];
 	}

  //print_r($job_data_arr);
	$dealing_marchant=rtrim($dealing_marchant,',');
	$dealing_marchants=implode(",",array_unique(explode(",",$dealing_marchant)));
	//$dealing_marchants=implode(",",array_unique($job_data_arr['dealing_marchant']));
	$nameArray=sql_select( "select a.buyer_id,a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.fabric_source,a.remarks,a.pay_mode,a.fabric_composition,a.ship_mode,a.tenor,a.pay_term,a.inserted_by,a.source from wo_booking_mst a   where  a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0");
	$season_arr=return_library_array("select id,season_name from lib_buyer_season","id","season_name");
	
	//print_r($shipment_mode);
	foreach ($nameArray as $result_job)
	{
		$booking_date=$result_job[csf('booking_date')];
		$buyer_id=$result_job[csf('buyer_id')];
		$currency_id=$result_job[csf('currency_id')];
		$attention=$result_job[csf('attention')];
		$delivery_date=$result_job[csf('delivery_date')];
		$supplier_id=$result_job[csf('supplier_id')];
		$remarks=$result_job[csf('remarks')];
		$paymode=$result_job[csf('pay_mode')];
		$tenor=$result_job[csf('tenor')];
		$payterm=$result_job[csf('pay_term')];
		$sources=$source[$result_job[csf('source')]];
		$fab_source=$fabric_source[$result_job[csf('fabric_source')]];
		$ship_mode=$shipment_mode[$result_job[csf('ship_mode')]];
		$inserted_by=$result_job[csf('inserted_by')];
		if(empty($ship_mode))
		{
			$ship_mode=implode(",",$ship_mode_arr[$result_job[csf('booking_no')]][$result_job[csf('ship_mode')]]);
		}
		
	}
	//echo $booking_date.'ddd';
	ob_start();
	?>
    <style>

		@media print
		{
		     .page-break { height:0; page-break-before:always; margin:0; border-top:none; }
		}
	     body, p, span, td, a {font-size:10pt;font-family: Arial;}
	     body{margin-left:2em; margin-right:2em; font-family: "Arial Narrow", Arial, sans-serif;}
	</style>
	<div style="width:1310px" align="center">
		<table width="100%" cellpadding="0" cellspacing="0" style="border:0px solid black" >
			<tr>
				<td width="100">
					<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
				</td>
				<td width="1250">
					<table width="100%" cellpadding="0" cellspacing="0"  border="0" >
						<tr>
							<td align="center"><p><b style="font-size:xx-large">
								<?php
								echo $company_library[$cbo_company_name].'</b>';
								$country_arr=return_library_array( "select id, country_name from lib_country",'id','country_name');
								$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
								// echo "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name";
								if($txt_job_no!="")
								{
									$location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'");
								}
								else
								{
									$location="";
								}
								foreach ($nameArray as $result)
								{
									$email=$result[csf('email')];
									$city=$result[csf('city')];
									//echo  $location_name_arr[$location];
									?> 
								   <br>
									 <? echo $result[csf('plot_no')]."-".$result[csf('level_no')].",".$result[csf('road_no')].",".$result[csf('block_no')]."<br>".$result[csf('city')].",".$result[csf('zip_code')].",".$country_arr[$result[csf('country_id')]]."<br>";?>
									Email Address: <? echo $email;?>
									Website: <? echo $result[csf('website')]; ?>
									<?
								}

								?>
								</p>
							</td>
							<td rowspan="3" width="250">
								<!-- <span><b> Booking No:&nbsp;&nbsp;<? echo trim($txt_booking_no,"'"); ?></b></span><br/>
							    <span><b> Booking Date :&nbsp;&nbsp;<? //echo change_date_format($booking_date); ?></b></span><br/> -->
								<?
								if($nameArray_approved_row[csf('approved_no')]>1)
								{
									?>
									<b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
									<br/>
									Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
									<?
								}
								?>
							</td>
						</tr>
						<tr>
							<td align="center">
							<strong><? if($report_title !=""){ echo $report_title.":-".trim($txt_booking_no,"'");}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
							</td>
						</tr>
						<tr>
							<td align="center">&nbsp;
							
							</td>
						</tr>
					</table>
				</td>
			</tr>
	    </table>
	    <table width="100%" style="border:0px solid black;table-layout: fixed;" >
				<tr>
					<td width="200"><span><b>To </b></span></td>
					<td width="280">&nbsp;<span></span></td>
					<td width="200"><span><b>Booking Date</b></span></td>
				    <td width="230"><span> :&nbsp;<b><? echo change_date_format($booking_date);  ?></b></span></td>
					<td width="200"><b>Delivery Date</b></td>
					<td width="230">:&nbsp;<b><? echo change_date_format($delivery_date); ?></b></td>
				</tr>
				<tr>
					<td width="200"><b>Supplier Name </b>   </td>
					<td width="280">:&nbsp;
					<?
					$supp_address=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website,contact_no from lib_company where id=$supplier_id");

				



					if($paymode==5 || $paymode==3){
					echo $company_library[$supplier_id];
				
					$suplier_address=$supp_address[0][csf('plot_no')]."-".$supp_address[0][csf('level_no')].",".$supp_address[0][csf('road_no')].",".$supp_address[0][csf('block_no')]."<br>".$supp_address[0][csf('city')].",".$supp_address[0][csf('zip_code')].",".$country_arr[$supp_address[0][csf('country_id')]];
					}
					else{
					echo $supplier_name_arr[$supplier_id];
					$suplier_address=$supplier_address_arr[$supplier_id];
					}
					?>    </td>
					<td><b>Ship Mode</b></td>
					<td>:&nbsp;<?=$ship_mode;?></td>	
					<td width="200"><span><b>Pay Term</b></span></td>
				    <td width="230"><span> :&nbsp;<? echo $pay_term[$payterm]; ?></span></td>
				</tr>
				<tr>
					<td width="200"><b>Address</b></td>
					<td width="280">:&nbsp;<? echo $suplier_address; ?></td>
					<td width="200"><span><b>Buyer</b></span></td>
				    <td width="230"><span> :&nbsp;<? echo $buyer_name_arr[$buyer_id]; ?></span></td>
					<td width="200"><span><b>Tenor</b></span></td>
				    <td width="230"><span> :&nbsp;<? echo $tenor; ?></span></td>
				</tr>
				
				<tr>
					<td width="200"><b>Contact No</b></td>
					<td width="280">:&nbsp;<? echo $supp_address[0][csf('contact_no')]; ?></td>
					<td width="200"><b>Dealing Marchant</b></td>
					<td width="" >:&nbsp;<? echo $dealing_marchants;?></td>
				
					<td width="200"><span><b>Pay Mode </b></span></td>
				    <td width="230"><span> :<?php echo $pay_mode[$paymode]; ?></span></td>
				
				</tr>
				<tr>
				
					<td width="200"><b>Contact Person</b></td>
					<td  width="280">:&nbsp;<? echo $attention; ?></td>
					<td width="200"><span><b>Fabric Source</b></span></td>
				    <td width="230"><span> :&nbsp;<? echo $fab_source; ?></span></td>
					<td width="200"><b>Currency </b>   </td>
					<td width="230">:&nbsp;
					<? 
					echo $currency[$currency_id];
					?>
					</td>
				
				</tr>
				<tr>
				
				<td width="200"><b>Source</b></td>
				<td  width="280" colspan="5">:&nbsp;<? echo $sources; ?></td>
			
			
			
			</tr>

				<tr>
					<td width="200"><b>Remark</b></td>
					<td conspan="6"> :<? echo $remarks;?></td>
				</tr>
		</table>
	    <?
	    
		$color_wise_process_loss=sql_select("select  a.id, a.job_no,a.body_part_id,b.color_number_id,a.process_loss_method,b.process_loss_percent as loss,b.remarks FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls  b 	WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and  a.job_no in(".$job_nos.")  group by a.id, a.job_no,a.body_part_id,a.process_loss_method,b.color_number_id,b.process_loss_percent,b.remarks ");
		foreach($color_wise_process_loss as $val)
		{
				if($val[csf("process_loss_percent")]>0){
					$loss_arr[$val[csf("id")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['loss']=$val[csf("loss")];
					$loss_arr[$val[csf("id")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['loss']=$val[csf("loss")];
				}
				$loss_arr[$val[csf("id")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['remarks']=$val[csf("remarks")];
		}
		if($job_nos!='')
		{
			//$lab_dip=sql_select("select  b.job_no,a.labtest_no FROM wo_labtest_mst a, wo_labtest_dtls  b WHERE a.id=b.mst_id and b.job_no in(".$job_nos.") ");
			$lab_dip=sql_select("select lapdip_no, color_name_id, job_no_mst from wo_po_lapdip_approval_info where job_no_mst in(".$job_nos.") and status_active=1 and is_deleted=0 and approval_status=3");
			foreach($lab_dip as $row)
			{
				$lab_dip_arr[$row[csf("job_no_mst")]]['labtest_no']=$row[csf("lapdip_no")];

			}
		}
		
		//wo_labtest_mst
	   $sql_booking="SELECT  a.job_no,a.id as fabric_cost_dtls_id, a.body_part_id,a.color_type_id as c_type, a.construction, a.composition, a.gsm_weight as gsm, d.dia_width as dia,a.uom,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,avg(d.rate) as rates,sum(d.amount) as amounts ,d.remark,c.style_ref_no,c.job_no_prefix_num,d.fabric_color_id as fab_color,d.gmts_color_id as gmt_color,c.season_buyer_wise,a.source_id ,d.po_break_down_id
		FROM wo_pre_cost_fabric_cost_dtls a,  wo_booking_dtls d,wo_po_details_master c
		WHERE   a.job_no=d.job_no and a.id=d.pre_cost_fabric_cost_dtls_id  and a.job_no=c.job_no  and d.job_no=c.job_no
		and d.booking_no =$txt_booking_no and d.job_no in(".$job_nos.") and d.status_active=1 and d.is_deleted=0
		group by  a.job_no,a.id, a.body_part_id,a.color_type_id, a.construction, a.composition,d.fabric_color_id,d.gmts_color_id, a.gsm_weight, d.dia_width,a.uom,c.style_ref_no,c.job_no_prefix_num,d.remark,c.season_buyer_wise,a.source_id,d.po_break_down_id  order by a.job_no,d.fabric_color_id ";
	//	echo $sql_booking;//die;
		 $result_set=sql_select($sql_booking);
		 foreach( $result_set as $row)
		 {
				$body_part_id=$body_part[$row[csf("body_part_id")]];
				$uom_data_arr[$row[csf("uom")]]=$unit_of_measurement[$row[csf("uom")]];
				$construction=$row[csf("construction")];
				$compositions= $row[csf("composition")];
				$item_desc=$body_part_id.'***'.$row[csf("construction")].'***'.$compositions;
			
				$remarks=$loss_arr[$row[csf("fabric_cost_dtls_id")]][$row[csf("job_no")]][$row[csf("body_part_id")]][$row[csf("gmt_color")]]['remarks'];

				$desc=$row[csf("construction")].'**'.$row[csf("composition")].'**'.$row[csf("gsm")].'**'.$row[csf("dia")];
				 $desc_data_arr[$desc]=$row[csf("construction")].' '.$row[csf("composition")].' GSM- '.$row[csf("gsm")].' With/Dia- '.$row[csf("dia")]." ".$remarks;

				 $fabric_data_arr[$desc][$row[csf("fab_color")]]['uom']=$row[csf("uom")];
				 $fabric_data_arr[$desc][$row[csf("fab_color")]]['rates']=$row[csf("rates")];
				 $fabric_data_arr[$desc][$row[csf("fab_color")]]['amounts']=$row[csf("amounts")];
				 $fabric_data_arr[$desc][$row[csf("fab_color")]]['fabric_cost_dtls_id']=$row[csf("fabric_cost_dtls_id")];
				
				
				
				 if($show_yarn_rate==1){
					$order_arr[$row[csf("style_ref_no")]]=$row[csf("style_ref_no")];
					$order_wise_fab_qnty[$desc][$row[csf("fab_color")]][$row[csf("style_ref_no")]]['qnty']+=$row[csf("fin_fab_qntys")];
				 }else{
					$order_arr[$row[csf("po_break_down_id")]]=$po_number_arr[$row[csf("po_break_down_id")]];
					$order_wise_fab_qnty[$desc][$row[csf("fab_color")]][$row[csf("po_break_down_id")]]['qnty']+=$row[csf("fin_fab_qntys")];
				 }


				$process_loss=$loss_arr[$row[csf("fabric_cost_dtls_id")]][$row[csf("job_no")]][$row[csf("body_part_id")]][$row[csf("gmt_color")]]['loss'];
				$process_loss_method=$loss_arr[$row[csf("fabric_cost_dtls_id")]][$row[csf("job_no")]][$row[csf("body_part_id")]][$row[csf("gmt_color")]]['loss_method'];
				if($process_loss=='') $process_loss=0;else $process_loss=$process_loss;
				if($process_loss_method=='') $process_loss_method=0;else $process_loss_method=$process_loss_method;


			
				$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['p_loss']=$process_loss;
				$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['p_loss_method']=$process_loss_method;
	
		

			}
		//  print_r($desc_data_arr);
		 $fab_row_span_arr=array();
		 $grand_total=0;
		foreach($desc_data_arr as $desc_id=>$desc)
		{
			?>
			<br>
		   		<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
					<tr> <th colspan="<?=count($order_arr)+6;?>" align="left"><h3><? echo $desc;?></h3></th> </tr>
					<tr>
				     
				        <th  width="100" align="center">color</th>
				        <th  width="120" align="center">Fabric Image</th>
						<?php
						foreach($order_arr as $poid=>$val){?>
							<th width='100' align="center"><?=$val;?></th>	
						<?	}?>

						<th width='80' align="center">Total</th>
						<th  width="50" align="center">UOM</th>			
						<th width='100' align="center">Rate (USD)</th>	     
				        <th width='100' align="center">Amount</th>		       
					</tr>
				   <?
					// print_r($body_rowspan_arr);
				
					$po_total=array();$color_total=array();$amount_total=0;$desc_total=0;
					foreach($fabric_data_arr[$desc_id] as $color_id=>$val)
					{
						
												$po_nos=rtrim($job_po_arr[$job_key],',');
												$po_nos=implode(",",array_unique(explode(",",$po_nos)));
												$fab_row_span=$fab_row_span_arr[$job_key];
												$p_loss_method=$val['p_loss_method'];
												$process_loss=$val['p_loss'];
												$labtest_no=$lab_dip_arr[$job_key]['labtest_no'];
												if($process_loss) $process_loss=$process_loss;else $process_loss=0;
												//echo $process_loss.'d';
												if($p_loss_method==1) //markup
												{

													$fin_qty=$val['fin_qty']-(($val['fin_qty']*$process_loss)/(100+$process_loss));
												}
												else if($p_loss_method==2) //margin
												{
													$fin_qty=$val['fin_qty']-(($val['fin_qty']*$process_loss)/100);
												}
												else $fin_qty=$val['fin_qty'];
											
													


												
												$img_ref_id=$val['fabric_cost_dtls_id'].'_'.$color_id;
												   $fab_color_img=$system_img_arr[$img_ref_id]['img'];
											

													?>
													<tr>
														
														<td width="150"><p><? echo  $color_library[$color_id]; ?>&nbsp;</p></td>
														<td><img src='../../<? echo $fab_color_img; ?>' height='50' width='70' align="middle" /></td>
														<?php
														foreach($order_arr as $poId=>$pval){?>
														
														<td width="100" align="right"><p><?
														
														echo $order_wise_fab_qnty[$desc_id][$color_id][$poId]['qnty'];; ?>&nbsp;</p></td>
															
															<?
																$po_total[$poId]+=$order_wise_fab_qnty[$desc_id][$color_id][$poId]['qnty'];
																$color_total[$color_id]+=$order_wise_fab_qnty[$desc_id][$color_id][$poId]['qnty'];
														
															}
														
														?>
					                            
														<td width="100" align="right" ><p><? echo number_format($color_total[$color_id],2); ?>&nbsp;</p></td>
														<td width="50"><p><? echo $unit_of_measurement[$val['uom']]; ?>&nbsp;</p></td>
												
														<td width="80" align="right"><p><? echo number_format($val['rates'],2); ?>&nbsp;</p></td>
														<td width="100" align="right"><p><? echo number_format($color_total[$color_id]*$val['rates'],2); ?>&nbsp;</p></td>
														
														
													</tr>
													<?
													$amount_total+=$color_total[$color_id]*$val['rates'];
													$grand_total+=$color_total[$color_id]*$val['rates'];
					}
					?>
				        <tfoot>
				            <tr>
				                 <th colspan="2" align="right"> Total </th>
								 <?php
									foreach($order_arr as $poid=>$pval){?>
				                 <th align="right"> <? echo number_format($po_total[$poid],2); 
								 	$desc_total+=$po_total[$poid];
								 ?> </th>        
								 <?}?>          
				                 <th align="right"><?=number_format($desc_total,2);;?>  </th>
								 <th align="right">  </th>
								 <th align="right">  </th>
				                 <th align="right"> <? echo number_format($amount_total,2); ?> </th>
				            </tr>
				        </tfoot>
			    </table>
			    <?
		}?>
	<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
				
		<tr>
			 <th colspan="2" align="right" colspan="<?=count($order_arr)+5;?>">Grand Total </th>
			 <th align="right"> <? echo number_format($grand_total,2); ?> </th>
		</tr>
	</table>
		

		<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
	<tr>
	<td width="49%" style=" border-color:#000; border-width:thin" valign="top">
	<table  width="100%"  border="1" cellpadding="0" cellspacing="0">
	<thead>
	<tr>
	<th width="3%"></th><th width="97%" align="left"><u>Special Instruction</u></th>
	</tr>
	</thead>
	<tbody>
	<?
	$data_array=sql_select("select id, terms from  wo_booking_terms_condition where booking_no=$txt_booking_no");
	if ( count($data_array)>0)
	{
	$i=0;
	foreach( $data_array as $row )
	{
	$i++;
	?>
	<tr id="settr_1" valign="top">
	<td style="vertical-align:top">
	<? echo $i;?>
	</td>
	<td>
	<strong style="font-size:14px"> <? echo $row[csf('terms')]; ?></strong>
	</td>
	</tr>
	<?
	}
	}
	?>
	</tbody>
	</table>
                  
        <br>
	   <?
	   
		  echo signature_table(121, $cbo_company_name, "1000px",$template_id, 40, $user_lib_name_arr[$inserted_by]);
       ?>

	</div>
    <?

	$html = ob_get_contents();
	ob_clean();
	list($is_mail_send,$mail)=explode('___',$mail_send_data);
	
	if($is_mail_send==1){
		require_once('../../../mailer/class.phpmailer.php');
		require_once('../../../auto_mail/setting/mail_setting.php');
		$mailBody = preg_replace("/<img[^>]+\>/i", " ", $html); 
		$mailBody="<br>".$mail_body	;	
		$mailToArr=array();
		$mailSql = "select b.EMAIL  from wo_booking_mst a,LIB_SUPPLIER b where b.id=a.supplier_id and a.booking_no=$txt_booking_no";
	 //echo $mailSql;die;
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
		}
		
		
		$mailSql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=99 and b.mail_user_setup_id=c.id  and c.IS_DELETED=0 and c.STATUS_ACTIVE=1";
		//echo $mailSql;die;
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
		}
		if($mail!=''){$mailToArr[]=$mail;}

		$to=implode(',',$mailToArr);
		$subject="Partial fabric booking";
		$header=mailHeader();
		echo $to;
		echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
		
	}
	else{
		echo $html;
	}
	exit();


}

if($action=="print_booking_20")//shariar 3597
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";
	if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
	if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$company_library=return_library_array( "select id,company_name from lib_company where status_active=1 and is_deleted=0", "id", "company_name");
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	$lip_yarn_count=return_library_array( "select id,fabric_composition_id from lib_yarn_count_determina_mst where  status_active=1", "id", "fabric_composition_id");
	$fabric_composition=return_library_array( "select id,fabric_composition_name from lib_fabric_composition where  status_active=1", "id", "fabric_composition_name");
	$size_library=return_library_array( "select id,size_name from lib_size  where status_active=1 and is_deleted=0", "id", "size_name");
	$team_leader_arr=return_library_array( "select id,team_leader_name from lib_marketing_team",'id','team_leader_name');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name"  );
	$user_arr=return_library_array( "select id,user_name from   user_passwd ",'id','user_name');

	$job_data_arr=array();
	$nameArray_buyer=sql_select( "select  a.style_ref_no,a.style_description, a.job_no, a.style_owner, a.buyer_name, a.client_id, a.dealing_marchant, a.season, a.season_matrix, a.total_set_qnty, a.product_dept, a.product_code, a.pro_sub_dep, a.gmts_item_id, a.order_repeat_no, a.qlty_label,a.season_buyer_wise from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0");
	foreach ($nameArray_buyer as $result_buy){
	$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
	$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
	$job_data_arr['total_set_qnty'][$result_buy[csf('job_no')]]=$result_buy[csf('total_set_qnty')];
	$job_data_arr['product_dept'][$result_buy[csf('job_no')]]=$product_dept[$result_buy[csf('product_dept')]];
	$job_data_arr['product_code'][$result_buy[csf('job_no')]]=$result_buy[csf('product_code')];
	$job_data_arr['pro_sub_dep'][$result_buy[csf('job_no')]]=$pro_sub_dept_array[$result_buy[csf('pro_sub_dep')]];
	$job_data_arr['gmts_item_id'][$result_buy[csf('job_no')]]=$result_buy[csf('gmts_item_id')];
	$job_data_arr['style_ref_no'][$result_buy[csf('job_no')]]=$result_buy[csf('style_ref_no')];
	$job_data_arr['style_description'][$result_buy[csf('job_no')]]=$result_buy[csf('style_description')];
	$job_data_arr['dealing_marchant'][$result_buy[csf('job_no')]]=$marchentrArr[$result_buy[csf('dealing_marchant')]];
	$job_data_arr['season_matrix'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_matrix')]];
	$job_data_arr['season_buyer_wise'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_buyer_wise')]];
	$job_data_arr['order_repeat_no'][$result_buy[csf('job_no')]]=$result_buy[csf('order_repeat_no')];
	$job_data_arr['qlty_label'][$result_buy[csf('job_no')]]=$quality_label[$result_buy[csf('qlty_label')]];
	$job_data_arr['client'][$result_buy[csf('job_no')]]=$result_buy[csf('client_id')];
	}

	$po_arr= sql_select("select b.grouping from wo_booking_dtls a,wo_po_break_down b where a.job_no=b.job_no_mst and b.status_active=1 and a.booking_no=$txt_booking_no");
	$internal_ref_no="";
	foreach($po_arr as $row)
	{
		if($internal_ref_no=="") $internal_ref_no=$row[csf('grouping')];else $internal_ref_no.=",".$row[csf('grouping')];
		$intRef[$row[csf('grouping')]]=$row[csf('grouping')];
	}

	$job_no= implode(",",array_unique($job_data_arr['job_no']));
	$job_no_in= implode(",",array_unique($job_data_arr['job_no_in']));
	$product_depertment=implode(",",array_unique($job_data_arr['product_dept']));
	$product_code=implode(",",array_unique($job_data_arr['product_code']));
	$pro_sub_dep=implode(",",array_unique($job_data_arr['pro_sub_dep']));
	$gmts_item_id=implode(",",array_unique($job_data_arr['gmts_item_id']));
	$style_sting=implode(",",array_unique($job_data_arr['style_ref_no']));
	$style_description=implode(",",array_unique($job_data_arr['style_description']));
	$dealing_marchant=implode(",",array_unique($job_data_arr['dealing_marchant']));
	$season_matrix=implode(",",array_unique($job_data_arr['season_matrix']));
	$season_buyer_wise=implode(",",array_unique($job_data_arr['season_buyer_wise']));
	$order_repeat_no= implode(",",array_unique($job_data_arr['order_repeat_no']));
	$qlty_label= implode(",",array_unique($job_data_arr['qlty_label']));
	$client_id= implode(",",array_unique($job_data_arr['client']));
	?>
	<div style="width:1330px" align="center">
	<?php
	$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and a.status_active =1 and a.is_deleted=0 ");
	list($nameArray_approved_row) = $nameArray_approved;
	$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0 ");
	list($nameArray_approved_date_row) = $nameArray_approved_date;
	$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0 ");
	list($nameArray_approved_comments_row) = $nameArray_approved_comments;
	$path = str_replace("'", "", $path);
	if ($path != "") {
		$path = $path;
	} else {
		$path = "../../";
	}
	ob_start();
	?>										<!--    Header Company Information         -->
	<style type="text/css">
		 .table_valign { vertical-align: top;word-break: break-all;word-wrap: break-word; }
	</style>
	<table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black"  >
	<tr>
	<td width="100">
	<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
	</td>
	<td width="1250">
	<table width="100%" cellpadding="0" cellspacing="0"  >
	<tr>
	<td align="center" style="font-size:20px;">
	<?php echo $company_library[$cbo_company_name];?>
	</td>
	<td rowspan="3" width="250">

	<span style="font-size:18px"><b>Internal Booking NO.:&nbsp;&nbsp;<?
							   $ref_no=trim($internal_ref_no,"'");
							   $ref_nos=implode(", ",array_unique(explode(",",$ref_no)));
							    echo $ref_nos; ?></b></span><br/>
	<?
	if($nameArray_approved_row[csf('approved_no')]>1)
	{
	?>
	<b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
	<br/>
	Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
	<?
	}
	?>


	</td>
	</tr>
	<tr>
	<td align="center" style="font-size:14px">
	<?
		$country_full_name = return_library_array("SELECT id,country_name from lib_country", "id", "country_name");
		$sqlCom="select company_name, email, website, plot_no, level_no, road_no, block_no, country_id, province, city, zip_code, contact_no from lib_company where id='$cbo_company_name' and status_active=1 and is_deleted=0";
		$sqlComRes=sql_select($sqlCom);
		$comName=$comAdd=$comPhone=$comPax=$comEmail=$comWeb=""; $consigneeDtls="";
		foreach( $sqlComRes as $row)
		{
			$comName=$row[csf("company_name")];
			
			if($row[csf("level_no")])		$level_no 	= $row[csf("level_no")].', ';
			if($row[csf("plot_no")])		$plot_no 	=$row[csf("plot_no")].', ';
			if($row[csf("road_no")]) 		$road_no 	=$row[csf("road_no")].', ';
			if($row[csf("block_no")]!='')	$block_no 	=$row[csf("block_no")].', ';
			if($row[csf("zip_code")]!='')	$zip_code 	= ' -'.$row[csf("zip_code")].' , ';
			if($row[csf("city")]!='') 		$city 		= ($zip_code!="")?$row[csf("city")]:$row[csf("city")]." ,";
			if($row[csf("country_id")]!='')	$country 	= $country_full_name[$row[csf("country_id")]].'.,';
			
			$comAdd="Level No-".$level_no."Plot No-".$plot_no."Road No-".$road_no."Block No-".$block_no.$city.$zip_code.$country.$row[csf("email")].",".$row[csf("website")];
			$comPhone=$row[csf("contact_no")];
			$comEmail=$row[csf("email")];
			$comWeb=$row[csf("website")];
		}



	
	echo $comAdd;?>
	</td>
	</tr>
	<tr>
	<td align="center" style="font-size:20px">
	<strong>Purchase Fabric Booking Sheet &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
	</td>
	</tr>
	</table>
	</td>
	</tr>
	</table>
	<?
	$po_data=array();
	if($db_type==0){
	$nameArray_job=sql_select( "select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,DATEDIFF(pub_shipment_date,po_received_date) date_diff,MIN(po_received_date) as po_received_date ,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status  from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0   group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
	}
	if($db_type==2){
	$nameArray_job=sql_select( "select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,(pub_shipment_date-po_received_date) date_diff,MIN(po_received_date) as po_received_date,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status   from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0  group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
	}
	foreach ($nameArray_job as $result_job){
		$po_data['po_id'][$result_job[csf('id')]]=$result_job[csf('id')];
		$po_data['po_number'][$result_job[csf('id')]]=$result_job[csf('po_number')];
		$po_data['leadtime'][$result_job[csf('id')]]=$result_job[csf('date_diff')];
		$po_data['po_quantity'][$result_job[csf('id')]]=$result_job[csf('po_quantity')];
		$po_data['po_received_date'][$result_job[csf('id')]]=change_date_format($result_job[csf('po_received_date')],'dd-mm-yyyy','-');
		$ddd=strtotime($result_job[csf('pub_shipment_date')]);
		$po_data['pub_shipment_date'][$ddd]=$ddd;
		$po_data['pub_shipment_date_po'][$result_job[csf('id')]]=$result_job[csf('pub_shipment_date')];
		
		$po_data['insert_date'][$result_job[csf('id')]]=$result_job[csf('insert_date')];

		if($result_job[csf('shiping_status')]==1){
		$shiping_status= "FP";
		}
		else if($result_job[csf('shiping_status')]==2){
		$shiping_status= "PS";
		}
		else if($result_job[csf('shiping_status')]==3){
		$shiping_status= "FS";
		}
		$po_data['shiping_status'][$result_job[csf('id')]]=$shiping_status;
		$po_data['file_no'][$result_job[csf('id')]]=$result_job[csf('file_no')];
		$po_data['grouping'][$result_job[csf('id')]]=$result_job[csf('grouping')];
	}
	$txt_order_no_id=implode(",",array_unique($po_data['po_id']));
	$leadtime=implode(",",array_unique($po_data['leadtime']));
	$po_quantity=array_sum($po_data['po_quantity']);
	$po_received_date=implode(",",array_unique($po_data['po_received_date']));
	$po_number=implode(",",array_unique($po_data['po_number']));
	$shipment_date=date('d-m-Y',min($po_data['pub_shipment_date']));
	$maxshipment_date=date('d-m-Y',max($po_data['pub_shipment_date']));
	$shiping_status=implode(",",array_unique($po_data['shiping_status']));
	$file_no=implode(",",array_unique($po_data['file_no']));
	$grouping=implode(",",array_unique($po_data['grouping']));

	$condition= new condition();
	if($txt_order_no_id !='')
	{
		$condition->po_id_in($txt_order_no_id);
	}
	$condition->init();
	$fabric= new fabric($condition);
	$fabric_costing_qty_arr=$fabric->getQtyArray_by_orderAndGmtscolor_knitAndwoven_greyAndfinish();



	$colar_excess_percent=0;
	$cuff_excess_percent=0;
	$rmg_process_breakdown=0;
	$nameArray=sql_select( "select a.buyer_id,a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.update_date,a.uom,a.remarks,a.pay_mode,a.fabric_composition from wo_booking_mst a  where   a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 ");
	foreach ($nameArray as $result)
	{
		$total_set_qnty=$result[csf('total_set_qnty')];
		$booking_uom=$result[csf('uom')];
		$colar_excess_percent=$result[csf('colar_excess_percent')];
		$cuff_excess_percent=$result[csf('cuff_excess_percent')];
		$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
		foreach ($po_data['po_id'] as $po_id=>$po_val){
			$daysInHand.=(datediff('d',date('d-m-Y',time()),$po_data['pub_shipment_date_po'][$po_id])-1).",";
			$booking_date=$result[csf('update_date')];
			if($booking_date=="" || $booking_date=="0000-00-00 00:00:00"){
			$booking_date=$result[csf('insert_date')];
			}
			$WOPreparedAfter.=(datediff('d',$po_data['insert_date'][$po_id],$booking_date)-1).",";
		}
	?>
	<table width="100%" style="border:1px solid black;table-layout: fixed;" id="table_h" >
	<tr>
		<td width="200"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
		<td width="220">:&nbsp;<span style="font-size:16px"><b><? $buyer_name_str=""; if($client_id!=0) $buyer_name_str=$buyer_name_arr[$result[csf('buyer_id')]]."-".$buyer_name_arr[$client_id]; else $buyer_name_str=$buyer_name_arr[$result[csf('buyer_id')]]; echo $buyer_name_str; ?></b></span></td>
		<td width="200"><span style="font-size:18px"><b>Dept.</b></span></td>
		<td style="font-size:16px" width="220">:&nbsp;
		<?
		echo $product_depertment ;
		if($product_code !=""){
		echo " (".$product_code.")";
		}
		if($pro_sub_dep != ""){
		echo " (".$pro_sub_dep.")";
		}
		?>
		</td>
	</tr>
	<tr>
		<td width="200"><span style="font-size:18px"><b>Order Qnty</b></span></td>
		<td style="font-size:16px">:&nbsp; <?  echo $po_quantity;//." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?> </td>
		<td style="font-size:18px"><b>Garments Item</b></td>
		<td style="font-size:16px">:&nbsp;
		<?
		$gmts_item_name="";
		$gmts_item=explode(',',$gmts_item_id);
		for($g=0;$g<=count($gmts_item); $g++)
		{
		$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
		}
		echo rtrim($gmts_item_name,',');
		?>
		</td>
	</tr>
	<tr>
		<td style="font-size:18px"><b>Style Ref.</b>   </td>
		<td style="font-size:16px">:&nbsp;<b><? echo $style_sting;?></b></td>
		<td style="font-size:18px"><b>Style Des.</b></td>
		<td style="font-size:16px">:&nbsp;<? echo $style_description;?></td>
    </tr>
	<tr>
		<td style="font-size:18px"><b>Booking Release Date</b></td>
		<td style="font-size:16px">:&nbsp;
		<?
		$booking_date=$result[csf('update_date')];
		if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
		{
		$booking_date=$result[csf('insert_date')];
		}
		echo change_date_format($booking_date,'dd-mm-yyyy','-','');
		?>&nbsp;&nbsp;&nbsp;</td>
		<td style="font-size:18px"><b>Po Received Date</b></td>
		<td style="font-size:16px" width="150" >:&nbsp;<? echo $po_received_date; ?></td>
	</tr>
	<tr>
		<td style="font-size:18px"><b>Dealing Merchant</b></td>
		<td style="font-size:16px">:&nbsp;<? echo $dealing_marchant; ?></td>
		<td style="font-size:18px"><b>Supplier Name</b>   </td>
		<td style="font-size:16px">:&nbsp;
		<?
		if($result[csf('pay_mode')]==5){
		echo $company_library[$result[csf('supplier_id')]];
		}
		else{
		echo $supplier_name_arr[$result[csf('supplier_id')]];
		}
		?>    </td>
	</tr>
	<tr>	
		<td style="font-size:18px"><b>Delivery Date</b></td>
		<td style="font-size:16px">:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
		<td style="font-size:18px"><b>Job No</b></td>
		<td style="font-size:16px">:&nbsp;<b><? echo trim($job_no,"'"); ?></td>
	</tr>
	<tr>
		<td style="font-size:18px"><b>Season</b></td>
		<td style="font-size:16px">:&nbsp;<?  if($season_matrix!="") echo $season_matrix; else echo $season_buyer_wise; ?></td>
		<td style="font-size:18px"><b>Attention</b></td>
		<td style="font-size:16px">:&nbsp;<? echo $result[csf('attention')]; ?></td>
	</tr>	
	<tr>
		<td style="font-size:18px"><b>Lead Time </b></td>
		<td style="font-size:16px">:&nbsp;<? echo $leadtime;?></td>	
	</tr>

	</table>
           <?
			}

			$po_arr= sql_select("select a.job_no, a.product_dept, a.total_set_qnty, b.id, b.po_number, MIN(b.po_received_date) as po_received_date, b.pub_shipment_date, b.grouping, sum(b.plan_cut) as plan_cut, sum(b.po_quantity) as po_quantity from wo_po_details_master a,wo_po_break_down b
	 where a.job_no=b.job_no_mst and b.status_active=1 and b.id in(".str_replace("'","",$txt_order_no_id).") group by a.job_no, a.total_set_qnty, a.product_dept, b.id, b.po_number, b.pub_shipment_date, b.grouping");
	$po_qnty_tot1=$po_qnty_tot=$tot_po_qnty_tot_pcs=0;
	foreach($po_arr as $row)
	{
		$po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
		$po_ship_date_arr[$row[csf('id')]]=$row[csf('pub_shipment_date')];
		$po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
		$po_num_arr[$row[csf('id')]]=$row[csf('po_number')];
		$po_qnty_tot1+=$row[csf('po_quantity')];
		$po_qnty_tot+=$row[csf('po_quantity')];
		$tot_po_qnty_tot_pcs+=$row[csf('po_quantity')]*$row[csf('total_set_qnty')];
		if($internal_ref_no=="") $internal_ref_no=$row[csf('grouping')];else $internal_ref_no.=",".$row[csf('grouping')];
		$intRef[$row[csf('grouping')]]=$row[csf('grouping')];
		$po_received_date=change_date_format($row[csf('po_received_date')],'dd-mm-yyyy','-');
		$prod_dept=$product_dept[$row[csf('product_dept')]];
		$job_no_aarr.=$row[csf('job_no')].',';

	}

			$nameArray_size=sql_select( "select size_number_id,min(id) as id,	min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  is_deleted=0 and status_active=1 group by size_number_id order by size_order");

		   ?>
             <table width="100%" >
		    <tr>
            <td width="1000">
                <div id="div_size_color_matrix" style="float:left; max-width:1000;">
            	<fieldset id="div_size_color_matrix" style="max-width:1180;">
 				<legend>Size and Color Breakdown </legend>
 				<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="930" cellspacing="0" rules="all" >
                    <tr>
                        <td style="border:1px solid black"><strong>PO Number</strong></td>
                        <td style="border:1px solid black"><strong>Ship Date</strong></td>
                        <td style="border:1px solid black"><strong>Gmts Item</strong></td>
                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                    <?
						foreach($nameArray_size  as $result_size)
                        {	     ?>
                        <td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
                    <?	}    ?>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                        <td style="border:1px solid black; width:80px" align="center"><strong> Excess Cut %</strong></td>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
						<td style="border:1px solid black; width:80px" align="center"><strong> Excess Input %</strong></td>
						<td style="border:1px solid black; width:100px" align="center"><strong> Total Input Cut Qty(Pcs)</strong></td>
                    </tr>
                    <?
					$color_size_order_qnty_array=array(); $color_size_qnty_array=array(); $size_tatal=array(); $size_tatal_order=array();
					$order_id=explode(",",str_replace("'","",$txt_order_no_id));
					$orderids=str_replace("'","",$txt_order_no_id);
					$gmtsItemIds=implode(",",$gmts_item);

							$item_size_tatal=array(); $item_size_tatal_order=array();
							$item_grand_total=array(); $item_grand_total_order=array();
							$nameArray_color=sql_select("select color_number_id,po_break_down_id,item_number_id 
							from wo_po_color_size_breakdown where item_number_id in ($gmtsItemIds) and po_break_down_id in ($orderids) 
							and is_deleted=0 and status_active=1 group by color_number_id,po_break_down_id,item_number_id  order by po_break_down_id,color_number_id");
							
							foreach($nameArray_color as $result_color)
		                    {
								$po_wise_data_arr[$result_color[csf('po_break_down_id')]][$result_color[csf('item_number_id')]][$result_color[csf('color_number_id')]]=$result_color[csf('color_number_id')];
								$po_wise_rows[$result_color[csf('po_break_down_id')]]+=1;
								$po_item_wise_rows[$result_color[csf('po_break_down_id')]][$result_color[csf('item_number_id')]]+=1;
							}
							?>
		                    <?
					foreach($po_wise_data_arr as $po_id=>$po_data){
						$p=1;
						foreach($po_data as $item_id=>$item_data){
							$it=1;
							foreach($item_data as $colorId){
		                    	?>
		                    <tr>
								<?
								if($p==1){?>

								
		                        <td align="center" style="border:1px solid black" rowspan="<?=$po_wise_rows[$po_id];?>"><? echo $po_number_arr[$po_id]; // echo $row_num_tr; ?></td>
		                         <td align="center" style="border:1px solid black" rowspan="<?=$po_wise_rows[$po_id];?>"><? echo change_date_format($po_ship_date_arr[$po_id],"dd-mm-yyyy","-"); // echo $row_num_tr; ?></td>
		                         
								<?$p++;}
								if($it==1){								
								?> <td align="center" style="border:1px solid black" rowspan="<?=$po_item_wise_rows[$po_id][$item_id];?>"><? echo $garments_item[$item_id]; // echo $row_num_tr; ?></td>
									<?$it++;}?>
		                        <td align="center" style="border:1px solid black"><? echo $color_library[$colorId]; ?></td>
		                        <?
								$color_total=0; $color_total_order=0;

								foreach($nameArray_size  as $result_size)
								{
								$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id =$po_id and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$colorId."  and item_number_id=$item_id and  status_active=1 and is_deleted =0");
								foreach($nameArray_color_size_qnty as $result_color_size_qnty)
		                        {

		                        ?>
		                            <td style="border:1px solid black; text-align:right">
									<?
										if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
										{
											 echo number_format($result_color_size_qnty[csf('order_quantity')],0);
											 $color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
											 $color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
											 $color_cut_total_order += $result_color_size_qnty[csf('order_quantity')]+($result_color_size_qnty[csf('order_quantity')]*.03) ;
											 $item_grand_total[$po_id]+=$result_color_size_qnty[csf('plan_cut_qnty')];
											 $item_grand_total_order[$po_id]+=$result_color_size_qnty[csf('order_quantity')];
										     $grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
											 $grand_total_order +=$result_color_size_qnty[csf('order_quantity')];
											 $grand_cut_total_order +=$result_color_size_qnty[csf('order_quantity')]+($result_color_size_qnty[csf('order_quantity')]*.03);
											 $color_size_qnty_array[$result_size[csf('size_number_id')]][$colorId]=$result_color_size_qnty[csf('plan_cut_qnty')];
											 $color_size_order_qnty_array[$result_size[csf('size_number_id')]][$colorId]=$result_color_size_qnty[csf('order_quantity')];
											 if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
											 {
													$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
													$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
											 }
											 else
											 {
												$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
												$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
											 }
											 if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
											 {
													$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
													$item_size_tatal_order[$po_id][$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
											 }
											 else
											 {
												$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
												$item_size_tatal_order[$po_id][$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
											 }
										}
										else echo "0";
									 ?>
									</td>
		                    <?
								}
		                        }
		                        ?>
		                        <td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total_order),0); ?></td>
		                         <td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,0)." %"; ?></td>
		                         <td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total),0); ?></td>
								 <td style="border:1px solid black; text-align:right"><? echo "3%"; ?></td>
								 <td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total_order+($color_total_order*.03)),0); ?></td>
		                         
		                    </tr>
		                    <?
		                    
							}
						
						}
						?>
						<tr>
						  <td align="center" style="border:1px solid black"><strong></strong></td>
						  <td align="center" style="border:1px solid black"><strong></strong></td>
						  <td align="center" style="border:1px solid black"><strong></strong></td>
							<td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
							<?
							foreach($nameArray_size  as $result_size)
							{
							?>
							<td style="border:1px solid black;  text-align:right"><? echo $item_size_tatal_order[$po_id][$result_size[csf('size_number_id')]];  ?></td>
							<?
							}
							?>
							<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total_order[$po_id]),0); ?></td>
							<td  style="border:1px solid black;  text-align:right"><? $excess_item_gra_tot=($item_grand_total[$po_id]-$item_grand_total_order[$po_id])/$item_grand_total_order[$po_id]*100; echo number_format($excess_item_gra_tot,0)." %"; ?></td>
							<td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total[$po_id]),0); ?></td>
							<td align="right" style="border:1px solid black"><strong><? echo "3%"; ?></strong></td>
							<td align="right" style="border:1px solid black"><strong><? echo number_format(round($item_grand_total_order[$po_id]+($item_grand_total_order[$po_id]*.03)),0);$cut_color_total+=$color_total_order+($color_total_order*.03); ?></strong></td>

						</tr>
						<?
					}
                    ?>
                     <tr>
                        <td style="border:1px solid black" align="center" colspan="<? echo count($nameArray_size)+4; ?>"><strong>&nbsp;</strong></td>
                       </tr>
                    <tr>
                    <tr>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                        <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total),0); ?></td>
						<td align="center" style="border:1px solid black"><strong></strong></td>
                    	<td align="right" style="border:1px solid black"><strong><? echo number_format(round($grand_total_order+($grand_total_order*.03)),0); ?></strong></td>
						
                </table>
             </fieldset>
                </div>
                </td>
      <br/>
       <style>
	 .main_table tr th{
		 border:1px solid black;
		 font-size:13px;
		 outline: 0;
	 }
	  .main_table tr td{
		 border:1px solid black;
		 font-size:13px;
		 outline: 0;
	 }
	 </style>
     <?
	 $costing_per=""; $costing_per_qnty=0;
	 $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_nos'");
	 if($costing_per_id==1)
	{
		$costing_per="1 Dzn";
		$costing_per_qnty=12;
	}
	if($costing_per_id==2)
	{
		$costing_per="1 Pcs";
		$costing_per_qnty=1;
	}
	if($costing_per_id==3)
	{
		$costing_per="2 Dzn";
		$costing_per_qnty=24;
	}
	if($costing_per_id==4)
	{
		$costing_per="3 Dzn";
		$costing_per_qnty=36;
	}
	if($costing_per_id==5)
	{
		$costing_per="4 Dzn";
		$costing_per_qnty=48;
	}
	$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");
	$nameArray_fabric_description= sql_select("select a.body_part_id,a.uom, a.lib_yarn_count_deter_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.dia_width,b.item_size, b.remarks, avg(b.cons) as cons, b.process_loss_percent, avg(b.requirment) as requirment,b.po_break_down_id,  d.fabric_color_id, d.gmts_color_id, d.id as dtls_id, d.fin_fab_qnty as fin_fab_qnty, sum(d.grey_fab_qnty) as grey_fab_qnty,e.body_part_type,rtrim(xmlagg(xmlelement(size_data, c.size_number_id,',').extract('//text()') order by c.size_number_id).getclobval(),',') as size_data, a.fab_nature_id FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d, lib_body_part e WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and a.body_part_id=e.id  and d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0  AND a.status_active = 1 AND a.is_deleted = 0   AND c.status_active = 1  AND c.is_deleted = 0  AND b.status_active = 1  AND b.is_deleted = 0 AND e.status_active = 1  AND e.is_deleted = 0 group by a.fab_nature_id, a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width,b.item_size, b.remarks,d.fabric_color_id, d.gmts_color_id, d.id,b.po_break_down_id, b.process_loss_percent,e.body_part_type,a.uom, d.fin_fab_qnty order by a.body_part_id, b.dia_width");

	foreach ($nameArray_fabric_description as $row) {	
		$grouping_item=$row[csf('fabric_color_id')].'*'.$row[csf('body_part_id')].'*'.$row[csf('construction')].'*'.$row[csf('composition')].'*'.$row[csf('gsm_weight')].'*'.$row[csf('dia_width')].'*'.$row[csf('color_type_id')];	
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['gmts_color_id'] = $row[csf('gmts_color_id')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['uom'] = $row[csf('uom')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['fabric_color_id'] = $row[csf('fabric_color_id')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['lapdip_no'] = $lapdip_no;
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['body_part_id'] = $row[csf('body_part_id')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['fabric_nature'] = $row[csf('fab_nature_id')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['item_size'] = $row[csf('item_size')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['construction'] = $row[csf('construction')];
		//$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['size_number_id'].=$size_library[$row[csf('size_number_id')]].',';
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['size_number_id']=$row[csf('size_data')]->load();
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['gsm'] = $row[csf('gsm_weight')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['fabric_dia'] = $row[csf('dia_width')].",".$fabric_typee[$row[csf('width_dia_type')]];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['color_type_id'] = $row[csf('color_type_id')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['finsh_cons'] = $row[csf('cons')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['gray_cons'] = $row[csf('requirment')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['fin_fab_qnty'] += $row[csf('fin_fab_qnty')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['grey_fab_qnty'] += $row[csf('grey_fab_qnty')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['process_loss_percent'] = $row[csf('process_loss_percent')];
		$fabric_data_arr[$row[csf('gmts_color_id')]][$grouping_item]['lib_yarn_count_deter_id'] = $row[csf('lib_yarn_count_deter_id')];

	}

	/*echo '<pre>';
	print_r($fabric_data_arr); die;*/

	?>
     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-size: 18px;">
     	<tr>
     		<th>Gmts Color</th>
     		<th>Fabric Color</th>
     		<th>Body Part</th>
     		<th>Fabric Nature</th>
     		<th>Fabrication</th>
     		<th>GSM</th>
			<th>Size</th>
     		<th>Dia Type with </br> Fabric Dia</th>
			<th>Cut Dia</th>
     		<th>Color Type</th>
     		<th>Finsh Cons.</th>
     		<th>Finish  Qty</th>
     		<th>UOM</th>
     	</tr>
     	<? 
     	foreach ($fabric_data_arr as $gmts_id=>$fabric_data_arr) {  
     	$i=1;     		  		
     		foreach ($fabric_data_arr as $fabric_id => $value) {
     				$fin_fab_qnty+=$value['fin_fab_qnty'];   		 	
     				$grey_fab_qnty+=$value['grey_fab_qnty'];  
					//$size=implode(",",array_filter(array_unique(explode(",",$value['size_number_id'])))); 
					$size_arr=array();
					$size_data_arr=explode(",",$value['size_number_id']);
					foreach($size_data_arr as $sizeid){
						$size_arr[$fabric_id][$sizeid]=$size_library[$sizeid];
					}
					$size=implode(",",$size_arr[$fabric_id]);	
     		 		if($i==1){
     		 	 	?>
	     		 	<tr>
		     			<td rowspan="<? echo count($fabric_data_arr) ?>"><? echo $color_library[$gmts_id] ?></td>
		     			<td><? echo $color_library[$value['fabric_color_id']] ?></td>
		     			<td><? echo $body_part[$value['body_part_id']] ?></td>
		     			<td><? echo $item_category[$value['fabric_nature']] ?></td>
		     			<td><? echo $value['construction'].",".$fabric_composition[$lip_yarn_count[$value['lib_yarn_count_deter_id']]]; ?></td>
		     			<td><? echo $value['gsm'] ?></td>
					
						<td><? if($size!="") echo $size; else echo " ";?></td>
		     			<td><? echo $value['fabric_dia'] ?></td>
						<td><? echo $value['item_size'] ?></td>
		     			<td><? echo $color_type[$value['color_type_id']] ?></td>
		     			<td align="right"><? echo number_format($value['finsh_cons'],2) ?></td>
		     			<td align="right"><? echo number_format($value['fin_fab_qnty'],0) ?></td>
						<td align="center"><? echo $unit_of_measurement[$value['uom']]; ?></td>
	     			</tr>
     		 		<? } 
     		 		else { ?>
     		 			<tr>
			     			<td><? echo $color_library[$value['fabric_color_id']] ?></td>
		     				<td><? echo $body_part[$value['body_part_id']] ?></td>
							 <td><? echo $item_category[$value['fabric_nature']] ?></td>
			     			<td><? echo $value['construction'].",".$fabric_composition[$lip_yarn_count[$value['lib_yarn_count_deter_id']]]; ?></td>
			     			<td><? echo $value['gsm'] ?></td>
							 <td><? if($size!="") echo $size; else echo " ";?></td>
							 <td><? echo $value['fabric_dia'] ?></td>
			     			<td><? echo $value['item_size'] ?></td>
			     			<td><? echo $color_type[$value['color_type_id']] ?></td>
			     			<td align="right"><? echo number_format($value['finsh_cons'],2) ?></td>
			     			<td align="right"><? echo number_format($value['fin_fab_qnty'],0) ?></td>
							 <td align="center"><? echo $unit_of_measurement[$value['uom']]; ?></td>
	     				</tr>
     		 		<? }
     		 		$i++;
     		 	//}
     		}
     	} 
     	?>
     	<tr>
     		<th colspan="11">Total</th>
     		<th align="right"><?echo number_format($fin_fab_qnty);  ?></th>
     		<th></th>
     	</tr>
     </table>
      <br/>
		<?
		$lib_designation_arr=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");
		$user_lib_designation_arr=return_library_array("SELECT id,designation from user_passwd", "id", "designation");
		$user_lib_name_arr=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");

		$mst_id=return_field_value("id as mst_id","wo_booking_mst","booking_no=$txt_booking_no","mst_id");
	 $approve_data_array=sql_select("select b.approved_by,min(b.approved_date) as approved_date from   approval_history b where b.mst_id=$mst_id and b.entry_form=7  group by  b.approved_by order by b.sequence_no asc");

	 $unapprove_data_array=sql_select("select b.approved_by,b.approved_date,b.un_approved_reason,b.un_approved_date,b.approved_no from   approval_history b where b.mst_id=$mst_id and b.entry_form=7  order by b.approved_date,b.approved_by");



     if(count($approve_data_array)>0)
	{
 		?>
       <table  width="850" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="5" style="border:1px solid black;">Approval Status</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th>
				<th width="40%" style="border:1px solid black;">Name</th>
				<th width="30%" style="border:1px solid black;">Designation</th>
				<th width="27%" style="border:1px solid black;">Approval Date</th>

                </tr>
            </thead>
            <tbody>
            <?
			$i=1;
			foreach($approve_data_array as $row){


			?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
				<td width="40%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
				<td width="30%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
				<td width="27%" style="border:1px solid black;text-align:center"><? echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')]));?></td>

                </tr>
                <?
				$i++;
			}
				?>
            </tbody>
        </table>
		<?
		}
		?>
		<br>
		<?
		if(count($unapprove_data_array)>0)
		{
		$sql_unapproved=sql_select("select booking_id,approval_cause from fabric_booking_approval_cause where  entry_form=7 and approval_type=2 and is_deleted=0 and status_active=1 and booking_id=$mst_id");
			$unapproved_request_arr=array();
			foreach($sql_unapproved as $rowu)
			{
				$unapproved_request_arr[$rowu[csf('booking_id')]]=$rowu[csf('approval_cause')];
			}
 		?>
       <table  width="850" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="6" style="border:1px solid black;">Approval/Un Approval History</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th>
				<th width="30%" style="border:1px solid black;">Name</th>
				<th width="20%" style="border:1px solid black;">Designation</th>
				<th width="5%" style="border:1px solid black;">Approval Status</th>
				<th width="20%" style="border:1px solid black;">Reason For Un Approval</th>
				<th width="22%" style="border:1px solid black;"> Date</th>

                </tr>
            </thead>
            <tbody>
            <?
			$i=1;
			foreach($unapprove_data_array as $row){

			?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
				<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
				<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
				<td width="5%" style="border:1px solid black; text-align:center"><? echo 'Yes';?></td>
				<td width="20%" style="border:1px solid black;"><? echo '';?></td>
				<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); else echo "";?></td>
            </tr>
                <?
				$i++;
				$un_approved_date= explode(" ",$row[csf('un_approved_date')]);
				$un_approved_date=$un_approved_date[0];
				if($db_type==0) //Mysql
				{
					if($un_approved_date=="" || $un_approved_date=="0000-00-00") $un_approved_date="";else $un_approved_date=$un_approved_date;
				}
				else
				{
					if($un_approved_date=="") $un_approved_date="";else $un_approved_date=$un_approved_date;
				}

				if($un_approved_date!="")
				{
				?>
			<tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
				<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
				<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
				<td width="5%" style="border:1px solid black;text-align:center;"><? echo 'No';?></td>
				<td width="20%" style="border:1px solid black;text-align:center"><? echo $unapproved_request_arr[$mst_id];?></td>
				<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('un_approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('un_approved_date')])); else echo "";?></td>
              </tr>

                <?
				$i++;
				}

			}
				?>
            </tbody>
        </table>
		<?
		}
        ?>
       <br> <br>
       

         <br>

		 <?


		$item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no ='$job_no'", "gmts_item_id", "set_item_ratio");
		$po_number_arr=return_library_array( "select id,po_number from wo_po_break_down  where job_no_mst ='$job_no'", "id", "po_number");
		$shipment_date_arr=return_library_array( "select id,shipment_date from wo_po_break_down  where job_no_mst ='$job_no'", "id", "shipment_date");
		$grand_order_total=0; $grand_plan_total=0; $size_wise_total=array();
		$nameArray_size=sql_select( "select size_number_id,size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by size_number_id,size_order order by size_order ");

		$main_finish_fabric_qnty_array=array(); 
		$booking_qnty_main= "select a.po_break_down_id,sum(a.grey_fab_qnty) as  grey_fab_qnty,a.gmts_color_id  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by a.po_break_down_id,a.gmts_color_id order by a.po_break_down_id";
		$booking_qnty_main_res=sql_select($booking_qnty_main);
		foreach($booking_qnty_main_res as $row)
		{

			$main_finish_fabric_qnty_array[$row[csf("po_break_down_id")]][$row[csf("gmts_color_id")]]+=$row[csf("grey_fab_qnty")];

		}
		unset($booking_qnty_main_res);

		$short_finish_fabric_qnty_array=array(); 
		$booking_qnty_short="select a.po_break_down_id,sum(a.grey_fab_qnty) as  grey_fab_qnty,a.gmts_color_id from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1  and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by a.po_break_down_id,a.gmts_color_id order by a.po_break_down_id";
		$booking_qnty_short_res=sql_select($booking_qnty_short);
		foreach($booking_qnty_short_res as $row)
		{

			$short_finish_fabric_qnty_array[$row[csf("po_break_down_id")]][$row[csf("gmts_color_id")]]+=$row[csf("grey_fab_qnty")];

		}
		unset($booking_qnty_short_res);

		$sample_finish_fabric_qnty_array=array(); 
		$booking_qnty_sample="select a.po_break_down_id,sum(a.grey_fab_qnty) as  grey_fab_qnty,a.gmts_color_id from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4  and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by a.po_break_down_id,a.gmts_color_id order by a.po_break_down_id";
		$booking_qnty_sample_res=sql_select($booking_qnty_sample);
		foreach($booking_qnty_sample_res as $row)
		{

			$sample_finish_fabric_qnty_array[$row[csf("po_break_down_id")]][$row[csf("gmts_color_id")]]+=$row[csf("grey_fab_qnty")];

		}
		unset($booking_qnty_sample_res);
		


	$name_sql="select a.fab_nature_id, b.po_break_down_id, b.color_number_id, b.process_loss_percent, b.rate FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and a.job_no='$job_no' and b.po_break_down_id in(".str_replace("'","",$txt_order_no_id).")   and a.status_active=1 and a.is_deleted=0 group by a.fab_nature_id, b.po_break_down_id, b.color_number_id, b.process_loss_percent, b.rate ";

	//echo $name_sql;
	$nameArray=sql_select($name_sql);

	$po_fabric_wise_data=array();
	foreach ($nameArray as $result){
	
		if($result[csf('fab_nature_id')]==3){
			$finish_fabric_qnty=array_sum($fabric_costing_qty_arr['woven']['finish'][$result[csf('po_break_down_id')]][$result[csf('color_number_id')]]);
			$grey_fabric_qnty=array_sum($fabric_costing_qty_arr['woven']['grey'][$result[csf('po_break_down_id')]][$result[csf('color_number_id')]]);
		}
		if($result[csf('fab_nature_id')]==2){
			$finish_fabric_qnty=array_sum($fabric_costing_qty_arr['knit']['finish'][$result[csf('po_break_down_id')]][$result[csf('color_number_id')]]);
			$grey_fabric_qnty=array_sum($fabric_costing_qty_arr['knit']['grey'][$result[csf('po_break_down_id')]][$result[csf('color_number_id')]]);
		}
		$ship_date=change_date_format($shipment_date_arr[$result[csf('po_break_down_id')]]);
		$po_fabric_wise_data[$result[csf('po_break_down_id')]][$ship_date][$result[csf('color_number_id')]]['finish_kg']+=$finish_fabric_qnty;
		$po_fabric_wise_data[$result[csf('po_break_down_id')]][$ship_date][$result[csf('color_number_id')]]['grey_kg']+=$grey_fabric_qnty;
		$po_fabric_wise_data[$result[csf('po_break_down_id')]][$ship_date][$result[csf('color_number_id')]]['process_loss']=$result[csf('process_loss_percent')];
		$po_fabric_wise_data[$result[csf('po_break_down_id')]][$ship_date][$result[csf('color_number_id')]]['color_size_sensitive']=$result[csf('color_size_sensitive')];
		$po_fabric_wise_data[$result[csf('po_break_down_id')]][$ship_date][$result[csf('color_number_id')]]['id']=$result[csf('id')];
		$po_wise_rows[$result[csf('po_break_down_id')]]+=1;
	}

	?>
	<div id="div_size_color_matrix" class="pagebreak">
		<fieldset id="div_size_color_matrix" >
			<legend>Size and Color Breakdown</legend>
			<table  class="rpt_table"  border="1" align="left" style="float:left;" cellpadding="0"  cellspacing="0" rules="all" >
				<tr>
					<td>PO Number</td>				
					<td>Ship Date</td>
					<td>Color</td>                          	
					<td  align="center"> Total Finish Fabric(<?= $unit_of_measurement[$booking_uom] ?>)</td>
					<td  align="center"> Total Grey Fabric(<?= $unit_of_measurement[$booking_uom] ?>)</td>
					<td  align="center"> Process Loss</td>
				</tr>
				<?
			   
				foreach ($po_fabric_wise_data as $po_id=>$shipdate_data){
					foreach ($shipdate_data as $date_id=>$color_data) {
						foreach ($color_data as  $color_id=>$result){

					?>
					<tr>
						
						<td   title="<?=$po_id;?>"><?php echo $po_number_arr[$po_id]; ?></td>
						
						<td><?php echo $date_id; ?></td>									
						<td><? if($result["color_size_sensitive"]!=0) echo $color_library[$color_id]; ?></td>									
						
						<?

						$grand_fabric_total+=$result["finish_kg"];
						$grand_grey_total+=$result["grey_kg"];
						$grand_main_fabric_total+=$main_finish_fabric_qnty_array[$po_id][$color_id];
						$grand_short_fabric_total+=$short_finish_fabric_qnty_array[$po_id][$color_id];
						$grand_sample_fabric_total+=$sample_finish_fabric_qnty_array[$po_id][$color_id];
						$po_fabric_tot[$po_id]+=$result["finish_kg"];
						$po_grey_tot[$po_id]+=$result["grey_kg"];
						$po_main_fabric_total[$po_id]+=$main_finish_fabric_qnty_array[$po_id][$color_id];
						$po_short_fabric_total[$po_id]+=$short_finish_fabric_qnty_array[$po_id][$color_id];
						$po_sample_fabric_total[$po_id]+=$sample_finish_fabric_qnty_array[$po_id][$color_id];
						$color_wise_arr[$color_id]['finish_kg']+=$result["finish_kg"];
						$color_wise_arr[$color_id]['grey_kg']+=$result["grey_kg"];



						?>
						<td align="right"><?php echo number_format($result["finish_kg"],2); ?></td>
						<td align="right"><?php echo number_format($result["grey_kg"],2); ?></td>
						<td align="right"><?php echo number_format($result['process_loss']); ?></td>
					</tr>
					<?
					 }
				  }?>

				<tr>
					<td align="right" colspan="3"><b>Po Wise Total</b></td>                            	
					<td align="right"><strong><?=number_format($po_fabric_tot[$po_id],2)?></strong></td>                                
					<td align="right"><strong><?=number_format($po_grey_tot[$po_id],2)?></strong></td>
					<td></td>
					
				</tr>
				<?

				}
				?>
				<tr>
					<td align="right" colspan="3"><b>Grand Total</b></td>                            	
					<td align="right"><strong><?=number_format($grand_fabric_total,2)?></strong></td>                                
					<td align="right"><strong><?=number_format($grand_grey_total,2)?></strong></td>
					<td></td>
				</tr>
			</table>
			<table  class="rpt_table"  style="float:left;margin-left:20px;" border="1" align="left" cellpadding="0"  cellspacing="0" rules="all" >
				<tr>
					<td colspan="4" align="center">Color wise Summary</td>                               
				</tr>
				<tr>
					<td>Sl</td>
					<td>Color Name</td>
					<td>Finish Fabric(<?= $unit_of_measurement[$booking_uom] ?>)</td>
					<td>Grey Fabric(<?= $unit_of_measurement[$booking_uom] ?>)</td>
				</tr>
				<?php
				$sl=1;
					foreach($color_wise_arr as $cid=> $val){
				?>
				<tr>
					<td width="30"><?=$sl;?></td>
					<td width="100"><?=$color_library[$cid];?></td>
					<td width="100" align="right"><?=number_format($val['finish_kg'],2);?></td>
					<td width="100" align="right"><?=number_format($val['grey_kg'],2);?></td>
				</tr>
				<?$sl++;
			
						$grand_fabric_tot+=$val['finish_kg'];
						$grand_grey_tot+=$val['grey_kg'];
			}?>
				<tr>
				  
					<td colspan="2">Total</td>
					<td align="right"><?=number_format($grand_fabric_tot,2);?></td>
					<td align="right"><?=number_format($grand_grey_tot,2);?></td>
				</tr>
			</table>
		</fieldset>
	</div>
	<br><br>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
            <tr>
                <td width="98%" style="border:solid; border-color:#000; border-width:thin" valign="top">
                    <? echo get_spacial_instruction($txt_booking_no,"97%",108);?>
                </td>
			</tr>
		</table>	



	<?
	$emailBody=ob_get_contents();
	if($is_mail_send==1){
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and  b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}
		
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		

		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			echo sendMailMailer( $to, $subject, $emailBody,$from_mail,'' );
		}
	}
	exit();
}

if($action=="print_booking_21")//shariar 1839
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$txt_job_no=str_replace("'","",$txt_job_no);
	$show_yarn_rate=str_replace("'","",$show_yarn_rate);
	$path=str_replace("'","",$path);
	if($path==1) $path="../../";

	$company_library=return_library_array( "select id,company_name from lib_company where status_active=1 and is_deleted=0", "id", "company_name");
	$location_name_arr=return_library_array( "select id,location_name from lib_location  where status_active=1 and is_deleted=0",'id','location_name');
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1 and master_tble_id='$cbo_company_name'",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$brand_name_arr=return_library_array( "select id, brand_name from lib_buyer_brand ",'id','brand_name');
	$user_name_arr=return_library_array( "select id, user_full_name from user_passwd ",'id','user_full_name');
	$user_lib_name_arr=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");
	$color_library=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	$size_library=return_library_array( "select id,size_name from lib_size where status_active=1 and is_deleted=0", "id", "size_name");


	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	?>
	<style type="text/css">
		@media print {
		    .pagebreak { page-break-before: always; } /* page-break-after works, as well */
		}
	</style>
	<div style="width:1330px" align="center">
    <?php
    	$lip_yarn_count=return_library_array( "select id,fabric_composition_id from lib_yarn_count_determina_mst where  status_active=1", "id", "fabric_composition_id");
		$fabric_composition=return_library_array( "select id,fabric_composition_name from lib_fabric_composition where  status_active=1", "id", "fabric_composition_name");
		
		$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
		list($nameArray_approved_row) = $nameArray_approved;
		$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_date_row) = $nameArray_approved_date;
		$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_comments_row) = $nameArray_approved_comments;

		$nameArray_per_job=sql_select( "select  a.job_no,a.style_ref_no,a.gmts_item_id,b.po_break_down_id,c.po_number,c.grouping  from wo_po_details_master a, wo_booking_dtls b, wo_po_break_down c where c.id=b.po_break_down_id and a.job_no=b.job_no and  a.job_no=c.job_no_mst and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by a.job_no,a.style_ref_no,a.gmts_item_id,b.po_break_down_id,c.grouping,c.po_number");
		foreach ($nameArray_per_job as $row_per_job)
		{
			$job_no_aarr.="'".$row_per_job[csf('job_no')]."'".',';
			$job_no_array.="".$row_per_job[csf('job_no')]."".',';
			$style_ref_array.="".$row_per_job[csf('style_ref_no')]."".',';
			$po_number_array.="".$row_per_job[csf('po_number')]."".',';
			$gmts_item_array.="".$row_per_job[csf('gmts_item_id')]."".',';
			$job_po_arr[$row_per_job[csf('job_no')]].=$row_per_job[csf('po_number')].',';
		}
		$job_number=rtrim($job_no_aarr,',');		
		$job_nos=implode(",",array_unique(explode(",",$job_number)));		
		$job_no_mst_cond=where_con_using_array(array_unique(explode(",",$job_nos)),0,"job_no_mst");//in(".$job_nos.")
		$job_no_mst_cond2=where_con_using_array(array_unique(explode(",",$job_nos)),0,"job_no");//in(".$job_nos.")
		$job_number_chk=rtrim($job_no_array,',');
		$job_noss=implode(",",array_unique(explode(",",$job_number_chk)));
		$style_ref_chk=rtrim($style_ref_array,',');
		$style_ref_nos=implode(",",array_unique(explode(",",$style_ref_chk)));
		$po_number_chk=rtrim($po_number_array,',');
		$ponos=implode(",",array_unique(explode(",",$po_number_chk)));
		$gmts_item_chk=rtrim($gmts_item_array,',');
		$gmts_items=implode(",",array_unique(explode(",",$gmts_item_chk)));

		$max_approve_date_data = sql_select("select min(b.approved_date) as approved_date,max(b.approved_date) as last_approve_date,max(b.un_approved_date) as un_approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
		$first_approve_date='';
		$last_approve_date='';
		$un_approved_date='';
		if(count($max_approve_date_data))
		{
			$last_approve_date=$max_approve_date_data[0][csf('last_approve_date')];
			$first_approve_date=$max_approve_date_data[0][csf('approved_date')];
			$un_approved_date=$max_approve_date_data[0][csf('un_approved_date')];
		}
		
		if($txt_job_no!="") $location=return_field_value( "location_name", "wo_po_details_master","job_no='$job_nos'"); else $location="";
		$sql_loc=sql_select("select id,location_name,address from lib_location where company_id=$cbo_company_name");
		foreach($sql_loc as $row)
		{
			$location_name_arr[$row[csf('id')]]= $row[csf('location_name')];
			$location_address_arr[$row[csf('id')]]= $row[csf('address')];
		}		

		$nameArray=sql_select( "select a.booking_no, a.booking_date, a.supplier_id, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.rmg_process_breakdown, a.insert_date, a.update_date, a.tagged_booking_no, a.uom, a.pay_mode, a.booking_percent, a.fabric_composition, a.remarks, a.sustainability_standard, a.quality_level, a.fab_material, a.requisition_no, a.proceed_dyeing,a.inserted_by from wo_booking_mst a where a.booking_no=$txt_booking_no and a.status_active=1");

		$booking_uom=$nameArray[0][csf('uom')];
		$bookingup_date=$nameArray[0][csf('update_date')];
		$bookingins_date=$nameArray[0][csf('insert_date')];
		$delivery_date=$nameArray[0][csf('delivery_date')];
		$requisition_no=$nameArray[0][csf('requisition_no')];
		$inserted_by=$nameArray[0][csf('inserted_by')];
		$sustainability_standards=$nameArray[0][csf('sustainability_standard')];
		$remarks=$nameArray[0][csf('remarks')];

		$nameArray_job=sql_select("select a.po_break_down_id, b.job_no, b.buyer_name, b.style_ref_no, b.gmts_item_id, b.order_uom, b.total_set_qnty, (b.job_quantity*b.total_set_qnty) as jobqtypcs, b.style_description, b.season_buyer_wise as season, b.product_dept, b.product_code, b.pro_sub_dep, b.dealing_marchant,b.factory_marchant, b.order_repeat_no, b.repeat_job_no, b.brand_id, b.qlty_label, b.packing from wo_booking_dtls a, wo_po_details_master b where a.job_no=b.job_no and a.booking_no=$txt_booking_no and a.status_active=1 and b.status_active=1");
		foreach ($nameArray_job as $job_row){
			$po_id_all=$job_row[csf('po_break_down_id')];
			$job_no_str=$job_row[csf('job_no')];
			$jobqtypcs=$job_row[csf('jobqtypcs')];
			$style_ref_no=$job_row[csf('style_ref_no')];
			$buyer_name=$job_row[csf('buyer_name')];
			$product_deptartment=$job_row[csf('product_dept')];
			$season=$job_row[csf('season')];
			$style_description=$job_row[csf('style_description')];
			$gmts_item_id=$job_row[csf('gmts_item_id')];
		}

		$po_shipment_date=sql_select("select  MIN(pub_shipment_date) as min_shipment_date,max(pub_shipment_date) as max_shipment_date from wo_po_break_down where status_active=1 $job_no_mst_cond order by shipment_date asc ");
		$min_shipment_date='';
		$max_shipment_date='';
		foreach ($po_shipment_date as $row) {
			$min_shipment_date=$row[csf('min_shipment_date')];
			$max_shipment_date=$row[csf('max_shipment_date')];
			break;
		} 

		$po_sql=sql_select("select a.id, a.po_number, sum(b.order_quantity) as poqtypcs from wo_po_break_down a, wo_po_color_size_breakdown b where a.id=b.po_break_down_id and a.job_no_mst in(".$job_nos.") and b.status_active=1 and b.is_deleted=0 group by a.id, a.po_number");
		foreach($po_sql as $row)
        {
            $po_qnty_tot1+=$row[csf('poqtypcs')];
		}

		$sum_fin_fabqnty=sql_select("SELECT  sum(d.fin_fab_qnty) as qty	FROM wo_pre_cost_fabric_cost_dtls a join wo_pre_cos_fab_co_avg_con_dtls b on  a.id=b.pre_cost_fabric_cost_dtls_id join wo_po_color_size_breakdown c on c.id=b.color_size_table_id join wo_booking_dtls d on b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id WHERE  d.booking_no =$txt_booking_no and a.uom=12 and d.status_active=1 and  d.is_deleted=0");

        $po_running_cancel= sql_select("select case when status_active=1 then  PO_NUMBER end as running_po, case when status_active>1 then po_number end as cancel_po,po_quantity from wo_po_break_down  where status_active=1 $job_no_mst_cond order by shipment_date asc ");
        $running_po='';
        $cancel_po='';
        $running_po_qnty=0;
        foreach ($po_running_cancel as $row) {
        	if(!empty($row[csf('running_po')]))
        	{
        		if(!empty($running_po))
        		{
        			$running_po.=",".$row[csf('running_po')];
        		}
        		else{
        			$running_po.=$row[csf('running_po')];
        		}
        		$running_po_qnty+=$row[csf('po_quantity')];
        	}
        	if(!empty($row[csf('cancel_po')]))
        	{
        		if(!empty($cancel_po))
        		{
        			$cancel_po.=",".$row[csf('cancel_po')];
        		}
        		else{
        			$cancel_po.=$row[csf('cancel_po')];
        		}
        	}
        }
  		ob_start();     
		?>	
											<!--    Header Company Information         -->
        <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black; font-family:Arial Narrow;" >
            <tr>
			<td width="200" style="font-size:28px"><img  src='../../<? echo $imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' /></td>
                <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:28px;"> <?php echo $company_library[$cbo_company_name]; ?></td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:18px"><?=$location_address_arr[$location]; ?></td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:24px">
                            	<span style="float:center;"><b><strong> <font style="color:black">Partial Fabric Booking </font></strong></b></span> 
                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:20px">
							<?
							if(str_replace("'","",$id_approved_id) ==1){ ?>
                            <span style="font-size:20px; float:center;"><strong> <font style="color:green"> <? echo "[Approved]"; ?> </font></strong></span> 
                               <? }else{ ?>
								<span style="font-size:20px; float:center;"><strong> <font style="color:red"><? echo "[Not Approved]"; ?> </font></strong></span> 
							   <? } ?>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
		<?
        $job_no=trim($txt_job_no,"'"); $total_set_qnty=0; $colar_excess_percent=0; $cuff_excess_percent=0; $rmg_process_breakdown=0; $booking_percent=0; $booking_po_id='';
		if($db_type==0)
        {
            $date_dif_cond="DATEDIFF(pub_shipment_date,po_received_date)";
            $group_concat_all="group_concat(grouping) as grouping, group_concat(file_no) as file_no";
        }
        else
        {
            $date_dif_cond="(pub_shipment_date-po_received_date)";
            $group_concat_all=" listagg(cast(grouping as varchar2(4000)),',') within group (order by grouping) as grouping,
                                listagg(cast(file_no as varchar2(4000)),',') within group (order by file_no) as file_no  ";
        }
        $po_number_arr=array(); $po_ship_date_arr=array(); $shipment_date=""; $po_no=""; $po_received_date=""; $shiping_status="";
        $po_sql=sql_select("select id, po_number, pub_shipment_date, MIN(pub_shipment_date) as mpub_shipment_date, MIN(po_received_date) as po_received_date, MIN(insert_date) as insert_date, plan_cut, po_quantity, shiping_status, $date_dif_cond as date_diff,min(factory_received_date) as factory_received_date, $group_concat_all from wo_po_break_down where status_active=1 $job_no_mst_cond group by id, po_number, pub_shipment_date, plan_cut, po_quantity, shiping_status, po_received_date");
      
        $to_ship=0; $fp_ship=0; $f_ship=0;

        foreach($po_sql as $row)
        {
            $po_qnty_tot+=$row[csf('plan_cut')];
            $po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
            $po_ship_date_arr[$row[csf('id')]]=$row[csf('pub_shipment_date')];
            $po_num_arr[$row[csf('id')]]=$row[csf('po_number')];
            $po_no.=$row[csf('po_number')].", ";
            $shipment_date.=change_date_format($row[csf('mpub_shipment_date')],'dd-mm-yyyy','-').", ";
            $lead_time.=$row[csf('date_diff')].",";
            $po_received_date=change_date_format($row[csf('po_received_date')],'dd-mm-yyyy','-');
            $factory_received_date=change_date_format($row[csf('factory_received_date')],'dd-mm-yyyy','-');
            $grouping.=$row[csf('grouping')].",";
            $file_no.=$row[csf('file_no')].",";
			
			$daysInHand.=(datediff('d',date('d-m-Y',time()),$row[csf('mpub_shipment_date')])-1).",";
			
			if($bookingup_date=="" || $bookingup_date=="0000-00-00 00:00:00")
			{
				$booking_date=$bookingins_date;
			}
			$WOPreparedAfter.=(datediff('d',$row[csf('insert_date')],$booking_date)-1).",";

			if($row[csf('shiping_status')]==1) {
				$shiping_status.= "FP".",";
				$to_ship++;
				$fp_ship++;
			}
			else if($row[csf('shiping_status')]==2){
				$shiping_status.= "PD".",";
				$to_ship++;
			} 
			else if($row[csf('shiping_status')]==3){
				$shiping_status.= "FS".",";
				$to_ship++;
				$f_ship++;
			} 
        }

        if($to_ship==$f_ship) $shiping_status= "Full shipped";
        else if($to_ship==$fp_ship) $shiping_status= "Full Pending";
        else $shiping_status= "Partial Delivery";
		
		$po_no=implode(",",array_filter(array_unique(explode(",",$po_no))));
		$shipment_date=implode(",",array_filter(array_unique(explode(",",$shipment_date))));
		$lead_time=implode(",",array_filter(array_unique(explode(",",$lead_time))));
		$po_received_date=implode(",",array_filter(array_unique(explode(",",$po_received_date))));
		$factory_received_date=implode(",",array_filter(array_unique(explode(",",$factory_received_date))));
		$grouping=implode(",",array_filter(array_unique(explode(",",$grouping))));
		$file_no=implode(",",array_filter(array_unique(explode(",",$file_no))));
		
		$daysInHand=implode(",",array_filter(array_unique(explode(",",$daysInHand))));
		$WOPreparedAfter=implode(",",array_filter(array_unique(explode(",",$WOPreparedAfter))));
		$shiping_status=implode(",",array_filter(array_unique(explode(",",$shiping_status))));
		
        foreach ($nameArray as $result)
        {
            $total_set_qnty=$result[csf('total_set_qnty')];
            $colar_excess_percent=$result[csf('colar_excess_percent')];
            $cuff_excess_percent=$result[csf('cuff_excess_percent')];
            $rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
            
            $booking_percent=$result[csf('booking_percent')];
			$booking_po_id=$result[csf('po_break_down_id')];
			$a_process_loss=$extra[14]+$extra[8]+$extra[6]+$extra[12]+$extra[0]+$extra[10]+$extra[2]+$extra[1];//+$extra[13]
			$b_process_loss=$extra[4]+$extra[3]+$extra[15];
			$tot_pro_loss=$a_process_loss+$b_process_loss;
			?>
			<table width="100%" class="rpt_table"  border="1" align="left" cellpadding="0"  cellspacing="0" rules="all"  style="font-size:18px; font-family:Arial Narrow;" >
				<tr>
					<td colspan="2" rowspan="7" width="210">
						<? $nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id=$job_nos and file_type=1"); ?>
                        <div id="div_size_color_matrix" style="float:left;">
                            <fieldset id="" width="210">
                                <legend>Image </legend>
                                <table width="208">
                                    <tr>
										<?
                                        $img_counter = 0;
                                        foreach($nameArray_imge as $result_imge)
                                        {
											if($path=="") $path='../../';
											?>
											<td><img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="200" height="200" border="2" /></td>
											<?
											$img_counter++;
                                        }
                                        ?>
                                    </tr>
                                </table>
                            </fieldset>
                        </div>
					</td>
					<td width="200"><b>Job No</b></td>
					<?php 
					 	$revised_no=$nameArray_approved_row[csf('approved_no')]-1;
						if($revised_no<0) $revised_no=0;
					 ?>
					<td width="250" colspan="3"> <span style="font-size:18px"><b style="float:left;font-size:18px">&nbsp;<? echo $job_noss;?></span></b> </span> </td>
					<td width="200"><span style="font-size:18px"><b>Fabric Booking No</b></span></td>
					<td  width="250" colspan="3"><b>&nbsp;<? echo $result[csf('booking_no')]; ?></b></td>
				</tr>
 					<?
                        $gmts_item_name="";
                        $gmts_item=explode(',',$gmts_items);
						$job_no_row="";
                        $job_nosss=explode(',',$job_noss);
						$style_ref=explode(',',$style_ref_nos);
						$po_number=explode(',',$ponos);
						
						$order_uom_res=sql_select( "select a.order_uom from wo_po_details_master a where a.status_active=1 and a.is_deleted=0  and a.job_no=$job_nos ");
						$order_uom='';
						if(count($order_uom_res))
						{
							$order_uom=$unit_of_measurement[$order_uom_res[0][csf('order_uom')]];
						}
					 ?>
				<tr>
					<td width="200" style="font-size:16px;"><b>Style Ref</b></td>
					<td  width="250" colspan="3" style="font-size:16px;" >&nbsp;<? echo $style_ref_nos; ?></td>
					<td width="200"><b>Booking Date</b></td>
					<td  width="250" colspan="3">&nbsp; <?
                        if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
                        {
                        }
                        $booking_date=$result[csf('insert_date')];
                        echo change_date_format($booking_date,'dd-mm-yyyy','-','');
                        ?>
                    </td>
				</tr>
				<tr>
					<td width="200"><span style="font-size:18px"><b>Con's/Dzn</b></span></td>
					<td  width="250" colspan="3">&nbsp;<span style="font-size:18px"><?=number_format(($sum_fin_fabqnty[0][csf('qty')]/$po_qnty_tot1)*12,4); ?></span></td>
					<td width="200"><span style="font-size:18px"><b>Buyer Name</b></span></td>
					<td  width="250" colspan="3">&nbsp;<span style="font-size:18px"><? echo $buyer_name_arr[$buyer_name]; ?></span></td>
				</tr>
				<tr>
					<td width="200"><span style="font-size:18px"><b>Product Dept.</b></span></td>
					<td  width="250" colspan="3">&nbsp;<span style="font-size:18px"><? echo $product_dept[$product_deptartment]?></span></td>
					<td width="200"><span style="font-size:18px"><b>Season</b></span></td>
					<td  width="250" colspan="3">&nbsp;<span style="font-size:18px"><? echo $season_name_arr[$season]; ?></span></td>
				</tr>
				<tr>
				<td width="200"><span style="font-size:18px"><b>Description</b></span></td>
				<td width="250" colspan="3"><span style="font-size:18px"><? echo $style_description; ?></span></td>	
				<td width="200"><b>Finish Fabric Delivery</b></td>
				<td width="250" colspan="3">&nbsp;<? echo change_date_format($delivery_date); ?></td>
				</tr>
				<tr>
					<td width="200"><b>Fabric Source</b></td>
					<td width="250" colspan="3">&nbsp;<? echo $fabric_source[$result[csf('fabric_source')]]; ?></td>
					<td width="200"><b>Shipment Date</b></td>
                	<td width="250" colspan="3">&nbsp;<?php echo  date('d-m-Y',strtotime($min_shipment_date));?> to <?php echo  date('d-m-Y',strtotime($max_shipment_date));?></td>				
				</tr>
				
				<tr>
					<td width="200"><span style="font-size:18px"><b>Remarks</b></span></td>
					<td width="250" colspan="3">&nbsp;<? echo $remarks;  ?></td>
					<td width="200"><b>Sustainability Standard</b></td>
					<td width="250" colspan="3">&nbsp;<?php echo $sustainability_standard[$sustainability_standards]; ?></td>
				</tr>		
			</table>
			<br>
			<?
		}	
		if($show_yarn_rate==1)
		{	
		if($cbo_fabric_source==1)
		{

			for($d=0;$d<count($job_nosss); $d++)
			{	$item_grand_total=0; $item_grand_total_order=0;$grand_total=0; $grand_total_order=0;
				$nameArray_size=sql_select( "select size_number_id,min(id) as id, min(size_order) as size_order from wo_po_color_size_breakdown where status_active=1 and job_no_mst='$job_nosss[$d]' and is_deleted=0 and status_active=1 group by size_number_id order by size_order");

			
			?>
			<table width="100%" style="font-family:Arial Narrow;font-size:18px" >
                <tr>
                    <td width="100%">
                                <table class="rpt_table"  border="1" align="left" cellpadding="0" width="100%" cellspacing="0" rules="all" >
									<tr>
										<td style="border:1px solid black; text-align:center;"><strong>Style Ref:&nbsp;<? echo $style_ref[$d];?></strong></td>
										<td style="border:1px solid black; text-align:center;"><strong></strong></td>
										<td colspan="3" style="border:1px solid black; text-align:center;"><strong>Po Number:&nbsp;<? echo $po_number[$d];?></strong></td>
									</tr>
                                    <tr>
                                        <td align="center" style="border:1px solid black"><strong>Color/Size</strong></td>
                                        <?
                                        foreach($nameArray_size  as $result_size)
                                        {
											?>
                                        	<td align="center" style="border:1px solid black"><strong><?=$size_library[$result_size[csf('size_number_id')]];?></strong></td>
                                        <? } ?>
                                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                                        <td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
                                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                                    </tr>
                                    <?
                                    $color_size_order_qnty_array=array(); $color_size_qnty_array=array(); $size_tatal=array(); $size_tatal_order=array();
                                    for($c=0;$c<count($gmts_item); $c++)
                                    {
										$item_size_tatal=array(); $item_size_tatal_order=array();
										$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and job_no_mst='$job_nosss[$d]' and is_deleted=0 and status_active=1 group by color_number_id  order by color_order");
										?>
										<tr>
											<td style="border:1px solid black; text-align:center;" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>
										</tr>
										<?
										foreach($nameArray_color as $result_color)
										{
											?>
											<tr>
                                                <td align="center" style="border:1px solid black"><?=$color_library[$result_color[csf('color_number_id')]]; ?></td>
                                                <?
                                                $color_total=0; $color_total_order=0;
                                                foreach($nameArray_size  as $result_size)
                                                {
													$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and job_no_mst='$job_nosss[$d]' and  status_active=1 and is_deleted =0");
													foreach($nameArray_color_size_qnty as $result_color_size_qnty)
													{
														?>
														<td style="border:1px solid black; text-align:center; font-size:18px;">
														<?
														if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
														{
															echo number_format($result_color_size_qnty[csf('order_quantity')],0);
															$color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
															$color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
															$item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
															$item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
															$grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
															$grand_total_order +=$result_color_size_qnty[csf('order_quantity')];
															
															$color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
															$color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
															{
																$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
																$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
															}
															else
															{
																$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
																$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															}
															if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
																$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
															}
															else
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
																$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															}
														}
														else echo "0";
														?>
														</td>
														<?
													}
                                                }
                                                ?>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($color_total_order),0); ?></td>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?></td>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($color_total),0); ?></td>
											</tr>
											<?
										}
										?>
										
										<td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
										<?
										foreach($nameArray_size  as $result_size)
										{
											?>
											<td style="border:1px solid black;  text-align:center; font-size:18px;"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
											<?
										}
										?>
										<td style="border:1px solid black;  text-align:center; font-size:18px;"><?  echo number_format(round($item_grand_total_order),0); ?></td>
										<td style="border:1px solid black;  text-align:center; font-size:18px;"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
										<td style="border:1px solid black;  text-align:center; font-size:18px;"><?  echo number_format(round($item_grand_total),0); ?></td>
										</tr>
										<?
                                    }
                                    ?>
                                    <tr>
                                    	<td style="border:1px solid black; font-size:18px;" align="center" colspan="<? echo count($nameArray_size)+3; ?>"><strong>&nbsp;</strong></td>
                                    </tr>
                                    <tr>
                                        <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                                        <?
                                        foreach($nameArray_size  as $result_size)
                                        {
											?>
											<td style="border:1px solid black; text-align:center; font-size:18px;"><? echo $size_tatal_order[$result_size[csf('size_number_id')]]; ?></td>
											<?
                                        }
                                        ?>
                                        <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($grand_total_order),0); ?></td>
                                        <td style="border:1px solid black; text-align:center; font-size:18px;"><? $excess_gra_tot=($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
                                        <td style="border:1px solid black; text-align:center; font-size:18px;"><?  echo number_format(round($grand_total),0); ?></td>
                                    </tr>
                                </table>
                    </td>
                    </td>
                </tr>
			</table>
			<?
		}
		}
		}
		// if($cbo_fabric_source==1) end
	
	
	  	?>
		<br/>
		<br>
      	<!--  Here will be the fabric details  -->
		  <style>
	 .main_table tr th{
		 border:1px solid black;
		 font-size:13px;
		 outline: 0;
	 }
	  .main_table tr td{
		 border:1px solid black;
		 font-size:13px;
		 outline: 0;
	 }
	 </style>
     <?
	 $costing_per=""; $costing_per_qnty=0;
	 $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_nos'");
	{
		$costing_per="Kg";
		$costing_per_qnty=12;
	}
	if($costing_per_id==2)
	{
		$costing_per="Pcs";
		$costing_per_qnty=1;
	}
	if($costing_per_id==3)
	{
		$costing_per="2 Dzn";
		$costing_per_qnty=24;
	}
	if($costing_per_id==4)
	{
		$costing_per="3 Dzn";
		$costing_per_qnty=36;
	}
	if($costing_per_id==5)
	{
		$costing_per="4 Dzn";
		$costing_per_qnty=48;
	}
	$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");
	$nameArray_fabric_description= sql_select("select a.body_part_id, a.lib_yarn_count_deter_id as determin_id, a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type,a.uom, b.dia_width, b.remarks, avg(b.cons) as cons, b.process_loss_percent, avg(b.requirment) as requirment,b.po_break_down_id,  d.fabric_color_id, d.gmts_color_id, d.id as dtls_id, sum(d.fin_fab_qnty) as fin_fab_qnty, sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.uom=12 and d.status_active=1 and d.is_deleted=0  AND a.status_active = 1 AND a.is_deleted = 0   AND c.status_active = 1  AND c.is_deleted = 0  AND b.status_active = 1  AND b.is_deleted = 0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.construction, a.composition, a.gsm_weight,a.uom, b.dia_width, b.remarks,d.fabric_color_id, d.gmts_color_id, d.id,b.po_break_down_id, b.process_loss_percent order by d.id");
	foreach ($nameArray_fabric_description as $row) {	
		$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."'  and approval_status=3 and color_name_id=".$row[csf('fabric_color_id')]."");

		$grouping_item=$row[csf('fabric_color_id')].'*'.$row[csf('gmts_color_id')].'*'.$row[csf('construction')].'*'.$row[csf('composition')].'*'.$row[csf('gsm_weight')].'*'.$row[csf('dia_width')].'*'.$row[csf('color_type_id')];	
		$fabric_data_arr[$row[csf('body_part_id')]][$grouping_item]['body_part_id'] = $row[csf('body_part_id')];
		$fabric_data_arr[$row[csf('body_part_id')]][$grouping_item]['gmts_color_id'] = $row[csf('gmts_color_id')];
		$fabric_data_arr[$row[csf('body_part_id')]][$grouping_item]['fabric_color_id'] = $row[csf('fabric_color_id')];
		$fabric_data_arr[$row[csf('body_part_id')]][$grouping_item]['lapdip_no'] = $lapdip_no;
		//$fabric_data_arr[$row[csf('body_part_id')]][$grouping_body_part_idart_id'] = $row[csf('body_part_id')];
		$fabric_data_arr[$row[csf('body_part_id')]][$grouping_item]['construction'] = $row[csf('construction')];
		$fabric_data_arr[$row[csf('body_part_id')]][$grouping_item]['composition'] = $row[csf('composition')];

		$fabric_data_arr[$row[csf('body_part_id')]][$grouping_item]['gsm'] = $row[csf('gsm_weight')];
		$fabric_data_arr[$row[csf('body_part_id')]][$grouping_item]['remarks'] = $row[csf('remarks')];
		$fabric_data_arr[$row[csf('body_part_id')]][$grouping_item]['fabric_dia'] = $row[csf('dia_width')].",".$fabric_typee[$row[csf('width_dia_type')]];
		$fabric_data_arr[$row[csf('body_part_id')]][$grouping_item]['color_type_id'] = $row[csf('color_type_id')];
		$fabric_data_arr[$row[csf('body_part_id')]][$grouping_item]['finsh_cons'] = $row[csf('cons')];
		$fabric_data_arr[$row[csf('body_part_id')]][$grouping_item]['gray_cons'] = $row[csf('requirment')];
		$fabric_data_arr[$row[csf('body_part_id')]][$grouping_item]['fin_fab_qnty'] += $row[csf('fin_fab_qnty')];
		$fabric_data_arr[$row[csf('body_part_id')]][$grouping_item]['grey_fab_qnty'] += $row[csf('grey_fab_qnty')];
		$fabric_data_arr[$row[csf('body_part_id')]][$grouping_item]['process_loss_percent'] = $row[csf('process_loss_percent')];

	}

	/*echo '<pre>';
	print_r($fabric_data_arr); die;*/
	if(count($nameArray_fabric_description)>0){
	?>
     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-size: 18px;">
	 	<tr>
        	<td align="center" colspan="12">  <b>Fabric Details [Kg]</b></td>
        		            
    	</tr>
     	<tr>
		 	<th>Body Part</th>  
			<th>Gmts Color</th>
			<th>Fabric Color</th> 		
     		<th>Composition</th>
			<th>Construction</th>
     		<th>GSM</th>
			<th>Fin. Required GSM/Remarks</th>
			<th>Lab Dip No</th> 
     		<th>Dia Type with </br> Fabric Dia</th>		
     		<th>Color Type</th>
     		<th>Finish Cons</th>
     		<th>Total Finish</br> Fabric Kg</th>
     	</tr>
     	<? 
     	foreach ($fabric_data_arr as $body_part_id=>$fabric_data_arr) {  
     	$i=1;     		  		
     		foreach ($fabric_data_arr as $fabric_id => $value) {
				$fin_fab_qnty+=$value['fin_fab_qnty'];
				$finsh_cons+=$value['finsh_cons'];  		 	  		 	
				if($i==1){
				?>
				<tr>
					<td rowspan="<? echo count($fabric_data_arr) ?>"><? echo $body_part[$body_part_id] ?></td>
					<td><? echo $color_library[$value['gmts_color_id']] ?></td>
					<td><? echo $color_library[$value['fabric_color_id']] ?></td>
					<td><? echo $value['composition'] ?></td>
					<td><? echo $value['construction'] ?></td>
					<td><? echo $value['gsm'] ?></td>
					<td><? echo $value['remarks'] ?></td>
					<td><? echo $value['lapdip_no']; ?></td>
					<td><? echo $value['fabric_dia'] ?></td>
					<td><? echo $color_type[$value['color_type_id']] ?></td>
					<td align="right";><? echo number_format($value['finsh_cons'],4) ?></td>
					<td align="right";><? echo number_format($value['fin_fab_qnty'],2) ?></td>
				</tr>
				<? } 
				else { ?>
					<tr>
						<td><? echo $color_library[$value['gmts_color_id']] ?></td>
						<td><? echo $color_library[$value['fabric_color_id']] ?></td>
						<td><? echo $value['composition'] ?></td>
						<td><? echo $value['construction'] ?></td>
						<td><? echo $value['gsm'] ?></td>
						<td><? echo $value['remarks'] ?></td>
						<td><? echo $value['lapdip_no']; ?></td>
						<td><? echo $value['fabric_dia'] ?></td>
						<td><? echo $color_type[$value['color_type_id']] ?></td>
						<td align="right";><? echo number_format($value['finsh_cons'],4) ?></td>
						<td align="right";><? echo number_format($value['fin_fab_qnty'],2) ?></td>
					</tr>
				<? }
				$i++;
     		}
     	} 
     	?>
     	<tr>
     		<th align="right" colspan="10">Total</th>
			 <th align="right" ><? echo number_format($finsh_cons,4) ?></th>
     		<th align="right";><?echo number_format($fin_fab_qnty,2);  ?></th>
     	</tr>
     </table>
	 <?
	}
	$nameArray_fabric_desc= sql_select("select a.body_part_id, a.lib_yarn_count_deter_id as determin_id, a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type,a.uom, b.dia_width, b.remarks, avg(b.cons) as cons, b.process_loss_percent, avg(b.requirment) as requirment,b.po_break_down_id,  d.fabric_color_id, d.gmts_color_id, d.id as dtls_id, sum(d.fin_fab_qnty) as fin_fab_qnty, sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.uom=1 and d.status_active=1 and d.is_deleted=0  AND a.status_active = 1 AND a.is_deleted = 0   AND c.status_active = 1  AND c.is_deleted = 0  AND b.status_active = 1  AND b.is_deleted = 0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.construction, a.composition, a.gsm_weight,a.uom, b.dia_width, b.remarks,d.fabric_color_id, d.gmts_color_id, d.id,b.po_break_down_id, b.process_loss_percent order by d.id");
	foreach ($nameArray_fabric_desc as $row) {	
		$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst=".$job_nos."  and approval_status=3 and color_name_id=".$row[csf('fabric_color_id')]."");

		$grouping_item=$row[csf('fabric_color_id')].'*'.$row[csf('gmts_color_id')].'*'.$row[csf('construction')].'*'.$row[csf('composition')].'*'.$row[csf('gsm_weight')].'*'.$row[csf('dia_width')].'*'.$row[csf('color_type_id')];	
		$fabric_data_ar[$row[csf('body_part_id')]][$grouping_item]['body_part_id'] = $row[csf('body_part_id')];
		$fabric_data_ar[$row[csf('body_part_id')]][$grouping_item]['gmts_color_id'] = $row[csf('gmts_color_id')];
		$fabric_data_ar[$row[csf('body_part_id')]][$grouping_item]['fabric_color_id'] = $row[csf('fabric_color_id')];
		$fabric_data_ar[$row[csf('body_part_id')]][$grouping_item]['lapdip_no'] = $lapdip_no;
		//$fabric_data_arr[$row[csf('body_part_id')]][$grouping_body_part_idart_id'] = $row[csf('body_part_id')];
		$fabric_data_ar[$row[csf('body_part_id')]][$grouping_item]['construction'] = $row[csf('construction')];
		$fabric_data_ar[$row[csf('body_part_id')]][$grouping_item]['composition'] = $row[csf('composition')];

		$fabric_data_ar[$row[csf('body_part_id')]][$grouping_item]['gsm'] = $row[csf('gsm_weight')];
		$fabric_data_ar[$row[csf('body_part_id')]][$grouping_item]['remarks'] = $row[csf('remarks')];
		$fabric_data_ar[$row[csf('body_part_id')]][$grouping_item]['fabric_dia'] = $row[csf('dia_width')].",".$fabric_typee[$row[csf('width_dia_type')]];
		$fabric_data_ar[$row[csf('body_part_id')]][$grouping_item]['color_type_id'] = $row[csf('color_type_id')];
		$fabric_data_ar[$row[csf('body_part_id')]][$grouping_item]['finsh_cons'] = $row[csf('cons')];
		$fabric_data_ar[$row[csf('body_part_id')]][$grouping_item]['gray_cons'] = $row[csf('requirment')];
		$fabric_data_ar[$row[csf('body_part_id')]][$grouping_item]['fin_fab_qnty'] += $row[csf('fin_fab_qnty')];
		$fabric_data_ar[$row[csf('body_part_id')]][$grouping_item]['grey_fab_qnty'] += $row[csf('grey_fab_qnty')];

	}

	/* echo '<pre>';
	print_r($fabric_data_ar); die; */
	if(count($nameArray_fabric_desc)>0){

	?>
     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-size: 18px;">
	 	<tr>
        	<td align="center" colspan="12">  <b>Fabric Details [Pcs]</b></td>
        		            
    	</tr>
     	<tr>
		 	<th>Body Part</th> 
			<th>Gmts Color</th> 
			<th>Fabric Color</th> 		
     		<th>Composition</th>
			<th>Construction</th>
     		<th>GSM</th>
			<th>Fin. Required GSM</th>
			<th>Lab Dip No</th> 
     		<th>Dia Type with </br> Fabric Dia</th>		
     		<th>Color Type</th>
     		<th>Finish Cons</th>
     		<th>Total Finish</br>Quantity</th>
     	</tr>
     	<? 
     	foreach ($fabric_data_ar as $body_part_id=>$fabric_data_ar) {  
     	$i=1;     		  		
     		foreach ($fabric_data_ar as $fabric_id => $value) {
     				$fin_fab_qty+=$value['fin_fab_qnty'];   		 	  		 	
     		 		if($i==1){
     		 	 	?>
	     		 	<tr>
		     			<td rowspan="<? echo count($fabric_data_ar) ?>"><? echo $body_part[$body_part_id] ?></td>
						<td><? echo $color_library[$value['gmts_color_id']] ?></td>
						<td><? echo $color_library[$value['fabric_color_id']] ?></td>
						<td><? echo $value['composition'] ?></td>
		     			<td><? echo $value['construction'] ?></td>
		     			<td><? echo $value['gsm'] ?></td>
						<td><? echo $value['remarks'] ?></td>
						<td><? echo $value['lapdip_no']; ?></td>
		     			<td><? echo $value['fabric_dia'] ?></td>
		     			<td><? echo $color_type[$value['color_type_id']] ?></td>
		     			<td align="right";><? echo number_format($value['gray_cons']) ?></td>
		     			<td align="right";><? echo number_format($value['fin_fab_qnty']) ?></td>
	     			</tr>
     		 		<? } 
     		 		else { ?>
     		 			<tr>
						  	<td><? echo $color_library[$value['gmts_color_id']] ?></td>
						  	<td><? echo $color_library[$value['fabric_color_id']] ?></td>
							<td><? echo $value['composition'] ?></td>
		     				<td><? echo $value['construction'] ?></td>
			     			<td><? echo $value['gsm'] ?></td>
							<td><? echo $value['remarks'] ?></td>
							<td><? echo $value['lapdip_no']; ?></td>
			     			<td><? echo $value['fabric_dia'] ?></td>
			     			<td><? echo $color_type[$value['color_type_id']] ?></td>
			     			<td align="right";><? echo number_format($value['gray_cons']) ?></td>
			     			<td align="right";><? echo number_format($value['fin_fab_qnty']) ?></td>
	     				</tr>
     		 		<? }
     		 		$i++;
     		 	//}
     		}
     	} 
     	?>
     	<tr>
     		<th align="right" colspan="11">Total</th>
     		<th align="right";><?echo number_format($fin_fab_qty);  ?></th>
     	</tr>
     </table>
      <br/>
     <?
	}

	$lab_dip_color_arr=array();
	$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no in($job_nos)");
	foreach($lab_dip_color_sql as $row)
	{
		$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
	}
	
	$collar_cuff_percent_arr=array(); $collar_cuff_body_arr=array(); $collar_cuff_color_arr=array(); $collar_cuff_size_arr=array(); $collar_cuff_item_size_arr=array(); $color_size_sensitive_arr=array();

	$collar_cuff_sql="select a.id, a.item_number_id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=b.color_size_table_id and d.gmts_color_id=b.color_number_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order";
	$collar_cuff_sql_res=sql_select($collar_cuff_sql);
			
	$itemIdArr=array();

	foreach($collar_cuff_sql_res as $collar_cuff_row)
	{
		$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
		$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
		$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
		if(!empty($collar_cuff_row[csf('item_size')]))
		{
			$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
		}
		
		$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];
		
		$itemIdArr[$collar_cuff_row[csf('body_part_type')]].=$collar_cuff_row[csf('item_number_id')].',';
	}
	unset($collar_cuff_sql_res);
	$booking_po_id=$txt_order_no_id;
	$order_plan_qty_arr=array();

	$color_wise_wo_sql_qnty=sql_select( "select item_number_id, color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  status_active=1 and is_deleted =0  $job_no_mst_cond group by item_number_id, color_number_id, size_number_id");

	foreach($color_wise_wo_sql_qnty as $row)
	{
		$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
		$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
	}
	unset($color_wise_wo_sql_qnty);
	if($show_yarn_rate==1)
	{	

	foreach($collar_cuff_body_arr as $body_type=>$body_name)
	{
		$gmtsItemId=array_filter(array_unique(explode(",",$itemIdArr[$body_type])));
		foreach($body_name as $body_val)
		{
			$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
			$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;

			?>
			<div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin:5px; margin-bottom:5px; position:relative;font-size:18px;">
			<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
				<tr>
					<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
				</tr>
				<tr>
					<td width="100">Size</td>
						<?
						foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
						{
							?>
							<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
							<?
						}
						?>
					<td width="60" rowspan="2" align="center"><strong>Total</strong></td>
					<td rowspan="2" align="center"><strong>Extra %</strong></td>
				</tr>
				<tr>
					<td style="font-size:12px"><? echo $body_val; ?> Size</td>
					<?
					foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
					{
						if(count($size_number)>0)
						{
								foreach($size_number  as $item_size=>$val)
								{
								?>
								<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
								<?
								}
						}
						else
						{
							?>
							<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
							<?
						}
					}
					?>
				</tr>
					<?

					$pre_size_total_arr=array();
					foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
					{
						foreach($pre_cost_data as $color_number_id=>$color_number_data)
						{
							foreach($color_number_data as $color_size_sensitive=>$color_break_down)
							{
								$pre_color_total_collar=0;
								$pre_color_total_collar_order_qnty=0;
								$process_loss_method=$process_loss_method;
								$constrast_color_arr=array();
								if($color_size_sensitive==3)
								{
									$constrast_color=explode('__',$color_break_down);
									for($i=0;$i<count($constrast_color);$i++)
									{
										$constrast_color2=explode('_',$constrast_color[$i]);
										$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
									}
								}
								?>
								<tr>
									<td>
										<?
										if( $color_size_sensitive==3)
										{
											echo strtoupper ($constrast_color_arr[$color_number_id]) ;
											$lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
										}
										else
										{
											echo $color_library[$color_number_id];
											$lab_dip_color_id=$color_number_id;
										}
										?>
									</td>
									<?
									foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
									{
										?>
										<td align="center" style="border:1px solid black">
											<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
											$plan_cut=0;
											foreach($gmtsItemId as $giid)
											{
												if($body_type==50) $plan_cut+=($order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'])*2;
												else $plan_cut+=$order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'];
											}
											
											//$ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

											$collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
											// echo $collar_ex_per.'=';

											if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
											else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
											$colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
											$collerqty=($plan_cut+$colar_excess_per);

											//$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

											echo number_format($collerqty);
											$pre_size_total_arr[$size_number_id]+=$collerqty;
											$pre_color_total_collar+=$collerqty;
											$pre_color_total_collar_order_qnty+=$plan_cut;

											//$pre_grand_tot_collar_order_qty+=$plan_cut;
											?>
										</td>
										<?
									}
									?>

									<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
									<td align="center"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
								</tr>
								<?
								$pre_grand_collar_ex_per+=$collar_ex_per;
								$pre_grand_tot_collar+=$pre_color_total_collar;
								$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
							}
						}
					}
					?>
				
				<tr>
					<td>Size Total</td>
						<?
						// foreach($pre_size_total_arr  as $size_qty)
						// {
							foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
							{
								$size_qty=$pre_size_total_arr[$size_number_id];
								?>
								<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
								<?
							}

						// }
						?>
					<td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
					<td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
				</tr>
			</table>
			</div>
			<br/>
			<?
		}
	}
	}
   ?>
    <br/>
     
	<table  width="100%" style="margin: 0px;padding: 0px;">
	<?php $stripe_color_wise=array(); ?>
	       
	<tr>
		<td width="70%" >
			<table  class="rpt_table" border="1" cellpadding="1" cellspacing="1" rules="all" width="100%"   style="font-family:Arial Narrow;font-size:18px;margin: 0px;padding: 0px;" >								
				<?
					$color_name_arr=return_library_array( "select id,color_name from lib_color",'id','color_name');
					$sql_stripe=("SELECT c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.id as did,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,d.uom  from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d , wo_po_color_size_breakdown e where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no='$job_no'  and d.job_no='$job_no' and b.booking_no=$txt_booking_no  and c.color_type_id in (2,6,33,34) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and 	b.is_deleted=0 and e.id=b.color_size_table_id and e.is_deleted=0 and e.status_active=1 and e.color_number_id=d.color_number_id  group by c.id,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,d.uom,c.composition,c.construction,b.dia_width order by d.id "); 				
					$result_data=sql_select($sql_stripe);
					foreach($result_data as $row)
					{
						$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
						$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
						$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
						$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
						$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

						$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
						$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
						$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
						$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
						$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
					}
					if(count($stripe_arr)>0){
    					?>
						<thead>
						<tr align="center">
								<td colspan="9"><b>Stripe Details</b></td>
							</tr>
							<tr>
								<th align="center" width="30"> SL</th>
								<th align="center" width="100"> Body Part</th>
								<th align="center" width="80"> Fabric Color</th>
								<th align="center" width="70"> Fabric Qty(KG)</th>
								<th align="center" width="70"> Stripe Color</th>
								<th align="center" width="70"> Stripe Measurement</th>
								<th align="center" width="70"> Stripe Uom</th>
								<th align="center" width="70"> Qty.(KG)</th>
								<th align="center" width="70"> Y/D Req.</th>
							</tr>
						</thead>
						<tbody>  
							<?							
							$i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
							foreach($stripe_arr as $body_id=>$body_data)
							{
								foreach($body_data as $color_id=>$color_val)
								{
									$rowspan=count($color_val['stripe_color']);
									$composition=$stripe_arr2[$body_id][$color_id]['composition'];
									$construction=$stripe_arr2[$body_id][$color_id]['construction'];
									$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
									$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
									$dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];

									if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
									else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";

									$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
										WHERE a.job_no=b.job_no and
										a.id=b.pre_cost_fabric_cost_dtls_id and
										c.job_no_mst=a.job_no and
										c.id=b.color_size_table_id and
										b.po_break_down_id=d.po_break_down_id and
										b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
										d.booking_no =$txt_booking_no and
										a.body_part_id='".$body_id."' and
										a.color_type_id='".$color_type_id."' and
										a.construction='".$construction."' and
										a.composition='".$composition."' and
										a.gsm_weight='".$gsm_weight."' and
										$color_cond and
										d.status_active=1 and
										d.is_deleted=0
										");
								
										list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;
									$sk=0;
									foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
									{
										
											?>
										<tr title="<?=$span?>">
											<?
											$color_qty=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
											if($sk==0)
											{
												?>
												<td rowspan="<?=$rowspan;?>"> <? echo $i; ?></td>
												<td rowspan="<?=$rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
												<td rowspan="<?=$rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
												<td rowspan="<?=$rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?>&nbsp; </td>
												<?
												$total_fab_qty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
												$i++;
											}
											

												$measurement=$color_val['measurement'][$strip_color_id];
												$uom=$color_val['uom'][$strip_color_id];
												$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
												$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
												
												?>
											
													<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
													<td align="right"> <? echo  number_format($measurement,2); ?> &nbsp; </td>
													<td align="center"> <? echo  $unit_of_measurement[$uom]; ?></td>
													<td align="right"> <? echo  number_format($fabreqtotkg,2); ?> &nbsp;</td>
													<td align="center"> <? echo  $yes_no[$yarn_dyed]; ?></td>
												
												<?
												
												$sk++;
												$total_fabreqtotkg+=$fabreqtotkg;
												$stripe_color_wise[$color_name_arr[$s_color_val]]+=$fabreqtotkg;
											
											
											?>
										</tr>
										<?
									}
								}
							}
							?>
						</tbody>
						<tfoot>
							<tr>
								<td colspan="3">Total </td>
								<td align="right">  <? echo  number_format($total_fab_qty,2); ?> &nbsp;</td>
								<td></td>
								<td></td>
								<td>   </td>
								<td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> &nbsp;</td>
							</tr>
						</tfoot>
    			    </table>
	        	</td>
			    <?

					$i=1;$total_stripe_qnt=0;        		            
						foreach($stripe_color_wise as $color=>$val)
						{
							
							
							?>
							<tr>
								<td> <? echo $i; ?></td>
								
								<td > <? echo $color; ?></td>
								<td align="right"> <?php echo number_format($val,2); ?></td>
							</tr>
							
							<?
							$total_stripe_qnt+=$val;
							
							$i++;
						}
			       					
			    ?>
		                   <tfoot>
		       	            <tr>
		       		            <td></td>
		       		            <td></td>
		       		            <td align="right"><? echo  number_format($total_stripe_qnt,2); ?> </td>
		       	            </tr>
		                   </tfoot>
			        </table>
	        </tr>
        </table >
        

       <? } ?>
      
        <br/>
		
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;font-size:18px;">
            <tr>
                <td width="49%" valign="top">
				<?  echo get_spacial_instruction($txt_booking_no,"97%",108); ?>
                </td>
                <td width="2%">
                </td>
            </tr>
        </table>
        <br/>
        
        <?
	   
		  echo signature_table(121, $cbo_company_name, "1000px",$template_id, 40, $user_lib_name_arr[$inserted_by]);
       ?>
		<br>
       <?
	$emailBody=ob_get_contents();
	//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
	*/		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and  b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		

		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			echo sendMailMailer( $to, $subject, $emailBody,$from_mail,'' );
		}
	}
	exit();
}


if($action=="company_wise_report_button_setting")
{
extract($_REQUEST);
//$process = array( &$_POST );
//extract(check_magic_quote_gpc( $process ));
//echo "select format_id from lib_report_template where template_name ='".$data."'  and module_id=2 and report_id=35 and is_deleted=0 and status_active=1";die;

$print_report_format=return_field_value("format_id"," lib_report_template","template_name ='".$data."'  and module_id=2 and report_id=35 and is_deleted=0 and status_active=1");

	$print_report_format_arr=explode(",",$print_report_format);
	echo "$('#print_1').hide();\n";
	echo "$('#print_2').hide();\n";
	echo "$('#print_3').hide();\n";
	echo "$('#print_4').hide();\n";
	echo "$('#print_5').hide();\n";
	echo "$('#print_6').hide();\n";
	echo "$('#print_7').hide();\n";
	echo "$('#print_8').hide();\n";
	echo "$('#print_booking_9').hide();\n";
	echo "$('#print_10').hide();\n";
	echo "$('#print_11').hide();\n";
	echo "$('#print_12').hide();\n";
	echo "$('#print_13').hide();\n";
	echo "$('#print_14').hide();\n";
	echo "$('#print_15').hide();\n";
	echo "$('#print_16').hide();\n";
	echo "$('#print_17').hide();\n";
	echo "$('#print_18').hide();\n";
	echo "$('#print_19').hide();\n";
	echo "$('#print_20').hide();\n";
	echo "$('#print_21').hide();\n";
	foreach($print_report_format_arr as $id){
		if($id==143){echo "$('#print_1').show();\n";}
		if($id==84){echo "$('#print_2').show();\n";}
		if($id==85){echo "$('#print_3').show();\n";}
		if($id==151){echo "$('#print_4').show();\n";}
		if($id==160){echo "$('#print_5').show();\n";}
		if($id==175){echo "$('#print_6').show();\n";}
		if($id==218){echo "$('#print_7').show();\n";}
		if($id==220){echo "$('#print_8').show();\n";}
		if($id==235){echo "$('#print_booking_9').show();\n";}
		if($id==274){echo "$('#print_10').show();\n";}
		if($id==241){echo "$('#print_11').show();\n";}
		if($id==269){echo "$('#print_12').show();\n";}
		if($id==28){echo "$('#print_13').show();\n";}
		if($id==280){echo "$('#print_14').show();\n";}
		if($id==304){echo "$('#print_15').show();\n";}
		if($id==719){echo "$('#print_16').show();\n";}
		if($id==723){echo "$('#print_17').show();\n";}
		if($id==339){echo "$('#print_18').show();\n";}
		if($id==370){echo "$('#print_19').show();\n";}
		if($id==768){echo "$('#print_20').show();\n";}
		if($id==425){echo "$('#print_21').show();\n";}
	}

exit();
}


if ($action=="send_mail_report_setting_first_select"){
	$print_report_format=return_field_value("format_id","lib_report_template","template_name ='".$data."' and module_id=2 and report_id =35 and is_deleted=0 and status_active=1");
	echo $print_report_format;
	exit();
}


if($action=="show_fabric_booking_report_advance_attire_ltd")
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$company_library=return_library_array( "select id, company_name from lib_company", "id", "company_name");
	$location_arr=return_library_array("select id,location_name from lib_location", "id","location_name");
	$supplier_arr=return_library_array( "select id, supplier_name from lib_supplier",'id','supplier_name');
	$buyer_arr=return_library_array( "select id,buyer_name from lib_buyer", "id","buyer_name");
	$season_arr=return_library_array("select id,season_name from lib_buyer_season","id","season_name");
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info","id","team_member_name");
	//$fab_uomArr = return_library_array("select id,uom from wo_pre_cost_fabric_cost_dtls","id","uom");
	$color_arr=return_library_array( "select id,color_name from lib_color", "id", "color_name");

	$imge_arr=return_library_array( "select master_tble_id, image_location from common_photo_library where form_name='company_details' or form_name='knit_order_entry' and file_type=1",'master_tble_id','image_location');

	$sql_mst="select buyer_id, booking_no, booking_date, supplier_id, currency_id, exchange_rate, attention, delivery_date, pay_mode, po_break_down_id, colar_excess_percent, cuff_excess_percent, delivery_date, is_apply_last_update, fabric_source, rmg_process_breakdown, insert_date, update_date, uom, remarks, pay_mode, fabric_composition from wo_booking_mst where booking_no=$txt_booking_no and status_active =1 and is_deleted=0";
	$dataArray=sql_select($sql_mst);

	$booking_no=$dataArray[0][csf('booking_no')];
	$booking_uom=$dataArray[0][csf('uom')];

	if($db_type==0)
	{
		$job_no=return_field_value( "group_concat(job_no) as job_no", "wo_booking_dtls","booking_no='$booking_no' and status_active=1 and is_deleted=0", "job_no");
	}
	else
	{
		$job_no=return_field_value( "listagg(CAST(job_no as VARCHAR(4000)),',') within group (order by job_no) as job_no", "wo_booking_dtls","booking_no='$booking_no' and status_active=1 and is_deleted=0", "job_no");
	}

	$job_no=array_unique(explode(",",$job_no));
	$job_nos="'".implode("','",$job_no)."'";
	//echo $job_no;
	$style_ref="";
	//$job_arr=array(); $po_arr=array();
	$season=$season_matrix=$dealing_marchant=$po_number=$pub_shipment_date=$style_ref='';
	$po_sql=sql_select("select a.season,a.style_ref_no, a.season_matrix, a.dealing_marchant, b.po_number, b.pub_shipment_date  from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and a.job_no in(".$job_nos.") and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0");
	foreach($po_sql as $row)
	{
		if($row[csf('season_matrix')]!=0) $row[csf('season_matrix')]=$row[csf('season')]; else $row[csf('season_matrix')]=$season_arr[$row[csf('season_matrix')]];
		if($season=="") $season=$row[csf('season_matrix')]; else $season.=','.$row[csf('season_matrix')];
		if($dealing_marchant=="") $dealing_marchant=$marchentrArr[$row[csf('dealing_marchant')]]; else $dealing_marchant.=','.$marchentrArr[$row[csf('dealing_marchant')]];
		if($po_number=="") $po_number=$row[csf('po_number')]; else $po_number.=','.$row[csf('po_number')];
		if($pub_shipment_date=="") $pub_shipment_date=change_date_format($row[csf('pub_shipment_date')]); else $pub_shipment_date.=','.change_date_format($row[csf('pub_shipment_date')]);
			if($style_ref=="") $style_ref=$row[csf('style_ref_no')]; else $style_ref.=','.$row[csf('style_ref_no')];
	}

	$season=implode(",",array_unique(explode(",",$season)));
	$dealing_marchant=implode(",",array_unique(explode(",",$dealing_marchant)));
	$po_number=implode(",",array_unique(explode(",",$po_number)));
	$pub_shipment_date=implode(",",array_unique(explode(",",$pub_shipment_date)));
	$style_ref=implode(",",array_unique(explode(",",$style_ref)));
	$path=str_replace("'","",$path);
	if($path=="")
	{
		$path='../../';
	}
	ob_start();
	?>
    <html>
	 
	<div style="width:950px;">
    <table width="100%" cellpadding="0" cellspacing="0" >
    	<tr><td width="70">&nbsp;</td><td align="right"><strong>Po No: <? echo $dataArray[0][csf('booking_no')]; ?></strong></td></tr>
        <tr><td width="70">&nbsp;</td><td align="right"><strong>Po Date: <? echo change_date_format($dataArray[0][csf('booking_date')]); ?></strong></td></tr>
        <tr><td width="70">&nbsp;</td><td align="right"><strong>Delivery Date: <? echo change_date_format($dataArray[0][csf('delivery_date')]); ?></strong></td></tr>
        <tr>
            <td width="70" align="right">
            	<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
            </td>
            <td>
                <table cellspacing="0" align="center">
                    <tr>
                    	<td align="center" style="font-size:20px"><strong ><? echo $company_library[$cbo_company_name]; ?></strong></td>
                    </tr>
                    <tr class="form_caption">
                        <td  align="center" style="font-size:14px"><? echo show_company($cbo_company_name,'',''); ?></td>
                    </tr>
                    <tr>
                    	<td align="center" style="font-size:18px"><strong><? echo $report_title; ?></strong></td>
                    </tr>
                </table>
            </td>
        </tr>
    </table>
    <table width="950" cellspacing="0" align="" border="0">
    	<tr><td colspan="6" align="left">To.</td></tr>
        <tr>
            <td width="305" colspan="2"><strong></strong>
            <?	$supplier_name="";
            	if($dataArray[0][csf('pay_mode')]==1 || $dataArray[0][csf('pay_mode')]==2)
                {
                    $party_add=$dataArray[0][csf('supplier_id')];
                    $nameArray=sql_select( "select address_1, web_site, country_id from lib_supplier where id=$party_add");
                    foreach ($nameArray as $result)
                    {
                        $address="";
                         if($result[csf('address_1')]!="") $address=$result[csf('address_1')];//.'<br>'.$country_arr[$result['country_id']].'<br>'.$result['email'].'<br>'.$result['web_site']
                    }
                    $supplier_name=$supplier_arr[$party_add].'<br>'.' : Address :- '.$address;
                }
				else
					$supplier_name=$company_library[$dataArray[0][csf('supplier_id')]];
				echo $supplier_name;
			?>
            </td>
            <td width="130"><strong>Buyer: </strong></td><td width="175px"> <p><? echo $buyer_arr[$dataArray[0][csf('buyer_id')]]; ?></p></td>
            <td width="130"><strong>Currency :</strong></td> <td width="175"><p><? echo $currency[$dataArray[0][csf('currency_id')]]; ?></p></td>
        </tr>
        <tr>
            <td width="130"><strong>Order No: </strong></td><td  width="175px" style="word-break:break-all"><p> <? echo $po_number; ?></p></td>
            <td><strong>Season :</strong></td> <td><p><? echo $season; ?></p></td>
            <td><strong>Attention:</strong></td> <td><p><? echo $dataArray[0][csf('attention')]; ?></p></td>
        </tr>
        <tr>
            <td><strong>Job No.: </strong></td><td style="word-break:break-all"><p> <? echo implode(",",$job_no); ?></p></td>
            <td><strong>Dealing Merchandiser:</strong></td><td><p><? echo $dealing_marchant; ?></p></td>
            <!-- <td><strong>Ship Date:</strong></td><td><p><? //echo $pub_shipment_date; ?></p></td> -->
            <td><strong>Style No.: </strong></td><td style="word-break:break-all"> <p><? echo $style_ref; ?></p></td>
        </tr>
        <tr>

			<td><strong>Booking Remarks:</strong></td><td colspan="3"><p><? echo $dataArray[0][csf('remarks')]; ?></p></td>
        </tr>
    </table>
    <br>
	<div style="width:100%;">
		<table style="margin-left:3px;" cellspacing="0" width="1010"  border="1" rules="all" class="rpt_table" >
            <thead bgcolor="#dddddd" align="center">
                <th width="30">SL</th>
                <th width="200">Item Description D</th>
                <th width="60">GSM</th>
                <th width="70">Width</th>
                <th width="80">Color Type</th>
                <th width="100">GMT Color</th>
                <th width="100">Fabric Color</th>
                <th width="50">UOM</th>
                <th width="80">Fabric Qty.</th>
                <th width="70">Rate</th>
                <th>Amount</th>
            </thead>
            <tbody>
				<?
				//pre_cost_fabric_cost_dtls_id
                $sql_result= sql_select("SELECT a.construction, a.copmposition, a.gsm_weight, a.dia_width, a.color_type, a.gmts_color_id, a.fabric_color_id, sum(a.fin_fab_qnty) as fin_fab_qnty, avg(a.rate) as rate, sum(a.amount) as amount,b.uom from wo_booking_dtls a join wo_pre_cost_fabric_cost_dtls b on a.pre_cost_fabric_cost_dtls_id=b.id where a.booking_no ='$booking_no' and a.status_active=1 and a.is_deleted=0 group by a.construction, a.copmposition, a.dia_width, a.color_type, a.gmts_color_id, a.fabric_color_id,a.gsm_weight, b.uom order by  a.construction, a.copmposition ");
                $i=1;$desc_by_arr=array();$k=1;$sub_tot_qty=$sub_tot_amount=0;
                foreach($sql_result as $row)
				{
					if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";

					//$uom_id=$fab_uomArr[$row[csf('fab_cost_id')]];

					$desc_value=$row[csf('construction')].$row[csf('copmposition')];
					if (!in_array($desc_value,$desc_by_arr) )
						{
							if($k!=1)
							{
							?>
							 <tr class="tbl_bottom" style="background:#CCCCCC">
                              <td colspan="8"  align="right"><b>Sub Total</b></td>
							   <td align="right"><? echo number_format($sub_tot_qty,2); ?></td>
							    <td align="right">&nbsp;</td>
								<td align="right"><? echo number_format($sub_tot_amount,2); ?></td>
							  </tr>


							<?
								unset($sub_tot_qty);
								unset($sub_tot_amount);
							}
							$desc_by_arr[]=$desc_value;
							$k++;
						}
					?>
                    <tr bgcolor="<? echo $bgcolor; ?>">
                        <td><? echo $i; ?></td>
                        <td><? echo $row[csf('construction')].' '.$row[csf('copmposition')]; ?></td>
                        <td><? echo $row[csf('gsm_weight')]; ?></td>
                        <td><? echo $row[csf('dia_width')]; ?></td>
                        <td><? echo $color_type[$row[csf('color_type')]]; ?></td>
                        <td><? echo $color_arr[$row[csf('gmts_color_id')]]; ?></td>
                        <td><? echo $color_arr[$row[csf('fabric_color_id')]]; ?></td>
                        <td><? echo $unit_of_measurement[$row[csf('uom')]]; ?></td>
                        <td align="right"><? echo number_format($row[csf('fin_fab_qnty')],2); ?></td>
                        <td align="right"><? echo number_format($row[csf('rate')],4); ?></td>
                        <td align="right"><? echo number_format($row[csf('amount')],2); ?></td>
					</tr>
					<?
					$i++;
					$grand_tot_qty+=$row[csf('fin_fab_qnty')];
					$sub_tot_qty+=$row[csf('fin_fab_qnty')];
					$grand_tot_amount+=$row[csf('amount')];
					$sub_tot_amount+=$row[csf('amount')];
				}
				$carrency_id=$dataArray[0][csf('currency_id')];
				if($carrency_id==1){$paysa_sent="Paisa";} else if($carrency_id==2){$paysa_sent="CENTS";}
				?>
				<tr class="tbl_bottom" style="background:#CCCCCC">
				  <td colspan="8"  align="right"><b>Sub Total</b></td>
				   <td align="right"><? echo number_format($sub_tot_qty,2); ?></td>
					<td align="right">&nbsp;</td>
					<td align="right"><? echo number_format($sub_tot_amount,2); ?></td>
				 </tr>

            </tbody>
            <tfoot>
                <tr>
                    <td align="right" colspan="8"><strong>Grand Total</strong></td>
                    <td align="right"><? echo number_format($grand_tot_qty,2); ?>&nbsp;</td>
                    <td>&nbsp;</td>
                    <td align="right"><? echo number_format($grand_tot_amount,2); ?>&nbsp;</td>
                </tr>
               <tr>
                   <td colspan="11" align="left"><b>In Word: <? echo number_to_words(def_number_format($grand_tot_amount,2,""),$currency[$carrency_id],$paysa_sent); ?></b></td>
               </tr>
           </tfoot>
        </table>
        <?
			echo get_spacial_instruction($booking_no,'930px',108);
		?>
        <br>
		 <?
            echo signature_table(121, $cbo_company_name, "930px");
         ?>
        </div>
    </div>
    </html>
	<?
	
	$user_id=$_SESSION['logic_erp']['user_id'];
	$report_cat=100;
	$html = ob_get_contents();
		ob_clean();
		//$new_link=create_delete_report_file( $html, 2, $delete, "../../../" );
		foreach (glob("tb*.xls") as $filename) {
		//if( @filemtime($filename) < (time()-$seconds_old) )
		@unlink($filename);
		}
		//---------end------------//
		$name=time();
		$filename="tb".$user_id."_".$name.".xls";
		$create_new_doc = fopen($filename, 'w');
		$is_created = fwrite($create_new_doc, $html);
		
		
	
		 
	 
		list($is_mail_send,$mail)=explode('___',$mail_send_data);
		if($is_mail_send==1){
			require_once('../../../mailer/class.phpmailer.php');
			require_once('../../../auto_mail/setting/mail_setting.php');
			$mailBody = preg_replace("/<img[^>]+\>/i", " ", $html); 
			$mailBody="<br>".$mail_body	;	
			$mailToArr=array();
			$mailSql = "select b.EMAIL  from wo_booking_mst a,LIB_SUPPLIER b where b.id=a.supplier_id and a.booking_no=$txt_booking_no";
		//echo $mailSql;die;
			$mailSqlRes=sql_select($mailSql);
			foreach($mailSqlRes as $rows){
				if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
			}
			
			
			$mailSql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=99 and b.mail_user_setup_id=c.id  and c.IS_DELETED=0 and c.STATUS_ACTIVE=1";
			//echo $mailSql;die;
			$mailSqlRes=sql_select($mailSql);
			foreach($mailSqlRes as $rows){
				if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
			}
			if($mail!=''){$mailToArr[]=$mail;}
	
			$to=implode(',',$mailToArr);
			$subject="Partial fabric booking";
			$header=mailHeader();
			echo $to;
			echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
			
		}
		else{
			echo "$filename****$html****$report_cat";
		}
		exit();
}


if($action=="print_booking_3") // rehan for northern
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' or form_name='knit_order_entry' and file_type=1",'master_tble_id','image_location');
	$company_library=return_library_array( "select id,company_name from lib_company where status_active=1 and is_deleted=0", "id", "company_name");
	$color_library=return_library_array( "select id,color_name from lib_color  where status_active=1 and is_deleted=0", "id", "color_name");
	$size_library=return_library_array( "select id,size_name from lib_size  where status_active=1 and is_deleted=0", "id", "size_name");
	$country_arr=return_library_array( "select id,country_name from   lib_country  where status_active=1 and is_deleted=0",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier  where status_active=1 and is_deleted=0",'id','supplier_name');
	$supplier_address_arr=return_library_array( "select id,address_1 from   lib_supplier  where status_active=1 and is_deleted=0",'id','address_1');

	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info  where status_active=1 and is_deleted=0","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer  where status_active=1 and is_deleted=0",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location  where status_active=1 and is_deleted=0",'id','location_name');

	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	$season_arr=return_library_array("select id,season_name from lib_buyer_season  where status_active=1 and is_deleted=0","id","season_name");
	$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where status_active=1 and is_deleted=0 and id in(select po_break_down_id from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no=$txt_booking_no)",'id','po_number');

	$uom=0;
	$joball=array();
	$nameArray_per_job=sql_select( "SELECT  a.job_no,a.style_ref_no ,a.season_matrix,a.gmts_item_id,a.product_dept,max(c.booking_date) as booking_date ,max(c.delivery_date) as delivery_date,max(c.is_approved) as is_approved,max(c.buyer_id) as buyer_id,max(c.pay_mode) as pay_mode,max(supplier_id) as supplier_id,max(a.dealing_marchant) as dealing_marchant,max(c.attention) as attention,max(c.currency_id) as currency_id ,max(c.remarks)  as remarks from wo_po_details_master a , wo_booking_dtls b,wo_booking_mst c  where c.booking_no=b.booking_no and c.status_active=1 and c.is_deleted=0 and  a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by  a.job_no,a.style_ref_no ,a.season_matrix,a.gmts_item_id,a.product_dept ");
$po_job_no="";
	foreach ($nameArray_per_job as $vals)
	{
		$joball['job_no'][$vals[csf('job_no')]]=$vals[csf('job_no')];
		$joball['style_ref_no'][$vals[csf('job_no')]]=$vals[csf('style_ref_no')];
		$all_job_arr[$vals[csf("job_no")]]["job"]="'".$vals[csf("job_no")]."'";
		$all_job_arr[$vals[csf("job_no")]]["style"]=$vals[csf("style_ref_no")];
		$all_job_arr[$vals[csf("job_no")]]["item"]=$vals[csf("gmts_item_id")];
		$all_job_arr[$vals[csf("job_no")]]["season"]=$vals[csf("season_matrix")];
		$all_job_arr[$vals[csf("job_no")]]["dept"]=$vals[csf("product_dept")];
		$all_jobs[$vals[csf("job_no")]]="'".$vals[csf("job_no")]."'";
		$po_job_no=$vals[csf('job_no')];
	}
	$all_jobs_id=implode(",",$all_jobs );
 	$po_qnty_all_style=sql_select("SELECT sum(po_quantity) as qnty from wo_po_break_down where status_active=1 and is_deleted=0 and job_no_mst in ($all_jobs_id)");

 	$all_shipdates_arr=sql_select("SELECT min(b.pub_shipment_date)  as shipdate,job_no from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.status_active=1 and b.is_deleted=0 and  a.status_active=1 and a.is_deleted=0 and b.job_no_mst in ($all_jobs_id) group by job_no");
 	$shipment_dates="";
 	foreach($all_shipdates_arr as $key=>$data)
 	{
 		if($shipment_dates=="")
 		{
 			$shipment_dates=change_date_format($data[csf("shipdate")]);
 		}
 		else
 		{
 			$shipment_dates .=','.change_date_format($data[csf("shipdate")]);
 		}
 	}


	$uom=0;
	$job_data_arr=array();
	$nameArray_buyer=sql_select( "SELECT  a.style_ref_no,a.style_description, a.job_no, a.style_owner, a.buyer_name, a.dealing_marchant,a.season,a.season_matrix,a.total_set_qnty,a.product_dept,a.product_code,a.pro_sub_dep,a.gmts_item_id ,a.order_repeat_no,a.qlty_label  from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0 and a.job_no='".$row_per_job[csf('job_no')]."'");
	foreach ($nameArray_buyer as $result_buy)
	{
		$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
		$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
		$job_data_arr['total_set_qnty'][$result_buy[csf('job_no')]]=$result_buy[csf('total_set_qnty')];
		$job_data_arr['product_dept'][$result_buy[csf('job_no')]]=$product_dept[$result_buy[csf('product_dept')]];
		$job_data_arr['product_code'][$result_buy[csf('job_no')]]=$result_buy[csf('product_code')];
		$job_data_arr['pro_sub_dep'][$result_buy[csf('job_no')]]=$pro_sub_dept_array[$result_buy[csf('pro_sub_dep')]];
		$job_data_arr['gmts_item_id'][$result_buy[csf('job_no')]]=$result_buy[csf('gmts_item_id')];
		$job_data_arr['style_ref_no'][$result_buy[csf('job_no')]]=$result_buy[csf('style_ref_no')];
		$job_data_arr['style_description'][$result_buy[csf('job_no')]]=$result_buy[csf('style_description')];
		$job_data_arr['dealing_marchant'][$result_buy[csf('job_no')]]=$marchentrArr[$result_buy[csf('dealing_marchant')]];
		$job_data_arr['season_matrix'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_matrix')]];
		$job_data_arr['order_repeat_no'][$result_buy[csf('job_no')]]=$result_buy[csf('order_repeat_no')];
		$job_data_arr['qlty_label'][$result_buy[csf('job_no')]]=$quality_label[$result_buy[csf('qlty_label')]];
	}
	$job_no= implode(",",array_unique($job_data_arr['job_no']));
	$job_no_in= implode(",",array_unique($job_data_arr['job_no_in']));
	$product_depertment=implode(",",array_unique($job_data_arr['product_dept']));
	$product_code=implode(",",array_unique($job_data_arr['product_code']));
	$pro_sub_dep=implode(",",array_unique($job_data_arr['pro_sub_dep']));
	$gmts_item_id=implode(",",array_unique($job_data_arr['gmts_item_id']));
	$style_sting=implode(",",array_unique($job_data_arr['style_ref_no']));
	$style_description=implode(",",array_unique($job_data_arr['style_description']));
	$dealing_marchant=implode(",",array_unique($job_data_arr['dealing_marchant']));
	$season_matrix=implode(",",array_unique($job_data_arr['season_matrix']));
	$order_repeat_no= implode(",",array_unique($job_data_arr['order_repeat_no']));
	$qlty_label= implode(",",array_unique($job_data_arr['qlty_label']));
	$path=str_replace("'","",$path);
	if($path=="")
	{
	$path='../../';
	}
	ob_start();
	?>
	<style type="text/css">

		body, p, span, td, a {font-size:10pt;font-family: Arial;}
		body{margin-left:2em; margin-right:2em; font-family: "Arial Narrow", Arial, sans-serif;}

	</style>

	<div style="width:1330px" align="center" >

		<table id="tb_header" width="100%" cellpadding="0" cellspacing="0" style="border:0px solid black" >
			<thead>
				<tr>
					<td width="150" rowspan="4">
						<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100' width='100' />
					</td>
					<td width="200">&nbsp;</td>
					<td width="400" align="left"><strong><?php echo $company_library[$cbo_company_name]; ?></strong></td>
					<td width="100">&nbsp;</td>
					<td width="300" align="left"><b>Booking No: </b><?php echo str_replace("'", "", $txt_booking_no); ?></td>
				</tr>

				<tr>
					<td width="200">&nbsp;</td>
					<td width="400" align="left">
						<?
						$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
						foreach ($nameArray as $result)
						{

						echo $result[csf('city')];


/*							Plot No: <? echo $result[csf('plot_no')]; ?>
							Level No: <? echo $result[csf('level_no')]?>
							Road No: <? echo $result[csf('road_no')]; ?>
							Block No: <? echo $result[csf('block_no')];?>
							City No: <? echo $result[csf('city')];?>
							Zip Code: <? echo $result[csf('zip_code')]; ?>
							Province No: <?php echo $result[csf('province')]; ?>
							Country: <? echo $country_arr[$result[csf('country_id')]]; ?><br>
							Email Address: <? echo $result[csf('email')];?>
							Website No: <? echo $result[csf('website')];
*/						}
							?>

					</td>
					<td width="100">&nbsp;</td>
					<td width="300" align="left"><b>Booking Date: </b><?php echo change_date_format($nameArray_per_job[0][csf("booking_date")]); ?></td>
				</tr>

				<tr>
					<td width="200">&nbsp;</td>
					<td width="400" align="left"><strong> Main Fabric Booking  </strong></td>
					<td width="100">&nbsp;</td>
					<td width="300" align="left"><b>Delivery Date: </b><?php echo change_date_format($nameArray_per_job[0][csf("delivery_date")]); ?></td>
				</tr>

				<tr>
					<td colspan="3" width="700">&nbsp;</td>
					<td width="300" align="left"><b>Approval Status: </b><?php if ($nameArray_per_job[0][csf("is_approved")] == 1 || $nameArray_per_job[0][csf("is_approved")] == 3) {echo "Approved";}?></td>
				</tr>
				<tr>
					<td colspan="4" height="10">&nbsp;</td>
				</tr>

				<tr>
					<td width="300"><b>To</b></td>

					<td width="400" align="left"><b>Buyer Name :   </b> <? echo $buyer_name_arr[$nameArray_per_job[0][csf("buyer_id")]]; ?></td>


				</tr>
				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<tr>
					<td width="300"><?
					$pay_mode=$nameArray_per_job[0][csf("pay_mode")];//pay_mode
					if($pay_mode!=3 && $pay_mode!=5)
					{
						echo $supplier_name_arr[$nameArray_per_job[0][csf("supplier_id")]];
					}
					else
					{
						echo $company_library[$nameArray_per_job[0][csf("supplier_id")]];
					}?></td>

					<td width="400" align="left"><b>Order Qnty :   </b> <? echo $po_qnty_all_style[0][csf("qnty")]; ?></td>


				</tr>
				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<tr>
					<td width="300" ><p><b>Address: </b><? echo $supplier_address_arr[$nameArray_per_job[0][csf("supplier_id")]]; ?> </p></td>

					<td width="400" align="left"><b>Dealing Merchandiser:   </b> <? echo $marchentrArr[$nameArray_per_job[0][csf("dealing_marchant")]]; ?></td>


				</tr>

				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<tr>
				   <td width="300"><b>Attention: </b>   <? echo $nameArray_per_job[0][csf("attention")];?></td>

				   <td width="400" align="left"><b>Currency:   </b> <? echo $currency[$nameArray_per_job[0][csf("currency_id")]]; ?></td>


				</tr>
				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<tr>
				   <td colspan="2" width="800"><b>Shipment Date: </b><? echo trim($shipment_dates);?></td>

				</tr>


				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<tr>
				   <td width="300"><b>WO Prepared After:   </b>    </td>

				   <td width="400" align="left"><b>Remarks:   </b> <? echo $nameArray_per_job[0][csf("remarks")]; ?></td>


				</tr>
			</thead>
		</table>


			<?php
$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and a.status_active =1 and a.is_deleted=0");
list($nameArray_approved_row) = $nameArray_approved;
$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
list($nameArray_approved_date_row) = $nameArray_approved_date;
$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
list($nameArray_approved_comments_row) = $nameArray_approved_comments;

$po_data = array();
if ($db_type == 0) {
	$nameArray_job = sql_select("select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,DATEDIFF(pub_shipment_date,po_received_date) date_diff,MIN(po_received_date) as po_received_date ,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status  from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id)  group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
}
if ($db_type == 2) {
	$nameArray_job = sql_select("select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,(pub_shipment_date-po_received_date) date_diff,MIN(po_received_date) as po_received_date,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status   from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id) group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
}
foreach ($nameArray_job as $result_job) {
	$po_data['po_id'][$result_job[csf('id')]] = $result_job[csf('id')];
	$po_data['po_number'][$result_job[csf('id')]] = $result_job[csf('po_number')];
	$po_data['leadtime'][$result_job[csf('id')]] = $result_job[csf('date_diff')];
	$po_data['po_quantity'][$result_job[csf('id')]] = $result_job[csf('po_quantity')];
	$po_data['po_received_date'][$result_job[csf('id')]] = change_date_format($result_job[csf('po_received_date')], 'dd-mm-yyyy', '-');
	$ddd = strtotime($result_job[csf('pub_shipment_date')]);
	$po_data['pub_shipment_date'][$ddd] = $ddd;

	$po_data['insert_date'][$result_job[csf('id')]] = $result_job[csf('insert_date')];

	if ($result_job[csf('shiping_status')] == 1) {
		$shiping_status = "FP";
	} else if ($result_job[csf('shiping_status')] == 2) {
		$shiping_status = "PS";
	} else if ($result_job[csf('shiping_status')] == 3) {
		$shiping_status = "FS";
	}
	$po_data['shiping_status'][$result_job[csf('id')]] = $shiping_status;
	$po_data['file_no'][$result_job[csf('id')]] = $result_job[csf('file_no')];
	$po_data['grouping'][$result_job[csf('id')]] = $result_job[csf('grouping')];
}
$txt_order_no_id = implode(",", array_unique($po_data['po_id']));
$leadtime = implode(",", array_unique($po_data['leadtime']));
$po_quantity = array_sum($po_data['po_quantity']);
$po_received_date = implode(",", array_unique($po_data['po_received_date']));
$po_number = implode(",", array_unique($po_data['po_number']));
$shipment_date = date('d-m-Y', min($po_data['pub_shipment_date']));
$maxshipment_date = date('d-m-Y', max($po_data['pub_shipment_date']));
//$shipment_date=implode(",",array_unique($po_data['pub_shipment_date']));
$shiping_status = implode(",", array_unique($po_data['shiping_status']));
$file_no = implode(",", array_unique($po_data['file_no']));
$grouping = implode(",", array_unique($po_data['grouping']));

$colar_excess_percent = 0;
$cuff_excess_percent = 0;
$rmg_process_breakdown = 0;
$nameArray = sql_select("select a.buyer_id,a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.update_date,a.uom,a.remarks,a.pay_mode,a.fabric_composition from wo_booking_mst a  where   a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0");
foreach ($nameArray as $result) {
	$total_set_qnty = $result[csf('total_set_qnty')];
	$colar_excess_percent = $result[csf('colar_excess_percent')];
	$cuff_excess_percent = $result[csf('cuff_excess_percent')];
	$rmg_process_breakdown = $result[csf('rmg_process_breakdown')];
	foreach ($po_data['po_id'] as $po_id => $po_val) {
		$daysInHand .= (datediff('d', date('d-m-Y', time()), $po_data['pub_shipment_date'][$po_id]) - 1) . ",";
		$booking_date = $result[csf('update_date')];
		if ($booking_date == "" || $booking_date == "0000-00-00 00:00:00") {
			$booking_date = $result[csf('insert_date')];
		}
		$WOPreparedAfter .= (datediff('d', $po_data['insert_date'][$po_id], $booking_date) - 1) . ",";
	}

}

?>
			<br/>
			<!--  Here will be the main portion  -->
			<?
			$costing_per="";
			$costing_per_qnty=0;
			$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no in($job_no_in)");
			if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;

			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";
				$costing_per_qnty=1;

			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;

			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;

			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;
			}
			$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no in($job_no_in)");
			$uom_arr=array(1=>"Pcs",12=>"Kg",23=>"Mtr",27=>"Yds");
			$p=1;
		/*foreach($uom_arr as $uom_id=>$uom_val)
		{ */
		if($cbo_fabric_source==1 or $cbo_fabric_source==2 or $cbo_fabric_source==3)
		{
			$nameArray_fabric_description= sql_select("SELECT a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , b.dia_width,d.pre_cost_remarks,a.uom,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,avg(d.rate) as rates,sum(d.amount) as amounts ,d.fabric_color_id,a.color_size_sensitive,a.color_break_down,c.job_no_mst  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_number_id=d.gmts_color_id and
				b.dia_width=d.dia_width and
				b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id
				and
				d.booking_no =$txt_booking_no and
				d.job_no in ($all_jobs_id) and

				d.status_active=1 and
				d.is_deleted=0 and
				b.cons>0
				group by a.id,a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,b.dia_width,d.pre_cost_remarks,a.uom ,d.fabric_color_id,a.color_size_sensitive,a.color_break_down,c.job_no_mst  order by c.job_no_mst   ");


			$uom_data_arr=array();
			foreach($nameArray_fabric_description as $row)
			{
				$uom_data_arr[$row[csf('uom')]]=$row[csf('uom')];
			}

			foreach($uom_data_arr as $uom_id=>$uom_val)
			{
				if(count($nameArray_fabric_description)>0)
				{

					?>

						<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
									<caption> <strong>Fabric Booking Details </strong> </caption>
									<tr>
										<th  width="30" align="center">SL</th>
										<th  width="150" align="center">Style/Season</th>
										<th  width="140" align="center">Gmts Item/Dept</th>
										<th  width="390" align="left">Item Description</th>
										<th  width="40" align="center">GSM</th>
										<th  width="90" align="center">Fabric Dia</th>
										<th  width="100" align="center">Color Type</th>
										<th  width="100" align="center">Gmts Color</th>
										<th  width="110" align="center">Fabric Color</th>
										<th  width="60" align="center">UOM</th>
										<th width='120' align="center">Finish Fab. Qty</th>
										<th width='120' align="center">Grey Fab. Qty</th>
										<th width='100' align="center">Avg Rate</th>
										<th width='60' align="center">Amount</th>

									</tr>
									<?
									$color_wise_process_loss=sql_select("SELECT  a.body_part_id,b.color_number_id,avg(b.process_loss_percent) as loss FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls  b 	WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and  a.job_no in ($all_jobs_id)   group by a.body_part_id,b.color_number_id
									");
									foreach($color_wise_process_loss as $val)
									{
										$loss_arr[$val[csf("body_part_id")]][$val[csf("color_number_id")]]=$val[csf("loss")];
									}

									$total_fin_fab_qnty=0;  $total_amount=0;  $total_grey_fab_qnty=0 ;$tot_avg=0;
									foreach($nameArray_fabric_description as $val)
									{
										if($val[csf('pre_cost_remarks')]!='') $remark_cond=" and d.pre_cost_remarks='".$val[csf('pre_cost_remarks')]."' "; else $remark_cond=" and d.pre_cost_remarks is null";
										$color_wise_wo_sql_qnty=sql_select("SELECT  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
											WHERE
											a.job_no=d.job_no and
											a.id=d.pre_cost_fabric_cost_dtls_id and
											d.booking_no =$txt_booking_no and
											d.job_no = '".$val[csf('job_no_mst')]."' and
											a.item_number_id='".$val[csf('item_number_id')]."' and
											a.body_part_id='".$val[csf('body_part_id')]."' and
											a.color_type_id='".$val[csf('color_type_id')]."' and
											a.construction='".$val[csf('construction')]."' and
											a.composition='".$val[csf('composition')]."' and
											a.gsm_weight='".$val[csf('gsm_weight')]."' and
											d.dia_width='".$val[csf('dia_width')]."' and

											d.fabric_color_id='".$val[csf('fabric_color_id')]."' and
											d.status_active=1 and
											d.is_deleted=0 $remark_cond
											");
										if($uom_id==$val[csf('uom')])
										{
											if($val[csf('pre_cost_remarks')]=='no remarks')  $pre_cost_remarks="";else  $pre_cost_remarks=$val[csf('pre_cost_remarks')];
											?>
											<tr>
												<td align="center"> <? echo $p; $p++;?></td>


												<td align="center"> <? echo $all_job_arr[$val[csf("job_no_mst")]]["style"];if($all_job_arr[$val[csf("job_no_mst")]]["season"]){echo ','.$season_arr[$all_job_arr[$val[csf("job_no_mst")]]["season"]];}?></td>
												<td align="center"> <? echo $garments_item[$all_job_arr[$val[csf("job_no_mst")]]["item"]].','.$product_dept[$all_job_arr[$val[csf("job_no_mst")]]["dept"]];?></td>
												<td align="left"> <? echo $body_part[$val[csf('body_part_id')]].','. $val[csf('construction')].','.$val[csf('composition')].', '.$pre_cost_remarks; ?> </td>

												<td  align="center">
													<?
													echo $val[csf('gsm_weight')];
													?>
												</td>

												<td  align="center">
													<?
													echo $val[csf('dia_width')];
													?>
												</td>

												<td  align="center">
													<?
													echo $color_type[$val[csf('color_type_id')]];
													?>
												</td>
												<td  align="center">
													<?
													if($val[csf('color_size_sensitive')]==1 or $val[csf('color_size_sensitive')]==2 or $val[csf('color_size_sensitive')]==4)
													{
														echo $color_library[$val[csf('fabric_color_id')]];
													}

													else
													{
														$color_break_down=$val[csf('color_break_down')];
														if($color_break_down)
														{
															$gmts_color="";
															if (strpos($color_break_down, '__') !== false)
															{
																$color_break_down=explode('__', $color_break_down);
																foreach ($color_break_down as $key => $value)
																{
																	$cols=explode('_', $value);
																	if(trim(strtolower($color_library[$val[csf('fabric_color_id')]]))==trim(strtolower($cols[2])))
																	{
																		if($gmts_color=="")
																		{
																			$gmts_color=$cols[1];
																		}
																		else
																		{
																			$gmts_color .=','.$cols[1];
																		}

																	}
																}
															}
															else
															{
																$cols=explode('_', $color_break_down);
																if(trim(strtolower($color_library[$val[csf('fabric_color_id')]]))==trim(strtolower($cols[2])))
																{
																	if($gmts_color=="")
																	{
																		$gmts_color=$cols[1];
																	}
																	else
																	{
																		$gmts_color .=','.$cols[1];
																	}

																}
															}

															echo $gmts_color;
														}

													}
													?>
												</td>


												<td  align="center">
													<?
													echo $color_library[$val[csf('fabric_color_id')]];
													?>
												</td>


												<td align="center"> <? echo $unit_of_measurement[$val[csf('uom')]]; ?></td>

												<td align="center"> <?   $greys= $color_wise_wo_sql_qnty[0][csf("grey_fab_qnty")] /(1+($loss_arr[$val[csf("body_part_id")]][$val[csf("fabric_color_id")]]/100)) ;
													echo def_number_format($greys,2);

													?> </td>



													<td align="center"> <? echo def_number_format($color_wise_wo_sql_qnty[0][csf("grey_fab_qnty")],2); ?> </td>
													<td align="center"> <? echo def_number_format($color_wise_wo_sql_qnty[0][csf("rate")],2); ?> </td>
													<td align="center"> <? echo def_number_format($color_wise_wo_sql_qnty[0][csf("amount")],2); ?> </td>


													<?

													$total_fin_fab_qnty +=str_replace(",", "", def_number_format($greys,2));
													$total_amount +=str_replace(",", "",def_number_format($color_wise_wo_sql_qnty[0][csf("amount")],2));
													$total_grey_fab_qnty +=str_replace(",", "",def_number_format($color_wise_wo_sql_qnty[0][csf("grey_fab_qnty")],2));
													$total_rate +=str_replace(",", "",def_number_format($color_wise_wo_sql_qnty[0][csf("rate")],2));
													$tot_avg=$total_amount/$total_grey_fab_qnty;


													?>



												</tr>
												<?
										}

									}
										?>
									<tr style=" font-weight:bold">


									<td  align="right" colspan="10"><strong>Total</strong></td>
									<td align="center"><? echo def_number_format($total_fin_fab_qnty,2);?></td>
									<td align="center"><? echo def_number_format($total_grey_fab_qnty,2);?></td>
									<td align="center"><? echo def_number_format($tot_avg,2);?></td>
									<td align="center"><? echo def_number_format($total_amount,2);?></td>

									</tr>

						</table>

					<?
				}
			}
		}


		$sql_data=sql_select("SELECT a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,a.uom,b.dia_width,b.pre_cost_remarks,b.fabric_color_id,b.remark, sum(b.grey_fab_qnty) as grey_fab_qnty,sum(b.adjust_qty)as adjust_qty FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in($all_jobs_id) and b.adjust_qty>0 and b.status_active=1 and b.is_deleted=0 group by a.id,a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,a.uom,b.dia_width,b.pre_cost_remarks,b.fabric_color_id,b.remark order by a.id,a.body_part_id");
		if(count($sql_data)>0)
		{

					?>
					<br/>
			<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

					<tr>
						<td colspan="7" align="center">
							<strong>Fabric Stock Adjustment Details</strong>
						</td>

					</tr>

					<tr>
						<td align="center"> SL </td>
						<td align="center"> Item Description </td>
						<td align="center"> Fabric Color </td>
						<td align="center">UOM</td>
						<td align="center">Adjusted Qty </td>


					</tr>
					<?
					$p=1;
					foreach($sql_data as $row)
					{
						?>
						<tr>
							<td align="center"><? echo $p;?></td>
							<td align="center">
								<? echo $body_part[$row[csf('body_part_id')]].",".$row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$row[csf('dia_width')].','.$fabric_typee[$row[csf('width_dia_type')]].",".$color_type[$row[csf('color_type_id')]] ?>
							</td>

							<td align="center">
								<? echo $color_library[$row[csf('fabric_color_id')]];  ?>
							</td>
							<td align="center">
								<? echo $unit_of_measurement[$row[csf('uom')]];  ?>
							</td>


							<td align="center">
								<? echo number_format($row[csf('adjust_qty')],4) ; ?>
							</td>

						</tr>
						<?
						$p++;
					}
		}
					?>
			</table>



	        <?
	       $sql_collar_cuff= "SELECT a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,b.gmts_color_id,b.size_number_id,b.item_size,b.gmts_qty,b.excess_per,b.qty,b.po_break_down_id as po_id,b.id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id)  and b.status_active=1 and b.is_deleted=0  order by a.body_part_id,b.gmts_color_id,b.id " ;
	         $sql_data_collar_cuff=sql_select($sql_collar_cuff);
	          if(count($sql_data_collar_cuff)>0)
	          {

					?>
			  		<br>
			  		<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

			  			<tr>
			  				<td colspan="9" align="center">
			  					<strong>Collar and  Cuff Breakdown</strong>
			  				</td>

			  			</tr>

			  			<tr>
			  				<td align="center"> SL </td>
			  				<td align="left">   &nbsp;&nbsp;Item Description </td>
			  				<td align="center"> PO Number   </td>
			  				<td align="center"> Gmts Color  </td>
			  				<td align="center"> Gmts Size</td>
			  				<td align="center"> Item Size  </td>
			  				<td align="center"> Gmts Qty (Pcs)  </td>
			  				<td align="center"> Excess %   </td>
			  				<td align="center"> Collar & Cuff Qty (Pcs) </td>


			  			</tr>
			  			<?
			  			$p=1;
			  			foreach($sql_data_collar_cuff as $row)
			  			{
			  				?>
			  				<tr>
			  					<td align="center"><? echo $p;?></td>
			  					<td align="left"> &nbsp;
			  						<? echo $body_part[$row[csf('body_part_id')]].",".$row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$fabric_typee[$row[csf('width_dia_type')]].",".$color_type[$row[csf('color_type_id')]] ?>
			  					</td>


			  					<td align="center">
			  						<? echo $po_num_arr[$row[csf("po_id")]] ;?>
			  					</td>


			  					<td align="center">
			  						<? echo $color_library[$row[csf('gmts_color_id')]];  ?>
			  					</td>
			  					<td align="center">
			  						<? echo $size_library[$row[csf('size_number_id')]];  ?>
			  					</td>


			  					<td align="center">
			  						<? echo $row[csf('item_size')];  ?>
			  					</td>

			  					<td align="right">
			  						<? echo $row[csf('gmts_qty')];
									  
									  $total_gmts_qty+=$row[csf('gmts_qty')];
									  ?>
			  					</td>

			  					<td align="right">
			  						<? echo $row[csf('excess_per')];  
									    $total_excess_per+=$row[csf('excess_per')];
									  ?>
			  					</td>

			  					<td align="right">
			  						<? echo $row[csf('qty')]; 
									  $total_qty+=$row[csf('qty')];
									  ?>
			  					</td>

			  				</tr>
			  				<?
			  				$p++;
			  			}
			  	}
			  		?>
					  <tr>
			  					
			  					<td align="right" colspan="6">	Total</td>
			  					<td align="right"><b><?=$total_gmts_qty; ?></b></td>
			  					<td align="right"><b><?=$total_excess_per; ?></b></td>
			  					<td align="right"><b><?=$total_qty;?></b></td>

			  				</tr>
			  	</table>
			<br>


			<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

				<tr>
					<td colspan="10" align="center">
						<strong>Comments</strong>
					</td>

				</tr>

				<tr>
					<td align="center"> SL </td>
					<td align="center" width="200"  style="word-wrap: break-word;word-break: break-all;"> PO NO </td>
					<td align="center"> Ship Date </td>
					<td align="center">BOM Qty</td>
					<td align="center"> Booking Qty </td>
					<td align="center"> Short Booking Qty </td>
					<td align="center"> Total Booking Qty </td>
					<td align="center"> Balance </td>
					<td align="center"> Comments </td>


				</tr>
				<?
				$is_short_data=sql_select("SELECT a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0   and b.is_short =1 group by  a.id ");
				foreach($is_short_data as $vals)
				{
					$short_qty_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
				}

				$booking_data=sql_select("SELECT a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and  b.status_active=1 and b.is_deleted=0 and b.is_short !=1 group by  a.id  order by a.id");
				foreach($booking_data as $vals)
				{
					$booking_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
				}

				$po_date=return_library_array("select id,shipment_date from wo_po_break_down where status_active=1 and is_deleted=0",'id','shipment_date');

				$comments_data=sql_select("SELECT min(a.id) as ids,b.po_break_down_id as po_number,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,SUM(b.requirment) as precost_grey_qty FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id
					and
					b.po_break_down_id=d.po_break_down_id and
					b.color_number_id=d.gmts_color_id and
					b.dia_width=d.dia_width and
					b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					a.job_no=d.job_no and
					a.id=d.pre_cost_fabric_cost_dtls_id
					and
					d.booking_no =$txt_booking_no and
					d.job_no in($all_jobs_id) and

					d.status_active=1 and
					d.is_deleted=0 and
					b.cons>0
					group by b.po_break_down_id order by b.po_break_down_id");



				$job_no=$all_jobs_id;
				$condition= new condition();
				if(str_replace("'","",$job_no) !='')
				{
					$condition->job_no("in ($job_no)");
				}
				$condition->init();
				$fabric= new fabric($condition);
				$fabric_costing_qty_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish();

				$j=1;
				$total_bom=0;
				$total_book=0;
				$total_short=0;
				$total_short_full=0;
				$total_balance=0;
				foreach($comments_data as $val)
				{
					$po_id=$val[csf('po_number')];
					$woven_qty=array_sum($fabric_costing_qty_arr['woven']['grey'][$po_id]);
					$knit_qty=array_sum($fabric_costing_qty_arr['knit']['grey'][$po_id]);
					$sum_woven_knit=$woven_qty + $knit_qty;


					?>
					<tr>
						<td align="center"><? echo $j;?></td>

						<td align="center"  style="word-wrap: break-word;word-break: break-all;"> <? echo $po_num_arr[$val[csf("po_number")]] ;?> </td>
						<td align="center"> <? echo change_date_format($po_date[$val[csf("po_number")]], "yyyy-mm-dd", "-");?> </td>
						<td align="center"><?  echo $pre= def_number_format($sum_woven_knit,2);  ?> </td>
						<td align="center"><?  echo $bookings= def_number_format($booking_arr[$val[csf("po_number")]],2);  ?> </td>
						<td align="center"> <?echo $short=def_number_format($short_qty_arr[$val[csf("po_number")]],2); ?> </td>
						<td align="center"> <?   $tot_short_book= str_replace(',','',$bookings) +  str_replace(',','',$short) ; echo def_number_format($tot_short_book,2); ?>  </td>
						<td align="center"> <?  $bal =str_replace(',','',$pre)-str_replace(',','',$tot_short_book) ; echo def_number_format($bal,2);  ?> </td>
						<td align="center"> <? if($bal!=0){ if($pre>$tot_short_book){echo "Less ";} else{ echo "Over";} }?> </td>


					</tr>
					<?
					$total_bom +=str_replace(',','',$pre);
					$total_book +=str_replace(',','',$bookings);
					$total_short +=str_replace(',','',$short);
					$total_short_full += str_replace(',','',$tot_short_book);
					$total_balance += str_replace(',','',$bal);

					$j++;
				}
				?>
				<tr>
					<td colspan="3" align="right"> <b> Total </b></td>
					<td align="center"><strong><? echo def_number_format($total_bom,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_book,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_short,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_short_full,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_balance,2);?> </strong> </td>
					<td>&nbsp;</td>
				</tr>
			</table>



			<?
			if($cbo_fabric_source==1 || $cbo_fabric_source==2 || $cbo_fabric_source==3){
			?>
			<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
				<tr>
					<?
					$nameArray_item_size=sql_select( "SELECT min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active =1 and d.is_deleted=0 and d.job_no in($all_jobs_id)  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
					if(count($nameArray_item_size)>0)
					{
						?>
						<td width="49%">

						</td>
						<td width="2%">
						</td>
						<?
					}
					?>
					<?
					$nameArray_item_size=sql_select( "SELECT min(c.id) as id, b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.job_no in ($all_jobs_id)  and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");

					if(count($nameArray_item_size)>0)
					{
						?>
						<td width="49%">

						</td>
						<?
					}
					?>
				</tr>
			</table>
			<br/>

			<br/>



	<?
	//------------------------------ Query for TNA start-----------------------------------
	$po_id_all=str_replace("'","",$txt_order_no_id);
	$po_num_arr=return_library_array("SELECT id,po_number from wo_po_break_down where job_no_mst in($all_jobs_id)",'id','po_number');
	$tna_start_sql=sql_select( "SELECT id,po_number_id,
	(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
	(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
	(case when task_number=60 then task_start_date else null end) as knitting_start_date,
	(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
	(case when task_number=61 then task_start_date else null end) as dying_start_date,
	(case when task_number=61 then task_finish_date else null end) as dying_end_date,
	(case when task_number=64 then task_start_date else null end) as finishing_start_date,
	(case when task_number=64 then task_finish_date else null end) as finishing_end_date,
	(case when task_number=84 then task_start_date else null end) as cutting_start_date,
	(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
	(case when task_number=86 then task_start_date else null end) as sewing_start_date,
	(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
	(case when task_number=110 then task_start_date else null end) as exfact_start_date,
	(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
	(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
	(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
	from tna_process_mst
	where status_active=1 and po_number_id in($po_id_all) and job_no in ($all_jobs_id) order by po_number_id");
 	$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
	$tna_date_task_arr=array();
	foreach($tna_start_sql as $row)
	{
		if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
		{
			if($tna_fab_start=="")
			{
				$tna_fab_start=$row[csf("fab_booking_start_date")];
			}
		}
		if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
		}
		if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
		}
		if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
		}
		if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
		}
		if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
		}
		if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
		}
		if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
		}
	}
	//------------------------------ Query for TNA end-----------------------------------
	if(count($tna_start_sql)>0 )
	{
		?>
		<br>
		<fieldset id="div_size_color_matrix" style="max-width:1000;">
			<legend>TNA Information</legend>
			<table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
				<tr>
					<td rowspan="2" align="center" valign="top">SL</td>
					<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
					<td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
					<td colspan="2" align="center" valign="top"><b>Knitting</b></td>
					<td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
					<td colspan="2" align="center" valign="top"><b>Finishing Fabric</b></td>
					<td colspan="2" align="center" valign="top"><b>Cutting </b></td>
					<td colspan="2" align="center" valign="top"><b>Sewing </b></td>
					<td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
				</tr>
				<tr>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
				</tr>
				<?
				$i=1;
				foreach($tna_date_task_arr as $order_id=>$row)
				{
					?>
					<tr>
						<td><? echo $i; ?></td>
						<td><? echo $po_num_arr[$order_id]; ?></td>
						<td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
						<td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
						<td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
					</tr>
					<?
					$i++;
				}
				?>
			</table>
		</fieldset>
		<?
	}
	}// fabric Source End
	?>
	<br>

	<table width="220"  border="0" cellpadding="2" cellspacing="0" rules="all" style="float:left">
		<tr>
			<td width="200" valign="top" align="left">

				<div id="div_size_color_matrix" style="float:left;">
					<?
					$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
					?>
					<fieldset>
						<legend>RMG Process Loss % </legend>
						<table width="180" class="rpt_table" border="1" rules="all">
							<?
							if(number_format($rmg_process_breakdown_arr[8],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Cut Panel rejection <!-- Extra Cutting % breack Down 8-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[8],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[2],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Chest Printing <!-- Printing % breack Down 2-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[2],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[10],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Neck/Sleeve Printing <!-- New breack Down 10-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[10],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[1],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Embroidery   <!-- Embroidery  % breack Down 1-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[1],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[4],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Sewing /Input<!-- Sewing % breack Down 4-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[4],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[3],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Garments Wash <!-- Washing %breack Down 3-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[3],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[15],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Gmts Finishing <!-- Washing %breack Down 3-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[15],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[11],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Others <!-- New breack Down 11-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[11],2);
										?>
									</td>
								</tr>
								<?
							}
							$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
							if($gmts_pro_sub_tot>0)
							{
								?>
								<tr>
									<td width="130">
										Sub Total <!-- New breack Down 11-->
									</td>
									<td align="right">
										<?

										echo number_format($gmts_pro_sub_tot,2);
										?>
									</td>
								</tr>
								<?
							}
							?>
						</table>
					</fieldset>


					<fieldset>
						<legend>Fabric Process Loss % </legend>
						<table width="180" class="rpt_table" border="1" rules="all">
							<?
							if(number_format($rmg_process_breakdown_arr[6],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Knitting  <!--  Knitting % breack Down 6-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[6],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[12],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Yarn Dyeing  <!--  New breack Down 12-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[12],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[5],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Dyeing & Finishing  <!-- Finishing % breack Down 5-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[5],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[13],2)>0)
							{
								?>
								<tr>
									<td width="130">
										All Over Print <!-- new  breack Down 13-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[13],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[14],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Lay Wash (Fabric) <!-- new  breack Down 14-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[14],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[7],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Dying   <!-- breack Down 7-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[7],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[0],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Cutting (Fabric) <!-- Cutting % breack Down 0-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[0],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[9],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Others  <!-- Others% breack Down 9-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[9],2);
										?>
									</td>
								</tr>
								<?
							}
							$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
							if($fab_proce_sub_tot>0)
							{
								?>
								<tr>
									<td width="130">
										Sub Total  <!-- Others% breack Down 9-->
									</td>
									<td align="right">
										<?

										echo number_format($fab_proce_sub_tot,2);
										?>
									</td>
								</tr>
								<?
							}
							if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
							{
								?>
								<tr>
									<td width="130">
										Grand Total  <!-- Others% breack Down 9-->
									</td>
									<td align="right">
										<?
										echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2);
										?>
									</td>
								</tr>
								<?
							}
							?>
						</table>
					</fieldset>
				</div>
			</td>
		</tr>
	</table>

	<table width="400"  border="0" cellpadding="2" cellspacing="0" rules="all" style="float:left">
		<tr>
			<td colspan="6" align="left"><img  src='<? echo $path.$imge_arr[$po_job_no]; ?>' height='155' width='200' /></td>
		</tr>
	</table>
	<br>
	<br>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
				<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
					<thead>
						<tr>
							<th width="3%"></th><th width="97%" align="left"><u>Special Instruction</u></th>
						</tr>
					</thead>
					<tbody>
						<?
						$data_array=sql_select("select id, terms from  wo_booking_terms_condition where booking_no=$txt_booking_no");
						if ( count($data_array)>0)
						{
							$i=0;
							foreach( $data_array as $row )
							{
								$i++;
								?>
								<tr id="settr_1" valign="top">
									<td style="vertical-align:top">
										<? echo $i;?>
									</td>

									<td>
										<strong style="font-size:16px"> <? echo $row[csf('terms')]; ?></strong>
									</td>
								</tr>
								<?
							}
						}
						?>
					</tbody>
				</table>
			</td>

		</tr>
	</table>

	<br/><br/><br/><br/><br/><br/><br/><br/>

		    <table  width="100%"  border="0" cellpadding="0" cellspacing="0">
		    	<tr>
		            <td>  <?
		                    echo signature_table(121, $cbo_company_name, "1330px",1,'');
							$job_no_all= implode(",",array_unique($joball['job_no']));
							$style_sting_all=implode(",",array_unique($joball['style_ref_no']));
							echo "****".custom_file_name($txt_booking_no,$style_sting_all,$job_no_all);
		                ?>
		            </td>
		        </tr>
		    </table>
	</div>

	<?
	
	$html = ob_get_contents();
	ob_clean();
	list($is_mail_send,$mail)=explode('___',$mail_send_data);

	if($is_mail_send==1){
		require_once('../../../mailer/class.phpmailer.php');
		require_once('../../../auto_mail/setting/mail_setting.php');
		$mailBody = preg_replace("/<img[^>]+\>/i", " ", $html); 
		$mailBody="<br>".$mail_body	;	
		$mailToArr=array();
		$mailSql = "select b.EMAIL  from wo_booking_mst a,LIB_SUPPLIER b where b.id=a.supplier_id and a.booking_no=$txt_booking_no";
	//echo $mailSql;die;
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
		}
		
		
		$mailSql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=99 and b.mail_user_setup_id=c.id  and c.IS_DELETED=0 and c.STATUS_ACTIVE=1";
		//echo $mailSql;die;
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
		}
		if($mail!=''){$mailToArr[]=$mail;}

		$to=implode(',',$mailToArr);
		$subject="Partial fabric booking";
		$header=mailHeader();
		echo $to;
		echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
		
	}
	else{
		echo $html;
	}
			
	$html = ob_get_contents();
	ob_clean();
	list($is_mail_send,$mail)=explode('___',$mail_send_data);

	if($is_mail_send==1){
		require_once('../../../mailer/class.phpmailer.php');
		require_once('../../../auto_mail/setting/mail_setting.php');
		$mailBody = preg_replace("/<img[^>]+\>/i", " ", $html); 
		$mailBody="<br>".$mail_body	;	
		$mailToArr=array();
		$mailSql = "select b.EMAIL  from wo_booking_mst a,LIB_SUPPLIER b where b.id=a.supplier_id and a.booking_no=$txt_booking_no";
	//echo $mailSql;die;
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
		}
		
		
		$mailSql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=99 and b.mail_user_setup_id=c.id  and c.IS_DELETED=0 and c.STATUS_ACTIVE=1";
		//echo $mailSql;die;
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
		}
		if($mail!=''){$mailToArr[]=$mail;}

		$to=implode(',',$mailToArr);
		$subject="Partial fabric booking";
		$header=mailHeader();
		echo $to;
		echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
		
	}
	else{
		echo $html;
	}
	exit();

}

if($action=="print_booking_7") // Aziz for northern
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' or form_name='knit_order_entry' and file_type=1",'master_tble_id','image_location');
	$company_library=return_library_array( "select id,company_name from lib_company where status_active=1 and is_deleted=0", "id", "company_name");
	$color_library=return_library_array( "select id,color_name from lib_color  where status_active=1 and is_deleted=0", "id", "color_name");
	$size_library=return_library_array( "select id,size_name from lib_size  where status_active=1 and is_deleted=0", "id", "size_name");
	$country_arr=return_library_array( "select id,country_name from   lib_country  where status_active=1 and is_deleted=0",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier  where status_active=1 and is_deleted=0",'id','supplier_name');
	$supplier_address_arr=return_library_array( "select id,address_1 from   lib_supplier  where status_active=1 and is_deleted=0",'id','address_1');


	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info  where status_active=1 and is_deleted=0","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer  where status_active=1 and is_deleted=0",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location  where status_active=1 and is_deleted=0",'id','location_name');

	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	$season_arr=return_library_array("select id,season_name from lib_buyer_season  where status_active=1 and is_deleted=0","id","season_name");
	$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where status_active=1 and is_deleted=0 and id in(select po_break_down_id from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no=$txt_booking_no)",'id','po_number');

	$uom=0;
	$joball=array();
	$nameArray_per_job=sql_select( "SELECT  a.job_no,a.style_ref_no ,a.season_matrix,a.gmts_item_id,a.product_dept,max(c.booking_date) as booking_date ,max(c.delivery_date) as delivery_date,max(c.is_approved) as is_approved,max(c.buyer_id) as buyer_id,max(c.pay_mode) as pay_mode,max(supplier_id) as supplier_id,max(a.dealing_marchant) as dealing_marchant,max(c.attention) as attention,max(c.currency_id) as currency_id ,max(c.remarks)  as remarks from wo_po_details_master a , wo_booking_dtls b,wo_booking_mst c  where c.booking_no=b.booking_no and c.status_active=1 and c.is_deleted=0 and  a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by  a.job_no,a.style_ref_no ,a.season_matrix,a.gmts_item_id,a.product_dept ");
	foreach ($nameArray_per_job as $vals)
	{
		$joball['job_no'][$row_per_job[csf('job_no')]]=$row_per_job[csf('job_no')];
		$joball['style_ref_no'][$row_per_job[csf('job_no')]]=$row_per_job[csf('style_ref_no')];
		$all_job_arr[$vals[csf("job_no")]]["job"]="'".$vals[csf("job_no")]."'";
		$all_job_arr[$vals[csf("job_no")]]["style"]=$vals[csf("style_ref_no")];
		$all_job_arr[$vals[csf("job_no")]]["item"]=$vals[csf("gmts_item_id")];
		$all_job_arr[$vals[csf("job_no")]]["season"]=$vals[csf("season_matrix")];
		$all_job_arr[$vals[csf("job_no")]]["dept"]=$vals[csf("product_dept")];
		$all_jobs[$vals[csf("job_no")]]="'".$vals[csf("job_no")]."'";
	}
	$all_jobs_id=implode(",",$all_jobs );
 	$po_qnty_all_style=sql_select("SELECT sum(po_quantity) as qnty from wo_po_break_down where status_active=1 and is_deleted=0 and job_no_mst in ($all_jobs_id)");

 	$all_shipdates_arr=sql_select("SELECT min(b.pub_shipment_date)  as shipdate,job_no from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.status_active=1 and b.is_deleted=0 and  a.status_active=1 and a.is_deleted=0 and b.job_no_mst in ($all_jobs_id) group by job_no");
 	$shipment_dates="";
 	foreach($all_shipdates_arr as $key=>$data)
 	{
 		if($shipment_dates=="")
 		{
 			$shipment_dates=change_date_format($data[csf("shipdate")]);
 		}
 		else
 		{
 			$shipment_dates .=','.change_date_format($data[csf("shipdate")]);
 		}
 	}


	$uom=0;
	$job_data_arr=array();
	$nameArray_buyer=sql_select( "SELECT  a.style_ref_no,a.style_description, a.job_no, a.style_owner, a.buyer_name, a.dealing_marchant,a.season,a.season_matrix,a.total_set_qnty,a.product_dept,a.product_code,a.pro_sub_dep,a.gmts_item_id ,a.order_repeat_no,a.qlty_label  from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0 and a.job_no='".$row_per_job[csf('job_no')]."'");
	foreach ($nameArray_buyer as $result_buy)
	{
		$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
		$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
		$job_data_arr['total_set_qnty'][$result_buy[csf('job_no')]]=$result_buy[csf('total_set_qnty')];
		$job_data_arr['product_dept'][$result_buy[csf('job_no')]]=$product_dept[$result_buy[csf('product_dept')]];
		$job_data_arr['product_code'][$result_buy[csf('job_no')]]=$result_buy[csf('product_code')];
		$job_data_arr['pro_sub_dep'][$result_buy[csf('job_no')]]=$pro_sub_dept_array[$result_buy[csf('pro_sub_dep')]];
		$job_data_arr['gmts_item_id'][$result_buy[csf('job_no')]]=$result_buy[csf('gmts_item_id')];
		$job_data_arr['style_ref_no'][$result_buy[csf('job_no')]]=$result_buy[csf('style_ref_no')];
		$job_data_arr['style_description'][$result_buy[csf('job_no')]]=$result_buy[csf('style_description')];
		$job_data_arr['dealing_marchant'][$result_buy[csf('job_no')]]=$marchentrArr[$result_buy[csf('dealing_marchant')]];
		$job_data_arr['season_matrix'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_matrix')]];
		$job_data_arr['order_repeat_no'][$result_buy[csf('job_no')]]=$result_buy[csf('order_repeat_no')];
		$job_data_arr['qlty_label'][$result_buy[csf('job_no')]]=$quality_label[$result_buy[csf('qlty_label')]];
	}
	$job_no= implode(",",array_unique($job_data_arr['job_no']));
	$job_no_in= implode(",",array_unique($job_data_arr['job_no_in']));
	$product_depertment=implode(",",array_unique($job_data_arr['product_dept']));
	$product_code=implode(",",array_unique($job_data_arr['product_code']));
	$pro_sub_dep=implode(",",array_unique($job_data_arr['pro_sub_dep']));
	$gmts_item_id=implode(",",array_unique($job_data_arr['gmts_item_id']));
	$style_sting=implode(",",array_unique($job_data_arr['style_ref_no']));
	$style_description=implode(",",array_unique($job_data_arr['style_description']));
	$dealing_marchant=implode(",",array_unique($job_data_arr['dealing_marchant']));
	$season_matrix=implode(",",array_unique($job_data_arr['season_matrix']));
	$order_repeat_no= implode(",",array_unique($job_data_arr['order_repeat_no']));
	$qlty_label= implode(",",array_unique($job_data_arr['qlty_label']));
	$path=str_replace("'","",$path);
	if($path=="")
	{
	$path='../../';
	}
	ob_start();
	?>
	<style type="text/css">

		body, p, span, td, a {font-size:10pt;font-family: Arial;}
		body{margin-left:2em; margin-right:2em; font-family: "Arial Narrow", Arial, sans-serif;}

	</style>

	<div style="width:1330px" align="center" >

		<table id="tb_header" width="100%" cellpadding="0" cellspacing="0" style="border:0px solid black" >
			<thead>
				<tr>
					<td width="150" rowspan="4">
						<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100' width='100' />
					</td>
					<td width="200">&nbsp;</td>
					<td width="400" align="left"><strong><?php echo $company_library[$cbo_company_name]; ?></strong></td>
					<td width="100">&nbsp;</td>
					<td width="300" align="left"><b>Booking No: </b><?php echo str_replace("'", "", $txt_booking_no); ?></td>
				</tr>

				<tr>
					<td width="200">&nbsp;</td>
					<td width="400" align="left">
						<?
						$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
						foreach ($nameArray as $result)
						{
							?>
							Plot No: <? echo $result[csf('plot_no')]; ?>
							Level No: <? echo $result[csf('level_no')]?>
							Road No: <? echo $result[csf('road_no')]; ?>
							Block No: <? echo $result[csf('block_no')];?>
							City No: <? echo $result[csf('city')];?>
							Zip Code: <? echo $result[csf('zip_code')]; ?>
							Province No: <?php echo $result[csf('province')]; ?>
							Country: <? echo $country_arr[$result[csf('country_id')]]; ?><br>
							Email Address: <? echo $result[csf('email')];?>
							Website No: <? echo $result[csf('website')];
						}
							?>

					</td>
					<td width="100">&nbsp;</td>
					<td width="300" align="left"><b>Booking Date: </b><?php echo change_date_format($nameArray_per_job[0][csf("booking_date")]); ?></td>
				</tr>

				<tr>
					<td width="200">&nbsp;</td>
					<td width="400" align="left"><strong> Main Fabric Booking  </strong></td>
					<td width="100">&nbsp;</td>
					<td width="300" align="left"><b>Delivery Date: </b><?php echo change_date_format($nameArray_per_job[0][csf("delivery_date")]); ?></td>
				</tr>

				<tr>
					<td colspan="3" width="700">&nbsp;</td>
					<td width="300" align="left"><b>Approval Status: </b><?php if ($nameArray_per_job[0][csf("is_approved")] == 1 || $nameArray_per_job[0][csf("is_approved")] == 3) {echo "Approved";}?></td>
				</tr>
				<tr>
					<td colspan="4" height="10">&nbsp;</td>
				</tr>

				<tr>
					<td width="300"><b>To</b></td>

					<td width="400" align="left"><b>Buyer Name :   </b> <? echo $buyer_name_arr[$nameArray_per_job[0][csf("buyer_id")]]; ?></td>


				</tr>
				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<tr>
					<td width="300"><?
					$pay_mode=$nameArray_per_job[0][csf("pay_mode")];//pay_mode
					if($pay_mode!=3 && $pay_mode!=5)
					{
						echo $supplier_name_arr[$nameArray_per_job[0][csf("supplier_id")]];
					}
					else
					{
						echo $company_library[$nameArray_per_job[0][csf("supplier_id")]];
					}?></td>

					<td width="400" align="left"><b>Order Qnty :   </b> <? echo $po_qnty_all_style[0][csf("qnty")]; ?></td>


				</tr>
				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<tr>
					<td width="300" ><p><b>Address: </b><? echo $supplier_address_arr[$nameArray_per_job[0][csf("supplier_id")]]; ?> </p></td>

					<td width="400" align="left"><b>Dealing Merchandiser:   </b> <? echo $marchentrArr[$nameArray_per_job[0][csf("dealing_marchant")]]; ?></td>


				</tr>

				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<tr>
				   <td width="300"><b>Attention: </b>   <? echo $nameArray_per_job[0][csf("attention")];?></td>

				   <td width="400" align="left"><b>Currency:   </b> <? echo $currency[$nameArray_per_job[0][csf("currency_id")]]; ?></td>


				</tr>
				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<tr>
				   <td colspan="2" width="800"><b>Shipment Date: </b><? echo trim($shipment_dates);?></td>

				</tr>


				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<tr>
				   <td width="300"><b>WO Prepared After:   </b>    </td>

				   <td width="400" align="left"><b>Remarks:   </b> <? echo $nameArray_per_job[0][csf("remarks")]; ?></td>


				</tr>
			</thead>
		</table>


			<?php
$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and a.status_active =1 and a.is_deleted=0");
list($nameArray_approved_row) = $nameArray_approved;
$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
list($nameArray_approved_date_row) = $nameArray_approved_date;
$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
list($nameArray_approved_comments_row) = $nameArray_approved_comments;

$po_data = array();
if ($db_type == 0) {
	$nameArray_job = sql_select("select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,DATEDIFF(pub_shipment_date,po_received_date) date_diff,MIN(po_received_date) as po_received_date ,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status  from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id)  group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
}
if ($db_type == 2) {
	$nameArray_job = sql_select("select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,(pub_shipment_date-po_received_date) date_diff,MIN(po_received_date) as po_received_date,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status   from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id) group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
}
foreach ($nameArray_job as $result_job) {
	$po_data['po_id'][$result_job[csf('id')]] = $result_job[csf('id')];
	$po_data['po_number'][$result_job[csf('id')]] = $result_job[csf('po_number')];
	$po_data['leadtime'][$result_job[csf('id')]] = $result_job[csf('date_diff')];
	$po_data['po_quantity'][$result_job[csf('id')]] = $result_job[csf('po_quantity')];
	$po_data['po_received_date'][$result_job[csf('id')]] = change_date_format($result_job[csf('po_received_date')], 'dd-mm-yyyy', '-');
	$ddd = strtotime($result_job[csf('pub_shipment_date')]);
	$po_data['pub_shipment_date'][$ddd] = $ddd;

	$po_data['insert_date'][$result_job[csf('id')]] = $result_job[csf('insert_date')];

	if ($result_job[csf('shiping_status')] == 1) {
		$shiping_status = "FP";
	} else if ($result_job[csf('shiping_status')] == 2) {
		$shiping_status = "PS";
	} else if ($result_job[csf('shiping_status')] == 3) {
		$shiping_status = "FS";
	}
	$po_data['shiping_status'][$result_job[csf('id')]] = $shiping_status;
	$po_data['file_no'][$result_job[csf('id')]] = $result_job[csf('file_no')];
	$po_data['grouping'][$result_job[csf('id')]] = $result_job[csf('grouping')];
}
$txt_order_no_id = implode(",", array_unique($po_data['po_id']));
$leadtime = implode(",", array_unique($po_data['leadtime']));
$po_quantity = array_sum($po_data['po_quantity']);
$po_received_date = implode(",", array_unique($po_data['po_received_date']));
$po_number = implode(",", array_unique($po_data['po_number']));
$shipment_date = date('d-m-Y', min($po_data['pub_shipment_date']));
$maxshipment_date = date('d-m-Y', max($po_data['pub_shipment_date']));
//$shipment_date=implode(",",array_unique($po_data['pub_shipment_date']));
$shiping_status = implode(",", array_unique($po_data['shiping_status']));
$file_no = implode(",", array_unique($po_data['file_no']));
$grouping = implode(",", array_unique($po_data['grouping']));

$colar_excess_percent = 0;
$cuff_excess_percent = 0;
$rmg_process_breakdown = 0;
$nameArray = sql_select("select a.buyer_id,a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.update_date,a.uom,a.remarks,a.pay_mode,a.fabric_composition from wo_booking_mst a  where   a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0");
foreach ($nameArray as $result) {
	$total_set_qnty = $result[csf('total_set_qnty')];
	$colar_excess_percent = $result[csf('colar_excess_percent')];
	$cuff_excess_percent = $result[csf('cuff_excess_percent')];
	$rmg_process_breakdown = $result[csf('rmg_process_breakdown')];
	foreach ($po_data['po_id'] as $po_id => $po_val) {
		$daysInHand .= (datediff('d', date('d-m-Y', time()), $po_data['pub_shipment_date'][$po_id]) - 1) . ",";
		$booking_date = $result[csf('update_date')];
		if ($booking_date == "" || $booking_date == "0000-00-00 00:00:00") {
			$booking_date = $result[csf('insert_date')];
		}
		$WOPreparedAfter .= (datediff('d', $po_data['insert_date'][$po_id], $booking_date) - 1) . ",";
	}

}

?>
			<br/>
			<!--  Here will be the main portion  -->
			<?
			$costing_per="";
			$costing_per_qnty=0;
			$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no in($job_no_in)");
			if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;

			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";
				$costing_per_qnty=1;

			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;

			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;

			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;
			}
			$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no in($job_no_in)");
			$uom_arr=array(1=>"Pcs",12=>"Kg",23=>"Mtr",27=>"Yds");
			$p=1;

		if($cbo_fabric_source==1 or $cbo_fabric_source==2 or $cbo_fabric_source==3)
		{
			$nameArray_fabric_description= sql_select("SELECT a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , b.dia_width,d.pre_cost_remarks,a.uom,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,avg(d.rate) as rates,sum(d.amount) as amounts ,d.fabric_color_id,a.color_size_sensitive,a.color_break_down,c.job_no_mst  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_number_id=d.gmts_color_id and
				b.dia_width=d.dia_width and
				b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id
				and
				d.booking_no =$txt_booking_no and
				d.job_no in ($all_jobs_id) and

				d.status_active=1 and
				d.is_deleted=0 and
				b.cons>0
				group by a.id,a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,b.dia_width,d.pre_cost_remarks,a.uom ,d.fabric_color_id,a.color_size_sensitive,a.color_break_down,c.job_no_mst  order by c.job_no_mst   ");


			$uom_data_arr=array();
			foreach($nameArray_fabric_description as $row)
			{
				$uom_data_arr[$row[csf('uom')]]=$row[csf('uom')];
			}

			foreach($uom_data_arr as $uom_id=>$uom_val)
			{
				if(count($nameArray_fabric_description)>0)
				{

					?>

						<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
									<caption> <strong>Fabric Booking Details </strong> </caption>
									<tr>
										<th  width="30" align="center">SL</th>
										<th  width="150" align="center">Style/Season</th>
										<th  width="140" align="center">Gmts Item/Dept</th>
										<th  width="390" align="left">Item Description</th>
										<th  width="40" align="center">GSM</th>
										<th  width="90" align="center">Fabric Dia</th>
										<th  width="100" align="center">Color Type</th>
										<th  width="100" align="center">Gmts Color</th>
										<th  width="110" align="center">Fabric Color</th>
										<th  width="60" align="center">UOM</th>
										<th width='120' align="center">Finish Fab. Qty</th>
										<th width='120' align="center">Grey Fab. Qty</th>
										<th width='100' align="center">Avg Rate</th>
										<th width='60' align="center">Amount</th>

									</tr>
									<?
									$color_wise_process_loss=sql_select("SELECT  a.body_part_id,b.color_number_id,avg(b.process_loss_percent) as loss FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls  b 	WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and  a.job_no in ($all_jobs_id)   group by a.body_part_id,b.color_number_id
									");
									foreach($color_wise_process_loss as $val)
									{
										$loss_arr[$val[csf("body_part_id")]][$val[csf("color_number_id")]]=$val[csf("loss")];
									}

									$total_fin_fab_qnty=0;  $total_amount=0;  $total_grey_fab_qnty=0 ;$tot_avg=0;
									foreach($nameArray_fabric_description as $val)
									{
										if($val[csf('pre_cost_remarks')]!='') $remark_cond=" and d.pre_cost_remarks='".$val[csf('pre_cost_remarks')]."' "; else $remark_cond=" and d.pre_cost_remarks is null";
										$color_wise_wo_sql_qnty=sql_select("SELECT  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
											WHERE
											a.job_no=d.job_no and
											a.id=d.pre_cost_fabric_cost_dtls_id and
											d.booking_no =$txt_booking_no and
											d.job_no = '".$val[csf('job_no_mst')]."' and
											a.item_number_id='".$val[csf('item_number_id')]."' and
											a.body_part_id='".$val[csf('body_part_id')]."' and
											a.color_type_id='".$val[csf('color_type_id')]."' and
											a.construction='".$val[csf('construction')]."' and
											a.composition='".$val[csf('composition')]."' and
											a.gsm_weight='".$val[csf('gsm_weight')]."' and
											d.dia_width='".$val[csf('dia_width')]."' and

											d.fabric_color_id='".$val[csf('fabric_color_id')]."' and
											d.status_active=1 and
											d.is_deleted=0 $remark_cond
											");
										if($uom_id==$val[csf('uom')])
										{
											if($val[csf('pre_cost_remarks')]=='no remarks')  $pre_cost_remarks="";else  $pre_cost_remarks=$val[csf('pre_cost_remarks')];
											?>
											<tr>
												<td align="center"> <? echo $p; $p++;?></td>


												<td align="center"> <? echo $all_job_arr[$val[csf("job_no_mst")]]["style"];if($all_job_arr[$val[csf("job_no_mst")]]["season"]){echo ','.$season_arr[$all_job_arr[$val[csf("job_no_mst")]]["season"]];}?></td>
												<td align="center"> <? echo $garments_item[$all_job_arr[$val[csf("job_no_mst")]]["item"]].','.$product_dept[$all_job_arr[$val[csf("job_no_mst")]]["dept"]];?></td>
												<td align="left"> <? echo $body_part[$val[csf('body_part_id')]].','. $val[csf('construction')].','.$val[csf('composition')].', '.$pre_cost_remarks; ?> </td>

												<td  align="center">
													<?
													echo $val[csf('gsm_weight')];
													?>
												</td>

												<td  align="center">
													<?
													echo $val[csf('dia_width')];
													?>
												</td>

												<td  align="center">
													<?
													echo $color_type[$val[csf('color_type_id')]];
													?>
												</td>
												<td  align="center">
													<?
													if($val[csf('color_size_sensitive')]==1 or $val[csf('color_size_sensitive')]==2 or $val[csf('color_size_sensitive')]==4)
													{
														echo $color_library[$val[csf('fabric_color_id')]];
													}

													else
													{
														$color_break_down=$val[csf('color_break_down')];
														if($color_break_down)
														{
															$gmts_color="";
															if (strpos($color_break_down, '__') !== false)
															{
																$color_break_down=explode('__', $color_break_down);
																foreach ($color_break_down as $key => $value)
																{
																	$cols=explode('_', $value);
																	if(trim(strtolower($color_library[$val[csf('fabric_color_id')]]))==trim(strtolower($cols[2])))
																	{
																		if($gmts_color=="")
																		{
																			$gmts_color=$cols[1];
																		}
																		else
																		{
																			$gmts_color .=','.$cols[1];
																		}

																	}
																}
															}
															else
															{
																$cols=explode('_', $color_break_down);
																if(trim(strtolower($color_library[$val[csf('fabric_color_id')]]))==trim(strtolower($cols[2])))
																{
																	if($gmts_color=="")
																	{
																		$gmts_color=$cols[1];
																	}
																	else
																	{
																		$gmts_color .=','.$cols[1];
																	}

																}
															}

															echo $gmts_color;
														}

													}
													?>
												</td>


												<td  align="center">
													<?
													echo $color_library[$val[csf('fabric_color_id')]];
													?>
												</td>


												<td align="center"> <? echo $unit_of_measurement[$val[csf('uom')]]; ?></td>

												<td align="center"> <?   $greys= $color_wise_wo_sql_qnty[0][csf("grey_fab_qnty")] /(1+($loss_arr[$val[csf("body_part_id")]][$val[csf("fabric_color_id")]]/100)) ;
													echo def_number_format($greys,2);

													?> </td>



													<td align="center"> <? echo def_number_format($color_wise_wo_sql_qnty[0][csf("grey_fab_qnty")],2); ?> </td>
													<td align="center"> <? echo def_number_format($color_wise_wo_sql_qnty[0][csf("rate")],2); ?> </td>
													<td align="center"> <? echo def_number_format($color_wise_wo_sql_qnty[0][csf("amount")],2); ?> </td>


													<?

													$total_fin_fab_qnty +=str_replace(",", "", def_number_format($greys,2));
													$total_amount +=str_replace(",", "",def_number_format($color_wise_wo_sql_qnty[0][csf("amount")],2));
													$total_grey_fab_qnty +=str_replace(",", "",def_number_format($color_wise_wo_sql_qnty[0][csf("grey_fab_qnty")],2));
													$total_rate +=str_replace(",", "",def_number_format($color_wise_wo_sql_qnty[0][csf("rate")],2));
													$tot_avg=$total_amount/$total_grey_fab_qnty;


													?>



												</tr>
												<?
										}

									}
										?>
									<tr style=" font-weight:bold">


									<td  align="right" colspan="10"><strong>Total</strong></td>
									<td align="center"><? echo def_number_format($total_fin_fab_qnty,2);?></td>
									<td align="center"><? echo def_number_format($total_grey_fab_qnty,2);?></td>
									<td align="center"><? echo def_number_format($tot_avg,2);?></td>
									<td align="center"><? echo def_number_format($total_amount,2);?></td>

									</tr>

						</table>

					<?
				}
			}
		}


		$sql_data=sql_select("SELECT a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,a.uom,b.dia_width,b.pre_cost_remarks,b.fabric_color_id,b.remark, sum(b.grey_fab_qnty) as grey_fab_qnty,sum(b.adjust_qty)as adjust_qty FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in($all_jobs_id) and b.adjust_qty>0 and b.status_active=1 and b.is_deleted=0 group by a.id,a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,a.uom,b.dia_width,b.pre_cost_remarks,b.fabric_color_id,b.remark order by a.id,a.body_part_id");
		if(count($sql_data)>0)
		{

					?>
					<br/>
			<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

					<tr>
						<td colspan="7" align="center">
							<strong>Fabric Stock Adjustment Details</strong>
						</td>

					</tr>

					<tr>
						<td align="center"> SL </td>
						<td align="center"> Item Description </td>
						<td align="center"> Fabric Color </td>
						<td align="center">UOM</td>
						<td align="center">Adjusted Qty </td>


					</tr>
					<?
					$p=1;
					foreach($sql_data as $row)
					{
						?>
						<tr>
							<td align="center"><? echo $p;?></td>
							<td align="center">
								<? echo $body_part[$row[csf('body_part_id')]].",".$row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$row[csf('dia_width')].','.$fabric_typee[$row[csf('width_dia_type')]].",".$color_type[$row[csf('color_type_id')]] ?>
							</td>

							<td align="center">
								<? echo $color_library[$row[csf('fabric_color_id')]];  ?>
							</td>
							<td align="center">
								<? echo $unit_of_measurement[$row[csf('uom')]];  ?>
							</td>


							<td align="center">
								<? echo number_format($row[csf('adjust_qty')],4) ; ?>
							</td>

						</tr>
						<?
						$p++;
					}
		}
					?>
			</table>



	        <?
	       $sql_collar_cuff= "SELECT a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,b.gmts_color_id,b.size_number_id,b.item_size,b.gmts_qty,b.excess_per,b.qty,b.po_break_down_id as po_id,b.id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id)  and b.status_active=1 and b.is_deleted=0  order by a.body_part_id,b.gmts_color_id,b.id " ;
	         $sql_data_collar_cuff=sql_select($sql_collar_cuff);
	          if(count($sql_data_collar_cuff)>0)
	          {

					?>
			  		<br>
			  		<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

			  			<tr>
			  				<td colspan="9" align="center">
			  					<strong>Collar and  Cuff Breakdown</strong>
			  				</td>

			  			</tr>

			  			<tr>
			  				<td align="center"> SL </td>
			  				<td align="left">   &nbsp;&nbsp;Item Description </td>
			  				<td align="center"> PO Number   </td>
			  				<td align="center"> Gmts Color  </td>
			  				<td align="center"> Gmts Size</td>
			  				<td align="center"> Item Size  </td>
			  				<td align="center"> Gmts Qty (Pcs)  </td>
			  				<td align="center"> Excess %   </td>
			  				<td align="center"> Collar & Cuff Qty (Pcs) </td>


			  			</tr>
			  			<?
			  			$p=1;
			  			foreach($sql_data_collar_cuff as $row)
			  			{
			  				?>
			  				<tr>
			  					<td align="center"><? echo $p;?></td>
			  					<td align="left"> &nbsp;
			  						<? echo $body_part[$row[csf('body_part_id')]].",".$row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$fabric_typee[$row[csf('width_dia_type')]].",".$color_type[$row[csf('color_type_id')]] ?>
			  					</td>


			  					<td align="center">
			  						<? echo $po_num_arr[$row[csf("po_id")]] ;?>
			  					</td>


			  					<td align="center">
			  						<? echo $color_library[$row[csf('gmts_color_id')]];  ?>
			  					</td>
			  					<td align="center">
			  						<? echo $size_library[$row[csf('size_number_id')]];  ?>
			  					</td>


			  					<td align="center">
			  						<? echo $row[csf('item_size')];  ?>
			  					</td>

			  					<td align="right">
			  						<? echo $row[csf('gmts_qty')];  ?>
			  					</td>

			  					<td align="right">
			  						<? echo $row[csf('excess_per')];  ?>
			  					</td>

			  					<td align="right">
			  						<? echo $row[csf('qty')];  ?>
			  					</td>

			  				</tr>
			  				<?
			  				$p++;
			  			}
			  	}
			  		?>
			  	</table>
			<br>


			<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

				<tr>
					<td colspan="10" align="center">
						<strong>Comments</strong>
					</td>

				</tr>

				<tr>
					<td align="center"> SL </td>
					<td align="center" width="200"  style="word-wrap: break-word;word-break: break-all;"> PO NO </td>
					<td align="center"> Ship Date </td>
					<td align="center">BOM Qty</td>
					<td align="center"> Booking Qty </td>
					<td align="center"> Short Booking Qty </td>
					<td align="center"> Total Booking Qty </td>
					<td align="center"> Balance </td>
					<td align="center"> Comments </td>


				</tr>
				<?
				$is_short_data=sql_select("SELECT a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0   and b.is_short =1 group by  a.id ");
				foreach($is_short_data as $vals)
				{
					$short_qty_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
				}

				$booking_data=sql_select("SELECT a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and  b.status_active=1 and b.is_deleted=0 and b.is_short !=1 group by  a.id  order by a.id");
				foreach($booking_data as $vals)
				{
					$booking_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
				}

				$po_date=return_library_array("select id,shipment_date from wo_po_break_down where status_active=1 and is_deleted=0",'id','shipment_date');

				$comments_data=sql_select("SELECT min(a.id) as ids,b.po_break_down_id as po_number,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,SUM(b.requirment) as precost_grey_qty FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id
					and
					b.po_break_down_id=d.po_break_down_id and
					b.color_number_id=d.gmts_color_id and
					b.dia_width=d.dia_width and
					b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					a.job_no=d.job_no and
					a.id=d.pre_cost_fabric_cost_dtls_id
					and
					d.booking_no =$txt_booking_no and
					d.job_no in($all_jobs_id) and

					d.status_active=1 and
					d.is_deleted=0 and
					b.cons>0
					group by b.po_break_down_id order by b.po_break_down_id");



				$job_no=$all_jobs_id;
				$condition= new condition();
				if(str_replace("'","",$job_no) !='')
				{
					$condition->job_no("in ($job_no)");
				}
				$condition->init();
				$fabric= new fabric($condition);
				$fabric_costing_qty_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish();

				$j=1;
				$total_bom=0;
				$total_book=0;
				$total_short=0;
				$total_short_full=0;
				$total_balance=0;
				foreach($comments_data as $val)
				{
					$po_id=$val[csf('po_number')];
					$woven_qty=array_sum($fabric_costing_qty_arr['woven']['grey'][$po_id]);
					$knit_qty=array_sum($fabric_costing_qty_arr['knit']['grey'][$po_id]);
					$sum_woven_knit=$woven_qty + $knit_qty;


					?>
					<tr>
						<td align="center"><? echo $j;?></td>

						<td align="center"  style="word-wrap: break-word;word-break: break-all;"> <? echo $po_num_arr[$val[csf("po_number")]] ;?> </td>
						<td align="center"> <? echo change_date_format($po_date[$val[csf("po_number")]], "yyyy-mm-dd", "-");?> </td>
						<td align="center"><?  echo $pre= def_number_format($sum_woven_knit,2);  ?> </td>
						<td align="center"><?  echo $bookings= def_number_format($booking_arr[$val[csf("po_number")]],2);  ?> </td>
						<td align="center"> <?echo $short=def_number_format($short_qty_arr[$val[csf("po_number")]],2); ?> </td>
						<td align="center"> <?   $tot_short_book= str_replace(',','',$bookings) +  str_replace(',','',$short) ; echo def_number_format($tot_short_book,2); ?>  </td>
						<td align="center"> <?  $bal =str_replace(',','',$pre)-str_replace(',','',$tot_short_book) ; echo def_number_format($bal,2);  ?> </td>
						<td align="center"> <? if($bal!=0){ if($pre>$tot_short_book){echo "Less ";} else{ echo "Over";} }?> </td>


					</tr>
					<?
					$total_bom +=str_replace(',','',$pre);
					$total_book +=str_replace(',','',$bookings);
					$total_short +=str_replace(',','',$short);
					$total_short_full += str_replace(',','',$tot_short_book);
					$total_balance += str_replace(',','',$bal);

					$j++;
				}
				?>
				<tr>
					<td colspan="3" align="right"> <b> Total </b></td>
					<td align="center"><strong><? echo def_number_format($total_bom,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_book,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_short,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_short_full,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_balance,2);?> </strong> </td>
					<td>&nbsp;</td>
				</tr>
			</table>



			<?
			if($cbo_fabric_source==1 || $cbo_fabric_source==2 || $cbo_fabric_source==3){
			?>
			<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
				<tr>
					<?
					$nameArray_item_size=sql_select( "SELECT min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active =1 and d.is_deleted=0 and d.job_no in($all_jobs_id)  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
					if(count($nameArray_item_size)>0)
					{
						?>
						<td width="49%">

						</td>
						<td width="2%">
						</td>
						<?
					}
					?>
					<?
					$nameArray_item_size=sql_select( "SELECT min(c.id) as id, b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.job_no in ($all_jobs_id)  and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");

					if(count($nameArray_item_size)>0)
					{
						?>
						<td width="49%">

						</td>
						<?
					}
					?>
				</tr>
			</table>
			<br/>

			<br/>



	<?
	//------------------------------ Query for TNA start-----------------------------------
	$po_id_all=str_replace("'","",$txt_order_no_id);
	$po_num_arr=return_library_array("SELECT id,po_number from wo_po_break_down where job_no_mst in($all_jobs_id)",'id','po_number');
	$tna_start_sql=sql_select( "SELECT id,po_number_id,
	(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
	(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
	(case when task_number=60 then task_start_date else null end) as knitting_start_date,
	(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
	(case when task_number=61 then task_start_date else null end) as dying_start_date,
	(case when task_number=61 then task_finish_date else null end) as dying_end_date,
	(case when task_number=64 then task_start_date else null end) as finishing_start_date,
	(case when task_number=64 then task_finish_date else null end) as finishing_end_date,
	(case when task_number=84 then task_start_date else null end) as cutting_start_date,
	(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
	(case when task_number=86 then task_start_date else null end) as sewing_start_date,
	(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
	(case when task_number=110 then task_start_date else null end) as exfact_start_date,
	(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
	(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
	(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
	from tna_process_mst
	where status_active=1 and po_number_id in($po_id_all) and job_no in ($all_jobs_id) order by po_number_id");
 	$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
	$tna_date_task_arr=array();
	foreach($tna_start_sql as $row)
	{
		if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
		{
			if($tna_fab_start=="")
			{
				$tna_fab_start=$row[csf("fab_booking_start_date")];
			}
		}
		if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
		}
		if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
		}
		if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
		}
		if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
		}
		if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
		}
		if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
		}
		if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
		}
	}
	//------------------------------ Query for TNA end-----------------------------------
	if(count($tna_start_sql)>0 )
	{
		?>
		<br>
		<fieldset id="div_size_color_matrix" style="max-width:1000;">
			<legend>TNA Information</legend>
			<table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
				<tr>
					<td rowspan="2" align="center" valign="top">SL</td>
					<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
					<td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
					<td colspan="2" align="center" valign="top"><b>Knitting</b></td>
					<td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
					<td colspan="2" align="center" valign="top"><b>Finishing Fabric</b></td>
					<td colspan="2" align="center" valign="top"><b>Cutting </b></td>
					<td colspan="2" align="center" valign="top"><b>Sewing </b></td>
					<td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
				</tr>
				<tr>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
				</tr>
				<?
				$i=1;
				foreach($tna_date_task_arr as $order_id=>$row)
				{
					?>
					<tr>
						<td><? echo $i; ?></td>
						<td><? echo $po_num_arr[$order_id]; ?></td>
						<td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
						<td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
						<td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
					</tr>
					<?
					$i++;
				}
				?>
			</table>
		</fieldset>
		<?
	}
	}// fabric Source End
	?>
	<br>

	<table width="220"  border="0" cellpadding="2" cellspacing="0" rules="all" style="float:left">
		<tr>
			<td width="200" valign="top" align="left">

				<div id="div_size_color_matrix" style="float:left;">
					<?
					$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
					?>
					<fieldset>
						<legend>RMG Process Loss % </legend>
						<table width="180" class="rpt_table" border="1" rules="all">
							<?
							if(number_format($rmg_process_breakdown_arr[8],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Cut Panel rejection <!-- Extra Cutting % breack Down 8-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[8],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[2],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Chest Printing <!-- Printing % breack Down 2-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[2],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[10],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Neck/Sleeve Printing <!-- New breack Down 10-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[10],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[1],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Embroidery   <!-- Embroidery  % breack Down 1-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[1],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[4],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Sewing /Input<!-- Sewing % breack Down 4-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[4],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[3],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Garments Wash <!-- Washing %breack Down 3-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[3],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[15],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Gmts Finishing <!-- Washing %breack Down 3-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[15],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[11],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Others <!-- New breack Down 11-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[11],2);
										?>
									</td>
								</tr>
								<?
							}
							$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
							if($gmts_pro_sub_tot>0)
							{
								?>
								<tr>
									<td width="130">
										Sub Total <!-- New breack Down 11-->
									</td>
									<td align="right">
										<?

										echo number_format($gmts_pro_sub_tot,2);
										?>
									</td>
								</tr>
								<?
							}
							?>
						</table>
					</fieldset>


					<fieldset>
						<legend>Fabric Process Loss % </legend>
						<table width="180" class="rpt_table" border="1" rules="all">
							<?
							if(number_format($rmg_process_breakdown_arr[6],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Knitting  <!--  Knitting % breack Down 6-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[6],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[12],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Yarn Dyeing  <!--  New breack Down 12-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[12],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[5],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Dyeing & Finishing  <!-- Finishing % breack Down 5-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[5],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[13],2)>0)
							{
								?>
								<tr>
									<td width="130">
										All Over Print <!-- new  breack Down 13-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[13],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[14],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Lay Wash (Fabric) <!-- new  breack Down 14-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[14],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[7],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Dying   <!-- breack Down 7-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[7],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[0],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Cutting (Fabric) <!-- Cutting % breack Down 0-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[0],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[9],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Others  <!-- Others% breack Down 9-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[9],2);
										?>
									</td>
								</tr>
								<?
							}
							$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
							if($fab_proce_sub_tot>0)
							{
								?>
								<tr>
									<td width="130">
										Sub Total  <!-- Others% breack Down 9-->
									</td>
									<td align="right">
										<?

										echo number_format($fab_proce_sub_tot,2);
										?>
									</td>
								</tr>
								<?
							}
							if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
							{
								?>
								<tr>
									<td width="130">
										Grand Total  <!-- Others% breack Down 9-->
									</td>
									<td align="right">
										<?
										echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2);
										?>
									</td>
								</tr>
								<?
							}
							?>
						</table>
					</fieldset>
				</div>
			</td>
		</tr>
	</table>

	<table width="400"  border="0" cellpadding="2" cellspacing="0" rules="all" style="float:left">
		<tr>
			<td colspan="6" align="left"><img  src='<? echo $path.$imge_arr[$job_no]; ?>' height='155' width='200' /></td>
		</tr>
	</table>
	<br>
	<br>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
				<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
					<thead>
						<tr>
							<th width="3%"></th><th width="97%" align="left"><u>Special Instruction</u></th>
						</tr>
					</thead>
					<tbody>
						<?
						$data_array=sql_select("select id, terms from  wo_booking_terms_condition where booking_no=$txt_booking_no");
						if ( count($data_array)>0)
						{
							$i=0;
							foreach( $data_array as $row )
							{
								$i++;
								?>
								<tr id="settr_1" valign="top">
									<td style="vertical-align:top">
										<? echo $i;?>
									</td>
									<td>
										<strong style="font-size:16px"> <? echo $row[csf('terms')]; ?></strong>
									</td>
								</tr>
								<?
							}
						}
						?>
					</tbody>
				</table>
			</td>

		</tr>
	</table>
	<br/><br/><br/><br/>


		    <table  width="100%"  border="0" cellpadding="0" cellspacing="0">
		    	<tr>
		            <td>  <?
		                    echo signature_table(121, $cbo_company_name, "1330px",1,'');
							$job_no_all= implode(",",array_unique($joball['job_no']));
							$style_sting_all=implode(",",array_unique($joball['style_ref_no']));
							echo "****".custom_file_name($txt_booking_no,$style_sting_all,$job_no_all);
		                ?>
		            </td>
		        </tr>
		    </table>
	</div>

	<?
			
			$html = ob_get_contents();
			ob_clean();
			list($is_mail_send,$mail)=explode('___',$mail_send_data);
		
			if($is_mail_send==1){
				require_once('../../../mailer/class.phpmailer.php');
				require_once('../../../auto_mail/setting/mail_setting.php');
				$mailBody = preg_replace("/<img[^>]+\>/i", " ", $html); 
				$mailBody="<br>".$mail_body	;	
				$mailToArr=array();
				$mailSql = "select b.EMAIL  from wo_booking_mst a,LIB_SUPPLIER b where b.id=a.supplier_id and a.booking_no=$txt_booking_no";
			//echo $mailSql;die;
				$mailSqlRes=sql_select($mailSql);
				foreach($mailSqlRes as $rows){
					if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
				}
				
				
				$mailSql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=99 and b.mail_user_setup_id=c.id  and c.IS_DELETED=0 and c.STATUS_ACTIVE=1";
				//echo $mailSql;die;
				$mailSqlRes=sql_select($mailSql);
				foreach($mailSqlRes as $rows){
					if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
				}
				if($mail!=''){$mailToArr[]=$mail;}
		
				$to=implode(',',$mailToArr);
				$subject="Partial fabric booking";
				$header=mailHeader();
				echo $to;
				echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
				
			}
			else{
				echo $html;
			}
			exit();

}

if($action=="print_booking_6") //Rehan for chaity
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$path=str_replace("'","",$path);
	if($path!="") $path=$path; else $path="../../";

	$imge_arr=return_library_array( "SELECT master_tble_id,image_location from   common_photo_library where form_name='company_details' or form_name='knit_order_entry' and file_type=1",'master_tble_id','image_location');
	$company_library=return_library_array( "SELECT id,company_name from lib_company where status_active=1 and is_deleted=0", "id", "company_name");
	$color_library=return_library_array( "SELECT id,color_name from lib_color ", "id", "color_name");
	$supplier_name_arr=return_library_array( "SELECT id,supplier_name from   lib_supplier  where status_active=1 and is_deleted=0",'id','supplier_name');
	$supplier_address_arr=return_library_array( "SELECT id,address_1 from   lib_supplier  where status_active=1 and is_deleted=0",'id','address_1');
	$marchentrArr = return_library_array("SELECT id,team_member_name from lib_mkt_team_member_info  where status_active=1 and is_deleted=0","id","team_member_name");
	$buyer_name_arr=return_library_array( "SELECT id,buyer_name from lib_buyer  where status_active=1 and is_deleted=0",'id','buyer_name');


	$nameArray_approved=sql_select( "SELECT max(b.approved_no) as approved_no,a.is_approved, count(b.id) as revised_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 group by a.is_approved");
	$nameArray_approved=sql_select( "select max(b.approved_no) as approved_no,a.is_approved, count(b.id) as revised_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 group by a.is_approved");
	list($nameArray_approved_row)=$nameArray_approved;
	$nameArray_approved_date=sql_select( "select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='".$nameArray_approved_row[csf('approved_no')]."'");
	list($nameArray_approved_date_row)=$nameArray_approved_date;
	$nameArray_approved_comments=sql_select( "select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='".$nameArray_approved_row[csf('approved_no')]."'");
	list($nameArray_approved_comments_row)=$nameArray_approved_comments;

	$job_po_arr=array();
	$ref_no='';$job_no_aarr='';
	$nameArray_per_job=sql_select( "SELECT  a.job_no,a.style_ref_no,b.po_break_down_id,c.po_number,c.grouping  from wo_po_details_master a, wo_booking_dtls b, wo_po_break_down c where c.id=b.po_break_down_id and a.job_no=b.job_no and  a.job_no=c.job_no_mst and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by a.job_no,a.style_ref_no,b.po_break_down_id,c.grouping,c.po_number");
	foreach ($nameArray_per_job as $row_per_job)
	{
		$job_no_aarr.="'".$row_per_job[csf('job_no')]."'".',';
		$all_po_id_arr[$row_per_job[csf('po_break_down_id')]]=$row_per_job[csf('po_break_down_id')];
		$job_po_arr[$row_per_job[csf('job_no')]].=$row_per_job[csf('po_number')].',';
		if($ref_no=='') $ref_no=$row_per_job[csf('grouping')]; else $ref_no.=",".$row_per_job[csf('grouping')];
		
		$job_no_allArr.=$row_per_job[csf('job_no')].',';

	}
	$job_no_all=rtrim($job_no_allArr,',');
	$job_no_Arr=array_unique(explode(",",$job_no_all));

	$job_nos=rtrim($job_no_aarr,',');
	$txt_order_no_id=implode(",",$all_po_id_arr);
	$job_nos=implode(",",array_unique(explode(",",$job_nos)));
	$ref_nos=implode(",",array_unique(explode(",",$ref_no)));
	$job_data_arr=array();
	$nameArray_buyer=sql_select( "SELECT  a.style_ref_no,a.style_description, a.job_no, a.style_owner, a.buyer_name, a.dealing_marchant,a.season,a.season_matrix,a.total_set_qnty,a.product_dept,a.product_code,a.pro_sub_dep,a.gmts_item_id ,a.order_repeat_no,a.qlty_label  from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0 and a.job_no in(".$job_nos.") order by a.job_no ");
	foreach ($nameArray_buyer as $result_buy)
	{
		$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
		$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
		$dealing_marchant.=$marchentrArr[$result_buy[csf('dealing_marchant')]].',';
	}

	$dealing_marchant=rtrim($dealing_marchant,',');
	$dealing_marchants=implode(",",array_unique(explode(",",$dealing_marchant)));
 	$nameArray=sql_select( "SELECT a.buyer_id, a.booking_no, a.booking_date, a.supplier_id, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.fabric_source, a.remarks, a.pay_mode, a.fabric_composition, a.booking_percent, a.is_approved,a.item_category,a.uom from wo_booking_mst a where  a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0");
 	foreach ($nameArray as $result_job)
 	{
 		$booking_date=$result_job[csf('booking_date')];
 		$buyer_id=$result_job[csf('buyer_id')];
 		$currency_id=$result_job[csf('currency_id')];
 		$attention=$result_job[csf('attention')];
 		$delivery_date=$result_job[csf('delivery_date')];
 		$supplier_id=$result_job[csf('supplier_id')];
 		$remarks=$result_job[csf('remarks')];
 		$pay_mode=$result_job[csf('pay_mode')];
 		$booking_percent=$result_job[csf('booking_percent')];
		$is_approved=$result_job[csf('is_approved')];
		$item=$result_job[csf('item_category')];
		$uom=$result_job[csf('uom')];
 	}

 	$lapdip_no_sql=sql_select("SELECT job_no_mst, lapdip_no,color_name_id from wo_po_lapdip_approval_info where  job_no_mst in ($job_nos) and status_active = 1 and approval_status = 3 ");
 	foreach($lapdip_no_sql as $key=>$vals)
 	{
 		$lapdip_no_arr[$vals[csf("job_no_mst")]][$vals[csf("color_name_id")]]=$vals[csf("lapdip_no")];
 	}

 	$condition= new condition();
	if(str_replace("'","",$txt_order_no_id) !='')
	{
		$condition->po_id("in($txt_order_no_id)");
	}

	$condition->init();
	$fabric= new fabric($condition);
	$fabric_costing_arr2=$fabric->getAmountArray_by_job_knitAndwoven_greyAndfinish();
	$fabric_qty_arr=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$fabric_amount_arr=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();

	ob_start();
	?>
	<style>

		@media print
		{
			.page-break { height:0; page-break-before:always; margin:0; border-top:none; }
		}
		body, p, span, td, a {font-size:10pt;font-family: Arial;}
		body{margin-left:2em; margin-right:2em; font-family: "Arial Narrow", Arial, sans-serif;}
	</style>
  <div style="width:1310px" align="center">
		<table width="100%" cellpadding="0" cellspacing="0" style="border:0px solid black" >
			<tr>
				<td width="100">
					<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
				</td>
				<td width="1250">
					<table width="100%" cellpadding="0" cellspacing="0"  border="0" >
						<tr>
							<td align="center">
								<?php
								echo $company_library[$cbo_company_name];
								?>
							</td>
							<td rowspan="3" width="250">
								<span><b> Booking No:&nbsp;&nbsp;<? echo trim($txt_booking_no,"'"); ?></b></span><br/>
								<span><b> Booking Date :&nbsp;&nbsp;<? echo change_date_format($booking_date); ?></b></span><br/>
								 <?
								if($nameArray_approved_row[csf('approved_no')]==1 && $nameArray_approved_row[csf('is_approved')]==0){
									?>
                                    <b> Revised No :  <? echo $nameArray_approved_row[csf('revised_no')]; ?></b>
                                      <br/>
                                      Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
                                    <?

								}
								 if($nameArray_approved_row[csf('approved_no')]>1 && $nameArray_approved_row[csf('is_approved')]==0)
								 {
								 ?>
								 <b> Revised No: <? echo $nameArray_approved_row[csf('revised_no')];?></b>
                                  <br/>
								  Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
								  <?
								 }
							  	?>
                                <?
                                if($nameArray_approved_row[csf('approved_no')]>1 && ($nameArray_approved_row[csf('is_approved')]==1 || $nameArray_approved_row[csf('is_approved')]==3))
								 {
								 ?>
								 <b> Revised No: <? echo $nameArray_approved_row[csf('revised_no')]-1;?></b>
                                  <br/>
								  Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
								  <?
								 }
							  	?>
							</td>
						</tr>
						<tr>
							<td align="center">
								<?
								$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");

								if($txt_job_no!="")
								{
									$location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'");
								}
								else
								{
									$location="";
								}
								foreach ($nameArray as $result)
								{
									$email=$result[csf('email')];
									$city=$result[csf('city')];

									?>
									Email Address: <? echo $email;?>
									Website: <? echo $result[csf('website')]; ?>
									<?
								}
								?>
							</td>
						</tr>
						<tr>
							<td align="center">
								<strong><? if($report_title !=""){ echo $report_title.'-'.$fabric_source[$cbo_fabric_source];}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if($is_approved==1){ echo "(Approved)";} else if($is_approved==3){ echo "(Partial Approved)";} else{echo "";}; ?> </font></strong><!--ISD-22-05697 by Kausar-->
							</td>
						</tr>
					</table>
				</td>
			</tr>
		</table>
		<table width="100%" style="border:0px solid black;table-layout: fixed;" >
			<tr>
				<td width="200"><span><b>To </b></span></td>
				<td width="280">&nbsp;<span></span></td>
				<td width="200"><span><b>Buyer</b></span></td>
				<td width="230"><span> :&nbsp;<b><? echo $buyer_name_arr[$buyer_id]; ?></b></span></td>
			</tr>
			<tr>
				<td width="200"><b>Supplier Name</b>   </td>
				<td width="280">:&nbsp;
					<?
					if($pay_mode==5 || $pay_mode==3){
						echo $company_library[$supplier_id];
						$suplier_address=$city.','.$email;
					}
					else{
						echo $supplier_name_arr[$supplier_id];
						$suplier_address=$supplier_address_arr[$supplier_id];
					}
					?>    </td>
					<td width="200"><b>Dealing Marchant</b></td>
					<td width="" colspan="2">:&nbsp;<? echo $dealing_marchants;?></td>
			</tr>
			<tr>
				<td width="200"><b>Address</b></td>
				<td width="280">:&nbsp;<? echo $suplier_address; ?></td>
				<td width="200"><b>Currency </b>   </td>
				<td width="230">:&nbsp;
					<?
					echo $currency[$currency_id];
					?>
				</td>
			</tr>
			<tr>
				<td width="200"><b>Attention</b></td>
				<td  width="280">:&nbsp;<? echo $attention; ?></td>
				<td width="200"><b>Fabric Nature</b></td>
				<td  width="280">:&nbsp;<? echo $item_category[$item];?>(<? echo $unit_of_measurement[$uom]?>)</td>
				
			</tr>
			<tr>
				<td width="200"><b>Delivery Date</b></td>
				<td width="280">:&nbsp;<? echo change_date_format($delivery_date); ?></td>
				<td width="200"><b>Internal Ref. No </b>   </td>
				<td colspan="2">:&nbsp;
					<?
					echo $ref_nos;
					?>
				</td>
			</tr>
			<tr>
				<td width="200"><b>Remark</b></td>
				<td colspan="4"> :<? echo $remarks;?></td>
			</tr>
	    </table>
	    <?

	    $color_wise_process_loss=sql_select("SELECT  a.job_no,a.body_part_id,b.color_number_id,a.process_loss_method,b.process_loss_percent as loss FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls  b 	WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and  a.job_no in(".$job_nos.") and b.process_loss_percent>0 group by a.job_no,a.body_part_id,a.process_loss_method,b.color_number_id,b.process_loss_percent");
	    foreach($color_wise_process_loss as $val)
	    {
	    	$loss_arr[$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['loss']=$val[csf("loss")];
	    	$loss_arr[$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['loss_method']=$val[csf("process_loss_method")];
	    }


	    $sql_booking="SELECT  a.job_no,a.id as fabric_cost_dtls_id, a.body_part_id,a.color_type_id as c_type, a.construction, a.composition, a.gsm_weight as gsm,d.process_loss_percent, d.dia_width as dia,a.uom,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.adjust_qty) as adjust_qty,sum(d.grey_fab_qnty) as grey_fab_qntys,avg(d.rate) as rates,sum(d.amount) as amounts ,c.style_ref_no,c.job_no_prefix_num,d.fabric_color_id as fab_color,d.gmts_color_id as gmt_color
	    FROM wo_pre_cost_fabric_cost_dtls a,  wo_booking_dtls d,wo_po_details_master c
	    WHERE   a.job_no=d.job_no and a.id=d.pre_cost_fabric_cost_dtls_id  and a.job_no=c.job_no  and d.job_no=c.job_no
	    and d.booking_no =$txt_booking_no and d.job_no in(".$job_nos.") and d.status_active=1 and d.is_deleted=0 and a.status_active=1 and a.is_deleted=0 and c.is_deleted=0
	    group by  a.job_no,a.id, a.body_part_id,a.color_type_id, a.construction, a.composition,d.fabric_color_id,d.gmts_color_id, a.gsm_weight,d.process_loss_percent, d.dia_width,a.uom,c.style_ref_no,c.job_no_prefix_num order by a.job_no,d.fabric_color_id ";
		// echo $sql_booking;
	    $result_set=sql_select($sql_booking);$pre_cost_fabIdArr=array();
	    foreach( $result_set as $row)
	    {
	    	$body_part_id=$body_part[$row[csf("body_part_id")]];
	    	$uom_data_arr[$row[csf("uom")]]=$unit_of_measurement[$row[csf("uom")]];
	    	$construction=$row[csf("construction")];
	    	$compositions= $row[csf("composition")];
	    	$item_desc=$body_part_id.','.$row[csf("construction")].','.$compositions;


	    	$process_loss=$loss_arr[$row[csf("job_no")]][$row[csf("body_part_id")]][$row[csf("gmt_color")]]['loss'];
	    	$process_loss_method=$loss_arr[$row[csf("job_no")]][$row[csf("body_part_id")]][$row[csf("gmt_color")]]['loss_method'];

	    	$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['uom']=$row[csf("uom")];
	    	$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['style_ref_no']=$row[csf("style_ref_no")];
	    	$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['job_prefix']=$row[csf("job_no_prefix_num")];
	    	$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['full_job']=$row[csf("job_no")];
	    	$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['style_ref_no']=$row[csf("style_ref_no")];

	    	$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['fin_qty']+=$row[csf("fin_fab_qntys")];
	    	$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['grey_qty']+=$row[csf("grey_fab_qntys")];
	    	$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['amounts']=$row[csf("amounts")];
	    	$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['rates']=$row[csf("rates")];
	    	$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['p_loss']=$process_loss;
	    	$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['p_loss_method']=$process_loss_method;
	    	$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['fabric_cost_dtls_id']=$row[csf("fabric_cost_dtls_id")];
			$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['process_losss']+=$row[csf("process_loss_percent")];
			$fabric_detail_arr[$row[csf("job_no")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]][$row[csf("c_type")]][$row[csf("gmt_color")]][$row[csf("fab_color")]]['adjust_qty']+=$row[csf("adjust_qty")];
			$pre_cost_fabIdArr[$row[csf("fabric_cost_dtls_id")]]=$row[csf("fabric_cost_dtls_id")];
			
	    }
	    $fab_row_span_arr=array();
	    foreach($fabric_detail_arr as $job_key=>$job_data)
	    {
	    	$desc_rowspan=0;
	    	foreach($job_data as $desc_key=>$desc_data)
	    	{
	    		foreach($desc_data as $gsm_key=>$gsm_data)
	    		{
	    			foreach($gsm_data as $dia_key=>$dia_data)
	    			{
	    				foreach($dia_data as $c_type_key=>$color_data)
	    				{
	    					foreach($color_data as $gmt_color_key=>$gmt_color_data)
	    					{
	    						foreach($gmt_color_data as $fab_color_key=>$val)
	    						{
	    							$desc_rowspan++;
	    						}
	    						//$fab_row_span_arr[$job_key]=$desc_rowspan;
	    					}
	    				}
	    			}
	    		}
	    	}
	    	$fab_row_span_arr[$job_key]=$desc_rowspan;
	    }
	//foreach($uom_data_arr as $uom_id=>$uom_val)
	//{
		?>
		<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >

			<tr>
				<th  width="30" align="center" style="word-break: break-all;word-wrap: break-word;">SL</th>
				<th  width="70" align="center" style="word-break: break-all;word-wrap: break-word;">Job No</th>
				<th  width="120" align="center" style="word-break: break-all;word-wrap: break-word;">Style Ref</th>
				<!-- <th  width="120" align="center" style="word-break: break-all;word-wrap: break-word;">Order No</th> -->
				<th  width="300" align="center" style="word-break: break-all;word-wrap: break-word;">Item Description</th>
				<th  width="50" align="center" style="word-break: break-all;word-wrap: break-word;">GSM</th>
				<th  width="60" align="center" style="word-break: break-all;word-wrap: break-word;">Fabric Dia</th>
				<th  width="80" align="center" style="word-break: break-all;word-wrap: break-word;">Color Type</th>
				<th  width="100" align="center" style="word-break: break-all;word-wrap: break-word;">Gmts Color</th>
				<th  width="100" align="center" style="word-break: break-all;word-wrap: break-word;">Fabric Color</th>
				<th  width="120" align="center" style="word-break: break-all;word-wrap: break-word;">Lab Dip No</th>
				<th  width="50" align="center" style="word-break: break-all;word-wrap: break-word;">UOM</th>
				<th width='100' align="center" style="word-break: break-all;word-wrap: break-word;">Finish Fab. Qty</th>
				<th width='100' align="center" style="word-break: break-all;word-wrap: break-word;">Process Loss</th>
				<th width='100' align="center" style="word-break: break-all;word-wrap: break-word;">Grey Fab. Qty</th>
				<th width='100' align="center" style="word-break: break-all;word-wrap: break-word;">Adj. Qty</th>
				<th width='80' align="center" style="word-break: break-all;word-wrap: break-word;">Avg Rate</th>
				<th width='100' align="center" style="word-break: break-all;word-wrap: break-word;">Amount</th>
			</tr>
			<?
 			$k=$p=1;$total_fin_qty=$total_grey_qty=$total_amount=0;


			foreach($fabric_detail_arr as $job_key=>$job_data)
			{
				$y=1;
				foreach($job_data as $desc_key=>$desc_data)
				{
					foreach($desc_data as $gsm_key=>$gsm_data)
					{
						foreach($gsm_data as $dia_key=>$dia_data)
						{
							foreach($dia_data as $c_type_key=>$color_data)
							{
								foreach($color_data as $gmt_color_key=>$gmt_color_data)
								{
									foreach($gmt_color_data as $fab_color_key=>$val)
									{
										$po_nos=rtrim($job_po_arr[$job_key],',');
										$po_nos=implode(",",array_unique(explode(",",$po_nos)));
										$fab_row_span=$fab_row_span_arr[$job_key];
										$p_loss_method=$val['p_loss_method'];
										$process_loss=$val['p_loss'];
										$labtest_no=$lab_dip_arr[$job_key]['labtest_no'];
										if($process_loss) $process_loss=$process_loss;else $process_loss=0;
										$fin_qty=$val['fin_qty'];										
										$fabric_cost_dtls_id=$val['fabric_cost_dtls_id'];
											?>
											<tr>
												<?
												if($y==1)
												{
													?>
													<td style="word-break: break-all;word-wrap: break-word;" width="30"  rowspan="<? echo $fab_row_span;?>"><? echo $p; ?></td>
													<td style="word-break: break-all;word-wrap: break-word;" width="70" align="center" rowspan="<? echo $fab_row_span;?>"><p><? echo $val['job_prefix']; ?>&nbsp;</p></td>
													<td style="word-break: break-all;word-wrap: break-word;" width="120" rowspan="<? echo $fab_row_span;?>"><p><? echo $val['style_ref_no']; ?>&nbsp;</p></td>
													<!-- <td style="word-break: break-all;word-wrap: break-word;" width="120" rowspan="<? echo $fab_row_span;?>">&nbsp;<p><? echo $po_nos; ?>&nbsp;</p></td> -->
													<?
												}
												?>
												<td style="word-break: break-all;word-wrap: break-word;" width="300"><p><? echo $desc_key; ?>&nbsp;</p></td>
												<td style="word-break: break-all;word-wrap: break-word;" width="50"><p><? echo $gsm_key; ?>&nbsp;</p></td>
												<td style="word-break: break-all;word-wrap: break-word;" width="60"><p><? echo $dia_key; ?>&nbsp;</p></td>
												<td style="word-break: break-all;word-wrap: break-word;" width="80"><p><? echo $color_type[$c_type_key]; ?>&nbsp;</p></td>
												<td style="word-break: break-all;word-wrap: break-word;" width="100"><p><? echo $color_library[$gmt_color_key]; ?>&nbsp;</p></td>
												<td style="word-break: break-all;word-wrap: break-word;" width="100"><p><? echo $color_library[$fab_color_key]; ?>&nbsp;</p></td>
												<td style="word-break: break-all;word-wrap: break-word;" width="120"><p><? echo $lapdip_no_arr[$val['full_job']][$fab_color_key]; ?>&nbsp;</p></td>
												<td  style="word-break: break-all;word-wrap: break-word;"width="50"><p><? echo $unit_of_measurement[$val['uom']]; ?>&nbsp;</p></td>
												<td style="word-break: break-all;word-wrap: break-word;" width="100" align="right" title="(Markup/Margin Method) Process Loss=<? echo $process_loss;?>,Fin Qty=<? echo $val['fin_qty'];?>"><p><? echo number_format($fin_qty,2); //number_format($fin_qty,2); ?>&nbsp;</p></td>
												<td style="word-break: break-all;word-wrap: break-word;" width="100" align="right"><p><? echo number_format($val['process_losss'],2); ?>&nbsp;</p></td>
												<td style="word-break: break-all;word-wrap: break-word;" width="100" align="right"><p><? echo number_format($val['grey_qty'],2); ?>&nbsp;</p></td>
												<td style="word-break: break-all;word-wrap: break-word;" width="100" align="right"><p><? echo number_format($val['adjust_qty'],2); ?>&nbsp;</p></td>
												<td style="word-break: break-all;word-wrap: break-word;" width="80" align="right"><p><? echo number_format($val['rates'],2); ?>&nbsp;</p></td>
												<td style="word-break: break-all;word-wrap: break-word;"width="100" align="right"><p><? echo number_format($val['amounts'],2); ?>&nbsp;</p></td>
											</tr>
											<?
											$k++;$y++;
											$total_fin_qty+=$fin_qty;
											$total_grey_qty+=$val['grey_qty'];
											$total_amount+=$val['amounts'];
							        }
						        }
					        }
				        }
			        }
		        }
				$p++;
	        }
			?>
			<tfoot>
				<tr>
					<th colspan="11" align="right"> Total </th>
					<th align="right"> <? echo number_format($total_fin_qty,2); ?> </th>
					<th></th>
					<th align="right"> <? echo number_format($total_grey_qty,2); ?> </th>
					<th></th>
					<th align="right"> <? //echo number_format($total_fin_qty,2); ?> </th>
					<th align="right"> <? echo number_format($total_amount,2); ?> </th>
				</tr>
			</tfoot>
		</table>
		<?
    //}

	?>
	<br>




	<?
        $size_lib_arr = return_library_array("select id,size_name from  lib_size ","id","size_name");
        $color_lib_arr = return_library_array("select id,color_name from  lib_color ","id","color_name");
        $sql_collar_cuff= "SELECT a.body_part_type, a.body_part_id, b.job_no, b.gmts_color_id, b.size_number_id, b.item_size, b.gmts_qty, b.excess_per, b.qty, b.po_break_down_id as po_id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in (".$job_nos.") and b.status_active=1 and b.is_deleted=0 order by b.id ASC" ;
       // echo $sql_collar_cuff;
        $sql_data_collar_cuff=sql_select($sql_collar_cuff);
        $body_part_color_arr=array(); $body_part_size_arr=array(); $body_part_color_size_arr=array(); $body_part_body_size_arr=array();
        foreach($sql_data_collar_cuff as $row)
        {
            $body_part_color_arr[$row[csf("body_part_type")]][$row[csf("body_part_id")]][$row[csf("job_no")]]['color'][$row[csf("gmts_color_id")]]=$row[csf("gmts_color_id")];
            $body_part_size_arr[$row[csf("body_part_type")]][$row[csf("body_part_id")]][$row[csf("job_no")]]['size'][$row[csf("size_number_id")]]=$row[csf("size_number_id")];
            $body_part_body_size_arr[$row[csf("body_part_type")]][$row[csf("body_part_id")]][$row[csf("job_no")]]['item_size'][$row[csf("size_number_id")]]=$row[csf("item_size")];
            $body_part_color_size_arr[$row[csf("body_part_type")]][$row[csf("body_part_id")]][$row[csf("job_no")]][$row[csf("gmts_color_id")]][$row[csf("size_number_id")]]['qty']+=$row[csf("qty")];
			$body_part_color_size_arr[$row[csf("body_part_type")]][$row[csf("body_part_id")]][$row[csf("job_no")]][$row[csf("gmts_color_id")]][$row[csf("size_number_id")]]['gmtsqty']+=$row[csf("gmts_qty")];
        }

		foreach($body_part_color_arr as $body_type=>$body_data)
		{
			foreach($body_data as $body_id=>$jobdata)
			{
				foreach($jobdata as $job_no=>$data)
				{
					$count_collar_cuff=count($body_part_size_arr[$body_type][$body_id][$job_no]['size']);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;

					?>
					<div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;">
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
						<tr>
							<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo "Job No:".$job_no.'; '.$body_part[$body_id]; ?> - Color Size Brakedown in Pcs.</b></td>
						</tr>
						<tr>
							<td width="100">Size</td>
								<?
								foreach($body_part_size_arr[$body_type][$body_id][$job_no]['size']  as $size_number_id)
								{
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_lib_arr[$size_number_id];?></strong></td>
									<?
								}
								?>
							<td width="60" rowspan="2" align="center"><strong>Total</strong></td>
							<td rowspan="2" align="center"><strong>Extra %</strong></td>
						</tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_part[$body_id]; ?> Size</td>
                            <?
                            foreach($body_part_body_size_arr[$body_type][$body_id][$job_no]['item_size']  as $size_number_id=>$size_number)
                            {
								?>
                                <td align="center" style="border:1px solid black"><strong><? echo $size_number;?></strong></td>
                                <?
                            }

                            $pre_size_total_arr=array();
                            foreach($data['color'] as $color_id=>$color_data)
                            {
								?>
								<tr>
									<td><? echo $color_library[$color_id]; ?></td>
									<? $pre_color_total_collar=0;  $pre_color_total_gmtsqty=0;
										foreach($body_part_size_arr[$body_type][$body_id][$job_no]['size']  as $size_number_id)
										{
											$size_qty=0; $gmtssize_qty=0;
											$size_qty=$body_part_color_size_arr[$body_type][$body_id][$job_no][$color_id][$size_number_id]['qty'];
											$gmtssize_qty=$body_part_color_size_arr[$body_type][$body_id][$job_no][$color_id][$size_number_id]['gmtsqty'];
											$pre_size_total_arr[$size_number_id]+=$size_qty;
											$pre_color_total_collar+=$size_qty;
											$pre_color_total_gmtsqty+=$gmtssize_qty;
											?>
											<td align="center" style="border:1px solid black"><? echo number_format($size_qty); ?></td>
											<?
										}
										$color_gmts_pcs=0;
										if($body_type==50) $color_gmts_pcs=(($pre_color_total_collar/2)-$pre_color_total_gmtsqty); else $color_gmts_pcs=$pre_color_total_collar-$pre_color_total_gmtsqty;
									?>
                                    <td align="center"><? echo number_format($pre_color_total_collar); ?></td>
                                    <td align="center"><? echo number_format((($color_gmts_pcs)/$pre_color_total_gmtsqty)*100,2); ?></td>
                                </tr>
                                <?
                                $pre_grand_collar_ex_per+=$collar_ex_per;
                                $pre_grand_tot_collar+=$pre_color_total_collar;
                                $pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>
                <br/>
                <?
				}
            }
        }
		//////////////////



	
	$cos_per_arr=$condition->getCostingPerArr();
	$yarn= new yarn($condition);
	$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
	$yarn_qty_arr=$yarn->get_By_Precostdtlsid_YarnQtyArray();
 	$yarn_count_arr=return_library_array( "SELECT id,yarn_count from lib_yarn_count",'id','yarn_count');
 	$po_qnty_tot=return_field_value("sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");

 	if($db_type==0)
 	{
 		$job_listagg=" group_concat(a.job_no) as job_no";
 	}
 	else
 	{

 		$job_listagg=" listagg(cast(a.job_no as varchar2(4000)),',') within group (order by a.job_no) as job_no";
 	}

	 $pre_cost_fabIds=implode(",",$pre_cost_fabIdArr);
	$yarn_sql_array=sql_select("SELECT a.id ,a.count_id, a.copm_one_id, a.percent_one, a.color, a.type_id, sum(a.cons_qnty) as yarn_required, a.rate    from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no in ($job_nos) and b.booking_no=$txt_booking_no and b.pre_cost_fabric_cost_dtls_id in ($pre_cost_fabIds) and  a.status_active=1 and a.is_deleted=0 group by a.count_id,a.copm_one_id,a.percent_one,a.color,a.type_id,a.rate ,a.id");

	
	if($show_yarn_rate==1) $display_rate=""; else $display_rate="display:none";
	?>
	<br/>
	<br/>
	<br/>
	<table style="margin-top: 10px;" class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >

		<tr align="center">
             <td colspan="7"><b>Yarn Required Summary (Pre Cost) </b></td>
        </tr>

        <tr align="center">
        	<td width="30" style="word-wrap: break-word;word-break: break-all;">Sl</td>

        	<td width="500" style="word-wrap: break-word;word-break: break-all;">Yarn Description</td>
        	<td width="150" style="word-wrap: break-word;word-break: break-all;">Brand</td>
        	<td width="150" style="word-wrap: break-word;word-break: break-all;">Lot</td>
        	<td width="50" style="word-wrap: break-word;word-break: break-all; <?=$display_rate; ?>">Rate</td>
        	<td width="120" style="word-wrap: break-word;word-break: break-all;">Cons for Dzn Gmts</td>
        	<td style="word-wrap: break-word;word-break: break-all;">Total (KG)</td>
        </tr>

        <?
		$i=0;
		$total_yarn=0;
		foreach($yarn_sql_array  as $row)
        {

			$i++;
			$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
			$rowcons_Amt = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];


			$rate=$rowcons_Amt/$rowcons_qnty;
			$rowcons_qnty =($rowcons_qnty/100)*$booking_percent;
			$job_no=$row[csf("job_no")];
			$cos_per_value=0;
			//foreach(explode(",", $job_no) as $keys=>$vals)
			foreach($job_no_Arr as $keys=>$vals)
			{
				$cos_per_value=$cos_per_arr[$vals];
			}
			?>
            <tr align="center">
            	<td style="word-wrap: break-word;word-break: break-all;"><? echo $i; ?></td>

            	<td style="word-wrap: break-word;word-break: break-all;" align="left">
            		<?
            		$yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
            		$yarn_des.=$color_library[$row[csf('color')]]." ";
            		$yarn_des.=$yarn_type[$row[csf('type_id')]];
            		echo $yarn_des;
            		?>
            	</td>
            	<td style="word-wrap: break-word;word-break: break-all;"></td>
            	<td style="word-wrap: break-word;word-break: break-all;"></td>
            	<td style="word-wrap: break-word;word-break: break-all; <?=$display_rate; ?>"><? echo number_format($row[csf('rate')],4); ?></td>
            	<td style="word-wrap: break-word;word-break: break-all;"><? echo number_format(($rowcons_qnty/$po_qnty_tot)*$cos_per_value,4);?></td>
            	<td align="right" style="word-wrap: break-word;word-break: break-all;"><? echo $yarn_qty_arr[$row[csf('id')]];//number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td>
            </tr>
            <?
			$total_yarn+=$yarn_qty_arr[$row[csf('id')]];
		}
		?>
       <tr align="center">
	       	<td colspan="5" align="right">Total</td>
            <td style=" <?=$display_rate; ?>">&nbsp;</td>
	       	<td align="right"><? echo number_format($total_yarn,4); ?></td>
        </tr>
	</table>

	<br>
	<?
	$color_name_arr=return_library_array( "SELECT id,color_name from lib_color",'id','color_name');
	
	$all_jobs_id=$job_nos;
	$sql_stripe="SELECT c.id,c.job_no,c.composition,c.construction,c.body_part_id,c.gsm_weight,c.color_type_id,d.color_number_id as color_number_id,d.id as did,d.uom,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,c.uom as type_uom from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and d.job_no in($all_jobs_id)  and b.booking_no=$txt_booking_no  and c.color_type_id in (2,3,6) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and b.is_deleted=0  
	group by c.id,c.job_no,c.body_part_id,c.gsm_weight,c.color_type_id,d.color_number_id,d.uom,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,c.composition,c.construction,c.uom order by c.job_no,c.id,d.id ";
	//echo $sql_stripe;
		$result_data=sql_select($sql_stripe);
		foreach($result_data as $row)
		{
		$style_ref_no=$job_data_arr['style_ref_no'][$row[csf('job_no')]];
		//echo $style_ref_no.'XXXX';
			//$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['style_ref_no'][$row[csf('did')]]=$style_ref_no;
			if($row[csf('type_uom')]==12){
				$type_uom_arr[$row[csf('type_uom')]]='kg';
			}elseif($row[csf('type_uom')]==1){
				$type_uom_arr[$row[csf('type_uom')]]='pcs';
			}
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')].'*'.$row[csf('did')]]['type_uom']=$row[csf('type_uom')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')].'*'.$row[csf('did')]]['stripe_color']=$row[csf('stripe_color')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')].'*'.$row[csf('did')]]['measurement']=$row[csf('measurement')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')].'*'.$row[csf('did')]]['fabreqtotkg']+=$row[csf('fabreqtotkg')];
			//$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')].'*'.$row[csf('did')]]['yarn_dyed']=$row[csf('yarn_dyed')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')].'*'.$row[csf('did')]]['fabric_description']=$row[csf('fabric_description')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')].'*'.$row[csf('did')]]['uom']=$row[csf('uom')];
		
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')].'*'.$row[csf('did')]]['style_ref_no']=$style_ref_no;

			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabric_description']=$row[csf('fabric_description')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['style_ref_no']=$style_ref_no;
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom']=$row[csf('uom')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
			//$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg']+=$row[csf('fabreqtotkg')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['type_uom']=$row[csf('type_uom')];
		}
	
 // print_r($type_uom_arr);

		foreach($type_uom_arr as $uom_id=>$uom_arr){
		?>
			

			<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
       		 <caption> <strong style="float:left"> Stripe Details (<?=$uom_arr;?>)</strong></caption>
      

            <tr>
                <th width="30"> SL</th>
                <th width="100">Job No</th>
				<th width="100">Body Part</th>
				<!-- <th width="100">Fab. Desc.</th> -->
                <th width="80">Fabric Color</th>
                <th width="70">Fabric Qty(<?=$uom_arr;?>)</th>
                <th width="70">Stripe Color</th>
                <th width="70">Stripe Measurement</th>
				<th  width="70">Stripe Uom</th>
                <th  width="70">Qty.(<?=$uom_arr;?>)</th>

				<th  width="70">Y/D Req.</th>
            </tr>
            <?
				$job_strip_color_rowspan=array();$fab_strip_color_rowspan=array();$color_strip_color_rowspan=array();
			  foreach($stripe_arr as $job_id=>$job_data)
			  {	 $job_row_span=0;
					 foreach($job_data as $body_id=>$body_data)
					 {
						   $fab_row_span=0;
						   foreach($body_data as $color_id=>$color_data)
						   {
								$color_row_span=0;
								foreach($color_data as $strip_color_id=>$color_val)
								{
									$job_row_span++;$fab_row_span++;$color_row_span++;

								}
								$job_strip_color_rowspan[$job_id]=$job_row_span;
								$fab_strip_color_rowspan[$job_id][$body_id]=$fab_row_span;
								$color_strip_color_rowspan[$job_id][$body_id][$color_id]=$color_row_span;
								$color_strip_color_qty_arr[$job_id][$body_id][$color_id]=$stripe_arr2[$job_id][$body_id][$color_id]['fabreqtotkg'];


						   }
					 }
			  }
			 // print_r($job_strip_color_rowspan);


			$i=1;$total_fab_qty=0;$total_fabreqtotkg=$total_color_qty=0;$fab_data_array=array();
            foreach($stripe_arr as $job_id=>$job_data)	{
			 $job_span=1;
			 foreach($job_data as $body_id=>$body_data)    {
			  $fab_span=1;
			   foreach($body_data as $color_id=>$color_data)  {
			     $color_span=1;
				foreach($color_data as $strip_color_key=>$color_val)   {
					$strip_color_str_arr=explode("*",$strip_color_key);
					$strip_color_id=$strip_color_str_arr[0];

					if($uom_id==$color_val['type_uom'])
					{
					?>
					<tr>
					<?

					if($job_span==1)
					{
					?>
                        <td align="center" rowspan="<? echo $job_strip_color_rowspan[$job_id];?>"> <? echo $i; ?></td>
                        <td align="center" title="<? echo $job_id;?>" rowspan="<? echo $job_strip_color_rowspan[$job_id];?>"> <? echo $job_id; ?></td>
						<?
					}
					if($fab_span==1)
					{
						?>
						<td align="center" rowspan="<? echo $fab_strip_color_rowspan[$job_id][$body_id];?>"> <? echo $body_part[$body_id]; ?></td>
						<!-- <td align="center" rowspan="<? echo $fab_strip_color_rowspan[$job_id][$body_id];?>"> <? //echo $color_val['fabric_description']; ?></td> -->
						<?
					}
					if($color_span==1)
					{
					$color_qty= $color_strip_color_qty_arr[$job_id][$body_id][$color_id];//$color_val['fabreqtotkg'];
					$total_color_qty+=$color_qty;
					?>
                        <td rowspan="<? echo $color_strip_color_rowspan[$job_id][$body_id][$color_id];?>" align="center"> <? echo $color_name_arr[$color_id]; ?></td>
                        <td rowspan="<? echo $color_strip_color_rowspan[$job_id][$body_id][$color_id];?>" align="center"> <? echo number_format($color_qty,2); ?></td>
					<?
					}

						?>
						<td align="center"><?  echo  $color_name_arr[$strip_color_id]; ?></td>
						<td align="center"> <? echo  number_format($color_val['measurement'],2); ?></td>
						<td align="center"> <? echo  $unit_of_measurement[$color_val['uom']]; ?></td>
						<td align="center" title="Stripe Measurement/Tot Stripe Measurement*Fabric Qty(KG)"> <? echo  number_format($color_val['fabreqtotkg'],2); ?></td>

						<td align="center"> <? echo  $yes_no[$color_val['yarn_dyed']]; ?></td>
					</tr>
						<?
					
						$total_fabreqtotkg+=$color_val['fabreqtotkg'];

					$job_span++;$fab_span++;$color_span++;
					}
				  }
				}
				$i++;
			}
			}
			?>
        <tfoot>
        <tr>
            <td align="right" colspan="4">Total </td>
            <td align="center"><? echo  number_format($total_color_qty,2); ?> </td>
            <td></td>
            <td></td>

            <td> </td>
			 <td align="center"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
			<td> </td>
        </tr>
        </tfoot>
   </table>
   <?}?>
   <br/>
    

    <table  style="margin-top: 5px;float: left;"    width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

		<tr>
			<td colspan="10" align="center">
				<strong>Comments</strong>
			</td>
		</tr>
		<tr>
			<td align="center"> SL </td>
			<td align="center" width="200"  style="word-wrap: break-word;word-break: break-all;"> PO NO </td>
			<td align="center"> Ship Date </td>
			<td align="center">BOM Qty</td>
			<td align="center"> Booking Qty </td>
			<td align="center"> Short Booking Qty </td>
			<td align="center"> Total Booking Qty </td>
			<td align="center"> Balance </td>
			<td align="center"> Comments </td>
		</tr>
		<?
		$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where status_active=1 and is_deleted=0 and id in(select po_break_down_id from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no=$txt_booking_no)",'id','po_number');
		$is_short_data=sql_select("SELECT a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0   and b.is_short =1 group by  a.id ");
		foreach($is_short_data as $vals)
		{
			$short_qty_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
		}

		$booking_data=sql_select("SELECT a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and  b.status_active=1 and b.is_deleted=0 and b.is_short !=1 and b.booking_type=1 group by  a.id  order by a.id");
		foreach($booking_data as $vals)
		{
			$booking_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
		}

		$po_date=return_library_array("select id,shipment_date from wo_po_break_down where status_active=1 and is_deleted=0",'id','shipment_date');

		$comments_data=sql_select("SELECT min(a.id) as ids,b.po_break_down_id as po_number,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,SUM(b.requirment) as precost_grey_qty FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
			WHERE a.job_no=b.job_no and
			a.id=b.pre_cost_fabric_cost_dtls_id
			and
			b.po_break_down_id=d.po_break_down_id and
			b.color_number_id=d.gmts_color_id and
			b.dia_width=d.dia_width and
			b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
			a.job_no=d.job_no and
			a.id=d.pre_cost_fabric_cost_dtls_id
			and
			d.booking_no =$txt_booking_no and
			d.job_no in($all_jobs_id) and

			d.status_active=1 and
			d.is_deleted=0 and
			b.cons>0
			group by b.po_break_down_id order by b.po_break_down_id");



		$job_no=$all_jobs_id;
		$condition= new condition();
		if(str_replace("'","",$job_no) !='')
		{
			$condition->job_no("in ($job_no)");
		}
		$condition->init();
		$fabric= new fabric($condition);
		$fabric_costing_qty_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish();

		$j=1;
		$total_bom=0;
		$total_book=0;
		$total_short=0;
		$total_short_full=0;
		$total_balance=0;
		foreach($comments_data as $val)
		{
			$po_id=$val[csf('po_number')];
			$woven_qty=array_sum($fabric_costing_qty_arr['woven']['grey'][$po_id]);
			$knit_qty=array_sum($fabric_costing_qty_arr['knit']['grey'][$po_id]);
			$sum_woven_knit=$woven_qty + $knit_qty;


			?>
			<tr>
				<td align="center"><? echo $j;?></td>

				<td align="center"  style="word-wrap: break-word;word-break: break-all;"> <? echo $po_num_arr[$val[csf("po_number")]] ;?> </td>
				<td align="center"> <? echo change_date_format($po_date[$val[csf("po_number")]], "yyyy-mm-dd", "-");?> </td>
				<td align="center"><?  echo $pre= def_number_format($sum_woven_knit,2);  ?> </td>
				<td align="center"><?  echo $bookings= def_number_format($booking_arr[$val[csf("po_number")]],2);  ?> </td>
				<td align="center"> <?echo $short=def_number_format($short_qty_arr[$val[csf("po_number")]],2); ?> </td>
				<td align="center"> <?   $tot_short_book= str_replace(',','',$bookings) +  str_replace(',','',$short) ; echo def_number_format($tot_short_book,2); ?>  </td>
				<td align="center"> <?  $bal =str_replace(',','',$pre)-str_replace(',','',$tot_short_book) ; echo def_number_format($bal,2);  ?> </td>
				<td align="center"> <? if($bal!=0){ if($pre>$tot_short_book){echo "Less ";} else{ echo "Over";} }?> </td>


			</tr>
			<?
			$total_bom +=str_replace(',','',$pre);
			$total_book +=str_replace(',','',$bookings);
			$total_short +=str_replace(',','',$short);
			$total_short_full += str_replace(',','',$tot_short_book);
			$total_balance += str_replace(',','',$bal);

			$j++;
		}
		?>
		<tr>
			<td colspan="3" align="right"> <b> Total </b></td>
			<td align="center"><strong><? echo def_number_format($total_bom,2);?> </strong> </td>
			<td align="center"><strong><? echo def_number_format($total_book,2);?> </strong> </td>
			<td align="center"><strong><? echo def_number_format($total_short,2);?> </strong> </td>
			<td align="center"><strong><? echo def_number_format($total_short_full,2);?> </strong> </td>
			<td align="center"><strong><? echo def_number_format($total_balance,2);?> </strong> </td>
			<td>&nbsp;</td>
		</tr>
	</table>


    <fieldset id="div_size_color_matrix" style="max-width:1000;">
		<?
	    //Query for TNA start-
		$po_id_all=str_replace("'","",$txt_order_no_id);
		$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
		$tna_start_sql=sql_select( "select id,po_number_id,
						(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
						(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
						(case when task_number=60 then task_start_date else null end) as knitting_start_date,
						(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
						(case when task_number=61 then task_start_date else null end) as dying_start_date,
						(case when task_number=61 then task_finish_date else null end) as dying_end_date,
						(case when task_number=64 then task_start_date else null end) as finishing_start_date,
						(case when task_number=64 then task_finish_date else null end) as finishing_end_date,
						(case when task_number=84 then task_start_date else null end) as cutting_start_date,
						(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
						(case when task_number=86 then task_start_date else null end) as sewing_start_date,
						(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
						(case when task_number=110 then task_start_date else null end) as exfact_start_date,
						(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
						(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
						(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
						from tna_process_mst
						where status_active=1 and po_number_id in($po_id_all)");
		$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
		$tna_date_task_arr=array();
		foreach($tna_start_sql as $row)
		{
			if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
			{
				if($tna_fab_start=="")
				{
					$tna_fab_start=$row[csf("fab_booking_start_date")];
				}
			}


			if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
			}
			if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
			}
			if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
			}
			if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
			}

			if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
			}
			if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
			}
			if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
			}
		}


		?>
        <legend>TNA Information</legend>

        <table width="100%" style="border:1px solid black;font-size:12px; font-family:Arial Narrow;" border="1" cellpadding="2" cellspacing="0" rules="all">
        	<tr>
        		<td rowspan="2" align="center" valign="top">SL</td>
        		<td width="180" rowspan="2"  align="center" valign="top" style="word-wrap: break-word;word-break: break-all;"><b>Order No</b></td>
        		<td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
        		<td colspan="2" align="center" valign="top"><b>Knitting</b></td>
        		<td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
        		<td colspan="2" align="center" valign="top"><b>Finish Fabric Prod.</b></td>
        		<td colspan="2" align="center" valign="top"><b>Cutting </b></td>
        		<td colspan="2" align="center" valign="top"><b>Sewing </b></td>
        		<td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
        	</tr>
        	<tr>
        		<td width="85" align="center" valign="top"><b>Start Date</b></td>
        		<td width="85" align="center" valign="top"><b>End Date</b></td>
        		<td width="85" align="center" valign="top"><b>Start Date</b></td>
        		<td width="85" align="center" valign="top"><b>End Date</b></td>
        		<td width="85" align="center" valign="top"><b>Start Date</b></td>
        		<td width="85" align="center" valign="top"><b>End Date</b></td>
        		<td width="85" align="center" valign="top"><b>Start Date</b></td>
        		<td width="85" align="center" valign="top"><b>End Date</b></td>
        		<td width="85" align="center" valign="top"><b>Start Date</b></td>
        		<td width="85" align="center" valign="top"><b>End Date</b></td>
        		<td width="85" align="center" valign="top"><b>Start Date</b></td>
        		<td width="85" align="center" valign="top"><b>End Date</b></td>
        		<td width="85" align="center" valign="top"><b>Start Date</b></td>
        		<td width="85" align="center" valign="top"><b>End Date</b></td>

        	</tr>
            <?
			$i=1;
			foreach($tna_date_task_arr as $order_id=>$row)
			{

				?>
				<tr>
					<td><? echo $i; ?></td>
					<td style="word-wrap: break-word;word-break: break-all;"><? echo $po_num_arr[$order_id]; ?></td>
					<td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
					<td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
					<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
					<td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
					<td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
					<td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
					<td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
					<td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
					<td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
					<td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
					<td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
					<td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
					<td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
					<td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
				</tr>
                <?
				$i++;
			}
			?>

        </table>
    </fieldset>

    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
            <thead>
                <tr>
                    <th width="3%"></th><th width="97%" align="left"><u>Special Instruction</u></th>
                </tr>
            </thead>
            <tbody>
            <?
            $data_array=sql_select("select id, terms from  wo_booking_terms_condition where booking_no=$txt_booking_no");// quotation_id='$data'
            if ( count($data_array)>0)
            {
                $i=0;
                foreach( $data_array as $row )
                {
                    $i++;
                    ?>
                        <tr id="settr_1" valign="top">
                            <td style="vertical-align:top">
                            <? echo $i;?>
                            </td>
                            <td>
                           <strong style="font-size:14px"> <? echo $row[csf('terms')]; ?></strong>
                            </td>
                        </tr>
                    <?
                }
            }
            ?>
        </tbody>
    </table>


	<br>
	<?
		echo signature_table(121, $cbo_company_name, "1000px");
	?>

  </div>
	<?

		
	$html = ob_get_contents();
	ob_clean();
	list($is_mail_send,$mail)=explode('___',$mail_send_data);

	if($is_mail_send==1){
		require_once('../../../mailer/class.phpmailer.php');
		require_once('../../../auto_mail/setting/mail_setting.php');
		$mailBody = preg_replace("/<img[^>]+\>/i", " ", $html); 
		$mailBody="<br>".$mail_body	;	
		$mailToArr=array();
		$mailSql = "select b.EMAIL  from wo_booking_mst a,LIB_SUPPLIER b where b.id=a.supplier_id and a.booking_no=$txt_booking_no";
	//echo $mailSql;die;
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
		}
		
		
		$mailSql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=99 and b.mail_user_setup_id=c.id  and c.IS_DELETED=0 and c.STATUS_ACTIVE=1";
		//echo $mailSql;die;
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
		}
		if($mail!=''){$mailToArr[]=$mail;}

		$to=implode(',',$mailToArr);
		$subject="Partial fabric booking";
		$header=mailHeader();
		echo $to;
		echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
		
	}
	else{
		echo $html;
	}
	exit();
}

if($action=="print_booking_15") //ISD-22-8874 by Md Mamun-13-05-2022
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$path=str_replace("'","",$path);
	if($path!="") $path=$path; else $path="../../";

	// echo $cbo_fabric_source;die; show_yarn_rate


	$imge_arr=return_library_array( "SELECT master_tble_id,image_location from common_photo_library where form_name='company_details' or form_name='knit_order_entry' and file_type=1",'master_tble_id','image_location');
	$company_library=return_library_array( "SELECT id,company_name from lib_company where status_active=1 and is_deleted=0", "id", "company_name");
	$color_library=return_library_array( "SELECT id,color_name from lib_color", "id", "color_name");
	$supplier_name_arr=return_library_array( "SELECT id,supplier_name from lib_supplier  where status_active=1 and is_deleted=0",'id','supplier_name');
	$supplier_address_arr=return_library_array( "SELECT id,address_1 from lib_supplier  where status_active=1 and is_deleted=0",'id','address_1');
	$marchentrArr = return_library_array("SELECT id,team_member_name from lib_mkt_team_member_info  where status_active=1 and is_deleted=0","id","team_member_name");
	$buyer_name_arr=return_library_array("SELECT id,buyer_name from lib_buyer  where status_active=1 and is_deleted=0",'id','buyer_name');

	$nameArray_approved=sql_select("SELECT max(b.approved_no) as approved_no,a.is_approved, count(b.id) as revised_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 group by a.is_approved");
	$nameArray_approved=sql_select("select max(b.approved_no) as approved_no,a.is_approved, count(b.id) as revised_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 group by a.is_approved");
	list($nameArray_approved_row)=$nameArray_approved;
	$nameArray_approved_date=sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='".$nameArray_approved_row[csf('approved_no')]."'");
	list($nameArray_approved_date_row)=$nameArray_approved_date;
	$nameArray_approved_comments=sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='".$nameArray_approved_row[csf('approved_no')]."'");
	list($nameArray_approved_comments_row)=$nameArray_approved_comments;

	$job_po_arr=array();
	$ref_no='';$job_no_aarr='';
	$nameArray_per_job=sql_select("SELECT  a.job_no, a.style_ref_no, b.po_break_down_id, c.po_number, c.grouping from wo_po_details_master a, wo_booking_dtls b, wo_po_break_down c where c.id=b.po_break_down_id and a.job_no=b.job_no and  a.job_no=c.job_no_mst and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by a.job_no,a.style_ref_no,b.po_break_down_id,c.grouping,c.po_number");

	

	foreach ($nameArray_per_job as $row_per_job)
	{
		$job_no_aarr.="'".$row_per_job[csf('job_no')]."'".',';
		$all_po_id_arr[$row_per_job[csf('po_break_down_id')]]=$row_per_job[csf('po_break_down_id')];
		$job_po_arr[$row_per_job[csf('job_no')]].=$row_per_job[csf('po_number')].',';
		if($ref_no=='') $ref_no=$row_per_job[csf('grouping')]; else $ref_no.=",".$row_per_job[csf('grouping')];
		
		$job_no_allArr.=$row_per_job[csf('job_no')].',';
	}
	
	$job_no_all=rtrim($job_no_allArr,',');
	$job_no_Arr=array_unique(explode(",",$job_no_all));

	$job_nos=rtrim($job_no_aarr,',');
	$txt_order_no_id=implode(",",$all_po_id_arr);
	$job_nos=implode(",",array_unique(explode(",",$job_nos)));

	$ref_nos=implode(",",array_unique(explode(",",$ref_no)));

	$job_data_arr=array(); 
	$nameArray_buyer=sql_select( "SELECT a.style_ref_no, a.style_description, a.job_no, a.style_owner, a.buyer_name, a.dealing_marchant, a.season, a.season_matrix, a.total_set_qnty, a.product_dept, a.product_code, a.pro_sub_dep, a.gmts_item_id, a.order_repeat_no, a.qlty_label from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0 and a.job_no in(".$job_nos.") order by a.job_no ");
	
	foreach ($nameArray_buyer as $result_buy)
	{
		$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
		$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
		$dealing_marchant.=$marchentrArr[$result_buy[csf('dealing_marchant')]].',';
	}
	
	$sqlColorSizeBreak="select job_no_mst, color_number_id, article_number from wo_po_color_size_breakdown where job_no_mst in(".$job_nos.") and status_active =1 and is_deleted=0";
	$sqlColorSizeBreakArr=sql_select($sqlColorSizeBreak); 
	
	$artNoArr=array();
	foreach ($sqlColorSizeBreakArr as $czrow)
	{
		if($artNoArr[$czrow[csf('job_no_mst')]][$czrow[csf('color_number_id')]]['artno']=="")
			$artNoArr[$czrow[csf('job_no_mst')]][$czrow[csf('color_number_id')]]['artno']=$czrow[csf('article_number')];
		else
			$artNoArr[$czrow[csf('job_no_mst')]][$czrow[csf('color_number_id')]]['artno'].=','.$czrow[csf('article_number')];
	}
	unset($sqlColorSizeBreakArr);

	$dealing_marchant=rtrim($dealing_marchant,',');
	$dealing_marchants=implode(",",array_unique(explode(",",$dealing_marchant)));
 	$nameArray=sql_select( "SELECT a.buyer_id, a.booking_no, a.booking_date, a.supplier_id, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.fabric_source, a.remarks, a.pay_mode, a.fabric_composition, a.booking_percent, a.is_approved,a.item_category,a.uom from wo_booking_mst a where  a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0");

	

 	foreach ($nameArray as $result_job)
 	{
 		$booking_date=$result_job[csf('booking_date')];
 		$buyer_id=$result_job[csf('buyer_id')];
 		$currency_id=$result_job[csf('currency_id')];
 		$attention=$result_job[csf('attention')];
 		$delivery_date=$result_job[csf('delivery_date')];
 		$supplier_id=$result_job[csf('supplier_id')];
 		$remarks=$result_job[csf('remarks')];
 		$payMode=$result_job[csf('pay_mode')];
 		$booking_percent=$result_job[csf('booking_percent')];
		$is_approved=$result_job[csf('is_approved')];
		$item=$result_job[csf('item_category')];
		$uom=$result_job[csf('uom')];
 	}

 	$lapdip_no_sql=sql_select("SELECT job_no_mst, lapdip_no,color_name_id from wo_po_lapdip_approval_info where  job_no_mst in ($job_nos) and status_active = 1 and approval_status = 3 ");

	// print_r($lapdip_no_sql);die;

 	foreach($lapdip_no_sql as $key=>$vals)
 	{
 		$lapdip_no_arr[$vals[csf("job_no_mst")]][$vals[csf("color_name_id")]]=$vals[csf("lapdip_no")];
 	}

 	$condition= new condition();
	if(str_replace("'","",$txt_order_no_id) !='')
	{
		$condition->po_id("in($txt_order_no_id)");
	}

	$condition->init();
	$fabric= new fabric($condition);
	$fabric_costing_arr2=$fabric->getAmountArray_by_job_knitAndwoven_greyAndfinish();
	$fabric_qty_arr=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$fabric_amount_arr=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
	$fab_qnty_arr=$fabric->getQtyArray_by_JobFabricIdItemBobyPartGmtsColorGsmDia_greyAndfinish();
	ob_start();
	?>
	<style>

		@media print
		{
			.page-break { height:0; page-break-before:always; margin:0; border-top:none; }
		}
		body, p, span, td, a {font-size:10pt;font-family: Arial;}
		body{margin-left:2em; margin-right:2em; font-family: "Arial Narrow", Arial, sans-serif;}
	</style>
  <div style="width:1310px" align="center">
		<table width="100%" cellpadding="0" cellspacing="0" style="border:0px solid black" >
			<tr>
				<td width="100">
					<img  src='<?=$path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
				</td>
				<td width="1250">
					<table width="100%" cellpadding="0" cellspacing="0"  border="0" >
						<tr>
							<td align="center"><?=$company_library[$cbo_company_name]; ?></td>
							<td rowspan="3" width="250">
								<span><b> Booking No:&nbsp;&nbsp;<?=trim($txt_booking_no,"'"); ?></b></span><br/>
								<span><b> Booking Date :&nbsp;&nbsp;<?=change_date_format($booking_date); ?></b></span><br/>
								 <?
								if($nameArray_approved_row[csf('approved_no')]==1 && $nameArray_approved_row[csf('is_approved')]==0){
									?>
                                    <b> Revised No :  <?=$nameArray_approved_row[csf('revised_no')]; ?></b>
                                      <br/>
                                      Approved Date: <?=$nameArray_approved_date_row[csf('approved_date')]; ?>
                                    <?

								}
								 if($nameArray_approved_row[csf('approved_no')]>1 && $nameArray_approved_row[csf('is_approved')]==0)
								 {
								 ?>
								 <b> Revised No: <?=$nameArray_approved_row[csf('revised_no')];?></b>
                                  <br/>
								  Approved Date: <?=$nameArray_approved_date_row[csf('approved_date')]; ?>
								  <?
								 }
							  	?>
                                <?
                                if($nameArray_approved_row[csf('approved_no')]>1 && ($nameArray_approved_row[csf('is_approved')]==1 || $nameArray_approved_row[csf('is_approved')]==3))
								 {
								 ?>
								 <b> Revised No: <?=$nameArray_approved_row[csf('revised_no')]-1;?></b>
                                  <br/>
								  Approved Date: <?=$nameArray_approved_date_row[csf('approved_date')]; ?>
								  <?
								 }
							  	?>
							</td>
						</tr>
						<tr>
							<td align="center">
								<?
								$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");

								if($txt_job_no!="")
								{
									$location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'");
								}
								else
								{
									$location="";
								}
								foreach ($nameArray as $result)
								{
									$email=$result[csf('email')];
									$city=$result[csf('city')];

									?>
									Email Address: <?=$email;?>
									Website: <? echo $result[csf('website')]; ?>
									<?
								}
								?>
							</td>
						</tr>
						<tr>
							<td align="center">
								<strong><? if($report_title !=""){ echo $report_title.'-'.$fabric_source[$cbo_fabric_source];}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if($is_approved==1){ echo "(Approved)";} else if($is_approved==3){ echo "(Partial Approved)";} else{echo "";}; ?> </font></strong><!--ISD-22-05697 by Kausar-->
							</td>
						</tr>
					</table>
				</td>
			</tr>
		</table>
		<table width="100%" style="border:0px solid black;table-layout: fixed;" >
			<tr>
				<td width="200"><span><b>To </b></span></td>
				<td width="280">&nbsp;<span></span></td>
				<td width="200"><span><b>Buyer</b></span></td>
				<td width="230"><span> :&nbsp;<b><? echo $buyer_name_arr[$buyer_id]; ?></b></span></td>
			</tr>
			<tr>
				<td width="200"><b>Supplier Name</b>   </td>
				<td width="280">:&nbsp;
					<?
					if($payMode==5 || $payMode==3){
						echo $company_library[$supplier_id];
						$suplier_address=$city.','.$email;
					}
					else{
						echo $supplier_name_arr[$supplier_id];
						$suplier_address=$supplier_address_arr[$supplier_id];
					}
					?>    </td>
					<td width="200"><b>Dealing Marchant</b></td>
					<td width="" colspan="2">:&nbsp;<?=$dealing_marchants;?></td>
			</tr>
			<tr>
				<td width="200"><b>Address</b></td>
				<td width="280">:&nbsp;<?=$suplier_address; ?></td>
				<td width="200"><b>Currency </b>   </td>
				<td width="230">:&nbsp;
					<?=$currency[$currency_id]; ?>
				</td>
			</tr>
			<tr>
				<td width="200"><b>Attention</b></td>
				<td  width="280">:&nbsp;<?=$attention; ?></td>
				<td width="200"><b>Fabric Nature</b></td>
				<td  width="280">:&nbsp;<? echo $item_category[$item];?>(<? echo $unit_of_measurement[$uom]?>)</td>
				
			</tr>
			<tr>
				<td width="200"><b>Delivery Date</b></td>
				<td width="280">:&nbsp;<?=change_date_format($delivery_date); ?></td>
				<td width="200"><b>Internal Ref. No </b>   </td>
				<td colspan="2">:&nbsp;
					<?=$ref_nos; ?>
				</td>
			</tr>
			<tr>
				<td width="200"><b>Pay Mode</b></td>
				<td width="280">:&nbsp;<?php echo $pay_mode[$payMode]; ?>
				<td width="200"><b>Remark</b></td>
				<td colspan="2">:&nbsp;<?=$remarks;?></td>
			</tr>
	    </table>
	    <?
		// and a.job_no='CTL-22-02031'
		$costing_per_arr=return_library_array( "select job_no, costing_per from wo_pre_cost_mst where job_no in(".$job_nos.") ", "job_no","costing_per");
		$set_item_ratio_data=sql_select("SELECT id,set_item_ratio,gmts_item_id,job_no from wo_po_details_mas_set_details  where job_no in (".$job_nos.") ");

		foreach($set_item_ratio_data as $row){
			$set_item_ratio_arr[$row[csf("job_no")]][$row[csf("gmts_item_id")]]=$row[csf("set_item_ratio")];
		}

		$plan_cut_data =sql_select("select plan_cut_qnty,job_no_mst,po_break_down_id,item_number_id,color_number_id,size_number_id from wo_po_color_size_breakdown where job_no_mst in(".$job_nos.")   and status_active=1 ");

		foreach($plan_cut_data as $val){
			$plan_cut_arr[$val[csf("job_no_mst")]][$val[csf("po_break_down_id")]][$val[csf("item_number_id")]][$val[csf("color_number_id")]][$val[csf("size_number_id")]]+=$val[csf("plan_cut_qnty")];
		}

	    $color_wise_process_loss=sql_select("SELECT a.id,a.job_no, a.body_part_id, b.color_number_id, a.process_loss_method, b.process_loss_percent as loss,a.item_number_id,b.cons_pcs AS consdzn,b.requirment,b.po_break_down_id, a.gsm_weight as gsm,b.dia_width as dia,b.gmts_sizes FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b WHERE a.job_id=b.job_id and a.id=b.pre_cost_fabric_cost_dtls_id and  a.job_no in(".$job_nos.")  and a.STATUS_ACTIVE=1 and b.STATUS_ACTIVE=1  group by a.id,a.job_no, a.body_part_id, a.process_loss_method, b.color_number_id, b.process_loss_percent,a.item_number_id,b.po_break_down_id, a.gsm_weight,b.dia_width,b.gmts_sizes,b.cons_pcs,b.requirment");
		//echo "SELECT a.job_no, a.body_part_id, b.color_number_id, a.process_loss_method, b.process_loss_percent as loss, avg(b.cons_pcs) as consdzn FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and  a.job_no in(".$job_nos.") and b.process_loss_percent>0 group by a.job_no, a.body_part_id, a.process_loss_method, b.color_number_id, b.process_loss_percent";
		foreach($color_wise_process_loss as $val)
	    {
			$set_item_ratio=$set_item_ratio_arr[$val[csf("job_no")]][$val[csf("item_number_id")]];
			$costing_per=$costing_per_arr[$val[csf("job_no")]];			
			$plan_cut_qnty=$plan_cut_arr[$val[csf("job_no")]][$val[csf("po_break_down_id")]][$val[csf("item_number_id")]][$val[csf("color_number_id")]][$val[csf("gmts_sizes")]];
			
			// echo $plan_cut_qnty.'<br>';
			if($set_item_ratio==0 || $set_item_ratio=="") $set_item_ratio=1;
			$pcs_value=0;

			if($costing_per==1) $pcs_value=1*12*$set_item_ratio;
			else if($costing_per==2) $pcs_value=1*1*$set_item_ratio;
			else if($costing_per==3) $pcs_value=2*12*$set_item_ratio;
			else if($costing_per==4) $pcs_value=3*12*$set_item_ratio;
			else if($costing_per==5) $pcs_value=4*12*$set_item_ratio;
			if($val[csf("loss")]>0)
			{ 
				$loss_arr[$val[csf("job_no")]][$val[csf("id")]][$val[csf("item_number_id")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['loss']=$val[csf("loss")];
			}			
				$loss_arr[$val[csf("job_no")]][$val[csf("id")]][$val[csf("item_number_id")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['consdzn']=$val[csf("consdzn")];
	    }

	    $sql_booking="SELECT a.job_no, a.id as fabric_cost_dtls_id, a.body_part_id, a.color_type_id as c_type, a.construction, a.composition, a.gsm_weight as gsm, a.avg_finish_cons, d.process_loss_percent, d.dia_width as dia, a.uom, (d.fin_fab_qnty) as fin_fab_qntys,(d.adjust_qty) as adjust_qty, (d.grey_fab_qnty) as grey_fab_qntys, (d.rate) as rates, (d.amount) as amounts, c.style_ref_no, c.job_no_prefix_num, d.fabric_color_id as fab_color, d.gmts_color_id as gmt_color,a.item_number_id
	    FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d, wo_po_details_master c
	    WHERE a.job_no=d.job_no and a.id=d.pre_cost_fabric_cost_dtls_id  and a.job_id=c.id  and d.job_no=c.job_no
	    and d.booking_no =$txt_booking_no and d.job_no in(".$job_nos.") and d.status_active=1 and d.is_deleted=0 and a.status_active=1 and a.is_deleted=0 and c.is_deleted=0
	    order by a.job_no,d.fabric_color_id,a.item_number_id ";
		//echo $sql_booking;die;
		
		$result_set=sql_select($sql_booking);
		foreach( $result_set as $row)
		{
			$fab_dtls_idArr[$row[csf("fabric_cost_dtls_id")]]=$row[csf("fabric_cost_dtls_id")];
		}
		
		$color_wise_avg=sql_select("SELECT a.id as fab_dtls_id,a.job_no, a.body_part_id, b.color_number_id, (b.cons_pcs) as consdzn FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b WHERE a.job_id=b.job_id and a.id=b.pre_cost_fabric_cost_dtls_id  and b.cons_pcs>0 and  a.job_no in(".$job_nos.") and a.id in(".implode(",",$fab_dtls_idArr).")  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 ");
		 
		
	    $color_chkArr=array();
	    // $k=1;
	    foreach($color_wise_avg as $val)
	    {
			$avg_cons_arr[$val[csf("job_no")]][$val[csf("fab_dtls_id")]][$val[csf("color_number_id")]]['consdzn']+=$val[csf("consdzn")];
			$colorstring=$val[csf("job_no")].$val[csf("fab_dtls_id")].$val[csf("color_number_id")];
			$avg_cons_arr[$val[csf("job_no")]][$val[csf("fab_dtls_id")]][$val[csf("color_number_id")]]['color_count']+=1;
		    // $color_chkArr[$colorstring]=$colorstring;
		    // $k++;
	    }
		unset($color_wise_avg);
	 	//print_r($avg_cons_arr);
 
	    foreach( $result_set as $row)
	    {
	    	$body_part_id=$body_part[$row[csf("body_part_id")]];
	    	$uom_data_arr[$row[csf("uom")]]=$unit_of_measurement[$row[csf("uom")]];
	    	$construction=$row[csf("construction")];
	    	$compositions= $row[csf("composition")];
	    	$item_desc=$row[csf("construction")].','.$compositions;

	    	$process_loss=$loss_arr[$row[csf("job_no")]][$row[csf("fabric_cost_dtls_id")]][$row[csf("item_number_id")]][$row[csf("body_part_id")]][$row[csf("gmt_color")]]['loss'];
	    	$process_loss_method=$loss_arr[$row[csf("job_no")]][$row[csf("fabric_cost_dtls_id")]][$row[csf("item_number_id")]][$row[csf("body_part_id")]][$row[csf("gmt_color")]]['loss_method'];
			$fabQnty=$fab_qnty_arr['knit']['finish'][$row[csf("job_no")]][$row[csf("fabric_cost_dtls_id")]][$row[csf("item_number_id")]][$row[csf("body_part_id")]][$row[csf("gmt_color")]][$row[csf("gsm")]][$row[csf("dia")]];
			
			if($process_loss=='') $process_loss=0;else $process_loss=$process_loss;
			if($process_loss_method=='') $process_loss_method=0;else $process_loss_method=$process_loss_method;
			//$avgfincons=$loss_arr[$row[csf("job_no")]][$row[csf("body_part_id")]][$row[csf("gmt_color")]]['consdzn'];
			$avgfincons=$avg_cons_arr[$row[csf("job_no")]][$row[csf("fabric_cost_dtls_id")]][$row[csf("gmt_color")]]['consdzn']/$avg_cons_arr[$row[csf("job_no")]][$row[csf("fabric_cost_dtls_id")]][$row[csf("gmt_color")]]['color_count'];
			//echo $avg_cons_arr[$row[csf("job_no")]][$row[csf("fabric_cost_dtls_id")]][$row[csf("gmt_color")]]['consdzn'].'='.$avg_cons_arr[$row[csf("job_no")]][$row[csf("fabric_cost_dtls_id")]][$row[csf("gmt_color")]]['color_count'].'<br>';

			//$fabric_detail_arr[$row[csf("job_no")]][$row[csf("gmt_color")]][$row[csf("fab_color")]][$body_part_id][$item_desc]['gsm']=$row[csf("gsm")];
			//$fabric_detail_arr[$row[csf("job_no")]][$row[csf("gmt_color")]][$row[csf("fab_color")]][$body_part_id][$item_desc]['dia']=$row[csf("dia")];
			$fabric_detail_arr[$row[csf("job_no")]][$row[csf("gmt_color")]][$row[csf("fab_color")]][$row[csf("item_number_id")]][$row[csf("body_part_id")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]]['c_type']=$row[csf("c_type")];
	    	$fabric_detail_arr[$row[csf("job_no")]][$row[csf("gmt_color")]][$row[csf("fab_color")]][$row[csf("item_number_id")]][$row[csf("body_part_id")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]]['uom']=$row[csf("uom")];
	    	$fabric_detail_arr[$row[csf("job_no")]][$row[csf("gmt_color")]][$row[csf("fab_color")]][$row[csf("item_number_id")]][$row[csf("body_part_id")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]]['style_ref_no']=$row[csf("style_ref_no")];
	    	$fabric_detail_arr[$row[csf("job_no")]][$row[csf("gmt_color")]][$row[csf("fab_color")]][$row[csf("item_number_id")]][$row[csf("body_part_id")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]]['job_prefix']=$row[csf("job_no_prefix_num")];
	    	$fabric_detail_arr[$row[csf("job_no")]][$row[csf("gmt_color")]][$row[csf("fab_color")]][$row[csf("item_number_id")]][$row[csf("body_part_id")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]]['full_job']=$row[csf("job_no")];
	    	$fabric_detail_arr[$row[csf("job_no")]][$row[csf("gmt_color")]][$row[csf("fab_color")]][$row[csf("item_number_id")]][$row[csf("body_part_id")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]]['style_ref_no']=$row[csf("style_ref_no")];

	    	// $fabric_detail_arr[$row[csf("job_no")]][$row[csf("gmt_color")]][$row[csf("fab_color")]][$row[csf("body_part_id")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]]['fin_qty']+=$row[csf("fin_fab_qntys")]+$row[csf("adjust_qty")];
			 $fabric_detail_arr[$row[csf("job_no")]][$row[csf("gmt_color")]][$row[csf("fab_color")]][$row[csf("item_number_id")]][$row[csf("body_part_id")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]]['fin_qty']=$fabQnty;

	    	$fabric_detail_arr[$row[csf("job_no")]][$row[csf("gmt_color")]][$row[csf("fab_color")]][$row[csf("item_number_id")]][$row[csf("body_part_id")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]]['grey_qty']+=$row[csf("grey_fab_qntys")];
			$fabric_detail_arr[$row[csf("job_no")]][$row[csf("gmt_color")]][$row[csf("fab_color")]][$row[csf("item_number_id")]][$row[csf("body_part_id")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]]['fin_fab_qntys']+=$row[csf("fin_fab_qntys")];
	    	$fabric_detail_arr[$row[csf("job_no")]][$row[csf("gmt_color")]][$row[csf("fab_color")]][$row[csf("item_number_id")]][$row[csf("body_part_id")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]]['amounts']+=$row[csf("amounts")];
	    	$fabric_detail_arr[$row[csf("job_no")]][$row[csf("gmt_color")]][$row[csf("fab_color")]][$row[csf("item_number_id")]][$row[csf("body_part_id")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]]['rates']=$row[csf("amounts")]/$row[csf("grey_fab_qntys")];
	    	$fabric_detail_arr[$row[csf("job_no")]][$row[csf("gmt_color")]][$row[csf("fab_color")]][$row[csf("item_number_id")]][$row[csf("body_part_id")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]]['p_loss']=$process_loss;
	    	$fabric_detail_arr[$row[csf("job_no")]][$row[csf("gmt_color")]][$row[csf("fab_color")]][$row[csf("item_number_id")]][$row[csf("body_part_id")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]]['p_loss_method']=$process_loss_method;
	    	$fabric_detail_arr[$row[csf("job_no")]][$row[csf("gmt_color")]][$row[csf("fab_color")]][$row[csf("item_number_id")]][$row[csf("body_part_id")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]]['fabric_cost_dtls_id']=$row[csf("fabric_cost_dtls_id")];
			$fabric_detail_arr[$row[csf("job_no")]][$row[csf("gmt_color")]][$row[csf("fab_color")]][$row[csf("item_number_id")]][$row[csf("body_part_id")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]]['process_losss']+=$row[csf("process_loss_percent")];
			$fabric_detail_arr[$row[csf("job_no")]][$row[csf("gmt_color")]][$row[csf("fab_color")]][$row[csf("item_number_id")]][$row[csf("body_part_id")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]]['adjust_qty']+=$row[csf("adjust_qty")];
			$fabric_detail_arr[$row[csf("job_no")]][$row[csf("gmt_color")]][$row[csf("fab_color")]][$row[csf("item_number_id")]][$row[csf("body_part_id")]][$item_desc][$row[csf("gsm")]][$row[csf("dia")]]['avgfincons']=$avgfincons;

	    }
	    $fab_row_span_arr=array();
	    foreach($fabric_detail_arr as $job_key=>$job_data)
	    {
	    	$desc_rowspan=0;
	    	foreach($job_data as $gmt_color_key=>$gmt_color_data)
	    	{
	    		foreach($gmt_color_data as $fab_color_key=>$fab_color_data)
	    		{
					foreach($fab_color_data as $item_key=>$item_data)
					{
						foreach($item_data as $bodypartid=>$bodypart_data)
						{
							foreach($bodypart_data as $desc_key=>$desData)
							{
								foreach($desData as $gsm=>$gsmdata)
								{
									foreach($gsmdata as $dia=>$val)
									{
										$desc_rowspan++;
									}
								}
							}
						}
					}
	    		}
	    	}
	    	$fab_row_span_arr[$job_key]=$desc_rowspan;
	    }
		?>
		<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >

			<tr>
				<th width="20" align="center" style="word-break: break-all;word-wrap: break-word;">SL</th>
				<th width="50" align="center" style="word-break: break-all;word-wrap: break-word;">Job No</th>
				<th width="80" align="center" style="word-break: break-all;word-wrap: break-word;">Style Ref</th>
                <th width="70" align="center" style="word-break: break-all;word-wrap: break-word;">Body Part</th>
				<th width="130" align="center" style="word-break: break-all;word-wrap: break-word;">Item Description</th>
				<th width="40" align="center" style="word-break: break-all;word-wrap: break-word;">GSM</th>
				<th width="40" align="center" style="word-break: break-all;word-wrap: break-word;">Fabric Dia</th>
				<th width="70" align="center" style="word-break: break-all;word-wrap: break-word;">Color Type</th>
                <th width="60" align="center" style="word-break: break-all;word-wrap: break-word;">Art. No</th>
				<th width="90" align="center" style="word-break: break-all;word-wrap: break-word;">Gmts Color</th>
				<th width="90" align="center" style="word-break: break-all;word-wrap: break-word;">Fabric Color</th>
                <th width="50" align="center" style="word-break: break-all;word-wrap: break-word;">Avg. Fin. Cons[DZN]</th>
				<th width="50" align="center" style="word-break: break-all;word-wrap: break-word;">Lab Dip No</th>
				<th width="40" align="center" style="word-break: break-all;word-wrap: break-word;">UOM</th>
				<th width='60' align="center" style="word-break: break-all;word-wrap: break-word;">Finish Fab. Qty (Budget)</th>
				<th width='60' align="center" style="word-break: break-all;word-wrap: break-word;">Finish Fab. Qty (Booking)</th>
				<th width='50' align="center" style="word-break: break-all;word-wrap: break-word;">Process Loss</th>
				<th width='60' align="center" style="word-break: break-all;word-wrap: break-word;">Grey Fab. Qty[W/O]</th>
				<th width='60' align="center" style="word-break: break-all;word-wrap: break-word;">Adj. Qty</th>
				<th width='60' align="center" style="word-break: break-all;word-wrap: break-word;">Grey Balance Qty</th>
				<th width='50' align="center" style="word-break: break-all;word-wrap: break-word;">Avg Rate</th>
				<th align="center" style="word-break: break-all;word-wrap: break-word;">Amount</th>
			</tr>
			<?
 			$k=$p=1;$total_fin_qty=$total_grey_qty=$total_adjust_qty=$total_grey_adjust_balance=$total_amount=0;

			foreach($fabric_detail_arr as $job_key=>$job_data)
			{
				$y=1;
				foreach($job_data as $gmt_color_key=>$gmt_color_data)
				{
					foreach($gmt_color_data as $fab_color_key=>$fab_color_data)
					{
						foreach($fab_color_data as $item_key=>$item_data)
					{
						
						foreach($item_data as $bodypart_key=>$bodypart_data)
						{
							foreach($bodypart_data as $desc_key=>$desData)
							{
								foreach($desData as $gsm=>$gsmdata)
								{
									foreach($gsmdata as $dia=>$val)
									{
										$po_nos=rtrim($job_po_arr[$job_key],',');
										$po_nos=implode(",",array_unique(explode(",",$po_nos)));
										$fab_row_span=$fab_row_span_arr[$job_key];
										$p_loss_method=$val['p_loss_method'];
										$process_loss=$val['p_loss'];
										$labtest_no=$lab_dip_arr[$job_key]['labtest_no'];
										if($process_loss) $process_loss=$process_loss;else $process_loss=0;
										//  $fin_qty=$val['fin_qty'];
										$diaWidth=$dia;
										if($diaWidth!='') $diaWidth=$diaWidth;
										
										$artnoStr="";
										$artnoStr=implode(",",array_filter(array_unique(explode(",",$artNoArr[$job_key][$gmt_color_key]['artno']))));
										
										$fabric_cost_dtls_id=$val['fabric_cost_dtls_id'];
												/*if($p_loss_method==1) //markup
												{
				
													$fin_qty=$val['fin_qty']-(($val['fin_qty']*$process_loss)/(100+$process_loss));
												}
												else if($p_loss_method==2) //margin
												{
													$fin_qty=$val['fin_qty']-(($val['fin_qty']*$process_loss)/100);
												}
												else $fin_qty=$val['fin_qty'];*/ //Charka
												$fin_qty=$val['fin_qty'];
										?>
										<tr>
											<?
											if($y==1)
											{
												?>
												<td style="word-break: break-all;word-wrap: break-word;" rowspan="<?=$fab_row_span; ?>"><?=$p; ?></td>
												<td style="word-break: break-all;word-wrap: break-word;" align="center" rowspan="<?=$fab_row_span;?>"><?=$val['job_prefix']; ?></td>
												<td style="word-break: break-all;word-wrap: break-word;" rowspan="<?=$fab_row_span;?>"><?=$val['style_ref_no']; ?>&nbsp;</td>
												<?
											}
											$labdipno="";
											if($lapdip_no_arr[$val['full_job']][$fab_color_key]!="") $labdipno=$lapdip_no_arr[$val['full_job']][$fab_color_key]; //ISD-23-14129
											//else $labdipno=$lapdip_no_arr[$val['full_job']][$gmt_color_key];
											?>
											<td style="word-break: break-all;word-wrap: break-word;"><?=$body_part[$bodypart_key]; ?>&nbsp;</td>
											<td style="word-break: break-all;word-wrap: break-word;"><?=$desc_key; ?>&nbsp;</td>
											<td style="word-break: break-all;word-wrap: break-word;"><?=$gsm; ?>&nbsp;</td>
											<td style="word-break: break-all;word-wrap: break-word;"><?=$diaWidth.$fabric_typee[$dia]; ?>&nbsp;</td>
											<td style="word-break: break-all;word-wrap: break-word;"><?=$color_type[$val[('c_type')]]; ?>&nbsp;</td>
											<td style="word-break: break-all;"><?=$artnoStr; ?>&nbsp;</td>
											<td style="word-break: break-all;word-wrap: break-word;"><?=$color_library[$gmt_color_key]; ?>&nbsp;</td>
											<td style="word-break: break-all;word-wrap: break-word;"><?=$color_library[$fab_color_key]; ?>&nbsp;</td>
											<td style="word-break: break-all;" align="right"><?=number_format($val['avgfincons'],2); ?>&nbsp;</td>
											<td style="word-break: break-all;word-wrap: break-word;" title="<?=$lapdip_no_arr[$val['full_job']][$gmt_color_key].'=='; ?>"><?=$labdipno; ?>&nbsp;</td>
											<td  style="word-break: break-all;word-wrap: break-word;"><?=$unit_of_measurement[$val['uom']]; ?>&nbsp;</td>
											<td style="word-break: break-all;word-wrap: break-word;" align="right" title="(Markup/Margin Method) Process Loss=<?=$process_loss;?>,Fin Qty=<?=$fin_qty;?>"><?=number_format($fin_qty,2); //number_format($fin_qty,2); ?>&nbsp;</td>
											<td style="word-break: break-all;word-wrap: break-word;" align="right"  ><?=number_format($val['fin_fab_qntys'],2);  //number_format($fin_qty,2); ?>&nbsp;</td>
											<td style="word-break: break-all;word-wrap: break-word;" align="right"><?=number_format($process_loss,2); ?>&nbsp;</td>
											<td style="word-break: break-all;word-wrap: break-word;" align="right"><?=number_format($val['grey_qty'],2); ?>&nbsp;</td>
											<td style="word-break: break-all;word-wrap: break-word;" align="right"><?=number_format($val['adjust_qty'],2); ?>&nbsp;</td>
											<td style="word-break: break-all;word-wrap: break-word;" align="right"><?=number_format($val['grey_qty']-$val['adjust_qty'],2); ?>&nbsp;</td>
											<td style="word-break: break-all;word-wrap: break-word;" align="right"><?=number_format($val['rates'],2); ?>&nbsp;</td>
											<td style="word-break: break-all;word-wrap: break-word;" align="right"><?=number_format($val['amounts'],2); ?>&nbsp;</td>
										</tr>
										<?
										$k++;$y++;
										$total_fin_qty+=$fin_qty;
										$total_grey_qty+=$val['grey_qty'];
										$total_fin_fab_qntys+=$val['fin_fab_qntys'];
										$total_adjust_qty+=$val['adjust_qty'];
										$total_grey_adjust_balance+=$val['grey_qty']-$val['adjust_qty'];
										$total_amount+=$val['amounts'];
									}
								}
							}}
						}
			        }
		        }
				$p++;
	        }
			?>
			<tfoot>
				<tr>
					<th colspan="14" align="right"> Total </th>
					<th align="right"> <?=number_format($total_fin_qty,2); ?> </th>
					<th align="right"> <?=number_format($total_fin_fab_qntys,2); ?> </th>
					<th></th>
					<th align="right"> <?=number_format($total_grey_qty,2); ?> </th>
					<th align="right"> <?=number_format($total_adjust_qty,2); ?> </th>
					<th align="right"> <?=number_format($total_grey_adjust_balance,2); ?> </th>
					<th align="right"> <? //=number_format($total_fin_qty,2); ?> </th>
					<th align="right"> <?=number_format($total_amount,2); ?> </th>
				</tr>
			</tfoot>
		</table>
		<?
    

	?>
	<br>




	<?
        $size_lib_arr = return_library_array("select id,size_name from  lib_size ","id","size_name");
        $color_lib_arr = return_library_array("select id,color_name from  lib_color ","id","color_name");
        $sql_collar_cuff= "SELECT a.body_part_type, a.body_part_id, b.job_no, b.gmts_color_id, b.size_number_id, b.item_size, b.gmts_qty, b.excess_per, b.qty, b.po_break_down_id as po_id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in (".$job_nos.") and b.status_active=1 and b.is_deleted=0 order by b.id ASC" ;
       // echo $sql_collar_cuff;
        $sql_data_collar_cuff=sql_select($sql_collar_cuff);
        $body_part_color_arr=array(); $body_part_size_arr=array(); $body_part_color_size_arr=array(); $body_part_body_size_arr=array();
        foreach($sql_data_collar_cuff as $row)
        {
            $body_part_color_arr[$row[csf("body_part_type")]][$row[csf("body_part_id")]][$row[csf("job_no")]]['color'][$row[csf("gmts_color_id")]]=$row[csf("gmts_color_id")];
            $body_part_size_arr[$row[csf("body_part_type")]][$row[csf("body_part_id")]][$row[csf("job_no")]]['size'][$row[csf("size_number_id")]][$row[csf("item_size")]]=$row[csf("item_size")];
			 $body_part_gmts_size_arr[$row[csf("body_part_type")]][$row[csf("body_part_id")]][$row[csf("job_no")]]['size'][$row[csf("size_number_id")]]=$row[csf("size_number_id")];
            $body_part_body_size_arr[$row[csf("body_part_type")]][$row[csf("body_part_id")]][$row[csf("job_no")]]['item_size'][$row[csf("size_number_id")]]=$row[csf("item_size")];
            $body_part_color_size_arr[$row[csf("body_part_type")]][$row[csf("body_part_id")]][$row[csf("job_no")]][$row[csf("gmts_color_id")]][$row[csf("size_number_id")]][$row[csf("item_size")]]['qty']+=$row[csf("qty")];
			
			$body_part_color_size_arr[$row[csf("body_part_type")]][$row[csf("body_part_id")]][$row[csf("job_no")]][$row[csf("gmts_color_id")]][$row[csf("size_number_id")]]['gmtsqty']+=$row[csf("gmts_qty")];
			 $body_part_item_size_arr[$row[csf("body_part_type")]][$row[csf("body_part_id")]][$row[csf("job_no")]][$row[csf("size_number_id")]][$row[csf("item_size")]]=$row[csf("item_size")];
			   $body_part_excess_per_arr[$row[csf("body_part_type")]][$row[csf("body_part_id")]][$row[csf("job_no")]][$row[csf("gmts_color_id")]]['excess_per']=$row[csf("excess_per")];
        }

		foreach($body_part_color_arr as $body_type=>$body_data)
		{
			foreach($body_data as $body_id=>$jobdata)
			{
				foreach($jobdata as $job_no=>$data)
				{
					$count_collar_cuff=count($body_part_size_arr[$body_type][$body_id][$job_no]['size']);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;

					?>
					<div style="max-height:1330px; overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;">
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
						<tr>
							<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo "Job No:".$job_no.'; '.$body_part[$body_id]; ?> - Color Size Brakedown in Pcs.</b></td>
						</tr>
						<tr>
							<td width="100">Size</td>
								<?
								foreach($body_part_gmts_size_arr[$body_type][$body_id][$job_no]['size']  as $size_number_id)
								{
									?>
								<td align="center" style="border:1px solid black" colspan="<?=count($body_part_item_size_arr[$body_type][$body_id][$job_no][$size_number_id]);?>"><strong><? echo $size_lib_arr[$size_number_id];?></strong></td>
									<?
								}
								?>
							<td width="60" rowspan="2" align="center"><strong>Total</strong></td>
							<td rowspan="2" align="center"><strong>Extra %</strong></td>
						</tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_part[$body_id]; ?> Size</td>
                            <?
                            foreach($body_part_item_size_arr[$body_type][$body_id][$job_no]  as $size_number_id=>$size_data)
                            {
								 foreach($size_data  as $size_id=>$size_number)
                            {
								?>
                                <td align="center" style="border:1px solid black"><strong><? echo $size_number;?></strong></td>
                                <?
                            }}

                            $pre_size_total_arr=array();
                            foreach($data['color'] as $color_id=>$color_data)
                            {
								?>
								<tr>
									<td><? echo $color_library[$color_id]; ?></td>
									<? $pre_color_total_collar=0;  $pre_color_total_gmtsqty=0;
										foreach($body_part_size_arr[$body_type][$body_id][$job_no]['size']  as $size_number_id=>$size_data)
										{
											foreach($size_data  as $size_id)
										{
											$size_qty=0; $gmtssize_qty=0;
											$size_qty=$body_part_color_size_arr[$body_type][$body_id][$job_no][$color_id][$size_number_id][$size_id]['qty'];
											
											$gmtssize_qty=$body_part_color_size_arr[$body_type][$body_id][$job_no][$color_id][$size_number_id]['gmtsqty'];
											$pre_size_total_arr[$size_number_id][$size_id]+=$size_qty;
											$pre_color_total_collar+=$size_qty;
											$pre_color_total_gmtsqty+=$gmtssize_qty;
											?>
											<td align="center" style="border:1px solid black"><? echo number_format($size_qty); ?></td>
											<?
										}}
										$excess_per=$body_part_excess_per_arr[$body_type][$body_id][$job_no][$color_id]['excess_per'];
										$color_gmts_pcs=0;
										if($body_type==50) $color_gmts_pcs=(($pre_color_total_collar/2)-$pre_color_total_gmtsqty); else $color_gmts_pcs=$pre_color_total_collar-$pre_color_total_gmtsqty;
									?>
                                    <td align="center"><? echo number_format($pre_color_total_collar); ?></td>
                                    <td align="center"><? echo number_format($excess_per); ;//number_format((($color_gmts_pcs)/$pre_color_total_gmtsqty)*100,2); ?></td>
                                </tr>
                                <?
                                $pre_grand_collar_ex_per+=$collar_ex_per;
                                $pre_grand_tot_collar+=$pre_color_total_collar;
                                $pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $gmtsSize=>$size_data)
                                {
									 foreach($size_data  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
                                }}
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo fn_number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>
                <br/>
                <?
				}
            }
        }
		//////////////////



	
	$cos_per_arr=$condition->getCostingPerArr();
	$yarn= new yarn($condition);
	$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
 	$yarn_count_arr=return_library_array( "SELECT id,yarn_count from lib_yarn_count",'id','yarn_count');
 	$po_qnty_tot=return_field_value("sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");

 	if($db_type==0)
 	{
 		$job_listagg=" group_concat(a.job_no) as job_no";
 	}
 	else
 	{

 		$job_listagg=" listagg(cast(a.job_no as varchar2(4000)),',') within group (order by a.job_no) as job_no";
 	}
	 
		$yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.count_id, a.copm_one_id, a.percent_one, a.color, a.type_id,sum(a.cons_qnty) as yarn_required,a.rate,sum(b.grey_fab_qnty*a.cons_ratio/100) as booking_qty, a.certification	from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.booking_type=1 and a.job_no in ($job_nos) and b.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 and  b.status_active=1 and b.is_deleted=0  group by a.count_id,a.copm_one_id,a.percent_one,a.color,a.type_id,a.rate, a.certification");
	?>
	<br/>
	<br/>
	<br/>
	<table style="margin-top: 10px;" class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >

		<tr align="center">
             <td colspan="7"><b>Yarn Required Summary (Pre Cost) </b></td>
        </tr>

        <tr align="center">
        	<td width="25" >Sl</td>
        	<td width="250" >Yarn Description</td>
			<td width="150" >Certification</td>
        	<td width="60" >Brand</td>
        	<td width="60" >Lot</td>
        	<td width="50" >Rate</td>
        	<td width="120" >Cons for Dzn Gmts</td>
        	<td width="110" >Total (KG)</td>
			<td width="110" >Booking Qty</td>
        </tr>

        <?
		$i=0;
		$total_yarn=0;$total_booking_qty=0;
		foreach($yarn_sql_array  as $row)
        {

			$i++;
			$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
			$rowcons_Amt = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];
			$booing_qnty=$row[csf("booking_qty")];

			$rate=$rowcons_Amt/$rowcons_qnty;
			$rowcons_qnty =($rowcons_qnty/100)*$booking_percent;
			$job_no=$row[csf("job_no")];
			$cos_per_value=0;
			//foreach(explode(",", $job_no) as $keys=>$vals)
			foreach($job_no_Arr as $keys=>$vals)
			{
				$cos_per_value=$cos_per_arr[$vals];
			}
			?>
            <tr align="center">
            	<td width="25" style="word-wrap: break-word;word-break: break-all;"><? echo $i; ?></td>

            	<td width="250" style="word-wrap: break-word;word-break: break-all;" align="left">
            		<?
            		$yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
            		$yarn_des.=$color_library[$row[csf('color')]]." ";
            		$yarn_des.=$yarn_type[$row[csf('type_id')]];
            		echo $yarn_des;
            		?>
            	</td>
				<td width="150" style="word-wrap: break-word;word-break: break-all;"><? 
				echo $certification_arr[$row[csf('certification')]]; ?></td>
            	<td width="60" style="word-wrap: break-word;word-break: break-all;"></td>
            	<td width="60" style="word-wrap: break-word;word-break: break-all;"></td>
            	<td width="50" style="word-wrap: break-word;word-break: break-all;"><? echo number_format($row[csf('rate')],4);  $cos_per_arr[$job_no].' c'; ?></td>
            	<td width="120" style="word-wrap: break-word;word-break: break-all;"><? echo number_format(($rowcons_qnty/$po_qnty_tot)*$cos_per_value,4);?></td>
            	<td align="right" width="110" style="word-wrap: break-word;word-break: break-all;"><? echo number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td>
				<td align="right" width="110" style="word-wrap: break-word;word-break: break-all;"><? echo number_format($booing_qnty,2); $total_booking_qty+=$booing_qnty; ?></td>
            </tr>
            <?
		}
		?>
       <tr align="center">
	       	<td colspan="7" align="right">Total</td>
	       	<td align="right"><? echo number_format($total_yarn,2); ?></td>
			<td align="right"><? echo number_format($total_booking_qty,2); ?></td>
        </tr>
	</table>

	<br>
	<?
	$color_name_arr=return_library_array( "SELECT id,color_name from lib_color",'id','color_name');
	
	$all_jobs_id=$job_nos;
	$sql_stripe="SELECT c.id,c.job_no,c.composition,c.construction,c.body_part_id,c.gsm_weight,c.color_type_id,d.color_number_id as color_number_id,d.id as did,d.uom,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,c.uom as type_uom from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and d.job_no in($all_jobs_id)  and b.booking_no=$txt_booking_no  and c.color_type_id in (2,3,6) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and b.is_deleted=0  
	group by c.id,c.job_no,c.body_part_id,c.gsm_weight,c.color_type_id,d.color_number_id,d.uom,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,c.composition,c.construction,c.uom order by c.job_no,c.id,d.id ";
	//echo $sql_stripe;
		$result_data=sql_select($sql_stripe);
		foreach($result_data as $row)
		{
			$style_ref_no=$job_data_arr['style_ref_no'][$row[csf('job_no')]];
			if($row[csf('type_uom')]==12){
				$type_uom_arr[$row[csf('type_uom')]]='kg';
			}elseif($row[csf('type_uom')]==1){
				$type_uom_arr[$row[csf('type_uom')]]='pcs';
			}
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')].'*'.$row[csf('did')]]['type_uom']=$row[csf('type_uom')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')].'*'.$row[csf('did')]]['stripe_color']=$row[csf('stripe_color')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')].'*'.$row[csf('did')]]['measurement']=$row[csf('measurement')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')].'*'.$row[csf('did')]]['fabreqtotkg']+=$row[csf('fabreqtotkg')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')].'*'.$row[csf('did')]]['yarn_dyed']=$row[csf('yarn_dyed')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')].'*'.$row[csf('did')]]['fabric_description']=$row[csf('fabric_description')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')].'*'.$row[csf('did')]]['uom']=$row[csf('uom')];
		
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')].'*'.$row[csf('did')]]['style_ref_no']=$style_ref_no;

			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabric_description']=$row[csf('fabric_description')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['style_ref_no']=$style_ref_no;
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom']=$row[csf('uom')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
			//$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg']+=$row[csf('fabreqtotkg')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['type_uom']=$row[csf('type_uom')];
		}
	
 // print_r($type_uom_arr);

		foreach($type_uom_arr as $uom_id=>$uom_arr){
		?>
			

			<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
       		 <caption> <strong style="float:left"> Stripe Details (<?=$uom_arr;?>)</strong></caption>
      

            <tr>
                <th width="30"> SL</th>
                <th width="100">Job No</th>
				<th width="100">Body Part</th>
				<!-- <th width="100">Fab. Desc.</th> -->
                <th width="80">Fabric Color</th>
                <th width="70">Fabric Qty(<?=$uom_arr;?>)</th>
                <th width="70">Stripe Color</th>
                <th width="70">Stripe Measurement</th>
				<th  width="70">Stripe Uom</th>
                <th  width="70">Qty.(<?=$uom_arr;?>)</th>

				<th  width="70">Y/D Req.</th>
            </tr>
            <?
				$job_strip_color_rowspan=array();$fab_strip_color_rowspan=array();$color_strip_color_rowspan=array();
			  foreach($stripe_arr as $job_id=>$job_data)
			  {	 $job_row_span=0;
					 foreach($job_data as $body_id=>$body_data)
					 {
						   $fab_row_span=0;
						   foreach($body_data as $color_id=>$color_data)
						   {
								$color_row_span=0;
								foreach($color_data as $strip_color_id=>$color_val)
								{
									$job_row_span++;$fab_row_span++;$color_row_span++;

								}
								$job_strip_color_rowspan[$job_id]=$job_row_span;
								$fab_strip_color_rowspan[$job_id][$body_id]=$fab_row_span;
								$color_strip_color_rowspan[$job_id][$body_id][$color_id]=$color_row_span;
								$color_strip_color_qty_arr[$job_id][$body_id][$color_id]=$stripe_arr2[$job_id][$body_id][$color_id]['fabreqtotkg'];


						   }
					 }
			  }
			 // print_r($job_strip_color_rowspan);


			$i=1;$total_fab_qty=0;$total_fabreqtotkg=$total_color_qty=0;$fab_data_array=array();
            foreach($stripe_arr as $job_id=>$job_data)	{
			 $job_span=1;
			 foreach($job_data as $body_id=>$body_data)    {
			  $fab_span=1;
			   foreach($body_data as $color_id=>$color_data)  {
			     $color_span=1;
				foreach($color_data as $strip_color_key=>$color_val)   {
					//$rowspan=count($color_val['stripe_color']);
					$strip_color_str_arr=explode("*",$strip_color_key);
					$strip_color_id=$strip_color_str_arr[0];

					if($uom_id==$color_val['type_uom'])
					{
					?>
					<tr>
					<?

					if($job_span==1)
					{
					?>
                        <td align="center" rowspan="<? echo $job_strip_color_rowspan[$job_id];?>"> <? echo $i; ?></td>
                        <td align="center" title="<? echo $job_id;?>" rowspan="<? echo $job_strip_color_rowspan[$job_id];?>"> <? echo $job_id; ?></td>
						<?
					}
					if($fab_span==1)
					{
						?>
						<td align="center" rowspan="<? echo $fab_strip_color_rowspan[$job_id][$body_id];?>"> <? echo $body_part[$body_id]; ?></td>
						<!-- <td align="center" rowspan="<? echo $fab_strip_color_rowspan[$job_id][$body_id];?>"> <? //echo $color_val['fabric_description']; ?></td> -->
						<?
					}
					if($color_span==1)
					{
					$color_qty= $color_strip_color_qty_arr[$job_id][$body_id][$color_id];//$color_val['fabreqtotkg'];
					$total_color_qty+=$color_qty;
					?>
                        <td rowspan="<? echo $color_strip_color_rowspan[$job_id][$body_id][$color_id];?>" align="center"> <? echo $color_name_arr[$color_id]; ?></td>
                        <td rowspan="<? echo $color_strip_color_rowspan[$job_id][$body_id][$color_id];?>" align="center"> <? echo number_format($color_qty,2); ?></td>
					<?
					}

						?>
						<td align="center"><?  echo  $color_name_arr[$strip_color_id]; ?></td>
						<td align="center"> <? echo  number_format($color_val['measurement'],2); ?></td>
						<td align="center"> <? echo  $unit_of_measurement[$color_val['uom']]; ?></td>
						<td align="center" title="Stripe Measurement/Tot Stripe Measurement*Fabric Qty(KG)"> <? echo  number_format($color_val['fabreqtotkg'],2); ?></td>

						<td align="center"> <? echo  $yes_no[$color_val['yarn_dyed']]; ?></td>
					</tr>
						<?
					
						$total_fabreqtotkg+=$color_val['fabreqtotkg'];

					$job_span++;$fab_span++;$color_span++;
					}
				  }
				}
				$i++;
			}
			}
			?>
        <tfoot>
        <tr>
            <td align="right" colspan="4">Total </td>
            <td align="center"><? echo  number_format($total_color_qty,2); ?> </td>
            <td></td>
            <td></td>

            <td> </td>
			 <td align="center"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
			<td> </td>
        </tr>
        </tfoot>
   </table>
   <?}?>
   <br/>
    

    <table  style="margin-top: 5px;float: left;"    width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

		<tr>
			<td colspan="10" align="center">
				<strong>Comments</strong>
			</td>
		</tr>
		<tr>
			<td align="center"> SL </td>
			<td align="center" width="200"  style="word-wrap: break-word;word-break: break-all;"> PO NO </td>
			<td align="center"> Ship Date </td>
			<td align="center">BOM Qty</td>
			<td align="center"> Booking Qty </td>
			<td align="center"> Short Booking Qty </td>
			<td align="center"> Total Booking Qty </td>
			<td align="center"> Balance </td>
			<td align="center"> Comments </td>
		</tr>
		<?
		$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where status_active=1 and is_deleted=0 and id in(select po_break_down_id from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no=$txt_booking_no)",'id','po_number');
		$is_short_data=sql_select("SELECT a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0   and b.is_short =1 group by  a.id ");
		foreach($is_short_data as $vals)
		{
			$short_qty_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
		}

		$booking_data=sql_select("SELECT a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and  b.status_active=1 and b.is_deleted=0 and b.is_short !=1 and b.booking_type=1 group by  a.id  order by a.id");
		foreach($booking_data as $vals)
		{
			$booking_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
		}

		$po_date=return_library_array("select id,shipment_date from wo_po_break_down where status_active=1 and is_deleted=0",'id','shipment_date');

		$comments_data=sql_select("SELECT min(a.id) as ids,b.po_break_down_id as po_number,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,SUM(b.requirment) as precost_grey_qty FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
			WHERE a.job_no=b.job_no and
			a.id=b.pre_cost_fabric_cost_dtls_id
			and
			b.po_break_down_id=d.po_break_down_id and
			b.color_number_id=d.gmts_color_id and
			b.dia_width=d.dia_width and
			b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
			a.job_no=d.job_no and
			a.id=d.pre_cost_fabric_cost_dtls_id
			and
			d.booking_no =$txt_booking_no and
			d.job_no in($all_jobs_id) and

			d.status_active=1 and
			d.is_deleted=0 and
			b.cons>0
			group by b.po_break_down_id order by b.po_break_down_id");



		$job_no=$all_jobs_id;
		$condition= new condition();
		if(str_replace("'","",$job_no) !='')
		{
			$condition->job_no("in ($job_no)");
		}
		$condition->init();
		$fabric= new fabric($condition);
		$fabric_costing_qty_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish();

		$j=1;
		$total_bom=0;
		$total_book=0;
		$total_short=0;
		$total_short_full=0;
		$total_balance=0;
		foreach($comments_data as $val)
		{
			$po_id=$val[csf('po_number')];
			$woven_qty=array_sum($fabric_costing_qty_arr['woven']['grey'][$po_id]);
			$knit_qty=array_sum($fabric_costing_qty_arr['knit']['grey'][$po_id]);
			$sum_woven_knit=$woven_qty + $knit_qty;


			?>
			<tr>
				<td align="center"><? echo $j;?></td>

				<td align="center"  style="word-wrap: break-word;word-break: break-all;"> <? echo $po_num_arr[$val[csf("po_number")]] ;?> </td>
				<td align="center"> <? echo change_date_format($po_date[$val[csf("po_number")]], "yyyy-mm-dd", "-");?> </td>
				<td align="center"><?  echo $pre= def_number_format($sum_woven_knit,2);  ?> </td>
				<td align="center"><?  echo $bookings= def_number_format($booking_arr[$val[csf("po_number")]],2);  ?> </td>
				<td align="center"> <?echo $short=def_number_format($short_qty_arr[$val[csf("po_number")]],2); ?> </td>
				<td align="center"> <?   $tot_short_book= str_replace(',','',$bookings) +  str_replace(',','',$short) ; echo def_number_format($tot_short_book,2); ?>  </td>
				<td align="center"> <?  $bal =str_replace(',','',$pre)-str_replace(',','',$tot_short_book) ; echo def_number_format($bal,2);  ?> </td>
				<td align="center"> <? if($bal!=0){ if($pre>$tot_short_book){echo "Less ";} else{ echo "Over";} }?> </td>


			</tr>
			<?
			$total_bom +=str_replace(',','',$pre);
			$total_book +=str_replace(',','',$bookings);
			$total_short +=str_replace(',','',$short);
			$total_short_full += str_replace(',','',$tot_short_book);
			$total_balance += str_replace(',','',$bal);

			$j++;
		}
		?>
		<tr>
			<td colspan="3" align="right"> <b> Total </b></td>
			<td align="center"><strong><? echo def_number_format($total_bom,2);?> </strong> </td>
			<td align="center"><strong><? echo def_number_format($total_book,2);?> </strong> </td>
			<td align="center"><strong><? echo def_number_format($total_short,2);?> </strong> </td>
			<td align="center"><strong><? echo def_number_format($total_short_full,2);?> </strong> </td>
			<td align="center"><strong><? echo def_number_format($total_balance,2);?> </strong> </td>
			<td>&nbsp;</td>
		</tr>
	</table>


    <fieldset id="div_size_color_matrix" style="max-width:1000;">
		<?
	    //Query for TNA start-
		$po_id_all=str_replace("'","",$txt_order_no_id);
		$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
		$tna_start_sql=sql_select( "select id,po_number_id,
						(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
						(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
						(case when task_number=60 then task_start_date else null end) as knitting_start_date,
						(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
						(case when task_number=61 then task_start_date else null end) as dying_start_date,
						(case when task_number=61 then task_finish_date else null end) as dying_end_date,
						(case when task_number=64 then task_start_date else null end) as finishing_start_date,
						(case when task_number=64 then task_finish_date else null end) as finishing_end_date,
						(case when task_number=84 then task_start_date else null end) as cutting_start_date,
						(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
						(case when task_number=86 then task_start_date else null end) as sewing_start_date,
						(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
						(case when task_number=110 then task_start_date else null end) as exfact_start_date,
						(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
						(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
						(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
						from tna_process_mst
						where status_active=1 and po_number_id in($po_id_all)");
		$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
		$tna_date_task_arr=array();
		foreach($tna_start_sql as $row)
		{
			if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
			{
				if($tna_fab_start=="")
				{
					$tna_fab_start=$row[csf("fab_booking_start_date")];
				}
			}


			if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
			}
			if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
			}
			if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
			}
			if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
			}

			if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
			}
			if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
			}
			if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
			{
				$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
				$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
			}
		}


		?>
        <legend>TNA Information</legend>

        <table width="100%" style="border:1px solid black;font-size:12px; font-family:Arial Narrow;" border="1" cellpadding="2" cellspacing="0" rules="all">
        	<tr>
        		<td rowspan="2" align="center" valign="top">SL</td>
        		<td width="180" rowspan="2"  align="center" valign="top" style="word-wrap: break-word;word-break: break-all;"><b>Order No</b></td>
        		<td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
        		<td colspan="2" align="center" valign="top"><b>Knitting</b></td>
        		<td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
        		<td colspan="2" align="center" valign="top"><b>Finish Fabric Prod.</b></td>
        		<td colspan="2" align="center" valign="top"><b>Cutting </b></td>
        		<td colspan="2" align="center" valign="top"><b>Sewing </b></td>
        		<td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
        	</tr>
        	<tr>
        		<td width="85" align="center" valign="top"><b>Start Date</b></td>
        		<td width="85" align="center" valign="top"><b>End Date</b></td>
        		<td width="85" align="center" valign="top"><b>Start Date</b></td>
        		<td width="85" align="center" valign="top"><b>End Date</b></td>
        		<td width="85" align="center" valign="top"><b>Start Date</b></td>
        		<td width="85" align="center" valign="top"><b>End Date</b></td>
        		<td width="85" align="center" valign="top"><b>Start Date</b></td>
        		<td width="85" align="center" valign="top"><b>End Date</b></td>
        		<td width="85" align="center" valign="top"><b>Start Date</b></td>
        		<td width="85" align="center" valign="top"><b>End Date</b></td>
        		<td width="85" align="center" valign="top"><b>Start Date</b></td>
        		<td width="85" align="center" valign="top"><b>End Date</b></td>
        		<td width="85" align="center" valign="top"><b>Start Date</b></td>
        		<td width="85" align="center" valign="top"><b>End Date</b></td>

        	</tr>
            <?
			$i=1;
			foreach($tna_date_task_arr as $order_id=>$row)
			{

				?>
				<tr>
					<td><? echo $i; ?></td>
					<td style="word-wrap: break-word;word-break: break-all;"><? echo $po_num_arr[$order_id]; ?></td>
					<td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
					<td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
					<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
					<td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
					<td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
					<td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
					<td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
					<td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
					<td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
					<td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
					<td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
					<td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
					<td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
					<td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
				</tr>
                <?
				$i++;
			}
			?>

        </table>
    </fieldset>

    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
            <thead>
                <tr>
                    <th width="3%"></th><th width="97%" align="left"><u>Special Instruction</u></th>
                </tr>
            </thead>
            <tbody>
            <?
            $data_array=sql_select("select id, terms from  wo_booking_terms_condition where booking_no=$txt_booking_no");// quotation_id='$data'
            if ( count($data_array)>0)
            {
                $i=0;
                foreach( $data_array as $row )
                {
                    $i++;
                    ?>
                        <tr id="settr_1" valign="top">
                            <td style="vertical-align:top">
                            <? echo $i;?>
                            </td>
                            <td>
                           <strong style="font-size:14px"> <? echo $row[csf('terms')]; ?></strong>
                            </td>
                        </tr>
                    <?
                }
            }
            ?>
        </tbody>
    </table>


	<br>
	<?
		echo signature_table(121, $cbo_company_name, "1000px");
	?>

  </div>
	<?
		
		$html = ob_get_contents();
		ob_clean();
		list($is_mail_send,$mail)=explode('___',$mail_send_data);
	
		if($is_mail_send==1){
			require_once('../../../mailer/class.phpmailer.php');
			require_once('../../../auto_mail/setting/mail_setting.php');
			$mailBody = preg_replace("/<img[^>]+\>/i", " ", $html); 
			$mailBody="<br>".$mail_body	;	
			$mailToArr=array();
			$mailSql = "select b.EMAIL  from wo_booking_mst a,LIB_SUPPLIER b where b.id=a.supplier_id and a.booking_no=$txt_booking_no";
		//echo $mailSql;die;
			$mailSqlRes=sql_select($mailSql);
			foreach($mailSqlRes as $rows){
				if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
			}
			
			
			$mailSql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=99 and b.mail_user_setup_id=c.id  and c.IS_DELETED=0 and c.STATUS_ACTIVE=1";
			//echo $mailSql;die;
			$mailSqlRes=sql_select($mailSql);
			foreach($mailSqlRes as $rows){
				if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
			}
			if($mail!=''){$mailToArr[]=$mail;}
	
			$to=implode(',',$mailToArr);
			$subject="Partial fabric booking";
			$header=mailHeader();
			echo $to;
			echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
			
		}
		else{
			echo $html;
		}
		exit();
}
if($action=="print_booking_northern_new_not_used") // rehan for northern
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' or form_name='knit_order_entry' and file_type=1",'master_tble_id','image_location');
	$company_library=return_library_array( "select id,company_name from lib_company where status_active=1 and is_deleted=0", "id", "company_name");
	$color_library=return_library_array( "select id,color_name from lib_color  where status_active=1 and is_deleted=0", "id", "color_name");
	$size_library=return_library_array( "select id,size_name from lib_size  where status_active=1 and is_deleted=0", "id", "size_name");
	$country_arr=return_library_array( "select id,country_name from   lib_country  where status_active=1 and is_deleted=0",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier  where status_active=1 and is_deleted=0",'id','supplier_name');
	$supplier_address_arr=return_library_array( "select id,address_1 from   lib_supplier  where status_active=1 and is_deleted=0",'id','address_1');


	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info  where status_active=1 and is_deleted=0","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer  where status_active=1 and is_deleted=0",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location  where status_active=1 and is_deleted=0",'id','location_name');

	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	$season_arr=return_library_array("select id,season_name from lib_buyer_season  where status_active=1 and is_deleted=0","id","season_name");
	$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where status_active=1 and is_deleted=0 and id in(select po_break_down_id from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no=$txt_booking_no)",'id','po_number');

	$uom=0;
	$joball=array();
	$nameArray_per_job=sql_select( "SELECT  a.season_buyer_wise,  a.job_no,a.style_ref_no ,a.season_matrix,a.gmts_item_id,a.product_dept,max(c.booking_date) as booking_date ,max(c.delivery_date) as delivery_date,max(c.is_approved) as is_approved,max(c.buyer_id) as buyer_id,max(c.pay_mode) as pay_mode,max(supplier_id) as supplier_id,max(a.dealing_marchant) as dealing_marchant,max(c.attention) as attention,max(c.currency_id) as currency_id ,max(c.remarks)  as remarks from wo_po_details_master a , wo_booking_dtls b,wo_booking_mst c  where c.booking_no=b.booking_no and c.status_active=1 and c.is_deleted=0 and  a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by  a.season_buyer_wise, a.job_no,a.style_ref_no ,a.season_matrix,a.gmts_item_id,a.product_dept ");
	foreach ($nameArray_per_job as $vals)
	{
		$joball['job_no'][$row_per_job[csf('job_no')]]=$row_per_job[csf('job_no')];
		$joball['style_ref_no'][$row_per_job[csf('job_no')]]=$row_per_job[csf('style_ref_no')];
		$all_job_arr[$vals[csf("job_no")]]["job"]="'".$vals[csf("job_no")]."'";
		$all_job_arr[$vals[csf("job_no")]]["style"]=$vals[csf("style_ref_no")];
		$all_job_arr[$vals[csf("job_no")]]["item"]=$vals[csf("gmts_item_id")];
		$all_job_arr[$vals[csf("job_no")]]["season"]=$vals[csf("season_matrix")];

		$all_job_arr_season[$vals[csf("job_no")]]=$season_arr[$vals[csf("season_buyer_wise")]];

		$all_job_arr[$vals[csf("job_no")]]["dept"]=$vals[csf("product_dept")];
		$all_job_arr_dept[$vals[csf("job_no")]]=$product_dept[$vals[csf("product_dept")]];
		$all_jobs[$vals[csf("job_no")]]="'".$vals[csf("job_no")]."'";
		$job_wise_style[$vals[csf("job_no")]]= $vals[csf("style_ref_no")];
	}
	$all_jobs_id=implode(",",$all_jobs );
	$seasons=implode(",",$all_job_arr_season );
	$depts=implode(",",$all_job_arr_dept );
 	$po_qnty_all_style=sql_select("SELECT sum(po_quantity) as qnty from wo_po_break_down where status_active=1 and is_deleted=0 and job_no_mst in ($all_jobs_id)");

 	$all_shipdates_arr=sql_select("SELECT min(b.pub_shipment_date)  as shipdate,job_no,a.order_uom as uom from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.status_active=1 and b.is_deleted=0 and  a.status_active=1 and a.is_deleted=0 and b.job_no_mst in ($all_jobs_id) group by job_no,a.order_uom");
 	$shipment_dates="";
 	$job_uom_array=array();
 	foreach($all_shipdates_arr as $key=>$data)
 	{
 		if($shipment_dates=="")
 		{
 			$shipment_dates=change_date_format($data[csf("shipdate")]);
 		}
 		else
 		{
 			$shipment_dates .=','.change_date_format($data[csf("shipdate")]);
 		}
 		$job_uom_array[$data[csf("job_no")]]=$unit_of_measurement[$data[csf("uom")]];


 	}
 	$unites=implode(",", $job_uom_array);


	$uom=0;
	$job_data_arr=array();
	$nameArray_buyer=sql_select( "SELECT  a.style_ref_no,a.style_description, a.job_no, a.style_owner, a.buyer_name, a.dealing_marchant,a.season,a.season_matrix,a.total_set_qnty,a.product_dept,a.product_code,a.pro_sub_dep,a.gmts_item_id ,a.order_repeat_no,a.qlty_label  from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0 and a.job_no='".$row_per_job[csf('job_no')]."'");
	foreach ($nameArray_buyer as $result_buy)
	{
		$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
		$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
		$job_data_arr['total_set_qnty'][$result_buy[csf('job_no')]]=$result_buy[csf('total_set_qnty')];
		$job_data_arr['product_dept'][$result_buy[csf('job_no')]]=$product_dept[$result_buy[csf('product_dept')]];
		$job_data_arr['product_code'][$result_buy[csf('job_no')]]=$result_buy[csf('product_code')];
		$job_data_arr['pro_sub_dep'][$result_buy[csf('job_no')]]=$pro_sub_dept_array[$result_buy[csf('pro_sub_dep')]];
		$job_data_arr['gmts_item_id'][$result_buy[csf('job_no')]]=$result_buy[csf('gmts_item_id')];
		$job_data_arr['style_ref_no'][$result_buy[csf('job_no')]]=$result_buy[csf('style_ref_no')];
		$job_data_arr['style_description'][$result_buy[csf('job_no')]]=$result_buy[csf('style_description')];
		$job_data_arr['dealing_marchant'][$result_buy[csf('job_no')]]=$marchentrArr[$result_buy[csf('dealing_marchant')]];
		$job_data_arr['season_matrix'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_matrix')]];
		$job_data_arr['order_repeat_no'][$result_buy[csf('job_no')]]=$result_buy[csf('order_repeat_no')];
		$job_data_arr['qlty_label'][$result_buy[csf('job_no')]]=$quality_label[$result_buy[csf('qlty_label')]];
	}
	$job_no= implode(",",array_unique($job_data_arr['job_no']));
	$job_no_in= implode(",",array_unique($job_data_arr['job_no_in']));
	$product_depertment=implode(",",array_unique($job_data_arr['product_dept']));
	$product_code=implode(",",array_unique($job_data_arr['product_code']));
	$pro_sub_dep=implode(",",array_unique($job_data_arr['pro_sub_dep']));
	$gmts_item_id=implode(",",array_unique($job_data_arr['gmts_item_id']));
	$style_sting=implode(",",array_unique($job_data_arr['style_ref_no']));
	$style_description=implode(",",array_unique($job_data_arr['style_description']));
	$dealing_marchant=implode(",",array_unique($job_data_arr['dealing_marchant']));
	$season_matrix=implode(",",array_unique($job_data_arr['season_matrix']));
	$order_repeat_no= implode(",",array_unique($job_data_arr['order_repeat_no']));
	$qlty_label= implode(",",array_unique($job_data_arr['qlty_label']));
	$path=str_replace("'","",$path);
	if($path=="")
	{
	$path='../../';
	}
	ob_start();
	?>
	<style type="text/css">

		body, p, span, td, a {font-size:10pt;font-family: Arial;}
		body{margin-left:2em; margin-right:2em; font-family: "Arial Narrow", Arial, sans-serif;}

	</style>

	<div style="width:1330px" align="center" >

		<table id="tb_header" width="100%" cellpadding="0" cellspacing="0" style="border:0px solid black" >
			<thead>
				<tr>
					<td width="150" rowspan="4">
						<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100' width='100' />
					</td>
					<td width="200">&nbsp;</td>
					<td width="400" align="left" style="font-size: 16px;"><b><?php echo $company_library[$cbo_company_name]; ?></b></td>
					<td width="100">&nbsp;</td>
					<td width="300" align="left"><b>Booking No: </b><?php echo str_replace("'", "", $txt_booking_no); ?></td>
				</tr>

				<tr>
					<td width="200">&nbsp;</td>
					<td width="400" align="left">
						<?
						$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
						foreach ($nameArray as $result)
						{
							?>
							Plot No: <? echo $result[csf('plot_no')]; ?>
							Level No: <? echo $result[csf('level_no')]?>
							Road No: <? echo $result[csf('road_no')]; ?>
							Block No: <? echo $result[csf('block_no')];?>
							City No: <? echo $result[csf('city')];?>
							Zip Code: <? echo $result[csf('zip_code')]; ?>
							Province No: <?php echo $result[csf('province')]; ?>
							Country: <? echo $country_arr[$result[csf('country_id')]]; ?><br>
							Email Address: <? echo $result[csf('email')];?>
							Website No: <? echo $result[csf('website')];
						}
							?>

					</td>
					<td width="100">&nbsp;</td>
					<td width="300" align="left"><b>Booking Date: </b><?php echo change_date_format($nameArray_per_job[0][csf("booking_date")]); ?></td>
				</tr>

				<tr>
					<td width="200">&nbsp;</td>
					<td width="400" align="left" style="font-size: 16px;"><b>Fabric Booking Sheet </b></td>
					<td width="100">&nbsp;</td>
					<td width="300" align="left"><b>Delivery Date: </b><?php echo change_date_format($nameArray_per_job[0][csf("delivery_date")]); ?></td>
				</tr>

				<tr>
					<td colspan="3" width="700">&nbsp;</td>
					<td width="300" align="left"><b>Approval Status: </b><?php if ($nameArray_per_job[0][csf("is_approved")] == 1 || $nameArray_per_job[0][csf("is_approved")] == 3) {echo "Approved";}?></td>
				</tr>
				<tr>
					<td colspan="4" height="10">&nbsp;</td>
				</tr>

				<tr>
					<td width="300"><b>To</b></td>

					<td width="400" align="left"><b>Buyer Name :   </b> <? echo $buyer_name_arr[$nameArray_per_job[0][csf("buyer_id")]]; ?></td>
					<td align="left"><b>Season : </b>&nbsp;<? echo $seasons;?></td>



				</tr>
				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<tr>
					<td width="300"><?
					$pay_mode=$nameArray_per_job[0][csf("pay_mode")];//pay_mode
					if($pay_mode!=3 && $pay_mode!=5)
					{
						echo $supplier_name_arr[$nameArray_per_job[0][csf("supplier_id")]];
					}
					else
					{
						echo $company_library[$nameArray_per_job[0][csf("supplier_id")]];
					}?></td>

					<td width="400" align="left"><b>Order Qnty :   </b> <? echo $po_qnty_all_style[0][csf("qnty")]; ?>&nbsp;<? echo $unites;?></td>
					<td><b>Dept : </b> &nbsp;<? echo $depts; ?></td>
					<td></td>


				</tr>
				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<tr>
					<td width="300" ><p><b>Address: </b><? echo $supplier_address_arr[$nameArray_per_job[0][csf("supplier_id")]]; ?> </p></td>

					<td width="400" align="left"><b>Dealing Merchandiser:   </b> <? echo $marchentrArr[$nameArray_per_job[0][csf("dealing_marchant")]]; ?></td>


				</tr>

				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<tr>
				   <td width="300"><b>Attention: </b>   <? echo $nameArray_per_job[0][csf("attention")];?></td>

				   <td width="400" align="left"><b>Currency:   </b> <? echo $currency[$nameArray_per_job[0][csf("currency_id")]]; ?></td>


				</tr>
				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<tr>
				   <td colspan="2" width="800"><b>Shipment Date: </b><? echo trim($shipment_dates);?></td>

				</tr>


				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<tr>
				   <td width="300"><b>WO Prepared After:   </b>    </td>

				   <td width="400" align="left"><b>Remarks:   </b> <? echo $nameArray_per_job[0][csf("remarks")]; ?></td>


				</tr>
			</thead>
		</table>


			<?php
	$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and a.status_active =1 and a.is_deleted=0");
	list($nameArray_approved_row) = $nameArray_approved;
	$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
	list($nameArray_approved_date_row) = $nameArray_approved_date;
	$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
	list($nameArray_approved_comments_row) = $nameArray_approved_comments;

	$po_data = array();
	if ($db_type == 0) {
	$nameArray_job = sql_select("select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,DATEDIFF(pub_shipment_date,po_received_date) date_diff,MIN(po_received_date) as po_received_date ,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status  from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id)  group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
}
if ($db_type == 2) {
	$nameArray_job = sql_select("select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,(pub_shipment_date-po_received_date) date_diff,MIN(po_received_date) as po_received_date,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status   from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id) group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
}
foreach ($nameArray_job as $result_job) {
	$po_data['po_id'][$result_job[csf('id')]] = $result_job[csf('id')];
	$po_data['po_number'][$result_job[csf('id')]] = $result_job[csf('po_number')];
	$po_data['leadtime'][$result_job[csf('id')]] = $result_job[csf('date_diff')];
	$po_data['po_quantity'][$result_job[csf('id')]] = $result_job[csf('po_quantity')];
	$po_data['po_received_date'][$result_job[csf('id')]] = change_date_format($result_job[csf('po_received_date')], 'dd-mm-yyyy', '-');
	$ddd = strtotime($result_job[csf('pub_shipment_date')]);
	$po_data['pub_shipment_date'][$ddd] = $ddd;

	$po_data['insert_date'][$result_job[csf('id')]] = $result_job[csf('insert_date')];

	if ($result_job[csf('shiping_status')] == 1) {
		$shiping_status = "FP";
	} else if ($result_job[csf('shiping_status')] == 2) {
		$shiping_status = "PS";
	} else if ($result_job[csf('shiping_status')] == 3) {
		$shiping_status = "FS";
	}
	$po_data['shiping_status'][$result_job[csf('id')]] = $shiping_status;
	$po_data['file_no'][$result_job[csf('id')]] = $result_job[csf('file_no')];
	$po_data['grouping'][$result_job[csf('id')]] = $result_job[csf('grouping')];
}
$txt_order_no_id = implode(",", array_unique($po_data['po_id']));
$leadtime = implode(",", array_unique($po_data['leadtime']));
$po_quantity = array_sum($po_data['po_quantity']);
$po_received_date = implode(",", array_unique($po_data['po_received_date']));
$po_number = implode(",", array_unique($po_data['po_number']));
$shipment_date = date('d-m-Y', min($po_data['pub_shipment_date']));

$maxshipment_date = date('d-m-Y', max($po_data['pub_shipment_date']));
//$shipment_date=implode(",",array_unique($po_data['pub_shipment_date']));
$shiping_status = implode(",", array_unique($po_data['shiping_status']));
$file_no = implode(",", array_unique($po_data['file_no']));
$grouping = implode(",", array_unique($po_data['grouping']));

$colar_excess_percent = 0;
$cuff_excess_percent = 0;
$rmg_process_breakdown = 0;
$nameArray = sql_select("select a.buyer_id,a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.update_date,a.uom,a.remarks,a.pay_mode,a.fabric_composition from wo_booking_mst a  where   a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0");
foreach ($nameArray as $result) {
	$total_set_qnty = $result[csf('total_set_qnty')];
	$colar_excess_percent = $result[csf('colar_excess_percent')];
	$cuff_excess_percent = $result[csf('cuff_excess_percent')];
	$rmg_process_breakdown = $result[csf('rmg_process_breakdown')];
	foreach ($po_data['po_id'] as $po_id => $po_val) {
		$daysInHand .= (datediff('d', date('d-m-Y', time()), $po_data['pub_shipment_date'][$po_id]) - 1) . ",";
		$booking_date = $result[csf('update_date')];
		if ($booking_date == "" || $booking_date == "0000-00-00 00:00:00") {
			$booking_date = $result[csf('insert_date')];
		}
		$WOPreparedAfter .= (datediff('d', $po_data['insert_date'][$po_id], $booking_date) - 1) . ",";
	}

}

?>
			<br/>
			<!--  Here will be the main portion  -->
			<?
			$costing_per="";
			$costing_per_qnty=0;
			$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no in($job_no_in)");
			if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;

			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";
				$costing_per_qnty=1;

			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;

			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;

			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;
			}
			$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no in($job_no_in)");
			$uom_arr=array(1=>"Pcs",12=>"Kg",23=>"Mtr",27=>"Yds");
			$p=1;

		if($cbo_fabric_source==1 || $cbo_fabric_source==2 || $cbo_fabric_source==3)
		{
			$nameArray_fabric_description= sql_select("SELECT a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , b.dia_width,d.pre_cost_remarks,a.uom,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,avg(d.rate) as rates,sum(d.amount) as amounts ,d.fabric_color_id,a.color_size_sensitive,a.color_break_down,c.job_no_mst,avg(b.cons) as cad_consumption,avg(b.requirment) as consumption,avg(b.process_loss_percent) as wastage  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_number_id=d.gmts_color_id and
				b.dia_width=d.dia_width and
				b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id
				and
				d.booking_no =$txt_booking_no and
				d.job_no in ($all_jobs_id) and

				d.status_active=1 and
				d.is_deleted=0 and
				b.cons>0   and a.body_part_type not in(40,50)
				group by a.id,a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,b.dia_width,d.pre_cost_remarks,a.uom ,d.fabric_color_id,a.color_size_sensitive,a.color_break_down,c.job_no_mst  order by c.job_no_mst   ");


			$uom_data_arr=array();
			foreach($nameArray_fabric_description as $row)
			{
				$uom_data_arr[$row[csf('uom')]]=$row[csf('uom')];
			}

			foreach($uom_data_arr as $uom_id=>$uom_val)
			{
				if(count($nameArray_fabric_description)>0)
				{

					?>

						<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
									<caption> <strong>Fabric Booking Summary </strong> </caption>
									<tr>
										<th  width="30" align="center">SL</th>
										<th  width="150" align="center">Style</th>
										<th  width="140" align="center">Gmts Item</th>
										<th  width="130" align="center">Parts</th>
										<th  width="390" align="left">Fabric Composition</th>
										<th  width="40" align="center">GSM</th>
										<th  width="90" align="center">Fabric Dia</th>
										<th  width="100" align="center">Color Type</th>
										<th  width="100" align="center">Combo</th>
										<th  width="110" align="center">Fabric Color</th>
										<th  width="80" align="center">CAD Consumption</th>
										<th  width="80" align="center">Wastage %</th>
										<th  width="80" align="center">Consumption</th>
										<th  width="60" align="center">UOM</th>
										<!-- <th width='120' align="center"></th> -->
										<th width='120' align="center" title="Based on avg grey consumption">Finish Fab. Qty</th>
										<th width='100' align="center">Avg Rate</th>
										<th width='60' align="center">Amount</th>

									</tr>
									<?
									$color_wise_process_loss=sql_select("SELECT  a.body_part_id,b.color_number_id,avg(b.process_loss_percent) as loss FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls  b 	WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and  a.job_no in ($all_jobs_id)   group by a.body_part_id,b.color_number_id
									");
									foreach($color_wise_process_loss as $val)
									{
										$loss_arr[$val[csf("body_part_id")]][$val[csf("color_number_id")]]=$val[csf("loss")];
									}

									$total_fin_fab_qnty=0;  $total_amount=0;  $total_grey_fab_qnty=0 ;$tot_avg=0;
									foreach($nameArray_fabric_description as $val)
									{
										if($val[csf('pre_cost_remarks')]!='') $remark_cond=" and d.pre_cost_remarks='".$val[csf('pre_cost_remarks')]."' "; else $remark_cond=" and d.pre_cost_remarks is null";
										$color_wise_wo_sql_qnty=sql_select("SELECT  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
											WHERE
											a.job_no=d.job_no and
											a.id=d.pre_cost_fabric_cost_dtls_id and
											d.booking_no =$txt_booking_no and
											d.job_no = '".$val[csf('job_no_mst')]."' and
											a.item_number_id='".$val[csf('item_number_id')]."' and
											a.body_part_id='".$val[csf('body_part_id')]."' and
											a.color_type_id='".$val[csf('color_type_id')]."' and
											a.construction='".$val[csf('construction')]."' and
											a.composition='".$val[csf('composition')]."' and
											a.gsm_weight='".$val[csf('gsm_weight')]."' and
											d.dia_width='".$val[csf('dia_width')]."' and

											d.fabric_color_id='".$val[csf('fabric_color_id')]."' and
											d.status_active=1 and
											d.is_deleted=0 $remark_cond
											");
										if($uom_id==$val[csf('uom')])
										{
											if($val[csf('pre_cost_remarks')]=='no remarks')  $pre_cost_remarks="";else  $pre_cost_remarks=$val[csf('pre_cost_remarks')];
											?>
											<tr>
												<td align="center"> <? echo $p; $p++;?></td>


												<td align="center"> <? echo $all_job_arr[$val[csf("job_no_mst")]]["style"];?></td>
												<td align="center"> <? echo $garments_item[$val[csf("item_number_id")]];?></td>
												<td align="center"><? echo $body_part[$val[csf('body_part_id')]];?></td>
												<td align="left"> <? echo $val[csf('construction')].','.$val[csf('composition')].', '.$pre_cost_remarks; ?> </td>

												<td  align="center">
													<?
													echo $val[csf('gsm_weight')];
													?>
												</td>

												<td  align="center">
													<?
													echo $val[csf('dia_width')];
													?>
												</td>

												<td  align="center">
													<?
													echo $color_type[$val[csf('color_type_id')]];
													?>
												</td>
												<td  align="center">
													<?
													if($val[csf('color_size_sensitive')]==1 or $val[csf('color_size_sensitive')]==2 or $val[csf('color_size_sensitive')]==4)
													{
														echo $color_library[$val[csf('fabric_color_id')]];
													}

													else
													{
														$color_break_down=$val[csf('color_break_down')];
														if($color_break_down)
														{
															$gmts_color="";
															if (strpos($color_break_down, '__') !== false)
															{
																$color_break_down=explode('__', $color_break_down);
																foreach ($color_break_down as $key => $value)
																{
																	$cols=explode('_', $value);
																	if(trim(strtolower($color_library[$val[csf('fabric_color_id')]]))==trim(strtolower($cols[2])))
																	{
																		if($gmts_color=="")
																		{
																			$gmts_color=$cols[1];
																		}
																		else
																		{
																			$gmts_color .=','.$cols[1];
																		}

																	}
																}
															}
															else
															{
																$cols=explode('_', $color_break_down);
																if(trim(strtolower($color_library[$val[csf('fabric_color_id')]]))==trim(strtolower($cols[2])))
																{
																	if($gmts_color=="")
																	{
																		$gmts_color=$cols[1];
																	}
																	else
																	{
																		$gmts_color .=','.$cols[1];
																	}

																}
															}

															echo $gmts_color;
														}

													}
													?>
												</td>


												<td  align="center">
													<?
													echo $color_library[$val[csf('fabric_color_id')]];
													?>
												</td>


												<td align="center"> <? echo $val[csf('cad_consumption')]; ?></td>
												<td align="center"> <? echo $val[csf('wastage')]; ?>%</td>
												<td align="center"> <? echo $val[csf('consumption')]; ?></td>
												<td align="center"> <? echo $unit_of_measurement[$val[csf('uom')]]; ?></td>

												<!-- <td align="center"> <?   //$greys= $color_wise_wo_sql_qnty[0][csf("grey_fab_qnty")] /(1+($loss_arr[$val[csf("body_part_id")]][$val[csf("fabric_color_id")]]/100)) ;
													//echo def_number_format($greys,2);

													?> </td> -->



													<td align="center"> <? echo def_number_format($color_wise_wo_sql_qnty[0][csf("grey_fab_qnty")],2); ?> </td>
													<td align="center"> <? echo def_number_format($color_wise_wo_sql_qnty[0][csf("rate")],2); ?> </td>
													<td align="center"> <? echo def_number_format($color_wise_wo_sql_qnty[0][csf("amount")],2); ?> </td>


													<?

													$total_fin_fab_qnty +=str_replace(",", "", def_number_format($greys,2));
													$total_amount +=str_replace(",", "",def_number_format($color_wise_wo_sql_qnty[0][csf("amount")],2));

													$total_grey_fab_qnty +=str_replace(",", "",def_number_format($color_wise_wo_sql_qnty[0][csf("grey_fab_qnty")],2));
													$total_rate +=str_replace(",", "",def_number_format($color_wise_wo_sql_qnty[0][csf("rate")],2));
													$tot_avg=$total_amount/$total_grey_fab_qnty;


													?>



												</tr>
												<?
										}

									}
										?>
									<tr style=" font-weight:bold">


									<td  align="right" colspan="14"><strong>Total</strong></td>
									<!-- <td align="center"><?// echo def_number_format($total_fin_fab_qnty,2);?></td> -->
									<td align="center"><? echo def_number_format($total_grey_fab_qnty,2);?></td>
									<td align="center"><? echo def_number_format($tot_avg,2);?></td>
									<td align="center"><? echo def_number_format($total_amount,2);?></td>

									</tr>

						</table>

					<?
				}
			}
		}


		$sql_data=sql_select("SELECT a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,a.uom,b.dia_width,b.pre_cost_remarks,b.fabric_color_id,b.remark, sum(b.grey_fab_qnty) as grey_fab_qnty,sum(b.adjust_qty)as adjust_qty FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in($all_jobs_id) and b.adjust_qty>0 and b.status_active=1 and b.is_deleted=0 group by a.id,a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,a.uom,b.dia_width,b.pre_cost_remarks,b.fabric_color_id,b.remark and a.body_part_type not in(40,50) order by a.id,a.body_part_id");
		if(count($sql_data)>0)
		{

					?>
					<br/>
			<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

					<tr>
						<td colspan="7" align="center">
							<strong>Fabric Stock Adjustment Details</strong>
						</td>

					</tr>

					<tr>
						<td align="center"> SL </td>
						<td align="center"> Item Description </td>
						<td align="center"> Fabric Color </td>
						<td align="center">UOM</td>
						<td align="center">Adjusted Qty </td>


					</tr>
					<?
					$p=1;
					foreach($sql_data as $row)
					{
						?>
						<tr>
							<td align="center"><? echo $p;?></td>
							<td align="center">
								<? echo $body_part[$row[csf('body_part_id')]].",".$row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$row[csf('dia_width')].','.$fabric_typee[$row[csf('width_dia_type')]].",".$color_type[$row[csf('color_type_id')]] ?>
							</td>

							<td align="center">
								<? echo $color_library[$row[csf('fabric_color_id')]];  ?>
							</td>
							<td align="center">
								<? echo $unit_of_measurement[$row[csf('uom')]];  ?>
							</td>


							<td align="center">
								<? echo number_format($row[csf('adjust_qty')],4) ; ?>
							</td>

						</tr>
						<?
						$p++;
					}
		}
					?>
			</table>
			<br>
			  		<table  width="100%"  border="0" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

			  			<tr>
			  				<td colspan="9" align="center">
			  					<strong>Collar and  Cuff Breakdown</strong>
			  				</td>

			  			</tr>
			  		</table>



	        <?
	     	  $sql_collar_cuff= "SELECT a.rate, a.amount, a.job_no , a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.width_dia_type, b.gmts_color_id, b.size_number_id, b.item_size, b.gmts_qty, b.excess_per, b.qty, b.po_break_down_id as po_id, b.id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id) and a.body_part_type=40 and b.status_active=1 and b.is_deleted=0  order by a.body_part_id,b.gmts_color_id,b.id " ;
	         $sql_data_collar_cuff=sql_select($sql_collar_cuff);
	         $size_id_array=array();
	         $size_with_item_size_array=array();
	         foreach($sql_data_collar_cuff as $vals)
	         {
	         	$size_id_array[$vals[csf("size_number_id")]]=$vals[csf("size_number_id")];
	         	$size_with_item_size_array[$vals[csf("size_number_id")]]=$vals[csf("item_size")];
	         	$size_item_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$size_item_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["grey"]+=$vals[csf("qty")];

	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]=$vals[csf("excess_per")];
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["grey"]+=$vals[csf("qty")];
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["amount"]=$vals[csf("amount")];

	         }

	          $sql_collar_cuff2= "SELECT a.rate,a.amount, a.job_no , a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,b.gmts_color_id,b.po_break_down_id as po_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id) and a.body_part_type=40  and b.status_active=1 and b.is_deleted=0  group by  a.rate,a.amount, a.job_no , a.id , a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition,a.gsm_weight,a.width_dia_type,b.gmts_color_id,b.po_break_down_id  order by a.body_part_id,b.gmts_color_id  " ;
	          $sql_data_collar_cuff2=sql_select($sql_collar_cuff2);


	         $counts=count($size_id_array);
	         $gr_fin_qty=0;
	         $gr_collor_qty=0;
	         $gr_avg_price=0;
	         $gr_avg_row=0;
	         $gr_amount=0;
	         $gr_excess=0;
	         $size_wise_qnty_array=array();
	         ?>
	         <table align="left"  width="100%"   border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" >

	         <?
	          if(count($sql_data_collar_cuff2)>0)
	          {
					?>
			  			<tr>
			  				<td colspan="<? echo $counts+12;?>" align="center">
			  					<strong>Collar Details</strong>
			  				</td>

			  			</tr>

			  			<tr>
			  				<td   width="30"  rowspan="2" align="center">SL </td>
			  				<td  width="100" rowspan="2" align="center">Style</td>
 			  				<td  width="100"  rowspan="2" align="center">Gmts Item</td>
 			  				<td   width="100"  rowspan="2" align="center">Body Part</td>
			  				<td  width="310" rowspan="2" align="left">&nbsp;&nbsp;Collar Composition</td>
			  				<td   width="100"  rowspan="2" align="center">Color Type</td>
 			  				<td  width="100"  rowspan="2"  align="center">Combo</td>
 			  				<?
 			  				foreach($size_id_array as $id=>$val)
 			  				{
 			  					?>
 			  					<td width="40" align="center"><? echo $size_library[$id];?></td>

 			  					<?
 			  				}
 			  				?>

			  				<td width="60"  rowspan="2" align="center"> Gmts Qty (Pcs)  </td>
			  				<td  width="50" rowspan="2"  align="center"> Excess %   </td>
			  				<td width="60" rowspan="2"  align="center"> Collar Qty (Pcs) </td>
			  				<td width="50" rowspan="2"  align="center">Price/Pcs</td>
			  				<td  width="40" rowspan="2" align="center">Amount</td>


			  			</tr>
			  			<tr>
			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td  align="center"><? echo $size_with_item_size_array[$id];?></td>

			  					<?
			  				}
			  				?>

			  			</tr>
			  			<?
			  			$p=1;
			  			foreach($sql_data_collar_cuff2 as $row)
			  			{
			  				?>
			  				<tr>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="30" align="center"><? echo $p;?></td>
			  					<td style="word-break: break-all;word-wrap: break-word;" width="150" align="center"><? echo $job_wise_style[$row[csf("job_no")]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="140" align="center"><?  $item_id= $row[csf('item_number_id')];echo $garments_item[$item_id]; ?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="130" align="center"><? echo $body_part[$row[csf("body_part_id")]];?></td>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="390" align="left"> &nbsp;
			  						<? echo $row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$fabric_typee[$row[csf('width_dia_type')]] ;?>
			  					</td>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="100" align="center"><? echo $color_type[$row[csf('color_type_id')]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center">
			  						<? echo $color_library[$row[csf('gmts_color_id')]];  ?>
			  					</td>


			  					<?
								$color_qty=0; $greyQty=0;
			  					foreach($size_id_array as $id=>$val)
			  					{
			  						?>
			  						<td  style="word-break: break-all;word-wrap: break-word;" width="40"  align="center"><? echo $val=$size_item_wise_qnty[$row[csf("gmts_color_id")]][$id][$size_with_item_size_array[$id]]["fin"];?></td>

			  						<?
			  						$size_wise_qnty_array[$id]+=$val;
									$color_qty+=$val;
									$greyQty+=$size_item_wise_qnty[$row[csf("gmts_color_id")]][$id][$size_with_item_size_array[$id]]["grey"];
			  					}
			  					?>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="60" align="center">
			  						<? echo $fin_qty=$color_qty;// $color_wise_qnty[$row[csf('gmts_color_id')]][$item_id]["fin"];  ?>
			  					</td>

			  					<td  style="word-break: break-all;word-wrap: break-word;" width="50" align="center">
			  						<? echo $excess= $color_wise_qnty[$row[csf('gmts_color_id')]][$item_id]["excess_per"];  ?>
			  					</td>

			  					<td  style="word-break: break-all;word-wrap: break-word;" width="60" align="center">
			  						<? echo $grey_qnty=$greyQty;//$color_wise_qnty[$row[csf('gmts_color_id')]][$item_id]["grey"];  ?>
			  					</td>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="50" align="center">
			  						<? echo $price=$color_wise_qnty[$row[csf('gmts_color_id')]][$item_id]["rate"];  ?>
			  					</td>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="40" align="center">
			  						<? echo $amount=$grey_qnty* $color_wise_qnty[$row[csf('gmts_color_id')]][$item_id]["rate"];   ?>
			  					</td>
			  				</tr>
			  				<?
			  				$gr_fin_qty+=$fin_qty;
			  				$gr_collor_qty+=$grey_qnty;
			  				$gr_avg_price+=$price;
			  				$gr_avg_row++;
			  				$gr_amount+=$amount;
			  				$gr_excess+=$excess ;


			  				$p++;
			  			}
			  			?>
			  			<tr>
			  				<td colspan="7" align="right">Total </td>


			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td  align="center"><? echo $size_wise_qnty_array[$id];?></td>

			  					<?
			  				}
			  				?>



			  				<td align="center">
			  					<? echo $gr_fin_qty;  ?>
			  				</td>
			  				<td align="center"><? echo $gr_excess/$gr_avg_row; ?></td>

			  				<td align="center">
			  					<? echo $gr_collor_qty;  ?>
			  				</td>


			  				<td align="center">
			  					<? echo $gr_avg_price/$gr_avg_row;  ?>
			  				</td>
			  				<td align="center">
			  					<? echo $gr_amount;   ?>
			  				</td>

			  			</tr>

			  			<?
			  	}




	     	  $sql_collar_cuff= "SELECT a.rate,a.amount, a.job_no , a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,b.gmts_color_id,b.size_number_id,b.item_size,b.gmts_qty,b.excess_per,b.qty,b.po_break_down_id as po_id,b.id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id) and a.body_part_type=50 and b.status_active=1 and b.is_deleted=0  order by a.body_part_id,b.gmts_color_id,b.id " ;
	         $sql_data_collar_cuff=sql_select($sql_collar_cuff);
	         $size_id_array=array();
	         $size_with_item_size_array=array();
	         $size_item_wise_qnty=array();
	         $color_wise_qnty=array();
	         foreach($sql_data_collar_cuff as $vals)
	         {
	         	$size_id_array[$vals[csf("size_number_id")]]=$vals[csf("size_number_id")];
	         	$size_with_item_size_array[$vals[csf("size_number_id")]]=$vals[csf("item_size")];
	         	$size_item_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$size_item_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["grey"]+=$vals[csf("qty")];

	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]=$vals[csf("excess_per")];
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["grey"]+=$vals[csf("qty")];
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["amount"]=$vals[csf("amount")];

	         }

	          $sql_collar_cuff2= "SELECT a.rate,a.amount, a.job_no , a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,b.gmts_color_id,b.po_break_down_id as po_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id) and a.body_part_type=50  and b.status_active=1 and b.is_deleted=0  group by  a.rate,a.amount, a.job_no , a.id , a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition,a.gsm_weight,a.width_dia_type,b.gmts_color_id,b.po_break_down_id  order by a.body_part_id,b.gmts_color_id  " ;
	          $sql_data_collar_cuff2=sql_select($sql_collar_cuff2);


	         $counts=count($size_id_array);
	          if(count($sql_data_collar_cuff2)>0)
	          {

					?>
					<br>

			  		<tr>
			  		<td height="5"  colspan="<? echo $counts+12;?>">

			  		</tr>
			  			<tr>
			  				<td colspan="<? echo $counts+12;?>" align="center">
			  					<strong>Cuff Details</strong>
			  				</td>

			  			</tr>



			  			<tr>
			  				<td   width="30"  rowspan="2" align="center">SL </td>
			  				<td  width="100" rowspan="2" align="center">Style</td>
 			  				<td  width="100"  rowspan="2" align="center">Gmts Item</td>
 			  				<td   width="100"  rowspan="2" align="center">Body Part</td>
			  				<td  width="310" rowspan="2" align="left">&nbsp;&nbsp;Cuff Composition</td>
			  				<td   width="100"  rowspan="2" align="center">Color Type</td>
 			  				<td  width="100"  rowspan="2"  align="center">Combo</td>
 			  				<?
 			  				foreach($size_id_array as $id=>$val)
 			  				{
 			  					?>
 			  					<td width="40" align="center"><? echo $size_library[$id];?></td>

 			  					<?
 			  				}
 			  				?>

			  				<td width="60"  rowspan="2" align="center"> Gmts Qty (Pcs)  </td>
			  				<td  width="50" rowspan="2"  align="center"> Excess %   </td>
			  				<td width="60" rowspan="2"  align="center"> Cuff Qty (Pcs) </td>
			  				<td width="50" rowspan="2"  align="center">Price/Pcs</td>
			  				<td  width="40" rowspan="2" align="center">Amount</td>


			  			</tr>


			  			<tr>
			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td width="40"  align="center"><? echo $size_with_item_size_array[$id];?></td>

			  					<?
			  				}
			  				?>

			  			</tr>
			  			<?
			  			$p=1;
			  			$gr_fin_qty=0;
			  			$gr_collor_qty=0;
			  			$gr_avg_price=0;
			  			$gr_avg_row=0;
			  			$gr_amount=0;
			  			$gr_excess=0;
			  			$size_wise_qnty_array=array();
			  			foreach($sql_data_collar_cuff2 as $row)
			  			{
			  				?>
			  				<tr>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="30" align="center"><? echo $p;?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center"><? echo $job_wise_style[$row[csf("job_no")]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center"><?  $item_id= $row[csf('item_number_id')];echo $garments_item[$item_id]; ?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center"><? echo $body_part[$row[csf("body_part_id")]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="310" align="left"> &nbsp;
			  						<? echo $row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$fabric_typee[$row[csf('width_dia_type')]] ;?>
			  					</td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center"><? echo $color_type[$row[csf('color_type_id')]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center">
			  						<? echo $color_library[$row[csf('gmts_color_id')]];  ?>
			  					</td>


			  					<?
			  					foreach($size_id_array as $id=>$val)
			  					{
			  						?>
			  						<td  style="word-break: break-all;word-wrap: break-word;"  width="40"  align="center"><? echo $val=2*$size_item_wise_qnty[$row[csf("gmts_color_id")]][$id][$size_with_item_size_array[$id]]["fin"];?></td>

			  						<?
			  						$size_wise_qnty_array[$id]+=$val;
			  					}
			  					?>



			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="60" align="center">
			  						<? echo $fin_qty=2*$color_wise_qnty[$row[csf('gmts_color_id')]][$item_id]["fin"];  ?>
			  					</td>

			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="50" align="center">
			  						<? echo $excess=$color_wise_qnty[$row[csf('gmts_color_id')]][$item_id]["excess_per"];  ?>
			  					</td>

			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="60" align="center">
			  						<? echo $grey_qnty=$color_wise_qnty[$row[csf('gmts_color_id')]][$item_id]["grey"];  ?>
			  					</td>
			  					<td   style="word-break: break-all;word-wrap: break-word;" width="50" align="center">
			  						<? echo $price= $color_wise_qnty[$row[csf('gmts_color_id')]][$item_id]["rate"];  ?>
			  					</td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="40" align="center">
			  						<? echo  $amount=$color_wise_qnty[$row[csf('gmts_color_id')]][$item_id]["grey"] * $color_wise_qnty[$row[csf('gmts_color_id')]][$item_id]["rate"];   ?>
			  					</td>






			  				</tr>
			  				<?
			  				$gr_fin_qty+=$fin_qty;
			  				$gr_collor_qty+=$grey_qnty;
			  				$gr_avg_price+=$price;
			  				$gr_avg_row++;
			  				$gr_amount+=$amount;
			  				$gr_excess+=$excess;
			  				$p++;
			  			}

			  			?>
			  			<tr>
			  				<td colspan="7" align="right">Total </td>


			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td  align="center"><? echo $size_wise_qnty_array[$id];?></td>

			  					<?

			  				}
			  				?>




			  				<td align="center">
			  					<? echo $gr_fin_qty;  ?>
			  				</td>
			  				<td align="center"><? echo $gr_excess/$gr_avg_row; ?></td>

			  				<td align="center">
			  					<? echo $gr_collor_qty;  ?>
			  				</td>


			  				<td align="center">
			  					<? echo $gr_avg_price/$gr_avg_row;  ?>
			  				</td>
			  				<td align="center">
			  					<? echo $gr_amount;   ?>
			  				</td>

			  			</tr>

			  			<?


			  	}
			  		?>


			  	</table>
			<br>










			<table  style="margin-top: 5px;float: left;"    width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

				<tr>
					<td colspan="10" align="center">
						<strong>Comments</strong>
					</td>

				</tr>

				<tr>
					<td align="center"> SL </td>
					<td align="center" width="200"  style="word-wrap: break-word;word-break: break-all;"> PO NO </td>
					<td align="center"> Ship Date </td>
					<td align="center">BOM Qty</td>
					<td align="center"> Booking Qty </td>
					<td align="center"> Short Booking Qty </td>
					<td align="center"> Total Booking Qty </td>
					<td align="center"> Balance </td>
					<td align="center"> Comments </td>


				</tr>
				<?
				$is_short_data=sql_select("SELECT a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0   and b.is_short =1 group by  a.id ");
				foreach($is_short_data as $vals)
				{
					$short_qty_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
				}

				$booking_data=sql_select("SELECT a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and  b.status_active=1 and b.is_deleted=0 and b.is_short !=1 group by  a.id  order by a.id");
				foreach($booking_data as $vals)
				{
					$booking_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
				}

				$po_date=return_library_array("select id,shipment_date from wo_po_break_down where status_active=1 and is_deleted=0",'id','shipment_date');

				$comments_data=sql_select("SELECT min(a.id) as ids,b.po_break_down_id as po_number,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,SUM(b.requirment) as precost_grey_qty FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id
					and
					b.po_break_down_id=d.po_break_down_id and
					b.color_number_id=d.gmts_color_id and
					b.dia_width=d.dia_width and
					b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					a.job_no=d.job_no and
					a.id=d.pre_cost_fabric_cost_dtls_id
					and
					d.booking_no =$txt_booking_no and
					d.job_no in($all_jobs_id) and

					d.status_active=1 and
					d.is_deleted=0 and
					b.cons>0
					group by b.po_break_down_id order by b.po_break_down_id");



				$job_no=$all_jobs_id;
				$condition= new condition();
				if(str_replace("'","",$job_no) !='')
				{
					$condition->job_no("in ($job_no)");
				}
				$condition->init();
				$fabric= new fabric($condition);
				$fabric_costing_qty_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish();

				$j=1;
				$total_bom=0;
				$total_book=0;
				$total_short=0;
				$total_short_full=0;
				$total_balance=0;
				foreach($comments_data as $val)
				{
					$po_id=$val[csf('po_number')];
					$woven_qty=array_sum($fabric_costing_qty_arr['woven']['grey'][$po_id]);
					$knit_qty=array_sum($fabric_costing_qty_arr['knit']['grey'][$po_id]);
					$sum_woven_knit=$woven_qty + $knit_qty;


					?>
					<tr>
						<td align="center"><? echo $j;?></td>

						<td align="center"  style="word-wrap: break-word;word-break: break-all;"> <? echo $po_num_arr[$val[csf("po_number")]] ;?> </td>
						<td align="center"> <? echo change_date_format($po_date[$val[csf("po_number")]], "yyyy-mm-dd", "-");?> </td>
						<td align="center"><?  echo $pre= def_number_format($sum_woven_knit,2);  ?> </td>
						<td align="center"><?  echo $bookings= def_number_format($booking_arr[$val[csf("po_number")]],2);  ?> </td>
						<td align="center"> <?echo $short=def_number_format($short_qty_arr[$val[csf("po_number")]],2); ?> </td>
						<td align="center"> <?   $tot_short_book= str_replace(',','',$bookings) +  str_replace(',','',$short) ; echo def_number_format($tot_short_book,2); ?>  </td>
						<td align="center"> <?  $bal =str_replace(',','',$pre)-str_replace(',','',$tot_short_book) ; echo def_number_format($bal,2);  ?> </td>
						<td align="center"> <? if($bal!=0){ if($pre>$tot_short_book){echo "Less ";} else{ echo "Over";} }?> </td>


					</tr>
					<?
					$total_bom +=str_replace(',','',$pre);
					$total_book +=str_replace(',','',$bookings);
					$total_short +=str_replace(',','',$short);
					$total_short_full += str_replace(',','',$tot_short_book);
					$total_balance += str_replace(',','',$bal);

					$j++;
				}
				?>
				<tr>
					<td colspan="3" align="right"> <b> Total </b></td>
					<td align="center"><strong><? echo def_number_format($total_bom,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_book,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_short,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_short_full,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_balance,2);?> </strong> </td>
					<td>&nbsp;</td>
				</tr>
			</table>



			<?
			if($cbo_fabric_source==1 || $cbo_fabric_source==2 || $cbo_fabric_source==3){
			?>
			<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
				<tr>
					<?
					$nameArray_item_size=sql_select( "SELECT min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active =1 and d.is_deleted=0 and d.job_no in($all_jobs_id)  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
					if(count($nameArray_item_size)>0)
					{
						?>
						<td width="49%">

						</td>
						<td width="2%">
						</td>
						<?
					}
					?>
					<?
					$nameArray_item_size=sql_select( "SELECT min(c.id) as id, b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.job_no in ($all_jobs_id)  and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");

					if(count($nameArray_item_size)>0)
					{
						?>
						<td width="49%">

						</td>
						<?
					}
					?>
				</tr>
			</table>
			<br/>

			<br/>



	<?
	//------------------------------ Query for TNA start-----------------------------------
	$po_id_all=str_replace("'","",$txt_order_no_id);
	$po_num_arr=return_library_array("SELECT id,po_number from wo_po_break_down where job_no_mst in($all_jobs_id)",'id','po_number');
	$tna_start_sql=sql_select( "SELECT id,po_number_id,
	(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
	(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
	(case when task_number=60 then task_start_date else null end) as knitting_start_date,
	(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
	(case when task_number=61 then task_start_date else null end) as dying_start_date,
	(case when task_number=61 then task_finish_date else null end) as dying_end_date,
	(case when task_number=64 then task_start_date else null end) as finishing_start_date,
	(case when task_number=64 then task_finish_date else null end) as finishing_end_date,
	(case when task_number=84 then task_start_date else null end) as cutting_start_date,
	(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
	(case when task_number=86 then task_start_date else null end) as sewing_start_date,
	(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
	(case when task_number=110 then task_start_date else null end) as exfact_start_date,
	(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
	(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
	(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
	from tna_process_mst
	where status_active=1 and po_number_id in($po_id_all) and job_no in ($all_jobs_id) order by po_number_id");
 	$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
	$tna_date_task_arr=array();
	foreach($tna_start_sql as $row)
	{
		if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
		{
			if($tna_fab_start=="")
			{
				$tna_fab_start=$row[csf("fab_booking_start_date")];
			}
		}
		if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
		}
		if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
		}
		if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
		}
		if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
		}
		if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
		}
		if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
		}
		if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
		}
	}
	//------------------------------ Query for TNA end-----------------------------------
	if(count($tna_start_sql)>0 )
	{
		?>
		<br>
		<fieldset id="div_size_color_matrix" style="max-width:1000;">
			<legend>TNA Information</legend>
			<table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
				<tr>
					<td rowspan="2" align="center" valign="top">SL</td>
					<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
					<td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
					<td colspan="2" align="center" valign="top"><b>Knitting</b></td>
					<td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
					<td colspan="2" align="center" valign="top"><b>Finishing Fabric</b></td>
					<td colspan="2" align="center" valign="top"><b>Cutting </b></td>
					<td colspan="2" align="center" valign="top"><b>Sewing </b></td>
					<td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
				</tr>
				<tr>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
				</tr>
				<?
				$i=1;
				foreach($tna_date_task_arr as $order_id=>$row)
				{
					?>
					<tr>
						<td><? echo $i; ?></td>
						<td><? echo $po_num_arr[$order_id]; ?></td>
						<td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
						<td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
						<td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
					</tr>
					<?
					$i++;
				}
				?>
			</table>
		</fieldset>
		<?
	}
	}// fabric Source End
	?>
	<br>

	<table width="220"  border="0" cellpadding="2" cellspacing="0" rules="all" style="float:left">
		<tr>
			<td width="200" valign="top" align="left">

				<div id="div_size_color_matrix" style="float:left;">
					<?
					$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
					?>
					<fieldset>
						<legend>RMG Process Loss % </legend>
						<table width="180" class="rpt_table" border="1" rules="all">
							<?
							if(number_format($rmg_process_breakdown_arr[8],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Cut Panel rejection <!-- Extra Cutting % breack Down 8-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[8],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[2],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Chest Printing <!-- Printing % breack Down 2-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[2],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[10],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Neck/Sleeve Printing <!-- New breack Down 10-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[10],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[1],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Embroidery   <!-- Embroidery  % breack Down 1-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[1],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[4],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Sewing /Input<!-- Sewing % breack Down 4-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[4],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[3],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Garments Wash <!-- Washing %breack Down 3-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[3],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[15],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Gmts Finishing <!-- Washing %breack Down 3-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[15],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[11],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Others <!-- New breack Down 11-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[11],2);
										?>
									</td>
								</tr>
								<?
							}
							$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
							if($gmts_pro_sub_tot>0)
							{
								?>
								<tr>
									<td width="130">
										Sub Total <!-- New breack Down 11-->
									</td>
									<td align="right">
										<?

										echo number_format($gmts_pro_sub_tot,2);
										?>
									</td>
								</tr>
								<?
							}
							?>
						</table>
					</fieldset>


					<fieldset>
						<legend>Fabric Process Loss % </legend>
						<table width="180" class="rpt_table" border="1" rules="all">
							<?
							if(number_format($rmg_process_breakdown_arr[6],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Knitting  <!--  Knitting % breack Down 6-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[6],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[12],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Yarn Dyeing  <!--  New breack Down 12-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[12],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[5],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Dyeing & Finishing  <!-- Finishing % breack Down 5-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[5],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[13],2)>0)
							{
								?>
								<tr>
									<td width="130">
										All Over Print <!-- new  breack Down 13-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[13],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[14],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Lay Wash (Fabric) <!-- new  breack Down 14-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[14],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[7],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Dying   <!-- breack Down 7-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[7],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[0],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Cutting (Fabric) <!-- Cutting % breack Down 0-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[0],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[9],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Others  <!-- Others% breack Down 9-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[9],2);
										?>
									</td>
								</tr>
								<?
							}
							$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
							if($fab_proce_sub_tot>0)
							{
								?>
								<tr>
									<td width="130">
										Sub Total  <!-- Others% breack Down 9-->
									</td>
									<td align="right">
										<?

										echo number_format($fab_proce_sub_tot,2);
										?>
									</td>
								</tr>
								<?
							}
							if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
							{
								?>
								<tr>
									<td width="130">
										Grand Total  <!-- Others% breack Down 9-->
									</td>
									<td align="right">
										<?
										echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2);
										?>
									</td>
								</tr>
								<?
							}
							?>
						</table>
					</fieldset>
				</div>
			</td>
		</tr>
	</table>

	<table width="400"  border="0" cellpadding="2" cellspacing="0" rules="all" style="float:left">
		<tr>
			<td colspan="6" align="left"><img  src='<? echo $path.$imge_arr[$job_no]; ?>' height='155' width='200' /></td>
		</tr>
	</table>
	<br>
	<br>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
				<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
					<thead>
						<tr>
							<th width="3%"></th><th width="97%" align="left"><u>Special Instruction</u></th>
						</tr>
					</thead>
					<tbody>
						<?
						$data_array=sql_select("select id, terms from  wo_booking_terms_condition where booking_no=$txt_booking_no");
						if ( count($data_array)>0)
						{
							$i=0;
							foreach( $data_array as $row )
							{
								$i++;
								?>
								<tr id="settr_1" valign="top">
									<td style="vertical-align:top">
										<? echo $i;?>
									</td>
									<td>
										<strong style="font-size:16px"> <? echo $row[csf('terms')]; ?></strong>
									</td>
								</tr>
								<?
							}
						}
						?>
					</tbody>
				</table>
			</td>

		</tr>
	</table>
		    <table  width="100%"  border="0" cellpadding="0" cellspacing="0">
		    	<tr>
		            <td>  <?
		                    echo signature_table(121, $cbo_company_name, "1330px",1,'');
							$job_no_all= implode(",",array_unique($joball['job_no']));
							$style_sting_all=implode(",",array_unique($joball['style_ref_no']));
							echo "****".custom_file_name($txt_booking_no,$style_sting_all,$job_no_all);
		                ?>
		            </td>
		        </tr>
		    </table>
	</div>
	<?
			
			$html = ob_get_contents();
			ob_clean();
			list($is_mail_send,$mail)=explode('___',$mail_send_data);
		
			if($is_mail_send==1){
				require_once('../../../mailer/class.phpmailer.php');
				require_once('../../../auto_mail/setting/mail_setting.php');
				$mailBody = preg_replace("/<img[^>]+\>/i", " ", $html); 
				$mailBody="<br>".$mail_body	;	
				$mailToArr=array();
				$mailSql = "select b.EMAIL  from wo_booking_mst a,LIB_SUPPLIER b where b.id=a.supplier_id and a.booking_no=$txt_booking_no";
			//echo $mailSql;die;
				$mailSqlRes=sql_select($mailSql);
				foreach($mailSqlRes as $rows){
					if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
				}
				
				
				$mailSql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=99 and b.mail_user_setup_id=c.id  and c.IS_DELETED=0 and c.STATUS_ACTIVE=1";
				//echo $mailSql;die;
				$mailSqlRes=sql_select($mailSql);
				foreach($mailSqlRes as $rows){
					if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
				}
				if($mail!=''){$mailToArr[]=$mail;}
		
				$to=implode(',',$mailToArr);
				$subject="Partial fabric booking";
				$header=mailHeader();
				echo $to;
				echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
				
			}
			else{
				echo $html;
			}
			exit();
}

if($action=="print_booking_14") // md mamun ahmed sagor /06-04-2022
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' or form_name='knit_order_entry' and file_type=1",'master_tble_id','image_location');
	$company_library=return_library_array( "select id,company_name from lib_company where status_active=1 and is_deleted=0", "id", "company_name");
	$color_library=return_library_array( "select id,color_name from lib_color  where status_active=1 and is_deleted=0", "id", "color_name");
	$size_library=return_library_array( "select id,size_name from lib_size  where status_active=1 and is_deleted=0", "id", "size_name");
	$country_arr=return_library_array( "select id,country_name from   lib_country  where status_active=1 and is_deleted=0",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier  where status_active=1 and is_deleted=0",'id','supplier_name');
	$supplier_address_arr=return_library_array( "select id,address_1 from   lib_supplier  where status_active=1 and is_deleted=0",'id','address_1');


	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info  where status_active=1 and is_deleted=0","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer  where status_active=1 and is_deleted=0",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location  where status_active=1 and is_deleted=0",'id','location_name');

	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	$season_arr=return_library_array("select id,season_name from lib_buyer_season  where status_active=1 and is_deleted=0","id","season_name");
	$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where status_active=1 and is_deleted=0 and id in(select po_break_down_id from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no=$txt_booking_no)",'id','po_number');

	$uom=0;
	$joball=array();
	$nameArray_per_job=sql_select( "SELECT  a.season_buyer_wise,  a.job_no,a.style_ref_no ,a.season_matrix,a.gmts_item_id,a.product_dept,max(c.booking_date) as booking_date ,max(c.delivery_date) as delivery_date,max(c.is_approved) as is_approved,max(c.buyer_id) as buyer_id,max(c.pay_mode) as pay_mode,max(supplier_id) as supplier_id,max(a.dealing_marchant) as dealing_marchant,max(c.attention) as attention,max(c.currency_id) as currency_id ,max(c.remarks)  as remarks from wo_po_details_master a , wo_booking_dtls b,wo_booking_mst c  where c.booking_no=b.booking_no and c.status_active=1 and c.is_deleted=0 and  a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by  a.season_buyer_wise, a.job_no,a.style_ref_no ,a.season_matrix,a.gmts_item_id,a.product_dept ");
	$po_job_no="";
	foreach ($nameArray_per_job as $vals)
	{
		$joball['job_no'][$vals[csf('job_no')]]=$vals[csf('job_no')];
		$joball['style_ref_no'][$vals[csf('job_no')]]=$vals[csf('style_ref_no')];
		$all_job_arr[$vals[csf("job_no")]]["job"]="'".$vals[csf("job_no")]."'";
		$all_job_arr[$vals[csf("job_no")]]["style"]=$vals[csf("style_ref_no")];
		$all_job_arr[$vals[csf("job_no")]]["item"]=$vals[csf("gmts_item_id")];
		$all_job_arr[$vals[csf("job_no")]]["season"]=$vals[csf("season_matrix")];

		$all_job_arr_season[$vals[csf("job_no")]]=$season_arr[$vals[csf("season_buyer_wise")]];

		$all_job_arr[$vals[csf("job_no")]]["dept"]=$vals[csf("product_dept")];
		$all_job_arr_dept[$vals[csf("job_no")]]=$product_dept[$vals[csf("product_dept")]];
		$all_jobs[$vals[csf("job_no")]]="'".$vals[csf("job_no")]."'";
		$job_wise_style[$vals[csf("job_no")]]= $vals[csf("style_ref_no")];
		$po_job_no=$vals[csf('job_no')];
	}
	//echo $po_job_no.'DDD';die;
	$all_jobs_id=implode(",",$all_jobs );
	$seasons=implode(",",$all_job_arr_season );
	$depts=implode(",",$all_job_arr_dept );
 	$po_qnty_all_style=sql_select("SELECT sum(po_quantity) as qnty from wo_po_break_down where status_active=1 and is_deleted=0 and job_no_mst in ($all_jobs_id)");

 	$all_shipdates_arr=sql_select("SELECT min(b.pub_shipment_date)  as shipdate,job_no,a.order_uom as uom from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.status_active=1 and b.is_deleted=0 and  a.status_active=1 and a.is_deleted=0 and b.job_no_mst in ($all_jobs_id) group by job_no,a.order_uom");
 	$shipment_dates="";
 	$job_uom_array=array();
 	foreach($all_shipdates_arr as $key=>$data)
 	{
 		if($shipment_dates=="")
 		{
 			$shipment_dates=change_date_format($data[csf("shipdate")]);
 		}
 		else
 		{
 			$shipment_dates .=','.change_date_format($data[csf("shipdate")]);
 		}
 		$job_uom_array[$data[csf("job_no")]]=$unit_of_measurement[$data[csf("uom")]];


 	}
 	$unites=implode(",", $job_uom_array);


	$uom=0;
	$job_data_arr=array();
	$nameArray_buyer=sql_select( "SELECT  a.style_ref_no,a.style_description, a.job_no, a.style_owner, a.buyer_name, a.dealing_marchant,a.season,a.season_matrix,a.total_set_qnty,a.product_dept,a.product_code,a.pro_sub_dep,a.gmts_item_id ,a.order_repeat_no,a.qlty_label  from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  and a.job_no in ($all_jobs_id) ");

	foreach ($nameArray_buyer as $result_buy)
	{
		$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
		$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
		$job_data_arr['total_set_qnty'][$result_buy[csf('job_no')]]=$result_buy[csf('total_set_qnty')];
		$job_data_arr['product_dept'][$result_buy[csf('job_no')]]=$product_dept[$result_buy[csf('product_dept')]];
		$job_data_arr['product_code'][$result_buy[csf('job_no')]]=$result_buy[csf('product_code')];
		$job_data_arr['pro_sub_dep'][$result_buy[csf('job_no')]]=$pro_sub_dept_array[$result_buy[csf('pro_sub_dep')]];
		$job_data_arr['gmts_item_id'][$result_buy[csf('job_no')]]=$result_buy[csf('gmts_item_id')];
		$job_data_arr['style_ref_no'][$result_buy[csf('job_no')]]=$result_buy[csf('style_ref_no')];
		$job_data_arr['style_description'][$result_buy[csf('job_no')]]=$result_buy[csf('style_description')];
		$job_data_arr['dealing_marchant'][$result_buy[csf('job_no')]]=$marchentrArr[$result_buy[csf('dealing_marchant')]];
		$job_data_arr['season_matrix'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_matrix')]];
		$job_data_arr['order_repeat_no'][$result_buy[csf('job_no')]]=$result_buy[csf('order_repeat_no')];
		$job_data_arr['qlty_label'][$result_buy[csf('job_no')]]=$quality_label[$result_buy[csf('qlty_label')]];
	}
	$job_no= implode(",",array_unique($job_data_arr['job_no']));
	$job_no_in= implode(",",array_unique($job_data_arr['job_no_in']));
	$product_depertment=implode(",",array_unique($job_data_arr['product_dept']));
	$product_code=implode(",",array_unique($job_data_arr['product_code']));
	$pro_sub_dep=implode(",",array_unique($job_data_arr['pro_sub_dep']));
	$gmts_item_id=implode(",",array_unique($job_data_arr['gmts_item_id']));
	$style_sting=implode(",",array_unique($job_data_arr['style_ref_no']));
	$style_description=implode(",",array_unique($job_data_arr['style_description']));
	$dealing_marchant=implode(",",array_unique($job_data_arr['dealing_marchant']));
	$season_matrix=implode(",",array_unique($job_data_arr['season_matrix']));
	$order_repeat_no= implode(",",array_unique($job_data_arr['order_repeat_no']));
	$qlty_label= implode(",",array_unique($job_data_arr['qlty_label']));
	$path=str_replace("'","",$path);
	if($path=="")
	{
	$path='../../';
	}
	ob_start();
	?>
	<style type="text/css">

		body, p, span, td, a {font-size:10pt;font-family: Arial;}
		body{margin-left:2em; margin-right:2em; font-family: "Arial Narrow", Arial, sans-serif;}

	</style>

	<div style="width:1330px" align="center" >

		<table id="tb_header" width="100%" cellpadding="0" cellspacing="0" style="border:0px solid black" >
			<thead>
				<tr>
					<td width="150" rowspan="2"><img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100' width='100' />
					</td>
					
					<td width="400" align="left" style="font-size: 16px;"><b><?php echo $company_library[$cbo_company_name]; ?></b></td>
					<td width="100"><b>Booking No: </b><?php echo str_replace("'", "", $txt_booking_no); ?></td>
					<td width="300" align="left"rowspan="2"><img  src='<? echo $path.$imge_arr[$po_job_no]; ?>' align="left" height='200' width='200' /></td>
					<td width="150"  align="left"></td>
				</tr>
				<tr>
				
					<td width="400" align="left">
						<?
						$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
						foreach ($nameArray as $result)
						{
							?>
							Plot No: <? echo $result[csf('plot_no')]; ?>
							Level No: <? echo $result[csf('level_no')]?>
							Road No: <? echo $result[csf('road_no')]; ?>
							Block No: <? echo $result[csf('block_no')];?>
							City No: <? echo $result[csf('city')];?>
							Zip Code: <? echo $result[csf('zip_code')]; ?>
							Province No: <?php echo $result[csf('province')]; ?>
							Country: <? echo $country_arr[$result[csf('country_id')]]; ?><br>
							Email Address: <? echo $result[csf('email')];?>
							Website No: <? echo $result[csf('website')];
						}
							?>

					</td>
					<td width="100"><b>Booking Date: </b><?php echo change_date_format($nameArray_per_job[0][csf("booking_date")]); ?></td>
					
				</tr>

				<tr>
					<td width="200">&nbsp;</td>
					<td width="400" align="left" style="font-size: 16px;"><b>Fabric Booking Sheet </b></td>
					<td width="100"><b>Delivery Date: </b><?php echo change_date_format($nameArray_per_job[0][csf("delivery_date")]); ?></td>
					<td width="300" align="left"></td>
				</tr>

				<tr>
					<td colspan="3" width="700"><b>Approval Status: </b><?php if ($nameArray_per_job[0][csf("is_approved")] == 1 || $nameArray_per_job[0][csf("is_approved")] == 3) {echo "Approved";}?></td>
					<td width="300" align="left"></td>
				</tr>
				<tr>
					<td colspan="4" height="10">&nbsp;</td>
				</tr>

				<tr>
					<td width="300"><b>To</b></td>

					<td width="400" align="left"><b>Buyer Name :   </b> <? echo $buyer_name_arr[$nameArray_per_job[0][csf("buyer_id")]]; ?></td>
					<td align="left"><b>Season : </b>&nbsp;<? echo $seasons;?></td>

				</tr>
				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<tr>
					<td width="300"><?
					$pay_mode=$nameArray_per_job[0][csf("pay_mode")];//pay_mode
					if($pay_mode!=3 && $pay_mode!=5)
					{
						echo $supplier_name_arr[$nameArray_per_job[0][csf("supplier_id")]];
					}
					else
					{
						echo $company_library[$nameArray_per_job[0][csf("supplier_id")]];
					}?></td>

					<td width="400" align="left"><b>Order Qnty :   </b> <? echo $po_qnty_all_style[0][csf("qnty")]; ?>&nbsp;<? echo $unites;?></td>
					<td><b>Dept : </b> &nbsp;<? echo $depts; ?></td>
					<td></td>


				</tr>
				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<tr>
					<!-- <td width="300" ><p><b>Address: </b><? echo $supplier_address_arr[$nameArray_per_job[0][csf("supplier_id")]]; ?> </p></td> -->

					<td width="400" align="left"><b>Dealing Merchandiser:   </b> <? echo $marchentrArr[$nameArray_per_job[0][csf("dealing_marchant")]]; ?></td>

					<td width="300"><b>Attention: </b>   <? echo $nameArray_per_job[0][csf("attention")];?></td>

				   <td width="400" align="left"><b>Currency:   </b> <? echo $currency[$nameArray_per_job[0][csf("currency_id")]]; ?></td>
				</tr>
				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<!-- <tr>
				   <td colspan="2" width="800"><b>Shipment Date: </b><? echo trim($shipment_dates);?></td>

				</tr> -->


				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<tr>
				   <td width="300"><b>WO Prepared After:   </b>    </td>

				   <td width="400" align="left"><b>Remarks:   </b> <? echo $nameArray_per_job[0][csf("remarks")]; ?></td>


				</tr>
			</thead>
		</table>


			<?php
			$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and a.status_active =1 and a.is_deleted=0");
			list($nameArray_approved_row) = $nameArray_approved;
			$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
			list($nameArray_approved_date_row) = $nameArray_approved_date;
			$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
			list($nameArray_approved_comments_row) = $nameArray_approved_comments;

			$po_data = array();
			if ($db_type == 0) {
				$nameArray_job = sql_select("select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,DATEDIFF(pub_shipment_date,po_received_date) date_diff,MIN(po_received_date) as po_received_date ,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status  from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id)  group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
			}
			if ($db_type == 2) {
				$nameArray_job = sql_select("select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,(pub_shipment_date-po_received_date) date_diff,MIN(po_received_date) as po_received_date,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status   from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id) group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
			}
			foreach ($nameArray_job as $result_job) {
				$po_data['po_id'][$result_job[csf('id')]] = $result_job[csf('id')];
				$po_data['po_number'][$result_job[csf('id')]] = $result_job[csf('po_number')];
				$po_data['leadtime'][$result_job[csf('id')]] = $result_job[csf('date_diff')];
				$po_data['po_quantity'][$result_job[csf('id')]] = $result_job[csf('po_quantity')];
				$po_data['po_received_date'][$result_job[csf('id')]] = change_date_format($result_job[csf('po_received_date')], 'dd-mm-yyyy', '-');
				$ddd = strtotime($result_job[csf('pub_shipment_date')]);
				$po_data['pub_shipment_date'][$ddd] = $ddd;

				$po_data['insert_date'][$result_job[csf('id')]] = $result_job[csf('insert_date')];

				if ($result_job[csf('shiping_status')] == 1) {
					$shiping_status = "FP";
				} else if ($result_job[csf('shiping_status')] == 2) {
					$shiping_status = "PS";
				} else if ($result_job[csf('shiping_status')] == 3) {
					$shiping_status = "FS";
				}
				$po_data['shiping_status'][$result_job[csf('id')]] = $shiping_status;
				$po_data['file_no'][$result_job[csf('id')]] = $result_job[csf('file_no')];

				$po_data['grouping'][$result_job[csf('id')]] = $result_job[csf('grouping')];
			}
	$txt_order_no_id = implode(",", array_unique($po_data['po_id']));
	$leadtime = implode(",", array_unique($po_data['leadtime']));
	$po_quantity = array_sum($po_data['po_quantity']);
	$po_received_date = implode(",", array_unique($po_data['po_received_date']));
	$po_number = implode(",", array_unique($po_data['po_number']));
	$shipment_date = date('d-m-Y', min($po_data['pub_shipment_date']));
	$maxshipment_date = date('d-m-Y', max($po_data['pub_shipment_date']));
	//$shipment_date=implode(",",array_unique($po_data['pub_shipment_date']));
	$shiping_status = implode(",", array_unique($po_data['shiping_status']));
	$file_no = implode(",", array_unique($po_data['file_no']));
	$grouping = implode(",", array_unique($po_data['grouping']));

	$colar_excess_percent = 0;
	$cuff_excess_percent = 0;
	$rmg_process_breakdown = 0;
	$nameArray = sql_select("select a.buyer_id,a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.update_date,a.uom,a.remarks,a.pay_mode,a.fabric_composition from wo_booking_mst a  where   a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0");
	foreach ($nameArray as $result) {
	$total_set_qnty = $result[csf('total_set_qnty')];
	$colar_excess_percent = $result[csf('colar_excess_percent')];
	$cuff_excess_percent = $result[csf('cuff_excess_percent')];
	$rmg_process_breakdown = $result[csf('rmg_process_breakdown')];
	foreach ($po_data['po_id'] as $po_id => $po_val) {
		$daysInHand .= (datediff('d', date('d-m-Y', time()), $po_data['pub_shipment_date'][$po_id]) - 1) . ",";
		$booking_date = $result[csf('update_date')];
		if ($booking_date == "" || $booking_date == "0000-00-00 00:00:00") {
			$booking_date = $result[csf('insert_date')];
		}
		$WOPreparedAfter .= (datediff('d', $po_data['insert_date'][$po_id], $booking_date) - 1) . ",";
	}

	}

	?>
			<br/>
			<!--  Here will be the main portion  -->
			<?
			$costing_per="";
			$costing_per_qnty=0;
			$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no in($job_no_in)");
			if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;

			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";
				$costing_per_qnty=1;

			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;

			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;

			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;
			}
			$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no in($job_no_in)");
			$uom_arr=array(1=>"Pcs",12=>"Kg",23=>"Mtr",27=>"Yds");
			$p=1;

		if($cbo_fabric_source==1 || $cbo_fabric_source==2 || $cbo_fabric_source==3)
		{
			$nameArray_qty_arr = sql_select("select b.job_no_mst,b.id,a.style_ref_no,c.item_number_id,c.color_number_id,c.order_quantity   from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where  a.job_no=b.job_no_mst and c.po_break_down_id=b.id and a.job_no=c.job_no_mst and a.status_active =1 and b.status_active =1 and c.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id) and b.id in($txt_order_no_id)  ");
		//echo "select b.job_no_mst,b.id,a.style_ref_no,c.item_number_id,c.color_number_id,c.order_quantity   from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where  a.job_no=b.job_no_mst and c.po_break_down_id=b.id and a.status_active =1 and c.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id) and b.id in($txt_order_no_id)  ";
			foreach($nameArray_qty_arr as $row)
			{
				$gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][40]+=$row[csf('order_quantity')];
				$gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][50]+=$row[csf('order_quantity')];
				$fab_gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]]+=$row[csf('order_quantity')];
				$gmts_color_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]]['color'].=$row[csf('color_number_id')].',';
			}

			// $nameArray_fabric_description= sql_select("SELECT a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.body_part_type,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , b.dia_width,d.pre_cost_remarks,a.uom,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,avg(d.rate) as rates,sum(d.amount) as amounts ,d.fabric_color_id,a.color_size_sensitive,a.color_break_down,min(c.color_order) as color_order,c.job_no_mst,sum(c.order_quantity) as order_quantity_pcs,avg(b.cons) as cad_consumption,avg(b.requirment) as consumption,avg(b.process_loss_percent) as wastage,d.fin_fab_qnty,d.remark  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
			// 	WHERE a.job_no=b.job_no and
			// 	a.id=b.pre_cost_fabric_cost_dtls_id and
			// 	c.job_no_mst=a.job_no and
			// 	c.id=b.color_size_table_id and
			// 	b.po_break_down_id=d.po_break_down_id and
			// 	b.color_number_id=d.gmts_color_id and
			// 	b.dia_width=d.dia_width and
			// 	b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
			// 	a.job_no=d.job_no and
			// 	a.id=d.pre_cost_fabric_cost_dtls_id
			// 	and
			// 	d.booking_no =$txt_booking_no and
			// 	d.job_no in ($all_jobs_id) and

			// 	d.status_active=1 and
			// 	c.status_active=1 and
			// 	d.is_deleted=0 and
			// 	b.cons>0
			// 	group by  a.id , a.item_number_id, a.body_part_id,a.body_part_type,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type  , b.dia_width,d.pre_cost_remarks,a.uom ,d.fabric_color_id,a.color_size_sensitive,a.color_break_down,d.fin_fab_qnty,c.job_no_mst,d.remark  order by a.body_part_id,d.fabric_color_id ");

			$nameArray_fabric_description= sql_select("SELECT a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.body_part_type,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , b.dia_width,	d.pre_cost_remarks,a.uom ,d.fabric_color_id,a.color_size_sensitive,	a.color_break_down,c.job_no_mst,d.remark,avg(b.requirment) as consumption,avg(b.cons) as finish_cons,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_number_id=d.gmts_color_id and b.dia_width=d.dia_width and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and a.job_no=d.job_no and a.id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.job_no in ($all_jobs_id) and d.status_active=1 and c.status_active=1 and d.is_deleted=0 and b.cons>0 group by a.id , a.item_number_id, a.body_part_id,a.body_part_type,a.color_type_id, a.construction,a.composition, a.gsm_weight,a.width_dia_type , b.dia_width,d.pre_cost_remarks,a.uom ,d.fabric_color_id,a.color_size_sensitive,a.color_break_down,c.job_no_mst,d.remark order by a.item_number_id");





		

			

				


			$uom_data_arr=array();$b_part_array_not=array(40,50);
			foreach($nameArray_fabric_description as $row)
			{
				if(!in_array($row[csf('body_part_type')],$b_part_array_not))
				{
					$uom_data_arr[$row[csf('uom')]]=$row[csf('uom')];
				}
				if($row[csf('body_part_type')]==40 || $row[csf('body_part_type')]==50)
				{
					//$gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('fabric_color_id')]][$row[csf('body_part_type')]]+=$row[csf('order_quantity_pcs')];
					$gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('gmts_color_id')]][$row[csf('body_part_type')]]=$row[csf('order_quantity_pcs')];
				}
			}

			foreach($uom_data_arr as $uom_id=>$uom_val)
			{
				if(count($nameArray_fabric_description)>0)
				{

					?>

						<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
									<caption> <strong>Fabric Booking Summary </strong> </caption>
									<tr>
										<th  width="30" align="center">SL</th>
										<th  width="150" align="center">Style</th>
										<th  width="140" align="center">Gmts Item</th>
										<th  width="130" align="center">Body Parts</th>
										<th  width="100" align="center">Gmts Qty (Pcs)</th>
										<th  width="100" align="center">Plan Cut Qty (Pcs)</th>
										<th  width="390" align="left">Fabric Composition</th>
										<th  width="40" align="center">GSM</th>
										<th  width="90" align="center">Fabric Dia</th>
										<th  width="100" align="center">Color Type</th>
										<th  width="100" align="center">Combo</th>
										<th  width="110" align="center">Fabric Color</th>
										<th  width="80" align="center">CAD Consumption (Kg/Dzn)</th>
							
										<th  width="60" align="center">UOM</th>
										<!-- <th width='120' align="center"></th> -->
										<th width='120' align="center" title="Based on avg grey consumption">Finish Fab. Qty</th>
										<th width='100' align="center">Avg Rate/<? echo $unit_of_measurement[$uom_id];?></th>
										<th width='60' align="center">Amount</th>
										<th  align="center">Remarks</th>

									</tr>
									<? //wo_pre_cos_fab_co_color_dtls
									$color_wise_process_loss=sql_select("SELECT  a.body_part_id,b.color_number_id,avg(b.process_loss_percent) as loss,avg(b.requirment) as consumption FROM  wo_pre_cos_fab_co_avg_con_dtls  b,wo_pre_cost_fabric_cost_dtls a WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and  a.job_no in ($all_jobs_id)  group by a.body_part_id,b.color_number_id order by a.body_part_id,b.color_number_id");
									//echo "SELECT  a.body_part_id,b.color_number_id,avg(b.process_loss_percent) as loss,g.contrast_color_id FROM  wo_pre_cos_fab_co_avg_con_dtls  b,wo_pre_cost_fabric_cost_dtls a left join wo_pre_cos_fab_co_color_dtls g on a.job_no=g.job_no and a.id=g.pre_cost_fabric_cost_dtls_id 	WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and  a.job_no in ($all_jobs_id)  group by a.body_part_id,b.color_number_id,g.contrast_color_id";

									foreach($color_wise_process_loss as $val)
									{
										$loss_arr[$val[csf("body_part_id")]][$val[csf("color_number_id")]]=$val[csf("loss")];
										$consumption_arr[$val[csf("body_part_id")]][$val[csf("color_number_id")]]=$val[csf("consumption")];

									}

									$total_fin_fab_qnty=$total_gmt_qty_pcs=0;  $total_amount=0;  $total_grey_fab_qnty=0 ;$tot_avg=0;
									foreach($nameArray_fabric_description as $val)
									{
										if($val[csf('pre_cost_remarks')]!='') $remark_cond=" and d.pre_cost_remarks='".$val[csf('pre_cost_remarks')]."' "; else $remark_cond=" and d.pre_cost_remarks is null";
										$color_wise_wo_sql_qnty=sql_select("SELECT  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
											WHERE
											a.job_no=d.job_no and
											a.id=d.pre_cost_fabric_cost_dtls_id and
											d.booking_no =$txt_booking_no and
											d.job_no = '".$val[csf('job_no_mst')]."' and
											a.item_number_id='".$val[csf('item_number_id')]."' and
											a.body_part_id='".$val[csf('body_part_id')]."' and
											a.color_type_id='".$val[csf('color_type_id')]."' and
											a.construction='".$val[csf('construction')]."' and
											a.composition='".$val[csf('composition')]."' and
											a.gsm_weight='".$val[csf('gsm_weight')]."' and
											d.dia_width='".$val[csf('dia_width')]."' and
											a.id='".$val[csf('fabric_cost_dtls_id')]."' and
											a.uom='".$uom_id."' and

											d.fabric_color_id='".$val[csf('fabric_color_id')]."' and
											d.status_active=1 and
											d.is_deleted=0 $remark_cond
											");
										if($uom_id==$val[csf('uom')])
										{
											if($val[csf('pre_cost_remarks')]=='no remarks')  $pre_cost_remarks="";else  $pre_cost_remarks=$val[csf('pre_cost_remarks')];

											//$order_quantity_pcs=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$val[csf('fabric_color_id')]];
											//$order_quantity_pcs=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$val[csf('gmts_color_id')]];
											$order_quantity_pcs=0;
											if($val[csf('color_size_sensitive')]==1 or $val[csf('color_size_sensitive')]==2 or $val[csf('color_size_sensitive')]==4)
											{
												$gmt_colorName=$color_library[$val[csf('fabric_color_id')]];
												$order_quantity_pcs+=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$val[csf('fabric_color_id')]];
											}
											else
											{
												$color_break_down=$val[csf('color_break_down')];
												if($color_break_down)
												{
													$gmts_color="";
													if (strpos($color_break_down, '__') !== false)
													{
														$color_break_down=explode('__', $color_break_down);
														foreach ($color_break_down as $key => $value)
														{
															$cols=explode('_', $value);
															if(trim(strtolower($color_library[$val[csf('fabric_color_id')]]))==trim(strtolower($cols[2])))
															{
																if($gmts_color=="")
																{
																	$gmts_color=$cols[1];
																$order_quantity_pcs=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];

																}
																else
																{
																	$gmts_color .=','.$cols[1];
																$order_quantity_pcs+=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];

																}

															}
														}
													}
													else
													{
														$cols=explode('_', $color_break_down);
														if(trim(strtolower($color_library[$val[csf('fabric_color_id')]]))==trim(strtolower($cols[2])))
														{
															if($gmts_color=="")
															{
																$gmts_color=$cols[1];
																$order_quantity_pcs=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];

															}
															else
															{
																$gmts_color .=','.$cols[1];
																$order_quantity_pcs+=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];

															}

														}
													}

													$gmt_colorName=$gmts_color;
												}

											}

											?>
											<tr>
												<td align="center"> <? echo $p; $p++;?></td>

												
												<td align="center"> <? echo $all_job_arr[$val[csf("job_no_mst")]]["style"];?></td>
												<td align="center"> <? echo $garments_item[$val[csf("item_number_id")]];?></td>
												<td align="center"><? echo $body_part[$val[csf('body_part_id')]];?></td>
												
												<td align="center"><? echo number_format($order_quantity_pcs,2);?></td>
													<td align="center"><? echo number_format($val[csf('plan_cut_qnty')],2);?></td>
												
												<td align="left"> <? echo $val[csf('construction')].','.$val[csf('composition')].', '.$pre_cost_remarks; ?> </td>

												<td  align="center">
													<?
													echo $val[csf('gsm_weight')];
													?>
												</td>

												<td  align="center">
													<?
													echo $val[csf('dia_width')];
													?>
												</td>

												<td  align="center">
													<?
													echo $color_type[$val[csf('color_type_id')]];
													?>
												</td>
												<td  align="center">
													<?
													echo $gmt_colorName;
													?>
												</td>


												<td  align="center">
													<?
													echo $color_library[$val[csf('fabric_color_id')]];
													?>
												</td>


												
												<td align="center"> <? echo def_number_format($val[csf('consumption')],2); ?></td>
												<td align="center"> <? echo $unit_of_measurement[$val[csf('uom')]]; ?></td>

												<?
													
													$fin_fab_qnty=$color_wise_wo_sql_qnty[0][csf("fin_fab_qnty")];
													$rate=$color_wise_wo_sql_qnty[0][csf("rate")];
													$amount=$color_wise_wo_sql_qnty[0][csf("amount")];
													$avgRate=$amount/$fin_fab_qnty;

												


													?> </td> 
													<td align="center"> <? echo def_number_format($fin_fab_qnty,2); ?> </td>
													<td align="center"> <? echo def_number_format($avgRate,2); ?> </td>
													<td align="center"> <? echo def_number_format($amount,2); ?> </td>


													<?

													$total_fin_fab_qnty +=str_replace(",", "", def_number_format($greys,2));
													$total_amount +=str_replace(",", "",def_number_format($amount,2));

													$total_grey_fab_qnty +=str_replace(",", "",def_number_format($fin_fab_qnty,2));
													$total_rate +=str_replace(",", "",def_number_format($rate,2));
													$tot_avg=$total_amount/$total_grey_fab_qnty;
													$total_gmt_qty_pcs +=$order_quantity_pcs;


													?>
												<td align="center"> <? echo $val[csf('remark')]; ?> </td>


												</tr>
												<?
										}

									}
										?>
									<tr style=" font-weight:bold">

									<td  align="right" colspan="5"><strong>Total</strong></td>
									 <td align="right"><? //echo def_number_format($total_gmt_qty_pcs,2);?></td>
									<td  align="right" colspan="8">&nbsp;</td>

									<td align="center"><? echo def_number_format($total_grey_fab_qnty,2);?></td>
									<td align="center"><? echo def_number_format($tot_avg,2);?></td>
									<td align="center"><? echo def_number_format($total_amount,2);?></td>
									<td  align="right" >&nbsp;</td>

									</tr>

						</table>

					<?
				}
			}
		}


		$sql_data=sql_select("SELECT a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,a.uom,b.dia_width,b.pre_cost_remarks,b.fabric_color_id,b.remark, sum(b.grey_fab_qnty) as grey_fab_qnty,sum(b.adjust_qty)as adjust_qty FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in($all_jobs_id) and b.adjust_qty>0 and b.status_active=1 and b.is_deleted=0 group by a.id,a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,a.uom,b.dia_width,b.pre_cost_remarks,b.fabric_color_id,b.remark and a.body_part_type not in(40,50) order by a.id,a.body_part_id");
		if(count($sql_data)>0)
		{

					?>
					<br/>
			<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

					<tr>
						<td colspan="7" align="center">
							<strong>Fabric Stock Adjustment Details</strong>
						</td>

					</tr>

					<tr>
						<td align="center"> SL </td>
						<td align="center"> Item Description </td>
						<td align="center"> Fabric Color </td>
						<td align="center">UOM</td>
						<td align="center">Adjusted Qty </td>


					</tr>
					<?
					$p=1;
					foreach($sql_data as $row)
					{
						?>
						<tr>
							<td align="center"><? echo $p;?></td>
							<td align="center">
								<? echo $body_part[$row[csf('body_part_id')]].",".$row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$row[csf('dia_width')].','.$fabric_typee[$row[csf('width_dia_type')]].",".$color_type[$row[csf('color_type_id')]] ?>
							</td>

							<td align="center">
								<? echo $color_library[$row[csf('fabric_color_id')]];  ?>
							</td>
							<td align="center">
								<? echo $unit_of_measurement[$row[csf('uom')]];  ?>
							</td>


							<td align="center">
								<? echo number_format($row[csf('adjust_qty')],4) ; ?>
							</td>

						</tr>
						<?
						$p++;
					}
		}
					?>
			</table>
			<br>
				<div style="width:1330px" align="center" >
			  		<table  width="100%"  border="0" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

			  			<tr>
			  				<td colspan="10" align="center">
			  					<strong>Collar and Cuff & Other Flat Knit Fabric Breakdown</strong>
			  				</td>

			  			</tr>
			  		</table>

	        <?
	     	  $sql_collar_cuff= "SELECT a.rate, a.amount, a.job_no , a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.width_dia_type, b.gmts_color_id, b.size_number_id, b.item_size, b.gmts_qty, b.excess_per, b.qty, b.po_break_down_id as po_id, b.id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id) and a.body_part_type=40 and b.status_active=1 and b.is_deleted=0  order by a.body_part_id,b.gmts_color_id,b.id " ;
	     	  //echo $sql_collar_cuff; die;
	         $sql_data_collar_cuff=sql_select($sql_collar_cuff);
	         $size_id_array=array();
	         $size_with_item_size_array=array();
	         foreach($sql_data_collar_cuff as $vals)
	         {
	         	$body_part_cuff_array[$vals[csf("body_part_id")]]=$vals[csf("body_part_id")];
				$size_id_array[$vals[csf("size_number_id")]]=$vals[csf("size_number_id")];
	         	$size_with_item_size_array[$vals[csf("size_number_id")]][$vals[csf("body_part_id")]]=$vals[csf("item_size")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["grey"]+=$vals[csf("qty")];

	         	//$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]=$vals[csf("excess_per")];
				if($vals[csf("excess_per")]>0)
				{
				$color_wise_excess_per_arr[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]+=$vals[csf("excess_per")];
				$color_wise_excess_per_arr[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_excess_per"]+=1;
				}
	         	$color_wise_qnty[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$color_wise_qnty[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["grey"]+=$vals[csf("qty")];
	         	/*$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];*/

	         	//$color_wise_qnty[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["amount"]=$vals[csf("amount")];
				$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_rate"]=1;

	         }
			unset($sql_data_collar_cuff);
	         $sql_collar_cuff3 = sql_select("SELECT c.rate, a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id, c.gmts_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls c WHERE a.job_no=c.job_no and a.id=c.pre_cost_fabric_cost_dtls_id and  a.id=c.pre_cost_fabric_cost_dtls_id and c.booking_no =$txt_booking_no and c.job_no in ($all_jobs_id) and a.body_part_type=40 and c.status_active=1 and c.is_deleted=0  order by a.body_part_id");

	         foreach($sql_collar_cuff3 as $vals)
	         {

	         	$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];

	         }


	         $counts=count($size_id_array);


	         $size_wise_qnty_array=array();
	         ?>


			 <?
	          if(count($body_part_cuff_array)>0)
	          {		$grand_size_wise_qnty_array=array();
			  		$gr_collor_qty=0;
					 $gr_col_avg_price=0;
					 $gr_col_avg_row=0;
					 $gr_amount=0;
					 $gr_excess=0;
					foreach($body_part_cuff_array as $bpart_id=>$val)
					{
					// $sql_collar_cuff2= "SELECT a.rate,a.amount, a.job_no , a.id as fabric_cost_dtls_id,a.color_size_sensitive,a.color_break_down, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,b.gmts_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and a.body_part_id=$bpart_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id) and a.body_part_type=40  and b.status_active=1 and b.is_deleted=0  group by  a.rate,a.amount, a.job_no , a.id ,a.color_size_sensitive,a.color_break_down, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition,a.gsm_weight,a.width_dia_type,b.gmts_color_id  order by a.body_part_id,b.gmts_color_id  " ;

					$sql_collar_cuff2= " SELECT a.rate,
									         a.amount,
									         a.job_no,
									         a.id as fabric_cost_dtls_id,
									         a.color_size_sensitive,
									         a.item_number_id,
									         a.body_part_id,
									         a.color_type_id,
									         a.construction,
									         a.composition,
									         a.gsm_weight,
									         a.width_dia_type,
									         b.gmts_color_id
									    from wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b,wo_booking_dtls c ,wo_pre_cos_fab_co_avg_con_dtls d
									    where     a.job_no = b.job_no
									         and a.id = b.pre_cost_fabric_cost_dtls_id
									         and b.booking_no=c.booking_no
									         and b.po_break_down_id=c.po_break_down_id
									         and b.pre_cost_fabric_cost_dtls_id=c.pre_cost_fabric_cost_dtls_id
									         and b.gmts_color_id=c.gmts_color_id
									        and  a.id=d.pre_cost_fabric_cost_dtls_id
									        and d.gmts_sizes=b.size_number_id
									        and c.status_active = 1
									        and c.is_deleted = 0
								         and a.body_part_id=$bpart_id 
								         and b.booking_no =$txt_booking_no 
								         and b.job_no in ($all_jobs_id) 
								         and a.body_part_type=40  
								         and b.status_active=1 
								         and b.is_deleted=0 
								    group by  a.rate,a.amount, a.job_no , a.id ,a.color_size_sensitive,a.color_break_down, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition,a.gsm_weight,a.width_dia_type,b.gmts_color_id  order by a.body_part_id,b.gmts_color_id  " ;
	          $sql_data_collar_cuff2=sql_select($sql_collar_cuff2);
					?>
					 <table align="left"  width="100%" style="margin-top: 5px;" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" >
			  			<tr>
			  				<td colspan="<? echo $counts+13;?>" align="center">
			  					<strong>Collar Details(<? echo $body_part[$bpart_id];?>)</strong>
			  				</td>

			  			</tr>
			  			<tr>
			  				<td  width="30"  rowspan="2" align="center"><strong>SL</strong> </td>
			  				<td  width="150" rowspan="2" align="center"><strong>Style</strong></td>
 			  				<td  width="140"  rowspan="2" align="center"><strong>Gmts Item</strong></td>
 			  				<td  width="100"  rowspan="2" align="center"><strong>Body Part</strong></td>
							<td  width="100" rowspan="2" align="center"><strong>Actual Qty(Pcs)</strong></td>
			  				<td  width="390" rowspan="2" align="left">&nbsp;&nbsp;<strong>Collar Composition</strong></td>
			  				<td  width="100"  rowspan="2" align="center"><strong>Color Type</strong></td>
 			  				<td  width="100"  rowspan="2"  align="center"><strong>Combo</strong></td>
							<td  width="100"  rowspan="2"  align="center"><strong>Fabric Color</strong></td>
 			  				<?
 			  				foreach($size_id_array as $id=>$val)
 			  				{
 			  					?>
 			  					<td width="40" align="center"><strong><? echo $size_library[$id];?></strong></td>

 			  					<?
 			  				}
 			  				?>
			  				<td width="60"  rowspan="2" align="center"><strong> Req Qty (Pcs)</strong> </td>
			  				<td  width="50" rowspan="2"  align="center"><strong> Excess %  </strong> </td>
			  				<td width="50" rowspan="2"  align="center"><strong>Price/Pcs</strong></td>
			  				<td  width="40" rowspan="2" align="center"><strong>Amount</strong></td>


			  			</tr>
			  			<tr>
			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					//$size_with_item=rtrim($size_with_item_size_array[$id],',');
								//$size_with_item=implode(",",array_unique(explode(",",$size_with_item)));
								?>
			  					<td  align="center"><? echo $size_with_item_size_array[$id][$bpart_id];?></td>

			  					<?
			  				}
			  				?>

			  			</tr>
			  			<?
			  			$p=1;
			  			foreach($sql_data_collar_cuff2 as $row)
			  			{

							?>
			  				<tr>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="30" align="center"><? echo $p;?></td>
			  					<td style="word-break: break-all;word-wrap: break-word;" width="150" align="center"><? echo $job_wise_style[$row[csf("job_no")]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="140" align="center"><?  $item_id= $row[csf('item_number_id')];echo $garments_item[$item_id]; ?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center"><? echo $body_part[$row[csf("body_part_id")]];?></td>
								<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center"><? $gmt_actual_qty=$gmts_qty_data_arr[$row[csf('job_no')]][$item_id][$row[csf('gmts_color_id')]][40];echo number_format($gmt_actual_qty,0);$total_gmt_actual_qty+=$gmt_actual_qty;?></td>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="390" align="left"> &nbsp;
			  						<? echo $row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$fabric_typee[$row[csf('width_dia_type')]] ;?>
			  					</td>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="100" align="center"><? echo $color_type[$row[csf('color_type_id')]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center">
			  						<? echo $color_library[$row[csf('gmts_color_id')]];  ?>
			  					</td>
								<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center">
			  						<?
										if($row[csf('color_size_sensitive')]==1 or $row[csf('color_size_sensitive')]==2 or $row[csf('color_size_sensitive')]==4)
										{
											$gmt_fab_color=$color_library[$row[csf('gmts_color_id')]];
										}
										else
										{
											$contrast_color_id=return_field_value("b.contrast_color_id as contrast_color_id", "wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b", "a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.job_no in ($all_jobs_id) and a.id=".$row[csf('fabric_cost_dtls_id')]."  and b.gmts_color_id=".$row[csf('gmts_color_id')]." ","contrast_color_id");//pre_cost_fabric_cost_dtls_id
											if($contrast_color_id>0)
											{
												$gmt_fab_color=$color_library[$contrast_color_id];
											}
										}
									echo $gmt_fab_color;  ?>
			  					</td>


			  					<?
								$color_qty=0; $greyQty=0;
			  					foreach($size_id_array as $id=>$val)
			  					{
			  						?>
			  						<td  style="word-break: break-all;word-wrap: break-word;" width="40"  align="center"><? echo $cuff_grey_qty=$size_item_wise_qnty[$row[csf("body_part_id")]][$row[csf("fabric_cost_dtls_id")]][$row[csf("gmts_color_id")]][$id][$size_with_item_size_array[$id][$bpart_id]]["grey"];//.'K '.$row[csf("fabric_cost_dtls_id")].'='.$row[csf("gmts_color_id")].'='.$id.'='.$size_with_item_size_array[$id];
									?></td>

			  						<?
			  						$size_wise_qnty_array[$id]+=$val;
									$grand_size_wise_qnty_array[$id]+=$cuff_grey_qty;$sub_size_wise_qnty_array[$bpart_id][$id]+=$cuff_grey_qty;
									$color_qty+=$cuff_grey_qty;

			  					}
								$row_excess_per= $color_wise_excess_per_arr[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf("gmts_color_id")]][$item_id]["row_excess_per"];
			  					?>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="60" align="center">
			  						<? echo $grey_qnty=$color_qty;//$color_wise_qnty[$row[csf('gmts_color_id')]][$item_id]["grey"];  ?>
			  					</td>

			  					<td  style="word-break: break-all;word-wrap: break-word;" title="<? echo $row_excess_per;?>" width="50" align="center">
			  						<?  $excess= $color_wise_excess_per_arr[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf("gmts_color_id")]][$item_id]["excess_per"]/$row_excess_per;
									echo number_format($excess,2);
									  ?>
			  					</td>


			  					<td style="word-break: break-all;word-wrap: break-word;" title="<? echo $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["row_rate"];?>"  width="50" align="center">
			  						<? echo  $cuff_price=$color_wise_qnty2[$row[csf("fabric_cost_dtls_id")]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["rate"];
										//$tot_row_rate=$color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["row_rate"];  ?>
			  					</td>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="40" align="center">
			  						<? echo $amount=$grey_qnty*$cuff_price;   ?>
			  					</td>
			  				</tr>
			  				<?

							$sub_collor_qty_arr[$row[csf("body_part_id")]]+=$grey_qnty;
							$sub_collor_amount_arr[$row[csf("body_part_id")]]+=$amount;

							$sub_excess_arr[$row[csf("body_part_id")]]+=$excess;
							$sub_price_arr[$row[csf("body_part_id")]]+=$cuff_price;
							$cuff_body_wise_avg_row[$row[csf("body_part_id")]]+=1;

							$gr_fin_qty+=$fin_qty;
			  				$gr_collor_qty+=$grey_qnty;
							$gr_amount+=$amount;
			  				$gr_excess+=$excess ;
			  				$gr_col_avg_price+=$cuff_price;
			  				$gr_col_avg_row++;



			  				$p++;
			  			}
			  			?>
						<tr class="tbl_bottom">
							<td colspan="9" align="right">Total </td>
							<?
							foreach($size_id_array as $id=>$val)
							{
								?>
								<td  align="center"><? echo $sub_size_wise_qnty_array[$bpart_id][$id];?></td>

								<?
							}
							$cuff_sub_excess=$sub_excess_arr[$bpart_id];
							$cuff_sub_price=$sub_price_arr[$bpart_id];
							$cuff_body_wise_avg_tot_row=$cuff_body_wise_avg_row[$bpart_id];
							?>
							<td align="center">
								<? echo $sub_collor_qty_arr[$bpart_id];  ?>
							</td>
							<td align="center" title="Sub Exess & sub Row=<? echo $cuff_sub_excess.'='.$cuff_body_wise_avg_tot_row ?>">
									<? echo number_format($cuff_sub_excess/$cuff_body_wise_avg_tot_row,2); ?></td>
							<td align="center"><? echo number_format($cuff_sub_price/$cuff_body_wise_avg_tot_row,2); ?></td>

							<td align="center">
								<? echo $sub_collor_amount_arr[$bpart_id];   ?>
							</td>
			  			</tr>
						<!--Sub TOT End-->


			  			<?
						} //Body Part End
						?>

						<tr>
			  				<td colspan="9" align="right">Grand Total </td>
			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td  align="center"><? echo $grand_size_wise_qnty_array[$id];?></td>

			  					<?
			  				}
			  				?>
			  				<td align="center">
			  					<? echo $gr_collor_qty;  ?>
			  				</td>
			  				<td align="center" title="Sub Exess & Tot Row=<? echo $gr_excess.'='.$gr_avg_row ?>"><? echo number_format($gr_excess/$gr_col_avg_row,2); ?></td>
							<td align="center"  title="Tot Price  & Tot Row=<? echo $gr_col_avg_price.'='.$gr_col_avg_row.'**'.$p?>"><? //echo number_format($gr_col_avg_price/$gr_col_avg_row,2); ?></td>

			  				<td align="center">
			  					<? echo $gr_amount;   ?>
			  				</td>
			  			</tr>

						</table>
						<?
			  		}
			  	?>


					<br/><br/>

						<?
	     	  $sql_collar_cuff= "SELECT a.rate,a.amount, a.job_no , a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,b.gmts_color_id,b.size_number_id,b.item_size,b.gmts_qty,b.excess_per,b.qty,b.po_break_down_id as po_id,b.id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id) and a.body_part_type=50 and b.status_active=1 and b.is_deleted=0  order by a.body_part_id,b.gmts_color_id,b.id " ;
	         $sql_data_collar_cuff=sql_select($sql_collar_cuff);
	         $size_id_array=array();
	         $size_with_item_size_array=array();
	         $size_item_wise_qnty=array();
	         $color_wise_qnty=array();
	         foreach($sql_data_collar_cuff as $vals)
	         {
	         	$body_part_array[$vals[csf("body_part_id")]]=$vals[csf("body_part_id")];
				$size_id_array[$vals[csf("size_number_id")]]=$vals[csf("size_number_id")];
	         	$size_with_item_size_array[$vals[csf("size_number_id")]][$vals[csf("body_part_id")]]=$vals[csf("item_size")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["grey"]+=$vals[csf("qty")];

	         	//$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]=$vals[csf("excess_per")];
				if($vals[csf("excess_per")]>0)
				{
				$color_wise_excess_per_cuff_arr[$vals[csf('fabric_cost_dtls_id')]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]+=$vals[csf("excess_per")];
				$color_wise_excess_per_cuff_arr[$vals[csf('fabric_cost_dtls_id')]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_excess_per"]+=1;
				}
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["grey"]+=$vals[csf("qty")];
	         	/*$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];*/
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["amount"]=$vals[csf("amount")];
				$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_rate"]=1;

	         }
				unset($sql_data_collar_cuff);
	         $sql_collar_cuff3 = sql_select("SELECT c.rate, a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id, c.gmts_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls c WHERE a.job_no=c.job_no and a.id=c.pre_cost_fabric_cost_dtls_id and  a.id=c.pre_cost_fabric_cost_dtls_id and c.booking_no =$txt_booking_no and c.job_no in ($all_jobs_id) and a.body_part_type=50 and c.status_active=1 and c.is_deleted=0  order by a.body_part_id");

	         foreach($sql_collar_cuff3 as $vals)
	         {

	         	$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];

	         }


	         $counts=count($size_id_array);$grand_size_wise_qnty_array=array();
	          if(count($body_part_array)>0)
	          {
					$gr_collor_qty=$gr_amount=$gr_avg_price=$gr_avg_row=$gr_excess=0;
					foreach($body_part_array as $bpart_id=>$val)
					{
					// $sql_collar_cuff2= "SELECT a.rate,a.amount, a.job_no , a.id as fabric_cost_dtls_id,a.color_size_sensitive, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,b.gmts_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and a.body_part_id=$bpart_id and b.job_no in ($all_jobs_id) and a.body_part_type=50  and b.status_active=1 and b.is_deleted=0  group by  a.rate,a.amount, a.job_no , a.id , a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition,a.gsm_weight,a.width_dia_type,b.gmts_color_id,a.color_size_sensitive  order by a.body_part_id,b.gmts_color_id  " ;

					$sql_collar_cuff2= "SELECT a.rate,
								         a.amount,
								         a.job_no,
								         a.id as fabric_cost_dtls_id,
								         a.color_size_sensitive,
								         a.item_number_id,
								         a.body_part_id,
								         a.color_type_id,
								         a.construction,
								         a.composition,
								         a.gsm_weight,
								         a.width_dia_type,
								         b.gmts_color_id
								    from wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b,wo_booking_dtls c ,wo_pre_cos_fab_co_avg_con_dtls d
								    where     a.job_no = b.job_no
								         and a.id = b.pre_cost_fabric_cost_dtls_id
								         and b.booking_no=c.booking_no
								         and b.po_break_down_id=c.po_break_down_id
								         and b.pre_cost_fabric_cost_dtls_id=c.pre_cost_fabric_cost_dtls_id
								         and b.gmts_color_id=c.gmts_color_id
								        and  a.id=d.pre_cost_fabric_cost_dtls_id
								        and d.gmts_sizes=b.size_number_id
								        and c.status_active = 1
								        and c.is_deleted = 0
								         and b.booking_no =$txt_booking_no 
								         and a.body_part_id=$bpart_id 
								         and b.job_no in ($all_jobs_id) 
								         and a.body_part_type=50  
								         and b.status_active=1 
								         and b.is_deleted=0  
								   group by  
								         a.rate,a.amount, a.job_no ,
								          a.id , a.item_number_id, 
								          a.body_part_id,a.color_type_id,
								           a.construction, a.composition,a.gsm_weight,a.width_dia_type,b.gmts_color_id,a.color_size_sensitive  order by a.body_part_id,b.gmts_color_id  " ;
	          $sql_data_collar_cuff2=sql_select($sql_collar_cuff2);
					?>

			  	 <table align="left"  width="100%" style="margin-top: 5px; margin-bottom:10px;"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" >
			  			<tr>
			  				<td colspan="<? echo $counts+13;?>" align="center">
			  					<strong>Cuff Details &nbsp;(<? echo  $body_part[$bpart_id];?>) </strong>
			  				</td>
			  			</tr>
			  			<tr>
			  				<td  width="30"  rowspan="2" align="center"><strong>SL</strong> </td>
			  				<td  width="150" rowspan="2" align="center"><strong>Style</strong></td>
 			  				<td  width="140" rowspan="2" align="center"><strong>Gmts Item</strong></td>
 			  				<td  width="100" rowspan="2" align="center"><strong>Body Part</strong></td>
							<td  width="100" rowspan="2" align="center"><strong>Actual Qty(Pcs)</strong></td>
			  				<td  width="390" rowspan="2" align="left">&nbsp;&nbsp;<strong>Cuff Composition</strong></td>
			  				<td  width="100" rowspan="2" align="center"><strong>Color Type</strong></td>
 			  				<td  width="100" rowspan="2"  align="center"><strong>Combo</strong></td>
							<td  width="100" rowspan="2"  align="center"><strong>Fabric Color</strong></td>
 			  				<?
 			  				foreach($size_id_array as $id=>$val)
 			  				{
 			  					?>
 			  					<td width="40" align="center"><strong><? echo $size_library[$id];?></strong></td>

 			  					<?
 			  				}
 			  				?>

			  				<td width="60"  rowspan="2" align="center"><strong> Req Qty(Pcs) </strong> </td>
			  				<td  width="50" rowspan="2"  align="center"><strong> Excess %  </strong> </td>

			  				<td width="50" rowspan="2"  align="center"><strong>Price/Pcs</strong></td>
			  				<td  width="40" rowspan="2" align="center"><strong>Amount</strong></td>
			  			</tr>
			  			<tr>
			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td width="40"  align="center"><strong><? echo $size_with_item_size_array[$id][$bpart_id];?></strong></td>
			  					<?
			  				}
			  				?>
			  			</tr>
			  			<?
			  			$p=1;
			  			$size_wise_qnty_array=array();
			  			foreach($sql_data_collar_cuff2 as $row)
			  			{
							?>
			  				<tr>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="30" align="center"><? echo $p;?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="150" align="center"><? echo $job_wise_style[$row[csf("job_no")]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="140" align="center"><?  $item_id= $row[csf('item_number_id')];echo $garments_item[$item_id]; ?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center"><? echo $body_part[$row[csf("body_part_id")]];?></td>
								<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center"><? $gmt_actual_qty=$gmts_qty_data_arr[$row[csf('job_no')]][$item_id][$row[csf('gmts_color_id')]][50];echo number_format($gmt_actual_qty,0);$total_gmt_actual_qty+=$gmt_actual_qty;?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="390" align="left"> &nbsp;
			  						<? echo $row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$fabric_typee[$row[csf('width_dia_type')]] ;?>
			  					</td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center"><? echo $color_type[$row[csf('color_type_id')]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center">
			  						<? echo $color_library[$row[csf('gmts_color_id')]];  ?>
			  					</td>
								<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center">
			  						<?
									if($row[csf('color_size_sensitive')]==1 or $row[csf('color_size_sensitive')]==2 or $row[csf('color_size_sensitive')]==4)
										{
											$gmt_fab_color=$color_library[$row[csf('gmts_color_id')]];
										}
										else
										{
											$contrast_color_id=return_field_value("b.contrast_color_id as contrast_color_id", "wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b", "a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.job_no in ($all_jobs_id) and a.id=".$row[csf('fabric_cost_dtls_id')]."  and b.gmts_color_id=".$row[csf('gmts_color_id')]." ","contrast_color_id");//pre_cost_fabric_cost_dtls_id
											if($contrast_color_id>0)
											{
												$gmt_fab_color=$color_library[$contrast_color_id];
											}
										}
									echo $gmt_fab_color;   ?>
			  					</td>

			  					<?
								$tot_size_qty=0;
			  					foreach($size_id_array as $id=>$val)
			  					{
			  						?>
			  						<td  style="word-break: break-all;word-wrap: break-word;"  width="40"  align="center"><? echo $size_grey_qty=$size_item_wise_qnty[$row[csf("body_part_id")]][$row[csf('fabric_cost_dtls_id')]][$row[csf("gmts_color_id")]][$id][$size_with_item_size_array[$id][$row[csf("body_part_id")]]]["grey"];?></td>

			  						<?
			  						$size_wise_qnty_array[$id]+=$size_grey_qty;$sub_size_wise_qnty_array[$row[csf("body_part_id")]][$id]+=$size_grey_qty;
									$grand_size_wise_qnty_array[$id]+=$size_grey_qty;
									$tot_size_qty+=$size_grey_qty;

			  					}
			  					?>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="60" align="center">
			  						<? echo $grey_qnty=$tot_size_qty;//$color_wise_qnty[$row[csf('gmts_color_id')]][$item_id]["grey"];
									$row_excess_per=$color_wise_excess_per_cuff_arr[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf("gmts_color_id")]][$item_id]["row_excess_per"];
									 ?>
			  					</td>

			  					<td  style="word-break: break-all;word-wrap: break-word;" title="excess tot=<? echo $row_excess_per; ?>"  width="50" align="center">
			  						<?  $avg_excess=$color_wise_excess_per_cuff_arr[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf("gmts_color_id")]][$item_id]["excess_per"]/$row_excess_per;echo number_format($avg_excess,2);   ?>
			  					</td>
			  					<td   style="word-break: break-all;word-wrap: break-word;" width="50" title="<? echo $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["row_rate"];?>" align="center">
			  						<? echo $price= $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["rate"];
									$tot_row_rate= $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["row_rate"]; ?>

			  					</td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="40" align="center">
			  						<? echo  $amount=$grey_qnty* $price;   ?>
			  					</td>

			  				</tr>
			  				<?
			  				$sub_collor_qty_arr[$row[csf("body_part_id")]]+=$grey_qnty;
							$sub_collor_amount_arr[$row[csf("body_part_id")]]+=$amount;
							$sub_excess_arr[$row[csf("body_part_id")]]+=$avg_excess;
							$sub_price_arr[$row[csf("body_part_id")]]+=$price;
							$body_wise_avg_row[$row[csf("body_part_id")]]+=1;

							$gr_fin_qty+=$fin_qty;
			  				$gr_collor_qty+=$grey_qnty;
			  				$gr_avg_price+=$price;
							$gr_amount+=$amount;
			  				$gr_excess+=$avg_excess;

			  				$gr_avg_row++;

			  				$p++;
			  			}
			  			?>

			  			<tr>
			  				<td colspan="9" align="right">Total </td>
			  				<?
							//$sub_size_wise_qnty_array=array();
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td  align="center"><? echo $sub_size_wise_qnty_array[$bpart_id][$id];
								//$sub_size_wise_qnty_array[$row[csf("body_part_id")]][$id]=0;
								/*$grand_size_wise_qnty_array[$id]+=$sub_size_wise_qnty_array[$bpart_id][$id];*/
								?></td>
			  					<?
			  				}
							$tot_avg_row=$body_wise_avg_row[$bpart_id];
							$tot_sub_excess=$sub_excess_arr[$bpart_id];
							$tot_sub_price=$sub_price_arr[$bpart_id];
			  				?>
			  				<td align="center">
			  					<? echo $sub_collor_qty_arr[$bpart_id];  ?>
			  				</td>
			  				<td align="center" title="Tot Excess & Tot Row=<? echo $tot_sub_excess.'='.$tot_avg_row;?>"><? echo number_format($tot_sub_excess/$tot_avg_row,2); ?></td>
			  				<td align="center">
			  					<? echo number_format($tot_sub_price/$tot_avg_row,2);  ?>
			  				</td>
			  				<td align="center">
			  					<? echo $sub_collor_amount_arr[$bpart_id];   ?>
			  				</td>
			  			</tr>
			  			<?
						} //Body Part End

			  		?>
					<tr>
			  				<td colspan="9" align="right">Grand Total </td>
			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td  align="center"><? echo $grand_size_wise_qnty_array[$id];?></td>
			  					<?
			  				}
			  				?>
			  				<td align="center">
			  					<? echo $gr_collor_qty;  ?>
			  				</td>
			  				<td align="center" title="grand Excess &tot row=<? echo $gr_excess.'='.$gr_avg_row;?>"><? echo number_format($gr_excess/$gr_avg_row,2); ?></td>
			  				<td align="center">
			  					<? //echo number_format($gr_avg_price/$gr_avg_row,2);  ?>
			  				</td>
			  				<td align="center">
			  					<? echo $gr_amount;   ?>
			  				</td>
			  			</tr>
			  	</table>
				<?
					}
				?>

				</div>
				<br>
				<?
		$color_name_arr=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0",'id','color_name');
		$sql_stripe=("select c.id,c.job_no,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.id as did,d.uom,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,c.uom as type_uom from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and d.job_no in($all_jobs_id) and b.booking_no=$txt_booking_no  and c.color_type_id in (2,6) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and b.is_deleted=0  group by c.id,c.job_no,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.uom,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,c.composition,c.construction,b.dia_width,c.uom order by c.job_no,c.id,d.id ");
		$result_data=sql_select($sql_stripe);
		foreach($result_data as $row)
		{
		$style_ref_no=$job_data_arr['style_ref_no'][$row[csf('job_no')]];
		//echo $style_ref_no.'XXXX';
			//$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['style_ref_no'][$row[csf('did')]]=$style_ref_no;
			if($row[csf('type_uom')]==12){
				$type_uom_arr[$row[csf('type_uom')]]='kg';
			}elseif($row[csf('type_uom')]==1){
				$type_uom_arr[$row[csf('type_uom')]]='pcs';
			}
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['type_uom']=$row[csf('type_uom')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['stripe_color']=$row[csf('stripe_color')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['measurement']=$row[csf('measurement')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['fabreqtotkg']+=$row[csf('fabreqtotkg')];
			//$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['yarn_dyed']=$row[csf('yarn_dyed')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['fabric_description']=$row[csf('fabric_description')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['uom']=$row[csf('uom')];
		
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['style_ref_no']=$style_ref_no;

			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabric_description']=$row[csf('fabric_description')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['style_ref_no']=$style_ref_no;
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom']=$row[csf('uom')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg']+=$row[csf('fabreqtotkg')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['type_uom']=$row[csf('type_uom')];
		}
	
	// print_r($type_uom_arr);

		foreach($type_uom_arr as $uom_id=>$uom_arr){
		?>
			

			<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
       		 <caption> <strong style="float:left"> Stripe Details (<?=$uom_arr;?>)</strong></caption>
      

            <tr>
                <th width="30"> SL</th>
                <th width="100">Style</th>
				<th width="100">Body Part</th>
				<th width="100">Fab. Desc.</th>
                <th width="80">Gmts Color</th>
                <th width="70">Fabric Qty(<?=$uom_arr;?>)</th>
                <th width="70">Stripe Color</th>
                <th width="70">Stripe Measurement</th>
				<th  width="70">Stripe Uom</th>
                <th  width="70">Qty.(<?=$uom_arr;?>)</th>

				<th  width="70">Y/D Req.</th>
            </tr>
            <?
				$job_strip_color_rowspan=array();$fab_strip_color_rowspan=array();$color_strip_color_rowspan=array();
			  foreach($stripe_arr as $job_id=>$job_data)
			  {	 $job_row_span=0;
					 foreach($job_data as $body_id=>$body_data)
					 {
						   $fab_row_span=0;
						   foreach($body_data as $color_id=>$color_data)
						   {
								$color_row_span=0;
								foreach($color_data as $strip_color_id=>$color_val)
								{
									$job_row_span++;$fab_row_span++;$color_row_span++;

								}
								$job_strip_color_rowspan[$job_id]=$job_row_span;
								$fab_strip_color_rowspan[$job_id][$body_id]=$fab_row_span;
								$color_strip_color_rowspan[$job_id][$body_id][$color_id]=$color_row_span;
								$color_strip_color_qty_arr[$job_id][$body_id][$color_id]=$stripe_arr2[$job_id][$body_id][$color_id]['fabreqtotkg'];


						   }
					 }
			  }
			 // print_r($job_strip_color_rowspan);


			$i=1;$total_fab_qty=0;$total_fabreqtotkg=$total_color_qty=0;$fab_data_array=array();
            foreach($stripe_arr as $job_id=>$job_data)	{
			 $job_span=1;
			 foreach($job_data as $body_id=>$body_data)    {
			  $fab_span=1;
			   foreach($body_data as $color_id=>$color_data)  {
			     $color_span=1;
				foreach($color_data as $strip_color_id=>$color_val)   {
					//$rowspan=count($color_val['stripe_color']);

					if($uom_id==$color_val['type_uom'])
					{
					?>
					<tr>
					<?

					if($job_span==1)
					{
					?>
                        <td align="center" rowspan="<? echo $job_strip_color_rowspan[$job_id];?>"> <? echo $i; ?></td>
                        <td align="center" title="<? echo $job_id;?>" rowspan="<? echo $job_strip_color_rowspan[$job_id];?>"> <? echo $color_val['style_ref_no']; ?></td>
						<?
					}
					if($fab_span==1)
					{
						?>
						<td align="center" rowspan="<? echo $fab_strip_color_rowspan[$job_id][$body_id];?>"> <? echo $body_part[$body_id]; ?></td>
						<td align="center" rowspan="<? echo $fab_strip_color_rowspan[$job_id][$body_id];?>"> <? echo $color_val['fabric_description']; ?></td>
						<?
					}
					if($color_span==1)
					{
					$color_qty= $color_strip_color_qty_arr[$job_id][$body_id][$color_id];//$color_val['fabreqtotkg'];
					$total_color_qty+=$color_qty;
					?>
                        <td rowspan="<? echo $color_strip_color_rowspan[$job_id][$body_id][$color_id];?>" align="center"> <? echo $color_name_arr[$color_id]; ?></td>
                        <td rowspan="<? echo $color_strip_color_rowspan[$job_id][$body_id][$color_id];?>" align="center"> <? echo number_format($color_qty,2); ?></td>
					<?
					}

						?>
						<td align="center"><?  echo  $color_name_arr[$strip_color_id]; ?></td>
						<td align="center"> <? echo  number_format($color_val['measurement'],2); ?></td>
						<td align="center"> <? echo  $unit_of_measurement[$color_val['uom']]; ?></td>
						<td align="center" title="Stripe Measurement/Tot Stripe Measurement*Fabric Qty(KG)"> <? echo  number_format($color_val['fabreqtotkg'],2); ?></td>

						<td align="center"> <? echo  $yes_no[$color_val['yarn_dyed']]; ?></td>
					</tr>
						<?
					
						$total_fabreqtotkg+=$color_val['fabreqtotkg'];

					$job_span++;$fab_span++;$color_span++;
					}
				  }
				}
				$i++;
			}
			}
			?>
        <tfoot>
        <tr>
            <td align="right" colspan="5">Total </td>
            <td align="center"><? echo  number_format($total_color_qty,2); ?> </td>
            <td></td>
            <td></td>

            <td> </td>
			 <td align="center"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
			<td> </td>
        </tr>
        </tfoot>
   </table>
   <?}?>
   <br/>
			<table  style="margin-top: 5px;float: left;"    width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

				<tr>
					<td colspan="10" align="center">
						<strong>Comments</strong>
					</td>
				</tr>
				<tr>
					<td align="center"> SL </td>
					<td align="center" width="200"  style="word-wrap: break-word;word-break: break-all;"> PO NO </td>
					<td align="center"> Ship Date </td>
					<td align="center">BOM Qty</td>
					<td align="center"> Booking Qty </td>
					<td align="center"> Short Booking Qty </td>
					<td align="center"> Total Booking Qty </td>
					<td align="center"> Balance </td>
					<td align="center"> Comments </td>
				</tr>
				<?
				$is_short_data=sql_select("SELECT a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0   and b.is_short =1 group by  a.id ");
				foreach($is_short_data as $vals)
				{
					$short_qty_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
				}

				$booking_data=sql_select("SELECT a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and  b.status_active=1 and b.is_deleted=0 and b.is_short !=1 and b.booking_type=1 group by  a.id  order by a.id");
				foreach($booking_data as $vals)
				{
					$booking_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
				}

				$po_date=return_library_array("select id,shipment_date from wo_po_break_down where status_active=1 and is_deleted=0",'id','shipment_date');

				$comments_data=sql_select("SELECT min(a.id) as ids,b.po_break_down_id as po_number,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,SUM(b.requirment) as precost_grey_qty FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id
					and
					b.po_break_down_id=d.po_break_down_id and
					b.color_number_id=d.gmts_color_id and
					b.dia_width=d.dia_width and
					b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					a.job_no=d.job_no and
					a.id=d.pre_cost_fabric_cost_dtls_id
					and
					d.booking_no =$txt_booking_no and
					d.job_no in($all_jobs_id) and

					d.status_active=1 and
					d.is_deleted=0 and
					b.cons>0
					group by b.po_break_down_id order by b.po_break_down_id");



				$job_no=$all_jobs_id;
				$condition= new condition();
				if(str_replace("'","",$job_no) !='')
				{
					$condition->job_no("in ($job_no)");
				}
				$condition->init();
				$fabric= new fabric($condition);
				$fabric_costing_qty_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish();

				$j=1;
				$total_bom=0;
				$total_book=0;
				$total_short=0;
				$total_short_full=0;
				$total_balance=0;
				foreach($comments_data as $val)
				{
					$po_id=$val[csf('po_number')];
					$woven_qty=array_sum($fabric_costing_qty_arr['woven']['grey'][$po_id]);
					$knit_qty=array_sum($fabric_costing_qty_arr['knit']['grey'][$po_id]);
					$sum_woven_knit=$woven_qty + $knit_qty;


					?>
					<tr>
						<td align="center"><? echo $j;?></td>

						<td align="center"  style="word-wrap: break-word;word-break: break-all;"> <? echo $po_num_arr[$val[csf("po_number")]] ;?> </td>
						<td align="center"> <? echo change_date_format($po_date[$val[csf("po_number")]], "yyyy-mm-dd", "-");?> </td>
						<td align="center"><?  echo $pre= def_number_format($sum_woven_knit,2);  ?> </td>
						<td align="center"><?  echo $bookings= def_number_format($booking_arr[$val[csf("po_number")]],2);  ?> </td>
						<td align="center"> <?echo $short=def_number_format($short_qty_arr[$val[csf("po_number")]],2); ?> </td>
						<td align="center"> <?   $tot_short_book= str_replace(',','',$bookings) +  str_replace(',','',$short) ; echo def_number_format($tot_short_book,2); ?>  </td>
						<td align="center"> <?  $bal =str_replace(',','',$pre)-str_replace(',','',$tot_short_book) ; echo def_number_format($bal,2);  ?> </td>
						<td align="center"> <? if($bal!=0){ if($pre>$tot_short_book){echo "Less ";} else{ echo "Over";} }?> </td>


					</tr>
					<?
					$total_bom +=str_replace(',','',$pre);
					$total_book +=str_replace(',','',$bookings);
					$total_short +=str_replace(',','',$short);
					$total_short_full += str_replace(',','',$tot_short_book);
					$total_balance += str_replace(',','',$bal);

					$j++;
				}
				?>
				<tr>
					<td colspan="3" align="right"> <b> Total </b></td>
					<td align="center"><strong><? echo def_number_format($total_bom,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_book,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_short,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_short_full,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_balance,2);?> </strong> </td>
					<td>&nbsp;</td>
				</tr>
			</table>



			<?
			if($cbo_fabric_source==1 || $cbo_fabric_source==2 || $cbo_fabric_source==3){
			?>
			<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
				<tr>
					<?
					$nameArray_item_size=sql_select( "SELECT min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active =1 and d.is_deleted=0 and d.job_no in($all_jobs_id)  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
					if(count($nameArray_item_size)>0)
					{
						?>
						<td width="49%">

						</td>
						<td width="2%">
						</td>
						<?
					}
					?>
					<?
					$nameArray_item_size=sql_select( "SELECT min(c.id) as id, b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.job_no in ($all_jobs_id)  and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");

					if(count($nameArray_item_size)>0)
					{
						?>
						<td width="49%">

						</td>
						<?
					}
					?>
				</tr>
			</table>
			<br/>

			<br/>



	<?
	//------------------------------ Query for TNA start-----------------------------------
	$po_id_all=str_replace("'","",$txt_order_no_id);
	$po_num_arr=return_library_array("SELECT id,po_number from wo_po_break_down where job_no_mst in($all_jobs_id)",'id','po_number');
	$tna_start_sql=sql_select( "SELECT id,po_number_id,
	(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
	(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
	(case when task_number=60 then task_start_date else null end) as knitting_start_date,
	(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
	(case when task_number=61 then task_start_date else null end) as dying_start_date,
	(case when task_number=61 then task_finish_date else null end) as dying_end_date,
	(case when task_number=64 then task_start_date else null end) as finishing_start_date,
	(case when task_number=64 then task_finish_date else null end) as finishing_end_date,
	(case when task_number=84 then task_start_date else null end) as cutting_start_date,
	(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
	(case when task_number=86 then task_start_date else null end) as sewing_start_date,
	(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
	(case when task_number=110 then task_start_date else null end) as exfact_start_date,
	(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
	(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
	(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
	from tna_process_mst
	where status_active=1 and po_number_id in($po_id_all) and job_no in ($all_jobs_id) order by po_number_id");
 	$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
	$tna_date_task_arr=array();
	foreach($tna_start_sql as $row)
	{
		if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
		{
			if($tna_fab_start=="")
			{
				$tna_fab_start=$row[csf("fab_booking_start_date")];
			}
		}
		if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
		}
		if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
		}
		if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
		}
		if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
		}
		if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
		}
		if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
		}
		if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
		}
	}
	//------------------------------ Query for TNA end-----------------------------------
	if(count($tna_start_sql)>0 )
	{
		?>
		<br>
		<fieldset id="div_size_color_matrix" style="max-width:1000;">
			<legend>TNA Information</legend>
			<table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
				<tr>
					<td rowspan="2" align="center" valign="top">SL</td>
					<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
					<td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
					<td colspan="2" align="center" valign="top"><b>Knitting</b></td>
					<td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
					<td colspan="2" align="center" valign="top"><b>Finishing Fabric</b></td>
					<td colspan="2" align="center" valign="top"><b>Cutting </b></td>
					<td colspan="2" align="center" valign="top"><b>Sewing </b></td>
					<td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
				</tr>
				<tr>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
				</tr>
				<?
				$i=1;
				foreach($tna_date_task_arr as $order_id=>$row)
				{
					?>
					<tr>
						<td><? echo $i; ?></td>
						<td><? echo $po_num_arr[$order_id]; ?></td>
						<td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
						<td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
						<td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
					</tr>
					<?
					$i++;
				}
				?>
			</table>
		</fieldset>
		<?
	}
	}// fabric Source End
	?>
	<br>

	<table width="220"  border="0" cellpadding="2" cellspacing="0" rules="all" style="float:left">
		<tr>
			<td width="200" valign="top" align="left">

				<div id="div_size_color_matrix" style="float:left;">
					<?
					$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
					?>
					<fieldset>
						<legend>RMG Process Loss % </legend>
						<table width="180" class="rpt_table" border="1" rules="all">
							<?
							if(number_format($rmg_process_breakdown_arr[8],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Cut Panel rejection <!-- Extra Cutting % breack Down 8-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[8],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[2],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Chest Printing <!-- Printing % breack Down 2-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[2],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[10],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Neck/Sleeve Printing <!-- New breack Down 10-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[10],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[1],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Embroidery   <!-- Embroidery  % breack Down 1-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[1],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[4],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Sewing /Input<!-- Sewing % breack Down 4-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[4],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[3],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Garments Wash <!-- Washing %breack Down 3-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[3],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[15],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Gmts Finishing <!-- Washing %breack Down 3-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[15],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[11],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Others <!-- New breack Down 11-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[11],2);
										?>
									</td>
								</tr>
								<?
							}
							$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
							if($gmts_pro_sub_tot>0)
							{
								?>
								<tr>
									<td width="130">
										Sub Total <!-- New breack Down 11-->
									</td>
									<td align="right">
										<?

										echo number_format($gmts_pro_sub_tot,2);
										?>
									</td>
								</tr>
								<?
							}
							?>
						</table>
					</fieldset>


					<fieldset>
						<legend>Fabric Process Loss % </legend>
						<table width="180" class="rpt_table" border="1" rules="all">
							<?
							if(number_format($rmg_process_breakdown_arr[6],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Knitting  <!--  Knitting % breack Down 6-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[6],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[12],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Yarn Dyeing  <!--  New breack Down 12-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[12],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[5],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Dyeing & Finishing  <!-- Finishing % breack Down 5-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[5],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[13],2)>0)
							{
								?>
								<tr>
									<td width="130">
										All Over Print <!-- new  breack Down 13-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[13],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[14],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Lay Wash (Fabric) <!-- new  breack Down 14-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[14],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[7],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Dying   <!-- breack Down 7-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[7],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[0],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Cutting (Fabric) <!-- Cutting % breack Down 0-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[0],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[9],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Others  <!-- Others% breack Down 9-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[9],2);
										?>
									</td>
								</tr>
								<?
							}
							$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
							if($fab_proce_sub_tot>0)
							{
								?>
								<tr>
									<td width="130">
										Sub Total  <!-- Others% breack Down 9-->
									</td>
									<td align="right">
										<?

										echo number_format($fab_proce_sub_tot,2);
										?>
									</td>
								</tr>
								<?
							}
							if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
							{
								?>
								<tr>
									<td width="130">
										Grand Total  <!-- Others% breack Down 9-->
									</td>
									<td align="right">
										<?
										echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2);
										?>
									</td>
								</tr>
								<?
							}
							?>
						</table>
					</fieldset>
				</div>
			</td>
		</tr>
	</table>

	<!-- <table width="400"  border="0" cellpadding="2" cellspacing="0" rules="all" style="float:left">
		<tr>
			<td colspan="6" align="left"><img  src='<? echo $path.$imge_arr[$po_job_no]; ?>' height='155' width='200' /></td>
		</tr>
	</table> -->
	<br>
	<br>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
				<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
					<thead>
						<tr>
							<th width="3%"></th><th width="97%" align="left"><u>Special Instruction</u></th>
						</tr>
					</thead>
					<tbody>
						<?
						$data_array=sql_select("select id, terms from  wo_booking_terms_condition where booking_no=$txt_booking_no");
						if ( count($data_array)>0)
						{
							$i=0;
							foreach( $data_array as $row )
							{
								$i++;
								?>
								<tr id="settr_1" valign="top">
									<td style="vertical-align:top">
										<? echo $i;?>
									</td>
									<td>
										<strong style="font-size:16px"> <? echo $row[csf('terms')]; ?></strong>
									</td>
								</tr>
								<?
							}
						}
						?>
					</tbody>
				</table>
			</td>

		</tr>
	</table>
	<br/><br/><br/><br/>
		    <table  width="100%"  border="0" cellpadding="0" cellspacing="0">
		    	<tr>
		            <td>  <?
		                    echo signature_table(121, $cbo_company_name, "1330px",1,'');
							$job_no_all= implode(",",array_unique($joball['job_no']));
							$style_sting_all=implode(",",array_unique($joball['style_ref_no']));
							echo "****".custom_file_name($txt_booking_no,$style_sting_all,$job_no_all);
		                ?>
		            </td>
		        </tr>
		    </table>
	</div>
	<?
			
			$html = ob_get_contents();
			ob_clean();
			list($is_mail_send,$mail)=explode('___',$mail_send_data);
		
			if($is_mail_send==1){
				require_once('../../../mailer/class.phpmailer.php');
				require_once('../../../auto_mail/setting/mail_setting.php');
				$mailBody = preg_replace("/<img[^>]+\>/i", " ", $html); 
				$mailBody="<br>".$mail_body	;	
				$mailToArr=array();
				$mailSql = "select b.EMAIL  from wo_booking_mst a,LIB_SUPPLIER b where b.id=a.supplier_id and a.booking_no=$txt_booking_no";
			//echo $mailSql;die;
				$mailSqlRes=sql_select($mailSql);
				foreach($mailSqlRes as $rows){
					if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
				}
				
				
				$mailSql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=99 and b.mail_user_setup_id=c.id  and c.IS_DELETED=0 and c.STATUS_ACTIVE=1";
				//echo $mailSql;die;
				$mailSqlRes=sql_select($mailSql);
				foreach($mailSqlRes as $rows){
					if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
				}
				if($mail!=''){$mailToArr[]=$mail;}
		
				$to=implode(',',$mailToArr);
				$subject="Partial fabric booking";
				$header=mailHeader();
				echo $to;
				echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
				
			}
			else{
				echo $html;
			}
			exit();
}
if($action=="print_booking_17") // md mamun ahmed sagor /17-07-2022 
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' or form_name='knit_order_entry' and file_type=1",'master_tble_id','image_location');
	$company_library=return_library_array( "select id,company_name from lib_company where status_active=1 and is_deleted=0", "id", "company_name");

	$color_library=return_library_array( "select id,color_name from lib_color  where status_active=1 and is_deleted=0", "id", "color_name");
	$size_library=return_library_array( "select id,size_name from lib_size  where status_active=1 and is_deleted=0", "id", "size_name");
	$country_arr=return_library_array( "select id,country_name from   lib_country  where status_active=1 and is_deleted=0",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier  where status_active=1 and is_deleted=0",'id','supplier_name');
	$supplier_address_arr=return_library_array( "select id,address_1 from   lib_supplier  where status_active=1 and is_deleted=0",'id','address_1');

	$lip_yarn_count=return_library_array( "select id,fabric_composition_id from lib_yarn_count_determina_mst where  status_active=1", "id", "fabric_composition_id");
	$fabric_composition_arr=return_library_array( "select id,fabric_composition_name from lib_fabric_composition where  status_active=1", "id", "fabric_composition_name");
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info  where status_active=1 and is_deleted=0","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer  where status_active=1 and is_deleted=0",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location  where status_active=1 and is_deleted=0",'id','location_name');

	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	$season_arr=return_library_array("select id,season_name from lib_buyer_season  where status_active=1 and is_deleted=0","id","season_name");
	$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where status_active=1 and is_deleted=0 and id in(select po_break_down_id from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no=$txt_booking_no)",'id','po_number');

	$uom=0;
	$joball=array();
	$nameArray_per_job=sql_select( "SELECT  a.season_buyer_wise,  a.job_no,a.style_ref_no ,a.season_matrix,a.gmts_item_id,a.product_dept,max(c.booking_date) as booking_date ,max(c.delivery_date) as delivery_date,max(c.fabric_start_date) as fabric_start_date,max(c.is_approved) as is_approved,max(c.buyer_id) as buyer_id,max(c.pay_mode) as pay_mode,max(supplier_id) as supplier_id,max(a.dealing_marchant) as dealing_marchant,max(c.attention) as attention,max(c.currency_id) as currency_id ,max(c.remarks)  as remarks from wo_po_details_master a , wo_booking_dtls b,wo_booking_mst c  where c.booking_no=b.booking_no and c.status_active=1 and c.is_deleted=0 and  a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by  a.season_buyer_wise, a.job_no,a.style_ref_no ,a.season_matrix,a.gmts_item_id,a.product_dept ");
	$po_job_no="";
	foreach ($nameArray_per_job as $vals)
	{
		$joball['job_no'][$vals[csf('job_no')]]=$vals[csf('job_no')];
		$joball['style_ref_no'][$vals[csf('job_no')]]=$vals[csf('style_ref_no')];
		$all_job_arr[$vals[csf("job_no")]]["job"]="'".$vals[csf("job_no")]."'";
		$all_job_arr[$vals[csf("job_no")]]["style"]=$vals[csf("style_ref_no")];
		$all_job_arr[$vals[csf("job_no")]]["item"]=$vals[csf("gmts_item_id")];
		$all_job_arr[$vals[csf("job_no")]]["season"]=$vals[csf("season_matrix")];

		$all_job_arr_season[$vals[csf("job_no")]]=$season_arr[$vals[csf("season_buyer_wise")]];

		$all_job_arr[$vals[csf("job_no")]]["dept"]=$vals[csf("product_dept")];
		$all_job_arr_dept[$vals[csf("job_no")]]=$product_dept[$vals[csf("product_dept")]];
		$all_jobs[$vals[csf("job_no")]]="'".$vals[csf("job_no")]."'";
		$all_job[$vals[csf("job_no")]]="".$vals[csf("job_no")]."";
		$job_wise_style[$vals[csf("job_no")]]= $vals[csf("style_ref_no")];
		$po_job_no=$vals[csf('job_no')];
	}
	//echo $po_job_no.'DDD';die;
	$all_jobs_id=implode(",",$all_jobs );
	$all_job_id=implode(",",$all_job );
	$seasons=implode(",",$all_job_arr_season );
	$depts=implode(",",$all_job_arr_dept );
	$style=implode(",",$job_wise_style );
 	$po_qnty_all_style=sql_select("SELECT sum(po_quantity) as qnty from wo_po_break_down where status_active=1 and is_deleted=0 and job_no_mst in ($all_jobs_id)");

 	$all_shipdates_arr=sql_select("SELECT min(b.pub_shipment_date)  as shipdate,job_no,a.order_uom as uom from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.status_active=1 and b.is_deleted=0 and  a.status_active=1 and a.is_deleted=0 and b.job_no_mst in ($all_jobs_id) group by job_no,a.order_uom");
 	$shipment_dates="";
 	$job_uom_array=array();
 	foreach($all_shipdates_arr as $key=>$data)
 	{
 		if($shipment_dates=="")
 		{
 			$shipment_dates=change_date_format($data[csf("shipdate")]);
 		}
 		else
 		{
 			$shipment_dates .=','.change_date_format($data[csf("shipdate")]);
 		}
 		$job_uom_array[$data[csf("job_no")]]=$unit_of_measurement[$data[csf("uom")]];


 	}
 	$unites=implode(",", $job_uom_array);


	$uom=0;
	$job_data_arr=array();
	$nameArray_buyer=sql_select( "SELECT  a.style_ref_no,a.style_description, a.job_no, a.style_owner, a.buyer_name, a.dealing_marchant,a.season,a.season_matrix,a.total_set_qnty,a.product_dept,a.product_code,a.pro_sub_dep,a.gmts_item_id ,a.order_repeat_no,a.qlty_label  from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  and a.job_no in ($all_jobs_id) ");

	foreach ($nameArray_buyer as $result_buy)
	{
		$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
		$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
		$job_data_arr['total_set_qnty'][$result_buy[csf('job_no')]]=$result_buy[csf('total_set_qnty')];
		$job_data_arr['product_dept'][$result_buy[csf('job_no')]]=$product_dept[$result_buy[csf('product_dept')]];
		$job_data_arr['product_code'][$result_buy[csf('job_no')]]=$result_buy[csf('product_code')];
		$job_data_arr['pro_sub_dep'][$result_buy[csf('job_no')]]=$pro_sub_dept_array[$result_buy[csf('pro_sub_dep')]];
		$job_data_arr['gmts_item_id'][$result_buy[csf('job_no')]]=$result_buy[csf('gmts_item_id')];
		$job_data_arr['style_ref_no'][$result_buy[csf('job_no')]]=$result_buy[csf('style_ref_no')];
		$job_data_arr['style_description'][$result_buy[csf('job_no')]]=$result_buy[csf('style_description')];
		$job_data_arr['dealing_marchant'][$result_buy[csf('job_no')]]=$marchentrArr[$result_buy[csf('dealing_marchant')]];
		$job_data_arr['season_matrix'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_matrix')]];
		$job_data_arr['order_repeat_no'][$result_buy[csf('job_no')]]=$result_buy[csf('order_repeat_no')];
		$job_data_arr['qlty_label'][$result_buy[csf('job_no')]]=$quality_label[$result_buy[csf('qlty_label')]];
		//$item_arr[$result_buy[csf('job_no')]]=$garments_item[$result_buy[csf('gmts_item_id')]];
		$item_arr[$result_buy[csf('job_no')]]=$result_buy[csf('gmts_item_id')];
	}
	$job_no= implode(",",array_unique($job_data_arr['job_no']));
	$job_no_in= implode(",",array_unique($job_data_arr['job_no_in']));
	$product_depertment=implode(",",array_unique($job_data_arr['product_dept']));
	$product_code=implode(",",array_unique($job_data_arr['product_code']));
	$pro_sub_dep=implode(",",array_unique($job_data_arr['pro_sub_dep']));
	$gmts_item_id=implode(",",array_unique($job_data_arr['gmts_item_id']));
	//$gmts_item_ids=implode(",",$item_arr['gmts_item_id']);
	$style_sting=implode(",",array_unique($job_data_arr['style_ref_no']));
	$style_description=implode(",",array_unique($job_data_arr['style_description']));
	$dealing_marchant=implode(",",array_unique($job_data_arr['dealing_marchant']));
	$season_matrix=implode(",",array_unique($job_data_arr['season_matrix']));
	$order_repeat_no= implode(",",array_unique($job_data_arr['order_repeat_no']));
	$qlty_label= implode(",",array_unique($job_data_arr['qlty_label']));
	$path=str_replace("'","",$path);
	if($path=="")
	{
	$path='../../';
	}

	foreach($item_arr as $data){
		$item_job_arr=explode(",",$data);
		foreach($item_job_arr as $itemid){
			$gmts_item_arr[$itemid]=$garments_item[$itemid];
		}

	}

	$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
	foreach ($nameArray as $result)
	{
		$comp_address_lib[$cbo_company_name]=$result[csf('plot_no')].",".$result[csf('level_no')].",".$result[csf('road_no')].",".$result[csf('block_no')].",".$result[csf('city')];
	}

	$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and a.status_active =1 and a.is_deleted=0 ");
	list($nameArray_approved_row) = $nameArray_approved;
	$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0 ");
	list($nameArray_approved_date_row) = $nameArray_approved_date;
	$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0 ");
	list($nameArray_approved_comments_row) = $nameArray_approved_comments;


	ob_start();
	?>
	<style type="text/css">

		body, p, span, td, a {font-size:10pt;font-family: Arial;}
		body{margin-left:2em; margin-right:2em; font-family: "Arial Narrow", Arial, sans-serif;}

	</style>

	<div style="width:1330px" align="center" >

		<table id="tb_header" width="100%" cellpadding="0" cellspacing="0" style="border:0px solid black" >
			<thead>
				<tr>
					<td width="150" ><img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100' width='100' /></br><b><?php echo $company_library[$cbo_company_name]; ?></b></td>					
					<td width="400" align="left" style="font-size: 16px;">
						<b>Corporate Office:</b></br>
						<p>House #21,Road # 13,Baridhara</br>Dhaka-1212,Bangladesh</br>PABX:880-2-9889078,9841735,9860445,98417979</br>Fax:880-2-9289172</br>Web:www.nazbd.com</p>
					</td>
					<td width="100">
					<?
						if($nameArray_approved_row[csf('approved_no')]>1)
						{
						?>
						<b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
						<br/>
						<b>Last Revised Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?></b>
						<?
						}
						?>
					</td>
					<td width="300" align="left"><img  src='<? echo $path.$imge_arr[$po_job_no]; ?>' align="left" height='150' width='200' /></td>
					<td width="150"  align="left"></td>
				</tr>
				<tr>

				
					<td width="300"><b>Supplier:</b>
						<?
						$pay_mode=$nameArray_per_job[0][csf("pay_mode")];//pay_mode
						if($pay_mode!=3 && $pay_mode!=5)
						{
							echo $supplier_name_arr[$nameArray_per_job[0][csf("supplier_id")]];
						}
						else
						{
							echo $company_library[$nameArray_per_job[0][csf("supplier_id")]];
						}?>
					</td>
					<td width="400" align="left"><b>Address:   </b> <? if($pay_mode!=3 && $pay_mode!=5)
						{
							echo $supplier_address_arr[$nameArray_per_job[0][csf("supplier_id")]];
						}
						else
						{
							echo $comp_address_lib[$nameArray_per_job[0][csf("supplier_id")]];
						}?></td>
					<td align="left"><b>Booking Date : </b>&nbsp;<? echo change_date_format($nameArray_per_job[0][csf("booking_date")]);?></td>

				</tr>
				<tr>
					<td width="300"><b>Attention: </b>   <? echo $nameArray_per_job[0][csf("attention")];?></td>
					<td width="300"><b>Booking NO: </b>   <? echo str_replace("'","",$txt_booking_no);?></td>
					<td width="400"><b>Fabric Delivery Start Date: </b><?php echo change_date_format($nameArray_per_job[0][csf("fabric_start_date")]); ?></td>
				</tr>
				<tr>
					<td width="300"><b>Buyer Name :</b><? echo $buyer_name_arr[$nameArray_per_job[0][csf("buyer_id")]]; ?></td>
					<td width="400" align="left" colspan="2"><b>Style: </b> <? echo $style; ?></td>
					
				</tr>

				<tr>
					<td width="300"><b>Item Details: &nbsp;<? echo implode(",",$gmts_item_arr); ?></b></td>
					<td><b>Job No : </b> &nbsp;<? echo $all_job_id; ?></td>
					<td width="400"><b>Fabric Delivery End Date: </b><?php echo change_date_format($nameArray_per_job[0][csf("delivery_date")]); ?></td>
				</tr>
				
				<tr>
					<td width="400" align="left"><b>Department:   </b> <? if($product_code!="") echo $depts."-".$product_code; else echo $depts; ?></td>
					<td width="300"><b>Season: </b>   <? echo $seasons;;?></td>
					<td width="400" align="left"><b>Order Qnty :   </b> <? echo $po_qnty_all_style[0][csf("qnty")]; ?>&nbsp;<? echo $unites;?></td>
				</tr>
		
				<tr>
				   <td width="400" align="left" colspan="3"><b>Remarks:   </b> <? echo $nameArray_per_job[0][csf("remarks")]; ?></td>
				</tr>
			</thead>
		</table>


			<?php

			$po_data = array();

			$nameArray_job = sql_select("select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,(pub_shipment_date-po_received_date) date_diff,MIN(po_received_date) as po_received_date,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status   from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id) group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
			foreach ($nameArray_job as $result_job) {
				$po_data['po_id'][$result_job[csf('id')]] = $result_job[csf('id')];
				$po_data['po_number'][$result_job[csf('id')]] = $result_job[csf('po_number')];
				$po_data['leadtime'][$result_job[csf('id')]] = $result_job[csf('date_diff')];
				$po_data['po_quantity'][$result_job[csf('id')]] = $result_job[csf('po_quantity')];
				$po_data['po_received_date'][$result_job[csf('id')]] = change_date_format($result_job[csf('po_received_date')], 'dd-mm-yyyy', '-');
				$ddd = strtotime($result_job[csf('pub_shipment_date')]);
				$po_data['pub_shipment_date'][$ddd] = $ddd;

				$po_data['insert_date'][$result_job[csf('id')]] = $result_job[csf('insert_date')];

				if ($result_job[csf('shiping_status')] == 1) {
					$shiping_status = "FP";
				} else if ($result_job[csf('shiping_status')] == 2) {
					$shiping_status = "PS";
				} else if ($result_job[csf('shiping_status')] == 3) {
					$shiping_status = "FS";
				}
				$po_data['shiping_status'][$result_job[csf('id')]] = $shiping_status;
				$po_data['file_no'][$result_job[csf('id')]] = $result_job[csf('file_no')];

				$po_data['grouping'][$result_job[csf('id')]] = $result_job[csf('grouping')];
			}
	$txt_order_no_id = implode(",", array_unique($po_data['po_id']));
	$leadtime = implode(",", array_unique($po_data['leadtime']));
	$po_quantity = array_sum($po_data['po_quantity']);
	$po_received_date = implode(",", array_unique($po_data['po_received_date']));
	$po_number = implode(",", array_unique($po_data['po_number']));
	$shipment_date = date('d-m-Y', min($po_data['pub_shipment_date']));
	$maxshipment_date = date('d-m-Y', max($po_data['pub_shipment_date']));
	//$shipment_date=implode(",",array_unique($po_data['pub_shipment_date']));
	$shiping_status = implode(",", array_unique($po_data['shiping_status']));
	$file_no = implode(",", array_unique($po_data['file_no']));
	$grouping = implode(",", array_unique($po_data['grouping']));

	$colar_excess_percent = 0;
	$cuff_excess_percent = 0;
	$rmg_process_breakdown = 0;
	$nameArray = sql_select("select a.buyer_id,a.inserted_by,a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.update_date,a.uom,a.remarks,a.pay_mode,a.fabric_composition from wo_booking_mst a  where   a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0");

	
	foreach ($nameArray as $result) {
	$total_set_qnty = $result[csf('total_set_qnty')];
	$colar_excess_percent = $result[csf('colar_excess_percent')];
	$cuff_excess_percent = $result[csf('cuff_excess_percent')];
	$rmg_process_breakdown = $result[csf('rmg_process_breakdown')];
	foreach ($po_data['po_id'] as $po_id => $po_val) {
		$daysInHand .= (datediff('d', date('d-m-Y', time()), $po_data['pub_shipment_date'][$po_id]) - 1) . ",";
		$booking_date = $result[csf('update_date')];
		if ($booking_date == "" || $booking_date == "0000-00-00 00:00:00") {
			$booking_date = $result[csf('insert_date')];
		}
		$WOPreparedAfter .= (datediff('d', $po_data['insert_date'][$po_id], $booking_date) - 1) . ",";
	}

	}
	$inserted_by=$nameArray[0][csf('inserted_by')];


	?>
			<br/>
			<!--  Here will be the main portion  -->
			<?
			$costing_per="";
			$costing_per_qnty=0;
			$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no in($job_no_in)");
			if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;

			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";
				$costing_per_qnty=1;

			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;

			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;

			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;
			}
			$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no in($job_no_in)");
			$uom_arr=array(1=>"Pcs",12=>"Kg",23=>"Mtr",27=>"Yds");
			$p=1;
		 $color_wise_process_loss=sql_select("SELECT a.id,a.job_no, a.body_part_id, b.color_number_id,b.dia_width, a.process_loss_method, b.process_loss_percent as loss, avg(b.cons_pcs) as consdzn FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and  a.job_no in(".$job_no_in.") and b.process_loss_percent>0 group by a.id,a.job_no, a.body_part_id, a.process_loss_method,b.dia_width, b.color_number_id, b.process_loss_percent");
	    foreach($color_wise_process_loss as $val)
	    {
	    	$loss_arr[$val[csf("id")]][$val[csf("dia_width")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['loss']=$val[csf("loss")];
	    	$loss_arr[$val[csf("id")]][$val[csf("dia_width")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['loss_method']=$val[csf("process_loss_method")];
			$loss_arr[$val[csf("id")]][$val[csf("dia_width")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['consdzn']=$val[csf("consdzn")];
			$gmt_color_arr[$val[csf("id")]][$val[csf("dia_width")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['color_id']=$val[csf("color_number_id")];
	    }
		
		if($cbo_fabric_source==1 || $cbo_fabric_source==2 || $cbo_fabric_source==3)
		{
			$nameArray_qty_arr = sql_select("select b.job_no_mst,b.id,a.style_ref_no,c.item_number_id,c.color_number_id,c.plan_cut_qnty,c.order_quantity   from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where  a.job_no=b.job_no_mst and c.po_break_down_id=b.id and a.job_no=c.job_no_mst and a.status_active =1 and b.status_active =1 and c.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id) and b.id in($txt_order_no_id)  ");
		//echo "select b.job_no_mst,b.id,a.style_ref_no,c.item_number_id,c.color_number_id,c.order_quantity   from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where  a.job_no=b.job_no_mst and c.po_break_down_id=b.id and a.status_active =1 and c.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id) and b.id in($txt_order_no_id)  ";
			foreach($nameArray_qty_arr as $row)
			{
				$gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][40]+=$row[csf('order_quantity')];
				$gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][50]+=$row[csf('order_quantity')];
				$fab_gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]]+=$row[csf('order_quantity')];
				$plan_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]]+=$row[csf('order_quantity')];
				$gmts_color_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]]['color'].=$row[csf('color_number_id')].',';
			}

			
			$nameArray_fabric_description= sql_select("SELECT a.id as fabric_cost_dtls_id,a.inserted_by,a.seq, a.item_number_id, a.body_part_id,a.body_part_type,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , b.dia_width,	d.pre_cost_remarks,a.uom ,d.fabric_color_id,a.color_size_sensitive,	a.color_break_down,c.job_no_mst,d.remark,avg(b.requirment) as consumption,avg(b.cons) as consumption,avg(b.process_loss_percent) as process_loss_percent,avg(b.cons) as finish_cons,sum(c.plan_cut_qnty) as plan_cut_qnty,sum(c.order_quantity) as order_quantity,avg(c.excess_cut_perc) as ex_cut_per,b.color_number_id,d.gmts_color_id, a.avg_finish_cons FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_number_id=d.gmts_color_id and b.dia_width=d.dia_width and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and a.job_no=d.job_no and a.id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.job_no in ($all_jobs_id)  and d.status_active=1 and c.status_active=1 and d.is_deleted=0 and b.cons>0 group by a.id ,a.inserted_by, a.item_number_id,a.seq, a.body_part_id,a.body_part_type,a.color_type_id, a.construction,a.composition, a.gsm_weight,a.width_dia_type , b.dia_width,d.pre_cost_remarks,a.uom ,d.fabric_color_id,a.color_size_sensitive,a.color_break_down,c.job_no_mst,d.remark,b.color_number_id,d.gmts_color_id, a.avg_finish_cons order by b.color_number_id,a.item_number_id,a.seq,a.id");

			



			$uom_data_arr=array();$b_part_array_not=array(40,50);
			foreach($nameArray_fabric_description as $row)
			{
				if(!in_array($row[csf('body_part_type')],$b_part_array_not))
				{
					$uom_data_arr[$row[csf('uom')]]=$row[csf('uom')];
				}
				if($row[csf('body_part_type')]==40 || $row[csf('body_part_type')]==50)
				{
					//$gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('fabric_color_id')]][$row[csf('body_part_type')]]+=$row[csf('order_quantity_pcs')];
					$gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('gmts_color_id')]][$row[csf('body_part_type')]]=$row[csf('order_quantity_pcs')];
				}
			}
			
			foreach($uom_data_arr as $uom_id=>$uom_val)
			{
				if(count($nameArray_fabric_description)>0)
				{

					?>

						<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
									<caption> <strong>Fabric Booking Summary </strong> </caption>
									<tr>
										<th  width="30" align="center">SL</th>
										<th  width="150" align="center">Style</th>
										<th  width="140" align="center">Gmts Item</th>
										<th  width="130" align="center">Body Parts</th>
										<th  width="100" align="center">Gmts Order Qty (Pcs)</th>
										<th  width="100" align="center">Extra Cutting %</th>
										<th  width="100" align="center">Fabric Construction</th>
										<th  width="400" align="center">Yarn Composition</th>
										<th  width="100" align="center">Fabric Composition</th>
										<th  width="150" align="center">Add. Process</th>
										<th  width="40" align="center">GSM</th>
										<th  width="90" align="center">Fin Width/ Dia Type</th>
										<th  width="100" align="center">Color Type</th>
										<th  width="100" align="center">Combo</th>
										<th  width="110" align="center">Fabric Color</th>
										<th  width="80" align="center">Finish Cons. Kg/Dzn</th>
							
										<th  width="60" align="center">UOM</th>
										<!-- <th width='120' align="center"></th> -->
										<th width='120' align="center" title="Based on avg grey consumption">Finished Fab. Qty</th>
										<th width='100' align="center">Avg. P/L %</th>
										<th width='100' align="center">Grey Fabric Qty</th>
										<th width='100' align="center">Avg Rate/<? echo $unit_of_measurement[$uom_id];?></th>
										<th width='60' align="center">Amount</th>
								
										<th  align="center">Remarks</th>

									</tr>
									<? //wo_pre_cos_fab_co_color_dtls
									$dtm_arr=array();
									$sql=sql_select("select pre_cost_fabric_cost_id,fabric_color,sum(qty) as qty  from wo_dye_to_match where booking_no=$txt_booking_no and status_active=1 and is_deleted=0 group by pre_cost_fabric_cost_id,fabric_color");
									foreach($sql as $row){
										$dtm_arr[$row[csf('pre_cost_fabric_cost_id')]][$row[csf('fabric_color')]]=$row[csf('qty')];
									}
									
									$total_fin_fab_qnty=$total_gmt_qty_pcs=0;  $total_amount=0;  $total_grey_fab_qnty=0 ;$tot_avg=0;
									foreach($nameArray_fabric_description as $val)
									{
										if($val[csf('pre_cost_remarks')]!='') $remark_cond=" and d.pre_cost_remarks='".$val[csf('pre_cost_remarks')]."' "; else $remark_cond=" and d.pre_cost_remarks is null";


										$color_wise_wo_sql_qnty=sql_select("SELECT  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount,max(a.lib_yarn_count_deter_id) as determin_id
										FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
										WHERE
											a.job_no=d.job_no and
											a.id=d.pre_cost_fabric_cost_dtls_id and
											d.booking_no =$txt_booking_no and
											d.job_no = '".$val[csf('job_no_mst')]."' and
											a.item_number_id='".$val[csf('item_number_id')]."' and
											a.body_part_id='".$val[csf('body_part_id')]."' and
											a.color_type_id='".$val[csf('color_type_id')]."' and
											a.construction='".$val[csf('construction')]."' and
											a.composition='".$val[csf('composition')]."' and
											a.gsm_weight='".$val[csf('gsm_weight')]."' and
											d.dia_width='".$val[csf('dia_width')]."' and
											a.id='".$val[csf('fabric_cost_dtls_id')]."' and
											a.uom='".$uom_id."' and
											d.fabric_color_id='".$val[csf('fabric_color_id')]."' and
											d.gmts_color_id='".$val[csf('gmts_color_id')]."' and
											d.status_active=1 and
											d.is_deleted=0 $remark_cond");
											
										if($uom_id==$val[csf('uom')])
										{
											if($val[csf('pre_cost_remarks')]=='no remarks')  $pre_cost_remarks="";else  $pre_cost_remarks=$val[csf('pre_cost_remarks')];

											//$order_quantity_pcs=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$val[csf('fabric_color_id')]];
											//$order_quantity_pcs=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$val[csf('gmts_color_id')]];
											$order_quantity_pcs=0;
											if($val[csf('color_size_sensitive')]==1 or $val[csf('color_size_sensitive')]==2 or $val[csf('color_size_sensitive')]==4)
											{
												$gmt_colorName=$color_library[$val[csf('fabric_color_id')]];
												$gmt_colorId=$val[csf('fabric_color_id')];
												//echo $gmt_colorId.'d';
												$order_quantity_pcs+=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$val[csf('fabric_color_id')]];
												$plan_quantity_pcs+=$plan_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$val[csf('fabric_color_id')]];
											}
											else
											{
												$color_break_down=$val[csf('color_break_down')];
												if($color_break_down)
												{
													$gmts_color="";$gmt_colorId="";
													if (strpos($color_break_down, '__') !== false)
													{
														$color_break_down=explode('__', $color_break_down);
														foreach ($color_break_down as $key => $value)
														{
															$cols=explode('_', $value);
															if(trim(strtolower($color_library[$val[csf('fabric_color_id')]]))==trim(strtolower($cols[2])))
															{
																if($gmts_color=="")
																{
																	$gmts_color=$cols[1];
																$order_quantity_pcs=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];
																$plan_quantity_pcs=$plan_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];
																$gmt_colorId=$cols[0];

																}
																else
																{
																	$gmts_color .=','.$cols[1];
																$order_quantity_pcs+=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];
																$plan_quantity_pcs+=$plan_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];
																$gmt_colorId=$cols[0];

																}
																

															}
															
														}
													}
													else
													{
														$cols=explode('_', $color_break_down);
														if(trim(strtolower($color_library[$val[csf('fabric_color_id')]]))==trim(strtolower($cols[2])))
														{
															if($gmts_color=="")
															{
																$gmts_color=$cols[1];
																$order_quantity_pcs=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];
																$plan_quantity_pcs=$plan_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];
																$gmt_colorId=$cols[0];

															}
															else
															{
																$gmts_color .=','.$cols[1];
																$order_quantity_pcs+=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];
																$plan_quantity_pcs+=$plan_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];
																$gmt_colorId=$cols[0];

															}
															

														}
														
													}

													$gmt_colorName=$gmts_color;
													
												}
												
											}
											
											$gmt_color_Id=$gmt_colorId;
											$order_quantity_pcs=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$val[csf("color_number_id")]];
											
						
											
											$process_loss=$loss_arr[$val[csf("fabric_cost_dtls_id")]][$val[csf("dia_width")]][$val[csf("job_no_mst")]][$val[csf("body_part_id")]][$gmt_color_Id]['loss'];
											$p_loss_method=$loss_arr[$val[csf("fabric_cost_dtls_id")]][$val[csf("dia_width")]][$val[csf("job_no_mst")]][$val[csf("body_part_id")]][$gmt_color_Id]['loss_method'];
											
											if($process_loss=='') $process_loss=0;else $process_loss=$process_loss;
											if($p_loss_method=='') $p_loss_method=0;else $p_loss_method=$p_loss_method;

											?>
											<tr>
												<td align="center"> <? echo $p; $p++;?></td>

												
												<td align="center"> <? echo $all_job_arr[$val[csf("job_no_mst")]]["style"];?></td>
												<td align="center"> <? echo $garments_item[$val[csf("item_number_id")]];?></td>
												<td align="center"><? echo $body_part[$val[csf('body_part_id')]];?></td>
												
												<td align="center"><? //echo number_format($order_quantity_pcs,2);?><? echo number_format($val[csf('order_quantity')],2);?></td>
													<td align="center"><? echo number_format($val[csf('ex_cut_per')],2);?></td>
												
												<td align="left"> <? echo $val[csf('construction')]; ?> </td>
												<td align="left"> <? echo $val[csf('composition')]; ?> </td>
												<td align="center"> 
												<?
												foreach($color_wise_wo_sql_qnty  as $frow)
												{
													 echo $fabric_composition_arr[$lip_yarn_count[$frow[csf('determin_id')]]];
												}
												?>
												</td>
												<td  align="center"><?	echo $pre_cost_remarks;	?>	</td>
												<td  align="center">
													<?
													echo $val[csf('gsm_weight')];
													?>
												</td>

												<td  align="center">
													<?
													echo $val[csf('dia_width')].'/'.$fabric_typee[$val[csf('width_dia_type')]];
													?>
												</td>

												<td  align="center">
													<?
													echo $color_type[$val[csf('color_type_id')]];
													?>
												</td>
												<td  align="center" title="<?=$gmt_color_Id;?>">
													<?
													echo $color_library[$val[csf('color_number_id')]];
													?>
												</td>


												<td  align="center">
													<?
													echo $color_library[$val[csf('fabric_color_id')]];
													?>
												</td>


												
												<td align="center" title="Tot Fin Cons in Budget/Tot Row"> <? echo def_number_format($val[csf('avg_finish_cons')],5); ?></td>
												
												<td align="center"> <? echo $unit_of_measurement[$val[csf('uom')]]; ?></td>

												<?
													$fin_fab_qnty=$color_wise_wo_sql_qnty[0][csf("fin_fab_qnty")];
																																		
													$grey_fab_qnty=$color_wise_wo_sql_qnty[0][csf("grey_fab_qnty")];
													$rate=$color_wise_wo_sql_qnty[0][csf("rate")];
													$amount=$color_wise_wo_sql_qnty[0][csf("amount")];
													$process_loss_percent=$val[csf("process_loss_percent")];
													$avgRate=$amount/$fin_fab_qnty;										

													?> </td> 
													<td align="center" title="Process Loss Method=<?=$p_loss_method.'='.$process_loss.'*'.$color_wise_wo_sql_qnty[0][csf("grey_fab_qnty")];?>"> <? echo def_number_format($fin_fab_qnty,2); ?> </td>
													<td align="center"> <? echo def_number_format($process_loss_percent,2); ?> </td>
													<td align="center"> <? echo def_number_format($grey_fab_qnty,2); ?> </td>
													<td align="center"> <? echo def_number_format($avgRate,2); ?> </td>
													<td align="center"> <? echo def_number_format($amount,2); ?> </td>


													<?

													$total_fin_fab_qnty +=str_replace(",", "", def_number_format($greys,2));
													$total_amount +=str_replace(",", "",def_number_format($amount,2));

													$total_grey_fab_qnty +=str_replace(",", "",def_number_format($fin_fab_qnty,2));
													$total_greyfabqnty +=str_replace(",", "",def_number_format($grey_fab_qnty,2));
													$total_rate +=str_replace(",", "",def_number_format($rate,2));
													$tot_avg=$total_amount/$total_grey_fab_qnty;
													$total_gmt_qty_pcs +=$order_quantity_pcs;


													?>
												
												<td align="center"> <? echo $val[csf('remark')]; ?> </td>


												</tr>
												<?
										}

									}
										?>
									<tr style=" font-weight:bold">

									<td  align="right" colspan="6"><strong>Total</strong></td>
									 <td align="right"><? //echo def_number_format($total_gmt_qty_pcs,2);?></td>
									<td  align="right" colspan="10">&nbsp;</td>

									<td align="center"><? echo def_number_format($total_grey_fab_qnty,2);?></td>
									<td  align="right" >&nbsp;</td>
									<td align="center"><? echo def_number_format($total_greyfabqnty,2);?></td>
									<td align="center"><? echo def_number_format($tot_avg,2);?></td>
									<td align="center"><? echo def_number_format($total_amount,2);?></td>
									<td  align="right" >&nbsp;</td>

									</tr>

						</table>

					<?
				}
			}
		}


		$sql_data=sql_select("SELECT a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,a.uom,b.dia_width,b.pre_cost_remarks,b.fabric_color_id,b.remark, sum(b.grey_fab_qnty) as grey_fab_qnty,sum(b.adjust_qty)as adjust_qty FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in($all_jobs_id) and b.adjust_qty>0 and b.status_active=1 and b.is_deleted=0 group by a.id,a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,a.uom,b.dia_width,b.pre_cost_remarks,b.fabric_color_id,b.remark and a.body_part_type not in(40,50) order by a.id,a.body_part_id");
		if(count($sql_data)>0)
		{

					?>
					<br/>
			<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

					<tr>
						<td colspan="7" align="center">
							<strong>Fabric Stock Adjustment Details</strong>
						</td>

					</tr>

					<tr>
						<td align="center"> SL </td>
						<td align="center"> Item Description </td>
						<td align="center"> Fabric Color </td>
						<td align="center">UOM</td>
						<td align="center">Adjusted Qty </td>


					</tr>
					<?
					$p=1;
					foreach($sql_data as $row)
					{
						?>
						<tr>
							<td align="center"><? echo $p;?></td>
							<td align="center">
								<? echo $body_part[$row[csf('body_part_id')]].",".$row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$row[csf('dia_width')].','.$fabric_typee[$row[csf('width_dia_type')]].",".$color_type[$row[csf('color_type_id')]] ?>
							</td>

							<td align="center">
								<? echo $color_library[$row[csf('fabric_color_id')]];  ?>
							</td>
							<td align="center">
								<? echo $unit_of_measurement[$row[csf('uom')]];  ?>
							</td>


							<td align="center">
								<? echo number_format($row[csf('adjust_qty')],4) ; ?>
							</td>

						</tr>
						<?
						$p++;
					}
		}
					?>
			</table>
			<br>
				<div style="width:1330px" align="center" >
			  		<table  width="100%"  border="0" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

			  			<tr>
			  				<td colspan="10" align="center">
			  					<strong>Collar and Cuff & Other Flat Knit Fabric Breakdown</strong>
			  				</td>

			  			</tr>
			  		</table>

	        <?
			$nameArray_size=sql_select( "select  size_number_id,min(id) as id,	min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  	is_deleted=0 and status_active!=0 group by size_number_id order by size_order");
			$nameArray_item_size=sql_select( "select min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_id=b.job_id and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.job_no in ($all_jobs_id)  and a.body_part_id=2  and c.job_id=a.job_id and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
	     	  $sql_collar_cuff= "SELECT a.rate, a.amount, a.job_no , a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.width_dia_type, b.gmts_color_id, b.size_number_id, b.item_size, b.gmts_qty, b.excess_per, b.qty, b.po_break_down_id as po_id, b.id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id) and a.body_part_type=40 and b.status_active=1 and b.is_deleted=0  order by a.body_part_id,b.gmts_color_id,b.id " ;
	     	  //echo $sql_collar_cuff; die;
	         $sql_data_collar_cuff=sql_select($sql_collar_cuff);
	         $size_id_array=array();
	         $size_with_item_size_array=array();
	         foreach($sql_data_collar_cuff as $vals)
	         {
	         	$body_part_cuff_array[$vals[csf("body_part_id")]]=$vals[csf("body_part_id")];
				$size_id_array[$vals[csf("size_number_id")]]=$vals[csf("size_number_id")];
	         	$size_with_item_size_array[$vals[csf("size_number_id")]][$vals[csf("body_part_id")]]=$vals[csf("item_size")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["grey"]+=$vals[csf("qty")];
				$size_item_wise_qntys[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["grey"]+=$vals[csf("qty")];


	         	//$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]=$vals[csf("excess_per")];
				if($vals[csf("excess_per")]>0)
				{
				$color_wise_excess_per_arr[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]+=$vals[csf("excess_per")];
				$color_wise_excess_per_arr[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_excess_per"]+=1;
				}
	         	$color_wise_qnty[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$color_wise_qnty[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["grey"]+=$vals[csf("qty")];
	         	/*$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];*/

	         	//$color_wise_qnty[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["amount"]=$vals[csf("amount")];
				$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_rate"]=1;

	         }
			unset($sql_data_collar_cuff);
	         $sql_collar_cuff3 = sql_select("SELECT c.rate, a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id, c.gmts_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls c WHERE a.job_no=c.job_no and a.id=c.pre_cost_fabric_cost_dtls_id and  a.id=c.pre_cost_fabric_cost_dtls_id and c.booking_no =$txt_booking_no and c.job_no in ($all_jobs_id) and a.body_part_type=40 and c.status_active=1 and c.is_deleted=0  order by a.body_part_id");

	         foreach($sql_collar_cuff3 as $vals)
	         {

	         	$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];

	         }


	         $counts=count($size_id_array);


	         $size_wise_qnty_array=array();
	         ?>


			 <?
	          if(count($body_part_cuff_array)>0)
	          {		$grand_size_wise_qnty_array=array();
			  		$gr_collor_qty=0;
					 $gr_col_avg_price=0;
					 $gr_col_avg_row=0;
					 $gr_amount=0;
					 $gr_excess=0;
					foreach($body_part_cuff_array as $bpart_id=>$val)
					{
					// $sql_collar_cuff2= "SELECT a.rate,a.amount, a.job_no , a.id as fabric_cost_dtls_id,a.color_size_sensitive,a.color_break_down, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,b.gmts_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and a.body_part_id=$bpart_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id) and a.body_part_type=40  and b.status_active=1 and b.is_deleted=0  group by  a.rate,a.amount, a.job_no , a.id ,a.color_size_sensitive,a.color_break_down, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition,a.gsm_weight,a.width_dia_type,b.gmts_color_id  order by a.body_part_id,b.gmts_color_id  " ;

					$sql_collar_cuff2= " SELECT a.rate,
									         a.amount,
									         a.job_no,
									         a.id as fabric_cost_dtls_id,
									         a.color_size_sensitive,
									         a.item_number_id,
									         a.body_part_id,
									         a.color_type_id,
									         a.construction,
									         a.composition,
									         a.gsm_weight,
									         a.width_dia_type,
									         b.gmts_color_id
									    from wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b,wo_booking_dtls c ,wo_pre_cos_fab_co_avg_con_dtls d
									    where     a.job_no = b.job_no
									         and a.id = b.pre_cost_fabric_cost_dtls_id
									         and b.booking_no=c.booking_no
									         and b.po_break_down_id=c.po_break_down_id
									         and b.pre_cost_fabric_cost_dtls_id=c.pre_cost_fabric_cost_dtls_id
									         and b.gmts_color_id=c.gmts_color_id
									        and  a.id=d.pre_cost_fabric_cost_dtls_id
									        and d.gmts_sizes=b.size_number_id
									        and c.status_active = 1
									        and c.is_deleted = 0
								         and a.body_part_id=$bpart_id 
								         and b.booking_no =$txt_booking_no 
								         and b.job_no in ($all_jobs_id) 
								         and a.body_part_type=40  
								         and b.status_active=1 
								         and b.is_deleted=0 
								    group by  a.rate,a.amount, a.job_no , a.id ,a.color_size_sensitive,a.color_break_down, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition,a.gsm_weight,a.width_dia_type,b.gmts_color_id  order by a.body_part_id,b.gmts_color_id  " ;
	          $sql_data_collar_cuff2=sql_select($sql_collar_cuff2);
					?>
					 <table align="left"  width="100%" style="margin-top: 5px;" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" >
			  			<tr>
			  				<td colspan="<? echo count($nameArray_size)+14;?>" align="center">
			  					<strong>Collar Details(<? echo $body_part[$bpart_id];?>)</strong>
			  				</td>

			  			</tr>
			  			<tr>
			  				<td  width="30"  rowspan="2" align="center"><strong>SL</strong> </td>
			  				<td  width="150" rowspan="2" align="center"><strong>Style</strong></td>
 			  				<td  width="140"  rowspan="2" align="center"><strong>Gmts Item</strong></td>
 			  				<td  width="100"  rowspan="2" align="center"><strong>Body Part</strong></td>
							<td  width="100" rowspan="2" align="center"><strong>Actual Qty(Pcs)</strong></td>
			  				<td  width="390" rowspan="2" align="left">&nbsp;&nbsp;<strong>Collar Composition</strong></td>
			  				<td  width="100"  rowspan="2" align="center"><strong>Color Type</strong></td>
 			  				<td  width="100"  rowspan="2"  align="center"><strong>Combo</strong></td>
							<td  width="100"  rowspan="2"  align="center"><strong>Fabric Color</strong></td>
 			  				<?
 			  				foreach($nameArray_item_size  as $result_size)
 			  				{
 			  					?>
 			  					<td width="40" align="center"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>

 			  					<?
 			  				}
 			  				?>
			  				<td width="60"  rowspan="2" align="center"><strong> Req Qty (Pcs)</strong> </td>
			  				<td  width="50" rowspan="2"  align="center"><strong> Excess %  </strong> </td>
			  				<td width="50" rowspan="2"  align="center"><strong>Price/Pcs</strong></td>
			  				<td  width="40" rowspan="2" align="center"><strong>Amount</strong></td>


			  			</tr>
			  			<tr>
			  				<?
			  				foreach($nameArray_item_size  as $result_item_size)
			  				{
			  					//$size_with_item=rtrim($size_with_item_size_array[$id],',');
								//$size_with_item=implode(",",array_unique(explode(",",$size_with_item)));
								?>
			  					<td  align="center"><? echo $result_item_size[csf('item_size')];?></td>

			  					<?
			  				}
			  				?>

			  			</tr>
			  			<?
			  			$p=1;
			  			foreach($sql_data_collar_cuff2 as $row)
			  			{

							?>
			  				<tr>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="30" align="center"><? echo $p;?></td>
			  					<td style="word-break: break-all;word-wrap: break-word;" width="150" align="center"><? echo $job_wise_style[$row[csf("job_no")]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="140" align="center"><?  $item_id= $row[csf('item_number_id')];echo $garments_item[$item_id]; ?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center"><? echo $body_part[$row[csf("body_part_id")]];?></td>
								<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center"><? $gmt_actual_qty=$gmts_qty_data_arr[$row[csf('job_no')]][$item_id][$row[csf('gmts_color_id')]][40];echo number_format($gmt_actual_qty,0);$total_gmt_actual_qty+=$gmt_actual_qty;?></td>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="390" align="left"> &nbsp;
			  						<? echo $row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$fabric_typee[$row[csf('width_dia_type')]] ;?>
			  					</td>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="100" align="center"><? echo $color_type[$row[csf('color_type_id')]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center">
			  						<? echo $color_library[$row[csf('gmts_color_id')]];  ?>
			  					</td>
								<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center">
			  						<?
										if($row[csf('color_size_sensitive')]==1 or $row[csf('color_size_sensitive')]==2 or $row[csf('color_size_sensitive')]==4)
										{
											$gmt_fab_color=$color_library[$row[csf('gmts_color_id')]];
										}
										else
										{
											$contrast_color_id=return_field_value("b.contrast_color_id as contrast_color_id", "wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b", "a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.job_no in ($all_jobs_id) and a.id=".$row[csf('fabric_cost_dtls_id')]."  and b.gmts_color_id=".$row[csf('gmts_color_id')]." ","contrast_color_id");//pre_cost_fabric_cost_dtls_id
											if($contrast_color_id>0)
											{
												$gmt_fab_color=$color_library[$contrast_color_id];
											}
										}
									echo $gmt_fab_color;  ?>
			  					</td>


			  					<?
								$color_qty=0; $greyQty=0;
			  					//foreach($size_id_array as $id=>$val)
								foreach($nameArray_item_size  as $result_size)
			  					{
			  						?>
			  						<td  style="word-break: break-all;word-wrap: break-word;" width="40"  align="center"><? echo $cuff_grey_qty=$size_item_wise_qnty[$row[csf("body_part_id")]][$row[csf("fabric_cost_dtls_id")]][$row[csf("gmts_color_id")]][$result_size[csf("size_number_id")]][$result_size[csf("item_size")]]["grey"];//.'K '.$row[csf("fabric_cost_dtls_id")].'='.$row[csf("gmts_color_id")].'='.$id.'='.$size_with_item_size_array[$id];
									?></td>

			  						<?
			  						$size_wise_qnty_array[$id]+=$val;
									$grand_size_wise_qnty_array[$result_size[csf("size_number_id")]][$result_size[csf("item_size")]]+=$cuff_grey_qty;
									$size_item_wise_qnty[$row[csf("body_part_id")]][$result_size[csf("size_number_id")]][$result_size[csf("item_size")]]+=$cuff_grey_qty;
									$color_qty+=$cuff_grey_qty;

			  					}
								$row_excess_per= $color_wise_excess_per_arr[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf("gmts_color_id")]][$item_id]["row_excess_per"];
			  					?>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="60" align="center">
			  						<? echo $grey_qnty=$color_qty;//$color_wise_qnty[$row[csf('gmts_color_id')]][$item_id]["grey"];  ?>
			  					</td>

			  					<td  style="word-break: break-all;word-wrap: break-word;" title="<? echo $row_excess_per;?>" width="50" align="center">
			  						<?  $excess= $color_wise_excess_per_arr[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf("gmts_color_id")]][$item_id]["excess_per"]/$row_excess_per;
									echo number_format($excess,2);
									  ?>
			  					</td>


			  					<td style="word-break: break-all;word-wrap: break-word;" title="<? echo $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["row_rate"];?>"  width="50" align="center">
			  						<? echo  $cuff_price=$color_wise_qnty2[$row[csf("fabric_cost_dtls_id")]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["rate"];  ?>
			  					</td>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="40" align="center">
			  						<? echo $amount=$grey_qnty*$cuff_price;   ?>
			  					</td>
			  				</tr>
			  				<?

							$sub_collor_qty_arr[$row[csf("body_part_id")]]+=$grey_qnty;
							$sub_collor_amount_arr[$row[csf("body_part_id")]]+=$amount;

							$sub_excess_arr[$row[csf("body_part_id")]]+=$excess;
							$sub_price_arr[$row[csf("body_part_id")]]+=$cuff_price;
							$cuff_body_wise_avg_row[$row[csf("body_part_id")]]+=1;

							$gr_fin_qty+=$fin_qty;
			  				$gr_collor_qty+=$grey_qnty;
							$gr_amount+=$amount;
			  				$gr_excess+=$excess ;
			  				$gr_col_avg_price+=$cuff_price;
			  				$gr_col_avg_row++;



			  				$p++;
			  			}
			  			?>
						<tr class="tbl_bottom">
							<td colspan="9" align="right">Total </td>
							<?
							//foreach($size_id_array as $id=>$val)
							foreach($nameArray_item_size  as $result_size)
							{
								?>
								<td  align="center"><? echo $size_item_wise_qnty[$bpart_id][$result_size[csf("size_number_id")]][$result_size[csf("item_size")]]?></td>

								<?
							}
							$cuff_sub_excess=$sub_excess_arr[$bpart_id];
							$cuff_sub_price=$sub_price_arr[$bpart_id];
							$cuff_body_wise_avg_tot_row=$cuff_body_wise_avg_row[$bpart_id];
							?>
							<td align="center">
								<? echo $sub_collor_qty_arr[$bpart_id];  ?>
							</td>
							<td align="center" title="Sub Exess & sub Row=<? echo $cuff_sub_excess.'='.$cuff_body_wise_avg_tot_row ?>">
									<? echo number_format($cuff_sub_excess/$cuff_body_wise_avg_tot_row,2); ?></td>
							<td align="center"><? echo number_format($cuff_sub_price/$cuff_body_wise_avg_tot_row,2); ?></td>

							<td align="center">
								<? echo $sub_collor_amount_arr[$bpart_id];   ?>
							</td>
			  			</tr>
						<!--Sub TOT End-->


			  			<?
						} //Body Part End
						?>

						<tr>
			  				<td colspan="9" align="right">Grand Total </td>
			  				<?
			  				foreach($nameArray_item_size  as $result_size)
							  {
			  					?>
			  					<td  align="center"><?  echo $grand_size_wise_qnty_array[$result_size[csf("size_number_id")]][$result_size[csf("item_size")]];?></td>

			  					<?
			  				}
			  				?>
			  				<td align="center">
			  					<? echo $gr_collor_qty;  ?>
			  				</td>
			  				<td align="center" title="Sub Exess & Tot Row=<? echo $gr_excess.'='.$gr_avg_row ?>"><? echo number_format($gr_excess/$gr_col_avg_row,2); ?></td>
							<td align="center"  title="Tot Price  & Tot Row=<? echo $gr_col_avg_price.'='.$gr_col_avg_row.'**'.$p?>"><? //echo number_format($gr_col_avg_price/$gr_col_avg_row,2); ?></td>

			  				<td align="center">
			  					<? echo $gr_amount;   ?>
			  				</td>
			  			</tr>

						</table>
						<?
			  		}
			  	?>


					<br/><br/>

						<?
	     	  $sql_collar_cuff= "SELECT a.rate,a.amount, a.job_no , a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,b.gmts_color_id,b.size_number_id,b.item_size,b.gmts_qty,b.excess_per,b.qty,b.po_break_down_id as po_id,b.id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id) and a.body_part_type=50 and b.status_active=1 and b.is_deleted=0  order by a.body_part_id,b.gmts_color_id,b.id " ;
	         $sql_data_collar_cuff=sql_select($sql_collar_cuff);
	         $size_id_array=array();
	         $size_with_item_size_array=array();
	         $size_item_wise_qnty=array();
	         $color_wise_qnty=array();
	         foreach($sql_data_collar_cuff as $vals)
	         {
	         	$body_part_array[$vals[csf("body_part_id")]]=$vals[csf("body_part_id")];
				$size_id_array[$vals[csf("size_number_id")]]=$vals[csf("size_number_id")];
	         	$size_with_item_size_array[$vals[csf("size_number_id")]][$vals[csf("body_part_id")]]=$vals[csf("item_size")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["grey"]+=$vals[csf("qty")];

	         	//$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]=$vals[csf("excess_per")];
				if($vals[csf("excess_per")]>0)
				{
				$color_wise_excess_per_cuff_arr[$vals[csf('fabric_cost_dtls_id')]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]+=$vals[csf("excess_per")];
				$color_wise_excess_per_cuff_arr[$vals[csf('fabric_cost_dtls_id')]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_excess_per"]+=1;
				}
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["grey"]+=$vals[csf("qty")];
	         	/*$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];*/
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["amount"]=$vals[csf("amount")];
				$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_rate"]=1;

	         }
				unset($sql_data_collar_cuff);
	         $sql_collar_cuff3 = sql_select("SELECT c.rate, a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id, c.gmts_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls c WHERE a.job_no=c.job_no and a.id=c.pre_cost_fabric_cost_dtls_id and  a.id=c.pre_cost_fabric_cost_dtls_id and c.booking_no =$txt_booking_no and c.job_no in ($all_jobs_id) and a.body_part_type=50 and c.status_active=1 and c.is_deleted=0  order by a.body_part_id");

	         foreach($sql_collar_cuff3 as $vals)
	         {

	         	$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];

	         }


	         $counts=count($size_id_array);$grand_size_wise_qnty_array=array();
	          if(count($body_part_array)>0)
	          {
					$gr_collor_qty=$gr_amount=$gr_avg_price=$gr_avg_row=$gr_excess=0;
					foreach($body_part_array as $bpart_id=>$val)
					{
					$sql_collar_cuff2= "SELECT a.rate, a.amount, a.job_no, a.id as fabric_cost_dtls_id, a.color_size_sensitive, a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.width_dia_type, b.gmts_color_id from wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b,wo_booking_dtls c ,wo_pre_cos_fab_co_avg_con_dtls d where     a.job_no = b.job_no and a.id = b.pre_cost_fabric_cost_dtls_id and b.booking_no=c.booking_no and b.po_break_down_id=c.po_break_down_id and b.pre_cost_fabric_cost_dtls_id=c.pre_cost_fabric_cost_dtls_id and b.gmts_color_id=c.gmts_color_id and  a.id=d.pre_cost_fabric_cost_dtls_id and d.gmts_sizes=b.size_number_id and c.status_active = 1 and c.is_deleted = 0 and b.booking_no =$txt_booking_no and a.body_part_id=$bpart_id and b.job_no in ($all_jobs_id) and a.body_part_type=50 and b.status_active=1 and b.is_deleted=0 group by a.rate,a.amount, a.job_no , a.id , a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition,a.gsm_weight,a.width_dia_type,b.gmts_color_id,a.color_size_sensitive  order by a.body_part_id,b.gmts_color_id  " ;
	          $sql_data_collar_cuff2=sql_select($sql_collar_cuff2);
					?>

			  	 <table align="left"  width="100%" style="margin-top: 5px; margin-bottom:10px;"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" >
			  			<tr>
			  				<td colspan="<? echo $counts+13;?>" align="center">
			  					<strong>Cuff Details &nbsp;(<? echo  $body_part[$bpart_id];?>) </strong>
			  				</td>
			  			</tr>
			  			<tr>
			  				<td  width="30"  rowspan="2" align="center"><strong>SL</strong> </td>
			  				<td  width="150" rowspan="2" align="center"><strong>Style</strong></td>
 			  				<td  width="140" rowspan="2" align="center"><strong>Gmts Item</strong></td>
 			  				<td  width="100" rowspan="2" align="center"><strong>Body Part</strong></td>
							<td  width="100" rowspan="2" align="center"><strong>Actual Qty(Pcs)</strong></td>
			  				<td  width="390" rowspan="2" align="left">&nbsp;&nbsp;<strong>Cuff Composition</strong></td>
			  				<td  width="100" rowspan="2" align="center"><strong>Color Type</strong></td>
 			  				<td  width="100" rowspan="2"  align="center"><strong>Combo</strong></td>
							<td  width="100" rowspan="2"  align="center"><strong>Fabric Color</strong></td>
 			  				<?
 			  				foreach($size_id_array as $id=>$val)
 			  				{
 			  					?>
 			  					<td width="40" align="center"><strong><? echo $size_library[$id];?></strong></td>

 			  					<?
 			  				}
 			  				?>

			  				<td width="60"  rowspan="2" align="center"><strong> Req Qty(Pcs) </strong> </td>
			  				<td  width="50" rowspan="2"  align="center"><strong> Excess %  </strong> </td>

			  				<td width="50" rowspan="2"  align="center"><strong>Price/Pcs</strong></td>
			  				<td  width="40" rowspan="2" align="center"><strong>Amount</strong></td>
			  			</tr>
			  			<tr>
			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td width="40"  align="center"><strong><? echo $size_with_item_size_array[$id][$bpart_id];?></strong></td>
			  					<?
			  				}
			  				?>
			  			</tr>
			  			<?
			  			$p=1;
			  			$size_wise_qnty_array=array();
			  			foreach($sql_data_collar_cuff2 as $row)
			  			{
							?>
			  				<tr>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="30" align="center"><? echo $p;?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="150" align="center"><? echo $job_wise_style[$row[csf("job_no")]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="140" align="center"><?  $item_id= $row[csf('item_number_id')];echo $garments_item[$item_id]; ?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center"><? echo $body_part[$row[csf("body_part_id")]];?></td>
								<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center"><? $gmt_actual_qty=$gmts_qty_data_arr[$row[csf('job_no')]][$item_id][$row[csf('gmts_color_id')]][50];echo number_format($gmt_actual_qty,0);$total_gmt_actual_qty+=$gmt_actual_qty;?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="390" align="left"> &nbsp;
			  						<? echo $row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$fabric_typee[$row[csf('width_dia_type')]] ;?>
			  					</td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center"><? echo $color_type[$row[csf('color_type_id')]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center">
			  						<? echo $color_library[$row[csf('gmts_color_id')]];  ?>
			  					</td>
								<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center">
			  						<?
									if($row[csf('color_size_sensitive')]==1 or $row[csf('color_size_sensitive')]==2 or $row[csf('color_size_sensitive')]==4)
										{
											$gmt_fab_color=$color_library[$row[csf('gmts_color_id')]];
										}
										else
										{
											$contrast_color_id=return_field_value("b.contrast_color_id as contrast_color_id", "wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b", "a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.job_no in ($all_jobs_id) and a.id=".$row[csf('fabric_cost_dtls_id')]."  and b.gmts_color_id=".$row[csf('gmts_color_id')]." ","contrast_color_id");//pre_cost_fabric_cost_dtls_id
											if($contrast_color_id>0)
											{
												$gmt_fab_color=$color_library[$contrast_color_id];
											}
										}
									echo $gmt_fab_color;   ?>
			  					</td>

			  					<?
								$tot_size_qty=0;
			  					foreach($size_id_array as $id=>$val)
			  					{
			  						?>
			  						<td  style="word-break: break-all;word-wrap: break-word;"  width="40"  align="center"><? echo $size_grey_qty=$size_item_wise_qnty[$row[csf("body_part_id")]][$row[csf('fabric_cost_dtls_id')]][$row[csf("gmts_color_id")]][$id][$size_with_item_size_array[$id][$row[csf("body_part_id")]]]["grey"];?></td>

			  						<?
			  						$size_wise_qnty_array[$id]+=$size_grey_qty;$sub_size_wise_qnty_array[$row[csf("body_part_id")]][$id]+=$size_grey_qty;
									$grand_size_wise_qnty_array[$id]+=$size_grey_qty;
									$tot_size_qty+=$size_grey_qty;

			  					}
			  					?>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="60" align="center">
			  						<? echo $grey_qnty=$tot_size_qty;//$color_wise_qnty[$row[csf('gmts_color_id')]][$item_id]["grey"];
									$row_excess_per=$color_wise_excess_per_cuff_arr[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf("gmts_color_id")]][$item_id]["row_excess_per"];
									 ?>
			  					</td>

			  					<td  style="word-break: break-all;word-wrap: break-word;" title="excess tot=<? echo $row_excess_per; ?>"  width="50" align="center">
			  						<?  $avg_excess=$color_wise_excess_per_cuff_arr[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf("gmts_color_id")]][$item_id]["excess_per"]/$row_excess_per;echo number_format($avg_excess,2);   ?>
			  					</td>
			  					<td   style="word-break: break-all;word-wrap: break-word;" width="50" title="<? echo $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["row_rate"];?>" align="center">
			  						<? echo $price= $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["rate"];
									$tot_row_rate= $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["row_rate"]; ?>

			  					</td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="40" align="center">
			  						<? echo  $amount=$grey_qnty* $price;   ?>
			  					</td>

			  				</tr>
			  				<?
			  				$sub_collor_qty_arr[$row[csf("body_part_id")]]+=$grey_qnty;
							$sub_collor_amount_arr[$row[csf("body_part_id")]]+=$amount;
							$sub_excess_arr[$row[csf("body_part_id")]]+=$avg_excess;
							$sub_price_arr[$row[csf("body_part_id")]]+=$price;
							$body_wise_avg_row[$row[csf("body_part_id")]]+=1;

							$gr_fin_qty+=$fin_qty;
			  				$gr_collor_qty+=$grey_qnty;
			  				$gr_avg_price+=$price;
							$gr_amount+=$amount;
			  				$gr_excess+=$avg_excess;

			  				$gr_avg_row++;

			  				$p++;
			  			}
			  			?>

			  			<tr>
			  				<td colspan="9" align="right">Total </td>
			  				<?
							//$sub_size_wise_qnty_array=array();
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td  align="center"><? echo $sub_size_wise_qnty_array[$bpart_id][$id];
								//$sub_size_wise_qnty_array[$row[csf("body_part_id")]][$id]=0;
								/*$grand_size_wise_qnty_array[$id]+=$sub_size_wise_qnty_array[$bpart_id][$id];*/
								?></td>
			  					<?
			  				}
							$tot_avg_row=$body_wise_avg_row[$bpart_id];
							$tot_sub_excess=$sub_excess_arr[$bpart_id];
							$tot_sub_price=$sub_price_arr[$bpart_id];
			  				?>
			  				<td align="center">
			  					<? echo $sub_collor_qty_arr[$bpart_id];  ?>
			  				</td>
			  				<td align="center" title="Tot Excess & Tot Row=<? echo $tot_sub_excess.'='.$tot_avg_row;?>"><? echo number_format($tot_sub_excess/$tot_avg_row,2); ?></td>
			  				<td align="center">
			  					<? echo number_format($tot_sub_price/$tot_avg_row,2);  ?>
			  				</td>
			  				<td align="center">
			  					<? echo $sub_collor_amount_arr[$bpart_id];   ?>
			  				</td>
			  			</tr>
			  			<?
						} //Body Part End

			  		?>
					<tr>
			  				<td colspan="9" align="right">Grand Total </td>
			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td  align="center"><? echo $grand_size_wise_qnty_array[$id];?></td>
			  					<?
			  				}
			  				?>
			  				<td align="center">
			  					<? echo $gr_collor_qty;  ?>
			  				</td>
			  				<td align="center" title="grand Excess &tot row=<? echo $gr_excess.'='.$gr_avg_row;?>"><? echo number_format($gr_excess/$gr_avg_row,2); ?></td>
			  				<td align="center">
			  					<? //echo number_format($gr_avg_price/$gr_avg_row,2);  ?>
			  				</td>
			  				<td align="center">
			  					<? echo $gr_amount;   ?>
			  				</td>
			  			</tr>
			  	</table>
				<?
					}
				?>

				</div>
				<br>
				
				<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
						<caption> <strong style="float:left"> Stripe Details</strong></caption>
					<?
					$color_name_arr=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0",'id','color_name');
					$po_name_arr=return_library_array( "select id,po_number from wo_po_break_down where status_active=1 and is_deleted=0",'id','po_number');
					// and b.fabric_color_id=d.stripe_color 
					$sql_stripe_po=sql_select("SELECT  b.po_break_down_id from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and d.job_no in($all_jobs_id) and b.booking_no=$txt_booking_no and d.color_number_id=b.gmts_color_id and c.color_type_id in (2,6) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and 	b.is_deleted=0  group by b.po_break_down_id");
					foreach($sql_stripe_po as $po_row){
						$stripe_po_arr[$po_row[csf('po_break_down_id')]]=$po_name_arr[$po_row[csf('po_break_down_id')]];
					}

					$sql_stripe=("SELECT c.id, d.id as did, c.job_no,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,d.color_number_id as color_number_id,d.uom,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,c.uom as type_uom from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and d.job_no in($all_jobs_id) and b.booking_no=$txt_booking_no  and c.color_type_id in (2,6) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and b.is_deleted=0  group by c.id,c.job_no,c.body_part_id,c.fabric_description,c.gsm_weight,d.color_number_id,d.uom,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,c.composition,c.construction,c.uom, c.id, d.id order by c.job_no, c.id, d.id");
					//echo $sql_stripe;


					$result_data=sql_select($sql_stripe);
					foreach($result_data as $row){
						$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
						$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
						$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]+=$row[csf('fabreqtotkg')];
						$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['subtotal_measurement'][$row[csf('did')]]=$row[csf('measurement')];
						$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

						$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
						$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
						$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
						$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom']=$row[csf('uom')];
						//$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
						$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg']+=$row[csf('fabreqtotkg')];
						$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabric_description']=$row[csf('fabric_description')];
						
						$strip_id_arr[$row[csf('did')]]=$row[csf('did')];

						
					}
					if(count($strip_id_arr)>0){
						$stripe_id_str=implode(",",$strip_id_arr);
						$stripe_po_sql=sql_select("SELECT a.po_break_down_id from WO_BOOKING_DTLS a join WO_PRE_STRIPE_COLOR b on a.PRE_COST_FABRIC_COST_DTLS_ID=b.PRE_COST_FABRIC_COST_DTLS_ID where a.status_active=1 and a.is_deleted=0 and b.id in ($stripe_id_str) group by a.po_break_down_id");
					}
					

					?>
						<tr>
							<th width="30"> SL</th>
							<th width="150"> PO Number</th>
							<th width="60"> Body Part</th>
							<th width="100">Fab. Desc.</th>
							<th width="60">Gmts Color</th>
							<th width="60">Fabric Qty </th>
							<th width="40">Color Sequence</th>
							<th width="60"> Stripe Color</th>
							<th width="60"> Stripe Measurement</th>
							<th  width="50"> Uom</th>
							<th  width="50"> Qty.(KG)</th>
							
						</tr>
						<?
						foreach($stripe_arr as $body_id=>$body_data){
							foreach($body_data as $color_id=>$color_val){
								$total_rowspan+=count($color_val['stripe_color']);
								foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
								{
								$color_strip_color_qty_arr[$body_id][$color_id]=$color_val['fabreqtotkg'][$strip_color_id];
								}
							}
						}
						$i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
						foreach($stripe_arr as $body_id=>$body_data){
							foreach($body_data as $color_id=>$color_val){
								$rowspan=count($color_val['stripe_color']);
								$composition=$stripe_arr2[$body_id][$color_id]['composition'];
								$construction=$stripe_arr2[$body_id][$color_id]['construction'];
								$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
								//$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
								$uom_id=$stripe_arr2[$body_id][$color_id]['uom'];
								$subtotal_measurement=array_sum($color_val['subtotal_measurement']);					
								$color_qty=$stripe_arr2[$body_id][$color_id]['fabreqtotkg'];
								//$color_qty=$color_strip_color_qty_arr[$body_id][$color_id];
								$fabric_des=$stripe_arr2[$body_id][$color_id]['fabric_description'];
								$qnty=$color_qty/$subtotal_measurement;
								$total_color_qty+=$color_qty;
								?>
								<tr>
								<?
								if($i==1){
								?>
								<td rowspan="<? echo $total_rowspan;?>" align="center"> <? echo $i; ?></td>
								<td rowspan="<? echo $total_rowspan;?>" align="center"> <? echo implode(",",$stripe_po_arr); ?></td>
								<? } ?>
									<td rowspan="<? echo $rowspan;?>" align="center"> <? echo $body_part[$body_id]; ?></td>
									<td rowspan="<? echo $rowspan;?>" align="center"> <? echo $fabric_des; ?></td>
									<td rowspan="<? echo $rowspan;?>" align="center"> <? echo $color_name_arr[$color_id]; ?></td>
									<td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?></td>
								<?
								//$total_fab_qty+=$color_wise_wo_result_qnty[csf('fin_fab_qnty')];
								$k=1;
								foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
								{
									$measurement=$color_val['measurement'][$strip_color_id];
									$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
									$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
									$qnty_kg=$qnty*$measurement;
									?>
									<td align="center"><?  echo  $k; ?></td>
									<td align="center"><?  echo  $color_name_arr[$s_color_val]; ?></td>
									<td align="right"> <? echo  number_format($measurement,2); ?></td>
									<td align="center"> <? echo  $unit_of_measurement[$uom_id]; ?></td>
									<td align="right"> <? echo  number_format($fabreqtotkg,2); ?></td>						
								</tr>
									<?
									$total_fabreqtotkg+=$fabreqtotkg;
									$k++;
									
								}
								$i++;
							}
						}
						?>
					<tfoot>
					<tr>
						<td colspan="5">Total </td>
						<td align="right"><? echo  number_format($total_color_qty,2); ?> </td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
					</tr>
					</tfoot>
			</table>


			<br/>

		<?
		$lib_item_group_arr=return_library_array( "select item_name, id from lib_item_group where item_category=4 and is_deleted=0  and  status_active=1 order by item_name", "id", "item_name");
		
		$sql=sql_select("select id from wo_booking_mst where booking_no=$txt_booking_no");
		$bookingId=0;
		foreach($sql as $row)
		{
			$bookingId= $row[csf('id')];
		}
		$sql_data=sql_select("select a.fabric_color,a.item_color,a.precost_trim_cost_id,b.trim_group,b.cons_uom,sum(qty) as qty   from wo_dye_to_match a, wo_pre_cost_trim_cost_dtls b where a.precost_trim_cost_id=b.id and a.booking_id=$bookingId and a.qty>0 and a.is_deleted=0  and  a.status_active=1 and b.is_deleted=0  and  b.status_active=1 group by a.fabric_color,a.item_color,a.precost_trim_cost_id,b.trim_group,b.cons_uom order by a.fabric_color");
		if(count($sql_data)>0)
		{
		$i=0; $dyeing_qty=0;
		foreach($sql_data  as $row)
		{
			$i++;
			?>
			<table align="left" width="70%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
			<tr align="center">
			<td colspan="5"><b>Trims Dye To Match</b></td>
			</tr>
			<tr align="center">
				<td>Sl</td>
				<td>Trims Name </td>
				<td>Fabric Color</td>
				<td>UOM</td>
				<td>Qnty.</td>
				
			</tr>
			<tr align="center">
				<td><? echo $i; ?></td>
				<td> <? echo $lib_item_group_arr[$row[csf('trim_group')]];?></td>
				<td><? echo $color_library[$row[csf('fabric_color')]];?></td>
				<td><? echo $unit_of_measurement[$row[csf('cons_uom')]];?></td>
				<td align="right"><? echo number_format($row[csf('qty')],2);?></td>
				
			</tr>
			<?
			$dyeing_qty+=$row[csf('qty')];
		}
		?>
		<tr align="center">
			<td colspan="4" align="right">Total</td>
			<td align="right"><? echo number_format($dyeing_qty,2); ?></td>
		</tr>
	</table>
	<? } ?>
	<br>

			<table  style="margin-top: 5px;float: left;"    width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

				<tr>
					<td colspan="9" align="center">
						<strong>Comments</strong>
					</td>
				</tr>
				<tr>
					<td align="center"> SL </td>
					<td align="center" width="200"  style="word-wrap: break-word;word-break: break-all;"> PO NO </td>
					<td align="center">BOM Qty</td>
					<td align="center"> Booking Qty </td>
					<td align="center"> Short Booking Qty </td>
					<td align="center"> Total Booking Qty </td>
					<td align="center"> Balance </td>
					<td align="center"> Comments </td>
				</tr>
				<?
				$is_short_data=sql_select("SELECT a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0   and b.is_short =1 group by  a.id ");
				foreach($is_short_data as $vals)
				{
					$short_qty_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
				}

				$booking_data=sql_select("SELECT a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and  b.status_active=1 and b.is_deleted=0 and b.is_short !=1 and b.booking_type=1 group by  a.id  order by a.id");
				foreach($booking_data as $vals)
				{
					$booking_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
				}

				$po_date=return_library_array("select id,shipment_date from wo_po_break_down where status_active=1 and is_deleted=0",'id','shipment_date');

				$comments_data=sql_select("SELECT min(a.id) as ids,b.po_break_down_id as po_number,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,SUM(b.requirment) as precost_grey_qty FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id
					and
					b.po_break_down_id=d.po_break_down_id and
					b.color_number_id=d.gmts_color_id and
					b.dia_width=d.dia_width and
					b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					a.job_no=d.job_no and
					a.id=d.pre_cost_fabric_cost_dtls_id
					and
					d.booking_no =$txt_booking_no and
					d.job_no in($all_jobs_id) and

					d.status_active=1 and
					d.is_deleted=0 and
					b.cons>0
					group by b.po_break_down_id order by b.po_break_down_id");



				$job_no=$all_jobs_id;
				$condition= new condition();
				if(str_replace("'","",$job_no) !='')
				{
					$condition->job_no("in ($job_no)");
				}
				$condition->init();
				$fabric= new fabric($condition);
				$fabric_costing_qty_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish();

				$j=1;
				$total_bom=0;
				$total_book=0;
				$total_short=0;
				$total_short_full=0;
				$total_balance=0;
				foreach($comments_data as $val)
				{
					$po_id=$val[csf('po_number')];
					$woven_qty=array_sum($fabric_costing_qty_arr['woven']['grey'][$po_id]);
					$knit_qty=array_sum($fabric_costing_qty_arr['knit']['grey'][$po_id]);
					$sum_woven_knit=$woven_qty + $knit_qty;


					?>
					<tr>
						<td align="center"><? echo $j;?></td>

						<td align="center"  style="word-wrap: break-word;word-break: break-all;"> <? echo $po_num_arr[$val[csf("po_number")]] ;?> </td>
						<td align="center"><?  echo $pre= def_number_format($sum_woven_knit,2);  ?> </td>
						<td align="center"><?  echo $bookings= def_number_format($booking_arr[$val[csf("po_number")]],2);  ?> </td>
						<td align="center"> <?echo $short=def_number_format($short_qty_arr[$val[csf("po_number")]],2); ?> </td>
						<td align="center"> <?   $tot_short_book= str_replace(',','',$bookings) +  str_replace(',','',$short) ; echo def_number_format($tot_short_book,2); ?>  </td>
						<td align="center"> <?  $bal =str_replace(',','',$pre)-str_replace(',','',$tot_short_book) ; echo def_number_format($bal,2);  ?> </td>
						<td align="center"> <? if($bal!=0){ if($pre>$tot_short_book){echo "Less ";} else{ echo "Over";} }?> </td>


					</tr>
					<?
					$total_bom +=str_replace(',','',$pre);
					$total_book +=str_replace(',','',$bookings);
					$total_short +=str_replace(',','',$short);
					$total_short_full += str_replace(',','',$tot_short_book);
					$total_balance += str_replace(',','',$bal);

					$j++;
				}
				?>
				<tr>
					<td colspan="2" align="right"> <b> Total </b></td>
					<td align="center"><strong><? echo def_number_format($total_bom,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_book,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_short,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_short_full,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_balance,2);?> </strong> </td>
					<td>&nbsp;</td>
				</tr>
			</table>



			<?
			if($cbo_fabric_source==1 || $cbo_fabric_source==2 || $cbo_fabric_source==3){
			?>
			<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
				<tr>
					<?
					$nameArray_item_size=sql_select( "SELECT min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active =1 and d.is_deleted=0 and d.job_no in($all_jobs_id)  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
					if(count($nameArray_item_size)>0)
					{
						?>
						<td width="49%">

						</td>
						<td width="2%">
						</td>
						<?
					}
					?>
					<?
					$nameArray_item_size=sql_select( "SELECT min(c.id) as id, b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.job_no in ($all_jobs_id)  and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");

					if(count($nameArray_item_size)>0)
					{
						?>
						<td width="49%">

						</td>
						<?
					}
					?>
				</tr>
			</table>
			<br/>

			<br/>



	<?
	//------------------------------ Query for TNA start-----------------------------------
	$po_id_all=str_replace("'","",$txt_order_no_id);
	$po_num_arr=return_library_array("SELECT id,po_number from wo_po_break_down where job_no_mst in($all_jobs_id)",'id','po_number');
	$tna_start_sql=sql_select( "SELECT id,po_number_id,
	(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
	(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
	(case when task_number=60 then task_start_date else null end) as knitting_start_date,
	(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
	(case when task_number=61 then task_start_date else null end) as dying_start_date,
	(case when task_number=61 then task_finish_date else null end) as dying_end_date,
	(case when task_number=64 then task_start_date else null end) as finishing_start_date,
	(case when task_number=64 then task_finish_date else null end) as finishing_end_date,
	(case when task_number=84 then task_start_date else null end) as cutting_start_date,
	(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
	(case when task_number=86 then task_start_date else null end) as sewing_start_date,
	(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
	(case when task_number=110 then task_start_date else null end) as exfact_start_date,
	(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
	(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
	(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
	from tna_process_mst
	where status_active=1 and po_number_id in($po_id_all) and job_no in ($all_jobs_id) order by po_number_id");
 	$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
	$tna_date_task_arr=array();
	foreach($tna_start_sql as $row)
	{
		if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
		{
			if($tna_fab_start=="")
			{
				$tna_fab_start=$row[csf("fab_booking_start_date")];
			}
		}
		if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
		}
		if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
		}
		if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
		}
		if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
		}
		if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
		}
		if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
		}
		if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
		}
	}
	//------------------------------ Query for TNA end-----------------------------------
	if(count($tna_start_sql)>0 )
	{
		?>
		<br>
		<!-- <fieldset id="div_size_color_matrix" style="max-width:1000;">
			<legend>TNA Information</legend>
			<table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
				<tr>
					<td rowspan="2" align="center" valign="top">SL</td>
					<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
					<td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
					<td colspan="2" align="center" valign="top"><b>Knitting</b></td>
					<td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
					<td colspan="2" align="center" valign="top"><b>Finishing Fabric</b></td>
					<td colspan="2" align="center" valign="top"><b>Cutting </b></td>
					<td colspan="2" align="center" valign="top"><b>Sewing </b></td>
					<td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
				</tr>
				<tr>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
				</tr>
				<?
				$i=1;
				foreach($tna_date_task_arr as $order_id=>$row)
				{
					?>
					<tr>
						<td><? echo $i; ?></td>
						<td><? echo $po_num_arr[$order_id]; ?></td>
						<td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
						<td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
						<td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
					</tr>
					<?
					$i++;
				}
				?>
			</table>
		</fieldset> -->
		<?
	}
	}// fabric Source End
	?>
	<br>

	<table width="220"  border="0" cellpadding="2" cellspacing="0" rules="all" style="float:left">
		<tr>
			<td width="200" valign="top" align="left">

				<div id="div_size_color_matrix" style="float:left;">
					<?
					$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
					?>
					<fieldset>
						<legend>RMG Process Loss % </legend>
						<table width="180" class="rpt_table" border="1" rules="all">
							<?
							if(number_format($rmg_process_breakdown_arr[8],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Cut Panel rejection <!-- Extra Cutting % breack Down 8-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[8],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[2],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Chest Printing <!-- Printing % breack Down 2-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[2],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[10],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Neck/Sleeve Printing <!-- New breack Down 10-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[10],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[1],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Embroidery   <!-- Embroidery  % breack Down 1-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[1],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[4],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Sewing /Input<!-- Sewing % breack Down 4-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[4],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[3],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Garments Wash <!-- Washing %breack Down 3-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[3],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[15],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Gmts Finishing <!-- Washing %breack Down 3-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[15],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[11],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Others <!-- New breack Down 11-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[11],2);
										?>
									</td>
								</tr>
								<?
							}
							$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
							if($gmts_pro_sub_tot>0)
							{
								?>
								<tr>
									<td width="130">
										Sub Total <!-- New breack Down 11-->
									</td>
									<td align="right">
										<?

										echo number_format($gmts_pro_sub_tot,2);
										?>
									</td>
								</tr>
								<?
							}
							?>
						</table>
					</fieldset>


					<fieldset>
						<legend>Fabric Process Loss % </legend>
						<table width="180" class="rpt_table" border="1" rules="all">
							<?
							if(number_format($rmg_process_breakdown_arr[6],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Knitting  <!--  Knitting % breack Down 6-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[6],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[12],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Yarn Dyeing  <!--  New breack Down 12-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[12],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[5],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Dyeing & Finishing  <!-- Finishing % breack Down 5-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[5],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[13],2)>0)
							{
								?>
								<tr>
									<td width="130">
										All Over Print <!-- new  breack Down 13-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[13],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[14],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Lay Wash (Fabric) <!-- new  breack Down 14-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[14],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[7],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Dying   <!-- breack Down 7-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[7],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[0],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Cutting (Fabric) <!-- Cutting % breack Down 0-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[0],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[9],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Others  <!-- Others% breack Down 9-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[9],2);
										?>
									</td>
								</tr>
								<?
							}
							$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
							if($fab_proce_sub_tot>0)
							{
								?>
								<tr>
									<td width="130">
										Sub Total  <!-- Others% breack Down 9-->
									</td>
									<td align="right">
										<?

										echo number_format($fab_proce_sub_tot,2);
										?>
									</td>
								</tr>
								<?
							}
							if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
							{
								?>
								<tr>
									<td width="130">
										Grand Total  <!-- Others% breack Down 9-->
									</td>
									<td align="right">
										<?
										echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2);
										?>
									</td>
								</tr>
								<?
							}
							?>
						</table>
					</fieldset>
				</div>
			</td>
		</tr>
	</table>

	<!-- <table width="400"  border="0" cellpadding="2" cellspacing="0" rules="all" style="float:left">
		<tr>
			<td colspan="6" align="left"><img  src='<? echo $path.$imge_arr[$po_job_no]; ?>' height='155' width='200' /></td>
		</tr>
	</table> -->
	<br>
	<br>
						<?
									$data_array = sql_select("select ID,TERMS, TERMS_PREFIX from wo_booking_terms_condition where booking_no = $txt_booking_no");
									$groupedData = array();
									foreach ($data_array as $row) {
										$prefix = $row["TERMS_PREFIX"];
										if($prefix!=""){
										$headerData[$prefix]=$prefix;
										$groupedData[$prefix]['TERMS'].=$row["TERMS"].',';
										}
										
									}
									// print_r($groupedData);
										?>
									<table width="100%" class="rpt_table" border="1"  cellpadding="0" cellspacing="0" rules="all" >
									<tr>
												<?
										foreach ($headerData as $header=>$head) {
												 
										if($header!=""){
											?>
										 <th><b> <?=$header;?> </b></th> 
										 <?
										}
									}
										?>
								  </tr>	
								 	 <tr>
										<?php
										foreach ($headerData as $header=>$head) {
											$terms=$groupedData[$header]['TERMS'];	
											$termsAll=rtrim($terms,',');
											$termsArr=array_unique(explode(',',$termsAll));
										?>
											<td valign="top"><?//=$termsAll;?>
											<table width="99%" style=" margin:2px;" class="rpt_table" border="1"  cellpadding="0" cellspacing="0" rules="all" >
												<?php
												$i=1;
												foreach($termsArr as $val)
												{?>
												<tr>
													<td> <?=$i;?></td>
													<td><b> <?=$val;?><b></td>
												</tr>
												<? $i++; }
												?>

											<tr>
												<td> </td>
										   </tr>
										  </table>
										
										</td>
										<?
										}
										?>

									</tr>
									</table>						
										 			
	<br/><br/>
	<? $booking_mst_info=sql_select("SELECT a.id as mst_id, to_char(a.insert_date, 'DD-MM-YYYY HH:MI:SS AM') as insert_date, b.user_full_name, c.custom_designation,a.company_id from wo_booking_mst a join user_passwd b on b.id = a.inserted_by join lib_designation c on c.id = b.designation where a.status_active=1 and a.is_deleted=0 and a.BOOKING_NO=$txt_booking_no");
	$mst_arr=array('insert_date','user_full_name','custom_designation','mst_id','company_id');
	foreach($booking_mst_info as $row){
		foreach($mst_arr as $data){
			$$data=$row[csf($data)];
		}
	}

	$electronic_sequence_arr = [];
    $get_electronic_sequence_sql = sql_select("select sequence_no as sequence_no from electronic_approval_setup where page_id = 410 and company_id=$company_id and is_deleted = 0 order by sequence_no asc");
    foreach ($get_electronic_sequence_sql as $sequence){
        $electronic_sequence_arr[] = $sequence['SEQUENCE_NO'];
    }

    $sql_get_checked_user = sql_select("select user_passwd.user_full_name as USER_FULL_NAME, lib_designation.custom_designation as CUSTOM_DESIGNATION, to_char(approval_history.approved_date, 'DD-MM-YYYY HH:MI:SS AM') as APPROVED_DATE from approval_history left join user_passwd on user_passwd.id = approval_history.approved_by left join lib_designation on lib_designation.id = user_passwd.designation where approval_history.entry_form = 7 and approval_history.mst_id = $mst_id and approval_history.sequence_no in(".implode(',', $electronic_sequence_arr).") and approval_history.id = (select max(id) from approval_history where entry_form = 7 and mst_id = $mst_id and sequence_no = ".min($electronic_sequence_arr).") and rownum = 1 and (select max(CURRENT_APPROVAL_STATUS) from approval_history where entry_form = 7 and mst_id = $mst_id) = 1 order by approval_history.approved_no asc");
	
    $sql_get_approved_user = sql_select("select user_passwd.user_full_name as USER_FULL_NAME, lib_designation.custom_designation as CUSTOM_DESIGNATION, to_char(approval_history.approved_date, 'dd-mm-yyyy hh:mi:ss am') as APPROVED_DATE from approval_history inner join wo_booking_mst a on a.id = approval_history.mst_id left join user_passwd on user_passwd.id = approval_history.approved_by left join lib_designation on lib_designation.id = user_passwd.designation where approval_history.mst_id = $mst_id and approval_history.entry_form = 7 and a.is_approved = 1 and approval_history.current_approval_status = 1 ");
	// and approval_history.sequence_no =".max($electronic_sequence_arr)
	?>
       
		    <table  width="100%"  border="0" cellpadding="0" cellspacing="0">
		    	<tr>
		            <td>  <?
					 $appSql = "select a.APPROVED_BY, a.APPROVED_DATE,b.USER_FULL_NAME,c.CUSTOM_DESIGNATION from approval_mst a,USER_PASSWD b,LIB_DESIGNATION c where a.mst_id =$mst_id  and a.APPROVED_BY=b.id and b.DESIGNATION=c.id and c.STATUS_ACTIVE=1 and c.IS_DELETED=0 and b.STATUS_ACTIVE=1 and b.IS_DELETED=0
					 union all
					 select b.id as APPROVED_BY, a.INSERT_DATE as APPROVED_DATE,b.USER_FULL_NAME,c.CUSTOM_DESIGNATION from wo_booking_mst a,USER_PASSWD b,LIB_DESIGNATION c where a.id =$mst_id  and a.INSERTED_BY=b.id and b.DESIGNATION=c.id and c.STATUS_ACTIVE=1 and c.IS_DELETED=0 and b.STATUS_ACTIVE=1 and b.IS_DELETED=0";
					 // echo $appSql;die;
					 $appSqlRes=sql_select($appSql);
					 $userDtlsArr=array();
					 foreach($appSqlRes as $row){
						 $userDtlsArr[$row['APPROVED_BY']]="<div><b>".$row['USER_FULL_NAME']."</b></div><div><b>".$row['CUSTOM_DESIGNATION']."</b></div><div><small>".$row['APPROVED_DATE']."</small></div>";
					 }
					//  echo "<pre>";
					//  print_r($userDtlsArr); 
					//    echo "</pre>";die();
					 
					 echo get_app_signature(121, $cbo_company_name,"900px",$template_id, 50,$inserted_by,$userDtlsArr);
		                    //echo signature_table(121, $cbo_company_name, "1330px",1,'');
							$job_no_all= implode(",",array_unique($joball['job_no']));
							$style_sting_all=implode(",",array_unique($joball['style_ref_no']));
							echo "****".custom_file_name($txt_booking_no,$style_sting_all,$job_no_all);
		                ?>
		            </td>
		        </tr>
		    </table>
	</div>
	<?
			
			$html = ob_get_contents();
			ob_clean();
			list($is_mail_send,$mail)=explode('___',$mail_send_data);
		
			if($is_mail_send==1){
				require_once('../../../mailer/class.phpmailer.php');
				require_once('../../../auto_mail/setting/mail_setting.php');
				$mailBody = preg_replace("/<img[^>]+\>/i", " ", $html); 
				$mailBody="<br>".$mail_body	;	
				$mailToArr=array();
				$mailSql = "select b.EMAIL  from wo_booking_mst a,LIB_SUPPLIER b where b.id=a.supplier_id and a.booking_no=$txt_booking_no";
			//echo $mailSql;die;
				$mailSqlRes=sql_select($mailSql);
				foreach($mailSqlRes as $rows){
					if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
				}
				
				
				$mailSql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=99 and b.mail_user_setup_id=c.id  and c.IS_DELETED=0 and c.STATUS_ACTIVE=1";
				//echo $mailSql;die;
				$mailSqlRes=sql_select($mailSql);
				foreach($mailSqlRes as $rows){
					if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
				}
				if($mail!=''){$mailToArr[]=$mail;}
		
				$to=implode(',',$mailToArr);
				$subject="Partial fabric booking";
				$header=mailHeader();
				echo $to;
				echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
				
			}
			else{
				echo $html;
			}
			exit();
}

if($action=="print_booking_17_bk") // md mamun ahmed sagor /17-07-2022 
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' or form_name='knit_order_entry' and file_type=1",'master_tble_id','image_location');
	$company_library=return_library_array( "select id,company_name from lib_company where status_active=1 and is_deleted=0", "id", "company_name");

	$color_library=return_library_array( "select id,color_name from lib_color  where status_active=1 and is_deleted=0", "id", "color_name");
	$size_library=return_library_array( "select id,size_name from lib_size  where status_active=1 and is_deleted=0", "id", "size_name");
	$country_arr=return_library_array( "select id,country_name from   lib_country  where status_active=1 and is_deleted=0",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier  where status_active=1 and is_deleted=0",'id','supplier_name');
	$supplier_address_arr=return_library_array( "select id,address_1 from   lib_supplier  where status_active=1 and is_deleted=0",'id','address_1');

	$lip_yarn_count=return_library_array( "select id,fabric_composition_id from lib_yarn_count_determina_mst where  status_active=1", "id", "fabric_composition_id");
	$fabric_composition_arr=return_library_array( "select id,fabric_composition_name from lib_fabric_composition where  status_active=1", "id", "fabric_composition_name");
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info  where status_active=1 and is_deleted=0","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer  where status_active=1 and is_deleted=0",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location  where status_active=1 and is_deleted=0",'id','location_name');

	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	$season_arr=return_library_array("select id,season_name from lib_buyer_season  where status_active=1 and is_deleted=0","id","season_name");
	$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where status_active=1 and is_deleted=0 and id in(select po_break_down_id from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no=$txt_booking_no)",'id','po_number');

	$uom=0;
	$joball=array();
	$nameArray_per_job=sql_select( "SELECT  a.season_buyer_wise,  a.job_no,a.style_ref_no ,a.season_matrix,a.gmts_item_id,a.product_dept,max(c.booking_date) as booking_date ,max(c.delivery_date) as delivery_date,max(c.fabric_start_date) as fabric_start_date,max(c.is_approved) as is_approved,max(c.buyer_id) as buyer_id,max(c.pay_mode) as pay_mode,max(supplier_id) as supplier_id,max(a.dealing_marchant) as dealing_marchant,max(c.attention) as attention,max(c.currency_id) as currency_id ,max(c.remarks)  as remarks from wo_po_details_master a , wo_booking_dtls b,wo_booking_mst c  where c.booking_no=b.booking_no and c.status_active=1 and c.is_deleted=0 and  a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by  a.season_buyer_wise, a.job_no,a.style_ref_no ,a.season_matrix,a.gmts_item_id,a.product_dept ");
	$po_job_no="";
	foreach ($nameArray_per_job as $vals)
	{
		$joball['job_no'][$vals[csf('job_no')]]=$vals[csf('job_no')];
		$joball['style_ref_no'][$vals[csf('job_no')]]=$vals[csf('style_ref_no')];
		$all_job_arr[$vals[csf("job_no")]]["job"]="'".$vals[csf("job_no")]."'";
		$all_job_arr[$vals[csf("job_no")]]["style"]=$vals[csf("style_ref_no")];
		$all_job_arr[$vals[csf("job_no")]]["item"]=$vals[csf("gmts_item_id")];
		$all_job_arr[$vals[csf("job_no")]]["season"]=$vals[csf("season_matrix")];

		$all_job_arr_season[$vals[csf("job_no")]]=$season_arr[$vals[csf("season_buyer_wise")]];

		$all_job_arr[$vals[csf("job_no")]]["dept"]=$vals[csf("product_dept")];
		$all_job_arr_dept[$vals[csf("job_no")]]=$product_dept[$vals[csf("product_dept")]];
		$all_jobs[$vals[csf("job_no")]]="'".$vals[csf("job_no")]."'";
		$all_job[$vals[csf("job_no")]]="".$vals[csf("job_no")]."";
		$job_wise_style[$vals[csf("job_no")]]= $vals[csf("style_ref_no")];
		$po_job_no=$vals[csf('job_no')];
	}
	//echo $po_job_no.'DDD';die;
	$all_jobs_id=implode(",",$all_jobs );
	$all_job_id=implode(",",$all_job );
	$seasons=implode(",",$all_job_arr_season );
	$depts=implode(",",$all_job_arr_dept );
	$style=implode(",",$job_wise_style );
 	$po_qnty_all_style=sql_select("SELECT sum(po_quantity) as qnty from wo_po_break_down where status_active=1 and is_deleted=0 and job_no_mst in ($all_jobs_id)");

 	$all_shipdates_arr=sql_select("SELECT min(b.pub_shipment_date)  as shipdate,job_no,a.order_uom as uom from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.status_active=1 and b.is_deleted=0 and  a.status_active=1 and a.is_deleted=0 and b.job_no_mst in ($all_jobs_id) group by job_no,a.order_uom");
 	$shipment_dates="";
 	$job_uom_array=array();
 	foreach($all_shipdates_arr as $key=>$data)
 	{
 		if($shipment_dates=="")
 		{
 			$shipment_dates=change_date_format($data[csf("shipdate")]);
 		}
 		else
 		{
 			$shipment_dates .=','.change_date_format($data[csf("shipdate")]);
 		}
 		$job_uom_array[$data[csf("job_no")]]=$unit_of_measurement[$data[csf("uom")]];


 	}
 	$unites=implode(",", $job_uom_array);


	$uom=0;
	$job_data_arr=array();
	$nameArray_buyer=sql_select( "SELECT  a.style_ref_no,a.style_description, a.job_no, a.style_owner, a.buyer_name, a.dealing_marchant,a.season,a.season_matrix,a.total_set_qnty,a.product_dept,a.product_code,a.pro_sub_dep,a.gmts_item_id ,a.order_repeat_no,a.qlty_label  from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  and a.job_no in ($all_jobs_id) ");

	foreach ($nameArray_buyer as $result_buy)
	{
		$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
		$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
		$job_data_arr['total_set_qnty'][$result_buy[csf('job_no')]]=$result_buy[csf('total_set_qnty')];
		$job_data_arr['product_dept'][$result_buy[csf('job_no')]]=$product_dept[$result_buy[csf('product_dept')]];
		$job_data_arr['product_code'][$result_buy[csf('job_no')]]=$result_buy[csf('product_code')];
		$job_data_arr['pro_sub_dep'][$result_buy[csf('job_no')]]=$pro_sub_dept_array[$result_buy[csf('pro_sub_dep')]];
		$job_data_arr['gmts_item_id'][$result_buy[csf('job_no')]]=$result_buy[csf('gmts_item_id')];
		$job_data_arr['style_ref_no'][$result_buy[csf('job_no')]]=$result_buy[csf('style_ref_no')];
		$job_data_arr['style_description'][$result_buy[csf('job_no')]]=$result_buy[csf('style_description')];
		$job_data_arr['dealing_marchant'][$result_buy[csf('job_no')]]=$marchentrArr[$result_buy[csf('dealing_marchant')]];
		$job_data_arr['season_matrix'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_matrix')]];
		$job_data_arr['order_repeat_no'][$result_buy[csf('job_no')]]=$result_buy[csf('order_repeat_no')];
		$job_data_arr['qlty_label'][$result_buy[csf('job_no')]]=$quality_label[$result_buy[csf('qlty_label')]];
		//$item_arr[$result_buy[csf('job_no')]]=$garments_item[$result_buy[csf('gmts_item_id')]];
		$item_arr[$result_buy[csf('job_no')]]=$result_buy[csf('gmts_item_id')];
	}
	$job_no= implode(",",array_unique($job_data_arr['job_no']));
	$job_no_in= implode(",",array_unique($job_data_arr['job_no_in']));
	$product_depertment=implode(",",array_unique($job_data_arr['product_dept']));
	$product_code=implode(",",array_unique($job_data_arr['product_code']));
	$pro_sub_dep=implode(",",array_unique($job_data_arr['pro_sub_dep']));
	$gmts_item_id=implode(",",array_unique($job_data_arr['gmts_item_id']));
	//$gmts_item_ids=implode(",",$item_arr['gmts_item_id']);
	$style_sting=implode(",",array_unique($job_data_arr['style_ref_no']));
	$style_description=implode(",",array_unique($job_data_arr['style_description']));
	$dealing_marchant=implode(",",array_unique($job_data_arr['dealing_marchant']));
	$season_matrix=implode(",",array_unique($job_data_arr['season_matrix']));
	$order_repeat_no= implode(",",array_unique($job_data_arr['order_repeat_no']));
	$qlty_label= implode(",",array_unique($job_data_arr['qlty_label']));
	$path=str_replace("'","",$path);
	if($path=="")
	{
	$path='../../';
	}

	foreach($item_arr as $data){
		$item_job_arr=explode(",",$data);
		foreach($item_job_arr as $itemid){
			$gmts_item_arr[$itemid]=$garments_item[$itemid];
		}

	}

	$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
	foreach ($nameArray as $result)
	{
		$comp_address_lib[$cbo_company_name]=$result[csf('plot_no')].",".$result[csf('level_no')].",".$result[csf('road_no')].",".$result[csf('block_no')].",".$result[csf('city')];
	}

	$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and a.status_active =1 and a.is_deleted=0 ");
	list($nameArray_approved_row) = $nameArray_approved;
	$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0 ");
	list($nameArray_approved_date_row) = $nameArray_approved_date;
	$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0 ");
	list($nameArray_approved_comments_row) = $nameArray_approved_comments;


	ob_start();
	?>
	<style type="text/css">

		body, p, span, td, a {font-size:10pt;font-family: Arial;}
		body{margin-left:2em; margin-right:2em; font-family: "Arial Narrow", Arial, sans-serif;}

	</style>

	<div style="width:1330px" align="center" >

		<table id="tb_header" width="100%" cellpadding="0" cellspacing="0" style="border:0px solid black" >
			<thead>
				<tr>
					<td width="150" ><img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100' width='100' /></br><b><?php echo $company_library[$cbo_company_name]; ?></b></td>					
					<td width="400" align="left" style="font-size: 16px;">
						<b>Corporate Office:</b></br>
						<p>House #21,Road # 13,Baridhara</br>Dhaka-1212,Bangladesh</br>PABX:880-2-9889078,9841735,9860445,98417979</br>Fax:880-2-9289172</br>Web:www.nazbd.com</p>
					</td>
					<td width="100">
					<?
						if($nameArray_approved_row[csf('approved_no')]>1)
						{
						?>
						<b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
						<br/>
						<b>Last Revised Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?></b>
						<?
						}
						?>
					</td>
					<td width="300" align="left"><img  src='<? echo $path.$imge_arr[$po_job_no]; ?>' align="left" height='150' width='200' /></td>
					<td width="150"  align="left"></td>
				</tr>
				<tr>

				
					<td width="300"><b>Supplier:</b>
						<?
						$pay_mode=$nameArray_per_job[0][csf("pay_mode")];//pay_mode
						if($pay_mode!=3 && $pay_mode!=5)
						{
							echo $supplier_name_arr[$nameArray_per_job[0][csf("supplier_id")]];
						}
						else
						{
							echo $company_library[$nameArray_per_job[0][csf("supplier_id")]];
						}?>
					</td>
					<td width="400" align="left"><b>Address:   </b> <? if($pay_mode!=3 && $pay_mode!=5)
						{
							echo $supplier_address_arr[$nameArray_per_job[0][csf("supplier_id")]];
						}
						else
						{
							echo $comp_address_lib[$nameArray_per_job[0][csf("supplier_id")]];
						}?></td>
					<td align="left"><b>Booking Date : </b>&nbsp;<? echo change_date_format($nameArray_per_job[0][csf("booking_date")]);?></td>

				</tr>
				<tr>
					<td width="300"><b>Attention: </b>   <? echo $nameArray_per_job[0][csf("attention")];?></td>
					<td width="300"><b>Booking NO: </b>   <? echo str_replace("'","",$txt_booking_no);?></td>
					<td width="400"><b>Fabric Delivery Start Date: </b><?php echo change_date_format($nameArray_per_job[0][csf("fabric_start_date")]); ?></td>
				</tr>
				<tr>
					<td width="300"><b>Buyer Name :</b><? echo $buyer_name_arr[$nameArray_per_job[0][csf("buyer_id")]]; ?></td>
					<td width="400" align="left" colspan="2"><b>Style: </b> <? echo $style; ?></td>
					
				</tr>

				<tr>
					<td width="300"><b>Item Details: &nbsp;<? echo implode(",",$gmts_item_arr); ?></b></td>
					<td><b>Job No : </b> &nbsp;<? echo $all_job_id; ?></td>
					<td width="400"><b>Fabric Delivery End Date: </b><?php echo change_date_format($nameArray_per_job[0][csf("delivery_date")]); ?></td>
				</tr>
				
				<tr>
					<td width="400" align="left"><b>Department:   </b> <? if($product_code!="") echo $depts."-".$product_code; else echo $depts; ?></td>
					<td width="300"><b>Season: </b>   <? echo $seasons;;?></td>
					<td width="400" align="left"><b>Order Qnty :   </b> <? echo $po_qnty_all_style[0][csf("qnty")]; ?>&nbsp;<? echo $unites;?></td>
				</tr>
		
				<tr>
				   <td width="400" align="left" colspan="3"><b>Remarks:   </b> <? echo $nameArray_per_job[0][csf("remarks")]; ?></td>
				</tr>
			</thead>
		</table>


			<?php

			$po_data = array();

			$nameArray_job = sql_select("select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,(pub_shipment_date-po_received_date) date_diff,MIN(po_received_date) as po_received_date,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status   from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id) group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
			foreach ($nameArray_job as $result_job) {
				$po_data['po_id'][$result_job[csf('id')]] = $result_job[csf('id')];
				$po_data['po_number'][$result_job[csf('id')]] = $result_job[csf('po_number')];
				$po_data['leadtime'][$result_job[csf('id')]] = $result_job[csf('date_diff')];
				$po_data['po_quantity'][$result_job[csf('id')]] = $result_job[csf('po_quantity')];
				$po_data['po_received_date'][$result_job[csf('id')]] = change_date_format($result_job[csf('po_received_date')], 'dd-mm-yyyy', '-');
				$ddd = strtotime($result_job[csf('pub_shipment_date')]);
				$po_data['pub_shipment_date'][$ddd] = $ddd;

				$po_data['insert_date'][$result_job[csf('id')]] = $result_job[csf('insert_date')];

				if ($result_job[csf('shiping_status')] == 1) {
					$shiping_status = "FP";
				} else if ($result_job[csf('shiping_status')] == 2) {
					$shiping_status = "PS";
				} else if ($result_job[csf('shiping_status')] == 3) {
					$shiping_status = "FS";
				}
				$po_data['shiping_status'][$result_job[csf('id')]] = $shiping_status;
				$po_data['file_no'][$result_job[csf('id')]] = $result_job[csf('file_no')];

				$po_data['grouping'][$result_job[csf('id')]] = $result_job[csf('grouping')];
			}
	$txt_order_no_id = implode(",", array_unique($po_data['po_id']));
	$leadtime = implode(",", array_unique($po_data['leadtime']));
	$po_quantity = array_sum($po_data['po_quantity']);
	$po_received_date = implode(",", array_unique($po_data['po_received_date']));
	$po_number = implode(",", array_unique($po_data['po_number']));
	$shipment_date = date('d-m-Y', min($po_data['pub_shipment_date']));
	$maxshipment_date = date('d-m-Y', max($po_data['pub_shipment_date']));
	//$shipment_date=implode(",",array_unique($po_data['pub_shipment_date']));
	$shiping_status = implode(",", array_unique($po_data['shiping_status']));
	$file_no = implode(",", array_unique($po_data['file_no']));
	$grouping = implode(",", array_unique($po_data['grouping']));

	$colar_excess_percent = 0;
	$cuff_excess_percent = 0;
	$rmg_process_breakdown = 0;
	$nameArray = sql_select("select a.buyer_id,a.inserted_by,a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.update_date,a.uom,a.remarks,a.pay_mode,a.fabric_composition from wo_booking_mst a  where   a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0");

	
	foreach ($nameArray as $result) {
	$total_set_qnty = $result[csf('total_set_qnty')];
	$colar_excess_percent = $result[csf('colar_excess_percent')];
	$cuff_excess_percent = $result[csf('cuff_excess_percent')];
	$rmg_process_breakdown = $result[csf('rmg_process_breakdown')];
	foreach ($po_data['po_id'] as $po_id => $po_val) {
		$daysInHand .= (datediff('d', date('d-m-Y', time()), $po_data['pub_shipment_date'][$po_id]) - 1) . ",";
		$booking_date = $result[csf('update_date')];
		if ($booking_date == "" || $booking_date == "0000-00-00 00:00:00") {
			$booking_date = $result[csf('insert_date')];
		}
		$WOPreparedAfter .= (datediff('d', $po_data['insert_date'][$po_id], $booking_date) - 1) . ",";
	}

	}
	$inserted_by=$nameArray[0][csf('inserted_by')];


	?>
			<br/>
			<!--  Here will be the main portion  -->
			<?
			$costing_per="";
			$costing_per_qnty=0;
			$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no in($job_no_in)");
			if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;

			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";
				$costing_per_qnty=1;

			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;

			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;

			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;
			}
			$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no in($job_no_in)");
			$uom_arr=array(1=>"Pcs",12=>"Kg",23=>"Mtr",27=>"Yds");
			$p=1;
		 $color_wise_process_loss=sql_select("SELECT a.id,a.job_no, a.body_part_id, b.color_number_id,b.dia_width, a.process_loss_method, b.process_loss_percent as loss, avg(b.cons_pcs) as consdzn FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and  a.job_no in(".$job_no_in.") and b.process_loss_percent>0 group by a.id,a.job_no, a.body_part_id, a.process_loss_method,b.dia_width, b.color_number_id, b.process_loss_percent");
	    foreach($color_wise_process_loss as $val)
	    {
	    	$loss_arr[$val[csf("id")]][$val[csf("dia_width")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['loss']=$val[csf("loss")];
	    	$loss_arr[$val[csf("id")]][$val[csf("dia_width")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['loss_method']=$val[csf("process_loss_method")];
			$loss_arr[$val[csf("id")]][$val[csf("dia_width")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['consdzn']=$val[csf("consdzn")];
			$gmt_color_arr[$val[csf("id")]][$val[csf("dia_width")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['color_id']=$val[csf("color_number_id")];
	    }
		
		if($cbo_fabric_source==1 || $cbo_fabric_source==2 || $cbo_fabric_source==3)
		{
			$nameArray_qty_arr = sql_select("select b.job_no_mst,b.id,a.style_ref_no,c.item_number_id,c.color_number_id,c.plan_cut_qnty,c.order_quantity   from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where  a.job_no=b.job_no_mst and c.po_break_down_id=b.id and a.job_no=c.job_no_mst and a.status_active =1 and b.status_active =1 and c.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id) and b.id in($txt_order_no_id)  ");
		//echo "select b.job_no_mst,b.id,a.style_ref_no,c.item_number_id,c.color_number_id,c.order_quantity   from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where  a.job_no=b.job_no_mst and c.po_break_down_id=b.id and a.status_active =1 and c.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id) and b.id in($txt_order_no_id)  ";
			foreach($nameArray_qty_arr as $row)
			{
				$gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][40]+=$row[csf('order_quantity')];
				$gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][50]+=$row[csf('order_quantity')];
				$fab_gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]]+=$row[csf('order_quantity')];
				$plan_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]]+=$row[csf('order_quantity')];
				$gmts_color_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]]['color'].=$row[csf('color_number_id')].',';
			}

			
			$nameArray_fabric_description= sql_select("SELECT a.id as fabric_cost_dtls_id,a.inserted_by,a.seq, a.item_number_id, a.body_part_id,a.body_part_type,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , b.dia_width,	d.pre_cost_remarks,a.uom ,d.fabric_color_id,a.color_size_sensitive,	a.color_break_down,c.job_no_mst,d.remark,avg(b.requirment) as consumption,avg(b.cons) as consumption,avg(b.process_loss_percent) as process_loss_percent,avg(b.cons) as finish_cons,sum(c.plan_cut_qnty) as plan_cut_qnty,sum(c.order_quantity) as order_quantity,avg(c.excess_cut_perc) as ex_cut_per,b.color_number_id,d.gmts_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_number_id=d.gmts_color_id and b.dia_width=d.dia_width and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and a.job_no=d.job_no and a.id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.job_no in ($all_jobs_id)  and d.status_active=1 and c.status_active=1 and d.is_deleted=0 and b.cons>0 group by a.id ,a.inserted_by, a.item_number_id,a.seq, a.body_part_id,a.body_part_type,a.color_type_id, a.construction,a.composition, a.gsm_weight,a.width_dia_type , b.dia_width,d.pre_cost_remarks,a.uom ,d.fabric_color_id,a.color_size_sensitive,a.color_break_down,c.job_no_mst,d.remark,b.color_number_id,d.gmts_color_id order by b.color_number_id,a.item_number_id,a.seq,a.id");

			



			$uom_data_arr=array();$b_part_array_not=array(40,50);
			foreach($nameArray_fabric_description as $row)
			{
				if(!in_array($row[csf('body_part_type')],$b_part_array_not))
				{
					$uom_data_arr[$row[csf('uom')]]=$row[csf('uom')];
				}
				if($row[csf('body_part_type')]==40 || $row[csf('body_part_type')]==50)
				{
					//$gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('fabric_color_id')]][$row[csf('body_part_type')]]+=$row[csf('order_quantity_pcs')];
					$gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('gmts_color_id')]][$row[csf('body_part_type')]]=$row[csf('order_quantity_pcs')];
				}
			}
			
			foreach($uom_data_arr as $uom_id=>$uom_val)
			{
				if(count($nameArray_fabric_description)>0)
				{

					?>

						<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
									<caption> <strong>Fabric Booking Summary </strong> </caption>
									<tr>
										<th  width="30" align="center">SL</th>
										<th  width="150" align="center">Style</th>
										<th  width="140" align="center">Gmts Item</th>
										<th  width="130" align="center">Body Parts</th>
										<th  width="100" align="center">Gmts Order Qty (Pcs)</th>
										<th  width="100" align="center">Extra Cutting %</th>
										<th  width="100" align="center">Fabric Construction</th>
										<th  width="400" align="center">Yarn Composition</th>
										<th  width="100" align="center">Fabric Composition</th>
										<th  width="150" align="center">Add. Process</th>
										<th  width="40" align="center">GSM</th>
										<th  width="90" align="center">Fin Width/ Dia Type</th>
										<th  width="100" align="center">Color Type</th>
										<th  width="100" align="center">Combo</th>
										<th  width="110" align="center">Fabric Color</th>
										<th  width="80" align="center">Finish Cons. Kg/Dzn</th>
							
										<th  width="60" align="center">UOM</th>
										<!-- <th width='120' align="center"></th> -->
										<th width='120' align="center" title="Based on avg grey consumption">Finished Fab. Qty</th>
										<th width='100' align="center">Avg. P/L %</th>
										<th width='100' align="center">Grey Fabric Qty</th>
										<th width='100' align="center">Avg Rate/<? echo $unit_of_measurement[$uom_id];?></th>
										<th width='60' align="center">Amount</th>
								
										<th  align="center">Remarks</th>

									</tr>
									<? //wo_pre_cos_fab_co_color_dtls
									$dtm_arr=array();
									$sql=sql_select("select pre_cost_fabric_cost_id,fabric_color,sum(qty) as qty  from wo_dye_to_match where booking_no=$txt_booking_no and status_active=1 and is_deleted=0 group by pre_cost_fabric_cost_id,fabric_color");
									foreach($sql as $row){
										$dtm_arr[$row[csf('pre_cost_fabric_cost_id')]][$row[csf('fabric_color')]]=$row[csf('qty')];
									}
									
									$total_fin_fab_qnty=$total_gmt_qty_pcs=0;  $total_amount=0;  $total_grey_fab_qnty=0 ;$tot_avg=0;
									foreach($nameArray_fabric_description as $val)
									{
										if($val[csf('pre_cost_remarks')]!='') $remark_cond=" and d.pre_cost_remarks='".$val[csf('pre_cost_remarks')]."' "; else $remark_cond=" and d.pre_cost_remarks is null";


										$color_wise_wo_sql_qnty=sql_select("SELECT  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount,max(a.lib_yarn_count_deter_id) as determin_id
										FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
										WHERE
											a.job_no=d.job_no and
											a.id=d.pre_cost_fabric_cost_dtls_id and
											d.booking_no =$txt_booking_no and
											d.job_no = '".$val[csf('job_no_mst')]."' and
											a.item_number_id='".$val[csf('item_number_id')]."' and
											a.body_part_id='".$val[csf('body_part_id')]."' and
											a.color_type_id='".$val[csf('color_type_id')]."' and
											a.construction='".$val[csf('construction')]."' and
											a.composition='".$val[csf('composition')]."' and
											a.gsm_weight='".$val[csf('gsm_weight')]."' and
											d.dia_width='".$val[csf('dia_width')]."' and
											a.id='".$val[csf('fabric_cost_dtls_id')]."' and
											a.uom='".$uom_id."' and
											d.fabric_color_id='".$val[csf('fabric_color_id')]."' and
											d.gmts_color_id='".$val[csf('gmts_color_id')]."' and
											d.status_active=1 and
											d.is_deleted=0 $remark_cond");
											
										if($uom_id==$val[csf('uom')])
										{
											if($val[csf('pre_cost_remarks')]=='no remarks')  $pre_cost_remarks="";else  $pre_cost_remarks=$val[csf('pre_cost_remarks')];

											//$order_quantity_pcs=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$val[csf('fabric_color_id')]];
											//$order_quantity_pcs=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$val[csf('gmts_color_id')]];
											$order_quantity_pcs=0;
											if($val[csf('color_size_sensitive')]==1 or $val[csf('color_size_sensitive')]==2 or $val[csf('color_size_sensitive')]==4)
											{
												$gmt_colorName=$color_library[$val[csf('fabric_color_id')]];
												$gmt_colorId=$val[csf('fabric_color_id')];
												//echo $gmt_colorId.'d';
												$order_quantity_pcs+=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$val[csf('fabric_color_id')]];
												$plan_quantity_pcs+=$plan_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$val[csf('fabric_color_id')]];
											}
											else
											{
												$color_break_down=$val[csf('color_break_down')];
												if($color_break_down)
												{
													$gmts_color="";$gmt_colorId="";
													if (strpos($color_break_down, '__') !== false)
													{
														$color_break_down=explode('__', $color_break_down);
														foreach ($color_break_down as $key => $value)
														{
															$cols=explode('_', $value);
															if(trim(strtolower($color_library[$val[csf('fabric_color_id')]]))==trim(strtolower($cols[2])))
															{
																if($gmts_color=="")
																{
																	$gmts_color=$cols[1];
																$order_quantity_pcs=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];
																$plan_quantity_pcs=$plan_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];
																$gmt_colorId=$cols[0];

																}
																else
																{
																	$gmts_color .=','.$cols[1];
																$order_quantity_pcs+=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];
																$plan_quantity_pcs+=$plan_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];
																$gmt_colorId=$cols[0];

																}
																

															}
															
														}
													}
													else
													{
														$cols=explode('_', $color_break_down);
														if(trim(strtolower($color_library[$val[csf('fabric_color_id')]]))==trim(strtolower($cols[2])))
														{
															if($gmts_color=="")
															{
																$gmts_color=$cols[1];
																$order_quantity_pcs=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];
																$plan_quantity_pcs=$plan_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];
																$gmt_colorId=$cols[0];

															}
															else
															{
																$gmts_color .=','.$cols[1];
																$order_quantity_pcs+=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];
																$plan_quantity_pcs+=$plan_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];
																$gmt_colorId=$cols[0];

															}
															

														}
														
													}

													$gmt_colorName=$gmts_color;
													
												}
												
											}
											
											$gmt_color_Id=$gmt_colorId;
											$order_quantity_pcs=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$val[csf("color_number_id")]];
											
						
											
											$process_loss=$loss_arr[$val[csf("fabric_cost_dtls_id")]][$val[csf("dia_width")]][$val[csf("job_no_mst")]][$val[csf("body_part_id")]][$gmt_color_Id]['loss'];
											$p_loss_method=$loss_arr[$val[csf("fabric_cost_dtls_id")]][$val[csf("dia_width")]][$val[csf("job_no_mst")]][$val[csf("body_part_id")]][$gmt_color_Id]['loss_method'];
											
											if($process_loss=='') $process_loss=0;else $process_loss=$process_loss;
											if($p_loss_method=='') $p_loss_method=0;else $p_loss_method=$p_loss_method;

											?>
											<tr>
												<td align="center"> <? echo $p; $p++;?></td>

												
												<td align="center"> <? echo $all_job_arr[$val[csf("job_no_mst")]]["style"];?></td>
												<td align="center"> <? echo $garments_item[$val[csf("item_number_id")]];?></td>
												<td align="center"><? echo $body_part[$val[csf('body_part_id')]];?></td>
												
												<td align="center"><? //echo number_format($order_quantity_pcs,2);?><? echo number_format($val[csf('order_quantity')],2);?></td>
													<td align="center"><? echo number_format($val[csf('ex_cut_per')],2);?></td>
												
												<td align="left"> <? echo $val[csf('construction')]; ?> </td>
												<td align="left"> <? echo $val[csf('composition')]; ?> </td>
												<td align="center"> 
												<?
												foreach($color_wise_wo_sql_qnty  as $frow)
												{
													 echo $fabric_composition_arr[$lip_yarn_count[$frow[csf('determin_id')]]];
												}
												?>
												</td>
												<td  align="center"><?	echo $pre_cost_remarks;	?>	</td>
												<td  align="center">
													<?
													echo $val[csf('gsm_weight')];
													?>
												</td>

												<td  align="center">
													<?
													echo $val[csf('dia_width')].'/'.$fabric_typee[$val[csf('width_dia_type')]];
													?>
												</td>

												<td  align="center">
													<?
													echo $color_type[$val[csf('color_type_id')]];
													?>
												</td>
												<td  align="center" title="<?=$gmt_color_Id;?>">
													<?
													echo $color_library[$val[csf('color_number_id')]];
													?>
												</td>


												<td  align="center">
													<?
													echo $color_library[$val[csf('fabric_color_id')]];
													?>
												</td>


												
												<td align="center"> <? echo def_number_format($val[csf('consumption')],5); ?></td>
												
												<td align="center"> <? echo $unit_of_measurement[$val[csf('uom')]]; ?></td>

												<?
													$fin_fab_qnty=$color_wise_wo_sql_qnty[0][csf("fin_fab_qnty")];
																																		
													$grey_fab_qnty=$color_wise_wo_sql_qnty[0][csf("grey_fab_qnty")];
													$rate=$color_wise_wo_sql_qnty[0][csf("rate")];
													$amount=$color_wise_wo_sql_qnty[0][csf("amount")];
													$process_loss_percent=$val[csf("process_loss_percent")];
													$avgRate=$amount/$fin_fab_qnty;										

													?> </td> 
													<td align="center" title="Process Loss Method=<?=$p_loss_method.'='.$process_loss.'*'.$color_wise_wo_sql_qnty[0][csf("grey_fab_qnty")];?>"> <? echo def_number_format($fin_fab_qnty,2); ?> </td>
													<td align="center"> <? echo def_number_format($process_loss_percent,2); ?> </td>
													<td align="center"> <? echo def_number_format($grey_fab_qnty,2); ?> </td>
													<td align="center"> <? echo def_number_format($avgRate,2); ?> </td>
													<td align="center"> <? echo def_number_format($amount,2); ?> </td>


													<?

													$total_fin_fab_qnty +=str_replace(",", "", def_number_format($greys,2));
													$total_amount +=str_replace(",", "",def_number_format($amount,2));

													$total_grey_fab_qnty +=str_replace(",", "",def_number_format($fin_fab_qnty,2));
													$total_greyfabqnty +=str_replace(",", "",def_number_format($grey_fab_qnty,2));
													$total_rate +=str_replace(",", "",def_number_format($rate,2));
													$tot_avg=$total_amount/$total_grey_fab_qnty;
													$total_gmt_qty_pcs +=$order_quantity_pcs;


													?>
												
												<td align="center"> <? echo $val[csf('remark')]; ?> </td>


												</tr>
												<?
										}

									}
										?>
									<tr style=" font-weight:bold">

									<td  align="right" colspan="6"><strong>Total</strong></td>
									 <td align="right"><? //echo def_number_format($total_gmt_qty_pcs,2);?></td>
									<td  align="right" colspan="10">&nbsp;</td>

									<td align="center"><? echo def_number_format($total_grey_fab_qnty,2);?></td>
									<td  align="right" >&nbsp;</td>
									<td align="center"><? echo def_number_format($total_greyfabqnty,2);?></td>
									<td align="center"><? echo def_number_format($tot_avg,2);?></td>
									<td align="center"><? echo def_number_format($total_amount,2);?></td>
									<td  align="right" >&nbsp;</td>

									</tr>

						</table>

					<?
				}
			}
		}


		$sql_data=sql_select("SELECT a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,a.uom,b.dia_width,b.pre_cost_remarks,b.fabric_color_id,b.remark, sum(b.grey_fab_qnty) as grey_fab_qnty,sum(b.adjust_qty)as adjust_qty FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in($all_jobs_id) and b.adjust_qty>0 and b.status_active=1 and b.is_deleted=0 group by a.id,a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,a.uom,b.dia_width,b.pre_cost_remarks,b.fabric_color_id,b.remark and a.body_part_type not in(40,50) order by a.id,a.body_part_id");
		if(count($sql_data)>0)
		{

					?>
					<br/>
			<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

					<tr>
						<td colspan="7" align="center">
							<strong>Fabric Stock Adjustment Details</strong>
						</td>

					</tr>

					<tr>
						<td align="center"> SL </td>
						<td align="center"> Item Description </td>
						<td align="center"> Fabric Color </td>
						<td align="center">UOM</td>
						<td align="center">Adjusted Qty </td>


					</tr>
					<?
					$p=1;
					foreach($sql_data as $row)
					{
						?>
						<tr>
							<td align="center"><? echo $p;?></td>
							<td align="center">
								<? echo $body_part[$row[csf('body_part_id')]].",".$row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$row[csf('dia_width')].','.$fabric_typee[$row[csf('width_dia_type')]].",".$color_type[$row[csf('color_type_id')]] ?>
							</td>

							<td align="center">
								<? echo $color_library[$row[csf('fabric_color_id')]];  ?>
							</td>
							<td align="center">
								<? echo $unit_of_measurement[$row[csf('uom')]];  ?>
							</td>


							<td align="center">
								<? echo number_format($row[csf('adjust_qty')],4) ; ?>
							</td>

						</tr>
						<?
						$p++;
					}
		}
					?>
			</table>
			<br>
				<div style="width:1330px" align="center" >
			  		<table  width="100%"  border="0" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

			  			<tr>
			  				<td colspan="10" align="center">
			  					<strong>Collar and Cuff & Other Flat Knit Fabric Breakdown</strong>
			  				</td>

			  			</tr>
			  		</table>

	        <?
	     	  $sql_collar_cuff= "SELECT a.rate, a.amount, a.job_no , a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.width_dia_type, b.gmts_color_id, b.size_number_id, b.item_size, b.gmts_qty, b.excess_per, b.qty, b.po_break_down_id as po_id, b.id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id) and a.body_part_type=40 and b.status_active=1 and b.is_deleted=0  order by a.body_part_id,b.gmts_color_id,b.id " ;
	     	  //echo $sql_collar_cuff; die;
	         $sql_data_collar_cuff=sql_select($sql_collar_cuff);
	         $size_id_array=array();
	         $size_with_item_size_array=array();
	         foreach($sql_data_collar_cuff as $vals)
	         {
	         	$body_part_cuff_array[$vals[csf("body_part_id")]]=$vals[csf("body_part_id")];
				$size_id_array[$vals[csf("size_number_id")]]=$vals[csf("size_number_id")];
				$item_id_array[$vals[csf("item_size")]]=$vals[csf("item_size")];
				$item_size_array[$vals[csf("size_number_id")]][$vals[csf("item_size")]]=$vals[csf("item_size")];
	         	$size_with_item_size_array[$vals[csf("size_number_id")]][$vals[csf("body_part_id")]].=$vals[csf("item_size")].',';
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["grey"]+=$vals[csf("qty")];
				if($vals[csf("excess_per")]>0)
				{
					$color_wise_excess_per_arr[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]+=$vals[csf("excess_per")];
					$color_wise_excess_per_arr[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_excess_per"]+=1;
				}
	         	$color_wise_qnty[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$color_wise_qnty[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["grey"]+=$vals[csf("qty")];
				$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_rate"]=1;

	         }
			/*  echo '<pre>';
				print_r($item_id_array); */
			unset($sql_data_collar_cuff);
	         $sql_collar_cuff3 = sql_select("SELECT c.rate, a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id, c.gmts_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls c WHERE a.job_no=c.job_no and a.id=c.pre_cost_fabric_cost_dtls_id and  a.id=c.pre_cost_fabric_cost_dtls_id and c.booking_no =$txt_booking_no and c.job_no in ($all_jobs_id) and a.body_part_type=40 and c.status_active=1 and c.is_deleted=0  order by a.body_part_id");

	         foreach($sql_collar_cuff3 as $vals)
	         {

	         	$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];

	         }


	         $counts=count($item_id_array);
		/* 	 echo $counts;die; */

	         $size_wise_qnty_array=array();
	         ?>


			 <?
	          if(count($body_part_cuff_array)>0)
	          {		$grand_size_wise_qnty_array=array();
			  		$gr_collor_qty=0;
					 $gr_col_avg_price=0;
					 $gr_col_avg_row=0;
					 $gr_amount=0;
					 $gr_excess=0;
					foreach($body_part_cuff_array as $bpart_id=>$val)
					{
					// $sql_collar_cuff2= "SELECT a.rate,a.amount, a.job_no , a.id as fabric_cost_dtls_id,a.color_size_sensitive,a.color_break_down, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,b.gmts_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and a.body_part_id=$bpart_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id) and a.body_part_type=40  and b.status_active=1 and b.is_deleted=0  group by  a.rate,a.amount, a.job_no , a.id ,a.color_size_sensitive,a.color_break_down, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition,a.gsm_weight,a.width_dia_type,b.gmts_color_id  order by a.body_part_id,b.gmts_color_id  " ;

					$sql_collar_cuff2= " SELECT a.rate,
									         a.amount,
									         a.job_no,
									         a.id as fabric_cost_dtls_id,
									         a.color_size_sensitive,
									         a.item_number_id,
									         a.body_part_id,
									         a.color_type_id,
									         a.construction,
									         a.composition,
									         a.gsm_weight,
									         a.width_dia_type,
									         b.gmts_color_id,b.item_size
									    from wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b,wo_booking_dtls c ,wo_pre_cos_fab_co_avg_con_dtls d
									    where     a.job_no = b.job_no
									         and a.id = b.pre_cost_fabric_cost_dtls_id
									         and b.booking_no=c.booking_no
									         and b.po_break_down_id=c.po_break_down_id
									         and b.pre_cost_fabric_cost_dtls_id=c.pre_cost_fabric_cost_dtls_id
									         and b.gmts_color_id=c.gmts_color_id
									        and  a.id=d.pre_cost_fabric_cost_dtls_id
									        and d.gmts_sizes=b.size_number_id
									        and c.status_active = 1
									        and c.is_deleted = 0
								         and a.body_part_id=$bpart_id 
								         and b.booking_no =$txt_booking_no 
								         and b.job_no in ($all_jobs_id) 
								         and a.body_part_type=40  
								         and b.status_active=1 
								         and b.is_deleted=0 
								    group by  a.rate,a.amount, a.job_no , a.id ,a.color_size_sensitive,a.color_break_down, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition,a.gsm_weight,a.width_dia_type,b.gmts_color_id,b.item_size  order by a.body_part_id,b.gmts_color_id  " ;
	          $sql_data_collar_cuff2=sql_select($sql_collar_cuff2);
					?>
					 <table align="left"  width="100%" style="margin-top: 5px;" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" >
			  			<tr>
			  				<td colspan="<? echo $counts+13;?>" align="center">
			  					<strong>Collar Details(<? echo $body_part[$bpart_id];?>)</strong>
			  				</td>

			  			</tr>
			  			<tr>
			  				<td  width="30"  rowspan="2" align="center"><strong>SL</strong> </td>
			  				<td  width="150" rowspan="2" align="center"><strong>Style</strong></td>
 			  				<td  width="140"  rowspan="2" align="center"><strong>Gmts Item</strong></td>
 			  				<td  width="100"  rowspan="2" align="center"><strong>Body Part</strong></td>
							<td  width="100" rowspan="2" align="center"><strong>Actual Qty(Pcs)</strong></td>
			  				<td  width="390" rowspan="2" align="left">&nbsp;&nbsp;<strong>Collar Composition</strong></td>
			  				<td  width="100"  rowspan="2" align="center"><strong>Color Type</strong></td>
 			  				<td  width="100"  rowspan="2"  align="center"><strong>Combo</strong></td>
							<td  width="100"  rowspan="2"  align="center"><strong>Fabric Color</strong></td>
 			  				<?
 			  				foreach($size_id_array as $id=>$val)
 			  				{
 			  					?>
 			  					<td colspan="<? echo $counts;?>" width="40" align="center"><strong><? echo $size_library[$id];?></strong></td>

 			  					<?
 			  				}
 			  				?>
			  				<td width="60"  rowspan="2" align="center"><strong> Req Qty (Pcs)</strong> </td>
			  				<td  width="50" rowspan="2"  align="center"><strong> Excess %  </strong> </td>
			  				<td width="50" rowspan="2"  align="center"><strong>Price/Pcs</strong></td>
			  				<td  width="40" rowspan="2" align="center"><strong>Amount</strong></td>


			  			</tr>
			  			<tr>
			  				<?
							foreach($size_id_array as $id=>$val)
							{
			  				foreach($item_id_array as $itemsize=>$itemval)
			  				{
								
			  					/* $size_with_item=rtrim($size_with_item_size_array[$id][$bpart_id],',');
								$size_with_item=implode(",",array_unique(explode(",",$size_with_item))); */
								?>
			  					<td  align="center"><? echo $itemsize;?></td>

			  					<?
							}
			  				}
			  				?>

			  			</tr>
			  			<?
			  			$p=1;
			  			foreach($sql_data_collar_cuff2 as $row)
			  			{

							?>
			  				<tr>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="30" align="center"><? echo $p;?></td>
			  					<td style="word-break: break-all;word-wrap: break-word;" width="150" align="center"><? echo $job_wise_style[$row[csf("job_no")]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="140" align="center"><?  $item_id= $row[csf('item_number_id')];echo $garments_item[$item_id]; ?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center"><? echo $body_part[$row[csf("body_part_id")]];?></td>
								<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center"><? $gmt_actual_qty=$gmts_qty_data_arr[$row[csf('job_no')]][$item_id][$row[csf('gmts_color_id')]][40];echo number_format($gmt_actual_qty,0);$total_gmt_actual_qty+=$gmt_actual_qty;?></td>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="390" align="left"> &nbsp;
			  						<? echo $row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$fabric_typee[$row[csf('width_dia_type')]] ;?>
			  					</td>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="100" align="center"><? echo $color_type[$row[csf('color_type_id')]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center">
			  						<? echo $color_library[$row[csf('gmts_color_id')]];  ?>
			  					</td>
								<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center">
			  						<?
										if($row[csf('color_size_sensitive')]==1 or $row[csf('color_size_sensitive')]==2 or $row[csf('color_size_sensitive')]==4)
										{
											$gmt_fab_color=$color_library[$row[csf('gmts_color_id')]];
										}
										else
										{
											$contrast_color_id=return_field_value("b.contrast_color_id as contrast_color_id", "wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b", "a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.job_no in ($all_jobs_id) and a.id=".$row[csf('fabric_cost_dtls_id')]."  and b.gmts_color_id=".$row[csf('gmts_color_id')]." ","contrast_color_id");//pre_cost_fabric_cost_dtls_id
											if($contrast_color_id>0)
											{
												$gmt_fab_color=$color_library[$contrast_color_id];
											}
										}
									echo $gmt_fab_color;  ?>
			  					</td>


			  					<?
								$color_qty=0; $greyQty=0;
			  					foreach($size_id_array as $id=>$val)
			  					{
									foreach($item_id_array as $itemid=>$value)
			  					{
			  						?>
			  						<td  style="word-break: break-all;word-wrap: break-word;" width="40"  align="center"><? echo $cuff_grey_qty=$size_item_wise_qnty[$row[csf("body_part_id")]][$row[csf("fabric_cost_dtls_id")]][$row[csf("gmts_color_id")]][$id][$size_with_item_size_array[$id][$bpart_id]]["grey"];//.'K '.$row[csf("fabric_cost_dtls_id")].'='.$row[csf("gmts_color_id")].'='.$id.'='.$size_with_item_size_array[$id];
									?></td>

			  						<?
			  						$size_wise_qnty_array[$id]+=$val;
									$grand_size_wise_qnty_array[$id]+=$cuff_grey_qty;$sub_size_wise_qnty_array[$bpart_id][$id]+=$cuff_grey_qty;
									$color_qty+=$cuff_grey_qty;
								}

			  					}
								$row_excess_per= $color_wise_excess_per_arr[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf("gmts_color_id")]][$item_id]["row_excess_per"];
			  					?>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="60" align="center">
			  						<? echo $grey_qnty=$color_qty;//$color_wise_qnty[$row[csf('gmts_color_id')]][$item_id]["grey"];  ?>
			  					</td>

			  					<td  style="word-break: break-all;word-wrap: break-word;" title="<? echo $row_excess_per;?>" width="50" align="center">
			  						<?  $excess= $color_wise_excess_per_arr[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf("gmts_color_id")]][$item_id]["excess_per"]/$row_excess_per;
									echo number_format($excess,2);
									  ?>
			  					</td>


			  					<td style="word-break: break-all;word-wrap: break-word;" title="<? echo $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["row_rate"];?>"  width="50" align="center">
			  						<? echo  $cuff_price=$color_wise_qnty2[$row[csf("fabric_cost_dtls_id")]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["rate"];
										//$tot_row_rate=$color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["row_rate"];  ?>
			  					</td>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="40" align="center">
			  						<? echo $amount=$grey_qnty*$cuff_price;   ?>
			  					</td>
			  				</tr>
			  				<?

							$sub_collor_qty_arr[$row[csf("body_part_id")]]+=$grey_qnty;
							$sub_collor_amount_arr[$row[csf("body_part_id")]]+=$amount;

							$sub_excess_arr[$row[csf("body_part_id")]]+=$excess;
							$sub_price_arr[$row[csf("body_part_id")]]+=$cuff_price;
							$cuff_body_wise_avg_row[$row[csf("body_part_id")]]+=1;

							$gr_fin_qty+=$fin_qty;
			  				$gr_collor_qty+=$grey_qnty;
							$gr_amount+=$amount;
			  				$gr_excess+=$excess ;
			  				$gr_col_avg_price+=$cuff_price;
			  				$gr_col_avg_row++;



			  				$p++;
			  			}
			  			?>
						<tr class="tbl_bottom">
							<td colspan="9" align="right">Total </td>
							<?
							foreach($size_id_array as $id=>$val)
							{
								foreach($item_id_array as $itemid=>$value)
							{
								?>
								<td  align="center"><? echo $sub_size_wise_qnty_array[$bpart_id][$id];?></td>

								<?
							}
							}
							$cuff_sub_excess=$sub_excess_arr[$bpart_id];
							$cuff_sub_price=$sub_price_arr[$bpart_id];
							$cuff_body_wise_avg_tot_row=$cuff_body_wise_avg_row[$bpart_id];
							?>
							<td align="center">
								<? echo $sub_collor_qty_arr[$bpart_id];  ?>
							</td>
							<td align="center" title="Sub Exess & sub Row=<? echo $cuff_sub_excess.'='.$cuff_body_wise_avg_tot_row ?>">
									<? echo number_format($cuff_sub_excess/$cuff_body_wise_avg_tot_row,2); ?></td>
							<td align="center"><? echo number_format($cuff_sub_price/$cuff_body_wise_avg_tot_row,2); ?></td>

							<td align="center">
								<? echo $sub_collor_amount_arr[$bpart_id];   ?>
							</td>
			  			</tr>
						<!--Sub TOT End-->


			  			<?
						} //Body Part End
						?>

						<tr>
			  				<td colspan="9" align="right">Grand Total </td>
			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td  align="center"><? echo $grand_size_wise_qnty_array[$id];?></td>

			  					<?
			  				}
			  				?>
			  				<td align="center">
			  					<? echo $gr_collor_qty;  ?>
			  				</td>
			  				<td align="center" title="Sub Exess & Tot Row=<? echo $gr_excess.'='.$gr_avg_row ?>"><? echo number_format($gr_excess/$gr_col_avg_row,2); ?></td>
							<td align="center"  title="Tot Price  & Tot Row=<? echo $gr_col_avg_price.'='.$gr_col_avg_row.'**'.$p?>"><? //echo number_format($gr_col_avg_price/$gr_col_avg_row,2); ?></td>

			  				<td align="center">
			  					<? echo $gr_amount;   ?>
			  				</td>
			  			</tr>

						</table>
						<?
			  		}
			  	?>


					<br/><br/>

						<?
	     	  $sql_collar_cuff= "SELECT a.rate,a.amount, a.job_no , a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,b.gmts_color_id,b.size_number_id,b.item_size,b.gmts_qty,b.excess_per,b.qty,b.po_break_down_id as po_id,b.id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id) and a.body_part_type=50 and b.status_active=1 and b.is_deleted=0  order by a.body_part_id,b.gmts_color_id,b.id " ;die;
	         $sql_data_collar_cuff=sql_select($sql_collar_cuff);
	         $size_id_array=array();
	         $size_with_item_size_array=array();
	         $size_item_wise_qnty=array();
	         $color_wise_qnty=array();
	         foreach($sql_data_collar_cuff as $vals)
	         {
	         	$body_part_array[$vals[csf("body_part_id")]]=$vals[csf("body_part_id")];
				$size_id_array[$vals[csf("size_number_id")]]=$vals[csf("size_number_id")];
	         	$size_with_item_size_array[$vals[csf("size_number_id")]][$vals[csf("body_part_id")]]=$vals[csf("item_size")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["grey"]+=$vals[csf("qty")];

	         	//$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]=$vals[csf("excess_per")];
				if($vals[csf("excess_per")]>0)
				{
				$color_wise_excess_per_cuff_arr[$vals[csf('fabric_cost_dtls_id')]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]+=$vals[csf("excess_per")];
				$color_wise_excess_per_cuff_arr[$vals[csf('fabric_cost_dtls_id')]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_excess_per"]+=1;
				}
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["grey"]+=$vals[csf("qty")];
	         	/*$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];*/
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["amount"]=$vals[csf("amount")];
				$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_rate"]=1;

	         }
				unset($sql_data_collar_cuff);
	         $sql_collar_cuff3 = sql_select("SELECT c.rate, a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id, c.gmts_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls c WHERE a.job_no=c.job_no and a.id=c.pre_cost_fabric_cost_dtls_id and  a.id=c.pre_cost_fabric_cost_dtls_id and c.booking_no =$txt_booking_no and c.job_no in ($all_jobs_id) and a.body_part_type=50 and c.status_active=1 and c.is_deleted=0  order by a.body_part_id");

	         foreach($sql_collar_cuff3 as $vals)
	         {

	         	$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];

	         }


	         $counts=count($size_id_array);$grand_size_wise_qnty_array=array();
	          if(count($body_part_array)>0)
	          {
					$gr_collor_qty=$gr_amount=$gr_avg_price=$gr_avg_row=$gr_excess=0;
					foreach($body_part_array as $bpart_id=>$val)
					{
					$sql_collar_cuff2= "SELECT a.rate, a.amount, a.job_no, a.id as fabric_cost_dtls_id, a.color_size_sensitive, a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.width_dia_type, b.gmts_color_id from wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b,wo_booking_dtls c ,wo_pre_cos_fab_co_avg_con_dtls d where     a.job_no = b.job_no and a.id = b.pre_cost_fabric_cost_dtls_id and b.booking_no=c.booking_no and b.po_break_down_id=c.po_break_down_id and b.pre_cost_fabric_cost_dtls_id=c.pre_cost_fabric_cost_dtls_id and b.gmts_color_id=c.gmts_color_id and  a.id=d.pre_cost_fabric_cost_dtls_id and d.gmts_sizes=b.size_number_id and c.status_active = 1 and c.is_deleted = 0 and b.booking_no =$txt_booking_no and a.body_part_id=$bpart_id and b.job_no in ($all_jobs_id) and a.body_part_type=50 and b.status_active=1 and b.is_deleted=0 group by a.rate,a.amount, a.job_no , a.id , a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition,a.gsm_weight,a.width_dia_type,b.gmts_color_id,a.color_size_sensitive  order by a.body_part_id,b.gmts_color_id  " ;
	          $sql_data_collar_cuff2=sql_select($sql_collar_cuff2);
					?>

			  	 <table align="left"  width="100%" style="margin-top: 5px; margin-bottom:10px;"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" >
			  			<tr>
			  				<td colspan="<? echo $counts+13;?>" align="center">
			  					<strong>Cuff Details &nbsp;(<? echo  $body_part[$bpart_id];?>) </strong>
			  				</td>
			  			</tr>
			  			<tr>
			  				<td  width="30"  rowspan="2" align="center"><strong>SL</strong> </td>
			  				<td  width="150" rowspan="2" align="center"><strong>Style</strong></td>
 			  				<td  width="140" rowspan="2" align="center"><strong>Gmts Item</strong></td>
 			  				<td  width="100" rowspan="2" align="center"><strong>Body Part</strong></td>
							<td  width="100" rowspan="2" align="center"><strong>Actual Qty(Pcs)</strong></td>
			  				<td  width="390" rowspan="2" align="left">&nbsp;&nbsp;<strong>Cuff Composition</strong></td>
			  				<td  width="100" rowspan="2" align="center"><strong>Color Type</strong></td>
 			  				<td  width="100" rowspan="2"  align="center"><strong>Combo</strong></td>
							<td  width="100" rowspan="2"  align="center"><strong>Fabric Color</strong></td>
 			  				<?
 			  				foreach($size_id_array as $id=>$val)
 			  				{
 			  					?>
 			  					<td width="40" align="center"><strong><? echo $size_library[$id];?></strong></td>

 			  					<?
 			  				}
 			  				?>

			  				<td width="60"  rowspan="2" align="center"><strong> Req Qty(Pcs) </strong> </td>
			  				<td  width="50" rowspan="2"  align="center"><strong> Excess %  </strong> </td>

			  				<td width="50" rowspan="2"  align="center"><strong>Price/Pcs</strong></td>
			  				<td  width="40" rowspan="2" align="center"><strong>Amount</strong></td>
			  			</tr>
			  			<tr>
			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td width="40"  align="center"><strong><? echo $size_with_item_size_array[$id][$bpart_id];?></strong></td>
			  					<?
			  				}
			  				?>
			  			</tr>
			  			<?
			  			$p=1;
			  			$size_wise_qnty_array=array();
			  			foreach($sql_data_collar_cuff2 as $row)
			  			{
							?>
			  				<tr>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="30" align="center"><? echo $p;?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="150" align="center"><? echo $job_wise_style[$row[csf("job_no")]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="140" align="center"><?  $item_id= $row[csf('item_number_id')];echo $garments_item[$item_id]; ?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center"><? echo $body_part[$row[csf("body_part_id")]];?></td>
								<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center"><? $gmt_actual_qty=$gmts_qty_data_arr[$row[csf('job_no')]][$item_id][$row[csf('gmts_color_id')]][50];echo number_format($gmt_actual_qty,0);$total_gmt_actual_qty+=$gmt_actual_qty;?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="390" align="left"> &nbsp;
			  						<? echo $row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$fabric_typee[$row[csf('width_dia_type')]] ;?>
			  					</td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center"><? echo $color_type[$row[csf('color_type_id')]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center">
			  						<? echo $color_library[$row[csf('gmts_color_id')]];  ?>
			  					</td>
								<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center">
			  						<?
									if($row[csf('color_size_sensitive')]==1 or $row[csf('color_size_sensitive')]==2 or $row[csf('color_size_sensitive')]==4)
										{
											$gmt_fab_color=$color_library[$row[csf('gmts_color_id')]];
										}
										else
										{
											$contrast_color_id=return_field_value("b.contrast_color_id as contrast_color_id", "wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b", "a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.job_no in ($all_jobs_id) and a.id=".$row[csf('fabric_cost_dtls_id')]."  and b.gmts_color_id=".$row[csf('gmts_color_id')]." ","contrast_color_id");//pre_cost_fabric_cost_dtls_id
											if($contrast_color_id>0)
											{
												$gmt_fab_color=$color_library[$contrast_color_id];
											}
										}
									echo $gmt_fab_color;   ?>
			  					</td>

			  					<?
								$tot_size_qty=0;
			  					foreach($size_id_array as $id=>$val)
			  					{
			  						?>
			  						<td  style="word-break: break-all;word-wrap: break-word;"  width="40"  align="center"><? echo $size_grey_qty=$size_item_wise_qnty[$row[csf("body_part_id")]][$row[csf('fabric_cost_dtls_id')]][$row[csf("gmts_color_id")]][$id][$size_with_item_size_array[$id][$row[csf("body_part_id")]]]["grey"];?></td>

			  						<?
			  						$size_wise_qnty_array[$id]+=$size_grey_qty;$sub_size_wise_qnty_array[$row[csf("body_part_id")]][$id]+=$size_grey_qty;
									$grand_size_wise_qnty_array[$id]+=$size_grey_qty;
									$tot_size_qty+=$size_grey_qty;

			  					}
			  					?>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="60" align="center">
			  						<? echo $grey_qnty=$tot_size_qty;//$color_wise_qnty[$row[csf('gmts_color_id')]][$item_id]["grey"];
									$row_excess_per=$color_wise_excess_per_cuff_arr[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf("gmts_color_id")]][$item_id]["row_excess_per"];
									 ?>
			  					</td>

			  					<td  style="word-break: break-all;word-wrap: break-word;" title="excess tot=<? echo $row_excess_per; ?>"  width="50" align="center">
			  						<?  $avg_excess=$color_wise_excess_per_cuff_arr[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf("gmts_color_id")]][$item_id]["excess_per"]/$row_excess_per;echo number_format($avg_excess,2);   ?>
			  					</td>
			  					<td   style="word-break: break-all;word-wrap: break-word;" width="50" title="<? echo $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["row_rate"];?>" align="center">
			  						<? echo $price= $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["rate"];
									$tot_row_rate= $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["row_rate"]; ?>

			  					</td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="40" align="center">
			  						<? echo  $amount=$grey_qnty* $price;   ?>
			  					</td>

			  				</tr>
			  				<?
			  				$sub_collor_qty_arr[$row[csf("body_part_id")]]+=$grey_qnty;
							$sub_collor_amount_arr[$row[csf("body_part_id")]]+=$amount;
							$sub_excess_arr[$row[csf("body_part_id")]]+=$avg_excess;
							$sub_price_arr[$row[csf("body_part_id")]]+=$price;
							$body_wise_avg_row[$row[csf("body_part_id")]]+=1;

							$gr_fin_qty+=$fin_qty;
			  				$gr_collor_qty+=$grey_qnty;
			  				$gr_avg_price+=$price;
							$gr_amount+=$amount;
			  				$gr_excess+=$avg_excess;

			  				$gr_avg_row++;

			  				$p++;
			  			}
			  			?>

			  			<tr>
			  				<td colspan="9" align="right">Total </td>
			  				<?
							//$sub_size_wise_qnty_array=array();
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td  align="center"><? echo $sub_size_wise_qnty_array[$bpart_id][$id];
								//$sub_size_wise_qnty_array[$row[csf("body_part_id")]][$id]=0;
								/*$grand_size_wise_qnty_array[$id]+=$sub_size_wise_qnty_array[$bpart_id][$id];*/
								?></td>
			  					<?
			  				}
							$tot_avg_row=$body_wise_avg_row[$bpart_id];
							$tot_sub_excess=$sub_excess_arr[$bpart_id];
							$tot_sub_price=$sub_price_arr[$bpart_id];
			  				?>
			  				<td align="center">
			  					<? echo $sub_collor_qty_arr[$bpart_id];  ?>
			  				</td>
			  				<td align="center" title="Tot Excess & Tot Row=<? echo $tot_sub_excess.'='.$tot_avg_row;?>"><? echo number_format($tot_sub_excess/$tot_avg_row,2); ?></td>
			  				<td align="center">
			  					<? echo number_format($tot_sub_price/$tot_avg_row,2);  ?>
			  				</td>
			  				<td align="center">
			  					<? echo $sub_collor_amount_arr[$bpart_id];   ?>
			  				</td>
			  			</tr>
			  			<?
						} //Body Part End

			  		?>
					<tr>
			  				<td colspan="9" align="right">Grand Total </td>
			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td  align="center"><? echo $grand_size_wise_qnty_array[$id];?></td>
			  					<?
			  				}
			  				?>
			  				<td align="center">
			  					<? echo $gr_collor_qty;  ?>
			  				</td>
			  				<td align="center" title="grand Excess &tot row=<? echo $gr_excess.'='.$gr_avg_row;?>"><? echo number_format($gr_excess/$gr_avg_row,2); ?></td>
			  				<td align="center">
			  					<? //echo number_format($gr_avg_price/$gr_avg_row,2);  ?>
			  				</td>
			  				<td align="center">
			  					<? echo $gr_amount;   ?>
			  				</td>
			  			</tr>
			  	</table>
				<?
					}
				?>

				</div>
				<br>
				
				<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
						<caption> <strong style="float:left"> Stripe Details</strong></caption>
					<?
					$color_name_arr=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0",'id','color_name');
					$po_name_arr=return_library_array( "select id,po_number from wo_po_break_down where status_active=1 and is_deleted=0",'id','po_number');
					// and b.fabric_color_id=d.stripe_color 
					$sql_stripe_po=sql_select("SELECT  b.po_break_down_id from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and d.job_no in($all_jobs_id) and b.booking_no=$txt_booking_no and d.color_number_id=b.gmts_color_id and c.color_type_id in (2,6) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and 	b.is_deleted=0  group by b.po_break_down_id");
					foreach($sql_stripe_po as $po_row){
						$stripe_po_arr[$po_row[csf('po_break_down_id')]]=$po_name_arr[$po_row[csf('po_break_down_id')]];
					}

					$sql_stripe=("SELECT c.id, d.id as did, c.job_no,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,d.color_number_id as color_number_id,d.uom,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,c.uom as type_uom from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and d.job_no in($all_jobs_id) and b.booking_no=$txt_booking_no  and c.color_type_id in (2,6) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and b.is_deleted=0  group by c.id,c.job_no,c.body_part_id,c.fabric_description,c.gsm_weight,d.color_number_id,d.uom,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,c.composition,c.construction,c.uom, c.id, d.id order by c.job_no, c.id, d.id");
					//echo $sql_stripe;


					$result_data=sql_select($sql_stripe);
					foreach($result_data as $row){
						$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
						$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
						$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]+=$row[csf('fabreqtotkg')];
						$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['subtotal_measurement'][$row[csf('did')]]=$row[csf('measurement')];
						$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

						$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
						$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
						$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
						$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom']=$row[csf('uom')];
						//$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
						$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg']+=$row[csf('fabreqtotkg')];
						$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabric_description']=$row[csf('fabric_description')];
						
						$strip_id_arr[$row[csf('did')]]=$row[csf('did')];

						
					}
					if(count($strip_id_arr)>0){
						$stripe_id_str=implode(",",$strip_id_arr);
						$stripe_po_sql=sql_select("SELECT a.po_break_down_id from WO_BOOKING_DTLS a join WO_PRE_STRIPE_COLOR b on a.PRE_COST_FABRIC_COST_DTLS_ID=b.PRE_COST_FABRIC_COST_DTLS_ID where a.status_active=1 and a.is_deleted=0 and b.id in ($stripe_id_str) group by a.po_break_down_id");
					}
					

					?>
						<tr>
							<th width="30"> SL</th>
							<th width="150"> PO Number</th>
							<th width="60"> Body Part</th>
							<th width="100">Fab. Desc.</th>
							<th width="60">Gmts Color</th>
							<th width="60">Fabric Qty </th>
							<th width="40">Color Sequence</th>
							<th width="60"> Stripe Color</th>
							<th width="60"> Stripe Measurement</th>
							<th  width="50"> Uom</th>
							<th  width="50"> Qty.(KG)</th>
							
						</tr>
						<?
						foreach($stripe_arr as $body_id=>$body_data){
							foreach($body_data as $color_id=>$color_val){
								$total_rowspan+=count($color_val['stripe_color']);
								foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
								{
								$color_strip_color_qty_arr[$body_id][$color_id]=$color_val['fabreqtotkg'][$strip_color_id];
								}
							}
						}
						$i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
						foreach($stripe_arr as $body_id=>$body_data){
							foreach($body_data as $color_id=>$color_val){
								$rowspan=count($color_val['stripe_color']);
								$composition=$stripe_arr2[$body_id][$color_id]['composition'];
								$construction=$stripe_arr2[$body_id][$color_id]['construction'];
								$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
								//$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
								$uom_id=$stripe_arr2[$body_id][$color_id]['uom'];
								$subtotal_measurement=array_sum($color_val['subtotal_measurement']);					
								$color_qty=$stripe_arr2[$body_id][$color_id]['fabreqtotkg'];
								//$color_qty=$color_strip_color_qty_arr[$body_id][$color_id];
								$fabric_des=$stripe_arr2[$body_id][$color_id]['fabric_description'];
								$qnty=$color_qty/$subtotal_measurement;
								$total_color_qty+=$color_qty;
								?>
								<tr>
								<?
								if($i==1){
								?>
								<td rowspan="<? echo $total_rowspan;?>" align="center"> <? echo $i; ?></td>
								<td rowspan="<? echo $total_rowspan;?>" align="center"> <? echo implode(",",$stripe_po_arr); ?></td>
								<? } ?>
									<td rowspan="<? echo $rowspan;?>" align="center"> <? echo $body_part[$body_id]; ?></td>
									<td rowspan="<? echo $rowspan;?>" align="center"> <? echo $fabric_des; ?></td>
									<td rowspan="<? echo $rowspan;?>" align="center"> <? echo $color_name_arr[$color_id]; ?></td>
									<td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?></td>
								<?
								//$total_fab_qty+=$color_wise_wo_result_qnty[csf('fin_fab_qnty')];
								$k=1;
								foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
								{
									$measurement=$color_val['measurement'][$strip_color_id];
									$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
									$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
									$qnty_kg=$qnty*$measurement;
									?>
									<td align="center"><?  echo  $k; ?></td>
									<td align="center"><?  echo  $color_name_arr[$s_color_val]; ?></td>
									<td align="right"> <? echo  number_format($measurement,2); ?></td>
									<td align="center"> <? echo  $unit_of_measurement[$uom_id]; ?></td>
									<td align="right"> <? echo  number_format($fabreqtotkg,2); ?></td>						
								</tr>
									<?
									$total_fabreqtotkg+=$fabreqtotkg;
									$k++;
									
								}
								$i++;
							}
						}
						?>
					<tfoot>
					<tr>
						<td colspan="5">Total </td>
						<td align="right"><? echo  number_format($total_color_qty,2); ?> </td>
						<td></td>
						<td></td>
						<td></td>
						<td></td>
						<td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
					</tr>
					</tfoot>
			</table>




			<table  style="margin-top: 5px;float: left;"    width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

				<tr>
					<td colspan="9" align="center">
						<strong>Comments</strong>
					</td>
				</tr>
				<tr>
					<td align="center"> SL </td>
					<td align="center" width="200"  style="word-wrap: break-word;word-break: break-all;"> PO NO </td>
					<td align="center">BOM Qty</td>
					<td align="center"> Booking Qty </td>
					<td align="center"> Short Booking Qty </td>
					<td align="center"> Total Booking Qty </td>
					<td align="center"> Balance </td>
					<td align="center"> Comments </td>
				</tr>
				<?
				$is_short_data=sql_select("SELECT a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0   and b.is_short =1 group by  a.id ");
				foreach($is_short_data as $vals)
				{
					$short_qty_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
				}

				$booking_data=sql_select("SELECT a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and  b.status_active=1 and b.is_deleted=0 and b.is_short !=1 and b.booking_type=1 group by  a.id  order by a.id");
				foreach($booking_data as $vals)
				{
					$booking_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
				}

				$po_date=return_library_array("select id,shipment_date from wo_po_break_down where status_active=1 and is_deleted=0",'id','shipment_date');

				$comments_data=sql_select("SELECT min(a.id) as ids,b.po_break_down_id as po_number,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,SUM(b.requirment) as precost_grey_qty FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id
					and
					b.po_break_down_id=d.po_break_down_id and
					b.color_number_id=d.gmts_color_id and
					b.dia_width=d.dia_width and
					b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					a.job_no=d.job_no and
					a.id=d.pre_cost_fabric_cost_dtls_id
					and
					d.booking_no =$txt_booking_no and
					d.job_no in($all_jobs_id) and

					d.status_active=1 and
					d.is_deleted=0 and
					b.cons>0
					group by b.po_break_down_id order by b.po_break_down_id");



				$job_no=$all_jobs_id;
				$condition= new condition();
				if(str_replace("'","",$job_no) !='')
				{
					$condition->job_no("in ($job_no)");
				}
				$condition->init();
				$fabric= new fabric($condition);
				$fabric_costing_qty_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish();

				$j=1;
				$total_bom=0;
				$total_book=0;
				$total_short=0;
				$total_short_full=0;
				$total_balance=0;
				foreach($comments_data as $val)
				{
					$po_id=$val[csf('po_number')];
					$woven_qty=array_sum($fabric_costing_qty_arr['woven']['grey'][$po_id]);
					$knit_qty=array_sum($fabric_costing_qty_arr['knit']['grey'][$po_id]);
					$sum_woven_knit=$woven_qty + $knit_qty;


					?>
					<tr>
						<td align="center"><? echo $j;?></td>

						<td align="center"  style="word-wrap: break-word;word-break: break-all;"> <? echo $po_num_arr[$val[csf("po_number")]] ;?> </td>
						<td align="center"><?  echo $pre= def_number_format($sum_woven_knit,2);  ?> </td>
						<td align="center"><?  echo $bookings= def_number_format($booking_arr[$val[csf("po_number")]],2);  ?> </td>
						<td align="center"> <?echo $short=def_number_format($short_qty_arr[$val[csf("po_number")]],2); ?> </td>
						<td align="center"> <?   $tot_short_book= str_replace(',','',$bookings) +  str_replace(',','',$short) ; echo def_number_format($tot_short_book,2); ?>  </td>
						<td align="center"> <?  $bal =str_replace(',','',$pre)-str_replace(',','',$tot_short_book) ; echo def_number_format($bal,2);  ?> </td>
						<td align="center"> <? if($bal!=0){ if($pre>$tot_short_book){echo "Less ";} else{ echo "Over";} }?> </td>


					</tr>
					<?
					$total_bom +=str_replace(',','',$pre);
					$total_book +=str_replace(',','',$bookings);
					$total_short +=str_replace(',','',$short);
					$total_short_full += str_replace(',','',$tot_short_book);
					$total_balance += str_replace(',','',$bal);

					$j++;
				}
				?>
				<tr>
					<td colspan="2" align="right"> <b> Total </b></td>
					<td align="center"><strong><? echo def_number_format($total_bom,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_book,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_short,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_short_full,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_balance,2);?> </strong> </td>
					<td>&nbsp;</td>
				</tr>
			</table>



			<?
			if($cbo_fabric_source==1 || $cbo_fabric_source==2 || $cbo_fabric_source==3){
			?>
			<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
				<tr>
					<?
					$nameArray_item_size=sql_select( "SELECT min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active =1 and d.is_deleted=0 and d.job_no in($all_jobs_id)  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
					if(count($nameArray_item_size)>0)
					{
						?>
						<td width="49%">

						</td>
						<td width="2%">
						</td>
						<?
					}
					?>
					<?
					$nameArray_item_size=sql_select( "SELECT min(c.id) as id, b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.job_no in ($all_jobs_id)  and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");

					if(count($nameArray_item_size)>0)
					{
						?>
						<td width="49%">

						</td>
						<?
					}
					?>
				</tr>
			</table>
			<br/>

			<br/>



	<?
	//------------------------------ Query for TNA start-----------------------------------
	$po_id_all=str_replace("'","",$txt_order_no_id);
	$po_num_arr=return_library_array("SELECT id,po_number from wo_po_break_down where job_no_mst in($all_jobs_id)",'id','po_number');
	$tna_start_sql=sql_select( "SELECT id,po_number_id,
	(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
	(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
	(case when task_number=60 then task_start_date else null end) as knitting_start_date,
	(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
	(case when task_number=61 then task_start_date else null end) as dying_start_date,
	(case when task_number=61 then task_finish_date else null end) as dying_end_date,
	(case when task_number=64 then task_start_date else null end) as finishing_start_date,
	(case when task_number=64 then task_finish_date else null end) as finishing_end_date,
	(case when task_number=84 then task_start_date else null end) as cutting_start_date,
	(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
	(case when task_number=86 then task_start_date else null end) as sewing_start_date,
	(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
	(case when task_number=110 then task_start_date else null end) as exfact_start_date,
	(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
	(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
	(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
	from tna_process_mst
	where status_active=1 and po_number_id in($po_id_all) and job_no in ($all_jobs_id) order by po_number_id");
 	$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
	$tna_date_task_arr=array();
	foreach($tna_start_sql as $row)
	{
		if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
		{
			if($tna_fab_start=="")
			{
				$tna_fab_start=$row[csf("fab_booking_start_date")];
			}
		}
		if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
		}
		if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
		}
		if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
		}
		if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
		}
		if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
		}
		if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
		}
		if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
		}
	}
	//------------------------------ Query for TNA end-----------------------------------
	if(count($tna_start_sql)>0 )
	{
		?>
		<br>
		<!-- <fieldset id="div_size_color_matrix" style="max-width:1000;">
			<legend>TNA Information</legend>
			<table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
				<tr>
					<td rowspan="2" align="center" valign="top">SL</td>
					<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
					<td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
					<td colspan="2" align="center" valign="top"><b>Knitting</b></td>
					<td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
					<td colspan="2" align="center" valign="top"><b>Finishing Fabric</b></td>
					<td colspan="2" align="center" valign="top"><b>Cutting </b></td>
					<td colspan="2" align="center" valign="top"><b>Sewing </b></td>
					<td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
				</tr>
				<tr>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
				</tr>
				<?
				$i=1;
				foreach($tna_date_task_arr as $order_id=>$row)
				{
					?>
					<tr>
						<td><? echo $i; ?></td>
						<td><? echo $po_num_arr[$order_id]; ?></td>
						<td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
						<td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
						<td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
					</tr>
					<?
					$i++;
				}
				?>
			</table>
		</fieldset> -->
		<?
	}
	}// fabric Source End
	?>
	<br>

	<table width="220"  border="0" cellpadding="2" cellspacing="0" rules="all" style="float:left">
		<tr>
			<td width="200" valign="top" align="left">

				<div id="div_size_color_matrix" style="float:left;">
					<?
					$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
					?>
					<fieldset>
						<legend>RMG Process Loss % </legend>
						<table width="180" class="rpt_table" border="1" rules="all">
							<?
							if(number_format($rmg_process_breakdown_arr[8],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Cut Panel rejection <!-- Extra Cutting % breack Down 8-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[8],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[2],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Chest Printing <!-- Printing % breack Down 2-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[2],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[10],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Neck/Sleeve Printing <!-- New breack Down 10-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[10],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[1],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Embroidery   <!-- Embroidery  % breack Down 1-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[1],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[4],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Sewing /Input<!-- Sewing % breack Down 4-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[4],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[3],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Garments Wash <!-- Washing %breack Down 3-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[3],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[15],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Gmts Finishing <!-- Washing %breack Down 3-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[15],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[11],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Others <!-- New breack Down 11-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[11],2);
										?>
									</td>
								</tr>
								<?
							}
							$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
							if($gmts_pro_sub_tot>0)
							{
								?>
								<tr>
									<td width="130">
										Sub Total <!-- New breack Down 11-->
									</td>
									<td align="right">
										<?

										echo number_format($gmts_pro_sub_tot,2);
										?>
									</td>
								</tr>
								<?
							}
							?>
						</table>
					</fieldset>


					<fieldset>
						<legend>Fabric Process Loss % </legend>
						<table width="180" class="rpt_table" border="1" rules="all">
							<?
							if(number_format($rmg_process_breakdown_arr[6],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Knitting  <!--  Knitting % breack Down 6-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[6],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[12],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Yarn Dyeing  <!--  New breack Down 12-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[12],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[5],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Dyeing & Finishing  <!-- Finishing % breack Down 5-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[5],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[13],2)>0)
							{
								?>
								<tr>
									<td width="130">
										All Over Print <!-- new  breack Down 13-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[13],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[14],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Lay Wash (Fabric) <!-- new  breack Down 14-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[14],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[7],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Dying   <!-- breack Down 7-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[7],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[0],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Cutting (Fabric) <!-- Cutting % breack Down 0-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[0],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[9],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Others  <!-- Others% breack Down 9-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[9],2);
										?>
									</td>
								</tr>
								<?
							}
							$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
							if($fab_proce_sub_tot>0)
							{
								?>
								<tr>
									<td width="130">
										Sub Total  <!-- Others% breack Down 9-->
									</td>
									<td align="right">
										<?

										echo number_format($fab_proce_sub_tot,2);
										?>
									</td>
								</tr>
								<?
							}
							if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
							{
								?>
								<tr>
									<td width="130">
										Grand Total  <!-- Others% breack Down 9-->
									</td>
									<td align="right">
										<?
										echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2);
										?>
									</td>
								</tr>
								<?
							}
							?>
						</table>
					</fieldset>
				</div>
			</td>
		</tr>
	</table>

	<!-- <table width="400"  border="0" cellpadding="2" cellspacing="0" rules="all" style="float:left">
		<tr>
			<td colspan="6" align="left"><img  src='<? echo $path.$imge_arr[$po_job_no]; ?>' height='155' width='200' /></td>
		</tr>
	</table> -->
	<br>
	<br>
						<?
									$data_array = sql_select("select ID,TERMS, TERMS_PREFIX from wo_booking_terms_condition where booking_no = $txt_booking_no");
									$groupedData = array();
									foreach ($data_array as $row) {
										$prefix = $row["TERMS_PREFIX"];
										if($prefix!=""){
										$headerData[$prefix]=$prefix;
										$groupedData[$prefix]['TERMS'].=$row["TERMS"].',';
										}
										
									}
									// print_r($groupedData);
										?>
									<table width="100%" class="rpt_table" border="1"  cellpadding="0" cellspacing="0" rules="all" >
									<tr>
												<?
										foreach ($headerData as $header=>$head) {
												 
										if($header!=""){
											?>
										 <th><b> <?=$header;?> </b></th> 
										 <?
										}
									}
										?>
								  </tr>	
								 	 <tr>
										<?php
										foreach ($headerData as $header=>$head) {
											$terms=$groupedData[$header]['TERMS'];	
											$termsAll=rtrim($terms,',');
											$termsArr=array_unique(explode(',',$termsAll));
										?>
											<td valign="top"><?//=$termsAll;?>
											<table width="99%" style=" margin:2px;" class="rpt_table" border="1"  cellpadding="0" cellspacing="0" rules="all" >
												<?php
												$i=1;
												foreach($termsArr as $val)
												{?>
												<tr>
													<td> <?=$i;?></td>
													<td><b> <?=$val;?><b></td>
												</tr>
												<? $i++; }
												?>

											<tr>
												<td> </td>
										   </tr>
										  </table>
										
										</td>
										<?
										}
										?>

									</tr>
									</table>						
										 			
	<br/><br/>
	<? $booking_mst_info=sql_select("SELECT a.id as mst_id, to_char(a.insert_date, 'DD-MM-YYYY HH:MI:SS AM') as insert_date, b.user_full_name, c.custom_designation,a.company_id from wo_booking_mst a join user_passwd b on b.id = a.inserted_by join lib_designation c on c.id = b.designation where a.status_active=1 and a.is_deleted=0 and a.BOOKING_NO=$txt_booking_no");
	$mst_arr=array('insert_date','user_full_name','custom_designation','mst_id','company_id');
	foreach($booking_mst_info as $row){
		foreach($mst_arr as $data){
			$$data=$row[csf($data)];
		}
	}

	$electronic_sequence_arr = [];
    $get_electronic_sequence_sql = sql_select("select sequence_no as sequence_no from electronic_approval_setup where page_id = 410 and company_id=$company_id and is_deleted = 0 order by sequence_no asc");
    foreach ($get_electronic_sequence_sql as $sequence){
        $electronic_sequence_arr[] = $sequence['SEQUENCE_NO'];
    }

    $sql_get_checked_user = sql_select("select user_passwd.user_full_name as USER_FULL_NAME, lib_designation.custom_designation as CUSTOM_DESIGNATION, to_char(approval_history.approved_date, 'DD-MM-YYYY HH:MI:SS AM') as APPROVED_DATE from approval_history left join user_passwd on user_passwd.id = approval_history.approved_by left join lib_designation on lib_designation.id = user_passwd.designation where approval_history.entry_form = 7 and approval_history.mst_id = $mst_id and approval_history.sequence_no in(".implode(',', $electronic_sequence_arr).") and approval_history.id = (select max(id) from approval_history where entry_form = 7 and mst_id = $mst_id and sequence_no = ".min($electronic_sequence_arr).") and rownum = 1 and (select max(CURRENT_APPROVAL_STATUS) from approval_history where entry_form = 7 and mst_id = $mst_id) = 1 order by approval_history.approved_no asc");
	
    $sql_get_approved_user = sql_select("select user_passwd.user_full_name as USER_FULL_NAME, lib_designation.custom_designation as CUSTOM_DESIGNATION, to_char(approval_history.approved_date, 'dd-mm-yyyy hh:mi:ss am') as APPROVED_DATE from approval_history inner join wo_booking_mst a on a.id = approval_history.mst_id left join user_passwd on user_passwd.id = approval_history.approved_by left join lib_designation on lib_designation.id = user_passwd.designation where approval_history.mst_id = $mst_id and approval_history.entry_form = 7 and a.is_approved = 1 and approval_history.current_approval_status = 1 ");
	// and approval_history.sequence_no =".max($electronic_sequence_arr)
	?>
       
		    <table  width="100%"  border="0" cellpadding="0" cellspacing="0">
		    	<tr>
		            <td>  <?
					 $appSql = "select a.APPROVED_BY, a.APPROVED_DATE,b.USER_FULL_NAME,c.CUSTOM_DESIGNATION from approval_mst a,USER_PASSWD b,LIB_DESIGNATION c where a.mst_id =$mst_id  and a.APPROVED_BY=b.id and b.DESIGNATION=c.id and c.STATUS_ACTIVE=1 and c.IS_DELETED=0 and b.STATUS_ACTIVE=1 and b.IS_DELETED=0
					 union all
					 select b.id as APPROVED_BY, a.INSERT_DATE as APPROVED_DATE,b.USER_FULL_NAME,c.CUSTOM_DESIGNATION from wo_booking_mst a,USER_PASSWD b,LIB_DESIGNATION c where a.id =$mst_id  and a.INSERTED_BY=b.id and b.DESIGNATION=c.id and c.STATUS_ACTIVE=1 and c.IS_DELETED=0 and b.STATUS_ACTIVE=1 and b.IS_DELETED=0";
					 // echo $appSql;die;
					 $appSqlRes=sql_select($appSql);
					 $userDtlsArr=array();
					 foreach($appSqlRes as $row){
						 $userDtlsArr[$row['APPROVED_BY']]="<div><b>".$row['USER_FULL_NAME']."</b></div><div><b>".$row['CUSTOM_DESIGNATION']."</b></div><div><small>".$row['APPROVED_DATE']."</small></div>";
					 }
					//  echo "<pre>";
					//  print_r($userDtlsArr); 
					//    echo "</pre>";die();
					 
					 echo get_app_signature(121, $cbo_company_name,"900px",$template_id, 50,$inserted_by,$userDtlsArr);
		                    //echo signature_table(121, $cbo_company_name, "1330px",1,'');
							$job_no_all= implode(",",array_unique($joball['job_no']));
							$style_sting_all=implode(",",array_unique($joball['style_ref_no']));
							echo "****".custom_file_name($txt_booking_no,$style_sting_all,$job_no_all);
		                ?>
		            </td>
		        </tr>
		    </table>
	</div>
	<?
			
			$html = ob_get_contents();
			ob_clean();
			list($is_mail_send,$mail)=explode('___',$mail_send_data);
		
			if($is_mail_send==1){
				require_once('../../../mailer/class.phpmailer.php');
				require_once('../../../auto_mail/setting/mail_setting.php');
				$mailBody = preg_replace("/<img[^>]+\>/i", " ", $html); 
				$mailBody="<br>".$mail_body	;	
				$mailToArr=array();
				$mailSql = "select b.EMAIL  from wo_booking_mst a,LIB_SUPPLIER b where b.id=a.supplier_id and a.booking_no=$txt_booking_no";
			//echo $mailSql;die;
				$mailSqlRes=sql_select($mailSql);
				foreach($mailSqlRes as $rows){
					if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
				}
				
				
				$mailSql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=99 and b.mail_user_setup_id=c.id  and c.IS_DELETED=0 and c.STATUS_ACTIVE=1";
				//echo $mailSql;die;
				$mailSqlRes=sql_select($mailSql);
				foreach($mailSqlRes as $rows){
					if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
				}
				if($mail!=''){$mailToArr[]=$mail;}
		
				$to=implode(',',$mailToArr);
				$subject="Partial fabric booking";
				$header=mailHeader();
				echo $to;
				echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
				
			}
			else{
				echo $html;
			}
			exit();
}



if($action=="print_booking_northern_new") // Aziz for northern
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' or form_name='knit_order_entry' and file_type=1",'master_tble_id','image_location');
	$company_library=return_library_array( "select id,company_name from lib_company where status_active=1 and is_deleted=0", "id", "company_name");
	$color_library=return_library_array( "select id,color_name from lib_color  where status_active=1 and is_deleted=0", "id", "color_name");
	$size_library=return_library_array( "select id,size_name from lib_size  where status_active=1 and is_deleted=0", "id", "size_name");
	$country_arr=return_library_array( "select id,country_name from   lib_country  where status_active=1 and is_deleted=0",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier  where status_active=1 and is_deleted=0",'id','supplier_name');
	$supplier_address_arr=return_library_array( "select id,address_1 from   lib_supplier  where status_active=1 and is_deleted=0",'id','address_1');


	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info  where status_active=1 and is_deleted=0","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer  where status_active=1 and is_deleted=0",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location  where status_active=1 and is_deleted=0",'id','location_name');

	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	$season_arr=return_library_array("select id,season_name from lib_buyer_season  where status_active=1 and is_deleted=0","id","season_name");
	$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where status_active=1 and is_deleted=0 and id in(select po_break_down_id from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no=$txt_booking_no)",'id','po_number');

	$uom=0;
	$joball=array();
	$nameArray_per_job=sql_select( "SELECT  a.season_buyer_wise,  a.job_no,a.style_ref_no ,a.season_matrix,a.gmts_item_id,a.product_dept,max(c.booking_date) as booking_date ,max(c.delivery_date) as delivery_date,max(c.is_approved) as is_approved,max(c.buyer_id) as buyer_id,max(c.pay_mode) as pay_mode,max(supplier_id) as supplier_id,max(a.dealing_marchant) as dealing_marchant,max(c.attention) as attention,max(c.currency_id) as currency_id ,max(c.remarks)  as remarks from wo_po_details_master a , wo_booking_dtls b,wo_booking_mst c  where c.booking_no=b.booking_no and c.status_active=1 and c.is_deleted=0 and  a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by  a.season_buyer_wise, a.job_no,a.style_ref_no ,a.season_matrix,a.gmts_item_id,a.product_dept ");
	$po_job_no="";
	foreach ($nameArray_per_job as $vals)
	{
		$joball['job_no'][$vals[csf('job_no')]]=$vals[csf('job_no')];
		$joball['style_ref_no'][$vals[csf('job_no')]]=$vals[csf('style_ref_no')];
		$all_job_arr[$vals[csf("job_no")]]["job"]="'".$vals[csf("job_no")]."'";
		$all_job_arr[$vals[csf("job_no")]]["style"]=$vals[csf("style_ref_no")];
		$all_job_arr[$vals[csf("job_no")]]["item"]=$vals[csf("gmts_item_id")];
		$all_job_arr[$vals[csf("job_no")]]["season"]=$vals[csf("season_matrix")];

		$all_job_arr_season[$vals[csf("job_no")]]=$season_arr[$vals[csf("season_buyer_wise")]];

		$all_job_arr[$vals[csf("job_no")]]["dept"]=$vals[csf("product_dept")];
		$all_job_arr_dept[$vals[csf("job_no")]]=$product_dept[$vals[csf("product_dept")]];
		$all_jobs[$vals[csf("job_no")]]="'".$vals[csf("job_no")]."'";
		$job_wise_style[$vals[csf("job_no")]]= $vals[csf("style_ref_no")];
		$po_job_no=$vals[csf('job_no')];
	}
	//echo $po_job_no.'DDD';die;
	$all_jobs_id=implode(",",$all_jobs );
	$seasons=implode(",",$all_job_arr_season );
	$depts=implode(",",$all_job_arr_dept );
 	$po_qnty_all_style=sql_select("SELECT sum(po_quantity) as qnty from wo_po_break_down where status_active=1 and is_deleted=0 and job_no_mst in ($all_jobs_id)");

 	$all_shipdates_arr=sql_select("SELECT min(b.pub_shipment_date)  as shipdate,job_no,a.order_uom as uom from wo_po_details_master a, wo_po_break_down b where a.job_no=b.job_no_mst and b.status_active=1 and b.is_deleted=0 and  a.status_active=1 and a.is_deleted=0 and b.job_no_mst in ($all_jobs_id) group by job_no,a.order_uom");
 	$shipment_dates="";
 	$job_uom_array=array();
 	foreach($all_shipdates_arr as $key=>$data)
 	{
 		if($shipment_dates=="")
 		{
 			$shipment_dates=change_date_format($data[csf("shipdate")]);
 		}
 		else
 		{
 			$shipment_dates .=','.change_date_format($data[csf("shipdate")]);
 		}
 		$job_uom_array[$data[csf("job_no")]]=$unit_of_measurement[$data[csf("uom")]];


 	}
 	$unites=implode(",", $job_uom_array);


	$uom=0;
	$job_data_arr=array();
	$nameArray_buyer=sql_select( "SELECT  a.style_ref_no,a.style_description, a.job_no, a.style_owner, a.buyer_name, a.dealing_marchant,a.season,a.season_matrix,a.total_set_qnty,a.product_dept,a.product_code,a.pro_sub_dep,a.gmts_item_id ,a.order_repeat_no,a.qlty_label  from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  and a.job_no in ($all_jobs_id) ");

	foreach ($nameArray_buyer as $result_buy)
	{
		$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
		$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
		$job_data_arr['total_set_qnty'][$result_buy[csf('job_no')]]=$result_buy[csf('total_set_qnty')];
		$job_data_arr['product_dept'][$result_buy[csf('job_no')]]=$product_dept[$result_buy[csf('product_dept')]];
		$job_data_arr['product_code'][$result_buy[csf('job_no')]]=$result_buy[csf('product_code')];
		$job_data_arr['pro_sub_dep'][$result_buy[csf('job_no')]]=$pro_sub_dept_array[$result_buy[csf('pro_sub_dep')]];
		$job_data_arr['gmts_item_id'][$result_buy[csf('job_no')]]=$result_buy[csf('gmts_item_id')];
		$job_data_arr['style_ref_no'][$result_buy[csf('job_no')]]=$result_buy[csf('style_ref_no')];
		$job_data_arr['style_description'][$result_buy[csf('job_no')]]=$result_buy[csf('style_description')];
		$job_data_arr['dealing_marchant'][$result_buy[csf('job_no')]]=$marchentrArr[$result_buy[csf('dealing_marchant')]];
		$job_data_arr['season_matrix'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_matrix')]];
		$job_data_arr['order_repeat_no'][$result_buy[csf('job_no')]]=$result_buy[csf('order_repeat_no')];
		$job_data_arr['qlty_label'][$result_buy[csf('job_no')]]=$quality_label[$result_buy[csf('qlty_label')]];
	}
	$job_no= implode(",",array_unique($job_data_arr['job_no']));
	$job_no_in= implode(",",array_unique($job_data_arr['job_no_in']));
	$product_depertment=implode(",",array_unique($job_data_arr['product_dept']));
	$product_code=implode(",",array_unique($job_data_arr['product_code']));
	$pro_sub_dep=implode(",",array_unique($job_data_arr['pro_sub_dep']));
	$gmts_item_id=implode(",",array_unique($job_data_arr['gmts_item_id']));
	$style_sting=implode(",",array_unique($job_data_arr['style_ref_no']));
	$style_description=implode(",",array_unique($job_data_arr['style_description']));
	$dealing_marchant=implode(",",array_unique($job_data_arr['dealing_marchant']));
	$season_matrix=implode(",",array_unique($job_data_arr['season_matrix']));
	$order_repeat_no= implode(",",array_unique($job_data_arr['order_repeat_no']));
	$qlty_label= implode(",",array_unique($job_data_arr['qlty_label']));
	$path=str_replace("'","",$path);
	if($path=="")
	{
	$path='../../';
	}
	ob_start();
	?>
	<style type="text/css">

		body, p, span, td, a {font-size:10pt;font-family: Arial;}
		body{margin-left:2em; margin-right:2em; font-family: "Arial Narrow", Arial, sans-serif;}

	</style>

	<div style="width:1330px" align="center" >

		<table id="tb_header" width="100%" cellpadding="0" cellspacing="0" style="border:0px solid black" >
			<thead>
				<tr>
					<td width="150" rowspan="4">
						<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100' width='100' />
					</td>
					<td width="200">&nbsp;</td>
					<td width="400" align="left" style="font-size: 16px;"><b><?php echo $company_library[$cbo_company_name]; ?></b></td>
					<td width="100">&nbsp;</td>
					<td width="300" align="left"><b>Booking No: </b><?php echo str_replace("'", "", $txt_booking_no); ?></td>
				</tr>

				<tr>
					<td width="200">&nbsp;</td>
					<td width="400" align="left">
						<?
						$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
						foreach ($nameArray as $result)
						{
							?>
							Plot No: <? echo $result[csf('plot_no')]; ?>
							Level No: <? echo $result[csf('level_no')]?>
							Road No: <? echo $result[csf('road_no')]; ?>
							Block No: <? echo $result[csf('block_no')];?>
							City No: <? echo $result[csf('city')];?>
							Zip Code: <? echo $result[csf('zip_code')]; ?>
							Province No: <?php echo $result[csf('province')]; ?>
							Country: <? echo $country_arr[$result[csf('country_id')]]; ?><br>
							Email Address: <? echo $result[csf('email')];?>
							Website No: <? echo $result[csf('website')];
						}
							?>

					</td>
					<td width="100">&nbsp;</td>
					<td width="300" align="left"><b>Booking Date: </b><?php echo change_date_format($nameArray_per_job[0][csf("booking_date")]); ?></td>
				</tr>

				<tr>
					<td width="200">&nbsp;</td>
					<td width="400" align="left" style="font-size: 16px;"><b>Fabric Booking Sheet </b></td>
					<td width="100">&nbsp;</td>
					<td width="300" align="left"><b>Delivery Date: </b><?php echo change_date_format($nameArray_per_job[0][csf("delivery_date")]); ?></td>
				</tr>

				<tr>
					<td colspan="3" width="700">&nbsp;</td>
					<td width="300" align="left"><b>Approval Status: </b><?php if ($nameArray_per_job[0][csf("is_approved")] == 1 || $nameArray_per_job[0][csf("is_approved")] == 3) {echo "Approved";}?></td>
				</tr>
				<tr>
					<td colspan="4" height="10">&nbsp;</td>
				</tr>

				<tr>
					<td width="300"><b>To</b></td>

					<td width="400" align="left"><b>Buyer Name :   </b> <? echo $buyer_name_arr[$nameArray_per_job[0][csf("buyer_id")]]; ?></td>
					<td align="left"><b>Season : </b>&nbsp;<? echo $seasons;?></td>



				</tr>
				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<tr>
					<td width="300"><?
					$pay_mode=$nameArray_per_job[0][csf("pay_mode")];//pay_mode
					if($pay_mode!=3 && $pay_mode!=5)
					{
						echo $supplier_name_arr[$nameArray_per_job[0][csf("supplier_id")]];
					}
					else
					{
						echo $company_library[$nameArray_per_job[0][csf("supplier_id")]];
					}?></td>

					<td width="400" align="left"><b>Order Qnty :   </b> <? echo $po_qnty_all_style[0][csf("qnty")]; ?>&nbsp;<? echo $unites;?></td>
					<td><b>Dept : </b> &nbsp;<? echo $depts; ?></td>
					<td></td>


				</tr>
				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<tr>
					<!-- <td width="300" ><p><b>Address: </b><? echo $supplier_address_arr[$nameArray_per_job[0][csf("supplier_id")]]; ?> </p></td> -->

					<td width="400" align="left"><b>Dealing Merchandiser:   </b> <? echo $marchentrArr[$nameArray_per_job[0][csf("dealing_marchant")]]; ?></td>

					<td width="300"><b>Attention: </b>   <? echo $nameArray_per_job[0][csf("attention")];?></td>

				   <td width="400" align="left"><b>Currency:   </b> <? echo $currency[$nameArray_per_job[0][csf("currency_id")]]; ?></td>
				</tr>
				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<!-- <tr>
				   <td colspan="2" width="800"><b>Shipment Date: </b><? echo trim($shipment_dates);?></td>

				</tr> -->


				<tr>
					<td height="2">&nbsp;</td>
				</tr>

				<tr>
				   <td width="300"><b>WO Prepared After:   </b>    </td>

				   <td width="400" align="left"><b>Remarks:   </b> <? echo $nameArray_per_job[0][csf("remarks")]; ?></td>


				</tr>
			</thead>
		</table>


			<?php
$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and a.status_active =1 and a.is_deleted=0");
list($nameArray_approved_row) = $nameArray_approved;
$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
list($nameArray_approved_date_row) = $nameArray_approved_date;
$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
list($nameArray_approved_comments_row) = $nameArray_approved_comments;

$po_data = array();
if ($db_type == 0) {
	$nameArray_job = sql_select("select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,DATEDIFF(pub_shipment_date,po_received_date) date_diff,MIN(po_received_date) as po_received_date ,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status  from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id)  group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
}
if ($db_type == 2) {
	$nameArray_job = sql_select("select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,(pub_shipment_date-po_received_date) date_diff,MIN(po_received_date) as po_received_date,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status   from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id) group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
}
foreach ($nameArray_job as $result_job) {
	$po_data['po_id'][$result_job[csf('id')]] = $result_job[csf('id')];
	$po_data['po_number'][$result_job[csf('id')]] = $result_job[csf('po_number')];
	$po_data['leadtime'][$result_job[csf('id')]] = $result_job[csf('date_diff')];
	$po_data['po_quantity'][$result_job[csf('id')]] = $result_job[csf('po_quantity')];
	$po_data['po_received_date'][$result_job[csf('id')]] = change_date_format($result_job[csf('po_received_date')], 'dd-mm-yyyy', '-');
	$ddd = strtotime($result_job[csf('pub_shipment_date')]);
	$po_data['pub_shipment_date'][$ddd] = $ddd;

	$po_data['insert_date'][$result_job[csf('id')]] = $result_job[csf('insert_date')];

	if ($result_job[csf('shiping_status')] == 1) {
		$shiping_status = "FP";
	} else if ($result_job[csf('shiping_status')] == 2) {
		$shiping_status = "PS";
	} else if ($result_job[csf('shiping_status')] == 3) {
		$shiping_status = "FS";
	}
	$po_data['shiping_status'][$result_job[csf('id')]] = $shiping_status;
	$po_data['file_no'][$result_job[csf('id')]] = $result_job[csf('file_no')];

	$po_data['grouping'][$result_job[csf('id')]] = $result_job[csf('grouping')];
}
$txt_order_no_id = implode(",", array_unique($po_data['po_id']));
$leadtime = implode(",", array_unique($po_data['leadtime']));
$po_quantity = array_sum($po_data['po_quantity']);
$po_received_date = implode(",", array_unique($po_data['po_received_date']));
$po_number = implode(",", array_unique($po_data['po_number']));
$shipment_date = date('d-m-Y', min($po_data['pub_shipment_date']));
$maxshipment_date = date('d-m-Y', max($po_data['pub_shipment_date']));
//$shipment_date=implode(",",array_unique($po_data['pub_shipment_date']));
$shiping_status = implode(",", array_unique($po_data['shiping_status']));
$file_no = implode(",", array_unique($po_data['file_no']));
$grouping = implode(",", array_unique($po_data['grouping']));

$colar_excess_percent = 0;
$cuff_excess_percent = 0;
$rmg_process_breakdown = 0;
$nameArray = sql_select("select a.buyer_id,a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.update_date,a.uom,a.remarks,a.pay_mode,a.fabric_composition from wo_booking_mst a  where   a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0");
foreach ($nameArray as $result) {
	$total_set_qnty = $result[csf('total_set_qnty')];
	$colar_excess_percent = $result[csf('colar_excess_percent')];
	$cuff_excess_percent = $result[csf('cuff_excess_percent')];
	$rmg_process_breakdown = $result[csf('rmg_process_breakdown')];
	foreach ($po_data['po_id'] as $po_id => $po_val) {
		$daysInHand .= (datediff('d', date('d-m-Y', time()), $po_data['pub_shipment_date'][$po_id]) - 1) . ",";
		$booking_date = $result[csf('update_date')];
		if ($booking_date == "" || $booking_date == "0000-00-00 00:00:00") {
			$booking_date = $result[csf('insert_date')];
		}
		$WOPreparedAfter .= (datediff('d', $po_data['insert_date'][$po_id], $booking_date) - 1) . ",";
	}

}

?>
			<br/>
			<!--  Here will be the main portion  -->
			<?
			$costing_per="";
			$costing_per_qnty=0;
			$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no in($job_no_in)");
			if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;

			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";
				$costing_per_qnty=1;

			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;

			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;

			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;
			}
			$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no in($job_no_in)");
			$uom_arr=array(1=>"Pcs",12=>"Kg",23=>"Mtr",27=>"Yds");
			$p=1;

		if($cbo_fabric_source==1 || $cbo_fabric_source==2 || $cbo_fabric_source==3)
		{
			$nameArray_qty_arr = sql_select("select b.job_no_mst,b.id,a.style_ref_no,c.item_number_id,c.color_number_id,c.order_quantity   from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where  a.job_no=b.job_no_mst and c.po_break_down_id=b.id and a.job_no=c.job_no_mst and a.status_active =1 and b.status_active =1 and c.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id) and b.id in($txt_order_no_id)  ");
		//echo "select b.job_no_mst,b.id,a.style_ref_no,c.item_number_id,c.color_number_id,c.order_quantity   from wo_po_details_master a, wo_po_break_down b,wo_po_color_size_breakdown c where  a.job_no=b.job_no_mst and c.po_break_down_id=b.id and a.status_active =1 and c.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id) and b.id in($txt_order_no_id)  ";
			foreach($nameArray_qty_arr as $row)
			{
				$gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][40]+=$row[csf('order_quantity')];
				$gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]][50]+=$row[csf('order_quantity')];
				$fab_gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('color_number_id')]]+=$row[csf('order_quantity')];
				$gmts_color_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]]['color'].=$row[csf('color_number_id')].',';
			}

			$nameArray_fabric_description= sql_select("SELECT a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.body_part_type,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , b.dia_width,d.pre_cost_remarks,a.uom,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,avg(d.rate) as rates,sum(d.amount) as amounts ,d.fabric_color_id,a.color_size_sensitive,a.color_break_down,min(c.color_order) as color_order,c.job_no_mst,sum(c.order_quantity) as order_quantity_pcs,avg(b.cons) as cad_consumption,avg(b.requirment) as consumption,avg(b.process_loss_percent) as wastage,sum(d.fin_fab_qnty) as fin_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_number_id=d.gmts_color_id and
				b.dia_width=d.dia_width and
				b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id
				and
				d.booking_no =$txt_booking_no and
				d.job_no in ($all_jobs_id) and

				d.status_active=1 and
				c.status_active=1 and
				d.is_deleted=0 and
				b.cons>0
				group by a.id,a.item_number_id,a.body_part_id,a.body_part_type,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,b.dia_width,d.pre_cost_remarks,a.uom ,d.fabric_color_id,a.color_size_sensitive,a.color_break_down,c.job_no_mst  order by a.body_part_id,d.fabric_color_id ");


			$uom_data_arr=array();$b_part_array_not=array(40,50);
			foreach($nameArray_fabric_description as $row)
			{
				if(!in_array($row[csf('body_part_type')],$b_part_array_not))
				{
					$uom_data_arr[$row[csf('uom')]]=$row[csf('uom')];
				}
				if($row[csf('body_part_type')]==40 || $row[csf('body_part_type')]==50)
				{
					//$gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('fabric_color_id')]][$row[csf('body_part_type')]]+=$row[csf('order_quantity_pcs')];
					$gmts_qty_data_arr[$row[csf('job_no_mst')]][$row[csf('item_number_id')]][$row[csf('gmts_color_id')]][$row[csf('body_part_type')]]=$row[csf('order_quantity_pcs')];
				}
			}

			foreach($uom_data_arr as $uom_id=>$uom_val)
			{
				if(count($nameArray_fabric_description)>0)
				{

					?>

						<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
									<caption> <strong>Fabric Booking Summary </strong> </caption>
									<tr>
										<th  width="30" align="center">SL</th>
										<th  width="150" align="center">Style</th>
										<th  width="140" align="center">Gmts Item</th>
										<th  width="130" align="center">Body Parts</th>
										<th  width="100" align="center">Gmts Qty (Pcs)</th>
										<th  width="390" align="left">Fabric Composition</th>
										<th  width="40" align="center">GSM</th>
										<th  width="90" align="center">Fabric Dia</th>
										<th  width="100" align="center">Color Type</th>
										<th  width="100" align="center">Combo</th>
										<th  width="110" align="center">Fabric Color</th>
										<th  width="80" align="center">CAD Consumption (Kg/Dzn)</th>
										<th  width="80" align="center">Wastage %</th>
										<th  width="80" align="center">Consumption (Kg/Dzn)</th>
										<th  width="60" align="center">UOM</th>
										<!-- <th width='120' align="center"></th> -->
										<th width='120' align="center" title="Based on avg grey consumption">Finish Fab. Qty</th>
										<th width='100' align="center">Avg Rate/<? echo $unit_of_measurement[$uom_id];?></th>
										<th width='60' align="center">Amount</th>

									</tr>
									<? //wo_pre_cos_fab_co_color_dtls
									$color_wise_process_loss=sql_select("SELECT  a.body_part_id,b.color_number_id,avg(b.process_loss_percent) as loss FROM  wo_pre_cos_fab_co_avg_con_dtls  b,wo_pre_cost_fabric_cost_dtls a WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and  a.job_no in ($all_jobs_id)  group by a.body_part_id,b.color_number_id order by a.body_part_id,b.color_number_id");
									//echo "SELECT  a.body_part_id,b.color_number_id,avg(b.process_loss_percent) as loss,g.contrast_color_id FROM  wo_pre_cos_fab_co_avg_con_dtls  b,wo_pre_cost_fabric_cost_dtls a left join wo_pre_cos_fab_co_color_dtls g on a.job_no=g.job_no and a.id=g.pre_cost_fabric_cost_dtls_id 	WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and  a.job_no in ($all_jobs_id)  group by a.body_part_id,b.color_number_id,g.contrast_color_id";

									foreach($color_wise_process_loss as $val)
									{
										$loss_arr[$val[csf("body_part_id")]][$val[csf("color_number_id")]]=$val[csf("loss")];

									}

									$total_fin_fab_qnty=$total_gmt_qty_pcs=0;  $total_amount=0;  $total_grey_fab_qnty=0 ;$tot_avg=0;
									foreach($nameArray_fabric_description as $val)
									{
										if($val[csf('pre_cost_remarks')]!='') $remark_cond=" and d.pre_cost_remarks='".$val[csf('pre_cost_remarks')]."' "; else $remark_cond=" and d.pre_cost_remarks is null";
										$color_wise_wo_sql_qnty=sql_select("SELECT  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
											WHERE
											a.job_no=d.job_no and
											a.id=d.pre_cost_fabric_cost_dtls_id and
											d.booking_no =$txt_booking_no and
											d.job_no = '".$val[csf('job_no_mst')]."' and
											a.item_number_id='".$val[csf('item_number_id')]."' and
											a.body_part_id='".$val[csf('body_part_id')]."' and
											a.color_type_id='".$val[csf('color_type_id')]."' and
											a.construction='".$val[csf('construction')]."' and
											a.composition='".$val[csf('composition')]."' and
											a.gsm_weight='".$val[csf('gsm_weight')]."' and
											d.dia_width='".$val[csf('dia_width')]."' and
											a.id='".$val[csf('fabric_cost_dtls_id')]."' and
											a.uom='".$uom_id."' and

											d.fabric_color_id='".$val[csf('fabric_color_id')]."' and
											d.status_active=1 and
											d.is_deleted=0 $remark_cond
											");
										if($uom_id==$val[csf('uom')])
										{
											if($val[csf('pre_cost_remarks')]=='no remarks')  $pre_cost_remarks="";else  $pre_cost_remarks=$val[csf('pre_cost_remarks')];

											//$order_quantity_pcs=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$val[csf('fabric_color_id')]];
											//$order_quantity_pcs=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$val[csf('gmts_color_id')]];
											$order_quantity_pcs=0;
											if($val[csf('color_size_sensitive')]==1 or $val[csf('color_size_sensitive')]==2 or $val[csf('color_size_sensitive')]==4)
											{
												$gmt_colorName=$color_library[$val[csf('fabric_color_id')]];
												$order_quantity_pcs+=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$val[csf('fabric_color_id')]];
											}
											else
											{
												$color_break_down=$val[csf('color_break_down')];
												if($color_break_down)
												{
													$gmts_color="";
													if (strpos($color_break_down, '__') !== false)
													{
														$color_break_down=explode('__', $color_break_down);
														foreach ($color_break_down as $key => $value)
														{
															$cols=explode('_', $value);
															if(trim(strtolower($color_library[$val[csf('fabric_color_id')]]))==trim(strtolower($cols[2])))
															{
																if($gmts_color=="")
																{
																	$gmts_color=$cols[1];
																$order_quantity_pcs=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];

																}
																else
																{
																	$gmts_color .=','.$cols[1];
																$order_quantity_pcs+=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];

																}

															}
														}
													}
													else
													{
														$cols=explode('_', $color_break_down);
														if(trim(strtolower($color_library[$val[csf('fabric_color_id')]]))==trim(strtolower($cols[2])))
														{
															if($gmts_color=="")
															{
																$gmts_color=$cols[1];
																$order_quantity_pcs=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];

															}
															else
															{
																$gmts_color .=','.$cols[1];
																$order_quantity_pcs+=$fab_gmts_qty_data_arr[$val[csf('job_no_mst')]][$val[csf('item_number_id')]][$cols[0]];

															}

														}
													}

													$gmt_colorName=$gmts_color;
												}

											}

											?>
											<tr>
												<td align="center"> <? echo $p; $p++;?></td>


												<td align="center"> <? echo $all_job_arr[$val[csf("job_no_mst")]]["style"];?></td>
												<td align="center"> <? echo $garments_item[$val[csf("item_number_id")]];?></td>
												<td align="center"><? echo $body_part[$val[csf('body_part_id')]];?></td>
												<td align="center"><? echo number_format($order_quantity_pcs,2);?></td>
												<td align="left"> <? echo $val[csf('construction')].','.$val[csf('composition')].', '.$pre_cost_remarks; ?> </td>

												<td  align="center">
													<?
													echo $val[csf('gsm_weight')];
													?>
												</td>

												<td  align="center">
													<?
													echo $val[csf('dia_width')];
													?>
												</td>

												<td  align="center">
													<?
													echo $color_type[$val[csf('color_type_id')]];
													?>
												</td>
												<td  align="center">
													<?
													echo $gmt_colorName;
													?>
												</td>


												<td  align="center">
													<?
													echo $color_library[$val[csf('fabric_color_id')]];
													?>
												</td>


												<td align="center"> <? echo $val[csf('cad_consumption')]; ?></td>
												<td align="center"> <? echo $val[csf('wastage')]; ?>%</td>
												<td align="center"> <? echo def_number_format($val[csf('consumption')],2); ?></td>
												<td align="center"> <? echo $unit_of_measurement[$val[csf('uom')]]; ?></td>

												<!-- <td align="center"> <?   //$greys= $color_wise_wo_sql_qnty[0][csf("grey_fab_qnty")] /(1+($loss_arr[$val[csf("body_part_id")]][$val[csf("fabric_color_id")]]/100)) ;
													//echo def_number_format($greys,2);
													
													$val[csf('fin_fab_qnty')]='';
													$val[csf('fin_fab_qnty')]=$color_wise_wo_sql_qnty[0][csf("fin_fab_qnty")];

													?> </td> -->



													<td align="center"> <? echo def_number_format($val[csf('fin_fab_qnty')],2); ?> </td>
													<td align="center"> <? echo def_number_format($color_wise_wo_sql_qnty[0][csf("amount")]/$val[csf('fin_fab_qnty')],2); ?> </td>
													<td align="center"> <? echo def_number_format($color_wise_wo_sql_qnty[0][csf("amount")],2); ?> </td>


													<?

													$total_fin_fab_qnty +=str_replace(",", "", def_number_format($greys,2));
													$total_amount +=str_replace(",", "",def_number_format($color_wise_wo_sql_qnty[0][csf("amount")],2));

													$total_grey_fab_qnty +=str_replace(",", "",def_number_format($val[csf('fin_fab_qnty')],2));
													$total_rate +=str_replace(",", "",def_number_format($color_wise_wo_sql_qnty[0][csf("rate")],2));
													$tot_avg=$total_amount/$total_grey_fab_qnty;
													$total_gmt_qty_pcs +=$order_quantity_pcs;


													?>



												</tr>
												<?
										}

									}
										?>
									<tr style=" font-weight:bold">

									<td  align="right" colspan="4"><strong>Total</strong></td>
									 <td align="right"><? //echo def_number_format($total_gmt_qty_pcs,2);?></td>
									<td  align="right" colspan="10">&nbsp;</td>

									<td align="center"><? echo def_number_format($total_grey_fab_qnty,2);?></td>
									<td align="center"><? echo def_number_format($tot_avg,2);?></td>
									<td align="center"><? echo def_number_format($total_amount,2);?></td>

									</tr>

						</table>

					<?
				}
			}
		}


		$sql_data=sql_select("SELECT a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,a.uom,b.dia_width,b.pre_cost_remarks,b.fabric_color_id,b.remark, sum(b.grey_fab_qnty) as grey_fab_qnty,sum(b.adjust_qty)as adjust_qty FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in($all_jobs_id) and b.adjust_qty>0 and b.status_active=1 and b.is_deleted=0 group by a.id,a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,a.uom,b.dia_width,b.pre_cost_remarks,b.fabric_color_id,b.remark and a.body_part_type not in(40,50) order by a.id,a.body_part_id");
		if(count($sql_data)>0)
		{

					?>
					<br/>
			<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

					<tr>
						<td colspan="7" align="center">
							<strong>Fabric Stock Adjustment Details</strong>
						</td>

					</tr>

					<tr>
						<td align="center"> SL </td>
						<td align="center"> Item Description </td>
						<td align="center"> Fabric Color </td>
						<td align="center">UOM</td>
						<td align="center">Adjusted Qty </td>


					</tr>
					<?
					$p=1;
					foreach($sql_data as $row)
					{
						?>
						<tr>
							<td align="center"><? echo $p;?></td>
							<td align="center">
								<? echo $body_part[$row[csf('body_part_id')]].",".$row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$row[csf('dia_width')].','.$fabric_typee[$row[csf('width_dia_type')]].",".$color_type[$row[csf('color_type_id')]] ?>
							</td>

							<td align="center">
								<? echo $color_library[$row[csf('fabric_color_id')]];  ?>
							</td>
							<td align="center">
								<? echo $unit_of_measurement[$row[csf('uom')]];  ?>
							</td>


							<td align="center">
								<? echo number_format($row[csf('adjust_qty')],4) ; ?>
							</td>

						</tr>
						<?
						$p++;
					}
		}
					?>
			</table>
			<br>
				<div style="width:1330px" align="center" >
			  		<table  width="100%"  border="0" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

			  			<tr>
			  				<td colspan="10" align="center">
			  					<strong>Collar and Cuff & Other Flat Knit Fabric Breakdown</strong>
			  				</td>

			  			</tr>
			  		</table>

	        <?
	     	  $sql_collar_cuff= "SELECT a.rate, a.amount, a.job_no , a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.width_dia_type, b.gmts_color_id, b.size_number_id, b.item_size, b.gmts_qty, b.excess_per, b.qty, b.po_break_down_id as po_id, b.id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id) and a.body_part_type=40 and b.status_active=1 and b.is_deleted=0  order by a.body_part_id,b.gmts_color_id,b.id " ;
	     	  //echo $sql_collar_cuff; die;
	         $sql_data_collar_cuff=sql_select($sql_collar_cuff);
	         $size_id_array=array();
	         $size_with_item_size_array=array();
	         foreach($sql_data_collar_cuff as $vals)
	         {
	         	$body_part_cuff_array[$vals[csf("body_part_id")]]=$vals[csf("body_part_id")];
				$size_id_array[$vals[csf("size_number_id")]]=$vals[csf("size_number_id")];
	         	$size_with_item_size_array[$vals[csf("size_number_id")]][$vals[csf("body_part_id")]]=$vals[csf("item_size")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["grey"]+=$vals[csf("qty")];

	         	//$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]=$vals[csf("excess_per")];
				if($vals[csf("excess_per")]>0)
				{
				$color_wise_excess_per_arr[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]+=$vals[csf("excess_per")];
				$color_wise_excess_per_arr[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_excess_per"]+=1;
				}
	         	$color_wise_qnty[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$color_wise_qnty[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["grey"]+=$vals[csf("qty")];
	         	/*$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];*/

	         	//$color_wise_qnty[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["amount"]=$vals[csf("amount")];
				$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_rate"]=1;

	         }
			unset($sql_data_collar_cuff);
	         $sql_collar_cuff3 = sql_select("SELECT c.rate, a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id, c.gmts_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls c WHERE a.job_no=c.job_no and a.id=c.pre_cost_fabric_cost_dtls_id and  a.id=c.pre_cost_fabric_cost_dtls_id and c.booking_no =$txt_booking_no and c.job_no in ($all_jobs_id) and a.body_part_type=40 and c.status_active=1 and c.is_deleted=0  order by a.body_part_id");

	         foreach($sql_collar_cuff3 as $vals)
	         {

	         	$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];

	         }


	         $counts=count($size_id_array);


	         $size_wise_qnty_array=array();
	         ?>


			 <?
	          if(count($body_part_cuff_array)>0)
	          {		$grand_size_wise_qnty_array=array();
			  		$gr_collor_qty=0;
					 $gr_col_avg_price=0;
					 $gr_col_avg_row=0;
					 $gr_amount=0;
					 $gr_excess=0;
					foreach($body_part_cuff_array as $bpart_id=>$val)
					{
					// $sql_collar_cuff2= "SELECT a.rate,a.amount, a.job_no , a.id as fabric_cost_dtls_id,a.color_size_sensitive,a.color_break_down, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,b.gmts_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and a.body_part_id=$bpart_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id) and a.body_part_type=40  and b.status_active=1 and b.is_deleted=0  group by  a.rate,a.amount, a.job_no , a.id ,a.color_size_sensitive,a.color_break_down, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition,a.gsm_weight,a.width_dia_type,b.gmts_color_id  order by a.body_part_id,b.gmts_color_id  " ;

					$sql_collar_cuff2= " SELECT a.rate,
									         a.amount,
									         a.job_no,
									         a.id as fabric_cost_dtls_id,
									         a.color_size_sensitive,
									         a.item_number_id,
									         a.body_part_id,
									         a.color_type_id,
									         a.construction,
									         a.composition,
									         a.gsm_weight,
									         a.width_dia_type,
									         b.gmts_color_id
									    from wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b,wo_booking_dtls c ,wo_pre_cos_fab_co_avg_con_dtls d
									    where     a.job_no = b.job_no
									         and a.id = b.pre_cost_fabric_cost_dtls_id
									         and b.booking_no=c.booking_no
									         and b.po_break_down_id=c.po_break_down_id
									         and b.pre_cost_fabric_cost_dtls_id=c.pre_cost_fabric_cost_dtls_id
									         and b.gmts_color_id=c.gmts_color_id
									        and  a.id=d.pre_cost_fabric_cost_dtls_id
									        and d.gmts_sizes=b.size_number_id
									        and c.status_active = 1
									        and c.is_deleted = 0
								         and a.body_part_id=$bpart_id 
								         and b.booking_no =$txt_booking_no 
								         and b.job_no in ($all_jobs_id) 
								         and a.body_part_type=40  
								         and b.status_active=1 
								         and b.is_deleted=0 
								    group by  a.rate,a.amount, a.job_no , a.id ,a.color_size_sensitive,a.color_break_down, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition,a.gsm_weight,a.width_dia_type,b.gmts_color_id  order by a.body_part_id,b.gmts_color_id  " ;
	          $sql_data_collar_cuff2=sql_select($sql_collar_cuff2);
					?>
					 <table align="left"  width="100%" style="margin-top: 5px;" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" >
			  			<tr>
			  				<td colspan="<? echo $counts+13;?>" align="center">
			  					<strong>Collar Details(<? echo $body_part[$bpart_id];?>)</strong>
			  				</td>

			  			</tr>
			  			<tr>
			  				<td  width="30"  rowspan="2" align="center"><strong>SL</strong> </td>
			  				<td  width="150" rowspan="2" align="center"><strong>Style</strong></td>
 			  				<td  width="140"  rowspan="2" align="center"><strong>Gmts Item</strong></td>
 			  				<td  width="100"  rowspan="2" align="center"><strong>Body Part</strong></td>
							<td  width="100" rowspan="2" align="center"><strong>Actual Qty(Pcs)</strong></td>
			  				<td  width="390" rowspan="2" align="left">&nbsp;&nbsp;<strong>Collar Composition</strong></td>
			  				<td  width="100"  rowspan="2" align="center"><strong>Color Type</strong></td>
 			  				<td  width="100"  rowspan="2"  align="center"><strong>Combo</strong></td>
							<td  width="100"  rowspan="2"  align="center"><strong>Fabric Color</strong></td>
 			  				<?
 			  				foreach($size_id_array as $id=>$val)
 			  				{
 			  					?>
 			  					<td width="40" align="center"><strong><? echo $size_library[$id];?></strong></td>

 			  					<?
 			  				}
 			  				?>
			  				<td width="60"  rowspan="2" align="center"><strong> Req Qty (Pcs)</strong> </td>
			  				<td  width="50" rowspan="2"  align="center"><strong> Excess %  </strong> </td>
			  				<td width="50" rowspan="2"  align="center"><strong>Price/Pcs</strong></td>
			  				<td  width="40" rowspan="2" align="center"><strong>Amount</strong></td>


			  			</tr>
			  			<tr>
			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					//$size_with_item=rtrim($size_with_item_size_array[$id],',');
								//$size_with_item=implode(",",array_unique(explode(",",$size_with_item)));
								?>
			  					<td  align="center"><? echo $size_with_item_size_array[$id][$bpart_id];?></td>

			  					<?
			  				}
			  				?>

			  			</tr>
			  			<?
			  			$p=1;
			  			foreach($sql_data_collar_cuff2 as $row)
			  			{

							?>
			  				<tr>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="30" align="center"><? echo $p;?></td>
			  					<td style="word-break: break-all;word-wrap: break-word;" width="150" align="center"><? echo $job_wise_style[$row[csf("job_no")]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="140" align="center"><?  $item_id= $row[csf('item_number_id')];echo $garments_item[$item_id]; ?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center"><? echo $body_part[$row[csf("body_part_id")]];?></td>
								<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center"><? $gmt_actual_qty=$gmts_qty_data_arr[$row[csf('job_no')]][$item_id][$row[csf('gmts_color_id')]][40];echo number_format($gmt_actual_qty,0);$total_gmt_actual_qty+=$gmt_actual_qty;?></td>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="390" align="left"> &nbsp;
			  						<? echo $row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$fabric_typee[$row[csf('width_dia_type')]] ;?>
			  					</td>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="100" align="center"><? echo $color_type[$row[csf('color_type_id')]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center">
			  						<? echo $color_library[$row[csf('gmts_color_id')]];  ?>
			  					</td>
								<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center">
			  						<?
										if($row[csf('color_size_sensitive')]==1 or $row[csf('color_size_sensitive')]==2 or $row[csf('color_size_sensitive')]==4)
										{
											$gmt_fab_color=$color_library[$row[csf('gmts_color_id')]];
										}
										else
										{
											$contrast_color_id=return_field_value("b.contrast_color_id as contrast_color_id", "wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b", "a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.job_no in ($all_jobs_id) and a.id=".$row[csf('fabric_cost_dtls_id')]."  and b.gmts_color_id=".$row[csf('gmts_color_id')]." ","contrast_color_id");//pre_cost_fabric_cost_dtls_id
											if($contrast_color_id>0)
											{
												$gmt_fab_color=$color_library[$contrast_color_id];
											}
										}
									echo $gmt_fab_color;  ?>
			  					</td>


			  					<?
								$color_qty=0; $greyQty=0;
			  					foreach($size_id_array as $id=>$val)
			  					{
			  						?>
			  						<td  style="word-break: break-all;word-wrap: break-word;" width="40"  align="center"><? echo $cuff_grey_qty=$size_item_wise_qnty[$row[csf("body_part_id")]][$row[csf("fabric_cost_dtls_id")]][$row[csf("gmts_color_id")]][$id][$size_with_item_size_array[$id][$bpart_id]]["grey"];//.'K '.$row[csf("fabric_cost_dtls_id")].'='.$row[csf("gmts_color_id")].'='.$id.'='.$size_with_item_size_array[$id];
									?></td>

			  						<?
			  						$size_wise_qnty_array[$id]+=$val;
									$grand_size_wise_qnty_array[$id]+=$cuff_grey_qty;$sub_size_wise_qnty_array[$bpart_id][$id]+=$cuff_grey_qty;
									$color_qty+=$cuff_grey_qty;

			  					}
								$row_excess_per= $color_wise_excess_per_arr[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf("gmts_color_id")]][$item_id]["row_excess_per"];
			  					?>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="60" align="center">
			  						<? echo $grey_qnty=$color_qty;//$color_wise_qnty[$row[csf('gmts_color_id')]][$item_id]["grey"];  ?>
			  					</td>

			  					<td  style="word-break: break-all;word-wrap: break-word;" title="<? echo $row_excess_per;?>" width="50" align="center">
			  						<?  $excess= $color_wise_excess_per_arr[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf("gmts_color_id")]][$item_id]["excess_per"]/$row_excess_per;
									echo number_format($excess,2);
									  ?>
			  					</td>


			  					<td style="word-break: break-all;word-wrap: break-word;" title="<? echo $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["row_rate"];?>"  width="50" align="center">
			  						<? echo  $cuff_price=$color_wise_qnty2[$row[csf("fabric_cost_dtls_id")]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["rate"];
										//$tot_row_rate=$color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["row_rate"];  ?>
			  					</td>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="40" align="center">
			  						<? echo $amount=$grey_qnty*$cuff_price;   ?>
			  					</td>
			  				</tr>
			  				<?

							$sub_collor_qty_arr[$row[csf("body_part_id")]]+=$grey_qnty;
							$sub_collor_amount_arr[$row[csf("body_part_id")]]+=$amount;

							$sub_excess_arr[$row[csf("body_part_id")]]+=$excess;
							$sub_price_arr[$row[csf("body_part_id")]]+=$cuff_price;
							$cuff_body_wise_avg_row[$row[csf("body_part_id")]]+=1;

							$gr_fin_qty+=$fin_qty;
			  				$gr_collor_qty+=$grey_qnty;
							$gr_amount+=$amount;
			  				$gr_excess+=$excess ;
			  				$gr_col_avg_price+=$cuff_price;
			  				$gr_col_avg_row++;



			  				$p++;
			  			}
			  			?>
						<tr class="tbl_bottom">
							<td colspan="9" align="right">Total </td>
							<?
							foreach($size_id_array as $id=>$val)
							{
								?>
								<td  align="center"><? echo $sub_size_wise_qnty_array[$bpart_id][$id];?></td>

								<?
							}
							$cuff_sub_excess=$sub_excess_arr[$bpart_id];
							$cuff_sub_price=$sub_price_arr[$bpart_id];
							$cuff_body_wise_avg_tot_row=$cuff_body_wise_avg_row[$bpart_id];
							?>
							<td align="center">
								<? echo $sub_collor_qty_arr[$bpart_id];  ?>
							</td>
							<td align="center" title="Sub Exess & sub Row=<? echo $cuff_sub_excess.'='.$cuff_body_wise_avg_tot_row ?>">
									<? echo number_format($cuff_sub_excess/$cuff_body_wise_avg_tot_row,2); ?></td>
							<td align="center"><? echo number_format($cuff_sub_price/$cuff_body_wise_avg_tot_row,2); ?></td>

							<td align="center">
								<? echo $sub_collor_amount_arr[$bpart_id];   ?>
							</td>
			  			</tr>
						<!--Sub TOT End-->


			  			<?
						} //Body Part End
						?>

						<tr>
			  				<td colspan="9" align="right">Grand Total </td>
			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td  align="center"><? echo $grand_size_wise_qnty_array[$id];?></td>

			  					<?
			  				}
			  				?>
			  				<td align="center">
			  					<? echo $gr_collor_qty;  ?>
			  				</td>
			  				<td align="center" title="Sub Exess & Tot Row=<? echo $gr_excess.'='.$gr_avg_row ?>"><? echo number_format($gr_excess/$gr_col_avg_row,2); ?></td>
							<td align="center"  title="Tot Price  & Tot Row=<? echo $gr_col_avg_price.'='.$gr_col_avg_row.'**'.$p?>"><? //echo number_format($gr_col_avg_price/$gr_col_avg_row,2); ?></td>

			  				<td align="center">
			  					<? echo $gr_amount;   ?>
			  				</td>
			  			</tr>

						</table>
						<?
			  		}
			  	?>


					<br/><br/>

						<?
	     	  $sql_collar_cuff= "SELECT a.rate,a.amount, a.job_no , a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,b.gmts_color_id,b.size_number_id,b.item_size,b.gmts_qty,b.excess_per,b.qty,b.po_break_down_id as po_id,b.id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id) and a.body_part_type=50 and b.status_active=1 and b.is_deleted=0  order by a.body_part_id,b.gmts_color_id,b.id " ;
	         $sql_data_collar_cuff=sql_select($sql_collar_cuff);
	         $size_id_array=array();
	         $size_with_item_size_array=array();
	         $size_item_wise_qnty=array();
	         $color_wise_qnty=array();
	         foreach($sql_data_collar_cuff as $vals)
	         {
	         	$body_part_array[$vals[csf("body_part_id")]]=$vals[csf("body_part_id")];
				$size_id_array[$vals[csf("size_number_id")]]=$vals[csf("size_number_id")];
	         	$size_with_item_size_array[$vals[csf("size_number_id")]][$vals[csf("body_part_id")]]=$vals[csf("item_size")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["grey"]+=$vals[csf("qty")];

	         	//$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]=$vals[csf("excess_per")];
				if($vals[csf("excess_per")]>0)
				{
				$color_wise_excess_per_cuff_arr[$vals[csf('fabric_cost_dtls_id')]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]+=$vals[csf("excess_per")];
				$color_wise_excess_per_cuff_arr[$vals[csf('fabric_cost_dtls_id')]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_excess_per"]+=1;
				}
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["grey"]+=$vals[csf("qty")];
	         	/*$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];*/
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["amount"]=$vals[csf("amount")];
				$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_rate"]=1;

	         }
				unset($sql_data_collar_cuff);
	         $sql_collar_cuff3 = sql_select("SELECT c.rate, a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id, c.gmts_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls c WHERE a.job_no=c.job_no and a.id=c.pre_cost_fabric_cost_dtls_id and  a.id=c.pre_cost_fabric_cost_dtls_id and c.booking_no =$txt_booking_no and c.job_no in ($all_jobs_id) and a.body_part_type=50 and c.status_active=1 and c.is_deleted=0  order by a.body_part_id");

	         foreach($sql_collar_cuff3 as $vals)
	         {

	         	$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];

	         }


	         $counts=count($size_id_array);$grand_size_wise_qnty_array=array();
	          if(count($body_part_array)>0)
	          {
					$gr_collor_qty=$gr_amount=$gr_avg_price=$gr_avg_row=$gr_excess=0;
					foreach($body_part_array as $bpart_id=>$val)
					{
					// $sql_collar_cuff2= "SELECT a.rate,a.amount, a.job_no , a.id as fabric_cost_dtls_id,a.color_size_sensitive, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,b.gmts_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and a.body_part_id=$bpart_id and b.job_no in ($all_jobs_id) and a.body_part_type=50  and b.status_active=1 and b.is_deleted=0  group by  a.rate,a.amount, a.job_no , a.id , a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition,a.gsm_weight,a.width_dia_type,b.gmts_color_id,a.color_size_sensitive  order by a.body_part_id,b.gmts_color_id  " ;

					$sql_collar_cuff2= "SELECT a.rate,
								         a.amount,
								         a.job_no,
								         a.id as fabric_cost_dtls_id,
								         a.color_size_sensitive,
								         a.item_number_id,
								         a.body_part_id,
								         a.color_type_id,
								         a.construction,
								         a.composition,
								         a.gsm_weight,
								         a.width_dia_type,
								         b.gmts_color_id
								    from wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b,wo_booking_dtls c ,wo_pre_cos_fab_co_avg_con_dtls d
								    where     a.job_no = b.job_no
								         and a.id = b.pre_cost_fabric_cost_dtls_id
								         and b.booking_no=c.booking_no
								         and b.po_break_down_id=c.po_break_down_id
								         and b.pre_cost_fabric_cost_dtls_id=c.pre_cost_fabric_cost_dtls_id
								         and b.gmts_color_id=c.gmts_color_id
								        and  a.id=d.pre_cost_fabric_cost_dtls_id
								        and d.gmts_sizes=b.size_number_id
								        and c.status_active = 1
								        and c.is_deleted = 0
								         and b.booking_no =$txt_booking_no 
								         and a.body_part_id=$bpart_id 
								         and b.job_no in ($all_jobs_id) 
								         and a.body_part_type=50  
								         and b.status_active=1 
								         and b.is_deleted=0  
								   group by  
								         a.rate,a.amount, a.job_no ,
								          a.id , a.item_number_id, 
								          a.body_part_id,a.color_type_id,
								           a.construction, a.composition,a.gsm_weight,a.width_dia_type,b.gmts_color_id,a.color_size_sensitive  order by a.body_part_id,b.gmts_color_id  " ;
	          $sql_data_collar_cuff2=sql_select($sql_collar_cuff2);
					?>

			  	 <table align="left"  width="100%" style="margin-top: 5px; margin-bottom:10px;"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" >
			  			<tr>
			  				<td colspan="<? echo $counts+13;?>" align="center">
			  					<strong>Cuff Details &nbsp;(<? echo  $body_part[$bpart_id];?>) </strong>
			  				</td>
			  			</tr>
			  			<tr>
			  				<td  width="30"  rowspan="2" align="center"><strong>SL</strong> </td>
			  				<td  width="150" rowspan="2" align="center"><strong>Style</strong></td>
 			  				<td  width="140" rowspan="2" align="center"><strong>Gmts Item</strong></td>
 			  				<td  width="100" rowspan="2" align="center"><strong>Body Part</strong></td>
							<td  width="100" rowspan="2" align="center"><strong>Actual Qty(Pcs)</strong></td>
			  				<td  width="390" rowspan="2" align="left">&nbsp;&nbsp;<strong>Cuff Composition</strong></td>
			  				<td  width="100" rowspan="2" align="center"><strong>Color Type</strong></td>
 			  				<td  width="100" rowspan="2"  align="center"><strong>Combo</strong></td>
							<td  width="100" rowspan="2"  align="center"><strong>Fabric Color</strong></td>
 			  				<?
 			  				foreach($size_id_array as $id=>$val)
 			  				{
 			  					?>
 			  					<td width="40" align="center"><strong><? echo $size_library[$id];?></strong></td>

 			  					<?
 			  				}
 			  				?>

			  				<td width="60"  rowspan="2" align="center"><strong> Req Qty(Pcs) </strong> </td>
			  				<td  width="50" rowspan="2"  align="center"><strong> Excess %  </strong> </td>

			  				<td width="50" rowspan="2"  align="center"><strong>Price/Pcs</strong></td>
			  				<td  width="40" rowspan="2" align="center"><strong>Amount</strong></td>
			  			</tr>
			  			<tr>
			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td width="40"  align="center"><strong><? echo $size_with_item_size_array[$id][$bpart_id];?></strong></td>
			  					<?
			  				}
			  				?>
			  			</tr>
			  			<?
			  			$p=1;
			  			$size_wise_qnty_array=array();
			  			foreach($sql_data_collar_cuff2 as $row)
			  			{
							?>
			  				<tr>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="30" align="center"><? echo $p;?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="150" align="center"><? echo $job_wise_style[$row[csf("job_no")]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="140" align="center"><?  $item_id= $row[csf('item_number_id')];echo $garments_item[$item_id]; ?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center"><? echo $body_part[$row[csf("body_part_id")]];?></td>
								<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center"><? $gmt_actual_qty=$gmts_qty_data_arr[$row[csf('job_no')]][$item_id][$row[csf('gmts_color_id')]][50];echo number_format($gmt_actual_qty,0);$total_gmt_actual_qty+=$gmt_actual_qty;?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="390" align="left"> &nbsp;
			  						<? echo $row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$fabric_typee[$row[csf('width_dia_type')]] ;?>
			  					</td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center"><? echo $color_type[$row[csf('color_type_id')]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center">
			  						<? echo $color_library[$row[csf('gmts_color_id')]];  ?>
			  					</td>
								<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center">
			  						<?
									if($row[csf('color_size_sensitive')]==1 or $row[csf('color_size_sensitive')]==2 or $row[csf('color_size_sensitive')]==4)
										{
											$gmt_fab_color=$color_library[$row[csf('gmts_color_id')]];
										}
										else
										{
											$contrast_color_id=return_field_value("b.contrast_color_id as contrast_color_id", "wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b", "a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.job_no in ($all_jobs_id) and a.id=".$row[csf('fabric_cost_dtls_id')]."  and b.gmts_color_id=".$row[csf('gmts_color_id')]." ","contrast_color_id");//pre_cost_fabric_cost_dtls_id
											if($contrast_color_id>0)
											{
												$gmt_fab_color=$color_library[$contrast_color_id];
											}
										}
									echo $gmt_fab_color;   ?>
			  					</td>

			  					<?
								$tot_size_qty=0;
			  					foreach($size_id_array as $id=>$val)
			  					{
			  						?>
			  						<td  style="word-break: break-all;word-wrap: break-word;"  width="40"  align="center"><? echo $size_grey_qty=$size_item_wise_qnty[$row[csf("body_part_id")]][$row[csf('fabric_cost_dtls_id')]][$row[csf("gmts_color_id")]][$id][$size_with_item_size_array[$id][$row[csf("body_part_id")]]]["grey"];?></td>

			  						<?
			  						$size_wise_qnty_array[$id]+=$size_grey_qty;$sub_size_wise_qnty_array[$row[csf("body_part_id")]][$id]+=$size_grey_qty;
									$grand_size_wise_qnty_array[$id]+=$size_grey_qty;
									$tot_size_qty+=$size_grey_qty;

			  					}
			  					?>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="60" align="center">
			  						<? echo $grey_qnty=$tot_size_qty;//$color_wise_qnty[$row[csf('gmts_color_id')]][$item_id]["grey"];
									$row_excess_per=$color_wise_excess_per_cuff_arr[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf("gmts_color_id")]][$item_id]["row_excess_per"];
									 ?>
			  					</td>

			  					<td  style="word-break: break-all;word-wrap: break-word;" title="excess tot=<? echo $row_excess_per; ?>"  width="50" align="center">
			  						<?  $avg_excess=$color_wise_excess_per_cuff_arr[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf("gmts_color_id")]][$item_id]["excess_per"]/$row_excess_per;echo number_format($avg_excess,2);   ?>
			  					</td>
			  					<td   style="word-break: break-all;word-wrap: break-word;" width="50" title="<? echo $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["row_rate"];?>" align="center">
			  						<? echo $price= $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["rate"];
									$tot_row_rate= $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["row_rate"]; ?>

			  					</td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="40" align="center">
			  						<? echo  $amount=$grey_qnty* $price;   ?>
			  					</td>

			  				</tr>
			  				<?
			  				$sub_collor_qty_arr[$row[csf("body_part_id")]]+=$grey_qnty;
							$sub_collor_amount_arr[$row[csf("body_part_id")]]+=$amount;
							$sub_excess_arr[$row[csf("body_part_id")]]+=$avg_excess;
							$sub_price_arr[$row[csf("body_part_id")]]+=$price;
							$body_wise_avg_row[$row[csf("body_part_id")]]+=1;

							$gr_fin_qty+=$fin_qty;
			  				$gr_collor_qty+=$grey_qnty;
			  				$gr_avg_price+=$price;
							$gr_amount+=$amount;
			  				$gr_excess+=$avg_excess;

			  				$gr_avg_row++;

			  				$p++;
			  			}
			  			?>

			  			<tr>
			  				<td colspan="9" align="right">Total </td>
			  				<?
							//$sub_size_wise_qnty_array=array();
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td  align="center"><? echo $sub_size_wise_qnty_array[$bpart_id][$id];
								//$sub_size_wise_qnty_array[$row[csf("body_part_id")]][$id]=0;
								/*$grand_size_wise_qnty_array[$id]+=$sub_size_wise_qnty_array[$bpart_id][$id];*/
								?></td>
			  					<?
			  				}
							$tot_avg_row=$body_wise_avg_row[$bpart_id];
							$tot_sub_excess=$sub_excess_arr[$bpart_id];
							$tot_sub_price=$sub_price_arr[$bpart_id];
			  				?>
			  				<td align="center">
			  					<? echo $sub_collor_qty_arr[$bpart_id];  ?>
			  				</td>
			  				<td align="center" title="Tot Excess & Tot Row=<? echo $tot_sub_excess.'='.$tot_avg_row;?>"><? echo number_format($tot_sub_excess/$tot_avg_row,2); ?></td>
			  				<td align="center">
			  					<? echo number_format($tot_sub_price/$tot_avg_row,2);  ?>
			  				</td>
			  				<td align="center">
			  					<? echo $sub_collor_amount_arr[$bpart_id];   ?>
			  				</td>
			  			</tr>
			  			<?
						} //Body Part End

			  		?>
					<tr>
			  				<td colspan="9" align="right">Grand Total </td>
			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td  align="center"><? echo $grand_size_wise_qnty_array[$id];?></td>
			  					<?
			  				}
			  				?>
			  				<td align="center">
			  					<? echo $gr_collor_qty;  ?>
			  				</td>
			  				<td align="center" title="grand Excess &tot row=<? echo $gr_excess.'='.$gr_avg_row;?>"><? echo number_format($gr_excess/$gr_avg_row,2); ?></td>
			  				<td align="center">
			  					<? //echo number_format($gr_avg_price/$gr_avg_row,2);  ?>
			  				</td>
			  				<td align="center">
			  					<? echo $gr_amount;   ?>
			  				</td>
			  			</tr>
			  	</table>
				<?
					}
				?>

				</div>
				<br>
				<?
		$color_name_arr=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0",'id','color_name');
		$sql_stripe=("select c.id,c.job_no,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.id as did,d.uom,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,c.uom as type_uom from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and d.job_no in($all_jobs_id) and b.booking_no=$txt_booking_no  and c.color_type_id in (2,6) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and b.is_deleted=0  group by c.id,c.job_no,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.uom,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,c.composition,c.construction,b.dia_width,c.uom order by c.job_no,c.id,d.id ");
		$result_data=sql_select($sql_stripe);
		foreach($result_data as $row)
		{
		$style_ref_no=$job_data_arr['style_ref_no'][$row[csf('job_no')]];
		//echo $style_ref_no.'XXXX';
			//$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['style_ref_no'][$row[csf('did')]]=$style_ref_no;
			if($row[csf('type_uom')]==12){
				$type_uom_arr[$row[csf('type_uom')]]='kg';
			}elseif($row[csf('type_uom')]==1){
				$type_uom_arr[$row[csf('type_uom')]]='pcs';
			}
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['type_uom']=$row[csf('type_uom')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['stripe_color']=$row[csf('stripe_color')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['measurement']=$row[csf('measurement')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['fabreqtotkg']+=$row[csf('fabreqtotkg')];
			//$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['yarn_dyed']=$row[csf('yarn_dyed')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['fabric_description']=$row[csf('fabric_description')];
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['uom']=$row[csf('uom')];
		
			$stripe_arr[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]][$row[csf('stripe_color')]]['style_ref_no']=$style_ref_no;

			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabric_description']=$row[csf('fabric_description')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['style_ref_no']=$style_ref_no;
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom']=$row[csf('uom')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg']+=$row[csf('fabreqtotkg')];
			$stripe_arr2[$row[csf('job_no')]][$row[csf('body_part_id')]][$row[csf('color_number_id')]]['type_uom']=$row[csf('type_uom')];
		}
	
// print_r($type_uom_arr);

		foreach($type_uom_arr as $uom_id=>$uom_arr){
		?>
			

			<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
       		 <caption> <strong style="float:left"> Stripe Details (<?=$uom_arr;?>)</strong></caption>
      

            <tr>
                <th width="30"> SL</th>
                <th width="100">Style</th>
				<th width="100">Body Part</th>
				<th width="100">Fab. Desc.</th>
                <th width="80">Gmts Color</th>
                <th width="70">Fabric Qty(<?=$uom_arr;?>)</th>
                <th width="70">Stripe Color</th>
                <th width="70">Stripe Measurement</th>
				<th  width="70">Stripe Uom</th>
                <th  width="70">Qty.(<?=$uom_arr;?>)</th>

				<th  width="70">Y/D Req.</th>
            </tr>
            <?
				$job_strip_color_rowspan=array();$fab_strip_color_rowspan=array();$color_strip_color_rowspan=array();
			  foreach($stripe_arr as $job_id=>$job_data)
			  {	 $job_row_span=0;
					 foreach($job_data as $body_id=>$body_data)
					 {
						   $fab_row_span=0;
						   foreach($body_data as $color_id=>$color_data)
						   {
								$color_row_span=0;
								foreach($color_data as $strip_color_id=>$color_val)
								{
									$job_row_span++;$fab_row_span++;$color_row_span++;

								}
								$job_strip_color_rowspan[$job_id]=$job_row_span;
								$fab_strip_color_rowspan[$job_id][$body_id]=$fab_row_span;
								$color_strip_color_rowspan[$job_id][$body_id][$color_id]=$color_row_span;
								$color_strip_color_qty_arr[$job_id][$body_id][$color_id]=$stripe_arr2[$job_id][$body_id][$color_id]['fabreqtotkg'];


						   }
					 }
			  }
			 // print_r($job_strip_color_rowspan);


			$i=1;$total_fab_qty=0;$total_fabreqtotkg=$total_color_qty=0;$fab_data_array=array();
            foreach($stripe_arr as $job_id=>$job_data)	{
			 $job_span=1;
			 foreach($job_data as $body_id=>$body_data)    {
			  $fab_span=1;
			   foreach($body_data as $color_id=>$color_data)  {
			     $color_span=1;
				foreach($color_data as $strip_color_id=>$color_val)   {
					//$rowspan=count($color_val['stripe_color']);

					if($uom_id==$color_val['type_uom'])
					{
					?>
					<tr>
					<?

					if($job_span==1)
					{
					?>
                        <td align="center" rowspan="<? echo $job_strip_color_rowspan[$job_id];?>"> <? echo $i; ?></td>
                        <td align="center" title="<? echo $job_id;?>" rowspan="<? echo $job_strip_color_rowspan[$job_id];?>"> <? echo $color_val['style_ref_no']; ?></td>
						<?
					}
					if($fab_span==1)
					{
						?>
						<td align="center" rowspan="<? echo $fab_strip_color_rowspan[$job_id][$body_id];?>"> <? echo $body_part[$body_id]; ?></td>
						<td align="center" rowspan="<? echo $fab_strip_color_rowspan[$job_id][$body_id];?>"> <? echo $color_val['fabric_description']; ?></td>
						<?
					}
					if($color_span==1)
					{
					$color_qty= $color_strip_color_qty_arr[$job_id][$body_id][$color_id];//$color_val['fabreqtotkg'];
					$total_color_qty+=$color_qty;
					?>
                        <td rowspan="<? echo $color_strip_color_rowspan[$job_id][$body_id][$color_id];?>" align="center"> <? echo $color_name_arr[$color_id]; ?></td>
                        <td rowspan="<? echo $color_strip_color_rowspan[$job_id][$body_id][$color_id];?>" align="center"> <? echo number_format($color_qty,2); ?></td>
					<?
					}

						?>
						<td align="center"><?  echo  $color_name_arr[$strip_color_id]; ?></td>
						<td align="center"> <? echo  number_format($color_val['measurement'],2); ?></td>
						<td align="center"> <? echo  $unit_of_measurement[$color_val['uom']]; ?></td>
						<td align="center" title="Stripe Measurement/Tot Stripe Measurement*Fabric Qty(KG)"> <? echo  number_format($color_val['fabreqtotkg'],2); ?></td>

						<td align="center"> <? echo  $yes_no[$color_val['yarn_dyed']]; ?></td>
					</tr>
						<?
					
						$total_fabreqtotkg+=$color_val['fabreqtotkg'];

					$job_span++;$fab_span++;$color_span++;
					}
				  }
				}
				$i++;
			}
			}
			?>
        <tfoot>
        <tr>
            <td align="right" colspan="5">Total </td>
            <td align="center"><? echo  number_format($total_color_qty,2); ?> </td>
            <td></td>
            <td></td>

            <td> </td>
			 <td align="center"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
			<td> </td>
        </tr>
        </tfoot>
   </table>
   <?}?>
   <br/>
			<table  style="margin-top: 5px;float: left;"    width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

				<tr>
					<td colspan="10" align="center">
						<strong>Comments</strong>
					</td>
				</tr>
				<tr>
					<td align="center"> SL </td>
					<td align="center" width="200"  style="word-wrap: break-word;word-break: break-all;"> PO NO </td>
					<td align="center"> Ship Date </td>
					<td align="center">BOM Qty</td>
					<td align="center"> Booking Qty </td>
					<td align="center"> Short Booking Qty </td>
					<td align="center"> Total Booking Qty </td>
					<td align="center"> Balance </td>
					<td align="center"> Comments </td>
				</tr>
				<?
				$is_short_data=sql_select("SELECT a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0   and b.is_short =1 group by  a.id ");
				foreach($is_short_data as $vals)
				{
					$short_qty_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
				}

				$booking_data=sql_select("SELECT a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and  b.status_active=1 and b.is_deleted=0 and b.is_short !=1 and b.booking_type=1 group by  a.id  order by a.id");
				foreach($booking_data as $vals)
				{
					$booking_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
				}

				$po_date=return_library_array("select id,shipment_date from wo_po_break_down where status_active=1 and is_deleted=0",'id','shipment_date');

				$comments_data=sql_select("SELECT min(a.id) as ids,b.po_break_down_id as po_number,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,SUM(b.requirment) as precost_grey_qty FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id
					and
					b.po_break_down_id=d.po_break_down_id and
					b.color_number_id=d.gmts_color_id and
					b.dia_width=d.dia_width and
					b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					a.job_no=d.job_no and
					a.id=d.pre_cost_fabric_cost_dtls_id
					and
					d.booking_no =$txt_booking_no and
					d.job_no in($all_jobs_id) and

					d.status_active=1 and
					d.is_deleted=0 and
					b.cons>0
					group by b.po_break_down_id order by b.po_break_down_id");



				$job_no=$all_jobs_id;
				$condition= new condition();
				if(str_replace("'","",$job_no) !='')
				{
					$condition->job_no("in ($job_no)");
				}
				$condition->init();
				$fabric= new fabric($condition);
				$fabric_costing_qty_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish();

				$j=1;
				$total_bom=0;
				$total_book=0;
				$total_short=0;
				$total_short_full=0;
				$total_balance=0;
				foreach($comments_data as $val)
				{
					$po_id=$val[csf('po_number')];
					$woven_qty=array_sum($fabric_costing_qty_arr['woven']['grey'][$po_id]);
					$knit_qty=array_sum($fabric_costing_qty_arr['knit']['grey'][$po_id]);
					$sum_woven_knit=$woven_qty + $knit_qty;


					?>
					<tr>
						<td align="center"><? echo $j;?></td>

						<td align="center"  style="word-wrap: break-word;word-break: break-all;"> <? echo $po_num_arr[$val[csf("po_number")]] ;?> </td>
						<td align="center"> <? echo change_date_format($po_date[$val[csf("po_number")]], "yyyy-mm-dd", "-");?> </td>
						<td align="center"><?  echo $pre= def_number_format($sum_woven_knit,2);  ?> </td>
						<td align="center"><?  echo $bookings= def_number_format($booking_arr[$val[csf("po_number")]],2);  ?> </td>
						<td align="center"> <?echo $short=def_number_format($short_qty_arr[$val[csf("po_number")]],2); ?> </td>
						<td align="center"> <?   $tot_short_book= str_replace(',','',$bookings) +  str_replace(',','',$short) ; echo def_number_format($tot_short_book,2); ?>  </td>
						<td align="center"> <?  $bal =str_replace(',','',$pre)-str_replace(',','',$tot_short_book) ; echo def_number_format($bal,2);  ?> </td>
						<td align="center"> <? if($bal!=0){ if($pre>$tot_short_book){echo "Less ";} else{ echo "Over";} }?> </td>


					</tr>
					<?
					$total_bom +=str_replace(',','',$pre);
					$total_book +=str_replace(',','',$bookings);
					$total_short +=str_replace(',','',$short);
					$total_short_full += str_replace(',','',$tot_short_book);
					$total_balance += str_replace(',','',$bal);

					$j++;
				}
				?>
				<tr>
					<td colspan="3" align="right"> <b> Total </b></td>
					<td align="center"><strong><? echo def_number_format($total_bom,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_book,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_short,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_short_full,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_balance,2);?> </strong> </td>
					<td>&nbsp;</td>
				</tr>
			</table>



			<?
			if($cbo_fabric_source==1 || $cbo_fabric_source==2 || $cbo_fabric_source==3){
			?>
			<table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
				<tr>
					<?
					$nameArray_item_size=sql_select( "SELECT min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active =1 and d.is_deleted=0 and d.job_no in($all_jobs_id)  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
					if(count($nameArray_item_size)>0)
					{
						?>
						<td width="49%">

						</td>
						<td width="2%">
						</td>
						<?
					}
					?>
					<?
					$nameArray_item_size=sql_select( "SELECT min(c.id) as id, b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.job_no in ($all_jobs_id)  and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");

					if(count($nameArray_item_size)>0)
					{
						?>
						<td width="49%">

						</td>
						<?
					}
					?>
				</tr>
			</table>
			<br/>

			<br/>



	<?
	//------------------------------ Query for TNA start-----------------------------------
	$po_id_all=str_replace("'","",$txt_order_no_id);
	$po_num_arr=return_library_array("SELECT id,po_number from wo_po_break_down where job_no_mst in($all_jobs_id)",'id','po_number');
	$tna_start_sql=sql_select( "SELECT id,po_number_id,
	(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
	(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
	(case when task_number=60 then task_start_date else null end) as knitting_start_date,
	(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
	(case when task_number=61 then task_start_date else null end) as dying_start_date,
	(case when task_number=61 then task_finish_date else null end) as dying_end_date,
	(case when task_number=64 then task_start_date else null end) as finishing_start_date,
	(case when task_number=64 then task_finish_date else null end) as finishing_end_date,
	(case when task_number=84 then task_start_date else null end) as cutting_start_date,
	(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
	(case when task_number=86 then task_start_date else null end) as sewing_start_date,
	(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
	(case when task_number=110 then task_start_date else null end) as exfact_start_date,
	(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
	(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
	(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
	from tna_process_mst
	where status_active=1 and po_number_id in($po_id_all) and job_no in ($all_jobs_id) order by po_number_id");
 	$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
	$tna_date_task_arr=array();
	foreach($tna_start_sql as $row)
	{
		if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
		{
			if($tna_fab_start=="")
			{
				$tna_fab_start=$row[csf("fab_booking_start_date")];
			}
		}
		if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
		}
		if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
		}
		if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
		}
		if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
		}
		if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
		}
		if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
		}
		if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
		}
	}
	//------------------------------ Query for TNA end-----------------------------------
	if(count($tna_start_sql)>0 )
	{
		?>
		<br>
		<fieldset id="div_size_color_matrix" style="max-width:1000;">
			<legend>TNA Information</legend>
			<table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
				<tr>
					<td rowspan="2" align="center" valign="top">SL</td>
					<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
					<td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
					<td colspan="2" align="center" valign="top"><b>Knitting</b></td>
					<td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
					<td colspan="2" align="center" valign="top"><b>Finishing Fabric</b></td>
					<td colspan="2" align="center" valign="top"><b>Cutting </b></td>
					<td colspan="2" align="center" valign="top"><b>Sewing </b></td>
					<td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
				</tr>
				<tr>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
				</tr>
				<?
				$i=1;
				foreach($tna_date_task_arr as $order_id=>$row)
				{
					?>
					<tr>
						<td><? echo $i; ?></td>
						<td><? echo $po_num_arr[$order_id]; ?></td>
						<td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
						<td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
						<td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
					</tr>
					<?
					$i++;
				}
				?>
			</table>
		</fieldset>
		<?
	}
	}// fabric Source End
	?>
	<br>

	<table width="220"  border="0" cellpadding="2" cellspacing="0" rules="all" style="float:left">
		<tr>
			<td width="200" valign="top" align="left">

				<div id="div_size_color_matrix" style="float:left;">
					<?
					$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
					?>
					<fieldset>
						<legend>RMG Process Loss % </legend>
						<table width="180" class="rpt_table" border="1" rules="all">
							<?
							if(number_format($rmg_process_breakdown_arr[8],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Cut Panel rejection <!-- Extra Cutting % breack Down 8-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[8],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[2],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Chest Printing <!-- Printing % breack Down 2-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[2],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[10],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Neck/Sleeve Printing <!-- New breack Down 10-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[10],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[1],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Embroidery   <!-- Embroidery  % breack Down 1-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[1],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[4],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Sewing /Input<!-- Sewing % breack Down 4-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[4],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[3],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Garments Wash <!-- Washing %breack Down 3-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[3],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[15],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Gmts Finishing <!-- Washing %breack Down 3-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[15],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[11],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Others <!-- New breack Down 11-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[11],2);
										?>
									</td>
								</tr>
								<?
							}
							$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
							if($gmts_pro_sub_tot>0)
							{
								?>
								<tr>
									<td width="130">
										Sub Total <!-- New breack Down 11-->
									</td>
									<td align="right">
										<?

										echo number_format($gmts_pro_sub_tot,2);
										?>
									</td>
								</tr>
								<?
							}
							?>
						</table>
					</fieldset>


					<fieldset>
						<legend>Fabric Process Loss % </legend>
						<table width="180" class="rpt_table" border="1" rules="all">
							<?
							if(number_format($rmg_process_breakdown_arr[6],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Knitting  <!--  Knitting % breack Down 6-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[6],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[12],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Yarn Dyeing  <!--  New breack Down 12-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[12],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[5],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Dyeing & Finishing  <!-- Finishing % breack Down 5-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[5],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[13],2)>0)
							{
								?>
								<tr>
									<td width="130">
										All Over Print <!-- new  breack Down 13-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[13],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[14],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Lay Wash (Fabric) <!-- new  breack Down 14-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[14],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[7],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Dying   <!-- breack Down 7-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[7],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[0],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Cutting (Fabric) <!-- Cutting % breack Down 0-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[0],2);
										?>
									</td>
								</tr>
								<?
							}
							if(number_format($rmg_process_breakdown_arr[9],2)>0)
							{
								?>
								<tr>
									<td width="130">
										Others  <!-- Others% breack Down 9-->
									</td>
									<td align="right">
										<?
										echo number_format($rmg_process_breakdown_arr[9],2);
										?>
									</td>
								</tr>
								<?
							}
							$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
							if($fab_proce_sub_tot>0)
							{
								?>
								<tr>
									<td width="130">
										Sub Total  <!-- Others% breack Down 9-->
									</td>
									<td align="right">
										<?

										echo number_format($fab_proce_sub_tot,2);
										?>
									</td>
								</tr>
								<?
							}
							if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
							{
								?>
								<tr>
									<td width="130">
										Grand Total  <!-- Others% breack Down 9-->
									</td>
									<td align="right">
										<?
										echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2);
										?>
									</td>
								</tr>
								<?
							}
							?>
						</table>
					</fieldset>
				</div>
			</td>
		</tr>
	</table>

	<table width="400"  border="0" cellpadding="2" cellspacing="0" rules="all" style="float:left">
		<tr>
			<td colspan="6" align="left"><img  src='<? echo $path.$imge_arr[$po_job_no]; ?>' height='155' width='200' /></td>
		</tr>
	</table>
	<br>
	<br>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
				<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
					<thead>
						<tr>
							<th width="3%"></th><th width="97%" align="left"><u>Special Instruction</u></th>
						</tr>
					</thead>
					<tbody>
						<?
						$data_array=sql_select("select id, terms from  wo_booking_terms_condition where booking_no=$txt_booking_no");
						if ( count($data_array)>0)
						{
							$i=0;
							foreach( $data_array as $row )
							{
								$i++;
								?>
								<tr id="settr_1" valign="top">
									<td style="vertical-align:top">
										<? echo $i;?>
									</td>
									<td>
										<strong style="font-size:16px"> <? echo $row[csf('terms')]; ?></strong>
									</td>
								</tr>
								<?
							}
						}
						?>
					</tbody>
				</table>
			</td>

		</tr>
	</table>
	<br/><br/><br/><br/>
		    <table  width="100%"  border="0" cellpadding="0" cellspacing="0">
		    	<tr>
		            <td>  <?
		                    echo signature_table(121, $cbo_company_name, "1330px",1,'');
							$job_no_all= implode(",",array_unique($joball['job_no']));
							$style_sting_all=implode(",",array_unique($joball['style_ref_no']));
							echo "****".custom_file_name($txt_booking_no,$style_sting_all,$job_no_all);
		                ?>
		            </td>
		        </tr>
		    </table>
	</div>
	<?
			
			$html = ob_get_contents();
			ob_clean();
			list($is_mail_send,$mail)=explode('___',$mail_send_data);
		
			if($is_mail_send==1){
				require_once('../../../mailer/class.phpmailer.php');
				require_once('../../../auto_mail/setting/mail_setting.php');
				$mailBody = preg_replace("/<img[^>]+\>/i", " ", $html); 
				$mailBody="<br>".$mail_body	;	
				$mailToArr=array();
				$mailSql = "select b.EMAIL  from wo_booking_mst a,LIB_SUPPLIER b where b.id=a.supplier_id and a.booking_no=$txt_booking_no";
			//echo $mailSql;die;
				$mailSqlRes=sql_select($mailSql);
				foreach($mailSqlRes as $rows){
					if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
				}
				
				
				$mailSql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=99 and b.mail_user_setup_id=c.id  and c.IS_DELETED=0 and c.STATUS_ACTIVE=1";
				//echo $mailSql;die;
				$mailSqlRes=sql_select($mailSql);
				foreach($mailSqlRes as $rows){
					if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
				}
				if($mail!=''){$mailToArr[]=$mail;}
		
				$to=implode(',',$mailToArr);
				$subject="Partial fabric booking";
				$header=mailHeader();
				echo $to;
				echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
				
			}
			else{
				echo $html;
			}
			exit();
}

if($action=="print_booking_northern_9") // Aziz for Yunusco
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' or form_name='knit_order_entry' and file_type=1",'master_tble_id','image_location');
	$company_library=return_library_array( "select id,company_name from lib_company where status_active=1 and is_deleted=0", "id", "company_name");
	$color_library=return_library_array( "select id,color_name from lib_color  where status_active=1 and is_deleted=0", "id", "color_name");
	$size_library=return_library_array( "select id,size_name from lib_size  where status_active=1 and is_deleted=0", "id", "size_name");
	$country_arr=return_library_array( "select id,country_name from   lib_country  where status_active=1 and is_deleted=0",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier  where status_active=1 and is_deleted=0",'id','supplier_name');
	$supplier_address_arr=return_library_array( "select id,address_1 from   lib_supplier  where status_active=1 and is_deleted=0",'id','address_1');


	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info  where status_active=1 and is_deleted=0","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer  where status_active=1 and is_deleted=0",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location  where status_active=1 and is_deleted=0",'id','location_name');


	$po_sql=sql_select("select id,po_number,grouping from wo_po_break_down where status_active=1 and is_deleted=0 and id in(select po_break_down_id from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no=$txt_booking_no)");
	$int_ref_no="";
	foreach ($po_sql as $row)
	{
		$po_num_arr[$row[csf("id")]]=$row[csf("po_number")];
		$int_ref_no.=$row[csf("grouping")].',';
	}

	$uom=0;
	$joball=array();
	$nameArray_per_job=sql_select( "SELECT  a.season_buyer_wise,  a.job_no,a.style_ref_no ,a.season_matrix,a.gmts_item_id,a.product_dept,max(c.booking_date) as booking_date ,max(c.delivery_date) as delivery_date,max(c.is_approved) as is_approved,max(c.buyer_id) as buyer_id,max(c.pay_mode) as pay_mode,max(c.source) as source,max(supplier_id) as supplier_id,max(a.dealing_marchant) as dealing_marchant,max(c.attention) as attention,max(c.currency_id) as currency_id,max(c.fabric_source) as fabric_source ,max(c.remarks)  as remarks from wo_po_details_master a , wo_booking_dtls b,wo_booking_mst c  where c.booking_no=b.booking_no and c.status_active=1 and c.is_deleted=0 and  a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by  a.season_buyer_wise, a.job_no,a.style_ref_no ,a.season_matrix,a.gmts_item_id,a.product_dept ");
	foreach ($nameArray_per_job as $vals)
	{
		$joball['job_no'][$row_per_job[csf('job_no')]]=$row_per_job[csf('job_no')];
		$joball['style_ref_no'][$row_per_job[csf('job_no')]]=$row_per_job[csf('style_ref_no')];
		$all_job_arr[$vals[csf("job_no")]]["job"]="'".$vals[csf("job_no")]."'";
		$all_job_arr[$vals[csf("job_no")]]["style"]=$vals[csf("style_ref_no")];
		$all_job_arr[$vals[csf("job_no")]]["item"]=$vals[csf("gmts_item_id")];
		$all_jobs[$vals[csf("job_no")]]="'".$vals[csf("job_no")]."'";
		$all_jobs_no_arr[$vals[csf("job_no")]]=$vals[csf("job_no")];
		$job_wise_style[$vals[csf("job_no")]]= $vals[csf("style_ref_no")];
	}
	$all_jobs_id=implode(",",$all_jobs );
	$all_jobs_nos=implode(",",$all_jobs_no_arr );

 //	echo $all_jobs_id.'SSSA';
	$int_ref_no=rtrim($int_ref_no,',');
	if($int_ref_no!='')
	{
		$job_int_ref=implode(",", array_unique(explode(",",$int_ref_no)));
	}




	$path=str_replace("'","",$path);
	if($path=="")
	{
	$path='../../';
	}
	ob_start();
	?>
	<style type="text/css">

		body, p, span, td, a {font-size:10pt;font-family: Arial;}
		body{margin-left:2em; margin-right:2em; font-family: "Arial Narrow", Arial, sans-serif;}

	</style>

	<div style="width:1330px" align="center" >

		<table id="tb_header" width="100%" cellpadding="0" cellspacing="0" style="border:0px solid black" >
			<thead>
				<tr>
					<td width="110" rowspan="3">
						<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100' width='100' />
					</td>

					<td width="500" colspan="2" align="left" style="font-size: 16px;"><b><?php echo $company_library[$cbo_company_name]; ?></b></td>
					<td width="200">&nbsp;</td>
					<td width="300" align="left"><b>Booking No: </b><?php echo str_replace("'", "", $txt_booking_no); ?></td>
				</tr>

				<tr>

					<td  width="500" colspan="2" align="left">
						<?
						$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
						foreach ($nameArray as $result)
						{
							?>
							Plot No: <? echo $result[csf('plot_no')]; ?>
							Level No: <? echo $result[csf('level_no')]?>
							Road No: <? echo $result[csf('road_no')]; ?>
							Block No: <? echo $result[csf('block_no')];?>
							City No: <? echo $result[csf('city')];?>
							Zip Code: <? echo $result[csf('zip_code')]; ?>
							Province No: <?php echo $result[csf('province')]; ?>
							Country: <? echo $country_arr[$result[csf('country_id')]]; ?><br>
							Email Address: <? echo $result[csf('email')];?>
							Website No: <? echo $result[csf('website')];
						}
							?>

					</td>
					<td width="200">&nbsp;</td>
					<td width="300" align="left"><b>Booking Date: </b><?php echo change_date_format($nameArray_per_job[0][csf("booking_date")]); ?></td>
				</tr>

				<tr>

					<td  width="500" colspan="2" align="left" style="font-size: 16px;"><b>Multi-Job Fabric Booking-<? echo $fabric_source[$nameArray_per_job[0][csf("fabric_source")]];?></b></td>
					<td width="200">&nbsp;</td>
					<td width="300" align="left"><b>Delivery Date: </b><?php echo change_date_format($nameArray_per_job[0][csf("delivery_date")]); ?></td>
				</tr>

				<tr>
					<td colspan="4" width="700">&nbsp;</td>
					<td width="300" align="left"><b>Approval Status: </b><?php if ($nameArray_per_job[0][csf("is_approved")] == 1 || $nameArray_per_job[0][csf("is_approved")] == 3) {echo "Approved";}?></td>
				</tr>
				<tr>
					<td colspan="4" height="11">&nbsp;</td>
				</tr>
				<tr>
					<td width="300"><b>To</b></td>
				</tr>

				<tr>
					<td width="300"><?
					$pay_mode_id=$nameArray_per_job[0][csf("pay_mode")];//pay_mode
					if($pay_mode_id!=3 && $pay_mode_id!=5)
					{
						echo $supplier_name_arr[$nameArray_per_job[0][csf("supplier_id")]];
					}
					else
					{
						echo $company_library[$nameArray_per_job[0][csf("supplier_id")]];
					}?></td>
					<td colspan="3" width="700">&nbsp;</td>
					<td width="300" align="left"><b>Dealing Merchandiser:   </b> <? echo $marchentrArr[$nameArray_per_job[0][csf("dealing_marchant")]]; ?></td>

				</tr>

				<tr>
					<td width="300" ><p><b>Address: </b><? echo $supplier_address_arr[$nameArray_per_job[0][csf("supplier_id")]]; ?> </p></td>
					<td colspan="3" width="700">&nbsp;</td>
					<td width="300" align="left"><b>Buyer Name :   </b> <? echo $buyer_name_arr[$nameArray_per_job[0][csf("buyer_id")]]; ?></td>
				</tr>



				<tr>
				   <td width="300"><b>Attention: </b>   <? echo $nameArray_per_job[0][csf("attention")];?></td>
				   <td colspan="3" width="700">&nbsp;</td>
				   <td width="300" align="left"><b>Inter. Ref. No:   </b> <? echo $job_int_ref; ?></td>
				</tr>

				<tr>
				   <td width="300" align="left"><b>Pay Mode:   </b> <? echo $pay_mode[$nameArray_per_job[0][csf("pay_mode")]]; ?></td>
				    <td colspan="3" width="700">&nbsp;</td>
				   <td width="300"><b>Job No : </b>   <? echo $all_jobs_nos;?></td>

				</tr>
				<tr>
				   <td colspan="2" width="800"><b>Currency : </b><? echo $currency[$nameArray_per_job[0][csf("currency_id")]];?></td>
				</tr>

				<tr>
				   <td width="300"><b>Source :  <? echo $source[$nameArray_per_job[0][csf("source")]]; ?> </b>    </td>
				</tr>
				<tr>
				   <td width="400" align="left"><b>Remarks:   </b> <? echo $nameArray_per_job[0][csf("remarks")]; ?></td>
				</tr>
			</thead>
		</table>


			<?php

$po_data = array();
if ($db_type == 0) {
	$nameArray_job = sql_select("select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,DATEDIFF(pub_shipment_date,po_received_date) date_diff,MIN(po_received_date) as po_received_date ,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status  from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id)  group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
}
if ($db_type == 2) {
	$nameArray_job = sql_select("select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,(pub_shipment_date-po_received_date) date_diff,MIN(po_received_date) as po_received_date,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status   from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id) group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
}
foreach ($nameArray_job as $result_job) {
	$po_data['po_id'][$result_job[csf('id')]] = $result_job[csf('id')];
	$po_data['po_number'][$result_job[csf('id')]] = $result_job[csf('po_number')];
	$po_data['leadtime'][$result_job[csf('id')]] = $result_job[csf('date_diff')];
	$po_data['po_quantity'][$result_job[csf('id')]] = $result_job[csf('po_quantity')];
	$po_data['po_received_date'][$result_job[csf('id')]] = change_date_format($result_job[csf('po_received_date')], 'dd-mm-yyyy', '-');
	$ddd = strtotime($result_job[csf('pub_shipment_date')]);
	$po_data['pub_shipment_date'][$ddd] = $ddd;

	$po_data['insert_date'][$result_job[csf('id')]] = $result_job[csf('insert_date')];

	if ($result_job[csf('shiping_status')] == 1) {
		$shiping_status = "FP";
	} else if ($result_job[csf('shiping_status')] == 2) {
		$shiping_status = "PS";
	} else if ($result_job[csf('shiping_status')] == 3) {
		$shiping_status = "FS";
	}
	$po_data['shiping_status'][$result_job[csf('id')]] = $shiping_status;
	$po_data['file_no'][$result_job[csf('id')]] = $result_job[csf('file_no')];
	$po_data['grouping'][$result_job[csf('id')]] = $result_job[csf('grouping')];
}
$txt_order_no_id = implode(",", array_unique($po_data['po_id']));
$leadtime = implode(",", array_unique($po_data['leadtime']));
$po_quantity = array_sum($po_data['po_quantity']);
$po_received_date = implode(",", array_unique($po_data['po_received_date']));
$po_number = implode(",", array_unique($po_data['po_number']));
$shipment_date = date('d-m-Y', min($po_data['pub_shipment_date']));
$maxshipment_date = date('d-m-Y', max($po_data['pub_shipment_date']));
//$shipment_date=implode(",",array_unique($po_data['pub_shipment_date']));
$shiping_status = implode(",", array_unique($po_data['shiping_status']));
$file_no = implode(",", array_unique($po_data['file_no']));
$grouping = implode(",", array_unique($po_data['grouping']));

$colar_excess_percent = 0;
$cuff_excess_percent = 0;
$rmg_process_breakdown = 0;

?>
			<br/>
			<!--  Here will be the main portion  -->
			<?
			$costing_per="";
			$costing_per_qnty=0;
			$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no in($all_jobs_id)");
			if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;

			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";
				$costing_per_qnty=1;

			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;

			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;

			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;
			}
			//$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no in($all_jobs_id)");
			//wo_labtest_dtls

			//$labdip_no_arr=return_library_array( "select job_no,labtest_no from wo_labtest_mst a,wo_labtest_dtls b  where a.id=b.mst_id  and b.job_no in($all_jobs_id) and  b.status_active=1 and b.is_deleted=0",'job_no','labtest_no');
			$lab_dip_no_arr=array();
			$lab_dip_no_sql=sql_select("select lapdip_no, color_name_id from wo_po_lapdip_approval_info where job_no_mst in($all_jobs_id) and status_active=1 and is_deleted=0 and approval_status=3");
			foreach($lab_dip_no_sql as $row)
			{
				$lab_dip_no_arr[$row[csf('color_name_id')]]=$row[csf('lapdip_no')];
			}
			unset($lab_dip_no_sql);
			//echo "select job_no,labtest_no from wo_labtest_mst a,wo_labtest_dtls b  where a.id=b.mst_id  and b.job_no in($all_jobs_id) and  b.status_active=1 and b.is_deleted=0";
		$data_img=sql_select("select image_location,master_tble_id  from common_photo_library  where   form_name='fabric_color_img' and is_deleted=0 and file_type=1");
	   $system_img_arr=array();
	  foreach($data_img as $row)
	   {
		  $system_img_arr[$row[csf('master_tble_id')]]['img']=$row[csf('image_location')];
	   }

			$uom_arr=array(1=>"Pcs",12=>"Kg",23=>"Mtr",27=>"Yds");
			$p=1;

		if($cbo_fabric_source==1 || $cbo_fabric_source==2 || $cbo_fabric_source==3)
		{
			$nameArray_fabric_description= sql_select("SELECT a.id as fabric_cost_dtls_id,d.dia_width as dia,a.construction,a.composition,a.fab_nature_id as fab_nat_id,a.gsm_weight,a.fabric_description as fab_desc, a.item_number_id as item_id, a.body_part_id,a.color_type_id as color_type,a.width_dia_type as width_dia,d.po_break_down_id as po_id,d.remark as fab_remark,a.uom,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,avg(d.rate) as rates,sum(d.amount) as amounts ,d.fabric_color_id,a.color_size_sensitive,a.color_break_down,d.gmts_color_id as color_id,d.job_no
			  FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
				WHERE a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				d.job_no in ($all_jobs_id) and
				d.status_active=1 and
				d.is_deleted=0 and
				d.fin_fab_qnty>0   and a.body_part_type not in(40,50)
				group by a.id,a.item_number_id,a.gsm_weight,a.fab_nature_id,a.fabric_description ,a.body_part_id,a.color_type_id,d.gmts_color_id,a.width_dia_type,d.po_break_down_id,d.remark,a.uom ,d.fabric_color_id,a.color_size_sensitive,a.color_break_down,d.job_no,d.dia_width,a.construction,a.composition  order by a.body_part_id,d.fabric_color_id ");

			foreach($nameArray_fabric_description as $row)
			{
				$item_desc= $body_part[$row[csf("body_part_id")]].",".$color_type[$row[csf("color_type_id")]].",".$row[csf("fab_desc")].','.$row[csf('dia')];
				$uom_data_arr[$row[csf('uom')]]=$row[csf('uom')];
				if($row[csf("color_type_id")]==2 || $row[csf("color_type_id")]==6)
				{
					$strip_color_arr[$row[csf('body_part_id')]][$row[csf('color_id')]]=$row[csf('fin_fab_qntys')];
				}
				$fabric_data_arr[$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['dia']=$row[csf('dia')];
				$fabric_data_arr[$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['color_type']=$row[csf('color_type')];
				$fabric_data_arr[$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['width_dia']=$row[csf('width_dia')];
				$fabric_data_arr[$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['uom']=$row[csf('uom')];
				$fabric_data_arr[$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['item_id']=$row[csf('item_id')];
				$fabric_data_arr[$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['gsm_weight']=$row[csf('gsm_weight')];
				$fabric_data_arr[$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['dia_width']=$row[csf('dia_width')];
				$fabric_data_arr[$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['construction']=$row[csf('construction')];
				$fabric_data_arr[$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['composition']=$row[csf('composition')];
				$fabric_data_arr[$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['fab_color_id']=$row[csf('fabric_color_id')];
				$fabric_data_arr[$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['body_part_id']=$row[csf('body_part_id')];
				$fabric_data_arr[$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['fab_remark']=$row[csf('fab_remark')];
				$fabric_data_arr[$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['amount']=$row[csf('amounts')];
				$fabric_data_arr[$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['fin_fab_qnty']=$row[csf('fin_fab_qntys')];
				$fabric_data_arr[$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['color_size_sensitive']=$row[csf('color_size_sensitive')];
				$fabric_data_arr[$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['color_break_down']=$row[csf('color_break_down')];
				$fabric_data_arr[$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['fabric_cost_dtls_id']=$row[csf('fabric_cost_dtls_id')];

			}
					?>
						<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
									<caption> <strong>Fabric Booking Detail </strong> </caption>
									<tr>
										<th  width="30" align="center">SL</th>
										<th  width="100" align="center">Style Ref</th>
										<th  width="100" align="center">Order No</th>
										<th  width="70" align="center">Fabric Nature</th>
										<th  width="300" align="center">Fabric Description</th>
										<th  width="35" align="center">GSM</th>
										<th  width="120" align="center">FabricDia/ Width</th>
										<th  width="70" align="center">Color Type</th>
										<th  width="60" align="center">Gmts Color</th>
										<th  width="65" align="center">Fabric Color</th>
										<th  width="80" align="center">Lab Dip No</th>
										<th  width="45" align="center">UOM</th>
										<th  width="70" align="center">Finish Fab. Qty</th>
										<th  width="240" align="center">Image</th>
										<th width="80" align="center" title="">Avg Rate</th>
										<th width="80" align="center">Amount</th>
										<th width="100" align="center">Remark</th>

									</tr>
									<? //wo_pre_cos_fab_co_color_dtls
										$total_fin_fab_qnty=$total_amount=0;
										$k=1;
									foreach($fabric_data_arr as $style_id=>$style_data)
									{
									  foreach($style_data as $po_id=>$po_data)
									  {
									  	 foreach($po_data as $nat_id=>$nat_data)
									     {
										 	foreach($nat_data as $desc_id=>$desc_data)
									        {
												foreach($desc_data as $color_id=>$val)
									        	{
											if($val[('fab_remark')]=='no remarks')  $pre_cost_remarks="";else  $pre_cost_remarks=$val[('fab_remark')];
											$diaWidth=$val[('dia')];
											if($diaWidth!='') $diaWidth=$diaWidth.",";else $diaWidth="";
											?>
											<tr>
												<td align="center"> <? echo $k;?></td>
												<td align="center" title="<? echo $style_id;?>"> <? echo $all_job_arr[$style_id]["style"];?></td>
												<td align="center"> <? echo $po_num_arr[$po_id];?></td>
												<td align="center"><? echo $item_category[$nat_id];?></td>
												<td align="center"><? echo $desc_id;?></td>
												<td align="center"> <? echo $val[('gsm_weight')]; ?> </td>

												<td  align="center">
													<?
													echo $diaWidth.$fabric_typee[$val[('width_dia')]];
													?>
												</td>
												<td  align="center">
													<?
													echo $color_type[$val[('color_type')]];
													?>
												</td>
												<td  align="center">
													<?
													if($val[('color_size_sensitive')]==1 or $val[('color_size_sensitive')]==2 or $val[('color_size_sensitive')]==4)
													{
														echo $color_library[$val[('fab_color_id')]];
													}

													else
													{
														$color_break_down=$val[('color_break_down')];
														if($color_break_down)
														{
															$gmts_color="";
															if (strpos($color_break_down, '__') !== false)
															{
																$color_break_down=explode('__', $color_break_down);
																foreach ($color_break_down as $key => $value)
																{
																	$cols=explode('_', $value);
																	if(trim(strtolower($color_library[$val[('fab_color_id')]]))==trim(strtolower($cols[2])))
																	{
																		if($gmts_color=="")
																		{
																			$gmts_color=$cols[1];
																		}
																		else
																		{
																			$gmts_color .=','.$cols[1];
																		}

																	}
																}
															}
															else
															{
																$cols=explode('_', $color_break_down);
																if(trim(strtolower($color_library[$val[('fab_color_id')]]))==trim(strtolower($cols[2])))
																{
																	if($gmts_color=="")
																	{
																		$gmts_color=$cols[1];
																	}
																	else
																	{
																		$gmts_color .=','.$cols[1];
																	}

																}
															}

															echo $gmts_color;
														}

													}
													?>
												</td>
												<td  align="center">
													<?

													echo $color_library[$val[('fab_color_id')]];
													?>
												</td>
												<td align="center"><? echo $lab_dip_no_arr[$val[('fab_color_id')]];//$labdip_no_arr[$style_id]; ?></td>
												<td align="center"> <? echo $unit_of_measurement[$val[('uom')]]; ?></td>
												<td align="center"> <? echo def_number_format($val[("fin_fab_qnty")],2); ?></td>
													<td align="center"> <?
													$img_ref_id=$val[('fabric_cost_dtls_id')].'_'.$val[('fab_color_id')];
													$fab_color_img=$system_img_arr[$img_ref_id]['img'];

													//echo def_number_format($val[("fin_fab_qntys")],2);
													if($fab_color_img!='')
													{
													?>
													<img src='../../<? echo $fab_color_img; ?>' height='50' width='70' align="middle" />
													<?
													}
													else
													{
													?>
														<img src='../../<? echo $fab_color_img; ?>' height='50' width='70' align="middle" />
													<?
													}
													?>
													</td>
													<td align="center"> <? echo def_number_format($val[("amount")]/$val[("fin_fab_qnty")],2); ?> </td>
													<td align="center"> <? echo def_number_format($val[("amount")],2); ?> </td>
													<td align="center"> <? echo $pre_cost_remarks; ?> </td>
													<?
													$total_fin_fab_qnty +=$val[("fin_fab_qnty")];
													$total_amount +=$val[("amount")];

												?>

												</tr>
												<?
												$k++;
															} // Color End

														} // Desc End
													} // Nature End
												} // Po End

										} // Style End

										?>
									<tr style="font-weight:bold">
									    <td  align="right" colspan="12"><strong>Total&nbsp;</strong></td>
									    <td align="center"><? echo def_number_format($total_fin_fab_qnty,2);?></td>
									    <td align="center"></td>
									    <td align="center"></td>
									    <td align="center"><? echo def_number_format($total_amount,2);?></td>
									    <td align="center"></td>
									</tr>
									<!-- <tr style=" font-weight:bold">
									<td  align="right" colspan="5"><strong>Total</strong></td>
									<td align="right"><? //echo def_number_format($total_gmt_qty_pcs,2);?></td>
									<td  align="right" colspan="8">&nbsp;</td>

								<td align="center"><? //echo def_number_format($total_fin_fab_qnty,2);?></td>
									<td align="center"><? //echo def_number_format($total_fin_fab_qnty,2);?></td>
									<td align="center"><? //echo def_number_format($total_fin_fab_qnty,2);?></td>

								<td align="center"><? //echo def_number_format($total_amount,2);?></td>
									<td align="center"><? //echo def_number_format($total_amount,2);?></td>
									</tr> -->
						</table>
					<br/>

		<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
       		 <caption> <strong style="float:left"> Stripe Details</strong></caption>
        <?
		$color_name_arr=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0",'id','color_name');
		$sql_stripe=("select c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.id as did,d.uom,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and d.job_no in($all_jobs_id) and b.booking_no=$txt_booking_no  and c.color_type_id in (2,6) and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and 	b.is_deleted=0  group by c.id,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.uom,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,c.composition,c.construction,b.dia_width order by c.id,d.id ");
		//echo $sql_stripe;


		$result_data=sql_select($sql_stripe);
		foreach($result_data as $row){
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
			//$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom']=$row[csf('uom')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg']+=$row[csf('fabreqtotkg')];
		}
		?>
            <tr>
                <th width="30"> SL</th>
                <th width="100"> Body Part</th>
                <th width="80"> Fabric Color</th>
                <th width="70"> Fin Fabric Qty </th>
                <th width="70"> Stripe Color</th>
                <th width="70"> Stripe Measurement</th>
                <th  width="70"> Qty.(KG)</th>
                <th  width="70"> Uom</th>
            </tr>
            <?
			$i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
            foreach($stripe_arr as $body_id=>$body_data){
				foreach($body_data as $color_id=>$color_val){
					$rowspan=count($color_val['stripe_color']);
					$composition=$stripe_arr2[$body_id][$color_id]['composition'];
					$construction=$stripe_arr2[$body_id][$color_id]['construction'];
					$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
					$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
					$uom_id=$stripe_arr2[$body_id][$color_id]['uom'];
					$dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];
					/*if($db_type==0) $color_id_cond="IFNULL(d.fabric_color_id,0)=IFNULL('".$color_id."',0) and";
					else if ( $db_type==2) $color_id_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0) and";
					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
						WHERE a.job_no=b.job_no and
						a.id=b.pre_cost_fabric_cost_dtls_id and
						c.job_no_mst=a.job_no and
						c.id=b.color_size_table_id and
						b.po_break_down_id=d.po_break_down_id and
						 b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
						d.booking_no =$txt_booking_no and
						a.body_part_id='".$body_id."' and
						a.color_type_id='".$color_type_id."' and
						a.construction='".$construction."' and
						a.composition='".$composition."' and
						a.gsm_weight='".$gsm_weight."' and
						$color_id_cond
						d.status_active=1 and
						d.is_deleted=0
						");

						list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;*/

						//$color_qty=$strip_color_arr[$body_id][$color_id];
						$color_qty=$stripe_arr2[$body_id][$color_id]['fabreqtotkg'];
						$total_color_qty+=$color_qty;
					?>
					<tr>
					<?
					//$color_qty=$color_wise_wo_result_qnty[csf('fin_fab_qnty')];
					?>
                        <td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
                        <td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
                        <td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
                        <td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?></td>
					<?
					//$total_fab_qty+=$color_wise_wo_result_qnty[csf('fin_fab_qnty')];
					foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
					{
						$measurement=$color_val['measurement'][$strip_color_id];
						$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
						$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
						?>
						<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
						<td align="right"> <? echo  number_format($measurement,2); ?></td>
						<td align="right"> <? echo  number_format($fabreqtotkg,2); ?></td>
						<td> <? echo  $unit_of_measurement[$uom_id]; ?></td>
					</tr>
						<?
						$total_fabreqtotkg+=$fabreqtotkg;
					}
					$i++;
				}
			}
			?>
        <tfoot>
        <tr>
            <td colspan="3">Total </td>
            <td align="right"><? echo  number_format($total_color_qty,2); ?> </td>
            <td></td>
            <td></td>
            <td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
            <td> </td>
        </tr>
        </tfoot>
   </table>

					<?
			//End

		}
					?>
			</table>
			<br>
				<div style="width:1330px" align="center" >
			  		<table  width="100%"  border="0" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

			  			<tr>
			  				<td colspan="10" align="center">
			  					<strong>Collar and Cuff & Other Flat Knit Fabric Breakdown</strong>
			  				</td>

			  			</tr>
			  		</table>

	        <?
	     	  $sql_collar_cuff= "SELECT a.rate, a.amount, a.job_no , a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.width_dia_type, b.gmts_color_id, b.size_number_id, b.item_size, b.gmts_qty, b.excess_per, b.qty, b.po_break_down_id as po_id, b.id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id) and a.body_part_type=40 and b.status_active=1 and b.is_deleted=0  order by a.body_part_id,b.gmts_color_id,b.id " ;
	     	  //echo $sql_collar_cuff; die;
	         $sql_data_collar_cuff=sql_select($sql_collar_cuff);
	         $size_id_array=array();
	         $size_with_item_size_array=array();
	         foreach($sql_data_collar_cuff as $vals)
	         {
	         	$body_part_cuff_array[$vals[csf("body_part_id")]]=$vals[csf("body_part_id")];
				$size_id_array[$vals[csf("size_number_id")]]=$vals[csf("size_number_id")];
	         	$size_with_item_size_array[$vals[csf("size_number_id")]][$vals[csf("body_part_id")]]=$vals[csf("item_size")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["grey"]+=$vals[csf("qty")];

	         	//$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]=$vals[csf("excess_per")];
				if($vals[csf("excess_per")]>0)
				{
				$color_wise_excess_per_arr[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]+=$vals[csf("excess_per")];
				$color_wise_excess_per_arr[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_excess_per"]+=1;
				}
	         	$color_wise_qnty[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$color_wise_qnty[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["grey"]+=$vals[csf("qty")];
	         	/*$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];*/

	         	//$color_wise_qnty[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["amount"]=$vals[csf("amount")];
				$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_rate"]=1;

	         }
			unset($sql_data_collar_cuff);
	         $sql_collar_cuff3 = sql_select("SELECT c.rate, a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id, c.gmts_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls c WHERE a.job_no=c.job_no and a.id=c.pre_cost_fabric_cost_dtls_id and  a.id=c.pre_cost_fabric_cost_dtls_id and c.booking_no =$txt_booking_no and c.job_no in ($all_jobs_id) and a.body_part_type=40 and c.status_active=1 and c.is_deleted=0  order by a.body_part_id");

	         foreach($sql_collar_cuff3 as $vals)
	         {

	         	$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];

	         }


	         $counts=count($size_id_array);


	         $size_wise_qnty_array=array();
	         ?>


			 <?
	          if(count($body_part_cuff_array)>0)
	          {		$grand_size_wise_qnty_array=array();
			  		$gr_collor_qty=0;
					 $gr_col_avg_price=0;
					 $gr_col_avg_row=0;
					 $gr_amount=0;
					 $gr_excess=0;
					foreach($body_part_cuff_array as $bpart_id=>$val)
					{
					 $sql_collar_cuff2= "SELECT a.rate,a.amount, a.job_no , a.id as fabric_cost_dtls_id,a.color_size_sensitive,a.color_break_down, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,b.gmts_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and a.body_part_id=$bpart_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id) and a.body_part_type=40  and b.status_active=1 and b.is_deleted=0  group by  a.rate,a.amount, a.job_no , a.id ,a.color_size_sensitive,a.color_break_down, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition,a.gsm_weight,a.width_dia_type,b.gmts_color_id  order by a.body_part_id,b.gmts_color_id  " ;
	          $sql_data_collar_cuff2=sql_select($sql_collar_cuff2);
					?>
					 <table align="left"  width="100%" style="margin-top: 5px;" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" >
			  			<tr>
			  				<td colspan="<? echo $counts+13;?>" align="center">
			  					<strong>Collar Details(<? echo $body_part[$bpart_id];?>)</strong>
			  				</td>

			  			</tr>
			  			<tr>
			  				<td  width="30"  rowspan="2" align="center"><strong>SL</strong> </td>
			  				<td  width="150" rowspan="2" align="center"><strong>Style</strong></td>
 			  				<td  width="140"  rowspan="2" align="center"><strong>Gmts Item</strong></td>
 			  				<td  width="100"  rowspan="2" align="center"><strong>Body Part</strong></td>
							<td  width="100" rowspan="2" align="center"><strong>Actual Qty(Pcs)</strong></td>
			  				<td  width="390" rowspan="2" align="left">&nbsp;&nbsp;<strong>Collar Composition</strong></td>
			  				<td  width="100"  rowspan="2" align="center"><strong>Color Type</strong></td>
 			  				<td  width="100"  rowspan="2"  align="center"><strong>Combo</strong></td>
							<td  width="100"  rowspan="2"  align="center"><strong>Fabric Color</strong></td>
 			  				<?
 			  				foreach($size_id_array as $id=>$val)
 			  				{
 			  					?>
 			  					<td width="40" align="center"><strong><? echo $size_library[$id];?></strong></td>

 			  					<?
 			  				}
 			  				?>
			  				<td width="60"  rowspan="2" align="center"><strong> Req Qty (Pcs)</strong> </td>
			  				<td  width="50" rowspan="2"  align="center"><strong> Excess %  </strong> </td>
			  				<td width="50" rowspan="2"  align="center"><strong>Price/Pcs</strong></td>
			  				<td  width="40" rowspan="2" align="center"><strong>Amount</strong></td>


			  			</tr>
			  			<tr>
			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					//$size_with_item=rtrim($size_with_item_size_array[$id],',');
								//$size_with_item=implode(",",array_unique(explode(",",$size_with_item)));
								?>
			  					<td  align="center"><? echo $size_with_item_size_array[$id][$bpart_id];?></td>

			  					<?
			  				}
			  				?>

			  			</tr>
			  			<?
			  			$p=1;
			  			foreach($sql_data_collar_cuff2 as $row)
			  			{

							?>
			  				<tr>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="30" align="center"><? echo $p;?></td>
			  					<td style="word-break: break-all;word-wrap: break-word;" width="150" align="center"><? echo $job_wise_style[$row[csf("job_no")]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="140" align="center"><?  $item_id= $row[csf('item_number_id')];echo $garments_item[$item_id]; ?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center"><? echo $body_part[$row[csf("body_part_id")]];?></td>
								<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center"><? $gmt_actual_qty=$gmts_qty_data_arr[$row[csf('job_no')]][$item_id][$row[csf('gmts_color_id')]];echo number_format($gmt_actual_qty,0);$total_gmt_actual_qty+=$gmt_actual_qty;?></td>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="390" align="left"> &nbsp;
			  						<? echo $row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$fabric_typee[$row[csf('width_dia_type')]] ;?>
			  					</td>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="100" align="center"><? echo $color_type[$row[csf('color_type_id')]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center">
			  						<? echo $color_library[$row[csf('gmts_color_id')]];  ?>
			  					</td>
								<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center">
			  						<?
										if($row[csf('color_size_sensitive')]==1 or $row[csf('color_size_sensitive')]==2 or $row[csf('color_size_sensitive')]==4)
										{
											$gmt_fab_color=$color_library[$row[csf('gmts_color_id')]];
										}
										else
										{
											$contrast_color_id=return_field_value("b.contrast_color_id as contrast_color_id", "wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b", "a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.job_no in ($all_jobs_id) and a.id=".$row[csf('fabric_cost_dtls_id')]."  and b.gmts_color_id=".$row[csf('gmts_color_id')]." ","contrast_color_id");//pre_cost_fabric_cost_dtls_id
											if($contrast_color_id>0)
											{
												$gmt_fab_color=$color_library[$contrast_color_id];
											}
										}
									echo $gmt_fab_color;  ?>
			  					</td>


			  					<?
								$color_qty=0; $greyQty=0;
			  					foreach($size_id_array as $id=>$val)
			  					{
			  						?>
			  						<td  style="word-break: break-all;word-wrap: break-word;" width="40"  align="center"><? echo $cuff_grey_qty=$size_item_wise_qnty[$row[csf("body_part_id")]][$row[csf("fabric_cost_dtls_id")]][$row[csf("gmts_color_id")]][$id][$size_with_item_size_array[$id][$bpart_id]]["grey"];//.'K '.$row[csf("fabric_cost_dtls_id")].'='.$row[csf("gmts_color_id")].'='.$id.'='.$size_with_item_size_array[$id];
									?></td>

			  						<?
			  						$size_wise_qnty_array[$id]+=$val;
									$grand_size_wise_qnty_array[$id]+=$cuff_grey_qty;$sub_size_wise_qnty_array[$bpart_id][$id]+=$cuff_grey_qty;
									$color_qty+=$cuff_grey_qty;

			  					}
								$row_excess_per= $color_wise_excess_per_arr[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf("gmts_color_id")]][$item_id]["row_excess_per"];
			  					?>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="60" align="center">
			  						<? echo $grey_qnty=$color_qty;//$color_wise_qnty[$row[csf('gmts_color_id')]][$item_id]["grey"];  ?>
			  					</td>

			  					<td  style="word-break: break-all;word-wrap: break-word;" title="<? echo $row_excess_per;?>" width="50" align="center">
			  						<?  $excess= $color_wise_excess_per_arr[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf("gmts_color_id")]][$item_id]["excess_per"]/$row_excess_per;
									echo number_format($excess,2);
									  ?>
			  					</td>


			  					<td style="word-break: break-all;word-wrap: break-word;" title="<? echo $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["row_rate"];?>"  width="50" align="center">
			  						<? echo  $cuff_price=$color_wise_qnty2[$row[csf("fabric_cost_dtls_id")]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["rate"];
										//$tot_row_rate=$color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["row_rate"];  ?>
			  					</td>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="40" align="center">
			  						<? $amount=$grey_qnty*$cuff_price; echo number_format( $amount,4); ?>
			  					</td>
			  				</tr>
			  				<?

							$sub_collor_qty_arr[$row[csf("body_part_id")]]+=$grey_qnty;
							$sub_collor_amount_arr[$row[csf("body_part_id")]]+=$amount;

							$sub_excess_arr[$row[csf("body_part_id")]]+=$excess;
							$sub_price_arr[$row[csf("body_part_id")]]+=$cuff_price;
							$cuff_body_wise_avg_row[$row[csf("body_part_id")]]+=1;

							$gr_fin_qty+=$fin_qty;
			  				$gr_collor_qty+=$grey_qnty;
							$gr_amount+=$amount;
			  				$gr_excess+=$excess ;
			  				$gr_col_avg_price+=$cuff_price;
			  				$gr_col_avg_row++;



			  				$p++;
			  			}
			  			?>
						<tr class="tbl_bottom">
							<td colspan="9" align="right">Total </td>
							<?
							foreach($size_id_array as $id=>$val)
							{
								?>
								<td  align="center"><? echo $sub_size_wise_qnty_array[$bpart_id][$id];?></td>

								<?
							}
							$cuff_sub_excess=$sub_excess_arr[$bpart_id];
							$cuff_sub_price=$sub_price_arr[$bpart_id];
							$cuff_body_wise_avg_tot_row=$cuff_body_wise_avg_row[$bpart_id];
							?>
							<td align="center">
								<? echo $sub_collor_qty_arr[$bpart_id];  ?>
							</td>
							<td align="center" title="Sub Exess & sub Row=<? echo $cuff_sub_excess.'='.$cuff_body_wise_avg_tot_row ?>">
									<? echo number_format($cuff_sub_excess/$cuff_body_wise_avg_tot_row,2); ?></td>
							<td align="center"><? echo number_format($cuff_sub_price/$cuff_body_wise_avg_tot_row,2); ?></td>

							<td align="center">
								<? echo number_format($sub_collor_amount_arr[$bpart_id],4);   ?>
							</td>
			  			</tr>
						<!--Sub TOT End-->


			  			<?
						} //Body Part End
						?>

						<tr>
			  				<td colspan="9" align="right">Grand Total </td>
			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td  align="center"><? echo $grand_size_wise_qnty_array[$id];?></td>

			  					<?
			  				}
			  				?>
			  				<td align="center">
			  					<? echo $gr_collor_qty;  ?>
			  				</td>
			  				<td align="center" title="Sub Exess & Tot Row=<? echo $gr_excess.'='.$gr_avg_row ?>"><? echo number_format($gr_excess/$gr_col_avg_row,2); ?></td>
							<td align="center"  title="Tot Price  & Tot Row=<? echo $gr_col_avg_price.'='.$gr_col_avg_row.'**'.$p?>"><? //echo number_format($gr_col_avg_price/$gr_col_avg_row,2); ?></td>

			  				<td align="center">
			  					<? echo number_format($gr_amount,4);   ?>
			  				</td>
			  			</tr>

						</table>
						<?
			  		}
			  	?>


					<br/><br/>

						<?
	     	  $sql_collar_cuff= "SELECT a.rate,a.amount, a.job_no , a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,b.gmts_color_id,b.size_number_id,b.item_size,b.gmts_qty,b.excess_per,b.qty,b.po_break_down_id as po_id,b.id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id) and a.body_part_type=50 and b.status_active=1 and b.is_deleted=0  order by a.body_part_id,b.gmts_color_id,b.id " ;
	         $sql_data_collar_cuff=sql_select($sql_collar_cuff);
	         $size_id_array=array();
	         $size_with_item_size_array=array();
	         $size_item_wise_qnty=array();
	         $color_wise_qnty=array();
	         foreach($sql_data_collar_cuff as $vals)
	         {
	         	$body_part_array[$vals[csf("body_part_id")]]=$vals[csf("body_part_id")];
				$size_id_array[$vals[csf("size_number_id")]]=$vals[csf("size_number_id")];
	         	$size_with_item_size_array[$vals[csf("size_number_id")]][$vals[csf("body_part_id")]]=$vals[csf("item_size")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["grey"]+=$vals[csf("qty")];

	         	//$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]=$vals[csf("excess_per")];
				if($vals[csf("excess_per")]>0)
				{
				$color_wise_excess_per_cuff_arr[$vals[csf('fabric_cost_dtls_id')]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]+=$vals[csf("excess_per")];
				$color_wise_excess_per_cuff_arr[$vals[csf('fabric_cost_dtls_id')]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_excess_per"]+=1;
				}
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["grey"]+=$vals[csf("qty")];
	         	/*$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];*/
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["amount"]=$vals[csf("amount")];
				$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_rate"]=1;

	         }
				unset($sql_data_collar_cuff);
	         $sql_collar_cuff3 = sql_select("SELECT c.rate, a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id, c.gmts_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls c WHERE a.job_no=c.job_no and a.id=c.pre_cost_fabric_cost_dtls_id and  a.id=c.pre_cost_fabric_cost_dtls_id and c.booking_no =$txt_booking_no and c.job_no in ($all_jobs_id) and a.body_part_type=50 and c.status_active=1 and c.is_deleted=0  order by a.body_part_id");

	         foreach($sql_collar_cuff3 as $vals)
	         {

	         	$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];

	         }


	         $counts=count($size_id_array);$grand_size_wise_qnty_array=array();
	          if(count($body_part_array)>0)
	          {
					$gr_collor_qty=$gr_amount=$gr_avg_price=$gr_avg_row=$gr_excess=0;
					foreach($body_part_array as $bpart_id=>$val)
					{
					 $sql_collar_cuff2= "SELECT a.rate,a.amount, a.job_no , a.id as fabric_cost_dtls_id,a.color_size_sensitive, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,b.gmts_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and a.body_part_id=$bpart_id and b.job_no in ($all_jobs_id) and a.body_part_type=50  and b.status_active=1 and b.is_deleted=0  group by  a.rate,a.amount, a.job_no , a.id , a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition,a.gsm_weight,a.width_dia_type,b.gmts_color_id,a.color_size_sensitive  order by a.body_part_id,b.gmts_color_id  " ;
	          $sql_data_collar_cuff2=sql_select($sql_collar_cuff2);
					?>

			  	 <table align="left"  width="100%" style="margin-top: 5px; margin-bottom:10px;"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" >
			  			<tr>
			  				<td colspan="<? echo $counts+13;?>" align="center">
			  					<strong>Cuff Details &nbsp;(<? echo  $body_part[$bpart_id];?>) </strong>
			  				</td>
			  			</tr>
			  			<tr>
			  				<td  width="30"  rowspan="2" align="center"><strong>SL</strong> </td>
			  				<td  width="150" rowspan="2" align="center"><strong>Style</strong></td>
 			  				<td  width="140" rowspan="2" align="center"><strong>Gmts Item</strong></td>
 			  				<td  width="100" rowspan="2" align="center"><strong>Body Part</strong></td>
							<td  width="100" rowspan="2" align="center"><strong>Actual Qty(Pcs)</strong></td>
			  				<td  width="390" rowspan="2" align="left">&nbsp;&nbsp;<strong>Cuff Composition</strong></td>
			  				<td  width="100" rowspan="2" align="center"><strong>Color Type</strong></td>
 			  				<td  width="100" rowspan="2"  align="center"><strong>Combo</strong></td>
							<td  width="100" rowspan="2"  align="center"><strong>Fabric Color</strong></td>
 			  				<?
 			  				foreach($size_id_array as $id=>$val)
 			  				{
 			  					?>
 			  					<td width="40" align="center"><strong><? echo $size_library[$id];?></strong></td>

 			  					<?
 			  				}
 			  				?>

			  				<td width="60"  rowspan="2" align="center"><strong> Req Qty(Pcs) </strong> </td>
			  				<td  width="50" rowspan="2"  align="center"><strong> Excess %  </strong> </td>

			  				<td width="50" rowspan="2"  align="center"><strong>Price/Pcs</strong></td>
			  				<td  width="40" rowspan="2" align="center"><strong>Amount</strong></td>
			  			</tr>
			  			<tr>
			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td width="40"  align="center"><strong><? echo $size_with_item_size_array[$id][$bpart_id];?></strong></td>
			  					<?
			  				}
			  				?>
			  			</tr>
			  			<?
			  			$p=1;
			  			$size_wise_qnty_array=array();
			  			foreach($sql_data_collar_cuff2 as $row)
			  			{
							?>
			  				<tr>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="30" align="center"><? echo $p;?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="150" align="center"><? echo $job_wise_style[$row[csf("job_no")]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="140" align="center"><?  $item_id= $row[csf('item_number_id')];echo $garments_item[$item_id]; ?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center"><? echo $body_part[$row[csf("body_part_id")]];?></td>
								<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center"><? $gmt_actual_qty=$gmts_qty_data_arr[$row[csf('job_no')]][$item_id][$row[csf('gmts_color_id')]];echo number_format($gmt_actual_qty,0);$total_gmt_actual_qty+=$gmt_actual_qty;?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="390" align="left"> &nbsp;
			  						<? echo $row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$fabric_typee[$row[csf('width_dia_type')]] ;?>
			  					</td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center"><? echo $color_type[$row[csf('color_type_id')]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center">
			  						<? echo $color_library[$row[csf('gmts_color_id')]];  ?>
			  					</td>
								<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center">
			  						<?
									if($row[csf('color_size_sensitive')]==1 or $row[csf('color_size_sensitive')]==2 or $row[csf('color_size_sensitive')]==4)
										{
											$gmt_fab_color=$color_library[$row[csf('gmts_color_id')]];
										}
										else
										{
											$contrast_color_id=return_field_value("b.contrast_color_id as contrast_color_id", "wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b", "a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.job_no in ($all_jobs_id) and a.id=".$row[csf('fabric_cost_dtls_id')]."  and b.gmts_color_id=".$row[csf('gmts_color_id')]." ","contrast_color_id");//pre_cost_fabric_cost_dtls_id
											if($contrast_color_id>0)
											{
												$gmt_fab_color=$color_library[$contrast_color_id];
											}
										}
									echo $gmt_fab_color;   ?>
			  					</td>

			  					<?
								$tot_size_qty=0;
			  					foreach($size_id_array as $id=>$val)
			  					{
			  						?>
			  						<td  style="word-break: break-all;word-wrap: break-word;"  width="40"  align="center"><? echo $size_grey_qty=$size_item_wise_qnty[$row[csf("body_part_id")]][$row[csf('fabric_cost_dtls_id')]][$row[csf("gmts_color_id")]][$id][$size_with_item_size_array[$id][$row[csf("body_part_id")]]]["grey"];?></td>

			  						<?
			  						$size_wise_qnty_array[$id]+=$size_grey_qty;$sub_size_wise_qnty_array[$row[csf("body_part_id")]][$id]+=$size_grey_qty;
									$grand_size_wise_qnty_array[$id]+=$size_grey_qty;
									$tot_size_qty+=$size_grey_qty;

			  					}
			  					?>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="60" align="center">
			  						<? echo $grey_qnty=$tot_size_qty;//$color_wise_qnty[$row[csf('gmts_color_id')]][$item_id]["grey"];
									$row_excess_per=$color_wise_excess_per_cuff_arr[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf("gmts_color_id")]][$item_id]["row_excess_per"];
									 ?>
			  					</td>

			  					<td  style="word-break: break-all;word-wrap: break-word;" title="excess tot=<? echo $row_excess_per; ?>"  width="50" align="center">
			  						<?  $avg_excess=$color_wise_excess_per_cuff_arr[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf("gmts_color_id")]][$item_id]["excess_per"]/$row_excess_per;echo number_format($avg_excess,2);   ?>
			  					</td>
			  					<td   style="word-break: break-all;word-wrap: break-word;" width="50" title="<? echo $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["row_rate"];?>" align="center">
			  						<? echo $price= $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["rate"];
									$tot_row_rate= $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["row_rate"]; ?>
			  					</td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="40" align="center">
			  						<? $amount=$grey_qnty*$price; echo number_format($amount,4); ?>
			  					</td>

			  				</tr>
			  				<?
			  				$sub_collor_qty_arr[$row[csf("body_part_id")]]+=$grey_qnty;
							$sub_collor_amount_arr[$row[csf("body_part_id")]]+=$amount;
							$sub_excess_arr[$row[csf("body_part_id")]]+=$avg_excess;
							$sub_price_arr[$row[csf("body_part_id")]]+=$price;
							$body_wise_avg_row[$row[csf("body_part_id")]]+=1;

							$gr_fin_qty+=$fin_qty;
			  				$gr_collor_qty+=$grey_qnty;
			  				$gr_avg_price+=$price;
							$gr_amount+=$amount;
			  				$gr_excess+=$avg_excess;

			  				$gr_avg_row++;

			  				$p++;
			  			}
			  			?>

			  			<tr>
			  				<td colspan="9" align="right">Total </td>
			  				<?
							//$sub_size_wise_qnty_array=array();
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td  align="center"><? echo $sub_size_wise_qnty_array[$bpart_id][$id];
								//$sub_size_wise_qnty_array[$row[csf("body_part_id")]][$id]=0;
								/*$grand_size_wise_qnty_array[$id]+=$sub_size_wise_qnty_array[$bpart_id][$id];*/
								?></td>
			  					<?
			  				}
							$tot_avg_row=$body_wise_avg_row[$bpart_id];
							$tot_sub_excess=$sub_excess_arr[$bpart_id];
							$tot_sub_price=$sub_price_arr[$bpart_id];
			  				?>
			  				<td align="center">
			  					<? echo $sub_collor_qty_arr[$bpart_id];  ?>
			  				</td>
			  				<td align="center" title="Tot Excess & Tot Row=<? echo $tot_sub_excess.'='.$tot_avg_row;?>"><? echo number_format($tot_sub_excess/$tot_avg_row,2); ?></td>
			  				<td align="center">
			  					<? echo number_format($tot_sub_price/$tot_avg_row,2);  ?>
			  				</td>
			  				<td align="center">
			  					<? echo number_format($sub_collor_amount_arr[$bpart_id],4);   ?>
			  				</td>
			  			</tr>
			  			<?
						} //Body Part End

			  		?>
					<tr>
			  				<td colspan="9" align="right">Grand Total </td>
			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td  align="center"><? echo $grand_size_wise_qnty_array[$id];?></td>
			  					<?
			  				}
			  				?>
			  				<td align="center">
			  					<? echo $gr_collor_qty;  ?>
			  				</td>
			  				<td align="center" title="grand Excess &tot row=<? echo $gr_excess.'='.$gr_avg_row;?>"><? echo number_format($gr_excess/$gr_avg_row,2); ?></td>
			  				<td align="center">
			  					<? //echo number_format($gr_avg_price/$gr_avg_row,2);  ?>
			  				</td>
			  				<td align="center">
			  					<? echo number_format($gr_amount,4);   ?>
			  				</td>
			  			</tr>
			  	</table>
				<?
					}
				?>

				</div>
			<br>
			<table  style="margin-top: 5px;float: left; display:none"    width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

				<tr>
					<td colspan="10" align="center">
						<strong>Comments</strong>
					</td>
				</tr>
				<tr>
					<td align="center"> SL </td>
					<td align="center" width="200"  style="word-wrap: break-word;word-break: break-all;"> PO NO </td>
					<td align="center"> Ship Date </td>
					<td align="center">BOM Qty</td>
					<td align="center"> Booking Qty </td>
					<td align="center"> Short Booking Qty </td>
					<td align="center"> Total Booking Qty </td>
					<td align="center"> Balance </td>
					<td align="center"> Comments </td>
				</tr>
				<?
				$is_short_data=sql_select("SELECT a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0   and b.is_short =1 group by  a.id ");
				foreach($is_short_data as $vals)
				{
					$short_qty_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
				}

				$booking_data=sql_select("SELECT a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and  b.status_active=1 and b.is_deleted=0 and b.is_short !=1 group by  a.id  order by a.id");
				foreach($booking_data as $vals)
				{
					$booking_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
				}

				$po_date=return_library_array("select id,shipment_date from wo_po_break_down where status_active=1 and is_deleted=0",'id','shipment_date');

				$comments_data=sql_select("SELECT min(a.id) as ids,b.po_break_down_id as po_number,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,SUM(b.requirment) as precost_grey_qty FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id
					and
					b.po_break_down_id=d.po_break_down_id and
					b.color_number_id=d.gmts_color_id and
					b.dia_width=d.dia_width and
					b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					a.job_no=d.job_no and
					a.id=d.pre_cost_fabric_cost_dtls_id
					and
					d.booking_no =$txt_booking_no and
					d.job_no in($all_jobs_id) and

					d.status_active=1 and
					d.is_deleted=0 and
					b.cons>0
					group by b.po_break_down_id order by b.po_break_down_id");



				$job_no=$all_jobs_id;
				$condition= new condition();
				if(str_replace("'","",$job_no) !='')
				{
					$condition->job_no("in ($job_no)");
				}
				$condition->init();
				$fabric= new fabric($condition);
				$fabric_costing_qty_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish();

				$j=1;
				$total_bom=0;
				$total_book=0;
				$total_short=0;
				$total_short_full=0;
				$total_balance=0;
				foreach($comments_data as $val)
				{
					$po_id=$val[csf('po_number')];
					$woven_qty=array_sum($fabric_costing_qty_arr['woven']['grey'][$po_id]);
					$knit_qty=array_sum($fabric_costing_qty_arr['knit']['grey'][$po_id]);
					$sum_woven_knit=$woven_qty + $knit_qty;


					?>
					<tr>
						<td align="center"><? echo $j;?></td>

						<td align="center"  style="word-wrap: break-word;word-break: break-all;"> <? echo $po_num_arr[$val[csf("po_number")]] ;?> </td>
						<td align="center"> <? echo change_date_format($po_date[$val[csf("po_number")]], "yyyy-mm-dd", "-");?> </td>
						<td align="center"><?  echo $pre= def_number_format($sum_woven_knit,2);  ?> </td>
						<td align="center"><?  echo $bookings= def_number_format($booking_arr[$val[csf("po_number")]],2);  ?> </td>
						<td align="center"> <?echo $short=def_number_format($short_qty_arr[$val[csf("po_number")]],2); ?> </td>
						<td align="center"> <?   $tot_short_book= str_replace(',','',$bookings) +  str_replace(',','',$short) ; echo def_number_format($tot_short_book,2); ?>  </td>
						<td align="center"> <?  $bal =str_replace(',','',$pre)-str_replace(',','',$tot_short_book) ; echo def_number_format($bal,2);  ?> </td>
						<td align="center"> <? if($bal!=0){ if($pre>$tot_short_book){echo "Less ";} else{ echo "Over";} }?> </td>


					</tr>
					<?
					$total_bom +=str_replace(',','',$pre);
					$total_book +=str_replace(',','',$bookings);
					$total_short +=str_replace(',','',$short);
					$total_short_full += str_replace(',','',$tot_short_book);
					$total_balance += str_replace(',','',$bal);

					$j++;
				}
				?>
				<tr>
					<td colspan="3" align="right"> <b> Total </b></td>
					<td align="center"><strong><? echo def_number_format($total_bom,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_book,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_short,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_short_full,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_balance,2);?> </strong> </td>
					<td>&nbsp;</td>
				</tr>
			</table>
			<br>


			<?
			if($cbo_fabric_source==1 || $cbo_fabric_source==2 || $cbo_fabric_source==3){
			?>


	<?
	//------------------------------ Query for TNA start-----------------------------------
	$po_id_all=str_replace("'","",$txt_order_no_id);
	$po_num_arr=return_library_array("SELECT id,po_number from wo_po_break_down where job_no_mst in($all_jobs_id)",'id','po_number');
	$tna_start_sql=sql_select( "SELECT id,po_number_id,
	(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
	(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
	(case when task_number=60 then task_start_date else null end) as knitting_start_date,
	(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
	(case when task_number=61 then task_start_date else null end) as dying_start_date,
	(case when task_number=61 then task_finish_date else null end) as dying_end_date,
	(case when task_number=64 then task_start_date else null end) as finishing_start_date,
	(case when task_number=64 then task_finish_date else null end) as finishing_end_date,
	(case when task_number=84 then task_start_date else null end) as cutting_start_date,
	(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
	(case when task_number=86 then task_start_date else null end) as sewing_start_date,
	(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
	(case when task_number=110 then task_start_date else null end) as exfact_start_date,
	(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
	(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
	(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
	from tna_process_mst
	where status_active=1 and po_number_id in($po_id_all) and job_no in ($all_jobs_id) order by po_number_id");
 	$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
	$tna_date_task_arr=array();
	foreach($tna_start_sql as $row)
	{
		if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
		{
			if($tna_fab_start=="")
			{
				$tna_fab_start=$row[csf("fab_booking_start_date")];
			}
		}
		if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
		}
		if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
		}
		if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
		}
		if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
		}
		if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
		}
		if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
		}
		if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
		}
	}
	//------------------------------ Query for TNA end-----------------------------------
	if(count($tna_start_sql)>0 )
	{
		?>
		<br>
		<fieldset id="div_size_color_matrix" style="max-width:1000; display:none;">
			<legend>TNA Information</legend>
			<table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
				<tr>
					<td rowspan="2" align="center" valign="top">SL</td>
					<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
					<td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
					<td colspan="2" align="center" valign="top"><b>Knitting</b></td>
					<td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
					<td colspan="2" align="center" valign="top"><b>Finishing Fabric</b></td>
					<td colspan="2" align="center" valign="top"><b>Cutting </b></td>
					<td colspan="2" align="center" valign="top"><b>Sewing </b></td>
					<td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
				</tr>
				<tr>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
				</tr>
				<?
				$i=1;
				foreach($tna_date_task_arr as $order_id=>$row)
				{
					?>
					<tr>
						<td><? echo $i; ?></td>
						<td><? echo $po_num_arr[$order_id]; ?></td>
						<td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
						<td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
						<td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
					</tr>
					<?
					$i++;
				}
				?>
			</table>
		</fieldset>
		<?
	}
	}// fabric Source End
	?>
	<br>
	<br>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
				<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
					<thead>
						<tr>
							<th width="3%"></th><th width="97%" align="left"><u>Special Instruction</u></th>
						</tr>
					</thead>
					<tbody>
						<?
						$data_array=sql_select("select id, terms from  wo_booking_terms_condition where booking_no=$txt_booking_no");
						if ( count($data_array)>0)
						{
							$i=0;
							foreach( $data_array as $row )
							{
								$i++;
								?>
								<tr id="settr_1" valign="top">
									<td style="vertical-align:top">
										<? echo $i;?>
									</td>
									<td>
										<strong style="font-size:16px"> <? echo $row[csf('terms')]; ?></strong>
									</td>
								</tr>
								<?
							}
						}
						?>
					</tbody>
				</table>
			</td>

		</tr>
	</table>
	<br/><br/><br/><br/>
		    <table  width="100%"  border="0" cellpadding="0" cellspacing="0">
		    	<tr>
		            <td>  <?
		                    echo signature_table(121, $cbo_company_name, "1330px",1,'');
						//	$job_no_all= implode(",",array_unique($joball['job_no']));
							//$style_sting_all=implode(",",array_unique($joball['style_ref_no']));
							//echo "****".custom_file_name($txt_booking_no,$style_sting_all,$job_no_all);
		                ?>
		            </td>
		        </tr>
		    </table>
	</div>
	<?
			
			$html = ob_get_contents();
			ob_clean();
			list($is_mail_send,$mail)=explode('___',$mail_send_data);
		
			if($is_mail_send==1){
				require_once('../../../mailer/class.phpmailer.php');
				require_once('../../../auto_mail/setting/mail_setting.php');
				$mailBody = preg_replace("/<img[^>]+\>/i", " ", $html); 
				$mailBody="<br>".$mail_body	;	
				$mailToArr=array();
				$mailSql = "select b.EMAIL  from wo_booking_mst a,LIB_SUPPLIER b where b.id=a.supplier_id and a.booking_no=$txt_booking_no";
			//echo $mailSql;die;
				$mailSqlRes=sql_select($mailSql);
				foreach($mailSqlRes as $rows){
					if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
				}
				
				
				$mailSql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=99 and b.mail_user_setup_id=c.id  and c.IS_DELETED=0 and c.STATUS_ACTIVE=1";
				//echo $mailSql;die;
				$mailSqlRes=sql_select($mailSql);
				foreach($mailSqlRes as $rows){
					if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
				}
				if($mail!=''){$mailToArr[]=$mail;}
		
				$to=implode(',',$mailToArr);
				$subject="Partial fabric booking";
				$header=mailHeader();
				echo $to;
				echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
				
			}
			else{
				echo $html;
			}
			exit();
}

if($action=="print_booking_16") // md mamun -09-06-2022-ISD-12897
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' or form_name='knit_order_entry' and file_type=1",'master_tble_id','image_location');
	$company_library=return_library_array( "select id,company_name from lib_company where status_active=1 and is_deleted=0", "id", "company_name");
	$color_library=return_library_array( "select id,color_name from lib_color  where status_active=1 and is_deleted=0", "id", "color_name");
	$size_library=return_library_array( "select id,size_name from lib_size  where status_active=1 and is_deleted=0", "id", "size_name");
	$country_arr=return_library_array( "select id,country_name from   lib_country  where status_active=1 and is_deleted=0",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier  where status_active=1 and is_deleted=0",'id','supplier_name');
	$contact_no_arr=return_library_array( "select id,contact_no from   lib_supplier  where status_active=1 and is_deleted=0",'id','contact_no');
	$designation_arr=return_library_array( "select id,designation from   lib_supplier  where status_active=1 and is_deleted=0",'id','designation');
	$supplier_address_arr=return_library_array( "select id,address_1 from   lib_supplier  where status_active=1 and is_deleted=0",'id','address_1');
	$supplier_contact_person_arr=return_library_array( "select id,contact_person from   lib_supplier  where status_active=1 and is_deleted=0",'id','contact_person');
	$comp_contact_person_arr=return_library_array( "select id,contract_person from lib_company where status_active=1 and is_deleted=0", "id", "contract_person");
	$employee_code_arr=return_library_array( "select id,employee_code from user_passwd  where status_active=1 ",'id','employee_code');
	$user_email_arr=return_library_array( "select id,user_email from user_passwd  where status_active=1 ",'id','user_email');


	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info  where status_active=1 and is_deleted=0","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer  where status_active=1 and is_deleted=0",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location  where status_active=1 and is_deleted=0",'id','location_name');
	$user_name_arr=return_library_array( "select id,user_name from user_passwd  where status_active=1 ",'id','user_name');

	$user_name_sql=sql_select( "select d.id,d.user_name,d.user_email,d.employee_code,c.inserted_by from user_passwd d,wo_booking_mst c  where d.status_active=1 and d.is_deleted=0 and d.id=c.inserted_by");
	foreach ($user_name_sql as $row)
	{
		$user_email[$row[csf("id")]][$row[csf("user_name")]]=$row[csf("user_email")];
		$employee_code[$row[csf("id")]][$row[csf("employee_code")]]=$row[csf("employee_code")];
	}
	$po_sql=sql_select("select id,po_number,grouping from wo_po_break_down where status_active=1 and is_deleted=0 and id in(select po_break_down_id from wo_booking_dtls where status_active=1 and is_deleted=0 and booking_no=$txt_booking_no)");
	$int_ref_no="";
	foreach ($po_sql as $row)
	{
		$po_num_arr[$row[csf("id")]]=$row[csf("po_number")];
		$int_ref_no.=$row[csf("grouping")].',';
	}

	$uom=0;
	$joball=array();
	
	// $nameArray_per_job=sql_select( "SELECT  a.season_buyer_wise,  a.job_no,a.style_ref_no ,a.season_matrix,a.gmts_item_id,a.product_dept,d.id,max(c.booking_date) as booking_date ,max(c.delivery_date) as delivery_date,max(c.is_approved) as is_approved,max(c.buyer_id) as buyer_id,max(c.pay_mode) as pay_mode,max(c.source) as source,max(supplier_id) as supplier_id,max(a.dealing_marchant) as dealing_marchant,max(c.attention) as attention,max(c.currency_id) as currency_id,max(c.fabric_source) as fabric_source ,max(c.remarks)  as remarks,max(c.inserted_by)  as inserted_by from wo_po_details_master a , wo_booking_dtls b,wo_booking_mst c where c.booking_no=b.booking_no and  c.status_active=1 and c.is_deleted=0 and  a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by  a.season_buyer_wise, a.job_no,a.style_ref_no ,a.season_matrix,a.gmts_item_id,a.product_dept ");
	$nameArray_per_job=sql_select( "SELECT  a.season_buyer_wise,  a.job_no,a.style_ref_no ,a.season_matrix,a.gmts_item_id,a.product_dept,max(c.booking_date) as booking_date ,max(c.delivery_date) as delivery_date,max(c.is_approved) as is_approved,max(c.buyer_id) as buyer_id,max(c.pay_mode) as pay_mode,max(c.source) as source,max(supplier_id) as supplier_id,max(a.dealing_marchant) as dealing_marchant,max(c.attention) as attention,max(c.currency_id) as currency_id,max(c.fabric_source) as fabric_source ,max(c.remarks)  as remarks,max(c.inserted_by)  as inserted_by from wo_po_details_master a , wo_booking_dtls b,wo_booking_mst c  where c.booking_no=b.booking_no and c.status_active=1 and c.is_deleted=0 and  a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by  a.season_buyer_wise, a.job_no,a.style_ref_no ,a.season_matrix,a.gmts_item_id,a.product_dept ");
	foreach ($nameArray_per_job as $vals)
	{
		$joball['job_no'][$row_per_job[csf('job_no')]]=$row_per_job[csf('job_no')];
		$joball['style_ref_no'][$row_per_job[csf('job_no')]]=$row_per_job[csf('style_ref_no')];
		$all_job_arr[$vals[csf("job_no")]]["job"]="'".$vals[csf("job_no")]."'";
		$all_job_arr[$vals[csf("job_no")]]["style"]=$vals[csf("style_ref_no")];
		$all_job_arr[$vals[csf("job_no")]]["item"]=$vals[csf("gmts_item_id")];
		$all_jobs[$vals[csf("job_no")]]="'".$vals[csf("job_no")]."'";
		$all_jobs_no_arr[$vals[csf("job_no")]]=$vals[csf("job_no")];
		$job_wise_style[$vals[csf("job_no")]]= $vals[csf("style_ref_no")];
	}
	$all_jobs_id=implode(",",$all_jobs );
	$all_jobs_nos=implode(",",$all_jobs_no_arr );

 //	echo $all_jobs_id.'SSSA';
	$int_ref_no=rtrim($int_ref_no,',');
	if($int_ref_no!='')
	{
		$job_int_ref=implode(",", array_unique(explode(",",$int_ref_no)));
	}




	$path=str_replace("'","",$path);
	if($path=="")
	{
	$path='../../';
	}
	
	?>
	<style type="text/css">

		body, p, span, td, a {font-size:10pt;font-family: Arial;}
		body{margin-left:2em; margin-right:2em; font-family: "Arial Narrow", Arial, sans-serif;}

	</style>
	<? ob_start(); ?>
	<div style="width:1330px" align="center" >

		<table id="tb_header" width="100%" cellpadding="0" cellspacing="0" style="border:0px solid black" >
			<thead>
				<tr>
					<td width="110" rowspan="3">
						<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100' width='100' />
					</td>

					<td width="500" colspan="2" align="center" style="font-size: 16px;"><b><?php echo $company_library[$cbo_company_name]; ?></b></td>
					<td width="200">&nbsp;</td>
					
				</tr>

				<tr>

					<td  width="500" colspan="2" align="left">
						<?
						$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
						foreach ($nameArray as $result)
						{
							?>
							Plot No: <? echo $result[csf('plot_no')]; ?>
							Level No: <? echo $result[csf('level_no')]?>
							Road No: <? echo $result[csf('road_no')]; ?>
							Block No: <? echo $result[csf('block_no')];?>
							City No: <? echo $result[csf('city')];?>
							Zip Code: <? echo $result[csf('zip_code')]; ?>
							Province No: <?php echo $result[csf('province')]; ?>
							Country: <? echo $country_arr[$result[csf('country_id')]]; ?><br>
							Email Address: <? echo $result[csf('email')];?>
							Website No: <? echo $result[csf('website')];
						}
							?>

					</td>
					<td width="200">&nbsp;</td>
					
				</tr>

				<tr>

					<!-- <td  width="500" colspan="2" align="left" style="font-size: 16px;"><b>Multi-Job Fabric Booking-<? echo $fabric_source[$nameArray_per_job[0][csf("fabric_source")]];?></b></td> -->
					<td  width="500" colspan="2" align="center" style="font-size: 16px;"><b>Fabric Booking</b></td>
					<td width="200">&nbsp;</td>
					
				</tr>

				<tr>
					<td colspan="4" width="700">&nbsp;</td>
					
				</tr>
				<tr>
					<td colspan="4" height="11">&nbsp;</td>
				</tr>
				<tr>
					<td width="300"><b>To</b></td>
					<td colspan="3" width="700">&nbsp;</td>
					<td width="300" align="left"><b>Booking No: </b><?php echo str_replace("'", "", $txt_booking_no); ?></td>
				</tr>

				<tr>
					<td width="300"><?
					$attention="";
					$pay_mode_id=$nameArray_per_job[0][csf("pay_mode")];//pay_mode
					if($pay_mode_id!=3 && $pay_mode_id!=5)
					{
						echo $supplier_name_arr[$nameArray_per_job[0][csf("supplier_id")]];
						$attention=$supplier_contact_person_arr[$nameArray_per_job[0][csf("supplier_id")]];
					}
					else
					{
						echo $company_library[$nameArray_per_job[0][csf("supplier_id")]];
						$attention=$comp_contact_person_arr[$nameArray_per_job[0][csf("supplier_id")]];
					}?></td>
					<td colspan="3" width="700">&nbsp;</td>
					<td width="300" align="left"><b>Booking Date: </b><?php echo change_date_format($nameArray_per_job[0][csf("booking_date")]); ?></td>
				</tr>
				
				<tr>
					<td width="300" ><p><b>Address: </b><? echo $supplier_address_arr[$nameArray_per_job[0][csf("supplier_id")]]; ?> </p></td>
					<td colspan="3" width="700">&nbsp;</td>
					
					<td width="300" align="left"><b>Approval Status: </b><?php if ($nameArray_per_job[0][csf("is_approved")] == 1 || $nameArray_per_job[0][csf("is_approved")] == 3) {echo "Approved";}?></td>
					
				</tr>

				

				<tr>
				   <td width="300"><b>Attention: </b>   <? echo $attention; ?></td>
				   <td colspan="3" width="700">&nbsp;</td>
				   <td width="300"><b>Job No : </b>   <? echo $all_jobs_nos;?></td>

				</tr>
				<tr>
				   <td width="300" align="left"><b>Designation:   </b> <? echo $designation_arr[$nameArray_per_job[0][csf("supplier_id")]];; ?></td>
				   <td colspan="3" width="700">&nbsp;</td>
					<td width="300" align="left"><b>Responsible Merchandiser:   </b> <? echo $user_name_arr[$nameArray_per_job[0][csf("inserted_by")]]; ?></td>

				</tr>
				<tr>
				   <td width="300" align="left"><b>Contact Number:   </b> <? echo $contact_no_arr[$nameArray_per_job[0][csf("supplier_id")]];; ?></td>
				   <td colspan="3" width="700">&nbsp;</td>
				   <td width="300" align="left"><b>Contact No:   </b> 0<? echo $employee_code_arr[$nameArray_per_job[0][csf("inserted_by")]]; ?></td>

				</tr>

				<tr>
				   <td width="300" align="left"><b>Pay Mode:   </b> <? echo $pay_mode[$nameArray_per_job[0][csf("pay_mode")]]; ?></td>
				   <td colspan="3" width="700">&nbsp;</td>
				   <td width="300" align="left"><b>Email Id:   </b> <? echo $user_email_arr[$nameArray_per_job[0][csf("inserted_by")]]; ?></td>

				</tr>
				<tr>
				   <td width="300"><b>Currency : </b><? echo $currency[$nameArray_per_job[0][csf("currency_id")]];?></td>
				   <td colspan="3" width="700">&nbsp;</td>
				   <td width="300" align="left"><b>Buyer Name :   </b> <? echo $buyer_name_arr[$nameArray_per_job[0][csf("buyer_id")]]; ?></td>
				</tr>

				<tr>
				   <td width="300"><b>Source :  <? echo $source[$nameArray_per_job[0][csf("source")]]; ?> </b>    </td>
				   <td colspan="3" width="700">&nbsp;</td>
				   <td width="300" align="left"><b>Delivery Date: </b><?php echo change_date_format($nameArray_per_job[0][csf("delivery_date")]); ?></td>
				</tr>
				<tr>
				   <td width="400" align="left"><b>Remarks:   </b> <? echo $nameArray_per_job[0][csf("remarks")]; ?></td>
				</tr>
			</thead>
		</table>


			<?php

				$po_data = array();
				if ($db_type == 0) {
					$nameArray_job = sql_select("select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,DATEDIFF(pub_shipment_date,po_received_date) date_diff,MIN(po_received_date) as po_received_date ,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status  from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id)  group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
				}
				if ($db_type == 2) {
					$nameArray_job = sql_select("select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,(pub_shipment_date-po_received_date) date_diff,MIN(po_received_date) as po_received_date,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status   from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no in($all_jobs_id) group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
				}
				foreach ($nameArray_job as $result_job) {
					$po_data['po_id'][$result_job[csf('id')]] = $result_job[csf('id')];
					$po_data['po_number'][$result_job[csf('id')]] = $result_job[csf('po_number')];
					$po_data['leadtime'][$result_job[csf('id')]] = $result_job[csf('date_diff')];
					$po_data['po_quantity'][$result_job[csf('id')]] = $result_job[csf('po_quantity')];
					$po_data['po_received_date'][$result_job[csf('id')]] = change_date_format($result_job[csf('po_received_date')], 'dd-mm-yyyy', '-');
					$ddd = strtotime($result_job[csf('pub_shipment_date')]);
					$po_data['pub_shipment_date'][$ddd] = $ddd;

					$po_data['insert_date'][$result_job[csf('id')]] = $result_job[csf('insert_date')];

					if ($result_job[csf('shiping_status')] == 1) {
						$shiping_status = "FP";
					} else if ($result_job[csf('shiping_status')] == 2) {
						$shiping_status = "PS";
					} else if ($result_job[csf('shiping_status')] == 3) {
						$shiping_status = "FS";
					}
					$po_data['shiping_status'][$result_job[csf('id')]] = $shiping_status;
					$po_data['file_no'][$result_job[csf('id')]] = $result_job[csf('file_no')];
					$po_data['grouping'][$result_job[csf('id')]] = $result_job[csf('grouping')];
				}
				$txt_order_no_id = implode(",", array_unique($po_data['po_id']));
				$leadtime = implode(",", array_unique($po_data['leadtime']));
				$po_quantity = array_sum($po_data['po_quantity']);
				$po_received_date = implode(",", array_unique($po_data['po_received_date']));
				$po_number = implode(",", array_unique($po_data['po_number']));
				$shipment_date = date('d-m-Y', min($po_data['pub_shipment_date']));
				$maxshipment_date = date('d-m-Y', max($po_data['pub_shipment_date']));
				//$shipment_date=implode(",",array_unique($po_data['pub_shipment_date']));
				$shiping_status = implode(",", array_unique($po_data['shiping_status']));
				$file_no = implode(",", array_unique($po_data['file_no']));
				$grouping = implode(",", array_unique($po_data['grouping']));

				$colar_excess_percent = 0;
				$cuff_excess_percent = 0;
				$rmg_process_breakdown = 0;

 			?>
			<br/>
			<!--  Here will be the main portion  -->
			<?
			$costing_per="";
			$costing_per_qnty=0;
			$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no in($all_jobs_id)");
			if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;

			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";
				$costing_per_qnty=1;

			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;

			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;

			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;
			}
			//$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no in($all_jobs_id)");
			//wo_labtest_dtls

			//$labdip_no_arr=return_library_array( "select job_no,labtest_no from wo_labtest_mst a,wo_labtest_dtls b  where a.id=b.mst_id  and b.job_no in($all_jobs_id) and  b.status_active=1 and b.is_deleted=0",'job_no','labtest_no');
			$lab_dip_no_arr=array();
			$lab_dip_no_sql=sql_select("select lapdip_no, color_name_id,job_no_mst,po_break_down_id from wo_po_lapdip_approval_info where job_no_mst in($all_jobs_id) and status_active=1 and is_deleted=0 and approval_status=3 group by lapdip_no, color_name_id,job_no_mst,po_break_down_id ");
			foreach($lab_dip_no_sql as $row)
			{
				// $lab_dip_no_arr[$row[csf('color_name_id')]].=$row[csf('lapdip_no')].",";
				$lab_dip_no_arr[$row[csf('job_no_mst')]][$row[csf('po_break_down_id')]][$row[csf('color_name_id')]]=$row[csf('lapdip_no')];
			}
			unset($lab_dip_no_sql);
			//echo "select job_no,labtest_no from wo_labtest_mst a,wo_labtest_dtls b  where a.id=b.mst_id  and b.job_no in($all_jobs_id) and  b.status_active=1 and b.is_deleted=0";
		$data_img=sql_select("select image_location,master_tble_id  from common_photo_library  where   form_name='fabric_color_img' and is_deleted=0 and file_type=1");
	   $system_img_arr=array();
	  foreach($data_img as $row)
	   {
		  $system_img_arr[$row[csf('master_tble_id')]]['img']=$row[csf('image_location')];
	   }

			$uom_arr=array(1=>"Pcs",12=>"Kg",23=>"Mtr",27=>"Yds");
			$p=1;

		if($cbo_fabric_source==1 || $cbo_fabric_source==2 || $cbo_fabric_source==3)
		{
			$nameArray_fabric_description= sql_select("SELECT a.id as fabric_cost_dtls_id,d.dia_width as dia,a.construction,a.composition,a.fab_nature_id as fab_nat_id,a.gsm_weight,a.fabric_description as fab_desc, a.item_number_id as item_id, a.body_part_id,a.color_type_id as color_type,a.width_dia_type as width_dia,d.po_break_down_id as po_id,d.remark as fab_remark,a.uom,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,avg(d.rate) as rates,sum(d.amount) as amounts ,d.fabric_color_id,a.color_size_sensitive,a.color_break_down,d.gmts_color_id as color_id,d.job_no
			  FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
				WHERE a.job_no=d.job_no and
				a.id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				d.job_no in ($all_jobs_id) and
				d.status_active=1 and
				d.is_deleted=0 and
				d.fin_fab_qnty>0   and a.body_part_type not in(40,50)
				group by a.id,a.item_number_id,a.gsm_weight,a.fab_nature_id,a.fabric_description ,a.body_part_id,a.color_type_id,d.gmts_color_id,a.width_dia_type,d.po_break_down_id,d.remark,a.uom ,d.fabric_color_id,a.color_size_sensitive,a.color_break_down,d.job_no,d.dia_width,a.construction,a.composition  order by a.body_part_id,d.fabric_color_id ");

			foreach($nameArray_fabric_description as $row)
			{
				$item_desc= $body_part[$row[csf("body_part_id")]].",".$color_type[$row[csf("color_type_id")]].",".$row[csf("fab_desc")].','.$row[csf('dia')];
				$uom_data_arr[$row[csf('uom')]]=$row[csf('uom')];
				if($row[csf("color_type_id")]==2 || $row[csf("color_type_id")]==6)
				{
					$strip_color_arr[$row[csf('body_part_id')]][$row[csf('color_id')]]=$row[csf('fin_fab_qntys')];
				}
				$lab_dib=$lab_dip_no_arr[$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fabric_color_id')]];
				$lab_dip_arr[$lab_dib]=$lab_dib;
				$fabric_data_arr[$lab_dib][$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['dia']=$row[csf('dia')];
				$fabric_data_arr[$lab_dib][$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['color_type']=$row[csf('color_type')];
				$fabric_data_arr[$lab_dib][$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['width_dia']=$row[csf('width_dia')];
				$fabric_data_arr[$lab_dib][$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['uom']=$row[csf('uom')];
				$fabric_data_arr[$lab_dib][$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['item_id']=$row[csf('item_id')];
				$fabric_data_arr[$lab_dib][$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['gsm_weight']=$row[csf('gsm_weight')];
				$fabric_data_arr[$lab_dib][$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['dia_width']=$row[csf('dia_width')];
				$fabric_data_arr[$lab_dib][$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['construction']=$row[csf('construction')];
				$fabric_data_arr[$lab_dib][$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['composition']=$row[csf('composition')];
				$fabric_data_arr[$lab_dib][$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['fab_color_id']=$row[csf('fabric_color_id')];
				$fabric_data_arr[$lab_dib][$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['body_part_id']=$row[csf('body_part_id')];
				$fabric_data_arr[$lab_dib][$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['fab_remark']=$row[csf('fab_remark')];
				$fabric_data_arr[$lab_dib][$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['amount']=$row[csf('amounts')];
				$fabric_data_arr[$lab_dib][$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['fin_fab_qnty']=$row[csf('fin_fab_qntys')];
				$fabric_data_arr[$lab_dib][$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['color_size_sensitive']=$row[csf('color_size_sensitive')];
				$fabric_data_arr[$lab_dib][$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['color_break_down']=$row[csf('color_break_down')];
				$fabric_data_arr[$lab_dib][$row[csf('job_no')]][$row[csf('po_id')]][$row[csf('fab_nat_id')]][$item_desc][$row[csf('color_id')]]['fabric_cost_dtls_id']=$row[csf('fabric_cost_dtls_id')];

			}

			
					?>
					<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
									<caption> <strong style="font-size:20px">Fabric Booking Detail </strong> </caption>
									<tr>
										<th  width="30" align="center">SL</th>
										<th  width="100" align="center">Style Ref</th>
										<th  width="100" align="center">Order No</th>
										<th  width="70" align="center">Fabric Nature</th>
										<th  width="300" align="center">Fabric Description</th>
										<th  width="35" align="center">GSM</th>
										<th  width="120" align="center">FabricDia/ Width</th>
										<th  width="70" align="center">Color Type</th>
										<th  width="60" align="center">Gmts Color</th>
										<th  width="65" align="center">Fabric Color</th>
										<th  width="130" align="center">Lab Dip No</th>
										<th  width="45" align="center">UOM</th>
										<th  width="70" align="center">Finish Fab. Qty</th>
										<!-- <th  width="240" align="center">Image</th> -->
										<th width="80" align="center" title="">Avg Rate</th>
										<th width="80" align="center">Amount</th>
										<th width="100" align="center">Remark</th>

									</tr>
									<? //wo_pre_cos_fab_co_color_dtls
										$total_fin_fab_qnty=$total_amount=0;
										$k=1;
									foreach($fabric_data_arr as $lab_dip_id=>$fabric_data)
									{
										$sub_total_fin_fab_qnty=0;
										$sub_total_amount=0;									
									foreach($fabric_data as $style_id=>$style_data)
									{
									  foreach($style_data as $po_id=>$po_data)
									  {
									  	 foreach($po_data as $nat_id=>$nat_data)
									     {
										 	foreach($nat_data as $desc_id=>$desc_data)
									        {
												foreach($desc_data as $color_id=>$val)
									        	{

													
													
									
													
											if($val[('fab_remark')]=='no remarks')  $pre_cost_remarks="";else  $pre_cost_remarks=$val[('fab_remark')];
											$diaWidth=$val[('dia')];
											if($diaWidth!='') $diaWidth=$diaWidth.",";else $diaWidth="";
											?>
											<tr>
												<td align="center"> <? echo $k;?></td>
												<td align="center" title="<? echo $style_id;?>"> <? echo $all_job_arr[$style_id]["style"];?></td>
												<td align="center"> <? echo $po_num_arr[$po_id];?></td>
												<td align="center"><? echo $item_category[$nat_id];?></td>
												<td align="center"><? echo $desc_id;?></td>
												<td align="center"> <? echo $val[('gsm_weight')]; ?> </td>

												<td  align="center">
													<?
													echo $diaWidth.$fabric_typee[$val[('width_dia')]];
													?>
												</td>
												<td  align="center">
													<?
													echo $color_type[$val[('color_type')]];
													?>
												</td>
												<td  align="center">
													<?
													if($val[('color_size_sensitive')]==1 or $val[('color_size_sensitive')]==2 or $val[('color_size_sensitive')]==4)
													{
														echo $color_library[$val[('fab_color_id')]];
													}

													else
													{
														$color_break_down=$val[('color_break_down')];
														if($color_break_down)
														{
															$gmts_color="";
															if (strpos($color_break_down, '__') !== false)
															{
																$color_break_down=explode('__', $color_break_down);
																foreach ($color_break_down as $key => $value)
																{
																	$cols=explode('_', $value);
																	if(trim(strtolower($color_library[$val[('fab_color_id')]]))==trim(strtolower($cols[2])))
																	{
																		if($gmts_color=="")
																		{
																			$gmts_color=$cols[1];
																		}
																		else
																		{
																			$gmts_color .=','.$cols[1];
																		}

																	}
																}
															}
															else
															{
																$cols=explode('_', $color_break_down);
																if(trim(strtolower($color_library[$val[('fab_color_id')]]))==trim(strtolower($cols[2])))
																{
																	if($gmts_color=="")
																	{
																		$gmts_color=$cols[1];
																	}
																	else
																	{
																		$gmts_color .=','.$cols[1];
																	}

																}
															}

															echo $gmts_color;
														}

													}
													?>
												</td>
												<td  align="center" title="<?=$val[('fab_color_id')];?>">
													<?

													echo $color_library[$val[('fab_color_id')]];
													?>
												</td>
												<td align="center"><? echo $lab_dip_id;//$labdip_no_arr[$style_id]; ?></td>
												<td align="center"> <? echo $unit_of_measurement[$val[('uom')]]; ?></td>
												<td align="center"> <? echo def_number_format($val[("fin_fab_qnty")],2); ?></td>
													<!-- <td align="center"> <?
													$img_ref_id=$val[('fabric_cost_dtls_id')].'_'.$val[('fab_color_id')];
													$fab_color_img=$system_img_arr[$img_ref_id]['img'];

													//echo def_number_format($val[("fin_fab_qntys")],2);
													if($fab_color_img!='')
													{
													?>
													<img src='../../<? echo $fab_color_img; ?>' height='50' width='70' align="middle" />
													<?
													}
													else
													{
													?>
														<img src='../../<? echo $fab_color_img; ?>' height='50' width='70' align="middle" />
													<?
													}
													?>
													</td> -->
													<td align="center"> <? echo def_number_format($val[("amount")]/$val[("fin_fab_qnty")],2); ?> </td>
													<td align="center"> <? echo def_number_format($val[("amount")],2); ?> </td>
													<td align="center"> <? echo $pre_cost_remarks; ?> </td>
													<?
													$total_fin_fab_qnty +=$val[("fin_fab_qnty")];
													$total_amount +=$val[("amount")];
													$sub_total_fin_fab_qnty +=$val[("fin_fab_qnty")];
													$sub_total_amount +=$val[("amount")];


												?>

												</tr>
												<?
												$k++;
															}	
															} // Color End

														} // Desc End
													} // Nature End
												} // Po End

												?>
												<tr style="font-weight:bold">
									    <td  align="right" colspan="12"><strong>Sub Total&nbsp;</strong></td>
									    <td align="center"><? echo def_number_format($sub_total_fin_fab_qnty,2);?></td>
									    <!-- <td align="center"></td> -->
									    <td align="center"></td>
									    <td align="center"><? echo def_number_format($sub_total_amount,2);?></td>
									    <td align="center"></td>
									</tr>
									<?

										} // Style End
										$currency_id=$nameArray_per_job[0][csf("currency_id")];
										if($currency_id==1){$paysa_sent="Paisa";} else if($currency_id==2){$paysa_sent="Cents";}
										?>
									<tr style="font-weight:bold">
									    <td  align="right" colspan="12"><strong> Grand Total&nbsp;</strong></td>
									    <td align="center"><? echo def_number_format($total_fin_fab_qnty,2);?></td>
									    <!-- <td align="center"></td> -->
									    <td align="center"></td>
									    <td align="center"><? echo def_number_format($total_amount,2);?></td>
									    <td align="center"></td>
									</tr>
									<tr>
										<th colspan="12" align="left" style="font-size:16px;">Grand Total Booking Amount (in words):<? echo str_replace("-"," ",number_to_words(def_number_format($total_amount,2,""),$currency[$currency_id],$paysa_sent)); ?></th>
										<th colspan="5" align="left"></th>
									</tr>
									
									<!-- <tr style=" font-weight:bold">
									<td  align="right" colspan="5"><strong>Total</strong></td>
									<td align="right"><? //echo def_number_format($total_gmt_qty_pcs,2);?></td>
									<td  align="right" colspan="8">&nbsp;</td>

								<td align="center"><? //echo def_number_format($total_fin_fab_qnty,2);?></td>
									<td align="center"><? //echo def_number_format($total_fin_fab_qnty,2);?></td>
									<td align="center"><? //echo def_number_format($total_fin_fab_qnty,2);?></td>

								<td align="center"><? //echo def_number_format($total_amount,2);?></td>
									<td align="center"><? //echo def_number_format($total_amount,2);?></td>
									</tr> -->
						</table>
					<br/>

					<?
			//End

		}
					?>
			</table>
			<br>
				<div style="width:1330px" align="center" >
			  		<!-- <table  width="100%"  border="0" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

			  			<tr>
			  				<td colspan="10" align="center">
			  					<strong>Collar and Cuff & Other Flat Knit Fabric Breakdown</strong>
			  				</td>

			  			</tr>
			  		</table> -->

	        <?
	     	  $sql_collar_cuff= "SELECT a.rate, a.amount, a.job_no , a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.width_dia_type, b.gmts_color_id, b.size_number_id, b.item_size, b.gmts_qty, b.excess_per, b.qty, b.po_break_down_id as po_id, b.id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id) and a.body_part_type=40 and b.status_active=1 and b.is_deleted=0  order by a.body_part_id,b.gmts_color_id,b.id " ;
	     	  //echo $sql_collar_cuff; die;
	         $sql_data_collar_cuff=sql_select($sql_collar_cuff);
	         $size_id_array=array();
	         $size_with_item_size_array=array();
	         foreach($sql_data_collar_cuff as $vals)
	         {
	         	$body_part_cuff_array[$vals[csf("body_part_id")]]=$vals[csf("body_part_id")];
				$size_id_array[$vals[csf("size_number_id")]]=$vals[csf("size_number_id")];
	         	$size_with_item_size_array[$vals[csf("size_number_id")]][$vals[csf("body_part_id")]]=$vals[csf("item_size")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["grey"]+=$vals[csf("qty")];

	         	//$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]=$vals[csf("excess_per")];
				if($vals[csf("excess_per")]>0)
				{
				$color_wise_excess_per_arr[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]+=$vals[csf("excess_per")];
				$color_wise_excess_per_arr[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_excess_per"]+=1;
				}
	         	$color_wise_qnty[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$color_wise_qnty[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["grey"]+=$vals[csf("qty")];
	         	/*$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];*/

	         	//$color_wise_qnty[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["amount"]=$vals[csf("amount")];
				$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_rate"]=1;

	         }
			unset($sql_data_collar_cuff);
	         $sql_collar_cuff3 = sql_select("SELECT c.rate, a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id, c.gmts_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls c WHERE a.job_no=c.job_no and a.id=c.pre_cost_fabric_cost_dtls_id and  a.id=c.pre_cost_fabric_cost_dtls_id and c.booking_no =$txt_booking_no and c.job_no in ($all_jobs_id) and a.body_part_type=40 and c.status_active=1 and c.is_deleted=0  order by a.body_part_id");

	         foreach($sql_collar_cuff3 as $vals)
	         {

	         	$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];

	         }


	         $counts=count($size_id_array);


	         $size_wise_qnty_array=array();
	         ?>


			 <?
	          if(count($body_part_cuff_array)>0)
	          {		$grand_size_wise_qnty_array=array();
			  		$gr_collor_qty=0;
					 $gr_col_avg_price=0;
					 $gr_col_avg_row=0;
					 $gr_amount=0;
					 $gr_excess=0;
					foreach($body_part_cuff_array as $bpart_id=>$val)
					{
					 $sql_collar_cuff2= "SELECT a.rate,a.amount, a.job_no , a.id as fabric_cost_dtls_id,a.color_size_sensitive,a.color_break_down, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,b.gmts_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and a.body_part_id=$bpart_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id) and a.body_part_type=40  and b.status_active=1 and b.is_deleted=0  group by  a.rate,a.amount, a.job_no , a.id ,a.color_size_sensitive,a.color_break_down, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition,a.gsm_weight,a.width_dia_type,b.gmts_color_id  order by a.body_part_id,b.gmts_color_id  " ;
	          $sql_data_collar_cuff2=sql_select($sql_collar_cuff2);
					?>
					 <table align="left"  width="100%" style="margin-top: 5px;" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" >
			  			<tr>
			  				<td colspan="<? echo $counts+13;?>" align="center">
			  					<strong>Collar Details(<? echo $body_part[$bpart_id];?>)</strong>
			  				</td>

			  			</tr>
			  			<tr>
			  				<td  width="30"  rowspan="2" align="center"><strong>SL</strong> </td>
			  				<td  width="150" rowspan="2" align="center"><strong>Style</strong></td>
 			  				<td  width="140"  rowspan="2" align="center"><strong>Gmts Item</strong></td>
 			  				<td  width="100"  rowspan="2" align="center"><strong>Body Part</strong></td>
							<td  width="100" rowspan="2" align="center"><strong>Actual Qty(Pcs)</strong></td>
			  				<td  width="390" rowspan="2" align="left">&nbsp;&nbsp;<strong>Collar Composition</strong></td>
			  				<td  width="100"  rowspan="2" align="center"><strong>Color Type</strong></td>
 			  				<td  width="100"  rowspan="2"  align="center"><strong>Combo</strong></td>
							<td  width="100"  rowspan="2"  align="center"><strong>Fabric Color</strong></td>
 			  				<?
 			  				foreach($size_id_array as $id=>$val)
 			  				{
 			  					?>
 			  					<td width="40" align="center"><strong><? echo $size_library[$id];?></strong></td>

 			  					<?
 			  				}
 			  				?>
			  				<td width="60"  rowspan="2" align="center"><strong> Req Qty (Pcs)</strong> </td>
			  				<td  width="50" rowspan="2"  align="center"><strong> Excess %  </strong> </td>
			  				<td width="50" rowspan="2"  align="center"><strong>Price/Pcs</strong></td>
			  				<td  width="40" rowspan="2" align="center"><strong>Amount</strong></td>


			  			</tr>
			  			<tr>
			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					//$size_with_item=rtrim($size_with_item_size_array[$id],',');
								//$size_with_item=implode(",",array_unique(explode(",",$size_with_item)));
								?>
			  					<td  align="center"><? echo $size_with_item_size_array[$id][$bpart_id];?></td>

			  					<?
			  				}
			  				?>

			  			</tr>
			  			<?
			  			$p=1;
			  			foreach($sql_data_collar_cuff2 as $row)
			  			{

							?>
			  				<tr>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="30" align="center"><? echo $p;?></td>
			  					<td style="word-break: break-all;word-wrap: break-word;" width="150" align="center"><? echo $job_wise_style[$row[csf("job_no")]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="140" align="center"><?  $item_id= $row[csf('item_number_id')];echo $garments_item[$item_id]; ?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center"><? echo $body_part[$row[csf("body_part_id")]];?></td>
								<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center"><? $gmt_actual_qty=$gmts_qty_data_arr[$row[csf('job_no')]][$item_id][$row[csf('gmts_color_id')]];echo number_format($gmt_actual_qty,0);$total_gmt_actual_qty+=$gmt_actual_qty;?></td>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="390" align="left"> &nbsp;
			  						<? echo $row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$fabric_typee[$row[csf('width_dia_type')]] ;?>
			  					</td>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="100" align="center"><? echo $color_type[$row[csf('color_type_id')]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center">
			  						<? echo $color_library[$row[csf('gmts_color_id')]];  ?>
			  					</td>
								<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center">
			  						<?
										if($row[csf('color_size_sensitive')]==1 or $row[csf('color_size_sensitive')]==2 or $row[csf('color_size_sensitive')]==4)
										{
											$gmt_fab_color=$color_library[$row[csf('gmts_color_id')]];
										}
										else
										{
											$contrast_color_id=return_field_value("b.contrast_color_id as contrast_color_id", "wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b", "a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.job_no in ($all_jobs_id) and a.id=".$row[csf('fabric_cost_dtls_id')]."  and b.gmts_color_id=".$row[csf('gmts_color_id')]." ","contrast_color_id");//pre_cost_fabric_cost_dtls_id
											if($contrast_color_id>0)
											{
												$gmt_fab_color=$color_library[$contrast_color_id];
											}
										}
									echo $gmt_fab_color;  ?>
			  					</td>


			  					<?
								$color_qty=0; $greyQty=0;
			  					foreach($size_id_array as $id=>$val)
			  					{
			  						?>
			  						<td  style="word-break: break-all;word-wrap: break-word;" width="40"  align="center"><? echo $cuff_grey_qty=$size_item_wise_qnty[$row[csf("body_part_id")]][$row[csf("fabric_cost_dtls_id")]][$row[csf("gmts_color_id")]][$id][$size_with_item_size_array[$id][$bpart_id]]["grey"];//.'K '.$row[csf("fabric_cost_dtls_id")].'='.$row[csf("gmts_color_id")].'='.$id.'='.$size_with_item_size_array[$id];
									?></td>

			  						<?
			  						$size_wise_qnty_array[$id]+=$val;
									$grand_size_wise_qnty_array[$id]+=$cuff_grey_qty;$sub_size_wise_qnty_array[$bpart_id][$id]+=$cuff_grey_qty;
									$color_qty+=$cuff_grey_qty;

			  					}
								$row_excess_per= $color_wise_excess_per_arr[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf("gmts_color_id")]][$item_id]["row_excess_per"];
			  					?>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="60" align="center">
			  						<? echo $grey_qnty=$color_qty;//$color_wise_qnty[$row[csf('gmts_color_id')]][$item_id]["grey"];  ?>
			  					</td>

			  					<td  style="word-break: break-all;word-wrap: break-word;" title="<? echo $row_excess_per;?>" width="50" align="center">
			  						<?  $excess= $color_wise_excess_per_arr[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf("gmts_color_id")]][$item_id]["excess_per"]/$row_excess_per;
									echo number_format($excess,2);
									  ?>
			  					</td>


			  					<td style="word-break: break-all;word-wrap: break-word;" title="<? echo $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["row_rate"];?>"  width="50" align="center">
			  						<? echo  $cuff_price=$color_wise_qnty2[$row[csf("fabric_cost_dtls_id")]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["rate"];
										//$tot_row_rate=$color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["row_rate"];  ?>
			  					</td>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="40" align="center">
			  						<? $amount=$grey_qnty*$cuff_price; echo number_format( $amount,4); ?>
			  					</td>
			  				</tr>
			  				<?

							$sub_collor_qty_arr[$row[csf("body_part_id")]]+=$grey_qnty;
							$sub_collor_amount_arr[$row[csf("body_part_id")]]+=$amount;

							$sub_excess_arr[$row[csf("body_part_id")]]+=$excess;
							$sub_price_arr[$row[csf("body_part_id")]]+=$cuff_price;
							$cuff_body_wise_avg_row[$row[csf("body_part_id")]]+=1;

							$gr_fin_qty+=$fin_qty;
			  				$gr_collor_qty+=$grey_qnty;
							$gr_amount+=$amount;
			  				$gr_excess+=$excess ;
			  				$gr_col_avg_price+=$cuff_price;
			  				$gr_col_avg_row++;



			  				$p++;
			  			}
			  			?>
						<tr class="tbl_bottom">
							<td colspan="9" align="right">Total </td>
							<?
							foreach($size_id_array as $id=>$val)
							{
								?>
								<td  align="center"><? echo $sub_size_wise_qnty_array[$bpart_id][$id];?></td>

								<?
							}
							$cuff_sub_excess=$sub_excess_arr[$bpart_id];
							$cuff_sub_price=$sub_price_arr[$bpart_id];
							$cuff_body_wise_avg_tot_row=$cuff_body_wise_avg_row[$bpart_id];
							?>
							<td align="center">
								<? echo $sub_collor_qty_arr[$bpart_id];  ?>
							</td>
							<td align="center" title="Sub Exess & sub Row=<? echo $cuff_sub_excess.'='.$cuff_body_wise_avg_tot_row ?>">
									<? echo number_format($cuff_sub_excess/$cuff_body_wise_avg_tot_row,2); ?></td>
							<td align="center"><? echo number_format($cuff_sub_price/$cuff_body_wise_avg_tot_row,2); ?></td>

							<td align="center">
								<? echo number_format($sub_collor_amount_arr[$bpart_id],4);   ?>
							</td>
			  			</tr>
						<!--Sub TOT End-->


			  			<?
						} //Body Part End
						?>

						<tr>
			  				<td colspan="9" align="right">Grand Total </td>
			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td  align="center"><? echo $grand_size_wise_qnty_array[$id];?></td>

			  					<?
			  				}
			  				?>
			  				<td align="center">
			  					<? echo $gr_collor_qty;  ?>
			  				</td>
			  				<td align="center" title="Sub Exess & Tot Row=<? echo $gr_excess.'='.$gr_avg_row ?>"><? echo number_format($gr_excess/$gr_col_avg_row,2); ?></td>
							<td align="center"  title="Tot Price  & Tot Row=<? echo $gr_col_avg_price.'='.$gr_col_avg_row.'**'.$p?>"><? //echo number_format($gr_col_avg_price/$gr_col_avg_row,2); ?></td>

			  				<td align="center">
			  					<? echo number_format($gr_amount,4);   ?>
			  				</td>
			  			</tr>

						</table>
						<?
			  		}
			  	?>


					<br/><br/>

						<?
	     	  $sql_collar_cuff= "SELECT a.rate,a.amount, a.job_no , a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,b.gmts_color_id,b.size_number_id,b.item_size,b.gmts_qty,b.excess_per,b.qty,b.po_break_down_id as po_id,b.id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id) and a.body_part_type=50 and b.status_active=1 and b.is_deleted=0  order by a.body_part_id,b.gmts_color_id,b.id " ;
	         $sql_data_collar_cuff=sql_select($sql_collar_cuff);
	         $size_id_array=array();
	         $size_with_item_size_array=array();
	         $size_item_wise_qnty=array();
	         $color_wise_qnty=array();
	         foreach($sql_data_collar_cuff as $vals)
	         {
	         	$body_part_array[$vals[csf("body_part_id")]]=$vals[csf("body_part_id")];
				$size_id_array[$vals[csf("size_number_id")]]=$vals[csf("size_number_id")];
	         	$size_with_item_size_array[$vals[csf("size_number_id")]][$vals[csf("body_part_id")]]=$vals[csf("item_size")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["grey"]+=$vals[csf("qty")];

	         	//$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]=$vals[csf("excess_per")];
				if($vals[csf("excess_per")]>0)
				{
				$color_wise_excess_per_cuff_arr[$vals[csf('fabric_cost_dtls_id')]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]+=$vals[csf("excess_per")];
				$color_wise_excess_per_cuff_arr[$vals[csf('fabric_cost_dtls_id')]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_excess_per"]+=1;
				}
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["grey"]+=$vals[csf("qty")];
	         	/*$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];*/
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["amount"]=$vals[csf("amount")];
				$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_rate"]=1;

	         }
				unset($sql_data_collar_cuff);
	         $sql_collar_cuff3 = sql_select("SELECT c.rate, a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id, c.gmts_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls c WHERE a.job_no=c.job_no and a.id=c.pre_cost_fabric_cost_dtls_id and  a.id=c.pre_cost_fabric_cost_dtls_id and c.booking_no =$txt_booking_no and c.job_no in ($all_jobs_id) and a.body_part_type=50 and c.status_active=1 and c.is_deleted=0  order by a.body_part_id");

	         foreach($sql_collar_cuff3 as $vals)
	         {

	         	$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];

	         }


	         $counts=count($size_id_array);$grand_size_wise_qnty_array=array();
	          if(count($body_part_array)>0)
	          {
					$gr_collor_qty=$gr_amount=$gr_avg_price=$gr_avg_row=$gr_excess=0;
					foreach($body_part_array as $bpart_id=>$val)
					{
					 $sql_collar_cuff2= "SELECT a.rate,a.amount, a.job_no , a.id as fabric_cost_dtls_id,a.color_size_sensitive, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,b.gmts_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and a.body_part_id=$bpart_id and b.job_no in ($all_jobs_id) and a.body_part_type=50  and b.status_active=1 and b.is_deleted=0  group by  a.rate,a.amount, a.job_no , a.id , a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition,a.gsm_weight,a.width_dia_type,b.gmts_color_id,a.color_size_sensitive  order by a.body_part_id,b.gmts_color_id  " ;
	          $sql_data_collar_cuff2=sql_select($sql_collar_cuff2);
					?>

			  	 <table align="left"  width="100%" style="margin-top: 5px; margin-bottom:10px;"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" >
			  			<tr>
			  				<td colspan="<? echo $counts+13;?>" align="center">
			  					<strong>Cuff Details &nbsp;(<? echo  $body_part[$bpart_id];?>) </strong>
			  				</td>
			  			</tr>
			  			<tr>
			  				<td  width="30"  rowspan="2" align="center"><strong>SL</strong> </td>
			  				<td  width="150" rowspan="2" align="center"><strong>Style</strong></td>
 			  				<td  width="140" rowspan="2" align="center"><strong>Gmts Item</strong></td>
 			  				<td  width="100" rowspan="2" align="center"><strong>Body Part</strong></td>
							<td  width="100" rowspan="2" align="center"><strong>Actual Qty(Pcs)</strong></td>
			  				<td  width="390" rowspan="2" align="left">&nbsp;&nbsp;<strong>Cuff Composition</strong></td>
			  				<td  width="100" rowspan="2" align="center"><strong>Color Type</strong></td>
 			  				<td  width="100" rowspan="2"  align="center"><strong>Combo</strong></td>
							<td  width="100" rowspan="2"  align="center"><strong>Fabric Color</strong></td>
 			  				<?
 			  				foreach($size_id_array as $id=>$val)
 			  				{
 			  					?>
 			  					<td width="40" align="center"><strong><? echo $size_library[$id];?></strong></td>

 			  					<?
 			  				}
 			  				?>

			  				<td width="60"  rowspan="2" align="center"><strong> Req Qty(Pcs) </strong> </td>
			  				<td  width="50" rowspan="2"  align="center"><strong> Excess %  </strong> </td>

			  				<td width="50" rowspan="2"  align="center"><strong>Price/Pcs</strong></td>
			  				<td  width="40" rowspan="2" align="center"><strong>Amount</strong></td>
			  			</tr>
			  			<tr>
			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td width="40"  align="center"><strong><? echo $size_with_item_size_array[$id][$bpart_id];?></strong></td>
			  					<?
			  				}
			  				?>
			  			</tr>
			  			<?
			  			$p=1;
			  			$size_wise_qnty_array=array();
			  			foreach($sql_data_collar_cuff2 as $row)
			  			{
							?>
			  				<tr>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="30" align="center"><? echo $p;?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="150" align="center"><? echo $job_wise_style[$row[csf("job_no")]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="140" align="center"><?  $item_id= $row[csf('item_number_id')];echo $garments_item[$item_id]; ?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center"><? echo $body_part[$row[csf("body_part_id")]];?></td>
								<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center"><? $gmt_actual_qty=$gmts_qty_data_arr[$row[csf('job_no')]][$item_id][$row[csf('gmts_color_id')]];echo number_format($gmt_actual_qty,0);$total_gmt_actual_qty+=$gmt_actual_qty;?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="390" align="left"> &nbsp;
			  						<? echo $row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')].",".$fabric_typee[$row[csf('width_dia_type')]] ;?>
			  					</td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center"><? echo $color_type[$row[csf('color_type_id')]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center">
			  						<? echo $color_library[$row[csf('gmts_color_id')]];  ?>
			  					</td>
								<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center">
			  						<?
									if($row[csf('color_size_sensitive')]==1 or $row[csf('color_size_sensitive')]==2 or $row[csf('color_size_sensitive')]==4)
										{
											$gmt_fab_color=$color_library[$row[csf('gmts_color_id')]];
										}
										else
										{
											$contrast_color_id=return_field_value("b.contrast_color_id as contrast_color_id", "wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b", "a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.job_no in ($all_jobs_id) and a.id=".$row[csf('fabric_cost_dtls_id')]."  and b.gmts_color_id=".$row[csf('gmts_color_id')]." ","contrast_color_id");//pre_cost_fabric_cost_dtls_id
											if($contrast_color_id>0)
											{
												$gmt_fab_color=$color_library[$contrast_color_id];
											}
										}
									echo $gmt_fab_color;   ?>
			  					</td>

			  					<?
								$tot_size_qty=0;
			  					foreach($size_id_array as $id=>$val)
			  					{
			  						?>
			  						<td  style="word-break: break-all;word-wrap: break-word;"  width="40"  align="center"><? echo $size_grey_qty=$size_item_wise_qnty[$row[csf("body_part_id")]][$row[csf('fabric_cost_dtls_id')]][$row[csf("gmts_color_id")]][$id][$size_with_item_size_array[$id][$row[csf("body_part_id")]]]["grey"];?></td>

			  						<?
			  						$size_wise_qnty_array[$id]+=$size_grey_qty;$sub_size_wise_qnty_array[$row[csf("body_part_id")]][$id]+=$size_grey_qty;
									$grand_size_wise_qnty_array[$id]+=$size_grey_qty;
									$tot_size_qty+=$size_grey_qty;

			  					}
			  					?>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="60" align="center">
			  						<? echo $grey_qnty=$tot_size_qty;//$color_wise_qnty[$row[csf('gmts_color_id')]][$item_id]["grey"];
									$row_excess_per=$color_wise_excess_per_cuff_arr[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf("gmts_color_id")]][$item_id]["row_excess_per"];
									 ?>
			  					</td>

			  					<td  style="word-break: break-all;word-wrap: break-word;" title="excess tot=<? echo $row_excess_per; ?>"  width="50" align="center">
			  						<?  $avg_excess=$color_wise_excess_per_cuff_arr[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf("gmts_color_id")]][$item_id]["excess_per"]/$row_excess_per;echo number_format($avg_excess,2);   ?>
			  					</td>
			  					<td   style="word-break: break-all;word-wrap: break-word;" width="50" title="<? echo $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["row_rate"];?>" align="center">
			  						<? echo $price= $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["rate"];
									$tot_row_rate= $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["row_rate"]; ?>
			  					</td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="40" align="center">
			  						<? $amount=$grey_qnty*$price; echo number_format($amount,4); ?>
			  					</td>

			  				</tr>
			  				<?
			  				$sub_collor_qty_arr[$row[csf("body_part_id")]]+=$grey_qnty;
							$sub_collor_amount_arr[$row[csf("body_part_id")]]+=$amount;
							$sub_excess_arr[$row[csf("body_part_id")]]+=$avg_excess;
							$sub_price_arr[$row[csf("body_part_id")]]+=$price;
							$body_wise_avg_row[$row[csf("body_part_id")]]+=1;

							$gr_fin_qty+=$fin_qty;
			  				$gr_collor_qty+=$grey_qnty;
			  				$gr_avg_price+=$price;
							$gr_amount+=$amount;
			  				$gr_excess+=$avg_excess;

			  				$gr_avg_row++;

			  				$p++;
			  			}
			  			?>

			  			<tr>
			  				<td colspan="9" align="right">Total </td>
			  				<?
							//$sub_size_wise_qnty_array=array();
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td  align="center"><? echo $sub_size_wise_qnty_array[$bpart_id][$id];
								//$sub_size_wise_qnty_array[$row[csf("body_part_id")]][$id]=0;
								/*$grand_size_wise_qnty_array[$id]+=$sub_size_wise_qnty_array[$bpart_id][$id];*/
								?></td>
			  					<?
			  				}
							$tot_avg_row=$body_wise_avg_row[$bpart_id];
							$tot_sub_excess=$sub_excess_arr[$bpart_id];
							$tot_sub_price=$sub_price_arr[$bpart_id];
			  				?>
			  				<td align="center">
			  					<? echo $sub_collor_qty_arr[$bpart_id];  ?>
			  				</td>
			  				<td align="center" title="Tot Excess & Tot Row=<? echo $tot_sub_excess.'='.$tot_avg_row;?>"><? echo number_format($tot_sub_excess/$tot_avg_row,2); ?></td>
			  				<td align="center">
			  					<? echo number_format($tot_sub_price/$tot_avg_row,2);  ?>
			  				</td>
			  				<td align="center">
			  					<? echo number_format($sub_collor_amount_arr[$bpart_id],4);   ?>
			  				</td>
			  			</tr>
			  			<?
						} //Body Part End

			  		?>
					<tr>
			  				<td colspan="9" align="right">Grand Total </td>
			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td  align="center"><? echo $grand_size_wise_qnty_array[$id];?></td>
			  					<?
			  				}
			  				?>
			  				<td align="center">
			  					<? echo $gr_collor_qty;  ?>
			  				</td>
			  				<td align="center" title="grand Excess &tot row=<? echo $gr_excess.'='.$gr_avg_row;?>"><? echo number_format($gr_excess/$gr_avg_row,2); ?></td>
			  				<td align="center">
			  					<? //echo number_format($gr_avg_price/$gr_avg_row,2);  ?>
			  				</td>
			  				<td align="center">
			  					<? echo number_format($gr_amount,4);   ?>
			  				</td>
			  			</tr>
			  	</table>
				<?
					}
				?>

				</div>
			<br>
			<table  style="margin-top: 5px;float: left; display:none"    width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

				<tr>
					<td colspan="10" align="center">
						<strong>Comments</strong>
					</td>
				</tr>
				<tr>
					<td align="center"> SL </td>
					<td align="center" width="200"  style="word-wrap: break-word;word-break: break-all;"> PO NO </td>
					<td align="center"> Ship Date </td>
					<td align="center">BOM Qty</td>
					<td align="center"> Booking Qty </td>
					<td align="center"> Short Booking Qty </td>
					<td align="center"> Total Booking Qty </td>
					<td align="center"> Balance </td>
					<td align="center"> Comments </td>
				</tr>
				<?
				$is_short_data=sql_select("SELECT a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0   and b.is_short =1 group by  a.id ");
				foreach($is_short_data as $vals)
				{
					$short_qty_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
				}

				$booking_data=sql_select("SELECT a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and  b.status_active=1 and b.is_deleted=0 and b.is_short !=1 group by  a.id  order by a.id");
				foreach($booking_data as $vals)
				{
					$booking_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
				}

				$po_date=return_library_array("select id,shipment_date from wo_po_break_down where status_active=1 and is_deleted=0",'id','shipment_date');

				$comments_data=sql_select("SELECT min(a.id) as ids,b.po_break_down_id as po_number,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,SUM(b.requirment) as precost_grey_qty FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
					WHERE a.job_no=b.job_no and
					a.id=b.pre_cost_fabric_cost_dtls_id
					and
					b.po_break_down_id=d.po_break_down_id and
					b.color_number_id=d.gmts_color_id and
					b.dia_width=d.dia_width and
					b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
					a.job_no=d.job_no and
					a.id=d.pre_cost_fabric_cost_dtls_id
					and
					d.booking_no =$txt_booking_no and
					d.job_no in($all_jobs_id) and

					d.status_active=1 and
					d.is_deleted=0 and
					b.cons>0
					group by b.po_break_down_id order by b.po_break_down_id");



				$job_no=$all_jobs_id;
				$condition= new condition();
				if(str_replace("'","",$job_no) !='')
				{
					$condition->job_no("in ($job_no)");
				}
				$condition->init();
				$fabric= new fabric($condition);
				$fabric_costing_qty_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish();

				$j=1;
				$total_bom=0;
				$total_book=0;
				$total_short=0;
				$total_short_full=0;
				$total_balance=0;
				foreach($comments_data as $val)
				{
					$po_id=$val[csf('po_number')];
					$woven_qty=array_sum($fabric_costing_qty_arr['woven']['grey'][$po_id]);
					$knit_qty=array_sum($fabric_costing_qty_arr['knit']['grey'][$po_id]);
					$sum_woven_knit=$woven_qty + $knit_qty;


					?>
					<tr>
						<td align="center"><? echo $j;?></td>

						<td align="center"  style="word-wrap: break-word;word-break: break-all;"> <? echo $po_num_arr[$val[csf("po_number")]] ;?> </td>
						<td align="center"> <? echo change_date_format($po_date[$val[csf("po_number")]], "yyyy-mm-dd", "-");?> </td>
						<td align="center"><?  echo $pre= def_number_format($sum_woven_knit,2);  ?> </td>
						<td align="center"><?  echo $bookings= def_number_format($booking_arr[$val[csf("po_number")]],2);  ?> </td>
						<td align="center"> <?echo $short=def_number_format($short_qty_arr[$val[csf("po_number")]],2); ?> </td>
						<td align="center"> <?   $tot_short_book= str_replace(',','',$bookings) +  str_replace(',','',$short) ; echo def_number_format($tot_short_book,2); ?>  </td>
						<td align="center"> <?  $bal =str_replace(',','',$pre)-str_replace(',','',$tot_short_book) ; echo def_number_format($bal,2);  ?> </td>
						<td align="center"> <? if($bal!=0){ if($pre>$tot_short_book){echo "Less ";} else{ echo "Over";} }?> </td>


					</tr>
					<?
					$total_bom +=str_replace(',','',$pre);
					$total_book +=str_replace(',','',$bookings);
					$total_short +=str_replace(',','',$short);
					$total_short_full += str_replace(',','',$tot_short_book);
					$total_balance += str_replace(',','',$bal);

					$j++;
				}
				?>
				<tr>
					<td colspan="3" align="right"> <b> Total </b></td>
					<td align="center"><strong><? echo def_number_format($total_bom,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_book,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_short,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_short_full,2);?> </strong> </td>
					<td align="center"><strong><? echo def_number_format($total_balance,2);?> </strong> </td>
					<td>&nbsp;</td>
				</tr>
			</table>
			<br>


			<?
			if($cbo_fabric_source==1 || $cbo_fabric_source==2 || $cbo_fabric_source==3){
			?>


	<?
	//------------------------------ Query for TNA start-----------------------------------
	$po_id_all=str_replace("'","",$txt_order_no_id);
	$po_num_arr=return_library_array("SELECT id,po_number from wo_po_break_down where job_no_mst in($all_jobs_id)",'id','po_number');
	$tna_start_sql=sql_select( "SELECT id,po_number_id,
	(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
	(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
	(case when task_number=60 then task_start_date else null end) as knitting_start_date,
	(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
	(case when task_number=61 then task_start_date else null end) as dying_start_date,
	(case when task_number=61 then task_finish_date else null end) as dying_end_date,
	(case when task_number=64 then task_start_date else null end) as finishing_start_date,
	(case when task_number=64 then task_finish_date else null end) as finishing_end_date,
	(case when task_number=84 then task_start_date else null end) as cutting_start_date,
	(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
	(case when task_number=86 then task_start_date else null end) as sewing_start_date,
	(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
	(case when task_number=110 then task_start_date else null end) as exfact_start_date,
	(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
	(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
	(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
	from tna_process_mst
	where status_active=1 and po_number_id in($po_id_all) and job_no in ($all_jobs_id) order by po_number_id");
 	$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
	$tna_date_task_arr=array();
	foreach($tna_start_sql as $row)
	{
		if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
		{
			if($tna_fab_start=="")
			{
				$tna_fab_start=$row[csf("fab_booking_start_date")];
			}
		}
		if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
		}
		if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
		}
		if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
		}
		if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
		}
		if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
		}
		if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
		}
		if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
		{
			$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
			$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
		}
	}
	//------------------------------ Query for TNA end-----------------------------------
	if(count($tna_start_sql)>0 )
	{
		?>
		<br>
		<fieldset id="div_size_color_matrix" style="max-width:1000; display:none;">
			<legend>TNA Information</legend>
			<table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
				<tr>
					<td rowspan="2" align="center" valign="top">SL</td>
					<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
					<td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
					<td colspan="2" align="center" valign="top"><b>Knitting</b></td>
					<td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
					<td colspan="2" align="center" valign="top"><b>Finishing Fabric</b></td>
					<td colspan="2" align="center" valign="top"><b>Cutting </b></td>
					<td colspan="2" align="center" valign="top"><b>Sewing </b></td>
					<td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
				</tr>
				<tr>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
					<td width="85" align="center" valign="top"><b>Start Date</b></td>
					<td width="85" align="center" valign="top"><b>End Date</b></td>
				</tr>
				<?
				$i=1;
				foreach($tna_date_task_arr as $order_id=>$row)
				{
					?>
					<tr>
						<td><? echo $i; ?></td>
						<td><? echo $po_num_arr[$order_id]; ?></td>
						<td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
						<td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
						<td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
						<td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
						<td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
					</tr>
					<?
					$i++;
				}
				?>
			</table>
		</fieldset>
		<?
	}
	}// fabric Source End
	?>
	<br>
	<br>
	<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
		<tr>
			<td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
				<table  width="100%"  border="0" cellpadding="0" cellspacing="0">
					<thead>
						<tr>
							<th width="3%"></th><th width="97%" align="left" style="font-size:16px"><strong><u>Special Instruction</u></strong></th>
						</tr>
					</thead>
					<tbody>
						<?
						$data_array=sql_select("select id, terms from  wo_booking_terms_condition where booking_no=$txt_booking_no");
						if ( count($data_array)>0)
						{
							$i=0;
							foreach( $data_array as $row )
							{
								$i++;
								?>
								<tr id="settr_1" valign="top">
									<td style="vertical-align:top">
										<? echo $i;?>
									</td>
									<td>
										<span style="font-size:12px"> <? echo $row[csf('terms')]; ?></span>
									</td>
								</tr>
								<?
							}
						}
						?>
					</tbody>
				</table>
			</td>

		</tr>
	</table>
	<br/><br/><br/><br/>
		    <table  width="100%"  border="0" cellpadding="0" cellspacing="0">
		    	<tr>
		            <td>  <?
		                    echo signature_table(121, $cbo_company_name, "1330px",1,'');
						//	$job_no_all= implode(",",array_unique($joball['job_no']));
							//$style_sting_all=implode(",",array_unique($joball['style_ref_no']));
							//echo "****".custom_file_name($txt_booking_no,$style_sting_all,$job_no_all);
		                ?>
		            </td>
		        </tr>
		    </table>
	</div>
	<?
			
			$html = ob_get_contents();
			ob_clean();
			list($is_mail_send,$mail)=explode('___',$mail_send_data);
		
			if($is_mail_send==1){
				
				
				//pdf att file..............................................
				$REAL_FILE_NAME = custom_file_name($txt_booking_no,$style_sting,$job_no);
				$user_id=$_SESSION['logic_erp']['user_id'];
				foreach (glob("../../../auto_mail/tmp/".$REAL_FILE_NAME) as $filename) {			
					@unlink($filename);
				}
				$att_file_arr=array();
				require('../../../ext_resource/mpdf60/mpdf.php');
				$mpdf = new mPDF('', 'A4-L', '', '', 10, 10, 10, 20, 3, 3);	
				$mpdf->WriteHTML($html,2);
				//$REAL_FILE_NAME = 'trims_booking_multy_job_'.$user_id.'.pdf';
				$file_path='../../../auto_mail/tmp/'.$REAL_FILE_NAME;
				$mpdf->Output($file_path, 'F');
				$att_file_arr[]='../../../auto_mail/tmp/'.$REAL_FILE_NAME.'**'.$REAL_FILE_NAME;
				//..............................................pdf att file;
				
				//echo $html;die;			
				
				
				require_once('../../../mailer/class.phpmailer.php');
				require_once('../../../auto_mail/setting/mail_setting.php');
				$mailBody = preg_replace("/<img[^>]+\>/i", " ", $html); 
				$mailBody="<br>".$mail_body	;	
				$mailToArr=array();
				$mailSql = "select b.EMAIL  from wo_booking_mst a,LIB_SUPPLIER b where b.id=a.supplier_id and a.booking_no=$txt_booking_no";
			//echo $mailSql;die;
				$mailSqlRes=sql_select($mailSql);
				foreach($mailSqlRes as $rows){
					if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
				}
				
				
				$mailSql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=99 and b.mail_user_setup_id=c.id  and c.IS_DELETED=0 and c.STATUS_ACTIVE=1";
				//echo $mailSql;die;
				$mailSqlRes=sql_select($mailSql);
				foreach($mailSqlRes as $rows){
					if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
				}
				if($mail!=''){$mailToArr[]=$mail;}
		
				$to=implode(',',$mailToArr);
				$subject="Partial fabric booking";
				$header=mailHeader();
				echo $to;
				echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
				
			}
			else{
				echo $html;
			}
			exit();
}

if($action=="print_booking_12") //ISD-21-22116 4H
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$path=str_replace("'","",$path);
	if($path!="") $path=$path; else $path="../../";

	$imge_arr=return_library_array( "select master_tble_id,image_location from common_photo_library where form_name='company_details' or form_name='knit_order_entry' and file_type=1",'master_tble_id','image_location');
	$fabimge_arr=return_library_array( "select master_tble_id, image_location from common_photo_library where form_name='company_details' or form_name='fabric_color_img' and file_type=1",'master_tble_id','image_location');
	
	$color_library=return_library_array( "select id,color_name from lib_color ", "id", "color_name");
	//$marchentrArr = return_library_array("select id, team_member_name from lib_mkt_team_member_info  where status_active=1 and is_deleted=0","id","team_member_name");
	$teamArr =$marchentrArr=array();
	$teamSql = sql_select("select a.id, b.id as bid, a.team_name, a.team_leader_name, a.team_leader_email, a.user_tag_id, b.user_tag_id as user_id, b.team_member_name, b.team_member_email from lib_marketing_team a, lib_mkt_team_member_info b where a.id=b.team_id and a.status_active=1 and a.is_deleted=0 ");
	foreach($teamSql as $trow)
	{
		$teamArr[$trow[csf('id')]]['teamname']=$trow[csf('team_name')];
		$teamArr[$trow[csf('id')]]['team_leader_name']=$trow[csf('team_leader_name')];
		$teamArr[$trow[csf('id')]]['team_email']=$trow[csf('team_leader_email')];
		$marchentrArr[$trow[csf('bid')]]['team_member_name']=$trow[csf('team_member_name')];
		$marchentrArr[$trow[csf('bid')]]['team_member_email']=$trow[csf('team_member_email')];
		if($trow[csf('user_tag_id')]==$trow[csf('user_id')])
		{
			$teamArr[$trow[csf('id')]]['team_leader_email']=$trow[csf('team_member_email')];
		}
	}
	unset($teamSql);
	
	$buyer_name_arr=return_library_array( "select id, buyer_name from lib_buyer  where status_active=1 and is_deleted=0",'id','buyer_name');
	$nameArray_approved=sql_select( "select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and a.status_active =1 and a.is_deleted=0");
	list($nameArray_approved_row)=$nameArray_approved;

	$job_data_arr=array();
	$nameArray_buyer=sql_select( "select a.style_ref_no, a.style_description, a.job_no, a.buyer_name, a.team_leader, a.dealing_marchant, a.total_set_qnty, c.po_number from wo_po_details_master a, wo_booking_dtls b, wo_po_break_down c where a.job_no=b.job_no and a.id=c.job_id and b.po_break_down_id=c.id and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0 order by a.job_no ");
	$jobAll=$styleAll=$poAll="";
	foreach ($nameArray_buyer as $result_buy)
	{
		if($jobAll=="") $jobAll=$result_buy[csf('job_no')]; else $jobAll.=','.$result_buy[csf('job_no')];
		if($styleAll=="") $styleAll=$result_buy[csf('style_ref_no')]; else $styleAll.='**'.$result_buy[csf('style_ref_no')];
		if($poAll=="") $poAll=$result_buy[csf('po_number')]; else $poAll.='**'.$result_buy[csf('po_number')];
		
		$job_data_arr[$result_buy[csf('job_no')]]['style']=$result_buy[csf('style_ref_no')];
		$job_data_arr[$result_buy[csf('job_no')]]['job_no_in']="'".$result_buy[csf('job_no')]."'";
		$dealing_marchant.=$marchentrArr[$result_buy[csf('dealing_marchant')]]['team_member_name'].',';
		$team_name.=$teamArr[$result_buy[csf('team_leader')]]['teamname'].',';
		$team_email.=$teamArr[$result_buy[csf('team_leader')]]['team_email'].',';
		$team_leader_email.=$teamArr[$result_buy[csf('team_leader')]]['team_leader_email'].',';
		$team_leader.=$teamArr[$result_buy[csf('team_leader')]]['team_leader_name'].',';
		$team_member_email.=$marchentrArr[$result_buy[csf('dealing_marchant')]]['team_member_email'].',';
		$all_jobs[$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
 	}
	unset($nameArray_buyer);
	
	$jobAll=implode(", ",array_unique(explode(",",$jobAll)));
	$styleAll=implode(", ",array_unique(explode("**",$styleAll)));
	$poAll=implode(", ",array_unique(explode("**",$poAll)));
	$all_jobs_id=implode(",",$all_jobs );

  	//print_r($job_data_arr);
	$dealing_marchant=rtrim($dealing_marchant,',');
	$dealing_marchants=implode(",",array_unique(explode(",",$dealing_marchant)));
	
	$team_member_email=rtrim($team_member_email,',');
	$team_member_emails=implode(",",array_unique(explode(",",$team_member_email)));
	
	$team_name=rtrim($team_name,',');
	$team_names=implode(",",array_unique(explode(",",$team_name)));
	
	$team_email=rtrim($team_email,',');
	$team_emails=implode(",",array_unique(explode(",",$team_email)));
	
	$team_leader=rtrim($team_leader,',');
	$team_leaders=implode(",",array_unique(explode(",",$team_leader)));
	
	$team_leader_email=rtrim($team_leader_email,',');
	$team_leader_emails=implode(",",array_unique(explode(",",$team_leader_email)));
	
	$nameArray=sql_select( "select a.buyer_id, a.booking_date, a.supplier_id, a.ship_mode, a.delivery_date, a.fabric_source, a.remarks, a.pay_mode, a.attention, a.pay_term, a.tenor, a.is_approved, a.shippingmark_breck_down from wo_booking_mst a where a.booking_no=$txt_booking_no and a.status_active=1 and a.is_deleted=0");
	foreach ($nameArray as $result_job){
		$booking_date=$result_job[csf('booking_date')];
		$buyer_id=$result_job[csf('buyer_id')];
		$ship_mode=$result_job[csf('ship_mode')];
		$delivery_date=$result_job[csf('delivery_date')];
		$supplier_id=$result_job[csf('supplier_id')];
		$pay_mode=$result_job[csf('pay_mode')];
		$shippingmark_breck_down=$result_job[csf('shippingmark_breck_down')];
		$mstremarks=$result_job[csf('remarks')];
		$attention=$result_job[csf('attention')];
		$paytermTenor=$pay_term[$result_job[csf('pay_term')]].', '.$result_job[csf('tenor')].' Days';
		$is_approved=$result_job[csf('is_approved')];
	}
	unset($nameArray);
	//echo $booking_date.'ddd';
	
	$shippingmark_data=explode("~!~",$shippingmark_breck_down);
	$shippingmark_str="<b>".$shippingmark_data[0]."</b><br>".$shippingmark_data[1]."<br>".$shippingmark_data[2]."<br>".$shippingmark_data[3]."<br>".$shippingmark_data[4]."<br>".$shippingmark_data[5];
	
	$country_full_name = return_library_array("SELECT id,country_name from lib_country", "id", "country_name");
			
	$sqlCom="select company_name, email, website, plot_no, level_no, road_no, block_no, country_id, province, city, zip_code, contact_no from lib_company where id='$cbo_company_name' and status_active=1 and is_deleted=0";
	$sqlComRes=sql_select($sqlCom);
	$comName=$comAdd=$comPhone=$comPax=$comEmail=$comWeb=""; $consigneeDtls="";
	foreach( $sqlComRes as $row)
	{
		$comName=$row[csf("company_name")];
		
		if($row[csf("level_no")])		$level_no 	= $row[csf("level_no")].', ';
		if($row[csf("plot_no")])		$plot_no 	=$row[csf("plot_no")].', ';
		if($row[csf("road_no")]) 		$road_no 	=$row[csf("road_no")].', ';
		if($row[csf("block_no")]!='')	$block_no 	=$row[csf("block_no")].', ';
		if($row[csf("zip_code")]!='')	$zip_code 	= ' -'.$row[csf("zip_code")].' , ';
		if($row[csf("city")]!='') 		$city 		= ($zip_code!="")?$row[csf("city")]:$row[csf("city")]." ,";
		if($row[csf("country_id")]!='')	$country 	= $country_full_name[$row[csf("country_id")]].'.';
		
		$comAdd=$level_no.$plot_no.$road_no.$block_no.$city.$zip_code.$country;
		$comPhone=$row[csf("contact_no")];
		$comEmail=$row[csf("email")];
		$comWeb=$row[csf("website")];
	}
	$consigneeDtls="<b>Consignee:</b> <br>".$comName."<br>".$comAdd."<br>".$comPhone."<br>".$comPax."<br>".$comEmail."<br>".$comWeb;
	
	$beneficiaryDtls="";
	if($pay_mode==3 || $pay_mode==5)
	{
		$sqlSupp="select company_name, email, website, plot_no, level_no, road_no, block_no, country_id, province, city, zip_code, contact_no from lib_company where id='$supplier_id' and status_active=1 and is_deleted=0";
		$sqlSuppRes=sql_select($sqlSupp);
		$suppName=$suppAdd=$suppPhone=$suppPax=$suppEmail=$suppWeb="";
		foreach( $sqlSuppRes as $row)
		{
			$suppName=$row[csf("company_name")];
			
			if($row[csf("level_no")])		$level_no 	= $row[csf("level_no")].', ';
			if($row[csf("plot_no")])		$plot_no 	=$row[csf("plot_no")].', ';
			if($row[csf("road_no")]) 		$road_no 	=$row[csf("road_no")].', ';
			if($row[csf("block_no")]!='')	$block_no 	=$row[csf("block_no")].', ';
			if($row[csf("zip_code")]!='')	$zip_code 	= ' -'.$row[csf("zip_code")].' , ';
			if($row[csf("city")]!='') 		$city 		= ($zip_code!="")?$row[csf("city")]:$row[csf("city")]." ,";
			if($row[csf("country_id")]!='')	$country 	= $country_full_name[$row[csf("country_id")]].'.';
			
			$suppAdd=$level_no.$plot_no.$road_no.$block_no.$city.$zip_code.$country;
			$suppPhone=$row[csf("contact_no")];
			$suppEmail=$row[csf("email")];
			$suppWeb=$row[csf("website")];
		}
		$beneficiaryDtls="<b>Beneficiary:</b> <br>".$suppName."<br>".$suppAdd."<br>".$suppPhone."<br>".$suppPax."<br>".$suppEmail."<br>".$suppWeb;
	}
	else
	{
		$sqlSupp="select supplier_name, email, web_site, address_1, contact_no from lib_supplier where id='$supplier_id' and status_active=1 and is_deleted=0";
		$sqlSuppRes=sql_select($sqlSupp);
		$suppName=$suppAdd=$suppPhone=$suppPax=$suppEmail=$suppWeb="";
		$level_no=$plot_no=$road_no=$block_no=$city=$zip_code=$country="";
		foreach( $sqlSuppRes as $row)
		{
			$suppName=$row[csf("supplier_name")];
			$suppAdd=$row[csf("address_1")];
			$suppPhone=$row[csf("contact_no")];
			$suppEmail=$row[csf("email")];
			$suppWeb=$row[csf("web_site")];
		}
		$beneficiaryDtls="<b>Beneficiary:</b> <br>".$suppName."<br>".$suppAdd."<br>".$suppPhone."<br>".$suppPax."<br>".$suppEmail."<br>".$suppWeb;
	}
	ob_start();
	?>
    <style>
	@media print
	{
	     .page-break { height:0; page-break-before:always; margin:0; border-top:none; }
	}
     body, p, span, td, a {font-size:10pt;font-family: Arial;}
     body{margin-left:2em; margin-right:2em; font-family: "Arial Narrow", Arial, sans-serif;}
	</style>
	<div style="width:930px" align="center">
        <table width="100%" cellpadding="0" cellspacing="0" style="border:0px solid black" >
            <tr>
                <td width="100">
                	<img src='<?=$path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
                </td>
                <td width="830">
                    <table width="100%" cellpadding="0" cellspacing="0"  border="0" >
                        <tr>
                            <td align="center" colspan="2" style="font-size:20px"><?=$comName; ?></td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:14px"><?=show_company($cbo_company_name,'',''); ?></td>  
                        </tr>
                        <tr>
                            <td align="center" colspan="2" style="font-size:16px">
                            	<span><b>Fabric <?=$fabric_source[$cbo_fabric_source]; ?> Order No:&nbsp;&nbsp;<?=trim($txt_booking_no,"'"); ?></span>
                                <span style="color:#FF0000"><?php if ($is_approved==1 || $is_approved==3) {echo "(Approved)";} ?></span>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
            <tr>
            	<td width="830" colspan="2">
                	<table width="100%" cellpadding="0" cellspacing="0"  border="1" rules="all" >
                        <tr>
                            <td><?=$beneficiaryDtls; ?></td>
                            <td><?=$consigneeDtls; ?></td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
	<div>
    <div style="width:930px" align="center">
        <table class="rpt_table" width="100%" border="1" cellpadding="0" cellspacing="0" rules="all" >
        	<thead>
            	<th width="60">Issue Date</th>
                <th width="60">Delivery Date</th>
                <th width="70">Fabric Source</th>
                <th width="60">Mode of Shipment </th>
                <th width="100">Pay Term & Tenor</th>
                <th width="70">Contact Person</th>
                <th width="90">Buyer</th>
                <th width="150">Job No</th>
                <th>Style</th>
            </thead>
            <tbody>
            	<tr>
                    <td align="center"><?=change_date_format($booking_date); ?></td>
                    <td align="center"><?=change_date_format($delivery_date); ?></td>
                    <td align="center" style="word-break:break-all"><?=$fabric_source[$cbo_fabric_source]; ?></td>
                    <td align="center" style="word-break:break-all"><?=$shipment_mode[$ship_mode]; ?></td>
                    <td align="center" style="word-break:break-all"><?=$paytermTenor; ?></td>
                    <td align="center" style="word-break:break-all"><?=$attention; ?></td>
                    <td style="word-break:break-all"><?=$buyer_name_arr[$buyer_id]; ?></td>
                    <td style="word-break:break-all"><?=$jobAll; ?></td>
                    <td style="word-break:break-all"><?=$styleAll; ?></td>
                </tr>
                <tr>
                	<td align="center">Order No</td>
                    <td style="word-break:break-all" colspan="8"><?=$poAll; ?></td>
                </tr>
            </tbody>
        </table>
	<div>
    <br>
    <?
	$color_wise_process_loss=sql_select("select  a.id, a.job_no,a.body_part_id,b.color_number_id,a.process_loss_method,b.process_loss_percent as loss FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls  b 	WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and  a.job_no in(".$all_jobs_id.") and b.process_loss_percent>0 group by a.id, a.job_no,a.body_part_id,a.process_loss_method,b.color_number_id,b.process_loss_percent");
	foreach($color_wise_process_loss as $val)
	{
		$loss_arr[$val[csf("id")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['loss']=$val[csf("loss")];
		$loss_arr[$val[csf("id")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['loss_method']=$val[csf("process_loss_method")];
	}





	$sqlBookDtls="Select a.job_no,a.id as fabric_cost_dtls_id , a.id, a.item_number_id, a.body_part_id, a.fabric_description, a.uom, b.gsm_weight, b.dia_width, b.color_type, b.gmts_color_id, b.fabric_color_id, b.fin_fab_qnty,b.grey_fab_qnty, b.rate, b.amount, b.remark from wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls b where a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no=$txt_booking_no  and a.body_part_type not in  (40,50) and b.status_active =1 and b.is_deleted=0";

	
	
	$sqlBookDtlsRes=sql_select($sqlBookDtls);
	$dtlsDataArr=array();
	foreach($sqlBookDtlsRes as $brow)
	{
		$img_ref=$brow[csf('id')].'_'.$brow[csf('fabric_color_id')];

		$process_loss=$loss_arr[$brow[csf("fabric_cost_dtls_id")]][$brow[csf("job_no")]][$brow[csf("body_part_id")]][$brow[csf("gmts_color_id")]]['loss'];
		$process_loss_method=$loss_arr[$brow[csf("fabric_cost_dtls_id")]][$brow[csf("job_no")]][$brow[csf("body_part_id")]][$brow[csf("gmts_color_id")]]['loss_method'];
		if($process_loss=='') $process_loss=0;else $process_loss=$process_loss;
		if($process_loss_method=='') $process_loss_method=0;else $process_loss_method=$process_loss_method;
		
		$dtlsDataArr[$brow[csf('item_number_id')]][$brow[csf('body_part_id')]][$brow[csf('fabric_description')]][$brow[csf('gsm_weight')]][$brow[csf('dia_width')]][$brow[csf('color_type')]][$brow[csf('gmts_color_id')]][$brow[csf('fabric_color_id')]][$brow[csf('uom')]]['finQty']+=$brow[csf('fin_fab_qnty')];
		$dtlsDataArr[$brow[csf('item_number_id')]][$brow[csf('body_part_id')]][$brow[csf('fabric_description')]][$brow[csf('gsm_weight')]][$brow[csf('dia_width')]][$brow[csf('color_type')]][$brow[csf('gmts_color_id')]][$brow[csf('fabric_color_id')]][$brow[csf('uom')]]['greyQty']+=$brow[csf('grey_fab_qnty')];
		$dtlsDataArr[$brow[csf('item_number_id')]][$brow[csf('body_part_id')]][$brow[csf('fabric_description')]][$brow[csf('gsm_weight')]][$brow[csf('dia_width')]][$brow[csf('color_type')]][$brow[csf('gmts_color_id')]][$brow[csf('fabric_color_id')]][$brow[csf('uom')]]['amt']+=$brow[csf('amount')];
		$dtlsDataArr[$brow[csf('item_number_id')]][$brow[csf('body_part_id')]][$brow[csf('fabric_description')]][$brow[csf('gsm_weight')]][$brow[csf('dia_width')]][$brow[csf('color_type')]][$brow[csf('gmts_color_id')]][$brow[csf('fabric_color_id')]][$brow[csf('uom')]]['remarks'].=$brow[csf('remark')]."__";
		$dtlsDataArr[$brow[csf('item_number_id')]][$brow[csf('body_part_id')]][$brow[csf('fabric_description')]][$brow[csf('gsm_weight')]][$brow[csf('dia_width')]][$brow[csf('color_type')]][$brow[csf('gmts_color_id')]][$brow[csf('fabric_color_id')]][$brow[csf('uom')]]['fabimg']=$img_ref;
		$dtlsDataArr[$brow[csf('item_number_id')]][$brow[csf('body_part_id')]][$brow[csf('fabric_description')]][$brow[csf('gsm_weight')]][$brow[csf('dia_width')]][$brow[csf('color_type')]][$brow[csf('gmts_color_id')]][$brow[csf('fabric_color_id')]][$brow[csf('uom')]]['p_loss']=$process_loss;
		$dtlsDataArr[$brow[csf('item_number_id')]][$brow[csf('body_part_id')]][$brow[csf('fabric_description')]][$brow[csf('gsm_weight')]][$brow[csf('dia_width')]][$brow[csf('color_type')]][$brow[csf('gmts_color_id')]][$brow[csf('fabric_color_id')]][$brow[csf('uom')]]['p_loss_method']=$process_loss_method;

	}
	unset($sqlBookDtlsRes);
	asort($dtlsDataArr);
	
	$fabspanArr=array();
	foreach($dtlsDataArr as $itemid=>$itemData)
	{
		
		foreach($itemData as $bodyid=>$bodyData)
		{
			foreach($bodyData as $fabric=>$fabricData)	
			{
				foreach($fabricData as $gsm=>$gsmData)
				{
					foreach($gsmData as $dia=>$diaData)
					{
						$fabspan=0;
						foreach($diaData as $colortyp=>$colortypData)
						{
							foreach($colortypData as $gmtcolor=>$gmtcolorData)
							{
								foreach($gmtcolorData as $fabcolor=>$fabcolorData)
								{
									foreach($fabcolorData as $uom=>$uomData)
									{
										$fabspan++;
									}
								}
							}
						}
						$fabspanArr[$itemid][$bodyid][$fabric][$gsm][$dia]=$fabspan;
					}
				}
			}
		}
	}
	/*echo "<pre>";
	print_r($fabspanArr);*/
	?>
    
    <div style="width:930px" align="center">
        <table class="rpt_table" width="100%" border="1" cellpadding="0" cellspacing="0" rules="all" >
			<tr><th colspan="14">Fabric Details</th></tr>
        	<tr>
            	<th width="70">GMT Item Name</th>
                <th width="70">Body Part</th>
                <th width="130">Fab Description</th>
                <th width="40">GSM</th>
                <th width="40">Fab Dia</th>
                <th width="60">Color Type</th>
                <th width="80">Gmts Color</th>
                <th width="80">Fab Color</th>
                <th width="50">Fab Design IMG</th>    
				<th width="80">Grey Fab Qty</th>            
                <th width="80">Finish Fab Qty</th>			
                <th width="50">UOM</th>
                <th width="50">Rate</th>
                <th width="80">Amount</th>
                <th>Remarks</th>
			</tr>
           
            <?
			foreach($dtlsDataArr as $itemid=>$itemData)
			{
				foreach($itemData as $bodyid=>$bodyData)
				{
					foreach($bodyData as $fabric=>$fabricData)	
					{
						foreach($fabricData as $gsm=>$gsmData)
						{
							foreach($gsmData as $dia=>$diaData)
							{
								$k=1; $finQtyTotal=0;$greyQtyTotal=0; $bookingAmtTotal=0;
								$fabrowspan=$fabspanArr[$itemid][$bodyid][$fabric][$gsm][$dia]+1;
								foreach($diaData as $colortyp=>$colortypData)
								{
									foreach($colortypData as $gmtcolor=>$gmtcolorData)
									{
										foreach($gmtcolorData as $fabcolor=>$fabcolorData)
										{
											foreach($fabcolorData as $uom=>$uomData)
											{
												
												$remarks=""; $avgRate=0;
												$remarks=implode(",",array_filter(array_unique(explode("__",$uomData['remarks']))));
												$avgRate=$uomData['amt']/$uomData['finQty'];

												$p_loss_method=$uomData['p_loss_method'];
												$process_loss=$uomData['p_loss'];
											if($process_loss) $process_loss=$process_loss;else $process_loss=0;


												
												if($p_loss_method==1) //markup
												{
				
													$fin_qty=$uomData['finQty']-(($uomData['finQty']*$process_loss)/(100+$process_loss));
												}
												else if($p_loss_method==2) //margin
												{
													$fin_qty=$uomData['finQty']-(($uomData['finQty']*$process_loss)/100);
												}
												else $fin_qty=$uomData['finQty'];

												?>
                                                <tr>
                                                    <?
                                                    if($k==1)
                                                    {
														?>
														<td style="word-break:break-all" rowspan="<?=$fabrowspan; ?>"><?=$garments_item[$itemid]; ?></td>
														<td style="word-break:break-all" rowspan="<?=$fabrowspan; ?>" title="<?=$bodyid;?>"><?=$body_part[$bodyid]; ?></td>
														<td style="word-break:break-all" rowspan="<?=$fabrowspan; ?>"><?=$fabric; ?></td>
														<td style="word-break:break-all" rowspan="<?=$fabrowspan; ?>" align="center"><?=$gsm; ?></td>
														<td style="word-break:break-all" rowspan="<?=$fabrowspan; ?>" align="center"><?=$dia; ?></td>
														<?
                                                    }
                                                    ?>
                                                    <td style="word-break:break-all"><?=$color_type[$colortyp]; ?></td>
                                                    <td style="word-break:break-all"><?=$color_library[$gmtcolor]; ?></td>
                                                    <td style="word-break:break-all"><?=$color_library[$fabcolor]; ?></td>
                                                    <td style="word-break:break-all" width="50"><img src='<?=$path.$fabimge_arr[$uomData['fabimg']]; ?>' height='100%' width='100%' /></td>
                                                    <td style="word-break:break-all" align="right"><?=number_format($uomData['greyQty'],2); ?></td>
													<td style="word-break:break-all" align="right" title="process loss:<?=$process_loss;?>"><?=number_format($fin_qty,2); ?></td>
                                                    <td style="word-break:break-all"><?=$unit_of_measurement[$uom]; ?></td>
                                                    <td style="word-break:break-all" align="right"><?=number_format($avgRate,2); ?></td>
                                                    <td style="word-break:break-all" align="right"><?=number_format($uomData['amt'],2); ?></td>
                                                    <td style="word-break:break-all"><?=$remarks; ?></td>
                                                </tr>
                                                <?
												$k++;
												
												$greyQtyTotal+=$uomData['greyQty']; 
												$finQtyTotal+=$fin_qty; 
												$bookingAmtTotal+=$uomData['amt'];
												$ggreyQty+=$uomData['greyQty']; 
												$gfinQty+=$fin_qty; 
												$gbookingAmt+=$uomData['amt'];
											}
										}
									}
								}
								
								?>
                                	<tr style="background-color:#E3FDE6">
                                        <td style="word-break:break-all" colspan="4" align="right">Fabric Total : </td>
                                        <td style="word-break:break-all" align="right"><?=number_format($greyQtyTotal,2); ?></td>
										<td style="word-break:break-all" align="right"><?=number_format($finQtyTotal,2); ?></td>
                                        <td style="word-break:break-all">&nbsp;</td>
                                        <td style="word-break:break-all" align="right">&nbsp;</td>
                                        <td style="word-break:break-all" align="right"><?=number_format($bookingAmtTotal,2); ?></td>
                                        <td style="word-break:break-all">&nbsp;</td>
                                    </tr>
                                <?
							}
						}
					}
				}
			}
			?>
			 <tr style="background-color:#CCC">
                    <td style="word-break:break-all" colspan="9" align="right">Grand Total : </td>
					<td style="word-break:break-all" align="right"><?=number_format($ggreyQty,2); ?></td>
                    <td style="word-break:break-all" align="right"><?=number_format($gfinQty,2); ?></td>
                    <td style="word-break:break-all">&nbsp;</td>
                    <td style="word-break:break-all" align="right">&nbsp;</td>
                    <td style="word-break:break-all" align="right"><?=number_format($gbookingAmt,2); ?></td>
                    <td style="word-break:break-all">&nbsp;</td>
                </tr>
         
        
        </table>
	<div>
    <br>




	
		<?

			$sqlBookDtls="Select a.id, a.item_number_id, a.body_part_id, a.fabric_description, a.uom, b.gsm_weight, b.dia_width, b.color_type, b.gmts_color_id, b.fabric_color_id, b.fin_fab_qnty,b.grey_fab_qnty, b.rate, b.amount, b.remark,a.body_part_type from wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls b where a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no=$txt_booking_no  and a.body_part_type  in  (40,50) and b.status_active =1 and b.is_deleted=0";

				
				$sqlBookDtlsRes=sql_select($sqlBookDtls);
				$dtlsDataArr=array();
				foreach($sqlBookDtlsRes as $brow)
				{
					
					$string=$brow[csf('item_number_id')]."*".$brow[csf('body_part_id')]."*".$brow[csf('body_part_type')]."*".$brow[csf('fabric_description')]."*".$brow[csf('gsm_weight')]."*".$brow[csf('color_type')]."*".$brow[csf('gmts_color_id')];

					$booking_collar_cuf_rate[$string]['rate']=$brow[csf('amount')]/$brow[csf('fin_fab_qnty')];
				}
				unset($sqlBookDtlsRes);





			$po_num_arr=return_library_array("SELECT id,po_number from wo_po_break_down where job_no_mst in($all_jobs_id)",'id','po_number');
			$size_library=return_library_array( "select id,size_name from lib_size  where status_active=1 and is_deleted=0", "id", "size_name");
			$color_library=return_library_array( "select id,color_name from lib_color  where status_active=1 and is_deleted=0", "id", "color_name");

	       $sql_collar_cuff= "SELECT a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,b.gmts_color_id,b.size_number_id,b.item_size,b.gmts_qty,
		   b.excess_per,b.qty,b.id,a.job_no,a.rate,a.amount,a.color_size_sensitive, a.fabric_description,a.body_part_type  FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id) and a.body_part_type=40 and b.status_active=1 and b.is_deleted=0   order by a.body_part_id,b.gmts_color_id,b.id  " ;

		   
			
		  


	         $sql_data_collar_cuff=sql_select($sql_collar_cuff);
			 $color_rows=array();
			 foreach($sql_data_collar_cuff as $row)
			 {
				$style=$job_data_arr[$row[csf('job_no')]]['style'];
			
				$color_id[$row[csf('gmts_color_id')]]=$row[csf('gmts_color_id')];
				
				$composition=$row[csf('construction')].",".$row[csf('composition')];
				$strings=$row[csf('item_number_id')]."*".$row[csf('body_part_id')]."*".$row[csf('body_part_type')]."*".$row[csf('fabric_description')]."*".$row[csf('gsm_weight')]."*".$row[csf('color_type_id')]."*".$row[csf('gmts_color_id')];
				
				 $style_wise_data[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['gmts_qty']+=$row[csf('gmts_qty')];
				 $style_wise_data[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['fabric_cost_dtls_id']=$row[csf('fabric_cost_dtls_id')];
				 $style_wise_data[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['color_size_sensitive']=$row[csf('color_size_sensitive')];
				 $style_wise_data[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['qty']+=$row[csf('qty')];
				 $style_wise_data[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
				 $style_wise_data[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['amount']=$row[csf('amount')];
				 $style_wise_data[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['rate']=$booking_collar_cuf_rate[$strings]['rate'];
				 $style_wise_data[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['item_size']=$row[csf('item_size')];
				 $style_wise_data[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['excess_per']=$row[csf('excess_per')];
				 $style_wise_data[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['job_no']=$row[csf('job_no')];


			 }
			 

			//  echo "<pre>";
			//  print_r($job_wise_booking_rate);
			$color_rows=array();
			foreach($style_wise_data as $styleId=>$item_data){
				foreach($item_data as $itemId=>$body_part_data){
				   foreach($body_part_data as $bodyId=>$comp_data){
					  foreach($comp_data as $compId=>$colortype_data){

						foreach($colortype_data as $colortypeId=>$color_data){
						  foreach($color_data as $colorId=>$size_data){
							foreach($size_data as $sizeId=>$row){


									$color_rows[$styleId][$colorId]+=1;
									if($row['excess_per']>0){
									$style_wise_qty[$styleId][$colorId]+=$row['gmts_qty']+(($row['gmts_qty']*$row['excess_per'])/100);
									}else{
										$style_wise_qty[$styleId][$colorId]+=$row['gmts_qty'];
									}
									}
								}
							}
						}
					}
				}
			}
			//  echo "<pre>";
			//  print_r($color_rows);

		?>
		


			<?

	          if(count($sql_data_collar_cuff)>0)

	          {

					?>
			  		<br>
			  		<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
					  <tr>
						<td colspan="16" align="center">
							<strong>Collar and Cuff Breakdown</strong>
						</td>

					</tr>
			  			<tr>
			  				<td colspan="16" align="center">
			  					<strong>Collar Details</strong>
			  				</td>

			  			</tr>

			  			<tr>
			  				<td align="center"> SL </td>
							<td align="center" width="80">Style </td>
							<td align="center">Gmts Item </td>
							<td align="center">Body Part </td>
			  				<td align="center" width="150">Collar Composition</td>
							<td align="center">GSM </td>
							<td align="center">Color Type </td>			  			
			  				<td align="center"> Fabric  Color  </td>
			  				<td align="center"> Gmts Size</td>
			  				<td align="center"> Item Size  </td>
			  				<td align="center"> Gmts Qty (Pcs)  </td>
			  				<td align="center"> Excess %   </td>
			  				<td align="center"> Collar Qty (Pcs) </td>
							<td align="center">  Rate </td>
							<td align="center"> Amount </td>
			  			</tr>
			  			<?
			  			$p=1;$color_id="";$grand_total_amount=0;
			  			foreach($style_wise_data as $styleId=>$item_data){
						  foreach($item_data as $itemId=>$body_part_data){
							 foreach($body_part_data as $bodyId=>$comp_data){
								foreach($comp_data as $compId=>$colortype_data){									
								  foreach($colortype_data as $colortypeId=>$color_data){									
									foreach($color_data as $colorId=>$size_data){
										$c=1;
									  foreach($size_data as $sizeId=>$row){

			  				?>
			  				<tr>
			  					<td align="center"><? echo $p;?></td>	
								<td align="left" title="<?=$row["job_no"];?>"><? echo $styleId ;?></td>
								<td align="left"><? echo $garments_item[$itemId] ;?></td>
								<td align="left"><? echo $body_part[$bodyId] ;?></td>
			  					<td align="left"> &nbsp;<? echo $compId; ?></td>
								<td align="center"><? echo $row["gsm_weight"] ;?></td>
								<td align="center"><? echo $color_type[$colortypeId] ;?></td>
			  					<td align="center">
								  <?
										if($row['color_size_sensitive']==1 or $row['color_size_sensitive']==2 or $row['color_size_sensitive']==4)
										{
											$gmt_fab_color=$color_library[$colorId];
										}
										else
										{
											$contrast_color_id=return_field_value("b.contrast_color_id as contrast_color_id", "wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b", "a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.job_no in ($all_jobs_id) and a.id=".$row['fabric_cost_dtls_id']."  and b.gmts_color_id=".$colorId." ","contrast_color_id");//pre_cost_fabric_cost_dtls_id
											if($contrast_color_id>0)
											{
												$gmt_fab_color=$color_library[$contrast_color_id];
											}
										}
									echo $gmt_fab_color;  ?>
			  					</td>
			  					<td align="center"><? echo $size_library[$sizeId];  ?></td>
			  					<td align="center"><? echo $row['item_size'];  ?></td>
			  					<td align="right"><? echo $row['gmts_qty']; $total_gmts_qty+=$row['gmts_qty']; ?></td>
			  					<td align="right"><? echo $row['excess_per'];$total_excess_per+=$row['excess_per'];?></td>
			  					<td align="right"><? echo $row['gmts_qty']+(($row['gmts_qty']*$row['excess_per'])/100);   $total_qty+=$row['qty']; ?></td>
								  <?php
								//   $r=1;
								 	if($c==1){					
								  ?>
								<td align="right" rowspan="<?=$color_rows[$styleId][$colorId];?>"><? echo number_format($row['rate'],2);  ?></td>
								<td align="right" rowspan="<?=$color_rows[$styleId][$colorId];?>"><? echo number_format($style_wise_qty[$styleId][$colorId]*$row['rate'],2);;  $sub_total_amount+=$style_wise_qty[$styleId][$colorId]*$row['rate']; 
								$grand_total_amount+=$style_wise_qty[$styleId][$colorId]*$row['rate'];

								?></td>

								<?
								 }
								?>
								
			  				</tr>
			  				<?
			  				$p++;  $r++;  $c++;
							 $sub_total_gmts_qty+=$row['gmts_qty'];
							 $sub_total_collar_qty+=$row['gmts_qty']+(($row['gmts_qty']*$row['excess_per'])/100);
							
							  
			  		      }
					    }
				      }
				    }
				  }
			     }
                }
		    
			  		?>
					    <tr>
			  				<td align="right" colspan="10"><b>Sub Total</b> </td>
			  				<td align="right"><?= $sub_total_gmts_qty;?></td>
			  				<td align="right"></td>
			  				<td align="right"><?=$sub_total_collar_qty;?></td>
							<td align="right"></td>
							<td align="right"><?=number_format($sub_total_amount,2);?> </td>
			  			</tr>

						  <?}?>
					  
			  	</table>
			  <br>

	   <?



				$sql_cuff_data=sql_select( "SELECT a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,b.gmts_color_id,b.size_number_id,b.item_size,b.gmts_qty,
				b.excess_per,b.qty,b.id,a.job_no,a.rate,a.amount,a.color_size_sensitive,a.fabric_description,a.body_part_type  FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id) and a.body_part_type=50 and b.status_active=1 and b.is_deleted=0   order by a.body_part_id,b.gmts_color_id,b.id  ") ;


				$color_rows=array();
				$strings="";
				foreach($sql_cuff_data as $row)
				{
					$style=$job_data_arr[$row[csf('job_no')]]['style'];
				
					$color_id[$row[csf('gmts_color_id')]]=$row[csf('gmts_color_id')];
					
					$composition=$row[csf('construction')].",".$row[csf('composition')];

					
					$strings=$row[csf('item_number_id')]."*".$row[csf('body_part_id')]."*".$row[csf('body_part_type')]."*".$row[csf('fabric_description')]."*".$row[csf('gsm_weight')]."*".$row[csf('color_type_id')]."*".$row[csf('gmts_color_id')];
					
					$style_wise_data2[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['gmts_qty']+=$row[csf('gmts_qty')];
					$style_wise_data2[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['fabric_cost_dtls_id']=$row[csf('fabric_cost_dtls_id')];
					$style_wise_data2[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['color_size_sensitive']=$row[csf('color_size_sensitive')];
					$style_wise_data2[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['qty']+=$row[csf('qty')];
					$style_wise_data2[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
					$style_wise_data2[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['amount']=$row[csf('amount')];
					$style_wise_data2[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['rate']=$booking_collar_cuf_rate[$strings]['rate'];;
					$style_wise_data2[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['item_size']=$row[csf('item_size')];
					$style_wise_data2[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['excess_per']=$row[csf('excess_per')];


				}
				

				//  echo "<pre>";
				//  print_r($style_wise_data);
				$color_rows2=array();$style_wise_qty2=array();
				foreach($style_wise_data2 as $styleId=>$item_data){
					foreach($item_data as $itemId=>$body_part_data){
						foreach($body_part_data as $bodyId=>$comp_data){
						foreach($comp_data as $compId=>$colortype_data){
							foreach($colortype_data as $colortypeId=>$color_data){
							foreach($color_data as $colorId=>$size_data){
								foreach($size_data as $sizeId=>$row){

										$color_rows2[$styleId][$colorId]+=1;
										
											$style_wise_qty2[$styleId][$colorId]+=$row['qty'];
										
										
										}
									}
								}
							}
						}
					}
				}
	   


			 if(count($sql_cuff_data)>0)

			 {

				   ?>
					 <br>
					 <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

						 <tr>
							 <td colspan="16" align="center">
								 <strong>Cuff Details</strong>
							 </td>
						 </tr>
						 <tr>
						   <td align="center"> SL </td>
						   <td align="center" width="80">Style </td>
						   <td align="center">Gmts Item </td>
						   <td align="center">Body Part </td>
						   <td align="center" width="150">Cuff Composition </td>
						   <td align="center">GSM </td>
						   <td align="center">Color Type </td>						
						   <td align="center"> Fabric  Color  </td>
						   <td align="center"> Gmts Size</td>
						   <td align="center"> Item Size  </td>
						   <td align="center"> Gmts Qty (Pcs)  </td>
						   <td align="center"> Excess %   </td>
						   <td align="center"> Cuff Qty (Pcs) </td>
						   <td align="center">  Rate </td>
						   <td align="center"> Amount </td>
						 </tr>
						 <?
			  			$p=1;$color_id="";$sub_total_gmts_qty=0; $sub_total_collar_qty=0; $sub_total_amount=0;
			  			foreach($style_wise_data2 as $styleId=>$item_data){
						  foreach($item_data as $itemId=>$body_part_data){
							 foreach($body_part_data as $bodyId=>$comp_data){
								foreach($comp_data as $compId=>$colortype_data){									
								  foreach($colortype_data as $colortypeId=>$color_data){									
									foreach($color_data as $colorId=>$size_data){
										$c=1;
									  foreach($size_data as $sizeId=>$row){

			  				?>
								<tr>
									<td align="center"><? echo $p;?></td>
									<td align="left"><? echo $styleId ;?></td>
									<td align="left"><? echo $garments_item[$itemId] ;?></td>
									<td align="left"><? echo $body_part[$bodyId] ;?></td>
									<td align="left"><? echo $compId; ?></td>
									<td align="center"><? echo $row["gsm_weight"] ;?></td>
									<td align="center">	<? echo $color_type[$colortypeId] ;?></td>
									<td align="center">
									<?
											if($row['color_size_sensitive']==1 or $row['color_size_sensitive']==2 or $row['color_size_sensitive']==4)
											{
												$gmt_fab_color=$color_library[$colorId];
											}
											else
											{
												$contrast_color_id=return_field_value("b.contrast_color_id as contrast_color_id", "wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b", "a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.job_no in ($all_jobs_id) and a.id=".$row['fabric_cost_dtls_id']."  and b.gmts_color_id=".$colorId." ","contrast_color_id");//pre_cost_fabric_cost_dtls_id
												if($contrast_color_id>0)
												{
													$gmt_fab_color=$color_library[$contrast_color_id];
												}
											}
										echo $gmt_fab_color;  ?>
									</td>
									<td align="center"><? echo $size_library[$sizeId];  ?></td>
									<td align="center"><? echo $row['item_size'];  ?></td>
									<td align="right"><? echo $row['gmts_qty'];	$total_gmts_qty+=$row['gmts_qty'];?></td>
									<td align="right"><? echo $row['excess_per']; $total_excess_per+=$row['excess_per'];?></td>
									<td align="right"><? echo $row['qty'];    ?></td>
									<?php
									//   $r=1;
									if($c==1){					
									?>
										<td align="right" rowspan="<?=$color_rows2[$styleId][$colorId];?>"><? echo number_format($row['rate'],2);  ?></td>
										<td align="right" rowspan="<?=$color_rows2[$styleId][$colorId];?>"><? echo number_format($style_wise_qty2[$styleId][$colorId]*$row['rate'],2);; $sub_total_amount+=$style_wise_qty2[$styleId][$colorId]*$row['rate']; 
										$grand_total_amount+=$style_wise_qty2[$styleId][$colorId]*$row['rate'];;					
										?>
										</td>

									<?
									}
									?>
									
								</tr>
			  				<?
			  				$p++;  $r++; $c++;
							 
							  $sub_total_gmts_qty+=$row['gmts_qty'];
							  $sub_total_cuff_qty+=$row['qty'];
			  		      }
					    }
				      }
				    }
				  }
			     }
                }
				?>
				<tr>
					<td align="right" colspan="10"><b>Sub Total</b> </td>
					<td align="right"><?= $sub_total_gmts_qty;?></td>
					<td align="right"></td>
					<td align="right"><?=$sub_total_cuff_qty;?></td>
					<td align="right"></td>
					<td align="right"><?=number_format($sub_total_amount,2);;?></td>
				</tr>
				<?
		    }

				if(count($style_wise_data)>0 || count($style_wise_data2)>0){

				
			  		?>
				
				<tr>
					<td align="right" colspan="14"><b>Grand Total</b> </td>				
					<td align="right"><?=number_format($grand_total_amount,2);;?></td>
				</tr>
				<?}
				?>
			 
		  </table>
			<br>



    <div style="width:930"><?=get_spacial_instruction($txt_booking_no); ?></div>
    <br>
    <div style="width:930px" align="center">
        <table class="rpt_table" width="100%" border="1" cellpadding="0" cellspacing="0" rules="all" >
        	<thead>
            	<th width="300">Shipping Marks [One Side]</th>
                <th width="200" colspan="2">Shipping Marks [Other Side]</th>
                <th width="200" colspan="2">Order Issued By</th>
                <th>Special Instruction /Remarks</th>
            </thead>
            <tbody>
            	<tr>
                    <td style="word-break:break-all" rowspan="6"><?=$shippingmark_str; ?></td>
                    <td align="center">Customer Name :</td>
                    <td align="center"><?=$buyer_name_arr[$buyer_id]; ?></td>
                    <td align="center" style="word-break:break-all"><?=$team_names; ?></td>
                    <td align="center" style="word-break:break-all"><?=$team_emails; ?></td>
                    <td align="center" style="word-break:break-all" rowspan="6"><?=$mstremarks; ?></td>
                </tr>
                <tr>
                    <td align="center">Four H Order :</td>
                    <td align="center"><?=$txt_booking_no; ?></td>
                    <td align="center" style="word-break:break-all"><?=$team_leaders; ?></td>
                    <td align="center" style="word-break:break-all"><?=$team_leader_emails; ?></td>
                </tr>
                <tr>
                    <td align="center">Quantity :</td>
                    <td align="center"><?=number_format($gfinQty,2); ?></td>
                    <td align="center" style="word-break:break-all"><?=$dealing_marchants; ?></td>
                    <td align="center" style="word-break:break-all"><?=$team_member_emails; ?></td>
                </tr>
                <tr>
                    <td align="center">&nbsp;</td>
                    <td align="center">&nbsp;</td>
                    <td align="center" style="word-break:break-all">&nbsp;</td>
                    <td align="center" style="word-break:break-all">&nbsp;</td>
                </tr>
                <tr>
                    <td align="center">&nbsp;</td>
                    <td align="center">&nbsp;</td>
                    <td align="center" style="word-break:break-all">&nbsp;</td>
                    <td align="center" style="word-break:break-all">&nbsp;</td>
                </tr>
                <tr>
                    <td align="center">&nbsp;</td>
                    <td align="center">&nbsp;</td>
                    <td align="center" style="word-break:break-all">&nbsp;</td>
                    <td align="center" style="word-break:break-all">&nbsp;</td>
                </tr>
            </tbody>
        </table>
	<div>
    <?=signature_table(121, $cbo_company_name, "930px"); 
			
	$html = ob_get_contents();
	ob_clean();
	list($is_mail_send,$mail)=explode('___',$mail_send_data);

	if($is_mail_send==1){
		require_once('../../../mailer/class.phpmailer.php');
		require_once('../../../auto_mail/setting/mail_setting.php');
		$mailBody = preg_replace("/<img[^>]+\>/i", " ", $html); 
		$mailBody="<br>".$mail_body	;
		$mailToArr=array();
		$mailSql = "select b.EMAIL  from wo_booking_mst a,LIB_SUPPLIER b where b.id=a.supplier_id and a.booking_no=$txt_booking_no";
	//echo $mailSql;die;
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
		}
		
		
		$mailSql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=99 and b.mail_user_setup_id=c.id  and c.IS_DELETED=0 and c.STATUS_ACTIVE=1";
		//echo $mailSql;die;
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
		}
		if($mail!=''){$mailToArr[]=$mail;}

		$to=implode(',',$mailToArr);
		$subject="Partial fabric booking";
		$header=mailHeader();
		echo $to;
		echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
		
	}
	else{
		echo $html;
	}
	exit();
}

if($action=="print_booking_18") //md mamun ahmed sagor-20/07/2022/copy-print 12-ISD:15975
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$path=str_replace("'","",$path);
	if($path!="") $path=$path; else $path="../../";

	$imge_arr=return_library_array( "select master_tble_id,image_location from common_photo_library where form_name='company_details' or form_name='knit_order_entry' and file_type=1",'master_tble_id','image_location');
	$fabimge_arr=return_library_array( "select master_tble_id, image_location from common_photo_library where form_name='company_details' or form_name='fabric_color_img' and file_type=1",'master_tble_id','image_location');
	
	$color_library=return_library_array( "select id,color_name from lib_color ", "id", "color_name");
	//$marchentrArr = return_library_array("select id, team_member_name from lib_mkt_team_member_info  where status_active=1 and is_deleted=0","id","team_member_name");
	$teamArr =$marchentrArr=array();
	$teamSql = sql_select("select a.id, b.id as bid, a.team_name, a.team_leader_name, a.team_leader_email, a.user_tag_id, b.user_tag_id as user_id, b.team_member_name, b.team_member_email from lib_marketing_team a, lib_mkt_team_member_info b where a.id=b.team_id and a.status_active=1 and a.is_deleted=0 ");
	foreach($teamSql as $trow)
	{
		$teamArr[$trow[csf('id')]]['teamname']=$trow[csf('team_name')];
		$teamArr[$trow[csf('id')]]['team_leader_name']=$trow[csf('team_leader_name')];
		$teamArr[$trow[csf('id')]]['team_email']=$trow[csf('team_leader_email')];
		$marchentrArr[$trow[csf('bid')]]['team_member_name']=$trow[csf('team_member_name')];
		$marchentrArr[$trow[csf('bid')]]['team_member_email']=$trow[csf('team_member_email')];
		if($trow[csf('user_tag_id')]==$trow[csf('user_id')])
		{
			$teamArr[$trow[csf('id')]]['team_leader_email']=$trow[csf('team_member_email')];
		}
	}
	unset($teamSql);
	
	$buyer_name_arr=return_library_array( "select id, buyer_name from lib_buyer  where status_active=1 and is_deleted=0",'id','buyer_name');
	$nameArray_approved=sql_select( "select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and a.status_active =1 and a.is_deleted=0");
	list($nameArray_approved_row)=$nameArray_approved;

	$job_data_arr=array();
	$nameArray_buyer=sql_select( "select a.style_ref_no, a.style_description, a.job_no, a.buyer_name, a.team_leader, a.dealing_marchant, a.total_set_qnty, c.po_number from wo_po_details_master a, wo_booking_dtls b, wo_po_break_down c where a.job_no=b.job_no and a.id=c.job_id and b.po_break_down_id=c.id and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0 order by a.job_no ");
	$jobAll=$styleAll=$poAll="";
	foreach ($nameArray_buyer as $result_buy)
	{
		if($jobAll=="") $jobAll=$result_buy[csf('job_no')]; else $jobAll.=','.$result_buy[csf('job_no')];
		if($styleAll=="") $styleAll=$result_buy[csf('style_ref_no')]; else $styleAll.='**'.$result_buy[csf('style_ref_no')];
		if($poAll=="") $poAll=$result_buy[csf('po_number')]; else $poAll.='**'.$result_buy[csf('po_number')];
		
		$job_data_arr[$result_buy[csf('job_no')]]['style']=$result_buy[csf('style_ref_no')];
		$job_data_arr[$result_buy[csf('job_no')]]['job_no_in']="'".$result_buy[csf('job_no')]."'";
		$dealing_marchant.=$marchentrArr[$result_buy[csf('dealing_marchant')]]['team_member_name'].',';
		$team_name.=$teamArr[$result_buy[csf('team_leader')]]['teamname'].',';
		$team_email.=$teamArr[$result_buy[csf('team_leader')]]['team_email'].',';
		$team_leader_email.=$teamArr[$result_buy[csf('team_leader')]]['team_leader_email'].',';
		$team_leader.=$teamArr[$result_buy[csf('team_leader')]]['team_leader_name'].',';
		$team_member_email.=$marchentrArr[$result_buy[csf('dealing_marchant')]]['team_member_email'].',';
		$all_jobs[$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
 	}
	unset($nameArray_buyer);
	
	$jobAll=implode(", ",array_unique(explode(",",$jobAll)));
	$styleAll=implode(", ",array_unique(explode("**",$styleAll)));
	$poAll=implode(", ",array_unique(explode("**",$poAll)));
	$all_jobs_id=implode(",",$all_jobs );

  	//print_r($job_data_arr);
	$dealing_marchant=rtrim($dealing_marchant,',');
	$dealing_marchants=implode(",",array_unique(explode(",",$dealing_marchant)));
	
	$team_member_email=rtrim($team_member_email,',');
	$team_member_emails=implode(",",array_unique(explode(",",$team_member_email)));
	
	$team_name=rtrim($team_name,',');
	$team_names=implode(",",array_unique(explode(",",$team_name)));
	
	$team_email=rtrim($team_email,',');
	$team_emails=implode(",",array_unique(explode(",",$team_email)));
	
	$team_leader=rtrim($team_leader,',');
	$team_leaders=implode(",",array_unique(explode(",",$team_leader)));
	
	$team_leader_email=rtrim($team_leader_email,',');
	$team_leader_emails=implode(",",array_unique(explode(",",$team_leader_email)));
	
	$nameArray=sql_select( "select a.buyer_id, a.booking_date, a.supplier_id, a.ship_mode, a.delivery_date, a.fabric_source, a.remarks, a.pay_mode, a.attention, a.pay_term, a.tenor, a.is_approved, a.shippingmark_breck_down from wo_booking_mst a where a.booking_no=$txt_booking_no and a.status_active=1 and a.is_deleted=0");
	foreach ($nameArray as $result_job){
		$booking_date=$result_job[csf('booking_date')];
		$buyer_id=$result_job[csf('buyer_id')];
		$ship_mode=$result_job[csf('ship_mode')];
		$delivery_date=$result_job[csf('delivery_date')];
		$supplier_id=$result_job[csf('supplier_id')];
		$pay_mode=$result_job[csf('pay_mode')];
		$shippingmark_breck_down=$result_job[csf('shippingmark_breck_down')];
		$mstremarks=$result_job[csf('remarks')];
		$attention=$result_job[csf('attention')];
		$paytermTenor=$pay_term[$result_job[csf('pay_term')]].', '.$result_job[csf('tenor')].' Days';
		$is_approved=$result_job[csf('is_approved')];
	}
	unset($nameArray);
	//echo $booking_date.'ddd';
	
	$shippingmark_data=explode("~!~",$shippingmark_breck_down);
	$shippingmark_str="<b>".$shippingmark_data[0]."</b><br>".$shippingmark_data[1]."<br>".$shippingmark_data[2]."<br>".$shippingmark_data[3]."<br>".$shippingmark_data[4]."<br>".$shippingmark_data[5];
	
	$country_full_name = return_library_array("SELECT id,country_name from lib_country", "id", "country_name");
			
	$sqlCom="select company_name, email, website, plot_no, level_no, road_no, block_no, country_id, province, city, zip_code, contact_no from lib_company where id='$cbo_company_name' and status_active=1 and is_deleted=0";
	$sqlComRes=sql_select($sqlCom);
	$comName=$comAdd=$comPhone=$comPax=$comEmail=$comWeb=""; $consigneeDtls="";
	foreach( $sqlComRes as $row)
	{
		$comName=$row[csf("company_name")];
		
		if($row[csf("level_no")])		$level_no 	= $row[csf("level_no")].', ';
		if($row[csf("plot_no")])		$plot_no 	=$row[csf("plot_no")].', ';
		if($row[csf("road_no")]) 		$road_no 	=$row[csf("road_no")].', ';
		if($row[csf("block_no")]!='')	$block_no 	=$row[csf("block_no")].', ';
		if($row[csf("zip_code")]!='')	$zip_code 	= ' -'.$row[csf("zip_code")].' , ';
		if($row[csf("city")]!='') 		$city 		= ($zip_code!="")?$row[csf("city")]:$row[csf("city")]." ,";
		if($row[csf("country_id")]!='')	$country 	= $country_full_name[$row[csf("country_id")]].'.';
		
		$comAdd=$level_no.$plot_no.$road_no.$block_no.$city.$zip_code.$country;
		$comPhone=$row[csf("contact_no")];
		$comEmail=$row[csf("email")];
		$comWeb=$row[csf("website")];
	}
	$consigneeDtls="<b>Consignee:</b> <br>".$comName."<br>".$comAdd."<br>".$comPhone."<br>".$comPax."<br>".$comEmail."<br>".$comWeb;
	
	$beneficiaryDtls="";
	if($pay_mode==3 || $pay_mode==5)
	{
		$sqlSupp="select company_name, email, website, plot_no, level_no, road_no, block_no, country_id, province, city, zip_code, contact_no from lib_company where id='$supplier_id' and status_active=1 and is_deleted=0";
		$sqlSuppRes=sql_select($sqlSupp);
		$suppName=$suppAdd=$suppPhone=$suppPax=$suppEmail=$suppWeb="";
		foreach( $sqlSuppRes as $row)
		{
			$suppName=$row[csf("company_name")];
			
			if($row[csf("level_no")])		$level_no 	= $row[csf("level_no")].', ';
			if($row[csf("plot_no")])		$plot_no 	=$row[csf("plot_no")].', ';
			if($row[csf("road_no")]) 		$road_no 	=$row[csf("road_no")].', ';
			if($row[csf("block_no")]!='')	$block_no 	=$row[csf("block_no")].', ';
			if($row[csf("zip_code")]!='')	$zip_code 	= ' -'.$row[csf("zip_code")].' , ';
			if($row[csf("city")]!='') 		$city 		= ($zip_code!="")?$row[csf("city")]:$row[csf("city")]." ,";
			if($row[csf("country_id")]!='')	$country 	= $country_full_name[$row[csf("country_id")]].'.';
			
			$suppAdd=$level_no.$plot_no.$road_no.$block_no.$city.$zip_code.$country;
			$suppPhone=$row[csf("contact_no")];
			$suppEmail=$row[csf("email")];
			$suppWeb=$row[csf("website")];
		}
		$beneficiaryDtls="<b>Beneficiary:</b> <br>".$suppName."<br>".$suppAdd."<br>".$suppPhone."<br>".$suppPax."<br>".$suppEmail."<br>".$suppWeb;
	}
	else
	{
		$sqlSupp="select supplier_name, email, web_site, address_1, contact_no from lib_supplier where id='$supplier_id' and status_active=1 and is_deleted=0";
		$sqlSuppRes=sql_select($sqlSupp);
		$suppName=$suppAdd=$suppPhone=$suppPax=$suppEmail=$suppWeb="";
		$level_no=$plot_no=$road_no=$block_no=$city=$zip_code=$country="";
		foreach( $sqlSuppRes as $row)
		{
			$suppName=$row[csf("supplier_name")];
			$suppAdd=$row[csf("address_1")];
			$suppPhone=$row[csf("contact_no")];
			$suppEmail=$row[csf("email")];
			$suppWeb=$row[csf("web_site")];
		}
		$beneficiaryDtls="<b>Beneficiary:</b> <br>".$suppName."<br>".$suppAdd."<br>".$suppPhone."<br>".$suppPax."<br>".$suppEmail."<br>".$suppWeb;
	}
	ob_start();
	?>
    <style>
	@media print
	{
	     .page-break { height:0; page-break-before:always; margin:0; border-top:none; }
	}
     body, p, span, td, a {font-size:10pt;font-family: Arial;}
     body{margin-left:2em; margin-right:2em; font-family: "Arial Narrow", Arial, sans-serif;}
	</style>
	<div style="width:930px" align="center">
        <table width="100%" cellpadding="0" cellspacing="0" style="border:0px solid black" >
            <tr>
                <td width="100">
                	<img src='<?=$path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
                </td>
                <td width="830">
                    <table width="100%" cellpadding="0" cellspacing="0"  border="0" >
                        <tr>
                            <td align="center" colspan="2" style="font-size:20px"><?=$comName; ?></td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:14px"><?=show_company($cbo_company_name,'',''); ?></td>  
                        </tr>
                        <tr>
                            <td align="center" colspan="2" style="font-size:16px">
                            	<span><b>Fabric <?=$fabric_source[$cbo_fabric_source]; ?> Order No:&nbsp;&nbsp;<?=trim($txt_booking_no,"'"); ?></span>
                                <span style="color:#FF0000"><?php if ($is_approved==1 || $is_approved==3) {echo "(Approved)";} ?></span>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
            <tr>
            	<td width="830" colspan="2">
                	<table width="100%" cellpadding="0" cellspacing="0"  border="1" rules="all" >
                        <tr>
                            <td><?=$beneficiaryDtls; ?></td>
                            <td><?=$consigneeDtls; ?></td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
	<div>
    <div style="width:930px" align="center">
        <table class="rpt_table" width="100%" border="1" cellpadding="0" cellspacing="0" rules="all" >
        	<thead>
            	<th width="60">Issue Date</th>
                <th width="60">Delivery Date</th>
                <th width="70">Fabric Source</th>
                <th width="60">Mode of Shipment </th>
                <th width="100">Pay Term & Tenor</th>
                <th width="70">Contact Person</th>
                <th width="90">Buyer</th>
                <th width="150">Job No</th>
                <th>Style</th>
            </thead>
            <tbody>
            	<tr>
                    <td align="center"><?=change_date_format($booking_date); ?></td>
                    <td align="center"><?=change_date_format($delivery_date); ?></td>
                    <td align="center" style="word-break:break-all"><?=$fabric_source[$cbo_fabric_source]; ?></td>
                    <td align="center" style="word-break:break-all"><?=$shipment_mode[$ship_mode]; ?></td>
                    <td align="center" style="word-break:break-all"><?=$paytermTenor; ?></td>
                    <td align="center" style="word-break:break-all"><?=$attention; ?></td>
                    <td style="word-break:break-all"><?=$buyer_name_arr[$buyer_id]; ?></td>
                    <td style="word-break:break-all"><?=$jobAll; ?></td>
                    <td style="word-break:break-all"><?=$styleAll; ?></td>
                </tr>
                <tr>
                	<td align="center">Order No</td>
                    <td style="word-break:break-all" colspan="8"><?=$poAll; ?></td>
                </tr>
            </tbody>
        </table>
	<div>
    <br>
    <?
	$color_wise_process_loss=sql_select("select  a.id, a.job_no,a.body_part_id,b.color_number_id,a.process_loss_method,b.process_loss_percent as loss FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls  b 	WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and  a.job_no in(".$all_jobs_id.") and b.process_loss_percent>0 group by a.id, a.job_no,a.body_part_id,a.process_loss_method,b.color_number_id,b.process_loss_percent");
	foreach($color_wise_process_loss as $val)
	{
		$loss_arr[$val[csf("id")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['loss']=$val[csf("loss")];
		$loss_arr[$val[csf("id")]][$val[csf("job_no")]][$val[csf("body_part_id")]][$val[csf("color_number_id")]]['loss_method']=$val[csf("process_loss_method")];
	}





	$sqlBookDtls="Select a.job_no,a.id as fabric_cost_dtls_id , a.id, a.item_number_id, a.body_part_id, a.fabric_description, a.uom, b.gsm_weight, b.dia_width, b.color_type, b.gmts_color_id, b.fabric_color_id, b.fin_fab_qnty,b.grey_fab_qnty, b.rate, b.amount, b.remark from wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls b where a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no=$txt_booking_no  and a.body_part_type not in  (40,50) and b.status_active =1 and b.is_deleted=0";

	
	
	$sqlBookDtlsRes=sql_select($sqlBookDtls);
	$dtlsDataArr=array();
	foreach($sqlBookDtlsRes as $brow)
	{
		$img_ref=$brow[csf('id')].'_'.$brow[csf('fabric_color_id')];

		$process_loss=$loss_arr[$brow[csf("fabric_cost_dtls_id")]][$brow[csf("job_no")]][$brow[csf("body_part_id")]][$brow[csf("gmts_color_id")]]['loss'];
		$process_loss_method=$loss_arr[$brow[csf("fabric_cost_dtls_id")]][$brow[csf("job_no")]][$brow[csf("body_part_id")]][$brow[csf("gmts_color_id")]]['loss_method'];
		if($process_loss=='') $process_loss=0;else $process_loss=$process_loss;
		if($process_loss_method=='') $process_loss_method=0;else $process_loss_method=$process_loss_method;
		
		$dtlsDataArr[$brow[csf('fabric_description')]][$brow[csf('gsm_weight')]][$brow[csf('dia_width')]][$brow[csf('color_type')]][$brow[csf('gmts_color_id')]][$brow[csf('fabric_color_id')]][$brow[csf('uom')]]['finQty']+=$brow[csf('fin_fab_qnty')];
		$dtlsDataArr[$brow[csf('fabric_description')]][$brow[csf('gsm_weight')]][$brow[csf('dia_width')]][$brow[csf('color_type')]][$brow[csf('gmts_color_id')]][$brow[csf('fabric_color_id')]][$brow[csf('uom')]]['greyQty']+=$brow[csf('grey_fab_qnty')];
		$dtlsDataArr[$brow[csf('fabric_description')]][$brow[csf('gsm_weight')]][$brow[csf('dia_width')]][$brow[csf('color_type')]][$brow[csf('gmts_color_id')]][$brow[csf('fabric_color_id')]][$brow[csf('uom')]]['amt']+=$brow[csf('amount')];
		$dtlsDataArr[$brow[csf('fabric_description')]][$brow[csf('gsm_weight')]][$brow[csf('dia_width')]][$brow[csf('color_type')]][$brow[csf('gmts_color_id')]][$brow[csf('fabric_color_id')]][$brow[csf('uom')]]['remarks'].=$brow[csf('remark')]."__";
		$dtlsDataArr[$brow[csf('fabric_description')]][$brow[csf('gsm_weight')]][$brow[csf('dia_width')]][$brow[csf('color_type')]][$brow[csf('gmts_color_id')]][$brow[csf('fabric_color_id')]][$brow[csf('uom')]]['fabimg']=$img_ref;
		$dtlsDataArr[$brow[csf('fabric_description')]][$brow[csf('gsm_weight')]][$brow[csf('dia_width')]][$brow[csf('color_type')]][$brow[csf('gmts_color_id')]][$brow[csf('fabric_color_id')]][$brow[csf('uom')]]['p_loss']=$process_loss;
		$dtlsDataArr[$brow[csf('fabric_description')]][$brow[csf('gsm_weight')]][$brow[csf('dia_width')]][$brow[csf('color_type')]][$brow[csf('gmts_color_id')]][$brow[csf('fabric_color_id')]][$brow[csf('uom')]]['p_loss_method']=$process_loss_method;

	}
	unset($sqlBookDtlsRes);
	asort($dtlsDataArr);
	
	$fabspanArr=array();

			foreach($dtlsDataArr as $fabric=>$fabricData)	
			{
				foreach($fabricData as $gsm=>$gsmData)
				{
					foreach($gsmData as $dia=>$diaData)
					{
						$fabspan=0;
						foreach($diaData as $colortyp=>$colortypData)
						{
							foreach($colortypData as $gmtcolor=>$gmtcolorData)
							{
								foreach($gmtcolorData as $fabcolor=>$fabcolorData)
								{
									foreach($fabcolorData as $uom=>$uomData)
									{
										$fabspan++;
									}
								}
							}
						}
						$fabspanArr[$fabric][$gsm][$dia]=$fabspan;
					}
				}
			}
		
	
	/*echo "<pre>";
	print_r($fabspanArr);*/
	?>
    
    <div style="width:930px" align="center">
        <table class="rpt_table" width="100%" border="1" cellpadding="0" cellspacing="0" rules="all" >
			<tr><th colspan="14">Fabric Details</th></tr>
        	<tr>
            	
                <th width="130">Fab Description</th>
                <th width="40">GSM</th>
                <th width="40">Fab Dia</th>
                <th width="60">Color Type</th>
                <th width="80">Gmts Color</th>
                <th width="80">Fab Color</th>
                <th width="50">Fab Design IMG</th>    
				<th width="80">Grey Fab Qty</th>            
                <th width="80">Finish Fab Qty</th>			
                <th width="50">UOM</th>
                <th width="50">Rate</th>
                <th width="80">Amount</th>
                <th>Remarks</th>
			</tr>
           
            <?
			
					foreach($dtlsDataArr as $fabric=>$fabricData)	
					{
						foreach($fabricData as $gsm=>$gsmData)
						{
							foreach($gsmData as $dia=>$diaData)
							{
								$k=1; $finQtyTotal=0;$greyQtyTotal=0; $bookingAmtTotal=0;
								$fabrowspan=$fabspanArr[$fabric][$gsm][$dia]+1;
								foreach($diaData as $colortyp=>$colortypData)
								{
									foreach($colortypData as $gmtcolor=>$gmtcolorData)
									{
										foreach($gmtcolorData as $fabcolor=>$fabcolorData)
										{
											foreach($fabcolorData as $uom=>$uomData)
											{
												
												$remarks=""; $avgRate=0;
												$remarks=implode(",",array_filter(array_unique(explode("__",$uomData['remarks']))));
												$avgRate=$uomData['amt']/$uomData['finQty'];

												$p_loss_method=$uomData['p_loss_method'];
												$process_loss=$uomData['p_loss'];
												if($process_loss) $process_loss=$process_loss;else $process_loss=0;


												
												if($p_loss_method==1) //markup
												{
				
													$fin_qty=$uomData['finQty']-(($uomData['finQty']*$process_loss)/(100+$process_loss));
												}
												else if($p_loss_method==2) //margin
												{
													$fin_qty=$uomData['finQty']-(($uomData['finQty']*$process_loss)/100);
												}
												else $fin_qty=$uomData['finQty'];

												?>
                                                <tr>
                                                    <?
                                                    if($k==1)
                                                    {
														?>
														
														<td style="word-break:break-all" rowspan="<?=$fabrowspan; ?>"><?=$fabric; ?></td>
														<td style="word-break:break-all" rowspan="<?=$fabrowspan; ?>" align="center"><?=$gsm; ?></td>
														<td style="word-break:break-all" rowspan="<?=$fabrowspan; ?>" align="center"><?=$dia; ?></td>
														<?
                                                    }
                                                    ?>
                                                    <td style="word-break:break-all"><?=$color_type[$colortyp]; ?></td>
                                                    <td style="word-break:break-all"><?=$color_library[$gmtcolor]; ?></td>
                                                    <td style="word-break:break-all"><?=$color_library[$fabcolor]; ?></td>
                                                    <td style="word-break:break-all" width="50"><img src='<?=$path.$fabimge_arr[$uomData['fabimg']]; ?>' height='100%' width='100%' /></td>
                                                    <td style="word-break:break-all" align="right"><?=number_format($uomData['greyQty'],2); ?></td>
													<td style="word-break:break-all" align="right" title="process loss:<?=$process_loss;?>"><?=number_format($fin_qty,2); ?></td>
                                                    <td style="word-break:break-all"><?=$unit_of_measurement[$uom]; ?></td>
                                                    <td style="word-break:break-all" align="right"><?=number_format($avgRate,2); ?></td>
                                                    <td style="word-break:break-all" align="right"><?=number_format($uomData['amt'],2); ?></td>
                                                    <td style="word-break:break-all"><?=$remarks; ?></td>
                                                </tr>
                                                <?
												$k++;
												
												$greyQtyTotal+=$uomData['greyQty']; 
												$finQtyTotal+=$fin_qty; 
												$bookingAmtTotal+=$uomData['amt'];
												$ggreyQty+=$uomData['greyQty']; 
												$gfinQty+=$fin_qty; 
												$gbookingAmt+=$uomData['amt'];
											}
										}
									}
								}
								
								?>
                                	<tr style="background-color:#E3FDE6">
                                        <td style="word-break:break-all" colspan="4" align="right">Fabric Total : </td>
                                        <td style="word-break:break-all" align="right"><?=number_format($greyQtyTotal,2); ?></td>
										<td style="word-break:break-all" align="right"><?=number_format($finQtyTotal,2); ?></td>
										
                                        <td style="word-break:break-all">&nbsp;</td>
                                        <td style="word-break:break-all" align="right">&nbsp;</td>
                                        <td style="word-break:break-all" align="right"><?=number_format($bookingAmtTotal,2); ?></td>
                                        <td style="word-break:break-all">&nbsp;</td>
                                    </tr>
                                <?
							}
						}
					}
				
			
			?>
			 <tr style="background-color:#CCC">
                    <td style="word-break:break-all" colspan="7" align="right">Grand Total : </td>
					<td style="word-break:break-all" align="right"><?=number_format($ggreyQty,2); ?></td>
                    <td style="word-break:break-all" align="right"><?=number_format($gfinQty,2); ?></td>
                    <td style="word-break:break-all">&nbsp;</td>
                    <td style="word-break:break-all" align="right">&nbsp;</td>
                    <td style="word-break:break-all" align="right"><?=number_format($gbookingAmt,2); ?></td>
                    <td style="word-break:break-all">&nbsp;</td>
                </tr>
         
        
        </table>
	<div>
    <br>




	
		<?

			$sqlBookDtls="Select a.id, a.item_number_id, a.body_part_id, a.fabric_description, a.uom, b.gsm_weight, b.dia_width, b.color_type, b.gmts_color_id, b.fabric_color_id, b.fin_fab_qnty,b.grey_fab_qnty, b.rate, b.amount, b.remark,a.body_part_type from wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls b where a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no=$txt_booking_no  and a.body_part_type  in  (40,50) and b.status_active =1 and b.is_deleted=0";

				
				$sqlBookDtlsRes=sql_select($sqlBookDtls);
				$dtlsDataArr=array();
				foreach($sqlBookDtlsRes as $brow)
				{
					
					$string=$brow[csf('item_number_id')]."*".$brow[csf('body_part_id')]."*".$brow[csf('body_part_type')]."*".$brow[csf('fabric_description')]."*".$brow[csf('gsm_weight')]."*".$brow[csf('color_type')]."*".$brow[csf('gmts_color_id')];

					$booking_collar_cuf_rate[$string]['rate']=$brow[csf('amount')]/$brow[csf('fin_fab_qnty')];
				}
				unset($sqlBookDtlsRes);





			$po_num_arr=return_library_array("SELECT id,po_number from wo_po_break_down where job_no_mst in($all_jobs_id)",'id','po_number');
			$size_library=return_library_array( "select id,size_name from lib_size  where status_active=1 and is_deleted=0", "id", "size_name");
			$color_library=return_library_array( "select id,color_name from lib_color  where status_active=1 and is_deleted=0", "id", "color_name");

	       $sql_collar_cuff= "SELECT a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,b.gmts_color_id,b.size_number_id,b.item_size,b.gmts_qty,
		   b.excess_per,b.qty,b.id,a.job_no,a.rate,a.amount,a.color_size_sensitive, a.fabric_description,a.body_part_type  FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id) and a.body_part_type=40 and b.status_active=1 and b.is_deleted=0   order by a.body_part_id,b.gmts_color_id,b.id  " ;

		   
			
		  


	         $sql_data_collar_cuff=sql_select($sql_collar_cuff);
			 $color_rows=array();
			 foreach($sql_data_collar_cuff as $row)
			 {
				$style=$job_data_arr[$row[csf('job_no')]]['style'];
			
				$color_id[$row[csf('gmts_color_id')]]=$row[csf('gmts_color_id')];
				
				$composition=$row[csf('construction')].",".$row[csf('composition')];
				$strings=$row[csf('item_number_id')]."*".$row[csf('body_part_id')]."*".$row[csf('body_part_type')]."*".$row[csf('fabric_description')]."*".$row[csf('gsm_weight')]."*".$row[csf('color_type_id')]."*".$row[csf('gmts_color_id')];
				
				 $style_wise_data[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['gmts_qty']+=$row[csf('gmts_qty')];
				 $style_wise_data[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['fabric_cost_dtls_id']=$row[csf('fabric_cost_dtls_id')];
				 $style_wise_data[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['color_size_sensitive']=$row[csf('color_size_sensitive')];
				 $style_wise_data[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['qty']+=$row[csf('qty')];
				 $style_wise_data[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
				 $style_wise_data[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['amount']=$row[csf('amount')];
				 $style_wise_data[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['rate']=$booking_collar_cuf_rate[$strings]['rate'];
				 $style_wise_data[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['item_size']=$row[csf('item_size')];
				 $style_wise_data[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['excess_per']=$row[csf('excess_per')];
				 $style_wise_data[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['job_no']=$row[csf('job_no')];


			 }
			 

			//  echo "<pre>";
			//  print_r($job_wise_booking_rate);
			$color_rows=array();
			foreach($style_wise_data as $styleId=>$item_data){
				foreach($item_data as $itemId=>$body_part_data){
				   foreach($body_part_data as $bodyId=>$comp_data){
					  foreach($comp_data as $compId=>$colortype_data){

						foreach($colortype_data as $colortypeId=>$color_data){
						  foreach($color_data as $colorId=>$size_data){
							foreach($size_data as $sizeId=>$row){


									$color_rows[$styleId][$colorId]+=1;
									if($row['excess_per']>0){
									$style_wise_qty[$styleId][$colorId]+=$row['gmts_qty']+(($row['gmts_qty']*$row['excess_per'])/100);
									}else{
										$style_wise_qty[$styleId][$colorId]+=$row['gmts_qty'];
									}
									}
								}
							}
						}
					}
				}
			}
			//  echo "<pre>";
			//  print_r($color_rows);

		?>
		


			<?

	          if(count($sql_data_collar_cuff)>0)

	          {

					?>
			  		<br>
			  		<table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
					  <tr>
						<td colspan="16" align="center">
							<strong>Collar and Cuff Breakdown</strong>
						</td>

					</tr>
			  			<tr>
			  				<td colspan="16" align="center">
			  					<strong>Collar Details</strong>
			  				</td>

			  			</tr>

			  			<tr>
			  				<td align="center"> SL </td>
							<td align="center" width="80">Style </td>
							<td align="center">Gmts Item </td>
							<td align="center">Body Part </td>
			  				<td align="center" width="150">Collar Composition</td>
							<td align="center">GSM </td>
							<td align="center">Color Type </td>			  			
			  				<td align="center"> Fabric  Color  </td>
			  				<td align="center"> Gmts Size</td>
			  				<td align="center"> Item Size  </td>
			  				<td align="center"> Gmts Qty (Pcs)  </td>
			  				<td align="center"> Excess %   </td>
			  				<td align="center"> Collar Qty (Pcs) </td>
							<td align="center">  Rate </td>
							<td align="center"> Amount </td>
			  			</tr>
			  			<?
			  			$p=1;$color_id="";$grand_total_amount=0;
			  			foreach($style_wise_data as $styleId=>$item_data){
						  foreach($item_data as $itemId=>$body_part_data){
							 foreach($body_part_data as $bodyId=>$comp_data){
								foreach($comp_data as $compId=>$colortype_data){									
								  foreach($colortype_data as $colortypeId=>$color_data){									
									foreach($color_data as $colorId=>$size_data){
										$c=1;
									  foreach($size_data as $sizeId=>$row){

			  				?>
			  				<tr>
			  					<td align="center"><? echo $p;?></td>	
								<td align="left" title="<?=$row["job_no"];?>"><? echo $styleId ;?></td>
								<td align="left"><? echo $garments_item[$itemId] ;?></td>
								<td align="left"><? echo $body_part[$bodyId] ;?></td>
			  					<td align="left"> &nbsp;<? echo $compId; ?></td>
								<td align="center"><? echo $row["gsm_weight"] ;?></td>
								<td align="center"><? echo $color_type[$colortypeId] ;?></td>
			  					<td align="center">
								  <?
										if($row['color_size_sensitive']==1 or $row['color_size_sensitive']==2 or $row['color_size_sensitive']==4)
										{
											$gmt_fab_color=$color_library[$colorId];
										}
										else
										{
											$contrast_color_id=return_field_value("b.contrast_color_id as contrast_color_id", "wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b", "a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.job_no in ($all_jobs_id) and a.id=".$row['fabric_cost_dtls_id']."  and b.gmts_color_id=".$colorId." ","contrast_color_id");//pre_cost_fabric_cost_dtls_id
											if($contrast_color_id>0)
											{
												$gmt_fab_color=$color_library[$contrast_color_id];
											}
										}
									echo $gmt_fab_color;  ?>
			  					</td>
			  					<td align="center"><? echo $size_library[$sizeId];  ?></td>
			  					<td align="center"><? echo $row['item_size'];  ?></td>
			  					<td align="right"><? echo $row['gmts_qty']; $total_gmts_qty+=$row['gmts_qty']; ?></td>
			  					<td align="right"><? echo $row['excess_per'];$total_excess_per+=$row['excess_per'];?></td>
			  					<td align="right"><? echo $row['gmts_qty']+(($row['gmts_qty']*$row['excess_per'])/100);   $total_qty+=$row['qty']; ?></td>
								  <?php
								//   $r=1;
								 	if($c==1){					
								  ?>
								<td align="right" rowspan="<?=$color_rows[$styleId][$colorId];?>"><? echo number_format($row['rate'],2);  ?></td>
								<td align="right" rowspan="<?=$color_rows[$styleId][$colorId];?>"><? echo number_format($style_wise_qty[$styleId][$colorId]*$row['rate'],2);;  $sub_total_amount+=$style_wise_qty[$styleId][$colorId]*$row['rate']; 
								$grand_total_amount+=$style_wise_qty[$styleId][$colorId]*$row['rate'];

								?></td>

								<?
								 }
								?>
								
			  				</tr>
			  				<?
			  				$p++;  $r++;  $c++;
							 $sub_total_gmts_qty+=$row['gmts_qty'];
							 $sub_total_collar_qty+=$row['gmts_qty']+(($row['gmts_qty']*$row['excess_per'])/100);
							
							  
			  		      }
					    }
				      }
				    }
				  }
			     }
                }
		    
			  		?>
					    <tr>
			  				<td align="right" colspan="10"><b>Sub Total</b> </td>
			  				<td align="right"><?= $sub_total_gmts_qty;?></td>
			  				<td align="right"></td>
			  				<td align="right"><?=$sub_total_collar_qty;?></td>
							<td align="right"></td>
							<td align="right"><?=number_format($sub_total_amount,2);?> </td>
			  			</tr>

						  <?}?>
					  
			  	</table>
			  <br>

	   <?



				$sql_cuff_data=sql_select( "SELECT a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type,b.gmts_color_id,b.size_number_id,b.item_size,b.gmts_qty,
				b.excess_per,b.qty,b.id,a.job_no,a.rate,a.amount,a.color_size_sensitive,a.fabric_description,a.body_part_type  FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_colar_culff_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no =$txt_booking_no and b.job_no in ($all_jobs_id) and a.body_part_type=50 and b.status_active=1 and b.is_deleted=0   order by a.body_part_id,b.gmts_color_id,b.id  ") ;


				$color_rows=array();
				$strings="";
				foreach($sql_cuff_data as $row)
				{
					$style=$job_data_arr[$row[csf('job_no')]]['style'];
				
					$color_id[$row[csf('gmts_color_id')]]=$row[csf('gmts_color_id')];
					
					$composition=$row[csf('construction')].",".$row[csf('composition')];

					
					$strings=$row[csf('item_number_id')]."*".$row[csf('body_part_id')]."*".$row[csf('body_part_type')]."*".$row[csf('fabric_description')]."*".$row[csf('gsm_weight')]."*".$row[csf('color_type_id')]."*".$row[csf('gmts_color_id')];
					
					$style_wise_data2[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['gmts_qty']+=$row[csf('gmts_qty')];
					$style_wise_data2[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['fabric_cost_dtls_id']=$row[csf('fabric_cost_dtls_id')];
					$style_wise_data2[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['color_size_sensitive']=$row[csf('color_size_sensitive')];
					$style_wise_data2[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['qty']+=$row[csf('qty')];
					$style_wise_data2[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
					$style_wise_data2[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['amount']=$row[csf('amount')];
					$style_wise_data2[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['rate']=$booking_collar_cuf_rate[$strings]['rate'];;
					$style_wise_data2[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['item_size']=$row[csf('item_size')];
					$style_wise_data2[$style][$row[csf('item_number_id')]][$row[csf('body_part_id')]][$composition][$row[csf('color_type_id')]][$row[csf('gmts_color_id')]][$row[csf('size_number_id')]]['excess_per']=$row[csf('excess_per')];


				}
				

				//  echo "<pre>";
				//  print_r($style_wise_data);
				$color_rows2=array();$style_wise_qty2=array();
				foreach($style_wise_data2 as $styleId=>$item_data){
					foreach($item_data as $itemId=>$body_part_data){
						foreach($body_part_data as $bodyId=>$comp_data){
						foreach($comp_data as $compId=>$colortype_data){
							foreach($colortype_data as $colortypeId=>$color_data){
							foreach($color_data as $colorId=>$size_data){
								foreach($size_data as $sizeId=>$row){

										$color_rows2[$styleId][$colorId]+=1;
										
											$style_wise_qty2[$styleId][$colorId]+=$row['qty'];
										
										
										}
									}
								}
							}
						}
					}
				}
	   


			 if(count($sql_cuff_data)>0)

			 {

				   ?>
					 <br>
					 <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

						 <tr>
							 <td colspan="16" align="center">
								 <strong>Cuff Details</strong>
							 </td>
						 </tr>
						 <tr>
						   <td align="center"> SL </td>
						   <td align="center" width="80">Style </td>
						   <td align="center">Gmts Item </td>
						   <td align="center">Body Part </td>
						   <td align="center" width="150">Cuff Composition </td>
						   <td align="center">GSM </td>
						   <td align="center">Color Type </td>						
						   <td align="center"> Fabric  Color  </td>
						   <td align="center"> Gmts Size</td>
						   <td align="center"> Item Size  </td>
						   <td align="center"> Gmts Qty (Pcs)  </td>
						   <td align="center"> Excess %   </td>
						   <td align="center"> Cuff Qty (Pcs) </td>
						   <td align="center">  Rate </td>
						   <td align="center"> Amount </td>
						 </tr>
						 <?
			  			$p=1;$color_id="";$sub_total_gmts_qty=0; $sub_total_collar_qty=0; $sub_total_amount=0;
			  			foreach($style_wise_data2 as $styleId=>$item_data){
						  foreach($item_data as $itemId=>$body_part_data){
							 foreach($body_part_data as $bodyId=>$comp_data){
								foreach($comp_data as $compId=>$colortype_data){									
								  foreach($colortype_data as $colortypeId=>$color_data){									
									foreach($color_data as $colorId=>$size_data){
										$c=1;
									  foreach($size_data as $sizeId=>$row){

			  				?>
								<tr>
									<td align="center"><? echo $p;?></td>
									<td align="left"><? echo $styleId ;?></td>
									<td align="left"><? echo $garments_item[$itemId] ;?></td>
									<td align="left"><? echo $body_part[$bodyId] ;?></td>
									<td align="left"><? echo $compId; ?></td>
									<td align="center"><? echo $row["gsm_weight"] ;?></td>
									<td align="center">	<? echo $color_type[$colortypeId] ;?></td>
									<td align="center">
									<?
											if($row['color_size_sensitive']==1 or $row['color_size_sensitive']==2 or $row['color_size_sensitive']==4)
											{
												$gmt_fab_color=$color_library[$colorId];
											}
											else
											{
												$contrast_color_id=return_field_value("b.contrast_color_id as contrast_color_id", "wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b", "a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.job_no in ($all_jobs_id) and a.id=".$row['fabric_cost_dtls_id']."  and b.gmts_color_id=".$colorId." ","contrast_color_id");//pre_cost_fabric_cost_dtls_id
												if($contrast_color_id>0)
												{
													$gmt_fab_color=$color_library[$contrast_color_id];
												}
											}
										echo $gmt_fab_color;  ?>
									</td>
									<td align="center"><? echo $size_library[$sizeId];  ?></td>
									<td align="center"><? echo $row['item_size'];  ?></td>
									<td align="right"><? echo $row['gmts_qty'];	$total_gmts_qty+=$row['gmts_qty'];?></td>
									<td align="right"><? echo $row['excess_per']; $total_excess_per+=$row['excess_per'];?></td>
									<td align="right"><? echo $row['qty'];    ?></td>
									<?php
									//   $r=1;
									if($c==1){					
									?>
										<td align="right" rowspan="<?=$color_rows2[$styleId][$colorId];?>"><? echo number_format($row['rate'],2);  ?></td>
										<td align="right" rowspan="<?=$color_rows2[$styleId][$colorId];?>"><? echo number_format($style_wise_qty2[$styleId][$colorId]*$row['rate'],2);; $sub_total_amount+=$style_wise_qty2[$styleId][$colorId]*$row['rate']; 
										$grand_total_amount+=$style_wise_qty2[$styleId][$colorId]*$row['rate'];;					
										?>
										</td>

									<?
									}
									?>
									
								</tr>
			  				<?
			  				$p++;  $r++; $c++;
							 
							  $sub_total_gmts_qty+=$row['gmts_qty'];
							  $sub_total_cuff_qty+=$row['qty'];
			  		      }
					    }
				      }
				    }
				  }
			     }
                }
				?>
				<tr>
					<td align="right" colspan="10"><b>Sub Total</b> </td>
					<td align="right"><?= $sub_total_gmts_qty;?></td>
					<td align="right"></td>
					<td align="right"><?=$sub_total_cuff_qty;?></td>
					<td align="right"></td>
					<td align="right"><?=number_format($sub_total_amount,2);;?></td>
				</tr>
				<?
		    }

				if(count($style_wise_data)>0 || count($style_wise_data2)>0){

				
			  		?>
				
				<tr>
					<td align="right" colspan="14"><b>Grand Total</b> </td>				
					<td align="right"><?=number_format($grand_total_amount,2);;?></td>
				</tr>
				<?}
				?>
			 
		  </table>
			<br>



    <div style="width:930"><?=get_spacial_instruction($txt_booking_no); ?></div>
    <br>
    <div style="width:930px" align="center">
        <table class="rpt_table" width="100%" border="1" cellpadding="0" cellspacing="0" rules="all" >
        	<thead>
            	<th width="300">Shipping Marks [One Side]</th>
                <th width="200" colspan="2">Shipping Marks [Other Side]</th>
                <th width="200" colspan="2">Order Issued By</th>
                <th>Special Instruction /Remarks</th>
            </thead>
            <tbody>
            	<tr>
                    <td style="word-break:break-all" rowspan="6"><?=$shippingmark_str; ?></td>
                    <td align="center">Customer Name :</td>
                    <td align="center"><?=$buyer_name_arr[$buyer_id]; ?></td>
                    <td align="center" style="word-break:break-all"><?=$team_names; ?></td>
                    <td align="center" style="word-break:break-all"><?=$team_emails; ?></td>
                    <td align="center" style="word-break:break-all" rowspan="6"><?=$mstremarks; ?></td>
                </tr>
                <tr>
                    <td align="center">Four H Order :</td>
                    <td align="center"><?=$txt_booking_no; ?></td>
                    <td align="center" style="word-break:break-all"><?=$team_leaders; ?></td>
                    <td align="center" style="word-break:break-all"><?=$team_leader_emails; ?></td>
                </tr>
                <tr>
                    <td align="center">Quantity :</td>
                    <td align="center"><?=number_format($gfinQty,2); ?></td>
                    <td align="center" style="word-break:break-all"><?=$dealing_marchants; ?></td>
                    <td align="center" style="word-break:break-all"><?=$team_member_emails; ?></td>
                </tr>
                <tr>
                    <td align="center">&nbsp;</td>
                    <td align="center">&nbsp;</td>
                    <td align="center" style="word-break:break-all">&nbsp;</td>
                    <td align="center" style="word-break:break-all">&nbsp;</td>
                </tr>
                <tr>
                    <td align="center">&nbsp;</td>
                    <td align="center">&nbsp;</td>
                    <td align="center" style="word-break:break-all">&nbsp;</td>
                    <td align="center" style="word-break:break-all">&nbsp;</td>
                </tr>
                <tr>
                    <td align="center">&nbsp;</td>
                    <td align="center">&nbsp;</td>
                    <td align="center" style="word-break:break-all">&nbsp;</td>
                    <td align="center" style="word-break:break-all">&nbsp;</td>
                </tr>
            </tbody>
        </table>
	<div>
    <?=signature_table(121, $cbo_company_name, "930px"); 
			
	$html = ob_get_contents();
	ob_clean();
	list($is_mail_send,$mail)=explode('___',$mail_send_data);

	if($is_mail_send==1){
		require_once('../../../mailer/class.phpmailer.php');
		require_once('../../../auto_mail/setting/mail_setting.php');
		$mailBody = preg_replace("/<img[^>]+\>/i", " ", $html); 
		$mailBody="<br>".$mail_body	;
		$mailToArr=array();
		$mailSql = "select b.EMAIL  from wo_booking_mst a,LIB_SUPPLIER b where b.id=a.supplier_id and a.booking_no=$txt_booking_no";
	//echo $mailSql;die;
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
		}
		
		
		$mailSql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=99 and b.mail_user_setup_id=c.id  and c.IS_DELETED=0 and c.STATUS_ACTIVE=1";
		//echo $mailSql;die;
		$mailSqlRes=sql_select($mailSql);
		foreach($mailSqlRes as $rows){
			if($rows[EMAIL]){$mailToArr[]=$rows[EMAIL];}
		}
		if($mail!=''){$mailToArr[]=$mail;}

		$to=implode(',',$mailToArr);
		$subject="Partial fabric booking";
		$header=mailHeader();
		echo $to;
		echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );
		
	}
	else{
		echo $html;
	}
	exit();
}

if($action=="dtm_popup")
{
	echo load_html_head_contents("DTM Search","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	$color_library=return_library_array( "select id,color_name from lib_color ", "id", "color_name");
	?>
<script>

function trims_popup(page_link,title,i)
{
	//var job_no=$('#txt_job_no').val();
	var booking_no=$('#txt_booking_no').val();
	//var selected_no=$('#txt_order_no_id').val();
	var selected_no=$('#poid_'+i).val();
	var job_no=$('#jobno_'+i).val();
	var fabric=$('#fabric_'+i).val();
	var color=$('#color_'+i).val();
	var fabric_cost_id=$('#fabric_cost_id_'+i).val();


	if(booking_no=='')
	{
		alert('Booking  Not Found.');
		$('#txt_booking_no').focus();
		return;
	}

	page_link=page_link+'&job_no='+job_no+'&booking_no='+booking_no+'&selected_no='+selected_no+'&fabric='+fabric+'&color='+color+'&fabric_cost_id='+fabric_cost_id+'&index='+i;
	emailwindow=dhtmlmodal.open('EmailBox', 'iframe', page_link, title, 'width=800px,height=300px,center=1,resize=1,scrolling=0','../../')

}
</script>
<?
$dtm_arr=array();
$sql=sql_select("select pre_cost_fabric_cost_id,fabric_color,sum(qty) as qty  from wo_dye_to_match where booking_no='$booking_no' and status_active=1 and is_deleted=0 group by pre_cost_fabric_cost_id,fabric_color");
foreach($sql as $row){
	$dtm_arr[$row[csf('pre_cost_fabric_cost_id')]][$row[csf('fabric_color')]]=$row[csf('qty')];
}


$trims_matches_sql=sql_select("SELECT a.id, a.body_part_id, a.composition, a.construction, a.gsm_weight, d.fabric_color_id, d.gmts_color_id, min(c.id) as cid, sum(d.fin_fab_qnty) as fin_fab_qnty, sum(d.grey_fab_qnty) as grey_fab_qnty, d.job_no, d.po_break_down_id FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and  b.po_break_down_id=d.po_break_down_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no ='$booking_no' and d.status_active=1 and  c.status_active=1  and a.status_active=1 and d.is_deleted=0 group by a.id, a.body_part_id, a.composition, a.construction, a.gsm_weight, d.fabric_color_id , d.gmts_color_id, d.job_no, d.po_break_down_id order by a.id, cid ");
?>



</head>
<body>
<div align="center" style="width:100%;" >
<input type="hidden" id="txt_job_no" name="txt_job_no" value="<? echo $job_no;  ?>"/>
<input type="hidden" id="txt_booking_no" name="txt_booking_no" value="<? echo $booking_no;  ?>"/>
<input type="hidden" id="txt_order_no_id" name="txt_order_no_id" value="<? echo $selected_no;  ?>"/>
	<table width="800" cellspacing="0" class="rpt_table" border="0" id="tbl_trims_dyes_match1" rules="all">
	<thead>
	  <tr>
		<th width="40">S/L</th>
		<th width="60">Job NO</th>
		<th width="300">Fabric Driscription</th>
		<th width="90">Color</th>
		<th width="100">Fabric Qnty.</th>
		<th width="100">Trims</th>
	  </tr>
	</thead>
	<tbody>
	<?

	$i=1;
	foreach($trims_matches_sql as $row)
	 {
	 ?>
	  <tr>
	  	<td width="40"><? echo $i; ?></td>
	  	<td width="60">
			<? echo $row[csf('job_no')]; ?>
			<input type="hidden" id="jobno_<?= $i ?>" value="<?= $row[csf('job_no')]  ?>" >
			<input type="hidden" id="poid_<?= $i ?>" value="<?= $row[csf('po_break_down_id')]  ?>" >
		</td>
	  	<td width="300">
        <input class="text_boxes" type="text" style="width:300px;"  name="fabric_<? echo $i; ?>" id="fabric_<? echo $i; ?>" value="<? echo $body_part[$row[csf('body_part_id')]].",".$row[csf('construction')].",".$row[csf('composition')].",".$row[csf('gsm_weight')];?>" readonly/>
         <input class="text_boxes" type="hidden" style="width:300px;"  name="fabric_cost_id_<? echo $i; ?>" id="fabric_cost_id_<? echo $i; ?>" value="<? echo $row[csf('id')];?>" readonly/>
        </td>
	  	<td width="90">
        <? echo $color_library[$row[csf('fabric_color_id')]];?>
        <input class="text_boxes" type="hidden" style="width:150px;"  name="color_<? echo $i; ?>" id="color_<? echo $i; ?>" value="<? echo $row[csf('gmts_color_id')];?>" readonly/>
        </td>
	  	<td width="100" align="right">
		<? echo number_format($row[csf('fin_fab_qnty')],4);?>
        </td>
	  	<td width="100"><input class="text_boxes" type="text" style="width:100px;"  name="trims_<? echo $i; ?>" id="trims_<? echo $i; ?>" value="<? echo $dtm_arr[$row[csf('id')]][$row[csf('fabric_color_id')]] ?>" onDblClick="trims_popup('partial_fabric_booking_controller.php?action=trims_popup','Trims Item',<? echo $i ?>)" readonly/></td>
	  </tr>
	  <? $i++;

	  } ?>
	</tbody>
	</table>
</div>
</body>
<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
</html>
<?
exit();
}

if($action=="trims_popup")
{
	echo load_html_head_contents("DTM Search","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
<script>
function fnc_fabric_dye_to_match( operation )
{

	var job_no=$('#txt_job_no').val();
	var booking_no=$('#txt_booking_no').val();
	var selected_no=$('#txt_order_no_id').val();
	var fabric=$('#fabric').val();
	var color=$('#color').val();
	var fabric_cost_id=$('#fabric_cost_id').val();
	var index=$('#index').val();

	    var row_num=$('#tbl_trims_dyes_match tbody tr').length;
		var data_all="";
		for (var i=1; i<=row_num; i++)
		{

			data_all=data_all+get_submitted_data_string('trim_group_'+i+'*pre_cost_trim_cost_id_'+i+'*dyeqty_'+i+'*color_'+i,"../../../",i);

		}
		//alert(data_all);
		var data="action=save_update_delete_dye_to_match&operation="+operation+'&total_row='+row_num+data_all+'&booking_no='+booking_no+'&fabric='+fabric+'&color='+color+'&fabric_cost_id='+fabric_cost_id;
		freeze_window(operation);
		http.open("POST","fabric_booking_urmi_controller.php",true);
		http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
		http.send(data);
		http.onreadystatechange = fnc_fabric_booking_terms_condition_reponse;
}

function fnc_fabric_booking_terms_condition_reponse()
{

	if(http.readyState == 4)
	{
	        var reponse=trim(http.responseText).split('**');
			 if(trim(reponse[0])=='approved')
			 {
				 alert("This booking is approved");
				 release_freezing();
				 return;
			 }

			if(trim(reponse[0])=='papproved'){
				alert("This booking is Partial approved");
				release_freezing();
				return;
			}

			if (reponse[0].length>2) reponse[0]=10;
			release_freezing();
			if(reponse[0]==0 || reponse[0]==1)
			{
				var index=$('#index').val();
				parent.document.getElementById('trims_'+index).value=reponse[1];
				parent.emailwindow.hide();
			}
	}
}
</script>
<?
$lib_item_group_arr=return_library_array( "select item_name, id from lib_item_group where item_category=4 and is_deleted=0  and  status_active=1 order by item_name", "id", "item_name");
$color_library=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");

$dtm_arr=array();
$dtm_arr_item_color=array();
$sql=sql_select("select pre_cost_fabric_cost_id,fabric_color,precost_trim_cost_id,item_color,sum(qty) as qty from wo_dye_to_match where booking_no='$booking_no' and pre_cost_fabric_cost_id='$fabric_cost_id' and status_active=1 and is_deleted=0 group by pre_cost_fabric_cost_id,fabric_color,item_color,precost_trim_cost_id");

foreach($sql as $row){
	$dtm_arr[$row[csf('pre_cost_fabric_cost_id')]][$row[csf('fabric_color')]][$row[csf('precost_trim_cost_id')]]=$row[csf('qty')];
	$dtm_arr_item_color[$row[csf('pre_cost_fabric_cost_id')]][$row[csf('fabric_color')]][$row[csf('precost_trim_cost_id')]]=$row[csf('item_color')];
}
$trims_matches_sql=sql_select("select a.id,a.job_no,a.trim_group,a.description,a.cons_uom FROM wo_pre_cost_trim_cost_dtls a, wo_pre_cost_trim_co_cons_dtls b,  wo_booking_dtls c WHERE a.job_no=b.job_no and a.job_no=c.job_no and a.id=b.wo_pre_cost_trim_cost_dtls_id and b.po_break_down_id=c.po_break_down_id and c.booking_no ='$booking_no' and b.po_break_down_id in($selected_no) and a.status_active=1 and a.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by a.id,a.job_no,a.trim_group,a.description,a.cons_uom");

	$condition= new condition();
	if(str_replace("'","",$job_no) !=''){
	$condition->job_no("='$job_no'");
	}
	if(str_replace("'","",$selected_no) !=''){
		$condition->po_id("in($selected_no)");
	}
	$condition->init();
	$trim= new trims($condition);
	//echo $trim->getQuery();
	$totalqtyarray_arr=$trim->getQtyArray_by_jobAndPrecostdtlsid();
	$totalqtyarray_arr2=$trim->getQtyArray_by_jobItemidDescriptionGmtcolorAndSizeid();
?>
</head>
<body>
<div align="center" style="width:100%;" >
 <? echo load_freeze_divs ("../../../",$permission);  ?>
<fieldset>
<form id="dtm_1">
<input type="hidden" id="txt_job_no" name="txt_job_no" value="<? echo $job_no;  ?>"/>
<input type="hidden" id="txt_booking_no" name="txt_booking_no" value="<? echo $booking_no;  ?>"/>
<input type="hidden" id="txt_order_no_id" name="txt_order_no_id" value="<? echo $selected_no;  ?>"/>
<input type="hidden" id="fabric" name="txt_order_no_id" value="<? echo $fabric;  ?>"/>
<input type="hidden" id="color" name="color" value="<? echo $color;  ?>"/>
<input type="hidden" id="fabric_cost_id" name="fabric_cost_id" value="<? echo $fabric_cost_id;  ?>"/>
<input type="hidden" id="index" name="index" value="<? echo $index;  ?>"/>
	<table width="700" cellspacing="0" class="rpt_table" border="0" id="tbl_trims_dyes_match" rules="all">
	<thead>
	  <tr>
		<th width="40">S/L</th>
		<th width="150">Item Group</th>
		<th width="150">Item Color</th>
        <th width="150">Item Driscription</th>
		<th width="100">Req. Qty.</th>
		<th width="60">Uom</th>
        <th width="60">Dye Qnty</th>
	  </tr>
	</thead>
	<tbody>
	<?

	$i=1;
	foreach($trims_matches_sql as $row)
	 {
	 $item_color=$dtm_arr_item_color[$fabric_cost_id][$color][$row[csf('id')]];
	 if(empty($item_color)){
		 $item_color=$color;
	 }
	 $qnty=array_sum($totalqtyarray_arr2[$row[csf('job_no')]][$row[csf('trim_group')]][$row[csf('description')]][$item_color]);
	 ?>
	  <tr>
	  	<td width="40"><? echo $i; ?></td>
	  	<td width="150">
        <? echo $lib_item_group_arr[$row[csf('trim_group')]];?>
        <input class="text_boxes" type="hidden" style="width:150px;"  name="trim_group_<? echo $i; ?>" id="trim_group_<? echo $i; ?>" value="<? echo $row[csf('trim_group')];?>" readonly/>
         <input class="text_boxes" type="hidden" style="width:150px;"  name="pre_cost_trim_cost_id_<? echo $i; ?>" id="pre_cost_trim_cost_id_<? echo $i; ?>" value="<? echo $row[csf('id')];?>" readonly/>
        </td>
	  	<td width="150">
        <? //echo $color_library[$color];?>
        <input class="text_boxes" type="text" style="width:150px;"  name="color_<? echo $i; ?>" id="color_<? echo $i; ?>" value="<? echo $color_library[$item_color];?>"/>
        </td>
	  	<td width="120">
		<? echo $row[csf('description')];?>
        </td>
	  	<td width="100" title="Job and trim item wise=<?=$totalqtyarray_arr[$row[csf('job_no')]][$row[csf('id')]]?>">
        <input class="text_boxes_numeric" type="text" style="width:100px;"  name="reqqty_<? echo $i; ?>" id="reqqty_<? echo $i; ?>" value="<? echo $qnty;//$totalqtyarray_arr[$row[csf('job_no')]][$row[csf('id')]]; ?>" readonly/>
        </td>
        <td width="60">
        <input class="text_boxes" type="text" style="width:60px;"  name="uom_<? echo $i; ?>" id="uom_<? echo $i; ?>" value="<? echo $unit_of_measurement[$row[csf('cons_uom')]]; ?>" readonly/>
        </td>
        <td width="60">
        <input class="text_boxes_numeric" type="text" style="width:60px;"  name="dyeqty_<? echo $i; ?>" id="dyeqty_<? echo $i; ?>" value="<? echo $dtm_arr[$fabric_cost_id][$color][$row[csf('id')]] ?>"/>
        </td>
	  </tr>
	  <? $i++;

	  } ?>
	</tbody>
	</table>
    </form>
    <table width="650" cellspacing="0" class="" border="0">
        <tr>
            <td align="center" width="100%" class="button_container">
            <?
            echo load_submit_buttons( $permission, "fnc_fabric_dye_to_match", 0,0 ,"reset_form('dtm_1','','','','')",1) ;
            ?>
            </td>
        </tr>
    </table>
    </fieldset>
</div>
</body>
<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
</html>
<?
exit();
}
if($action=="save_update_delete_dye_to_match")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	if ($operation==0)
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		$booking_id=return_field_value( "id", "wo_booking_mst","booking_no ='$booking_no'");

		$is_approved=0;
		$sql=sql_select("select is_approved from wo_booking_mst where booking_no='$booking_no'");
		 foreach($sql as $row){
           // if($row[csf('is_approved')]==3) $is_approved=1; else $is_approved=$row[csf('is_approved')];
		    $is_approved=$row[csf('is_approved')];
        }
        if($is_approved==1) { echo "approved**".str_replace("'","",$txt_booking_no); disconnect($con);die; }
		else if($is_approved==3) { echo "papproved**".str_replace("'","",$txt_booking_no); disconnect($con);die; }

		if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0"; disconnect($con);die;}
		$id=return_next_id( "id", "wo_dye_to_match", 1 ) ;
		$field_array="id,booking_id,booking_no,pre_cost_fabric_cost_id,fabric_color,item_color,precost_trim_cost_id,item_group,qty";//,status_active,is_deleted
		$total_dye_qty=0;
		$new_array_color=array();
		for ($i=1;$i<=$total_row;$i++)
		{
			$trim_group="trim_group_".$i;
			$pre_cost_trim_cost_id="pre_cost_trim_cost_id_".$i;
			$dyeqty="dyeqty_".$i;
			$item_color="color_".$i;
			
			if(str_replace("'","",$$item_color)!="")
			{
				if (!in_array(str_replace("'","",$$item_color),$new_array_color)){
					$color_id = return_id( str_replace("'","",$$item_color), $color_library, "lib_color", "id,color_name","118");
					$new_array_color[$color_id]=str_replace("'","",$$item_color);
				}
				else $color_id =  array_search(str_replace("'","",$$item_color), $new_array_color);
			}
			else $color_id=0;
			
			if ($i!=1) $data_array .=",";
			$data_array .="(".$id.",".$booking_id.",'".$booking_no."','".$fabric_cost_id."','".$color."','".$color_id."',".$$pre_cost_trim_cost_id.",".$$trim_group.",".$$dyeqty.")";
			$total_dye_qty+=str_replace("'"," ",$$dyeqty);
			$id=$id+1;
		}
		//echo "10**insert into wo_dye_to_match (".$field_array.") values ".$data_array;die;
		$rID_de3=execute_query( "delete from wo_dye_to_match where  pre_cost_fabric_cost_id ='".$fabric_cost_id."' and fabric_color= '".$color."'",0);
		$rID=sql_insert("wo_dye_to_match",$field_array,$data_array,1);
		check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID && $rID_de3){
			mysql_query("COMMIT");
			echo "0**".$total_dye_qty;
			}
			else{
			mysql_query("ROLLBACK");
			echo "10**".$total_dye_qty;
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID && $rID_de3){
			oci_commit($con);
			echo "0**".$total_dye_qty;
			}
			else{
			oci_rollback($con);
			echo "10**".$total_dye_qty;
			}
		}
		disconnect($con);
		die;
	}
}
?>