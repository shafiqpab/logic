<?
/*-------------------------------------------- Comments
Version                  :  V1
Purpose			         : 	This form will create Short Fabric Booking
Functionality	         :
JS Functions	         :
Created by		         :	Monzu
Creation date 	         : 	27-12-2012
Requirment Client        :
Requirment By            :
Requirment type          :
Requirment               :
Affected page            :
Affected Code            :
DB Script                :
Updated by 		         : 	Aziz	(Print Button Report Setting)
Update date		         : 	16-5-15
QC Performed BY	         :
QC Date			         :
Comments		         :  From this version oracle conversion is start
*/
header('Content-type:text/html; charset=utf-8');
session_start();
if( $_SESSION['logic_erp']['user_id'] == "" ) header("location:login.php");
include('../../../includes/common.php');
include('../../../includes/class4/class.conditions.php');
include('../../../includes/class4/class.reports.php');
//include('../../../includes/class4/class.fabrics.php');
include('../../../includes/class4/class.yarns.php');
include('../../../includes/class4/class.fabrics.php');
$data=$_REQUEST['data'];
$action=$_REQUEST['action'];
$permission=$_SESSION['page_permission'];
$user_id=$_SESSION['logic_erp']['user_id'];
$buyer_cond=set_user_lavel_filtering(' and buy.id','buyer_id');
$company_cond=set_user_lavel_filtering(' and comp.id','company_id');

//---------------------------------------------------- Start---------------------------------------------------------------------------
$size_library=return_library_array( "select id,size_name from lib_size where status_active =1 and is_deleted=0", "id", "size_name");
$company_library=return_library_array( "select id,company_name from lib_company", "id", "company_name");

if ($action=="load_drop_down_buyer")
{
	echo create_drop_down( "cbo_buyer_name", 130,"select buy.id,buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active =1 and buy.is_deleted=0 and b.buyer_id=buy.id and b.tag_company='$data' $buyer_cond and buy.id in (select  buyer_id from  lib_buyer_party_type where party_type in (1,3,21,90))  order by buyer_name","id,buyer_name", 1, "-- Select Buyer --", $selected, "","1","" );
	exit();
}

if ($action=="load_drop_down_suplier")
{
	if($data==5 || $data==3){
	   echo create_drop_down( "cbo_supplier_name", 130, "select id,company_name from lib_company where status_active=1 and is_deleted=0 order by company_name", "id,company_name",1, "-- Select Supplier --", "", "validate_suplier();get_php_form_data( this.value+'_'+document.getElementById('cbo_pay_mode').value, 'load_drop_down_attention', 'requires/short_fabric_booking_controller');load_drop_down( 'requires/short_fabric_booking_controller',this.value+'_'+document.getElementById('cbo_pay_mode').value, 'load_drop_down_location', 'sup_location_td' )",0,"" );
	}
	else{
	   echo create_drop_down( "cbo_supplier_name", 130, "select id,supplier_name from lib_supplier where status_active =1 and is_deleted=0 order by supplier_name","id,supplier_name", 1, "-- Select Supplier --", $selected, "get_php_form_data( this.value+'_'+document.getElementById('cbo_pay_mode').value, 'load_drop_down_attention', 'requires/short_fabric_booking_controller');load_drop_down( 'requires/short_fabric_booking_controller',this.value+'_'+document.getElementById('cbo_pay_mode').value, 'load_drop_down_location', 'sup_location_td' )",0 );

	}
	exit();
}

if ($action=="load_drop_down_short_provider")
{
	if($data==5 || $data==3){
	   echo create_drop_down( "cbo_provider_name", 130, "select id,company_name from lib_company where status_active=1 and is_deleted=0 order by company_name", "id,company_name",1, "-- Select Supplier --", "", "validate_suplier();get_php_form_data( this.value+'_'+document.getElementById('cbo_pay_mode').value, 'load_drop_down_attention', 'requires/short_fabric_booking_controller');load_drop_down( 'requires/short_fabric_booking_controller',this.value+'_'+document.getElementById('cbo_pay_mode').value, 'load_drop_down_location', 'sup_location_td' )",0,"" );
	}
	else{
	   echo create_drop_down( "cbo_provider_name", 130, "select id,supplier_name from lib_supplier where status_active =1 and is_deleted=0 order by supplier_name","id,supplier_name", 1, "-- Select Supplier --", $selected, "get_php_form_data( this.value+'_'+document.getElementById('cbo_pay_mode').value, 'load_drop_down_attention', 'requires/short_fabric_booking_controller');load_drop_down( 'requires/short_fabric_booking_controller',this.value+'_'+document.getElementById('cbo_pay_mode').value, 'load_drop_down_location', 'sup_location_td' )",0 );

	}
	exit();
}

if ($action=="load_drop_down_location")
{
	$data=explode("_",$data);
	if($data[1]==5 || $data[1]==3)
	{
		echo create_drop_down( "cbo_supplier_location", 130, "select id,location_name from lib_location where status_active =1 and is_deleted=0 and company_id=$data[0] order by location_name","id,location_name", 1, "-- Select Supp Location --", $selected, "","" );
	}
	else
	{
		echo create_drop_down( "cbo_supplier_location", 130, $blank_array,"", 1, "-- Select Supp Location --", "", "","" );
	}
	exit();
}

if($action=="load_drop_down_attention")
{
	$data=explode("_",$data);
	$supplier=$data[0];
	$paymode=$data[1];
	$supplier_name=return_field_value("contact_person","lib_supplier","id ='".$supplier."' and is_deleted=0 and status_active=1");
	if($paymode==1 || $paymode==2)
	{
		echo "document.getElementById('txt_attention').value = '".$supplier_name."';\n";
	}
	else
	{
		echo "document.getElementById('txt_attention').value = '';\n";
	}
	exit();
}

if ($action=="load_drop_down_po_number")
{
	echo create_drop_down( "cbo_order_id",130, "select id, po_number from wo_po_break_down where id in ($data) and status_active=1 and is_deleted=0","id,po_number", 1, "--Select--", $selected, "load_drop_down( 'requires/short_fabric_booking_controller', this.value+'_'+$('#cbo_fabric_natu').val()+'_'+$('#cbo_fabric_source').val()+'_'+$('#cbouom').val(), 'load_drop_down_fabric_description', 'fabricdescription_id_td');","",$data,"","","","" );
	exit();
}
if ($action == "load_drop_down_department")
{
	echo create_drop_down("cbo_department", 130, "select id,department_name from lib_department where STATUS_ACTIVE=1 and DIVISION_ID in(select id from LIB_DIVISION where STATUS_ACTIVE=1 and COMPANY_ID=$data) ", "id,department_name", 1, "-- Select Department --", $selected, 0, 1);
	exit();
}


if ($action == "load_drop_down_profit_center")
{
   // list($data,$width)=explode('***',$data); 
	echo create_drop_down("cbo_profit_center", 130, "select id,profit_center_name from  lib_profit_center where company_id=$data", "id,profit_center_name", 1, "-- Select Profit Center --", $selected, 0, 1);
	exit();
}

if ($action=="load_drop_down_fabric_description")
{
	$data=explode("_",$data);
	$txt_order_no_id=$data[0];
	$cbo_fabric_natu=$data[1];
	$cbo_fabric_source=$data[2];
	$cbouom=$data[3];
	if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
	if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
	if ($cbouom!=0) $cbouom_cond="and a.uom='$cbouom'";
	
	if($cbo_fabric_source==4){
		$nameArray=sql_select( "select a.id as pre_cost_fabric_cost_dtls_id, a.body_part_id, a.color_type_id, a.gsm_weight, a.construction, a.composition FROM wo_pre_cost_fabric_cost_dtls a, wo_po_break_down b, wo_pre_cos_fab_co_avg_con_dtls c WHERE a.job_no=b.job_no_mst and a.id=c.pre_cost_fabric_cost_dtls_id and b.id=c.po_break_down_id and b.id in (".$txt_order_no_id.") and c.cons>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0  and c.status_active=1 and c.is_deleted=0  $cbo_fabric_natu $cbouom_cond group by a.id, a.body_part_id, a.color_type_id, a.gsm_weight, a.construction, a.composition order by a.id");
	}
	else{
		$nameArray=sql_select( "select a.id as pre_cost_fabric_cost_dtls_id, a.body_part_id, a.color_type_id, a.gsm_weight, a.construction, a.composition FROM wo_pre_cost_fabric_cost_dtls a, wo_po_break_down b, wo_pre_cos_fab_co_avg_con_dtls c WHERE a.job_no=b.job_no_mst and a.id=c.pre_cost_fabric_cost_dtls_id and b.id=c.po_break_down_id and b.id in (".$txt_order_no_id.") and c.cons>0 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0  and c.status_active=1 and c.is_deleted=0  $cbo_fabric_natu $cbo_fabric_source_cond $cbouom_cond group by a.id, a.body_part_id, a.color_type_id, a.gsm_weight, a.construction, a.composition order by a.id");
	}
	
	$fabric_description_array= array();
	if (count($nameArray)>0 )
	{
		foreach ($nameArray as $result)
		{
			$fabric_description_array[$result[csf("pre_cost_fabric_cost_dtls_id")]]=$body_part[$result[csf("body_part_id")]].', '.$color_type[$result[csf("color_type_id")]].', '.$result[csf("construction")].', '.$result[csf("composition")].', '.$result[csf("gsm_weight")];
	
			
		}
	}
	echo create_drop_down( "cbo_fabricdescription_id", 360, $fabric_description_array,"", 1, "--Select--", "", "load_drop_down( 'requires/short_fabric_booking_controller', $('#cbo_order_id').val()+'_'+this.value, 'load_drop_down_gmts_color', 'garmentscolor_id_id_td'); set_process_loss( this.value);	get_php_form_data( this.value, 'populate_rate_data', 'requires/short_fabric_booking_controller' );","","","","","","" );
	exit();
}

if ($action=="populate_rate_data")
{
	$rate=return_field_value("rate", "wo_pre_cost_fabric_cost_dtls","id='$data' and status_active =1 and is_deleted=0");
	//echo $data;
	echo "document.getElementById('txt_rate').value = '".$rate."';\n";
	exit();
}

if ($action=="load_drop_down_gmts_color")
{
	$data=explode("_",$data);
	$txt_order_no_id=$data[0];
	$fabric_data=$data[1];
	$color_library_order=return_library_array( "select a.id, a.color_name from lib_color a, wo_pre_cos_fab_co_avg_con_dtls b where a.id=b.color_number_id and b.po_break_down_id in (".$txt_order_no_id.") and b.pre_cost_fabric_cost_dtls_id='$fabric_data' and b.cons>0 and b.status_active=1 and b.is_deleted=0 group by a.id, a.color_name", "id", "color_name");
	echo create_drop_down( "cbo_garmentscolor_id", 130, $color_library_order,"", 1, "-- Select Color --", $selected, "load_drop_down( 'requires/short_fabric_booking_controller', $('#cbo_order_id').val()+'_'+$('#cbo_fabricdescription_id').val()+'_'+this.value, 'load_drop_down_fabric_color', 'fabriccolor_id_id_td'); load_drop_down( 'requires/short_fabric_booking_controller', $('#cbo_order_id').val()+'_'+$('#cbo_fabricdescription_id').val()+'_'+this.value, 'load_drop_down_gmts_size', 'garmentssize_id_td'); load_drop_down( 'requires/short_fabric_booking_controller', $('#cbo_order_id').val()+'_'+$('#cbo_fabricdescription_id').val()+'_'+this.value, 'load_drop_down_item_size', 'itemsize_id_td');" );
	exit();
}

if ($action=="load_drop_down_fabric_color")
{
	$color_library=return_library_array( "select id,color_name from lib_color where status_active =1 and is_deleted=0", "id", "color_name");
	$data=explode("_",$data);
	$txt_order_no_id=$data[0];
	$fabric_id=$data[1];
	$gmts_color=$data[2];

	$nameArray=sql_select("select a.id as pre_cost_fabric_cost_dtls_id, a.color_size_sensitive, a.color, a.color_break_down, b.color_number_id FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.po_break_down_id in (".$txt_order_no_id.")  and a.id='$fabric_id' and b.cons>0 and a.status_active=1 and a.is_deleted=0 group by a.id, a.color_size_sensitive, a.color, a.color_break_down, b.color_number_id order by a.id");
	
	$contrast_color=sql_select("select a.id as fab_dtls_id, b.contrast_color_id, b.gmts_color_id from wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_color_dtls b where a.id=b.pre_cost_fabric_cost_dtls_id and a.id='$fabric_id' and b.gmts_color_id='$gmts_color'");
	//and b.po_break_down_id in (".$txt_order_no_id.")
	foreach ($contrast_color as $row)
	{
		$fab_contrast_color_arr[$row[csf("fab_dtls_id")]][$row[csf("gmts_color_id")]]=$row[csf("contrast_color_id")];
	}
	unset($contrast_color);
	
	$fabric_color_array= array();
	if (count($nameArray)>0 )
	{
		foreach ($nameArray as $result)
		{
			$constrast_color_arr=array();
			if($result[csf("color_size_sensitive")]==3)
			{
				$constrast_color=explode('__',$result[csf("color_break_down")]);
				for($i=0;$i<count($constrast_color);$i++)
				{
					$constrast_color2=explode('_',$constrast_color[$i]);
					$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
					
				}
			}

			$color_id="";
			if($result[csf("color_size_sensitive")]==3)
			{
				$color_id=$fab_contrast_color_arr[$result[csf('pre_cost_fabric_cost_dtls_id')]][$result[csf('color_number_id')]];
				$fabric_color_array[$color_id]=$constrast_color_arr[$result[csf("color_number_id")]];
			}
			else if($result[csf("color_size_sensitive")]==0)
			{
				$fabric_color_array[$result[csf("color")]]=$color_library[$result[csf("color")]];
			}
			else
			{
				$fabric_color_array[$result[csf("color_number_id")]]=$color_library[$result[csf("color_number_id")]];
			}
		}
	}
	
	echo create_drop_down( "cbo_fabriccolor_id", 130, $fabric_color_array,"", 1, "-Select-", "", "","","","","","","" );
	exit();
}

if ($action=="load_drop_down_gmts_size")
{
	$data=explode("_",$data);
	$txt_order_no_id=$data[0];
	$fabric_id=$data[1];
	$gmts_color=$data[2];
	
	$size_library_order=return_library_array( "select a.id, a.size_name from lib_size a, wo_pre_cos_fab_co_avg_con_dtls b where a.id=b.gmts_sizes and b.po_break_down_id in (".$txt_order_no_id.") and b.pre_cost_fabric_cost_dtls_id='$fabric_id' and b.color_number_id='$gmts_color' and b.cons>0  group by a.id, a.size_name", "id", "size_name");
	
	echo create_drop_down( "cbo_garmentssize_id", 130, $size_library_order,"", 1, "-- Select Size --", $selected, "load_dia(this.value)" );
	exit();
}

if ($action=="load_drop_down_item_size")
 {
	$data=explode("_",$data);
	$txt_order_no_id=$data[0];
	$fabric_id=$data[1];
	$gmts_color=$data[2];
	
	if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
	if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
	if ($cbouom!=0) $cbouom_cond="and a.uom='$cbouom'";
	$nameArray=sql_select( " select b.item_size FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.po_break_down_id in (".$txt_order_no_id.") and a.id='$fabric_id' and b.color_number_id='$gmts_color' and b.cons>0 order by b.item_size");
	$item_size_array= array();
	if (count($nameArray)>0 )
	{
		foreach ($nameArray as $result)
		{
		    $item_size_array[$result[csf("item_size")]]=$result[csf("item_size")];
		}
	}

	echo create_drop_down( "cbo_itemsize_id", 130, $item_size_array,"", 1, "-Select-", "", "","","","","","","" );
	exit();
}

if($action=="check_conversion_rate"){
	$data=explode("**",$data);
	$conversion_date=change_date_format($data[1], "d-M-y", "-",1);
	$currency_rate=set_conversion_rate( $data[0], $conversion_date,$data[2] );
	echo "1"."_".$currency_rate;
	exit();
}

if($action=="load_fabric_dia")
{
	$data=explode("**",$data);
	$order_id=$data[0];
	$fabricdescription_id=$data[1];
	$garmentscolor_id=$data[2];
	$garmentssize_id=$data[3];
	$dia='';
	$dia_arr=sql_select("SELECT dia_width from wo_pre_cos_fab_co_avg_con_dtls  where  po_break_down_id =".$order_id." and pre_cost_fabric_cost_dtls_id='$fabricdescription_id' and color_number_id='$garmentscolor_id' and gmts_sizes=$garmentssize_id and cons>0  group by dia_width");
	if(count($dia_arr)>0)
	{
		foreach ($dia_arr as $row) {
			$dia=$row[csf('dia_width')];
		}
		echo "1"."_".$dia;
	}
	else{
		echo "2"."_".$dia;
	}
	
	exit();
}

if($action=="check_month_maintain")
{
	//echo $data;
	$sql_result=sql_select("select tna_integrated from variable_order_tracking where company_name='$data' and variable_list=14 and status_active=1 and is_deleted=0");

	$maintain_setting=$sql_result[0][csf('tna_integrated')];
	if($maintain_setting==1) echo "1"."_"; else echo "0"."_";
	exit();
}

if ($action=="order_search_popup")
{
	echo load_html_head_contents("Order Search","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
		var selected_id = new Array, selected_name = new Array();
		function check_all_data()
		{
			var tbl_row_count = document.getElementById( 'tbl_list_search' ).rows.length;
			tbl_row_count = tbl_row_count;
			for( var i = 1; i <= tbl_row_count; i++ )
			{
				js_set_value( i );
			}
		}

		function toggle( x, origColor )
		{
			var newColor = 'yellow';
			document.getElementById(x).style.backgroundColor = ( newColor == document.getElementById(x).style.backgroundColor )? origColor : newColor;
		}

		function js_set_value( str_data,tr_id )
		{
			var str_all=str_data.split("_");
			var str_po=str_all[1];
			var str=str_all[0];
			if ( document.getElementById('job_no').value!="" && document.getElementById('job_no').value!=str_all[2] )
			{
				alert('No Job Mix Allowed')
				return;
			}
			toggle( tr_id, '#FFFFCC');
			document.getElementById('job_no').value=str_all[2];

			if( jQuery.inArray( str , selected_id ) == -1 )
			{
				selected_id.push( str );
				selected_name.push( str_po );
			}
			else
			{
				for( var i = 0; i < selected_id.length; i++ )
				{
					if( selected_id[i] == str ) break;
				}

				selected_id.splice( i, 1 );
				selected_name.splice( i, 1 );
					//alert(selected_id.length)
				if(selected_id.length==0)
				{
					document.getElementById('job_no').value="";
				}
			}
			var id = '' ; var name = '';
			for( var i = 0; i < selected_id.length; i++ )
			{
				id += selected_id[i] + ',';
				name += selected_name[i] + ',';
			}
			id = id.substr( 0, id.length - 1 );
			name = name.substr( 0, name.length - 1 );
			$('#po_number_id').val( id );
			$('#po_number').val( name );
		}
	</script>
	</head>
	<body>
        <div align="center" style="width:100%;" >
			<?
				$booking_month=0;
				if(str_replace("'","",$cbo_booking_month)<10) $booking_month.=str_replace("'","",$cbo_booking_month); else $booking_month=str_replace("'","",$cbo_booking_month);
				
				$start_date="01"."-".$booking_month."-".str_replace("'","",$cbo_booking_year);
				$end_date=cal_days_in_month(CAL_GREGORIAN, $booking_month, str_replace("'","",$cbo_booking_year))."-".$booking_month."-".str_replace("'","",$cbo_booking_year);
				//echo $booking_month;
				if($booking_month!=0)
				{
					$start_date=$start_date;  $end_date=$end_date;
				}
				else
				{
					$start_date=''; $end_date='';
				}
            ?>
            <form name="searchpofrm_1" id="searchpofrm_1">
                <table width="1200" class="rpt_table" align="center" border="1" rules="all">
                    <thead>
                        <tr>
                            <th colspan="9"><? echo create_drop_down( "cbo_string_search_type", 100, $string_search_type,'', 1, "-- Searching Type --" ); ?></th>
                        </tr>
                        <tr>
                            <th width="150">Company Name</th>
                            <th width="150">Buyer Name</th>
                            <th width="100">Job No</th>
                            <th width="100">Style Ref </th>
                            <th width="100">Internal Ref</th>
                            <th width="100">File No</th>
                            <th width="150">Order No</th>
                            <th width="200">Date Range</th>
                            <th>
                                <input type="hidden" id="po_number_id">
                                <input type="hidden" id="job_no">&nbsp;
                            </th>
                        </tr>
                    </thead>
                    <tr class="general">
                        <td><? echo create_drop_down( "cbo_company_mst", 150, "select id,company_name from lib_company comp where status_active=1 and is_deleted=0 and core_business not in(3) $company_cond order by company_name","id,company_name",1, "- Select Company -", str_replace("'","",$cbo_company_name), "load_drop_down( 'fabric_booking_controller', this.value, 'load_drop_down_buyer_popup', 'buyer_td' );"); ?></td>
                        <td id="buyer_td"><? echo create_drop_down( "cbo_buyer_name", 172, "select buy.id,buy.buyer_name from lib_buyer buy, lib_buyer_tag_company b where buy.status_active=1 and buy.is_deleted=0 $buyer_cond and b.buyer_id=buy.id and b.tag_company=$cbo_company_name and buy.id in (select  buyer_id from  lib_buyer_party_type where party_type in (1,3,21,90)) order by buyer_name","id,buyer_name", 1, "-- Select Buyer --", str_replace("'","",$cbo_buyer_name), "" ); ?></td>
                        <td><input name="txt_job_prifix" id="txt_job_prifix" class="text_boxes" style="width:90px" placeholder="Prefix No"></td>
                        <td><input name="txt_style" id="txt_style" class="text_boxes" style="width:90px"></td>
                        <td><input name="txt_internal_ref" id="txt_internal_ref" class="text_boxes" style="width:90px"></td>
                        <td><input name="txt_file_no" id="txt_file_no" class="text_boxes" style="width:90px"></td>
                        <td><input name="txt_order_search" id="txt_order_search" class="text_boxes" style="width:150px"></td>
                        <td>
                            <input name="txt_date_from" id="txt_date_from" class="datepicker" style="width:85px" value="<? echo $start_date; ?>"/>
                            <input name="txt_date_to" id="txt_date_to" class="datepicker" style="width:85px" value="<? echo $end_date; ?>"/>
                            <input class="datepicker" type="hidden" style="width:130px" name="txt_booking_date" id="txt_booking_date"  value="<? echo str_replace("'","",$txt_booking_date)?>" disabled />
                        </td>
                        <td>
                            <input type="button" name="button2" class="formbutton" value="Show" onClick="show_list_view ( document.getElementById('cbo_company_mst').value+'_'+document.getElementById('cbo_buyer_name').value+'_'+document.getElementById('txt_date_from').value+'_'+document.getElementById('txt_date_to').value+'_'+document.getElementById('txt_job_prifix').value+'_'+document.getElementById('txt_order_search').value+'_'+document.getElementById('txt_style').value+'_'+document.getElementById('cbo_string_search_type').value+'_'+document.getElementById('txt_internal_ref').value+'_'+document.getElementById('txt_file_no').value+'_'+document.getElementById('txt_booking_date').value, 'create_po_search_list_view', 'search_div', 'short_fabric_booking_controller', 'setFilterGrid(\'list_view\',-1)')" style="width:100%;" />
                        </td>
                    </tr>
                    <tr>
                        <td colspan="9" align="center">
                            <strong>Selected PO Number:</strong> &nbsp;<input type="text" class="text_boxes" readonly style="width:550px" id="po_number">
                        </td>
                    </tr>
                    <tr>
                        <td align="center"  colspan="9"><input type="button" name="close" onClick="parent.emailwindow.hide();"  class="formbutton" value="Close" style="width:100px" /></td>
                    </tr>
                </table>
            </form>
            <div id="search_div"></div>
        </div>
	</body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}

if($action=="create_po_search_list_view")
{
	$data=explode('_',$data);
	if ($data[0]!=0) $company=" and a.company_name='$data[0]'"; else { echo "Please Select Company First."; die; }
	if ($data[1]!=0) $buyer=" and a.buyer_name='$data[1]'"; else $buyer=""; //{ echo "Please Select Buyer First."; die; }

	$txt_booking_date=str_replace("'","",$data[10]);

	//if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num='$data[4]'  "; else  $job_cond="";
	//if (str_replace("'","",$data[5])!="") $order_cond=" and b.po_number like '%$data[5]%'  "; else  $order_cond="";
	$job_cond=""; $order_cond=""; $style_cond="";
	if($data[7]==1)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num='$data[4]'"; //else  $job_cond="";
		if (str_replace("'","",$data[5])!="") $order_cond=" and b.po_number = '$data[5]'  "; //else  $order_cond="";
		if (trim($data[6])!="") $style_cond=" and a.style_ref_no ='$data[6]'"; //else  $style_cond="";
	}
	else if($data[7]==2)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num like '$data[4]%'"; //else  $job_cond="";
		if (str_replace("'","",$data[5])!="") $order_cond=" and b.po_number like '$data[5]%'  "; //else  $order_cond="";
		if (trim($data[6])!="") $style_cond=" and a.style_ref_no like '$data[6]%'  "; //else  $style_cond="";
	}
	else if($data[7]==3)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num like '%$data[4]'"; //else  $job_cond="";
		if (str_replace("'","",$data[5])!="") $order_cond=" and b.po_number like '%$data[5]'  "; //else  $order_cond="";
		if (trim($data[6])!="") $style_cond=" and a.style_ref_no like '%$data[6]'"; //else  $style_cond="";
	}
	else if($data[7]==4 || $data[7]==0)
	{
		if (str_replace("'","",$data[4])!="") $job_cond=" and a.job_no_prefix_num like '%$data[4]%'"; //else  $job_cond="";
		if (str_replace("'","",$data[5])!="") $order_cond=" and b.po_number like '%$data[5]%'  "; //else  $order_cond="";
		if (trim($data[6])!="") $style_cond=" and a.style_ref_no like '%$data[6]%'"; //else  $style_cond="";
	}
	$internal_ref = str_replace("'","",$data[8]);
	$file_no = str_replace("'","",$data[9]);
	if ($file_no=="") $file_no_cond=""; else $file_no_cond=" and b.file_no='".trim($file_no)."' ";
	if ($internal_ref=="") $internal_ref_cond=""; else $internal_ref_cond=" and b.grouping='".trim($internal_ref)."' ";
 	$shipment_date ="";
	if($db_type==0)
	{
		if ($data[2]!="" &&  $data[3]!="") $shipment_date = "and b.pub_shipment_date between '".change_date_format($data[2], "yyyy-mm-dd", "-")."' and '".change_date_format($data[3], "yyyy-mm-dd", "-")."'";
	}
	else if($db_type==2)
	{
		if ($data[2]!="" &&  $data[3]!="") $shipment_date = "and b.pub_shipment_date between '".change_date_format($data[2], "yyyy-mm-dd", "-",1)."' and '".change_date_format($data[3], "yyyy-mm-dd", "-",1)."'";
	}
	$short_fabric_booking_befr_main=sql_select("select s_f_booking_befor_m_f from variable_order_tracking where company_name='$data[0]' and variable_list=38 and status_active=1 and is_deleted=0");
	list($sf_be_mf)= $short_fabric_booking_befr_main;
	$sf_be_mf_va=$sf_be_mf[csf('s_f_booking_befor_m_f')];

	 $po_id_arr=array();
	 $sql_job=sql_select("select b.id,  sum(distinct c.booking_percent) as  booking_percent from wo_po_details_master a, wo_po_break_down b, wo_booking_mst c,wo_booking_dtls d where a.job_no=b.job_no_mst  and a.job_no=d.job_no and b.id=d.po_break_down_id and c.booking_no=d.booking_no and a.status_active=1 and b.status_active=1 and c.status_active=1  $shipment_date $company $buyer $job_cond $order_cond $file_no_cond $internal_ref_cond $style_cond ".set_user_lavel_filtering(' and a.buyer_name','buyer_id')."  group by b.id  order by b.id");
	//echo "select b.id,  sum(distinct c.booking_percent) as  booking_percent from wo_po_details_master a, wo_po_break_down b, wo_booking_mst c,wo_booking_dtls d where a.job_no=b.job_no_mst and a.job_no=c.job_no and a.job_no=d.job_no and b.id=d.po_break_down_id and c.booking_no=d.booking_no and a.status_active=1 and b.status_active=1 and c.status_active=1  $shipment_date $company $buyer $job_cond $order_cond $file_no_cond $internal_ref_cond $style_cond ".set_user_lavel_filtering(' and a.buyer_name','buyer_id')."  group by b.id  order by b.id";
	 $bk_string="";
	 foreach($sql_job as $row_job )
	 {
		 if($row_job[csf('booking_percent')]>=100){
		 $po_id_arr[]= $row_job[csf('id')];
		 }
	 }

	if($db_type==0)
	{
		$sql_approval_status="select approval_need,allow_partial from approval_setup_dtls where mst_id=(select id from approval_setup_mst where company_id='$data[0]' and setup_date=(select max(setup_date) from approval_setup_mst where setup_date <= '".change_date_format($txt_booking_date,'yyyy-mm-dd')."' and company_id='$data[0]')) and page_id=25 and status_active=1 and is_deleted=0";
	}
	else
	{
		$sql_approval_status="select approval_need,allow_partial from approval_setup_dtls where mst_id=(select id from approval_setup_mst where company_id='$data[0]' and setup_date=(select max(setup_date) from approval_setup_mst where setup_date <= '".change_date_format($txt_booking_date, "", "",1)."' and company_id='$data[0]')) and page_id=25 and status_active=1 and is_deleted=0";
	}
	$result_approval_status=sql_select($sql_approval_status);
	//if($approval_status[0][csf('approval_need')]==1) $approval_status="1"; else $approval_status="1,2";
	$allow_partial=$result_approval_status[0][csf('allow_partial')];
	$approval_need=$result_approval_status[0][csf('approval_need')];
	//echo $allow_partial.'='.$approval_need.'XZ';die;
	/*if($approval_need==1 && $allow_partial==1)
	{ 
	 $approval_statusCond=" and c.approved in (1,3)";
	}
	else if($approval_need==1 )
	{ 
	 $approval_statusCond="and c.approved in (1)";
	}
	else if($allow_partial==1)
	{ 
	 $approval_statusCond="and c.approved in (3)";
	}
	else $approval_statusCond="";*/
	
	if($approval_need==1 && $allow_partial==1) //Issue Id-29071 Norban
	{ 
	 $approval_statusCond=" and c.approved in (1,3)";
	}
	else if($allow_partial==1 && ($approval_need==0 or $approval_need==2))
	{ 
	 $approval_statusCond="and c.approved in (1,3)";
	}
	else $approval_statusCond="";
	
 //echo $allow_partial.'DSSSSSSS';die;
	//print_r($po_id_arr);die;
	if(count($po_id_arr)>0 and $sf_be_mf_va==2)
	{
		$po_id=array_chunk($po_id_arr,1000, true);
		$po_cond_in="";
		
		$ji=0;
		foreach($po_id as $key=> $value)
		{
			if($ji==0) $po_cond_in="and b.id in(".implode(",",$value).")";  else $po_cond_in.=" or b.id in(".implode(",",$value).")";
			$ji++;
		}

		$buyer_arr=return_library_array( "select id, short_name from lib_buyer",'id','short_name');
		$comp=return_library_array( "select id, company_short_name from lib_company",'id','company_short_name');
		$arr=array (1=>$comp,2=>$buyer_arr);
		 $sql= "select a.job_no_prefix_num, a.company_name, a.buyer_name, a.style_ref_no, a.job_quantity, b.id, b.file_no, b.grouping, b.po_number, b.po_quantity, b.shipment_date, a.job_no from wo_po_details_master a, wo_po_break_down b, wo_pre_cost_mst c where a.job_no=b.job_no_mst and  a.id=c.job_id and   b.job_id=c.job_id and a.status_active=1 and b.status_active=1 and b.shiping_status not in(3) $approval_statusCond  $po_cond_in  $internal_ref_cond $file_no_cond  order by a.id DESC"; //$shipment_date $company $buyer $job_cond  $style_cond
		echo  create_list_view("list_view", "Job No,Company,Buyer,Style Ref. No,Job Qty.,PO number,Internal Ref,File No.,PO Qty,Shipment Date", "60,60,50,100,70,150,100,100,80,80","950","320",0, $sql , "js_set_value", "id,po_number,job_no", "this.id", 1, "0,company_name,buyer_name,0,0,0,0,0,0", $arr , "job_no_prefix_num,company_name,buyer_name,style_ref_no,job_quantity,po_number,grouping,file_no,po_quantity,shipment_date", '','','0,0,0,0,1,0,0,0,1,3','','');
	}
	else if($sf_be_mf_va==1)
	{
		$buyer_arr=return_library_array( "select id, short_name from lib_buyer",'id','short_name');
		$comp=return_library_array( "select id, company_short_name from lib_company",'id','company_short_name');
		$arr=array (1=>$comp,2=>$buyer_arr);
		$sql= "select a.job_no_prefix_num, a.company_name, a.buyer_name, a.style_ref_no, a.job_quantity, b.id, b.file_no, b.grouping, b.po_number, b.po_quantity, b.shipment_date, a.job_no from wo_po_details_master a, wo_po_break_down b, wo_pre_cost_mst c where a.job_no=b.job_no_mst and  a.id=c.job_id and   b.job_id=c.job_id and a.status_active=1 and b.status_active=1 and b.shiping_status not in(3) $approval_statusCond $shipment_date $company $buyer $job_cond $order_cond $style_cond $internal_ref_cond $file_no_cond order by a.id DESC"; //$shipment_date $company $buyer $job_cond  $style_cond
		echo  create_list_view("list_view", "Job No,Company,Buyer,Style Ref. No,Job Qty.,PO number,Internal Ref,File No.,PO Qty,Shipment Date", "60,60,50,100,70,150,100,100,80,80","950","320",0, $sql , "js_set_value", "id,po_number,job_no", "this.id", 1, "0,company_name,buyer_name,0,0,0,0,0,0", $arr , "job_no_prefix_num,company_name,buyer_name,style_ref_no,job_quantity,po_number,grouping,file_no,po_quantity,shipment_date", '','','0,0,0,0,1,0,0,0,1,3','','');
	}
	else
	{
		?>
		<strong style="color:#F00"> <? echo "100% Booking againts budget not done. Please Check". rtrim($bk_string,", ")."";?></strong>
		<?
	}
	exit();
}

if($action=="main_booking_popup")
{
	echo load_html_head_contents("Main Fabric Booking Tag popup","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
		function js_set_value( strval )
		{
			document.getElementById('selected_id').value=strval;
			parent.emailwindow.hide();
		}
    </script>
    </head>
    <?
	$sql= "select a.id, a.booking_no_prefix_num, c.file_no, c.grouping, a.booking_date, a.company_id, a.buyer_id, a.job_no, a.pay_mode, d.gmts_item_id, a.po_break_down_id, a.item_category, a.fabric_source, a.supplier_id, a.is_approved, a.booking_no, a.ready_to_approved, b.style_ref_no from wo_booking_mst a, wo_po_details_master b, wo_po_break_down c, wo_po_details_mas_set_details d where a.company_id='$cbo_company_name' ". set_user_lavel_filtering(' and a.buyer_id','buyer_id')." and a.job_no=b.job_no and b.id=c.job_id and b.id=d.job_id and c.id in (".$order_no_id.") and a.booking_type=1 and a.is_short=2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and a.entry_form in (86,108,118) group by a.id, a.booking_no_prefix_num, c.file_no, c.grouping, a.booking_date, a.company_id, a.buyer_id, a.job_no, a.pay_mode, d.gmts_item_id, a.po_break_down_id, a.item_category, a.fabric_source, a.supplier_id, a.is_approved, a.booking_no, a.ready_to_approved, b.style_ref_no order by a.id DESC";
	?>
    <table width="1160" cellspacing="0" cellpadding="0" border="1" class="rpt_table" rules="all">
        <thead>
            <tr>
                <th width="30">SL</th>
                <th width="60">Booking No</th>
                <th width="60">Booking Date</th>
                <th width="80">Buyer</th>
                <th width="60">Job No</th>
                <th width="90">Style Ref.</th>
                <th width="90">Gmts Item </th>
                <th width="100">PO number</th>
                <th width="50">PO Qty.</th>
                <th width="80">Internal Ref</th>
                <th width="80">File No</th>
                <th width="80">Fabric Nature</th>
                <th width="80">Fabric Source</th>
                <th width="50">Pay Mode</th>
                <th width="50">Supplier</th>
                <th width="50">Approved</th>
                <th>Ready to Approved<input type="hidden" id="selected_id"></th>
            </tr>
        </thead>
    </table>
    <div style="max-height:300px; overflow-y:scroll; width:1160px" >
        <table width="1140" cellspacing="0" cellpadding="0" border="1" class="rpt_table" rules="all" id="list_view">
            <tbody>
            <?
            $sl=1;
            $data=sql_select($sql);
            foreach($data as $row)
            {
				if ($sl%2==0)$bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
				?>
				<tr bgcolor="<? echo $bgcolor; ?>" onClick="js_set_value('<? echo $row[csf("id")].'_'.$row[csf("booking_no")]; ?>')" style="cursor:pointer">
                    <td width="30"><? echo $sl; ?></td>
                    <td width="60"><? echo $row[csf("booking_no_prefix_num")];?></td>
                    <td width="60"><? echo change_date_format($row[csf("booking_date")],"dd-mm-yyyy","-"); ?></td>
                    <td width="80" style="word-break:break-all"><? echo $buyer_arr[$row[csf("buyer_id")]];?></td>
                    <td width="60"><? echo $job_prefix_num[$row[csf("job_no")]];?></td>
                    <td width="90" style="word-break:break-all"><? echo $row[csf("style_ref_no")]; ?></td>
                    <td width="90" style="word-break:break-all"><? echo $garments_item[$row[csf("gmts_item_id")]];?> </td>
                    <td width="100" style="word-wrap: break-word;word-break: break-all;"><? echo $po_array[$row[csf("po_break_down_id")]];?></td>
                    <td width="50"><? echo $po_qty_array[$row[csf("po_break_down_id")]];?></td>
                    <td width="80" style="word-break:break-all"><? echo $row[csf("grouping")];?></td>
                    <td width="80" style="word-break:break-all"><? echo $row[csf("file_no")];?></td>
                    <td width="80" style="word-break:break-all"><? echo $item_category[$row[csf("item_category")]];?></td>
                    <td width="80" style="word-break:break-all"><? echo $fabric_source[$row[csf("fabric_source")]];?></td>
                    <td width="50" style="word-break:break-all"><? echo $pay_mode[$row[csf("pay_mode")]];?></td>
                    <td width="50" style="word-break:break-all">
                    <?
                    if($row[csf("pay_mode")]==3 || $row[csf("pay_mode")]==5) echo $comp[$row[csf("supplier_id")]]; else echo $suplier[$row[csf("supplier_id")]];
                    ?>
                    </td>
                    <td width="50"><? echo $approved[$row[csf("is_approved")]];?></td>
                    <td><? echo $is_ready[$row[csf("ready_to_approved")]];?></td>
				</tr>
				<?
				$sl++;
            }
            ?>
            </tbody>
        </table>
    </div>
    <script>setFilterGrid('list_view',-1);</script>
	<?
	exit();
}

if($action=="process_loss_method_id")
{
	$data=explode("_",$data);
	$process_loss_method=return_field_value("process_loss_method", "variable_order_tracking", "company_name=$data[0]  and variable_list=18 and item_category_id=$data[1] and status_active=1 and is_deleted=0");
	echo $process_loss_method;
	exit();
}

if($action=="prosess_loss_set")
{
	$process_loss="";
	$nameArray=sql_select("select  process_loss from lib_yarn_count_determina_mst a,  wo_pre_cost_fabric_cost_dtls b  where a.id=b.lib_yarn_count_deter_id and b.id=$data limit 1");
	foreach ($nameArray as $result)
	{
		$process_loss=$result[csf("process_loss")];
	}
	echo  $process_loss;
	exit();
}

if($action=="show_fabric_booking")
{
	extract($_REQUEST);
	$po_number=return_library_array( "select id,po_number from wo_po_break_down", "id", "po_number"  );
	$color_library=return_library_array( "select id,color_name from lib_color where status_active =1 and is_deleted=0", "id", "color_name");
	$arr=array (0=>$po_number,1=>$body_part,2=>$color_type,6=>$color_library);
	$txt_booking_no=str_replace("'","",$txt_booking_no);
	$sql= "select a.po_break_down_id, b.body_part_id, b.color_type_id, b.construction, b.composition, b.gsm_weight, a.fabric_color_id, a.item_size, a.dia_width, a.fin_fab_qnty, a.process_loss_percent, a.grey_fab_qnty, a.rate, a.amount, a.id, a.pre_cost_fabric_cost_dtls_id FROM wo_booking_dtls a, wo_pre_cost_fabric_cost_dtls b WHERE a.pre_cost_fabric_cost_dtls_id=b.id and  a.booking_no ='".$data."' and a.is_short=1 and a.status_active=1 and	a.is_deleted=0";

	echo  create_list_view("list_view", "PO Number,Body Part,Color Type,Construction,Composition,GSM,Fab.Color,Item Size,Dia/ Width,Fin Fab Qnty,Process Loss,Gray Qnty,Rate,Amount", "100,130,100,100,150,50,80,100,50,60,60,60,60","1280","220",0, $sql , "get_php_form_data", "id", "'populate_details_data_from_for_update'", 1, "po_break_down_id,body_part_id,color_type_id,0,0,0,fabric_color_id,0,0,0,0,0,0,0", $arr , "po_break_down_id,body_part_id,color_type_id,construction,composition,gsm_weight,fabric_color_id,item_size,dia_width,fin_fab_qnty,process_loss_percent,grey_fab_qnty,rate,amount", "requires/short_fabric_booking_controller",'','0,0,0,0,0,0,0,0,0,2,2,2,2,2') ;
	exit();
}

if($action=="check_is_booking_used")
{
	$txt_booking_no="'".$data."'";
	$is_approved=0;
	$sql=sql_select("select is_approved from wo_booking_mst where booking_no=$txt_booking_no  and status_active=1");
	foreach($sql as $row){
		if($row[csf('is_approved')]==3) $is_approved=1; else $is_approved=$row[csf('is_approved')];
	}
	if($is_approved==1){
		echo "approved**".str_replace("'","",$txt_booking_no);
		die;
	}
	$booking_no=str_replace("'","",$txt_booking_no);
	if($booking_no!='') //Booking Start
	{
		$pi_number=return_field_value( "pi_number", "com_pi_master_details a,com_pi_item_details b"," a.id=b.pi_id and b.work_order_no=$txt_booking_no and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0");
		if($pi_number){
			echo "pi1**".str_replace("'","",$txt_booking_no)."**".$pi_number;
			die;
		}

		$pplbook=0;
		$ppl=sql_select("select b.id from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and a.booking_no=$txt_booking_no and a.is_sales!=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.id");
		foreach($ppl as $pplrow){
			$pplbook=$pplrow[csf('id')];
		}

		if($pplbook!=0){
			echo "PPL**".str_replace("'","",$txt_booking_no)."**".$pplbook;
			die;
		}

		$sales_order=0;
		$sqls=sql_select("select is_approved,job_no from fabric_sales_order_mst where sales_booking_no=$txt_booking_no and status_active=1");
		foreach($sqls as $rows){
			$sales_order=$rows[csf('job_no')];
			$sales_is_approved=$rows[csf('is_approved')];
		}
		if($sales_order){
			if($rows[csf('is_approved')]==3) $sales_is_approved=1; else $sales_is_approved=$rows[csf('is_approved')];
			//echo "sal1**".str_replace("'","",$txt_booking_no)."**".$sales_order;
			//die;
			if($sales_is_approved==1){
			echo "sal1**".str_replace("'","",$txt_booking_no)."**".$sales_order;
			die;
		}
		
	}

		$receive_mrr=0;
		$sqlre=sql_select("select recv_number from inv_receive_master where booking_no=$txt_booking_no");
		foreach($sqlre as $rows){
			$receive_mrr=$rows[csf('recv_number')];
		}
		if($receive_mrr){
			echo "rec1**".str_replace("'","",$txt_booking_no)."**".$receive_mrr;
			die;
		}

		$issue_mrr=0;
		$sqlis=sql_select("select issue_number from inv_issue_master where booking_no=$txt_booking_no");
		foreach($sqlis as $rows){
			$issue_mrr=$rows[csf('issue_number')];
		}
		if($issue_mrr){
			echo "iss1**".str_replace("'","",$txt_booking_no)."**".$issue_mrr;
			die;
		}
	} //Booking End
	exit();
}

if($action=="delete_booking_item")
{
	$con = connect();
	if($db_type==0)
	{
		mysql_query("BEGIN");
	}
    $rID_de1=execute_query( "update wo_booking_dtls set status_active=0, is_deleted =1 where booking_no ='$data' and status_active=1 and is_deleted =0",0);
    //$rID_de1=execute_query( "delete from  wo_booking_dtls where  booking_no ='$data'",0);
    if($db_type==0)
	{
		if($rID_de1)
		{
			mysql_query("COMMIT");
			//echo "0**".$new_job_no[0]."**".$rID;
		}
		else
		{
			mysql_query("ROLLBACK");
			//echo "10**".$new_job_no[0]."**".$rID;
		}
	}
	else if($db_type==2 || $db_type==1 )
	{
		if($rID_de1)
		{
			oci_commit($con);
			//echo "0**".$new_job_no[0]."**".$rID;
		}
		else
		{
			oci_rollback($con);
			//echo "10**".$new_job_no[0]."**".$rID;
		}
	}
	disconnect($con);
}

if($action=="print_booking_5")//md mamun-12-05-2022-crm-9885
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$txt_job_no=str_replace("'","",$txt_job_no);
	$show_yarn_rate=str_replace("'","",$show_yarn_rate);
	$path=str_replace("'","",$path);

	if($path==1) $path="../../";
	
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1 and master_tble_id='$cbo_company_name'",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$brand_name_arr=return_library_array( "select id,brand_name from lib_buyer_brand",'id','brand_name');
	$team_leader_arr=return_library_array( "select id,team_leader_name from lib_marketing_team",'id','team_leader_name');

	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	//$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	//$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	?>
	<div style="width:1330px" align="center">
    <?php
		$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7");
		list($nameArray_approved_row) = $nameArray_approved;
		$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_date_row) = $nameArray_approved_date;
		$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_comments_row) = $nameArray_approved_comments;

		?>										<!--    Header Company Information         -->
     
		<?
		
        $sample_booking_arr=array();
        $namesamplefab=sql_select( "select a.booking_no , sum(b.grey_fab_qnty) as grey_fab_qnty  from wo_booking_mst a, wo_booking_dtls b where  a.job_no=b.job_no and a.booking_no=b.booking_no  and a.tagged_booking_no=$txt_booking_no and a.is_deleted=0 and a.status_active=1 and b.is_deleted=0 and b.status_active=1  group by a.booking_no");
        foreach($namesamplefab as $namesamplefabrow){
            $sample_booking_arr['booking_no'][$namesamplefabrow[csf('booking_no')]]=$namesamplefabrow[csf('booking_no')];
            $sample_booking_arr['grey_fab_qnty'][$namesamplefabrow[csf('booking_no')]]=$namesamplefabrow[csf('grey_fab_qnty')];
        }
        $sample_booking_no=implode($sample_booking_arr['booking_no']);
        $sample_booking_qty=array_sum($sample_booking_arr['grey_fab_qnty']);
		
        $job_no=''; $total_set_qnty=0; $colar_excess_percent=0; $cuff_excess_percent=0; $rmg_process_breakdown=0; $booking_percent=0; $booking_po_id='';
		
        $nameArray=sql_select( "select a.booking_no, a.booking_date, a.supplier_id, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.rmg_process_breakdown, a.insert_date, a.update_date, a.tagged_booking_no, a.uom, a.pay_mode, a.booking_percent, b.job_no,b.brand_id, b.buyer_name, b.style_ref_no, b.gmts_item_id, b.order_uom, b.total_set_qnty, b.style_description, b.season_buyer_wise as season, b.product_dept, b.product_code, b.pro_sub_dep, b.dealing_marchant, b.order_repeat_no, b.repeat_job_no, a.fabric_composition, a.remarks,b.team_leader,b.fit_id from wo_booking_mst a, wo_po_details_master b where a.job_no=b.job_no and a.booking_no=$txt_booking_no");
		
		
		$po_id_all=$nameArray[0][csf('po_break_down_id')];
		$booking_uom=$nameArray[0][csf('uom')];
		$bookingup_date=$nameArray[0][csf('update_date')];
		$bookingins_date=$nameArray[0][csf('insert_date')];
		
		
		if($db_type==0)
        {
            $date_dif_cond="DATEDIFF(pub_shipment_date,po_received_date)";
            $group_concat_all="group_concat(grouping) as grouping, group_concat(file_no) as file_no";
        }
        else
        {
            $date_dif_cond="(pub_shipment_date-po_received_date)";
            $group_concat_all=" listagg(cast(grouping as varchar2(4000)),',') within group (order by grouping) as grouping,
                                listagg(cast(file_no as varchar2(4000)),',') within group (order by file_no) as file_no  ";
        }
        $po_number_arr=array(); $po_ship_date_arr=array(); $shipment_date=""; $po_no=""; $po_received_date=""; $shiping_status="";
        $po_sql=sql_select("select id, po_number, pub_shipment_date, MIN(pub_shipment_date) as mpub_shipment_date, MIN(po_received_date) as po_received_date, MIN(insert_date) as insert_date, plan_cut, po_quantity, shiping_status, $date_dif_cond as date_diff, $group_concat_all from wo_po_break_down where id in(".$po_id_all.") group by id, po_number, pub_shipment_date, plan_cut, po_quantity, shiping_status, po_received_date");
        foreach($po_sql as $row)
        {
            $po_qnty_tot+=$row[csf('plan_cut')];
            $po_qnty_tot1+=$row[csf('po_quantity')];
            $po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
            $po_ship_date_arr[$row[csf('id')]]=$row[csf('pub_shipment_date')];
            $po_num_arr[$row[csf('id')]]=$row[csf('po_number')];
            $po_no.=$row[csf('po_number')].", ";
            $shipment_date.=change_date_format($row[csf('mpub_shipment_date')],'dd-mm-yyyy','-').", ";
            $lead_time.=$row[csf('date_diff')].",";
            $po_received_date=change_date_format($row[csf('po_received_date')],'dd-mm-yyyy','-');
            $grouping.=$row[csf('grouping')].",";
            $file_no.=$row[csf('file_no')].",";
			
			$daysInHand.=(datediff('d',date('d-m-Y',time()),$row[csf('mpub_shipment_date')])-1).",";
			
			if($bookingup_date=="" || $bookingup_date=="0000-00-00 00:00:00")
			{
				$booking_date=$bookingins_date;
			}
			$WOPreparedAfter.=(datediff('d',$row[csf('insert_date')],$booking_date)-1).",";

			if($row[csf('shiping_status')]==1) $shiping_status.= "FP".",";
			else if($row[csf('shiping_status')]==2) $shiping_status.= "PS".",";
			else if($row[csf('shiping_status')]==3) $shiping_status.= "FS".",";
        }
		
		$po_no=implode(",",array_filter(array_unique(explode(",",$po_no))));
		$shipment_date=implode(",",array_filter(array_unique(explode(",",$shipment_date))));
		$lead_time=implode(",",array_filter(array_unique(explode(",",$lead_time))));
		$po_received_date=implode(",",array_filter(array_unique(explode(",",$po_received_date))));
		$grouping=implode(",",array_filter(array_unique(explode(",",$grouping))));
		$file_no=implode(",",array_filter(array_unique(explode(",",$file_no))));
		
		$daysInHand=implode(",",array_filter(array_unique(explode(",",$daysInHand))));
		$WOPreparedAfter=implode(",",array_filter(array_unique(explode(",",$WOPreparedAfter))));
		$shiping_status=implode(",",array_filter(array_unique(explode(",",$shiping_status))));
		?>
		<div width="100%"><?
        foreach ($nameArray as $result)
        {
            $total_set_qnty=$result[csf('total_set_qnty')];
            $colar_excess_percent=$result[csf('colar_excess_percent')];
            $cuff_excess_percent=$result[csf('cuff_excess_percent')];
            $rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
				$brand_id=$result[csf('brand_id')];
			$extra=explode("_",$rmg_process_breakdown);

			
            
            $booking_percent=$result[csf('booking_percent')];
			 $booking_po_id=$result[csf('po_break_down_id')];      

									 $a_process_loss=$extra[14]+$extra[8]+$extra[6]+$extra[12]+$extra[0]+$extra[10]+$extra[2]+$extra[13]+$extra[1];
									$b_process_loss=$extra[4]+$extra[3]+$extra[15];
									$tot_pro_loss=$a_process_loss+$b_process_loss;

				$sum_fin_fabqnty=sql_select("SELECT  sum(d.fin_fab_qnty) as qty	FROM wo_pre_cost_fabric_cost_dtls a join wo_pre_cos_fab_co_avg_con_dtls b on  
				a.id=b.pre_cost_fabric_cost_dtls_id join wo_po_color_size_breakdown c on c.id=b.color_size_table_id join wo_booking_dtls d on 
				b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id
				WHERE  d.booking_no =$txt_booking_no and a.uom=12 and d.status_active=1 and  d.is_deleted=0");

				//  print_r($total_fin_fabqnty);

			ob_start();
			if($brand_id>0) $brand_id_name="/".$brand_name_arr[$brand_id];else  $brand_id_name='';
			?>


			<table  class="rpt_table"  border="1" style="border:1px solid black;"   cellpadding="0" width="100%" cellspacing="0" rules="all" >
				<tr>
				<td align="center" colspan="2"><img  src='../../<? echo $imge_arr[$cbo_company_name]; ?>' height='5%' width='7%' align="left"/><p style=" margin-top:2%;"><?php echo $company_library[$cbo_company_name]; ?></p></td>
					<td align="center" width="100" colspan="2"> TEAM : &nbsp; <?=$team_leader_arr[$result[csf('team_leader')]];?></td>	
					<td align="center" width="100" colspan="2"> FIT: &nbsp; <?=$fit_list_arr[$result[csf('fit_id')]];?></td>
					<td align="center" colspan="2" width="170">FABRIC BOOKING SHEET EXCESS<br><?=str_replace("'","",$txt_booking_no);?></td>
				</tr>
		 	</table>
			 <table  class="rpt_table"  border="1" style="border:1px solid black;"   cellpadding="0" width="100%" cellspacing="0" rules="all" >
				<tr>
					<td width="150" style="font-size:16px;"><b>Portal Date</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?=$po_received_date;?></b></td>
					<td width="150" style="font-size:16px;"><b>Job No.</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><? echo trim($txt_job_no,"'"); ?></b></td>
					<td width="150" style="font-size:16px;"><b>Internal Ref</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><? echo $grouping; ?></b></td>
				</tr>
				<tr>
					<td width="150" style="font-size:16px;"><b>Prepared Date</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?=$result[csf('booking_date')];?></b></td>
					<td width="150" style="font-size:16px;"><b>Style Description</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></b></td>
					<td width="150" style="font-size:16px;"><b>Remarks</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><? echo $result[csf('remarks')]; ?></b></td>
				</tr>
				<tr>
					<td width="150" style="font-size:16px;"><b>Buyer / Brand </b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><? echo $buyer_name_arr[$result[csf('buyer_name')]].$brand_id_name; ?></b></td>
					<td width="150" style="font-size:16px;"><b>Order Quantity</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?=$po_qnty_tot1;?></b></td>
				</tr>
				<tr>
					<td width="150" style="font-size:16px;"><b>Style Ref. No.</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2"><b>&nbsp;<? echo $result[csf('style_ref_no')];?> </b></td>
					<td width="150" style="font-size:16px;"><b>Target Input Qty.</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?=$po_qnty_tot1*((100+$tot_pro_loss-$a_process_loss)/100);?></b></td>
				</tr>
				<tr>
					<td width="150" style="font-size:16px;"><b>Garments Item</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?
                        $gmts_item_name="";
                        $gmts_item=explode(',',$result[csf('gmts_item_id')]);
                        for($g=0;$g<=count($gmts_item); $g++)
                        {
                            $gmts_item_name.= $garments_item[$gmts_item[$g]].",";
                        }
                        echo rtrim($gmts_item_name,',');
                        ?></b></td>
					<td width="150" style="font-size:16px;"><b>Gmts  Cons.(Dzn)</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?=($sum_fin_fabqnty[0][csf('qty')]/$po_qnty_tot1)*12;?></b></td>
				</tr>
				<tr>
					<td width="150" style="font-size:16px;"><b>Order No.</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2"><b>&nbsp;<b><? echo rtrim($po_no,", "); ?></b></td>
					<td width="150" style="font-size:16px;"><b>Cutting Cons.(Dzn)</b></td>
					<td width="40" style="font-size:16px;" align="center"><b>:</b></td>
					<td width="100" style="font-size:16px;" colspan="2">&nbsp;<b><?
					$target_qty=$po_qnty_tot1*((100+$tot_pro_loss-$a_process_loss)/100);
					echo number_format(($sum_fin_fabqnty[0][csf('qty')]/$target_qty)*12,3);?></b></td>
				</tr>
				

			 </table>

			 <table  class="rpt_table"  border="1" style="border:1px solid black;"   cellpadding="0" width="100%" cellspacing="0" rules="all" >
				<tr>
					<td width="150" style="font-size:16px;"><b>A) B/Input  Rej%</b></td>
				
					<td width="100" style="font-size:16px;"><b><b>(1)&nbsp; Fabric :&nbsp<?=$extra[14]+$extra[8]+$extra[6]+$extra[12]+$extra[0];?>%</b></td>
					<td width="100" style="font-size:16px;"><b>(2)&nbsp; Print:<?=$extra[10]+$extra[2];?>%</b></td>
					<td width="100" style="font-size:16px;"><b> (3)&nbsp; Embo :<?=$extra[1];?>%</b></td>
					<td width="100" style="font-size:16px;"><b> (4)&nbsp; AOP :<?=$extra[13];?>%</b></td>
					<td width="100" align="right" style="font-size:16px;"><b>Total:</b></td>
					<td width="50" align="center" style="font-size:16px;"><b><?=$extra[14]+$extra[8]+$extra[6]+$extra[12]+$extra[0]+$extra[10]+$extra[2]+$extra[13]+$extra[1];?>%</b></td>
				</tr>
				<tr>
					<td width="150" style="font-size:16px;"><b>B)&nbsp; A/Input Extra/Rej %</b></td>					
					<td width="100" style="font-size:16px;"><b>(1)&nbsp; Sewing:<?=$extra[4];?>%</b></td>
					<td width="100" style="font-size:16px;"><b>(2)&nbsp; Wash:<?=$extra[3];?>%</b></td>
					<td width="100" style="font-size:16px;"><b>(3)&nbsp; Packing: <? echo $extra[15];  ?>%</b></td>
					<td width="100" style="font-size:16px;"><b></b></td>
					<td width="100" align="right" style="font-size:16px;"><b>Total: </b></td>
					<td width="50" align="center" style="font-size:16px;"><b><?=$extra[4]+$extra[3]+$extra[15];?>%</b></td>
				
				</tr>

			 </table>


			
					<?
		}
		
		if($cbo_fabric_source==1)
		{
			$nameArray_size=sql_select( "select size_number_id,min(id) as id, min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by size_number_id order by size_order");
			?>
			                 
                            
                              
                                <table  class="rpt_table"  border="1" align="left" cellpadding="0" width="100%" cellspacing="0" rules="all" >
                                    <tr>
                                        <td style="border:1px solid black" colspan="2" width="80"><strong> Size</strong></td>										
                                        <?
                                        foreach($nameArray_size  as $result_size)
                                        {
											?>
                                        	<td align="center" style="word-break:break-all" style="border:1px solid black"><strong><?=$size_library[$result_size[csf('size_number_id')]];?></strong></td>
                                        <? } ?>
                                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                         
                                    </tr>
                                    <?
									
                                    $color_size_order_qnty_array=array(); $color_size_qnty_array=array(); $size_tatal=array(); $size_tatal_order=array();
                                 //   for($c=0;$c<count($gmts_item); $c++)
                                 //   {
										$item_size_tatal=array(); $item_size_tatal_order=array(); $item_grand_total=0; $item_grand_total_order=0;
										$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  status_active=1  ".where_con_using_array($gmts_item,1,'item_number_id')." and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0  group by color_number_id  order by color_order");
										?>
									
										<?
									//	foreach($nameArray_color as $result_color)
										//{
											?>
											<tr>
                                                <td align="left" style="border:1px solid black" width="220">C) Order Qty (Pcs)  @</td>
												<td align="left" style="border:1px solid black" width="60">100%</td>
                                                <?
                                                $color_total=0; $color_total_order=0;
                                                foreach($nameArray_size  as $result_size)
                                                {
													$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]."  ".where_con_using_array($gmts_item,1,'item_number_id')." and  status_active=1 and is_deleted =0");

													foreach($nameArray_color_size_qnty as $result_color_size_qnty)
													{
														?>
														<td style="border:1px solid black; text-align:center; font-size:18px;">
														<?
														if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
														{
															echo number_format($result_color_size_qnty[csf('order_quantity')],0);
															$color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
															$color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
															$item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
															$item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
															$grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
															$grand_total_order +=$result_color_size_qnty[csf('order_quantity')];
															
															$color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
															$color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
															{
																$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
																$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
															}
															else
															{
																$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
																$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															}
															if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
																$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
															}
															else
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
																$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
															}
														}
														else echo "0";
														?>
														</td>
														<?
													}
                                                }
                                                ?>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($color_total_order),0); ?></td>
                                              
											</tr>
											<tr>
                                                <td align="left" style="border:1px solid black" width="220">D) Cutting Qty (A+B+C) @ </td>
												<td align="left" style="border:1px solid black" width="60"><?=100+$tot_pro_loss;?>%</td>
                                                <?
                                                $color_total=0; $color_total_order=0;
                                                foreach($nameArray_size  as $result_size)
                                                {
													$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]."   ".where_con_using_array($gmts_item,1,'item_number_id')." and  status_active=1 and is_deleted =0");
													foreach($nameArray_color_size_qnty as $result_color_size_qnty)
													{
														?>
														<td style="border:1px solid black; text-align:center; font-size:18px;">
														<?
														if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
														{
															echo number_format($result_color_size_qnty[csf('order_quantity')]*((100+$tot_pro_loss)/100),0);
															$color_total += $result_color_size_qnty[csf('plan_cut_qnty')]*((100+$tot_pro_loss)/100) ;
															$color_total_order += $result_color_size_qnty[csf('order_quantity')]*((100+$tot_pro_loss)/100) ;
															$item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')]*((100+$tot_pro_loss)/100);
															$item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')]*((100+$tot_pro_loss)/100);
														
															
															$color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')]*((100+$tot_pro_loss)/100);
															$color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')]*((100+$tot_pro_loss)/100);
															if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
															{
																$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')]*((100+$tot_pro_loss)/100);
																$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')]*((100+$tot_pro_loss)/100);
															}
															else
															{
																$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')]*((100+$tot_pro_loss)/100);
																$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')]*((100+$tot_pro_loss)/100);
															}
															if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')]*((100+$tot_pro_loss)/100);
																$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')]*((100+$tot_pro_loss)/100);
															}
															else
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')]*((100+$tot_pro_loss)/100);
																$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')]*((100+$tot_pro_loss)/100);
															}
														}
														else echo "0";
														?>
														</td>
														<?
													}
                                                }
                                                ?>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($color_total_order),0); ?></td>
                                              
											</tr>
											<tr>
                                                <td align="left" style="border:1px solid black" width="220">Target Input Qty. (D-A) @ &nbsp;&nbsp; </td>
												<td align="left" style="border:1px solid black" width="60"><?=(100+$tot_pro_loss)-$a_process_loss;?>%</td>
                                                <?
												$target_input_loss=(100+$tot_pro_loss)-$a_process_loss;
                                                $color_total=0; $color_total_order=0;
                                                foreach($nameArray_size  as $result_size)
                                                {
													$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]."   ".where_con_using_array($gmts_item,1,'item_number_id')." and  status_active=1 and is_deleted =0");
													foreach($nameArray_color_size_qnty as $result_color_size_qnty)
													{
														?>
														<td style="border:1px solid black; text-align:center; font-size:18px;">
														<?
														if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
														{
															echo number_format($result_color_size_qnty[csf('order_quantity')]*($target_input_loss/100),0);
															$color_total += $result_color_size_qnty[csf('plan_cut_qnty')]*($target_input_loss/100) ;
															$color_total_order += $result_color_size_qnty[csf('order_quantity')]*($target_input_loss/100) ;
															$item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')]*($target_input_loss/100);
															$item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')]*($target_input_loss/100);
														
															
															$color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')]*($target_input_loss/100);
															$color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')]*($target_input_loss/100);
															if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
															{
																$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')]*($target_input_loss/100);
																$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')]*($target_input_loss/100);
															}
															else
															{
																$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')]*($target_input_loss/100);
																$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')]*($target_input_loss/100);
															}
															if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')]*($target_input_loss/100);
																$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')]*($target_input_loss/100);
															}
															else
															{
																$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')]*($target_input_loss/100);
																$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')]*($target_input_loss/100);
															}
														}
														else echo "0";
														?>
														</td>
														<?
													}
                                                }
                                                ?>
                                                <td style="border:1px solid black; text-align:center; font-size:18px;"><?=number_format(round($color_total_order),0); ?></td>
                                              
											</tr>
											<?
									//	}
										?>
										
										
										
										</tr>
										<?
                                   // }
                                    ?>
                                  
                                   
                                </table>
                           
                        
			<?
		}
		// if($cbo_fabric_source==1) end
		
	  	?>
		
      	<!--  Here will be the main portion  -->
		<?
        $costing_per=""; $costing_per_qnty=0;
        $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
        if($costing_per_id==1)
        {
			$costing_per="1 Dzn";
			$costing_per_qnty=12;
        }
        if($costing_per_id==2)
        {
			$costing_per="1 Pcs";
			$costing_per_qnty=1;
        }
        if($costing_per_id==3)
        {
			$costing_per="2 Dzn";
			$costing_per_qnty=24;
        }
        if($costing_per_id==4)
        {
			$costing_per="3 Dzn";
			$costing_per_qnty=36;
        }
        if($costing_per_id==5)
        {
			$costing_per="4 Dzn";
			$costing_per_qnty=48;
        }
        $process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no' and status_active=1");
		//$s_length=return_field_value( "stitch_length", "fabric_mapping","mst_id=$determin_id");;
		$s_lengthArr=return_library_array( "select mst_id, stitch_length from fabric_mapping",'mst_id','stitch_length');
		
		if($cbo_fabric_source==1)
		{
			
			// $nameArray_fabric_description= sql_select("SELECT min(a.id) as fabric_cost_dtls_id, a.lib_yarn_count_deter_id as determin_id, a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.remarks, b.dia_width, avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment)as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and a.id=d.pre_cost_fabric_cost_dtls_id  and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no=$txt_booking_no and a.status_active=1 and d.status_active=1 and d.is_deleted=0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.item_number_id, a.construction, a.composition, a.gsm_weight, b.remarks, b.dia_width order by fabric_cost_dtls_id, a.body_part_id, b.dia_width");


			 $nameArray_fabric_description= sql_select("SELECT min(a.id) as fabric_cost_dtls_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,avg(b.process_loss_percent) as process_loss_percent,avg(rmg_qty) as rmg_qty, a.item_number_id, a.lib_yarn_count_deter_id as determin_id, min(a.width_dia_type) as width_dia_type  	FROM wo_pre_cost_fabric_cost_dtls a,wo_booking_dtls b where b.booking_no=$txt_booking_no and a.id=b.pre_cost_fabric_cost_dtls_id and b.status_active=1 and b.is_deleted=0
 			 and b.grey_fab_qnty>0 group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width, a.item_number_id, a.lib_yarn_count_deter_id order by a.body_part_id ");


			

			

			?>
					<br>
		<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-family:Arial Narrow;" >
			<tr align="center"><th colspan="<?=count($nameArray_fabric_description)*3+6;?>" align="center">&nbsp; </th>
                   
                   
                </tr>
			<tr align="center">
                    <th colspan="<?=count($nameArray_fabric_description)*3+6;?>" align="center">Fabric Details in Kg</th>
                   
                   
                </tr>
			<tr align="center">
                    <th colspan="3" align="left">Item Name</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('item_number_id')] == "") echo "<td  colspan='3'>&nbsp</td>";
						else echo "<td colspan='3'>". $garments_item[$result_fabric_description[csf('item_number_id')]]."</td>";
                    }
                    ?>
                    <td rowspan="10" width="50"><p>Total  Finish Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Total Grey Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Process Loss % </p></td>
                </tr>
				<tr align="center">
                    <th colspan="3" align="left">Body Part</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('body_part_id')] == "") echo "<td  colspan='3'  style='word-break:break-all'>&nbsp</td>";
						else echo "<td colspan='3' style='word-break:break-all'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
                    }
                    ?>
                  
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Color Type</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'  style='word-break:break-all'>&nbsp</td>";
						else echo "<td  colspan='3'  style='word-break:break-all'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Fabric Construction</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if($result_fabric_description[csf('construction')]== "") echo "<td  colspan='3'  style='word-break:break-all'>&nbsp</td>";
						else echo "<td  colspan='3'  style='word-break:break-all'>". $result_fabric_description[csf('construction')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th colspan="3" align="left">Yarn Composition</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('composition')] == "") echo "<td colspan='3'  style='word-break:break-all'>&nbsp</td>";
						else echo "<td colspan='3'  style='word-break:break-all'>".$result_fabric_description[csf('composition')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                	<th colspan="3" align="left">GSM</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('gsm_weight')] == "") echo "<td colspan='3' style='word-break:break-all' >&nbsp</td>";
						else echo "<td colspan='3'  style='word-break:break-all' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
                    }
                    ?>
                </tr>
              
                <tr align="center">
                    <th colspan="3" align="left">Dia/Width</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'  style='word-break:break-all'>&nbsp</td>";
						else echo "<td colspan='3'  style='word-break:break-all' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center">
                    <th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'  style='word-break:break-all'>&nbsp</td>";
						else echo "<td colspan='3'  style='word-break:break-all' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],4).", Grey: ".number_format($result_fabric_description[csf('requirment')],4)."</td>";
                    }
                    ?>
                </tr>
				 <tr align="center">
                    <th   colspan="3" align="left">Remarks</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('remarks')] == "")   echo "<td colspan='3'  style='word-break:break-all'>&nbsp</td>";
						else echo "<td colspan='3'  style='word-break:break-all' align='center'>".$result_fabric_description[csf('remarks')].",".$fabric_typee[$result_fabric_description[csf('remarks')]]."</td>";
                    }
                    ?>
                </tr>
                <tr>
                	<th colspan="<? echo  count($nameArray_fabric_description)*2+2; ?>" align="left" style="height:30px">&nbsp;</th>
                </tr>
                <tr>
                    <th width="120" align="left">Fabric Color</th>
                    <th width="120" align="left">Body Color</th>
                    <th width="120" align="left">Lab Dip No</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                   		echo "<th width='50'>Finish</th><th width='50'>P.Loss</th><th width='50' >Grey</th>";
                    }
                    ?>
                </tr>
                <?
				$color_library=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
                // $color_wise_wo_sql = "SELECT a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.lib_yarn_count_deter_id, b.dia_width, b.remarks, d.fabric_color_id, d.fin_fab_qnty as fin_fab_qnty, d.grey_fab_qnty as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a join wo_pre_cos_fab_co_avg_con_dtls b on  a.id=b.pre_cost_fabric_cost_dtls_id join wo_po_color_size_breakdown c on c.id=b.color_size_table_id join wo_booking_dtls d on b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id WHERE  d.booking_no =$txt_booking_no and a.uom=12 and d.status_active=1 and  d.is_deleted=0 ";
				$color_wise_wo_sql = "select sum(b.fin_fab_qnty) as fin_fab_qnty,sum(b.grey_fab_qnty) as grey_fab_qnty,a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.lib_yarn_count_deter_id, b.fabric_color_id, b.process_loss_percent FROM	wo_pre_cost_fabric_cost_dtls a,	wo_booking_dtls b WHERE	b.booking_no =$txt_booking_no  and a.id=b.pre_cost_fabric_cost_dtls_id and
				b.status_active=1 and	b.is_deleted=0 and b.grey_fab_qnty>0 group by a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.lib_yarn_count_deter_id, b.fabric_color_id, b.process_loss_percent";
					
				// echo  $color_wise_wo_sql;

                $color_wise_wo_sql_res=sql_select($color_wise_wo_sql); $fin_grey_qty_arr=array(); $fin_grey_color_qty_arr=array();
                foreach($color_wise_wo_sql_res as $row)
                {
					$fin_grey_key = $row[csf('item_number_id')].'**'.$row[csf('body_part_id')].'**'.$row[csf('color_type_id')].'**'.$row[csf('construction')].'**'.$row[csf('composition')].'**'.$row[csf('gsm_weight')].'**'.$row[csf('lib_yarn_count_deter_id')];
					$fin_grey_color_key = $row[csf('item_number_id')].'**'.$row[csf('body_part_id')].'**'.$row[csf('color_type_id')].'**'.$row[csf('construction')].'**'.$row[csf('composition')].'**'.$row[csf('gsm_weight')].'**'.$row[csf('lib_yarn_count_deter_id')].'**'.$row[csf('fabric_color_id')];
					$fin_grey_qty_arr[$fin_grey_key]['fin'] += $row[csf('fin_fab_qnty')];
					$fin_grey_qty_arr[$fin_grey_key]['grey'] += $row[csf('grey_fab_qnty')];
					$fin_grey_color_qty_arr[$fin_grey_color_key]['fin'] +=$row[csf('fin_fab_qnty')];
					$fin_grey_color_qty_arr[$fin_grey_color_key]['grey'] +=$row[csf('grey_fab_qnty')];
					$fin_grey_color_qty_arr[$fin_grey_color_key]['process_loss_percent']=$row[csf('process_loss_percent')];
                }
                unset($color_wise_wo_sql_res);
                
                $gmt_color_library=array();
                $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and a.status_active=1  and b.status_active=1 and a.job_no ='$job_no'");
                foreach( $gmt_color_data as $gmt_color_row)
                {
                	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
                }
                
                $lab_dip_no_arr=array();
                $lab_dip_no_sql=sql_select("select lapdip_no, color_name_id from wo_po_lapdip_approval_info where job_no_mst='$job_no' and status_active=1 and is_deleted=0 and approval_status=3");
                foreach($lab_dip_no_sql as $row)
                {
                	$lab_dip_no_arr[$row[csf('color_name_id')]]=$row[csf('lapdip_no')];
                }
                unset($lab_dip_no_sql);
                
                $grand_total_fin_fab_qnty=0; $grand_total_grey_fab_qnty=0; $grand_totalcons_per_finish=0; $grand_totalcons_per_grey=0;
                $color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
                foreach($color_wise_wo_sql as $color_wise_wo_result)
                {
				
					?>
					<tr>
                        <td width="120" align="left"><? echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>
						
                        <td><? if($gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]) echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);else echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>
                        <td width="120" align="left">
							<?
                            $lapdip_no=""; $lapdip_no=$lab_dip_no_arr[$color_wise_wo_result[csf('fabric_color_id')]];
                            if($lapdip_no=="") echo "&nbsp;"; else echo $lapdip_no;
                            ?>
                        </td>
                        <?
                        $total_fin_fab_qnty=0; $total_grey_fab_qnty=0;
                        foreach($nameArray_fabric_description as $result_fabric_description)
                        {
							$color_wo_fin_qnty=0; $color_wo_grey_qnty=0;
							$fin_gray_color = $result_fabric_description[csf('item_number_id')].'**'.$result_fabric_description[csf('body_part_id')].'**'.$result_fabric_description[csf('color_type_id')].'**'.$result_fabric_description[csf('construction')].'**'.$result_fabric_description[csf('composition')].'**'.$result_fabric_description[csf('gsm_weight')].'**'.$result_fabric_description[csf('determin_id')].'**'.$color_wise_wo_result[csf('fabric_color_id')];
							
							
							
							$color_wo_fin_qnty=$fin_grey_color_qty_arr[$fin_gray_color]['fin'];
							$total_fin_fab_qnty+=$color_wo_fin_qnty;
							$color_wo_grey_qnty=$fin_grey_color_qty_arr[$fin_gray_color]['grey'];
							$total_grey_fab_qnty+=$color_wo_grey_qnty;
							?>
							<td width='50' align='center' style="font-size:18px;">
								<?
                                if($color_wo_fin_qnty!="")
                                {
                                    echo number_format($color_wo_fin_qnty,2) ;
                                   
                                }
                                ?>
							</td>
							<td width='50' align='center' title="Avg Process Loss" style="font-size:18px;"><?
								if($color_wo_fin_qnty!="")

								{
									echo $fin_grey_color_qty_arr[$fin_gray_color]['process_loss_percent'];
									
								}
						?></td>
							<td width='50' align='center' style="font-size:18px;">
								<?
                                if($color_wo_grey_qnty!="")
                                {
									echo number_format($color_wo_grey_qnty,2);
									
                                }
                                ?>
							</td>
							<?
                        }
						if($process_loss_method==1) //Markup
                        {
                        	//$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
							$msg=$total_grey_fab_qnty.'-'.$total_fin_fab_qnty.'/'.$total_fin_fab_qnty.'*'.'100';
							
                        }
                        if($process_loss_method==2)
                        {
                        	//$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
							$msg=$total_grey_fab_qnty.'-'.$total_fin_fab_qnty.'/'.$total_grey_fab_qnty.'*'.'100';
                        }
                        ?>
                        <td align="center" style="font-size:18px;"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
                        <td align="center" style="font-size:18px;"><? echo number_format($total_grey_fab_qnty,2); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>
                        <td align="center" style="font-size:18px;" title="<? echo $msg;?>">
                        <?

							if($process_loss_method==1)
							{
							$process_perc=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
							}
							if($process_loss_method==2)
							{
								
								$process_perc=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
							}
							echo number_format($process_perc,2);
							//if($color_wo_fin_qnty!="")

							//{
								//echo number_format($result_fabric_description[csf('process_loss_percent')],2);
								
							//}
                        ?>
                        </td>
					</tr>
					<?
                }
                ?>
                <tr style=" font-weight:bold">
                    <th width="120" align="left">&nbsp;</th>
                    <td width="120" align="left">&nbsp;</td>
                    <td width="120" align="left"><strong>Total</strong></td>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						$wo_fin_qnty=0; $wo_grey_qnty=0;
						$fin_key = $result_fabric_description[csf('item_number_id')].'**'.$result_fabric_description[csf('body_part_id')].'**'.$result_fabric_description[csf('color_type_id')].'**'.$result_fabric_description[csf('construction')].'**'.$result_fabric_description[csf('composition')].'**'.$result_fabric_description[csf('gsm_weight')].'**'.$result_fabric_description[csf('determin_id')];
						
						$wo_fin_qnty=$fin_grey_qty_arr[$fin_key]['fin'];
						$wo_grey_qnty=$fin_grey_qty_arr[$fin_key]['grey'];



						?>
						<td width='50' align='center' style="font-size:18px;"><?  echo number_format($wo_fin_qnty,2) ;?></td>
						<td width='50' align='center' style="font-size:18px;">
						<?
                         if($process_loss_method==1)
						 {
							$process_percent=(($wo_grey_qnty-$wo_fin_qnty)/$wo_fin_qnty)*100;
						 }
						 if($process_loss_method==2)
						 {
							 
							 $process_percent=(($wo_grey_qnty-$wo_fin_qnty)/$wo_grey_qnty)*100;
						 }
						 echo number_format($process_percent,2);
                        ?>	
						</td>
						<td width='50' align='center' style="font-size:18px;" > <? echo number_format($wo_grey_qnty,2);?></td>
						<?
                    }
                    ?>
                    <td align="center" style="font-size:18px;"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
                    <td align="center" style="font-size:18px;"><? echo number_format($grand_total_grey_fab_qnty,2);?></td>
                    <td align="center" style="font-size:18px;"><?
						if($process_loss_method==1)
						{
							$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_fin_fab_qnty)*100;
							
						}

						if($process_loss_method==2)
						{
							$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;
						}
						echo number_format($totalprocess_percent,2);?>
					</td>
                </tr>
                <tr style="font-weight:bold">
                    <th width="120" align="left">&nbsp;</th>
                    <td width="120" align="left">&nbsp;</td>
					<td width="120" align="left">&nbsp;</td>
                    <td width="120" align="left" title="<?=count($nameArray_fabric_description);?>" colspan="<?=count($nameArray_fabric_description)*3;?>"><strong>Consumption For: <? echo $costing_per; ?></strong></td>
						<?
                      //  foreach($nameArray_fabric_description as $result_fabric_description)
                       // {
							?>
							<!--<td width='50' align='center' style="font-size:18px;"><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
							<td width='50' align='center' style="font-size:18px;"><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
                            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>-->
							<?
                       // }
                       // ?>
                    <td align="center" style="font-size:18px;">
						<?
                        //echo $grand_total_fin_fab_qnty;
                        echo number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
                        $grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);
                        ?>
                    </td>
                    <td align="center" style="font-size:18px;"><? echo number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4);$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)?></td>
                    <td align="center" style="font-size:18px;">
					<?
                        if($process_loss_method==1)
                        {
                        	$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_fin_fab_qnty_dzn)*100;
                        }
                        
                        if($process_loss_method==2)
                        {
                        	
							$totalprocess_percent_dzn=(($grand_total_grey_fab_qnty_dzn-$grand_total_fin_fab_qnty_dzn)/$grand_total_grey_fab_qnty_dzn)*100;
                        }
                        echo number_format($totalprocess_percent_dzn,2);
                        ?>
                    </td>
                </tr>
			</table>
			<?
		}
		//echo "kausar"; die;
		if($cbo_fabric_source==2)
		{
			$nameArray_fabric_description= sql_select("select min(a.id) as fabric_cost_dtls_id, a.lib_yarn_count_deter_id as determin_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, min(a.width_dia_type) as width_dia_type, b.dia_width, avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0 group by a.body_part_id, a.lib_yarn_count_deter_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width order by fabric_cost_dtls_id, a.body_part_id, b.dia_width");
			?>
			<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" style="font-family:Arial Narrow;" >
                <tr align="center">
                    <th colspan="3" align="left">Body Part</th>
                    <?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
                    }
                    ?>
                    <td rowspan="10" width="50"><p>Total Fabric (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Avg Rate (<? echo $unit_of_measurement[$booking_uom];?>)</p></td>
                    <td rowspan="10" width="50"><p>Amount </p></td>
                </tr>
                <tr align="center"><th colspan="3" align="left">Color Type</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
                        if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
                        else echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
						else  echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Fabric Composition</th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
						else echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th  colspan="3" align="left">GSM</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else  echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th  colspan="3" align="left">Stitch Length</th>
					<?
                    foreach($nameArray_fabric_description  as $result_fabric_description)
                    {
						$determin_id=$result_fabric_description[csf('determin_id')];
						if( $result_fabric_description[csf('determin_id')] == "")   echo "<td colspan='2'>&nbsp</td>";
						else  echo "<td colspan='2' align='center'>". $s_lengthArr[$determin_id]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th colspan="3" align="left">Dia/Width (Inch)</th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
                    }
                    ?>
                </tr>
                <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2).", Grey: ".number_format($result_fabric_description[csf('requirment')],2)."</td>";
                    }
                    ?>
                </tr>
				  <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
					<?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
						if( $result_fabric_description[csf('requirment')] == "")   echo "<td colspan='3'>&nbsp</td>";
						else echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2).", Grey: ".number_format($result_fabric_description[csf('requirment')],2)."</td>";
                    }
                    ?>
                </tr>
                <tr>
                	<th colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
                </tr>
                <tr>
                    <th width="120" align="left">Fabric Color</th>
                    <th width="120" align="left">Body Color</th>
                    <th width="120" align="left">Lab Dip No</th>
                    <?
                    foreach($nameArray_fabric_description as $result_fabric_description)
                    {
                    	echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
                    }
                    ?>
                </tr>
                <?
                $gmt_color_library=array();
                $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.fabric_source =$cbo_fabric_source and a.job_no ='$job_no'");
                foreach( $gmt_color_data as $gmt_color_row)
                {
                	$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
                }
                
                $grand_total_fin_fab_qnty=0; $grand_total_amount=0;
                
                $color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
                foreach($color_wise_wo_sql as $color_wise_wo_result)
                {
                ?>
                <tr>
                
                <td  width="120" align="left">
                <?
                echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
                
                
                ?>
                </td>
                <td>
                <?
                echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
                ?>
                </td>
                <td  width="120" align="left">
                <?
                $lapdip_no="";
                $lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
                if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
                ?>
                </td>
                <?
                $total_fin_fab_qnty=0;
                $total_amount=0;
                
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                if($db_type==0)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
                d.status_active=1 and
                d.is_deleted=0
                ");
                }
                if($db_type==2)
                {
                
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
                d.status_active=1 and
                d.is_deleted=0
                ");
                }
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                ?>
                <td width='50' align='right'>
                <?
                if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
                {
                echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
                $total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
                }
                ?>
                </td>
                <td width='50' align='right' >
                <?
                if($color_wise_wo_result_qnty[csf('rate')]!="")
                {
                echo number_format($color_wise_wo_result_qnty[csf('rate')],2);
                }
                ?>
                </td>
                <td width='50' align='right' >
                <?
                $amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
                if($amount!="")
                {
                echo number_format($amount,2);
                $total_amount+=$amount;
                }
                ?>
                </td>
                <?
                }
                ?>
                <td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
                <td align="right"><? echo number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
                <td align="right">
                <?
                echo number_format($total_amount,2);
                
                ?>
                </td>
                </tr>
                <?
                }
                ?>
                <tr style=" font-weight:bold">
                <!--<td  width="120" align="left">&nbsp;</td>-->
                <th  width="120" align="left">&nbsp;</th>
                <td  width="120" align="left">&nbsp;</td>
                <td  width="120" align="left"><strong>Total</strong></td>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.status_active=1 and
                d.is_deleted=0
                ");
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                ?>
                <td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;?></td>
                <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
                <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
                <?
                }
                ?>
                <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
                <td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
                <td align="right">
                <?
                echo number_format($grand_total_amount,2);
                ?>
                </td>
                </tr>
                <tr style="font-weight:bold">
                <!--<td  width="120" align="left">&nbsp;</td>-->
                <th  width="120" align="left">&nbsp;</th>
                <td  width="120" align="left">&nbsp;</td>
                <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
                <?
                foreach($nameArray_fabric_description as $result_fabric_description)
                {
                $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
                WHERE a.job_no=b.job_no and
                a.id=b.pre_cost_fabric_cost_dtls_id and
                c.job_no_mst=a.job_no and
                c.id=b.color_size_table_id and
                b.po_break_down_id=d.po_break_down_id and
                b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
                d.booking_no =$txt_booking_no and
                a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
                a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
                a.construction='".$result_fabric_description[csf('construction')]."' and
                a.composition='".$result_fabric_description[csf('composition')]."' and
                a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
                a.lib_yarn_count_deter_id='".$result_fabric_description[csf('determin_id')]."' and
                b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
                d.status_active=1 and
                d.is_deleted=0
                ");
                list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
                
                ?>
                <td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
                <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
                <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
                <?
                }
                ?>
                <td align="right">
                <?
                $consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($costing_per_qnty);
                echo number_format($consumption_per_unit_fab,4);
                ?>
                </td>
                <td align="right">
                <?
                $consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($costing_per_qnty);
                echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
                ?>
                </td>
                <td align="right">
                <?
                echo number_format($consumption_per_unit_amuont,2);
                ?>
                </td>
                </tr>
			</table>
			<?
		}
		?>
        <br/>
        <?
		if($cbo_fabric_source==1)
		{
			$lab_dip_color_arr=array();
			$lab_dip_color_sql=sql_select("select pre_cost_fabric_cost_dtls_id, gmts_color_id, contrast_color_id from wo_pre_cos_fab_co_color_dtls where job_no='$job_no'");
			foreach($lab_dip_color_sql as $row)
			{
				$lab_dip_color_arr[$row[csf('pre_cost_fabric_cost_dtls_id')]][$row[csf('gmts_color_id')]]=$row[csf('contrast_color_id')];
			}
			
			

			$collar_cuff_percent_arr=array(); $collar_cuff_body_arr=array(); $collar_cuff_color_arr=array(); $collar_cuff_size_arr=array(); $collar_cuff_item_size_arr=array(); $color_size_sensitive_arr=array();

			$collar_cuff_sql="select a.id, a.item_number_id, a.color_size_sensitive, a.color_break_down, b.color_number_id, b.gmts_sizes, b.item_size, c.size_number_id, d.colar_cuff_per, e.body_part_full_name, e.body_part_type
			FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d, lib_body_part e

			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=e.id and e.body_part_type in (40,50) and c.id=d.color_size_table_id and d.color_size_table_id=b.color_size_table_id  and d.po_break_down_id=c.po_break_down_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 order by  c.size_order,e.body_part_type";
			//echo $collar_cuff_sql;
			$collar_cuff_sql_res=sql_select($collar_cuff_sql);
			
			$itemIdArr=array();

			foreach($collar_cuff_sql_res as $collar_cuff_row)
			{
				$collar_cuff_percent_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('gmts_sizes')]]=$collar_cuff_row[csf('colar_cuff_per')];
				$collar_cuff_body_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]]=$collar_cuff_row[csf('body_part_full_name')];
				$collar_cuff_size_arr[$collar_cuff_row[csf('body_part_type')]][$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]]=$collar_cuff_row[csf('size_number_id')];
				$collar_cuff_item_size_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('size_number_id')]][$collar_cuff_row[csf('item_size')]]=$collar_cuff_row[csf('item_size')];
				$color_size_sensitive_arr[$collar_cuff_row[csf('body_part_full_name')]][$collar_cuff_row[csf('id')]][$collar_cuff_row[csf('color_number_id')]][$collar_cuff_row[csf('color_size_sensitive')]]=$collar_cuff_row[csf('color_break_down')];
				
				$itemIdArr[$collar_cuff_row[csf('body_part_type')]].=$collar_cuff_row[csf('item_number_id')].',';
			}
			//print_r($collar_cuff_percent_arr[40]) ;
			unset($collar_cuff_sql_res);
			//$count_collar_cuff=count($collar_cuff_size_arr);
			
			$order_plan_qty_arr=array();
			$color_wise_wo_sql_qnty=sql_select( "select item_number_id, color_number_id, size_number_id, sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in ($booking_po_id) and status_active=1 and is_deleted =0  group by item_number_id, color_number_id, size_number_id");//and item_number_id in (".implode(",",$itemIdArr).")
			foreach($color_wise_wo_sql_qnty as $row)
			{
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['plan']=$row[csf('plan_cut_qnty')];
				$order_plan_qty_arr[$row[csf('item_number_id')]][$row[csf('color_number_id')]][$row[csf('size_number_id')]]['order']=$row[csf('order_quantity')];
			}
			unset($color_wise_wo_sql_qnty);
			
			foreach($collar_cuff_body_arr as $body_type=>$body_name)
			{
				$gmtsItemId=array_filter(array_unique(explode(",",$itemIdArr[$body_type])));
				foreach($body_name as $body_val)
				{
					$count_collar_cuff=count($collar_cuff_size_arr[$body_type][$body_val]);
					$pre_grand_tot_collar=0; $pre_grand_tot_collar_order_qty=0;

					?>
                    <div width="100%" style="overflow:auto; float:left; padding-top:5px; margin-left:5px; margin-bottom:5px; position:relative;">
					<table width="625" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr>
                        	<td colspan="<? echo $count_collar_cuff+3; ?>" align="center"><b><? echo $body_val; ?> - Color Size Brakedown in Pcs.</b></td>
                        </tr>
                        <tr>
                            <td width="100">Size</td>
								<?
                                foreach($collar_cuff_size_arr[$body_type][$body_val]  as $size_number_id)
                                {
									?>
									<td align="center" style="border:1px solid black"><strong><? echo $size_library[$size_number_id];?></strong></td>
									<?
                                }
                                ?>
                            <td width="60" rowspan="2" align="center"><strong>Total</strong></td>
                            <td rowspan="2" align="center"><strong>Extra %</strong></td>
                        </tr>
                        <tr>
                            <td style="font-size:12px"><? echo $body_val; ?> Size</td>
                            <?
                            foreach($collar_cuff_item_size_arr[$body_val]  as $size_number_id=>$size_number)
                            {
								if(count($size_number)>0)
								{
									 foreach($size_number  as $item_size=>$val)
									 {
										?>
										<td align="center" style="border:1px solid black"><strong><? echo $item_size;?></strong></td>
										<?
									 }
								}
								else
								{
									?>
									<td align="center" style="border:1px solid black"><strong>&nbsp;</strong></td>
									<?
								}
                            }

                            $pre_size_total_arr=array();
                            foreach($color_size_sensitive_arr[$body_val] as $pre_cost_id=>$pre_cost_data)
                            {
								foreach($pre_cost_data as $color_number_id=>$color_number_data)
								{
									foreach($color_number_data as $color_size_sensitive=>$color_break_down)
									{
										$pre_color_total_collar=0;
										$pre_color_total_collar_order_qnty=0;
										$process_loss_method=$process_loss_method;
										$constrast_color_arr=array();
										if($color_size_sensitive==3)
										{
											$constrast_color=explode('__',$color_break_down);
											for($i=0;$i<count($constrast_color);$i++)
											{
												$constrast_color2=explode('_',$constrast_color[$i]);
												$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
											}
										}
										?>
										<tr>
											<td>
												<?
                                                if( $color_size_sensitive==3)
                                                {
                                                    echo strtoupper ($constrast_color_arr[$color_number_id]) ;
                                                    $lab_dip_color_id=$lab_dip_color_arr[$pre_cost_id][$color_number_id];
                                                }
                                                else
                                                {
                                                    echo $color_library[$color_number_id];
                                                    $lab_dip_color_id=$color_number_id;
                                                }
                                                ?>
											</td>
											<?
											foreach($collar_cuff_size_arr[$body_type][$body_val] as $size_number_id)
											{
												?>
												<td align="center" style="border:1px solid black">
													<? $plan_cut=0; $collerqty=0; $collar_ex_per=0;
													$plan_cut=0;
													foreach($gmtsItemId as $giid)
													{
														if($body_type==50) $plan_cut+=($order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'])*2;
														else $plan_cut+=$order_plan_qty_arr[$giid][$color_number_id][$size_number_id]['plan'];
													}
													
                                                    //$ord_qty=$order_plan_qty_arr[$color_number_id][$size_number_id]['order'];

                                                    $collar_ex_per=$collar_cuff_percent_arr[$body_type][$body_val][$color_number_id][$size_number_id];
                                                    // echo $collar_ex_per.'=';

												    if($body_type==50) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$cuff_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                    else if($body_type==40) { if($collar_ex_per==0 || $collar_ex_per=="") $collar_ex_per=$colar_excess_percent; else $collar_ex_per=$collar_ex_per; }
                                                   // $colar_excess_per=number_format(($plan_cut*$collar_ex_per)/100,6,".",",");
                                                   $tot_exPer=($plan_cut*$collar_ex_per)/100;
													$colar_excess_per=$tot_exPer;
												    $collerqty=($plan_cut+$colar_excess_per);

                                                    //$collerqty=number_format(($requirment/$costing_per_qnty)*$plan_cut,2,'.','');

                                                    echo number_format($collerqty);
                                                    $pre_size_total_arr[$size_number_id]+=$collerqty;
                                                    $pre_color_total_collar+=$collerqty;
                                                    $pre_color_total_collar_order_qnty+=$plan_cut;

                                                    //$pre_grand_tot_collar_order_qty+=$plan_cut;
                                                    ?>
												</td>
												<?
											}
											$DataArr=$pre_color_total_collar.'-'.$pre_color_total_collar_order_qnty.'/'.$pre_color_total_collar_order_qnty.'*100';
											?>

											<td align="center"><? echo number_format($pre_color_total_collar); ?></td>
											<td align="center" title="<? echo $DataArr;?> &nbsp; =(SizeQty-PlanCut)/PlanCut*100"><? echo number_format((($pre_color_total_collar-$pre_color_total_collar_order_qnty)/$pre_color_total_collar_order_qnty)*100,2); ?></td>
										</tr>
										<?
										$pre_grand_collar_ex_per+=$collar_ex_per;
										$pre_grand_tot_collar+=$pre_color_total_collar;
										$pre_grand_tot_collar_order_qty+=$pre_color_total_collar_order_qnty;
									}
								}
							}
							?>
                        </tr>
                        <tr>
                            <td>Size Total</td>
								<?
                                foreach($pre_size_total_arr  as $size_qty)
                                {
									?>
									<td style="border:1px solid black;  text-align:center"><? echo number_format($size_qty); ?></td>
									<?
                                }
                                ?>
                            <td style="border:1px solid black; text-align:center"><? echo number_format($pre_grand_tot_collar); ?></td>
                            <td align="center" style="border:1px solid black"><? echo number_format((($pre_grand_tot_collar-$pre_grand_tot_collar_order_qty)/$pre_grand_tot_collar_order_qty)*100,2); ?></td>
                        </tr>
					</table>
                </div>
               
                <?
            }
        }

		 $condition= new condition();
		if(str_replace("'","",$txt_order_no_id) !=''){
			$condition->po_id("in(".str_replace("'","",$txt_order_no_id).")");
		}

		$condition->init();
		$cos_per_arr=$condition->getCostingPerArr();
		$yarn= new yarn($condition);
		$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');

		$yarn_sql_array=sql_select("SELECT min(a.id) as id ,a.count_id, a.copm_one_id, a.percent_one, a.color, a.type_id, sum(a.cons_qnty) as yarn_required, a.rate,SUM(b.grey_fab_qnty) as grey_fab_qnty from wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b where a.job_no=b.job_no and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no='$job_no' and b.booking_no=$txt_booking_no  and  a.status_active=1 and a.is_deleted=0 group by a.count_id,a.copm_one_id,a.percent_one,a.color,a.type_id,a.rate order by id");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" style="font-family:Arial Narrow;" >
            <tr>
                <td width="49%" valign="top">
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Yarn Required Summary (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                    <td>Rate</td>
                    <?
					}
					?>
                    <td>Cons for <? echo $costing_per; ?> Gmts</td>
                    <td>Total (KG)</td>
                    </tr>
                    <?
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
						$rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
						$rowcons_Amt = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];


						$rate=$rowcons_Amt/$rowcons_qnty;
						//$rowcons_qnty =($rowcons_qnty/100)*$booking_percent;
						$rowcons_qnty =$row[csf("grey_fab_qnty")];
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					$yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
					$yarn_des.=$color_library[$row[csf('color')]]." ";
					$yarn_des.=$yarn_type[$row[csf('type_id')]];
					echo $yarn_des;
					?>
                    </td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                     <td><? echo number_format($row[csf('rate')],4); ?></td>
                     <?
					}
					 ?>
                    <td><?  echo number_format(($rowcons_qnty/$po_qnty_tot)*$cos_per_arr[$job_no],4);//echo number_format($row[csf('yarn_required')],4); ?></td>

                    <td align="right">
					<? echo number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>
                    <td></td>
                    <td></td>
                    <?
					if($show_yarn_rate==1)
					{
					?>
                    <td></td>
                    <?
                    }
					?>
                    <td></td>
                    <td align="right"><? echo number_format($total_yarn,4); ?></td>
                    </tr>
                    </table>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                <?
				$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id order by id");
				if(count($yarn_sql_array)>0)
				{
				?>
                   <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Allocated Yarn</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>


                    <td>Allocated Qty (Kg)</td>
                    </tr>
                    <?
					$total_allo=0;
					$item=return_library_array( "select id, product_name_details from   product_details_master",'id','product_name_details');
					$supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?

					echo $item[$row[csf('item_id')]];
					?>
                    </td>
                    <td>
                    <?

					echo $supplier[$row[csf('supplier_id')]];
					?>
                    </td>
                    <td>
					<?

					echo $row[csf('lot')];
					?>
                    </td>
                    <td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>


                    <td></td>
                    <td></td>
                    <td align="right"><? echo number_format($total_allo,4); ?></td>
                    </tr>
                    </table>
                    <?
				}
				else
				{
					$is_yarn_allocated=return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_name and variable_list=18 and item_category_id=1");
					if($is_yarn_allocated==1)
					{
					?>
					<font style=" font-size:30px"><b> Draft</b></font>
                    <?
					}
					else
					{
						echo "";
					}
				}
					?>
                </td>
            </tr>
        </table>
        <br/>
		<div id="div_size_color_matrix" style="float:left; max-width:1000;">
            	<fieldset id="div_size_color_matrix" style="max-width:1000;">
 				<legend>Size and Color Breakdown</legend>
 				<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
                    <tr>
						<td style="border:1px solid black"><strong>Gmts Item</strong></td>
                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                    <?
						foreach($nameArray_size  as $result_size)
                        {	     ?>
                        <td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
                    <?	}    ?>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                        <td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                    </tr>
                    <?
					$color_size_order_qnty_array=array();
					$color_size_qnty_array=array();
					$size_tatal=array();
					$size_tatal_order=array();
					for($c=0;$c<count($gmts_item); $c++)
				    {
					$item_size_tatal=array();
					$item_size_tatal_order=array();
					$item_grand_total=0;
					$item_grand_total_order=0;
					$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id  order by color_order");
				
					?>
                   
                    <?
					$r=1;
					foreach($nameArray_color as $result_color)
                    {
                    ?>
                    <tr>
						<? if($r==1){?>
						<td style="border:1px solid black" rowspan="<?=count($nameArray_color);?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>
						<?$r++;}?>
                        <td align="center" style="border:1px solid black"><? echo $color_library[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
                        <?
						$color_total=0;
						$color_total_order=0;

						foreach($nameArray_size  as $result_size)
						{
						$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0");
						foreach($nameArray_color_size_qnty as $result_color_size_qnty)
                        {
                        ?>
                            <td style="border:1px solid black; text-align:right">
							<?
								if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
								{
									 echo number_format($result_color_size_qnty[csf('order_quantity')],0);
									 $color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
									 $color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
									 $item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
								     $grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $grand_total_order +=$result_color_size_qnty[csf('order_quantity')];

									 $color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
									 {
											$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
											$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
									 }
									 else
									 {
										$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
										$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 }
									 if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
									 {
											$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
											$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
									 }
									 else
									 {
										$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
										$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 }
								}
								else echo "0";
							 ?>
							</td>

                    <?
						}
                        }
                        ?>
						
                          <td style="border:1px solid black; text-align:right"><?  echo number_format(round($color_total_order),0); ?></td>

                         <td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?>
                         </td>
                        <td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total),0); ?></td>
                    </tr>
                    <?
                    }
					?>
 						
                    <?
					}
                    ?>
                     
                    <tr>
						<td style="border:1px solid black; text-align:right"></td>
                        <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                        <?
						$grand_total_order=0;$grand_total=0;
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
						$grand_total_order+=$size_tatal_order[$result_size[csf('size_number_id')]];
						$grand_total+=$size_tatal[$result_size[csf('size_number_id')]];
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total),0); ?></td>
                    </tr>
                </table>
                </fieldset>
                </div>

        <br/>

		 <!--New Start here-->
		 <div style="width:1330px; float:left">

	<?
	// Body Part type used only Cuff and Flat Knit
	$colar_percent_size_wise_array=return_library_array( "select a.colar_cuff_per,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id and a.booking_no=$txt_booking_no and a.booking_type=1 and c.body_part_type in(40,50) and a.status_active=1 and a.is_deleted=0", "gmts_sizes", "colar_cuff_per");

	//	echo  "select a.body_part_type,a.body_part_id,sum(d.rmg_qty) as rmg_qty,d.gmts_size,d.gmts_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d WHERE a.job_no=d.job_no and d.booking_no =$txt_booking_no and  a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 and d.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.body_part_type in(40,50) group by a.body_part_type,a.body_part_id,d.gmts_size,d.gmts_color_id order by a.body_part_id";

	$nameArray_body_part=sql_select( "select a.body_part_type,a.body_part_id,sum(d.rmg_qty) as rmg_qty,d.gmts_size,d.gmts_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d WHERE a.job_no=d.job_no and d.booking_no =$txt_booking_no and  a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 and d.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.body_part_type in(40,50) group by a.body_part_type,a.body_part_id,d.gmts_size,d.gmts_color_id order by a.body_part_id");



	$row_count=count($nameArray_body_part);
	//if($row_count==0) echo " <p style='color:#f00; text-align:center; font-size:15px;'> Body part type is  used only Flat Knit and Cuff.</p> ";
	foreach($nameArray_body_part as $row)
	{
		$body_part_arr[$row[csf('body_part_id')]]['bpart_type']=$row[csf('body_part_type')];
		$body_part_rmg_qty_arr[$row[csf('body_part_id')]][$row[csf('gmts_size')]][$row[csf('gmts_color_id')]]['rmg_qty']+=$row[csf('rmg_qty')];
	}
	//print_r($body_part_arr);
	$tbl_row_count=count($body_part_arr);
	//echo $tbl_row_count.'Dx';
	?>


	<?
	$k=1;
	foreach($body_part_arr as $body_id=>$val)
	{
		$k++;

		$bpart_type_id=$val['bpart_type'];
	$nameArray_item_size=sql_select( "select min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=$body_id  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 and a.body_part_type in(40,50) group by b.item_size,c.size_number_id order by id");
	?>

	<div style="max-height:1330px; width:660px; overflow:auto; float:left; padding-top:20px; margin-left:5px; margin-bottom:5px; position: relative;">
	<table  width="100%" align="left"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr>
	<td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b><? echo $body_part[$body_id];?> -  Colour Size Breakedown in Pcs</b></td>
	</tr>
	<tr>
	<td width="70">Size</td>

	<?
	foreach($nameArray_item_size  as $result_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
	<?
	}
	?>
	<td rowspan="2" align="center"><strong>Total</strong></td>

	</tr>
	<tr>
	<td>Collar Size</td>

	<?
	foreach($nameArray_item_size  as $result_item_size)
	{
	?>
	<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
	<?
	}
	?>
	<?
		$color_library=return_library_array( "select id,color_name from lib_color where status_active =1 and is_deleted=0", "id", "color_name");
		$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=$body_id  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and a.body_part_type in(40,50) group by c.color_number_id,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
	");
	foreach($color_wise_wo_sql as $color_wise_wo_result)
	{
		$color_total_collar=0;
		$color_total_collar_order_qnty=0;
		$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
		$constrast_color_arr=array();
		if($color_wise_wo_result[csf("color_size_sensitive")]==3)
		{
			$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
			for($i=0;$i<count($constrast_color);$i++)
			{
				$constrast_color2=explode('_',$constrast_color[$i]);
				$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
			}
		}
	?>
	<tr>
	<td>
	<?
	if($color_wise_wo_result[csf("color_size_sensitive")]==3)
	{
		echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
		$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
	}
	else
	{
		echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
		$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
	}
	?>

	</td>
	<?
	foreach($nameArray_item_size  as $result_size)
	{
		?>
		<td align="center" style="border:1px solid black">

		<?
		$rmg_qty=$body_part_rmg_qty_arr[$body_id][$result_size[csf('size_number_id')]][$color_wise_wo_result[csf('color_number_id')]]['rmg_qty'];
		//echo $bpart_type_id.'=';
		if($bpart_type_id==50)//Cuff
		{
			$fab_rmg_qty=$rmg_qty*2;
		}
		else //Flat Knit
		{
			$fab_rmg_qty=$rmg_qty;
		}
		echo number_format($fab_rmg_qty,0);
		$color_total_collar+=$fab_rmg_qty;
		$color_total_collar_order_qnty+=$fab_rmg_qty;
		$grand_total_collar+=$fab_rmg_qty;
		$grand_total_collar_order_qnty+=$fab_rmg_qty;

		$size_tatal[$result_size[csf('size_number_id')]]+=$fab_rmg_qty;
		?>
		</td>
		<?
	}
	?>

	<td align="center"><? echo number_format($color_total_collar,0); ?></td>

	</tr>
	<?
	}
	?>
	<tr>
		<td>Size Total</td>

		<?
		foreach($nameArray_item_size  as $result_size)
		{
			//$colar_excess_pers=($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100;
			$tot_size_tatal=$size_tatal[$result_size[csf('size_number_id')]];
			//$size_tatal[$result_size[csf('size_number_id')]]=0;
		?>
		<td style="border:1px solid black;  text-align:center"><?  echo number_format($size_tatal[$result_size[csf('size_number_id')]],0);$size_tatal[$result_size[csf('size_number_id')]]=0; ?></td>
		<?
		}
		?>
		<td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar,0);$grand_total_collar=0; ?></td>

	</tr>
	</table>
	<br/>
	</div>


	<?
	}

	?>


  <!--End here-->
		<div width="100%">
		<?
			$txt_job_no=str_replace("'","",$txt_job_no);
			$color_name_arr=return_library_array( "SELECT id,color_name from lib_color where status_active =1 and is_deleted=0",'id','color_name');
			$sql_stripe="SELECT c.id, c.composition, c.construction, c.body_part_id, c.fabric_description, c.gsm_weight, c.color_type_id, sum(b.grey_fab_qnty) as fab_qty, b.dia_width, d.gmts_color_id, d.fabric_color_id, d.id as did, d.stripe_color, d.fabreqtotkg as fabreqtotkg, d.measurement as measurement, d.yarn_dyed, d.uom, b.job_no from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c, wo_short_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.fabric_cost_dtls_id=c.id and d.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.id=d.dtls_id and b.job_no in('$txt_job_no')  and d.job_no in('$txt_job_no') and b.booking_no=$txt_booking_no and c.color_type_id in (2,3,4,6,31,32,33,34) and b.status_active=1 and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and b.is_deleted=0  group by c.id, c.body_part_id, c.fabric_description, c.gsm_weight, c.color_type_id, d.gmts_color_id, d.fabric_color_id, d.id, d.stripe_color, d.yarn_dyed, d.fabreqtotkg, d.measurement, d.uom, c.composition, c.construction, b.dia_width, b.job_no order by b.job_no,d.id ";
			$result_data=sql_select($sql_stripe);
		
			foreach($result_data as $row)
			{
				if($row[csf('fabric_color_id')]==0 || $row[csf('fabric_color_id')]=="") $row[csf('color_number_id')]=$row[csf('gmts_color_id')]; else $row[csf('color_number_id')]=$row[csf('fabric_color_id')];
				
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
				$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];
		
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
				$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['job_no']=$row[csf('job_no')];
				$tot_stripe_measurement_arr[$row[csf('color_number_id')]]+=$row[csf('measurement')];
			}
			
			if(count($stripe_arr)>0){
			?>

        <table width="55%"  border="1" style="float:left" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
      	
		
			 <tr>
				<th colspan="9"> <strong style="float:left"> Stripe Details</strong></th>
			
            </tr>
            <tr>
				<th width="30"> SL</th>
				<th width="100"> Body Part</th>
				<th width="80"> Fabric Color</th>
				<th width="70"> Fabric Qty(KG)</th>
				<th width="70"> Stripe Color</th>
				<th width="70"> Stripe Measurement</th>
				<th width="70"> Stripe Uom</th>
				<th  width="70"> Qty.(KG)</th>
				<th  width="70"> Y/D Req.</th>
            </tr>
            <?
			//if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
			//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";
				//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";


			$i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
            foreach($stripe_arr as $body_id=>$body_data){
				foreach($body_data as $color_id=>$color_val){
					$rowspan=count($color_val['stripe_color']);
					$composition=$stripe_arr2[$body_id][$color_id]['composition'];
					$construction=$stripe_arr2[$body_id][$color_id]['construction'];
					$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
					$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
					$dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];

					if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
					else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";

					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
						WHERE a.job_no=b.job_no and
						a.id=b.pre_cost_fabric_cost_dtls_id and
						c.job_no_mst=a.job_no and
						c.id=b.color_size_table_id and
						b.po_break_down_id=d.po_break_down_id and
						b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
						d.booking_no =$txt_booking_no and
						a.body_part_id='".$body_id."' and
						a.color_type_id='".$color_type_id."' and
						a.construction='".$construction."' and
						a.composition='".$composition."' and
						a.gsm_weight='".$gsm_weight."' and
						$color_cond and
						d.status_active=1 and
						d.is_deleted=0
						");
						list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;
					?>
					<tr>
					<?
					$color_qty=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
					?>
					<td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
					<td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
					<td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
					<td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?></td>
					<?
					$total_fab_qty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
					foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
					{
						$measurement=$color_val['measurement'][$strip_color_id];
						$uom=$color_val['uom'][$strip_color_id];
						$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
						$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
						?>
						<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
						<td align="right"> <? echo  number_format($measurement,2); ?></td>
                        <td> <? echo  $unit_of_measurement[$uom]; ?></td>
						<td align="right"> <? echo  number_format($fabreqtotkg,2); ?></td>
						<td> <? echo  $yes_no[$yarn_dyed]; ?></td>
						</tr>
						<?
						$total_fabreqtotkg+=$fabreqtotkg;
					}
					$i++;
				}
			}
			?>
            <tfoot>
            <tr>
            <td colspan="3">Total </td>
            <td align="right">  <? echo  number_format($total_fab_qty,2); ?> </td>
            <td></td>
            <td></td>
            <td>   </td>
            <td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
            </tr>
            </tfoot>
            </table>
			

	
			<?
				} //Stripe End
			$condition= new condition();
			if(str_replace("'","",$job_no) !=''){
				$condition->job_no("='$job_no'");
			}
			$condition->init();
			$cos_per_arr=$condition->getCostingPerArr();
			$yarn= new yarn($condition);
	
			//$yarn_data_array=$yarn->getOrderCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
			$yarn_data_array=$yarn->getOrderCountCompositionColorAndTypeWiseYarnQtyArray();
	
			$yarn_data_amt_array=$yarn->getOrderCountCompositionColorAndTypeWiseYarnAmountArray();
	
			$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');
			$po_number=return_library_array( "select id,po_number from wo_po_break_down", "id", "po_number");
		$lib_item_group_arr=return_library_array( "select item_name, id from lib_item_group where item_category=4 and is_deleted=0  and  status_active=1 order by item_name", "id", "item_name");
	
			
			
			
			$sql_data=sql_select("select a.fabric_color, a.item_color, a.precost_trim_cost_id, b.trim_group, b.cons_uom,sum(qty) as qty from wo_dye_to_match a, wo_pre_cost_trim_cost_dtls b where a.precost_trim_cost_id=b.id and a.booking_no=$txt_booking_no and a.qty>0 group by a.fabric_color, a.item_color, a.precost_trim_cost_id, b.trim_group, b.cons_uom order by a.fabric_color");
			
			if(count($sql_data)>0)
			{
				?>
			
				<table width="40%"  border="1" cellpadding="0" style="float:left;margin-left:5px; margin-bottom:10px;" cellspacing="0" class="rpt_table" rules="all">
				<tr>
				<th colspan="6"> <strong style="float:left"> Dyes To Match</strong></th>
			
            </tr>
					<tr align="center">
						<td>Sl</td>
						<td>Item</td>
						<td>Body Color</td>
						<td>Item Color</td>
						<td>Finish Qty.</td>
						<td>UOM</td>
					</tr>
					<?
					foreach($sql_data  as $row)
					{
						$co++;
						?>
						<tr>
							<td><? echo $co; ?></td>
							<td> <? echo $lib_item_group_arr[$row[csf('trim_group')]];?></td>
							<td><? echo $color_library[$row[csf('fabric_color')]];?></td>
							<td><? echo $color_library[$row[csf('item_color')]];?></td>
							<td align="right"><? echo $row[csf('qty')];?></td>
							<td><? echo $unit_of_measurement[$row[csf('cons_uom')]];?></td>
						</tr>
						<?
					}
					?>
				</table>
			
				<?
			}
			?>
				</div>
			
        <br/>
      

	<div width="100%">
	<?
	//------------------------------ Query for TNA start-----------------------------------
				$po_id_all=str_replace("'","",$txt_order_no_id);
				$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
				$tna_start_sql=sql_select( "select id,po_number_id,
								(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
								(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,

								(case when task_number=60 then task_start_date else null end) as knitting_start_date,
								(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
								(case when task_number=61 then task_start_date else null end) as dying_start_date,
								(case when task_number=61 then task_finish_date else null end) as dying_end_date,
								(case when task_number=64 then task_start_date else null end) as finishing_start_date,
								(case when task_number=64 then task_finish_date else null end) as finishing_end_date,
								(case when task_number=84 then task_start_date else null end) as cutting_start_date,
								(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
								(case when task_number=86 then task_start_date else null end) as sewing_start_date,
								(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
								(case when task_number=110 then task_start_date else null end) as exfact_start_date,
								(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
								(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
								(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
								from tna_process_mst
								where status_active=1 and po_number_id in($po_id_all)");
				$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
				$tna_date_task_arr=array();
				foreach($tna_start_sql as $row)
				{
					if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
					{
						if($tna_fab_start=="")
						{
							$tna_fab_start=$row[csf("fab_booking_start_date")];
						}
					}


					if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
					}
					if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
					}
					if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
					}
					if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
					}

					if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
					}
					if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
					}
					if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
					}
				}

	//------------------------------ Query for TNA end-----------------------------------
	
	if(count($tna_date_task_arr)>0){
	?>

	<fieldset id="div_size_color_matrix" style="max-width:1000;margin-top:10%;">

	
	
        <legend>TNA Information</legend>
        <!--<span style="font-size:180; font-weight:bold;"></span>-->
        <table width="100%" style="border:1px solid black;font-size:12px; font-family:Arial Narrow;" border="1" cellpadding="2" cellspacing="0" rules="all">
            <tr>
            	<td rowspan="2" align="center" valign="top">SL</td>
            	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
                <td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
                <td colspan="2" align="center" valign="top"><b>Knitting</b></td>
                <td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
                <td colspan="2" align="center" valign="top"><b>Finish Fabric Prod.</b></td>
                <td colspan="2" align="center" valign="top"><b>Cutting </b></td>
                <td colspan="2" align="center" valign="top"><b>Sewing </b></td>
                <td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
            </tr>
            <tr>
            	<td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

            </tr>
            <?
			$i=1;
			foreach($tna_date_task_arr as $order_id=>$row)
			{
				 //$tna_date_task_arr//knitting_start_date dying_start_date finishing_start_date cutting_start_date sewing_start_date exfact_start_date
				?>
                <tr>
                	<td><? echo $i; ?></td>
                    <td><? echo $po_num_arr[$order_id]; ?></td>
                    <td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
                	<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
                </tr>
                <?
				$i++;
			}
			?>

        </table>
		
        </fieldset>
		<?php
				}?>
		</div>
        <?
		}// fabric Source End
		if($isYarnPurchseValidate==2)
		{
			?>
            <br>
			<table align="left" width="350px" style="border:1px solid black;font-size:12px; font-family:Arial Narrow;" border="1" cellspacing="0" rules="all">
				<tr>
					<th colspan="3">Yarn Purchase Requisition Info</th>
				</tr>
				<tr>
					<th width="120">Job No</th>
					<th width="130">Purchase Req. No</th>
					<th>Qty.</th>
				</tr>
                
                <?
				$sqlYarnReq="select a.requ_no, b.job_no, sum(b.quantity) as qty from inv_purchase_requisition_mst a, inv_purchase_requisition_dtls b where a.id=b.mst_id and b.job_no='$job_no' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.requ_no, b.job_no";
				$sqlYarnReqRes=sql_select($sqlYarnReq);
				foreach($sqlYarnReqRes as $row)
				{
				?>
                <tr>
					<td width="120"><?=$row[csf("job_no")]; ?></td>
					<td width="130"><?=$row[csf("requ_no")]; ?></td>
					<td align="right"><?=number_format($row[csf("qty")],2); ?></td>
				</tr>
                
                <?
				}
				?>
        	</table>
            <br><br><br>
		<? } 
		//echo get_spacial_instruction($txt_booking_no,"97%",118);
		$mst_id=$txt_booking_no; $width="100%"; $entry_form=88;
		
			if ($entry_form != '') {$entry_form_con = " and entry_form=$entry_form";}
			//echo "select id, terms from  wo_booking_terms_condition where   booking_no='" . str_replace("'", "", $mst_id) . "' $entry_form_con   order by id";
			$data_array = sql_select("select id, terms from  wo_booking_terms_condition where   booking_no='" . str_replace("'", "", $mst_id) . "' $entry_form_con   order by id asc");
			//echo "select id, terms from  wo_booking_terms_condition where   booking_no='" . str_replace("'", "", $mst_id) . "' $entry_form_con   order by id asc";
			$tot_row=count($data_array)/2;
			//echo $tot_row;
			$k=1;
			foreach($data_array as $row)
			{
				if($k<=$tot_row)
				{
				$term_bookingArr[$row[csf('id')]]['terms']=$row[csf('terms')];
				}
				else
				{
				$other_term_bookingArr[$row[csf('id')]]['terms']=$row[csf('terms')];	
				}
				$k++;
			}
			
 if (count($data_array) > 0) {
		?>
        <br>
        <table align="left"  width="<?=$width;?>" align="center"   border="0" cellpadding="0" cellspacing="0" >
        <tr>
        <td valign="top">
        
        <table   width="650" class="rpt_table"   align="center"  border="1" cellpadding="0" cellspacing="0" rules="all">
        <thead>
            <tr style="border:1px solid black;">
            <th width="3%" style="border:1px solid black;">Sl</th>
            <th width="45%" style="border:1px solid black;">Special Instruction</th>
            </tr>
        </thead>
        <tbody>
		<?
		
			//print_r($term_bookingArr);
		$sl=1;
				foreach ($term_bookingArr as $term=>$row) {
					?>
					<tr id="settr_1" align="" style="border:1px solid black;">
					<td align="center" style="border:1px solid black;text-align:center"><?=$sl;?></td>
				   <td style="border:1px solid black; font-weight:bold"><?=$row['terms'];?></td>
					<?
					$sl++;
					}
				
		?>
	</tbody>
	</table>
    </td>
    <!--1st part end-->
    <?
	$sl2=$sl;
    if (count($other_term_bookingArr) > 0) {
	?>
		<td valign="top">
        	<table  width="650" class="rpt_table"   align="center"  border="1" cellpadding="0" cellspacing="0" rules="all">
        <thead>
            <tr style="border:1px solid black;">
            <th width="3%" style="border:1px solid black;" >Sl</th>
            <th width="45%" style="border:1px solid black;">Special Instruction</th>
            </tr>
        </thead>
        <tbody>
		<?
				foreach ($other_term_bookingArr as $term2=>$row2) {
					?>
					<tr id="settr_2" align="" style="border:1px solid black;">
					<td align="center" style="border:1px solid black; text-align:center"><?=$sl2;?></td>
				   <td style="border:1px solid black; font-weight:bold"><?=$row2['terms'];?></td>
					<?
					$sl2++;
					}
				
		?>
	</tbody>
	</table>
    
        </td> 
        <?
	}
		?>   
    </tr>
    </table>
	<br><br><br><br>
    <?
 }
	?>	
	 <table> 
	 <tr>
	 <td><td> 
	 </tr>
	 </table>
	<br>
	<?
	

	$department_name_library=return_library_array( "select id,department_name from  lib_department where status_active=1 and is_deleted=0 order by  department_name", "id", "department_name"  );

	$sql_responsible= sql_select("select responsible_dept,	responsible_person,	reason from wo_booking_dtls where booking_no =$txt_booking_no and fin_fab_qnty>0  and status_active=1 ");
	if(count($sql_responsible)>0)
	{
	?>
	<div>
	<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
	<tr>
	<td>
	<b>SL</b>
	</td>
	<td>
	<b>Responsible Dept.</b>
	</td>
	<td>
	<b>Responsible person</b>
	</td>
	<td>
	<b>Reason</b>
	</td>
	</tr>
	<?
	$ir=1;
	foreach($sql_responsible as $sql_responsible_row)
	{
	?>
	 <tr>
	 <td>
	 <?  echo $ir; ?>
	 </td>
	  <td>
	 <?
	 $responsible_dept_st="";
	 $responsible_dept_arr=explode( ",",$sql_responsible_row[csf('responsible_dept')]);
	 foreach($responsible_dept_arr as $key => $value)
	 {
		 $responsible_dept_st.= $department_name_library[$value].", ";
	 }
	 echo rtrim($responsible_dept_st,", ");
	 ?>
	 </td>
	 <td>
	<?  echo $sql_responsible_row[csf('responsible_person')]; ?>
	 </td>
	 <td>
	  <?  echo $sql_responsible_row[csf('reason')]; ?>
	 </td>
	 </tr>
	<?
	$ir++;

	}
	?>
	</table>
	</div>
	<?
	}
	?>
	<br/>
    

        

         <!--<br><br><br><br>-->
         <div style="font-family:Arial Narrow;">
         <?
		 	echo signature_table(1, $cbo_company_name, "1330px");
		 ?>
         </div>
       </div>
	   </div>
       <?
	$emailBody=ob_get_contents();
	//ob_clean();
	if($is_mail_send==1){
		/*$req_approved=return_field_value("id", "ELECTRONIC_APPROVAL_SETUP", "PAGE_ID = 336 and is_deleted=0");
		$is_approved=return_field_value("IS_APPROVED", "WO_BOOKING_MST", "STATUS_ACTIVE = 1 and is_deleted=0 and booking_no='$txt_booking_no'");
		if($req_approved && $is_approved==1){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Approved</h1>";
		}
		elseif($req_approved && $is_approved==0){
			$emailBody.="<h1 style='border:1px sloid #0ff;'>Draft</h1>";
		}
	*/		
		
		$sql = "SELECT c.email_address as EMAIL FROM mail_group_mst a, mail_group_child b, user_mail_address c where b.mail_group_mst_id=a.id and a.mail_item=87 and b.mail_user_setup_id=c.id and a.company_id =$cbo_company_name";
		$mail_sql_res=sql_select($sql);
		
		$mailArr=array();
		foreach($mail_sql_res as $row)
		{
			$mailArr[$row[EMAIL]]=$row[EMAIL]; 
		}
		
		$supplier_id=$nameArray[0][csf('supplier_id')];
		$supplier_mail=return_field_value("email", "lib_supplier", "status_active=1 and is_deleted=0 and id=$supplier_id ");

		
		$mailArr=array();
		if($mail_id!=''){$mailArr[]=$mail_id;}
		if($supplier_mail_arr[$supplier_id]!=''){$mailArr[]=$supplier_mail;}
		
		$to=implode(',',$mailArr);
		$subject="Fabric Booking Auto Mail";
		
		if($to!=""){
			require '../../../vendor/phpmailer/phpmailer/PHPMailerAutoload.php';
			require_once('../../../auto_mail/setting/mail_setting.php');
			$header=mailHeader();
			sendMailMailer( $to, $subject, $emailBody );
		}
	}
	exit();
}






if($action=="show_fabric_booking_report")
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$report_type=str_replace("'","",$report_type);
	$imge_arr=return_library_array( "select master_tble_id,image_location from common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$season_arr=return_library_array( "select id,season_name from lib_buyer_season",'id','season_name');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');

	$sql="select id from electronic_approval_setup where company_id=$cbo_company_name and page_id in(413,2606) and is_deleted=0";
	// echo $sql;die;
	$res_result_arr = sql_select($sql);
	$approval_arr=array();
		foreach($res_result_arr as $row){
			$approval_arr[$row["ID"]]["ID"]=$row["ID"];
		}
	
	$mainBookingNo="";
	
	$sqlMainBooking=sql_select("select booking_no from wo_booking_dtls where po_break_down_id in (".str_replace("'","",$txt_order_no_id).") and status_active=1 and is_deleted=0 and booking_type=1 and is_short=2 group by booking_no");
	foreach($sqlMainBooking as $row)
	{
		if($mainBookingNo=="") $mainBookingNo=$row[csf('booking_no')]; else $mainBookingNo.=','.$row[csf('booking_no')];
	}
	unset($sqlMainBooking)
	
	?>

	<div style="width:1330px" align="center">
    										<!--    Header Company Information         -->
        <?php
	$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12");
	list($nameArray_approved_row) = $nameArray_approved;
	$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
	list($nameArray_approved_date_row) = $nameArray_approved_date;
	$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
	list($nameArray_approved_comments_row) = $nameArray_approved_comments;
	$path = str_replace("'", "", $path);
	if ($path == "") {
		$path = '../../';
	}
	?>
    <table width="1330" cellpadding="0" cellspacing="0" style="border:1px solid black">
        <tr>
            <td width="100">
				<?
                if($report_type==1)
                {
                    ?><img  src='../../<? echo $imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' /><?
                }
                else if($report_type==2)
                {
                    ?><img  src='../<? echo $imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' /><?
                }
                else
                {
                    ?><img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' /><?
                }
                ?>
            </td>
            <td>
                <table width="980" cellpadding="0" cellspacing="0">
                    <tr>
                        <td align="center" style="font-size:20px;"><?php echo $company_library[$cbo_company_name]; ?></td>
                        <td rowspan="2" width="400" valign="top">
                            <span style="font-size:16px">&nbsp;&nbsp;&nbsp;&nbsp;<b>Job No:&nbsp;<? echo trim($txt_job_no,"'"); ?></b><br>
                            <font style="word-break:break-all">&nbsp;&nbsp;&nbsp;&nbsp;Main Booking No:&nbsp;<?=trim($mainBookingNo,"'"); ?></font><br>
                                <?
                                if($nameArray_approved_row[csf('approved_no')]>1)
                                {
                                    ?>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;  <strong> Revised No: &nbsp;<? echo $nameArray_approved_row[csf('approved_no')]-1; ?></strong><?
                                }
                                ?>
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td align="center" style="font-size:14px">
                            <?
                            $nameArray=sql_select( "select plot_no, level_no, road_no, block_no, country_id, province, city, zip_code, email, website from lib_company where id=$cbo_company_name");
                            foreach ($nameArray as $result)
                            {
                                ?>
                                Plot No: <? echo $result[csf('plot_no')]; ?>
                                Level No: <? echo $result[csf('level_no')]?>
                                Road No: <? echo $result[csf('road_no')]; ?>
                                Block No: <? echo $result[csf('block_no')];?>
                                City No: <? echo $result[csf('city')];?>
                                Zip Code: <? echo $result[csf('zip_code')]; ?>
                                Province No: <?php echo $result[csf('province')]; ?>
                                Country: <? echo $country_arr[$result[csf('country_id')]]; ?><br>
                                Email Address: <? echo $result[csf('email')];?>
                                Website No: <? echo $result[csf('website')];?>
                                <?
                            }
                            ?>
                        </td>
                    </tr>
                    <tr>
                        <td align="center" style="font-size:16px">
                            <strong><? if($report_type==1) echo str_replace("'","",$report_title);else echo 'Short Fabric Booking';?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}if(str_replace("'","",$id_approved_id) ==3){ echo "(Partial Approved)";}; ?> </font></strong>
                        </td>
                        <td width="400"style="font-size:20px"></td>
                    </tr>
                </table>
            </td>
            <td width="250" id="barcode_img_id"></td>
        </tr>
    </table>

                   <?
					$job_no=''; $total_set_qnty=0; $colar_excess_percent=0; $cuff_excess_percent=0;
					$nameArray=sql_select( "select a.INSERTED_BY,a.booking_no, a.booking_date, a.supplier_id, a.pay_mode, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.remarks, b.job_no, b.buyer_name, b.style_ref_no, b.gmts_item_id, b.order_uom, b.total_set_qnty, b.style_description, b.season_buyer_wise as season, b.product_dept, b.product_code, b.pro_sub_dep, b.dealing_marchant, b.factory_marchant,a.is_approved from wo_booking_mst a, wo_po_details_master b where  a.job_no=b.job_no and a.booking_no=$txt_booking_no");
					
					$poQnty="";
					foreach ($nameArray as $result)
					{
						$total_set_qnty=$result[csf('total_set_qnty')];
						$colar_excess_percent=$result[csf('colar_excess_percent')];
						$cuff_excess_percent=$result[csf('cuff_excess_percent')];
						$is_approved=$result[csf('is_approved')];
						$INSERTED_BY=$result[csf('INSERTED_BY')];
						$po_no="";
						$shipment_date="";	$internal_ref="";	$file_no="";
						$sql_po= "select po_number,grouping,file_no,MIN(pub_shipment_date) pub_shipment_date,sum(po_quantity) as po_quantity from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number,grouping,file_no";
						$data_array_po=sql_select($sql_po);
						foreach ($data_array_po as $row_po)
						{
							$po_no.=$row_po[csf('po_number')].", ";
							$po_id_arr[$result[csf('po_break_down_id')]]=$result[csf('po_break_down_id')];
							$shipment_date.=change_date_format($row_po[csf('pub_shipment_date')],'dd-mm-yyyy','-').", ";
							$internal_ref.=$row_po[csf('grouping')].", ";
							$file_no.=$row_po[csf('file_no')].", ";
							$poQnty+=$row_po[csf('po_quantity')];
						}

						$lead_time="";
						if($db_type==0)
						{
						$sql_lead_time= "select DATEDIFF(pub_shipment_date,po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
						}

						if($db_type==2)
						{
						$sql_lead_time= "select (pub_shipment_date-po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
						}
						$data_array_lead_time=sql_select($sql_lead_time);
						foreach ($data_array_lead_time as $row_lead_time)
						{
							$lead_time.=$row_lead_time[csf('date_diff')].",";
							//$shipment_date.=change_date_format($row_po['pub_shipment_date'],'dd-mm-yyyy','-').",";
						}

						$po_received_date="";
						$sql_po_received_date= "select MIN(po_received_date) as po_received_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
						$data_array_po_received_date=sql_select($sql_po_received_date);
						foreach ($data_array_po_received_date as $row_po_received_date)
						{
							$po_received_date=change_date_format($row_po_received_date[csf('po_received_date')],'dd-mm-yyyy','-');
							//$shipment_date.=change_date_format($row_po['pub_shipment_date'],'dd-mm-yyyy','-').",";
						}
						$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date, MIN(insert_date) as insert_date,shiping_status from wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number,shiping_status";
						$data_array_po=sql_select($sql_po);
						foreach ($data_array_po as $rows)
						{
							$daysInHand.=(datediff('d',date('d-m-Y',time()),$rows[csf('pub_shipment_date')])-1).",";
							$booking_date=$result[csf('update_date')];
							if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
							{
								$booking_date=$result[csf('insert_date')];
							}
							$WOPreparedAfter.=(datediff('d',$rows[csf('insert_date')],$booking_date)-1).",";

							if($rows[csf('shiping_status')]==1)
							{
							$shiping_status.= "FP".",";
							}
							else if($rows[csf('shiping_status')]==2)
							{
							$shiping_status.= "PS".",";
							}
							else if($rows[csf('shiping_status')]==3)
							{
							$shiping_status.= "FS".",";
							}
						}

					$file=rtrim($file_no,", ");//rtrim($po_no,", ")
					$file_all=array_unique(explode(",",$file));

					$file='';
					foreach($file_all as $file_id)
					{
						if($file=="") $file_cond=$file_id; else $file_cond.=", ".$file_id;
					}

					$varcode_booking_no=$result[csf('booking_no')];

				?>
       <table width="100%" style="border:1px solid black" >
            <tr>
                <td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
            </tr>
            <tr>
                <td width="110"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
                <td width="130">:&nbsp;<span style="font-size:18px"><b><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></b></span></td>
                <td width="110"><span style="font-size:12px"><b>Dept.</b></span></td>
                <td width="130">:&nbsp;<? echo $product_dept[$result[csf('product_dept')]] ; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></td>
                <td width="110"><span style="font-size:12px"><b>Order Qty.</b></span></td>
                <td width="130">:&nbsp;<? echo $po_qnty_tot1." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?></td>
            </tr>
            <tr>
                <td style="font-size:12px"><b>Garments Item</b></td>
                <td>:&nbsp;
				<?
				$gmts_item_name="";
				$gmts_item=explode(',',$result[csf('gmts_item_id')]);
				for($g=0;$g<=count($gmts_item); $g++)
				{
					$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
				}
				echo rtrim($gmts_item_name,',');
				?>
                </td>
                <td style="font-size:12px"><b>Booking Date</b></td>
                <td>:&nbsp;<? echo change_date_format($result[csf('booking_date')],'dd-mm-yyyy','-');?>&nbsp;&nbsp;&nbsp;</td>
                <td style="font-size:18px"><b>Style Ref.</b>   </td>
                <td style="font-size:18px">:&nbsp;<b><? echo $style_sting=$result[csf('style_ref_no')];?> </b>   </td>
            </tr>
             <tr>
                <td style="font-size:12px"><b>Style Des.</b></td>
                <td>:&nbsp;<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
                <td style="font-size:12px"><b>Lead Time </b>   </td>
                <td>:&nbsp;<?=implode(",",array_filter(array_unique(explode(",",$lead_time)))); ?> </td>
                <td style="font-size:12px"><b>Factory Merchandiser</b></td>
                <td>:&nbsp;<? echo $marchentrArr[$result[csf('factory_marchant')]]; ?></td>
            </tr>

            <tr>
                <td style="font-size:18px"><b>Supplier Name</b>   </td>
                <td style="font-size:18px">:&nbsp; <b><?
				if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3){
					echo $company_library[$result[csf('supplier_id')]];
					}
					else{
					echo $supplier_name_arr[$result[csf('supplier_id')]];
					}
				//echo $supplier_name_arr[$result[csf('supplier_id')]];?></b>    </td>
                <td style="font-size:12px"><b>Delivery Date</b></td>
               	<td>:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
                <td style="font-size:18px"><b>Booking No </b>   </td>
                <td style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?></td>
            </tr>
            <tr>
                <td style="font-size:12px"><b>Season</b></td>
                <td>:&nbsp;<? echo $season_arr[$result[csf('season')]]; ?></td>
                <td style="font-size:12px"><b>Attention</b></td>
                <td>:&nbsp;<? echo $result[csf('attention')]; ?></td>
                <td style="font-size:12px"><b>Po Received Date</b></td>
                <td>:&nbsp;<? echo $po_received_date; ?></td>
            </tr>
           <tr>
               <td style="font-size:18px"><b>Order No</b></td>
                <td style="font-size:18px" colspan="3">:&nbsp;<b><?=implode(",",array_filter(array_unique(explode(",",$po_no)))); ?></b></td>
                <td style="font-size:17px"><b>Internal Ref</b></td>
                <td style="font-size:16px">:&nbsp;<b><?=implode(",",array_filter(array_unique(explode(",",$internal_ref)))); ?></b></td>
            </tr>
            <tr>
               <td style="font-size:12px"><b>Shipment Date</b></td>
                <td colspan="3"> :&nbsp;<?=implode(",",array_filter(array_unique(explode(",",$shipment_date)))); ?></td>
                <td style="font-size:17px"><b>File No</b></td>
                <td style="font-size:16px">:&nbsp;<b><?=implode(",",array_filter(array_unique(explode(",",$file_cond)))); ?></b></td>
            </tr>
             <tr>
               <td style="font-size:12px"><b>WO Prepared After</b></td>
               <td> :&nbsp;<?=implode(",",array_filter(array_unique(explode(",",$WOPreparedAfter)))).' Days' ?></td>

               <td style="font-size:12px"><b>Ship.days in Hand</b></td>
               <td> :&nbsp;<?=implode(",",array_filter(array_unique(explode(",",$daysInHand)))).' Days'?></td>

               <td style="font-size:12px"><b>Ex-factory status</b></td>
               <td> :&nbsp;<?=implode(",",array_filter(array_unique(explode(",",$shiping_status)))); ?></td>
            </tr>
            <tr>
            	<td style="font-size:12px"><b>Remarks</b></td>
                <td colspan="5"> :&nbsp;<? echo $result[csf('remarks')]; ?></td>
            </tr>
        </table>
        <?
			}
		?>

      <br/>   									 <!--  Here will be the main portion  -->

     <?
	 $costing_per="";
	 $costing_per_qnty=0;
	 $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
	 if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;

			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";
				$costing_per_qnty=1;

			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;

			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;

			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;

			}
			$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");;
  //echo $process_loss_method."gggg";
	 ?>
     <?
	if(str_replace("'","",$cbo_fabric_source)==1 || str_replace("'","",$cbo_fabric_source)==3)
	  {
	$nameArray_fabric_description= sql_select("SELECT  a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,avg(b.process_loss_percent) as process_loss_percent,sum(rmg_qty) as rmg_qty FROM wo_pre_cost_fabric_cost_dtls a,wo_booking_dtls b where b.booking_no =$txt_booking_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.status_active=1 and
    b.is_deleted=0  and b.grey_fab_qnty>0 group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width order by a.body_part_id");
	 ?>
     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <tr align="center"><th colspan="4" align="left">Body Part</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
        <td  rowspan="9" width="50"><p>Total  Finish Fabric <? if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
        <td  rowspan="9" width="50"><p>Total Grey Fabric <? if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
        <td  rowspan="9" width="50"><p>Process Loss % </p></td>
       </tr>
     <tr align="center"><th colspan="4" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="4" align="left">Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="4" align="left">Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='2' >&nbsp</td>";
			else         		               echo "<td colspan='2' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="4" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		       echo "<td colspan='2' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="4" align="left">Dia/Width</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		              echo "<td colspan='2' align='center'>". $result_fabric_description[csf('dia_width')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="4" align="left">RMG Qty</th>
        <?
		$tot_rmg_qty=0;
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			$tot_rmg_qty+=$result_fabric_description[csf('rmg_qty')];
			if( $result_fabric_description[csf('rmg_qty')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		              echo "<td colspan='2' align='center'>". $result_fabric_description[csf('rmg_qty')]."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*2+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>
       <tr>
            <th width="100" align="left">Fabric Color</th>
            <th width="100" align="left"> Body Color</th>
            <th width="100" align="left">Article No</th>
            <th width="80" align="left">Lab Dip No</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			  echo "<th width='50'>Finish</th><th width='50' >Gray</th>";
		}
		?>

       </tr>
       <?

		$articalNoArr=array();
		$articalNo=sql_select("select color_number_id, article_number from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and status_active=1 and is_deleted=0 group by color_number_id, article_number");
		  foreach($articalNo as $row)
		  {
			 $articalNoArr[$row[csf("color_number_id")]].=$row[csf("article_number")]."," ;
		  }
		  unset($articalNo);

		  
		$color_library=return_library_array( "select id,color_name from lib_color where status_active =1 and is_deleted=0", "id", "color_name");
		  $gmt_color_library=array();
		  $gmt_color_data=sql_select("select gmts_color_id, fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("fabric_color_id")]].=$color_library[$gmt_color_row[csf("gmts_color_id")]]."," ;
		  }
	      $grand_total_fin_fab_qnty=0; $grand_total_grey_fab_qnty=0; $grand_totalcons_per_finish=0; $grand_totalcons_per_grey=0;
		$color_wise_wo_sql=sql_select("select fabric_color_id, gmts_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id,gmts_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
           <td  width="100" align="left"><? echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]]; ?></td>
            <td width="100" align="left"><? echo  $color_library[$color_wise_wo_result[csf('gmts_color_id')]]; ?> </td>
            <td width="100" align="left"><? echo implode(",",array_filter(array_unique(explode(",",$articalNoArr[$color_wise_wo_result[csf('gmts_color_id')]])))); ?></td>
            <td width="80" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_grey_fab_qnty=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {



				if($db_type==2)
				{
				$color_wise_wo_sql_qnty=sql_select("select sum(b.fin_fab_qnty) as fin_fab_qnty,sum(b.grey_fab_qnty) as grey_fab_qnty
												  FROM
												  wo_pre_cost_fabric_cost_dtls a,
												  wo_booking_dtls b
												  WHERE
												  b.booking_no =$txt_booking_no  and
												  a.id=b.pre_cost_fabric_cost_dtls_id and
												   nvl(a.body_part_id,0)=nvl('".$result_fabric_description[csf('body_part_id')]."',0) and
												   nvl(a.color_type_id,0)=nvl('".$result_fabric_description[csf('color_type_id')]."',0) and
												   nvl(a.construction,0)=nvl('".$result_fabric_description[csf('construction')]."',0) and
												   nvl(a.composition,0)=nvl('".$result_fabric_description[csf('composition')]."',0) and
												   nvl(a.gsm_weight,0)=nvl('".$result_fabric_description[csf('gsm_weight')]."',0) and
												   nvl(b.dia_width,0)=nvl('".$result_fabric_description[csf('dia_width')]."',0) and
												   nvl(b.fabric_color_id,0)=nvl(".$color_wise_wo_result[csf('fabric_color_id')].",0) and
												   nvl(b.gmts_color_id,0)=nvl(".$color_wise_wo_result[csf('gmts_color_id')].",0) and

												  b.status_active=1 and
												  b.is_deleted=0 and b.grey_fab_qnty>0");
				}

				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select sum(b.fin_fab_qnty) as fin_fab_qnty,sum(b.grey_fab_qnty) as grey_fab_qnty
												  FROM
												  wo_pre_cost_fabric_cost_dtls a,
												  wo_booking_dtls b
												  WHERE
												  b.booking_no =$txt_booking_no  and
												  a.id=b.pre_cost_fabric_cost_dtls_id and
												   a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												   a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												   a.construction='".$result_fabric_description[csf('construction')]."' and
												   a.composition='".$result_fabric_description[csf('composition')]."' and
												   a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												   b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												   b.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
												   b.gmts_color_id=".$color_wise_wo_result[csf('gmts_color_id')]." and
												  b.status_active=1 and
												  b.is_deleted=0 and b.grey_fab_qnty>0");
				}


				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;
			$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('fin_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2);
			$total_grey_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo number_format($total_grey_fab_qnty,2); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>

            <td align="right">
            <?
			if($process_loss_method==1)
			{
				$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
			}

			if($process_loss_method==2)
			{
				$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
			}
			echo number_format($process_percent,2);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr>
        <td  width="100" align="left">&nbsp;</td>
        <td  width="100" align="left">&nbsp;</td>
        <td  width="100" align="left">&nbsp;</td>
        <td  width="80" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				if($db_type==2)
				{
				$color_wise_wo_sql_qnty=sql_select("select sum(b.fin_fab_qnty) as fin_fab_qnty,sum(b.grey_fab_qnty) as grey_fab_qnty
												  FROM
												  wo_pre_cost_fabric_cost_dtls a,
												  wo_booking_dtls b
												  WHERE
												  b.booking_no =$txt_booking_no  and
												  a.id=b.pre_cost_fabric_cost_dtls_id and
												  nvl(a.body_part_id,0)=nvl('".$result_fabric_description[csf('body_part_id')]."',0) and
												  nvl(a.color_type_id,0)=nvl('".$result_fabric_description[csf('color_type_id')]."',0) and
												  nvl(a.construction,0)=nvl('".$result_fabric_description[csf('construction')]."',0) and
												  nvl(a.composition,0)=nvl('".$result_fabric_description[csf('composition')]."',0) and
												  nvl(a.gsm_weight,0)=nvl('".$result_fabric_description[csf('gsm_weight')]."',0) and
												  nvl(b.dia_width,0)=nvl('".$result_fabric_description[csf('dia_width')]."',0) and
												  b.status_active=1 and
												  b.is_deleted=0 and b.grey_fab_qnty>0
												  ");
				}

				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select sum(b.fin_fab_qnty) as fin_fab_qnty,sum(b.grey_fab_qnty) as grey_fab_qnty
												  FROM
												  wo_pre_cost_fabric_cost_dtls a,
												  wo_booking_dtls b
												  WHERE
												  b.booking_no =$txt_booking_no  and
												  a.id=b.pre_cost_fabric_cost_dtls_id and
												  a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												  a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												  a.construction='".$result_fabric_description[csf('construction')]."' and
												  a.composition='".$result_fabric_description[csf('composition')]."' and
												  a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												  b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												  b.status_active=1 and
												  b.is_deleted=0 and b.grey_fab_qnty>0
												  ");
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;?></td><td width='50' align='right' > <? echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2);?></td>
            <?
			}
			?>
            <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo number_format($grand_total_grey_fab_qnty,2);?></td>
            <td align="right">
            <?
            if($process_loss_method==1)
			{
				$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;
			}

			if($process_loss_method==2)
			{
				$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;
			}
			echo number_format($totalprocess_percent,2);
			?>
            </td>
            </tr>
    </table>

    <br/>
    <?
	  }
    ?>
        <?

	 if(str_replace("'","",$cbo_fabric_source)==2 || str_replace("'","",$cbo_fabric_source)==4)
	  {

	$nameArray_fabric_description= sql_select("SELECT  a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,avg(b.process_loss_percent) as process_loss_percent,avg(rmg_qty) as rmg_qty FROM wo_pre_cost_fabric_cost_dtls a,wo_booking_dtls b where b.booking_no =$txt_booking_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.status_active=1 and
    b.is_deleted=0 and b.grey_fab_qnty>0 group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width order by a.body_part_id");
	 ?>
     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <tr align="center"><th colspan="3" align="left">Body Part</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
        <!-- <td  rowspan="9" width="50"><p>Total Fabric <? if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td> -->
		<td  rowspan="9" width="50"><p>Total Fabric (<?=$unit_of_measurement[trim($cbouom ,"'")]; ?>)</p></td> 
        <td  rowspan="9" width="50"><p>Rate</p></td>
        <td  rowspan="9" width="50"><p>Amount </p></td>
       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>". $result_fabric_description[csf('dia_width')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">RMG Qty</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('rmg_qty')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>". $result_fabric_description[csf('rmg_qty')]."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>
       <tr>
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left"> Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			  echo "<th width='50'>Fab Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
		}
		?>

       </tr>
       <?

		$color_library=return_library_array( "select id,color_name from lib_color where status_active =1 and is_deleted=0", "id", "color_name");
		  $gmt_color_library=array();
		  $gmt_color_data=sql_select("select gmts_color_id,fabric_color_id
		  FROM
		  wo_booking_dtls
		  WHERE
		  booking_no =$txt_booking_no");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("fabric_color_id")]].=$color_library[$gmt_color_row[csf("gmts_color_id")]]."," ;
		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_grey_fab_qnty=0;
			$grand_totalcons_per_finish=0;
			$grand_totalcons_per_grey=0;
			$color_wise_wo_sql=sql_select("select fabric_color_id
										  FROM
										  wo_booking_dtls
										  WHERE
										  booking_no =$txt_booking_no and
										  status_active=1 and
                                          is_deleted=0
										  group by fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
           <td  width="120" align="left">
			<?

			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];

			?></td>
            <td  width="120" align="left">
			<?
			//echo $gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]];
			echo rtrim($gmt_color_library[$color_wise_wo_result['fabric_color_id']],",");
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_grey_fab_qnty=0;
			$total_amount=0;
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {



				if($db_type==2)
				{
				$color_wise_wo_sql_qnty=sql_select("select sum(b.fin_fab_qnty) as fin_fab_qnty,sum(b.grey_fab_qnty) as grey_fab_qnty, avg(b.rate) as rate
												  FROM
												  wo_pre_cost_fabric_cost_dtls a,
												  wo_booking_dtls b
												  WHERE
												  b.booking_no =$txt_booking_no  and
												  a.id=b.pre_cost_fabric_cost_dtls_id and
												   nvl(a.body_part_id,0)=nvl('".$result_fabric_description[csf('body_part_id')]."',0) and
												   nvl(a.color_type_id,0)=nvl('".$result_fabric_description[csf('color_type_id')]."',0) and
												   nvl(a.construction,0)=nvl('".$result_fabric_description[csf('construction')]."',0) and
												   nvl(a.composition,0)=nvl('".$result_fabric_description[csf('composition')]."',0) and
												   nvl(a.gsm_weight,0)=nvl('".$result_fabric_description[csf('gsm_weight')]."',0) and
												   nvl(b.dia_width,0)=nvl('".$result_fabric_description[csf('dia_width')]."',0) and
												   nvl(b.fabric_color_id,0)=nvl(".$color_wise_wo_result[csf('fabric_color_id')].",0) and
												  b.status_active=1 and
												  b.is_deleted=0 and b.fin_fab_qnty>0");
				}

				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select sum(b.fin_fab_qnty) as fin_fab_qnty,sum(b.grey_fab_qnty) as grey_fab_qnty, avg(b.rate) as rate
												  FROM
												  wo_pre_cost_fabric_cost_dtls a,
												  wo_booking_dtls b
												  WHERE
												  b.booking_no =$txt_booking_no  and
												  a.id=b.pre_cost_fabric_cost_dtls_id and
												  a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												  a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												  a.construction='".$result_fabric_description[csf('construction')]."' and
												  a.composition='".$result_fabric_description[csf('composition')]."' and
												  a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												  b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												  b.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
												  b.status_active=1 and
												  b.is_deleted=0 and b.fin_fab_qnty>0");
				}


				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty

			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2) ;
			$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('rate')],2);
			//$total_grey_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			$amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
			if($amount!="")
			{
			echo number_format($amount,2);
			$total_amount+=$amount;
			}

			/*if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')],2);
			}*/
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right"><? echo number_format($total_amount,2);?></td>
            </tr>
         <?
		}
		?>
        <tr>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				if($db_type==2)
				{
				$color_wise_wo_sql_qnty=sql_select("select sum(b.fin_fab_qnty) as fin_fab_qnty,sum(b.grey_fab_qnty) as grey_fab_qnty, avg(b.rate) as rate
												  FROM
												  wo_pre_cost_fabric_cost_dtls a,
												  wo_booking_dtls b
												  WHERE
												  b.booking_no =$txt_booking_no  and
												  a.id=b.pre_cost_fabric_cost_dtls_id and
												  nvl(a.body_part_id,0)=nvl('".$result_fabric_description[csf('body_part_id')]."',0) and
												  nvl(a.color_type_id,0)=nvl('".$result_fabric_description[csf('color_type_id')]."',0) and
												  nvl(a.construction,0)=nvl('".$result_fabric_description[csf('construction')]."',0) and
												  nvl(a.composition,0)=nvl('".$result_fabric_description[csf('composition')]."',0) and
												  nvl(a.gsm_weight,0)=nvl('".$result_fabric_description[csf('gsm_weight')]."',0) and
												  nvl(b.dia_width,0)=nvl('".$result_fabric_description[csf('dia_width')]."',0) and
												  b.status_active=1 and
												  b.is_deleted=0 and b.fin_fab_qnty>0
												  ");
				}

				if($db_type==0)
				{
				$color_wise_wo_sql_qnty=sql_select("select sum(b.fin_fab_qnty) as fin_fab_qnty,sum(b.grey_fab_qnty) as grey_fab_qnty, avg(b.rate) as rate
												  FROM
												  wo_pre_cost_fabric_cost_dtls a,
												  wo_booking_dtls b
												  WHERE
												  b.booking_no =$txt_booking_no  and
												  a.id=b.pre_cost_fabric_cost_dtls_id and
												  a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												  a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												  a.construction='".$result_fabric_description[csf('construction')]."' and
												  a.composition='".$result_fabric_description[csf('composition')]."' and
												  a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												  b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												  b.status_active=1 and
												  b.is_deleted=0 and b.fin_fab_qnty>0
												  ");
				}
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],2) ;?></td>
            <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2);?></td>
             <td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2);?></td>
            <?
			}
			?>
            <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
            <td align="right">
           <?
			echo number_format($grand_total_amount,2);
			?>
            </td>
            </tr>
    </table>

    <br/>
    <?
	  }
    ?>



       <?
		if(str_replace("'","",$cbo_fabric_source)==1 || str_replace("'","",$cbo_fabric_source)==3)
		{
		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');
		$yarn_sql_array=sql_select("SELECT min(id) as id,count_id, copm_one_id, percent_one,copm_two_id, percent_two, type_id, sum(cons_qnty) as yarn_required, AVG(rate) as rate from wo_pre_cost_fab_yarn_cost_dtls where job_no='$job_no' and  status_active=1 and is_deleted=0 group by count_id,copm_one_id,percent_one, copm_two_id,percent_two,type_id order by id");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
            <tr>
                <td width="49%" valign="top" align="center">
                <?
				$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id order by a.id");
				if(count($yarn_sql_array)>0)
				{
				?>
                   <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Allocated Yarn</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>


                    <td>Allocated Qty (Kg)</td>
                    </tr>
                    <?
					$total_allo=0;
					$item=return_library_array( "select id, product_name_details from   product_details_master",'id','product_name_details');
					$supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
					//$yarn_sql_array=sql_select("SELECT a.item_id, a.qnty,b.supplier_id,b.lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0");
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?

					echo $item[$row[csf('item_id')]];
					?>
                    </td>
                    <td>
                    <?

					echo $supplier[$row[csf('supplier_id')]];
					?>
                    </td>
                    <td>
					<?

					echo $row[csf('lot')];
					?>
                    </td>
                    <td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>


                    <td></td>
                    <td></td>
                    <td align="right"><? echo number_format($total_allo,4); ?></td>
                    </tr>
                    </table>
                    <?
				}
				else
				{
					$is_yarn_allocated=return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_name and variable_list=18 and item_category_id=1");
					if($is_yarn_allocated==1)
					{
					?>
					<font style=" font-size:30px"><b> Draft</b></font>
                    <?
					}
					else
					{
						echo "";
					}
				}
					?>
                </td>
            </tr>
        </table>
        <br/>
        <?
		}
		$main_sql=sql_select("select d.booking_no FROM wo_booking_mst d WHERE d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0 ");
		$finish_sql= sql_select("select a.id,b.gsm,a.issue_qnty,a.order_id,c.booking_no from inv_finish_fabric_issue_dtls a,product_details_master b,pro_batch_create_mst c where c.booking_no =$txt_booking_no and a.prod_id=b.id and a.batch_id=c.id and a.status_active =1 and a.is_deleted = 0 and b.status_active =1 and b.is_deleted = 0 and c.status_active =1 and c.is_deleted = 0");
		$finish_issue_arr=array();
		foreach ($finish_sql as $row) {
			$finish_issue_arr[$row[csf('booking_no')]]['gsm']= $row[csf('gsm')];
			$finish_issue_arr[$row[csf('booking_no')]]['issue_qnty']+= $row[csf('issue_qnty')];	 	
		} 
		
		$nameArray_fabric_desc= sql_select("select a.body_part_id,a.color_type_id, a.fabric_description, a.gsm_weight,min(a.width_dia_type) as width_dia_type, b.dia_width, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent , avg(b.requirment) as requirment,e.po_number,d.booking_no FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d,wo_po_break_down e WHERE a.job_no=b.job_no  and c.job_no_mst = e.job_no_mst and e.job_no_mst = a.job_no and b.po_break_down_id = e.id and e.id = d.po_break_down_id and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.status_active=1 and d.is_deleted=0 group by a.body_part_id,a.color_type_id,a.fabric_description,a.gsm_weight,b.dia_width,e.po_number,d.booking_no order by a.body_part_id,b.dia_width");
		$fabric_desc_arr=array();
		foreach ($nameArray_fabric_desc as $row) {
			$fabric_desc_arr[$row[csf('booking_no')]]['body_part_id'].= $row[csf('body_part_id')].",";
			$fabric_desc_arr[$row[csf('booking_no')]]['color_type_id'].= $row[csf('color_type_id')].",";	 
			$fabric_desc_arr[$row[csf('booking_no')]]['fabric_description'].= $row[csf('fabric_description')].",";	 
			$fabric_desc_arr[$row[csf('booking_no')]]['gsm_weight'].= $row[csf('gsm_weight')].",";
			$fabric_desc_arr[$row[csf('booking_no')]]['po_number'].= $row[csf('po_number')].",";
			$fabric_desc_arr[$row[csf('booking_no')]]['requirment']= $row[csf('requirment')];	 	
		} 
		//echo '<pre>';print_r($fabric_desc_arr);
		?>


	<div align="left">

	<table border="1" rules="all">
		<thead>   
			<th>Order Number</th>
			<th>Body</th>
			<th>Fabrication</th>
			<th>Budget GSM</th>
			<th>Budget Consumption/dzn</th>
			<th>Finish GSM</th>
			<th>Cutting Consumption/dzn</th>
		</thead>
		<? $i=0;
			foreach($main_sql  as $row){
				$i++;
				$body_part_id=implode(",",array_filter(array_unique(explode(",",$fabric_desc_arr[$row[csf('booking_no')]]['body_part_id']))));
				$color_type_id=implode(",",array_filter(array_unique(explode(",",$fabric_desc_arr[$row[csf('booking_no')]]['color_type_id']))));
				$fabric_description=implode(",",array_filter(array_unique(explode(",",$fabric_desc_arr[$row[csf('booking_no')]]['fabric_description']))));
				$gsm_weight=implode(",",array_filter(array_unique(explode(",",$fabric_desc_arr[$row[csf('booking_no')]]['gsm_weight']))));
				$po_number=implode(",",array_filter(array_unique(explode(",",$fabric_desc_arr[$row[csf('booking_no')]]['po_number']))));
				$req=$fabric_desc_arr[$row[csf('booking_no')]]['requirment'];
				$finish_gsm=$finish_issue_arr[$row[csf('booking_no')]]['gsm'];
				$cutting_qty=($finish_issue_arr[$row[csf('booking_no')]]['issue_qnty']/$po_qnty_tot1)*12;
				?>
				<tr align="center">
				<td>
				<?
				echo $po_number;
				?>
				</td>
				<td>
				<?
				echo $body_part[$body_part_id].",".$color_type[$color_type_id];
				?>
				</td>
				<td>
				<?
				echo $fabric_description;
				?>
				</td>
				<td>
				<?
				echo $gsm_weight;
				?>
				</td>

				<td>
				<?
				echo fn_number_format($req,2);
				?>
				</td>
				<td>
				<?
				echo $finish_gsm;
				?>
				</td>
				<td>
				<?
				echo fn_number_format($cutting_qty,2);
				?>
				</td>

				</tr>
				<?
				}
				?>
	</table>
	</div>
<br>
		<?
		//=====start=======new add=======issue id====18283========18-09-2022====================
		$po_ids=implode(",",$po_id_arr);
	
		$precost_data_arr=get_precost_data(array('company_id'=>$cbo_company_name,'job_no'=>$job_no,'po_id'=>$po_ids));
		$dye_pro_sql="SELECT sum(b.batch_qnty) as batch_qnty,b.po_id from pro_batch_create_mst a,pro_batch_create_dtls b, pro_fab_subprocess c where a.id=b.mst_id and a.id=c.batch_id and c.load_unload_id=2 and a.entry_form=0 and c.entry_form=35 and a.batch_against<>2 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and  b.po_id in(".$po_ids.")  group by b.po_id";

		$dye_pro_sql_data=sql_select($dye_pro_sql);
		
		foreach($dye_pro_sql_data as $row){
			$dye_pro_qnty=$row[csf('batch_qnty')];
		}


		$recvData=sql_select("select a.po_breakdown_id, sum(quantity) as grey_prod_qnty from order_wise_pro_details a, pro_grey_prod_entry_dtls b where a.dtls_id=b.id and a.prod_id=b.prod_id and a.entry_form =2 and a.is_deleted=0 and a.status_active=1 and a.po_breakdown_id in (".$po_ids.") group by a.po_breakdown_id");
		foreach($recvData as $row)
		{
			$KNIT_PRO_QNTY=$row[csf('grey_prod_qnty')];
		}
		unset($recvData);

		/* $recieved_sql="SELECT   po_breakdown_id as po_break_down_id,c.quantity as qnty  FROM INV_ISSUE_MASTER a,INV_TRANSACTION b,ORDER_WISE_PRO_DETAILS c Where a.id=b.mst_id and b.id=c.trans_id and  a.issue_basis=3 and a.entry_form=3 and a.status_active = 1 and b.status_active = 1   AND b.transaction_type=2 and c.trans_type=2 and b.receive_basis = 3  and c.status_active = 1 and  po_breakdown_id in(".$po_ids.")  ";
		echo $recieved_sql;die();

      $yarn_issue_arr=array();
		foreach(sql_select($recieved_sql) as $v)
		$yarn_issue_arr[$v[csf("po_break_down_id")]] +=$v[csf("qnty")];

				/* echo "<pre>";
			 print_r($yarn_issue_arr); 
				  echo "</pre>";die(); */ 
				  $yarn_issue_arr=array();
		$recieved_sql=sql_select("SELECT   po_breakdown_id as po_break_down_id,c.quantity as qnty  FROM INV_ISSUE_MASTER a,INV_TRANSACTION b,ORDER_WISE_PRO_DETAILS c Where a.id=b.mst_id and b.id=c.trans_id and  a.issue_basis=3 and a.entry_form=3 and a.status_active = 1 and b.status_active = 1   AND b.transaction_type=2 and c.trans_type=2 and b.receive_basis = 3  and c.status_active = 1 and  po_breakdown_id in(".$po_ids.")  ");
		foreach($recieved_sql as $row)
		{
			//$yarn_issue_arr[$row[csf("po_break_down_id")]]+=$row[csf('qnty')];
			$yarn_issue_qty+=$row[csf('qnty')];
		}
		unset($recieved_sql);
	
		$sql_return_data = sql_select("SELECT c.id, (b.quantity) as returned_qnty from inv_receive_master a,  order_wise_pro_details b, inv_transaction d,wo_po_break_down c  where a.id = d.mst_id and a.entry_form=9 and a.item_category =1 and a.receive_basis = 3 and d.transaction_type=4 and d.item_category=1 and d.id=b.trans_id and b.po_breakdown_id = c.id   and b.trans_type=4 and b.entry_form=9 and b.status_active=1 and b.is_deleted=0 and b.issue_purpose!=2 and po_breakdown_id in(".$po_ids.")");
		$return_qty_arr=array();
		foreach ($sql_return_data as $return_row) {
			$return_qty_arr[$return_row[csf('id')]]['returned_qnty'] += $return_row[csf('returned_qnty')];	 	
		} 
		/* echo "<pre>";
			 print_r($return_qty_arr); 
				  echo "</pre>";die();  */

		//$yarn_iss_qnty=$yarn_issue_arr[$order_no_id]-$return_qty_arr[$order_no_id]['returned_qnty'];
		$yarn_iss_qnty=$yarn_issue_qty-$return_qty_arr[$order_no_id]['returned_qnty'];



		// $recieved_sql=" select a.PO_BREAKDOWN_ID, sum(CASE WHEN a.entry_form ='3' and a.trans_type=2 THEN quantity ELSE 0 END) AS ISSUE_QNTY from order_wise_pro_details a,inv_transaction b where a.trans_id=b.id and a.status_active=1 and a.is_deleted=0 and a.issue_purpose!=2 and b.status_active=1 and po_breakdown_id in(".$po_ids.") group by a.po_breakdown_id";
		// //echo $recieved_sql;die();
		// 	$recieved_sql_result=sql_select($recieved_sql);
		// 	foreach($recieved_sql_result as $rcvRow){
		// 		$ISSUE_QNTY=$rcvRow['ISSUE_QNTY'];
		// 	}



			// $dying_sql="SELECT sum(b.roll_wgt) as roll_wgt_curr, c.po_breakdown_id  from pro_grey_batch_dtls b,inv_receive_mas_batchroll a,pro_roll_details c where a.id=b.mst_id and b.id=c.dtls_id and a.id=c.mst_id and c.entry_form=62  and a.is_deleted=0 and a.status_active=1 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and PO_BREAKDOWN_ID in(".$po_ids.") group by c.po_breakdown_id";
			// //echo $dying_sql;die();
			// $dyi_sql_result=sql_select($dying_sql);
			// foreach($dyi_sql_result as $rcvRow){
			// 	$DYE_QNTY=$rcvRow['ROLL_WGT_CURR'];
			// }


			$sqlsTrans="SELECT a.knit_dye_source, c.po_breakdown_id, sum(c.quantity) as qnty from inv_issue_master a, inv_grey_fabric_issue_dtls b, order_wise_pro_details c where a.id=b.mst_id and b.id=c.dtls_id and a.entry_form in(16,61) and c.entry_form in(16,61) and PO_BREAKDOWN_ID in(".$po_ids.") and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by a.knit_dye_source,c.po_breakdown_id  ";

			$results_trans=sql_select( $sqlsTrans );
			foreach ($results_trans as $row)
			{
				 if($row[csf('knit_dye_source')]!=3)
					$dataArrayYarnIssuesQty['qnty']+=$row[csf('qnty')];
				 if($row[csf('knit_dye_source')]==3)$dataArrayYarnIssuesQty['out']+=$row[csf('qnty')];
			}
			$sql_ret="SELECT  c.po_breakdown_id, sum(c.quantity) as quantity  from inv_receive_master a, inv_transaction b, order_wise_pro_details c, product_details_master d where a.id=b.mst_id and b.id=c.trans_id and b.prod_id=d.id and a.entry_form in (51,84) and c.entry_form in (51,84) and PO_BREAKDOWN_ID in(".$po_ids.") and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 group by  c.po_breakdown_id ";
			foreach (sql_select($sql_ret) as $row)
			{
				$dataArrayYarnIssuesQty['return']+=$row[csf('quantity')];
			}
			$DYE_QNTY +=$dataArrayYarnIssuesQty['qnty']+$dataArrayYarnIssuesQty['out']-$dataArrayYarnIssuesQty['return'];


			$pro_sql="select a.PO_BREAK_DOWN_ID,a.PRODUCTION_TYPE,a.EMBEL_NAME,a.EMBEL_TYPE,sum(b.production_qnty) as QTY from pro_garments_production_mst a,pro_garments_production_dtls b where a.id=b.mst_id and a.po_break_down_id in(".$po_ids.") and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.po_break_down_id,a.production_type,a.EMBEL_NAME,EMBEL_TYPE";
			//echo $pro_sql;

		
			$pro_sql_result=sql_select($pro_sql);

			$pro_data_arr=array();
			foreach($pro_sql_result as $preRow)
			{

				$pro_data_arr[$preRow[PRODUCTION_TYPE]]+=$preRow[QTY];
				$pro_data_arr[$preRow[EMBEL_TYPE]]+=$preRow[EMBEL_TYPE];
				//$emb_pro_data_arr[$preRow[PRODUCTION_TYPE]][$preRow[EMBEL_NAME]]+=$preRow[QTY];
				$emb_pro_data_arr[$preRow[PRODUCTION_TYPE]]+=$preRow[QTY];
			}
		?>
			


	<div align="left">

		<table  border="1" rules="all" >
			<thead><strong> Show Fabric Qty  (Task Wise)</strong></thead>
			<thead>   
				<th>Task Name</th>
				<th>Required Qty (Kg)</th>
				<th>Receive Qty (Kg)</th>
				<th>Production Qty (Kg)</th>
				<th>Excess/ Balance Qty (Kg)</th>
				<th>Excess/ Balance Qty %</th>
				
			</thead>
			<tbody>
				<?
				  $precost_data_arr['knitting_day'][31]=($precost_data_arr['knitting_day'][31])?$precost_data_arr['knitting_day'][31]:$precost_data_arr['knitting_day'][30];

				 
				  $knit_excess_qty=$precost_data_arr['grey_fab_qty']-$KNIT_PRO_QNTY;
				?>
		
				<tr>   
					<td>Knitting</td>
					<td align="right"><?=fn_number_format($precost_data_arr['grey_fab_qty'],2)	;?></td>
					<td align="right"><?=fn_number_format($yarn_iss_qnty,2);;?></td>
					<td align="right"><?=fn_number_format($KNIT_PRO_QNTY,2);;?></td>
					<td align="right"><?=fn_number_format($knit_excess_qty,2);?></td>
					<td align="right"><?=fn_number_format(($knit_excess_qty/$precost_data_arr['grey_fab_qty'])*100,2);?></td>
					
				</tr>
				   <?
				   	$precost_data_arr['knitting_day'][68]=($precost_data_arr['knitting_day'][68])?$precost_data_arr['knitting_day'][68]:$precost_data_arr['knitting_day'][193];

                     $dye_excess_qty=$precost_data_arr['finish_fab_qty']-$dye_pro_qnty;
					?>
				<tr>   
					<td>Dyeing</td>
					<td align="right"><?=fn_number_format($precost_data_arr['finish_fab_qty'],2);?></td>
					<td align="right"><?=fn_number_format($DYE_QNTY,2);?></td>
					<td align="right"><?=fn_number_format($dye_pro_qnty,2);?></td>
					<td align="right"><?=fn_number_format($dye_excess_qty,2);?></td>
					<td align="right"><?=fn_number_format(($dye_excess_qty/$precost_data_arr['finish_fab_qty'])*100,2)?></td>
					
					
				</tr>
				
			</tbody>

	</table> <br>
	
	<table border="1" rules="all">
	<thead><strong>Show Garments Qty (Task Wise)</strong></thead>
		<thead>   
			<th>Task Name</th>
			<th>Production Qty (PCS)</th>
			<th>Excess/ Balance Qty (PCS)</th>
			<th>Excess/ Balance Qty %</th>
		</thead>
		<tr>    
		     <? $cutting_output=$poQnty-$pro_data_arr[1];    ?>
			<td> Cutting Output</td>
			<td align="right"><?=number_format($pro_data_arr[1],2);?></td> 
			<td align="right"><?=number_format($cutting_output,2);;?></td> 
			<td align="right"><?=number_format(($cutting_output/$poQnty)*100,2); ?></td> 
		</tr>
		<tr>   
			
		    <? $embellishment=$poQnty-$emb_pro_data_arr[3]; ?>
			<td>Embellishment</td>
			<td align="right"><?=number_format($emb_pro_data_arr[3],0);?></td> 
			<td align="right"><?=number_format($embellishment,2);;?></td> 
			<td align="right"><?=number_format(($embellishment/$poQnty)*100,2); ?></td>  
		</tr>
		<tr> 
		      <?
		         $sewing_input=$poQnty-$pro_data_arr[4];
		        ?>      
			<td>Sewing Input</td>
			<td align="right"><?=number_format($pro_data_arr[4],2);?></td> 
			<td align="right"><?=number_format($sewing_input,2);;?></td> 
			<td align="right"><?=number_format(($sewing_input/$poQnty)*100,2); ?></td> 
		</tr>
		<tr>     
			
		  <?   $sewing_output=$poQnty-$pro_data_arr[5]; ?>  
			<td>Sewing Output</td>
			<td align="right"><?=number_format($pro_data_arr[5],2);?></td> 
			<td align="right"><?=number_format($sewing_output,2);;?></td> 
			<td align="right"><?=number_format(($sewing_output/$poQnty)*100,2); ?></td> 
		</tr>
		<tr>    <?
		        $total_fin_gmt=$poQnty-$pro_data_arr[8];
		        ?>   
			<td>Total Finished Gmts</td>
			<td align="right"><?=number_format($pro_data_arr[8],2);?></td> 
			<td align="right"><?=number_format($total_fin_gmt,2);;?></td> 
			<td align="right"><?=number_format(($total_fin_gmt/$poQnty)*100,2); ?></td> 
		</tr>  
		        <?
		        $total_ins_gmt=$poQnty-$insfection_qty;
		        ?>   
			<td>Total Inspection Gmts</td>
			<td align="right"><?=number_format($insfection_qty,2);?></td> 
			<td align="right"><?=number_format($total_ins_gmt,2);;?></td> 
			<td align="right"><?=number_format(($total_ins_gmt/$poQnty)*100,2); ?></td> 
		</tr>
		<tr>      
		     <? $total_ship_out_gmt=$poQnty-number_format($exfac_data_arr[$order_no_id],0,"",","); ?>  
			<td>Total Ship Out Gmts</td>
			<td align="right"><?=number_format($exfac_data_arr[$order_no_id],2);?></td> 
			<td align="right"><?=number_format($total_ship_out_gmt,2);;?></td> 
			<td align="right"><?=number_format(($total_ship_out_gmt/$poQnty)*100,2); ?></td> 
		</tr>
	</table><br>

	</div>

			<!--=====end======new add=======issue id====18283========18-09-2022======================-->
			

        <?
		$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
            <tr>
                <td width="49%" valign="top">
                <?
				if(count($sql_embelishment)>0)
				{
				?>
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Embelishment (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Embelishment Name</td>
                    <td>Embelishment Type</td>
                    <td>Cons <? echo $costing_per; ?> Gmts</td>
                    <td>Rate</td>
                    <td>Amount</td>

                    </tr>
                    <?
					$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
					$i=0;
					//$total_yarn=0;
					foreach($sql_embelishment  as $row_embelishment)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					echo $emblishment_name_array[$row_embelishment[csf('emb_name')]];
					?>
                    </td>
                    <td>
                    <?
					if($row_embelishment[csf('emb_name')]==1)
					{
					echo $emblishment_print_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==2)
					{
					echo $emblishment_embroy_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==3)
					{
					echo $emblishment_wash_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==4)
					{
					echo $emblishment_spwork_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==5)
					{
					echo $row_embelishment[csf('emb_type')];
					}
					?>

                    </td>
                    <td>
                    <?
					echo $row_embelishment[csf('cons_dzn_gmts')];
					?>
                    </td>
                    <td>
					<?
					echo $row_embelishment[csf('rate')];
					?>
                    </td>

                    <td>
					<?
					echo $row_embelishment[csf('amount')];
					?>
                    </td>


                    </tr>
                    <?
					}
					?>
                    </table>
                    <?
				}
					?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td><b>Approved Instructions</b></td>

                    </tr>
                    <tr>
                    <td>
                <?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
                </td>
                </tr>
                </table>

                </td>
            </tr>
        </table>
        <br/>
        <!--New Start here-->
        <div style="width:1330px; float:left">
		<!--=====start======new add=======issue id====12210========05-06-2023========Shariar==============-->
        <?

	 $colar_percent_size_wise_array=return_library_array( "select a.colar_cuff_per,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id and a.booking_no=$txt_booking_no and a.booking_type=1 and a.body_part_type in(40,50) and a.status_active=1 and a.is_deleted=0", "gmts_sizes", "colar_cuff_per");

		//echo  "select a.body_part_type,a.body_part_id,sum(d.rmg_qty) as rmg_qty,d.gmts_size,d.gmts_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d WHERE a.job_no=d.job_no and d.booking_no =$txt_booking_no and  a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 and d.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") group by a.body_part_type,a.body_part_id,d.gmts_size,d.gmts_color_id order by a.body_part_id";

		$nameArray_body_part=sql_select( "select a.body_part_type,a.body_part_id,sum(d.rmg_qty) as rmg_qty,d.gmts_size,d.gmts_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d WHERE a.job_no=d.job_no and d.booking_no =$txt_booking_no and  a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 and d.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.body_part_type in(40,50) group by a.body_part_type,a.body_part_id,d.gmts_size,d.gmts_color_id order by a.body_part_id");
			$row_count=count($nameArray_body_part);
		//if($row_count==0) echo " <p style='color:#f00; text-align:center; font-size:15px;'> Body part type is  used only Flat Knit and Cuff.</p> ";
		foreach($nameArray_body_part as $row)
		{
			$body_part_arr[$row[csf('body_part_id')]]['bpart_type']=$row[csf('body_part_type')];
			$body_part_rmg_qty_arr[$row[csf('body_part_id')]][$row[csf('gmts_size')]][$row[csf('gmts_color_id')]]['rmg_qty']+=$row[csf('rmg_qty')];
		}
		//print_r($body_part_arr);

		$k=1;
		foreach($body_part_arr as $body_id=>$val)
		{
			$k++;

			$bpart_type_id=$val['bpart_type'];
		$nameArray_item_size=sql_select( "select min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=$body_id  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 and a.body_part_type in(40,50) group by b.item_size,c.size_number_id order by id");

		/*$nameArray_item_size=sql_select( "select b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by c.size_number_id,b.item_size order by c.size_number_id");*/
		?>
         <div style="max-height:1330px; width:660px; overflow:auto; float:left; padding-top:20px; margin-left:5px; margin-bottom:5px; position: relative;">
        <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
        <tr>
        <td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b><? echo $body_part[$body_id];?> -  Colour Size Breakedown in Pcs</b></td>
        </tr>
        <tr>
        <td width="70">Size</td>
        <?
		foreach($nameArray_item_size  as $result_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
		<?
        }
        ?>
        <td rowspan="2" align="center"><strong>Total</strong></td>

        </tr>
        <tr>
        <td>Collar Size</td>

        <?
        foreach($nameArray_item_size  as $result_item_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
		<?
        }
        ?>
         <?

			$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=$body_id  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and a.body_part_type in(40,50) group by c.color_number_id,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			$color_total_collar=0;
			$color_total_collar_order_qnty=0;
			$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
			$constrast_color_arr=array();
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
				for($i=0;$i<count($constrast_color);$i++)
				{
					$constrast_color2=explode('_',$constrast_color[$i]);
					$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
				}
			}
		?>
			<tr>
            <td>
            <?
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
				$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
			}
			else
			{
				echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
				$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
			}
			?>

            </td>
            <?
            foreach($nameArray_item_size  as $result_size)
			{
				?>
				<td align="center" style="border:1px solid black">

				<?
				$rmg_qty=$body_part_rmg_qty_arr[$body_id][$result_size[csf('size_number_id')]][$color_wise_wo_result[csf('color_number_id')]]['rmg_qty'];
				//echo $bpart_type_id.'=';
				if($bpart_type_id==50)//Cuff
				{
					$tot_rmg_qty=$rmg_qty*2;
				}
				else //Flat Knit
				{
					$tot_rmg_qty=$rmg_qty;
				}
				//$color_wise_wo_sql_qnty=sql_select("select c.color_number_id,sum(c.order_quantity) as order_quantity, sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and c.color_number_id='".$color_wise_wo_result['color_number_id']."' and c.size_number_id='".$result_size['size_number_id']."'");
				/*$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active=1 and is_deleted =0");

				list($plan_cut_qnty)=$color_wise_wo_sql_qnty;*/
				//$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
				//$colar_excess_per=($plan_cut*$colar_excess_percent)/100;
				echo number_format($tot_rmg_qty,0);
				$color_total_collar+=$tot_rmg_qty;
				$color_total_collar_order_qnty+=$tot_rmg_qty;
				$grand_total_collar+=$tot_rmg_qty;
				$grand_total_collar_order_qnty+=$tot_rmg_qty;

				$size_tatal[$result_size[csf('size_number_id')]]+=$tot_rmg_qty;
				?>
                </td>
				<?
			}
			?>

            <td align="center"><? echo number_format($color_total_collar,0); ?></td>

            </tr>
            <?
		    }
			?>
            <tr>
                <td>Size Total</td>

                <?
                foreach($nameArray_item_size  as $result_size)
                {
					//$colar_excess_pers=($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100;
					$tot_size_tatal=$size_tatal[$result_size[csf('size_number_id')]];
					//$size_tatal[$result_size[csf('size_number_id')]]=0;
                ?>
                <td style="border:1px solid black;  text-align:center"><?  echo number_format($size_tatal[$result_size[csf('size_number_id')]],0);$size_tatal[$result_size[csf('size_number_id')]]=0; ?></td>
                <?
                }
                ?>
                <td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar,0);$grand_total_collar=0; ?></td>

            </tr>
        </table>
          <br/>
          </div>

        <?
		}

		?>
          <!--End here-->
	   <!--=====end======new add=======issue id====12210========05-06-2023========Shariar==============-->
        <br>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0">
            <tr>
                <td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
                    <?php echo get_spacial_instruction($txt_booking_no); ?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top">
                <?
		if(str_replace("'","",$cbo_fabric_source)==1 || str_replace("'","",$cbo_fabric_source)==2 || str_replace("'","",$cbo_fabric_source)==3 || str_replace("'","",$cbo_fabric_source)==4)
	    {
		?>
                   <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                   <tr align="center">
                    <td colspan="10"><b>Comments</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Po NO</td>
                    <td>Ship Date</td>
                    <td>Pre-Cost Qty</td>
                    <td>Mn.Book Qty</td>
                    <td>Sht.Book Qty</td>
                    <td>Smp.Book Qty</td>
                    <td>Tot.Book Qty</td>
                    <td>Balance</td>
                    <td>Comments</td>
                    </tr>
                    <?
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_natu_id=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
	if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
	//$paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_mst_id,size_mst_id,item_mst_id", "id", "plan_cut_qnty");

	$paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id,po_break_down_id", "id", "plan_cut_qnty");

	$item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no =$txt_job_no", "gmts_item_id", "set_item_ratio");
	$nameArray=sql_select("
	select
	a.id,
	a.item_number_id,
	a.costing_per,
	b.po_break_down_id,
	b.color_size_table_id,
	b.requirment,
	c.po_number
    FROM
	wo_pre_cost_fabric_cost_dtls a,
	wo_pre_cos_fab_co_avg_con_dtls b,
	wo_po_break_down c
    WHERE
	a.job_no=b.job_no and
	a.job_no=c.job_no_mst and
    a.id=b.pre_cost_fabric_cost_dtls_id and
	b.po_break_down_id=c.id and
	b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0
	order by a.id");
	$count=0;
	$tot_grey_req_as_pre_cost_arr=array();
	foreach ($nameArray as $result)
	{
		if (count($nameArray)>0 )
		{
            if($result[csf("costing_per")]==1)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(12*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==2)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(1*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==3)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(24*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==4)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(36*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==5)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(48*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			$tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
        }
    }
	                $total_pre_cost=0;
					$total_booking_qnty_main=0;
					$total_booking_qnty_short=0;
					$total_booking_qnty_sample=0;
					$total_tot_bok_qty=0;
					$tot_balance=0;
					/*$booking_qnty=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and booking_type in(1,4)  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by a.po_break_down_id", "po_break_down_id", "grey_fab_qnty");*/
					$booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category in(".$cbo_fabric_natu_id.") and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

					$booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category in(2,3) and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
					$booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category in(2,3)  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

					$sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.po_number order by id");
					foreach($sql_data  as $row)
                    {
					$col++;
					?>
                    <tr align="center">
                    <td><? echo $col; ?></td>
                    <td><? echo $row[csf("po_number")]; ?></td>
                     <td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
                    <td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
                    <td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
                    <td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
                    <td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
                    <td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
                    <td align="right">
					<? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
                    </td>
                    <td>
					<?
					if( $balance>0)
					{
						echo "Less Booking";
					}
					else if ($balance<0)
					{
						echo "Extra Booking";
					}
					else
					{
						echo "";
					}
					?>
                    </td>
                    </tr>
                    <?
					}
					?>
                    <tfoot>

                    <tr>
                    <td colspan="3">Total:</td>

                    <td align="right"><? echo number_format($total_pre_cost,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
                     <td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
                    <td align="right"><? echo number_format($tot_balance,2); ?></td>
                    <td></td>
                    </tr>
                    </tfoot>
                    </table>
                    <?
					 }
					?>
                </td>

            </tr>
        </table>
        <br/>
        <?
		//echo "select responsible_dept,	responsible_person,	reason from wo_booking_dtls where booking_no =$txt_booking_no";
		//"select id,department_name from  lib_department where status_active=1 and is_deleted=0 order by  department_name"
		$department_name_library=return_library_array( "select id,department_name from  lib_department where status_active=1 and is_deleted=0 order by  department_name", "id", "department_name"  );

		$sql_responsible= sql_select("select responsible_dept,	responsible_person,	reason from wo_booking_dtls where booking_no =$txt_booking_no and fin_fab_qnty>0  and status_active=1 ");
		if(count($sql_responsible)>0)
		{
		?>
         <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
         <tr>
         <td>
          #
         </td>
          <td>
         Responsible Dept.
         </td>
         <td>
         Responsible person
         </td>
         <td>
         Reason
         </td>
         </tr>
         <?
		 $ir=1;
		foreach($sql_responsible as $sql_responsible_row)
		{
			?>
             <tr>
             <td>
             <?  echo $ir; ?>
             </td>
              <td>
             <?
			 $responsible_dept_st="";
			 $responsible_dept_arr=explode( ",",$sql_responsible_row[csf('responsible_dept')]);
			 foreach($responsible_dept_arr as $key => $value)
			 {
				 $responsible_dept_st.= $department_name_library[$value].", ";
			 }
			 echo rtrim($responsible_dept_st,", ");
			 ?>
             </td>
             <td>
            <?  echo $sql_responsible_row[csf('responsible_person')]; ?>
             </td>
             <td>
              <?  echo $sql_responsible_row[csf('reason')]; ?>
             </td>
             </tr>
            <?
			$ir++;

		}
		 ?>
         </table>
         <?
		}
		 ?>
           <br/>
	<table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" style="font-family:Arial Narrow;">
        <caption> <strong style="float:left"> Stripe Details</strong></caption>
        <?
		// and a.id in(".str_replace("'","",$txt_order_no_id).")
		$color_name_arr=return_library_array( "select id,color_name from lib_color where status_active=1 and is_deleted=0",'id','color_name');
		$sql_stripe=("select c.id,c.composition,c.construction,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,sum(b.grey_fab_qnty) as fab_qty,b.dia_width,d.color_number_id as color_number_id,d.id as did,d.stripe_color,d.fabreqtotkg as fabreqtotkg ,d.measurement as measurement ,d.yarn_dyed,d.uom  from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c,wo_pre_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.pre_cost_fabric_cost_dtls_id=c.id and d.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.job_no='$job_no'  and b.booking_no=$txt_booking_no  and c.color_type_id in (2,3,4,6,32,33,34)  and b.status_active=1  and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and 	b.is_deleted=0  group by c.id,c.body_part_id,c.fabric_description,c.gsm_weight,c.color_type_id,d.color_number_id,d.id,d.stripe_color,d.yarn_dyed,d.fabreqtotkg ,d.measurement,d.uom,c.composition,c.construction,b.dia_width order by d.id ");
		$result_data=sql_select($sql_stripe);
		foreach($result_data as $row){
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
			$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
			$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg']+=$row[csf('fabreqtotkg')];
		}
		?>

            <tr>
            <th width="30"> SL</th>
            <th width="100"> Body Part</th>
            <th width="80"> Fabric Color</th>
            <th width="70"> Fabric Qty(KG)</th>
            <th width="70"> Stripe Color</th>
            <th width="70"> Stripe Measurement</th>
            <th width="70"> Stripe Uom</th>
            <th  width="70"> Qty.(KG)</th>
            <th  width="70"> Y/D Req.</th>
            </tr>
            <?
			//if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
			//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";
				//else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";


			$i=1;$total_fab_qty=0;$total_fabreqtotkg=0;$fab_data_array=array();
            foreach($stripe_arr as $body_id=>$body_data){
				foreach($body_data as $color_id=>$color_val){
					$rowspan=count($color_val['stripe_color']);
					$composition=$stripe_arr2[$body_id][$color_id]['composition'];
					$construction=$stripe_arr2[$body_id][$color_id]['construction'];
					$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
					$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
					$dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];

					/*if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
					else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";

					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
						WHERE a.job_no=b.job_no and
						a.id=b.pre_cost_fabric_cost_dtls_id and
						c.job_no_mst=a.job_no and
						c.id=b.color_size_table_id and
						b.po_break_down_id=d.po_break_down_id and
						b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
						d.booking_no =$txt_booking_no and
						a.body_part_id='".$body_id."' and
						a.color_type_id='".$color_type_id."' and
						a.construction='".$construction."' and
						a.composition='".$composition."' and
						a.gsm_weight='".$gsm_weight."' and
						$color_cond and
						d.status_active=1 and
						d.is_deleted=0
						");
						list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;*/
					?>
					<tr>
					<?
					//$color_qty=$stripe_arr2[$body_id][$color_id]['fabreqtotkg'];//$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
					$color_qty= array_sum($stripe_arr[$body_id][$color_id]['fabreqtotkg']);
					?>
					<td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
					<td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
					<td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
					<td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?></td>
					<?
					$total_fab_qty+=$color_qty;
					foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
					{
						$measurement=$color_val['measurement'][$strip_color_id];
						$uom=$color_val['uom'][$strip_color_id];
						$fabreqtotkg=$color_val['fabreqtotkg'][$strip_color_id];
						$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
						?>
						<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
						<td align="right"> <? echo  number_format($measurement,2); ?></td>
                        <td> <? echo  $unit_of_measurement[$uom]; ?></td>
						<td align="right"> <? echo  number_format($fabreqtotkg,2); ?></td>
						<td> <? echo  $yes_no[$yarn_dyed]; ?></td>
						</tr>
						<?
						$total_fabreqtotkg+=$fabreqtotkg;
					}
					$i++;
				}
			}
			?>
            <tfoot>
            <tr>
            <td colspan="3">Total </td>
            <td align="right">  <? echo  number_format($total_fab_qty,2); ?> </td>
            <td></td>
            <td></td>
            <td>   </td>
            <td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
            </tr>
            </tfoot>
            </table>

         <?
	$lib_designation_arr=return_library_array(" select id,custom_designation from lib_designation","id","custom_designation");
	$user_lib_designation_arr=return_library_array("SELECT id,designation from user_passwd", "id", "designation");
	$user_lib_name_arr=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");

	$mst_id=return_field_value("id as mst_id","wo_booking_mst","booking_no=$txt_booking_no","mst_id");
	//echo $mst_id.'ssD';
	//and b.un_approved_date is null
	 $approve_data_array=sql_select("select a.cause,b.approved_by,min(b.approved_date) as approved_date from   approval_history b left join booking_cause a on  b.mst_id=a.cause_id and a.status_active=1 and a.is_deleted=0 and a.entry_form=12 where b.mst_id=$mst_id and b.entry_form=12  group by  a.cause,b.approved_by order by b.approved_by asc");
	 $unapprove_data_array=sql_select("select b.approved_by,b.approved_date,b.un_approved_reason,b.un_approved_date,b.approved_no from   approval_history b where b.mst_id=$mst_id and b.entry_form=12  order by b.approved_date,b.approved_by");

	?>
    <td width="49%" valign="top">
	<?
       if(count($approve_data_array)>0)
			{
 		?>
       <table  width="850" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="5" style="border:1px solid black;">Approval Status</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th>
				<th width="25%" style="border:1px solid black;">Name</th>
				<th width="25%" style="border:1px solid black;">Designation</th>
				<th width="25%" style="border:1px solid black;">Comments</th>
				<th width="22%" style="border:1px solid black;">Approval Date</th>

                </tr>
            </thead>
            <tbody>
            <?
			$i=1;
			foreach($approve_data_array as $row){


			?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
				<td width="25%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
				<td width="25%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
				<td width="22%" style="border:1px solid black;text-align:center"><? echo $row[csf('cause')];?></td>
				<td width="25%" style="border:1px solid black;text-align:center"><? echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')]));?></td>

                </tr>
                <?
				$i++;
			}
				?>
            </tbody>
        </table>
		<?
		}
		?>
		<br>
		<?
		if(count($unapprove_data_array)>0)
		{
			//and approval_type=2
			$sql_unapproved=sql_select("select booking_id,approval_cause from fabric_booking_approval_cause where  entry_form=12 and is_deleted=0 and status_active=1 and booking_id=$mst_id");
			//echo "select booking_id,approval_cause from fabric_booking_approval_cause where  entry_form=13 and approval_type=2 and is_deleted=0 and status_active=1 and booking_id=$mst_id";
			$unapproved_request_arr=array();
			foreach($sql_unapproved as $rowu)
			{
			$unapproved_request_arr[$rowu[csf('booking_id')]]=$rowu[csf('approval_cause')];
			}
 		?>
       <table  width="850" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="6" style="border:1px solid black;">Approval/Un Approval History</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th>
				<th width="30%" style="border:1px solid black;">Name</th>
				<th width="20%" style="border:1px solid black;">Designation</th>
				<th width="5%" style="border:1px solid black;">Approval Status</th>
				<th width="20%" style="border:1px solid black;">Reason For Un Approval</th>
				<th width="22%" style="border:1px solid black;"> Date</th>

                </tr>
            </thead>
            <tbody>
            <?
			$i=1;
			foreach($unapprove_data_array as $row){

			?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
				<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
				<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
				<td width="5%" style="border:1px solid black; text-align:center"><? echo 'Yes';?></td>
				<td width="20%" style="border:1px solid black;"><? echo '';?></td>
				<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); else echo "";?></td>
            </tr>
				<?
				$i++;
				$un_approved_date= explode(" ",$row[csf('un_approved_date')]);
				$un_approved_date=$un_approved_date[0];
				if($db_type==0) //Mysql
				{
					if($un_approved_date=="" || $un_approved_date=="0000-00-00") $un_approved_date="";else $un_approved_date=$un_approved_date;
				}
				else
				{
					if($un_approved_date=="") $un_approved_date="";else $un_approved_date=$un_approved_date;
				}

				if($un_approved_date!="")
				{
				?>
			<tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td>
				<td width="30%" style="border:1px solid black;text-align:center"><? echo $user_lib_name_arr[$row[csf('approved_by')]];?></td>
				<td width="20%" style="border:1px solid black;text-align:center"><? echo $lib_designation_arr[$user_lib_designation_arr[$row[csf('approved_by')]]];?></td>
				<td width="5%" style="border:1px solid black;text-align:center;"><? echo 'No';?></td>
				<td width="20%" style="border:1px solid black;text-align:center"><? echo $unapproved_request_arr[$mst_id];?></td>
				<td width="22%" style="border:1px solid black;text-align:center"><? if($row[csf('un_approved_date')]!="") echo date ("d-m-Y h:i:s",strtotime($row[csf('un_approved_date')])); else echo "";?></td>
              </tr>

                <?
				$i++;
				}

			}
				?>
            </tbody>
        </table>
		<?
		}
		?>
		<br>
	    <table width="780" align="center">
                <tr>
                <div style="text-align:center;font-size:xx-large; font-style:italic; margin-top:20px; color:#FF0000;">
                    <?
					if(count($approval_arr)>0)
					{
                       if($is_approved == 0){echo "Draft";}else{}
					}
                    ?>
                </div>
                </tr>
        </table>
         <?
		 	echo signature_table(4, $cbo_company_name, "1330px","",1,$INSERTED_BY);
			echo "****".custom_file_name($txt_booking_no,$style_sting,$txt_job_no);
		 ?>
       </div>
	<script type="text/javascript" src="../../js/jquery.js"></script>
    <script type="text/javascript" src="../../js/jquerybarcode.js"></script>
    <script>
    fnc_generate_Barcode('<? echo $varcode_booking_no; ?>','barcode_img_id');
    </script>
    <?
	exit();
}

// new print button for urmi
if($action=="show_fabric_booking_report_urmi")
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$report_type=str_replace("'","",$report_type);

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$color_library=return_library_array( "select id,color_name from lib_color where status_active =1 and is_deleted=0", "id", "color_name");
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	//$supplier_address_arr=return_library_array( "select id,address_1 from   lib_supplier",'id','address_1');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	$id_approved_id=str_replace("'","",$id_approved_id);
	//
	?>
	<div style="width:1330px" align="center">
    <?php
$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12");
list($nameArray_approved_row) = $nameArray_approved;
$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
list($nameArray_approved_date_row) = $nameArray_approved_date;
$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
list($nameArray_approved_comments_row) = $nameArray_approved_comments;
$path = str_replace("'", "", $path);
if ($path == "") {
	$path = '../../';
}
?>										<!--    Header Company Information         -->
       <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black" >
           <tr>
               <td width="220">
               <?
			   if($report_type==1)
			   {
			   ?>
               <img  src='../../<? echo $imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
               <?
			   }
			   else if($report_type==2)
			   {
			   ?>
               <img  src='../<? echo $imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
               <?
			   }
			   else
			   {
			   ?>
               <img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
               <?
			   }
			   ?>
               </td>
               <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:20px;">
                              <?php
echo $company_library[$cbo_company_name];
?>
                            </td>
                            <td rowspan="3" width="250">

                               <span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($txt_job_no,"'"); ?></b></span>
                               <br/>
                                <?
								 if($nameArray_approved_row[csf('approved_no')]>1)
								 {
								 ?>
								 <b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
                                  <br/>
								  Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
								  <?
								 }
							  	?>


                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:14px">
                            <?
                            $nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
							//$location=return_field_value("location_name","lib_location","id=$data[3]" );
							//$nameArray=sql_select("select location_name from wo_po_details_master where job_no=$txt_job_no");
							if($txt_job_no!="")
							{
							 $location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'");
							}
							else
							{
							$location="";
							}

							foreach ($nameArray as $result)
                            {
							 echo  $location_name_arr[$location];
                            ?>

                               <!-- Plot No: <? //echo $result[csf('plot_no')]; ?>
                                Level No: <? //echo $result[csf('level_no')]?>
                                Road No: <? //echo $result[csf('road_no')]; ?>
                                Block No: <? //echo $result[csf('block_no')];?>
                                City No: <? //echo $result[csf('city')];?>
                                Zip Code: <? //echo $result[csf('zip_code')]; ?>
                                Province No: <?php //echo $result[csf('province')];?>
                                Country: <? //echo $country_arr[$result[csf('country_id')]]; ?> --><br>
                                Email Address: <? echo $result[csf('email')];?>
                                Website No: <? echo $result[csf('website')]; ?>

                                <?

                            }

                            ?>
                               </td>
                            </tr>
                            <tr>
                            <td align="center" style="font-size:20px">
                                <strong><? //if($report_type==1) echo str_replace("'","",$report_title);else echo 'Short Fabric Booking';
								if($report_title !=""){ echo str_replace("'","",$report_title);} else { echo "General Work Order";}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if($id_approved_id>0){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
                             </td>
                            </tr>
                      </table>
                </td>
            </tr>
       </table>
                <?
				$uom=0;
				$job_no='';
				$total_set_qnty=0;
				$colar_excess_percent=0;
				$cuff_excess_percent=0;
				$rmg_process_breakdown=0;
				$poid=str_replace("'","",$txt_order_no_id);
				$po_date_arr=array();
				$sql_po_date= "select job_no_mst,MIN(pub_shipment_date) pub_shipment_date,MAX(pub_shipment_date) pub_shipment_date_max from  wo_po_break_down  where job_no_mst=$txt_job_no and id in($poid)  group by job_no_mst order by pub_shipment_date";
				 $poArray=sql_select($sql_po_date);
				foreach($poArray as $row)
				{
					$po_date_arr[$row[csf('job_no_mst')]]=change_date_format($row[csf('pub_shipment_date')]).','.change_date_format($row[csf('pub_shipment_date_max')]);
				}
				//print_r($po_date_arr);
                $nameArray=sql_select( "select a.booking_no, a.booking_date, a.supplier_id, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.pay_mode, a.rmg_process_breakdown, a.insert_date, a.update_date, a.uom, a.remarks, a.short_booking_type, b.job_no, b.buyer_name, b.style_ref_no, b.gmts_item_id, b.order_uom, b.total_set_qnty, b.style_description, b.season, b.season_matrix,b.season_buyer_wise, b.order_repeat_no, b.product_dept, b.product_code, b.pro_sub_dep, b.dealing_marchant, b.client_id, b.qlty_label from wo_booking_mst a, wo_po_details_master b where a.job_no=b.job_no and a.booking_no=$txt_booking_no");
				foreach ($nameArray as $result)
				{
					$total_set_qnty=$result[csf('total_set_qnty')];
					$colar_excess_percent=$result[csf('colar_excess_percent')];
				    $cuff_excess_percent=$result[csf('cuff_excess_percent')];
					$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
					$po_no_arr=array();
					$shipment_date="";$shipment_date_max="";
					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date,MAX(pub_shipment_date) pub_shipment_date_max from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number";
					//echo "select po_number,MIN(pub_shipment_date) pub_shipment_date,MAX(pub_shipment_date) pub_shipment_date_max from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $row_po)
					{
						$po_no_arr[$row_po[csf('po_number')]]=$row_po[csf('po_number')];
						//$shipment_date.=change_date_format($row_po[csf('pub_shipment_date')],'dd-mm-yyyy','-').",";
						//$shipment_date_max.=change_date_format($row_po[csf('pub_shipment_date_max')],'dd-mm-yyyy','-').",";
						//$shipment_date_con=change_date_format($row_po[csf('pub_shipment_date')],'dd-mm-yyyy','-').",".change_date_format($row_po[csf('pub_shipment_date_max')],'dd-mm-yyyy','-');
					}
					$po_no=implode(",",$po_no_arr);
					$shipment_date=$po_date_arr[$result[csf('job_no')]];

					$lead_time_arr=array();
					if($db_type==0)
					{
					$sql_lead_time= "select DATEDIFF(pub_shipment_date,po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					if($db_type==2)
					{
					$sql_lead_time= "select (pub_shipment_date-po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					$data_array_lead_time=sql_select($sql_lead_time);
					foreach ($data_array_lead_time as $row_lead_time)
					{
						$lead_time_arr[]=$row_lead_time[csf('date_diff')];
						//$shipment_date.=change_date_format($row_po['pub_shipment_date'],'dd-mm-yyyy','-').",";
					}
					$lead_time=implode(",",array_unique($lead_time_arr));
					$po_received_date="";
					$sql_po_received_date= "select MIN(po_received_date) as po_received_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					$data_array_po_received_date=sql_select($sql_po_received_date);
					foreach ($data_array_po_received_date as $row_po_received_date)
					{
						$po_received_date=change_date_format($row_po_received_date[csf('po_received_date')],'dd-mm-yyyy','-');
						//$shipment_date.=change_date_format($row_po['pub_shipment_date'],'dd-mm-yyyy','-').",";
					}


				   $daysInHand_arr=array();
				   $WOPreparedAfter_arr=array();
				   $shiping_status_arr=array();
					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date, MIN(insert_date) as insert_date,shiping_status from wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number,shiping_status";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $rows)
					{
						$daysInHand_arr[]=(datediff('d',date('d-m-Y',time()),$rows[csf('pub_shipment_date')])-1);
						//$daysInHand=(datediff('d',date('d-m-Y',time()),$rows[csf('pub_shipment_date')])-1).",";
						$booking_date=$result[csf('update_date')];
						if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
						{
							$booking_date=$result[csf('insert_date')];
						}
						//$WOPreparedAfter.=(datediff('d',$rows[csf('insert_date')],$booking_date)-1).",";
						$WOPreparedAfter_arr[]=(datediff('d',$rows[csf('insert_date')],$booking_date)-1);

						if($rows[csf('shiping_status')]==1)
						{
						//$shiping_status.= "FP".",";
						$shiping_status_arr[]="FP";
						}
						else if($rows[csf('shiping_status')]==2)
						{
						//$shiping_status.= "PS".",";
						$shiping_status_arr[]="PS";

						}
						else if($rows[csf('shiping_status')]==3)
						{
						//$shiping_status.= "FS".",";
						$shiping_status_arr[]="FS";
						}

					}
					$daysInHand=implode(",",array_unique($daysInHand_arr));
					$WOPreparedAfter=implode(",",array_unique($WOPreparedAfter_arr));
					$shiping_status=implode(",",array_unique($shiping_status_arr));

				if($db_type==2) $group_concat_all=" listagg(cast(b.grouping as varchar2(4000)),',') within group (order by b.grouping) as grouping,
	                                    listagg(cast(b.file_no as varchar2(4000)),',') within group (order by b.file_no) as file_no  ";
				else { $group_concat_all="group_concat(b.grouping) as grouping, group_concat(b.file_no) as file_no";}
				$data_array3=sql_select("select a.job_no,a.company_name,a.buyer_name,$group_concat_all from wo_po_details_master a, wo_po_break_down b where b.id in (".$result[csf('po_break_down_id')].") and a.job_no=b.job_no_mst group by a.job_no,a.company_name,a.buyer_name");
				//echo $sql_grouping= "select booking_no  from wo_booking_dtls  where  po_break_down_id in(".$result[csf('po_break_down_id')].") and booking_type=1 and is_short=2 ";
				/*if($db_type==2) $group_concat_book="listagg(cast(booking_no as varchar2(4000)),',') within group (order by booking_no) as booking_no";
				else  $group_concat_book="group_concat(distinct booking_no) as booking_no ";

				$main_fab_booking_no=return_field_value( "$group_concat_book", "wo_booking_dtls","po_break_down_id in(".$result[csf('po_break_down_id')].") and booking_type=1 and is_short=2","booking_no");
				$main_fab_booking_no=implode(",",array_unique(explode(",",$main_fab_booking_no)));*/
				$mb_arr=array();
				$sql_mb= sql_select("select booking_no  from wo_booking_dtls  where  po_break_down_id in(".$result[csf('po_break_down_id')].") and booking_type=1 and is_short=2 ");                foreach($sql_mb as $row_mb){
					$mb_arr[$row_mb[csf('booking_no')]]=$row_mb[csf('booking_no')];

				}
				$main_fab_booking_no=implode(",",$mb_arr);
				?>
       <table width="100%" style="border:1px solid black;table-layout: fixed;" >
            <tr>
                <td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
            </tr>
            <tr>
                <td width="200"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
                <td width="220">:&nbsp;<span style="font-size:18px"><b><? $buyer_name_str=""; if($result[csf('client_id')]!=0) $buyer_name_str=$buyer_name_arr[$result[csf('buyer_name')]]."-".$buyer_name_arr[$result[csf('client_id')]]; else $buyer_name_str=$buyer_name_arr[$result[csf('buyer_name')]]; echo $buyer_name_str; ?></b></span></td>
                <td width="200"><span style="font-size:12px"><b>Dept.</b></span></td>
                <td width="220">:&nbsp;<? echo $product_dept[$result[csf('product_dept')]] ; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></td>
                <td width="200"><span style="font-size:12px"><b>Order Qnty</b></span></td>
                <td>:&nbsp; <?  echo $po_qnty_tot1." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?> </td>
            </tr>
            <tr>

                <td style="font-size:12px"><b>Garments Item</b></td>
                <td>:&nbsp;
				<?
				$gmts_item_name="";
				$gmts_item=explode(',',$result[csf('gmts_item_id')]);
				for($g=0;$g<=count($gmts_item); $g++)
				{
					$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
				}
				echo rtrim($gmts_item_name,',');
				?>
                </td>
                <td style="font-size:12px"><b>Booking Release Date</b></td>
                <td>:&nbsp;
				<?
				$booking_date=$result[csf('update_date')];
				if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
				{
					$booking_date=$result[csf('insert_date')];
				}
				echo change_date_format($booking_date,'dd-mm-yyyy','-','');
				?>&nbsp;&nbsp;&nbsp;</td>
                <td style="font-size:18px"><b>Style Ref.</b>   </td>
                <td style="font-size:18px">:&nbsp;<b><? echo $style_sting=$result[csf('style_ref_no')];?> </b>   </td>
            </tr>
             <tr>
                <td style="font-size:12px"><b>Style Des.</b></td>
                <td>:&nbsp;<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
                <td style="font-size:12px"><b>Lead Time </b>   </td>
                <td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;">:&nbsp;<?=implode(",",array_filter(array_unique(explode(",",$lead_time))));?> </td>
                <td style="font-size:12px"><b>Dealing Merchandiser</b></td>
                <td>:&nbsp;<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>
            </tr>

            <tr>
                <td style="font-size:12px"><b>Supplier Name</b>   </td>
                <td>:&nbsp;<?
				if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3){
					echo $company_library[$result[csf('supplier_id')]];
					}
					else{
					echo $supplier_name_arr[$result[csf('supplier_id')]];
					}
				//echo $supplier_name_arr[$result[csf('supplier_id')]];?>    </td>
                <td style="font-size:12px"><b>Delivery Date</b></td>
               	<td>:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
                <td style="font-size:18px"><b>Booking No </b>   </td>
                <td style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?> <? echo "(".$unit_of_measurement[$result[csf('uom')]].")"; $uom=$result[csf('uom')];?></td>

              <?
              //$shipment_date=implode(",",array_unique(explode(",",rtrim($shipment_date,","))));
			  // $shipment_date_max=implode(",",array_unique(explode(",",rtrim($shipment_date_max,","))));//rtrim($shipment_date_max,",");
			 //  if($shipment_date!='' && $shipment_date_max!='') $ship_date= $shipment_date.','.$shipment_date;
			 //  else if($shipment_date!='')  $ship_date= $shipment_date;
			   //else if($shipment_date_max!='')  $ship_date= $shipment_date_max;
			   //echo shipment_date; season_buyer_wise
			  ?>

            </tr>
            <tr>
                <td style="font-size:12px"><b>Season</b></td>
                <td>:&nbsp;<?

				$season_matrix=return_field_value("season_name","lib_buyer_season","id=".$result[csf('season_buyer_wise')],"season_name");

				echo $season_matrix; ?></td>
                <td  style="font-size:12px"><b>Attention</b></td>
                <td  >:&nbsp;<? echo $result[csf('attention')]; ?></td>
                <td  style="font-size:12px"><b>Po Received Date</b></td>
                <td  >:&nbsp;<? echo $po_received_date; ?></td>



            </tr>
           <tr>
               <td style="font-size:18px"><b>Order No</b></td>
               <td style="font-size:18px;overflow:hidden;text-overflow: ellipsis;white-space: nowrap;" colspan="3">:&nbsp;<b><?=implode(",",array_filter(array_unique(explode(",",$po_no)))); ?></b></td>
               <td  style="font-size:12px"><b>Repeat No</b></td>
               <td  >:&nbsp;<? echo $result[csf('order_repeat_no')]; ?></td>
            </tr>
            <tr>
               <td style="font-size:12px"><b>Shipment Date</b></td>
                <td colspan="3"> :&nbsp;<?=implode(",",array_filter(array_unique(explode(",",$shipment_date)))); ?></td>
                <td  style="font-size:12px"><b>Quality Label</b></td>
               <td  >:&nbsp;<? echo $quality_label[$result[csf('qlty_label')]]; ?></td>

            </tr>

            </tr>
            <tr>
               <td style="font-size:12px"><b>WO Prepared After</b></td>
               <td  style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;<?=implode(",",array_filter(array_unique(explode(",",$WOPreparedAfter)))).' Days' ?></td>

               <td style="font-size:12px"><b>Ship.days in Hand</b></td>
               <td  style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;<?=implode(",",array_filter(array_unique(explode(",",$daysInHand)))).' Days'?></td>

               <td style="font-size:12px"><b>Ex-factory status</b></td>
               <td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;<?=implode(",",array_filter(array_unique(explode(",",$shiping_status)))); ?></td>

            </tr>
           <tr>
               <td style="font-size:18px"><b>Internal Ref No</b></td>
               <td style="font-size:18px"> :&nbsp;<b><?=implode(",",array_unique(explode(",",$data_array3[0][csf("grouping")]))); ?></b></td>
               <td style="font-size:18px"><b>File no</b></td>
               <td style="font-size:18px"> :&nbsp;<b><?=implode(",",array_unique(explode(",",$data_array3[0][csf("file_no")])));?></b></td>
               <td style="font-size:18px"><b>Currency</b></td>
               <td style="font-size:18px"> :&nbsp;<b><?=$currency[$result[csf("currency_id")]];?></b></td>
            </tr>
            <tr>
                <td style="font-size:18px"><b>Main Fab. Booking No</b></td>
               <td style="font-size:18px" colspan="5"> : <? echo $main_fab_booking_no?></td>
          </tr>
          <tr>
               <td style="font-size:18px"><b>Remarks</b></td>
               <td style="font-size:18px" colspan="3"> :<? echo $result[csf('remarks')]?></td>
               <td style="font-size:18px"><b>Short Booking Type</b></td>
               <td style="font-size:18px"> :<? echo $short_booking_type[$result[csf('short_booking_type')]]?></td>
          </tr>
        </table>
           <?
			}
			if($cbo_fabric_source==1 || $cbo_fabric_source==2)
			{
			//$nameArray_size=sql_select( "select distinct size_number_id from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  	is_deleted=0 and status_active=1 order by size_number_id");
			//$nameArray_size=sql_select( "select  size_number_id,min(id) as id,	min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  	is_deleted=0 and status_active=1 group by size_number_id order by id");
			$nameArray_size=sql_select( "select  size_number_id,min(id) as id,	min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  	is_deleted=0 and status_active=1 group by size_number_id order by size_order");

		   ?>
            <table width="100%" >
		    <tr>
            <td width="800">
                <div id="div_size_color_matrix" style="float:left; max-width:1000;">
            	<fieldset id="div_size_color_matrix" style="max-width:1000;">
 				<legend>Size and Color Breakdown</legend>
 				<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
                    <tr>
                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                    <?
						foreach($nameArray_size  as $result_size)
                        {	     ?>
                        <td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
                    <?	}    ?>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                        <td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                    </tr>
                    <?
					$color_size_order_qnty_array=array();
					$color_size_qnty_array=array();
					$size_tatal=array();
					$size_tatal_order=array();
					for($c=0;$c<count($gmts_item); $c++)
				    {
					$item_size_tatal=array();
					$item_size_tatal_order=array();
					$item_grand_total=0;
					$item_grand_total_order=0;
					//$nameArray_color=sql_select( "select distinct color_number_id from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 order by color_number_id");
					//$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id  order by id");
					$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id  order by color_order");
					?>
                    <tr>
                    <td style="border:1px solid black" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>

                    </tr>
                    <?
					foreach($nameArray_color as $result_color)
                    {
                    ?>
                    <tr>
                        <td align="center" style="border:1px solid black"><? echo $color_library[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
                        <?
						$color_total=0;
						$color_total_order=0;

						foreach($nameArray_size  as $result_size)
						{
						$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0");
						foreach($nameArray_color_size_qnty as $result_color_size_qnty)
                        {
                        ?>
                            <td style="border:1px solid black; text-align:right">
							<?
								if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
								{
									 echo number_format($result_color_size_qnty[csf('order_quantity')],0);
									 $color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
									 $color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
									 $item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
								     $grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $grand_total_order +=$result_color_size_qnty[csf('order_quantity')];

									 $color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
									 {
											$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
											$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
									 }
									 else
									 {
										$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
										$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 }
									 if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
									 {
											$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
											$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
									 }
									 else
									 {
										$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
										$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 }
								}
								else echo "0";
							 ?>
							</td>

                    <?
						}
                        }
                        ?>
                          <td style="border:1px solid black; text-align:right"><?  echo number_format(round($color_total_order),0); ?></td>

                         <td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?>
                         </td>
                        <td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total),0); ?></td>
                    </tr>
                    <?
                    }
					?>

                        <td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total),0); ?></td>
                    </tr>
                    <?
					}
                    ?>
                     <tr>
                        <td style="border:1px solid black" align="center" colspan="<? echo count($nameArray_size)+3; ?>"><strong>&nbsp;</strong></td>
                        </tr>
                    <tr>
                    <tr>
                        <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total),0); ?></td>
                    </tr>
                </table>
                </fieldset>
                </div>
                </td>
                <td width="200" valign="top" align="left">
                <div id="div_size_color_matrix" style="float:left;">
                <?
				$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
				?>
            	 	<fieldset id="" >
 				<legend>RMG Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                <?
				if(number_format($rmg_process_breakdown_arr[8],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Cut Panel rejection <!-- Extra Cutting % breack Down 8-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[8],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[2],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Chest Printing <!-- Printing % breack Down 2-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[2],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[10],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Neck/Sleeve Printing <!-- New breack Down 10-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[10],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[1],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Embroidery   <!-- Embroidery  % breack Down 1-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[1],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[4],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Sewing /Input<!-- Sewing % breack Down 4-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[4],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[3],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Garments Wash <!-- Washing %breack Down 3-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[3],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[15],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Gmts Finishing <!-- Washing %breack Down 3-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[15],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[11],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Others <!-- New breack Down 11-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[11],2);
				?>
                </td>
                </tr>
                <?
                }
				$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
				if($gmts_pro_sub_tot>0)
				{
				?>
                <tr>
                <td width="130">
                Sub Total <!-- New breack Down 11-->
                </td>
                <td align="right">
                <?

				echo number_format($gmts_pro_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				?>
                </table>
                </fieldset>


                <fieldset id="" >
 				<legend>Fabric Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                 <?
				if(number_format($rmg_process_breakdown_arr[6],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Knitting  <!--  Knitting % breack Down 6-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[6],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[12],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Yarn Dyeing  <!--  New breack Down 12-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[12],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[5],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Dyeing & Finishing  <!-- Finishing % breack Down 5-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[5],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[13],2)>0)
				{
				?>
                <tr>
                <td width="130">
                All Over Print <!-- new  breack Down 13-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[13],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[14],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Lay Wash (Fabric) <!-- new  breack Down 14-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[14],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[7],2)>0)
				{
				?>
                 <tr>
                <td width="130">
                Dying   <!-- breack Down 7-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[7],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[0],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Cutting (Fabric) <!-- Cutting % breack Down 0-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[0],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[9],2)>0)
				{
				?>
                <tr>
                <td width="130">
               Others  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[9],2);
				?>
                </td>
                </tr>
                <?
				}
				$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
				if(fab_proce_sub_tot>0)
				{
				?>
                <tr>
                <td width="130">
                Sub Total  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?

				echo number_format($fab_proce_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
				{
				?>
                 <tr>
                <td width="130">
                Grand Total  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?
				echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				?>
           </table>
           </fieldset>
           </div>
                </td>
            <td width="330" valign="top" align="left">
            <?
			$nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id='$job_no' and file_type=1");
			?>
            <div id="div_size_color_matrix" style="float:left;">
            	<fieldset id="" >
 				<legend>Image </legend>
            	<table width="310">
                <tr>
                <?
				$img_counter = 0;
                foreach($nameArray_imge as $result_imge)
				{
				    if($path=="")
                    {
                   	 $path='../../';
                    }

					?>
					<td>
						<!--<img src="../../<? //echo $result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />-->
                        <img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />
					</td>
					<?

					$img_counter++;
				}
				?>
                </tr>
           </table>
           </fieldset>
           </div>
          </td>
        </tr>
       </table>
        <?
			}// if($cbo_fabric_source==1) end

	  ?>
      <br/>

      <!--  Here will be the main portion  -->
     <?
	 $costing_per="";
	 $costing_per_qnty=0;
	 $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
	 if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;

			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";
				$costing_per_qnty=1;

			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;

			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;

			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;

			}
			$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");;

$uom_arr=array(1=>"Pcs",12=>"Kg",23=>"Mtr",27=>"Yds");
foreach($uom_arr as $uom_id=>$uom_val){
	if($cbo_fabric_source==1)
	{
	$nameArray_fabric_description= sql_select("select a.id as fabric_cost_dtls_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , d.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.is_short=1 and
	a.uom=$uom_id and
	b.cons>0 and
	d.booking_no =$txt_booking_no and
	d.status_active=1 and
	d.is_deleted=0
	group by a.id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,d.dia_width,b.remarks order by fabric_cost_dtls_id,a.body_part_id,d.dia_width");
	if(count($nameArray_fabric_description)>0){
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <caption>Fabric Details in <? echo $uom_val ?></caption>
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
        <td  rowspan="10" width="50"><p>Total Finish Fabric <? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>

            <td  rowspan="10" width="50"><p>Avg Rate <? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
            <td  rowspan="10" width="50"><p>Amount </p></td>

       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('remarks')]."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
			}


		?>

       </tr>
       <?

		  /*$gmt_color_library=return_library_array( "select gmts_color_id,contrast_color_id
		  FROM
		  wo_pre_cos_fab_co_color_dtls
		  WHERE
		  job_no ='$job_no'", "contrast_color_id", "gmts_color_id");*/
		  $gmt_color_library=array();
		  $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=$uom_id and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			//$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]].=$color_library[$gmt_color_row[csf("gmts_color_id")]]."," ;
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;
			//$grand_totalcons_per_finish=0;
			//$grand_totalcons_per_grey=0;
			//$color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE  booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
			$color_wise_wo_sql=sql_select("select b.fabric_color_id  FROM  wo_pre_cost_fabric_cost_dtls a ,wo_booking_dtls b  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.uom=$uom_id and b.booking_no = $txt_booking_no and b.status_active=1 and  b.is_deleted=0 group by b.fabric_color_id");

		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
			?>
            </td>
            <td>
            <?
			//echo $color_library[$gmt_color_library[$color_wise_wo_result['fabric_color_id']]];
			//echo rtrim($gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]],",");
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
			//echo "lapdip_no from wo_po_lapdip_approval_info where job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result['fabric_color_id']."";
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_amount=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {


				if($db_type==0)
				{
					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty, sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate
					FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
					WHERE
					a.job_no=d.job_no and
					d.is_short=1 and
					a.id=d.pre_cost_fabric_cost_dtls_id and
					d.booking_no =$txt_booking_no and
					a.uom=$uom_id and
					a.id='".$result_fabric_description[csf('fabric_cost_dtls_id')]."' and
					a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
					a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
					a.construction='".$result_fabric_description[csf('construction')]."' and
					a.composition='".$result_fabric_description[csf('composition')]."' and
					a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
					d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
					d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
					d.pre_cost_remarks='".$result_fabric_description[csf('remarks')]."' and
					d.status_active=1 and
					d.is_deleted=0");
				}
				if($db_type==2)
				{
					 $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty, sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate
					FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
					WHERE
					a.job_no=d.job_no and
					d.is_short=1 and
					a.id=d.pre_cost_fabric_cost_dtls_id and
					d.booking_no =$txt_booking_no and
					a.uom=$uom_id and
					a.id='".$result_fabric_description[csf('fabric_cost_dtls_id')]."' and
					a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
					a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
					a.construction='".$result_fabric_description[csf('construction')]."' and
					a.composition='".$result_fabric_description[csf('composition')]."' and
					a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
					d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
					d.pre_cost_remarks='".$result_fabric_description[csf('remarks')]."' and

					nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
					d.status_active=1 and
					d.is_deleted=0");
				}

				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
				echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],0) ;
				$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('rate')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('rate')],4);
			//$total_grey_fab_qnty+=$color_wise_wo_result_qnty['grey_fab_qnty'];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			$amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
			if($amount!="")
			{
			echo number_format($amount,0);
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo number_format($total_fin_fab_qnty,0); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right">
            <?
			echo number_format($total_amount,0);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{

			$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty
											FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
											WHERE
											a.job_no=d.job_no and
											d.is_short=1 and
											a.id=d.pre_cost_fabric_cost_dtls_id and
											d.booking_no =$txt_booking_no and
											a.uom=$uom_id and
											a.id='".$result_fabric_description[csf('fabric_cost_dtls_id')]."' and
											a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
											a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
											a.construction='".$result_fabric_description[csf('construction')]."' and
											a.composition='".$result_fabric_description[csf('composition')]."' and
											a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
											d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
											d.pre_cost_remarks='".$result_fabric_description[csf('remarks')]."' and
											d.status_active=1 and
											d.is_deleted=0 ");
			list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
		?>
		<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],0) ;?></td>
		<td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
		<td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
		<?
		}
		?>
		<td align="right"><? echo number_format($grand_total_fin_fab_qnty,0);?></td>
		<td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
		<td align="right">
		<?
		echo number_format($grand_total_amount,0);
		?>
		</td>
		</tr>
		<tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				/*$color_wise_wo_sql_qnty=sql_select("select sum(b.fin_fab_qnty) as fin_fab_qnty,sum(b.grey_fab_qnty) as grey_fab_qnty
				  FROM
				  view_wo_fabric_booking_data_park a,
				  wo_booking_dtls b
				  WHERE
				  b.booking_no =$txt_booking_no  and
				  a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and
				  a.po_break_down_id=b.po_break_down_id and
				  a.color_size_table_id=b.color_size_table_id and
				  a.color_type_id='".$result_fabric_description['color_type_id']."' and
				  a.construction='".$result_fabric_description['construction']."' and
				  a.composition='".$result_fabric_description['composition']."' and
				  a.gsm_weight='".$result_fabric_description['gsm_weight']."' and
				  a.dia_width='".$result_fabric_description['dia_width']."' and
				  a.process_loss_percent='".$result_fabric_description['process_loss_percent']."' and
				  b.status_active=1 and
				  b.is_deleted=0
				  ");*/

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
			echo number_format($consumption_per_unit_fab,2);
			?>
            </td>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
			echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			?>
            </td>
            <td align="right" title="Only Allow Round Figer">
            <?
			echo number_format($consumption_per_unit_amuont,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}
	}
    }


    foreach($uom_arr as $uom_id=>$uom_val){
	if($cbo_fabric_source==2)
	{
	$nameArray_fabric_description= sql_select("select a.id as fabric_cost_dtls_id,a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , d.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.is_short=1 and
	a.uom=$uom_id and
	b.cons>0 and
	d.booking_no =$txt_booking_no and
	d.status_active=1 and
	d.is_deleted=0
	group by a.id,a.body_part_id,a.item_number_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,d.dia_width,b.remarks order by fabric_cost_dtls_id,a.body_part_id,d.dia_width");
	if(count($nameArray_fabric_description)>0){
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <caption>Fabric Details in <? echo $uom_val ?></caption>
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
        <td  rowspan="10" width="50"><p>Total Finish Fabric  <? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>

            <td  rowspan="10" width="50"><p>Avg Rate  <? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
            <td  rowspan="10" width="50"><p>Amount </p></td>

       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('remarks')]."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
			}


		?>

       </tr>
       <?

		  /*$gmt_color_library=return_library_array( "select gmts_color_id,contrast_color_id
		  FROM
		  wo_pre_cos_fab_co_color_dtls
		  WHERE
		  job_no ='$job_no'", "contrast_color_id", "gmts_color_id");*/
		  $gmt_color_library=array();
		  $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=$uom_id and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			//$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]].=$color_library[$gmt_color_row[csf("gmts_color_id")]]."," ;
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;
			//$grand_totalcons_per_finish=0;
			//$grand_totalcons_per_grey=0;
			//$color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE  booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
			$color_wise_wo_sql=sql_select("select b.fabric_color_id  FROM  wo_pre_cost_fabric_cost_dtls a ,wo_booking_dtls b  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.uom=$uom_id and b.booking_no = $txt_booking_no and b.status_active=1 and  b.is_deleted=0 group by b.fabric_color_id");

		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
           <!-- <td  width="120" align="left">
			<?

			//echo $color_library[$color_wise_wo_result['fabric_color_id']];

			?></td>-->
            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


			?>
            </td>
            <td>
            <?
			//echo $color_library[$gmt_color_library[$color_wise_wo_result['fabric_color_id']]];
			//echo rtrim($gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]],",");
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
			//echo "lapdip_no from wo_po_lapdip_approval_info where job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result['fabric_color_id']."";
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_amount=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {


				if($db_type==0)
				{
					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty, sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate
					FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
					WHERE
					a.job_no=d.job_no and
					d.is_short=1 and
					a.id=d.pre_cost_fabric_cost_dtls_id and
					d.booking_no =$txt_booking_no and
					a.uom=$uom_id and
					a.id='".$result_fabric_description[csf('fabric_cost_dtls_id')]."' and
					a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
					a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
					a.construction='".$result_fabric_description[csf('construction')]."' and
					a.composition='".$result_fabric_description[csf('composition')]."' and
					a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
					d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
					d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
					d.pre_cost_remarks='".$result_fabric_description[csf('remarks')]."' and
					d.status_active=1 and
					d.is_deleted=0");
				}
				if($db_type==2)
				{

					 $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty, sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate
					FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
					WHERE
					a.job_no=d.job_no and
					d.is_short=1 and
					a.id=d.pre_cost_fabric_cost_dtls_id and
					d.booking_no =$txt_booking_no and
					a.uom=$uom_id and

					a.id='".$result_fabric_description[csf('fabric_cost_dtls_id')]."' and
					a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
					a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
					a.construction='".$result_fabric_description[csf('construction')]."' and
					a.composition='".$result_fabric_description[csf('composition')]."' and
					d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
					a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
					d.pre_cost_remarks='".$result_fabric_description[csf('remarks')]."' and
					nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and

					d.status_active=1 and
					d.is_deleted=0");
				}

				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
				echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],0) ;
				$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('rate')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('rate')],4);
			//$total_grey_fab_qnty+=$color_wise_wo_result_qnty['grey_fab_qnty'];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			$amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
			if($amount!="")
			{
			echo number_format($amount,0);
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo number_format($total_fin_fab_qnty,0); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right">
            <?
			echo number_format($total_amount,0);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{

			$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty
											FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
											WHERE
											a.job_no=d.job_no and
											d.is_short=1 and
											a.id=d.pre_cost_fabric_cost_dtls_id and
											d.booking_no =$txt_booking_no and
											a.uom=$uom_id and
											a.id='".$result_fabric_description[csf('fabric_cost_dtls_id')]."' and
											a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
											a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
											a.construction='".$result_fabric_description[csf('construction')]."' and
											a.composition='".$result_fabric_description[csf('composition')]."' and
											a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
											d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
											d.pre_cost_remarks='".$result_fabric_description[csf('remarks')]."' and
											d.status_active=1 and
											d.is_deleted=0 ");
			list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
		?>
		<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],0) ;?></td>
		<td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
		<td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
		<?
		}
		?>
		<td align="right"><? echo number_format($grand_total_fin_fab_qnty,0);?></td>
		<td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
		<td align="right">
		<?
		echo number_format($grand_total_amount,0);
		?>
		</td>
		</tr>
		<tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				/*$color_wise_wo_sql_qnty=sql_select("select sum(b.fin_fab_qnty) as fin_fab_qnty,sum(b.grey_fab_qnty) as grey_fab_qnty
				  FROM
				  view_wo_fabric_booking_data_park a,
				  wo_booking_dtls b
				  WHERE
				  b.booking_no =$txt_booking_no  and
				  a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and
				  a.po_break_down_id=b.po_break_down_id and
				  a.color_size_table_id=b.color_size_table_id and
				  a.color_type_id='".$result_fabric_description['color_type_id']."' and
				  a.construction='".$result_fabric_description['construction']."' and
				  a.composition='".$result_fabric_description['composition']."' and
				  a.gsm_weight='".$result_fabric_description['gsm_weight']."' and
				  a.dia_width='".$result_fabric_description['dia_width']."' and
				  a.process_loss_percent='".$result_fabric_description['process_loss_percent']."' and
				  b.status_active=1 and
				  b.is_deleted=0
				  ");*/

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
			echo number_format($consumption_per_unit_fab,2);
			//$grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty),4)
			?>
            </td>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
			echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			//$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)
			?>
            </td>
            <td align="right" title="Only Allow Round Figer">
            <?
			echo number_format($consumption_per_unit_amuont,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}
	}
    }
	?>
        <br/>

        <?

		if($cbo_fabric_source==1 || $cbo_fabric_source==2){
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
        <tr>
        <?
		//echo "select a.colar_cuff_per,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id    and a.booking_no=$txt_booking_no and a.booking_type=1 c.body_part_id in(2) and a.status_active=1 and a.is_deleted=0";
		$colar_percent_size_wise_array=return_library_array( "select a.colar_cuff_per,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id    and a.booking_no=$txt_booking_no and a.booking_type=1 and c.body_part_id in(2) and a.status_active=1 and a.is_deleted=0", "gmts_sizes", "colar_cuff_per");
		//print_r($colar_percent_size_wise_array);
		$nameArray_item_size=sql_select( "select min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
		if(count($nameArray_item_size)>0)
		{
        ?>
        <td width="49%">
        <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
        <tr>
        <td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Collar -  Color & Size Breakdown in Pcs</b></td>
        </tr>
        <tr>
        <td width="70">Size</td>

        <?

		/*$nameArray_item_size=sql_select( "select b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by c.size_number_id,b.item_size order by c.size_number_id");*/
		foreach($nameArray_item_size  as $result_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
		<?
        }
        ?>
        <td rowspan="2" align="center"><strong>Total</strong></td>
        <td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
        </tr>
        <tr>
        <td>Collar Size</td>

        <?
        foreach($nameArray_item_size  as $result_item_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
		<?
        }
        ?>
         <?

			/*$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by c.color_number_id,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id");*/

			$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=2  and c.job_no_mst=a.job_no and a.job_no=$txt_job_no and b.gmts_sizes=d.gmts_size and C.SIZE_NUMBER_ID=D.GMTS_SIZE and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0  and c.status_active=1 and c.is_deleted=0  and d.status_active=1 and d.is_deleted=0 group by c.color_number_id,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			$color_total_collar=0;
			$color_total_collar_order_qnty=0;
			$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
			$constrast_color_arr=array();
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
				for($i=0;$i<count($constrast_color);$i++)
				{
					$constrast_color2=explode('_',$constrast_color[$i]);
					$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
				}
			}
		?>
			<tr>
            <td>
            <?
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
				$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
			}
			else
			{
				echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
				$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
			}
			?>

            </td>
            <?
            foreach($nameArray_item_size  as $result_size)
			{
				?>
				<td align="center" style="border:1px solid black">
				<?
				//$color_wise_wo_sql_qnty=sql_select("select c.color_number_id,sum(c.order_quantity) as order_quantity, sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and c.color_number_id='".$color_wise_wo_result['color_number_id']."' and c.size_number_id='".$result_size['size_number_id']."'");
				$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active=1 and is_deleted =0");

				list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
				$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
				$colar_excess_per=($plan_cut*$colar_excess_percent)/100;
				echo number_format($plan_cut+$colar_excess_per,0);
				$color_total_collar+=$plan_cut+$colar_excess_per;
				$color_total_collar_order_qnty+=$plan_cut;
				$grand_total_collar+=$plan_cut+$colar_excess_per;
				$grand_total_collar_order_qnty+=$plan_cut;
				?>
                </td>
				<?
			}
			?>

            <td align="center"><? echo number_format($color_total_collar,0); ?></td>
           <td align="center"><? echo number_format((($color_total_collar-$color_total_collar_order_qnty)/$color_total_collar_order_qnty)*100,2); ?></td>
            </tr>
            <?
		    }
			?>
            <tr>
                <td>Size Total</td>

                <?
                foreach($nameArray_item_size  as $result_size)
                {
                ?>
                <td style="border:1px solid black;  text-align:center"><? $colar_excess_pers=($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]+$colar_excess_pers,0); ?></td>
                <?
                }
                ?>
                <td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar,0); ?></td>
              <td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_collar-$grand_total_collar_order_qnty)/$grand_total_collar_order_qnty)*100,2); ?></td>
            </tr>
        </table>
        </td>
        <td width="2%">
        </td>
        <?
        }
		?>

        <?
		$cuff_percent_size_wise_array=return_library_array( "select a.colar_cuff_per,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id    and a.booking_no=$txt_booking_no and a.booking_type=1 and c.body_part_id in(3) and a.status_active=1 and a.is_deleted=0", "gmts_sizes", "colar_cuff_per");
		//print_r($cuff_percent_size_wise_array);
		$nameArray_item_size=sql_select( "select min(c.id) as id, b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");

		if(count($nameArray_item_size)>0)
		{
        ?>
        <td width="49%">
        <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
        <tr>
        <td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Cuff -  Color & Size Breakdown in Pcs</b></td>
        </tr>
        <tr>
        <td width="70">Size</td>

        <?
		foreach($nameArray_item_size  as $result_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
		<?
        }
        ?>
        <td rowspan="2" align="center"><strong>Total</strong></td>
       <td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
        </tr>
        <tr>
        <td>Cuff Size</td>

        <?
        foreach($nameArray_item_size  as $result_item_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
		<?
        }
        ?>
         <?

			$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and  d.status_active=1 and d.is_deleted=0 group by c.color_number_id ,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			$color_total_cuff=0;
			$color_total_cuff_order_qnty=0;
			$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
			$constrast_color_arr=array();
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
				for($i=0;$i<count($constrast_color);$i++)
				{
					$constrast_color2=explode('_',$constrast_color[$i]);
					$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
				}
			}
			//print_r($constrast_color_arr);
		?>
			<tr>
            <td>
            <?
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				///echo $color_wise_wo_result[csf('color_number_id')];
				echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]);
				$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
			}
			else
			{
				echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
				$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
			}
			?>

            </td>
            <?
            foreach($nameArray_item_size  as $result_size)
			{
				?>
				<td align="center" style="border:1px solid black">

				<?
				/*$color_wise_wo_sql_qnty=sql_select("select c.color_number_id,sum(c.order_quantity) as order_quantity, sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=3 and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and c.color_number_id='".$color_wise_wo_result['color_number_id']."' and c.size_number_id='".$result_size['size_number_id']."'");*/
				$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active=1 and is_deleted =0");

				list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
				$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
				$cuff_excess_per=(($plan_cut*2)*$cuff_excess_percent)/100;
				echo number_format($plan_cut*2+$cuff_excess_per,0);
				$color_total_cuff+=$plan_cut*2+$cuff_excess_per;
				$color_total_cuff_order_qnty+=$plan_cut*2;
				$grand_total_cuff+=$plan_cut*2+$cuff_excess_per;
				$grand_total_cuff_order_qnty+=$plan_cut*2;

				/*$cuff_excess_per=(($plan_cut_qnty[csf('plan_cut_qnty')]*2)*$cuff_excess_percent)/100;
				echo number_format($plan_cut_qnty[csf('plan_cut_qnty')]*2+$cuff_excess_per,0);
				$color_total_cuff+=$plan_cut_qnty[csf('plan_cut_qnty')]*2+$cuff_excess_per;
				$color_total_cuff_order_qnty+=$plan_cut_qnty[csf('order_quantity')]*2;
				$grand_total_cuff+=$plan_cut_qnty[csf('plan_cut_qnty')]*2+$cuff_excess_per;
				$grand_total_cuff_order_qnty+=$plan_cut_qnty[csf('order_quantity')]*2;*/

				?>

                </td>
				<?
			}
			?>

            <td align="center"><? echo number_format($color_total_cuff,0); ?></td>
           <td align="center"><? echo number_format((($color_total_cuff-$color_total_cuff_order_qnty)/$color_total_cuff_order_qnty)*100,2); ?></td>
            </tr>
            <?
		    }
			?>
            <tr>
                <td>Size Total</td>

                <?
                foreach($nameArray_item_size  as $result_size)
                {
                   /* $nameArray_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =$result_size[size_number_id]  and status_active=1 and is_deleted =0 order by id");
                foreach($nameArray_size_qnty as $result_size_qnty)
                {*/
                ?>
                <td style="border:1px solid black;  text-align:center"><? $cuff_excess_pers=(($size_tatal[$result_size[csf('size_number_id')]]*2)*$cuff_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]*2+$cuff_excess_pers,0); ?></td>
                <?
                //}
                }
                ?>
                <td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_cuff,0); ?></td>
               <td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_cuff-$grand_total_cuff_order_qnty)/$grand_total_cuff_order_qnty)*100,2); ?></td>
            </tr>
        </table>
        </td>
        <?
				}
		?>
        </tr>
        </table>
        <br/>
        <br/>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
        <tr>
        <?

		//echo "select a.colar_cuff_per,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id    and a.booking_no=$txt_booking_no and a.booking_type=1 c.body_part_id in(2) and a.status_active=1 and a.is_deleted=0";
		//$colar_percent_size_wise_array=return_library_array( "select a.colar_cuff_per,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id    and a.booking_no=$txt_booking_no and a.booking_type=1 and c.body_part_id in(2) and a.status_active=1 and a.is_deleted=0", "gmts_sizes", "colar_cuff_per");


		$colar_percent_size_wise_array=array();
		$colar_tipping_percent_size_wise_sql=sql_select( "select a.colar_cuff_per,b.color_number_id,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id    and a.booking_no=$txt_booking_no and a.booking_type=1 and c.body_part_id in(172) and a.status_active=1 and a.is_deleted=0");
		$colar_tipping_excess_percent_arr=array();
		foreach($colar_tipping_percent_size_wise_sql as $colar_percent_size_wise_row)
		{
			$colar_tipping_excess_percent_arr[$colar_percent_size_wise_row[csf('color_number_id')]][$colar_percent_size_wise_row[csf('gmts_sizes')]]=$colar_percent_size_wise_row[csf('colar_cuff_per')];
			//$colar_excess_percent_arr[$colar_percent_size_wise_row[csf('gmts_sizes')]]+=$colar_percent_size_wise_row[csf('colar_cuff_per')];

		}

		//print_r($colar_tipping_excess_percent_arr);
		$nameArray_item_size=sql_select( "select min(c.id) as id,b.item_size,c.size_number_id,	min(c.size_order) as size_order FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=172  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by size_order");


		if(count($nameArray_item_size)>0)
		{
        ?>
        <td width="49%">
        <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
        <tr>
        <td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Collar Tipping -  Color & Size Breakdown in Pcs</b></td>
        </tr>
        <tr>
        <td width="70">Size</td>

        <?

		/*$nameArray_item_size=sql_select( "select b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by c.size_number_id,b.item_size order by c.size_number_id");*/
		foreach($nameArray_item_size  as $result_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
		<?
        }
        ?>
        <td rowspan="2" align="center"><strong>Total</strong></td>
       <td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
        </tr>
        <tr>
        <td>Collar Size</td>

        <?
        foreach($nameArray_item_size  as $result_item_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
		<?
        }

		$color_wise_wo_sql=sql_select("select a.id, a.job_no, a.color_size_sensitive, a.color_break_down, a.process_loss_method, c.color_number_id , c.color_order, sum(c.plan_cut_qnty) as plan_cut_qnty
		FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d
		WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=172 and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and c.status_active=1 and c.is_deleted=0
		group by c.color_number_id, c.color_order, a.id, a.job_no, a.color_size_sensitive,a.color_break_down, a.process_loss_method
		order by c.color_order ");

		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			$color_total_collar=0;
			$color_total_collar_order_qnty=0;
			$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
			$constrast_color_arr=array();
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
				for($i=0;$i<count($constrast_color);$i++)
				{
					$constrast_color2=explode('_',$constrast_color[$i]);
					$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
				}
			}
		?>
			<tr>
            <td>
            <?
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
				$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
			}
			else
			{
				echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
				$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
			}
			?>

            </td>
            <?
            foreach($nameArray_item_size  as $result_size)
			{
				?>
				<td align="center" style="border:1px solid black">
				<?

				$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active=1 and is_deleted =0 ");




				list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
				$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
				$colar_tipping_excess_per=($plan_cut*$colar_tipping_excess_percent_arr[$color_wise_wo_result[csf('color_number_id')]][$result_size[csf('size_number_id')]])/100;
				echo number_format($plan_cut+$colar_tipping_excess_per,0);
				$collar_tiff_size_total_arr[$result_size[csf('size_number_id')]]+=number_format($plan_cut+$colar_tipping_excess_per,0,'','');
				$color_tipping_total_collar+=$plan_cut+$colar_tipping_excess_per;
				$color_tipping_total_collar_order_qnty+=$plan_cut;
				$grand_total_collar_tipping+=$plan_cut+$colar_tipping_excess_per;
				$grand_total_collar_tipping_order_qnty+=$plan_cut;



				?>
                </td>
				<?
			}
			?>

            <td align="center"><? echo number_format($color_tipping_total_collar,0); ?></td>
            <td align="center"><? echo number_format((($color_tipping_total_collar-$color_tipping_total_collar_order_qnty)/$color_tipping_total_collar_order_qnty)*100,2); ?></td>
            </tr>
            <?
		    }
			?>
            <tr>
                <td>Size Total</td>

                <?
                foreach($nameArray_item_size  as $result_size)
                {
                ?>
                <td style="border:1px solid black;  text-align:center">
				<?
				//$colar_excess_pers=($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]+$colar_excess_pers,0);
				echo number_format($collar_tiff_size_total_arr[$result_size[csf('size_number_id')]],0);

				?></td>
                <?
                }
                ?>
                <td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar_tipping,0); ?></td>
               <td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_collar_tipping-$grand_total_collar_tipping_order_qnty)/$grand_total_collar_tipping_order_qnty)*100,2); ?></td>
            </tr>
        </table>
        </td>
        <td width="2%">
        </td>
        <?
        }

		$cuff_tipping_percent_size_wise_array=$cuff_size_total=array();
		$cuff_tipping_percent_size_wise_sql=sql_select( "select a.colar_cuff_per,b.color_number_id,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id  and a.booking_no=$txt_booking_no and a.booking_type=1 and c.body_part_id in(214) and a.status_active=1 and a.is_deleted=0");
		foreach($cuff_tipping_percent_size_wise_sql as $cuff_percent_size_wise_row)
		{
			$cuff_tipping_percent_size_wise_array[$cuff_percent_size_wise_row[csf('color_number_id')]][$cuff_percent_size_wise_row[csf('gmts_sizes')]]=$cuff_percent_size_wise_row[csf('colar_cuff_per')];
		}


		$nameArray_item_size=sql_select( "select min(c.id) as id, b.item_size,c.size_number_id,	min(c.size_order) as size_order FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=214  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by size_order");


		if(count($nameArray_item_size)>0)
		{
        ?>
        <td width="49%">
        <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
        <tr>
        <td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Cuff Tipping-  Color & Size Breakdown in Pcs</b></td>
        </tr>
        <tr>
        <td width="70">Size</td>

        <?
		foreach($nameArray_item_size  as $result_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
		<?
        }
        ?>
        <td rowspan="2" align="center"><strong>Total</strong></td>
        <td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
        </tr>
        <tr>
        <td>Cuff Size</td>

        <?
        foreach($nameArray_item_size  as $result_item_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
		<?
        }
        ?>
         <?

			$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id, c.color_order, sum(c.plan_cut_qnty) as plan_cut_qnty
			FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d
			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=214  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and  d.status_active=1 and d.is_deleted=0
			group by c.color_number_id, c.color_order ,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method
			order by c.color_order");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			$color_total_cuff=0;
			$color_total_cuff_order_qnty=0;
			$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
			$constrast_color_arr=array();
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
				for($i=0;$i<count($constrast_color);$i++)
				{
					$constrast_color2=explode('_',$constrast_color[$i]);
					$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
				}
			}
		?>
			<tr>
            <td>
            <?
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]);
				$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
			}
			else
			{
				echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
				$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
			}
			?>

            </td>
            <?
            foreach($nameArray_item_size  as $result_size)
			{
				?>
				<td align="center" style="border:1px solid black">

				<?


				$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active=1 and is_deleted =0");



				list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
				$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
				$cuff_tipping_excess_per=(($plan_cut*2)*$cuff_tipping_percent_size_wise_array[$color_wise_wo_result[csf('color_number_id')]][$result_size[csf('size_number_id')]])/100;
				echo number_format($plan_cut*2+$cuff_tipping_excess_per,0);
				$cuff_tiffing_size_total[$result_size[csf('size_number_id')]]+=number_format($plan_cut*2+$cuff_tipping_excess_per,0,'','');
				//echo $cuff_tipping_percent_size_wise_array[$color_wise_wo_result[csf('color_number_id')]][$result_size[csf('size_number_id')]];
				$color_total_cuff_tiffing+=$plan_cut*2+$cuff_tipping_excess_per;
				$color_total_cuff_tiffing_order_qnty+=$plan_cut*2;
				$grand_total_cuff_tiffing+=$plan_cut*2+$cuff_tipping_excess_per;
				$grand_total_cuff_tiffing_order_qnty+=$plan_cut*2;
				?>

                </td>
				<?
			}
			?>

            <td align="center"><? echo number_format($color_total_cuff_tiffing,0); ?></td>
            <td align="center"><? echo number_format((($color_total_cuff_tiffing-$color_total_cuff_tiffing_order_qnty)/$color_total_cuff_tiffing_order_qnty)*100,2);  ?></td>
            </tr>
            <?
		    }
			?>
            <tr>
                <td>Size Total</td>

                <?
                foreach($nameArray_item_size  as $result_size)
                {
                   /* $nameArray_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =$result_size[size_number_id]  and status_active=1 and is_deleted =0 order by id");
                foreach($nameArray_size_qnty as $result_size_qnty)
                {*/
                ?>
                <td style="border:1px solid black;  text-align:center">
				<?
				//$cuff_excess_pers=(($size_tatal[$result_size[csf('size_number_id')]]*2)*$cuff_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]*2+$cuff_excess_pers,0);
				echo number_format($cuff_tiffing_size_total[$result_size[csf('size_number_id')]],0);
				?></td>
                <?
                //}
                }
                ?>
                <td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_cuff_tiffing,0); ?></td>
               <td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_cuff_tiffing-$grand_total_cuff_tiffing_order_qnty)/$grand_total_cuff_tiffing_order_qnty)*100,2); ?></td>
            </tr>
        </table>
        </td>
        <?
				}
		?>
        </tr>
        </table>
        <br/>

        <table  width="100%"  border="0" cellpadding="0" cellspacing="0">
            <tr>
                <td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
                    <?php echo get_spacial_instruction($txt_booking_no); ?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top">
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr align="center">
                        <td><b>Approved Instructions</b></td>

                        </tr>
                        <tr>
                        <td>
                    <?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
                    </td>
                    </tr>
                    </table>
                	<br />

                </td>

            </tr>
        </table>
       <br>

  <?
       //------------------------------ Query for TNA start-----------------------------------
				$po_id_all=str_replace("'","",$txt_order_no_id);
				$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
				$tna_start_sql=sql_select( "select id,po_number_id,
								(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
								(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
								(case when task_number=60 then task_start_date else null end) as knitting_start_date,
								(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
								(case when task_number=61 then task_start_date else null end) as dying_start_date,
								(case when task_number=61 then task_finish_date else null end) as dying_end_date,
								(case when task_number=73 then task_start_date else null end) as finishing_start_date,
								(case when task_number=73 then task_finish_date else null end) as finishing_end_date,
								(case when task_number=84 then task_start_date else null end) as cutting_start_date,
								(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
								(case when task_number=86 then task_start_date else null end) as sewing_start_date,
								(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
								(case when task_number=110 then task_start_date else null end) as exfact_start_date,
								(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
								(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
								(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
								from tna_process_mst
								where status_active=1 and po_number_id in($po_id_all)");
				$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
				$tna_date_task_arr=array();
				foreach($tna_start_sql as $row)
				{
					if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
					{
						if($tna_fab_start=="")
						{
							$tna_fab_start=$row[csf("fab_booking_start_date")];
						}
					}


					if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
					}
					if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
					}
					if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
					}
					if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
					}
					if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
					}
					if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
					}
					if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
					}
				}

	//------------------------------ Query for TNA end-----------------------------------
	?>

    <fieldset id="div_size_color_matrix" style="max-width:1000; display:none">
        <legend>TNA Information</legend>
        <!--<span style="font-size:180; font-weight:bold;"></span>-->
        <table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
            <tr>
            	<td rowspan="2" align="center" valign="top">SL</td>
            	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
                <td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
                <td colspan="2" align="center" valign="top"><b>Knitting</b></td>
                <td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
                <td colspan="2" align="center" valign="top"><b>Finishing Fabric</b></td>
                <td colspan="2" align="center" valign="top"><b>Cutting </b></td>
                <td colspan="2" align="center" valign="top"><b>Sewing </b></td>
                <td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
            </tr>
            <tr>
            	<td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

            </tr>
            <?
			$i=1;
			foreach($tna_date_task_arr as $order_id=>$row)
			{
				 //$tna_date_task_arr//knitting_start_date dying_start_date finishing_start_date cutting_start_date sewing_start_date exfact_start_date
				?>
                <tr>
                	<td><? echo $i; ?></td>
                    <td><? echo $po_num_arr[$order_id]; ?></td>
                    <td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
                	<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
                </tr>
                <?
				$i++;
			}
			?>

        </table>
        </fieldset>



        <?
		}// fabric Source End
		?>
        <br>
       
        <?
    
	 $desg_name=return_library_array( "select id, custom_designation from lib_designation", "id", "custom_designation"  );
	 $data_array=sql_select("select b.approved_by,b.approved_no, b.approved_date, c.user_full_name,c.designation from  wo_booking_mst a , approval_history b, user_passwd c where a.id=b.mst_id and b.approved_by=c.id and a.booking_no=$txt_booking_no and b.entry_form=12 order by b.id asc");
	?>
       <table  width="100%" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="3" style="border:1px solid black;">Approval Status</th>
                </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th>
                <th width="50%" style="border:1px solid black;">Name/Designation</th>
                <th width="27%" style="border:1px solid black;">Approval Date</th>
                <th width="20%" style="border:1px solid black;">Approval No</th>
                </tr>
            </thead>
            <tbody>
            <?
			$i=1;
			foreach($data_array as $row){
			?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $i;?></td><td width="50%" style="border:1px solid black;"><? echo $row[csf('user_full_name')].'/'.$desg_name[$row[csf('designation')]];?></td><td width="27%" style="border:1px solid black;"><? echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); //echo change_date_format($row[csf('approved_date')],"dd-mm-yyyy","-");?></td><td width="20%" style="border:1px solid black;"><? echo $row[csf('approved_no')];?></td>
                </tr>
                <?
				$i++;
			}
				?>
            </tbody>
        </table>
          <br>  <br>
        <?
		//$sqlHis="select approval_cause from approval_cause_refusing_his where entry_form=7 and booking_id='$wo_id' and approval_type=2 and status_active=1 and is_deleted=0 order by id Desc";
		$booking_id=return_field_value( "id", "wo_booking_mst","booking_no=$txt_booking_no");
		$user_nameArr=return_library_array( "select id, user_name from user_passwd ", "id", "user_name"  );
	//	$un_approve_reques_data_array=sql_select("select b.id,b.approval_cause, b.user_id, b.insert_date from fabric_booking_approval_cause b left join approval_cause_refusing_his a on b.id=a.cause_id   where  b.booking_id=$booking_id and b.entry_form=12 and b.approval_type=2 order by b.id");
		$un_approve_reques_data_array=sql_select("select b.id,b.approval_cause, b.user_id, b.insert_date from fabric_booking_approval_cause b    where  b.booking_id=$booking_id and b.entry_form=12 and b.approval_type=2 order by b.id");
		
	//echo "select a.id,a.cause_id,a.approval_cause, a.user_id, a.insert_date from approval_cause_refusing_his a, fabric_booking_approval_cause b where b.id=a.cause_id and b.booking_id=$booking_id and b.entry_form=12 and a.approval_type=2 order by a.id";
	foreach($un_approve_reques_data_array as $hrow)
		{
			$approval_data=$hrow[csf('id')];
			$unapprove_cause_arr[$approval_data]['insert_date']=$hrow[csf('insert_date')];
			$unapprove_cause_arr[$approval_data]['user_id']=$hrow[csf('user_id')];
			$unapprove_cause_arr[$approval_data]['approval_cause']=$hrow[csf('approval_cause')];
			$causeArrChk[$hrow[csf('approval_cause')].'_'.$hrow[csf('id')]]=$hrow[csf('approval_cause')].'_'.$hrow[csf('id')];
		}
		
		/*$un_approve_reques_data_cause_array=sql_select("select b.id,b.approval_cause,b.user_id,b.insert_date,b.update_date from fabric_booking_approval_cause b where  b.booking_id=$booking_id and b.entry_form=12 and b.approval_type=2 and b.status_active=1 order by b.id");
		//echo "select b.id,b.approval_cause,b.user_id,b.insert_date,b.update_date from fabric_booking_approval_cause b where  b.booking_id=$booking_id and b.entry_form=12 and b.approval_type=2 and b.status_active=1 order by b.id";
		foreach($un_approve_reques_data_cause_array as $hrow)
		{
			if($causeArrChk[$hrow[csf('approval_cause')].'_'.$hrow[csf('id')]]=='')
			{
			$insert_date=$hrow[csf('insert_date')];
			if(strtotime($hrow[csf('update_date')])>0)
			{
				$insert_date=$hrow[csf('update_date')];	
			}
			$approval_data=$hrow[csf('id')];
			$unapprove_cause_arr[$approval_data]['insert_date']=$insert_date;
			$unapprove_cause_arr[$approval_data]['user_id']=$hrow[csf('user_id')];
			$unapprove_cause_arr[$approval_data]['approval_cause']=$hrow[csf('approval_cause')];
			}
		}*/
		
		
		?>
		<table align="center" cellspacing="0" width="100%" class="rpt_table" border="1" rules="all">
			<thead>
				<th width="30">SL</th>
                <th width="200">Rev. Date</th>
                <th width="200">Rev. By</th>
				<th>Reason of Revision</th>
			</thead>
		 <tbody>
			<?
			$i=1;
			foreach($unapprove_cause_arr as $cause=>$hrow)
			{
				if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
				$causeArr=explode("_",$cause);
				?>
				<tr bgcolor="<?=$bgcolor; ?>" onClick="change_color('tr_<?=$i; ?>','<?=$bgcolor; ?>');">
                  	<td width="30"><?=$i; ?></td>
					<td width="200"><?=$hrow[('insert_date')]; ?></td>
                    <td width="200"><?=$user_nameArr[$hrow[('user_id')]]; ?></td>
					<td style="word-break:break-all"><?=$hrow[('approval_cause')]; ?></td>
				</tr>
				<?
				$i++;
			}
			?>
            </tbody>
        </table>
        
        <br/>
        <?
		//echo "select responsible_dept,	responsible_person,	reason from wo_booking_dtls where booking_no =$txt_booking_no";
		//"select id,department_name from  lib_department where status_active=1 and is_deleted=0 order by  department_name"
		$department_name_library=return_library_array( "select id,department_name from  lib_department where status_active=1 and is_deleted=0 order by  department_name", "id", "department_name"  );

		//$sql_responsible= sql_select("select responsible_dept,	responsible_person,	reason from wo_booking_dtls where booking_no =$txt_booking_no and fin_fab_qnty>0");
		/*echo "SELECT  a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,avg(b.process_loss_percent) as process_loss_percent,avg(rmg_qty) as rmg_qty, b.responsible_dept,	b.responsible_person,	b.reason FROM wo_pre_cost_fabric_cost_dtls a,wo_booking_dtls b where b.booking_no =$txt_booking_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.status_active=1 and
b.is_deleted=0 and b.grey_fab_qnty>0 group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.responsible_dept,	b.responsible_person,	b.reason order by a.body_part_id";*/
		$sql_responsible= sql_select("SELECT  a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,b.dia_width,avg(b.process_loss_percent) as process_loss_percent,avg(rmg_qty) as rmg_qty, b.division_id,b.responsible_dept,	b.responsible_person,	b.reason FROM wo_pre_cost_fabric_cost_dtls a,wo_booking_dtls b where b.booking_no =$txt_booking_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.status_active=1 and
b.is_deleted=0 and b.grey_fab_qnty>0 group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,b.dia_width,b.responsible_dept,	b.responsible_person,b.division_id,	b.reason order by a.body_part_id");
		if(count($sql_responsible)>0)
		{
		?>
         <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
         <tr>
         <td>
          #
         </td>
          <td>
         Fabric Description
         </td>
          <td>
        	 Division
         </td>
		   <td>
       		  Responsible Dept.
         </td>
         <td>
         Responsible person
         </td>
         <td>
         Reason
         </td>
         </tr>
         <?
		 $ir=1;
		foreach($sql_responsible as $sql_responsible_row)
		{
			?>
             <tr>
             <td>
             <?  echo $ir; ?>
             </td>
             <td>
             <?  echo $body_part[$sql_responsible_row[csf('body_part_id')]].','.$color_type[$sql_responsible_row[csf('color_type_id')]].','.$sql_responsible_row[csf('construction')].','.$sql_responsible_row[csf('composition')].','.$sql_responsible_row[csf('gsm_weight')].','.$sql_responsible_row[csf('dia_width')].','.$fabric_typee[$sql_responsible_row[csf('width_dia_type')]]; ?>
             </td>
			  <td>
            <?  echo $short_division_array[$sql_responsible_row[csf('division_id')]]; ?>
             </td>
              <td>
             <?
			 $responsible_dept_st="";
			 $responsible_dept_arr=explode( ",",$sql_responsible_row[csf('responsible_dept')]);
			 foreach($responsible_dept_arr as $key => $value)
			 {
				 $responsible_dept_st.= $department_name_library[$value].", ";
			 }
			 echo rtrim($responsible_dept_st,", ");
			 ?>
             </td>
             <td>
            <?  echo $sql_responsible_row[csf('responsible_person')]; ?>
             </td>
             <td>
              <?  echo $sql_responsible_row[csf('reason')]; ?>
             </td>
             </tr>
            <?
			$ir++;

		}
		 ?>
         </table>
         <?
		}
		 ?>
         

         <!--<br><br><br><br>-->
         <?
		 	echo signature_table(4, $cbo_company_name, "1330px");
			echo "****".custom_file_name($txt_booking_no,$style_sting,$txt_job_no);
		 ?>

       </div>
       <?
	   exit();
}
// new print button for Northan
if($action=="show_fabric_booking_report_ntg")
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$report_type=str_replace("'","",$report_type);

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	//$supplier_address_arr=return_library_array( "select id,address_1 from   lib_supplier",'id','address_1');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	//
	?>
	<div style="width:1330px" align="center">
    <?php
$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12");
list($nameArray_approved_row) = $nameArray_approved;
$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
list($nameArray_approved_date_row) = $nameArray_approved_date;
$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
list($nameArray_approved_comments_row) = $nameArray_approved_comments;
$path = str_replace("'", "", $path);
if ($path == "") {
	$path = '../../';
}
?>										<!--    Header Company Information         -->
       <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black" >
           <tr>
               <td width="220">
               <?
			   if($report_type==1)
			   {
			   ?>
               <img  src='../../<? echo $imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
               <?
			   }
			   else if($report_type==2)
			   {
			   ?>
               <img  src='../<? echo $imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
               <?
			   }
			   else
			   {
			   ?>
               <img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
               <?
			   }
			   ?>
               </td>
               <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:20px;">
                              <?php
echo $company_library[$cbo_company_name];
?>
                            </td>
                            <td rowspan="3" width="250">

                               <span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($txt_job_no,"'"); ?></b></span>
                               <br/>
                                <?
								 if($nameArray_approved_row[csf('approved_no')]>1)
								 {
								 ?>
								 <b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
                                  <br/>
								  Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
								  <?
								 }
							  	?>


                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:14px">
                            <?
                            $nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
							//$location=return_field_value("location_name","lib_location","id=$data[3]" );
							//$nameArray=sql_select("select location_name from wo_po_details_master where job_no=$txt_job_no");
							if($txt_job_no!="")
							{
							 $location=return_field_value( "location_name", "wo_po_details_master","job_no='$txt_job_no'");
							}
							else
							{
							$location="";
							}

							foreach ($nameArray as $result)
                            {
							 echo  $location_name_arr[$location];
                            ?>

                               <!-- Plot No: <? //echo $result[csf('plot_no')]; ?>
                                Level No: <? //echo $result[csf('level_no')]?>
                                Road No: <? //echo $result[csf('road_no')]; ?>
                                Block No: <? //echo $result[csf('block_no')];?>
                                City No: <? //echo $result[csf('city')];?>
                                Zip Code: <? //echo $result[csf('zip_code')]; ?>
                                Province No: <?php //echo $result[csf('province')];?>
                                Country: <? //echo $country_arr[$result[csf('country_id')]]; ?> --><br>
                                Email Address: <? echo $result[csf('email')];?>
                                Website No: <? echo $result[csf('website')]; ?>

                                <?

                            }

                            ?>
                               </td>
                            </tr>
                            <tr>
                            <td align="center" style="font-size:20px">
                                <strong><? //if($report_type==1) echo str_replace("'","",$report_title);else echo 'Short Fabric Booking';
								if($report_title !=""){ echo str_replace("'","",$report_title);} else { echo "General Work Order";}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
                             </td>
                            </tr>
                      </table>
                </td>
            </tr>
       </table>
                <?
				$uom=0;
				$job_no='';
				$total_set_qnty=0;
				$colar_excess_percent=0;
				$cuff_excess_percent=0;
				$rmg_process_breakdown=0;
				$poid=str_replace("'","",$txt_order_no_id);
				$po_date_arr=array();
				$sql_po_date= "select job_no_mst,MIN(pub_shipment_date) pub_shipment_date,MAX(pub_shipment_date) pub_shipment_date_max from  wo_po_break_down  where job_no_mst=$txt_job_no and id in($poid)  group by job_no_mst order by pub_shipment_date";
				 $poArray=sql_select($sql_po_date);
				foreach($poArray as $row)
				{
					$po_date_arr[$row[csf('job_no_mst')]]=change_date_format($row[csf('pub_shipment_date')]).','.change_date_format($row[csf('pub_shipment_date_max')]);
				}
				//print_r($po_date_arr);
                $nameArray=sql_select( "select a.booking_no, a.booking_date, a.supplier_id, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.pay_mode, a.rmg_process_breakdown, a.insert_date, a.update_date, a.uom, a.remarks, a.short_booking_type, b.job_no, b.buyer_name, b.style_ref_no, b.gmts_item_id, b.order_uom, b.total_set_qnty, b.style_description, b.season, b.season_matrix,b.season_buyer_wise, b.order_repeat_no, b.product_dept, b.product_code, b.pro_sub_dep, b.dealing_marchant, b.client_id, b.qlty_label from wo_booking_mst a, wo_po_details_master b where a.job_no=b.job_no and a.booking_no=$txt_booking_no");
				foreach ($nameArray as $result)
				{
					$total_set_qnty=$result[csf('total_set_qnty')];
					$colar_excess_percent=$result[csf('colar_excess_percent')];
				    $cuff_excess_percent=$result[csf('cuff_excess_percent')];
					$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
					$po_no_arr=array();
					$shipment_date="";$shipment_date_max="";
					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date,MAX(pub_shipment_date) pub_shipment_date_max from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number";
					//echo "select po_number,MIN(pub_shipment_date) pub_shipment_date,MAX(pub_shipment_date) pub_shipment_date_max from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $row_po)
					{
						$po_no_arr[$row_po[csf('po_number')]]=$row_po[csf('po_number')];
						//$shipment_date.=change_date_format($row_po[csf('pub_shipment_date')],'dd-mm-yyyy','-').",";
						//$shipment_date_max.=change_date_format($row_po[csf('pub_shipment_date_max')],'dd-mm-yyyy','-').",";
						//$shipment_date_con=change_date_format($row_po[csf('pub_shipment_date')],'dd-mm-yyyy','-').",".change_date_format($row_po[csf('pub_shipment_date_max')],'dd-mm-yyyy','-');
					}
					$po_no=implode(",",$po_no_arr);
					$shipment_date=$po_date_arr[$result[csf('job_no')]];

					$lead_time_arr=array();
					if($db_type==0)
					{
					$sql_lead_time= "select DATEDIFF(pub_shipment_date,po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					if($db_type==2)
					{
					$sql_lead_time= "select (pub_shipment_date-po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					$data_array_lead_time=sql_select($sql_lead_time);
					foreach ($data_array_lead_time as $row_lead_time)
					{
						$lead_time_arr[]=$row_lead_time[csf('date_diff')];
						//$shipment_date.=change_date_format($row_po['pub_shipment_date'],'dd-mm-yyyy','-').",";
					}
					$lead_time=implode(",",array_unique($lead_time_arr));
					$po_received_date="";
					$sql_po_received_date= "select MIN(po_received_date) as po_received_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					$data_array_po_received_date=sql_select($sql_po_received_date);
					foreach ($data_array_po_received_date as $row_po_received_date)
					{
						$po_received_date=change_date_format($row_po_received_date[csf('po_received_date')],'dd-mm-yyyy','-');
						//$shipment_date.=change_date_format($row_po['pub_shipment_date'],'dd-mm-yyyy','-').",";
					}


				   $daysInHand_arr=array();
				   $WOPreparedAfter_arr=array();
				   $shiping_status_arr=array();
					$sql_po= "select po_number,MIN(pub_shipment_date) pub_shipment_date, MIN(insert_date) as insert_date,shiping_status from wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number,shiping_status";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $rows)
					{
						$daysInHand_arr[]=(datediff('d',date('d-m-Y',time()),$rows[csf('pub_shipment_date')])-1);
						//$daysInHand=(datediff('d',date('d-m-Y',time()),$rows[csf('pub_shipment_date')])-1).",";
						$booking_date=$result[csf('update_date')];
						if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
						{
							$booking_date=$result[csf('insert_date')];
						}
						//$WOPreparedAfter.=(datediff('d',$rows[csf('insert_date')],$booking_date)-1).",";
						$WOPreparedAfter_arr[]=(datediff('d',$rows[csf('insert_date')],$booking_date)-1);

						if($rows[csf('shiping_status')]==1)
						{
						//$shiping_status.= "FP".",";
						$shiping_status_arr[]="FP";
						}
						else if($rows[csf('shiping_status')]==2)
						{
						//$shiping_status.= "PS".",";
						$shiping_status_arr[]="PS";

						}
						else if($rows[csf('shiping_status')]==3)
						{
						//$shiping_status.= "FS".",";
						$shiping_status_arr[]="FS";
						}

					}
					$daysInHand=implode(",",array_unique($daysInHand_arr));
					$WOPreparedAfter=implode(",",array_unique($WOPreparedAfter_arr));
					$shiping_status=implode(",",array_unique($shiping_status_arr));

				if($db_type==2) $group_concat_all=" listagg(cast(b.grouping as varchar2(4000)),',') within group (order by b.grouping) as grouping,
	                                    listagg(cast(b.file_no as varchar2(4000)),',') within group (order by b.file_no) as file_no  ";
				else { $group_concat_all="group_concat(b.grouping) as grouping, group_concat(b.file_no) as file_no";}
				$data_array3=sql_select("select a.job_no,a.company_name,a.buyer_name,$group_concat_all from wo_po_details_master a, wo_po_break_down b where b.id in (".$result[csf('po_break_down_id')].") and a.job_no=b.job_no_mst group by a.job_no,a.company_name,a.buyer_name");
				//echo $sql_grouping= "select booking_no  from wo_booking_dtls  where  po_break_down_id in(".$result[csf('po_break_down_id')].") and booking_type=1 and is_short=2 ";
				/*if($db_type==2) $group_concat_book="listagg(cast(booking_no as varchar2(4000)),',') within group (order by booking_no) as booking_no";
				else  $group_concat_book="group_concat(distinct booking_no) as booking_no ";

				$main_fab_booking_no=return_field_value( "$group_concat_book", "wo_booking_dtls","po_break_down_id in(".$result[csf('po_break_down_id')].") and booking_type=1 and is_short=2","booking_no");
				$main_fab_booking_no=implode(",",array_unique(explode(",",$main_fab_booking_no)));*/
				$mb_arr=array();
				$sql_mb= sql_select("select booking_no  from wo_booking_dtls  where  po_break_down_id in(".$result[csf('po_break_down_id')].") and booking_type=1 and is_short=2 ");                foreach($sql_mb as $row_mb){
					$mb_arr[$row_mb[csf('booking_no')]]=$row_mb[csf('booking_no')];

				}
				$main_fab_booking_no=implode(",",$mb_arr);
				?>
       <table width="100%" style="border:1px solid black;table-layout: fixed;" >
            <tr>
                <td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
            </tr>
            <tr>
                <td width="200"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
                <td width="220">:&nbsp;<span style="font-size:18px"><b><? $buyer_name_str=""; if($result[csf('client_id')]!=0) $buyer_name_str=$buyer_name_arr[$result[csf('buyer_name')]]."-".$buyer_name_arr[$result[csf('client_id')]]; else $buyer_name_str=$buyer_name_arr[$result[csf('buyer_name')]]; echo $buyer_name_str; ?></b></span></td>
                <td width="200"><span style="font-size:12px"><b>Dept.</b></span></td>
                <td width="220">:&nbsp;<? echo $product_dept[$result[csf('product_dept')]] ; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></td>
                <td width="200"><span style="font-size:12px"><b>Order Qnty</b></span></td>
                <td>:&nbsp; <?=$po_qnty_tot1." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?> </td>
            </tr>
            <tr>

                <td style="font-size:12px"><b>Garments Item</b></td>
                <td>:&nbsp;
				<?
				$gmts_item_name="";
				$gmts_item=explode(',',$result[csf('gmts_item_id')]);
				for($g=0;$g<=count($gmts_item); $g++)
				{
					$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
				}
				echo rtrim($gmts_item_name,',');
				?>
                </td>
                <td style="font-size:12px"><b>Booking Release Date</b></td>
                <td>:&nbsp;
				<?
				$booking_date=$result[csf('update_date')];
				if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
				{
					$booking_date=$result[csf('insert_date')];
				}
				echo change_date_format($booking_date,'dd-mm-yyyy','-','');
				?>&nbsp;&nbsp;&nbsp;</td>
                <td style="font-size:18px"><b>Style Ref.</b>   </td>
                <td style="font-size:18px">:&nbsp;<b><? echo $style_sting=$result[csf('style_ref_no')];?> </b>   </td>
            </tr>
             <tr>
                <td style="font-size:12px"><b>Style Des.</b></td>
                <td>:&nbsp;<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
                <td style="font-size:12px"><b>Lead Time </b>   </td>
                <td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;">:&nbsp;<?=implode(",",array_filter(array_unique(explode(",",$lead_time))));?> </td>
                <td style="font-size:12px"><b>Dealing Merchandiser</b></td>
                <td>:&nbsp;<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>
            </tr>

            <tr>
                <td style="font-size:12px"><b>Supplier Name</b>   </td>
                <td>:&nbsp;<?
				if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3){
					echo $company_library[$result[csf('supplier_id')]];
					}
					else{
					echo $supplier_name_arr[$result[csf('supplier_id')]];
					}
				//echo $supplier_name_arr[$result[csf('supplier_id')]];?>    </td>
                <td style="font-size:12px"><b>Delivery Date</b></td>
               	<td>:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
                <td style="font-size:18px"><b>Booking No </b>   </td>
                <td style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?> <? echo "(".$unit_of_measurement[$result[csf('uom')]].")"; $uom=$result[csf('uom')];?></td>

              <?
              //$shipment_date=implode(",",array_unique(explode(",",rtrim($shipment_date,","))));
			  // $shipment_date_max=implode(",",array_unique(explode(",",rtrim($shipment_date_max,","))));//rtrim($shipment_date_max,",");
			 //  if($shipment_date!='' && $shipment_date_max!='') $ship_date= $shipment_date.','.$shipment_date;
			 //  else if($shipment_date!='')  $ship_date= $shipment_date;
			   //else if($shipment_date_max!='')  $ship_date= $shipment_date_max;
			   //echo shipment_date; season_buyer_wise
			  ?>

            </tr>
            <tr>
                <td style="font-size:12px"><b>Season</b></td>
                <td>:&nbsp;<?

				$season_matrix=return_field_value("season_name","lib_buyer_season","id=".$result[csf('season_buyer_wise')],"season_name");

				echo $season_matrix; ?></td>
                <td  style="font-size:12px"><b>Attention</b></td>
                <td  >:&nbsp;<? echo $result[csf('attention')]; ?></td>
                <td  style="font-size:12px"><b>Po Received Date</b></td>
                <td  >:&nbsp;<? echo $po_received_date; ?></td>



            </tr>
           <tr>
               <td style="font-size:18px"><b>Order No</b></td>
               <td style="font-size:18px;overflow:hidden;text-overflow: ellipsis;white-space: nowrap;" colspan="3">:&nbsp;<b><?=implode(",",array_filter(array_unique(explode(",",$po_no)))); ?></b></td>
               <td  style="font-size:12px"><b>Repeat No</b></td>
               <td  >:&nbsp;<? echo $result[csf('order_repeat_no')]; ?></td>
            </tr>
            <tr>
               <td style="font-size:12px"><b>Shipment Date</b></td>
                <td colspan="3"> :&nbsp;<?=implode(",",array_filter(array_unique(explode(",",$shipment_date)))); ?></td>
                <td  style="font-size:12px"><b>Quality Label</b></td>
               <td  >:&nbsp;<? echo $quality_label[$result[csf('qlty_label')]]; ?></td>

            </tr>

            </tr>
            <tr>
               <td style="font-size:12px"><b>WO Prepared After</b></td>
               <td  style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;<?=implode(",",array_filter(array_unique(explode(",",$WOPreparedAfter)))).' Days' ?></td>

               <td style="font-size:12px"><b>Ship.days in Hand</b></td>
               <td  style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;<?=implode(",",array_filter(array_unique(explode(",",$daysInHand)))).' Days'?></td>

               <td style="font-size:12px"><b>Ex-factory status</b></td>
               <td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;<?=implode(",",array_filter(array_unique(explode(",",$shiping_status)))); ?></td>

            </tr>
           <tr>
               <td style="font-size:18px"><b>Internal Ref No</b></td>
               <td style="font-size:18px"> :&nbsp;<b><?=implode(",",array_unique(explode(",",$data_array3[0][csf("grouping")]))); ?></b></td>
               <td style="font-size:18px"><b>File no</b></td>
               <td style="font-size:18px"> :&nbsp;<b><?=implode(",",array_unique(explode(",",$data_array3[0][csf("file_no")])));?></b></td>
               <td style="font-size:18px"><b>Currency</b></td>
               <td style="font-size:18px"> :&nbsp;<b><? echo  $currency[$result[csf("currency_id")]];?></b></td>
            </tr>
            <tr>
                <td style="font-size:18px"><b>Main Fab. Booking No</b></td>
               <td style="font-size:18px" colspan="5"> : <? echo $main_fab_booking_no?></td>
          </tr>
          <tr>
               <td style="font-size:18px"><b>Remarks</b></td>
               <td style="font-size:18px" colspan="3"> :<? echo $result[csf('remarks')]; ?></td>
               <td style="font-size:18px"><b>Short Booking Type</b></td>
               <td style="font-size:18px"> :<? echo $short_booking_type[$result[csf('short_booking_type')]]?></td>
          </tr>
        </table>
           <?
			}
			if($cbo_fabric_source==1 || $cbo_fabric_source==2 || $cbo_fabric_source==3 || $cbo_fabric_source==4)
			{
			//$nameArray_size=sql_select( "select distinct size_number_id from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  	is_deleted=0 and status_active=1 order by size_number_id");
			//$nameArray_size=sql_select( "select  size_number_id,min(id) as id,	min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  	is_deleted=0 and status_active=1 group by size_number_id order by id");
			$nameArray_size=sql_select( "select  size_number_id,min(id) as id,	min(size_order) as size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  	is_deleted=0 and status_active=1 group by size_number_id order by size_order");

		   ?>
            <table width="100%" >
		    <tr>
            <td width="800">
                <div id="div_size_color_matrix" style="float:left; max-width:1000;">
            	<fieldset id="div_size_color_matrix" style="max-width:1000;">
 				<legend>Size and Color Breakdown</legend>
 				<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
                    <tr>
                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                    <?
						foreach($nameArray_size  as $result_size)
                        {	     ?>
                        <td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
                    <?	}    ?>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                        <td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                    </tr>
                    <?
					$color_size_order_qnty_array=array();
					$color_size_qnty_array=array();
					$size_tatal=array();
					$size_tatal_order=array();
					for($c=0;$c<count($gmts_item); $c++)
				    {
					$item_size_tatal=array();
					$item_size_tatal_order=array();
					$item_grand_total=0;
					$item_grand_total_order=0;
					//$nameArray_color=sql_select( "select distinct color_number_id from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 order by color_number_id");
					//$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id  order by id");
					$nameArray_color=sql_select( "select  color_number_id,min(id) as id,min(color_order) as color_order from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id  order by color_order");
					?>
                    <tr>
                    <td style="border:1px solid black" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>

                    </tr>
                    <?
					foreach($nameArray_color as $result_color)
                    {
                    ?>
                    <tr>
                        <td align="center" style="border:1px solid black"><? echo $color_library[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
                        <?
						$color_total=0;
						$color_total_order=0;

						foreach($nameArray_size  as $result_size)
						{
						$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as  order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0");
						foreach($nameArray_color_size_qnty as $result_color_size_qnty)
                        {
                        ?>
                            <td style="border:1px solid black; text-align:right">
							<?
								if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
								{
									 echo number_format($result_color_size_qnty[csf('order_quantity')],0);
									 $color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
									 $color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
									 $item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
								     $grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $grand_total_order +=$result_color_size_qnty[csf('order_quantity')];

									 $color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
									 {
											$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
											$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
									 }
									 else
									 {
										$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
										$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 }
									 if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
									 {
											$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
											$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
									 }
									 else
									 {
										$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
										$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 }
								}
								else echo "0";
							 ?>
							</td>

                    <?
						}
                        }
                        ?>
                          <td style="border:1px solid black; text-align:right"><?  echo number_format(round($color_total_order),0); ?></td>

                         <td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?>
                         </td>
                        <td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total),0); ?></td>
                    </tr>
                    <?
                    }
					?>

                        <td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total),0); ?></td>
                    </tr>
                    <?
					}
                    ?>
                     <tr>
                        <td style="border:1px solid black" align="center" colspan="<? echo count($nameArray_size)+3; ?>"><strong>&nbsp;</strong></td>
                        </tr>
                    <tr>
                    <tr>
                        <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total),0); ?></td>
                    </tr>
                </table>
                </fieldset>
                </div>
                </td>
                <td width="200" valign="top" align="left">
                <div id="div_size_color_matrix" style="float:left;">
                <?
				$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
				?>
            	 	<fieldset id="" >
 				<legend>RMG Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                <?
				if(number_format($rmg_process_breakdown_arr[8],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Cut Panel rejection <!-- Extra Cutting % breack Down 8-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[8],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[2],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Chest Printing <!-- Printing % breack Down 2-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[2],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[10],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Neck/Sleeve Printing <!-- New breack Down 10-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[10],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[1],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Embroidery   <!-- Embroidery  % breack Down 1-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[1],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[4],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Sewing /Input<!-- Sewing % breack Down 4-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[4],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[3],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Garments Wash <!-- Washing %breack Down 3-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[3],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[15],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Gmts Finishing <!-- Washing %breack Down 3-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[15],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[11],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Others <!-- New breack Down 11-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[11],2);
				?>
                </td>
                </tr>
                <?
                }
				$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
				if($gmts_pro_sub_tot>0)
				{
				?>
                <tr>
                <td width="130">
                Sub Total <!-- New breack Down 11-->
                </td>
                <td align="right">
                <?

				echo number_format($gmts_pro_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				?>
                </table>
                </fieldset>


                <fieldset id="" >
 				<legend>Fabric Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                 <?
				if(number_format($rmg_process_breakdown_arr[6],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Knitting  <!--  Knitting % breack Down 6-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[6],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[12],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Yarn Dyeing  <!--  New breack Down 12-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[12],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[5],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Dyeing & Finishing  <!-- Finishing % breack Down 5-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[5],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[13],2)>0)
				{
				?>
                <tr>
                <td width="130">
                All Over Print <!-- new  breack Down 13-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[13],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[14],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Lay Wash (Fabric) <!-- new  breack Down 14-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[14],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[7],2)>0)
				{
				?>
                 <tr>
                <td width="130">
                Dying   <!-- breack Down 7-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[7],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[0],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Cutting (Fabric) <!-- Cutting % breack Down 0-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[0],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[9],2)>0)
				{
				?>
                <tr>
                <td width="130">
               Others  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[9],2);
				?>
                </td>
                </tr>
                <?
				}
				$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
				if(fab_proce_sub_tot>0)
				{
				?>
                <tr>
                <td width="130">
                Sub Total  <!-- Others% breack Down 9-->
                </td>
                <td align="right">

                <?

				echo number_format($fab_proce_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
				{
				?>
                 <tr>
                <td width="130">
                Grand Total  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?
				echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				?>
           </table>
           </fieldset>
           </div>
                </td>
            <td width="330" valign="top" align="left">
            <?
			$nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id='$job_no' and file_type=1");
			?>
            <div id="div_size_color_matrix" style="float:left;">
            	<fieldset id="" >
 				<legend>Image </legend>
            	<table width="310">
                <tr>
                <?
				$img_counter = 0;
                foreach($nameArray_imge as $result_imge)
				{
				    if($path=="")
                    {
                   	 $path='../../';
                    }

					?>
					<td>
						<!--<img src="../../<? //echo $result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />-->
                        <img src="<? echo $path.$result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />
					</td>
					<?

					$img_counter++;
				}
				?>
                </tr>
           </table>
           </fieldset>
           </div>
          </td>
        </tr>
       </table>
        <?
			}// if($cbo_fabric_source==1) end

	  ?>
      <br/>

      <!--  Here will be the main portion  -->
     <?
	 $costing_per="";
	 $costing_per_qnty=0;
	 $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
	 if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;

			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";
				$costing_per_qnty=1;

			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;

			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;

			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;

			}
			$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");;

$uom_arr=array(1=>"Pcs",12=>"Kg",23=>"Mtr",27=>"Yds");
foreach($uom_arr as $uom_id=>$uom_val){
	if($cbo_fabric_source==1)
	{
	$nameArray_fabric_description= sql_select("select a.id as fabric_cost_dtls_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , d.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.is_short=1 and
	a.uom=$uom_id and
	b.cons>0 and
	d.booking_no =$txt_booking_no and
	d.status_active=1 and
	d.is_deleted=0
	group by a.id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,d.dia_width,b.remarks order by fabric_cost_dtls_id,a.body_part_id,d.dia_width");
	if(count($nameArray_fabric_description)>0){
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <caption>Fabric Details in <? echo $uom_val ?></caption>
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
        <td  rowspan="10" width="50"><p>Total Finish Fabric <? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>

            <td  rowspan="10" width="50"><p>Avg Rate <? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
            <td  rowspan="10" width="50"><p>Amount </p></td>

       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('remarks')]."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
			}


		?>

       </tr>
       <?

		  /*$gmt_color_library=return_library_array( "select gmts_color_id,contrast_color_id
		  FROM
		  wo_pre_cos_fab_co_color_dtls
		  WHERE
		  job_no ='$job_no'", "contrast_color_id", "gmts_color_id");*/
		    $color_library=return_library_array( "select id,color_name from lib_color where status_active =1 and is_deleted=0", "id", "color_name");
		  $gmt_color_library=array();
		  $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=$uom_id and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			//$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]].=$color_library[$gmt_color_row[csf("gmts_color_id")]]."," ;
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;
			//$grand_totalcons_per_finish=0;
			//$grand_totalcons_per_grey=0;
			//$color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE  booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
			$color_wise_wo_sql=sql_select("select b.fabric_color_id  FROM  wo_pre_cost_fabric_cost_dtls a ,wo_booking_dtls b  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.uom=$uom_id and b.booking_no = $txt_booking_no and b.status_active=1 and  b.is_deleted=0 group by b.fabric_color_id");

		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
			?>
            </td>
            <td>
            <?
			//echo $color_library[$gmt_color_library[$color_wise_wo_result['fabric_color_id']]];
			//echo rtrim($gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]],",");
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
			//echo "lapdip_no from wo_po_lapdip_approval_info where job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result['fabric_color_id']."";
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_amount=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {


				if($db_type==0)
				{
					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty, sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate
					FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
					WHERE
					a.job_no=d.job_no and
					d.is_short=1 and
					a.id=d.pre_cost_fabric_cost_dtls_id and
					d.booking_no =$txt_booking_no and
					a.uom=$uom_id and
					a.id='".$result_fabric_description[csf('fabric_cost_dtls_id')]."' and
					a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
					a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
					a.construction='".$result_fabric_description[csf('construction')]."' and
					a.composition='".$result_fabric_description[csf('composition')]."' and
					a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
					d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
					d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
					d.pre_cost_remarks='".$result_fabric_description[csf('remarks')]."' and
					d.status_active=1 and
					d.is_deleted=0");
				}
				if($db_type==2)
				{
					 $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty, sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate
					FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
					WHERE
					a.job_no=d.job_no and
					d.is_short=1 and
					a.id=d.pre_cost_fabric_cost_dtls_id and
					d.booking_no =$txt_booking_no and
					a.uom=$uom_id and
					a.id='".$result_fabric_description[csf('fabric_cost_dtls_id')]."' and
					a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
					a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
					a.construction='".$result_fabric_description[csf('construction')]."' and
					a.composition='".$result_fabric_description[csf('composition')]."' and
					a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
					d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
					d.pre_cost_remarks='".$result_fabric_description[csf('remarks')]."' and

					nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and
					d.status_active=1 and
					d.is_deleted=0");
				}

				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
				echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],0) ;
				$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('rate')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('rate')],4);
			//$total_grey_fab_qnty+=$color_wise_wo_result_qnty['grey_fab_qnty'];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			$amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
			if($amount!="")
			{
			echo number_format($amount,0);
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo number_format($total_fin_fab_qnty,0); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right">
            <?
			echo number_format($total_amount,0);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{

			$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty
											FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
											WHERE
											a.job_no=d.job_no and
											d.is_short=1 and
											a.id=d.pre_cost_fabric_cost_dtls_id and
											d.booking_no =$txt_booking_no and
											a.uom=$uom_id and
											a.id='".$result_fabric_description[csf('fabric_cost_dtls_id')]."' and
											a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
											a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
											a.construction='".$result_fabric_description[csf('construction')]."' and
											a.composition='".$result_fabric_description[csf('composition')]."' and
											a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
											d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
											d.pre_cost_remarks='".$result_fabric_description[csf('remarks')]."' and
											d.status_active=1 and
											d.is_deleted=0 ");
			list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
		?>
		<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],0) ;?></td>
		<td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
		<td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
		<?
		}
		?>
		<td align="right"><? echo number_format($grand_total_fin_fab_qnty,0);?></td>
		<td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
		<td align="right">
		<?
		echo number_format($grand_total_amount,0);
		?>
		</td>
		</tr>
		<tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				/*$color_wise_wo_sql_qnty=sql_select("select sum(b.fin_fab_qnty) as fin_fab_qnty,sum(b.grey_fab_qnty) as grey_fab_qnty
				  FROM
				  view_wo_fabric_booking_data_park a,
				  wo_booking_dtls b
				  WHERE
				  b.booking_no =$txt_booking_no  and
				  a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and
				  a.po_break_down_id=b.po_break_down_id and
				  a.color_size_table_id=b.color_size_table_id and
				  a.color_type_id='".$result_fabric_description['color_type_id']."' and
				  a.construction='".$result_fabric_description['construction']."' and
				  a.composition='".$result_fabric_description['composition']."' and
				  a.gsm_weight='".$result_fabric_description['gsm_weight']."' and
				  a.dia_width='".$result_fabric_description['dia_width']."' and
				  a.process_loss_percent='".$result_fabric_description['process_loss_percent']."' and
				  b.status_active=1 and
				  b.is_deleted=0
				  ");*/

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
			echo number_format($consumption_per_unit_fab,2);
			?>
            </td>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
			echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			?>
            </td>
            <td align="right" title="Only Allow Round Figer">
            <?
			echo number_format($consumption_per_unit_amuont,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}
	}
    }


    foreach($uom_arr as $uom_id=>$uom_val){
	if($cbo_fabric_source==2 || $cbo_fabric_source==3 || $cbo_fabric_source==4)
	{
	$nameArray_fabric_description= sql_select("select a.id as fabric_cost_dtls_id,a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , d.dia_width,b.remarks, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent, avg(b.requirment) as requirment  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	d.is_short=1 and
	a.uom=$uom_id and
	b.cons>0 and
	d.booking_no =$txt_booking_no and
	d.status_active=1 and
	d.is_deleted=0
	group by a.id,a.body_part_id,a.item_number_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,d.dia_width,b.remarks order by fabric_cost_dtls_id,a.body_part_id,d.dia_width");
	if(count($nameArray_fabric_description)>0){
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <caption>Fabric Details in <? echo $uom_val ?></caption>
     <tr align="center">
     <th colspan="3" align="left">Body Part</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
        <td  rowspan="10" width="50"><p>Total Finish Fabric  <? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>

            <td  rowspan="10" width="50"><p>Avg Rate  <? //echo "(".$unit_of_measurement[$uom].")"; //if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
            <td  rowspan="10" width="50"><p>Amount </p></td>

       </tr>
     <tr align="center"><th colspan="3" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="3" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else         		               echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="3" align="left">Yarn Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else         		               echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="3" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		       echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')].",".$fabric_typee[$result_fabric_description[csf('width_dia_type')]]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Consumption For <? echo $costing_per; ?></th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('cons')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>Fin: ".number_format($result_fabric_description[csf('cons')],2)."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="3" align="left">Remarks</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('remarks')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else         		              echo "<td colspan='3' align='center'>".$result_fabric_description[csf('remarks')]."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+3; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <!--<th  width="120" align="left">Gmts. Color</th>-->
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
			{
				  echo "<th width='50'>Fab. Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
			}


		?>

       </tr>
       <?

		  /*$gmt_color_library=return_library_array( "select gmts_color_id,contrast_color_id
		  FROM
		  wo_pre_cos_fab_co_color_dtls
		  WHERE
		  job_no ='$job_no'", "contrast_color_id", "gmts_color_id");*/
		  $gmt_color_library=array();
		  $gmt_color_data=sql_select("select b.gmts_color_id, b.contrast_color_id
		  FROM
		  wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b
		  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.fab_nature_id=$cbo_fabric_natu and a.uom=$uom_id and a.fabric_source =$cbo_fabric_source and
		  a.job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			//$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]].=$color_library[$gmt_color_row[csf("gmts_color_id")]]."," ;
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]][$gmt_color_row[csf("gmts_color_id")]]=$color_library[$gmt_color_row[csf("gmts_color_id")]];
		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_amount=0;
			//$grand_totalcons_per_finish=0;
			//$grand_totalcons_per_grey=0;
			//$color_wise_wo_sql=sql_select("select fabric_color_id FROM wo_booking_dtls WHERE  booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by fabric_color_id");
			$color_wise_wo_sql=sql_select("select b.fabric_color_id  FROM  wo_pre_cost_fabric_cost_dtls a ,wo_booking_dtls b  WHERE a.id=b.pre_cost_fabric_cost_dtls_id and a.uom=$uom_id and b.booking_no = $txt_booking_no and b.status_active=1 and  b.is_deleted=0 group by b.fabric_color_id");

		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
           <!-- <td  width="120" align="left">
			<?

			//echo $color_library[$color_wise_wo_result['fabric_color_id']];

			?></td>-->
            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


			?>
            </td>
            <td>
            <?
			//echo $color_library[$gmt_color_library[$color_wise_wo_result['fabric_color_id']]];
			//echo rtrim($gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]],",");
			echo implode(",",$gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]);
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
			//echo "lapdip_no from wo_po_lapdip_approval_info where job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result['fabric_color_id']."";
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_amount=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {


				if($db_type==0)
				{
					$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty, sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate
					FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
					WHERE
					a.job_no=d.job_no and
					d.is_short=1 and
					a.id=d.pre_cost_fabric_cost_dtls_id and
					d.booking_no =$txt_booking_no and
					a.uom=$uom_id and
					a.id='".$result_fabric_description[csf('fabric_cost_dtls_id')]."' and
					a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
					a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
					a.construction='".$result_fabric_description[csf('construction')]."' and
					a.composition='".$result_fabric_description[csf('composition')]."' and
					a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
					d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
					d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
					d.pre_cost_remarks='".$result_fabric_description[csf('remarks')]."' and
					d.status_active=1 and
					d.is_deleted=0");
				}
				if($db_type==2)
				{

					 $color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty, sum(d.grey_fab_qnty) as grey_fab_qnty, avg(d.rate) as rate
					FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
					WHERE
					a.job_no=d.job_no and
					d.is_short=1 and
					a.id=d.pre_cost_fabric_cost_dtls_id and
					d.booking_no =$txt_booking_no and
					a.uom=$uom_id and

					a.id='".$result_fabric_description[csf('fabric_cost_dtls_id')]."' and
					a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
					a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
					a.construction='".$result_fabric_description[csf('construction')]."' and
					a.composition='".$result_fabric_description[csf('composition')]."' and
					d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
					a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
					d.pre_cost_remarks='".$result_fabric_description[csf('remarks')]."' and
					nvl(d.fabric_color_id,0)=nvl('".$color_wise_wo_result[csf('fabric_color_id')]."',0) and

					d.status_active=1 and
					d.is_deleted=0");
				}

				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
				echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],0) ;
				$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('rate')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('rate')],4);
			//$total_grey_fab_qnty+=$color_wise_wo_result_qnty['grey_fab_qnty'];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			$amount=$color_wise_wo_result_qnty[csf('grey_fab_qnty')]*$color_wise_wo_result_qnty[csf('rate')];
			if($amount!="")
			{
			echo number_format($amount,0);
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
			}
			?>
            <td align="right"><? echo number_format($total_fin_fab_qnty,0); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
            <td align="right"><? echo number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>
            <td align="right">
            <?
			echo number_format($total_amount,0);

			?>
            </td>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{

			$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty
											FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
											WHERE
											a.job_no=d.job_no and
											d.is_short=1 and
											a.id=d.pre_cost_fabric_cost_dtls_id and
											d.booking_no =$txt_booking_no and
											a.uom=$uom_id and
											a.id='".$result_fabric_description[csf('fabric_cost_dtls_id')]."' and
											a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
											a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
											a.construction='".$result_fabric_description[csf('construction')]."' and
											a.composition='".$result_fabric_description[csf('composition')]."' and
											a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
											d.dia_width='".$result_fabric_description[csf('dia_width')]."' and
											d.pre_cost_remarks='".$result_fabric_description[csf('remarks')]."' and
											d.status_active=1 and
											d.is_deleted=0 ");
			list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
		?>
		<td width='50' align='right'><?  echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],0) ;?></td>
		<td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
		<td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty['grey_fab_qnty'],2);?></td>
		<?
		}
		?>
		<td align="right"><? echo number_format($grand_total_fin_fab_qnty,0);?></td>
		<td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
		<td align="right">
		<?
		echo number_format($grand_total_amount,0);
		?>
		</td>
		</tr>
		<tr style="font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption For <? echo $costing_per; ?></strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				/*$color_wise_wo_sql_qnty=sql_select("select sum(b.fin_fab_qnty) as fin_fab_qnty,sum(b.grey_fab_qnty) as grey_fab_qnty
				  FROM
				  view_wo_fabric_booking_data_park a,
				  wo_booking_dtls b
				  WHERE
				  b.booking_no =$txt_booking_no  and
				  a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and
				  a.po_break_down_id=b.po_break_down_id and
				  a.color_size_table_id=b.color_size_table_id and
				  a.color_type_id='".$result_fabric_description['color_type_id']."' and
				  a.construction='".$result_fabric_description['construction']."' and
				  a.composition='".$result_fabric_description['composition']."' and
				  a.gsm_weight='".$result_fabric_description['gsm_weight']."' and
				  a.dia_width='".$result_fabric_description['dia_width']."' and
				  a.process_loss_percent='".$result_fabric_description['process_loss_percent']."' and
				  b.status_active=1 and
				  b.is_deleted=0
				  ");*/

			?>
			<td width='50' align='right'><?  //echo number_format(($color_wise_wo_result_qnty['fin_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4) ;?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <td width='50' align='right' > <? //echo number_format(($color_wise_wo_result_qnty['grey_fab_qnty']/$grand_total)*($total_set_qnty*$costing_per_qnty),4);?></td>
            <?
			}
			?>
            <td align="right">
			<?
			$consumption_per_unit_fab=($grand_total_fin_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
			echo number_format($consumption_per_unit_fab,2);
			//$grand_total_fin_fab_qnty_dzn=number_format(($grand_total_fin_fab_qnty/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty),4)
			?>
            </td>
            <td align="right">
			<?
			$consumption_per_unit_amuont=($grand_total_amount/$po_qnty_tot)*($total_set_qnty*$costing_per_qnty);
			echo number_format(($consumption_per_unit_amuont/$consumption_per_unit_fab),2);
			//$grand_total_grey_fab_qnty_dzn=number_format(($grand_total_grey_fab_qnty/$grand_total)*($total_set_qnty*$costing_per_qnty),4)
			?>
            </td>
            <td align="right" title="Only Allow Round Figer">
            <?
			echo number_format($consumption_per_unit_amuont,2);
			?>
            </td>
            </tr>
    </table>
    <?
	}
	}
    }
	?>
        <br/>

        <?

		if($cbo_fabric_source==1 || $cbo_fabric_source==2 || $cbo_fabric_source==3 || $cbo_fabric_source==4){
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
        <tr>
        <?
		//echo "select a.colar_cuff_per,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id    and a.booking_no=$txt_booking_no and a.booking_type=1 c.body_part_id in(2) and a.status_active=1 and a.is_deleted=0";
		$colar_percent_size_wise_array=return_library_array( "select a.colar_cuff_per,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id    and a.booking_no=$txt_booking_no and a.booking_type=1 and c.body_part_id in(2) and a.status_active=1 and a.is_deleted=0", "gmts_sizes", "colar_cuff_per");
		//print_r($colar_percent_size_wise_array);
		$nameArray_item_size=sql_select( "select min(c.id) as id,d.item_size,d.gmts_size as size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by d.item_size,d.gmts_size order by id");
		//echo "select min(c.id) as id,b.item_size,d.gmts_size as size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,d.gmts_size order by id";
		
		if(count($nameArray_item_size)>0)
		{
        ?>
        <td width="49%">
        <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
        <tr>
        <td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Collar -  Color & Size Breakdown in Pcs</b></td>
        </tr>
        <tr>
        <td width="70">Size</td>

        <?

		/*$nameArray_item_size=sql_select( "select b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by c.size_number_id,b.item_size order by c.size_number_id");*/
		foreach($nameArray_item_size  as $result_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
		<?
        }
        ?>
        <td rowspan="2" align="center"><strong>Total</strong></td>
        <!--<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>-->
        </tr>
        <tr>
        <td>Collar Size</td>

        <?
        foreach($nameArray_item_size  as $result_item_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
		<?
        }
        ?>
         <?

			$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,d.gmts_color_id as color_number_id,d.pre_cost_fabric_cost_dtls_id as f_dtls_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by d.gmts_color_id,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,d.pre_cost_fabric_cost_dtls_id order by a.id
");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			$color_total_collar=0;
			$color_total_collar_order_qnty=0;
			$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
			$constrast_color_arr=array();
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
				for($i=0;$i<count($constrast_color);$i++)
				{
					$constrast_color2=explode('_',$constrast_color[$i]);
					$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
				}
			}
		?>
			<tr>
            <td>
            <?
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
				$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
			}
			else
			{
				echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
				$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
			}
			?>

            </td>
            <?
			$size_qnty_arr=array();
            foreach($nameArray_item_size  as $result_size)
			{
				?>
				<td align="center" style="border:1px solid black">
				<?
				//$color_wise_wo_sql_qnty=sql_select("select c.color_number_id,sum(c.order_quantity) as order_quantity, sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and c.color_number_id='".$color_wise_wo_result['color_number_id']."' and c.size_number_id='".$result_size['size_number_id']."'");
				$color_wise_wo_sql_qnty=sql_select( "select sum(grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  gmts_size =".$result_size[csf('size_number_id')]." and gmts_color_id =".$color_wise_wo_result[csf('color_number_id')]." and pre_cost_fabric_cost_dtls_id =".$color_wise_wo_result[csf('f_dtls_id')]."   and  status_active=1 and is_deleted =0");
				//echo "select sum(grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  gmts_size =".$result_size[csf('size_number_id')]." and gmts_color_id =".$color_wise_wo_result[csf('color_number_id')]."  and pre_cost_fabric_cost_dtls_id =".$color_wise_wo_result[csf('f_dtls_id')]." and  status_active=1 and is_deleted =0";

				list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
				$plan_cut=$plan_cut_qnty[csf('grey_fab_qnty')];
				$colar_excess_per=($plan_cut*$colar_excess_percent)/100;
				echo number_format($plan_cut+$colar_excess_per,0);
				$color_total_collar+=$plan_cut+$colar_excess_per;
				$color_total_collar_order_qnty+=$plan_cut;
				$grand_total_collar+=$plan_cut+$colar_excess_per;
				$grand_total_collar_order_qnty+=$plan_cut;
				$size_qnty_arr[$result_size[csf('size_number_id')]]+=$plan_cut+$colar_excess_per;
				?>
                </td>
				<?
			}
			?>

            <td align="center"><? echo number_format($color_total_collar,0); ?></td>
            <!--<td align="center"><? //echo number_format((($color_total_collar-$color_total_collar_order_qnty)/$color_total_collar_order_qnty)*100,2); ?></td>-->
            </tr>
            <?
		    }
			?>
            <tr>
                <td>Size Total</td>

                <?
                foreach($nameArray_item_size  as $result_size)
                {
                ?>
                <td style="border:1px solid black;  text-align:center"><? $colar_excess_pers=$size_qnty_arr[$result_size[csf('size_number_id')]];//($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100;
				 echo number_format($colar_excess_pers,0); ?></td>
                <?
                }
                ?>
                <td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar,0); ?></td>
               <!-- <td align="center" style="border:1px solid black"> <? //echo number_format((($grand_total_collar-$grand_total_collar_order_qnty)/$grand_total_collar_order_qnty)*100,2); ?></td>-->
            </tr>
        </table>
        </td>
        <td width="2%">
        </td>
        <?
        }
		?>

        <?
		$cuff_percent_size_wise_array=return_library_array( "select a.colar_cuff_per,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id    and a.booking_no=$txt_booking_no and a.booking_type=1 and c.body_part_id in(3) and a.status_active=1 and a.is_deleted=0", "gmts_sizes", "colar_cuff_per");
		//print_r($cuff_percent_size_wise_array);
		$nameArray_item_size=sql_select( "select min(c.id) as id, b.item_size,d.gmts_size FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,d.gmts_size,c.size_number_id order by id");
		//echo "select min(c.id) as id, b.item_size,d.gmts_size FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,d.gmts_size,c.size_number_id order by id";

		if(count($nameArray_item_size)>0)
		{
        ?>
        <td width="49%">
        <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
        <tr>
        <td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Cuff -  Color & Size Breakdown in Pcs</b></td>
        </tr>
        <tr>
        <td width="70">Size</td>

        <?
		foreach($nameArray_item_size  as $result_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
		<?
        }
        ?>
        <td rowspan="2" align="center"><strong>Total</strong></td>
       <!-- <td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>-->
        </tr>
        <tr>
        <td>Cuff Size</td>

        <?
        foreach($nameArray_item_size  as $result_item_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
		<?
        }
        ?>
         <?

			$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,d.pre_cost_fabric_cost_dtls_id as f_dtls_id,d.gmts_color_id as color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and  d.status_active=1 and d.is_deleted=0 group by c.gmts_color_id ,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,d.pre_cost_fabric_cost_dtls_id order by a.id
");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			$color_total_cuff=0;
			$color_total_cuff_order_qnty=0;
			$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
			$constrast_color_arr=array();
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
				for($i=0;$i<count($constrast_color);$i++)
				{
					$constrast_color2=explode('_',$constrast_color[$i]);
					$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
				}
			}
			//print_r($constrast_color_arr);
		?>
			<tr>
            <td>
            <?
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				///echo $color_wise_wo_result[csf('color_number_id')];
				echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]);
				$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
			}
			else
			{
				echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
				$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
			}
			?>

            </td>
            <?
			$size_qnty_cuff_arr=array();
            foreach($nameArray_item_size  as $result_size)
			{
				?>
				<td align="center" style="border:1px solid black">

				<?
				/*$color_wise_wo_sql_qnty=sql_select("select c.color_number_id,sum(c.order_quantity) as order_quantity, sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=3 and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and c.color_number_id='".$color_wise_wo_result['color_number_id']."' and c.size_number_id='".$result_size['size_number_id']."'");*/
				$color_wise_wo_sql_qnty=sql_select( "select sum(grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  gmts_size=".$result_size[csf('size_number_id')]." and pre_cost_fabric_cost_dtls_id =".$color_wise_wo_result[csf('f_dtls_id')]." and gmts_color_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active=1 and is_deleted =0");

				list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
				$plan_cut=$plan_cut_qnty[csf('grey_fab_qnty')];
				$cuff_excess_per=(($plan_cut*2)*$cuff_excess_percent)/100;
				echo number_format($plan_cut*2+$cuff_excess_per,0);
				$color_total_cuff+=$plan_cut*2+$cuff_excess_per;
				$color_total_cuff_order_qnty+=$plan_cut*2;
				$grand_total_cuff+=$plan_cut*2+$cuff_excess_per;
				$grand_total_cuff_order_qnty+=$plan_cut*2;

				$size_qnty_cuff_arr[$result_size[csf('size_number_id')]]+=$plan_cut*2+$cuff_excess_per;

				?>

                </td>
				<?
			}
			?>

            <td align="center"><? echo number_format($color_total_cuff,0); ?></td>
           <!-- <td align="center"><? //echo number_format((($color_total_cuff-$color_total_cuff_order_qnty)/$color_total_cuff_order_qnty)*100,2); ?></td>-->
            </tr>
            <?
		    }
			?>
            <tr>
                <td>Size Total</td>

                <?
                foreach($nameArray_item_size  as $result_size)
                {
                   /* $nameArray_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =$result_size[size_number_id]  and status_active=1 and is_deleted =0 order by id");
                foreach($nameArray_size_qnty as $result_size_qnty)
                {*/
                ?>
                <td style="border:1px solid black;  text-align:center"><? $cuff_excess_pers=$size_qnty_cuff_arr[$result_size[csf('size_number_id')]];
				 echo number_format($cuff_excess_pers,0); ?></td>
                <?
                //}
                }
                ?>
                <td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_cuff,0); ?></td>
                <!--<td align="center" style="border:1px solid black"> <? //echo number_format((($grand_total_cuff-$grand_total_cuff_order_qnty)/$grand_total_cuff_order_qnty)*100,2); ?></td>-->
            </tr>
        </table>
        </td>
        <?
				}
		?>
        </tr>
        </table>
        <br/>
        <br/>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
        <tr>
        <?

		//echo "select a.colar_cuff_per,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id    and a.booking_no=$txt_booking_no and a.booking_type=1 c.body_part_id in(2) and a.status_active=1 and a.is_deleted=0";
		//$colar_percent_size_wise_array=return_library_array( "select a.colar_cuff_per,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id    and a.booking_no=$txt_booking_no and a.booking_type=1 and c.body_part_id in(2) and a.status_active=1 and a.is_deleted=0", "gmts_sizes", "colar_cuff_per");


		$colar_percent_size_wise_array=array();
		$colar_tipping_percent_size_wise_sql=sql_select( "select a.colar_cuff_per,a.pre_cost_fabric_cost_dtls_id as f_dtls_id,a.gmts_color_id as color_number_id,a.gmts_size as gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id    and a.booking_no=$txt_booking_no and a.booking_type=1 and c.body_part_id in(172) and a.status_active=1 and a.is_deleted=0");
		$colar_tipping_excess_percent_arr=array();
		foreach($colar_tipping_percent_size_wise_sql as $colar_percent_size_wise_row)
		{
			$colar_tipping_excess_percent_arr[$colar_percent_size_wise_row[csf('color_number_id')]][$colar_percent_size_wise_row[csf('gmts_sizes')]]=$colar_percent_size_wise_row[csf('colar_cuff_per')];
			//$colar_excess_percent_arr[$colar_percent_size_wise_row[csf('gmts_sizes')]]+=$colar_percent_size_wise_row[csf('colar_cuff_per')];

		}

		//print_r($colar_tipping_excess_percent_arr);
		$nameArray_item_size=sql_select( "select min(c.id) as id,d.item_size,d.pre_cost_fabric_cost_dtls_id as f_dtls_id,d.gmts_size as size_number_id,	min(c.size_order) as size_order FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=172  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by d.gmts_size,d.item_size,d.pre_cost_fabric_cost_dtls_id order by size_order");


		if(count($nameArray_item_size)>0)
		{
        ?>
        <td width="49%">
        <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
        <tr>
        <td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Collar Tipping -  Color & Size Breakdown in Pcs</b></td>
        </tr>
        <tr>
        <td width="70">Size</td>

        <?

		//$nameArray_items_size=sql_select( "select b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by c.size_number_id,b.item_size order by c.size_number_id");
		
		
		foreach($nameArray_item_size  as $result_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
		<?
        }
        ?>
        <td rowspan="2" align="center"><strong>Total</strong></td>
       <!-- <td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>-->
        </tr>
        <tr>
        <td>Collar Size</td>

        <?
        foreach($nameArray_item_size  as $result_item_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
		<?
        }

		$color_wise_wo_sql=sql_select("select a.id, a.job_no, a.color_size_sensitive, a.color_break_down, a.process_loss_method, d.gmts_color_id as color_number_id , c.color_order, sum(c.plan_cut_qnty) as plan_cut_qnty,d.pre_cost_fabric_cost_dtls_id
		FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d
		WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=172 and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and c.status_active=1 and c.is_deleted=0
		group by d.gmts_color_id, c.color_order,d.pre_cost_fabric_cost_dtls_id, a.id, a.job_no, a.color_size_sensitive,a.color_break_down, a.process_loss_method
		order by c.color_order ");
	//	echo "select a.id, a.job_no, a.color_size_sensitive, a.color_break_down, a.process_loss_method, c.gmts_color_id as color_number_id , c.color_order, sum(c.plan_cut_qnty) as plan_cut_qnty,d.pre_cost_fabric_cost_dtls_id
		//FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d
		//WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=172 and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and c.status_active=1 and c.is_deleted=0
		//group by d.gmts_color_id, c.color_order,d.pre_cost_fabric_cost_dtls_id, a.id, a.job_no, a.color_size_sensitive,a.color_break_down, a.process_loss_method
		//order by c.color_order ";
		
		$size_qnty_tripping_arr=array();
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			$color_total_collar=0;
			$color_total_collar_order_qnty=0;
			$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
			$constrast_color_arr=array();
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
				for($i=0;$i<count($constrast_color);$i++)
				{
					$constrast_color2=explode('_',$constrast_color[$i]);
					$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
				}
			}
		?>
			<tr>
            <td>
            <?
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
				$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
			}
			else
			{
				echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
				$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
			}
			?>

            </td>
            <?
			
            foreach($nameArray_item_size  as $result_size)
			{
				?>
				<td align="center" style="border:1px solid black">
				<?

				$color_wise_wo_sql_qnty=sql_select( "select sum(grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  gmts_size =".$result_size[csf('size_number_id')]."  and pre_cost_fabric_cost_dtls_id =".$result_size[csf('f_dtls_id')]." and gmts_color_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active=1 and is_deleted =0 ");
			//	echo "select sum(grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  gmts_size =".$result_size[csf('size_number_id')]."  and pre_cost_fabric_cost_dtls_id =".$result_size[csf('f_dtls_id')]." and gmts_color_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active=1 and is_deleted =0 ";




				list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
				$plan_cut=$plan_cut_qnty[csf('grey_fab_qnty')];
				$colar_tipping_excess_per=($plan_cut*$colar_tipping_excess_percent_arr[$color_wise_wo_result[csf('color_number_id')]][$result_size[csf('size_number_id')]])/100;
				echo number_format($plan_cut+$colar_tipping_excess_per,0);
				$collar_tiff_size_total_arr[$result_size[csf('size_number_id')]]+=number_format($plan_cut+$colar_tipping_excess_per,0,'','');
				$color_tipping_total_collar+=$plan_cut+$colar_tipping_excess_per;
				$color_tipping_total_collar_order_qnty+=$plan_cut;
				$grand_total_collar_tipping+=$plan_cut+$colar_tipping_excess_per;
				$grand_total_collar_tipping_order_qnty+=$plan_cut;
				$size_wise_qty=0;
				$size_wise_qty=$plan_cut+$colar_tipping_excess_per;
				$size_qnty_tripping_arr[$result_size[csf('size_number_id')]]+=$size_wise_qty;



				?>
                </td>
				<?
			}
			?>

            <td align="center"><? echo number_format($color_tipping_total_collar,0); ?></td>
            <!--<td align="center"><? //echo number_format((($color_tipping_total_collar-$color_tipping_total_collar_order_qnty)/$color_tipping_total_collar_order_qnty)*100,2); ?></td>-->
            </tr>
            <?
		    }
			?>
            <tr>
                <td>Size Total</td>

                <?
                foreach($nameArray_item_size  as $result_size)
                {
                ?>
                <td style="border:1px solid black;  text-align:center">
				<?
				//$colar_excess_pers=($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]+$colar_excess_pers,0);
				
				echo number_format($size_qnty_tripping_arr[$result_size[csf('size_number_id')]],0);

				?></td>
                <?
                }
                ?>
                <td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar_tipping,0); ?></td>
               <!-- <td align="center" style="border:1px solid black"> <? //echo number_format((($grand_total_collar_tipping-$grand_total_collar_tipping_order_qnty)/$grand_total_collar_tipping_order_qnty)*100,2); ?></td>-->
            </tr>
        </table>
        </td>
        <td width="2%">
        </td>
        <?
        }

		$cuff_tipping_percent_size_wise_array=$cuff_size_total=array();
		$cuff_tipping_percent_size_wise_sql=sql_select( "select a.colar_cuff_per,a.gmts_color_id as color_number_id,a.gmts_size as gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id  and a.booking_no=$txt_booking_no and a.booking_type=1 and c.body_part_id in(214) and a.status_active=1 and a.is_deleted=0");
		foreach($cuff_tipping_percent_size_wise_sql as $cuff_percent_size_wise_row)
		{
			$cuff_tipping_percent_size_wise_array[$cuff_percent_size_wise_row[csf('color_number_id')]][$cuff_percent_size_wise_row[csf('gmts_sizes')]]=$cuff_percent_size_wise_row[csf('colar_cuff_per')];
		}


		$nameArray_item_size=sql_select( "select min(c.id) as id, b.item_size,d.pre_cost_fabric_cost_dtls_id as f_dtls_id,d.gmts_size as size_number_id,min(c.size_order) as size_order FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=214  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,d.gmts_size order by size_order");


		if(count($nameArray_item_size)>0)
		{
        ?>
        <td width="49%">
        <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
        <tr>
        <td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Cuff Tipping-  Color & Size Brakedown in Pcs</b></td>
        </tr>
        <tr>
        <td width="70">Size</td>

        <?
		foreach($nameArray_item_size  as $result_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
		<?
        }
        ?>
        <td rowspan="2" align="center"><strong>Total</strong></td>
        <!--<td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>-->
        </tr>
        <tr>
        <td>Cuff Size</td>

        <?
        foreach($nameArray_item_size  as $result_item_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
		<?
        }
        ?>
         <?

			$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,d.gmts_color_id as color_number_id, c.color_order, sum(c.plan_cut_qnty) as plan_cut_qnty,d.pre_cost_fabric_cost_dtls_id as f_dtls_id
			FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d
			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=214  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and  d.status_active=1 and d.is_deleted=0
			group by d.gmts_color_id, c.color_order ,a.id,a.job_no, d.pre_cost_fabric_cost_dtls_id,a.color_size_sensitive,a.color_break_down,a.process_loss_method
			order by c.color_order");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			$color_total_cuff=0;
			$color_total_cuff_order_qnty=0;
			$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
			$constrast_color_arr=array();
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
				for($i=0;$i<count($constrast_color);$i++)
				{
					$constrast_color2=explode('_',$constrast_color[$i]);
					$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
				}
			}
		?>
			<tr>
            <td>
            <?
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]);
				$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
			}
			else
			{
				echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
				$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
			}
			?>

            </td>
            <?
            foreach($nameArray_item_size  as $result_size)
			{
				?>
				<td align="center" style="border:1px solid black">

				<?


				$color_wise_wo_sql_qnty=sql_select( "select sum(grey_fab_qnty) as grey_fab_qnty from wo_booking_dtls where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  pre_cost_fabric_cost_dtls_id =".$color_wise_wo_result[csf('f_dtls_id')]." and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active=1 and is_deleted =0");



				list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
				$plan_cut=$plan_cut_qnty[csf('grey_fab_qnty')];
				$cuff_tipping_excess_per=(($plan_cut*2)*$cuff_tipping_percent_size_wise_array[$color_wise_wo_result[csf('color_number_id')]][$result_size[csf('size_number_id')]])/100;
				echo number_format($plan_cut*2+$cuff_tipping_excess_per,0);
				$cuff_tiffing_size_total[$result_size[csf('size_number_id')]]+=number_format($plan_cut*2+$cuff_tipping_excess_per,0,'','');
				//echo $cuff_tipping_percent_size_wise_array[$color_wise_wo_result[csf('color_number_id')]][$result_size[csf('size_number_id')]];
				$color_total_cuff_tiffing+=$plan_cut*2+$cuff_tipping_excess_per;
				$color_total_cuff_tiffing_order_qnty+=$plan_cut*2;
				$grand_total_cuff_tiffing+=$plan_cut*2+$cuff_tipping_excess_per;
				$grand_total_cuff_tiffing_order_qnty+=$plan_cut*2;
				?>

                </td>
				<?
			}
			?>

            <td align="center"><? echo number_format($color_total_cuff_tiffing,0); ?></td>
            <!--<td align="center"><? //echo number_format((($color_total_cuff_tiffing-$color_total_cuff_tiffing_order_qnty)/$color_total_cuff_tiffing_order_qnty)*100,2);  ?></td>-->
            </tr>
            <?
		    }
			?>
            <tr>
                <td>Size Total</td>

                <?
                foreach($nameArray_item_size  as $result_size)
                {
                   /* $nameArray_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =$result_size[size_number_id]  and status_active=1 and is_deleted =0 order by id");
                foreach($nameArray_size_qnty as $result_size_qnty)
                {*/
                ?>
                <td style="border:1px solid black;  text-align:center">
				<?
				//$cuff_excess_pers=(($size_tatal[$result_size[csf('size_number_id')]]*2)*$cuff_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]*2+$cuff_excess_pers,0);
				echo number_format($cuff_tiffing_size_total[$result_size[csf('size_number_id')]],0);
				?></td>
                <?
                //}
                }
                ?>
                <td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_cuff_tiffing,0); ?></td>
               <!-- <td align="center" style="border:1px solid black"> <? //echo number_format((($grand_total_cuff_tiffing-$grand_total_cuff_tiffing_order_qnty)/$grand_total_cuff_tiffing_order_qnty)*100,2); ?></td>-->
            </tr>
        </table>
        </td>
        <?
				}
		?>
        </tr>
        </table>
        <br/>

        <table  width="100%"  border="0" cellpadding="0" cellspacing="0">
            <tr>
                <td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
                    <?php echo get_spacial_instruction($txt_booking_no); ?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top">
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                        <tr align="center">
                        <td><b>Approved Instructions</b></td>

                        </tr>
                        <tr>
                        <td>
                    <?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
                    </td>
                    </tr>
                    </table>
                	<br />

                </td>

            </tr>
        </table>
       <br>

  <?
       //------------------------------ Query for TNA start-----------------------------------
				$po_id_all=str_replace("'","",$txt_order_no_id);
				$po_num_arr=return_library_array("select id,po_number from wo_po_break_down where id in($po_id_all)",'id','po_number');
				$tna_start_sql=sql_select( "select id,po_number_id,
								(case when task_number=31 then task_start_date else null end) as fab_booking_start_date,
								(case when task_number=31 then task_finish_date else null end) as fab_booking_end_date,
								(case when task_number=60 then task_start_date else null end) as knitting_start_date,
								(case when task_number=60 then task_finish_date else null end) as knitting_end_date,
								(case when task_number=61 then task_start_date else null end) as dying_start_date,
								(case when task_number=61 then task_finish_date else null end) as dying_end_date,
								(case when task_number=73 then task_start_date else null end) as finishing_start_date,
								(case when task_number=73 then task_finish_date else null end) as finishing_end_date,
								(case when task_number=84 then task_start_date else null end) as cutting_start_date,
								(case when task_number=84 then task_finish_date else null end) as cutting_end_date,
								(case when task_number=86 then task_start_date else null end) as sewing_start_date,
								(case when task_number=86 then task_finish_date else null end) as sewing_end_date,
								(case when task_number=110 then task_start_date else null end) as exfact_start_date,
								(case when task_number=110 then task_finish_date else null end) as exfact_end_date,
								(case when task_number=47 then task_start_date else null end) as yarn_rec_start_date,
								(case when task_number=47 then task_finish_date else null end) as yarn_rec_end_date
								from tna_process_mst
								where status_active=1 and po_number_id in($po_id_all)");
				$tna_fab_start=$tna_knit_start=$tna_dyeing_start=$tna_fin_start=$tna_cut_start=$tna_sewin_start=$tna_exfact_start="";
				$tna_date_task_arr=array();
				foreach($tna_start_sql as $row)
				{
					if($row[csf("fab_booking_start_date")]!="" && $row[csf("fab_booking_start_date")]!="0000-00-00")
					{
						if($tna_fab_start=="")
						{
							$tna_fab_start=$row[csf("fab_booking_start_date")];
						}
					}


					if($row[csf("knitting_start_date")]!="" && $row[csf("knitting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_start_date']=$row[csf("knitting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['knitting_end_date']=$row[csf("knitting_end_date")];
					}
					if($row[csf("dying_start_date")]!="" && $row[csf("dying_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_start_date']=$row[csf("dying_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['dying_end_date']=$row[csf("dying_end_date")];
					}
					if($row[csf("finishing_start_date")]!="" && $row[csf("finishing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_start_date']=$row[csf("finishing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['finishing_end_date']=$row[csf("finishing_end_date")];
					}
					if($row[csf("cutting_start_date")]!="" && $row[csf("cutting_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_start_date']=$row[csf("cutting_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['cutting_end_date']=$row[csf("cutting_end_date")];
					}
					if($row[csf("sewing_start_date")]!="" && $row[csf("sewing_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_start_date']=$row[csf("sewing_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['sewing_end_date']=$row[csf("sewing_end_date")];
					}
					if($row[csf("exfact_start_date")]!="" && $row[csf("exfact_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_start_date']=$row[csf("exfact_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['exfact_end_date']=$row[csf("exfact_end_date")];
					}
					if($row[csf("yarn_rec_start_date")]!="" && $row[csf("yarn_rec_start_date")]!="0000-00-00")
					{
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_start_date']=$row[csf("yarn_rec_start_date")];
						$tna_date_task_arr[$row[csf("po_number_id")]]['yarn_rec_end_date']=$row[csf("yarn_rec_end_date")];
					}
				}

	//------------------------------ Query for TNA end-----------------------------------
	?>

    <fieldset id="div_size_color_matrix" style="max-width:1000; display:none">
        <legend>TNA Information</legend>
        <!--<span style="font-size:180; font-weight:bold;"></span>-->
        <table width="100%" style="border:1px solid black;font-size:12px" border="1" cellpadding="2" cellspacing="0" rules="all">
            <tr>
            	<td rowspan="2" align="center" valign="top">SL</td>
            	<td width="180" rowspan="2"  align="center" valign="top"><b>Order No</b></td>
                <td colspan="2" align="center" valign="top"><b>Yarn Receive</b></td>
                <td colspan="2" align="center" valign="top"><b>Knitting</b></td>
                <td colspan="2" align="center" valign="top"><b>Dyeing</b></td>
                <td colspan="2" align="center" valign="top"><b>Finishing Fabric</b></td>
                <td colspan="2" align="center" valign="top"><b>Cutting </b></td>
                <td colspan="2" align="center" valign="top"><b>Sewing </b></td>
                <td colspan="2"  align="center" valign="top"><b>Ex-factory </b></td>
            </tr>
            <tr>
            	<td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>
                <td width="85" align="center" valign="top"><b>Start Date</b></td>
                <td width="85" align="center" valign="top"><b>End Date</b></td>

            </tr>
            <?
			$i=1;
			foreach($tna_date_task_arr as $order_id=>$row)
			{
				 //$tna_date_task_arr//knitting_start_date dying_start_date finishing_start_date cutting_start_date sewing_start_date exfact_start_date
				?>
                <tr>
                	<td><? echo $i; ?></td>
                    <td><? echo $po_num_arr[$order_id]; ?></td>
                    <td align="center"><? echo change_date_format($row['yarn_rec_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['yarn_rec_end_date']); ?></td>
                	<td align="center"><? echo change_date_format($row['knitting_start_date']); ?></td>
                    <td  align="center"><? echo change_date_format($row['knitting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['dying_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['finishing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['cutting_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['sewing_end_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_start_date']); ?></td>
                    <td align="center"><? echo change_date_format($row['exfact_end_date']); ?></td>
                </tr>
                <?
				$i++;
			}
			?>

        </table>
        </fieldset>



        <?
		}// fabric Source End
		?>
        <br/>
        <?
		//echo "select responsible_dept,	responsible_person,	reason from wo_booking_dtls where booking_no =$txt_booking_no";
		//"select id,department_name from  lib_department where status_active=1 and is_deleted=0 order by  department_name"
		$department_name_library=return_library_array( "select id,department_name from  lib_department where status_active=1 and is_deleted=0 order by  department_name", "id", "department_name"  );

		//$sql_responsible= sql_select("select responsible_dept,	responsible_person,	reason from wo_booking_dtls where booking_no =$txt_booking_no and fin_fab_qnty>0");
		/*echo "SELECT  a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,avg(b.process_loss_percent) as process_loss_percent,avg(rmg_qty) as rmg_qty, b.responsible_dept,	b.responsible_person,	b.reason FROM wo_pre_cost_fabric_cost_dtls a,wo_booking_dtls b where b.booking_no =$txt_booking_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.status_active=1 and
b.is_deleted=0 and b.grey_fab_qnty>0 group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width,b.responsible_dept,	b.responsible_person,	b.reason order by a.body_part_id";*/
		$sql_responsible= sql_select("SELECT  a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,b.dia_width,avg(b.process_loss_percent) as process_loss_percent,avg(rmg_qty) as rmg_qty, b.division_id,b.responsible_dept,	b.responsible_person,	b.reason FROM wo_pre_cost_fabric_cost_dtls a,wo_booking_dtls b where b.booking_no =$txt_booking_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.status_active=1 and
b.is_deleted=0 and b.grey_fab_qnty>0 group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,b.dia_width,b.responsible_dept,	b.responsible_person,b.division_id,	b.reason order by a.body_part_id");
		if(count($sql_responsible)>0)
		{
		?>
         <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
         <tr>
         <td>
          #
         </td>
          <td>
         Fabric Description
         </td>
          <td>
        	 Division
         </td>
		   <td>
       		  Responsible Dept.
         </td>
         <td>
         Responsible person
         </td>
         <td>
         Reason
         </td>
         </tr>
         <?
		 $ir=1;
		foreach($sql_responsible as $sql_responsible_row)
		{
			?>
             <tr>
             <td>
             <?  echo $ir; ?>
             </td>
             <td>
             <?  echo $body_part[$sql_responsible_row[csf('body_part_id')]].','.$color_type[$sql_responsible_row[csf('color_type_id')]].','.$sql_responsible_row[csf('construction')].','.$sql_responsible_row[csf('composition')].','.$sql_responsible_row[csf('gsm_weight')].','.$sql_responsible_row[csf('dia_width')].','.$fabric_typee[$sql_responsible_row[csf('width_dia_type')]]; ?>
             </td>
			  <td>
            <?  echo $short_division_array[$sql_responsible_row[csf('division_id')]]; ?>
             </td>
              <td>
             <?
			 $responsible_dept_st="";
			 $responsible_dept_arr=explode( ",",$sql_responsible_row[csf('responsible_dept')]);
			 foreach($responsible_dept_arr as $key => $value)
			 {
				 $responsible_dept_st.= $department_name_library[$value].", ";
			 }
			 echo rtrim($responsible_dept_st,", ");
			 ?>
             </td>
             <td>
            <?  echo $sql_responsible_row[csf('responsible_person')]; ?>
             </td>
             <td>
              <?  echo $sql_responsible_row[csf('reason')]; ?>
             </td>
             </tr>
            <?
			$ir++;

		}
		 ?>
         </table>
         <?
		}
		 ?>

         <!--<br><br><br><br>-->
         <?
		 	echo signature_table(4, $cbo_company_name, "1330px");
			echo "****".custom_file_name($txt_booking_no,$style_sting,$txt_job_no);
		 ?>

       </div>
       <?
	   exit();
}

if($action=="show_fabric_booking_report3")
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$report_type=str_replace("'","",$report_type);
	$imge_arr=return_library_array( "select master_tble_id,image_location from common_photo_library where form_name='company_details' and file_type=1 and master_tble_id=$txt_booking_no",'master_tble_id','image_location');
	
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	$supplier_address_arr=return_library_array( "select id,address_1 from   lib_supplier",'id','address_1');

	//$supplier_address_arr=return_library_array( "select id,address_1 from   lib_supplier",'id','address_1');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$color_library=return_library_array( "select id,color_name from lib_color where status_active =1 and is_deleted=0", "id", "color_name");


	//$po_qnty_tot=return_field_value( "sum(plan_cut)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	//$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	

	//$po_number_arr=return_library_array( "select id,po_number from   wo_po_break_down",'id','po_number');
	//$po_ship_date_arr=return_library_array( "select id,pub_shipment_date from   wo_po_break_down ",'id','pub_shipment_date');

	$po_data_sql=sql_select("SELECT id, sum(plan_cut) as plan_cut, sum(po_quantity) as po_quantity, po_number, pub_shipment_date from wo_po_break_down where status_active=1 and is_deleted=0 and id in(".str_replace("'","",$txt_order_no_id).") group by id, po_number, pub_shipment_date");
	foreach($po_data_sql as $row){
		$po_qnty_tot+=$row[csf('plan_cut')];
		$po_qnty_tot1+=$row[csf('po_quantity')];
		$po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
		$po_ship_date_arr[$row[csf('id')]]=$row[csf('pub_shipment_date')];
	}

	$mainBookingNo="";

	$sqlMainBooking=sql_select("select booking_no from wo_booking_dtls where po_break_down_id in (".str_replace("'","",$txt_order_no_id).") and status_active=1 and is_deleted=0 and booking_type=1 and is_short=2 group by booking_no");
	foreach($sqlMainBooking as $row)
	{
		if($mainBookingNo=="") $mainBookingNo=$row[csf('booking_no')]; else $mainBookingNo.=','.$row[csf('booking_no')];
	}
	unset($sqlMainBooking);
	?>
	<div style="width:1330px" align="center">
		    <?php
		$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12");
		list($nameArray_approved_row) = $nameArray_approved;
		$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_date_row) = $nameArray_approved_date;
		$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
		list($nameArray_approved_comments_row) = $nameArray_approved_comments;
		$path = str_replace("'", "", $path);
		if ($path == "") {
			$path = '../../';
		}
		?>										<!--    Header Company Information         -->
       <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black" >
           <tr>
               <td width="100">
               <?
                if($report_type==1)
                {
                    ?><img  src='../../<? echo $imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' /><?
                }
                else if($report_type==2)
                {
                    ?><img  src='../<? echo $imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' /><?
                }
                else
                {
                    ?><img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' /><?
                }
                ?>
               </td>
               <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:20px;">
                              <?php
								echo $company_library[$cbo_company_name];
								?>
                            </td>
                            <td rowspan="3"  width="270">
                               <span style="font-size:18px"><b>Job No:&nbsp;&nbsp;<? echo trim($txt_job_no,"'"); ?></b></span><br>
							   <font style="word-break:break-all">Main Booking No:&nbsp;&nbsp;<?=trim($mainBookingNo,"'"); ?></font>
                               <br>
                               <?
								 if($nameArray_approved_row[csf('approved_no')]>1)
								 {
								 ?>
								 <b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
                                  <br/>
								 <b> Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
								  <?
								 }
							  	?>
                            	</b>
                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:14px; word-break:break-all">
                            <?

                            $nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
                            foreach ($nameArray as $result)
                            {
                            ?>
                                Plot No: <? echo $result[csf('plot_no')]; ?>
                                Level No: <? echo $result[csf('level_no')]?>
                                Road No: <? echo $result[csf('road_no')]; ?>
                                Block No: <? echo $result[csf('block_no')];?>
                                City No: <? echo $result[csf('city')];?>
                                Zip Code: <? echo $result[csf('zip_code')]; ?>
                                Province No: <?php echo $result[csf('province')]; ?>
                                Country: <? echo $country_arr[$result[csf('country_id')]]; ?><br>
                                Email Address: <? echo $result[csf('email')];?>
                                Website No: <? echo $result[csf('website')];
								$company_address[$cbo_company_name]= "Plot No:".$result[csf('plot_no')].",Level No:".$result[csf('level_no')].",Road No:".$result[csf('road_no')].",Block No:".$result[csf('block_no')].",City No:".$result[csf('city')].",Zip Code:".$result[csf('zip_code')].",Province No:".$result[csf('province')].",Country:".$country_arr[$result[csf('country_id')]]; 
                            }
                            ?>
                               </td>
                            </tr>
                            <tr>
                            <td align="center" style="font-size:20px">
                                <strong><? if($report_type==1) echo str_replace("'","",$report_title);else echo 'Short Fabric Booking';?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><? if(str_replace("'","",$id_approved_id) ==1){?><font style="color:green"><? echo "(Approved)";?></font><?}else{?><font style="color:#F00"><? echo "(Not Approved)";?></font><?}; ?> </strong>
                             </td>
                              <td>

                             </td>
                            </tr>
                      </table>
                </td>
            </tr>
       </table>
                <?

				$job_no='';
				$total_set_qnty=0;
				$colar_excess_percent=0;
				$cuff_excess_percent=0;
                $nameArray=sql_select( "SELECT a.booking_no,a.booking_date,a.supplier_id,a.pay_mode,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,b.job_no,b.buyer_name, b.style_ref_no ,b.gmts_item_id,b.order_uom,b.total_set_qnty,b.style_description,b.season,b.product_dept,b.product_code,b.pro_sub_dep,b.dealing_marchant, b.factory_marchant,a.remarks from wo_booking_mst a, wo_po_details_master b where  a.job_no=b.job_no and a.booking_no=$txt_booking_no");

				foreach ($nameArray as $result)
				{
					$total_set_qnty=$result[csf('total_set_qnty')];
					$colar_excess_percent=$result[csf('colar_excess_percent')];
				    $cuff_excess_percent=$result[csf('cuff_excess_percent')];
					$remarks=$result[csf('remarks')];
					$po_no="";
					$shipment_date="";$internal_ref="";	$file_no="";
					$sql_po= "select po_number,grouping,file_no,MIN(pub_shipment_date) pub_shipment_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number,grouping,file_no";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $row_po)
					{
						$po_no.=$row_po[csf('po_number')].", ";
						$shipment_date.=change_date_format($row_po[csf('pub_shipment_date')],'dd-mm-yyyy','-').", ";
						$internal_ref.=$row_po[csf('grouping')].", ";
						$file_no.=$row_po[csf('file_no')].", ";
					}

					$lead_time="";
					if($db_type==0)
					{
					$sql_lead_time= "select DATEDIFF(pub_shipment_date,po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}

					if($db_type==2)
					{
					$sql_lead_time= "select (pub_shipment_date-po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					$data_array_lead_time=sql_select($sql_lead_time);
					foreach ($data_array_lead_time as $row_lead_time)
					{
						$lead_time.=$row_lead_time[csf('date_diff')].",";
						//$shipment_date.=change_date_format($row_po['pub_shipment_date'],'dd-mm-yyyy','-').",";
					}

					$po_received_date="";
					$sql_po_received_date= "select MIN(po_received_date) as po_received_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					$data_array_po_received_date=sql_select($sql_po_received_date);
					foreach ($data_array_po_received_date as $row_po_received_date)
					{
						$po_received_date=change_date_format($row_po_received_date[csf('po_received_date')],'dd-mm-yyyy','-');
						//$shipment_date.=change_date_format($row_po['pub_shipment_date'],'dd-mm-yyyy','-').",";
					}
					$file=rtrim($file_no,", ");//rtrim($po_no,", ")
					$file_all=array_unique(explode(",",$file));

					$file='';
					foreach($file_all as $file_id)
					{
						if($file=="") $file_cond=$file_id; else $file_cond.=", ".$file_id;
					}

				?>
       <table width="100%" style="border:1px solid black" >
            <tr>
                <td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
            </tr>
            <tr>
                <td width="100"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
                <td width="110">:&nbsp;<span style="font-size:18px"><b><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></b></span></td>
                <td width="100"><span style="font-size:12px"><b>Dept.</b></span></td>
                <td width="110">:&nbsp;<? echo $product_dept[$result[csf('product_dept')]] ; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></td>
                <td width="100"><span style="font-size:12px"><b>Order Qnty</b></span></td>
                <td width="110" style="font-size:18px"><b>:&nbsp;
				<?  echo $po_qnty_tot1." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?></b>
                </td>
            </tr>
            <tr>

                <td width="100" style="font-size:12px"><b>Garments Item</b></td>
                <td width="110">:&nbsp;
				<?
				$gmts_item_name="";
				$gmts_item=explode(',',$result[csf('gmts_item_id')]);
				for($g=0;$g<=count($gmts_item); $g++)
				{
					$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
				}
				echo rtrim($gmts_item_name,',');
				?>
                </td>
                <td width="100" style="font-size:12px"><b>Booking Date</b></td>
                <td width="110">:&nbsp;<? echo change_date_format($result[csf('booking_date')],'dd-mm-yyyy','-');?>&nbsp;&nbsp;&nbsp;</td>
                <td width="100" style="font-size:18px"><b>Style Ref.</b>   </td>
                <td width="110" style="font-size:18px">:&nbsp;<b><? echo $style_sting=$result[csf('style_ref_no')];?> </b>   </td>

            </tr>
             <tr>
                <td  width="100" style="font-size:12px"><b>Style Des.</b></td>
                <td  width="110" >:&nbsp;<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
                <td width="100" style="font-size:12px"><b>Lead Time </b>   </td>
                <td width="110">:&nbsp;<?=implode(",",array_filter(array_unique(explode(",",$lead_time))));?> </td>
                <td width="100" style="font-size:12px"><b>Dealing Merchandiser</b></td>
                <td width="110">:&nbsp;<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>
            </tr>
            <tr>
                <td width="100" style="font-size:12px"><b>Supplier Name</b>   </td>
                <td width="110">:&nbsp;<?
				if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3){
					echo $company_library[$result[csf('supplier_id')]];
					}
					else{
					echo $supplier_name_arr[$result[csf('supplier_id')]];
					}
				//echo $supplier_name_arr[$result[csf('supplier_id')]];?>    </td>
                <td width="100" style="font-size:12px"><b>Delivery Date</b></td>
               	<td width="110">:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
                <td width="100" style="font-size:18px"><b>Booking No </b>   </td>
                <td width="110" style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?></td>
            </tr>
			<tr>
                <td width="100" style="font-size:12px"><b>Supplier Adress</b>   </td>
                <td width="110" colspan="5">:&nbsp; <?
					$supplier_id=$result[csf('supplier_id')];
				
				if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3){
					$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$supplier_id");
					foreach ($nameArray as $result)
					{
						$company_address= "Plot No:".$result[csf('plot_no')].",Level No:".$result[csf('level_no')].",Road No:".$result[csf('road_no')].",Block No:".$result[csf('block_no')].",City No:".$result[csf('city')].",Zip Code:".$result[csf('zip_code')].",Province No:".$result[csf('province')].",Country:".$country_arr[$result[csf('country_id')]]; 
					}
					echo $company_address;
					}
					else{
					echo $supplier_address_arr[$result[csf('supplier_id')]];
					}
					
				?></td>
               
            </tr>
            <tr>
                <td width="100" style="font-size:12px"><b>Season</b></td>
                <td width="110">:&nbsp;<? echo $result[csf('season')]; ?></td>
                <td  width="100" style="font-size:12px"><b>Attention</b></td>
                <td  width="110" >:&nbsp;<? echo $result[csf('attention')]; ?></td>
                <td  width="100" style="font-size:12px"><b>Po Received Date</b></td>
                <td  width="110" >:&nbsp;<? echo $po_received_date; ?></td>
            </tr>
           <tr>
               <td width="100" style="font-size:18px"><b>Order No</b></td>
                <td width="110" style="font-size:18px">:&nbsp;<b><? echo rtrim($po_no,", "); ?></b></td>

                <td width="100" style="font-size:17px"><b>Factory Marchant</b></td>
                <td width="100" style="font-size:17px"><? echo $marchentrArr[$result[csf('factory_marchant')]] ?></td>
                <td width="100" style="font-size:17px"><b>Internal Ref</b></td>
                <td width="100" style="font-size:16px">:&nbsp;<b><?=implode(",",array_filter(array_unique(explode(",",$internal_ref)))); ?></b></td>

            </tr>
            <tr>
               <td width="100" style="font-size:12px"><b>Shipment Date</b></td>
               <td width="110" style="word-break:break-all"> :&nbsp;<?=implode(",",array_filter(array_unique(explode(",",$shipment_date)))); ?></td>
               <td width="100" style="font-size:12px"><b>Factory Merchandiser</b></td>
               <td width="110">:&nbsp;<?=$marchentrArr[$result[csf('factory_marchant')]]; ?></td>
               <td width="100" style="font-size:17px"><b>File No</b></td>
               <td width="100" style="font-size:16px"> :&nbsp;<b><? echo $file_cond; ?></b></td>
            </tr>
			<tr>
               <td width="100" style="font-size:12px"><b>Remarks</b></td>
               <td width="110" colspan="5"> :&nbsp;<? echo $remarks; ?></td>
              
            </tr>
        </table>
           <?
			}
		   ?>
          <br/>     									 <!--  Here will be the main portion  -->

     <?
	 $costing_per="";
	 $costing_per_qnty=0;
	 $costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
	 if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;

			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";
				$costing_per_qnty=1;

			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;

			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;

			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;

			}
			$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");;

	 ?>

     <?
	 if(str_replace("'","",$cbo_fabric_source)==1)
	  {
		

		$nameArray_fabric_description= sql_select("SELECT  a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.lib_yarn_count_deter_id,b.dia_width, avg(b.process_loss_percent) as process_loss_percent,avg(rmg_qty) as rmg_qty FROM wo_pre_cost_fabric_cost_dtls a,wo_booking_dtls b where b.booking_no =$txt_booking_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.status_active=1 and b.is_deleted=0  group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.lib_yarn_count_deter_id,b.dia_width order by a.body_part_id,dia_width");

		foreach($nameArray_fabric_description as $row){
			$yarn_count_id[$row[csf('lib_yarn_count_deter_id')]]=$row[csf('lib_yarn_count_deter_id')];
		}
		// $fabric_composition=return_library_array( "SELECT a.id, a.fabric_composition_id, b.fabric_composition_name from lib_yarn_count_determina_mst a join lib_fabric_composition b on b.id=a.fabric_composition_id where  a.status_active=1 ".where_con_using_array($yarn_count_id,0,'a.id')."", "id", "fabric_composition_name"); 

		$wo_fab_qty_sql=sql_select("SELECT sum(b.fin_fab_qnty) as fin_fab_qnty,sum(b.grey_fab_qnty) as grey_fab_qnty, a.body_part_id, a.color_type_id, a.construction,a.composition, a.gsm_weight, b.dia_width,b.gmts_color_id, b.fabric_color_id, b.po_break_down_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls b WHERE b.booking_no =$txt_booking_no  and a.id=b.pre_cost_fabric_cost_dtls_id and b.status_active=1 and b.is_deleted=0 group by a.body_part_id, a.color_type_id, a.construction,a.composition, a.gsm_weight, b.dia_width,b.gmts_color_id, b.fabric_color_id, b.po_break_down_id");
		foreach($wo_fab_qty_sql as $row){
			$index=$row[csf('body_part_id')].'*'.$row[csf('color_type_id')].'*'.$row[csf('construction')].'*'.$row[csf('composition')].'*'.$row[csf('gsm_weight')].'*'.$row[csf('dia_width')].'*'.$row[csf('gmts_color_id')].'*'.$row[csf('fabric_color_id')].'*'.$row[csf('po_break_down_id')];
			$index_wop=$row[csf('body_part_id')].'*'.$row[csf('color_type_id')].'*'.$row[csf('construction')].'*'.$row[csf('composition')].'*'.$row[csf('gsm_weight')].'*'.$row[csf('dia_width')];
			$color_wise_wo_qnty[$index]['fin_fab_qnty']=$row[csf('fin_fab_qnty')];
			$color_wise_wo_qnty[$index]['grey_fab_qnty']=$row[csf('grey_fab_qnty')];

			$color_wise_wo_qnty_wop[$index_wop]['fin_fab_qnty']+=$row[csf('fin_fab_qnty')];
			$color_wise_wo_qnty_wop[$index_wop]['grey_fab_qnty']+=$row[csf('grey_fab_qnty')];

		}
		/* echo "<pre>";
		print_r($color_wise_wo_qnty); die; */

	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <tr align="center">
     <th colspan="5" align="left">Body Part</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		?>
        <td  rowspan="9" width="50"><p>Total  Finish Fabric <? if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
        <td  rowspan="9" width="50"><p>Total Grey Fabric <? if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
        <td  rowspan="9" width="50"><p>Process Loss % </p></td>
       </tr>
     <tr align="center"><th colspan="5" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
       </tr>
        <tr align="center"><th colspan="5" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else echo "<td  colspan='2'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="5" align="left">Fabric Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			$fab_comp_all=$result_fabric_description[csf('composition')];
			if( $result_fabric_description[csf('lib_yarn_count_deter_id')] == "")   echo "<td colspan='2' >&nbsp</td>";
			else echo "<td colspan='2' >".$fab_comp_all."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="5" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else echo "<td colspan='2' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="5" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else echo "<td colspan='2' align='center'>".$result_fabric_description[csf('dia_width')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="5" align="left">RMG Qty</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('rmg_qty')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else echo "<td colspan='2' align='center'>". $result_fabric_description[csf('rmg_qty')]."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*2+5; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <th  width="120" align="left">PO Number</th>
            <th  width="120" align="left">Ship Date</th>
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			  echo "<th width='50'>Finish</th><th width='50' >Gray</th>";
		}
		?>

       </tr>
       <?
		  $gmt_color_library=array();
		  $gmt_color_data=sql_select("select gmts_color_id,fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("fabric_color_id")]].=$color_library[$gmt_color_row[csf("gmts_color_id")]]."," ;
		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_grey_fab_qnty=0;
			$grand_totalcons_per_finish=0;
			$grand_totalcons_per_grey=0;
			$color_wise_wo_sql=sql_select("SELECT fabric_color_id ,po_break_down_id,gmts_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by po_break_down_id,gmts_color_id,fabric_color_id");
			foreach($color_wise_wo_sql as $color_wise_wo_result)
			{
			?>
				<tr>
			<td  width="120" align="left">
				<?
				echo $po_number_arr[$color_wise_wo_result[csf('po_break_down_id')]];
				?></td>
				<td  width="120" align="left">
				<?

				echo change_date_format($po_ship_date_arr[$color_wise_wo_result[csf('po_break_down_id')]],"dd-mm-yyyy","-");

				?></td>
				<td  width="120" align="left">
				<?
				echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


				?>
				</td>
				<td>
				<?
				echo $color_library[$color_wise_wo_result[csf("gmts_color_id")]];//rtrim($gmt_color_library[$color_wise_wo_result['fabric_color_id']],",");
				?>
				</td>
				<td  width="120" align="left">
				<?
				$lapdip_no="";
				$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
				//echo "lapdip_no from wo_po_lapdip_approval_info where job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result['fabric_color_id']."";
				if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
				?>
				</td>
				<?
				$total_fin_fab_qnty=0;
				$total_grey_fab_qnty=0;

				foreach($nameArray_fabric_description as $result_fabric_description)
				{					
					$qty_index=$result_fabric_description[csf('body_part_id')].'*'.$result_fabric_description[csf('color_type_id')].'*'.$result_fabric_description[csf('construction')].'*'.$result_fabric_description[csf('composition')].'*'.$result_fabric_description[csf('gsm_weight')].'*'.$result_fabric_description[csf('dia_width')].'*'.$color_wise_wo_result[csf('gmts_color_id')].'*'.$color_wise_wo_result[csf('fabric_color_id')].'*'.$color_wise_wo_result[csf('po_break_down_id')];
				?>
				<td width='50' align='right'>
				<?
				if($color_wise_wo_qnty[$qty_index]['fin_fab_qnty']!="")
				{
					echo number_format($color_wise_wo_qnty[$qty_index]['fin_fab_qnty'],2) ;
					$total_fin_fab_qnty+=$color_wise_wo_qnty[$qty_index]['fin_fab_qnty'];
				}
				?>
				</td>
				<td width='50' align='right' >
				<?
				if($color_wise_wo_qnty[$qty_index]['grey_fab_qnty']!="")
				{
					echo number_format($color_wise_wo_qnty[$qty_index]['grey_fab_qnty'],2);
					$total_grey_fab_qnty+=$color_wise_wo_qnty[$qty_index]['grey_fab_qnty'];
				}
				?>
				</td>
				<?
				}
				?>
				<td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>
				<td align="right"><? echo number_format($total_grey_fab_qnty,2); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>

				<td align="right">
				<?
				if($process_loss_method==1)
				{
					$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_fin_fab_qnty)*100;
				}

				if($process_loss_method==2)
				{
					$process_percent=(($total_grey_fab_qnty-$total_fin_fab_qnty)/$total_grey_fab_qnty)*100;
				}
				echo number_format($process_percent,2);

				?>
				</td>
				</tr>
			<?
			}
		?>
        <tr style=" font-weight:bold">
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left">&nbsp;</td>
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$qty_index_wop=$result_fabric_description[csf('body_part_id')].'*'.$result_fabric_description[csf('color_type_id')].'*'.$result_fabric_description[csf('construction')].'*'.$result_fabric_description[csf('composition')].'*'.$result_fabric_description[csf('gsm_weight')].'*'.$result_fabric_description[csf('dia_width')];
			?>
			<td width='50' align='right'><?  echo number_format($color_wise_wo_qnty_wop[$qty_index_wop]['fin_fab_qnty'],2) ;?></td><td width='50' align='right' > <? echo number_format($color_wise_wo_qnty_wop[$qty_index_wop]['grey_fab_qnty'],2);?></td>
            <?
			}
			?>
            <td align="right"><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
            <td align="right"><? echo number_format($grand_total_grey_fab_qnty,2);?></td>
            <td align="right">
            <?
            if($process_loss_method==1)// markup
			{
				$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_fin_fab_qnty)*100;
			}

			if($process_loss_method==2) //margin
			{
				$totalprocess_percent=(($grand_total_grey_fab_qnty-$grand_total_fin_fab_qnty)/$grand_total_grey_fab_qnty)*100;
			}
			echo number_format($totalprocess_percent,2);
			?>
            </td>
            </tr>

    </table>

        <br/>
        <?
	  }
		?>



        <?
	 if(str_replace("'","",$cbo_fabric_source)==2 || str_replace("'","",$cbo_fabric_source)==4)
	  {
		$nameArray_fabric_description= sql_select("SELECT  a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width, avg(b.process_loss_percent) as process_loss_percent,avg(rmg_qty) as rmg_qty FROM wo_pre_cost_fabric_cost_dtls a,wo_booking_dtls b where b.booking_no =$txt_booking_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.status_active=1 and b.is_deleted=0  group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width order by a.body_part_id,dia_width");


		$color_wise_wo_qnty_sql=sql_select("select a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width, b.fabric_color_id, b.po_break_down_id, sum(b.fin_fab_qnty) as fin_fab_qnty,sum(b.grey_fab_qnty) as grey_fab_qnty,avg(b.rate) as rate FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls b WHERE b.booking_no =$txt_booking_no  and a.id=b.pre_cost_fabric_cost_dtls_id and b.status_active=1 and b.is_deleted=0 group by a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, b.dia_width, b.fabric_color_id, b.po_break_down_id");
		$color_wise_wo_qnty=array();
		$color_wise_wo_qnty_wop=array();
		foreach($color_wise_wo_qnty_sql as $row){
			$index=$row[csf('body_part_id')].'*'.$row[csf('color_type_id')].'*'.$row[csf('construction')].'*'.$row[csf('composition')].'*'.$row[csf('gsm_weight')].'*'.$row[csf('dia_width')].'*'.$row[csf('fabric_color_id')].'*'.$row[csf('po_break_down_id')];
			$index_wop=$row[csf('body_part_id')].'*'.$row[csf('color_type_id')].'*'.$row[csf('construction')].'*'.$row[csf('composition')].'*'.$row[csf('gsm_weight')].'*'.$row[csf('dia_width')];
			$color_wise_wo_qnty[$index]['fin_fab_qnty'] = $row[csf('fin_fab_qnty')];
			$color_wise_wo_qnty[$index]['grey_fab_qnty'] = $row[csf('grey_fab_qnty')];
			$color_wise_wo_qnty[$index]['rate'] = $row[csf('rate')];

			$color_wise_wo_qnty_wop[$index_wop]['fin_fab_qnty'] += $row[csf('fin_fab_qnty')];
			$color_wise_wo_qnty_wop[$index_wop]['grey_fab_qnty'] += $row[csf('grey_fab_qnty')];
		}


	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <tr align="center">
     <th colspan="5" align="left">Body Part</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else   echo "<td  colspan='3'>". $body_part[$result_fabric_description[csf('body_part_id')]]."</td>";
		}
		if($show_yarn_rate==1){
		?>
        <td  rowspan="9" width="50"><p>Total   Fabric <? if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
        
		<?php
		}else{
			$colspan="colspan='3'";
			?>
		<td  rowspan="9" width="50" colspan="3"><p>Total   Fabric <? if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
		<?}

		if($show_yarn_rate==1){?>
		<td  rowspan="9" width="50"><p>Rate <? if(trim($cbo_fabric_natu ,"'")==2){echo "(KG)";}else{echo "(Yds)";} ?></p></td>
        <td  rowspan="9" width="50"><p>Amount</p></td>
		<?}?>
       </tr>
     <tr align="center"><th colspan="5" align="left">Color Type</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('color_type_id')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else echo "<td  colspan='3'>". $color_type[$result_fabric_description[csf('color_type_id')]]."</td>";
		}
		?>
        <!--<td  rowspan="8" width="50"><p>Total  Finish Fabric (KG)</p></td> <td  rowspan="8" width="50"><p>Total Grey Fabric (KG)</p></td>-->
             <!--<td  rowspan="7" width="50"><p>Process Loss % </p></td>-->
       </tr>
        <tr align="center"><th colspan="5" align="left">Fabric Construction</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('construction')] == "")  echo "<td  colspan='3'>&nbsp</td>";
			else echo "<td  colspan='3'>". $result_fabric_description[csf('construction')]."</td>";
		}
		?>


       </tr>
        <tr align="center"><th   colspan="5" align="left">Fabric Composition</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='3' >&nbsp</td>";
			else echo "<td colspan='3' >".$result_fabric_description[csf('composition')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th  colspan="5" align="left">GSM</th>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('gsm_weight')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else echo "<td colspan='3' align='center'>". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="5" align="left">Dia/Width (Inch)</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='3'>&nbsp</td>";
			else echo "<td colspan='3' align='center'>".$result_fabric_description[csf('dia_width')]."</td>";
		}
		?>

       </tr>
       <tr align="center"><th   colspan="5" align="left">RMG Qty</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('rmg_qty')] == "")   echo "<td colspan='3'>&nbsp</td>";

			else echo "<td colspan='3' align='center'>". $result_fabric_description[csf('rmg_qty')]."</td>";
		}
		?>

       </tr>
       <tr>
       <th  colspan="<? echo  count($nameArray_fabric_description)*3+5; ?>" align="left" style="height:30px">&nbsp;</th>
       </tr>

       <tr>
            <th  width="120" align="left">PO Number</th>
            <th  width="120" align="left">Ship Date</th>
            <th  width="120" align="left">Fabric Color</th>
            <th  width="120" align="left">Body Color</th>
            <th  width="120" align="left">Lab Dip No</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if($show_yarn_rate==1){
			  echo "<th width='50'>Fab Qty</th><th width='50' >Rate</th><th width='50' >Amount</th>";
			}else{
				echo "<th width='50' colspan='3'>Fab Qty</th>";
			}
		}
		?>

       </tr>
       <?
		  $gmt_color_library=array();
		  $gmt_color_data=sql_select("SELECT gmts_color_id,fabric_color_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("fabric_color_id")]].=$color_library[$gmt_color_row[csf("gmts_color_id")]]."," ;
		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_grey_fab_qnty=0;
			$grand_totalcons_per_finish=0;
			$grand_totalcons_per_grey=0;
			$color_wise_wo_sql=sql_select("SELECT fabric_color_id ,po_break_down_id FROM wo_booking_dtls WHERE booking_no =$txt_booking_no and status_active=1 and is_deleted=0 group by po_break_down_id,fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
          <td  width="120" align="left">
			<?
			echo $po_number_arr[$color_wise_wo_result[csf('po_break_down_id')]];
			?></td>
             <td  width="120" align="left">
			<?

			echo change_date_format($po_ship_date_arr[$color_wise_wo_result[csf('po_break_down_id')]],"dd-mm-yyyy","-");

			?></td>
            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];


			?>
            </td>
            <td>
            <?
			echo rtrim($gmt_color_library[$color_wise_wo_result['fabric_color_id']],",");
			?>
            </td>
            <td  width="120" align="left">
			<?
			$lapdip_no="";
			$lapdip_no=return_field_value("lapdip_no","wo_po_lapdip_approval_info","job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result[csf('fabric_color_id')]."");
			//echo "lapdip_no from wo_po_lapdip_approval_info where job_no_mst='".$job_no."' and approval_status=3 and color_name_id=".$color_wise_wo_result['fabric_color_id']."";
			if($lapdip_no=="") echo "&nbsp;"; echo $lapdip_no;
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_grey_fab_qnty=0;
			$total_amount=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$index_key=$result_fabric_description[csf('body_part_id')].'*'.$result_fabric_description[csf('color_type_id')].'*'.$result_fabric_description[csf('construction')].'*'.$result_fabric_description[csf('composition')].'*'.$result_fabric_description[csf('gsm_weight')].'*'.$result_fabric_description[csf('dia_width')].'*'.$color_wise_wo_result[csf('fabric_color_id')].'*'.$color_wise_wo_result[csf('po_break_down_id')];
			?>
			<td width='50' align='right' <?=$colspan;?>>
			<?
			if($color_wise_wo_qnty[$index_key]['grey_fab_qnty']!="")
			{
			echo number_format($color_wise_wo_qnty[$index_key]['grey_fab_qnty'],2) ;
			$total_fin_fab_qnty+=$color_wise_wo_qnty[$index_key]['grey_fab_qnty'];
			}
			?>
            </td>
				<?php
			if($show_yarn_rate==1){?>

            <td width='50' align='right' >
			<?
			if($color_wise_wo_qnty[$index_key]['grey_fab_qnty']!="")
			{
			echo number_format($color_wise_wo_qnty[$index_key]['rate'],2);
			//$total_grey_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <td width='50' align='right' >
            <?
		    $amount=$color_wise_wo_qnty[$index_key]['grey_fab_qnty']*$color_wise_wo_qnty[$index_key]['rate'];
			if($amount!="")
			{
			echo number_format($amount,2);
			$total_amount+=$amount;
			}
			?>
            </td>
            <?
				}
			}
			?>
            <td align="right" <?=$colspan;?>><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>

			<?php
			if($show_yarn_rate==1){?>
            <td align="right"><? echo number_format($total_amount/$total_fin_fab_qnty,2); $grand_total_amount+=$total_amount;?></td>

            <td align="right">
            <?
			echo number_format($total_amount,2);
			?>
            </td>
			<?}?>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left">&nbsp;</td>
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$index_key_wop=$result_fabric_description[csf('body_part_id')].'*'.$result_fabric_description[csf('color_type_id')].'*'.$result_fabric_description[csf('construction')].'*'.$result_fabric_description[csf('composition')].'*'.$result_fabric_description[csf('gsm_weight')].'*'.$result_fabric_description[csf('dia_width')];
			?>
			<td width='50' align='right' <?=$colspan;?>><?  echo number_format($color_wise_wo_qnty_wop[$index_key_wop]['fin_fab_qnty'],2) ;?></td>
            <?php
			if($show_yarn_rate==1){?>
				<td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2);?></td>
           		<td width='50' align='right' > <? //echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],2);?></td>
            <?
			 }
			}
			?>
            <td align="right" <?=$colspan;?>><? echo number_format($grand_total_fin_fab_qnty,2);?></td>
			<?php
			if($show_yarn_rate==1){?>
            <td align="right"><? echo number_format($grand_total_amount/$grand_total_fin_fab_qnty,2);?></td>
            <td align="right">
            <?
			echo number_format($grand_total_amount,2);
			?>
            </td>
			<?}?>
            </tr>

    </table>

        <br/>
        <?
	  }
		?>




        <?
		if(str_replace("'","",$cbo_fabric_source)==1)
	    {
		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');
		
		if($db_type==2 || $db_type==1)
		{
			
			  $yarn_sql="SELECT MIN (a.id) AS id, a.count_id, a.copm_one_id, a.percent_one, a.copm_two_id, a.percent_two, a.type_id,a.color, SUM (a.cons_qnty) AS yarn_required, AVG (a.rate) AS rate, listagg (CAST (a.fabric_cost_dtls_id AS VARCHAR2 (4000)), ',') WITHIN GROUP (ORDER BY   a.fabric_cost_dtls_id) AS cost_dtls, AVG (a.cons_ratio) AS cons_ratio, sum (b.grey_fab_qnty*a.cons_ratio/100) AS grey_req FROM wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b WHERE a.job_no = '$job_no' AND a.status_active = 1 and a.is_deleted = 0 and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no=b.job_no and b.status_active=1 and b.is_deleted=0 and b.booking_no=$txt_booking_no --and a.count_id=b.yarn_count GROUP BY a.count_id, a.copm_one_id, a.percent_one, a.copm_two_id, a.percent_two, a.type_id,a.color";
  
		}
		else
		{
		
			$yarn_sql="SELECT MIN (a.id) AS id, a.count_id, a.copm_one_id, a.percent_one, a.copm_two_id, a.percent_two, a.type_id,a.color, SUM (a.cons_qnty) AS yarn_required, AVG (a.rate) AS rate, group_concat(fabric_cost_dtls_id) as cost_dtls, sum (b.grey_fab_qnty*a.cons_ratio/100) AS grey_req FROM wo_pre_cost_fab_yarn_cost_dtls a, wo_booking_dtls b WHERE a.job_no = '$job_no' AND a.status_active = 1 and a.is_deleted = 0 and a.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.job_no=b.job_no and b.status_active=1 and b.is_deleted=0 and b.booking_no=$txt_booking_no --and a.count_id=b.yarn_count GROUP BY a.count_id, a.copm_one_id, a.percent_one, a.copm_two_id, a.percent_two, a.type_id,a.color";
			
		}
		//echo $yarn_sql;
		$yarn_sql_array=sql_select($yarn_sql);


		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
            <tr>
                <td width="49%" valign="top">
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    	<td colspan="5"><b>Yarn Required Summary (Pre Cost) </b></td>
                    </tr>
                    <tr align="center">
                        <td>Sl</td>
                        <td>Yarn Description</td>
                        <?
                        if($show_yarn_rate==1)
                        {
                        ?>
                        <td>Rate</td>
                        <?
                        }
                        ?>
                        <td>Cons for <? echo $costing_per; ?> Gmts</td>
                        <td>Total (KG)</td>
                    </tr>
                    <?
					$i=0;
					$total_yarn=0;//$fab_chk_arr=array();
					foreach($yarn_sql_array  as $row)
                    {
						$i++;
						$fabric_cost_id=$row[csf('cost_dtls')];
						$yarn_id=$row[csf('id')];
						?>
						<tr align="center">
                            <td><? echo $i; ?></td>
                            <td>
                            <?
                            $yarn_des=$yarn_count_arr[$row[csf('count_id')]]." ".$composition[$row[csf('copm_one_id')]]." ".$row[csf('percent_one')]."%  ";
                            if($row['copm_two_id'] !=0)
                            {
                                $yarn_des.=$composition[$row[csf('copm_two_id')]]." ".$row[csf('percent_two')]."%";
                            }
                            $yarn_des.=$color_library[$row[csf('color')]]." ";
                            $yarn_des.=$yarn_type[$row[csf('type_id')]];
                            echo $yarn_des;
                            ?>
                            </td>
                            <?
                            if($show_yarn_rate==1)
                            {
                            ?>
                             <td><? echo number_format($row[csf('rate')],4); ?></td>
                             <?
                            }
                             ?>
                            <td><? echo number_format($row[csf('yarn_required')],4); ?></td>

                            <!--<td><? //echo number_format(($row['yarn_required']/$po_qnty_tot)*$costing_per_qnty,2); ?></td>-->
                          <!--   <td align="right"><? //echo number_format($rowcons_qnty,2); $total_yarn+=$rowcons_qnty; ?></td> -->
                          <td align="right" title="Grey Fab Qty(<? //echo $tot_booking_grey[0][csf("grey_qty")];?>)*Avg Pre Yarn Ratio(<? //echo $row[csf("cons_ratio")];?>)/100"><? $total_kg=$row[csf('grey_req')];//$tot_booking_grey[0][csf("grey_qty")] * ($row[csf("cons_ratio")]/100); 
						  echo number_format($total_kg,2); ?> </td>
						</tr>
						<?
						$total_yarn += $total_kg;
						$tot_qty+=$tot_booking_grey[0][csf("grey_qty")];
					}
					?>
                    <tr align="center">
                        <td></td>
                        <td></td>
                        <?
                        if($show_yarn_rate==1)
                        {
                        ?>
                        <td></td>
                        <?
                        }
                        ?>
                        <td align="right">Total : </td>
                        <td align="right" title="<? //echo $tot_qty;?>"><? echo number_format($total_yarn,2); ?></td>
                    </tr>
                    </table>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                <?
				$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id order by a.id");
				if(count($yarn_sql_array)>0)
				{
				?>
                   <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Allocated Yarn</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>


                    <td>Allocated Qty (Kg)</td>
                    </tr>
                    <?
					$total_allo=0;
					$item=return_library_array( "select id, product_name_details from   product_details_master",'id','product_name_details');
					$supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
					//$yarn_sql_array=sql_select("SELECT a.item_id, a.qnty,b.supplier_id,b.lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0");
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?

					echo $item[$row[csf('item_id')]];
					?>
                    </td>
                    <td>
                    <?

					echo $supplier[$row[csf('supplier_id')]];
					?>
                    </td>
                    <td>
					<?

					echo $row[csf('lot')];
					?>
                    </td>
                    <td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>


                    <td></td>
                    <td></td>
                    <td align="right"><? echo number_format($total_allo,4); ?></td>
                    </tr>
                    </table>
                    <?
				}
				else
				{
					$is_yarn_allocated=return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_name and variable_list=18 and item_category_id=1");
					if($is_yarn_allocated==1)
					{
					?>
					<font style=" font-size:30px"><b> Draft</b></font>
                    <?
					}
					else
					{
						echo "";
					}
				}
					?>
                </td>
            </tr>
        </table>
        <br/>
        <?
		}
		?>
        <?
		$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
            <tr>
                <td width="49%" valign="top">
                <?
				if(count($sql_embelishment)>0)
				{
				?>
                    <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Embelishment (Pre Cost)</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Embelishment Name</td>
                    <td>Embelishment Type</td>
                    <td>Cons <? echo $costing_per; ?> Gmts</td>
                    <td>Rate</td>
                    <td>Amount</td>

                    </tr>
                    <?
					$sql_embelishment=sql_select("select emb_name,emb_type,cons_dzn_gmts,rate,amount from wo_pre_cost_embe_cost_dtls where job_no='$job_no' and status_active=1 and 	is_deleted=0");
					$i=0;
					//$total_yarn=0;
					foreach($sql_embelishment  as $row_embelishment)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?
					echo $emblishment_name_array[$row_embelishment[csf('emb_name')]];
					?>
                    </td>
                    <td>
                    <?
					if($row_embelishment[csf('emb_name')]==1)
					{
					echo $emblishment_print_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==2)
					{
					echo $emblishment_embroy_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==3)
					{
					echo $emblishment_wash_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==4)
					{
					echo $emblishment_spwork_type[$row_embelishment[csf('emb_type')]];
					}
					if($row_embelishment[csf('emb_name')]==5)
					{
					echo $row_embelishment[csf('emb_type')];
					}
					?>

                    </td>
                    <td>
                    <?
					echo $row_embelishment[csf('cons_dzn_gmts')];
					?>
                    </td>
                    <td>
					<?
					echo $row_embelishment[csf('rate')];
					?>
                    </td>

                    <td>
					<?
					echo $row_embelishment[csf('amount')];
					?>
                    </td>


                    </tr>
                    <?
					}
					?>
                    </table>
                    <?
				}
					?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td><b>Approved Instructions</b></td>

                    </tr>
                    <tr>
                    <td>
                <?  echo $nameArray_approved_comments_row[csf('comments')];  ?>
                </td>
                </tr>
                </table>

                </td>
            </tr>
        </table>
        <br/>

         <br>
        <?
     $desg_name=return_library_array( "select id, custom_designation from lib_designation", "id", "custom_designation"  );
	 $data_array=sql_select("select b.approved_by,b.approved_no, b.approved_date, c.user_full_name,c.designation from  wo_booking_mst a , approval_history b, user_passwd c where a.id=b.mst_id and b.approved_by=c.id and a.booking_no=$txt_booking_no and b.entry_form=12 order by b.id asc");
	?>
       <table  width="100%" class="rpt_table"   border="1" cellpadding="0" cellspacing="0" rules="all">
            <thead>
            <tr style="border:1px solid black;">
                <th colspan="3" style="border:1px solid black;">Approval Status</th>
            </tr>
                <tr style="border:1px solid black;">
                <th width="3%" style="border:1px solid black;">Sl</th>
                <th width="50%" style="border:1px solid black;">Name/Designation</th>
                <th width="27%" style="border:1px solid black;">Approval Date</th>
                <th width="20%" style="border:1px solid black;">Approval No</th>
                </tr>
            </thead>
            <tbody>
            <?
			$s=1;
			foreach($data_array as $row){
			?>
            <tr style="border:1px solid black;">
                <td width="3%" style="border:1px solid black;"><? echo $s;?></td><td width="50%" style="border:1px solid black;"><? echo $row[csf('user_full_name')].'/'.$desg_name[$row[csf('designation')]];?></td><td width="27%" style="border:1px solid black;"><? echo date ("d-m-Y h:i:s",strtotime($row[csf('approved_date')])); //echo change_date_format($row[csf('approved_date')],"dd-mm-yyyy","-");?></td><td width="20%" style="border:1px solid black;"><? echo $row[csf('approved_no')];?></td>
                </tr>
                <?
				$s++;
			}
				?>
            </tbody>
        </table>
        </br>


        <table  width="100%"  border="0" cellpadding="0" cellspacing="0">
            <tr>
                <td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
                    <?php echo get_spacial_instruction($txt_booking_no); ?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top">
                <?
				if(str_replace("'","",$cbo_fabric_source)==1 || str_replace("'","",$cbo_fabric_source)==2 || str_replace("'","",$cbo_fabric_source)==4)
				{
				?>
                   <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                   <tr align="center">
                    <td colspan="10"><b>Comments</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Po NO</td>
                    <td>Ship Date</td>
                    <td>Pre-Cost Qty</td>
                    <td>Mn.Book Qty</td>
                    <td>Sht.Book Qty</td>
                    <td>Smp.Book Qty</td>
					<td>Par.Book Qty</td>
                    <td>Tot.Book Qty</td>
                    <td>Balance</td>
                    <td>Comments</td>
                    </tr>
                    <?
						$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
						$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
						if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
						if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
						$paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_mst_id,size_mst_id,item_mst_id", "id", "plan_cut_qnty");

						$item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no =$txt_job_no", "gmts_item_id", "set_item_ratio");
						$nameArray=sql_select(" select a.id, a.item_number_id, a.costing_per, b.po_break_down_id, b.color_size_table_id, b.requirment, c.po_number FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_break_down c WHERE a.job_no=b.job_no and a.job_no=c.job_no_mst and a.id=b.pre_cost_fabric_cost_dtls_id and b.po_break_down_id=c.id and b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0 order by a.id");
						$count=0;
						$tot_grey_req_as_pre_cost_arr=array();
						foreach ($nameArray as $result)
						{
							if (count($nameArray)>0 )
							{
								if($result[csf("costing_per")]==1)
								{
									$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(12*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
								}
								if($result[csf("costing_per")]==2)
								{
									$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(1*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
								}
								if($result[csf("costing_per")]==3)
								{
									$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(24*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
								}
								if($result[csf("costing_per")]==4)
								{
									$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(36*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
								}
								if($result[csf("costing_per")]==5)
								{
									$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(48*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
								}
								$tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
							}
						}
	                $total_pre_cost=0;
					$total_booking_qnty_main=0;
					$total_booking_qnty_short=0;
					$total_booking_qnty_sample=0;
					$total_tot_bok_qty=0;
					$tot_balance=0;
					$booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

					$booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in (".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
					
					$booking_qnty_partial=return_library_array( "select a.po_break_down_id as po_break_down_id,sum(a.grey_fab_qnty) as grey_fab_qnty ,sum(a.fin_fab_qnty) as fin_fab_qnty,a.job_no,c.item_category,c.entry_form,c.booking_no from wo_booking_dtls a , wo_booking_mst c 	where  a.booking_no =c.booking_no  and c.entry_form=108 and a.po_break_down_id in (".str_replace("'","",$txt_order_no_id).") and a.booking_type =1  and a.is_short=2 and a.status_active=1 and a.is_deleted=0  group by a.job_no,c.item_category,c.entry_form,c.booking_no,a.po_break_down_id  order by po_break_down_id", "po_break_down_id", "fin_fab_qnty");


					$booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

					$sql_data=sql_select( "select max(a.id) as id,a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.po_number order by id");
					foreach($sql_data  as $row)
                    {
					$col++;
					?>
                    <tr align="center">
                    <td><? echo $col; ?></td>
                    <td><? echo $row[csf("po_number")]; ?></td>
                     <td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
                    <td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
                    <td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
                    <td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
                    <td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
					<td align="right"><? echo number_format($booking_qnty_partial[$row[csf("id")]],2); $total_booking_qnty_partial+=$booking_qnty_partial[$row[csf("id")]];?></td>
                    <td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
                    <td align="right">
					<? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
                    </td>
                    <td>
					<?
					if( $balance>0)
					{
						echo "Less Booking";
					}
					else if ($balance<0)
					{
						echo "Over Booking";
					}
					else
					{
						echo "";
					}
					?>
                    </td>
                    </tr>
                    <?
					}
					?>
                    <tfoot>

                    <tr>
                    <td colspan="3">Total:</td>

                    <td align="right"><? echo number_format($total_pre_cost,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
					<td align="right"><? echo number_format($total_booking_qnty_partial,2); ?></td>
                     <td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
                    <td align="right"><? echo number_format($tot_balance,2); ?></td>
                    <td></td>
                    </tr>
                    </tfoot>
                    </table>
                    <?
				}
				?>
                </td>

            </tr>
        </table>


        <br/>
        <?
		$department_name_library=return_library_array( "select id,department_name from  lib_department where status_active=1 and is_deleted=0 order by  department_name", "id", "department_name"  );

		$sql_responsible= sql_select("select responsible_dept,	responsible_person,	reason from wo_booking_dtls where booking_no =$txt_booking_no");
		if(count($sql_responsible)>0)
		{
		?>
         <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
         <tr>
         <td>
          #
         </td>
          <td>
         Responsible Dept.
         </td>
         <td>
         Responsible person
         </td>
         <td>
         Reason
         </td>
         </tr>
         <?
		 $ir=1;
		foreach($sql_responsible as $sql_responsible_row)
		{
			?>
             <tr>
             <td>
             <?  echo $ir; ?>
             </td>
              <td>
             <?
			 $responsible_dept_st="";
			 $responsible_dept_arr=explode( ",",$sql_responsible_row[csf('responsible_dept')]);
			 foreach($responsible_dept_arr as $key => $value)
			 {
				 $responsible_dept_st.= $department_name_library[$value].", ";
			 }
			 echo rtrim($responsible_dept_st,", ");
			 ?>
             </td>
             <td>
            <?=$sql_responsible_row[csf('responsible_person')]; ?>
             </td>
             <td>
              <?=$sql_responsible_row[csf('reason')]; ?>
             </td>
             </tr>
            <?
			$ir++;

		}
		 ?>
         </table>
         <?
		}
		$job_imge_arr = sql_select("select master_tble_id,image_location from   common_photo_library where form_name='knit_order_entry'  and file_type=1 and master_tble_id =$txt_job_no");
		foreach ($job_imge_arr as $row) {
			$image_location = $row[csf('image_location')];
		}
		 ?>
         <table width="100%"   cellpadding="2" cellspacing="0" rules="all" style="border-left: none;border-right: none;border-top: none;border-bottom: none; margin-top: 10px">
			<tr>
			 	<td align="left" style="border-left: none;border-right: none;border-top: none;border-bottom: none;">
			 		<img  src='<? echo $path.$image_location; ?>' height='180' width='250' />
			 	</td>
			</tr>
		</table>

         <?
		 	echo signature_table(4, $cbo_company_name, "1330px");
			echo "****".custom_file_name($txt_booking_no,$style_sting,$txt_job_no);
		 ?>

       </div>
       <?
	   exit();
}

if($action=="show_fabric_booking_report4")
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	$report_type=str_replace("'","",$report_type);
	if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
	if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');
	//$supplier_address_arr=return_library_array( "select id,address_1 from   lib_supplier",'id','address_1');
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
//	$po_qnty_tot=return_field_value( "sum(plan_cut) as plan_cut", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");
	//$po_qnty_tot1=return_field_value( "sum(po_quantity)", "wo_po_break_down","id in(".str_replace("'","",$txt_order_no_id).")");

	//$po_number_arr=return_library_array( "select id,po_number from   wo_po_break_down",'id','po_number');
	//$po_ship_date_arr=return_library_array( "select id,pub_shipment_date from   wo_po_break_down ",'id','pub_shipment_date');
	$user_arr=return_library_array( "select id,user_name from   user_passwd ",'id','user_name');
	$sql_po=sql_select("select a.job_no,a.location_name,a.style_ref_no,b.style_description,b.id,b.po_number,b.pub_shipment_date,b.plan_cut,b.po_quantity from wo_po_break_down b,wo_po_details_master a where a.job_no=b.job_no_mst and b.id in(".str_replace("'","",$txt_order_no_id).") and b.status_active=1 and a.status_active=1");
	//echo "select a.location_name,a.style_ref_no,b.style_description,b.id,b.po_number,b.pub_shipment_date,b.plan_cut,b.po_quantity from wo_po_break_down b,wo_po_details_master a where a.job_no=b.job_no_mst and b.id in(".str_replace("'","",$txt_order_no_id).") and b.status_active=1 and a.status_active=1";
	$po_qnty_tot=0;$po_qnty_tot1=0;
	foreach($sql_po as $row)
	{
		$po_qnty_tot+=$row[csf('plan_cut')];
		$po_qnty_tot1+=$row[csf('po_quantity')];
		$location_name=$row[csf('location_name')];
		$style_ref_no=$row[csf('style_ref_no')];
		$style_description=$row[csf('style_description')];
		//$job_no=$row[csf('job_no')];
		$po_number_arr[$row[csf('id')]]=$row[csf('po_number')];
		$po_ship_date_arr[$row[csf('id')]]=$row[csf('pub_shipment_date')];
	}

	?>
	<div style="width:1330px" align="left">
    	<?php

$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12");
list($nameArray_approved_row) = $nameArray_approved;
$nameArray_approved_date = sql_select("select b.approved_date as approved_date,approved_by from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
list($nameArray_approved_date_row) = $nameArray_approved_date;
$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "'");
list($nameArray_approved_comments_row) = $nameArray_approved_comments;
$path = str_replace("'", "", $path);
if ($path == "") {
	$path = '../../';
}

?>									<!--    Header Company Information         -->
       <table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black" >
           <tr>
               <td width="100">
               <?
               if($report_type==1)
			   {
			   ?>
               <img  src='../../<? echo $imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
               <?
			   }
			   else if($report_type==2)
			   {
			   ?>
               <img  src='../<? echo $imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
               <?
			   }
			   else
			   {
			   ?>
               <img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
               <?
			   }
			   ?>
               </td>
               <td width="1250">
                    <table width="100%" cellpadding="0" cellspacing="0"  >
                        <tr>
                            <td align="center" style="font-size:20px;">
                              <?php
echo $company_library[$cbo_company_name];
?>
                            </td>
                            <td rowspan="3" width="250">
                               <span style="font-size:18px"><b> Job No:&nbsp;&nbsp;<? echo trim($txt_job_no,"'"); ?></b></span>
                                <br/>
                               <?
								 if($nameArray_approved_row[csf('approved_no')]>1)
								 {
								 ?>
								 <b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
                                  <br/>
								  Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
                                   <?
								 }
							  	?>
                            </td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:14px">
                            <?
                          $nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
						   if($txt_job_no!="")
							{
							 $location=$location_name;//return_field_value( "location_name", "wo_po_details_master","job_no=$txt_job_no");
							}
							else
							{
							$location="";
							}


                            foreach ($nameArray as $result)
                            {
								echo $location_name_arr[$location];

                            ?>
                               <!-- Plot No:--> <? //echo $result[csf('plot_no')]; ?>
                               <? //echo $result[csf('level_no')]?>
                                <? //echo $result[csf('road_no')]; ?>
                                <? //echo $result[csf('block_no')];?>
                                 <? //echo $result[csf('city')];?>
                                 <? //echo $result[csf('zip_code')]; ?>
                                <?php //echo $result[csf('province')];?>
                                 <? echo $country_arr[$result[csf('country_id')]]; ?> <br>
                                Email Address: <? echo $result[csf('email')];?>
                                Website No:<? echo $result[csf('website')];

                            }
                            ?>
                               </td>
                            </tr>
                            <tr>
                            <td align="center" style="font-size:20px">
                                <strong><? if($report_type==1) echo str_replace("'","",$report_title);else echo 'Short Fabric Booking';//echo str_replace("'","",$report_title);?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
                             </td>
                            </tr>
                      </table>
                </td>
            </tr>
       </table>
                <?
				$job_no='';
				$total_set_qnty=0;
				$colar_excess_percent=0;
				$cuff_excess_percent=0;
				$rmg_process_breakdown=0;
				$style_ref_no="";
				$inserted_by="";
                $nameArray=sql_select( "select a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.pay_mode,a.rmg_process_breakdown,a.insert_date,a.inserted_by,a.update_date,b.job_no,b.buyer_name, b.style_ref_no ,b.gmts_item_id,b.order_uom,b.total_set_qnty,b.style_description,b.season,b.product_dept,b.product_code,b.pro_sub_dep,b.dealing_marchant from wo_booking_mst a, wo_po_details_master b where  a.job_no=b.job_no and a.booking_no=$txt_booking_no");
				foreach ($nameArray as $result)
				{
					$total_set_qnty=$result[csf('total_set_qnty')];
					$colar_excess_percent=$result[csf('colar_excess_percent')];
				    $cuff_excess_percent=$result[csf('cuff_excess_percent')];
					$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
					$inserted_by=$result[csf('inserted_by')];
					$po_no="";
					$shipment_date="";$internal_ref="";	$file_no="";
					$sql_po= "select po_number,grouping,file_no,MIN(pub_shipment_date) pub_shipment_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].") group by po_number,grouping,file_no";
					$data_array_po=sql_select($sql_po);
					foreach ($data_array_po as $row_po)
					{
						$po_no.=$row_po[csf('po_number')].", ";
						$shipment_date.=change_date_format($row_po[csf('pub_shipment_date')],'dd-mm-yyyy','-').", ";
						$internal_ref.=$row_po[csf('grouping')].", ";
						$file_no.=$row_po[csf('file_no')].", ";
					}
					$lead_time=="";
					if($db_type==0)
					{
					$sql_lead_time= "select DATEDIFF(pub_shipment_date,po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}
					if($db_type==2)
					{
					$sql_lead_time= "select (pub_shipment_date-po_received_date) date_diff from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					}

					$data_array_lead_time=sql_select($sql_lead_time);
					foreach ($data_array_lead_time as $row_lead_time)
					{
						$lead_time.=$row_lead_time[csf('date_diff')].",";
						//$shipment_date.=change_date_format($row_po['pub_shipment_date'],'dd-mm-yyyy','-').",";
					}
					$po_received_date="";
					$sql_po_received_date= "select MIN(po_received_date) as po_received_date from  wo_po_break_down  where id in(".$result[csf('po_break_down_id')].")";
					$data_array_po_received_date=sql_select($sql_po_received_date);
					foreach ($data_array_po_received_date as $row_po_received_date)
					{
						$po_received_date=change_date_format($row_po_received_date[csf('po_received_date')],'dd-mm-yyyy','-');
						//$shipment_date.=change_date_format($row_po['pub_shipment_date'],'dd-mm-yyyy','-').",";
					}
					$file=rtrim($file_no,", ");//rtrim($po_no,", ")
					$file_all=array_unique(explode(",",$file));

					$file='';
					foreach($file_all as $file_id)
					{
						if($file=="") $file_cond=$file_id; else $file_cond.=", ".$file_id;
					}
				?>
       <table width="100%" style="border:1px solid black" >
            <tr>
                <td colspan="6" valign="top" style="font-size:18px; color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
            </tr>
            <tr>
                <td width="100"><span style="font-size:18px"><b>Buyer/Agent Name</b></span></td>
                <td width="110">:&nbsp;<span style="font-size:18px"><b><? echo $buyer_name_arr[$result[csf('buyer_name')]]; ?></b></span></td>
                <td width="100"><span style="font-size:12px"><b>Dept.</b></span></td>
                <td width="110">:&nbsp;<? echo $product_dept[$result[csf('product_dept')]] ; if($result[csf('product_code')] !=""){ echo " (".$result[csf('product_code')].")";} if($result[csf('pro_sub_dep')] !=0){ echo " (".$pro_sub_dept_array[$result[csf('pro_sub_dep')]].")";}?></td>
                <td width="100"><span style="font-size:12px"><b>Order Qnty</b></span></td>
                <td width="110">:&nbsp;
				<?  echo $po_qnty_tot1." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?>
                </td>
            </tr>
            <tr>

                <td width="100" style="font-size:12px"><b>Garments Item</b></td>
                <td width="110">:&nbsp;
				<?
				$gmts_item_name="";
				$gmts_item=explode(',',$result[csf('gmts_item_id')]);
				for($g=0;$g<=count($gmts_item); $g++)
				{
					$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
				}
				echo rtrim($gmts_item_name,',');
				?>
                </td>
                <td width="100" style="font-size:12px"><b>Booking Release Date</b></td>
                <td width="110">:&nbsp;
				<?
				$booking_date=$result[csf('update_date')];
				if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
				{
					$booking_date=$result[csf('insert_date')];
				}
				echo change_date_format($booking_date,'dd-mm-yyyy','-','');
				?>&nbsp;&nbsp;&nbsp;
                </td>
                <td width="100" style="font-size:18px"><b>Style Ref.</b>   </td>
                <td width="110" style="font-size:18px">:&nbsp;
                <b>
				<?
				echo $result[csf('style_ref_no')];
				$style_ref_no=$result[csf('style_ref_no')];
				?>
                </b>
                </td>

            </tr>
             <tr>



                <td  width="100" style="font-size:12px"><b>Style Des.</b></td>
                <td  width="110" >:&nbsp;<? echo $result[csf('style_description')]; $job_no= $result[csf('job_no')];?></td>
                <td width="100" style="font-size:12px"><b>Lead Time </b>   </td>
                <td width="110">:&nbsp;<?=implode(",",array_filter(array_unique(explode(",",$lead_time))));?> </td>
                <td width="100" style="font-size:12px"><b>Dealing Merchandiser</b></td>
                <td width="110">:&nbsp;<? echo $marchentrArr[$result[csf('dealing_marchant')]]; ?></td>



            </tr>

            <tr>
                <td width="100" style="font-size:12px"><b>Supplier Name</b>   </td>
                <td width="110">:&nbsp;<?
				if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3){
					echo $company_library[$result[csf('supplier_id')]];
					}
					else{
					echo $supplier_name_arr[$result[csf('supplier_id')]];
					}
				//echo $supplier_name_arr[$result[csf('supplier_id')]];?>    </td>
                <td width="100" style="font-size:12px"><b>Delivery Date</b></td>
               	<td width="110">:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
                <td width="100" style="font-size:18px"><b>Booking No </b>   </td>
                <td width="110" style="font-size:18px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?></td>



            </tr>
            <tr>
                <td width="100" style="font-size:12px"><b>Season</b></td>
                <td width="110">:&nbsp;<? echo $result[csf('season')]; ?></td>
                <td  width="100" style="font-size:12px"><b>Attention</b></td>
                <td  width="110" >:&nbsp;<? echo $result[csf('attention')]; ?></td>
                <td  width="100" style="font-size:12px"><b>Po Received Date</b></td>
                <td  width="110" >:&nbsp;<?=implode(",",array_filter(array_unique(explode(",",$po_received_date)))); ?></td>
            </tr>
             <tr>
                <td width="100" style="font-size:17px"><b>Internal Ref</b></td>
                <td width="110" colspan="3" style="font-size:16px">:&nbsp;<b><?=implode(",",array_filter(array_unique(explode(",",$internal_ref)))); ?></b></td>
                <td  width="100" style="font-size:17px"><b>File No</b></td>
                <td  width="110" colspan="2" style="font-size:16px">:&nbsp;<b><?=implode(",",array_filter(array_unique(explode(",",$file_cond)))); ?></b></td>

            </tr>
        </table>
           <?
			}
			//echo "select distinct size_number_id from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  	is_deleted=0 and status_active=1 order by size_number_id";
			//$nameArray_size=sql_select( "select distinct size_number_id from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  	is_deleted=0 and status_active=1 order by size_number_id");
			$nameArray_size=sql_select( "select  size_number_id,min(id) as id from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  	is_deleted=0 and status_active=1 group by size_number_id order by id");
		   ?>
            <table width="100%" >
		    <tr>
            <td width="800">
                <div id="div_size_color_matrix" style="float:left; max-width:1000;">
            	<fieldset id="div_size_color_matrix" style="max-width:1000;">
 				<legend>Size and Color Breakdown                </legend>
 				<table  class="rpt_table"  border="1" align="left" cellpadding="0" width="750" cellspacing="0" rules="all" >
                    <tr>
                        <td style="border:1px solid black"><strong>PO Namber</strong></td>
                        <td style="border:1px solid black"><strong>Ship Date</strong></td>
                        <td style="border:1px solid black"><strong>Gmts Item</strong></td>
                        <td style="border:1px solid black"><strong>Style Ref</strong></td>
                        <td style="border:1px solid black"><strong>Color/Size</strong></td>
                    <?
						foreach($nameArray_size  as $result_size)
                        {	     ?>
                        <td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
                    <?	}    ?>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Order Qty(Pcs)</strong></td>
                        <td style="border:1px solid black; width:80px" align="center"><strong> Excess %</strong></td>
                        <td style="border:1px solid black; width:130px" align="center"><strong> Total Plan Cut Qty(Pcs)</strong></td>
                    </tr>
                    <?
					$color_size_order_qnty_array=array();
					$color_size_qnty_array=array();
					$size_tatal=array();
					$size_tatal_order=array();
					$order_id=explode(",",str_replace("'","",$txt_order_no_id));
					for($or=0;$or<count($order_id); $or++)
				    {
					for($c=0;$c<count($gmts_item); $c++)
				    {
					$item_size_tatal=array();
					$item_size_tatal_order=array();
					$item_grand_total=0;
					$item_grand_total_order=0;
					$nameArray_color=sql_select( "select  color_number_id, min(id) as id from wo_po_color_size_breakdown where  item_number_id=$gmts_item[$c] and po_break_down_id =$order_id[$or] and is_deleted=0 and status_active=1 group by color_number_id  order by id");
					?>
                   <!-- <tr>
                    <td style="border:1px solid black" colspan="<? echo count($nameArray_size)+3;?>"><strong><? echo $garments_item[$gmts_item[$c]];?></strong></td>

                    </tr>-->
                    <?
					foreach($nameArray_color as $result_color)
                    {
                    ?>
                    <tr>
                        <td align="center" style="border:1px solid black"><? echo $po_number_arr[$order_id[$or]]; // echo $row_num_tr; ?></td>
                         <td align="center" style="border:1px solid black"><? echo change_date_format($po_ship_date_arr[$order_id[$or]],"dd-mm-yyyy","-"); // echo $row_num_tr; ?></td>
                          <td align="center" style="border:1px solid black"><? echo $garments_item[$gmts_item[$c]]; // echo $row_num_tr; ?></td>
                          <td align="center" style="border:1px solid black"><? echo $style_ref_no; // echo $row_num_tr; ?></td>
                        <td align="center" style="border:1px solid black"><? echo $color_library[$result_color[csf('color_number_id')]]; // echo $row_num_tr; ?></td>
                        <?
						$color_total=0;
						$color_total_order=0;

						foreach($nameArray_size  as $result_size)
						{
						$nameArray_color_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id =$order_id[$or] and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$result_color[csf('color_number_id')]."  and item_number_id=$gmts_item[$c] and  status_active=1 and is_deleted =0");
						foreach($nameArray_color_size_qnty as $result_color_size_qnty)
                        {

                        ?>
                            <td style="border:1px solid black; text-align:right">
							<?
								if($result_color_size_qnty[csf('plan_cut_qnty')]!= "")
								{
									 echo number_format($result_color_size_qnty[csf('order_quantity')],0);
									 $color_total += $result_color_size_qnty[csf('plan_cut_qnty')] ;
									 $color_total_order += $result_color_size_qnty[csf('order_quantity')] ;
									 $item_grand_total+=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $item_grand_total_order+=$result_color_size_qnty[csf('order_quantity')];
								     $grand_total +=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $grand_total_order +=$result_color_size_qnty[csf('order_quantity')];
									 $color_size_qnty_array[$result_size[csf('size_number_id')]][$result_color['color_number_id']]=$result_color_size_qnty[csf('plan_cut_qnty')];
									 $color_size_order_qnty_array[$result_size[csf('size_number_id')]][$result_color[csf('color_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 if (array_key_exists($result_size[csf('size_number_id')], $size_tatal))
									 {
											$size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
											$size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
									 }
									 else
									 {
										$size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
										$size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 }
									 if (array_key_exists($result_size[csf('size_number_id')], $item_size_tatal))
									 {
											$item_size_tatal[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('plan_cut_qnty')];
											$item_size_tatal_order[$result_size[csf('size_number_id')]]+=$result_color_size_qnty[csf('order_quantity')];
									 }
									 else
									 {
										$item_size_tatal[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('plan_cut_qnty')];
										$item_size_tatal_order[$result_size[csf('size_number_id')]]=$result_color_size_qnty[csf('order_quantity')];
									 }
								}
								else echo "0";
							 ?>
							</td>

                    <?
						}
                        }
                        ?>
                        <td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total_order),0); ?></td>
                         <td style="border:1px solid black; text-align:right"><? $excexss_per=($color_total-$color_total_order)/$color_total_order*100; echo number_format($excexss_per,2)." %"; ?></td>
                         <td style="border:1px solid black; text-align:right"><? echo number_format(round($color_total),0); ?></td>
                    </tr>
                    <?
                    }
					?>
                      <td align="center" style="border:1px solid black"><strong></strong></td>
                      <td align="center" style="border:1px solid black"><strong></strong></td>
                      <td align="center" style="border:1px solid black"><strong></strong></td>
                      <td align="center" style="border:1px solid black"><strong></strong></td>
                      <td align="center" style="border:1px solid black"><strong>Sub Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $item_size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_item_gra_tot=($item_grand_total-$item_grand_total_order)/$item_grand_total_order*100; echo number_format($excess_item_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($item_grand_total),0); ?></td>
                    </tr>
                    <?
					}
					}
                    ?>
                     <tr>
                        <td style="border:1px solid black" align="center" colspan="<? echo count($nameArray_size)+8; ?>"><strong>&nbsp;</strong></td>
                        </tr>
                    <tr>
                    <tr>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                    <td align="center" style="border:1px solid black"><strong></strong></td>
                        <td align="center" style="border:1px solid black"><strong>Grand Total</strong></td>
                        <?
						foreach($nameArray_size  as $result_size)
                        {
                        ?>
                        <td style="border:1px solid black;  text-align:right"><? echo $size_tatal_order[$result_size[csf('size_number_id')]];  ?></td>
                        <?
                        }
                        ?>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total_order),0); ?></td>
                        <td  style="border:1px solid black;  text-align:right"><? $excess_gra_tot= ($grand_total-$grand_total_order)/$grand_total_order*100; echo number_format($excess_gra_tot,2)." %"; ?></td>
                        <td  style="border:1px solid black;  text-align:right"><?  echo number_format(round($grand_total),0); ?></td>
                    </tr>
                </table>
                </fieldset>
                </div>
                </td>
                <td width="200" valign="top" align="left">
                <div id="div_size_color_matrix" style="float:left;">
            	<?
				$rmg_process_breakdown_arr=explode('_',$rmg_process_breakdown)
				?>
            	 	<fieldset id="" >
 				<legend>RMG Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                <?
				if(number_format($rmg_process_breakdown_arr[8],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Cut Panel rejection <!-- Extra Cutting % breack Down 8-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[8],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[2],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Chest Printing <!-- Printing % breack Down 2-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[2],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[10],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Neck/Sleeve Printing <!-- New breack Down 10-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[10],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[1],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Embroidery   <!-- Embroidery  % breack Down 1-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[1],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[4],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Sewing /Input<!-- Sewing % breack Down 4-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[4],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[3],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Garments Wash <!-- Washing %breack Down 3-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[3],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[15],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Gmts Finishing <!-- Washing %breack Down 3-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[15],2);
				?>
                </td>
                </tr>
                <?
                }
				if(number_format($rmg_process_breakdown_arr[11],2)>0)
				{
				?>
                <tr>
                <td width="130">
                 Others <!-- New breack Down 11-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[11],2);
				?>
                </td>
                </tr>
                <?
                }
				$gmts_pro_sub_tot=$rmg_process_breakdown_arr[8]+$rmg_process_breakdown_arr[2]+$rmg_process_breakdown_arr[10]+$rmg_process_breakdown_arr[1]+$rmg_process_breakdown_arr[4]+$rmg_process_breakdown_arr[3]+$rmg_process_breakdown_arr[11]+$rmg_process_breakdown_arr[15];
				if($gmts_pro_sub_tot>0)
				{
				?>
                <tr>
                <td width="130">
                Sub Total <!-- New breack Down 11-->
                </td>
                <td align="right">
                <?

				echo number_format($gmts_pro_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				?>
                </table>
                </fieldset>


                <fieldset id="" >
 				<legend>Fabric Process Loss % </legend>
            	<table width="180" class="rpt_table" border="1" rules="all">
                 <?
				if(number_format($rmg_process_breakdown_arr[6],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Knitting  <!--  Knitting % breack Down 6-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[6],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[12],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Yarn Dyeing  <!--  New breack Down 12-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[12],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[5],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Dyeing & Finishing  <!-- Finishing % breack Down 5-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[5],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[13],2)>0)
				{
				?>
                <tr>
                <td width="130">
                All Over Print <!-- new  breack Down 13-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[13],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[14],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Lay Wash (Fabric) <!-- new  breack Down 14-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[14],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[7],2)>0)
				{
				?>
                 <tr>
                <td width="130">
                Dying   <!-- breack Down 7-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[7],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[0],2)>0)
				{
				?>
                <tr>
                <td width="130">
                Cutting (Fabric) <!-- Cutting % breack Down 0-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[0],2);
				?>
                </td>
                </tr>
                <?
				}
				if(number_format($rmg_process_breakdown_arr[9],2)>0)
				{
				?>
                <tr>
                <td width="130">
               Others  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?
				echo number_format($rmg_process_breakdown_arr[9],2);
				?>
                </td>
                </tr>
                <?
				}
				$fab_proce_sub_tot=$rmg_process_breakdown_arr[6]+$rmg_process_breakdown_arr[12]+$rmg_process_breakdown_arr[5]+$rmg_process_breakdown_arr[13]+$rmg_process_breakdown_arr[14]+$rmg_process_breakdown_arr[7]+$rmg_process_breakdown_arr[0]+$rmg_process_breakdown_arr[9];
				if(fab_proce_sub_tot>0)
				{
				?>
                <tr>
                <td width="130">
                Sub Total  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?

				echo number_format($fab_proce_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				if($gmts_pro_sub_tot+$fab_proce_sub_tot>0)
				{
				?>
                 <tr>
                <td width="130">
                Grand Total  <!-- Others% breack Down 9-->
                </td>
                <td align="right">
                <?
				echo number_format($gmts_pro_sub_tot+$fab_proce_sub_tot,2);
				?>
                </td>
                </tr>
                <?
				}
				?>
           </table>
           </fieldset>
           </div>
                </td>
            <td width="330" valign="top" align="left">
            <?
			$nameArray_imge =sql_select("SELECT image_location FROM common_photo_library where master_tble_id='$job_no'");
			?>
            <div id="div_size_color_matrix" style="float:left;">
            	<fieldset id="" >
 				<legend>Image </legend>
            	<table width="310">
                <tr>
                <?
				$img_counter = 0;
                foreach($nameArray_imge as $result_imge)
				{

					?>
					<td>
						<img src="../../<? echo $result_imge[csf('image_location')]; ?>" width="90" height="100" border="2" />
					</td>
					<?

					$img_counter++;
				}
				?>
                </tr>
           </table>
           </fieldset>
           </div>
          </td>
        </tr>
       </table>
      <br/>   									 <!--  Here will be the main portion  -->
    <strong>Grey Fabric Details</strong>
    <table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
    <tr>
    <td width="49%">
     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
       <tr>
            <td  width="120" align="left">Fabric Color</td>
            <td  width="120" align="left">Fabric</td>
            <td  width="120" align="left">Composition</td>
            <td  width="120" align="left">GSM</td>
            <td  width="120" align="left">Process Loss</td>
			<? foreach($nameArray_size  as $result_size){?>
            <td align="center"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
            <? } ?>
            <td   width="50">Total (Kg)</td>
       </tr>
       <?

		$costing_per="";
		$costing_per_qnty=0;
		$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no ='$job_no'");
		if($costing_per_id==1)
		{
		$costing_per="1 Dzn";
		$costing_per_qnty=12;

		}
		if($costing_per_id==2)
		{
		$costing_per="1 Pcs";
		$costing_per_qnty=1;

		}
		if($costing_per_id==3)
		{
		$costing_per="2 Dzn";
		$costing_per_qnty=24;

		}
		if($costing_per_id==4)
		{
		$costing_per="3 Dzn";
		$costing_per_qnty=36;

		}
		if($costing_per_id==5)
		{
		$costing_per="4 Dzn";
		$costing_per_qnty=48;

		}
		$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no='$job_no'");

		    $wo_pre_cost_fabric_cost_dtls_id=array();
	        $grand_total_fin_fab_qnty=0;
			$grand_total_grey_fab_qnty=0;
			$grand_totalcons_per_finish=0;
			$grand_totalcons_per_grey=0;

				/*echo "select d.fabric_color_id, a.id,a.body_part_id, a.composition, a.construction, a.gsm_weight,a.width_dia_type as width_dia_type,a.color_size_sensitive, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent , avg(b.requirment) as requirment ,min(c.id) as cid FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				a.body_part_id in(1,20) and
				d.booking_no =$txt_booking_no and
				d.status_active=1 and
				d.is_deleted=0
				group by a.id,a.body_part_id, a.composition, a.construction, a.gsm_weight,a.width_dia_type,a.color_size_sensitive,d.fabric_color_id order by cid ";*/
			$color_wise_wo_sql=sql_select("select d.fabric_color_id, a.id,a.body_part_id, a.composition, a.construction, a.gsm_weight,a.width_dia_type as width_dia_type,a.color_size_sensitive, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent , avg(b.requirment) as requirment ,min(c.id) as cid FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_number_id=d.gmts_color_id and
				b.gmts_sizes=d.gmts_size and
				b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				a.body_part_id in(1,20) and
				d.booking_no =$txt_booking_no and
				d.status_active=1 and
				d.is_deleted=0
				group by a.id,a.body_part_id, a.composition, a.construction, a.gsm_weight,a.width_dia_type,a.color_size_sensitive,d.fabric_color_id order by cid ");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {

			$wo_pre_cost_fabric_cost_dtls_id[$color_wise_wo_result[csf('id')]]=$color_wise_wo_result[csf('id')];
			$fabric_color_id="";
			if($color_wise_wo_result[csf('color_size_sensitive')]==3)
			{
			$fabric_color_id=return_field_value( "gmts_color_id", "wo_pre_cos_fab_co_color_dtls","pre_cost_fabric_cost_dtls_id='".$color_wise_wo_result[csf('id')]."' and contrast_color_id='".$color_wise_wo_result[csf('fabric_color_id')]."'");
			}
			else
			{
			$fabric_color_id=$color_wise_wo_result[csf('fabric_color_id')];
			}


			$sql_dia_array=array();
		  // $sql_dia=sql_select("Select dia_width,gmts_sizes from wo_pre_cos_fab_co_avg_con_dtls where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and pre_cost_fabric_cost_dtls_id='".$color_wise_wo_result[csf('id')]."' and color_number_id='".$fabric_color_id."'");
		   $sql_dia=sql_select("Select dia_width,gmts_size from wo_booking_dtls where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and pre_cost_fabric_cost_dtls_id='".$color_wise_wo_result[csf('id')]."' and fabric_color_id='".$fabric_color_id."' and booking_no =$txt_booking_no" );

		   foreach($sql_dia as $sql_dia_row)
		   {
			$sql_dia_array[$sql_dia_row[csf("gmts_size")]][$sql_dia_row[csf("dia_width")]]= $sql_dia_row[csf("dia_width")];
		   }
		?>
			<tr>
            <td  width="120" align="left">
			<?
			echo $fabric_typee[$color_wise_wo_result[csf('width_dia_type')]];
			?>
            </td>
            <td  width="120" align="left">&nbsp;

            </td>
            <td>&nbsp;

            </td>
            <td  width="120" align="left">&nbsp;

            </td>

            <td  width="120" align="left">&nbsp;

            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_grey_fab_qnty=0;

			foreach($nameArray_size  as $result_size)
		    {
			?>

            <td width='50' align='' >&nbsp;
            <?
			$dia=implode(",", $sql_dia_array[$result_size[csf('size_number_id')]]);
			echo $dia;
			?>
            </td>
            <?
			}
			?>

            <td align="right">&nbsp;

            </td>
            </tr>

            <tr>
            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
			//echo $color_library[$fabric_color_id];

			?>
            </td>
            <td  width="120" align="left">
			<?
			echo $color_wise_wo_result[csf('construction')];
			?>
            </td>
            <td>
            <?
			echo $color_wise_wo_result[csf('composition')];
			?>
            </td>
            <td  width="120" align="left">
			<?
			echo $color_wise_wo_result[csf('gsm_weight')];
			?>
            </td>

            <td  width="120" align="left">
			<?
			echo $color_wise_wo_result[csf('process_loss_percent')];
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_grey_fab_qnty=0;

			foreach($nameArray_size  as $result_size)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_number_id=d.gmts_color_id and
				b.gmts_sizes=d.gmts_size and
				b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.id='".$color_wise_wo_result[csf('id')]."' and
				c.size_number_id='".$result_size[csf('size_number_id')]."' and
				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and
				d.is_deleted=0
				");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>

            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],4);
			$total_grey_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <?
			}
			?>

            <td align="right"><? echo number_format($total_grey_fab_qnty,4); $grand_total_grey_fab_qnty+=$total_grey_fab_qnty;?></td>


            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_size  as $result_size)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_number_id=d.gmts_color_id and
				                                b.gmts_sizes=d.gmts_size and
												b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id in(1,20) and
												c.size_number_id='".$result_size[csf('size_number_id')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right' > <? echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],4);?></td>
            <?
			}
			?>

            <td align="right"><? echo number_format($grand_total_grey_fab_qnty,4);?></td>

            </tr>
    </table>
 </td>
 <td width="2%"></td>
 <td width="49%" valign="top">
 <?
 $wo_pre_cost_fabric_cost_dtls_id_main_fabric=implode(",", $wo_pre_cost_fabric_cost_dtls_id);
 if($wo_pre_cost_fabric_cost_dtls_id_main_fabric=="")
 {
	 $wo_pre_cost_fabric_cost_dtls_id_main_fabric=0;
 }
     $nameArray_fabric_description= sql_select("select a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type, b.dia_width, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent , avg(b.requirment) as requirment,min(c.id) as cid FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
WHERE a.job_no=b.job_no and
a.id=b.pre_cost_fabric_cost_dtls_id and
c.job_no_mst=a.job_no and
c.id=b.color_size_table_id and
b.po_break_down_id=d.po_break_down_id and
b.color_number_id=d.gmts_color_id and
b.gmts_sizes=d.gmts_size and
b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
d.booking_no =$txt_booking_no and
a.body_part_id not in(1,20) and
d.status_active=1 and
d.is_deleted=0
group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width order by a.body_part_id,b.dia_width,cid");
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <tr align="center">
     <td width='50'></td>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>". $body_part[$result_fabric_description[csf('body_part_id')]].",".$result_fabric_description[csf('construction')]."</td>";
		}
		?>



       </tr>


        <tr align="center">
        <td width='50'></td>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='2' >&nbsp</td>";
			else         		               echo "<td colspan='2' >".$result_fabric_description[csf('composition')].",". $color_type[$result_fabric_description[csf('color_type_id')]].",". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>

       <tr align="center">
       <td width='50'></td>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		              echo "<td colspan='2' align='center'>".$fabric_typee[$result_fabric_description[csf('width_dia_type')]].",". $result_fabric_description[csf('dia_width')].",".number_format($result_fabric_description[csf('requirment')],4)."</td>";
		}
		?>

       </tr>
       <tr>
       <th width='50'>Gmt Color</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			  echo "<th width='50'>Color</th><th width='50' >Qty</th>";
		}
		?>

       </tr>
       <?

		  $gmt_color_library=array();
		  $gmt_color_data=sql_select("select gmts_color_id,contrast_color_id
		  FROM
		  wo_pre_cos_fab_co_color_dtls
		  WHERE
		  job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]].=$color_library[$gmt_color_row[csf("gmts_color_id")]]."," ;
		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_grey_fab_qnty=0;
			$grand_totalcons_per_finish=0;
			$grand_totalcons_per_grey=0;
			$color_wise_wo_sql=sql_select("select fabric_color_id
										  FROM
										  wo_booking_dtls
										  WHERE
										  booking_no =$txt_booking_no and
										  pre_cost_fabric_cost_dtls_id not in($wo_pre_cost_fabric_cost_dtls_id_main_fabric) and
										  status_active=1 and
                                          is_deleted=0
										  group by fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
            <td width='50' align='right'>
			<?
			//if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
			//{
				if($gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]!="")
				{
					echo rtrim($gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]],",");
				}
				else
				{
					echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
				}
			//}
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_grey_fab_qnty=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_number_id=d.gmts_color_id and
				b.gmts_sizes=d.gmts_size and
				b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and
				d.is_deleted=0
				");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>

			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
			{
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('grey_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],4);
			$total_grey_fab_qnty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
			}
			?>
            </td>
            <?
			}
			?>
            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">

        <td width='50' align='right'></td>
        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_number_id=d.gmts_color_id and
				                                b.gmts_sizes=d.gmts_size and
												b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'></td><td width='50' align='right' > <? echo number_format($color_wise_wo_result_qnty[csf('grey_fab_qnty')],4);?></td>
            <?
			}
			?>



            </tr>
    </table>
 </td>
 </tr>
 </table>
    <br/>   									 <!--  Here will be the main portion  -->
    <strong>Finish Fabric Details</strong>
    <table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
    <tr>
    <td width="49%">
     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
       <tr>
            <td  width="120" align="left">Fabric Color</td>
            <td  width="120" align="left">Fabric</td>
            <td  width="120" align="left">Composition</td>
            <td  width="120" align="left">GSM</td>
            <td  width="120" align="left">Process Loss</td>
			<?
            foreach($nameArray_size  as $result_size)
            {?>
            <td align="center"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
            <? } ?>
            <td   width="50">Total (Kg)</td>
       </tr>
       <?
	   $wo_pre_cost_fabric_cost_dtls_id=array();
	        $grand_total_fin_fab_qnty=0;
			$grand_total_grey_fab_qnty=0;
			$grand_totalcons_per_finish=0;
			$grand_totalcons_per_grey=0;
			$color_wise_wo_sql=sql_select("select d.fabric_color_id, a.id,a.body_part_id, a.composition, a.construction, a.gsm_weight,a.width_dia_type as width_dia_type,a.color_size_sensitive,  avg(b.cons) as cons, avg(b.process_loss_percent) as process_loss_percent , avg(b.requirment) as requirment,min(c.id) as cid  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_number_id=d.gmts_color_id and
				b.gmts_sizes=d.gmts_size and
				b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				a.body_part_id in(1,20) and
				d.booking_no =$txt_booking_no and
				d.status_active=1 and
				d.is_deleted=0
				group by a.id,a.body_part_id, a.composition, a.construction, a.gsm_weight,a.width_dia_type,a.color_size_sensitive,d.fabric_color_id order by cid");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			$wo_pre_cost_fabric_cost_dtls_id[$color_wise_wo_result[csf('id')]]=$color_wise_wo_result[csf('id')];
			$fabric_color_id="";
			if($color_wise_wo_result[csf('color_size_sensitive')]==3)
			{
			$fabric_color_id=return_field_value( "gmts_color_id", "wo_pre_cos_fab_co_color_dtls","pre_cost_fabric_cost_dtls_id='".$color_wise_wo_result[csf('id')]."' and contrast_color_id='".$color_wise_wo_result[csf('fabric_color_id')]."'");
			}
			else
			{
			$fabric_color_id=$color_wise_wo_result[csf('fabric_color_id')];
			}
			//echo "Select dia_width,gmts_sizes from wo_pre_cos_fab_co_avg_con_dtls where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and pre_cost_fabric_cost_dtls_id='".$color_wise_wo_result[csf('id')]."' and color_number_id='".$fabric_color_id."'";
			$sql_dia_array=array();
		  // $sql_dia=sql_select("Select dia_width,gmts_sizes from wo_pre_cos_fab_co_avg_con_dtls where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and pre_cost_fabric_cost_dtls_id='".$color_wise_wo_result[csf('id')]."' and color_number_id='".$fabric_color_id."'");
		  	$sql_dia=sql_select("Select dia_width,gmts_size from wo_booking_dtls where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and pre_cost_fabric_cost_dtls_id='".$color_wise_wo_result[csf('id')]."' and fabric_color_id='".$fabric_color_id."' and booking_no =$txt_booking_no" );

		   foreach($sql_dia as $sql_dia_row)
		   {
			$sql_dia_array[$sql_dia_row[csf("gmts_size")]][$sql_dia_row[csf("dia_width")]]= $sql_dia_row[csf("dia_width")];
		   }
		?>
			<tr>
            <td  width="120" align="left">
			<?
			echo $fabric_typee[$color_wise_wo_result[csf('width_dia_type')]];
			?>
            </td>
            <td  width="120" align="left">&nbsp;

            </td>
            <td>&nbsp;

            </td>
            <td  width="120" align="left">&nbsp;

            </td>

            <td  width="120" align="left">&nbsp;

            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_grey_fab_qnty=0;

			foreach($nameArray_size  as $result_size)
		    {
			?>

            <td width='50' align='' >&nbsp;
			<?
			$dia=implode(",", $sql_dia_array[$result_size[csf('size_number_id')]]);
			echo $dia;
			?>
            </td>
            <?
			}
			?>

            <td align="right">&nbsp;

            </td>


            </tr>



            <tr>
            <td  width="120" align="left">
			<?
			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
			//echo $color_library[$fabric_color_id];
			?>
            </td>
            <td  width="120" align="left">
			<?
			echo $color_wise_wo_result[csf('construction')];
			?>
            </td>
            <td>
            <?
			echo $color_wise_wo_result[csf('composition')];
			?>
            </td>
            <td  width="120" align="left">
			<?
			echo $color_wise_wo_result[csf('gsm_weight')];
			?>
            </td>

            <td  width="120" align="left">
			<?
			echo $color_wise_wo_result[csf('process_loss_percent')];
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_grey_fab_qnty=0;

			foreach($nameArray_size  as $result_size)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_number_id=d.gmts_color_id and
				b.gmts_sizes=d.gmts_size and
				b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.id='".$color_wise_wo_result[csf('id')]."' and
				c.size_number_id='".$result_size[csf('size_number_id')]."' and
				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and
				d.is_deleted=0
				");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>

            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],4);
			$total_fin_fab_qnty+=$color_wise_wo_result_qnty[csf('fin_fab_qnty')];
			}
			?>
            </td>
            <?
			}
			?>

            <td align="right"><? echo number_format($total_fin_fab_qnty,2); $grand_total_fin_fab_qnty+=$total_fin_fab_qnty;?></td>


            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Total</strong></td>
        <?
			foreach($nameArray_size  as $result_size)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(b.cons) as avg_cons FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_number_id=d.gmts_color_id and
				                                b.gmts_sizes=d.gmts_size and
												b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id in(1,20) and
												c.size_number_id='".$result_size[csf('size_number_id')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right' > <? echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],4);?></td>
            <?
			}
			?>
            <td align="right"><? echo number_format($grand_total_fin_fab_qnty,4);?></td>

            </tr>
            <tr style=" font-weight:bold">
        <!--<td  width="120" align="left">&nbsp;</td>-->
        <th  width="120" align="left">&nbsp;</th>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left">&nbsp;</td>
        <td  width="120" align="left"><strong>Consumption</strong></td>
        <?
			foreach($nameArray_size  as $result_size)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(b.cons) as avg_cons FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_number_id=d.gmts_color_id and
				                                b.gmts_sizes=d.gmts_size and
												b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id in(1,20) and
												c.size_number_id='".$result_size[csf('size_number_id')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right' > <? echo number_format($color_wise_wo_result_qnty[csf('avg_cons')],4);?></td>
            <?
			}
			?>
            <td align="right"><? //echo number_format($grand_total_fin_fab_qnty,2);?></td>

            </tr>


    </table>
    </td>
    <td width="2%"></td>
    <td width="49%" valign="top">
 <?
// print_r($wo_pre_cost_fabric_cost_dtls_id);
 $wo_pre_cost_fabric_cost_dtls_id_main_fabric=implode(",", $wo_pre_cost_fabric_cost_dtls_id);
 if($wo_pre_cost_fabric_cost_dtls_id_main_fabric=="")
 {
	 $wo_pre_cost_fabric_cost_dtls_id_main_fabric=0;
 }

 $nameArray_fabric_description= sql_select("select a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,min(a.width_dia_type) as width_dia_type, b.dia_width, avg(b.cons) as cons  , avg(b.process_loss_percent) as process_loss_percent , avg(b.requirment) as requirment,min(c.id) as cid FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
WHERE a.job_no=b.job_no and
a.id=b.pre_cost_fabric_cost_dtls_id and
c.job_no_mst=a.job_no and
c.id=b.color_size_table_id and
b.po_break_down_id=d.po_break_down_id and
b.color_number_id=d.gmts_color_id and
b.gmts_sizes=d.gmts_size and
b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
d.booking_no =$txt_booking_no and
a.body_part_id not in(1,20) and
d.status_active=1 and
d.is_deleted=0
group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,b.dia_width order by a.body_part_id,b.dia_width,cid");
	 ?>

     <table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
     <tr align="center">
     <td width='50'></td>
        <?
		foreach($nameArray_fabric_description  as $result_fabric_description)
		{
			if( $result_fabric_description[csf('body_part_id')] == "")  echo "<td  colspan='2'>&nbsp</td>";
			else         		               echo "<td  colspan='2'>". $body_part[$result_fabric_description[csf('body_part_id')]].",".$result_fabric_description[csf('construction')]."</td>";
		}
		?>



       </tr>

       <tr align="center">
       <td width='50'></td>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('composition')] == "")   echo "<td colspan='2' >&nbsp</td>";
			else         		               echo "<td colspan='2' >".$result_fabric_description[csf('composition')].",". $color_type[$result_fabric_description[csf('color_type_id')]].",". $result_fabric_description[csf('gsm_weight')]."</td>";
		}
		?>

       </tr>

       <tr align="center">
       <td width='50'></td>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			if( $result_fabric_description[csf('dia_width')] == "")   echo "<td colspan='2'>&nbsp</td>";
			else         		              echo "<td colspan='2' align='center'>".$fabric_typee[$result_fabric_description[csf('width_dia_type')]].",". $result_fabric_description[csf('dia_width')].",".number_format($result_fabric_description[csf('cons')],4)."</td>";
		}
		?>

       </tr>
       <tr>
       <th width='50'>Gmt Color</th>
        <?
		foreach($nameArray_fabric_description as $result_fabric_description)
		{
			  echo "<th width='50'>Color</th><th width='50' >Qty</th>";
		}
		?>

       </tr>
       <?

		  $gmt_color_library=array();
		  $gmt_color_data=sql_select("select gmts_color_id,contrast_color_id
		  FROM
		  wo_pre_cos_fab_co_color_dtls
		  WHERE
		  job_no ='$job_no'");
		  foreach( $gmt_color_data as $gmt_color_row)
		  {
			$gmt_color_library[$gmt_color_row[csf("contrast_color_id")]].=$color_library[$gmt_color_row[csf("gmts_color_id")]]."," ;
		  }

	        $grand_total_fin_fab_qnty=0;
			$grand_total_grey_fab_qnty=0;
			$grand_totalcons_per_finish=0;
			$grand_totalcons_per_grey=0;
			$color_wise_wo_sql=sql_select("select fabric_color_id
										  FROM
										  wo_booking_dtls
										  WHERE
										  booking_no =$txt_booking_no and
										  pre_cost_fabric_cost_dtls_id not in($wo_pre_cost_fabric_cost_dtls_id_main_fabric) and
										  status_active=1 and
                                          is_deleted=0
										  group by fabric_color_id");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
		?>
			<tr>
            <td width='50' align='right'>
			<?
			//if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
			//{
				if($gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]]!="")
				{

				echo rtrim($gmt_color_library[$color_wise_wo_result[csf('fabric_color_id')]],",");
				}
				else
				{
					echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
				}
			//}
			?>
            </td>
            <?
			$total_fin_fab_qnty=0;
			$total_grey_fab_qnty=0;

			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
				WHERE a.job_no=b.job_no and
				a.id=b.pre_cost_fabric_cost_dtls_id and
				c.job_no_mst=a.job_no and
				c.id=b.color_size_table_id and
				b.po_break_down_id=d.po_break_down_id and
				b.color_number_id=d.gmts_color_id and
				b.gmts_sizes=d.gmts_size and
				b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
				d.booking_no =$txt_booking_no and
				a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
				a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
				a.construction='".$result_fabric_description[csf('construction')]."' and
				a.composition='".$result_fabric_description[csf('composition')]."' and
				a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
				b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
				d.fabric_color_id=".$color_wise_wo_result[csf('fabric_color_id')]." and
				d.status_active=1 and
				d.is_deleted=0
				");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>

			<td width='50' align='right'>
			<?
			if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
			{

			echo $color_library[$color_wise_wo_result[csf('fabric_color_id')]];
			}
			?>
            </td>
            <td width='50' align='right' >
			<?
			if($color_wise_wo_result_qnty[csf('fin_fab_qnty')]!="")
			{
			echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],4);
			//$total_grey_fab_qnty+=$color_wise_wo_result_qnty[csf('fin_fab_qnty')];
			}
			?>
            </td>
            <?
			}
			?>




            </tr>
         <?
		}
		?>
        <tr style=" font-weight:bold">
        <td width='50' align='right'></td>

        <?
			foreach($nameArray_fabric_description as $result_fabric_description)
		    {
				$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
												WHERE a.job_no=b.job_no and
												a.id=b.pre_cost_fabric_cost_dtls_id and
												c.job_no_mst=a.job_no and
												c.id=b.color_size_table_id and
												b.po_break_down_id=d.po_break_down_id and
												b.color_number_id=d.gmts_color_id and
				                                b.gmts_sizes=d.gmts_size and
												b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
												d.booking_no =$txt_booking_no and
												a.body_part_id='".$result_fabric_description[csf('body_part_id')]."' and
												a.color_type_id='".$result_fabric_description[csf('color_type_id')]."' and
												a.construction='".$result_fabric_description[csf('construction')]."' and
												a.composition='".$result_fabric_description[csf('composition')]."' and
												a.gsm_weight='".$result_fabric_description[csf('gsm_weight')]."' and
												b.dia_width='".$result_fabric_description[csf('dia_width')]."' and
												d.status_active=1 and
												d.is_deleted=0
												");
				list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty
			?>
			<td width='50' align='right'></td><td width='50' align='right' > <? echo number_format($color_wise_wo_result_qnty[csf('fin_fab_qnty')],4);?></td>
            <?
			}
			?>



            </tr>
    </table>
 </td>
    </tr>
    </table>

   <br/>
   <table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
        <tr>
        <?

		$nameArray_item_size=sql_select( "select b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by c.id");

		if(count($nameArray_item_size)>0)
		{
        ?>
        <td width="49%">
        <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
        <tr>
        <td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Collar -  Colour Size Brakedown in Pcs</b></td>
        </tr>
        <tr>
        <td width="70">Size</td>

        <?

		/*$nameArray_item_size=sql_select( "select b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by c.size_number_id,b.item_size order by c.size_number_id");*/
		foreach($nameArray_item_size  as $result_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
		<?
        }
        ?>
        <td rowspan="2" align="center"><strong>Total</strong></td>
        <td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
        </tr>
        <tr>
        <td>Collar Size</td>

        <?
        foreach($nameArray_item_size  as $result_item_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
		<?
        }
        ?>
         <?

			$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by c.color_number_id,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id,c.id
");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			$color_total_collar=0;
			$color_total_collar_order_qnty=0;
			$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
			$constrast_color_arr=array();
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
				for($i=0;$i<count($constrast_color);$i++)
				{
					$constrast_color2=explode('_',$constrast_color[$i]);
					$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
				}
			}
		?>
			<tr>
            <td>
            <?
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
				$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
			}
			else
			{
				echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
				$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
			}
			?>

            </td>
            <?
            foreach($nameArray_item_size  as $result_size)
			{
				?>
				<td align="center" style="border:1px solid black">
				<?
				//$color_wise_wo_sql_qnty=sql_select("select c.color_number_id,sum(c.order_quantity) as order_quantity, sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and c.color_number_id='".$color_wise_wo_result['color_number_id']."' and c.size_number_id='".$result_size['size_number_id']."'");
				$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active=1 and is_deleted =0");

				list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
				$colar_excess_per=def_number_format(($plan_cut_qnty[csf('plan_cut_qnty')]*$colar_excess_percent)/100,6,0);
				echo number_format($plan_cut_qnty[csf('plan_cut_qnty')]+$colar_excess_per,0);
				$color_total_collar+=$plan_cut_qnty[csf('plan_cut_qnty')]+$colar_excess_per;
				$color_total_collar_order_qnty+=$plan_cut_qnty[csf('order_quantity')];
				$grand_total_collar+=$plan_cut_qnty[csf('plan_cut_qnty')]+$colar_excess_per;
				$grand_total_collar_order_qnty+=$plan_cut_qnty[csf('order_quantity')];
				?>
                </td>
				<?
			}
			?>

            <td align="center"><? echo number_format($color_total_collar,0); ?></td>
            <td align="center"><? echo number_format((($color_total_collar-$color_total_collar_order_qnty)/$color_total_collar_order_qnty)*100,2); ?></td>
            </tr>
            <?
		    }
			?>
            <tr>
                <td>Size Total</td>

                <?
                foreach($nameArray_item_size  as $result_size)
                {
                ?>
                <td style="border:1px solid black;  text-align:center"><? $colar_excess_pers=($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]+$colar_excess_pers,0); ?></td>
                <?
                }
                ?>
                <td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar,0); ?></td>
                <td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_collar-$grand_total_collar_order_qnty)/$grand_total_collar_order_qnty)*100,2); ?></td>
            </tr>
        </table>
        </td>
        <td width="2%">
        </td>
        <?
        }
		?>

        <?
		$nameArray_item_size=sql_select( "select  b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by c.id");

		if(count($nameArray_item_size)>0)
		{
        ?>
        <td width="49%">
        <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
        <tr>
        <td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Cuff -  Colour Size Brakedown in Pcs</b></td>
        </tr>
        <tr>
        <td width="70">Size</td>

        <?
		foreach($nameArray_item_size  as $result_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
		<?
        }
        ?>
        <td rowspan="2" align="center"><strong>Total</strong></td>
        <td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
        </tr>
        <tr>
        <td>Cuff Size</td>

        <?
        foreach($nameArray_item_size  as $result_item_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
		<?
        }
        ?>
         <?

			$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and  d.status_active=1 and d.is_deleted=0 group by c.color_number_id ,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id ,c.id
");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			$color_total_cuff=0;
			$color_total_cuff_order_qnty=0;
			$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
			$constrast_color_arr=array();
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
				for($i=0;$i<count($constrast_color);$i++)
				{
					$constrast_color2=explode('_',$constrast_color[$i]);
					$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
				}
			}
		?>
			<tr>
            <td>
            <?
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				echo strtoupper ($constrast_color_arr[$color_wise_wo_result['color_number_id']]) ;
				$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
			}
			else
			{
				echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
				$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
			}
			?>

            </td>
            <?
            foreach($nameArray_item_size  as $result_size)
			{
				?>
				<td align="center" style="border:1px solid black">

				<?
				/*$color_wise_wo_sql_qnty=sql_select("select c.color_number_id,sum(c.order_quantity) as order_quantity, sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=3 and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and c.color_number_id='".$color_wise_wo_result['color_number_id']."' and c.size_number_id='".$result_size['size_number_id']."'");*/
				$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active=1 and is_deleted =0");

				list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
				$cuff_excess_per=def_number_format((($plan_cut_qnty[csf('plan_cut_qnty')]*2)*$cuff_excess_percent)/100,6,"");
				echo number_format($plan_cut_qnty[csf('plan_cut_qnty')]*2+$cuff_excess_per,0);
				$color_total_cuff+=$plan_cut_qnty[csf('plan_cut_qnty')]*2+$cuff_excess_per;
				$color_total_cuff_order_qnty+=$plan_cut_qnty[csf('order_quantity')]*2;
				$grand_total_cuff+=$plan_cut_qnty[csf('plan_cut_qnty')]*2+$cuff_excess_per;
				$grand_total_cuff_order_qnty+=$plan_cut_qnty[csf('order_quantity')]*2;
				/*echo $color_size_qnty_array[$result_size[size_number_id]][$color_wise_wo_result[color_number_id]]*2;
				$color_total_cuff+=$color_size_qnty_array[$result_size[size_number_id]][$color_wise_wo_result[color_number_id]]*2;
				$color_total_cuff_order_qnty+=$color_size_order_qnty_array[$result_size[size_number_id]][$color_wise_wo_result[color_number_id]]*2;
				$grand_total_cuff+=$color_size_qnty_array[$result_size[size_number_id]][$color_wise_wo_result[color_number_id]]*2;
				$grand_total_cuff_order_qnty+=$color_size_order_qnty_array[$result_size[size_number_id]][$color_wise_wo_result[color_number_id]]*2;*/
				?>

                </td>
				<?
			}
			?>

            <td align="center"><? echo number_format($color_total_cuff,0); ?></td>
            <td align="center"><? echo number_format((($color_total_cuff-$color_total_cuff_order_qnty)/$color_total_cuff_order_qnty)*100,2); ?></td>
            </tr>
            <?
		    }
			?>
            <tr>
                <td>Size Total</td>

                <?
                foreach($nameArray_item_size  as $result_size)
                {
                   /* $nameArray_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =$result_size[size_number_id]  and status_active=1 and is_deleted =0 order by id");
                foreach($nameArray_size_qnty as $result_size_qnty)
                {*/
                ?>
                <td style="border:1px solid black;  text-align:center"><? $cuff_excess_pers=(($size_tatal[$result_size[csf('size_number_id')]]*2)*$cuff_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]*2+$cuff_excess_pers,0); ?></td>
                <?
                //}
                }
                ?>
                <td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_cuff,0); ?></td>
                <td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_cuff-$grand_total_cuff_order_qnty)/$grand_total_cuff_order_qnty)*100,2); ?></td>
            </tr>
        </table>
        </td>
        <?
				}
		?>
        </tr>
        </table>
        <br/>
        <?
		$yarn_count_arr=return_library_array( "select id,yarn_count from lib_yarn_count",'id','yarn_count');
		$yarn_sql_array=sql_select("SELECT min(id) as id ,count_id, copm_one_id, percent_one,copm_two_id, percent_two, type_id, sum(cons_qnty) as yarn_required, AVG(rate) as rate from wo_pre_cost_fab_yarn_cost_dtls where job_no='$job_no' and  status_active=1 and is_deleted=0 group by count_id,copm_one_id,percent_one, copm_two_id,percent_two,type_id order by id");
		?>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
            <tr>
                <td width="49%" style="border:solid; border-color:#000; border-width:thin" valign="top">
                    <?php echo get_spacial_instruction($txt_booking_no); ?>
                </td>
                <td width="2%">
                </td>
                <td width="49%" valign="top" align="center">
                <?
				$yarn_sql_array=sql_select("SELECT min(a.id) as id, a.item_id, sum(a.qnty) as qnty ,min(b.supplier_id) as supplier_id,min(b.lot) as lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0 group by a.item_id order by a.id");
				if(count($yarn_sql_array)>0)
				{
				?>
                   <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                    <tr align="center">
                    <td colspan="7"><b>Allocated Yarn</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Yarn Description</td>
                    <td>Brand</td>
                    <td>Lot</td>


                    <td>Allocated Qty (Kg)</td>
                    </tr>
                    <?
					$total_allo=0;
					$item=return_library_array( "select id, product_name_details from   product_details_master",'id','product_name_details');
					$supplier=return_library_array( "select id, short_name from   lib_supplier",'id','short_name');
					//$yarn_sql_array=sql_select("SELECT a.item_id, a.qnty,b.supplier_id,b.lot from inv_material_allocation_dtls a,product_details_master b where a.item_id=b.id and a.booking_no=$txt_booking_no and  a.status_active=1 and a.is_deleted=0");
					$i=0;
					$total_yarn=0;
					foreach($yarn_sql_array  as $row)
                    {

						$i++;
					?>
                    <tr align="center">
                    <td><? echo $i; ?></td>
                    <td>
					<?

					echo $item[$row[csf('item_id')]];
					?>
                    </td>
                    <td>
                    <?

					echo $supplier[$row[csf('supplier_id')]];
					?>
                    </td>
                    <td>
					<?

					echo $row[csf('lot')];
					?>
                    </td>
                    <td align="right"><? echo number_format($row[csf('qnty')],4); $total_allo+= $row[csf('qnty')];?></td>
                    </tr>
                    <?
					}
					?>
                    <tr align="center">
                    <td>Total</td>
                    <td></td>


                    <td></td>
                    <td></td>
                    <td align="right"><? echo number_format($total_allo,4); ?></td>
                    </tr>
                    </table>
                    <?
				}
				else
				{
					$is_yarn_allocated=return_field_value("allocation", "variable_settings_inventory", "company_name=$cbo_company_name and variable_list=18 and item_category_id=1");
					if($is_yarn_allocated==1)
					{
					?>
					<font style=" font-size:30px"><b> Draft</b></font>
                    <?
					}
					else
					{
						echo "";
					}
				}
					?>
                </td>
            </tr>
        </table>
        <br/>

        <table  width="100%"  border="0" cellpadding="0" cellspacing="0">
            <tr>


                <td width="49%" valign="top">
                <?
				if($cbo_fabric_source==1)
				{
                ?>
                   <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
                   <tr align="center">
                    <td colspan="10"><b>Comments</b></td>

                    </tr>
                    <tr align="center">
                    <td>Sl</td>
                    <td>Po NO</td>
                    <td>Ship Date</td>
                    <td>Pre-Cost Qty</td>
                    <td>Mn.Book Qty</td>
                    <td>Sht.Book Qty</td>
                    <td>Smp.Book Qty</td>
                    <td>Tot.Book Qty</td>
                    <td>Balance</td>
                    <td>Comments</td>
                    </tr>
                    <?
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);
	if ($cbo_fabric_natu!=0) $cbo_fabric_natu="and a.fab_nature_id='$cbo_fabric_natu'";
	if ($cbo_fabric_source!=0) $cbo_fabric_source_cond="and a.fabric_source='$cbo_fabric_source'";
	$paln_cut_qnty_array=return_library_array( "select min(id) as id,sum(plan_cut_qnty) as plan_cut_qnty from wo_po_color_size_breakdown  where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by color_number_id,size_number_id,item_number_id", "id", "plan_cut_qnty");

	$item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no =$txt_job_no", "gmts_item_id", "set_item_ratio");
	$nameArray=sql_select("
	select
	a.id,
	a.item_number_id,
	a.costing_per,
	b.po_break_down_id,
	b.color_size_table_id,
	b.requirment,
	c.po_number
FROM
	wo_pre_cost_fabric_cost_dtls a,
	wo_pre_cos_fab_co_avg_con_dtls b,
	wo_po_break_down c
WHERE
	a.job_no=b.job_no and
	a.job_no=c.job_no_mst and
    a.id=b.pre_cost_fabric_cost_dtls_id and
	b.po_break_down_id=c.id and
	b.po_break_down_id in (".str_replace("'","",$txt_order_no_id).")  $cbo_fabric_natu $cbo_fabric_source_cond and a.status_active=1 and a.is_deleted=0
	order by a.id");
	$count=0;
	$tot_grey_req_as_pre_cost_arr=array();
	foreach ($nameArray as $result)
	{
		if (count($nameArray)>0 )
		{
            if($result[csf("costing_per")]==1)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(12*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==2)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(1*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==3)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(24*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==4)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(36*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			if($result[csf("costing_per")]==5)
			{
				$tot_grey_req_as_pre_cost=def_number_format((($paln_cut_qnty_array[$result[csf("color_size_table_id")]]/(48*$item_ratio_array[$result[csf("item_number_id")]]))*$result[csf("requirment")]),5,"");
			}
			$tot_grey_req_as_pre_cost_arr[$result[csf("po_number")]]+=$tot_grey_req_as_pre_cost;
        }
    }
	                $total_pre_cost=0;
					$total_booking_qnty_main=0;
					$total_booking_qnty_short=0;
					$total_booking_qnty_sample=0;
					$total_tot_bok_qty=0;
					$tot_balance=0;
					/*$booking_qnty=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and booking_type in(1,4)  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by a.po_break_down_id", "po_break_down_id", "grey_fab_qnty");*/
					//$booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and booking_type =1 and is_short=2 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by a.po_break_down_id", "po_break_down_id", "grey_fab_qnty");
					$booking_qnty_main=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

					$booking_qnty_short=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and c.fabric_source=$cbo_fabric_source and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");
					$booking_qnty_sample=return_library_array( "select max(a.po_break_down_id) as po_break_down_id ,sum(a.grey_fab_qnty) as grey_fab_qnty  from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4 and c.fabric_source=$cbo_fabric_source and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by b.po_number order by po_break_down_id", "po_break_down_id", "grey_fab_qnty");

					$sql_data=sql_select( "select max(a.id) as id,  a.po_number,max(a.pub_shipment_date) as pub_shipment_date,sum(a.plan_cut) as plan_cut  from wo_po_break_down a,wo_pre_cost_sum_dtls b,wo_pre_cost_mst c where a.job_no_mst=b.job_no and a.job_no_mst=c.job_no and a.id in(".str_replace("'","",$txt_order_no_id).") group by a.po_number order by a.id");
					foreach($sql_data  as $row)
                    {
					$col++;
					?>
                    <tr align="center">
                    <td><? echo $col; ?></td>
                    <td><? echo $row[csf("po_number")]; ?></td>
                     <td><? echo change_date_format($row[csf("pub_shipment_date")],"dd-mm-yyyy",'-'); ?></td>
                    <td align="right"><? echo number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]],2); $total_pre_cost+=$tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]; ?></td>
                    <td align="right"><? echo number_format($booking_qnty_main[$row[csf("id")]],2); $total_booking_qnty_main+=$booking_qnty_main[$row[csf("id")]];?></td>
                    <td align="right"><? echo number_format($booking_qnty_short[$row[csf("id")]],2); $total_booking_qnty_short+=$booking_qnty_short[$row[csf("id")]];?></td>
                    <td align="right"><? echo number_format($booking_qnty_sample[$row[csf("id")]],2); $total_booking_qnty_sample+=$booking_qnty_sample[$row[csf("id")]];?></td>
                    <td align="right"><? $tot_bok_qty=$booking_qnty_main[$row[csf("id")]]+$booking_qnty_short[$row[csf("id")]]+$booking_qnty_sample[$row[csf("id")]]; echo number_format($tot_bok_qty,2); $total_tot_bok_qty+=$tot_bok_qty;?></td>
                    <td align="right">
					<? $balance= def_number_format($tot_grey_req_as_pre_cost_arr[$row[csf("po_number")]]-$tot_bok_qty,2,""); echo number_format($balance,2); $tot_balance+= $balance?>
                    </td>
                    <td>
					<?
					if( $balance>0)
					{
						echo "Less Booking";
					}
					else if ($balance<0)
					{
						echo "Over Booking";
					}
					else
					{
						echo "";
					}
					?>
                    </td>
                    </tr>
                    <?
					}
					?>
                    <tfoot>

                    <tr>
                    <td colspan="3">Total:</td>

                    <td align="right"><? echo number_format($total_pre_cost,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_main,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_short,2); ?></td>
                    <td align="right"><? echo number_format($total_booking_qnty_sample,2); ?></td>
                     <td align="right"><? echo number_format($total_tot_bok_qty,2); ?></td>
                    <td align="right"><? echo number_format($tot_balance,2); ?></td>
                    <td></td>
                    </tr>
                    </tfoot>
                    </table>
                    <?
				}
					?>
                </td>

            </tr>
        </table>

         <br/>
        <?
		//echo "select responsible_dept,	responsible_person,	reason from wo_booking_dtls where booking_no =$txt_booking_no";
		//"select id,department_name from  lib_department where status_active=1 and is_deleted=0 order by  department_name"
		$department_name_library=return_library_array( "select id,department_name from  lib_department where status_active=1 and is_deleted=0 order by  department_name", "id", "department_name"  );

		$sql_responsible= sql_select("select responsible_dept,	responsible_person,	reason from wo_booking_dtls where booking_no =$txt_booking_no");
		if(count($sql_responsible)>0)
		{
		?>
         <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
         <tr>
         <td>
          #
         </td>
          <td>
         Responsible Dept.
         </td>
         <td>
         Responsible person
         </td>
         <td>
         Reason
         </td>
         </tr>
         <?
		 $ir=1;
		foreach($sql_responsible as $sql_responsible_row)
		{
			?>
             <tr>
             <td>
             <?  echo $ir; ?>
             </td>
              <td>
             <?
			 $responsible_dept_st="";
			 $responsible_dept_arr=explode( ",",$sql_responsible_row[csf('responsible_dept')]);
			 foreach($responsible_dept_arr as $key => $value)
			 {
				 $responsible_dept_st.= $department_name_library[$value].", ";
			 }
			 echo rtrim($responsible_dept_st,", ");
			 ?>
             </td>
             <td>
            <?  echo $sql_responsible_row[csf('responsible_person')]; ?>
             </td>
             <td>
              <?  echo $sql_responsible_row[csf('reason')]; ?>
             </td>
             </tr>
            <?
			$ir++;

		}
		 ?>
         </table>
         <?
		}
		 
		 $sql = sql_select("select designation,name from variable_settings_signature where report_id=1 and company_id=$cbo_company_name order by sequence_no" );
	     $count=count($sql);

	$width=1330;
	$td_width=floor($width/$count);

	$standard_width=$count*150;

	if($standard_width>$width) $td_width=150;

	$no_coloumn_per_tr=floor($width/$td_width);
	$col=$count-2;
	$i=1;
	echo '<table width="'.$width.'"><tr><td width="'.$td_width.'" align="center" valign="bottom">'.$user_arr[$inserted_by].'</td><td height="70" colspan="'.$col.'"></td><td width="'.$td_width.'" align="center" valign="bottom">'.$user_arr[$nameArray_approved_date_row[csf('approved_by')]].'</td></tr><tr>';
	foreach($sql as $row)
	{
		echo '<td width="'.$td_width.'" align="center" valign="top"><strong style="text-decoration:overline">'.$row[csf("designation")]."</strong><br>".$row[csf("name")].'</td>';

		if($i%$no_coloumn_per_tr==0) echo '</tr><tr><td height="70" colspan="'.$no_coloumn_per_tr.'"></td><tr>';
		$i++;
	}
	echo '</tr></table>';
		 ?>
       </div>
	<?
	exit();
}

if ($action=="save_update_delete")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$update_type = str_replace("'", "", $txt_update_type)*1;
	if ($operation==0)
	{
		$con = connect();
		if($db_type==0){
			mysql_query("BEGIN");
		}
		
		$new_booking_no=explode("*",return_mrr_number( str_replace("'","",$cbo_company_name), '', 'FB', date("Y",time()), 5, "select booking_no_prefix, booking_no_prefix_num from wo_booking_mst where company_id=$cbo_company_name and booking_type=1 and to_char(insert_date,'YYYY')=".date('Y',time())." order by id desc ", "booking_no_prefix", "booking_no_prefix_num"));

		$id=return_next_id( "id", "wo_booking_mst", 1);
		$field_array="id, booking_type, is_short, booking_no_prefix, booking_no_prefix_num, booking_no, company_id, buyer_id, job_no, po_break_down_id, item_category, fabric_source, currency_id, exchange_rate, pay_mode, source, booking_date, delivery_date, booking_month, booking_year, supplier_id,provider_id, attention, ready_to_approved, short_booking_type, uom, remarks, supplier_location_id, shippingmark_breck_down, ship_mode, pay_term, tenor, main_booking_no, main_booking_id, entry_form,inserted_by, insert_date, status_active, is_deleted";
		$data_array ="(".$id.",1,1,'".$new_booking_no[1]."',".$new_booking_no[2].",'".$new_booking_no[0]."',".$cbo_company_name.",".$cbo_buyer_name.",".$txt_job_no.",".$txt_order_no_id.",".$cbo_fabric_natu.",".$cbo_fabric_source.",".$cbo_currency.",".$txt_exchange_rate.",".$cbo_pay_mode.",".$cbo_source.",".$txt_booking_date.",".$txt_delivery_date.",".$cbo_booking_month.",".$cbo_booking_year.",".$cbo_supplier_name.",".$cbo_provider_name.",".$txt_attention.",".$cbo_ready_to_approved.",".$cbo_short_booking_type.",".$cbouom.",".$txt_remark.",".$cbo_supplier_location.",".$hiddshippingmark_breck_down.",".$cbo_shipmode.",".$cbo_payterm.",".$txt_tenor.",".$txt_mainbooking_no.",".$hidd_mainbooking_id.",88,".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
//*cbo_department*cbo_profit_center*txt_final_comment
		$rID=sql_insert("wo_booking_mst",$field_array,$data_array,0);
		if($db_type==0){
			if($rID){
				mysql_query("COMMIT");
				echo "0**".$new_booking_no[0]."**".$id;
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_booking_no[0]."**".$id;;
			}
		}
		else if($db_type==2 || $db_type==1 ){
			if($rID){
				oci_commit($con);
				echo "0**".$new_booking_no[0]."**".$id;;
			}
			else{
				oci_rollback($con);
				echo "10**".$new_booking_no[0]."**".$id;;
			}
		}
		disconnect($con);
		die;
	}
	else if ($operation==1)
	{
		$con = connect();
		if($db_type==0){
			mysql_query("BEGIN");
		}

		$is_approved=0;
		$sql=sql_select("select is_approved from wo_booking_mst where booking_no=$txt_booking_no");
		foreach($sql as $row){
			if($row[csf('is_approved')]==3){
				$is_approved=1;
			}else{
				$is_approved=$row[csf('is_approved')];
			}
		}
		$profit_center=str_replace("'","",$cbo_profit_center);
		$departmentId=str_replace("'","",$cbo_department);
		$final_comment=str_replace("'","",$txt_final_comment);
		$approv_check_omit="";

		if($profit_center) $approv_check_omit="1";
		if($departmentId) $approv_check_omit="1";
		if($final_comment) $approv_check_omit="1";
		
		if($is_approved==1){
			//echo "10**=".$update_type.'='.$profit_center.'='.$departmentId.'='.$final_comment.'='.$is_approved;die;
		//	echo "10**=approved**".str_replace("'","",$txt_booking_no)."**".str_replace("'","",$update_type)."**".str_replace("'","",$approv_check_omit);die;
			if($update_type==1 &&  $approv_check_omit=="" ) //--- Issue id - 21154 
			{
				
				echo "approved**".str_replace("'","",$txt_booking_no)."**".str_replace("'","",$update_type)."**".str_replace("'","",$approv_check_omit);
				die;
			}
			
		}

		$pi_number=return_field_value( "pi_number", "com_pi_master_details a,com_pi_item_details b"," a.id=b.pi_id  and b.work_order_no=$txt_booking_no  and a.status_active=1 and  a.is_deleted=0  and b.status_active=1 and  b.is_deleted=0");
		if($pi_number){
			echo "pi1**".str_replace("'","",$txt_booking_no)."**".$pi_number;
			die;
		}

		$receive_mrr=0;
		$sqlre=sql_select("select recv_number from inv_receive_master where booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
		foreach($sqlre as $rows){
			$receive_mrr=$rows[csf('recv_number')];
		}
		if($receive_mrr){
			echo "rec1**".str_replace("'","",$txt_booking_no)."**".$receive_mrr;
			 disconnect($con);die;
		}

		/* 
		$issue_mrr=0;
		$sqlis=sql_select("select issue_number from inv_issue_master where booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
		foreach($sqlis as $rows){
			$issue_mrr=$rows[csf('issue_number')];
		}
		if($issue_mrr){
			echo "iss1**".str_replace("'","",$txt_booking_no)."**".$issue_mrr;
			 disconnect($con);die;cbo_profit_center txt_final_comment
		} */
		
		if($update_type == 1){ // Issue id - 21154 
			$field_array="profit_center*department_id*final_comments*provider_id*updated_by*update_date";	
			$data_array_update = "".$cbo_profit_center."*".$cbo_department."*".$txt_final_comment."*".$cbo_provider_name."*'".$_SESSION['logic_erp']['user_id']."'*'".$pc_date_time."'";
		}
		else{
			$field_array="buyer_id*job_no*po_break_down_id*item_category*fabric_source*currency_id*exchange_rate*pay_mode*source*booking_date*delivery_date*booking_month*booking_year*supplier_id*provider_id*attention*ready_to_approved*short_booking_type*uom*remarks*supplier_location_id*shippingmark_breck_down*ship_mode*pay_term*tenor*main_booking_no*main_booking_id*updated_by*update_date";
			$data_array_update ="".$cbo_buyer_name."*".$txt_job_no."*".$txt_order_no_id."*".$cbo_fabric_natu."*".$cbo_fabric_source."*".$cbo_currency."*".$txt_exchange_rate."*".$cbo_pay_mode."*".$cbo_source."*".$txt_booking_date."*".$txt_delivery_date."*".$cbo_booking_month."*".$cbo_booking_year."*".$cbo_supplier_name."*".$cbo_provider_name."*".$txt_attention."*".$cbo_ready_to_approved."*".$cbo_short_booking_type."*".$cbouom."*".$txt_remark."*".$cbo_supplier_location."*".$hiddshippingmark_breck_down."*".$cbo_shipmode."*".$cbo_payterm."*".$txt_tenor."*".$txt_mainbooking_no."*".$hidd_mainbooking_id."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'";
		}

		
		
		$rID=sql_update("wo_booking_mst",$field_array,$data_array_update,"id","".$update_id."",0);

		if($db_type==0){
			if($rID ){
				mysql_query("COMMIT");
				echo "1**".str_replace("'","",$txt_booking_no)."**".str_replace("'","",$update_id);
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".str_replace("'","",$txt_booking_no)."**".str_replace("'","",$update_id);
			}
		}
		else if($db_type==2 || $db_type==1 ){
			if($rID ){
				oci_commit($con);
				echo "1**".str_replace("'","",$txt_booking_no)."**".str_replace("'","",$update_id)."**".str_replace("'","",$approv_check_omit);
			}
			else{
				oci_rollback($con);
				echo "10**".str_replace("'","",$txt_booking_no)."**".str_replace("'","",$update_id);
			}
		}
		disconnect($con);
		die;
	}
	else if ($operation==2)
	{
		$con = connect();
		if($db_type==0){
			mysql_query("BEGIN");
		}
		$is_approved=0;
		$sql=sql_select("select is_approved from wo_booking_mst where booking_no=$txt_booking_no");
		foreach($sql as $row){
			if($row[csf('is_approved')]==3) $is_approved=1; else $is_approved=$row[csf('is_approved')];
		}
		if($is_approved==1){
			echo "approved**".str_replace("'","",$txt_booking_no);
		 disconnect($con);	die;
		}

		$pi_number=return_field_value( "pi_number", "com_pi_master_details a,com_pi_item_details b"," a.id=b.pi_id and b.work_order_no=$txt_booking_no and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0");
		if($pi_number){
			echo "pi1**".str_replace("'","",$txt_booking_no)."**".$pi_number;
			 disconnect($con);die;
		}

		$pplbook=0;
		$ppl=sql_select("select b.id from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and a.booking_no=$txt_booking_no and a.is_sales!=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.id");
		foreach($ppl as $pplrow){
			$pplbook=$pplrow[csf('id')];
		}

		if($pplbook!=0){
			echo "PPL**".str_replace("'","",$txt_booking_no)."**".$pplbook;
			 disconnect($con);die;
		}

		$sales_order=0;
		$sqls=sql_select("select job_no from fabric_sales_order_mst where sales_booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
		foreach($sqls as $rows){
			$sales_order=$rows[csf('job_no')];
		}
		if($sales_order){
			echo "sal1**".str_replace("'","",$txt_booking_no)."**".$sales_order;
			die;
		}

		$receive_mrr=0;
		$sqlre=sql_select("select recv_number from inv_receive_master where booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
		foreach($sqlre as $rows){
			$receive_mrr=$rows[csf('recv_number')];
		}
		if($receive_mrr){
			echo "rec1**".str_replace("'","",$txt_booking_no)."**".$receive_mrr;
			 disconnect($con);die;
		}

		$issue_mrr=0;
		$sqlis=sql_select("select issue_number from inv_issue_master where booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
		foreach($sqlis as $rows){
			$issue_mrr=$rows[csf('issue_number')];
		}
		if($issue_mrr){
			echo "iss1**".str_replace("'","",$txt_booking_no)."**".$issue_mrr;
			 disconnect($con);die;
		}
		$couse_found="";
		$sqlcouse=sql_select("select id from wo_booking_short_cause where booking_no=$txt_booking_no and entry_form=88 and status_active=1 and is_deleted=0");
		foreach($sqlcouse as $crow){
			$couse_found=$crow[csf('id')];
		}
		if($couse_found!=""){
			echo "cause**".str_replace("'","",$txt_booking_no)."**".$couse_found;
			 disconnect($con);die;
		}
		$flag=1;

		//echo "10**update wo_booking_mst set status_active=0,is_deleted =1 where  booking_no=$txt_booking_no and status_active=1 and is_deleted =0"; die;
		$rID=execute_query( "update wo_booking_mst set status_active=0,is_deleted =1 where booking_no=$txt_booking_no and status_active=1 and is_deleted =0",0);
		if($rID==1) $flag=1; else $flag=0;
		$rID2=execute_query( "update wo_booking_dtls set status_active=0,is_deleted =1 where booking_no =$txt_booking_no and status_active=1 and is_deleted =0",0);
		if($rID2==1 && $flag==1) $flag=1; else $flag=0;
		if($couse_found!="")
		{
			$rID3=execute_query( "update wo_booking_short_cause set status_active=0,is_deleted =1 where booking_no =$txt_booking_no and entry_form=88 and status_active=1 and is_deleted =0",0);
			if($rID3==1 && $flag==1) $flag=1; else $flag=0;
		}
		//echo "10**".$rID.'-'.$rID2.'-'.$rID3.'-'.$flag; die;

		if($db_type==0){
			if($flag==1){
				mysql_query("COMMIT");
				echo "2**".str_replace("'","",$txt_booking_no);
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".str_replace("'","",$txt_booking_no);
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($flag==1){
				oci_commit($con);
				echo "2**".str_replace("'","",$txt_booking_no);
			}
			else{
				oci_rollback($con);
				echo "10**".str_replace("'","",$txt_booking_no);
			}
		}
		disconnect($con);
		die;
	}
}
function sql_update2($strTable,$arrUpdateFields,$arrUpdateValues,$arrRefFields,$arrRefValues,$commit="",$return_query='')
{
	$strQuery = "UPDATE ".$strTable." SET ";
	$arrUpdateFields=explode("*",$arrUpdateFields);
	$arrUpdateValues=explode("*",$arrUpdateValues);

	if(count($arrUpdateFields)!=count($arrUpdateValues)){
		return "0";
	}

	if(is_array($arrUpdateFields))
	{
		$arrayUpdate = array_combine($arrUpdateFields,$arrUpdateValues);
		$Arraysize = count($arrayUpdate);
		$i = 1;
		foreach($arrayUpdate as $key=>$value):
			$strQuery .= ($i != $Arraysize)? $key."=".$value.", ":$key."=".$value;
			$i++;
		endforeach;
	}
	else
	{
		$strQuery .= $arrUpdateFields."=".$arrUpdateValues;
	}
	$strQuery .=" WHERE ";

	$arrRefFields=explode("*",$arrRefFields);
	$arrRefValues=explode("*",$arrRefValues);
	if(is_array($arrRefFields))
	{
		$arrayRef = array_combine($arrRefFields,$arrRefValues);
		$Arraysize = count($arrayRef);
		$i = 1;
		foreach($arrayRef as $key=>$value):
			$strQuery .= ($i != $Arraysize)? $key."=".$value." AND ":$key."=".$value."";
			$i++;
		endforeach;
	}
	else
	{
		$strQuery .= $arrRefFields."=".$arrRefValues."";
	}
	if($return_query==1){return $strQuery ;}
echo $strQuery;die;
		//return $strQuery;die;
	global $con;
	if( strpos($strQuery, "WHERE")==false)  return "0";
	$stid =  oci_parse($con, $strQuery);
	$exestd=oci_execute($stid,OCI_NO_AUTO_COMMIT);
	
	if ($exestd){user_activities($exestd);}
	if ($exestd)
		return "1";
	else
		return "0";

	die;
	if ( $commit==1 )
	{
		if (!oci_error($stid))
		{
			oci_commit($con);
			return "1";
		}
		else
		{
			oci_rollback($con);
			return "10";
		}
	}
	else
		return 1;
	die;
}
if($action=="save_update_delete_dtls")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	
	$sqljob=sql_select("select id from wo_po_details_master where job_no=$txt_job_no and status_active=1 and is_deleted=0");
	$jobid=$sqljob[0][csf('id')];
	$jobidArr[$jobid]=$jobid;

	if ($operation==0)  // Insert Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		 if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0";  disconnect($con);die;}
		 $id=return_next_id( "id", "wo_booking_dtls", 1 ) ;
		 $field_array="id,job_no,booking_mst_id,po_break_down_id,pre_cost_fabric_cost_dtls_id,booking_no,booking_type, is_short,fabric_color_id,gmts_color_id,item_size,gmts_size,dia_width,fin_fab_qnty,process_loss_percent,grey_fab_qnty,rate,amount,rmg_qty,responsible_dept,responsible_person,reason,pre_cost_remarks,division_id,inserted_by,insert_date";
		 	$pre_cost_remarks=return_field_value("remarks","wo_pre_cos_fab_co_avg_con_dtls","pre_cost_fabric_cost_dtls_id=$cbo_fabricdescription_id and po_break_down_id=$cbo_order_id and color_number_id =$cbo_garmentscolor_id and gmts_sizes=$cbo_garmentssize_id");

			$data_array="(".$id.",".$txt_job_no.",".$update_id.",".$cbo_order_id.",".$cbo_fabricdescription_id.",".$txt_booking_no.",1,1,".$cbo_fabriccolor_id.",".$cbo_garmentscolor_id.",".$cbo_itemsize_id.",".$cbo_garmentssize_id.",".$txt_dia_width.",".$txt_finish_qnty.",".$txt_process_loss.",".$txt_grey_qnty.",".$txt_rate.",".$txt_amount.",".$txt_rmg_qty.",".$cbo_responsible_dept.",".$cbo_responsible_person.",".$txt_reason.",'".$pre_cost_remarks."',".$cbo_division_id.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."')";
			//$id=$id+1;

		  $rID=sql_insert("wo_booking_dtls",$field_array,$data_array,1);
		 check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "0**".str_replace("'","",$txt_booking_no);
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".str_replace("'","",$txt_booking_no);
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "0**".str_replace("'","",$txt_booking_no);
			}
			else{
				oci_rollback($con);
				echo "10**".str_replace("'","",$txt_booking_no);
			}
		}
		disconnect($con);
		die;
	}
	else if ($operation==1)  // Insert Here
	{
		$con = connect();
		$is_approved=0;
		$sql=sql_select("select is_approved from wo_booking_mst where booking_no=$txt_booking_no");
		foreach($sql as $row){
			if($row[csf('is_approved')]==3){
				$is_approved=1;
			}else{
				$is_approved=$row[csf('is_approved')];
			}
		}
		if($is_approved==1){
			echo "approved**".str_replace("'","",$txt_booking_no);
			 disconnect($con);die;
		}

		$pi_number=return_field_value( "pi_number", "com_pi_master_details a,com_pi_item_details b"," a.id=b.pi_id  and b.work_order_no=$txt_booking_no  and a.status_active=1 and  a.is_deleted=0  and b.status_active=1 and  b.is_deleted=0");
		if($pi_number){
			echo "pi1**".str_replace("'","",$txt_booking_no)."**".$pi_number;
			 disconnect($con);die;
		}

		$receive_mrr=0;
		$sqlre=sql_select("select recv_number from inv_receive_master where booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
		foreach($sqlre as $rows){
			$receive_mrr=$rows[csf('recv_number')];
		}
		if($receive_mrr){
			echo "rec1**".str_replace("'","",$txt_booking_no)."**".$receive_mrr;
			 disconnect($con);die;
		}
		/* 
		$issue_mrr=0;
		$sqlis=sql_select("select issue_number from inv_issue_master where booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
		foreach($sqlis as $rows){
			$issue_mrr=$rows[csf('issue_number')];
		}
		if($issue_mrr){
			echo "iss1**".str_replace("'","",$txt_booking_no)."**".$issue_mrr;
			 disconnect($con);die;
		} */
		
		$olddtlsidArr=array(); $preDataArr=array();
		if(str_replace("'","",$txt_booking_no)!=''){
			$sql_po= sql_select("select b.id as dtlsid, b.po_break_down_id, b.pre_cost_fabric_cost_dtls_id, b.fabric_color_id, c.color_type_id, c.construction, c.composition, c.gsm_weight, b.dia_width from wo_booking_mst a, wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c where a.booking_no=b.booking_no and b.pre_cost_fabric_cost_dtls_id=c.id and a.booking_type=1 and a.is_short=1 and b.booking_no=$txt_booking_no and a.status_active=1 and  a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0");
			foreach($sql_po as $pdata){
				$olddtlsidArr[$pdata[csf('dtlsid')]]=$pdata[csf('dtlsid')];
				$strold=$pdata[csf('construction')].$pdata[csf('fabric_color_id')].$pdata[csf('composition')].$pdata[csf('color_type_id')].$pdata[csf('gsm_weight')].$pdata[csf('dia_width')];
				$preDataArr[$pdata[csf('pre_cost_fabric_cost_dtls_id')]][$pdata[csf('po_break_down_id')]][$strold]=$strold;
			}
		}

		if($db_type==0){
			mysql_query("BEGIN");
		}
	    if ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) {
			echo "15**1";
			 disconnect($con);die;
		}
			$plandatachnage=0;
	    $field_array_up="job_no*po_break_down_id*pre_cost_fabric_cost_dtls_id*booking_no*booking_type*is_short*fabric_color_id*gmts_color_id*item_size*gmts_size*dia_width*fin_fab_qnty*process_loss_percent*grey_fab_qnty*rate*amount*rmg_qty*responsible_dept*responsible_person*reason*pre_cost_remarks*division_id*updated_by*update_date";
		//$ss="select remarks from  wo_pre_cos_fab_co_avg_con_dtls where pre_cost_fabric_cost_dtls_id=$cbo_fabricdescription_id and po_break_down_id=$cbo_order_id and color_number_id =$cbo_garmentscolor_id and gmts_sizes=$cbo_garmentssize_id";

		$pre_cost_remarks=return_field_value("remarks","wo_pre_cos_fab_co_avg_con_dtls","pre_cost_fabric_cost_dtls_id=$cbo_fabricdescription_id and po_break_down_id=$cbo_order_id and color_number_id =$cbo_garmentscolor_id and gmts_sizes=$cbo_garmentssize_id");
		
		$strnew=str_replace("'",'',$$construction).str_replace("'",'',$$colorid).str_replace("'",'',$$composition).str_replace("'",'',$$colortype).str_replace("'",'',$$gsmweight).str_replace("'",'',$$diawidth);
			 
		 /*if($preDataArr[str_replace("'",'',$cbo_fabricdescription_id)][str_replace("'",'',$cbo_order_id)][$strnew]=="")
		 {
			$plandatachnage=1; 
		 }*/

	    $data_array_up ="".$txt_job_no."*".$cbo_order_id."*".$cbo_fabricdescription_id."*".$txt_booking_no."*1*1*".$cbo_fabriccolor_id."*".$cbo_garmentscolor_id."*".$cbo_itemsize_id."*".$cbo_garmentssize_id."*".$txt_dia_width."*".$txt_finish_qnty."*".$txt_process_loss."*".$txt_grey_qnty."*".$txt_rate."*".$txt_amount."*".$txt_rmg_qty."*".$cbo_responsible_dept."*".$cbo_responsible_person."*".$txt_reason."*'".$pre_cost_remarks."'*".$cbo_division_id."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'";
		
	    $rID=sql_update("wo_booking_dtls",$field_array_up,$data_array_up,"id","".$update_id_details."",0);
		
		fnc_isdyeingplan("WO_PO_DETAILS_MASTER", $jobidArr);
		fnc_isdyeingplan("WO_BOOKING_DTLS", str_replace("'",'',$update_id_details) );
		
	    check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "1**".str_replace("'","",$txt_booking_no);
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".str_replace("'","",$txt_booking_no);
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "1**".str_replace("'","",$txt_booking_no)."**".$ss;
			}
			else{
				oci_rollback($con);
				echo "10**".str_replace("'","",$txt_booking_no);
			}
		}
		disconnect($con);
		die;
	}
	else if ($operation==2)  // Insert Here
	{
		$con = connect();
		$is_approved=0;
		$sql=sql_select("select is_approved from wo_booking_mst where booking_no=$txt_booking_no");
		foreach($sql as $row){
			if($row[csf('is_approved')]==3) $is_approved=1; else $is_approved=$row[csf('is_approved')];
		}
		if($is_approved==1){
			echo "approved**".str_replace("'","",$txt_booking_no);
			 disconnect($con);die;
		}

		$pi_number=return_field_value( "pi_number", "com_pi_master_details a,com_pi_item_details b"," a.id=b.pi_id and b.work_order_no=$txt_booking_no and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and  b.is_deleted=0");
		if($pi_number){
			echo "pi1**".str_replace("'","",$txt_booking_no)."**".$pi_number;
			 disconnect($con);die;
		}

		$pplbook=0;
		$ppl=sql_select("select b.id from ppl_planning_info_entry_mst a, ppl_planning_info_entry_dtls b where a.id=b.mst_id and a.booking_no=$txt_booking_no and a.is_sales!=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by b.id");
		foreach($ppl as $pplrow){
			$pplbook=$pplrow[csf('id')];
		}

		if($pplbook!=0){
			echo "PPL**".str_replace("'","",$txt_booking_no)."**".$pplbook;
			 disconnect($con);die;
		}

		$sales_order=0;
		$sqls=sql_select("select job_no from fabric_sales_order_mst where sales_booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
		foreach($sqls as $rows){
			$sales_order=$rows[csf('job_no')];
		}
		if($sales_order){
			echo "sal1**".str_replace("'","",$txt_booking_no)."**".$sales_order;
			 disconnect($con);die;
		}

		$receive_mrr=0;
		$sqlre=sql_select("select recv_number from inv_receive_master where booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
		foreach($sqlre as $rows){
			$receive_mrr=$rows[csf('recv_number')];
		}
		if($receive_mrr){
			echo "rec1**".str_replace("'","",$txt_booking_no)."**".$receive_mrr;
			 disconnect($con);die;
		}

		$issue_mrr=0;
		$sqlis=sql_select("select issue_number from inv_issue_master where booking_no=$txt_booking_no and status_active=1 and is_deleted=0");
		foreach($sqlis as $rows){
			$issue_mrr=$rows[csf('issue_number')];
		}
		if($issue_mrr){
			echo "iss1**".str_replace("'","",$txt_booking_no)."**".$issue_mrr;
			 disconnect($con);die;
		}
		
		$couse_found="";
		$sqlcouse=sql_select("select id from wo_booking_short_cause where dtls_id=$update_id_details and entry_form=88 and status_active=1 and is_deleted=0");
		foreach($sqlcouse as $crow){
			$couse_found=$crow[csf('id')];
		}
		if($couse_found!=""){
			echo "cause**".str_replace("'","",$txt_booking_no)."**".$couse_found;
			 disconnect($con);die;
		}

		if($db_type==0){
			mysql_query("BEGIN");
		}
		$flag=1;
		//$rID=execute_query( "update wo_booking_dtls set status_active=0,is_deleted =1 where  id =$update_id_details",0);
		//$rID=sql_delete("wo_booking_dtls","status_active*is_deleted","0*1",'id',$update_id_details,1);
		$rID= execute_query( "update wo_booking_dtls set status_active=0,is_deleted =1,updated_by=".$_SESSION['logic_erp']['user_id'].",update_date='".$pc_date_time."' where  id=$update_id_details ",0);
		if($rID==1) $flag=1; else $flag=0;
		
		if($couse_found!=""){
			$rID1= execute_query( "update wo_booking_short_cause set status_active=0,is_deleted =1 where  dtls_id=$update_id_details and entry_form=88 and status_active=1 and is_deleted =0",0);
			if($rID1==1 && $flag==1) $flag=1; else $flag=0;
		}
		
		if($db_type==0)
		{
			if($flag==1){
				mysql_query("COMMIT");
				echo "2**".str_replace("'","",$txt_booking_no);
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".str_replace("'","",$txt_booking_no);
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($flag==1){
				oci_commit($con);
				echo "2**".str_replace("'","",$txt_booking_no);
			}
			else{
				oci_rollback($con);
				echo "10**".str_replace("'","",$txt_booking_no);
			}
		}
		disconnect($con);
		die;
	}
}

if ($action=="fabric_booking_popup")
{
  	echo load_html_head_contents("Booking Search","../../../", 1, 1, $unicode);
  	extract($_REQUEST);
?>
	<script>
 	var company="<? echo $company; ?>";
	$('#cbo_company_mst').val(company);
	function set_checkvalue()
	{
		if(document.getElementById('chk_job_wo_po').value==0) document.getElementById('chk_job_wo_po').value=1;
		else document.getElementById('chk_job_wo_po').value=0;
	}

	function js_set_value(booking_no)
	{
		document.getElementById('selected_booking').value=booking_no;
		parent.emailwindow.hide();
	}
    </script>
</head>
<body>
<div align="center" style="width:100%;" >
<form name="searchorderfrm_1"  id="searchorderfrm_1" autocomplete="off">
        <table cellspacing="0" cellpadding="0" border="1" class="rpt_table" align="center" rules="all">
             <thead>
                <th colspan="9">
                  <?
                   echo create_drop_down( "cbo_search_category", 130, $string_search_type,'', 1, "-- Search Catagory --" );
                  ?>
                </th>
             </thead>
            <thead>
                <th width="150">Company Name</th>
                <th width="150">Buyer Name</th>
                <th width="80">Booking No</th>
                <th width="80">Job No</th>
                <th width="80">Internal Ref</th>
                <th width="80">File No</th>
                <th width="130" colspan="2">Date Range</th>
                <th><input type="checkbox" value="0" onClick="set_checkvalue()" id="chk_job_wo_po">Orphan Booking</th>
            </thead>
            <tr class="general">
                <td> <input type="hidden" id="selected_booking">
                    <?
                        echo create_drop_down( "cbo_company_mst", 150, "select id,company_name from lib_company comp where status_active=1 and core_business not in(3) $company_cond order by company_name","id,company_name",1, "-- Select Company --", $company, "load_drop_down( 'size_color_breakdown_controller', this.value, 'load_drop_down_buyer', 'buyer_td' );");
                    ?>
                </td>
            <td id="buyer_td">
             <?
                echo create_drop_down( "cbo_buyer_name", 172, $blank_array,"", 1, "-- Select Buyer --" );
            ?>	</td>
            <td><input name="txt_booking_prifix" id="txt_booking_prifix" class="text_boxes" style="width:70px"></td>
            <td><input name="txt_job_prifix" id="txt_job_prifix" class="text_boxes" style="width:70px"></td>
            <td><input name="txt_internal_ref" id="txt_internal_ref" class="text_boxes" style="width:70px"></td>
            <td><input name="txt_file_no" id="txt_file_no" class="text_boxes" style="width:70px"></td>
            <td><input name="txt_date_from" id="txt_date_from" class="datepicker" style="width:60px"></td>
            <td><input name="txt_date_to" id="txt_date_to" class="datepicker" style="width:60px"></td>
             <td align="center">
                <input type="button" name="button2" class="formbutton" value="Show" onClick="show_list_view ( document.getElementById('cbo_company_mst').value+'_'+document.getElementById('cbo_buyer_name').value+'_'+document.getElementById('txt_date_from').value+'_'+document.getElementById('txt_date_to').value+'_'+document.getElementById('txt_job_prifix').value+'_'+document.getElementById('cbo_year_selection').value+'_'+document.getElementById('txt_booking_prifix').value+'_'+document.getElementById('cbo_search_category').value+'_'+document.getElementById('txt_internal_ref').value+'_'+document.getElementById('txt_file_no').value+'_'+document.getElementById('chk_job_wo_po').value, 'create_booking_search_list_view', 'search_div', 'short_fabric_booking_controller','setFilterGrid(\'list_view\',-1)')" style="width:100px;" /></td>
        </tr>
        <tr>
            <td align="center" colspan="9" valign="middle">
            <?=load_month_buttons(1);  ?>
            </td>
        </tr>
     </table>
    <div id="search_div"></div>
    </form>
   </div>
</body>
<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
</html>
<?
exit();
}

if ($action=="create_booking_search_list_view")
{
	$data=explode('_',$data);
	if ($data[0]!=0) $company="  a.company_id='$data[0]'"; else { echo "Please Select Company First."; die; }
	if ($data[1]!=0) $buyer=" and a.buyer_id='$data[1]'"; else $buyer="";//{ echo "Please Select Buyer First."; die; }
	if($db_type==0)
	 {
		  $booking_year_cond=" and year(a.insert_date)=$data[5]";
		  $year_cond=" and SUBSTRING_INDEX(b.insert_date, '-', 1)=$data[5]";
		  if ($data[2]!="" &&  $data[3]!="") $booking_date  = "and a.booking_date  between '".change_date_format($data[2], "yyyy-mm-dd", "-")."'
		  and '".change_date_format($data[3], "yyyy-mm-dd", "-")."'"; else $booking_date ="";
     }
	if($db_type==2)
	 {
		  $booking_year_cond=" and to_char(a.insert_date,'YYYY')=$data[5]";
		  $year_cond=" and to_char(b.insert_date,'YYYY')=$data[5]";
		  if ($data[2]!="" &&  $data[3]!="") $booking_date  = "and a.booking_date  between '".change_date_format($data[2], "yyyy-mm-dd", "-",1)."'
		  and '".change_date_format($data[3], "yyyy-mm-dd", "-",1)."'"; else $booking_date ="";
	 }
	if($data[7]==4 || $data[7]==0)
		{
			if (str_replace("'","",$data[4])!="") $job_cond=" and b.job_no_prefix_num like '%$data[4]%' $year_cond "; else  $job_cond="";
			if (str_replace("'","",$data[6])!="") $booking_cond=" and a.booking_no_prefix_num like '%$data[6]%'  $booking_year_cond  "; else $booking_cond="";
		}
		//echo $booking_cond;
    if($data[7]==1)
		{
			if (str_replace("'","",$data[4])!="") $job_cond=" and b.job_no_prefix_num ='$data[4]' "; else  $job_cond="";
			if (str_replace("'","",$data[6])!="") $booking_cond=" and a.booking_no_prefix_num ='$data[6]'   "; else $booking_cond="";
		}
   if($data[7]==2)
		{
			if (str_replace("'","",$data[4])!="") $job_cond=" and b.job_no_prefix_num like '$data[4]%'  $year_cond"; else  $job_cond="";
			if (str_replace("'","",$data[6])!="") $booking_cond=" and a.booking_no_prefix_num like '$data[6]%'  $booking_year_cond  "; else $booking_cond="";
		}
	if($data[7]==3)
		{
			if (str_replace("'","",$data[4])!="") $job_cond=" and b.job_no_prefix_num like '%$data[4]'  $year_cond"; else  $job_cond="";
			if (str_replace("'","",$data[6])!="") $booking_cond=" and a.booking_no_prefix_num like '%$data[6]'  $booking_year_cond  "; else $booking_cond="";
		}

	$internal_ref = str_replace("'","",$data[8]);
	$file_no = str_replace("'","",$data[9]);
	$chk_job_wo_po = str_replace("'","",$data[10]);
	//echo $chk_job_wo_po.'ddd';die;
	if ($file_no=="") $file_no_cond=""; else $file_no_cond=" and c.file_no='".trim($file_no)."' ";
	if ($internal_ref=="") $internal_ref_cond=""; else $internal_ref_cond=" and c.grouping='".trim($internal_ref)."' ";
$po_number=return_library_array( "select id,po_number from wo_po_break_down", "id", "po_number"  );
	$po_array=array();
	$sql_po= sql_select("select a.booking_no,a.po_break_down_id from wo_booking_mst  a where $company $buyer $booking_date  and a.booking_type=1 and a.is_short=1 and   a.status_active=1  and 	a.is_deleted=0 order by a.booking_no");
	foreach($sql_po as $row)
	{
		$po_id=explode(",",$row[csf("po_break_down_id")]);
		$po_number_string="";$po_internal="";
		foreach($po_id as $key=> $value )
		{
			$po_number_string.=$po_number[$value].",";
		}
		//print_r( $po_internal);
		$po_array[$row[csf("po_break_down_id")]]=rtrim($po_number_string,",");
	}
	//print_r($po_array);die;
	 $approved=array(0=>"No",1=>"Yes",3=>"Yes");
	 $is_ready=array(0=>"No",1=>"Yes",2=>"No");
	$buyer_arr=return_library_array( "select id, short_name from lib_buyer",'id','short_name');
	$comp=return_library_array( "select id, company_short_name from lib_company",'id','company_short_name');
	$suplier=return_library_array( "select id, short_name from lib_supplier",'id','short_name');
	//$po_num=return_library_array( "select job_no, job_no_prefix_num from wo_po_details_master",'job_no','job_no_prefix_num');
	//$arr=array (2=>$comp,3=>$buyer_arr,4=>$po_num,5=>$po_array,8=>$item_category,9=>$fabric_source,10=>$suplier,11=>$approved,12=>$yes_no);

	if($chk_job_wo_po==0)
	{
		$sql= "select a.booking_no_prefix_num, a.pay_mode, b.job_no_prefix_num, c.po_number, c.file_no, c.grouping, a.booking_no, a.booking_date, a.company_id, a.buyer_id, a.job_no, a.po_break_down_id, a.item_category, a.fabric_source, a.supplier_id, a.is_approved, a.ready_to_approved from wo_booking_mst a,wo_po_details_master b,wo_po_break_down c,wo_booking_dtls d where $company $buyer $booking_date $job_cond $booking_cond $file_no_cond $internal_ref_cond ".set_user_lavel_filtering(' and a.buyer_id','buyer_id')."  and d.po_break_down_id=c.id and a.entry_form=88 and a.booking_no=d.booking_no and a.job_no=b.job_no and d.job_no=b.job_no  and a.job_no=c.job_no_mst and b.job_no=c.job_no_mst and a.booking_type=1 and a.is_short=1 and  a.status_active=1 and a.is_deleted=0 and  b.status_active=1 and b.is_deleted=0 and  d.status_active=1 and d.is_deleted=0 order by a.id DESC";
	}
	else //Without Order/Job
	{
		$sql= "select a.booking_no_prefix_num, a.pay_mode, b.job_no_prefix_num, '' as po_number, '' as file_no, '' as grouping, a.booking_no, a.booking_date, a.company_id, a.buyer_id, a.job_no, a.po_break_down_id, a.item_category, a.fabric_source, a.supplier_id, a.is_approved, a.ready_to_approved from wo_booking_mst a, wo_po_details_master b where  a.booking_no not in ( select a.booking_no from wo_booking_mst a, wo_booking_dtls b, wo_po_break_down c where a.booking_no=b.booking_no and b.po_break_down_id=c.id and a.booking_type=1 and a.entry_form=88 and a.booking_type=1 and a.is_short=1 and a.status_active =1 and a.is_deleted=0 and b.status_active =1 and b.is_deleted=0 and $company $buyer $booking_date $booking_cond $job_cond $file_no_cond $internal_ref_cond ".set_user_lavel_filtering(' and a.buyer_id','buyer_id')." group by a.booking_no_prefix_num, a.booking_no,company_id,a.booking_date ) and $company $buyer $booking_date $job_cond $booking_cond ".set_user_lavel_filtering(' and a.buyer_id','buyer_id')." and a.job_no=b.job_no and a.entry_form=88 and a.booking_type=1 and a.is_short=1 and  a.status_active=1 and a.is_deleted=0 and  b.status_active=1 and b.is_deleted=0 order by a.id DESC";
	}

	?>
    <div style="1160px; margin-left:10px;">
    <table class="rpt_table" width="1160" cellpadding="0" cellspacing="0" border="1" rules="all" id="table_body">
        <thead>
            <th width="30">SL</th>
            <th width="50">Booking No</th>
            <th width="60">Booking Date</th>
            <th width="100">Company</th>
            <th width="90">Buyer</th>

            <th width="90">Job No.</th>
            <th width="120">PO No.</th>
            <th width="80">File No</th>
            <th width="80">Ref. No</th>

            <th width="90">Fabric Nature</th>
            <th width="80">Fabric Source</th>
            <th width="70">Pay Mode</th>
            <th width="80">Supplier</th>

            <th width="60">Approved</th>
            <th>Is-Ready</th>
        </thead>
        </table>
    <div style="max-height:300px; overflow-y:scroll; width:1160px" >
    <table width="1140" class="rpt_table" id="list_view" border="1" rules="all">
        <tbody>
        <?
		$i=1;
		$sql_data=sql_select($sql);
		foreach($sql_data as $row)
		{
			if($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
			?>
			<tr bgcolor="<? echo $bgcolor;?>" onClick="js_set_value('<? echo $row[csf('booking_no')]  ?>')" style="cursor:pointer">
                <td width="30"><? echo $i;?></td>
                <td width="50"><? echo $row[csf('booking_no_prefix_num')];?></td>
                <td width="60"><? echo date("d-m-Y",strtotime($row[csf('booking_date')]));?></td>
                <td width="100"><? echo $comp[$row[csf('company_id')]];?></td>
                <td width="90" style="word-break:break-all"><? echo $buyer_arr[$row[csf('buyer_id')]];?></td>
                <td width="90" style="word-break:break-all"><? echo $row[csf('job_no')];?></td>
                <td width="120" style="word-break:break-all"><? echo $row[csf('po_number')];?></td>
                <td width="80" style="word-break:break-all"><p><? echo $row[csf('file_no')];?></p></td>
                <td width="80" style="word-break:break-all"><p><? echo $row[csf('grouping')];?></p></td>
                <td width="90" style="word-break:break-all"><? echo $item_category[$row[csf('item_category')]];?></td>
                <td width="80" style="word-break:break-all"><? echo $fabric_source[$row[csf('fabric_source')]];?></td>
                <td width="70" style="word-break:break-all"><? echo $pay_mode[$row[csf('pay_mode')]];?></td>
                <td width="80" style="word-break:break-all">
                <?
                if($row[csf('pay_mode')]==3 || $row[csf('pay_mode')]==5) echo $comp[$row[csf('supplier_id')]];
                else echo $suplier[$row[csf('supplier_id')]];
                ?>
                </td>

                <td width="60"><? echo $approved[$row[csf('is_approved')]];?></td>
                <td><? echo $is_ready[$row[csf('ready_to_approved')]];?></td>
			</tr>
			<?
			$i++;
         }
        ?>
        </tbody>
    </table>
	</div>
	<?
	exit();
}

if($action=="terms_condition_popup")
{
	echo load_html_head_contents("Order Search","../../../", 1, 1, $unicode);
	extract($_REQUEST);
?>
	<script>
function add_break_down_tr(i)
 {
	var row_num=$('#tbl_termcondi_details tr').length-1;
	if (row_num!=i)
	{
		return false;
	}
	else
	{
		i++;

		 $("#tbl_termcondi_details tr:last").clone().find("input,select").each(function() {
			$(this).attr({
			  'id': function(_, id) { var id=id.split("_"); return id[0] +"_"+ i },
			  'name': function(_, name) { return name + i },
			  'value': function(_, value) { return value }
			});
		  }).end().appendTo("#tbl_termcondi_details");
		 $('#increase_'+i).removeAttr("onClick").attr("onClick","add_break_down_tr("+i+");");
		  $('#decrease_'+i).removeAttr("onClick").attr("onClick","fn_deletebreak_down_tr("+i+")");
		  $('#termscondition_'+i).val("");
	}

}

function fn_deletebreak_down_tr(rowNo)
{


		var numRow = $('table#tbl_termcondi_details tbody tr').length;
		if(numRow==rowNo && rowNo!=1)
		{
			$('#tbl_termcondi_details tbody tr:last').remove();
		}

}

function fnc_fabric_booking_terms_condition( operation )
{
	    var row_num=$('#tbl_termcondi_details tr').length-1;
		var data_all="";
		for (var i=1; i<=row_num; i++)
		{

			if (form_validation('termscondition_'+i,'Term Condition')==false)
			{
				return;
			}

			data_all=data_all+get_submitted_data_string('txt_booking_no*termscondition_'+i,"");
		}
		var data="action=save_update_delete_fabric_booking_terms_condition&operation="+operation+'&total_row='+row_num+data_all;
		//freeze_window(operation);
		http.open("POST","short_fabric_booking_controller.php",true);
		http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
		http.send(data);
		http.onreadystatechange = fnc_fabric_booking_terms_condition_reponse;
}

function fnc_fabric_booking_terms_condition_reponse()
{

	if(http.readyState == 4)
	{
	    var reponse=trim(http.responseText).split('**');
			if (reponse[0].length>2) reponse[0]=10;
			if(reponse[0]==0 || reponse[0]==1)
			{
				parent.emailwindow.hide();
			}
	}
}
    </script>

</head>

<body>
<div align="center" style="width:100%;" >
 <? echo load_freeze_divs ("../../../",$permission);  ?>
<fieldset>
        	<form id="termscondi_1" autocomplete="off">
           <input type="hidden" id="txt_booking_no" name="txt_booking_no" value="<? echo str_replace("'","",$txt_booking_no) ?>"/>


            <table width="650" cellspacing="0" class="rpt_table" border="0" id="tbl_termcondi_details" rules="all">
                	<thead>
                    	<tr>
                        	<th width="50">Sl</th><th width="530">Terms</th><th ></th>
                        </tr>
                    </thead>
                    <tbody>
                    <?
					$data_array=sql_select("select id, terms from  wo_booking_terms_condition where booking_no=$txt_booking_no");// quotation_id='$data'
					if ( count($data_array)>0)
					{
						$i=0;
						foreach( $data_array as $row )
						{
							$i++;
							?>
                            	<tr id="settr_1" align="center">
                                    <td>
                                    <? echo $i;?>
                                    </td>
                                    <td>
                                    <input type="text" id="termscondition_<? echo $i;?>"   name="termscondition_<? echo $i;?>" style="width:95%"  class="text_boxes"  value="<? echo $row[csf('terms')]; ?>"  />
                                    </td>
                                    <td>
                                    <input type="button" id="increase_<? echo $i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr(<? echo $i; ?> )" />
                                    <input type="button" id="decrease_<? echo $i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<? echo $i; ?>);" />
                                    </td>
                                </tr>
                            <?
						}
					}
					else
					{
					$data_array=sql_select("select id, terms from  lib_terms_condition  where is_default=1");// quotation_id='$data'
					foreach( $data_array as $row )
						{
							$i++;
					?>
                    <tr id="settr_1" align="center">
                                    <td>
                                    <? echo $i;?>
                                    </td>
                                    <td>
                                    <input type="text" id="termscondition_<? echo $i;?>"   name="termscondition_<? echo $i;?>" style="width:95%"  class="text_boxes"  value="<? echo $row[csf('terms')]; ?>"  />
                                    </td>
                                    <td>
                                    <input type="button" id="increase_<? echo $i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_tr(<? echo $i; ?> )" />
                                    <input type="button" id="decrease_<? echo $i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_deletebreak_down_tr(<? echo $i; ?> );" />
                                    </td>
                                </tr>
                    <?
						}
					}
					?>
                </tbody>
                </table>

                <table width="650" cellspacing="0" class="" border="0">
                	<tr>
                        <td align="center" height="15" width="100%"> </td>
                    </tr>
                	<tr>
                        <td align="center" width="100%" class="button_container">
						        <?
									echo load_submit_buttons( $permission, "fnc_fabric_booking_terms_condition", 0,0 ,"reset_form('termscondi_1','','','','')",1) ;
									?>
                        </td>
                    </tr>
                </table>
            </form>
        </fieldset>
</div>
</body>
<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
</html>
<?
exit();
}

if($action=="save_update_delete_fabric_booking_terms_condition")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));

	if ($operation==0)  // Insert Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0"; disconnect($con); die;}
		 $id=return_next_id( "id", "wo_booking_terms_condition", 1 ) ;
		 $field_array="id,booking_no,terms";
		 for ($i=1;$i<=$total_row;$i++)
		 {
			 $termscondition="termscondition_".$i;
			if ($i!=1) $data_array .=",";
			$data_array .="(".$id.",".$txt_booking_no.",".$$termscondition.")";
			$id=$id+1;
		 }
		// echo  $data_array;
		$rID_de3=execute_query( "delete from wo_booking_terms_condition where  booking_no =".$txt_booking_no."",0);

		 $rID=sql_insert("wo_booking_terms_condition",$field_array,$data_array,1);
		 check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID ){
				mysql_query("COMMIT");
				echo "0**".$new_booking_no[0];
			}
			else{
				mysql_query("ROLLBACK");
				echo "10**".$new_booking_no[0];
			}
		}

		if($db_type==2 || $db_type==1 )
		{
			if($rID ){
				oci_commit($con);
				echo "0**".$new_booking_no[0];
			}
			else{
				oci_rollback($con);
				echo "10**".$new_booking_no[0];
			}
		}
		disconnect($con);
		die;
	}
}

if ($action=="populate_order_data_from_search_popup")
{
	// $user_id
	if($db_type==2) $group_concat_all=" listagg(cast(b.grouping as varchar2(4000)),',') within group (order by b.grouping) as grouping,
	                                    listagg(cast(b.file_no as varchar2(4000)),',') within group (order by b.file_no) as file_no  ";
	else { $group_concat_all="group_concat(b.grouping) as grouping, group_concat(b.file_no) as file_no";}

	$data_array=sql_select("select a.job_no, a.company_name, $group_concat_all, a.buyer_name from wo_po_details_master a, wo_po_break_down b where b.id in (".$data.") and a.job_no=b.job_no_mst group by a.job_no,a.company_name,a.buyer_name");
	foreach ($data_array as $row)
	{
		$print_report_format2=return_field_value("format_id"," lib_report_template","template_name ='".$row[csf("company_name")]."' and module_id=2 and report_id=2 and is_deleted=0 and status_active=1");
		echo "document.getElementById('cbo_company_name').value = '".$row[csf("company_name")]."';\n";
		echo "document.getElementById('report_ids').value = '".$print_report_format2."';\n";
		echo "document.getElementById('cbo_buyer_name').value = '".$row[csf("buyer_name")]."';\n";
		echo "document.getElementById('txt_job_no').value = '".$row[csf("job_no")]."';\n";
		$grouping=implode(",",array_unique(explode(",",$row[csf("grouping")])));
		$file_no=implode(",",array_unique(explode(",",$row[csf("file_no")])));
		echo "document.getElementById('txt_intarnal_ref').value = '".$grouping."';\n";
		echo "document.getElementById('txt_file_no').value = '".$file_no."';\n";
	}
	exit();
}

if ($action=="populate_data_from_search_popup")
{
	 $company2=return_field_value("company_id","wo_booking_mst","booking_no ='".$data."' and is_deleted=0 and status_active=1");
	//$print_report_format1=return_field_value("format_id","user_priviledge_report_setting","company_id ='".$company2."' and  user_id=$user_id and module_id=2 and report_id=2 and is_deleted=0 and status_active=1");
	//$print_report_format1=return_field_value("format_id","user_priviledge_report_setting","company_id ='".$company2."' and  user_id=$user_id and module_id=2 and report_id=2 and is_deleted=0 and status_active=1");
	$print_report_format1=return_field_value("format_id","lib_report_template","template_name ='".$company2."' and module_id=2 and report_id=2 and is_deleted=0 and status_active=1");
	 $sql= "select id, booking_no, booking_date, company_id, buyer_id, job_no, po_break_down_id, item_category, fabric_source, currency_id, exchange_rate, pay_mode, booking_month, supplier_id,provider_id, attention, delivery_date, source, booking_year, is_approved,profit_center,department_id,final_comments, ready_to_approved, short_booking_type, uom, remarks, supplier_location_id, shippingmark_breck_down, ship_mode, pay_term, tenor, main_booking_id, main_booking_no from wo_booking_mst where booking_no='$data'";

	 $data_array=sql_select($sql);
	 foreach ($data_array as $row)
	 {
		echo "load_drop_down( 'requires/short_fabric_booking_controller', '".$row[csf("pay_mode")]."', 'load_drop_down_suplier', 'sup_td' ) ;\n";
		echo "load_drop_down( 'requires/short_fabric_booking_controller', '".$row[csf("pay_mode")]."', 'load_drop_down_short_provider', 'prov_td' ) ;\n";
		echo "document.getElementById('report_ids').value = '".$print_report_format1."';\n";
		echo "document.getElementById('txt_order_no_id').value = '".$row[csf("po_break_down_id")]."';\n";
		echo "document.getElementById('cbo_company_name').value = '".$row[csf("company_id")]."';\n";
		echo "document.getElementById('cbo_buyer_name').value = '".$row[csf("buyer_id")]."';\n";
		echo "document.getElementById('txt_job_no').value = '".$row[csf("job_no")]."';\n";
		echo "document.getElementById('txt_booking_no').value = '".$row[csf("booking_no")]."';\n";
		echo "document.getElementById('update_id').value = '".$row[csf("id")]."';\n";
		echo "document.getElementById('cbo_fabric_natu').value = '".$row[csf("item_category")]."';\n";
		echo "document.getElementById('cbo_fabric_source').value = '".$row[csf("fabric_source")]."';\n";
		echo "document.getElementById('cbo_currency').value = '".$row[csf("currency_id")]."';\n";
		echo "document.getElementById('txt_exchange_rate').value = '".$row[csf("exchange_rate")]."';\n";
		echo "document.getElementById('cbo_pay_mode').value = '".$row[csf("pay_mode")]."';\n";
		echo "document.getElementById('txt_booking_date').value = '".change_date_format($row[csf("booking_date")],'dd-mm-yyyy','-')."';\n";
		echo "document.getElementById('cbo_booking_month').value = '".$row[csf("booking_month")]."';\n";
		echo "document.getElementById('cbo_supplier_name').value = '".$row[csf("supplier_id")]."';\n";
		echo "document.getElementById('cbo_provider_name').value = '".$row[csf("provider_id")]."';\n";
		echo "load_drop_down( 'requires/short_fabric_booking_controller','".$row[csf("supplier_id")]."'+'_'+'".$row[csf("pay_mode")]."', 'load_drop_down_location', 'sup_location_td' );\n";
		echo "document.getElementById('cbo_supplier_location').value = '".$row[csf("supplier_location_id")]."';\n";
		echo "document.getElementById('txt_attention').value = '".$row[csf("attention")]."';\n";
		echo "document.getElementById('txt_delivery_date').value = '".change_date_format($row[csf("delivery_date")],'dd-mm-yyyy','-')."';\n";
	    echo "document.getElementById('cbo_source').value = '".$row[csf("source")]."';\n";
		echo "document.getElementById('cbo_booking_year').value = '".$row[csf("booking_year")]."';\n";
		echo "document.getElementById('hiddshippingmark_breck_down').value = '".$row[csf("shippingmark_breck_down")]."';\n";
		
		echo "document.getElementById('cbo_shipmode').value = '".$row[csf("ship_mode")]."';\n";
		echo "document.getElementById('cbo_payterm').value = '".$row[csf("pay_term")]."';\n";
		echo "document.getElementById('txt_tenor').value = '".$row[csf("tenor")]."';\n";
		echo "document.getElementById('txt_mainbooking_no').value = '".$row[csf("main_booking_no")]."';\n";
		echo "document.getElementById('hidd_mainbooking_id').value = '".$row[csf("main_booking_id")]."';\n";
		echo "load_drop_down( 'requires/short_fabric_booking_controller', '".$row[csf("company_id")]."', 'load_drop_down_department', 'department_td' ) ;\n";
		echo "load_drop_down( 'requires/short_fabric_booking_controller', '".$row[csf("company_id")]."', 'load_drop_down_profit_center', 'profit_center_td' ) ;\n";
		 
		echo "document.getElementById('cbo_profit_center').value = '".$row[csf("profit_center")]."';\n";
		echo "document.getElementById('cbo_department').value = '".$row[csf("department_id")]."';\n";
		echo "document.getElementById('txt_final_comment').value = '".$row[csf("final_comments")]."';\n";
		echo "document.getElementById('txt_update_type').value = '0';\n";
 
		if($row[csf("is_approved")]==1){
			echo "$('#txt_final_comment').prop('disabled',false)".";\n";
			echo "$('#cbo_profit_center').prop('disabled',false)".";\n";
			echo "$('#cbo_department').prop('disabled',false)".";\n";
			echo "$('#txt_update_type').val(1)".";\n";
		}


		/*if($row[csf("is_approved")]==3){
			$is_approved=1;
		}else{
			$is_approved=$row[csf("is_approved")];
		}*/
		echo " $('#cbo_company_name').attr('disabled','disabled');\n;";
		echo "document.getElementById('id_approved_id').value = '".$row[csf("is_approved")]."';\n";
		echo "document.getElementById('cbo_ready_to_approved').value = '".$row[csf("ready_to_approved")]."';\n";
		echo "document.getElementById('cbo_short_booking_type').value = '".$row[csf("short_booking_type")]."';\n";
		echo "document.getElementById('cbouom').value = '".$row[csf("uom")]."';\n";
		echo "document.getElementById('txt_remark').value = '".$row[csf("remarks")]."';\n";
		if($db_type==2) $group_concat_all=" listagg(cast(b.grouping as varchar2(4000)),',') within group (order by b.grouping) as grouping,
	                                    listagg(cast(b.file_no as varchar2(4000)),',') within group (order by b.file_no) as file_no,
										listagg(cast(b.po_number as varchar2(4000)),',') within group (order by b.po_number) as po_number";
		else { $group_concat_all="group_concat(b.grouping) as grouping, group_concat(b.file_no) as file_no, group_concat(b.po_number) as po_number";}
		$po_no="";
		$data_array3=sql_select("select a.job_no, a.company_name, a.buyer_name, $group_concat_all from wo_po_details_master a, wo_po_break_down b where b.id in (".$row[csf("po_break_down_id")].") and a.job_no=b.job_no_mst group by a.job_no,a.company_name,a.buyer_name");
		foreach($data_array3 as $inv)
		{
			$grouping=implode(",",array_unique(explode(",",$inv[csf("grouping")])));
			$file_no=implode(",",array_unique(explode(",",$inv[csf("file_no")])));
			$po_no=implode(",",array_unique(explode(",",$inv[csf("po_number")])));
			echo "document.getElementById('txt_file_no').value = '".$file_no."';\n";
			echo "document.getElementById('txt_intarnal_ref').value = '".$grouping."';\n";
		}

		if($row[csf("is_approved")]==1)
		{
			echo "document.getElementById('app_sms2').innerHTML = 'This booking is approved';\n";
			echo "document.getElementById('txt_un_appv_request').disabled = '".false."';\n";
		}
		else if($row[csf("is_approved")]==3)
		{
			echo "document.getElementById('app_sms2').innerHTML = 'This booking is partial approved';\n";
			echo "document.getElementById('txt_un_appv_request').disabled = '".false."';\n";
		}
		else
		{
			echo "document.getElementById('txt_un_appv_request').disabled = '".true."';\n";
			echo "document.getElementById('app_sms2').innerHTML = '';\n";
		}
		
		//echo "document.getElementById('txt_order_no').value = '".substr($po_no, 0, -1)."';\n";
		echo "document.getElementById('txt_order_no').value = '".rtrim($po_no,',')."';\n";
		echo "enable_disable('".$row[csf("fabric_source")]."');\n";
		$wo_id=$row[csf('id')];
		 $sql_req="select max(id) as id,approval_cause from fabric_booking_approval_cause where entry_form=12 and booking_id='$wo_id' and approval_type=2 and status_active=1 and is_deleted=0 group by approval_cause order by id asc ";       
		  $nameArray_req=sql_select($sql_req);
		  foreach($nameArray_req as $rrow)
		  {
			  $approval_cause=$rrow[csf('approval_cause')];
		    
		   // echo "document.getElementById('txt_un_appv_request').value='".str_replace(array("&", "*", "(", ")", "=","'","_","\r", "\n",'"','#'), "", $rrow[csf('approval_cause')])."';\n";

		  }
		  // echo $approval_cause.'DDD';
		  	$un_sql_request="select MAX(id) as id,max(approval_no) as approved_no from fabric_booking_approval_cause where entry_form=12  and booking_id=".$wo_id." and approval_type=2 and status_active=1 and is_deleted=0 order by id desc";// page_id='$menu_id'
		 //echo $un_sql_request;
		$nameArray_un_request=sql_select($un_sql_request);
		$cause_approved_no='';
		foreach($nameArray_un_request as $approw)
		{
			$cause_approved_no=$approw[csf("approved_no")];
		}
		 $max_approved_no=return_field_value("max(approved_no) as max_approved_no", "approval_history", "mst_id='".$wo_id."'  and entry_form=12","max_approved_no");
		 
		if($max_approved_no!=$cause_approved_no)
		{
			$approval_cause='';	
		}
		
		   echo "document.getElementById('txt_un_appv_request').value='".str_replace(array("&", "*", "(", ")", "=","'","_","\r", "\n",'"','#'), "",$approval_cause)."';\n";


		  $sql_cause="select approval_cause from fabric_booking_approval_cause where page_id='413' and entry_form=12 and user_id='$user_id' and booking_id='$wo_id'  and status_active=1 and is_deleted=0 and approval_type='1'";
		  //echo $sql_cause;        
		  $nameArray_cause=sql_select($sql_cause);
		  foreach($nameArray_cause as $rrow)
		  {
		    $refusing_reason=$rrow[csf("approval_cause")];
		    echo "document.getElementById('txt_refusing_cause').value='".str_replace(array("&", "*", "(", ")", "=","'","_","\r", "\n",'"','#'), "", $refusing_reason)."';\n";
		  }
	 }
	 exit();
}

if($action=="populate_details_data_from_for_update")
{
	$data_array=sql_select("select id, pre_cost_fabric_cost_dtls_id, po_break_down_id, fabric_color_id, gmts_color_id, item_size, division_id, gmts_size, dia_width, fin_fab_qnty, process_loss_percent, grey_fab_qnty, rate, amount, rmg_qty, responsible_dept, responsible_person, reason FROM wo_booking_dtls WHERE id ='".$data."' and is_short=1 and status_active=1 and	is_deleted=0");
	foreach ($data_array as $row)
	{
		$colorType=return_field_value( "color_type_id", "wo_pre_cost_fabric_cost_dtls","id='".$row[csf("pre_cost_fabric_cost_dtls_id")]."' and status_active=1 and	is_deleted=0 and color_type_id in (2,3,4,6,31,32,33,34)");
		
		echo "$('#cbo_order_id').val('".$row[csf("po_break_down_id")]."');\n";
		echo "load_drop_down( 'requires/short_fabric_booking_controller', '".$row[csf("po_break_down_id")]."'+'_'+$('#cbo_fabric_natu').val()+'_'+$('#cbo_fabric_source').val()+'_'+$('#cbouom').val(), 'load_drop_down_fabric_description', 'fabricdescription_id_td');\n";
		echo "$('#cbo_fabricdescription_id').val('".$row[csf("pre_cost_fabric_cost_dtls_id")]."');\n";
		echo "$('#cbo_fabricdescription_id').attr('disabled','disabled');\n;";
		
		echo "load_drop_down( 'requires/short_fabric_booking_controller', '".$row[csf("po_break_down_id")].'_'.$row[csf("pre_cost_fabric_cost_dtls_id")]."', 'load_drop_down_gmts_color', 'garmentscolor_id_id_td');\n";
		echo "$('#cbo_garmentscolor_id').val('".$row[csf("gmts_color_id")]."');\n";
		
		echo "load_drop_down( 'requires/short_fabric_booking_controller', '".$row[csf("po_break_down_id")].'_'.$row[csf("pre_cost_fabric_cost_dtls_id")].'_'.$row[csf("gmts_color_id")]."', 'load_drop_down_fabric_color', 'fabriccolor_id_id_td');\n";

		if($row[csf("fabric_color_id")]){
			echo "$('#cbo_fabriccolor_id').val('".$row[csf("fabric_color_id")]."');\n";
		}else{
			echo "$('#cbo_fabriccolor_id').val('0');\n";
		}
		
		echo "load_drop_down( 'requires/short_fabric_booking_controller', '".$row[csf("po_break_down_id")].'_'.$row[csf("pre_cost_fabric_cost_dtls_id")].'_'.$row[csf("gmts_color_id")]."', 'load_drop_down_gmts_size', 'garmentssize_id_td');\n";
		echo "$('#cbo_garmentssize_id').val('".$row[csf("gmts_size")]."');\n";
		
		echo "load_drop_down( 'requires/short_fabric_booking_controller', '".$row[csf("po_break_down_id")].'_'.$row[csf("pre_cost_fabric_cost_dtls_id")].'_'.$row[csf("gmts_color_id")]."', 'load_drop_down_item_size', 'itemsize_id_td');\n";
		echo "$('#cbo_itemsize_id').val('".$row[csf("item_size")]."');\n";
		
		if($colorType!="")
		{
			echo "fncChangeYdButtonShowHide('".$colorType."')\n";
		}
		echo "$('#hidden_colorType').val('".$colorType."');\n";
		
		echo "document.getElementById('txt_dia_width').value = '".$row[csf("dia_width")]."';\n";
		echo "document.getElementById('cbo_division_id').value = '".$row[csf("division_id")]."';\n";
		echo "document.getElementById('txt_finish_qnty').value = '".$row[csf("fin_fab_qnty")]."';\n";
		echo "document.getElementById('txt_process_loss').value = '".$row[csf("process_loss_percent")]."';\n";
		echo "document.getElementById('txt_grey_qnty').value = '".$row[csf("grey_fab_qnty")]."';\n";
		echo "document.getElementById('txt_rate').value = '".$row[csf("rate")]."';\n";
		echo "document.getElementById('txt_amount').value = '".$row[csf("amount")]."';\n";
		echo "document.getElementById('txt_rmg_qty').value = '".$row[csf("rmg_qty")]."';\n";
		echo "set_multiselect('cbo_responsible_dept','0','1','".$row[csf("responsible_dept")]."','0');\n";
		echo "document.getElementById('txt_reason').value = '".$row[csf("reason")]."';\n";
		echo "document.getElementById('cbo_responsible_person').value = '".$row[csf("responsible_person")]."';\n";
		echo "document.getElementById('update_id_details').value = '".$row[csf("id")]."';\n";
		echo "set_button_status(1, '".$_SESSION['page_permission']."', 'fnc_fabric_booking_dtls',2);\n";
		//echo "set_button_status(1, '".$_SESSION['page_permission']."', 'fnc_fabric_booking_dtls',2);\n";
	}
	exit();
}

if($action=="stripe_popup")
{
	echo load_html_head_contents("Popup Info","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
		var permission='<? echo $permission; ?>';
		function add_break_down_set_tr( i )
		{
			var row_num=$('table#tbl_set_details tbody tr').length;
			if (row_num!=i)
			{
				return false;
			}
			if (form_validation('stcolor_'+i+'*measurement_'+i+'*cboorderuom_'+i,'Stripe Color*Measurement*UOM')==false)
			{
				return;
			}
			else
			{
				i++;
				 $("table#tbl_set_details tbody tr:last").clone().find("input,select,a").each(function() {
					$(this).attr({
					  'id': function(_, id) { var id=id.split("_"); return id[0] +"_"+ i },
					  'name': function(_, name) { return name + i },
					  'value': function(_, value) { return value }
					});
				  }).end().appendTo("table#tbl_set_details tbody");
				 // $('#txtsetitemratio_'+i).removeAttr("onChange").attr("onChange","calculate_set_smv("+i+")");
				  $('#measurement_'+i).removeAttr("onChange").attr("onChange","calculate_fidder("+i+")");
				  $('#totfidder_'+i).removeAttr("onChange").attr("onChange","calculate_fidder("+i+")");
				  $('#increaseset_'+i).removeAttr("onClick").attr("onClick","add_break_down_set_tr("+i+")");
				  $('#decreaseset_'+i).removeAttr("onClick").attr("onClick","fn_delete_down_tr("+i+",'tbl_set_details')");
				  $('#stcolor_'+i).val('');
				  $('#measurement_'+i).val('');
				  $('#cboorderuom_'+i).val('');
				  $('#totfidder_'+i).val('');
			}
		}
		
		function fn_delete_down_tr(rowNo,table_id)
		{
			if(table_id=='tbl_set_details')
			{
				var numRow = $('table#tbl_set_details tbody tr').length;
				if(numRow==rowNo && rowNo!=1)
				{
					$('#tbl_set_details tbody tr:last').remove();
					set_sum();
					calculate_fab_req();
				}
			}
		}
		
		function color_select_popup(buyer_name,texbox_id)
		{
			emailwindow=dhtmlmodal.open('EmailBox', 'iframe', 'short_fabric_booking_controller.php?action=color_popup&buyer_name='+buyer_name, 'Color Select Pop Up', 'width=250px,height=300px,center=1,resize=1,scrolling=0','../../')
			emailwindow.onclose=function()
			{
				var theform=this.contentDoc.forms[0];
				var color_name=this.contentDoc.getElementById("color_name");
				if (color_name.value!="")
				{
					$('#'+texbox_id).val(color_name.value);
				}
			}
		}
		
		function calculate_fidder(i){
			set_sum();
			calculate_fab_req();
		}
		
		function set_sum()
		{
			var tottalmeasurement=0; var totaltotfidder=0;
			var row_num=$('table#tbl_set_details tbody tr').length;
			for (var i=1; i<=row_num; i++)
			{
				var measurement=document.getElementById('measurement_'+i).value*1;
				var totfidder=document.getElementById('totfidder_'+i).value*1;
				tottalmeasurement+=measurement;
				totaltotfidder+=totfidder;
			}
			
			if(tottalmeasurement>0) document.getElementById('tottalmeasurement').value=number_format_common(tottalmeasurement,5,0);
			else document.getElementById('tottalmeasurement').value='';
			
			if(totaltotfidder>0) document.getElementById('totaltotfidder').value=number_format_common(totaltotfidder,5,0);
			else document.getElementById('totaltotfidder').value='';
		}
		
		function calculate_fab_req()
		{
			var TotalGreyreq=document.getElementById('TotalGreyreq').value*1;
			var totaltotfidder=document.getElementById('totaltotfidder').value*1;
			var tottalmeasurement=document.getElementById('tottalmeasurement').value*1;
			var row_num=$('table#tbl_set_details tbody tr').length;
			var totalfabreq=0;
			for (var i=1; i<=row_num; i++)
			{
				var measurement=document.getElementById('measurement_'+i).value*1;
				var fabreq=0; var fabreqtotkg=0;
				if(measurement>0){
					fabreq=(measurement/tottalmeasurement)*TotalGreyreq;
					totalfabreq+=fabreq;
					fabreqtotkg=(TotalGreyreq/tottalmeasurement)*measurement;
		
				}else{
					var totfidder=document.getElementById('totfidder_'+i).value*1;
					fabreq=(totfidder/totaltotfidder)*TotalGreyreq;
					totalfabreq+=fabreq;
					fabreqtotkg=(TotalGreyreq/totaltotfidder)*totfidder;
				}
				document.getElementById('fabreq_'+i).value=number_format_common(fabreq,5,0);
				document.getElementById('fabreqtotkg_'+i).value=number_format_common(fabreqtotkg,5,0);
			}
			if(totalfabreq>0) document.getElementById('totalfabreq').value=number_format_common(totalfabreq,5,0);
			else document.getElementById('totalfabreq').value='';
		}
		
		function fnc_stripe_color( operation )
		{
			if(operation==2)
			{
				alert("Delete Restricted")
				return;
			}
			var row_num=$('table#tbl_set_details tbody tr').length;
			var data_all="";
			for (var i=1; i<=row_num; i++)
			{
				if (form_validation('stcolor_'+i+'*measurement_'+i+'*cboorderuom_'+i,'Stripe Color*Measurement*UOM')==false)
				{
					return;
				}
				data_all=data_all+get_submitted_data_string('txt_job_no*hidd_booking_no*hidd_dtls_id*fabric_cost_id*hidd_fabriccolor*hidd_gmtscolor*stcolor_'+i+'*measurement_'+i+'*cboorderuom_'+i+'*totfidder_'+i+'*fabreq_'+i+'*fabreqtotkg_'+i+'*yarndyed_'+i,"../../../",i);
			}
	
			var data="action=save_update_delete_stripe&operation="+operation+'&total_row='+row_num+data_all;
			//alert(data);
			freeze_window(operation);
			http.open("POST","short_fabric_booking_controller.php",true);
			http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
			http.send(data);
			http.onreadystatechange = fnc_stripe_color_reponse;
		}
		
		function fnc_stripe_color_reponse()
		{
			if(http.readyState == 4)
			{
				var reponse=trim(http.responseText).split('**');
				if (reponse[0].length>2) reponse[0]=10;
				release_freezing();
				if(reponse[0]==0 || reponse[0]==1)
				{
					parent.emailwindow.hide();
				}
			}
		}
	
	</script>
	</head>
	<body>
	<div align="center" style="width:100%;" >
	 <div style="display:none"><? echo load_freeze_divs ("../../../",$permission); ?></div>
	 <?
		$costing_per_arr=return_library_array( "select job_no,costing_per from wo_pre_cost_mst where  job_no='$txt_job_no'", "job_no", "costing_per");
		$color_library=return_library_array( "select id,color_name from lib_color where status_active =1 and is_deleted=0", "id", "color_name"  );
		
		if($fabriccolor_id==0 || $fabriccolor_id=="") $disfabriccolor_id=$garmentscolor_id; else $disfabriccolor_id=$fabriccolor_id;
	
		//echo $color_type_id;
	?>
    <table width="460" cellspacing="0" class="rpt_table" border="1" rules="all">
        <tr>
            <td width="150">Gray Fabric Qty.</td>
            <td width="150" align="right">
                <input type="hidden" id="TotalGreyreq" value="<?=$grey_qnty;?> "/>
                <?=number_format($grey_qnty,4); ?>&nbsp;
            </td>
            <td width="60">Kg</td>
        </tr>
        <tr>
            <td width="150">Fabric Desc</td>
            <td width="150" colspan="2"><?=$fabdesc; ?></td>
        </tr>
        <tr>
            <td width="150">Body Color</td>
            <td width="150" colspan="2"><?=$color_library[$disfabriccolor_id]; ?></td>
        </tr>
    </table>
	 <br/>
	 <input type="hidden" id="txt_job_no" name="txt_job_no" style="width:80px" class="text_boxes" value="<?=$txt_job_no; ?>"/>
	 <input type="hidden" id="hidd_dtls_id" name="hidd_dtls_id" style="width:80px" class="text_boxes" value="<?=$dtls_id; ?>"/>
	 <input type="hidden" id="hidd_booking_no" name="hidd_booking_no" style="width:80px" class="text_boxes" value="<?=$txt_booking_no; ?>"/>
	 <input type="hidden" id="fabric_cost_id" name="fabric_cost_id" style="width:80px" class="text_boxes" value="<?=$fabric_cost_id; ?>"/>
	 <input type="hidden" id="hidd_fabriccolor" name="hidd_fabriccolor" style="width:80px" class="text_boxes" value="<?=$fabriccolor_id; ?>"/>
     <input type="hidden" id="hidd_gmtscolor" name="hidd_gmtscolor" style="width:80px" class="text_boxes" value="<?=$garmentscolor_id; ?>"/>
	 <table width="680" cellspacing="0" class="rpt_table" border="0" id="tbl_set_details" rules="all">
		<thead>
			<tr>
				<th width="150">Stripe Color</th>
				<th width="80">Measurement</th>
				<th width="60">UOM</th>
				<th width="80">Total Feeder</th>
				<th width="70">Fab Req. Qty (KG)</th>
				<th width="70">Yarn Dyed</th>
				<th>&nbsp;</th>
			</tr>
		</thead>
		<tbody>
		<?
		$color_from_library=return_field_value("color_from_library", "variable_order_tracking", "company_name=$company_name  and variable_list=23  and status_active=1 and is_deleted=0");
		if($color_from_library==1)
		{
		   $readonly="readonly='readonly'";
		   $plachoder="placeholder='Click'";
		   $onClick="onClick='color_select_popup($cbo_buyer_name,this.id)'";
		}
		else
		{
		   $readonly=""; $plachoder=""; $onClick="";
		}
		$save_update=1;
		$sql_data=sql_select("select stripe_color, measurement, uom, totfidder, fabreq, fabreqtotkg, yarn_dyed from wo_short_stripe_color where fabric_cost_dtls_id=$fabric_cost_id and gmts_color_id=$garmentscolor_id");
		if(count($sql_data)>0)
		{
			$i=1;
			$totmeasurement=0; $totfidder=0; $fabreq=0;
			foreach($sql_data as $row)
			{
				$totmeasurement+=$row[csf('measurement')]; $totfidder+=$row[csf('totfidder')]; $fabreq+=$row[csf('fabreq')];
				?>
				<tr>
                    <th><input type="text" id="stcolor_<? echo $i; ?>" name="stcolor_<? echo $i; ?>" style="width:140px" class="text_boxes" value="<? echo $color_library[$row[csf('stripe_color')]]; ?>" <? echo $onClick." ".$readonly." ".$plachoder; ?> /></th>
                    <th><input type="text" id="measurement_<? echo $i; ?>" name="measurement_<? echo $i; ?>" style="width:70px" class="text_boxes_numeric" value="<? echo $row[csf('measurement')]; ?>" onChange="calculate_fidder(<? echo $i;?>);"/></th>
                    <th><? echo create_drop_down( "cboorderuom_".$i,60, $unit_of_measurement, "",1, "-Select-", $row[csf('uom')],"","","25,26,29,79" ); ?></th>
                    <th><input type="text" id="totfidder_<? echo $i; ?>" name="totfidder_<? echo $i; ?>" style="width:70px" class="text_boxes_numeric" value="<? echo $row[csf('totfidder')]; ?>" onChange="calculate_fidder(<? echo $i;?>);"/></th>
                    <th>
                        <input type="text" id="fabreq_<? echo $i; ?>" name="fabreq_<? echo $i; ?>" style="width:70px" class="text_boxes_numeric" value="<? echo $row[csf('fabreq')]; ?>" readonly/>
                        <input type="hidden" id="fabreqtotkg_<? echo $i; ?>" name="fabreqtotkg_<? echo $i; ?>" style="width:70px" class="text_boxes_numeric" value="<? echo $row[csf('fabreqtotkg')]; ?>" readonly/>
                    </th>
                    <th><? echo create_drop_down( "yarndyed_".$i,60, $yes_no, "",0, "", $row[csf('yarn_dyed')],"","","" ); ?></th>
                    <th>
                    <?
                    if($color_type_id !=6 && $color_type_id !=31 && $color_type_id !=32){
						?>
						<input type="button" id="increaseset_<? echo $i; ?>" style="width:30px" class="formbutton" value="+" onClick="add_break_down_set_tr(<? echo $i; ?>)" />
						<input type="button" id="decreaseset_<? echo $i; ?>" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_delete_down_tr(<? echo $i; ?> ,'tbl_set_details' );" />
						<?
                    }
                    ?>
                    </th>
				</tr>
				<?
				$i++;
			}
		}
		else
		{
			$save_update=0;
			if($color_type_id ==6 || $color_type_id ==31 || $color_type_id ==32){
				$color=$color_library[$fabric_color[$cbo_color_name]];
				$dis="disabled";
			}else{
				$color=""; $dis="";
			}
			?>
			<tr>
                <th><input type="text" id="stcolor_1" name="stcolor_1" style="width:150px" class="text_boxes" <? echo $onClick." ".$readonly." ".$plachoder." ".$dis; ?> value="<? echo $color;  ?>"/></th>
                <th><input type="text" id="measurement_1" name="measurement_1" style="width:70px" class="text_boxes_numeric" onChange="calculate_fidder(<? echo $i;?>)"/> </th>
                <th><? echo create_drop_down( "cboorderuom_1",60, $unit_of_measurement, "",0, "", 25, "","","25,26,29,79" ); ?></th>
                <th><input type="text" id="totfidder_1" name="totfidder_1" style="width:80px" class="text_boxes_numeric"/> </th>
                <th>
                    <input type="text" id="fabreq_1" name="fabreq_1" style="width:70px" class="text_boxes_numeric" readonly/>
                    <input type="hidden" id="fabreqtotkg_1" name="fabreqtotkg_1" style="width:70px" class="text_boxes_numeric" readonly/>
                </th>
                <th><? echo create_drop_down( "yarndyed_1",60, $yes_no, "",0, "", "","","","" ); ?></th>
                <th>
                <?
                if($color_type_id !=6 && $color_type_id !=31 && $color_type_id !=32){
					?>
					<input type="button" id="increaseset_1" style="width:30px" class="formbutton" value="+" onClick="add_break_down_set_tr(1)" />
					<input type="button" id="decreaseset_1" style="width:30px" class="formbutton" value="-" onClick="javascript:fn_delete_down_tr(1 ,'tbl_set_details' );" />
					<?
                }
                ?>
                </th>
			</tr>
			<?
	   }
	   ?>
        </tbody>
        <tfoot>
            <tr>
                <th style=" width:150px">&nbsp;</th>
                <th><input type="text" id="tottalmeasurement" name="tottalmeasurement" style="width:70px" class="text_boxes_numeric" value="<? echo number_format($totmeasurement,4); ?>" readonly/> </th>
                <th style="width:80px"></th>
                <th><input type="text" id="totaltotfidder" name="totaltotfidder" style="width:80px" class="text_boxes_numeric" value="<? echo number_format($totfidder,4); ?>" readonly/> </th>
                <th><input type="text" id="totalfabreq" name="totalfabreq" style="width:70px" class="text_boxes_numeric" value="<? echo number_format($fabreq,4); ?>" readonly/></th>
                <th style=" width:70px">&nbsp;</th>
                <th>&nbsp;</th>
            </tr>
            <tr>
                <td align="center" valign="middle" class="button_container" colspan="8">
                <?
                if(count($sql_data)>0)
                {
                    echo load_submit_buttons( $permission, "fnc_stripe_color", 1,0 ,"",1,1) ;
                }
                else
                {
                    echo load_submit_buttons( $permission, "fnc_stripe_color", 0,0 ,"",1,1) ;
                }
                ?>
                </td>
            </tr>
        </tfoot>
	</table>
	</div>
	</body>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</html>
	<?
	exit();
}

if($action=="color_popup")
{
	echo load_html_head_contents("Color Pop-Up","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	?>
	<script>
		function js_set_value(data)
		{
			document.getElementById('color_name').value=data;
			parent.emailwindow.hide();
		}
	</script>
	</head>
	<body>
        <div align="center">
        <form>
            <input type="hidden" id="color_name" name="color_name" />
            <?
            if($buyer_name=="" || $buyer_name==0)
            {
            	$sql="select color_name,id FROM lib_color  WHERE status_active=1 and is_deleted=0";
            }
            else
            {
            	$sql="select a.color_name,a.id FROM lib_color a, lib_color_tag_buyer b  WHERE a.id=b.color_id and b.buyer_id=$buyer_name and  status_active=1 and is_deleted=0";
            }
            echo  create_list_view("list_view", "Color Name", "160","210","420",0, $sql , "js_set_value", "color_name", "", 1, "0", $arr , "color_name", "requires/sample_booking_non_order_controller",'setFilterGrid("list_view",-1);','0,0,0,0,0,0,0,0,0,0,0,0,0,2,2,2,2,2') ;
            ?>
        </form>
        </div>
	</body>
	</html>
	<?
	exit();
}

if($action=="save_update_delete_stripe")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$color_library=return_library_array( "select id,color_name from lib_color where status_active =1 and is_deleted=0", "id", "color_name");
	if ($operation==0)
	{
		$con = connect();
		if($db_type==0){
			mysql_query("BEGIN");
		}
	
		if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0"; disconnect($con); die;}
		$new_array_color=array();
		$id=return_next_id( "id", "wo_short_stripe_color", 1 ) ;
		$field_array="id, job_no, booking_no, dtls_id, fabric_cost_dtls_id, gmts_color_id, fabric_color_id, stripe_color, measurement, uom, totfidder, fabreq, fabreqtotkg, yarn_dyed, inserted_by, insert_date, status_active, is_deleted";
		for ($i=1;$i<=$total_row;$i++)
		{
			$stcolor="stcolor_".$i;
			$measurement="measurement_".$i;
			$cboorderuom="cboorderuom_".$i;
			$fabreqtotkg="fabreqtotkg_".$i;
			$totfidder="totfidder_".$i;
			$fabreq="fabreq_".$i;
			$yarndyed="yarndyed_".$i;
			
			if(str_replace("'","",$$stcolor)!="")
			{
				if (!in_array(str_replace("'","",$$stcolor),$new_array_color))
				{
					$color_id = return_id( str_replace("'","",$$stcolor), $color_library, "lib_color", "id,color_name","88");
					$new_array_color[$color_id]=str_replace("'","",$$stcolor);
				}
				else $color_id = array_search(str_replace("'","",$$stcolor), $new_array_color);
			} 
			else $color_id=0;
		
			if ($i!=1) $data_array .=",";
			$data_array .="(".$id.",".$txt_job_no.",".$hidd_booking_no.",".$hidd_dtls_id.",".$fabric_cost_id.",".$hidd_gmtscolor.",".$hidd_fabriccolor.",".$color_id.",".$$measurement.",".$$cboorderuom.",".$$totfidder.",".$$fabreq.",".$$fabreqtotkg.",".$$yarndyed.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
			$id=$id+1;
		}
		$rID=sql_insert("wo_short_stripe_color",$field_array,$data_array,1);
		check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0){
			if($rID ){
				mysql_query("COMMIT");
				echo "0";
			}
			else{
				mysql_query("ROLLBACK");
				echo "10";
			}
		}
		else if($db_type==2 || $db_type==1 ){
			if($rID ){
				oci_commit($con);
				echo "0";
			}
			else{
				oci_rollback($con);
				echo "10";
			}
		}
		disconnect($con);
		die;
	}
	else if ($operation==1)  // Insert Here
	{
		 $con = connect();
		 if($db_type==0)
		 {
			mysql_query("BEGIN");
		 }

		 if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0";  disconnect($con);die;}
		 $new_array_color=array();
		 $id=return_next_id( "id", "wo_short_stripe_color", 1 ) ;
		$field_array="id, job_no, booking_no, dtls_id, fabric_cost_dtls_id, gmts_color_id, fabric_color_id, stripe_color, measurement, uom, totfidder, fabreq, fabreqtotkg, yarn_dyed, inserted_by, insert_date, status_active, is_deleted";
		 for ($i=1;$i<=$total_row;$i++)
		 {
			$stcolor="stcolor_".$i;
			$measurement="measurement_".$i;
			$cboorderuom="cboorderuom_".$i;
			$fabreqtotkg="fabreqtotkg_".$i;
			$totfidder="totfidder_".$i;
			$fabreq="fabreq_".$i;
			$yarndyed="yarndyed_".$i;

			if(str_replace("'","",$$stcolor)!="")
			{
				if (!in_array(str_replace("'","",$$stcolor),$new_array_color))
				{
					$color_id = return_id( str_replace("'","",$$stcolor), $color_library, "lib_color", "id,color_name","88");
					$new_array_color[$color_id]=str_replace("'","",$$stcolor);
				}
				else $color_id =  array_search(str_replace("'","",$$stcolor), $new_array_color);
			} 
			else $color_id=0;
			
			if ($i!=1) $data_array .=",";
			$data_array .="(".$id.",".$txt_job_no.",".$hidd_booking_no.",".$hidd_dtls_id.",".$fabric_cost_id.",".$hidd_gmtscolor.",".$hidd_fabriccolor.",".$color_id.",".$$measurement.",".$$cboorderuom.",".$$totfidder.",".$$fabreq.",".$$fabreqtotkg.",".$$yarndyed.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
			$id=$id+1;
		 }
		 $rID_de3=execute_query( "delete from wo_short_stripe_color where  fabric_cost_dtls_id =".$fabric_cost_id." and gmts_color_id=$hidd_gmtscolor",0);
		 $rID=sql_insert("wo_short_stripe_color",$field_array,$data_array,1);
		 check_table_status( $_SESSION['menu_id'],0);
		 if($db_type==0)
		 {
			if($rID ){
				mysql_query("COMMIT");
				echo "1";
			}
			else{
				mysql_query("ROLLBACK");
				echo "10";
			}
		 }
		 else if($db_type==2 || $db_type==1 )
		 {
			if($rID ){
				oci_commit($con);
				echo "1";
			}
			else{
				oci_rollback($con);
				echo "10";
			}
		 }
		disconnect($con);
		die;
	}
}

if($action=="delete_row")
{
	$data=explode("_",$data);
/*	$yarn_booking=0;
	$yarn_booking_sql=sql_select("select id from wo_yarn_dyeing_dtls where job_no ='$data[2]' and status_active=1 and is_deleted=0");
	foreach($yarn_booking_sql as $yarn_booking_row){
		$yarn_booking=$yarn_booking_row[csf('id')];
	}
	if($yarn_booking>0){
		echo 11;
		die;
	}
*/	$con = connect();
	if($db_type==0){
		mysql_query("BEGIN");
	}
	$rID_de3=execute_query( "delete from wo_short_stripe_color where  fabric_cost_dtls_id =".$data[0]." and gmts_color_id=$data[1]",0);
	if($db_type==0){
		if($rID_de3){
			mysql_query("COMMIT");
			echo 1;
		}
		else{
			mysql_query("ROLLBACK");
			echo 10;
		}
	}
	else if($db_type==2 || $db_type==1 ){
		if($rID_de3){
			oci_commit($con);
			echo 1;
		}
		else{
			oci_rollback($con);
			echo 10;
		}
	}
	disconnect($con);
}


if($action=="print_booking_3")
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' or form_name='knit_order_entry'  and file_type=1",'master_tble_id','image_location');

	$company_library=return_library_array( "select id,company_name from lib_company", "id", "company_name");
	$color_library=return_library_array( "select id,color_name from lib_color where status_active =1 and is_deleted=0", "id", "color_name");
	$size_library=return_library_array( "select id,size_name from lib_size where status_active =1 and is_deleted=0", "id", "size_name");
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from   lib_supplier",'id','supplier_name');

	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');

	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	$season_arr=return_library_array("select id,season_name from lib_buyer_season","id","season_name");
	
	$uom=0;
	$joball=array();
	$nameArray_per_job=sql_select( "SELECT a.job_no,a.style_ref_no  from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by a.job_no,a.style_ref_no");
	foreach ($nameArray_per_job as $row_per_job){
	$joball['job_no'][$row_per_job[csf('job_no')]]=$row_per_job[csf('job_no')];
	$joball['style_ref_no'][$row_per_job[csf('job_no')]]=$row_per_job[csf('style_ref_no')];

	$uom=0;
	$job_data_arr=array();
	$nameArray_buyer=sql_select( "SELECT a.style_ref_no, a.style_description, a.job_no, a.style_owner, a.buyer_name, b.responsible_dept, b.responsible_person, b.reason, a.team_leader, a.dealing_marchant, a.season, a.season_matrix, a.season_buyer_wise, a.total_set_qnty, a.product_dept, a.product_code, a.pro_sub_dep, a.gmts_item_id, a.order_repeat_no, a.qlty_label  from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0 and a.job_no='".$row_per_job[csf('job_no')]."'");
	foreach ($nameArray_buyer as $result_buy){
	$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
	$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
	$job_data_arr['total_set_qnty'][$result_buy[csf('job_no')]]=$result_buy[csf('total_set_qnty')];
	$job_data_arr['product_dept'][$result_buy[csf('job_no')]]=$product_dept[$result_buy[csf('product_dept')]];
	$job_data_arr['product_code'][$result_buy[csf('job_no')]]=$result_buy[csf('product_code')];
	$job_data_arr['pro_sub_dep'][$result_buy[csf('job_no')]]=$pro_sub_dept_array[$result_buy[csf('pro_sub_dep')]];
	$job_data_arr['gmts_item_id'][$result_buy[csf('job_no')]]=$result_buy[csf('gmts_item_id')];
	$job_data_arr['style_ref_no'][$result_buy[csf('job_no')]]=$result_buy[csf('style_ref_no')];
	$job_data_arr['style_description'][$result_buy[csf('job_no')]]=$result_buy[csf('style_description')];
	$job_data_arr['dealing_marchant'][$result_buy[csf('job_no')]]=$marchentrArr[$result_buy[csf('dealing_marchant')]];
	$job_data_arr['season_matrix'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_matrix')]];
	$job_data_arr['season_buyer_wise'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_buyer_wise')]];
	$job_data_arr['order_repeat_no'][$result_buy[csf('job_no')]]=$result_buy[csf('order_repeat_no')];
	$job_data_arr['qlty_label'][$result_buy[csf('job_no')]]=$quality_label[$result_buy[csf('qlty_label')]];

	$job_data_arr['responsible_person'][$result_buy[csf('responsible_person')]]=$result_buy[csf('responsible_person')];
	$job_data_arr['responsible_dept'][$result_buy[csf('responsible_dept')]]=$result_buy[csf('responsible_dept')];
	$job_data_arr['reason'][$result_buy[csf('reason')]]=$result_buy[csf('reason')];
	}
   
	$job_no= implode(",",array_unique($job_data_arr['job_no']));
	$job_no_in= implode(",",array_unique($job_data_arr['job_no_in']));
	$product_depertment=implode(",",array_unique($job_data_arr['product_dept']));
	$product_code=implode(",",array_unique($job_data_arr['product_code']));
	$pro_sub_dep=implode(",",array_unique($job_data_arr['pro_sub_dep']));
	$gmts_item_id=implode(",",array_unique($job_data_arr['gmts_item_id']));
	$style_sting=implode(",",array_unique($job_data_arr['style_ref_no']));
	$style_description=implode(",",array_unique($job_data_arr['style_description']));
	$dealing_marchant=implode(",",array_unique($job_data_arr['dealing_marchant']));
	$season_matrix=implode(",",array_unique($job_data_arr['season_matrix']));
	$season_buyer_wise=implode(",",array_unique($job_data_arr['season_buyer_wise']));
	$order_repeat_no= implode(",",array_unique($job_data_arr['order_repeat_no']));
	$qlty_label= implode(",",array_unique($job_data_arr['qlty_label']));
	
	
	?>
    <style>
		@media print {
			.gg {page-break-after: always;}
		}


		@media print
		{
			.page-break { height:0; page-break-before:always; margin:0; border-top:none; }
		}

		body, p, span, td, a {font-size:10pt;font-family: Arial;}
		body{margin-left:2em; margin-right:2em; font-family: "Arial Narrow", Arial, sans-serif;}
		.page{
		height:947px;
		padding-top:5px;
		page-break-after : always;
		font-family: Arial, Helvetica, sans-serif;
		position:relative;
		border-bottom:1px solid #000;
		}
	</style>
	<div style="width:1330px" align="center">

	<?php
	$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12 and a.status_active =1 and a.is_deleted=0");
	list($nameArray_approved_row) = $nameArray_approved;
	$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
	list($nameArray_approved_date_row) = $nameArray_approved_date;
	$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
	list($nameArray_approved_comments_row) = $nameArray_approved_comments;
	$path = str_replace("'", "", $path);
	if ($path != "") {
		$path = $path;
	} else {
		$path = "../../";
	}

	?>										<!--    Header Company Information         -->
		<table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black" >
		<tr>
		<td width="100">
		<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
		</td>
		<td width="1250">
		<table width="100%" cellpadding="0" cellspacing="0"  >
		<tr>
		<td align="center">
		<?php
	echo $company_library[$cbo_company_name];
	?>
	</td>
	<td rowspan="3" width="250">

	<span><b> Job No:&nbsp;&nbsp;<? echo trim($job_no,"'"); ?></b></span><br/>
	<?
	if($nameArray_approved_row[csf('approved_no')]>1)
	{
	?>
	<b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
	<br/>
	Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
	<?
	}
	?>


	</td>
	</tr>
	<tr>
	<td align="center">
	<?
	$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
	if($txt_job_no!="")
	{
		$location=return_field_value( "location_name", "wo_po_details_master","job_no=$txt_job_no");
	}
	else
	{
		$location="";
	}

	foreach ($nameArray as $result)
	{
		echo  $location_name_arr[$location];
		?>
		Email Address: <? echo $result[csf('email')];?>
		Website No: <? echo $result[csf('website')]; ?>
		<?
	}
	?>
	</td>
	</tr>
	<tr>
	<td align="center">
	<strong><? if($report_title !=""){ echo $report_title;} else { echo "General Work Order";}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
	</td>
	</tr>
	</table>
	</td>
	</tr>
	</table>
	<?
	$po_data=array();
	if($db_type==0){
	$nameArray_job=sql_select( "select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,DATEDIFF(pub_shipment_date,po_received_date) date_diff,MIN(po_received_date) as po_received_date ,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status  from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no='".$row_per_job[csf('job_no')]."'  group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
	}
	if($db_type==2){
	$nameArray_job=sql_select( "select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,(pub_shipment_date-po_received_date) date_diff,MIN(po_received_date) as po_received_date,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status   from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no='".$row_per_job[csf('job_no')]."' group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
	}
	foreach ($nameArray_job as $result_job){
		$po_data['po_id'][$result_job[csf('id')]]=$result_job[csf('id')];
		$po_data['po_number'][$result_job[csf('id')]]=$result_job[csf('po_number')];
		$po_data['leadtime'][$result_job[csf('id')]]=$result_job[csf('date_diff')];
		$po_data['po_quantity'][$result_job[csf('id')]]=$result_job[csf('po_quantity')];
		$po_data['po_received_date'][$result_job[csf('id')]]=change_date_format($result_job[csf('po_received_date')],'dd-mm-yyyy','-');
		$ddd=strtotime($result_job[csf('pub_shipment_date')]);
		$po_data['pub_shipment_date'][$ddd]=$ddd;

		$po_data['insert_date'][$result_job[csf('id')]]=$result_job[csf('insert_date')];

		if($result_job[csf('shiping_status')]==1){
		$shiping_status= "FP";
		}
		else if($result_job[csf('shiping_status')]==2){
		$shiping_status= "PS";
		}
		else if($result_job[csf('shiping_status')]==3){
		$shiping_status= "FS";
		}
		$po_data['shiping_status'][$result_job[csf('id')]]=$shiping_status;
		$po_data['file_no'][$result_job[csf('id')]]=$result_job[csf('file_no')];
		$po_data['grouping'][$result_job[csf('id')]]=$result_job[csf('grouping')];
	}
	$txt_order_no_id=implode(",",array_unique($po_data['po_id']));
	$leadtime=implode(",",array_unique($po_data['leadtime']));
	$po_quantity=array_sum($po_data['po_quantity']);
	$po_received_date=implode(",",array_unique($po_data['po_received_date']));
	$po_number=implode(",",array_unique($po_data['po_number']));
	$shipment_date=date('d-m-Y',min($po_data['pub_shipment_date']));
	$maxshipment_date=date('d-m-Y',max($po_data['pub_shipment_date']));
	//$shipment_date=implode(",",array_unique($po_data['pub_shipment_date']));
	$shiping_status=implode(",",array_unique($po_data['shiping_status']));
	$file_no=implode(",",array_unique($po_data['file_no']));
	$grouping=implode(",",array_unique($po_data['grouping']));


	$colar_excess_percent=0; $cuff_excess_percent=0; $rmg_process_breakdown=$buyer_id=0;
	$nameArray=sql_select( "SELECT  a.INSERTED_BY,a.buyer_id, a.booking_no, a.booking_date, a.supplier_id, a.currency_id, a.exchange_rate, a.attention, a.delivery_date, a.po_break_down_id, a.colar_excess_percent, a.cuff_excess_percent, a.delivery_date, a.is_apply_last_update, a.fabric_source, a.rmg_process_breakdown, a.insert_date, a.update_date, a.uom, a.remarks, a.pay_mode, a.main_booking_no, a.fabric_composition, a.inserted_by from wo_booking_mst a where a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0");

	

	$inserted_by=$nameArray[0]['INSERTED_BY'];
	foreach ($nameArray as $result)
	{
		$buyer_id=$result[csf('buyer_id')];
		$total_set_qnty=$result[csf('total_set_qnty')];
		//$INSERTED_BY=$result[csf('INSERTED_BY')];
		$colar_excess_percent=$result[csf('colar_excess_percent')];
		$cuff_excess_percent=$result[csf('cuff_excess_percent')];
		$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
		foreach ($po_data['po_id'] as $po_id=>$po_val){
			$daysInHand.=(datediff('d',date('d-m-Y',time()),$po_data['pub_shipment_date'][$po_id])-1).",";
			$booking_date=$result[csf('update_date')];
			if($booking_date=="" || $booking_date=="0000-00-00 00:00:00"){
			$booking_date=$result[csf('insert_date')];
			}
			$WOPreparedAfter.=(datediff('d',$po_data['insert_date'][$po_id],$booking_date)-1).",";
		}
	?>
	<table width="100%" style="border:1px solid black;table-layout: fixed;" >
	<tr>
	<td colspan="6" valign="top" style="color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
	</tr>
	<tr>
	<td width="200"><span><b>Buyer/Agent Name</b></span></td>
	<td width="220">:&nbsp;<span><b><? echo $buyer_name_arr[$result[csf('buyer_id')]]; ?></b></span></td>
	<td width="200"><span><b>Dept.</b></span></td>
	<td width="220">:&nbsp;
	<?
	echo $product_depertment ;
	if($product_code !=""){
	echo " (".$product_code.")";
	}
	if($pro_sub_dep != ""){
	echo " (".$pro_sub_dep.")";
	}
	?>
	</td>
	<td width="200"><span><b>Order Qnty</b></span></td>
	<td>:&nbsp; <?  echo $po_quantity;//." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?> </td>
	</tr>
	<tr>

	<td><b>Garments Item</b></td>
	<td>:&nbsp;
	<?
	$gmts_item_name="";
	$gmts_item=explode(',',$gmts_item_id);
	for($g=0;$g<=count($gmts_item); $g++)
	{
	$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
	}
	echo rtrim($gmts_item_name,',');
	?>
	</td>
	<td><b>Booking Release Date</b></td>
	<td>:&nbsp;
	<?
	$booking_date=$result[csf('update_date')];
	if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
	{
	$booking_date=$result[csf('insert_date')];
	}
	echo change_date_format($booking_date,'dd-mm-yyyy','-','');
	?>&nbsp;&nbsp;&nbsp;</td>
	<td><b>Style Ref.</b>   </td>
	<td>:&nbsp;<b>
	<?
	echo $style_sting;
	?>
	</b>
	</td>
	</tr>
	<tr>
	<td><b>Style Des.</b></td>
	<td>:&nbsp;<? echo $style_description;?></td>
	<td><b>Season</b></td>
	<td>:&nbsp;<? if($season_matrix!='') echo $season_matrix;else echo $season_buyer_wise; ?></td>
	<td><b>Dealing Merchandiser</b></td>
	<td>:&nbsp;<? echo $dealing_marchant; ?></td>
	</tr>

	<tr>
	<td><b>Supplier Name</b>   </td>
	<td>:&nbsp;
	<?
	if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3){
	echo $company_library[$result[csf('supplier_id')]];
	}
	else{
	echo $supplier_name_arr[$result[csf('supplier_id')]];
	}
	?>    </td>
	<td><b>Delivery Date</b></td>
	<td>:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
	<td style="font-size:14px"><b>Booking No </b>   </td>
	<td style="font-size:15px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?> <? //echo "(".$unit_of_measurement[$result[csf('uom')]].")"; $uom=$result[csf('uom')];?></td>
	</tr>
	<tr>
	<td><b>Attention</b></td>
	<td  >:&nbsp;<? echo $result[csf('attention')]; ?></td>
	<td><b>Lead Time </b>   </td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;">:&nbsp;
	<?
	echo $leadtime;
	?>
	</td>
	<td><b>Po Received Date</b></td>
	<td  >:&nbsp;<? echo $po_received_date; ?></td>
	</tr>
	<tr>
	<td><b>Order No</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;" colspan="3">:&nbsp;<? echo $po_number; ?></td>
	<td><b>Repeat No</b></td>
	<td  >:&nbsp;<? echo $order_repeat_no; ?></td>
	</tr>
	<tr>
	<td><b>Shipment Date</b></td>
<td colspan="3" style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> : First:&nbsp;<? echo rtrim($shipment_date,", "); //echo $max_pub_shipment_date; ?>, Last: <? echo $maxshipment_date; ?></td>
	<td><b>Quality Label</b></td>
	<td  >:&nbsp;<? echo $qlty_label; ?></td>
	</tr>
	</tr>
	<tr>
	<td><b>WO Prepared After</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
	<?
	$WOPreparedAfter=implode(",",array_unique(explode(",",chop($WOPreparedAfter,","))));
	echo $WOPreparedAfter.' Days' ;
	?></td>
 	<td><b>Ex-factory status</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
	<?
	echo $shiping_status;
	?></td>

	<td><b>Internal Ref No</b></td>
	<td> :&nbsp;<b><? echo $grouping; ?></b></td>



	</tr>
	<tr>

	<td><b>File no</b></td>
	<td> :&nbsp;<b><? echo  $file_no;?></b></td>
	<td><b>Currency</b></td>
	<td> :&nbsp;<b><? echo  $currency[$result[csf("currency_id")]];?></b></td>

	<td><b>Remarks</b></td>
	<td> :<? echo $result[csf('remarks')]?></td>


	</tr>

	<tr>
    <td><b>F.Main Booking No</b></td>
	<td> :<? echo $result[csf('main_booking_no')]?></td>
	<td><b>Fabric Composition</b></td>
	<td colspan="3"> :<? echo $result[csf('fabric_composition')]?></td>
    
	</tr>

	</table>
	<?
	}
	
	$shippingmark_data=explode("~!~",$shippingmark_breck_down);
	$shippingmark_str="<b>".$shippingmark_data[0]."</b><br>".$shippingmark_data[1]."<br>".$shippingmark_data[2]."<br>".$shippingmark_data[3]."<br>".$shippingmark_data[4]."<br>".$shippingmark_data[5];


	?>
	<br/>
	<!--  Here will be the main portion  -->
	<?
	$costing_per="";
	$costing_per_qnty=0;
	$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no in($job_no_in)");
	if($costing_per_id==1)
	{
	$costing_per="1 Dzn";
	$costing_per_qnty=12;

	}
	if($costing_per_id==2)
	{
	$costing_per="1 Pcs";
	$costing_per_qnty=1;

	}
	if($costing_per_id==3)
	{
	$costing_per="2 Dzn";
	$costing_per_qnty=24;

	}
	if($costing_per_id==4)
	{
	$costing_per="3 Dzn";
	$costing_per_qnty=36;

	}
	if($costing_per_id==5)
	{
	$costing_per="4 Dzn";
	$costing_per_qnty=48;
	}
	$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no in($job_no_in)");
 	$uom_arr=array(1=>"Pcs",12=>"Kg",23=>"Mtr",27=>"Yds");
	$p=1;
	/*foreach($uom_arr as $uom_id=>$uom_val)
	{ */
	if($cbo_fabric_source==1 or $cbo_fabric_source==2){
	$nameArray_fabric_description= sql_select("select a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , d.dia_width,d.pre_cost_remarks,a.uom,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,avg(d.rate) as rates,sum(d.amount) as amounts ,d.fabric_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_number_id=d.gmts_color_id and

	b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id
	and
	d.booking_no =$txt_booking_no and
	d.job_no='".$row_per_job[csf('job_no')]."' and

	d.status_active=1 and
	d.is_deleted=0 and
	b.cons>0
	group by a.id,a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,d.dia_width,d.pre_cost_remarks,a.uom ,d.fabric_color_id order by a.body_part_id,d.fabric_color_id,a.uom  ");
	/*echo "<pre>";
	print_r($nameArray_fabric_description);*/

	if(count($nameArray_fabric_description)>0){

	?>

	<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
	<caption> <strong>Fabric Booking Details </strong> </caption>

	<tr>
	<th  width="30" align="center">SL</th>
	<th  width="440" align="left">Item Description</th>
	<th  width="110" align="center">Fabric Color</th>
 	<th  width="120" align="center">UOM</th>
	<th width='120' align="center">Finish Fab. Qty</th>
	<th width='120' align="center">Grey Fab. Qty</th>
	<th width='120' align="center">Avg Rate</th>
	<th width='100' align="center">Amount</th>

	</tr>
	<?
	$color_wise_process_loss=sql_select("select  a.body_part_id,b.fabric_color_id,avg(b.process_loss_percent) as loss FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls  b 	WHERE a.job_no=b.job_no  and  a.job_no='".$row_per_job[csf('job_no')]."' and b.is_short=1 and b.booking_no=$txt_booking_no   group by a.body_part_id,b.fabric_color_id
	");
	foreach($color_wise_process_loss as $val)
	{
		$loss_arr[$val[csf("body_part_id")]][$val[csf("fabric_color_id")]]=$val[csf("loss")];
	}


	foreach($nameArray_fabric_description as $val)
	{

		if($val[csf('pre_cost_remarks')]!='') $remark_cond="and d.pre_cost_remarks='".$val[csf('pre_cost_remarks')]."'";else $remark_cond='';
		$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	d.job_no='".$row_per_job[csf('job_no')]."' and
	a.id='".$val[csf('fabric_cost_dtls_id')]."' and
 	a.item_number_id='".$val[csf('item_number_id')]."' and
	a.body_part_id='".$val[csf('body_part_id')]."' and
	a.color_type_id='".$val[csf('color_type_id')]."' and
	a.construction='".$val[csf('construction')]."' and
	a.composition='".$val[csf('composition')]."' and
	a.gsm_weight='".$val[csf('gsm_weight')]."' and
	a.id='".$val[csf('fabric_cost_dtls_id')]."' and
 	 
	d.dia_width='".$val[csf('dia_width')]."' and
	d.fabric_color_id='".$val[csf('fabric_color_id')]."' and
	d.status_active=1 and
	d.is_deleted=0 $remark_cond
	");


	?>
	<tr>
	<td align="center"> <? echo $p; $p++;?></td>
 	<td align="left"> <? echo $body_part[$val[csf('body_part_id')]].','. $val[csf('construction')].','.$val[csf('composition')].','.$val[csf('gsm_weight')].',' .$val[csf('dia_width')].',' .$fabric_typee[$val[csf('width_dia_type')]].',' .$color_type[$val[csf('color_type_id')]]; ?> </td>
	<td  align="center">
	<?
	echo $color_library[$val[csf('fabric_color_id')]];
	?>
	</td>


	<td align="center"> <? echo $unit_of_measurement[$val[csf('uom')]]; ?></td>

	<td align="center"> <?   $greys= $color_wise_wo_sql_qnty[0][csf("fin_fab_qnty")];
	echo def_number_format($greys,2);
 	?> </td>



	<td align="center"> <? echo def_number_format($color_wise_wo_sql_qnty[0][csf("grey_fab_qnty")],2); ?> </td>
	<td align="center"> <? echo def_number_format($color_wise_wo_sql_qnty[0][csf("rate")],2); ?> </td>
 <td align="center"> <? echo def_number_format($color_wise_wo_sql_qnty[0][csf("amount")],2); ?> </td>


	<?

	$total_fin_fab_qnty +=str_replace(",", "", def_number_format($greys,2));
	$total_amount +=str_replace(",", "",def_number_format($color_wise_wo_sql_qnty[0][csf("amount")],2));
	$total_grey_fab_qnty +=str_replace(",", "",def_number_format($color_wise_wo_sql_qnty[0][csf("grey_fab_qnty")],2));
	$total_rate +=str_replace(",", "",def_number_format($color_wise_wo_sql_qnty[0][csf("rate")],2));


	?>



	</tr>
	<?

	}
	?>
	<tr style=" font-weight:bold">


	<td  align="right" colspan="4"><strong>Total</strong></td>
	<td align="center"><? echo def_number_format($total_fin_fab_qnty,2);?></td>
	<td align="center"><? echo def_number_format($total_grey_fab_qnty,2);?></td>
	<td align="center"><? echo def_number_format($total_rate,2);?></td>
	<td align="center"><? echo def_number_format($total_amount,2);?></td>

	</tr>

	</table>
	<br/>
	<?
	}
	}

		?>

      <br/>
       <br/>
        <!--New Start here-->
        <div style="width:1330px; float:left">
        <?
		// Body Part type used only Cuff and Flat Knit
        $colar_percent_size_wise_array=return_library_array( "select a.colar_cuff_per,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id and a.booking_no=$txt_booking_no and a.booking_type=1 and a.body_part_type in(40,50) and a.status_active=1 and a.is_deleted=0", "gmts_sizes", "colar_cuff_per");

		//echo  "select a.body_part_type,a.body_part_id,sum(d.rmg_qty) as rmg_qty,d.gmts_size,d.gmts_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d WHERE a.job_no=d.job_no and d.booking_no =$txt_booking_no and  a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 and d.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") group by a.body_part_type,a.body_part_id,d.gmts_size,d.gmts_color_id order by a.body_part_id";

		$nameArray_body_part=sql_select( "select a.body_part_type,a.body_part_id,sum(d.rmg_qty) as rmg_qty,d.gmts_size,d.gmts_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d WHERE a.job_no=d.job_no and d.booking_no =$txt_booking_no and  a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 and d.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.body_part_type in(40,50) group by a.body_part_type,a.body_part_id,d.gmts_size,d.gmts_color_id order by a.body_part_id");
			$row_count=count($nameArray_body_part);
		//if($row_count==0) echo " <p style='color:#f00; text-align:center; font-size:15px;'> Body part type is  used only Flat Knit and Cuff.</p> ";
		foreach($nameArray_body_part as $row)
		{
			$body_part_arr[$row[csf('body_part_id')]]['bpart_type']=$row[csf('body_part_type')];
			$body_part_rmg_qty_arr[$row[csf('body_part_id')]][$row[csf('gmts_size')]][$row[csf('gmts_color_id')]]['rmg_qty']+=$row[csf('rmg_qty')];
		}
		//print_r($body_part_arr);

		$k=1;
		foreach($body_part_arr as $body_id=>$val)
		{
			$k++;

			$bpart_type_id=$val['bpart_type'];
		$nameArray_item_size=sql_select( "select min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=$body_id  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 and a.body_part_type in(40,50) group by b.item_size,c.size_number_id order by id");

		/*$nameArray_item_size=sql_select( "select b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by c.size_number_id,b.item_size order by c.size_number_id");*/
		?>
         <div style="max-height:1330px; width:660px; overflow:auto; float:left; padding-top:20px; margin-left:5px; margin-bottom:5px; position: relative;">
        <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
        <tr>
        <td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b><? echo $body_part[$body_id];?> -  Colour Size Breakedown in Pcs</b></td>
        </tr>
        <tr>
        <td width="70">Size</td>
        <?
		foreach($nameArray_item_size  as $result_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
		<?
        }
        ?>
        <td rowspan="2" align="center"><strong>Total</strong></td>

        </tr>
        <tr>
        <td>Collar Size</td>

        <?
        foreach($nameArray_item_size  as $result_item_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
		<?
        }
        ?>
         <?

			$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=$body_id  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and a.body_part_type in(40,50) group by c.color_number_id,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			$color_total_collar=0;
			$color_total_collar_order_qnty=0;
			$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
			$constrast_color_arr=array();
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
				for($i=0;$i<count($constrast_color);$i++)
				{
					$constrast_color2=explode('_',$constrast_color[$i]);
					$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
				}
			}
		?>
			<tr>
            <td>
            <?
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
				$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
			}
			else
			{
				echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
				$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
			}
			?>

            </td>
            <?
            foreach($nameArray_item_size  as $result_size)
			{
				?>
				<td align="center" style="border:1px solid black">

				<?
				$rmg_qty=$body_part_rmg_qty_arr[$body_id][$result_size[csf('size_number_id')]][$color_wise_wo_result[csf('color_number_id')]]['rmg_qty'];
				//echo $bpart_type_id.'=';
				if($bpart_type_id==50)//Cuff
				{
					$tot_rmg_qty=$rmg_qty*2;
				}
				else //Flat Knit
				{
					$tot_rmg_qty=$rmg_qty;
				}
				//$color_wise_wo_sql_qnty=sql_select("select c.color_number_id,sum(c.order_quantity) as order_quantity, sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and c.color_number_id='".$color_wise_wo_result['color_number_id']."' and c.size_number_id='".$result_size['size_number_id']."'");
				/*$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active=1 and is_deleted =0");

				list($plan_cut_qnty)=$color_wise_wo_sql_qnty;*/
				//$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
				//$colar_excess_per=($plan_cut*$colar_excess_percent)/100;
				echo number_format($tot_rmg_qty,0);
				$color_total_collar+=$tot_rmg_qty;
				$color_total_collar_order_qnty+=$tot_rmg_qty;
				$grand_total_collar+=$tot_rmg_qty;
				$grand_total_collar_order_qnty+=$tot_rmg_qty;

				$size_tatal[$result_size[csf('size_number_id')]]+=$tot_rmg_qty;
				?>
                </td>
				<?
			}
			?>

            <td align="center"><? echo number_format($color_total_collar,0); ?></td>

            </tr>
            <?
		    }
			?>
            <tr>
                <td>Size Total</td>

                <?
                foreach($nameArray_item_size  as $result_size)
                {
					//$colar_excess_pers=($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100;
					$tot_size_tatal=$size_tatal[$result_size[csf('size_number_id')]];
					//$size_tatal[$result_size[csf('size_number_id')]]=0;
                ?>
                <td style="border:1px solid black;  text-align:center"><?  echo number_format($size_tatal[$result_size[csf('size_number_id')]],0);$size_tatal[$result_size[csf('size_number_id')]]=0; ?></td>
                <?
                }
                ?>
                <td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar,0);$grand_total_collar=0; ?></td>

            </tr>
        </table>
          <br/>
          </div>

        <?
		}

		?>
          <!--End here-->
       </div>
        <table style="display:none"  width="100%"  border="0" cellpadding="0" cellspacing="0" >
        <tr>
        <?
		//echo "select a.colar_cuff_per,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id    and a.booking_no=$txt_booking_no and a.booking_type=1 c.body_part_id in(2) and a.status_active=1 and a.is_deleted=0";
		$colar_percent_size_wise_array=return_library_array( "select a.colar_cuff_per,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id    and a.booking_no=$txt_booking_no and a.booking_type=1 and c.body_part_id in(2) and a.status_active=1 and a.is_deleted=0", "gmts_sizes", "colar_cuff_per");
		//print_r($colar_percent_size_wise_array);
		$nameArray_item_size=sql_select( "select min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
		if(count($nameArray_item_size)>0)
		{
        ?>
        <td width="49%">
        <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
        <tr>
        <td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Collar -  Colour Size Brakedown in Pcs</b></td>
        </tr>
        <tr>
        <td width="70">Size</td>

        <?

		/*$nameArray_item_size=sql_select( "select b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by c.size_number_id,b.item_size order by c.size_number_id");*/
		foreach($nameArray_item_size  as $result_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
		<?
        }
        ?>
        <td rowspan="2" align="center"><strong>Total</strong></td>
        <td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
        </tr>
        <tr>
        <td>Collar Size</td>

        <?
        foreach($nameArray_item_size  as $result_item_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
		<?
        }
        ?>
         <?

			$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by c.color_number_id,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			$color_total_collar=0;
			$color_total_collar_order_qnty=0;
			$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
			$constrast_color_arr=array();
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
				for($i=0;$i<count($constrast_color);$i++)
				{
					$constrast_color2=explode('_',$constrast_color[$i]);
					$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
				}
			}
		?>
			<tr>
            <td>
            <?
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
				$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
			}
			else
			{
				echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
				$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
			}
			?>

            </td>
            <?
            foreach($nameArray_item_size  as $result_size)
			{
				?>
				<td align="center" style="border:1px solid black">
				<?
				//$color_wise_wo_sql_qnty=sql_select("select c.color_number_id,sum(c.order_quantity) as order_quantity, sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and c.color_number_id='".$color_wise_wo_result['color_number_id']."' and c.size_number_id='".$result_size['size_number_id']."'");
				$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active=1 and is_deleted =0");

				list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
				$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
				$colar_excess_per=($plan_cut*$colar_excess_percent)/100;
				echo number_format($plan_cut+$colar_excess_per,0);
				$color_total_collar+=$plan_cut+$colar_excess_per;
				$color_total_collar_order_qnty+=$plan_cut;
				$grand_total_collar+=$plan_cut+$colar_excess_per;
				$grand_total_collar_order_qnty+=$plan_cut;

				$size_tatal[$result_size[csf('size_number_id')]]+=$plan_cut+$colar_excess_per;
				?>
                </td>
				<?
			}
			?>

            <td align="center"><? echo number_format($color_total_collar,0); ?></td>
            <td align="center"><? echo number_format((($color_total_collar-$color_total_collar_order_qnty)/$color_total_collar_order_qnty)*100,2); ?></td>
            </tr>
            <?
		    }
			?>
            <tr>
                <td>Size Total</td>

                <?
                foreach($nameArray_item_size  as $result_size)
                {
                ?>
                <td style="border:1px solid black;  text-align:center"><? $colar_excess_pers=($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]+$colar_excess_pers,0); ?></td>
                <?
                }
                ?>
                <td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar,0); ?></td>
                <td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_collar-$grand_total_collar_order_qnty)/$grand_total_collar_order_qnty)*100,2); ?></td>
            </tr>
        </table>
        </td>
        <td width="2%">
        </td>
        <?
        }
		?>

        <?
		$cuff_percent_size_wise_array=return_library_array( "select a.colar_cuff_per,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id    and a.booking_no=$txt_booking_no and a.booking_type=1 and c.body_part_id in(3) and a.status_active=1 and a.is_deleted=0", "gmts_sizes", "colar_cuff_per");
		//print_r($cuff_percent_size_wise_array);
		$nameArray_item_size=sql_select( "select min(c.id) as id, b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");

		if(count($nameArray_item_size)>0)
		{
        ?>
        <td width="49%">
        <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
        <tr>
        <td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Cuff -  Colour Size Brakedown in Pcs</b></td>
        </tr>
        <tr>
        <td width="70">Size</td>

        <?
		foreach($nameArray_item_size  as $result_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
		<?
        }
        ?>
        <td rowspan="2" align="center"><strong>Total</strong></td>
        <td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
        </tr>
        <tr>
        <td>Cuff Size</td>

        <?
        foreach($nameArray_item_size  as $result_item_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
		<?
        }
        ?>
         <?

			$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and  d.status_active=1 and d.is_deleted=0 group by c.color_number_id ,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			$color_total_cuff=0;
			$color_total_cuff_order_qnty=0;
			$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
			$constrast_color_arr=array();
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
				for($i=0;$i<count($constrast_color);$i++)
				{
					$constrast_color2=explode('_',$constrast_color[$i]);
					$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
				}
			}
			//print_r($constrast_color_arr);
		?>
			<tr>
            <td>
            <?
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				///echo $color_wise_wo_result[csf('color_number_id')];
				echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]);
				$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
			}
			else
			{
				echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
				$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
			}
			?>

            </td>
            <?
            foreach($nameArray_item_size  as $result_size)
			{
				?>
				<td align="center" style="border:1px solid black">

				<?
				/*$color_wise_wo_sql_qnty=sql_select("select c.color_number_id,sum(c.order_quantity) as order_quantity, sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=3 and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and c.color_number_id='".$color_wise_wo_result['color_number_id']."' and c.size_number_id='".$result_size['size_number_id']."'");*/
				$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active=1 and is_deleted =0");

				list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
				$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
				$cuff_excess_per=(($plan_cut*2)*$cuff_excess_percent)/100;
				echo number_format($plan_cut*2+$cuff_excess_per,0);
				$color_total_cuff+=$plan_cut*2+$cuff_excess_per;
				$color_total_cuff_order_qnty+=$plan_cut*2;
				$grand_total_cuff+=$plan_cut*2+$cuff_excess_per;
				$grand_total_cuff_order_qnty+=$plan_cut*2;
				$size_tatal[$result_size[csf('size_number_id')]]+=($plan_cut*2+$cuff_excess_per);
				/*$cuff_excess_per=(($plan_cut_qnty[csf('plan_cut_qnty')]*2)*$cuff_excess_percent)/100;
				echo number_format($plan_cut_qnty[csf('plan_cut_qnty')]*2+$cuff_excess_per,0);
				$color_total_cuff+=$plan_cut_qnty[csf('plan_cut_qnty')]*2+$cuff_excess_per;
				$color_total_cuff_order_qnty+=$plan_cut_qnty[csf('order_quantity')]*2;
				$grand_total_cuff+=$plan_cut_qnty[csf('plan_cut_qnty')]*2+$cuff_excess_per;
				$grand_total_cuff_order_qnty+=$plan_cut_qnty[csf('order_quantity')]*2;*/

				?>

                </td>
				<?
			}
			?>

            <td align="center"><? echo number_format($color_total_cuff,0); ?></td>
            <td align="center"><? echo number_format((($color_total_cuff-$color_total_cuff_order_qnty)/$color_total_cuff_order_qnty)*100,2); ?></td>
            </tr>
            <?
		    }
			?>
            <tr>
                <td>Size Total</td>

                <?
                foreach($nameArray_item_size  as $result_size)
                {
                   /* $nameArray_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =$result_size[size_number_id]  and status_active=1 and is_deleted =0 order by id");
                foreach($nameArray_size_qnty as $result_size_qnty)
                {*/
                ?>
                <td style="border:1px solid black;  text-align:center"><? $cuff_excess_pers=(($size_tatal[$result_size[csf('size_number_id')]]*2)*$cuff_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]*2+$cuff_excess_pers,0); ?></td>
                <?
                //}
                }
                ?>
                <td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_cuff,0); ?></td>
                <td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_cuff-$grand_total_cuff_order_qnty)/$grand_total_cuff_order_qnty)*100,2); ?></td>
            </tr>
        </table>
        </td>
        <?
				}
		?>
        </tr>
        </table>
        <br/>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
        <tr>
        <?

		//echo "select a.colar_cuff_per,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id    and a.booking_no=$txt_booking_no and a.booking_type=1 c.body_part_id in(2) and a.status_active=1 and a.is_deleted=0";
		//$colar_percent_size_wise_array=return_library_array( "select a.colar_cuff_per,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id    and a.booking_no=$txt_booking_no and a.booking_type=1 and c.body_part_id in(2) and a.status_active=1 and a.is_deleted=0", "gmts_sizes", "colar_cuff_per");


		$colar_percent_size_wise_array=array();
		$colar_tipping_percent_size_wise_sql=sql_select( "select a.colar_cuff_per,b.color_number_id,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id    and a.booking_no=$txt_booking_no and a.booking_type=1 and c.body_part_id in(172) and a.status_active=1 and a.is_deleted=0");
		$colar_tipping_excess_percent_arr=array();
		foreach($colar_tipping_percent_size_wise_sql as $colar_percent_size_wise_row)
		{
			$colar_tipping_excess_percent_arr[$colar_percent_size_wise_row[csf('color_number_id')]][$colar_percent_size_wise_row[csf('gmts_sizes')]]=$colar_percent_size_wise_row[csf('colar_cuff_per')];
			//$colar_excess_percent_arr[$colar_percent_size_wise_row[csf('gmts_sizes')]]+=$colar_percent_size_wise_row[csf('colar_cuff_per')];

		}

		//print_r($colar_tipping_excess_percent_arr);
		$nameArray_item_size=sql_select( "select min(c.id) as id,b.item_size,c.size_number_id,	min(c.size_order) as size_order FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=172  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by size_order");


		if(count($nameArray_item_size)>0)
		{
        ?>
        <td width="49%">
        <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
        <tr>
        <td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Collar Tipping -  Colour Size Brakedown in Pcs</b></td>
        </tr>
        <tr>
        <td width="70">Size</td>

        <?

		/*$nameArray_item_size=sql_select( "select b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by c.size_number_id,b.item_size order by c.size_number_id");*/
		foreach($nameArray_item_size  as $result_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
		<?
        }
        ?>
        <td rowspan="2" align="center"><strong>Total</strong></td>
        <td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
        </tr>
        <tr>
        <td>Collar Size</td>

        <?
        foreach($nameArray_item_size  as $result_item_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
		<?
        }

		$color_wise_wo_sql=sql_select("select a.id, a.job_no, a.color_size_sensitive, a.color_break_down, a.process_loss_method, c.color_number_id , c.color_order, sum(c.plan_cut_qnty) as plan_cut_qnty
		FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d
		WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=172 and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and c.status_active=1 and c.is_deleted=0
		group by c.color_number_id, c.color_order, a.id, a.job_no, a.color_size_sensitive,a.color_break_down, a.process_loss_method
		order by c.color_order ");

		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			$color_total_collar=0;
			$color_total_collar_order_qnty=0;
			$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
			$constrast_color_arr=array();
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
				for($i=0;$i<count($constrast_color);$i++)
				{
					$constrast_color2=explode('_',$constrast_color[$i]);
					$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
				}
			}
		?>
			<tr>
            <td>
            <?
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
				$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
			}
			else
			{
				echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
				$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
			}
			?>

            </td>
            <?
            foreach($nameArray_item_size  as $result_size)
			{
				?>
				<td align="center" style="border:1px solid black">
				<?

				$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active=1 and is_deleted =0 ");




				list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
				$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
				$colar_tipping_excess_per=($plan_cut*$colar_tipping_excess_percent_arr[$color_wise_wo_result[csf('color_number_id')]][$result_size[csf('size_number_id')]])/100;
				echo number_format($plan_cut+$colar_tipping_excess_per,0);
				$collar_tiff_size_total_arr[$result_size[csf('size_number_id')]]+=number_format($plan_cut+$colar_tipping_excess_per,0,'','');
				$color_tipping_total_collar+=$plan_cut+$colar_tipping_excess_per;
				$color_tipping_total_collar_order_qnty+=$plan_cut;
				$grand_total_collar_tipping+=$plan_cut+$colar_tipping_excess_per;
				$grand_total_collar_tipping_order_qnty+=$plan_cut;



				?>
                </td>
				<?
			}
			?>

            <td align="center"><? echo number_format($color_tipping_total_collar,0); ?></td>
            <td align="center"><? echo number_format((($color_tipping_total_collar-$color_tipping_total_collar_order_qnty)/$color_tipping_total_collar_order_qnty)*100,2); ?></td>
            </tr>
            <?
		    }
			?>
            <tr>
                <td>Size Total</td>

                <?
                foreach($nameArray_item_size  as $result_size)
                {
                ?>
                <td style="border:1px solid black;  text-align:center">
				<?
				//$colar_excess_pers=($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]+$colar_excess_pers,0);
				echo number_format($collar_tiff_size_total_arr[$result_size[csf('size_number_id')]],0);

				?></td>
                <?
                }
                ?>
                <td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar_tipping,0); ?></td>
                <td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_collar_tipping-$grand_total_collar_tipping_order_qnty)/$grand_total_collar_tipping_order_qnty)*100,2); ?></td>
            </tr>
        </table>
        </td>
        <td width="2%">
        </td>
        <?
        }

		$cuff_tipping_percent_size_wise_array=$cuff_size_total=array();
		$cuff_tipping_percent_size_wise_sql=sql_select( "select a.colar_cuff_per,b.color_number_id,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id  and a.booking_no=$txt_booking_no and a.booking_type=1 and c.body_part_id in(214) and a.status_active=1 and a.is_deleted=0");
		foreach($cuff_tipping_percent_size_wise_sql as $cuff_percent_size_wise_row)
		{
			$cuff_tipping_percent_size_wise_array[$cuff_percent_size_wise_row[csf('color_number_id')]][$cuff_percent_size_wise_row[csf('gmts_sizes')]]=$cuff_percent_size_wise_row[csf('colar_cuff_per')];
		}


		$nameArray_item_size=sql_select( "select min(c.id) as id, b.item_size,c.size_number_id,	min(c.size_order) as size_order FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=214  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by size_order");


		if(count($nameArray_item_size)>0)
		{
        ?>
        <td width="49%">
        <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
        <tr>
        <td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Cuff Tipping-  Colour Size Brakedown in Pcs</b></td>
        </tr>
        <tr>
        <td width="70">Size</td>

        <?
		foreach($nameArray_item_size  as $result_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
		<?
        }
        ?>
        <td rowspan="2" align="center"><strong>Total</strong></td>
        <td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
        </tr>
        <tr>
        <td>Cuff Size</td>

        <?
        foreach($nameArray_item_size  as $result_item_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
		<?
        }
        ?>
         <?

			$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id, c.color_order, sum(c.plan_cut_qnty) as plan_cut_qnty
			FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d
			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=214  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and  d.status_active=1 and d.is_deleted=0
			group by c.color_number_id, c.color_order ,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method
			order by c.color_order");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			$color_total_cuff=0;
			$color_total_cuff_order_qnty=0;
			$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
			$constrast_color_arr=array();
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
				for($i=0;$i<count($constrast_color);$i++)
				{
					$constrast_color2=explode('_',$constrast_color[$i]);
					$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
				}
			}
		?>
			<tr>
            <td>
            <?
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]);
				$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
			}
			else
			{
				echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
				$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
			}
			?>

            </td>
            <?
            foreach($nameArray_item_size  as $result_size)
			{
				?>
				<td align="center" style="border:1px solid black">

				<?


				$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active=1 and is_deleted =0");



				list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
				$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
				$cuff_tipping_excess_per=(($plan_cut*2)*$cuff_tipping_percent_size_wise_array[$color_wise_wo_result[csf('color_number_id')]][$result_size[csf('size_number_id')]])/100;
				echo number_format($plan_cut*2+$cuff_tipping_excess_per,0);
				$cuff_tiffing_size_total[$result_size[csf('size_number_id')]]+=number_format($plan_cut*2+$cuff_tipping_excess_per,0,'','');
				//echo $cuff_tipping_percent_size_wise_array[$color_wise_wo_result[csf('color_number_id')]][$result_size[csf('size_number_id')]];
				$color_total_cuff_tiffing+=$plan_cut*2+$cuff_tipping_excess_per;
				$color_total_cuff_tiffing_order_qnty+=$plan_cut*2;
				$grand_total_cuff_tiffing+=$plan_cut*2+$cuff_tipping_excess_per;
				$grand_total_cuff_tiffing_order_qnty+=$plan_cut*2;
				?>

                </td>
				<?
			}
			?>

            <td align="center"><? echo number_format($color_total_cuff_tiffing,0); ?></td>
            <td align="center"><? echo number_format((($color_total_cuff_tiffing-$color_total_cuff_tiffing_order_qnty)/$color_total_cuff_tiffing_order_qnty)*100,2);  ?></td>
            </tr>
            <?
		    }
			?>
            <tr>
                <td>Size Total</td>

                <?
                foreach($nameArray_item_size  as $result_size)
                {
                   /* $nameArray_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =$result_size[size_number_id]  and status_active=1 and is_deleted =0 order by id");
                foreach($nameArray_size_qnty as $result_size_qnty)
                {*/
                ?>
                <td style="border:1px solid black;  text-align:center">
				<?
				//$cuff_excess_pers=(($size_tatal[$result_size[csf('size_number_id')]]*2)*$cuff_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]*2+$cuff_excess_pers,0);
				echo number_format($cuff_tiffing_size_total[$result_size[csf('size_number_')]],0);
				?></td>
                <?
                //}
                }
                ?>
                <td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_cuff_tiffing,0); ?></td>
                <td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_cuff_tiffing-$grand_total_cuff_tiffing_order_qnty)/$grand_total_cuff_tiffing_order_qnty)*100,2); ?></td>
            </tr>
        </table>
        </td>
        <?
				}
		?>
        </tr>
        </table>

 <br>
	<?
	$txt_job_no=str_replace("'","",$txt_job_no);
	$color_name_arr=return_library_array( "SELECT id,color_name from lib_color where status_active =1 and is_deleted=0",'id','color_name');
	$sql_stripe="SELECT c.id, c.composition, c.construction, c.body_part_id, c.fabric_description, c.gsm_weight, c.color_type_id, sum(b.grey_fab_qnty) as fab_qty, b.dia_width, d.gmts_color_id, d.fabric_color_id, d.id as did, d.stripe_color, d.fabreqtotkg as fabreqtotkg, d.measurement as measurement, d.yarn_dyed, d.uom, b.job_no from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c, wo_short_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.fabric_cost_dtls_id=c.id and d.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.id=d.dtls_id and b.job_no in('$txt_job_no')  and d.job_no in('$txt_job_no') and b.booking_no=$txt_booking_no and c.color_type_id in (2,3,4,6,31,32,33,34) and b.status_active=1 and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and b.is_deleted=0  group by c.id, c.body_part_id, c.fabric_description, c.gsm_weight, c.color_type_id, d.gmts_color_id, d.fabric_color_id, d.id, d.stripe_color, d.yarn_dyed, d.fabreqtotkg, d.measurement, d.uom, c.composition, c.construction, b.dia_width, b.job_no order by b.job_no ";
	$result_data=sql_select($sql_stripe);

	foreach($result_data as $row)
	{
		if($row[csf('fabric_color_id')]==0 || $row[csf('fabric_color_id')]=="") $row[csf('color_number_id')]=$row[csf('gmts_color_id')]; else $row[csf('color_number_id')]=$row[csf('fabric_color_id')];
		
		$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
		$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
		$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
		$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
		$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

		$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
		$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
		$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
		$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
		$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
		$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['job_no']=$row[csf('job_no')];
		$tot_stripe_measurement_arr[$row[csf('color_number_id')]]+=$row[csf('measurement')];
	}
	//echo $tot_stripe_measurement;

	if(count($stripe_arr)>0)
	{
		?>
		<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
			<tr>
	             <td colspan="9" align="center"><b>Stripe Details</b></td>
	        </tr>

	        <tr align="center">
	        	<th width="30"> SL</th>
	        	<th width="50"> Job</th>
	            <th width="100"> Body Part</th>
	            <th width="80"> Fabric Color</th>
	            <th width="70"> Fabric Qty(KG)</th>
	            <th width="70"> Stripe Color</th>
	            <th width="70"> Stripe Measurement</th>
	            <th width="70"> Stripe Uom</th>
	            <th width="70"> Qty.(KG)</th>
	            <th width="70"> Y/D Req.</th>
	        </tr>

	        <?
			$i=1;$total_fab_qty=0;
			$total_fabreqtotkg=0;
			$fab_data_array=array();
			$stripe_wise_fabkg_arr=array();

			$stripe_wise_fabkg_sql="SELECT a.job_no,a.body_part_id,a.color_type_id,b.fabric_color_id, sum(b.fin_fab_qnty) as fin_fab_qnty,sum(b.grey_fab_qnty) as grey_fab_qnty  from wo_pre_cost_fabric_cost_dtls a,wo_booking_dtls b where  a.color_type_id=2 and a.job_no=b.job_no  and b.booking_no=$txt_booking_no
			and a.id=b.pre_cost_fabric_cost_dtls_id  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.job_no,a.body_part_id,a.color_type_id,b.fabric_color_id";
			foreach(sql_select($stripe_wise_fabkg_sql) as $keys=>$vals)
			{
				$stripe_wise_fabkg_arr[$vals[csf("job_no")]][$vals[csf("body_part_id")]][$vals[csf("color_type_id")]][$vals[csf("fabric_color_id")]] +=$vals[csf("grey_fab_qnty")];
			}
	        foreach($stripe_arr as $body_id=>$body_data)
	        {
				foreach($body_data as $color_id=>$color_val)
				{
					$rowspan=count($color_val['stripe_color']);
					$composition=$stripe_arr2[$body_id][$color_id]['composition'];
					$construction=$stripe_arr2[$body_id][$color_id]['construction'];
					$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
					$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
					$dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];

					if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
					else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";

					$color_wise_wo_sql_qnty=sql_select("SELECT a.job_no, sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
						WHERE a.job_no=b.job_no and
						a.id=b.pre_cost_fabric_cost_dtls_id and
						c.job_no_mst=a.job_no and
						c.id=b.color_size_table_id and
						b.po_break_down_id=d.po_break_down_id and
						b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
						d.booking_no =$txt_booking_no and
						a.body_part_id='".$body_id."' and
						a.color_type_id='".$color_type_id."' and
						a.construction='".$construction."' and
						a.composition='".$composition."' and
						a.gsm_weight='".$gsm_weight."' and
						$color_cond and
						d.status_active=1 and
						d.is_deleted=0 group by a.job_no
						");
						list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;
					?>
					<tr>
						<?

						//$color_qty=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
						$jobs=$stripe_arr2[$body_id][$color_id]['job_no'];
						$color_qty=$stripe_wise_fabkg_arr[$jobs][$body_id][$color_type_id][$color_id];
						?>
						<td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
						<td rowspan="<? echo $rowspan;?>"> <? echo $jobs; ?></td>
						<td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
						<td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
						<td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?></td>
						<?
						//$total_fab_qty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
						$tot_stripe_measurement=$tot_stripe_measurement_arr[$color_id];

						$total_fab_qty+=$color_qty;
						foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
						{
							$measurement=$color_val['measurement'][$strip_color_id];
							$uom=$color_val['uom'][$strip_color_id];
							$fabreqtotkg=($measurement/$tot_stripe_measurement)*$color_qty;//$color_val['fabreqtotkg'][$strip_color_id];
							$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
							?>
							<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
							<td align="right"> <? echo  number_format($measurement,2); ?></td>
		                    <td> <? echo  $unit_of_measurement[$uom]; ?></td>
							<td align="right" title="Stripe Measurement/Tot Stripe Measurement(<? echo $tot_stripe_measurement;?>)*Fabric Qty(KG)"> <? echo  number_format($fabreqtotkg,2); ?></td>
							<td> <? echo  $yes_no[$yarn_dyed]; ?></td>
					</tr>
							<?
							$total_fabreqtotkg+=$fabreqtotkg;
						}
							$i++;
				}
			}
			?>
	        <tfoot>
	        	<tr>
	        		<td colspan="4">Total </td>
	        		<td align="right">  <? echo  number_format($total_fab_qty,2); ?> </td>
	        		<td></td>
	        		<td></td>
	        		<td>   </td>
	        		<td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
	        	</tr>
	        </tfoot>
		</table>
		<?
	}
	?>

	<br/>
        <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

        <tr>
        <td colspan="10" align="center">
        <strong>Comments</strong>
        </td>

        </tr>

        <tr>
	        <td align="center"> SL </td>
	        <td align="center"> PO NO </td>
	        <td align="center"> Ship Date </td>
	        <td align="center"> BOM Qty</td>
	        <td align="center"> Booking Qty </td>
	        <td align="center"> Short Booking Qty </td>
	        <td align="center"> Total Booking Qty </td>
	        <td align="center"> Balance </td>
	        <td align="center"> Comments </td>
         </tr>
        <?
        $is_short_data=sql_select("select a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0   and b.is_short =1 group by  a.id ");
        foreach($is_short_data as $vals)
        {
        	$short_qty_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
        }

        $booking_data=sql_select("select a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and  b.status_active=1 and b.is_deleted=0 and b.is_short !=1 group by  a.id ");
        foreach($booking_data as $vals)
        {
        	$booking_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
        }
        $po_num_arr=return_library_array("select id,po_number from wo_po_break_down where status_active=1 and is_deleted=0",'id','po_number');

        $po_date=return_library_array("select id,shipment_date from wo_po_break_down where status_active=1 and is_deleted=0",'id','shipment_date');

    $comments_data=sql_select("SELECT min(a.id) as ids,b.po_break_down_id as po_number,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,SUM(b.requirment) as precost_grey_qty FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id
	and
	b.po_break_down_id=d.po_break_down_id and
	b.color_number_id=d.gmts_color_id and
	b.dia_width=d.dia_width and
	b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id
	and
	d.booking_no =$txt_booking_no and
	d.job_no='".$row_per_job[csf('job_no')]."' and

	d.status_active=1 and
	d.is_deleted=0 and
	b.cons>0
	group by b.po_break_down_id");


	$job_no=$row_per_job[csf('job_no')];
 	$condition= new condition();
	if(str_replace("'","",$job_no) !='')
	{
	  $condition->job_no("='$job_no'");
 	}
	 $condition->init();
	$fabric= new fabric($condition);
	$fabric_costing_qty_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish();

        $j=1;
        $total_bom=0;
        $total_book=0;
        $total_short=0;
        $total_short_full=0;
        $total_balance=0;

		foreach($comments_data as $val)
		{
				$po_id=$val[csf('po_number')];
			 	$woven_qty=array_sum($fabric_costing_qty_arr['woven']['grey'][$po_id]);
			 	$knit_qty=array_sum($fabric_costing_qty_arr['knit']['grey'][$po_id]);
			 	$sum_woven_knit=$woven_qty + $knit_qty;
			?>
          <tr>
        <td align="center"><? echo $j;?></td>

        <td align="center"> <? echo $po_num_arr[$val[csf("po_number")]] ;?> </td>
        <td align="center"> <? echo change_date_format($po_date[$val[csf("po_number")]], "yyyy-mm-dd", "-");?> </td>
        <td align="center"><?  echo $pre= def_number_format($sum_woven_knit,2);  ?> </td>
         <td align="center"><?  echo $bookings= def_number_format($booking_arr[$val[csf("po_number")]],2);  ?> </td>
 		<td align="center"> <? echo $short=def_number_format($short_qty_arr[$val[csf("po_number")]],2); ?> </td>
		<td align="center"> <?  $tot_short_book= str_replace(',','',$bookings) +  str_replace(',','',$short); number_format($tot_short_book,2); ?>  </td>
		<td align="center"> <? $bal =str_replace(',','',$pre)-str_replace(',','',$tot_short_book); number_format($bal,2) ?> </td>
		<td align="center"> <? if($bal!=0){ if(str_replace(',','',$pre)>$tot_short_book){echo "Less ";} else{ echo "Over";} }?> </td>
        </tr>
        <?
        $total_bom +=str_replace(',','',$pre);
        $total_book +=str_replace(',','',$bookings);
        $total_short +=str_replace(',','',$short);
        $total_short_full += str_replace(',','',$tot_short_book);
        $total_balance += str_replace(',','',$bal);
        $j++;
		}
		?>
		<tr>
			<td colspan="3" align="right"> <b> Total </b></td>
			<td align="center"><strong><? echo number_format($total_bom,2);?> </strong> </td>
			<td align="center"><strong><? echo number_format($total_book,2);?> </strong> </td>
			<td align="center"><strong><? echo number_format($total_short,2);?> </strong> </td>
			<td align="center"><strong><? echo number_format($total_short_full,2);?> </strong> </td>
			<td align="center"><strong><? echo number_format($total_balance,2);?> </strong> </td>
			<td>&nbsp;</td>
		</tr>
        </table>
<br>
        <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
        	<tr>
        		<th>Responsible Dept.</th>
        		<th>Responsible Person</th>
        		<th>Reason</th>
        	</tr>
        	<tr>
        		<td>
        			<?
        				$all_dept_name="";
        				$department_name_library=return_library_array( "select id,department_name from  lib_department where status_active=1 and is_deleted=0 order by  department_name", "id", "department_name"  );
        				$all_dept=array_unique(explode(",", implode(",",$job_data_arr['responsible_dept'])));
        				foreach ($all_dept as $value)
        				{
        					$all_dept_name.=$department_name_library[$value].",";
        				}
        				echo chop($all_dept_name, ",");
        			?>
        		</td>
        		<td><? echo implode(",", array_unique($job_data_arr['responsible_person'])); ?></td>
        		<td><? echo implode(",", array_unique($job_data_arr['reason'])); ?></td>
        	</tr>
        </table>

        <br>
	<table width="100%"   cellpadding="2" cellspacing="0" rules="all" style="border-left: none;border-right: none;border-top: none;border-bottom: none;">
		<tr>
		 	<td align="left" style="border-left: none;border-right: none;border-top: none;border-bottom: none;">
		 		<img src='<? echo $path.$imge_arr[$job_no]; ?>' height='180' width='250' />
		 	</td>
		 	<td align="right" width="650" style="border-left: none;border-right: none;border-top: none;border-bottom: none;" valign="top">
		 		<?php echo get_spacial_instruction($txt_booking_no); ?>
		 	</td>
		</tr>
	</table>
	<br>
        <?
		//$sqlHis="select approval_cause from approval_cause_refusing_his where entry_form=7 and booking_id='$wo_id' and approval_type=2 and status_active=1 and is_deleted=0 order by id Desc";
		$booking_id=return_field_value( "id", "wo_booking_mst","booking_no=$txt_booking_no");
		$user_nameArr=return_library_array( "select id, user_name from user_passwd ", "id", "user_name"  );
		$un_approve_reques_data_array=sql_select("select a.id,a.cause_id,a.approval_cause, a.user_id, a.insert_date from approval_cause_refusing_his a, fabric_booking_approval_cause b where b.id=a.cause_id and b.booking_id=$booking_id and b.entry_form=12 and a.approval_type=2 order by a.id");
	//echo "select a.id,a.cause_id,a.approval_cause, a.user_id, a.insert_date from approval_cause_refusing_his a, fabric_booking_approval_cause b where b.id=a.cause_id and b.booking_id=$booking_id and b.entry_form=12 and a.approval_type=2 order by a.id";
	foreach($un_approve_reques_data_array as $hrow)
		{
			$approval_data=$hrow[csf('id')];
			$unapprove_cause_arr[$approval_data]['insert_date']=$hrow[csf('insert_date')];
			$unapprove_cause_arr[$approval_data]['user_id']=$hrow[csf('user_id')];
			$unapprove_cause_arr[$approval_data]['approval_cause']=$hrow[csf('approval_cause')];
			$causeArrChk[$hrow[csf('approval_cause')].'_'.$hrow[csf('id')]]=$hrow[csf('approval_cause')].'_'.$hrow[csf('id')];
		}
		
		$un_approve_reques_data_cause_array=sql_select("select b.id,b.approval_cause,b.user_id,b.insert_date,b.update_date from fabric_booking_approval_cause b where  b.booking_id=$booking_id and b.entry_form=12 and b.approval_type=2 and b.status_active=1 order by b.id");
		//echo "select b.id,b.approval_cause,b.user_id,b.insert_date,b.update_date from fabric_booking_approval_cause b where  b.booking_id=$booking_id and b.entry_form=12 and b.approval_type=2 and b.status_active=1 order by b.id";
		foreach($un_approve_reques_data_cause_array as $hrow)
		{
			if($causeArrChk[$hrow[csf('approval_cause')].'_'.$hrow[csf('id')]]=='')
			{
			$insert_date=$hrow[csf('insert_date')];
			if(strtotime($hrow[csf('update_date')])>0)
			{
				$insert_date=$hrow[csf('update_date')];	
			}
			$approval_data=$hrow[csf('id')];
			$unapprove_cause_arr[$approval_data]['insert_date']=$insert_date;
			$unapprove_cause_arr[$approval_data]['user_id']=$hrow[csf('user_id')];
			$unapprove_cause_arr[$approval_data]['approval_cause']=$hrow[csf('approval_cause')];
			}
		}
		
		
		?>
		<table align="center" cellspacing="0" width="100%" class="rpt_table" border="1" rules="all">
			<thead>
				<th width="30">SL</th>
                <th width="200">Rev. Date</th>
                <th width="200">Rev. By</th>
				<th>Reason of Revision</th>
			</thead>
		 <tbody>
			<?
			$i=1;
			foreach($unapprove_cause_arr as $cause=>$hrow)
			{
				if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
				$causeArr=explode("_",$cause);
				?>
				<tr bgcolor="<?=$bgcolor; ?>" onClick="change_color('tr_<?=$i; ?>','<?=$bgcolor; ?>');">
                  	<td width="30"><?=$i; ?></td>
					<td width="200"><?=$hrow[('insert_date')]; ?></td>
                    <td width="200"><?=$user_nameArr[$hrow[('user_id')]]; ?></td>
					<td style="word-break:break-all"><?=$hrow[('approval_cause')]; ?></td>
				</tr>
				<?
				$i++;
			}
			?>
            </tbody>
        </table>
		<?
		$user_lib_name=return_library_array("SELECT id,user_full_name from user_passwd", "id", "user_full_name");
		// $prepared_by = $user_arr[$user_id];
        echo signature_table(4, $cbo_company_name, "1330px",'','',$user_lib_name[$inserted_by]);
	}
	$job_no_all= implode(",",array_unique($joball['job_no']));
	$style_sting_all=implode(",",array_unique($joball['style_ref_no']));

	echo "****".custom_file_name($txt_booking_no,$style_sting_all,$job_no_all);
	?>
	</div>
	<?
	exit();
}

if($action=="print_booking_ntg")
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$imge_arr=return_library_array( "select master_tble_id,image_location from common_photo_library where form_name='company_details' or form_name='knit_order_entry' and file_type=1",'master_tble_id','image_location');

	$company_library=return_library_array( "select id,company_name from lib_company", "id", "company_name");
	$color_library=return_library_array( "select id,color_name from lib_color where status_active =1 and is_deleted=0", "id", "color_name");
	$size_library=return_library_array( "select id,size_name from lib_size where status_active =1 and is_deleted=0", "id", "size_name");
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from lib_supplier",'id','supplier_name');

	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');

	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	$season_arr=return_library_array("select id,season_name from lib_buyer_season","id","season_name");
	$uom=0;
	$joball=array();
	$nameArray_per_job=sql_select( "select  a.job_no,a.style_ref_no  from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by a.job_no,a.style_ref_no");
	foreach ($nameArray_per_job as $row_per_job){
	$joball['job_no'][$row_per_job[csf('job_no')]]=$row_per_job[csf('job_no')];
	$joball['style_ref_no'][$row_per_job[csf('job_no')]]=$row_per_job[csf('style_ref_no')];

	$uom=0;
	$job_data_arr=array();
	$nameArray_buyer=sql_select( "select  a.style_ref_no,a.style_description, a.job_no, a.style_owner, a.buyer_name, b.responsible_dept, b.responsible_person, b.reason, a.dealing_marchant,a.season,a.season_matrix,a.season_buyer_wise,a.total_set_qnty,a.product_dept,a.product_code,a.pro_sub_dep,a.gmts_item_id ,a.order_repeat_no,a.qlty_label  from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0 and a.job_no='".$row_per_job[csf('job_no')]."'");
	foreach ($nameArray_buyer as $result_buy){
	$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
	$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
	$job_data_arr['total_set_qnty'][$result_buy[csf('job_no')]]=$result_buy[csf('total_set_qnty')];
	$job_data_arr['product_dept'][$result_buy[csf('job_no')]]=$product_dept[$result_buy[csf('product_dept')]];
	$job_data_arr['product_code'][$result_buy[csf('job_no')]]=$result_buy[csf('product_code')];
	$job_data_arr['pro_sub_dep'][$result_buy[csf('job_no')]]=$pro_sub_dept_array[$result_buy[csf('pro_sub_dep')]];
	$job_data_arr['gmts_item_id'][$result_buy[csf('job_no')]]=$result_buy[csf('gmts_item_id')];
	$job_data_arr['style_ref_no'][$result_buy[csf('job_no')]]=$result_buy[csf('style_ref_no')];
	$job_data_arr['style_description'][$result_buy[csf('job_no')]]=$result_buy[csf('style_description')];
	$job_data_arr['dealing_marchant'][$result_buy[csf('job_no')]]=$marchentrArr[$result_buy[csf('dealing_marchant')]];
	$job_data_arr['season_matrix'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_matrix')]];
	$job_data_arr['season_buyer_wise'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_buyer_wise')]];
	$job_data_arr['order_repeat_no'][$result_buy[csf('job_no')]]=$result_buy[csf('order_repeat_no')];
	$job_data_arr['qlty_label'][$result_buy[csf('job_no')]]=$quality_label[$result_buy[csf('qlty_label')]];

	$job_data_arr['responsible_person'][$result_buy[csf('responsible_person')]]=$result_buy[csf('responsible_person')];
	$job_data_arr['responsible_dept'][$result_buy[csf('responsible_dept')]]=$result_buy[csf('responsible_dept')];
	$job_data_arr['reason'][$result_buy[csf('reason')]]=$result_buy[csf('reason')];
	}

	$job_no= implode(",",array_unique($job_data_arr['job_no']));
	$job_no_in= implode(",",array_unique($job_data_arr['job_no_in']));
	$product_depertment=implode(",",array_unique($job_data_arr['product_dept']));
	$product_code=implode(",",array_unique($job_data_arr['product_code']));
	$pro_sub_dep=implode(",",array_unique($job_data_arr['pro_sub_dep']));
	$gmts_item_id=implode(",",array_unique($job_data_arr['gmts_item_id']));
	$style_sting=implode(",",array_unique($job_data_arr['style_ref_no']));
	$style_description=implode(",",array_unique($job_data_arr['style_description']));
	$dealing_marchant=implode(",",array_unique($job_data_arr['dealing_marchant']));
	$season_matrix=implode(",",array_unique($job_data_arr['season_matrix']));
	$season_buyer_wise=implode(",",array_unique($job_data_arr['season_buyer_wise']));
	$order_repeat_no= implode(",",array_unique($job_data_arr['order_repeat_no']));
	$qlty_label= implode(",",array_unique($job_data_arr['qlty_label']));
	?>
    <style>
@media print {
    .gg {page-break-after: always;}
}


@media print
{
     .page-break { height:0; page-break-before:always; margin:0; border-top:none; }
}

     body, p, span, td, a {font-size:10pt;font-family: Arial;}
     body{margin-left:2em; margin-right:2em; font-family: "Arial Narrow", Arial, sans-serif;}
    .page{
    height:947px;
    padding-top:5px;
    page-break-after : always;
    font-family: Arial, Helvetica, sans-serif;
    position:relative;
   border-bottom:1px solid #000;
   		  }



</style>
	<div style="width:1330px" align="center">

	<?php
$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12 and a.status_active =1 and a.is_deleted=0");
list($nameArray_approved_row) = $nameArray_approved;
$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
list($nameArray_approved_date_row) = $nameArray_approved_date;
$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
list($nameArray_approved_comments_row) = $nameArray_approved_comments;
$path = str_replace("'", "", $path);
if ($path != "") {
	$path = $path;
} else {
	$path = "../../";
}

?>										<!--    Header Company Information         -->
	<table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black" >
	<tr>
	<td width="100">
	<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
	</td>
	<td width="1250">
	<table width="100%" cellpadding="0" cellspacing="0"  >
	<tr>
	<td align="center">
	<?php
echo $company_library[$cbo_company_name];
?>
	</td>
	<td rowspan="3" width="250">

	<span><b> Job No:&nbsp;&nbsp;<? echo trim($job_no,"'"); ?></b></span><br/>
	<?
	if($nameArray_approved_row[csf('approved_no')]>1)
	{
	?>
	<b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
	<br/>
	Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
	<?
	}
	?>


	</td>
	</tr>
	<tr>
	<td align="center">
	<?
	$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
	if($txt_job_no!="")
	{
	$location=return_field_value( "location_name", "wo_po_details_master","job_no=$txt_job_no");
	}
	else
	{
	$location="";
	}

	foreach ($nameArray as $result)
	{
	echo  $location_name_arr[$location];
	?>

	Email Address: <? echo $result[csf('email')];?>
	Website No: <? echo $result[csf('website')]; ?>

	<?

	}

	?>
	</td>
	</tr>
	<tr>
	<td align="center">
	<strong><? if($report_title !=""){ echo $report_title;} else { echo "General Work Order";}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
	</td>
	</tr>
	</table>
	</td>
	</tr>
	</table>
	<?


	$po_data=array();
	if($db_type==0){
	$nameArray_job=sql_select( "select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,DATEDIFF(pub_shipment_date,po_received_date) date_diff,MIN(po_received_date) as po_received_date ,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status  from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no='".$row_per_job[csf('job_no')]."'  group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
	}
	if($db_type==2){
	$nameArray_job=sql_select( "select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,(pub_shipment_date-po_received_date) date_diff,MIN(po_received_date) as po_received_date,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status   from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no='".$row_per_job[csf('job_no')]."' group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
	}
	foreach ($nameArray_job as $result_job){
		$po_data['po_id'][$result_job[csf('id')]]=$result_job[csf('id')];
		$po_data['po_number'][$result_job[csf('id')]]=$result_job[csf('po_number')];
		$po_data['leadtime'][$result_job[csf('id')]]=$result_job[csf('date_diff')];
		$po_data['po_quantity'][$result_job[csf('id')]]=$result_job[csf('po_quantity')];
		$po_data['po_received_date'][$result_job[csf('id')]]=change_date_format($result_job[csf('po_received_date')],'dd-mm-yyyy','-');
		$ddd=strtotime($result_job[csf('pub_shipment_date')]);
		$po_data['pub_shipment_date'][$ddd]=$ddd;

		$po_data['insert_date'][$result_job[csf('id')]]=$result_job[csf('insert_date')];

		if($result_job[csf('shiping_status')]==1){
		$shiping_status= "FP";
		}
		else if($result_job[csf('shiping_status')]==2){
		$shiping_status= "PS";
		}
		else if($result_job[csf('shiping_status')]==3){
		$shiping_status= "FS";
		}
		$po_data['shiping_status'][$result_job[csf('id')]]=$shiping_status;
		$po_data['file_no'][$result_job[csf('id')]]=$result_job[csf('file_no')];
		$po_data['grouping'][$result_job[csf('id')]]=$result_job[csf('grouping')];
	}
	$txt_order_no_id=implode(",",array_unique($po_data['po_id']));
	$leadtime=implode(",",array_unique($po_data['leadtime']));
	$po_quantity=array_sum($po_data['po_quantity']);
	$po_received_date=implode(",",array_unique($po_data['po_received_date']));
	$po_number=implode(",",array_unique($po_data['po_number']));
	$shipment_date=date('d-m-Y',min($po_data['pub_shipment_date']));
	$maxshipment_date=date('d-m-Y',max($po_data['pub_shipment_date']));
	//$shipment_date=implode(",",array_unique($po_data['pub_shipment_date']));
	$shiping_status=implode(",",array_unique($po_data['shiping_status']));
	$file_no=implode(",",array_unique($po_data['file_no']));
	$grouping=implode(",",array_unique($po_data['grouping']));


	$colar_excess_percent=0;
	$cuff_excess_percent=0;
	$rmg_process_breakdown=0;
	$nameArray=sql_select( "select a.buyer_id,a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.update_date,a.uom,a.remarks,a.pay_mode,a.fabric_composition,a.short_booking_type from wo_booking_mst a  where   a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0");
	foreach ($nameArray as $result)
	{
		$total_set_qnty=$result[csf('total_set_qnty')];
		$colar_excess_percent=$result[csf('colar_excess_percent')];
		$cuff_excess_percent=$result[csf('cuff_excess_percent')];
		$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
		foreach ($po_data['po_id'] as $po_id=>$po_val){
			$daysInHand.=(datediff('d',date('d-m-Y',time()),$po_data['pub_shipment_date'][$po_id])-1).",";
			$booking_date=$result[csf('update_date')];
			if($booking_date=="" || $booking_date=="0000-00-00 00:00:00"){
			$booking_date=$result[csf('insert_date')];
			}
			$WOPreparedAfter.=(datediff('d',$po_data['insert_date'][$po_id],$booking_date)-1).",";
		}
	?>
	<table width="100%" style="border:1px solid black;table-layout: fixed;" >
	<tr>
	<td colspan="6" valign="top" style="color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
	</tr>
	<tr>
	<td width="200"><span><b>Buyer/Agent Name</b></span></td>
	<td width="220">:&nbsp;<span><b><? echo $buyer_name_arr[$result[csf('buyer_id')]]; ?></b></span></td>
	<td width="200"><span><b>Dept.</b></span></td>
	<td width="220">:&nbsp;
	<?
	echo $product_depertment ;
	if($product_code !=""){
	echo " (".$product_code.")";
	}
	if($pro_sub_dep != ""){
	echo " (".$pro_sub_dep.")";
	}
	?>
	</td>
	<td width="200"><span><b>Order Qnty</b></span></td>
	<td>:&nbsp; <?  echo $po_quantity;//." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?> </td>
	</tr>
	<tr>

	<td><b>Garments Item</b></td>
	<td>:&nbsp;
	<?
	$gmts_item_name="";
	$gmts_item=explode(',',$gmts_item_id);
	for($g=0;$g<=count($gmts_item); $g++)
	{
	$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
	}
	echo rtrim($gmts_item_name,',');
	?>
	</td>
	<td><b>Booking Release Date</b></td>
	<td>:&nbsp;
	<?
	$booking_date=$result[csf('update_date')];
	if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
	{
	$booking_date=$result[csf('insert_date')];
	}
	echo change_date_format($booking_date,'dd-mm-yyyy','-','');
	?>&nbsp;&nbsp;&nbsp;</td>
	<td><b>Style Ref.</b>   </td>
	<td>:&nbsp;<b>
	<?
	echo $style_sting;
	?>
	</b>
	</td>
	</tr>
	<tr>
	<td><b>Style Des.</b></td>
	<td>:&nbsp;<? echo $style_description;?></td>
	<td><b>Season</b></td>
	<td>:&nbsp;<? if($season_matrix!='') echo $season_matrix;else echo $season_buyer_wise; ?></td>
	<td><b>Dealing Merchandiser</b></td>
	<td>:&nbsp;<? echo $dealing_marchant; ?></td>
	</tr>

	<tr>
	<td><b>Supplier Name</b>   </td>
	<td>:&nbsp;
	<?
	if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3){
	echo $company_library[$result[csf('supplier_id')]];
	}
	else{
	echo $supplier_name_arr[$result[csf('supplier_id')]];
	}
	?>    </td>
	<td><b>Delivery Date</b></td>
	<td>:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
	<td style="font-size:14px"><b>Booking No </b>   </td>
	<td style="font-size:15px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?> <? //echo "(".$unit_of_measurement[$result[csf('uom')]].")"; $uom=$result[csf('uom')];?></td>
	</tr>
	<tr>
	<td><b>Attention</b></td>
	<td  >:&nbsp;<? echo $result[csf('attention')]; ?></td>
	<td><b>Lead Time </b>   </td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;">:&nbsp;
	<?
	echo $leadtime;
	?>
	</td>
	<td><b>Po Received Date</b></td>
	<td  >:&nbsp;<? echo $po_received_date; ?></td>
	</tr>
	<tr>
	<td><b>Order No</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;" colspan="3">:&nbsp;<? echo $po_number; ?></td>
	<td><b>Repeat No</b></td>
	<td  >:&nbsp;<? echo $order_repeat_no; ?></td>
	</tr>
	<tr>
	<td><b>Shipment Date</b></td>
<td colspan="3" style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> : First:&nbsp;<? echo rtrim($shipment_date,", "); //echo $max_pub_shipment_date; ?>, Last: <? echo $maxshipment_date; ?></td>
	<td><b>Quality Label</b></td>
	<td  >:&nbsp;<? echo $qlty_label; ?></td>
	</tr>
	</tr>
	<tr>
	<td><b>WO Prepared After</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
	<?
	$WOPreparedAfter=implode(",",array_unique(explode(",",chop($WOPreparedAfter,","))));
	echo $WOPreparedAfter.' Days' ;
	?></td>
 	<td><b>Ex-factory status</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
	<?
	echo $shiping_status;
	?></td>

	<td><b>Internal Ref No</b></td>
	<td> :&nbsp;<b><? echo $grouping; ?></b></td>



	</tr>
	<tr>

	<td><b>File no</b></td>
	<td> :&nbsp;<b><? echo  $file_no;?></b></td>
	<td><b>Currency</b></td>
	<td> :&nbsp;<b><? echo  $currency[$result[csf("currency_id")]];?></b></td>

	<td><b>Remarks</b></td>
	<td> :<? echo $result[csf('remarks')]?></td>


	</tr>

	<tr>
	<td><b>Fabric Composition</b></td>
	<td colspan="3"> :<? echo $result[csf('fabric_composition')]?></td>
	<td><b>Short Booking Type</b></td>
	<td> :&nbsp;<? echo $short_booking_type[$result[csf('short_booking_type')]]?></td>
	</tr>

	</table>
	<?
	}


	?>
	<br/>
	<!--  Here will be the main portion  -->
	<?
	$costing_per="";
	$costing_per_qnty=0;
	$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no in($job_no_in)");
	if($costing_per_id==1)
	{
	$costing_per="1 Dzn";
	$costing_per_qnty=12;

	}
	if($costing_per_id==2)
	{
	$costing_per="1 Pcs";
	$costing_per_qnty=1;

	}
	if($costing_per_id==3)
	{
	$costing_per="2 Dzn";
	$costing_per_qnty=24;

	}
	if($costing_per_id==4)
	{
	$costing_per="3 Dzn";
	$costing_per_qnty=36;

	}
	if($costing_per_id==5)
	{
	$costing_per="4 Dzn";
	$costing_per_qnty=48;
	}
	$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no in($job_no_in)");
 	$uom_arr=array(1=>"Pcs",12=>"Kg",23=>"Mtr",27=>"Yds");
	$p=1;
	/*foreach($uom_arr as $uom_id=>$uom_val)
	{ */
	if($cbo_fabric_source==1 or $cbo_fabric_source==2 or $cbo_fabric_source==3){
	$nameArray_fabric_description= sql_select("select a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , d.dia_width,d.pre_cost_remarks,a.uom,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,avg(d.rate) as rates,sum(d.amount) as amounts ,d.fabric_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_number_id=d.gmts_color_id and

	b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id
	and
	d.booking_no =$txt_booking_no and
	d.job_no='".$row_per_job[csf('job_no')]."' and

	d.status_active=1 and
	d.is_deleted=0 and
	b.cons>0
	group by a.id,a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,d.dia_width,d.pre_cost_remarks,a.uom ,d.fabric_color_id order by a.body_part_id,d.fabric_color_id,a.uom  ");
	/*echo "<pre>";
	print_r($nameArray_fabric_description);*/

	if(count($nameArray_fabric_description)>0){

	?>

	<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
	<caption> <strong>Fabric Booking Details </strong> </caption>

	<tr>
	<th  width="30" align="center">SL</th>
	<th  width="440" align="left">Item Description</th>
	<th  width="110" align="center">Fabric Color</th>
 	<th  width="120" align="center">UOM</th>
	<th width='120' align="center">Finish Fab. Qty</th>
	<th width='120' align="center">Fin. Fab. Qty With Proc. Loss</th>
	<th width='120' align="center">Avg Rate</th>
	<th width='100' align="center">Amount</th>

	</tr>
	<?
	$color_wise_process_loss=sql_select("select  a.body_part_id,b.fabric_color_id,avg(b.process_loss_percent) as loss FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls  b 	WHERE a.job_no=b.job_no  and  a.job_no='".$row_per_job[csf('job_no')]."' and b.is_short=1 and b.booking_no=$txt_booking_no   group by a.body_part_id,b.fabric_color_id
	");
	foreach($color_wise_process_loss as $val)
	{
		$loss_arr[$val[csf("body_part_id")]][$val[csf("fabric_color_id")]]=$val[csf("loss")];
	}


	foreach($nameArray_fabric_description as $val)
	{

		$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
	WHERE
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id and
	d.booking_no =$txt_booking_no and
	d.job_no='".$row_per_job[csf('job_no')]."' and
 	a.item_number_id='".$val[csf('item_number_id')]."' and
	a.body_part_id='".$val[csf('body_part_id')]."' and
	a.color_type_id='".$val[csf('color_type_id')]."' and
	a.construction='".$val[csf('construction')]."' and
	a.composition='".$val[csf('composition')]."' and
	a.gsm_weight='".$val[csf('gsm_weight')]."' and
 	d.pre_cost_remarks='".$val[csf('pre_cost_remarks')]."' and
	d.fabric_color_id='".$val[csf('fabric_color_id')]."' and
	d.status_active=1 and
	d.is_deleted=0
	");


	?>
	<tr>
	<td align="center"> <? echo $p; $p++;?></td>
 	<td align="left"> <? echo $body_part[$val[csf('body_part_id')]].','. $val[csf('construction')].','.$val[csf('composition')].','.$val[csf('gsm_weight')].',' .$val[csf('dia_width')].',' .$fabric_typee[$val[csf('width_dia_type')]].',' .$color_type[$val[csf('color_type_id')]]; ?> </td>
	<td  align="center">
	<?
	echo $color_library[$val[csf('fabric_color_id')]];
	?>
	</td>


	<td align="center"> <? echo $unit_of_measurement[$val[csf('uom')]]; ?></td>

	<td align="center"> <?   $greys= $color_wise_wo_sql_qnty[0][csf("fin_fab_qnty")];
	echo def_number_format($greys,2);
 	?> </td>
	<td align="center"> <? echo def_number_format($color_wise_wo_sql_qnty[0][csf("grey_fab_qnty")],2); ?> </td>
	<td align="center"> <? echo def_number_format($color_wise_wo_sql_qnty[0][csf("rate")],2); ?> </td>
	<td align="center"> <? echo def_number_format($color_wise_wo_sql_qnty[0][csf("amount")],2); ?> </td>
	<?
	$total_fin_fab_qnty +=str_replace(",", "", def_number_format($greys,2));
	$total_amount +=str_replace(",", "",def_number_format($color_wise_wo_sql_qnty[0][csf("amount")],2));
	$total_grey_fab_qnty +=str_replace(",", "",def_number_format($color_wise_wo_sql_qnty[0][csf("grey_fab_qnty")],2));
	//$total_rate +=str_replace(",", "",def_number_format($color_wise_wo_sql_qnty[0][csf("rate")],2));
	?>
	</tr>
	<?
	}
	$avgTotRate=$total_amount/$total_fin_fab_qnty;
	?>
	<tr style=" font-weight:bold">
	<td  align="right" colspan="4"><strong>Total</strong></td>
	<td align="center"><? echo def_number_format($total_fin_fab_qnty,2);?></td>
	<td align="center"><? echo def_number_format($total_grey_fab_qnty,2);?></td>
	<td align="center"><? echo def_number_format($avgTotRate,2);?></td>
	<td align="center"><? echo def_number_format($total_amount,2);?></td>

	</tr>

	</table>
	<br/>
	<?
	}
	}

		?>

      <br/>
       <br/>
        <!--New Start here-->
        <div style="width:1330px; float:left">
        <?
		// Body Part type used only Cuff and Flat Knit
        $colar_percent_size_wise_array=return_library_array( "select a.colar_cuff_per,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id and a.booking_no=$txt_booking_no and a.booking_type=1 and a.body_part_type in(40,50) and a.status_active=1 and a.is_deleted=0", "gmts_sizes", "colar_cuff_per");

		//echo  "select a.body_part_type,a.body_part_id,sum(d.rmg_qty) as rmg_qty,d.gmts_size,d.gmts_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d WHERE a.job_no=d.job_no and d.booking_no =$txt_booking_no and  a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 and d.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") group by a.body_part_type,a.body_part_id,d.gmts_size,d.gmts_color_id order by a.body_part_id";

		$nameArray_body_part=sql_select( "select a.body_part_type,a.body_part_id,sum(d.rmg_qty) as rmg_qty,d.gmts_size,d.gmts_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d WHERE a.job_no=d.job_no and d.booking_no =$txt_booking_no and  a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 and d.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.body_part_type in(40,50) group by a.body_part_type,a.body_part_id,d.gmts_size,d.gmts_color_id order by a.body_part_id");
			$row_count=count($nameArray_body_part);
		//if($row_count==0) echo " <p style='color:#f00; text-align:center; font-size:15px;'> Body part type is  used only Flat Knit and Cuff.</p> ";
		foreach($nameArray_body_part as $row)
		{
			$body_part_arr[$row[csf('body_part_id')]]['bpart_type']=$row[csf('body_part_type')];
			$body_part_rmg_qty_arr[$row[csf('body_part_id')]][$row[csf('gmts_size')]][$row[csf('gmts_color_id')]]['rmg_qty']+=$row[csf('rmg_qty')];
		}
		//print_r($body_part_arr);

		$k=1;
		foreach($body_part_arr as $body_id=>$val)
		{
			$k++;

			$bpart_type_id=$val['bpart_type'];
		$nameArray_item_size=sql_select( "select min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=$body_id  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 and a.body_part_type in(40,50) group by b.item_size,c.size_number_id order by id");

		/*$nameArray_item_size=sql_select( "select b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by c.size_number_id,b.item_size order by c.size_number_id");*/
		?>
         <div style="max-height:1330px; width:660px; overflow:auto; float:left; padding-top:20px; margin-left:5px; margin-bottom:5px; position: relative;">
        <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
        <tr>
        <td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b><? echo $body_part[$body_id];?> -  Colour Size Breakedown in Pcs</b></td>
        </tr>
        <tr>
        <td width="70">Size</td>
        <?
		foreach($nameArray_item_size  as $result_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
		<?
        }
        ?>
        <td rowspan="2" align="center"><strong>Total</strong></td>

        </tr>
        <tr>
        <td>Collar Size</td>

        <?
        foreach($nameArray_item_size  as $result_item_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
		<?
        }
        ?>
         <?

			$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=$body_id  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and a.body_part_type in(40,50) group by c.color_number_id,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			$color_total_collar=0;
			$color_total_collar_order_qnty=0;
			$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
			$constrast_color_arr=array();
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
				for($i=0;$i<count($constrast_color);$i++)
				{
					$constrast_color2=explode('_',$constrast_color[$i]);
					$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
				}
			}
		?>
			<tr>
            <td>
            <?
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
				$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
			}
			else
			{
				echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
				$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
			}
			?>

            </td>
            <?
            foreach($nameArray_item_size  as $result_size)
			{
				?>
				<td align="center" style="border:1px solid black">

				<?
				$rmg_qty=$body_part_rmg_qty_arr[$body_id][$result_size[csf('size_number_id')]][$color_wise_wo_result[csf('color_number_id')]]['rmg_qty'];
				//echo $bpart_type_id.'=';
				if($bpart_type_id==50)//Cuff
				{
					$tot_rmg_qty=$rmg_qty*2;
				}
				else //Flat Knit
				{
					$tot_rmg_qty=$rmg_qty;
				}
				//$color_wise_wo_sql_qnty=sql_select("select c.color_number_id,sum(c.order_quantity) as order_quantity, sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and c.color_number_id='".$color_wise_wo_result['color_number_id']."' and c.size_number_id='".$result_size['size_number_id']."'");
				/*$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active=1 and is_deleted =0");

				list($plan_cut_qnty)=$color_wise_wo_sql_qnty;*/
				//$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
				//$colar_excess_per=($plan_cut*$colar_excess_percent)/100;
				echo number_format($tot_rmg_qty,0);
				$color_total_collar+=$tot_rmg_qty;
				$color_total_collar_order_qnty+=$tot_rmg_qty;
				$grand_total_collar+=$tot_rmg_qty;
				$grand_total_collar_order_qnty+=$tot_rmg_qty;

				$size_tatal[$result_size[csf('size_number_id')]]+=$tot_rmg_qty;
				?>
                </td>
				<?
			}
			?>

            <td align="center"><? echo number_format($color_total_collar,0); ?></td>

            </tr>
            <?
		    }
			?>
            <tr>
                <td>Size Total</td>

                <?
                foreach($nameArray_item_size  as $result_size)
                {
					//$colar_excess_pers=($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100;
					$tot_size_tatal=$size_tatal[$result_size[csf('size_number_id')]];
					//$size_tatal[$result_size[csf('size_number_id')]]=0;
                ?>
                <td style="border:1px solid black;  text-align:center"><?  echo number_format($size_tatal[$result_size[csf('size_number_id')]],0);$size_tatal[$result_size[csf('size_number_id')]]=0; ?></td>
                <?
                }
                ?>
                <td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar,0);$grand_total_collar=0; ?></td>

            </tr>
        </table>
          <br/>
          </div>

        <?
		}

		?>
          <!--End here-->
       </div>
        <table style="display:none"  width="100%"  border="0" cellpadding="0" cellspacing="0" >
        <tr>
        <?
		//echo "select a.colar_cuff_per,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id    and a.booking_no=$txt_booking_no and a.booking_type=1 c.body_part_id in(2) and a.status_active=1 and a.is_deleted=0";
		$colar_percent_size_wise_array=return_library_array( "select a.colar_cuff_per,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id    and a.booking_no=$txt_booking_no and a.booking_type=1 and c.body_part_id in(2) and a.status_active=1 and a.is_deleted=0", "gmts_sizes", "colar_cuff_per");
		//print_r($colar_percent_size_wise_array);
		$nameArray_item_size=sql_select( "select min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");
		if(count($nameArray_item_size)>0)
		{
        ?>
        <td width="49%">
        <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
        <tr>
        <td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Collar -  Colour Size Brakedown in Pcs</b></td>
        </tr>
        <tr>
        <td width="70">Size</td>

        <?

		/*$nameArray_item_size=sql_select( "select b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by c.size_number_id,b.item_size order by c.size_number_id");*/
		foreach($nameArray_item_size  as $result_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
		<?
        }
        ?>
        <td rowspan="2" align="center"><strong>Total</strong></td>
        <td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
        </tr>
        <tr>
        <td>Collar Size</td>

        <?
        foreach($nameArray_item_size  as $result_item_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
		<?
        }
        ?>
         <?

			$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by c.color_number_id,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			$color_total_collar=0;
			$color_total_collar_order_qnty=0;
			$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
			$constrast_color_arr=array();
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
				for($i=0;$i<count($constrast_color);$i++)
				{
					$constrast_color2=explode('_',$constrast_color[$i]);
					$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
				}
			}
		?>
			<tr>
            <td>
            <?
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
				$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
			}
			else
			{
				echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
				$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
			}
			?>

            </td>
            <?
            foreach($nameArray_item_size  as $result_size)
			{
				?>
				<td align="center" style="border:1px solid black">
				<?
				//$color_wise_wo_sql_qnty=sql_select("select c.color_number_id,sum(c.order_quantity) as order_quantity, sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and c.color_number_id='".$color_wise_wo_result['color_number_id']."' and c.size_number_id='".$result_size['size_number_id']."'");
				$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active=1 and is_deleted =0");

				list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
				$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
				$colar_excess_per=($plan_cut*$colar_excess_percent)/100;
				echo number_format($plan_cut+$colar_excess_per,0);
				$color_total_collar+=$plan_cut+$colar_excess_per;
				$color_total_collar_order_qnty+=$plan_cut;
				$grand_total_collar+=$plan_cut+$colar_excess_per;
				$grand_total_collar_order_qnty+=$plan_cut;

				$size_tatal[$result_size[csf('size_number_id')]]+=$plan_cut+$colar_excess_per;
				?>
                </td>
				<?
			}
			?>

            <td align="center"><? echo number_format($color_total_collar,0); ?></td>
            <td align="center"><? echo number_format((($color_total_collar-$color_total_collar_order_qnty)/$color_total_collar_order_qnty)*100,2); ?></td>
            </tr>
            <?
		    }
			?>
            <tr>
                <td>Size Total</td>

                <?
                foreach($nameArray_item_size  as $result_size)
                {
                ?>
                <td style="border:1px solid black;  text-align:center"><? $colar_excess_pers=($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]+$colar_excess_pers,0); ?></td>
                <?
                }
                ?>
                <td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar,0); ?></td>
                <td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_collar-$grand_total_collar_order_qnty)/$grand_total_collar_order_qnty)*100,2); ?></td>
            </tr>
        </table>
        </td>
        <td width="2%">
        </td>
        <?
        }
		?>

        <?
		$cuff_percent_size_wise_array=return_library_array( "select a.colar_cuff_per,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id    and a.booking_no=$txt_booking_no and a.booking_type=1 and c.body_part_id in(3) and a.status_active=1 and a.is_deleted=0", "gmts_sizes", "colar_cuff_per");
		//print_r($cuff_percent_size_wise_array);
		$nameArray_item_size=sql_select( "select min(c.id) as id, b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by id");

		if(count($nameArray_item_size)>0)
		{
        ?>
        <td width="49%">
        <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
        <tr>
        <td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Cuff -  Colour Size Brakedown in Pcs</b></td>
        </tr>
        <tr>
        <td width="70">Size</td>

        <?
		foreach($nameArray_item_size  as $result_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
		<?
        }
        ?>
        <td rowspan="2" align="center"><strong>Total</strong></td>
        <td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
        </tr>
        <tr>
        <td>Cuff Size</td>

        <?
        foreach($nameArray_item_size  as $result_item_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
		<?
        }
        ?>
         <?

			$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=3  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and  d.status_active=1 and d.is_deleted=0 group by c.color_number_id ,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			$color_total_cuff=0;
			$color_total_cuff_order_qnty=0;
			$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
			$constrast_color_arr=array();
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
				for($i=0;$i<count($constrast_color);$i++)
				{
					$constrast_color2=explode('_',$constrast_color[$i]);
					$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
				}
			}
			//print_r($constrast_color_arr);
		?>
			<tr>
            <td>
            <?
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				///echo $color_wise_wo_result[csf('color_number_id')];
				echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]);
				$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
			}
			else
			{
				echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
				$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
			}
			?>

            </td>
            <?
            foreach($nameArray_item_size  as $result_size)
			{
				?>
				<td align="center" style="border:1px solid black">

				<?
				/*$color_wise_wo_sql_qnty=sql_select("select c.color_number_id,sum(c.order_quantity) as order_quantity, sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=3 and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and c.color_number_id='".$color_wise_wo_result['color_number_id']."' and c.size_number_id='".$result_size['size_number_id']."'");*/
				$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active=1 and is_deleted =0");

				list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
				$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
				$cuff_excess_per=(($plan_cut*2)*$cuff_excess_percent)/100;
				echo number_format($plan_cut*2+$cuff_excess_per,0);
				$color_total_cuff+=$plan_cut*2+$cuff_excess_per;
				$color_total_cuff_order_qnty+=$plan_cut*2;
				$grand_total_cuff+=$plan_cut*2+$cuff_excess_per;
				$grand_total_cuff_order_qnty+=$plan_cut*2;
				$size_tatal[$result_size[csf('size_number_id')]]+=($plan_cut*2+$cuff_excess_per);
				/*$cuff_excess_per=(($plan_cut_qnty[csf('plan_cut_qnty')]*2)*$cuff_excess_percent)/100;
				echo number_format($plan_cut_qnty[csf('plan_cut_qnty')]*2+$cuff_excess_per,0);
				$color_total_cuff+=$plan_cut_qnty[csf('plan_cut_qnty')]*2+$cuff_excess_per;
				$color_total_cuff_order_qnty+=$plan_cut_qnty[csf('order_quantity')]*2;
				$grand_total_cuff+=$plan_cut_qnty[csf('plan_cut_qnty')]*2+$cuff_excess_per;
				$grand_total_cuff_order_qnty+=$plan_cut_qnty[csf('order_quantity')]*2;*/

				?>

                </td>
				<?
			}
			?>

            <td align="center"><? echo number_format($color_total_cuff,0); ?></td>
            <td align="center"><? echo number_format((($color_total_cuff-$color_total_cuff_order_qnty)/$color_total_cuff_order_qnty)*100,2); ?></td>
            </tr>
            <?
		    }
			?>
            <tr>
                <td>Size Total</td>

                <?
                foreach($nameArray_item_size  as $result_size)
                {
                   /* $nameArray_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =$result_size[size_number_id]  and status_active=1 and is_deleted =0 order by id");
                foreach($nameArray_size_qnty as $result_size_qnty)
                {*/
                ?>
                <td style="border:1px solid black;  text-align:center"><? $cuff_excess_pers=(($size_tatal[$result_size[csf('size_number_id')]]*2)*$cuff_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]*2+$cuff_excess_pers,0); ?></td>
                <?
                //}
                }
                ?>
                <td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_cuff,0); ?></td>
                <td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_cuff-$grand_total_cuff_order_qnty)/$grand_total_cuff_order_qnty)*100,2); ?></td>
            </tr>
        </table>
        </td>
        <?
				}
		?>
        </tr>
        </table>
        <br/>
        <table  width="100%"  border="0" cellpadding="0" cellspacing="0" >
        <tr>
        <?

		//echo "select a.colar_cuff_per,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id    and a.booking_no=$txt_booking_no and a.booking_type=1 c.body_part_id in(2) and a.status_active=1 and a.is_deleted=0";
		//$colar_percent_size_wise_array=return_library_array( "select a.colar_cuff_per,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id    and a.booking_no=$txt_booking_no and a.booking_type=1 and c.body_part_id in(2) and a.status_active=1 and a.is_deleted=0", "gmts_sizes", "colar_cuff_per");


		$colar_percent_size_wise_array=array();
		$colar_tipping_percent_size_wise_sql=sql_select( "select a.colar_cuff_per,b.color_number_id,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id    and a.booking_no=$txt_booking_no and a.booking_type=1 and c.body_part_id in(172) and a.status_active=1 and a.is_deleted=0");
		$colar_tipping_excess_percent_arr=array();
		foreach($colar_tipping_percent_size_wise_sql as $colar_percent_size_wise_row)
		{
			$colar_tipping_excess_percent_arr[$colar_percent_size_wise_row[csf('color_number_id')]][$colar_percent_size_wise_row[csf('gmts_sizes')]]=$colar_percent_size_wise_row[csf('colar_cuff_per')];
			//$colar_excess_percent_arr[$colar_percent_size_wise_row[csf('gmts_sizes')]]+=$colar_percent_size_wise_row[csf('colar_cuff_per')];

		}

		//print_r($colar_tipping_excess_percent_arr);
		$nameArray_item_size=sql_select( "select min(c.id) as id,b.item_size,c.size_number_id,	min(c.size_order) as size_order FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=172  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by size_order");


		if(count($nameArray_item_size)>0)
		{
        ?>
        <td width="49%">
        <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
        <tr>
        <td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Collar Tipping -  Colour Size Brakedown in Pcs</b></td>
        </tr>
        <tr>
        <td width="70">Size</td>

        <?

		/*$nameArray_item_size=sql_select( "select b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by c.size_number_id,b.item_size order by c.size_number_id");*/
		foreach($nameArray_item_size  as $result_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
		<?
        }
        ?>
        <td rowspan="2" align="center"><strong>Total</strong></td>
        <td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
        </tr>
        <tr>
        <td>Collar Size</td>

        <?
        foreach($nameArray_item_size  as $result_item_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
		<?
        }

		$color_wise_wo_sql=sql_select("select a.id, a.job_no, a.color_size_sensitive, a.color_break_down, a.process_loss_method, c.color_number_id , c.color_order, sum(c.plan_cut_qnty) as plan_cut_qnty
		FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c, wo_booking_dtls d
		WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=172 and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and c.status_active=1 and c.is_deleted=0
		group by c.color_number_id, c.color_order, a.id, a.job_no, a.color_size_sensitive,a.color_break_down, a.process_loss_method
		order by c.color_order ");

		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			$color_total_collar=0;
			$color_total_collar_order_qnty=0;
			$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
			$constrast_color_arr=array();
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
				for($i=0;$i<count($constrast_color);$i++)
				{
					$constrast_color2=explode('_',$constrast_color[$i]);
					$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
				}
			}
		?>
			<tr>
            <td>
            <?
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
				$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
			}
			else
			{
				echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
				$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
			}
			?>

            </td>
            <?
            foreach($nameArray_item_size  as $result_size)
			{
				?>
				<td align="center" style="border:1px solid black">
				<?

				$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active=1 and is_deleted =0 ");




				list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
				$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
				$colar_tipping_excess_per=($plan_cut*$colar_tipping_excess_percent_arr[$color_wise_wo_result[csf('color_number_id')]][$result_size[csf('size_number_id')]])/100;
				echo number_format($plan_cut+$colar_tipping_excess_per,0);
				$collar_tiff_size_total_arr[$result_size[csf('size_number_id')]]+=number_format($plan_cut+$colar_tipping_excess_per,0,'','');
				$color_tipping_total_collar+=$plan_cut+$colar_tipping_excess_per;
				$color_tipping_total_collar_order_qnty+=$plan_cut;
				$grand_total_collar_tipping+=$plan_cut+$colar_tipping_excess_per;
				$grand_total_collar_tipping_order_qnty+=$plan_cut;



				?>
                </td>
				<?
			}
			?>

            <td align="center"><? echo number_format($color_tipping_total_collar,0); ?></td>
            <td align="center"><? echo number_format((($color_tipping_total_collar-$color_tipping_total_collar_order_qnty)/$color_tipping_total_collar_order_qnty)*100,2); ?></td>
            </tr>
            <?
		    }
			?>
            <tr>
                <td>Size Total</td>

                <?
                foreach($nameArray_item_size  as $result_size)
                {
                ?>
                <td style="border:1px solid black;  text-align:center">
				<?
				//$colar_excess_pers=($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]+$colar_excess_pers,0);
				echo number_format($collar_tiff_size_total_arr[$result_size[csf('size_number_id')]],0);

				?></td>
                <?
                }
                ?>
                <td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar_tipping,0); ?></td>
                <td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_collar_tipping-$grand_total_collar_tipping_order_qnty)/$grand_total_collar_tipping_order_qnty)*100,2); ?></td>
            </tr>
        </table>
        </td>
        <td width="2%">
        </td>
        <?
        }

		$cuff_tipping_percent_size_wise_array=$cuff_size_total=array();
		$cuff_tipping_percent_size_wise_sql=sql_select( "select a.colar_cuff_per,b.color_number_id,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id  and a.booking_no=$txt_booking_no and a.booking_type=1 and c.body_part_id in(214) and a.status_active=1 and a.is_deleted=0");
		foreach($cuff_tipping_percent_size_wise_sql as $cuff_percent_size_wise_row)
		{
			$cuff_tipping_percent_size_wise_array[$cuff_percent_size_wise_row[csf('color_number_id')]][$cuff_percent_size_wise_row[csf('gmts_sizes')]]=$cuff_percent_size_wise_row[csf('colar_cuff_per')];
		}


		$nameArray_item_size=sql_select( "select min(c.id) as id, b.item_size,c.size_number_id,	min(c.size_order) as size_order FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=214  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by b.item_size,c.size_number_id order by size_order");


		if(count($nameArray_item_size)>0)
		{
        ?>
        <td width="49%">
        <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
        <tr>
        <td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b>Cuff Tipping-  Colour Size Brakedown in Pcs</b></td>
        </tr>
        <tr>
        <td width="70">Size</td>

        <?
		foreach($nameArray_item_size  as $result_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
		<?
        }
        ?>
        <td rowspan="2" align="center"><strong>Total</strong></td>
        <td width="60" rowspan="2" align="center"><strong>Extra %</strong></td>
        </tr>
        <tr>
        <td>Cuff Size</td>

        <?
        foreach($nameArray_item_size  as $result_item_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
		<?
        }
        ?>
         <?

			$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id, c.color_order, sum(c.plan_cut_qnty) as plan_cut_qnty
			FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d
			WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=214  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and  d.status_active=1 and d.is_deleted=0
			group by c.color_number_id, c.color_order ,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method
			order by c.color_order");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			$color_total_cuff=0;
			$color_total_cuff_order_qnty=0;
			$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
			$constrast_color_arr=array();
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
				for($i=0;$i<count($constrast_color);$i++)
				{
					$constrast_color2=explode('_',$constrast_color[$i]);
					$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
				}
			}
		?>
			<tr>
            <td>
            <?
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]);
				$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
			}
			else
			{
				echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
				$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
			}
			?>

            </td>
            <?
            foreach($nameArray_item_size  as $result_size)
			{
				?>
				<td align="center" style="border:1px solid black">

				<?


				$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active=1 and is_deleted =0");



				list($plan_cut_qnty)=$color_wise_wo_sql_qnty;
				$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
				$cuff_tipping_excess_per=(($plan_cut*2)*$cuff_tipping_percent_size_wise_array[$color_wise_wo_result[csf('color_number_id')]][$result_size[csf('size_number_id')]])/100;
				echo number_format($plan_cut*2+$cuff_tipping_excess_per,0);
				$cuff_tiffing_size_total[$result_size[csf('size_number_id')]]+=number_format($plan_cut*2+$cuff_tipping_excess_per,0,'','');
				//echo $cuff_tipping_percent_size_wise_array[$color_wise_wo_result[csf('color_number_id')]][$result_size[csf('size_number_id')]];
				$color_total_cuff_tiffing+=$plan_cut*2+$cuff_tipping_excess_per;
				$color_total_cuff_tiffing_order_qnty+=$plan_cut*2;
				$grand_total_cuff_tiffing+=$plan_cut*2+$cuff_tipping_excess_per;
				$grand_total_cuff_tiffing_order_qnty+=$plan_cut*2;
				?>

                </td>
				<?
			}
			?>

            <td align="center"><? echo number_format($color_total_cuff_tiffing,0); ?></td>
            <td align="center"><? echo number_format((($color_total_cuff_tiffing-$color_total_cuff_tiffing_order_qnty)/$color_total_cuff_tiffing_order_qnty)*100,2);  ?></td>
            </tr>
            <?
		    }
			?>
            <tr>
                <td>Size Total</td>

                <?
                foreach($nameArray_item_size  as $result_size)
                {
                   /* $nameArray_size_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =$result_size[size_number_id]  and status_active=1 and is_deleted =0 order by id");
                foreach($nameArray_size_qnty as $result_size_qnty)
                {*/
                ?>
                <td style="border:1px solid black;  text-align:center">
				<?
				//$cuff_excess_pers=(($size_tatal[$result_size[csf('size_number_id')]]*2)*$cuff_excess_percent)/100; echo number_format($size_tatal[$result_size[csf('size_number_id')]]*2+$cuff_excess_pers,0);
				echo number_format($cuff_tiffing_size_total[$result_size[csf('size_number_')]],0);
				?></td>
                <?
                //}
                }
                ?>
                <td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_cuff_tiffing,0); ?></td>
                <td align="center" style="border:1px solid black"> <? echo number_format((($grand_total_cuff_tiffing-$grand_total_cuff_tiffing_order_qnty)/$grand_total_cuff_tiffing_order_qnty)*100,2); ?></td>
            </tr>
        </table>
        </td>
        <?
				}
		?>
        </tr>
        </table>
 <br>
 <br/>
	<?
	$txt_job_no=str_replace("'","",$txt_job_no);
	$color_name_arr=return_library_array( "SELECT id,color_name from lib_color where status_active =1 and is_deleted=0",'id','color_name');
	$sql_stripe="SELECT c.id, c.composition, c.construction, c.body_part_id, c.fabric_description, c.gsm_weight, c.color_type_id, sum(b.grey_fab_qnty) as fab_qty, b.dia_width, d.gmts_color_id, d.fabric_color_id, d.id as did, d.stripe_color, d.fabreqtotkg as fabreqtotkg, d.measurement as measurement, d.yarn_dyed, d.uom, b.job_no from wo_booking_dtls b, wo_pre_cost_fabric_cost_dtls c, wo_short_stripe_color d where c.id=b.pre_cost_fabric_cost_dtls_id and c.job_no=b.job_no and d.fabric_cost_dtls_id=c.id and d.fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and b.job_no=d.job_no and b.id=d.dtls_id and b.job_no in('$txt_job_no')  and d.job_no in('$txt_job_no') and b.booking_no=$txt_booking_no and c.color_type_id in (2,3,4,6,31,32,33,34) and b.status_active=1 and c.is_deleted=0 and c.status_active=1  and d.is_deleted=0 and d.status_active=1  and b.is_deleted=0  group by c.id, c.body_part_id, c.fabric_description, c.gsm_weight, c.color_type_id, d.gmts_color_id, d.fabric_color_id, d.id, d.stripe_color, d.yarn_dyed, d.fabreqtotkg, d.measurement, d.uom, c.composition, c.construction, b.dia_width, b.job_no order by b.job_no,d.id,d.stripe_color ASC ";
	$result_data=sql_select($sql_stripe);

	foreach($result_data as $row)
	{
		if($row[csf('fabric_color_id')]==0 || $row[csf('fabric_color_id')]=="") $row[csf('color_number_id')]=$row[csf('gmts_color_id')]; else $row[csf('color_number_id')]=$row[csf('fabric_color_id')];
		
		$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['stripe_color'][$row[csf('did')]]=$row[csf('stripe_color')];
		$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['measurement'][$row[csf('did')]]=$row[csf('measurement')];
		$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['uom'][$row[csf('did')]]=$row[csf('uom')];
		$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['fabreqtotkg'][$row[csf('did')]]=$row[csf('fabreqtotkg')];
		$stripe_arr[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['yarn_dyed'][$row[csf('did')]]=$row[csf('yarn_dyed')];

		$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['composition']=$row[csf('composition')];
		$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['construction']=$row[csf('construction')];
		$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['gsm_weight']=$row[csf('gsm_weight')];
		$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['color_type_id']=$row[csf('color_type_id')];
		$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['dia_width']=$row[csf('dia_width')];
		$stripe_arr2[$row[csf('body_part_id')]][$row[csf('color_number_id')]]['job_no']=$row[csf('job_no')];
		$tot_stripe_measurement_arr[$row[csf('color_number_id')]]+=$row[csf('measurement')];
	}
	//echo $tot_stripe_measurement;

	if(count($stripe_arr)>0)
	{
		?>
		<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
			<tr>
	             <td colspan="9" align="center"><b>Stripe Details</b></td>
	        </tr>

	        <tr align="center">
	        	<th width="30"> SL</th>
	        	<th width="50"> Job</th>
	            <th width="100"> Body Part</th>
	            <th width="80"> Fabric Color</th>
	            <th width="70"> Fabric Qty(KG)</th>
	            <th width="70"> Stripe Color</th>
	            <th width="70"> Stripe Measurement</th>
	            <th width="70"> Stripe Uom</th>
	            <th width="70"> Qty.(KG)</th>
	            <th width="70"> Y/D Req.</th>
	        </tr>

	        <?
			$i=1;$total_fab_qty=0;
			$total_fabreqtotkg=0;
			$fab_data_array=array();
			$stripe_wise_fabkg_arr=array();

			$stripe_wise_fabkg_sql="SELECT a.job_no,a.body_part_id,a.color_type_id,b.fabric_color_id, sum(b.fin_fab_qnty) as fin_fab_qnty,sum(b.grey_fab_qnty) as grey_fab_qnty  from wo_pre_cost_fabric_cost_dtls a,wo_booking_dtls b where  a.color_type_id=2 and a.job_no=b.job_no  and b.booking_no=$txt_booking_no
			and a.id=b.pre_cost_fabric_cost_dtls_id  and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 group by a.job_no,a.body_part_id,a.color_type_id,b.fabric_color_id";
			foreach(sql_select($stripe_wise_fabkg_sql) as $keys=>$vals)
			{
				$stripe_wise_fabkg_arr[$vals[csf("job_no")]][$vals[csf("body_part_id")]][$vals[csf("color_type_id")]][$vals[csf("fabric_color_id")]] +=$vals[csf("grey_fab_qnty")];
			}
	        foreach($stripe_arr as $body_id=>$body_data)
	        {
				foreach($body_data as $color_id=>$color_val)
				{
					$rowspan=count($color_val['stripe_color']);
					$composition=$stripe_arr2[$body_id][$color_id]['composition'];
					$construction=$stripe_arr2[$body_id][$color_id]['construction'];
					$gsm_weight=$stripe_arr2[$body_id][$color_id]['gsm_weight'];
					$color_type_id=$stripe_arr2[$body_id][$color_id]['color_type_id'];
					$dia_width=$stripe_arr2[$body_id][$color_id]['dia_width'];

					if($db_type==0) $color_cond="d.fabric_color_id='".$color_id."'";
					else if($db_type==2) $color_cond="nvl(d.fabric_color_id,0)=nvl('".$color_id."',0)";

					$color_wise_wo_sql_qnty=sql_select("SELECT a.job_no, sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
						WHERE a.job_no=b.job_no and
						a.id=b.pre_cost_fabric_cost_dtls_id and
						c.job_no_mst=a.job_no and
						c.id=b.color_size_table_id and
						b.po_break_down_id=d.po_break_down_id and
						b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
						d.booking_no =$txt_booking_no and
						a.body_part_id='".$body_id."' and
						a.color_type_id='".$color_type_id."' and
						a.construction='".$construction."' and
						a.composition='".$composition."' and
						a.gsm_weight='".$gsm_weight."' and
						$color_cond and
						d.status_active=1 and
						d.is_deleted=0 group by a.job_no
						");
						list($color_wise_wo_result_qnty)=$color_wise_wo_sql_qnty;
					?>
					<tr>
						<?

						//$color_qty=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
						$jobs=$stripe_arr2[$body_id][$color_id]['job_no'];
						$color_qty=$stripe_wise_fabkg_arr[$jobs][$body_id][$color_type_id][$color_id];
						?>
						<td rowspan="<? echo $rowspan;?>"> <? echo $i; ?></td>
						<td rowspan="<? echo $rowspan;?>"> <? echo $jobs; ?></td>
						<td rowspan="<? echo $rowspan;?>"> <? echo $body_part[$body_id]; ?></td>
						<td rowspan="<? echo $rowspan;?>"> <? echo $color_name_arr[$color_id]; ?></td>
						<td rowspan="<? echo $rowspan;?>" align="right"> <? echo number_format($color_qty,2); ?></td>
						<?
						//$total_fab_qty+=$color_wise_wo_result_qnty[csf('grey_fab_qnty')];
						$tot_stripe_measurement=$tot_stripe_measurement_arr[$color_id];

						$total_fab_qty+=$color_qty;
						foreach($color_val['stripe_color'] as $strip_color_id=>$s_color_val)
						{
							$measurement=$color_val['measurement'][$strip_color_id];
							$uom=$color_val['uom'][$strip_color_id];
							$fabreqtotkg=($measurement/$tot_stripe_measurement)*$color_qty;//$color_val['fabreqtotkg'][$strip_color_id];
							$yarn_dyed=$color_val['yarn_dyed'][$strip_color_id];
							?>
							<td><?  echo  $color_name_arr[$s_color_val]; ?></td>
							<td align="right"> <? echo  number_format($measurement,2); ?></td>
		                    <td> <? echo  $unit_of_measurement[$uom]; ?></td>
							<td align="right" title="Stripe Measurement/Tot Stripe Measurement(<? echo $tot_stripe_measurement;?>)*Fabric Qty(KG)"> <? echo  number_format($fabreqtotkg,2); ?></td>
							<td> <? echo  $yes_no[$yarn_dyed]; ?></td>
					</tr>
							<?
							$total_fabreqtotkg+=$fabreqtotkg;
						}
							$i++;
				}
			}
			?>
	        <tfoot>
	        	<tr>
	        		<td colspan="4">Total </td>
	        		<td align="right">  <? echo  number_format($total_fab_qty,2); ?> </td>
	        		<td></td>
	        		<td></td>
	        		<td>   </td>
	        		<td align="right"><? echo  number_format($total_fabreqtotkg,2); ?> </td>
	        	</tr>
	        </tfoot>
		</table>
		<?
	}
	?>

	<br/>
        <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

        <tr>
        <td colspan="10" align="center">
        <strong>Comments</strong>
        </td>

        </tr>

        <tr>
	        <td align="center"> SL </td>
	        <td align="center"> PO NO </td>
	        <td align="center"> Ship Date </td>
	        <td align="center"> BOM Qty</td>
	        <td align="center"> Booking Qty </td>
	        <td align="center"> Short Booking Qty </td>
	        <td align="center"> Total Booking Qty </td>
	        <td align="center"> Balance </td>
	        <td align="center"> Comments </td>
         </tr>
        <?
        $is_short_data=sql_select("select a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0   and b.is_short =1 group by  a.id ");
        foreach($is_short_data as $vals)
        {
        	$short_qty_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
        }

        $booking_data=sql_select("select a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and  b.status_active=1 and b.is_deleted=0 and b.is_short !=1 group by  a.id ");
        foreach($booking_data as $vals)
        {
        	$booking_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
        }
        $po_num_arr=return_library_array("select id,po_number from wo_po_break_down where status_active=1 and is_deleted=0",'id','po_number');

        $po_date=return_library_array("select id,shipment_date from wo_po_break_down where status_active=1 and is_deleted=0",'id','shipment_date');

    $comments_data=sql_select("SELECT min(a.id) as ids,b.po_break_down_id as po_number,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,SUM(b.requirment) as precost_grey_qty FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id
	and
	b.po_break_down_id=d.po_break_down_id and
	b.color_number_id=d.gmts_color_id and
	b.dia_width=d.dia_width and
	b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id
	and
	d.booking_no =$txt_booking_no and
	d.job_no='".$row_per_job[csf('job_no')]."' and

	d.status_active=1 and
	d.is_deleted=0 and
	b.cons>0
	group by b.po_break_down_id");


	$job_no=$row_per_job[csf('job_no')];
 	$condition= new condition();
	if(str_replace("'","",$job_no) !='')
	{
	  $condition->job_no("='$job_no'");
 	}
	 $condition->init();
	$fabric= new fabric($condition);
	$fabric_costing_qty_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish();

        $j=1;
        $total_bom=0;
        $total_book=0;
        $total_short=0;
        $total_short_full=0;
        $total_balance=0;

		foreach($comments_data as $val)
		{
				$po_id=$val[csf('po_number')];
			 	$woven_qty=array_sum($fabric_costing_qty_arr['woven']['grey'][$po_id]);
			 	$knit_qty=array_sum($fabric_costing_qty_arr['knit']['grey'][$po_id]);
			 	$sum_woven_knit=$woven_qty + $knit_qty;
			?>
          <tr>
        <td align="center"><? echo $j;?></td>

        <td align="center"> <? echo $po_num_arr[$val[csf("po_number")]] ;?> </td>
        <td align="center"> <? echo change_date_format($po_date[$val[csf("po_number")]], "yyyy-mm-dd", "-");?> </td>
        <td align="center"><?  echo $pre= def_number_format($sum_woven_knit,2);  ?> </td>
         <td align="center"><?  echo $bookings= def_number_format($booking_arr[$val[csf("po_number")]],2);  ?> </td>
 		<td align="center"> <? echo $short=def_number_format($short_qty_arr[$val[csf("po_number")]],2); ?> </td>
		<td align="center"> <?  $tot_short_book= str_replace(',','',$bookings) +  str_replace(',','',$short); number_format($tot_short_book,2); ?>  </td>
		<td align="center"> <? $bal =str_replace(',','',$pre)-str_replace(',','',$tot_short_book); number_format($bal,2) ?> </td>
		<td align="center"> <? if($bal!=0){ if(str_replace(',','',$pre)>$tot_short_book){echo "Less ";} else{ echo "Over";} }?> </td>
        </tr>
        <?
        $total_bom +=str_replace(',','',$pre);
        $total_book +=str_replace(',','',$bookings);
        $total_short +=str_replace(',','',$short);
        $total_short_full += str_replace(',','',$tot_short_book);
        $total_balance += str_replace(',','',$bal);
        $j++;
		}
		?>
		<tr>
			<td colspan="3" align="right"> <b> Total </b></td>
			<td align="center"><strong><? echo number_format($total_bom,2);?> </strong> </td>
			<td align="center"><strong><? echo number_format($total_book,2);?> </strong> </td>
			<td align="center"><strong><? echo number_format($total_short,2);?> </strong> </td>
			<td align="center"><strong><? echo number_format($total_short_full,2);?> </strong> </td>
			<td align="center"><strong><? echo number_format($total_balance,2);?> </strong> </td>
			<td>&nbsp;</td>
		</tr>
        </table>
<br> <br>
        <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
        	<tr>
        		<th>Responsible Dept.</th>
        		<th>Responsible Person</th>
        		<th>Reason</th>
        	</tr>
        	<tr>
        		<td>
        			<?
        				$all_dept_name="";
        				$department_name_library=return_library_array( "select id,department_name from  lib_department where status_active=1 and is_deleted=0 order by  department_name", "id", "department_name"  );
        				$all_dept=array_unique(explode(",", implode(",",$job_data_arr['responsible_dept'])));
        				foreach ($all_dept as $value)
        				{
        					$all_dept_name.=$department_name_library[$value].",";
        				}
        				echo chop($all_dept_name, ",");
        			?>
        		</td>
        		<td><? echo implode(",", array_unique($job_data_arr['responsible_person'])); ?></td>
        		<td><? echo implode(",", array_unique($job_data_arr['reason'])); ?></td>
        	</tr>
        </table>

        <br>
	<table width="100%"   cellpadding="2" cellspacing="0" rules="all" style="border-left: none;border-right: none;border-top: none;border-bottom: none;">
		<tr>
		 	<td align="left" style="border-left: none;border-right: none;border-top: none;border-bottom: none;">
		 		<img  src='<? echo $path.$imge_arr[$job_no]; ?>' height='180' width='250' />
		 	</td>
		 	<td align="right" width="650" style="border-left: none;border-right: none;border-top: none;border-bottom: none;">
		 		<?php echo get_spacial_instruction($txt_booking_no); ?>
		 	</td>
		</tr>
	</table>
	<br>

	<?
	echo signature_table(4, $cbo_company_name, "1330px");
	?>
    <p class=""></p>

    <?
	}
	$job_no_all= implode(",",array_unique($joball['job_no']));
	$style_sting_all=implode(",",array_unique($joball['style_ref_no']));

	echo "****".custom_file_name($txt_booking_no,$style_sting_all,$job_no_all);
	?>
	</div>
	<?
	exit();
}
if($action=="print_booking_7")//Sakib 19-07-2023
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$imge_arr=return_library_array( "select master_tble_id,image_location from common_photo_library where form_name='company_details' or form_name='knit_order_entry' and file_type=1",'master_tble_id','image_location');

	$company_library=return_library_array( "select id,company_name from lib_company", "id", "company_name");
	$color_library=return_library_array( "select id,color_name from lib_color where status_active =1 and is_deleted=0", "id", "color_name");
	$size_library=return_library_array( "select id,size_name from lib_size where status_active =1 and is_deleted=0", "id", "size_name");
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from lib_supplier",'id','supplier_name');
	$department_name_library_arr=return_library_array( "select id,department_name from  lib_department  order by  department_name", "id", "department_name"  );
	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');

	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	$season_arr=return_library_array("select id,season_name from lib_buyer_season","id","season_name");
	$uom=0;
	$joball=array();
	$nameArray_per_job=sql_select( "select  a.job_no,a.style_ref_no  from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by a.job_no,a.style_ref_no");
	foreach ($nameArray_per_job as $row_per_job){
	$joball['job_no'][$row_per_job[csf('job_no')]]=$row_per_job[csf('job_no')];
	$joball['style_ref_no'][$row_per_job[csf('job_no')]]=$row_per_job[csf('style_ref_no')];

	$uom=0;
	$job_data_arr=array();
	$nameArray_buyer=sql_select( "select  a.style_ref_no,a.style_description, a.job_no, a.style_owner, a.buyer_name, b.responsible_dept, b.responsible_person, b.reason, a.dealing_marchant,a.season,a.season_matrix,a.season_buyer_wise,a.total_set_qnty,a.product_dept,a.product_code,a.pro_sub_dep,a.gmts_item_id ,a.order_repeat_no,a.qlty_label  from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0 and a.job_no='".$row_per_job[csf('job_no')]."'");
	foreach ($nameArray_buyer as $result_buy){
	$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
	$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
	$job_data_arr['total_set_qnty'][$result_buy[csf('job_no')]]=$result_buy[csf('total_set_qnty')];
	$job_data_arr['product_dept'][$result_buy[csf('job_no')]]=$product_dept[$result_buy[csf('product_dept')]];
	$job_data_arr['product_code'][$result_buy[csf('job_no')]]=$result_buy[csf('product_code')];
	$job_data_arr['pro_sub_dep'][$result_buy[csf('job_no')]]=$pro_sub_dept_array[$result_buy[csf('pro_sub_dep')]];
	$job_data_arr['gmts_item_id'][$result_buy[csf('job_no')]]=$result_buy[csf('gmts_item_id')];
	$job_data_arr['style_ref_no'][$result_buy[csf('job_no')]]=$result_buy[csf('style_ref_no')];
	$job_data_arr['style_description'][$result_buy[csf('job_no')]]=$result_buy[csf('style_description')];
	$job_data_arr['dealing_marchant'][$result_buy[csf('job_no')]]=$marchentrArr[$result_buy[csf('dealing_marchant')]];
	$job_data_arr['season_matrix'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_matrix')]];
	$job_data_arr['season_buyer_wise'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_buyer_wise')]];
	$job_data_arr['order_repeat_no'][$result_buy[csf('job_no')]]=$result_buy[csf('order_repeat_no')];
	$job_data_arr['qlty_label'][$result_buy[csf('job_no')]]=$quality_label[$result_buy[csf('qlty_label')]];
	$job_data_arr['responsible_person'][$result_buy[csf('responsible_person')]]=$result_buy[csf('responsible_person')];
	$job_data_arr['responsible_dept'][$result_buy[csf('responsible_dept')]]=$result_buy[csf('responsible_dept')];
	$job_data_arr['reason'][$result_buy[csf('reason')]]=$result_buy[csf('reason')];
	}

	$job_no= implode(",",array_unique($job_data_arr['job_no']));
	$job_no_in= implode(",",array_unique($job_data_arr['job_no_in']));
	$product_depertment=implode(",",array_unique($job_data_arr['product_dept']));
	$product_code=implode(",",array_unique($job_data_arr['product_code']));
	$pro_sub_dep=implode(",",array_unique($job_data_arr['pro_sub_dep']));
	$gmts_item_id=implode(",",array_unique($job_data_arr['gmts_item_id']));
	$style_sting=implode(",",array_unique($job_data_arr['style_ref_no']));
	$style_description=implode(",",array_unique($job_data_arr['style_description']));
	$dealing_marchant=implode(",",array_unique($job_data_arr['dealing_marchant']));
	$season_matrix=implode(",",array_unique($job_data_arr['season_matrix']));
	$season_buyer_wise=implode(",",array_unique($job_data_arr['season_buyer_wise']));
	$order_repeat_no= implode(",",array_unique($job_data_arr['order_repeat_no']));
	$qlty_label= implode(",",array_unique($job_data_arr['qlty_label']));
	?>
    <style>
		@media print {
			.gg {page-break-after: always;}
		}
		@media print
		{
			.page-break { height:0; page-break-before:always; margin:0; border-top:none; }
		}

			body, p, span, td, a {font-size:10pt;font-family: Arial;}
			body{margin-left:2em; margin-right:2em; font-family: "Arial Narrow", Arial, sans-serif;}
			.page{
					height:947px;
					padding-top:5px;
					page-break-after : always;
					font-family: Arial, Helvetica, sans-serif;
					position:relative;
					border-bottom:1px solid #000;
				}
	</style>
	<div style="width:1330px" align="center">

	<?php
		$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12 and a.status_active =1 and a.is_deleted=0");
		list($nameArray_approved_row) = $nameArray_approved;
		$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
		list($nameArray_approved_date_row) = $nameArray_approved_date;
		$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
		list($nameArray_approved_comments_row) = $nameArray_approved_comments;
		$path = str_replace("'", "", $path);
		if ($path != "") {
			$path = $path;
		} else {
			$path = "../../";
		}
		$ref_data=array();
		$nameArray_ref=sql_select( "select b.grouping from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no='".$row_per_job[csf('job_no')]."' group by b.grouping ");
		foreach ($nameArray_ref as $result_ref){
			$ref_data['grouping'][$result_ref[csf('id')]]=$result_ref[csf('grouping')];
		}
		$grouping=implode(",",array_unique($ref_data['grouping']));

	?>										<!--    Header Company Information         -->
	<table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black" >
		<tr>
			<td width="100">
				<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
			</td>
			<td width="1250">
				<table width="100%" cellpadding="0" cellspacing="0"  >
					<tr>
						<td style="font-size:20px;" align="center"><b><?php echo $company_library[$cbo_company_name]; ?></b></td>
						<td rowspan="3" width="250">
							<span><b>Job No:&nbsp;&nbsp;<? echo trim($job_no,"'"); ?></b></span><br/>
							<?
								if($nameArray_approved_row[csf('approved_no')]>1)
								{
									?>
										<b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b><br/>
										Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
									<?
								}
							?>
						</td>
					</tr>
					<tr>
						<td style="font-size:18px;" align="center"><b>
							<?
									$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
									if($txt_job_no!="")
									{
										$location=return_field_value( "location_name", "wo_po_details_master","job_no=$txt_job_no");
									}
									else
									{
										$location="";
									}

									foreach ($nameArray as $result)
									{
										echo  $location_name_arr[$location];
							?><br>
										Email Address: <? echo $result[csf('email')];?>
										Website No: <? echo $result[csf('website')]; ?>
							<?		}?></b>
						</td>
					</tr>
					<tr>
						<td style="font-size:18px;" align="center">
							<strong><? if($report_title !=""){ echo $report_title;} else { echo "General Work Order";}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
	<?
	$po_data=array();
	$nameArray_job=sql_select( "SELECT b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,(pub_shipment_date-po_received_date) date_diff,MIN(po_received_date) as po_received_date,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status   from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no='".$row_per_job[csf('job_no')]."' group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
	foreach ($nameArray_job as $result_job){
		$po_data['po_id'][$result_job[csf('id')]]=$result_job[csf('id')];
		$po_data['po_number'][$result_job[csf('id')]]=$result_job[csf('po_number')];
		$po_data['leadtime'][$result_job[csf('id')]]=$result_job[csf('date_diff')];
		$po_data['po_quantity'][$result_job[csf('id')]]=$result_job[csf('po_quantity')];
		$po_data['po_received_date'][$result_job[csf('id')]]=change_date_format($result_job[csf('po_received_date')],'dd-mm-yyyy','-');
		$ddd=strtotime($result_job[csf('pub_shipment_date')]);
		$po_data['pub_shipment_date'][$ddd]=$ddd;

		$po_data['insert_date'][$result_job[csf('id')]]=$result_job[csf('insert_date')];

		if($result_job[csf('shiping_status')]==1){
		$shiping_status= "FP";
		}
		else if($result_job[csf('shiping_status')]==2){
		$shiping_status= "PS";
		}
		else if($result_job[csf('shiping_status')]==3){
		$shiping_status= "FS";
		}
		$po_data['shiping_status'][$result_job[csf('id')]]=$shiping_status;
		$po_data['file_no'][$result_job[csf('id')]]=$result_job[csf('file_no')];
		$po_data['grouping'][$result_job[csf('id')]]=$result_job[csf('grouping')];
	}
	$txt_order_no_id=implode(",",array_unique($po_data['po_id']));
	$leadtime=implode(",",array_unique($po_data['leadtime']));
	$po_quantity=array_sum($po_data['po_quantity']);
	$po_received_date=implode(",",array_unique($po_data['po_received_date']));
	$po_number=implode(",",array_unique($po_data['po_number']));
	$shipment_date=date('d-m-Y',min($po_data['pub_shipment_date']));
	$maxshipment_date=date('d-m-Y',max($po_data['pub_shipment_date']));
	$shiping_status=implode(",",array_unique($po_data['shiping_status']));
	$file_no=implode(",",array_unique($po_data['file_no']));
	$grouping=implode(",",array_unique($po_data['grouping']));


	$colar_excess_percent=0;
	$cuff_excess_percent=0;
	$rmg_process_breakdown=0;
	$nameArray=sql_select( "SELECT a.buyer_id,a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.update_date,a.uom,a.remarks,a.pay_mode,a.fabric_composition,a.short_booking_type from wo_booking_mst a  where   a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0");

	$nameArray_res=sql_select( "select   b.responsible_dept, b.responsible_person, b.reason  from  wo_booking_mst a, wo_booking_dtls b where a.id=b.booking_mst_id and a.booking_no=b.booking_no and a.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0 ");
	foreach ($nameArray_res as $result)
	{
		$responsible_dept.=$department_name_library_arr[$result[csf('responsible_dept')]].', ';
		$responsible_person.=$result[csf('responsible_person')].', ';
		$reason.=$result[csf('reason')].', ';
	}
	$responsible_dept_res=implode(",",array_filter(array_unique(explode(",",$responsible_dept))));
	$responsible_person_res=implode(",",array_filter(array_unique(explode(",",$responsible_person))));
	$reason_res=implode(",",array_filter(array_unique(explode(",",$reason))));
	//print_r($responsible_dept_res);

	foreach ($nameArray as $result)
	{
		$total_set_qnty=$result[csf('total_set_qnty')];
		$colar_excess_percent=$result[csf('colar_excess_percent')];
		$cuff_excess_percent=$result[csf('cuff_excess_percent')];
		$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
		foreach ($po_data['po_id'] as $po_id=>$po_val)
		{
			$daysInHand.=(datediff('d',date('d-m-Y',time()),$po_data['pub_shipment_date'][$po_id])-1).",";
			$booking_date=$result[csf('update_date')];
			if($booking_date=="" || $booking_date=="0000-00-00 00:00:00"){
			$booking_date=$result[csf('insert_date')];
			}
			$WOPreparedAfter.=(datediff('d',$po_data['insert_date'][$po_id],$booking_date)-1).",";
		}
	?>
	<table width="100%" style="border:1px solid black;table-layout: fixed;" >
		<tr>
			<td colspan="6" valign="top" style="color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
		</tr>
		<tr>
			<td width="200"><span><b>Buyer/Agent Name</b></span></td>
			<td width="220">:&nbsp;<span><b><? echo $buyer_name_arr[$result[csf('buyer_id')]]; ?></b></span></td>
			<td width="200"><span><b>Dept.</b></span></td>
			<td width="220">:&nbsp;
				<?
				echo $product_depertment ;
				if($product_code !=""){
				echo " (".$product_code.")";
				}
				if($pro_sub_dep != ""){
				echo " (".$pro_sub_dep.")";
				}
				?>
			</td>
			<td width="200"><span><b>Order Qnty</b></span></td>
			<td>:&nbsp; <?  echo $po_quantity;//." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?> </td>
		</tr>
		<tr>
			<td><b>Garments Item</b></td>
			<td>:&nbsp;
				<?
					$gmts_item_name="";
					$gmts_item=explode(',',$gmts_item_id);
					for($g=0;$g<=count($gmts_item); $g++)
					{
					$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
					}
					echo rtrim($gmts_item_name,',');
				?>
			</td>
			<td><b>Booking Release Date</b></td>
			<td>:&nbsp;
				<?
				$booking_date=$result[csf('update_date')];
				if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
				{
				$booking_date=$result[csf('insert_date')];
				}
				echo change_date_format($booking_date,'dd-mm-yyyy','-','');
				?>&nbsp;&nbsp;&nbsp;
			</td>
			<td><b>Style Ref.</b></td>
			<td>:&nbsp;<b>
				<?
					echo $style_sting;
				?></b>
			</td>
		</tr>
		<tr>
			<td><b>Style Des.</b></td>
			<td>:&nbsp;<? echo $style_description;?></td>
			<td><b>Season</b></td>
			<td>:&nbsp;<? if($season_matrix!='') echo $season_matrix;else echo $season_buyer_wise; ?></td>
			<td><b>Dealing Merchandiser</b></td>
			<td>:&nbsp;<? echo $dealing_marchant; ?></td>
		</tr>
		<tr>
			<td><b>Supplier Name</b></td>
			<td>:&nbsp;
				<?
					if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3){
					echo $company_library[$result[csf('supplier_id')]];
					}
					else{
					echo $supplier_name_arr[$result[csf('supplier_id')]];
					}
				?>    
			</td>
			<td><b>Delivery Date</b></td>
			<td>:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
			<td style="font-size:14px"><b>System Booking No </b></td>
			<td style="font-size:15px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?> <? //echo "(".$unit_of_measurement[$result[csf('uom')]].")"; $uom=$result[csf('uom')];?></td>
		</tr>
		<tr>
			<td><b>Attention</b></td>
			<td>:&nbsp;<? echo $result[csf('attention')]; ?></td>
			<td><b>Lead Time </b>   </td>
			<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;">:&nbsp;
				<?
				echo $leadtime;
				?>
			</td>
			<td><b>Po Received Date</b></td>
			<td  >:&nbsp;<? echo $po_received_date; ?></td>
		</tr>
		<tr>
			<td><b>Order No</b></td>
			<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;" colspan="3">:&nbsp;<? echo $po_number; ?></td>
			<td><b>Repeat No</b></td>
			<td  >:&nbsp;<? echo $order_repeat_no; ?></td>
		</tr>
		<tr>
			<td><b>Shipment Date</b></td>
			<td colspan="3" style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> : First:&nbsp;<? echo rtrim($shipment_date,", "); //echo $max_pub_shipment_date; ?>, Last: <? echo $maxshipment_date; ?></td>
			<td><b>Quality Label</b></td>
			<td  >:&nbsp;<? echo $qlty_label; ?></td>
		</tr>
		<!-- </tr> -->
		<tr>
			<td><b>WO Prepared After</b></td>
			<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
				<?$WOPreparedAfter=implode(",",array_unique(explode(",",chop($WOPreparedAfter,","))));echo $WOPreparedAfter.' Days' ;?></td>
			<td><b>Ex-factory status</b></td>
			<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;<?echo $shiping_status;?></td>
			<td><b>Internal Booking No</b></td>
			<td> :&nbsp;<b><? echo $grouping; ?></b></td>
		</tr>
		<tr>
			<td><b>File no</b></td>
			<td> :&nbsp;<b><? echo  $file_no;?></b></td>
			<td><b>Currency</b></td>
			<td> :&nbsp;<b><? echo  $currency[$result[csf("currency_id")]];?></b></td>
			<td><b>Remarks</b></td>
			<td> :<? echo $result[csf('remarks')]?></td>
		</tr>
		<tr>
			<td><b>Fabric Composition</b></td>
			<td colspan="3"> :<? echo $result[csf('fabric_composition')]?></td>
			<td><b>Short Booking Type</b></td>
			<td> :&nbsp;<? echo $short_booking_type[$result[csf('short_booking_type')]]?></td>
		</tr>
		<tr>
			<td><b>Responsible Person</b></td>
			<td> :&nbsp;<? echo  $responsible_person_res;?></td>
			<td><b>Responsible Department</b></td>
			<td colspan="3"> :&nbsp;<? echo $responsible_dept_res;?></td>

		</tr>
		<tr>
			<td><b>Reason</b></td>
			<td colspan="3">:&nbsp;<? echo $reason_res;?></td>
		</tr>
	</table>
	<?
	}
	?>
	<br/>
		<?
			$costing_per="";
			$costing_per_qnty=0;
			$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no =$job_no_in");
			if($costing_per_id==1)
			{
				$costing_per="1 Dzn";
				$costing_per_qnty=12;

			}
			if($costing_per_id==2)
			{
				$costing_per="1 Pcs";
				$costing_per_qnty=1;

			}
			if($costing_per_id==3)
			{
				$costing_per="2 Dzn";
				$costing_per_qnty=24;

			}
			if($costing_per_id==4)
			{
				$costing_per="3 Dzn";
				$costing_per_qnty=36;

			}
			if($costing_per_id==5)
			{
				$costing_per="4 Dzn";
				$costing_per_qnty=48;
			}
				$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no =$job_no_in");
				$uom_arr=array(1=>"Pcs",12=>"Kg",23=>"Mtr",27=>"Yds");
				$p=1;
			/*foreach($uom_arr as $uom_id=>$uom_val)
			{ */
			if($cbo_fabric_source==1 or $cbo_fabric_source==2 or $cbo_fabric_source==3){
				$nameArray_fabric_description= sql_select("SELECT a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type ,a.uom,sum(d.process_loss_percent) as process_loss,sum(d.grey_fab_qnty) as grey_fab_qntys,sum(d.fin_fab_qnty) as fin_fab_qntys,avg(d.rate) as rates,sum(d.amount) as amounts ,d.fabric_color_id from wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d where a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_number_id=d.gmts_color_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and a.job_no=d.job_no and a.id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.job_no='".$row_per_job[csf('job_no')]."' and d.status_active=1 and d.is_deleted=0 and b.cons>0 group by a.id,a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,a.uom ,d.fabric_color_id order by a.body_part_id,d.fabric_color_id,a.uom");
			

			if(count($nameArray_fabric_description)>0)
			{
			?>

				<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
					<caption> <strong>Fabric Booking Details </strong> </caption>
					<tr>
						<th width="30"  align="center">SL</th>
						<th width="240" align="left"  >Item Description</th>
						<th width="100" align="center">Fabric Color</th>
						<th width="120" align="center">UOM</th>
						<th width='120' align="center">Finish Fab. Qty</th>
						<th width='80'  align="center">Main Fab Qty(Fin)</th>
						<th width='120' align="center">Avg Rate</th>
						<th width='100' align="center">Amount</th>
					</tr>
					<?
					foreach($nameArray_fabric_description as $val)
					{

						$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qntys,sum(d.process_loss_percent) as process_loss,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d
						WHERE
						a.job_no=d.job_no and
						a.id=d.pre_cost_fabric_cost_dtls_id and
						d.booking_no =$txt_booking_no and
						d.job_no='".$row_per_job[csf('job_no')]."' and
						a.item_number_id='".$val[csf('item_number_id')]."' and
						a.body_part_id='".$val[csf('body_part_id')]."' and
						a.color_type_id='".$val[csf('color_type_id')]."' and
						a.construction='".$val[csf('construction')]."' and
						a.composition='".$val[csf('composition')]."' and
						a.gsm_weight='".$val[csf('gsm_weight')]."' and
						d.fabric_color_id='".$val[csf('fabric_color_id')]."' and
						d.status_active=1 and
						d.is_deleted=0
						");
					?>
					<tr>
						<td align="center"> <? echo $p; $p++;?></td>
						<td align="left">
							<? 
								echo $body_part[$val[csf('body_part_id')]].','. $val[csf('construction')].','.$val[csf('composition')].','.$val[csf('gsm_weight')].',' .$fabric_typee[$val[csf('width_dia_type')]].',' .$color_type[$val[csf('color_type_id')]]; 
							?> 
						</td>
						<td  align="center"><?echo $color_library[$val[csf('fabric_color_id')]];?></td>
						<td align="center"> <? echo $unit_of_measurement[$val[csf('uom')]]; ?></td>
						<td align="center"> <? $fins= $color_wise_wo_sql_qnty[0][csf("fin_fab_qnty")]; echo def_number_format($fins,2);?> </td>
						<td align="center">
							 <? 
							 	$process_loss=$color_wise_wo_sql_qnty[0][csf("process_loss")];
							 	$greys= $color_wise_wo_sql_qnty[0][csf("grey_fab_qntys")]; 
								$greys_DevidedBy_Process_Calc=$greys/$process_loss;
								$main_fab_qty=$greys-$greys_DevidedBy_Process_Calc;
								echo def_number_format($main_fab_qty,2);
							 ?> 
						</td>
						<td align="center"> <? echo def_number_format($color_wise_wo_sql_qnty[0][csf("rate")],2); ?> </td>
						<td align="center"> <? echo def_number_format($color_wise_wo_sql_qnty[0][csf("amount")],2); ?> </td>
							<?
								$total_fin_fab_qnty +=str_replace(",", "", def_number_format($fins,2));
								$total_amount +=str_replace(",", "",def_number_format($color_wise_wo_sql_qnty[0][csf("amount")],2));
								$total_main_fab_qnty +=str_replace(",", "",def_number_format($main_fab_qty,2));
							?>
					</tr>
					<?
					} 
						$avgTotRate=$total_amount/$total_fin_fab_qnty;
					?>
					<tr style=" font-weight:bold">
						<td  align="right" colspan="4"><strong>Total</strong></td>
						<td align="center"><? echo def_number_format($total_fin_fab_qnty,2);?></td>
						<td align="center"><? echo def_number_format($total_main_fab_qnty,2);?></td>
						<td align="center"><? echo def_number_format($avgTotRate,2);?></td>
						<td align="center"><? echo def_number_format($total_amount,2);?></td>
					</tr>
				</table>
					<br/>
					<?
			}
	}
		?>
      <br/?
	<div style="width:1330px" align="center" >
			  		<table  width="100%"  border="0" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">

			  			<tr>
			  				<td colspan="10" align="center">
			  					<strong>Collar and Cuff & Other Flat Knit Fabric Breakdown</strong>
			  				</td>

			  			</tr>
			  		</table>

	        <?
			 $sql_excess_part=sql_select( "select b.pre_cost_fabric_cost_dtls_id, b.po_break_down_id as po_id, b.gmts_color_id, b.gmts_size as size_number_id from wo_booking_colar_culff_dtls a, wo_booking_dtls b where b.booking_no=$txt_booking_no and a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id  and b.job_no =$job_no_in and b.booking_type=1 and b.is_short=1 and b.status_active=1 and b.is_deleted=0");
			 foreach($sql_excess_part as $vals)
	         {
				if($vals[csf("excess_per")]>0){
					$excess_val=$excess_arr[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][[$vals[csf("size_number_id")]]]=$vals[csf("excess_per")];
				}
			 }

			 $sql_collar_cuff= "SELECT a.rate, a.amount, a.job_no ,a.color_size_sensitive, a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.width_dia_type, b.gmts_color_id, b.gmts_size as size_number_id, b.item_size, b.rmg_qty as gmts_qty, b.po_break_down_id as po_id, b.id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.job_no =$job_no_in and a.body_part_type=40 and b.booking_type=1 and b.is_short=1 and b.status_active=1 and b.is_deleted=0  order by a.body_part_id,b.gmts_color_id,b.id " ;
			 
	         $sql_data_collar_cuff=sql_select($sql_collar_cuff);
	         $size_id_array=array();
	         $size_with_item_size_array=array();
	         foreach($sql_data_collar_cuff as $vals)
	         {
	         	
				$dataStr=$vals[csf("fabric_cost_dtls_id")].'_'.$vals[csf("gmts_color_id")];
				$fabric_color_sizeWiseArr[$dataStr]["gmts_qty"]+=$vals[csf("gmts_qty")];
				$fabric_color_sizeWiseArr[$dataStr]["fabric_color_id"]=$vals[csf("fabric_color_id")];
				$fabric_color_sizeWiseArr[$dataStr]["item_number_id"]=$vals[csf("item_number_id")];
				$fabric_color_sizeWiseArr[$dataStr]["body_part_id"]=$vals[csf("body_part_id")];
				$fabric_color_sizeWiseArr[$dataStr]["color_type_id"]=$vals[csf("color_type_id")];
				$fabric_color_sizeWiseArr[$dataStr]["construction"]=$vals[csf("construction")];
				$fabric_color_sizeWiseArr[$dataStr]["composition"]=$vals[csf("composition")];
				$fabric_color_sizeWiseArr[$dataStr]["width_dia_type"]=$vals[csf("width_dia_type")];
				$fabric_color_sizeWiseArr[$dataStr]["color_size_sensitive"]=$vals[csf("color_size_sensitive")];
				$fabric_color_sizeWiseArr[$dataStr]["job_no"]=$vals[csf("job_no")];


				$body_part_cuff_array[$vals[csf("body_part_id")]]=$vals[csf("body_part_id")];
				$size_id_array[$vals[csf("size_number_id")]]=$vals[csf("size_number_id")];
	         	$size_with_item_size_array[$vals[csf("size_number_id")]][$vals[csf("body_part_id")]]=$vals[csf("item_size")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["grey"]+=$vals[csf("gmts_qty")];
				if($vals[csf("excess_per")]>0)
				{
				$color_wise_excess_per_arr[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]+=$vals[csf("excess_per")];
				$color_wise_excess_per_arr[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_excess_per"]+=1;
				}
	         	$color_wise_qnty[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$color_wise_qnty[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["grey"]+=$vals[csf("qty")];
				$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_rate"]=1;

	         }
			unset($sql_data_collar_cuff);
	         $sql_collar_cuff3 = sql_select("SELECT c.rate, a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id, c.gmts_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls c WHERE a.job_no=c.job_no and a.id=c.pre_cost_fabric_cost_dtls_id and  a.id=c.pre_cost_fabric_cost_dtls_id  and c.job_no =$job_no_in and a.body_part_type=40 and c.status_active=1 and c.is_deleted=0  order by a.body_part_id");

	         foreach($sql_collar_cuff3 as $vals)
	         {

	         	$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];

	         }


	         $counts=count($size_id_array);


	         $size_wise_qnty_array=array();
	         ?>


			 <?
	          if(count($body_part_cuff_array)>0)
	          {		$grand_size_wise_qnty_array=array();
			  		$gr_collor_qty=0;
					 $gr_col_avg_price=0;
					 $gr_col_avg_row=0;
					 $gr_amount=0;
					 $gr_excess=0;
					foreach($body_part_cuff_array as $bpart_id=>$val)
					{
					?>
					 <table align="left"  width="100%" style="margin-top: 5px;" border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" >
			  			<tr>
			  				<td colspan="<? echo $counts+13;?>" align="center">
			  					<strong>Collar Details(<? echo $body_part[$bpart_id];?>)</strong>
			  				</td>

			  			</tr>
			  			<tr>
			  				<td  width="30"  rowspan="2" align="center"><strong>SL</strong> </td>
			  				<td  width="150" rowspan="2" align="center"><strong>Style</strong></td>
 			  				<td  width="140"  rowspan="2" align="center"><strong>Gmts Item</strong></td>
 			  				<td  width="100"  rowspan="2" align="center"><strong>Body Part</strong></td>
							<td  width="100" rowspan="2" align="center"><strong>Actual Qty(Pcs)</strong></td>
			  				<td  width="390" rowspan="2" align="left">&nbsp;&nbsp;<strong>Collar Composition</strong></td>
			  				<td  width="100"  rowspan="2" align="center"><strong>Color Type</strong></td>
 			  				<td  width="100"  rowspan="2"  align="center"><strong>Combo</strong></td>
							<td  width="100"  rowspan="2"  align="center"><strong>Fabric Color</strong></td>
 			  				<?
 			  				foreach($size_id_array as $id=>$val)
 			  				{
 			  					?>
 			  					<td width="40" align="center"><strong><? echo $size_library[$id];?></strong></td>

 			  					<?
 			  				}
 			  				?>
			  				<td width="60"  rowspan="2" align="center"><strong> Req Qty (Pcs)</strong> </td>
			  				<td  width="50" rowspan="2"  align="center"><strong> Excess %  </strong> </td>
			  				<td width="50" rowspan="2"  align="center"><strong>Price/Pcs</strong></td>
			  				<td  width="40" rowspan="2" align="center"><strong>Amount</strong></td>


			  			</tr>
			  			<tr>
			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
								?>
			  					<td  align="center"><? echo $size_with_item_size_array[$id][$bpart_id];?></td>

			  					<?
			  				}
			  				?>

			  			</tr>
			  			<?
			  			$p=1;//here
			  			foreach($fabric_color_sizeWiseArr as $fabCOlor=>$row)
			  			{
							$dataArr=explode("_",$fabCOlor);
							$fabric_id=$dataArr[0];
							$gmts_color=$dataArr[1];
							?>
			  				<tr>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="30" align="center"><? echo $p;?></td>
			  					<td style="word-break: break-all;word-wrap: break-word;" width="150" align="center"><? echo $style_sting;?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="140" align="center"><?  $item_id= $row[('item_number_id')];echo $garments_item[$item_id]; ?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center"><? echo $body_part[$bpart_id];?></td>
								<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center"><? $gmt_actual_qty=$gmts_qty_data_arr[$row[('job_no')]][$item_id][$gmts_color][40];echo number_format($gmt_actual_qty,0);$total_gmt_actual_qty+=$gmt_actual_qty;?></td>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="390" align="left"> &nbsp;
			  						<? echo $row[('construction')].",".$row[('composition')].",".$row[('gsm_weight')].",".$fabric_typee[$row[('width_dia_type')]] ;?>
			  					</td>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="100" align="center"><? echo $color_type[$row[('color_type_id')]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center">
			  						<? echo $color_library[$gmts_color];  ?>
			  					</td>
								<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center">
			  						<?
										if($row[('color_size_sensitive')]==1 or $row[('color_size_sensitive')]==2 or $row[('color_size_sensitive')]==4)
										{
											$gmt_fab_color=$color_library[$gmts_color];
										}
										else
										{
											$contrast_color_id=return_field_value("b.contrast_color_id as contrast_color_id", "wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b", "a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.job_no =$job_no_in and a.id=".$fabric_id."  and b.gmts_color_id=".$gmts_color." ","contrast_color_id");//pre_cost_fabric_cost_dtls_id
											if($contrast_color_id>0)
											{
												$gmt_fab_color=$color_library[$contrast_color_id];
											}
										}
									echo $gmt_fab_color;  ?>
			  					</td>


			  					<?
								$color_qty=0; $greyQty=0;
			  					foreach($size_id_array as $id=>$val)
			  					{
			  						?>
			  						<td  style="word-break: break-all;word-wrap: break-word;" width="40"  align="center"><? echo $cuff_grey_qty=$size_item_wise_qnty[$bpart_id][$fabric_id][$gmts_color][$id][$size_with_item_size_array[$id][$bpart_id]]["grey"];
									?></td>

			  						<?
			  						$size_wise_qnty_array[$id]+=$val;
									$grand_size_wise_qnty_array[$id]+=$cuff_grey_qty;$sub_size_wise_qnty_array[$bpart_id][$id]+=$cuff_grey_qty;
									$color_qty+=$cuff_grey_qty;

			  					}
								$row_excess_per= $color_wise_excess_per_arr[$fabric_id][$bpart_id][$gmts_color][$item_id][$excess_val];
			  					?>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="60" align="center">
			  						<? echo $grey_qnty=$color_qty; ?>
			  					</td>

			  					<td  style="word-break: break-all;word-wrap: break-word;" title="<? echo $row_excess_per;?>" width="50" align="center">
			  						<?  
			
									$excess= $color_wise_excess_per_arr[$fabric_id][$bpart_id][$gmts_color][$item_id][$excess_val]/$row_excess_per;
									echo number_format($excess,2);
									  ?>
			  					</td>


			  					<td style="word-break: break-all;word-wrap: break-word;" title="<? echo $color_wise_qnty2[$fabric_id][$bpart_id][$gmts_color][$item_id]["row_rate"];?>"  width="50" align="center">
			  						<? echo  $cuff_price=$color_wise_qnty2[$fabric_id][$bpart_id][$gmts_color][$item_id]["rate"]; ?>
			  					</td>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="40" align="center">
			  						<? echo $amount=$grey_qnty*$cuff_price;   ?>
			  					</td>
			  				</tr>
			  				<?

							$sub_collor_qty_arr[$bpart_id]+=$grey_qnty;
							$sub_collor_amount_arr[$bpart_id]+=$amount;

							$sub_excess_arr[$bpart_id]+=$excess;
							$sub_price_arr[$row[csf("body_part_id")]]+=$cuff_price;
							$cuff_body_wise_avg_row[$row[csf("body_part_id")]]+=1;

							$gr_fin_qty+=$fin_qty;
			  				$gr_collor_qty+=$grey_qnty;
							$gr_amount+=$amount;
			  				$gr_excess+=$excess ;
			  				$gr_col_avg_price+=$cuff_price;
			  				$gr_col_avg_row++;



			  				$p++;
			  			}
			  			?>
						<tr class="tbl_bottom">
							<td colspan="9" align="right">Total </td>
							<?
							foreach($size_id_array as $id=>$val)
							{
								?>
								<td  align="center"><? echo $sub_size_wise_qnty_array[$bpart_id][$id];?></td>

								<?
							}
							$cuff_sub_excess=$sub_excess_arr[$bpart_id];
							$cuff_sub_price=$sub_price_arr[$bpart_id];
							$cuff_body_wise_avg_tot_row=$cuff_body_wise_avg_row[$bpart_id];
							?>
							<td align="center">
								<? echo $sub_collor_qty_arr[$bpart_id];  ?>
							</td>
							<td align="center" title="Sub Exess & sub Row=<? echo $cuff_sub_excess.'='.$cuff_body_wise_avg_tot_row ?>">
									<? echo number_format($cuff_sub_excess/$cuff_body_wise_avg_tot_row,2); ?></td>
							<td align="center"><? echo number_format($cuff_sub_price/$cuff_body_wise_avg_tot_row,2); ?></td>

							<td align="center">
								<? echo $sub_collor_amount_arr[$bpart_id];   ?>
							</td>
			  			</tr>
			  			<?
						} 
						?>

						<tr>
			  				<td colspan="9" align="right">Grand Total </td>
			  				<?
			  				foreach($size_id_array as $id=>$val)
			  				{
			  					?>
			  					<td  align="center"><? echo $grand_size_wise_qnty_array[$id];?></td>

			  					<?
			  				}
			  				?>
			  				<td align="center">
			  					<? echo $gr_collor_qty;  ?>
			  				</td>
			  				<td align="center" title="Sub Exess & Tot Row=<? echo $gr_excess.'='.$gr_avg_row ?>"><? echo number_format($gr_excess/$gr_col_avg_row,2); ?></td>
							<td align="center"  title="Tot Price  & Tot Row=<? echo $gr_col_avg_price.'='.$gr_col_avg_row.'**'.$p?>"><? ?></td>

			  				<td align="center">
			  					<? echo $gr_amount;   ?>
			  				</td>
			  			</tr>

						</table>
						<?
			  		}
			  	?>
					<br/>

				<?
	     	  $sql_collar_cuff= "SELECT a.rate, a.amount, a.job_no ,a.color_size_sensitive, a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id, a.color_type_id, a.construction, a.composition, a.gsm_weight, a.width_dia_type, b.gmts_color_id, b.gmts_size as size_number_id, b.item_size, b.rmg_qty as gmts_qty, b.po_break_down_id as po_id, b.id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls b WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.job_no =$job_no_in and a.body_part_type=50 and b.booking_type=1 and b.is_short=1 and b.status_active=1 and b.is_deleted=0  order by a.body_part_id,b.gmts_color_id,b.id " ;
	         $sql_data_collar_cuff=sql_select($sql_collar_cuff);
	         $size_id_array_2=array();
	         $size_with_item_size_array=array();
	         $size_item_wise_qnty=array();
	         $color_wise_qnty=array();
	         foreach($sql_data_collar_cuff as $vals)
	         {
					         	
				$dataStr=$vals[csf("fabric_cost_dtls_id")].'_'.$vals[csf("gmts_color_id")];
				$fabric_color_sizeWiseArr[$dataStr]["gmts_qty"]+=$vals[csf("gmts_qty")];
				$fabric_color_sizeWiseArr[$dataStr]["fabric_color_id"]=$vals[csf("fabric_color_id")];
				$fabric_color_sizeWiseArr[$dataStr]["item_number_id"]=$vals[csf("item_number_id")];
				$fabric_color_sizeWiseArr[$dataStr]["body_part_id"]=$vals[csf("body_part_id")];
				$fabric_color_sizeWiseArr[$dataStr]["color_type_id"]=$vals[csf("color_type_id")];
				$fabric_color_sizeWiseArr[$dataStr]["construction"]=$vals[csf("construction")];
				$fabric_color_sizeWiseArr[$dataStr]["composition"]=$vals[csf("composition")];
				$fabric_color_sizeWiseArr[$dataStr]["width_dia_type"]=$vals[csf("width_dia_type")];
				$fabric_color_sizeWiseArr[$dataStr]["color_size_sensitive"]=$vals[csf("color_size_sensitive")];
				$fabric_color_sizeWiseArr[$dataStr]["job_no"]=$vals[csf("job_no")];


				//$body_part_cuff_array[$vals[csf("body_part_id")]]=$vals[csf("body_part_id")];
	         	$body_part_array[$vals[csf("body_part_id")]]=$vals[csf("body_part_id")];
				$size_id_array_2[$vals[csf("size_number_id")]]=$vals[csf("size_number_id")];
	         	$size_with_item_size_array[$vals[csf("size_number_id")]][$vals[csf("body_part_id")]]=$vals[csf("item_size")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$size_item_wise_qnty[$vals[csf("body_part_id")]][$vals[csf("fabric_cost_dtls_id")]][$vals[csf("gmts_color_id")]][$vals[csf("size_number_id")]][$vals[csf("item_size")]]["grey"]+=$vals[csf("gmts_qty")];
				if($vals[csf("excess_per")]>0)
				{
				$color_wise_excess_per_cuff_arr[$vals[csf('fabric_cost_dtls_id')]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["excess_per"]+=$vals[csf("excess_per")];
				$color_wise_excess_per_cuff_arr[$vals[csf('fabric_cost_dtls_id')]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_excess_per"]+=1;
				}
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["fin"]+=$vals[csf("gmts_qty")];
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["grey"]+=$vals[csf("qty")];
	         	/*$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];*/
	         	$color_wise_qnty[$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["amount"]=$vals[csf("amount")];
				$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["row_rate"]=1;

	         }
				unset($sql_data_collar_cuff);
	         $sql_collar_cuff3 = sql_select("SELECT c.rate, a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id, c.gmts_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls c WHERE a.job_no=c.job_no and a.id=c.pre_cost_fabric_cost_dtls_id and  a.id=c.pre_cost_fabric_cost_dtls_id  and c.job_no =$job_no_in and a.body_part_type=50 and c.status_active=1 and c.is_deleted=0  order by a.body_part_id");

	         foreach($sql_collar_cuff3 as $vals)
	         {

	         	$color_wise_qnty2[$vals[csf("fabric_cost_dtls_id")]][$vals[csf("body_part_id")]][$vals[csf("gmts_color_id")]][$vals[csf("item_number_id")]]["rate"]=$vals[csf("rate")];

	         }


	         $counts=count($size_id_array_2);$grand_size_wise_qnty_array=array();
	          if(count($body_part_array)>0)
	          {
					$gr_collor_qty=$gr_amount=$gr_avg_price=$gr_avg_row=$gr_excess=0;
					foreach($body_part_array as $bpart_id=>$val)
					{
					?>

			  	 <table align="left"  width="100%" style="margin-top: 5px; margin-bottom:10px;"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all" >
			  			<tr>
			  				<td colspan="<? echo $counts+13;?>" align="center">
			  					<strong>Cuff Details &nbsp;(<? echo  $body_part[$bpart_id];?>) </strong>
			  				</td>
			  			</tr>
			  			<tr>
			  				<td  width="30"  rowspan="2" align="center"><strong>SL</strong> </td>
			  				<td  width="150" rowspan="2" align="center"><strong>Style</strong></td>
 			  				<td  width="140" rowspan="2" align="center"><strong>Gmts Item</strong></td>
 			  				<td  width="100" rowspan="2" align="center"><strong>Body Part</strong></td>
							<td  width="100" rowspan="2" align="center"><strong>Actual Qty(Pcs)</strong></td>
			  				<td  width="390" rowspan="2" align="left">&nbsp;&nbsp;<strong>Cuff Composition</strong></td>
			  				<td  width="100" rowspan="2" align="center"><strong>Color Type</strong></td>
 			  				<td  width="100" rowspan="2"  align="center"><strong>Combo</strong></td>
							<td  width="100" rowspan="2"  align="center"><strong>Fabric Color</strong></td>
 			  				<?
 			  				foreach($size_id_array_2 as $id=>$val)
 			  				{
 			  					?>
 			  					<td width="40" align="center"><strong><? echo $size_library[$id];?></strong></td>

 			  					<?
 			  				}
 			  				?>

			  				<td width="60"  rowspan="2" align="center"><strong> Req Qty(Pcs) </strong> </td>
			  				<td  width="50" rowspan="2"  align="center"><strong> Excess %  </strong> </td>

			  				<td width="50" rowspan="2"  align="center"><strong>Price/Pcs</strong></td>
			  				<td  width="40" rowspan="2" align="center"><strong>Amount</strong></td>
			  			</tr>
			  			<tr>
			  				<?
			  				foreach($size_id_array_2 as $id=>$val)
			  				{
			  					?>
			  					<td width="40"  align="center"><strong><? echo $size_with_item_size_array[$id][$bpart_id];?></strong></td>
			  					<?
			  				}
			  				?>
			  			</tr>
			  			<?
			  			$p=1;
			  			$size_wise_qnty_array=array();
			  			foreach($fabric_color_sizeWiseArr as $fabCOlor=>$row)
			  			{
							$dataArr=explode("_",$fabCOlor);
							$fabric_id=$dataArr[0];
							$gmts_color=$dataArr[1];
							?>
							?>
			  				<tr>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="30" align="center"><? echo $p;?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="150" align="center"><? echo $style_sting;?></td>
								<td  style="word-break: break-all;word-wrap: break-word;" width="140" align="center"><?  $item_id= $row[('item_number_id')];echo $garments_item[$item_id]; ?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center"><? echo $body_part[$bpart_id];?></td>
								<td  style="word-break: break-all;word-wrap: break-word;" width="100" align="center"><? $gmt_actual_qty=$gmts_qty_data_arr[$row[('job_no')]][$item_id][$gmts_color][40];echo number_format($gmt_actual_qty,0);$total_gmt_actual_qty+=$gmt_actual_qty;?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="390" align="left"> &nbsp;
								  <? echo $row[('construction')].",".$row[('composition')].",".$row[('gsm_weight')].",".$fabric_typee[$row[('width_dia_type')]] ;?>
			  					</td>
			  					<td style="word-break: break-all;word-wrap: break-word;"  width="100" align="center"><? echo $color_type[$row[('color_type_id')]];?></td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center">
								  <? echo $color_library[$gmts_color];  ?>
			  					</td>
								<td  style="word-break: break-all;word-wrap: break-word;"  width="100" align="center">
			  						<?
									if($row[('color_size_sensitive')]==1 or $row[('color_size_sensitive')]==2 or $row[('color_size_sensitive')]==4)
									{
										$gmt_fab_color=$color_library[$gmts_color];
									}
									else
									{
										$contrast_color_id=return_field_value("b.contrast_color_id as contrast_color_id", "wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_color_dtls b", "a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id  and b.job_no =$job_no_in and a.id=".$fabric_id."  and b.gmts_color_id=".$gmts_color." ","contrast_color_id");//pre_cost_fabric_cost_dtls_id
											if($contrast_color_id>0)
											{
												$gmt_fab_color=$color_library[$contrast_color_id];
											}
										}
									echo $gmt_fab_color;   ?>
			  					</td>

			  					<?
								$tot_size_qty=0;
			  					foreach($size_id_array_2 as $id=>$val)
			  					{
									?>
									<td  style="word-break: break-all;word-wrap: break-word;" width="40"  align="center"><? echo $cuff_grey_qty=$size_item_wise_qnty[$bpart_id][$fabric_id][$gmts_color][$id][$size_with_item_size_array[$id][$bpart_id]]["grey"];
								  ?></td>
			  						<?
			  						$size_wise_qnty_array[$id]+=$size_grey_qty;$sub_size_wise_qnty_array[$row[csf("body_part_id")]][$id]+=$size_grey_qty;
									$grand_size_wise_qnty_array[$id]+=$size_grey_qty;
									$tot_size_qty+=$size_grey_qty;

			  					}
			  					?>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="60" align="center">
			  						<? echo $grey_qnty=$tot_size_qty;//$color_wise_qnty[$row[csf('gmts_color_id')]][$item_id]["grey"];
									$row_excess_per= $color_wise_excess_per_arr[$fabric_id][$bpart_id][$gmts_color][$item_id][$excess_val];
									 ?>
			  					</td>

			  					<td  style="word-break: break-all;word-wrap: break-word;" title="excess tot=<? echo $row_excess_per; ?>"  width="50" align="center">
			  						<?  $excess= $color_wise_excess_per_arr[$fabric_id][$bpart_id][$gmts_color][$item_id][$excess_val]/$row_excess_per;echo number_format($excess,2);   ?>
			  					</td>
			  					<td   style="word-break: break-all;word-wrap: break-word;" width="50" title="<? echo $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["row_rate"];?>" align="center">
			  						<? echo $price= $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["rate"];
									$tot_row_rate= $color_wise_qnty2[$row[csf('fabric_cost_dtls_id')]][$row[csf("body_part_id")]][$row[csf('gmts_color_id')]][$item_id]["row_rate"]; ?>

			  					</td>
			  					<td  style="word-break: break-all;word-wrap: break-word;"  width="40" align="center">
			  						<? echo  $amount=$grey_qnty* $price;   ?>
			  					</td>

			  				</tr>
			  				<?
			  				$sub_collor_qty_arr[$row[csf("body_part_id")]]+=$grey_qnty;
							$sub_collor_amount_arr[$row[csf("body_part_id")]]+=$amount;
							$sub_excess_arr[$row[csf("body_part_id")]]+=$excess;
							$sub_price_arr[$row[csf("body_part_id")]]+=$price;
							$body_wise_avg_row[$row[csf("body_part_id")]]+=1;

							$gr_fin_qty+=$fin_qty;
			  				$gr_collor_qty+=$grey_qnty;
			  				$gr_avg_price+=$price;
							$gr_amount+=$amount;
			  				$gr_excess+=$avg_excess;

			  				$gr_avg_row++;

			  				$p++;
			  			}
			  			?>

			  			<tr>
			  				<td colspan="9" align="right">Total </td>
			  				<?
			  				foreach($size_id_array_2 as $id=>$val)
			  				{
			  					?>
			  					<td  align="center"><? echo $sub_size_wise_qnty_array[$bpart_id][$id];
								?></td>
			  					<?
			  				}
							$tot_avg_row=$body_wise_avg_row[$bpart_id];
							$tot_sub_excess=$sub_excess_arr[$bpart_id];
							$tot_sub_price=$sub_price_arr[$bpart_id];
			  				?>
			  				<td align="center">
			  					<? echo $sub_collor_qty_arr[$bpart_id];  ?>
			  				</td>
			  				<td align="center" title="Tot Excess & Tot Row=<? echo $tot_sub_excess.'='.$tot_avg_row;?>"><? echo number_format($tot_sub_excess/$tot_avg_row,2); ?></td>
			  				<td align="center">
			  					<? echo number_format($tot_sub_price/$tot_avg_row,2);  ?>
			  				</td>
			  				<td align="center">
			  					<? echo $sub_collor_amount_arr[$bpart_id];   ?>
			  				</td>
			  			</tr>
			  			<?
						} //Body Part End

			  		?>
					<tr>
			  				<td colspan="9" align="right">Grand Total </td>
			  				<?
			  				foreach($size_id_array_2 as $id=>$val)
			  				{
			  					?>
			  					<td  align="center"><? echo $grand_size_wise_qnty_array[$id];?></td>
			  					<?
			  				}
			  				?>
			  				<td align="center">
			  					<? echo $gr_collor_qty;  ?>
			  				</td>
			  				<td align="center" title="grand Excess &tot row=<? echo $gr_excess.'='.$gr_avg_row;?>"><? echo number_format($gr_excess/$gr_avg_row,2); ?></td>
			  				<td align="center">
			  					<? //echo number_format($gr_avg_price/$gr_avg_row,2);  ?>
			  				</td>
			  				<td align="center">
			  					<? echo $gr_amount;   ?>
			  				</td>
			  			</tr>
			  	</table>
				<?
					}
				?>

		</div>
		<br>
	<?
?>
     <br>
	 <table  style="margin-top: 5px;float: left;"    width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
			<tr>
				<td colspan="9" align="center">
					<strong>Comments</strong>
				</td>
			</tr>
			<tr>
				<td align="center"> SL </td>
				<td align="center" width="200"  style="word-wrap: break-word;word-break: break-all;"> PO NO </td>
				<td align="center">Ship date</td>
				<td align="center">BOM Qty</td>
				<td align="center"> Booking Qty </td>
				<td align="center"> Short Booking Qty </td>
				<td align="center"> Total Booking Qty </td>
				<td align="center"> Balance </td>
				<td align="center"> Comments </td>
			</tr>
			<?
			$is_short_data=sql_select("SELECT a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0   and b.is_short =1 group by  a.id ");
			foreach($is_short_data as $vals)
			{
				$short_qty_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
			}

			$booking_data=sql_select("SELECT a.id, sum(b.grey_fab_qnty) as booking_qty from wo_po_break_down a,wo_booking_dtls b  where a.job_no_mst =b.job_no and  a.id=b.po_break_down_id   and  a.status_active=1 and a.is_deleted=0 and  b.status_active=1 and b.is_deleted=0 and b.is_short !=1 and b.booking_type=1 group by  a.id  order by a.id");
			foreach($booking_data as $vals)
			{
				$booking_arr[$vals[csf("id")]]=$vals[csf("booking_qty")];
			}

			$po_date=return_library_array("select id,shipment_date from wo_po_break_down where status_active=1 and is_deleted=0",'id','shipment_date');
			$po_num_arr=return_library_array("SELECT id,po_number from wo_po_break_down where job_no_mst =$job_no_in",'id','po_number');

			$comments_data=sql_select("SELECT min(a.id) as ids,b.po_break_down_id as po_number,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,SUM(b.requirment) as precost_grey_qty FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
			WHERE a.job_no=b.job_no and
			a.id=b.pre_cost_fabric_cost_dtls_id
			and
			b.po_break_down_id=d.po_break_down_id and
			b.color_number_id=d.gmts_color_id and
			b.dia_width=d.dia_width and
			b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
			a.job_no=d.job_no and
			a.id=d.pre_cost_fabric_cost_dtls_id
			and
			d.booking_no =$txt_booking_no and
			d.job_no =$job_no_in and

			d.status_active=1 and
			d.is_deleted=0 and
			b.cons>0
			group by b.po_break_down_id order by b.po_break_down_id");

			//echo 

			$job_no=$job_no_in;
			$condition= new condition();
			if(str_replace("'","",$job_no) !='')
			{
				$condition->job_no("in ($job_no)");
			}
			$condition->init();
			$fabric= new fabric($condition);
			$fabric_costing_qty_arr=$fabric->getQtyArray_by_order_knitAndwoven_greyAndfinish();

			$j=1;
			$total_bom=0;
			$total_book=0;
			$total_short=0;
			$total_short_full=0;
			$total_balance=0;
			foreach($comments_data as $val)
			{
				$po_id=$val[csf('po_number')];
				$woven_qty=array_sum($fabric_costing_qty_arr['woven']['grey'][$po_id]);
				$knit_qty=array_sum($fabric_costing_qty_arr['knit']['grey'][$po_id]);
				$sum_woven_knit=$woven_qty + $knit_qty;


				?>
				<tr>
					<td align="center"><? echo $j;?></td>
					<td align="center"  style="word-wrap: break-word;word-break: break-all;"> <? echo $po_num_arr[$po_id];?> </td>
					<td align="center"><? echo rtrim($shipment_date,", ");  ?> </td>
					<td align="center"><?  echo $pre= def_number_format($sum_woven_knit,2);  ?> </td>
					<td align="center"><?  echo $bookings= def_number_format($booking_arr[$val[csf("po_number")]],2);  ?> </td>
					<td align="center"> <?echo $short=def_number_format($short_qty_arr[$val[csf("po_number")]],2); ?> </td>
					<td align="center"> <?   $tot_short_book= str_replace(',','',$bookings) +  str_replace(',','',$short) ; echo def_number_format($tot_short_book,2); ?>  </td>
					<td align="center"> <?  $bal =str_replace(',','',$pre)-str_replace(',','',$tot_short_book) ; echo def_number_format($bal,2);  ?> </td>
					<td align="center"> <? if($bal!=0){ if($pre>$tot_short_book){echo "Less ";} else{ echo "Over";} }?> </td>


				</tr>
				<?
				$total_bom +=str_replace(',','',$pre);
				$total_book +=str_replace(',','',$bookings);
				$total_short +=str_replace(',','',$short);
				$total_short_full += str_replace(',','',$tot_short_book);
				$total_balance += str_replace(',','',$bal);

				$j++;
			}
			?>
			<tr>
				<td colspan="3" align="right"> <b> Total </b></td>
				<td align="center"><strong><? echo def_number_format($total_bom,2);?> </strong> </td>
				<td align="center"><strong><? echo def_number_format($total_book,2);?> </strong> </td>
				<td align="center"><strong><? echo def_number_format($total_short,2);?> </strong> </td>
				<td align="center"><strong><? echo def_number_format($total_short_full,2);?> </strong> </td>
				<td align="center"><strong><? echo def_number_format($total_balance,2);?> </strong> </td>
				<td>&nbsp;</td>
			</tr>
			</table>
			<table width="100%"   cellpadding="2" cellspacing="0" rules="all" style="border-left: none;border-right: none;border-top: none;border-bottom: none;">
				<tr>
					<!-- <td align="left" style="border-left: none;border-right: none;border-top: none;border-bottom: none;">
						<img  src='<? //echo $path.$imge_arr[$job_no]; ?>' height='180' width='250' />
					</td> -->
					<!-- <td align="right" width="650" style="border-left: none;border-right: none;border-top: none;border-bottom: none;">
						<? //echo get_spacial_instruction($txt_booking_no); ?>
					</td> -->
				</tr>
			</table>
	<br>

	<?
	echo signature_table(4, $cbo_company_name, "1330px");
	?>
    <p class=""></p>

    <?
	}
	$job_no_all= implode(",",array_unique($joball['job_no']));
	$style_sting_all=implode(",",array_unique($joball['style_ref_no']));

	echo "****".custom_file_name($txt_booking_no,$style_sting_all,$job_no_all);
	?>
	</div>
	<?
	exit();
}

if($action=="print_booking_6")//shariar cotton
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$imge_arr=return_library_array( "select master_tble_id,image_location from common_photo_library where form_name='company_details' or form_name='knit_order_entry' and file_type=1",'master_tble_id','image_location');

	$company_library=return_library_array( "select id,company_name from lib_company", "id", "company_name");
	$color_library=return_library_array( "select id,color_name from lib_color where status_active =1 and is_deleted=0", "id", "color_name");
	$size_library=return_library_array( "select id,size_name from lib_size where status_active =1 and is_deleted=0", "id", "size_name");
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from lib_supplier",'id','supplier_name');

	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');
	$user_nameArr=return_library_array( "select id, user_name from user_passwd ", "id", "user_name"  );
	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	$season_arr=return_library_array("select id,season_name from lib_buyer_season","id","season_name");
	$uom=0;
	$joball=array();
	$nameArray_per_job=sql_select( "select  a.job_no,a.style_ref_no  from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by a.job_no,a.style_ref_no");
	foreach ($nameArray_per_job as $row_per_job){
	$joball['job_no'][$row_per_job[csf('job_no')]]=$row_per_job[csf('job_no')];
	$joball['style_ref_no'][$row_per_job[csf('job_no')]]=$row_per_job[csf('style_ref_no')];

	$uom=0;
	$job_data_arr=array();
	$nameArray_buyer=sql_select( "select  a.style_ref_no,a.style_description, a.job_no, a.style_owner, a.buyer_name, b.responsible_dept, b.responsible_person, b.reason,b.inserted_by, a.dealing_marchant,a.season,a.season_matrix,a.season_buyer_wise,a.total_set_qnty,a.product_dept,a.product_code,a.pro_sub_dep,a.gmts_item_id ,a.order_repeat_no,a.qlty_label  from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0 and a.job_no='".$row_per_job[csf('job_no')]."'");
	foreach ($nameArray_buyer as $result_buy){
	$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
	$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
	$job_data_arr['total_set_qnty'][$result_buy[csf('job_no')]]=$result_buy[csf('total_set_qnty')];
	$job_data_arr['product_dept'][$result_buy[csf('job_no')]]=$product_dept[$result_buy[csf('product_dept')]];
	$job_data_arr['product_code'][$result_buy[csf('job_no')]]=$result_buy[csf('product_code')];
	$job_data_arr['pro_sub_dep'][$result_buy[csf('job_no')]]=$pro_sub_dept_array[$result_buy[csf('pro_sub_dep')]];
	$job_data_arr['gmts_item_id'][$result_buy[csf('job_no')]]=$result_buy[csf('gmts_item_id')];
	$job_data_arr['style_ref_no'][$result_buy[csf('job_no')]]=$result_buy[csf('style_ref_no')];
	$job_data_arr['style_description'][$result_buy[csf('job_no')]]=$result_buy[csf('style_description')];
	$job_data_arr['dealing_marchant'][$result_buy[csf('job_no')]]=$marchentrArr[$result_buy[csf('dealing_marchant')]];
	$job_data_arr['season_matrix'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_matrix')]];
	$job_data_arr['season_buyer_wise'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_buyer_wise')]];
	$job_data_arr['order_repeat_no'][$result_buy[csf('job_no')]]=$result_buy[csf('order_repeat_no')];
	$job_data_arr['qlty_label'][$result_buy[csf('job_no')]]=$quality_label[$result_buy[csf('qlty_label')]];
	$job_data_arr['inserted_by'][$result_buy[csf('job_no')]]=$user_nameArr[$result_buy[csf('inserted_by')]];
	$job_data_arr['responsible_person'][$result_buy[csf('responsible_person')]]=$result_buy[csf('responsible_person')];
	$job_data_arr['responsible_dept'][$result_buy[csf('responsible_dept')]]=$result_buy[csf('responsible_dept')];
	$job_data_arr['reason'][$result_buy[csf('reason')]]=$result_buy[csf('reason')];
	}

	$job_no= implode(",",array_unique($job_data_arr['job_no']));
	$job_no_in= implode(",",array_unique($job_data_arr['job_no_in']));
	$product_depertment=implode(",",array_unique($job_data_arr['product_dept']));
	$product_code=implode(",",array_unique($job_data_arr['product_code']));
	$pro_sub_dep=implode(",",array_unique($job_data_arr['pro_sub_dep']));
	$gmts_item_id=implode(",",array_unique($job_data_arr['gmts_item_id']));
	$style_sting=implode(",",array_unique($job_data_arr['style_ref_no']));
	$style_description=implode(",",array_unique($job_data_arr['style_description']));
	$dealing_marchant=implode(",",array_unique($job_data_arr['dealing_marchant']));
	$season_matrix=implode(",",array_unique($job_data_arr['season_matrix']));
	$season_buyer_wise=implode(",",array_unique($job_data_arr['season_buyer_wise']));
	$order_repeat_no= implode(",",array_unique($job_data_arr['order_repeat_no']));
	$qlty_label= implode(",",array_unique($job_data_arr['qlty_label']));
	$INSERTED_BY= implode(",",array_unique($job_data_arr['inserted_by']));
	?>
    <style>
		@media print {
			.gg {page-break-after: always;}
		}
		@media print
		{
			.page-break { height:0; page-break-before:always; margin:0; border-top:none; }
		}

			body, p, span, td, a {font-size:10pt;font-family: Arial;}
			body{margin-left:2em; margin-right:2em; font-family: "Arial Narrow", Arial, sans-serif;}
			.page{
					height:947px;
					padding-top:5px;
					page-break-after : always;
					font-family: Arial, Helvetica, sans-serif;
					position:relative;
					border-bottom:1px solid #000;
				}
	</style>
	<div style="width:1330px" align="center">

	<?php
		$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12 and a.status_active =1 and a.is_deleted=0");
		list($nameArray_approved_row) = $nameArray_approved;
		$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
		list($nameArray_approved_date_row) = $nameArray_approved_date;
		$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
		list($nameArray_approved_comments_row) = $nameArray_approved_comments;
		$path = str_replace("'", "", $path);
		if ($path != "") {
			$path = $path;
		} else {
			$path = "../../";
		}
		$ref_data=array();
		$nameArray_ref=sql_select( "select b.grouping from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no='".$row_per_job[csf('job_no')]."' group by b.grouping ");
		foreach ($nameArray_ref as $result_ref){
			$ref_data['grouping'][$result_ref[csf('id')]]=$result_ref[csf('grouping')];
		}
		$grouping=implode(",",array_unique($ref_data['grouping']));

	?>										<!--    Header Company Information         -->
	<table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black" >
	<tr>
		<td width="100">
		<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
		</td>
	<td width="1250">
	<table width="100%" cellpadding="0" cellspacing="0"  >
	<tr>
		<td style="font-size:20px;" align="center"><b>
		<?php echo $company_library[$cbo_company_name]; ?>
		</b></td>
	<td rowspan="3" width="250">

	<span><b>Internal Booking No:&nbsp;&nbsp;<? echo $grouping; ?></b></span><br/>
	<?
	if($nameArray_approved_row[csf('approved_no')]>1)
	{
	?>
	<b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
	<br/>
	Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
	<?
	}
	?>


	</td>
	</tr>
	<tr>
	<td style="font-size:18px;" align="center"><b>
	<?
	$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
	if($txt_job_no!="")
	{
	$location=return_field_value( "location_name", "wo_po_details_master","job_no=$txt_job_no");
	}
	else
	{
	$location="";
	}

	foreach ($nameArray as $result)
	{
	echo  $location_name_arr[$location];
	
	?>
	<br>
	Email Address: <? echo $result[csf('email')];?>
	Website No: <? echo $result[csf('website')]; ?>

	<?

	}

	?>
	</b></td>
	</tr>
	<tr>
	<td style="font-size:18px;" align="center">
	<strong><? if($report_title !=""){ echo $report_title;} else { echo "General Work Order";}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
	</td>
	</tr>
	</table>
	</td>
	</tr>
	</table>
	<?
	$po_data=array();
	$nameArray_job=sql_select( "select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,(pub_shipment_date-po_received_date) date_diff,MIN(po_received_date) as po_received_date,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status   from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no='".$row_per_job[csf('job_no')]."' group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
	foreach ($nameArray_job as $result_job){
		$po_data['po_id'][$result_job[csf('id')]]=$result_job[csf('id')];
		$po_data['po_number'][$result_job[csf('id')]]=$result_job[csf('po_number')];
		$po_data['leadtime'][$result_job[csf('id')]]=$result_job[csf('date_diff')];
		$po_data['po_quantity'][$result_job[csf('id')]]=$result_job[csf('po_quantity')];
		$po_data['po_received_date'][$result_job[csf('id')]]=change_date_format($result_job[csf('po_received_date')],'dd-mm-yyyy','-');
		$ddd=strtotime($result_job[csf('pub_shipment_date')]);
		$po_data['pub_shipment_date'][$ddd]=$ddd;

		$po_data['insert_date'][$result_job[csf('id')]]=$result_job[csf('insert_date')];

		if($result_job[csf('shiping_status')]==1){
		$shiping_status= "FP";
		}
		else if($result_job[csf('shiping_status')]==2){
		$shiping_status= "PS";
		}
		else if($result_job[csf('shiping_status')]==3){
		$shiping_status= "FS";
		}
		$po_data['shiping_status'][$result_job[csf('id')]]=$shiping_status;
		$po_data['file_no'][$result_job[csf('id')]]=$result_job[csf('file_no')];
		$po_data['grouping'][$result_job[csf('id')]]=$result_job[csf('grouping')];
	}
	$txt_order_no_id=implode(",",array_unique($po_data['po_id']));
	$leadtime=implode(",",array_unique($po_data['leadtime']));
	$po_quantity=array_sum($po_data['po_quantity']);
	$po_received_date=implode(",",array_unique($po_data['po_received_date']));
	$po_number=implode(",",array_unique($po_data['po_number']));
	$shipment_date=date('d-m-Y',min($po_data['pub_shipment_date']));
	$maxshipment_date=date('d-m-Y',max($po_data['pub_shipment_date']));
	$shiping_status=implode(",",array_unique($po_data['shiping_status']));
	$file_no=implode(",",array_unique($po_data['file_no']));
	$grouping=implode(",",array_unique($po_data['grouping']));


	$colar_excess_percent=0;
	$cuff_excess_percent=0;
	$rmg_process_breakdown=0;
	$nameArray=sql_select( "select a.buyer_id,a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.update_date,a.uom,a.remarks,a.pay_mode,a.fabric_composition,a.short_booking_type from wo_booking_mst a  where   a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0");
	foreach ($nameArray as $result)
	{
		$total_set_qnty=$result[csf('total_set_qnty')];
		$colar_excess_percent=$result[csf('colar_excess_percent')];
		$cuff_excess_percent=$result[csf('cuff_excess_percent')];
		$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
		foreach ($po_data['po_id'] as $po_id=>$po_val){
			$daysInHand.=(datediff('d',date('d-m-Y',time()),$po_data['pub_shipment_date'][$po_id])-1).",";
			$booking_date=$result[csf('update_date')];
			if($booking_date=="" || $booking_date=="0000-00-00 00:00:00"){
			$booking_date=$result[csf('insert_date')];
			}
			$WOPreparedAfter.=(datediff('d',$po_data['insert_date'][$po_id],$booking_date)-1).",";
		}
	?>
	<table width="100%" style="border:1px solid black;table-layout: fixed;" >
	<tr>
	<td colspan="6" valign="top" style="color:#F00"><? if($result[csf('is_apply_last_update')]==2){echo "Booking Info not synchronized with order entry and pre-costing. order entry or pre-costing has updated after booking entry.  Contact to ".$marchentrArr[$result[csf('dealing_marchant')]]; } else{ echo "";} ?></td>
	</tr>
	<tr>
	<td width="200"><span><b>Buyer/Agent Name</b></span></td>
	<td width="220">:&nbsp;<span><b><? echo $buyer_name_arr[$result[csf('buyer_id')]]; ?></b></span></td>
	<td width="200"><span><b>Dept.</b></span></td>
	<td width="220">:&nbsp;
	<?
	echo $product_depertment ;
	if($product_code !=""){
	echo " (".$product_code.")";
	}
	if($pro_sub_dep != ""){
	echo " (".$pro_sub_dep.")";
	}
	?>
	</td>
	<td width="200"><span><b>Order Qnty</b></span></td>
	<td>:&nbsp; <?  echo $po_quantity;//." ".$unit_of_measurement[$result[csf('order_uom')]] ; ?> </td>
	</tr>
	<tr>

	<td><b>Garments Item</b></td>
	<td>:&nbsp;
	<?
	$gmts_item_name="";
	$gmts_item=explode(',',$gmts_item_id);
	for($g=0;$g<=count($gmts_item); $g++)
	{
	$gmts_item_name.= $garments_item[$gmts_item[$g]].",";
	}
	echo rtrim($gmts_item_name,',');
	?>
	</td>
	<td><b>Booking Release Date</b></td>
	<td>:&nbsp;
	<?
	$booking_date=$result[csf('update_date')];
	if($booking_date=="" || $booking_date=="0000-00-00 00:00:00")
	{
	$booking_date=$result[csf('insert_date')];
	}
	echo change_date_format($booking_date,'dd-mm-yyyy','-','');
	?>&nbsp;&nbsp;&nbsp;</td>
	<td><b>Style Ref.</b>   </td>
	<td>:&nbsp;<b>
	<?
	echo $style_sting;
	?>
	</b>
	</td>
	</tr>
	<tr>
	<td><b>Style Des.</b></td>
	<td>:&nbsp;<? echo $style_description;?></td>
	<td><b>Season</b></td>
	<td>:&nbsp;<? if($season_matrix!='') echo $season_matrix;else echo $season_buyer_wise; ?></td>
	<td><b>Dealing Merchandiser</b></td>
	<td>:&nbsp;<? echo $dealing_marchant; ?></td>
	</tr>

	<tr>
	<td><b>Supplier Name</b>   </td>
	<td>:&nbsp;
	<?
	if($result[csf('pay_mode')]==5 || $result[csf('pay_mode')]==3){
	echo $company_library[$result[csf('supplier_id')]];
	}
	else{
	echo $supplier_name_arr[$result[csf('supplier_id')]];
	}
	?>    </td>
	<td><b>Delivery Date</b></td>
	<td>:&nbsp;<? echo change_date_format( $result[csf('delivery_date')],'dd-mm-yyyy','-');?></td>
	<td style="font-size:14px"><b>System Booking No </b>   </td>
	<td style="font-size:15px">:&nbsp;<b><? echo $result[csf('booking_no')];?></b><? echo "(".$fabric_source[$result[csf('fabric_source')]].")"?> <? //echo "(".$unit_of_measurement[$result[csf('uom')]].")"; $uom=$result[csf('uom')];?></td>
	</tr>
	<tr>
	<td><b>Attention</b></td>
	<td  >:&nbsp;<? echo $result[csf('attention')]; ?></td>
	<td><b>Lead Time </b>   </td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;">:&nbsp;
	<?
	echo $leadtime;
	?>
	</td>
	<td><b>Po Received Date</b></td>
	<td  >:&nbsp;<? echo $po_received_date; ?></td>
	</tr>
	<tr>
	<td><b>Order No</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;" colspan="3">:&nbsp;<? echo $po_number; ?></td>
	<td><b>Repeat No</b></td>
	<td  >:&nbsp;<? echo $order_repeat_no; ?></td>
	</tr>
	<tr>
	<td><b>Shipment Date</b></td>
<td colspan="3" style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> : First:&nbsp;<? echo rtrim($shipment_date,", "); //echo $max_pub_shipment_date; ?>, Last: <? echo $maxshipment_date; ?></td>
	<td><b>Quality Label</b></td>
	<td  >:&nbsp;<? echo $qlty_label; ?></td>
	</tr>
	</tr>
	<tr>
	<td><b>WO Prepared After</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
	<?
	$WOPreparedAfter=implode(",",array_unique(explode(",",chop($WOPreparedAfter,","))));
	echo $WOPreparedAfter.' Days' ;
	?></td>
 	<td><b>Ex-factory status</b></td>
	<td style="overflow:hidden;text-overflow: ellipsis;white-space: nowrap;"> :&nbsp;
	<?
	echo $shiping_status;
	?></td>

	<td><b>Job No</b></td>
	<td> :&nbsp;<b><? echo trim($job_no,"'"); ?></b></td>



	</tr>
	<tr>

	<td><b>File no</b></td>
	<td> :&nbsp;<b><? echo  $file_no;?></b></td>
	<td><b>Currency</b></td>
	<td> :&nbsp;<b><? echo  $currency[$result[csf("currency_id")]];?></b></td>

	<td><b>Remarks</b></td>
	<td> :<? echo $result[csf('remarks')]?></td>


	</tr>

	<tr>
	<td><b>Fabric Composition</b></td>
	<td colspan="3"> :<? echo $result[csf('fabric_composition')]?></td>
	<td><b>Short Booking Type</b></td>
	<td> :&nbsp;<? echo $short_booking_type[$result[csf('short_booking_type')]]?></td>
	</tr>

	</table>
	<?
	}


	?>
	<br/>
	<!--  Here will be the main portion  -->
	<?
	$costing_per="";
	$costing_per_qnty=0;
	$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no in($job_no_in)");
	if($costing_per_id==1)
	{
	$costing_per="1 Dzn";
	$costing_per_qnty=12;

	}
	if($costing_per_id==2)
	{
	$costing_per="1 Pcs";
	$costing_per_qnty=1;

	}
	if($costing_per_id==3)
	{
	$costing_per="2 Dzn";
	$costing_per_qnty=24;

	}
	if($costing_per_id==4)
	{
	$costing_per="3 Dzn";
	$costing_per_qnty=36;

	}
	if($costing_per_id==5)
	{
	$costing_per="4 Dzn";
	$costing_per_qnty=48;
	}
	$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no in($job_no_in)");
 	$uom_arr=array(1=>"Pcs",12=>"Kg",23=>"Mtr",27=>"Yds");
	$p=1;
	/*foreach($uom_arr as $uom_id=>$uom_val)
	{ */
	if($cbo_fabric_source==1 or $cbo_fabric_source==2 or $cbo_fabric_source==3){
	$nameArray_fabric_description= sql_select("select a.id as fabric_cost_dtls_id,a.lib_yarn_count_deter_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , d.dia_width,d.gmts_color_id,d.process_loss_percent,d.pre_cost_remarks,a.uom,d.id as did,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,avg(d.rate) as rates,sum(d.amount) as amounts ,d.fabric_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_number_id=d.gmts_color_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and a.job_no=d.job_no and a.id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.job_no='".$row_per_job[csf('job_no')]."' and d.status_active=1 and d.is_deleted=0 and b.cons>0 group by a.id,a.lib_yarn_count_deter_id,a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,d.dia_width,d.gmts_color_id,d.process_loss_percent,d.pre_cost_remarks,d.id,a.uom ,d.fabric_color_id order by a.body_part_id,d.fabric_color_id,a.uom  ");
	foreach($nameArray_fabric_description as $row){
		$yarn_count_id[$row[csf('lib_yarn_count_deter_id')]]=$row[csf('lib_yarn_count_deter_id')];
	}
	if(count($nameArray_fabric_description)>0){

	?>

	<table class="rpt_table" width="100%"  border="1" cellpadding="0" cellspacing="0" rules="all" >
	<caption> <strong>Fabric Booking Details </strong> </caption>

	<tr>
	<th  width="30" align="center">SL</th>
	<th  width="100" align="center">Garments Color</th>
	<th  width="100" align="center">Fabric Color</th>
	<th  width="240" align="left">Item Description</th>
 	<th  width="120" align="center">Fabric Composition</th>
	 <th  width="120" align="center">UOM</th>
	<th  width="100" align="center">Dia / Width</th>
	<th width='120' align="center">Finish Fab. Qty</th>
	<th width='120' align="center">Grey Fab. Qty</th>
	<th width='80' align="center">Process Loss</th>
	<th width='80' align="center">Fin Cons (Main)</th>
	<th width='80' align="center">Main Fab Qty(Fin)</th>
	<th width='120' align="center">Main Fab Qty (Grey)</th>
	<th width='120' align="center">Avg Rate</th>
	<th width='100' align="center">Amount</th>

	</tr>
	<?
	$nameArray_description= sql_select("select  a.body_part_id,d.fabric_color_id,avg(b.cons) as cons, sum(d.fin_fab_qnty) as fin_fab_qnty, sum(d.grey_fab_qnty) as grey_fab_qnty FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and b.po_break_down_id=d.po_break_down_id and b.color_size_table_id=d.color_size_table_id and b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and d.job_no='".$row_per_job[csf('job_no')]."' and d.status_active=1 and d.is_deleted=0  AND a.status_active = 1 AND a.is_deleted = 0   AND c.status_active = 1  AND c.is_deleted = 0  AND b.status_active = 1  AND b.is_deleted = 0  group by a.body_part_id,d.fabric_color_id");
	foreach($nameArray_description as $val)
	{
		$cons_arr[$val[csf("body_part_id")]][$val[csf("fabric_color_id")]]=$val[csf("cons")];
		$fin_fab_arr[$val[csf("body_part_id")]][$val[csf("fabric_color_id")]]=$val[csf("fin_fab_qnty")];
		$grey_fab_arr[$val[csf("body_part_id")]][$val[csf("fabric_color_id")]]=$val[csf("grey_fab_qnty")];
	}
	//echo '<pre>';print_r($cons_arr);die;

	$color_wise_process_loss=sql_select("select  a.body_part_id,b.fabric_color_id,avg(b.process_loss_percent) as loss FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls  b 	WHERE a.job_no=b.job_no  and  a.job_no='".$row_per_job[csf('job_no')]."' and b.is_short=1 and b.booking_no=$txt_booking_no   group by a.body_part_id,b.fabric_color_id
	");
	foreach($color_wise_process_loss as $val)
	{
		$loss_arr[$val[csf("body_part_id")]][$val[csf("fabric_color_id")]]=$val[csf("loss")];
	}

	$fabric_composition=return_library_array( "SELECT a.id, a.fabric_composition_id, b.fabric_composition_name from lib_yarn_count_determina_mst a join lib_fabric_composition b on b.id=a.fabric_composition_id where  a.status_active=1 ".where_con_using_array($yarn_count_id,0,'a.id')."", "id", "fabric_composition_name");
	foreach($nameArray_fabric_description as $val)
	{

		$color_wise_wo_sql_qnty=sql_select("select  sum(d.fin_fab_qnty) as fin_fab_qnty,sum(d.grey_fab_qnty) as grey_fab_qnty,avg(d.rate) as rate,sum(d.fin_fab_qnty*d.rate) as amount FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d WHERE a.job_no=d.job_no and a.id=d.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and d.job_no='".$row_per_job[csf('job_no')]."' and a.item_number_id='".$val[csf('item_number_id')]."' and a.body_part_id='".$val[csf('body_part_id')]."' and a.color_type_id='".$val[csf('color_type_id')]."' and a.construction='".$val[csf('construction')]."' and a.composition='".$val[csf('composition')]."' and a.gsm_weight='".$val[csf('gsm_weight')]."' and d.pre_cost_remarks='".$val[csf('pre_cost_remarks')]."' and d.id='".$val[csf('did')]."' and d.fabric_color_id='".$val[csf('fabric_color_id')]."' and d.status_active=1 and d.is_deleted=0 ");


	?>
	<tr>
	<td align="center"> <? echo $p; $p++;?></td>
	<td  align="center">
	<?
	echo $color_library[$val[csf('gmts_color_id')]];
	?>
	</td>
	<td  align="center">
	<?
	echo $color_library[$val[csf('fabric_color_id')]];
	?>
	</td>
 	<td align="left"> <? echo $body_part[$val[csf('body_part_id')]].','. $val[csf('construction')].','.$val[csf('composition')].','.$val[csf('gsm_weight')].',' .$fabric_typee[$val[csf('width_dia_type')]].',' .$color_type[$val[csf('color_type_id')]]; ?> </td>
	

	<td align="center"> <? echo $fabric_composition[$val[csf('lib_yarn_count_deter_id')]]; ?></td>
	<td align="center"> <? echo $unit_of_measurement[$val[csf('uom')]]; ?></td>
	<td align="center"> <? echo $val[csf('dia_width')]; ?></td>

	<td align="center"> <?   $fins= $color_wise_wo_sql_qnty[0][csf("fin_fab_qnty")];
	echo def_number_format($fins,2);
 	?> </td>
	<td align="center"> <? 
	 $greys= $color_wise_wo_sql_qnty[0][csf("grey_fab_qnty")];
	 echo def_number_format($greys,2); ?> </td>
	<td align="center"> <? echo $val[csf('process_loss_percent')]; ?> </td>
	<td align="center"> <? echo def_number_format($cons_arr[$val[csf("body_part_id")]][$val[csf("fabric_color_id")]],2); ?> </td>
	<td align="center"> <? echo def_number_format($fin_fab_arr[$val[csf("body_part_id")]][$val[csf("fabric_color_id")]],2); ?> </td>
	<td align="center"> <? echo def_number_format($grey_fab_arr[$val[csf("body_part_id")]][$val[csf("fabric_color_id")]],2); ?> </td>
	<td align="center"> <? echo def_number_format($color_wise_wo_sql_qnty[0][csf("rate")],2); ?> </td>
	<td align="center"> <? echo def_number_format($color_wise_wo_sql_qnty[0][csf("amount")],2); ?> </td>
	<?
	$total_fin_fab_qnty +=str_replace(",", "", def_number_format($fins,2));
	$total_grey_fab_qnty +=str_replace(",", "", def_number_format($greys,2));
	$total_amount +=str_replace(",", "",def_number_format($color_wise_wo_sql_qnty[0][csf("amount")],2));
	$total_main_fab_qnty +=str_replace(",", "",def_number_format($fin_fab_arr[$val[csf("body_part_id")]][$val[csf("fabric_color_id")]],2));
	$total_main_grey_qnty +=str_replace(",", "",def_number_format($grey_fab_arr[$val[csf("body_part_id")]][$val[csf("fabric_color_id")]],2));
	$total_cons_qnty +=str_replace(",", "",def_number_format($cons_arr[$val[csf("body_part_id")]][$val[csf("fabric_color_id")]],2));
	//$total_rate +=str_replace(",", "",def_number_format($color_wise_wo_sql_qnty[0][csf("rate")],2));
	?>
	</tr>
	<?
	}
	$avgTotRate=$total_amount/$total_fin_fab_qnty;
	?>
	<tr style=" font-weight:bold">
	<td  align="right" colspan="7"><strong>Total</strong></td>
	<td align="center"><? echo def_number_format($total_fin_fab_qnty,2);?></td>
	<td align="center"><? echo def_number_format($total_grey_fab_qnty,2);?></td>
	<td align="center"><? //echo def_number_format($total_grey_fab_qnty,2);?></td>
	<td align="center"><? //echo def_number_format($total_cons_qnty,2);?></td>
	<td align="center"><? echo def_number_format($total_main_fab_qnty,2);?></td>
	<td align="center"><? echo def_number_format($total_main_grey_qnty,2);?></td>
	<td align="center"><? echo def_number_format($avgTotRate,2);?></td>
	<td align="center"><? echo def_number_format($total_amount,2);?></td>

	</tr>

	</table>
	<br/>
	<?
	}
	}

	?>
	<!--New Start here-->
	<div style="width:1330px; float:left">
		<!--=====start======new add=======issue id====12210========05-06-2023========Shariar==============-->
        <?

	 $colar_percent_size_wise_array=return_library_array( "select a.colar_cuff_per,b.gmts_sizes from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b,wo_pre_cost_fabric_cost_dtls c  where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id=b.po_break_down_id and a.color_size_table_id=b.color_size_table_id and a.booking_no=$txt_booking_no and a.booking_type=1 and a.body_part_type in(40,50) and a.status_active=1 and a.is_deleted=0", "gmts_sizes", "colar_cuff_per");

		//echo  "select a.body_part_type,a.body_part_id,sum(d.rmg_qty) as rmg_qty,d.gmts_size,d.gmts_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d WHERE a.job_no=d.job_no and d.booking_no =$txt_booking_no and  a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 and d.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") group by a.body_part_type,a.body_part_id,d.gmts_size,d.gmts_color_id order by a.body_part_id";

		$nameArray_body_part=sql_select( "select a.body_part_type,a.body_part_id,sum(d.rmg_qty) as rmg_qty,d.gmts_size,d.gmts_color_id FROM wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls d WHERE a.job_no=d.job_no and d.booking_no =$txt_booking_no and  a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 and d.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.body_part_type in(40,50) group by a.body_part_type,a.body_part_id,d.gmts_size,d.gmts_color_id order by a.body_part_id");
			$row_count=count($nameArray_body_part);
		//if($row_count==0) echo " <p style='color:#f00; text-align:center; font-size:15px;'> Body part type is  used only Flat Knit and Cuff.</p> ";
		foreach($nameArray_body_part as $row)
		{
			$body_part_arr[$row[csf('body_part_id')]]['bpart_type']=$row[csf('body_part_type')];
			$body_part_rmg_qty_arr[$row[csf('body_part_id')]][$row[csf('gmts_size')]][$row[csf('gmts_color_id')]]['rmg_qty']+=$row[csf('rmg_qty')];
		}
		//print_r($body_part_arr);

		$k=1;
		foreach($body_part_arr as $body_id=>$val)
		{
			$k++;

			$bpart_type_id=$val['bpart_type'];
		$nameArray_item_size=sql_select( "select min(c.id) as id,b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=$body_id  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id  and d.status_active=1 and d.is_deleted=0 and a.body_part_type in(40,50) group by b.item_size,c.size_number_id order by id");

		/*$nameArray_item_size=sql_select( "select b.item_size,c.size_number_id FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no  and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 group by c.size_number_id,b.item_size order by c.size_number_id");*/
		?>
         <div style="max-height:1330px; width:660px; overflow:auto; float:left; padding-top:20px; margin-left:5px; margin-bottom:5px; position: relative;">
        <table  width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
        <tr>
        <td colspan="<? echo count($nameArray_size)+4;?>" align="center"><b><? echo $body_part[$body_id];?> -  Colour Size Breakedown in Pcs</b></td>
        </tr>
        <tr>
        <td width="70">Size</td>
        <?
		foreach($nameArray_item_size  as $result_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $size_library[$result_size[csf('size_number_id')]];?></strong></td>
		<?
        }
        ?>
        <td rowspan="2" align="center"><strong>Total</strong></td>

        </tr>
        <tr>
        <td>Collar Size</td>

        <?
        foreach($nameArray_item_size  as $result_item_size)
		{
		?>
		<td align="center" style="border:1px solid black"><strong><? echo $result_item_size[csf('item_size')];?></strong></td>
		<?
        }
        ?>
         <?

			$color_wise_wo_sql=sql_select("select a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method,c.color_number_id,sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=$body_id  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.color_number_id=d.gmts_color_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and a.body_part_type in(40,50) group by c.color_number_id,a.id,a.job_no, a.color_size_sensitive,a.color_break_down,a.process_loss_method order by a.id
");
		foreach($color_wise_wo_sql as $color_wise_wo_result)
	    {
			$color_total_collar=0;
			$color_total_collar_order_qnty=0;
			$process_loss_method=$color_wise_wo_result[csf("process_loss_method")];
			$constrast_color_arr=array();
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				$constrast_color=explode('__',$color_wise_wo_result[csf("color_break_down")]);
				for($i=0;$i<count($constrast_color);$i++)
				{
					$constrast_color2=explode('_',$constrast_color[$i]);
					$constrast_color_arr[$constrast_color2[0]]=$constrast_color2[2];
				}
			}
		?>
			<tr>
            <td>
            <?
			if($color_wise_wo_result[csf("color_size_sensitive")]==3)
			{
				echo strtoupper ($constrast_color_arr[$color_wise_wo_result[csf('color_number_id')]]) ;
				$lab_dip_color_id=return_field_value("contrast_color_id","wo_pre_cos_fab_co_color_dtls","job_no='".$color_wise_wo_result[csf('job_no')]."' and pre_cost_fabric_cost_dtls_id=".$color_wise_wo_result[csf('id')]." and gmts_color_id=".$color_wise_wo_result[csf('color_number_id')]."");
			}
			else
			{
				echo $color_library[$color_wise_wo_result[csf('color_number_id')]];
				$lab_dip_color_id=$color_wise_wo_result[csf('color_number_id')];
			}
			?>

            </td>
            <?
            foreach($nameArray_item_size  as $result_size)
			{
				?>
				<td align="center" style="border:1px solid black">

				<?
				$rmg_qty=$body_part_rmg_qty_arr[$body_id][$result_size[csf('size_number_id')]][$color_wise_wo_result[csf('color_number_id')]]['rmg_qty'];
				//echo $bpart_type_id.'=';
				if($bpart_type_id==50)//Cuff
				{
					$tot_rmg_qty=$rmg_qty*2;
				}
				else //Flat Knit
				{
					$tot_rmg_qty=$rmg_qty;
				}
				//$color_wise_wo_sql_qnty=sql_select("select c.color_number_id,sum(c.order_quantity) as order_quantity, sum(c.plan_cut_qnty) as plan_cut_qnty FROM wo_pre_cost_fabric_cost_dtls a,wo_pre_cos_fab_co_avg_con_dtls b, wo_po_color_size_breakdown c , wo_booking_dtls d WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and d.booking_no =$txt_booking_no and a.body_part_id=2  and c.job_no_mst=a.job_no and c.id=b.color_size_table_id and d.po_break_down_id=c.po_break_down_id and c.id=d.color_size_table_id and a.id=d.pre_cost_fabric_cost_dtls_id and d.status_active=1 and d.is_deleted=0 and c.color_number_id='".$color_wise_wo_result['color_number_id']."' and c.size_number_id='".$result_size['size_number_id']."'");
				/*$color_wise_wo_sql_qnty=sql_select( "select sum(plan_cut_qnty) as plan_cut_qnty, sum(order_quantity) as order_quantity  from wo_po_color_size_breakdown where  po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and  size_number_id =".$result_size[csf('size_number_id')]." and color_number_id =".$color_wise_wo_result[csf('color_number_id')]."   and  status_active=1 and is_deleted =0");

				list($plan_cut_qnty)=$color_wise_wo_sql_qnty;*/
				//$plan_cut=$plan_cut_qnty[csf('plan_cut_qnty')];
				//$colar_excess_per=($plan_cut*$colar_excess_percent)/100;
				echo number_format($tot_rmg_qty,0);
				$color_total_collar+=$tot_rmg_qty;
				$color_total_collar_order_qnty+=$tot_rmg_qty;
				$grand_total_collar+=$tot_rmg_qty;
				$grand_total_collar_order_qnty+=$tot_rmg_qty;

				$size_tatal[$result_size[csf('size_number_id')]]+=$tot_rmg_qty;
				?>
                </td>
				<?
			}
			?>

            <td align="center"><? echo number_format($color_total_collar,0); ?></td>

            </tr>
            <?
		    }
			?>
            <tr>
                <td>Size Total</td>

                <?
                foreach($nameArray_item_size  as $result_size)
                {
					//$colar_excess_pers=($size_tatal[$result_size[csf('size_number_id')]]*$colar_excess_percent)/100;
					$tot_size_tatal=$size_tatal[$result_size[csf('size_number_id')]];
					//$size_tatal[$result_size[csf('size_number_id')]]=0;
                ?>
                <td style="border:1px solid black;  text-align:center"><?  echo number_format($size_tatal[$result_size[csf('size_number_id')]],0);$size_tatal[$result_size[csf('size_number_id')]]=0; ?></td>
                <?
                }
                ?>
                <td  style="border:1px solid black;  text-align:center"><?  echo number_format($grand_total_collar,0);$grand_total_collar=0; ?></td>

            </tr>
        </table>
          <br/>
          </div>

        <?
		}

		?>
          <!--End here-->
	   <!--=====end======new add=======issue id====12210========05-06-2023========Shariar==============-->
	<?
		$department_name_library=return_library_array( "select id,department_name from  lib_department where status_active=1 and is_deleted=0 order by  department_name", "id", "department_name"  );
		$cause_library=return_library_array( "select id,cause from  booking_cause where status_active=1 and is_deleted=0 order by  cause", "id", "cause"  );
		$color_name_arr=return_library_array( "SELECT id,color_name from lib_color where status_active =1 and is_deleted=0",'id','color_name');
		$sql_responsible= sql_select("SELECT  a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,b.dia_width,avg(b.process_loss_percent) as process_loss_percent,avg(rmg_qty) as rmg_qty, b.division_id,b.responsible_dept,b.responsible_person,b.reason,b.fabric_color_id,c.res_company,c.qty,c.cause,c.cause_description,c.cause_id FROM wo_pre_cost_fabric_cost_dtls a,wo_booking_dtls b,wo_booking_short_cause c where b.booking_no =$txt_booking_no and a.id=b.pre_cost_fabric_cost_dtls_id  and  b.booking_no=c.booking_no and b.id= c.dtls_id and a.status_active=1 and
		a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and b.grey_fab_qnty>0 group by a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,b.dia_width,b.responsible_dept,	b.responsible_person,b.division_id,	b.reason,b.fabric_color_id,c.res_company,c.qty,c.cause,c.cause_description,c.cause_id order by b.fabric_color_id");
		$res_data_arr = array();
		foreach($sql_res as $row)
		{
			$res_data_arr[$row[csf('fabric_color_id')]]['fabric_color_id']=$color_name_arr[$row[csf('fabric_color_id')]];
			$res_data_arr[$row[csf('fabric_color_id')]]['composition']=$row[csf('composition')];
			$res_data_arr[$row[csf('fabric_color_id')]]['body_part_id']= $body_part[$row[csf('body_part_id')]];
			$res_data_arr[$row[csf('fabric_color_id')]]['res_company']=$company_library[$row[csf('res_company')]];
			$res_data_arr[$row[csf('fabric_color_id')]]['responsible_dept']=$row[csf('responsible_dept')];
			$res_data_arr[$row[csf('fabric_color_id')]]['cause']=$cause_library[$row[csf('cause')]];
			$res_data_arr[$row[csf('fabric_color_id')]]['qty']=$row[csf('qty')];
			$res_data_arr[$row[csf('fabric_color_id')]]['cause_id']=$row[csf('cause_id')];
			$res_data_arr[$row[csf('fabric_color_id')]]['cause_description']=$row[csf('cause_description')];
		}
		
		if(count($sql_responsible)>0)
		{
			
		?>
        <table width="100%"  border="1" cellpadding="0" cellspacing="0" class="rpt_table" rules="all">
			<tr>
				<td align="center">SL</td>
				<td align="center" >Garments Colour</td>
				<td align="center">Composition</td>
				<td align="center">Body Part</td>
				<td align="center">Responsible Unit</td>
				<td align="center">Cause Dept.</td>
				<td align="center">Reason</td>
				<td align="center">Cause Description</td>
				<td align="center">Required Qty</td>
			</tr>
         <?
		 $ir=1;
		foreach($sql_responsible as $sql_responsible_row)
		{

			$rowspan=0;
			$rowspan=count($sql_responsible_row[csf('fabric_color_id')]);
			?>
             <tr>
				<td align="center" rowspan="<?= $rowspan ?>"><? echo $ir; ?></td>
				<td align="center" rowspan="<?= $rowspan ?>"><? echo $color_name_arr[$sql_responsible_row[csf('fabric_color_id')]]; ?></td>
				<td align="center"><? echo $sql_responsible_row[csf('composition')]; ?></td>
				<td align="center"><? echo $body_part[$sql_responsible_row[csf('body_part_id')]]; ?></td>
				<td align="center"><? echo $company_library[$sql_responsible_row[csf('res_company')]]; ?></td>
				<td align="center"><? echo $short_booking_cause_arr[$sql_responsible_row[csf('cause_id')]]; ?>
				</td>
				<td align="center"><? echo $cause_library[$sql_responsible_row[csf('cause')]]; ?></td>
				<td align="center"><?  echo $sql_responsible_row[csf('cause_description')]; ?></td>
				<td align="center"><?  echo $sql_responsible_row[csf('qty')]; ?></td>
             </tr>
            <?
			$tot_qty+=$sql_responsible_row[csf('qty')];
			$ir++;

		}
		 ?>
		 <tr>
			<td colspan="8" align="right">Total</td>
			<td align="center"><? echo $tot_qty?></td>
		 </tr>
         </table>
         <?
		}
		 ?>

        <br>

        <br>
	<table width="100%"   cellpadding="2" cellspacing="0" rules="all" style="border-left: none;border-right: none;border-top: none;border-bottom: none;">
		<tr>
		 	<td align="left" width="650" style="border-left: none;border-right: none;border-top: none;border-bottom: none;">
		 		<?php echo get_spacial_instruction($txt_booking_no); ?>
		 	</td>
		</tr>
	</table>
	<br>

	<?
	echo signature_table(4, $cbo_company_name, "1330px","",1,$INSERTED_BY);
	//echo signature_table(4, $cbo_company_name, "1330px");
	?>
    <p class=""></p>

    <?
	}
	$job_no_all= implode(",",array_unique($joball['job_no']));
	$style_sting_all=implode(",",array_unique($joball['style_ref_no']));

	echo "****".custom_file_name($txt_booking_no,$style_sting_all,$job_no_all);
	?>
	</div>
	<?
	exit();
}

if($action=="po_wise")
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$imge_arr=return_library_array( "select master_tble_id,image_location from common_photo_library where form_name='company_details' or form_name='knit_order_entry' and file_type=1",'master_tble_id','image_location');

	$company_library=return_library_array( "select id,company_name from lib_company", "id", "company_name");
	$color_library=return_library_array( "select id,color_name from lib_color where status_active =1 and is_deleted=0", "id", "color_name");
	$size_library=return_library_array( "select id,size_name from lib_size where status_active =1 and is_deleted=0", "id", "size_name");
	$country_arr=return_library_array( "select id,country_name from   lib_country",'id','country_name');
	$supplier_name_arr=return_library_array( "select id,supplier_name from lib_supplier",'id','supplier_name');

	$marchentrArr = return_library_array("select id,team_member_name from lib_mkt_team_member_info ","id","team_member_name");
	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$location_name_arr=return_library_array( "select id,location_name from lib_location",'id','location_name');

	$pro_sub_dept_array=return_library_array( "select id,sub_department_name from lib_pro_sub_deparatment",'id','sub_department_name');
	$season_arr=return_library_array("select id,season_name from lib_buyer_season","id","season_name");
	$uom=0;
	$joball=array();
	$nameArray_per_job=sql_select( "select  a.job_no,a.style_ref_no  from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0  group by a.job_no,a.style_ref_no");
	foreach ($nameArray_per_job as $row_per_job){
	$joball['job_no'][$row_per_job[csf('job_no')]]=$row_per_job[csf('job_no')];
	$joball['style_ref_no'][$row_per_job[csf('job_no')]]=$row_per_job[csf('style_ref_no')];

	$uom=0;
	$job_data_arr=array();
	$nameArray_buyer=sql_select( "select  a.style_ref_no,a.style_description, a.job_no, a.style_owner, a.buyer_name, b.responsible_dept, b.responsible_person, b.reason, a.dealing_marchant,a.season,a.season_matrix,a.season_buyer_wise,a.total_set_qnty,a.product_dept,a.product_code,a.pro_sub_dep,a.gmts_item_id ,a.order_repeat_no,a.qlty_label  from wo_po_details_master a, wo_booking_dtls b where a.job_no=b.job_no and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0 and a.job_no='".$row_per_job[csf('job_no')]."'");
	foreach ($nameArray_buyer as $result_buy){
	$job_data_arr['job_no'][$result_buy[csf('job_no')]]=$result_buy[csf('job_no')];
	$job_data_arr['job_no_in'][$result_buy[csf('job_no')]]="'".$result_buy[csf('job_no')]."'";
	$job_data_arr['total_set_qnty'][$result_buy[csf('job_no')]]=$result_buy[csf('total_set_qnty')];
	$job_data_arr['product_dept'][$result_buy[csf('job_no')]]=$product_dept[$result_buy[csf('product_dept')]];
	$job_data_arr['product_code'][$result_buy[csf('job_no')]]=$result_buy[csf('product_code')];
	$job_data_arr['pro_sub_dep'][$result_buy[csf('job_no')]]=$pro_sub_dept_array[$result_buy[csf('pro_sub_dep')]];
	$job_data_arr['gmts_item_id'][$result_buy[csf('job_no')]]=$result_buy[csf('gmts_item_id')];
	$job_data_arr['style_ref_no'][$result_buy[csf('job_no')]]=$result_buy[csf('style_ref_no')];
	$job_data_arr['style_description'][$result_buy[csf('job_no')]]=$result_buy[csf('style_description')];
	$job_data_arr['dealing_marchant'][$result_buy[csf('job_no')]]=$marchentrArr[$result_buy[csf('dealing_marchant')]];
	$job_data_arr['season_matrix'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_matrix')]];
	$job_data_arr['season_buyer_wise'][$result_buy[csf('job_no')]]=$season_arr[$result_buy[csf('season_buyer_wise')]];
	$job_data_arr['order_repeat_no'][$result_buy[csf('job_no')]]=$result_buy[csf('order_repeat_no')];
	$job_data_arr['qlty_label'][$result_buy[csf('job_no')]]=$quality_label[$result_buy[csf('qlty_label')]];

	$job_data_arr['responsible_person'][$result_buy[csf('responsible_person')]]=$result_buy[csf('responsible_person')];
	$job_data_arr['responsible_dept'][$result_buy[csf('responsible_dept')]]=$result_buy[csf('responsible_dept')];
	$job_data_arr['reason'][$result_buy[csf('reason')]]=$result_buy[csf('reason')];
	}

	$job_no= implode(",",array_unique($job_data_arr['job_no']));
	$job_no_in= implode(",",array_unique($job_data_arr['job_no_in']));
	$product_depertment=implode(",",array_unique($job_data_arr['product_dept']));
	$product_code=implode(",",array_unique($job_data_arr['product_code']));
	$pro_sub_dep=implode(",",array_unique($job_data_arr['pro_sub_dep']));
	$gmts_item_id=implode(",",array_unique($job_data_arr['gmts_item_id']));
	$style_sting=implode(",",array_unique($job_data_arr['style_ref_no']));
	$style_description=implode(",",array_unique($job_data_arr['style_description']));
	$dealing_marchant=implode(",",array_unique($job_data_arr['dealing_marchant']));
	$season_matrix=implode(",",array_unique($job_data_arr['season_matrix']));
	$season_buyer_wise=implode(",",array_unique($job_data_arr['season_buyer_wise']));
	$order_repeat_no= implode(",",array_unique($job_data_arr['order_repeat_no']));
	$qlty_label= implode(",",array_unique($job_data_arr['qlty_label']));
	?>
    <style>
		@media print {
			.gg {page-break-after: always;}
		}
		@media print
		{
			.page-break { height:0; page-break-before:always; margin:0; border-top:none; }
		}

			body, p, span, td, a {font-size:10pt;font-family: Arial;}
			body{margin-left:2em; margin-right:2em; font-family: "Arial Narrow", Arial, sans-serif;}
			.page{
					height:947px;
					padding-top:5px;
					page-break-after : always;
					font-family: Arial, Helvetica, sans-serif;
					position:relative;
					border-bottom:1px solid #000;
				}
	</style>
	<div style="width:1330px" align="center">

	<?php
		$nameArray_approved = sql_select("select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12 and a.status_active =1 and a.is_deleted=0");
		list($nameArray_approved_row) = $nameArray_approved;
		$nameArray_approved_date = sql_select("select b.approved_date as approved_date from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
		list($nameArray_approved_date_row) = $nameArray_approved_date;
		$nameArray_approved_comments = sql_select("select b.comments as comments from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=12 and b.approved_no='" . $nameArray_approved_row[csf('approved_no')] . "' and a.status_active =1 and a.is_deleted=0");
		list($nameArray_approved_comments_row) = $nameArray_approved_comments;
		$path = str_replace("'", "", $path);
		if ($path != "") {
			$path = $path;
		} else {
			$path = "../../";
		}
		$ref_data=array();
		$nameArray_ref=sql_select( "select b.grouping from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no='".$row_per_job[csf('job_no')]."' group by b.grouping ");
		foreach ($nameArray_ref as $result_ref){
			$ref_data['grouping'][$result_ref[csf('id')]]=$result_ref[csf('grouping')];
		}
		$grouping=implode(",",array_unique($ref_data['grouping']));

	?>										<!--    Header Company Information         -->
	<table width="100%" cellpadding="0" cellspacing="0" style="border:1px solid black" >
	<tr>
		<td width="100">
		<img  src='<? echo $path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
		</td>
	<td width="1250">
	<table width="100%" cellpadding="0" cellspacing="0"  >
	<tr>
		<td style="font-size:20px;" align="center"><b>
		<?php echo $company_library[$cbo_company_name]; ?>
		</b></td>
	<td rowspan="3" width="250">

	<span><b>Internal Booking No:&nbsp;&nbsp;<? echo $grouping; ?></b></span><br/>
	<?
	if($nameArray_approved_row[csf('approved_no')]>1)
	{
	?>
	<b> Revised No: <? echo $nameArray_approved_row[csf('approved_no')]-1; ?></b>
	<br/>
	Approved Date: <? echo $nameArray_approved_date_row[csf('approved_date')]; ?>
	<?
	}
	?>


	</td>
	</tr>
	<tr>
	<td style="font-size:18px;" align="center"><b>
	<?
	$nameArray=sql_select( "select plot_no,level_no,road_no,block_no,country_id,province,city,zip_code,email,website from lib_company where id=$cbo_company_name");
	if($txt_job_no!="")
	{
	$location=return_field_value( "location_name", "wo_po_details_master","job_no=$txt_job_no");
	}
	else
	{
	$location="";
	}

	foreach ($nameArray as $result)
	{
	echo  $location_name_arr[$location];
	
	?>
	<br>
	Email Address: <? echo $result[csf('email')];?>
	Website No: <? echo $result[csf('website')]; ?>

	<?

	}

	?>
	</b></td>
	</tr>
	<tr>
	<td style="font-size:18px;" align="center">
	<strong><? if($report_title !=""){ echo $report_title;} else { echo "General Work Order";}?> &nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font style="color:#F00"><? if(str_replace("'","",$id_approved_id) ==1){ echo "(Approved)";}else{echo "";}; ?> </font></strong>
	</td>
	</tr>
	</table>
	</td>
	</tr>
	</table>
	<?
	$po_data=array();
	$nameArray_job=sql_select( "select b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,(pub_shipment_date-po_received_date) date_diff,MIN(po_received_date) as po_received_date,MIN(pub_shipment_date) as pub_shipment_date,MIN(b.insert_date) as insert_date,b.shiping_status   from wo_booking_dtls a, wo_po_break_down b where a.po_break_down_id=b.id and a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0 and a.job_no='".$row_per_job[csf('job_no')]."' group by b.job_no_mst,b.id, b.po_number,b.grouping, b.file_no, b.po_quantity,pub_shipment_date,po_received_date,b.insert_date,b.shiping_status ");
	foreach ($nameArray_job as $result_job){
		$po_data['po_id'][$result_job[csf('id')]]=$result_job[csf('id')];
		$po_data['po_number'][$result_job[csf('id')]]=$result_job[csf('po_number')];
		$po_data['leadtime'][$result_job[csf('id')]]=$result_job[csf('date_diff')];
		$po_data['po_quantity'][$result_job[csf('id')]]=$result_job[csf('po_quantity')];
		$po_data['po_received_date'][$result_job[csf('id')]]=change_date_format($result_job[csf('po_received_date')],'dd-mm-yyyy','-');
		$ddd=strtotime($result_job[csf('pub_shipment_date')]);
		$po_data['pub_shipment_date'][$ddd]=$ddd;

		$po_data['insert_date'][$result_job[csf('id')]]=$result_job[csf('insert_date')];

		if($result_job[csf('shiping_status')]==1){
		$shiping_status= "FP";
		}
		else if($result_job[csf('shiping_status')]==2){
		$shiping_status= "PS";
		}
		else if($result_job[csf('shiping_status')]==3){
		$shiping_status= "FS";
		}
		$po_data['shiping_status'][$result_job[csf('id')]]=$shiping_status;
		$po_data['file_no'][$result_job[csf('id')]]=$result_job[csf('file_no')];
		$po_data['grouping'][$result_job[csf('id')]]=$result_job[csf('grouping')];
	}
	$txt_order_no_id=implode(",",array_unique($po_data['po_id']));
	$leadtime=implode(",",array_unique($po_data['leadtime']));
	$po_quantity=array_sum($po_data['po_quantity']);
	$po_received_date=implode(",",array_unique($po_data['po_received_date']));
	$po_number=implode(",",array_unique($po_data['po_number']));
	$shipment_date=date('d-m-Y',min($po_data['pub_shipment_date']));
	$maxshipment_date=date('d-m-Y',max($po_data['pub_shipment_date']));
	$shiping_status=implode(",",array_unique($po_data['shiping_status']));
	$file_no=implode(",",array_unique($po_data['file_no']));
	$grouping=implode(",",array_unique($po_data['grouping']));


	$colar_excess_percent=0;
	$cuff_excess_percent=0;
	$rmg_process_breakdown=0;
	$nameArray=sql_select( "select a.buyer_id,a.booking_no,a.booking_date,a.supplier_id,a.currency_id,a.exchange_rate,a.attention,a.delivery_date,a.po_break_down_id,a.colar_excess_percent,a.cuff_excess_percent,a.delivery_date,a.is_apply_last_update,a.fabric_source,a.rmg_process_breakdown,a.insert_date,a.update_date,a.uom,a.remarks,a.pay_mode,a.fabric_composition,a.short_booking_type from wo_booking_mst a  where   a.booking_no=$txt_booking_no and a.status_active =1 and a.is_deleted=0");
	foreach ($nameArray as $result)
	{
		$total_set_qnty=$result[csf('total_set_qnty')];
		$colar_excess_percent=$result[csf('colar_excess_percent')];
		$cuff_excess_percent=$result[csf('cuff_excess_percent')];
		$rmg_process_breakdown=$result[csf('rmg_process_breakdown')];
		foreach ($po_data['po_id'] as $po_id=>$po_val){
			$daysInHand.=(datediff('d',date('d-m-Y',time()),$po_data['pub_shipment_date'][$po_id])-1).",";
			$booking_date=$result[csf('update_date')];
			if($booking_date=="" || $booking_date=="0000-00-00 00:00:00"){
			$booking_date=$result[csf('insert_date')];
			}
			$WOPreparedAfter.=(datediff('d',$po_data['insert_date'][$po_id],$booking_date)-1).",";
		}
	?>
	<?
	}


	?>
	<br/>
	<!--  Here will be the main portion  -->
	<?
	$costing_per="";
	$costing_per_qnty=0;
	$costing_per_id=return_field_value( "costing_per", "wo_pre_cost_mst","job_no in($job_no_in)");
	if($costing_per_id==1)
	{
	$costing_per="1 Dzn";
	$costing_per_qnty=12;

	}
	if($costing_per_id==2)
	{
	$costing_per="1 Pcs";
	$costing_per_qnty=1;

	}
	if($costing_per_id==3)
	{
	$costing_per="2 Dzn";
	$costing_per_qnty=24;

	}
	if($costing_per_id==4)
	{
	$costing_per="3 Dzn";
	$costing_per_qnty=36;

	}
	if($costing_per_id==5)
	{
	$costing_per="4 Dzn";
	$costing_per_qnty=48;
	}
	$process_loss_method=return_field_value( "process_loss_method", "wo_pre_cost_fabric_cost_dtls","job_no in($job_no_in)");
 	$uom_arr=array(1=>"Pcs",12=>"Kg",23=>"Mtr",27=>"Yds");
	$p=1;
	/*foreach($uom_arr as $uom_id=>$uom_val)
	{ */
	if($cbo_fabric_source==1 or $cbo_fabric_source==2 or $cbo_fabric_source==3){
	$nameArray_fabric_description= sql_select("select a.id as fabric_cost_dtls_id, a.item_number_id, a.body_part_id,a.color_type_id, a.construction, a.composition, a.gsm_weight,a.width_dia_type as width_dia_type , d.dia_width,d.pre_cost_remarks,a.uom,sum(d.fin_fab_qnty) as fin_fab_qntys,sum(d.grey_fab_qnty) as grey_fab_qntys,avg(d.rate) as rates,sum(d.amount) as amounts ,d.fabric_color_id  FROM wo_pre_cost_fabric_cost_dtls a, wo_po_color_size_breakdown c, wo_pre_cos_fab_co_avg_con_dtls b, wo_booking_dtls d
	WHERE a.job_no=b.job_no and
	a.id=b.pre_cost_fabric_cost_dtls_id and
	c.job_no_mst=a.job_no and
	c.id=b.color_size_table_id and
	b.po_break_down_id=d.po_break_down_id and
	b.color_number_id=d.gmts_color_id and

	b.pre_cost_fabric_cost_dtls_id=d.pre_cost_fabric_cost_dtls_id and
	a.job_no=d.job_no and
	a.id=d.pre_cost_fabric_cost_dtls_id
	and
	d.booking_no =$txt_booking_no and
	d.job_no='".$row_per_job[csf('job_no')]."' and

	d.status_active=1 and
	d.is_deleted=0 and
	b.cons>0
	group by a.id,a.item_number_id,a.body_part_id,a.color_type_id,a.construction,a.composition,a.gsm_weight,a.width_dia_type,d.dia_width,d.pre_cost_remarks,a.uom ,d.fabric_color_id order by a.body_part_id,d.fabric_color_id,a.uom  ");
	}

		?>

      <br/>
       <br/>

	<?


		$item_ratio_array=return_library_array( "select gmts_item_id,set_item_ratio from wo_po_details_mas_set_details  where job_no ='$job_no'", "gmts_item_id", "set_item_ratio");
		$po_number_arr=return_library_array( "select id,po_number from wo_po_break_down  where job_no_mst ='$job_no'", "id", "po_number");
		$shipment_date_arr=return_library_array( "select id,shipment_date from wo_po_break_down  where job_no_mst ='$job_no'", "id", "shipment_date");
		$grand_order_total=0; $grand_plan_total=0; $size_wise_total=array();
		$nameArray_size=sql_select( "select size_number_id,size_order from wo_po_color_size_breakdown where po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and is_deleted=0 and status_active=1 group by size_number_id,size_order order by size_order ");

		$main_finish_fabric_qnty_array=array(); 
		$booking_qnty_main= "select a.po_break_down_id,sum(a.grey_fab_qnty) as  grey_fab_qnty,a.gmts_color_id  from wo_booking_dtls a, wo_po_break_down b, wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no  and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1 and a.is_short=2 and c.item_category=2 and a.status_active=1 and a.is_deleted=0 group by a.po_break_down_id,a.gmts_color_id order by a.po_break_down_id";
		$booking_qnty_main_res=sql_select($booking_qnty_main);
		foreach($booking_qnty_main_res as $row)
		{

			$main_finish_fabric_qnty_array[$row[csf("po_break_down_id")]][$row[csf("gmts_color_id")]]+=$row[csf("grey_fab_qnty")];

		}
		unset($booking_qnty_main_res);

		$short_finish_fabric_qnty_array=array(); 
		$booking_qnty_short="select a.po_break_down_id,sum(a.grey_fab_qnty) as  grey_fab_qnty,a.gmts_color_id from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =1  and c.item_category=2 and a.is_short=1 and a.status_active=1 and a.is_deleted=0 group by a.po_break_down_id,a.gmts_color_id order by a.po_break_down_id";
		$booking_qnty_short_res=sql_select($booking_qnty_short);
		foreach($booking_qnty_short_res as $row)
		{

			$short_finish_fabric_qnty_array[$row[csf("po_break_down_id")]][$row[csf("gmts_color_id")]]+=$row[csf("grey_fab_qnty")];

		}
		unset($booking_qnty_short_res);

		$sample_finish_fabric_qnty_array=array(); 
		$booking_qnty_sample="select a.po_break_down_id,sum(a.grey_fab_qnty) as  grey_fab_qnty,a.gmts_color_id from wo_booking_dtls a, wo_po_break_down b , wo_booking_mst c  where a.job_no =b.job_no_mst and  a.job_no =c.job_no and  a.booking_no =c.booking_no and a.po_break_down_id =b.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_type =4  and c.item_category=2  and a.status_active=1 and a.is_deleted=0 group by a.po_break_down_id,a.gmts_color_id order by a.po_break_down_id";
		$booking_qnty_sample_res=sql_select($booking_qnty_sample);
		foreach($booking_qnty_sample_res as $row)
		{

			$sample_finish_fabric_qnty_array[$row[csf("po_break_down_id")]][$row[csf("gmts_color_id")]]+=$row[csf("grey_fab_qnty")];

		}
		unset($booking_qnty_sample_res);
		$booking_dtls_sql="SELECT a.id as booking_dtls_id, b.id, a.fabric_color_id, a.fin_fab_qnty, a.grey_fab_qnty, a.amount, a.rate, a.colar_cuff_per  from wo_booking_dtls a, wo_pre_cos_fab_co_avg_con_dtls b, wo_pre_cost_fabric_cost_dtls c where a.pre_cost_fabric_cost_dtls_id=b.pre_cost_fabric_cost_dtls_id and a.po_break_down_id=b.po_break_down_id and a.pre_cost_fabric_cost_dtls_id=c.id and a.po_break_down_id in(".str_replace("'","",$txt_order_no_id).") and a.booking_no=$txt_booking_no and a.booking_type=1 and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0";
		$booking_dtls_res=sql_select($booking_dtls_sql);

		$booking_dtls_id_array=array(); $fabric_color_array=array(); $finish_fabric_qnty_array=array(); $grey_fabric_qnty_array=array(); $grey_fabric_amount_array=array(); $grey_fabric_rate_array=array(); $colar_cuff_percent_array=array();

			foreach($booking_dtls_res as $row)
			{
			$booking_dtls_id_array[$row[csf("id")]]=$row[csf("booking_dtls_id")];
			$fabric_color_array[$row[csf("id")]]=$row[csf("fabric_color_id")];
			$finish_fabric_qnty_array[$row[csf("id")]]+=$row[csf("fin_fab_qnty")];
			$grey_fabric_qnty_array[$row[csf("id")]]+=$row[csf("grey_fab_qnty")];
			$grey_fabric_amount_array[$row[csf("id")]]=$row[csf("amount")];
			$grey_fabric_rate_array[$row[csf("id")]]['rate']=$row[csf("rate")];
			$grey_fabric_rate_array[$row[csf("id")]]['colar_cuff_per']=$row[csf("colar_cuff_per")];
			}
			unset($booking_dtls_res);


		$name_sql="select a.id as pre_cost_fabric_cost_dtls_id, a.job_no, a.item_number_id, a.body_part_id, a.fab_nature_id, a.fabric_source, a.color_type_id, a.gsm_weight, a.construction, a.composition, a.color_size_sensitive, a.costing_per, a.color, a.color_break_down, a.rate as rate_mst, b.id, b.po_break_down_id, b.color_size_table_id, b.color_number_id, b.gmts_sizes as size_number_id, b.dia_width, b.item_size, b.cons, b.process_loss_percent, b.requirment, b.rate, b.pcs, b.remarks FROM wo_pre_cost_fabric_cost_dtls a, wo_pre_cos_fab_co_avg_con_dtls b
		WHERE a.job_no=b.job_no and a.id=b.pre_cost_fabric_cost_dtls_id and a.job_no='$job_no' and b.po_break_down_id in(".str_replace("'","",$txt_order_no_id).")   and a.status_active=1 and a.is_deleted=0 order by a.id,b.color_size_table_id";

	//echo $name_sql;
	$nameArray=sql_select($name_sql);

	$po_fabric_wise_data=array();
	foreach ($nameArray as $result){

	if($finish_fabric_qnty_array[$result[csf("id")]]>0  || $grey_fabric_qnty_array[$result[csf("id")]]> 0)
	{

		$ship_date=change_date_format($shipment_date_arr[$result[csf('po_break_down_id')]]);
		$po_fabric_wise_data[$result[csf('po_break_down_id')]][$ship_date][$result[csf('color_number_id')]]['finish_kg']+=$finish_fabric_qnty_array[$result[csf("id")]];
		$po_fabric_wise_data[$result[csf('po_break_down_id')]][$ship_date][$result[csf('color_number_id')]]['grey_kg']+=$grey_fabric_qnty_array[$result[csf("id")]];
		$po_fabric_wise_data[$result[csf('po_break_down_id')]][$ship_date][$result[csf('color_number_id')]]['process_loss']=$result[csf('process_loss_percent')];
		$po_fabric_wise_data[$result[csf('po_break_down_id')]][$ship_date][$result[csf('color_number_id')]]['color_size_sensitive']=$result[csf('color_size_sensitive')];
		$po_fabric_wise_data[$result[csf('po_break_down_id')]][$ship_date][$result[csf('color_number_id')]]['id']=$result[csf('id')];
		$po_wise_rows[$result[csf('po_break_down_id')]]+=1;

	}
}

?>
<div id="div_size_color_matrix" class="pagebreak">
		<fieldset id="div_size_color_matrix" >
			<legend>Size and Color Breakdown</legend>
			<table  class="rpt_table"  border="1" align="left" style="float:left;" cellpadding="0"  cellspacing="0" rules="all" >
				<tr>
					<td>PO Number</td>
				
					<td>Ship Date</td>
					<td>Color</td>                          	
					<td  align="center"> Total Finish Fabric(kg)</td>
					<td  align="center"> Total Grey Fabric(kg)</td>
					<td  align="center"> Process Loss</td>
					<td  align="center"> Pre-Cost Qty</td>
					<td  align="center"> Mn.Book Qty</td>
					<td  align="center"> Sht.Book Qty</td>
					<td  align="center"> Smp.Book Qty</td>
					<td  align="center"> Total Booking Qty</td>
					<td  align="center"> Comments</td>
				</tr>
				<?
			   
				foreach ($po_fabric_wise_data as $po_id=>$shipdate_data){
					foreach ($shipdate_data as $date_id=>$color_data) {
						foreach ($color_data as  $color_id=>$result){

					?>
					<tr>
						
						<td   title="<?=$po_id;?>"><?php echo $po_number_arr[$po_id]; ?></td>
						
						<td><?php echo $date_id; ?></td>									
						<td><? if($result["color_size_sensitive"]!=0) echo $color_library[$color_id]; ?></td>									
						
						<?

						$grand_fabric_total+=$result["finish_kg"];
						$grand_grey_total+=$result["grey_kg"];
						$grand_main_fabric_total+=$main_finish_fabric_qnty_array[$po_id][$color_id];
						$grand_short_fabric_total+=$short_finish_fabric_qnty_array[$po_id][$color_id];
						$grand_sample_fabric_total+=$sample_finish_fabric_qnty_array[$po_id][$color_id];
						$po_fabric_tot[$po_id]+=$result["finish_kg"];
						$po_grey_tot[$po_id]+=$result["grey_kg"];
						$po_main_fabric_total[$po_id]+=$main_finish_fabric_qnty_array[$po_id][$color_id];
						$po_short_fabric_total[$po_id]+=$short_finish_fabric_qnty_array[$po_id][$color_id];
						$po_sample_fabric_total[$po_id]+=$sample_finish_fabric_qnty_array[$po_id][$color_id];
						$color_wise_arr[$color_id]['finish_kg']+=$result["finish_kg"];
						$color_wise_arr[$color_id]['grey_kg']+=$result["grey_kg"];



						?>
						<td align="right"><?php echo number_format($result["finish_kg"],2); ?></td>
						<td align="right"><?php echo number_format($result["grey_kg"],2); ?></td>
						<td align="right"><?php echo number_format($result['process_loss']); ?></td>
						<td align="right"><?php echo number_format($main_finish_fabric_qnty_array[$po_id][$color_id],2);$po_main_tot+=$main_finish_fabric_qnty_array[$po_id][$color_id]; ?></td>
						<td align="right"><?php echo number_format($main_finish_fabric_qnty_array[$po_id][$color_id],2);$po_main_tot+=$main_finish_fabric_qnty_array[$po_id][$color_id] ?></td>
						<td align="right"><?php echo number_format($short_finish_fabric_qnty_array[$po_id][$color_id],2);$po_short_tot+=$short_finish_fabric_qnty_array[$po_id][$color_id]; ?></td>
						<td align="right"><?php echo number_format($sample_finish_fabric_qnty_array[$po_id][$color_id],2);$po_sample_tot+=$sample_finish_fabric_qnty_array[$po_id][$color_id]; ?></td>
						<td align="right"><?php echo number_format(($main_finish_fabric_qnty_array[$po_id][$color_id]+$short_finish_fabric_qnty_array[$po_id][$color_id]+$sample_finish_fabric_qnty_array[$po_id][$color_id]),2); ?></td>
						<td align="right"><?//php echo number_format($result["main_fab"],2); ?></td>
					</tr>
					<?
					 }
				  }?>

				<tr>
					<td align="right" colspan="3"><b>Po Wise Sub Total</b></td>                            	
					<td align="right"><strong><?=number_format($po_fabric_tot[$po_id],2)?></strong></td>                                
					<td align="right"><strong><?=number_format($po_grey_tot[$po_id],2)?></strong></td>
					<td></td>
					<td align="right"><strong><?=number_format($po_main_fabric_total[$po_id],2)?></strong></td>
					<td align="right"><strong><?=number_format($po_main_fabric_total[$po_id],2)?></strong></td>
					<td align="right"><strong><?=number_format($po_short_fabric_total[$po_id],2)?></strong></td>
					<td align="right"><strong><?=number_format($po_sample_fabric_total[$po_id],2)?></strong></td>
					<td align="right"><strong><?=number_format(($po_main_fabric_total[$po_id]+$po_short_fabric_total[$po_id]+$po_sample_fabric_total[$po_id]),2)?></strong></td>
					<td></td>
					
				</tr>
				<?

				}
				?>
				<tr>
					<td align="right" colspan="3"><b>Grand Total</b></td>                            	
					<td align="center"><strong><?=number_format($grand_fabric_total,2)?></strong></td>                                
					<td align="center"><strong><?=number_format($grand_grey_total,2)?></strong></td>
					<td></td>
					<td align="center"><strong><?=number_format($grand_main_fabric_total,2)?></strong></td>
					<td align="center"><strong><?=number_format($grand_main_fabric_total,2)?></strong></td>
					<td align="center"><strong><?=number_format($grand_short_fabric_total,2)?></strong></td>
					<td align="center"><strong><?=number_format($grand_sample_fabric_total,2)?></strong></td>
					<td align="center"><strong><?=number_format(($grand_main_fabric_total+$grand_short_fabric_total+$grand_sample_fabric_total),2)?></strong></td>
					<td></td>
				</tr>
			</table>
			<table  class="rpt_table"  style="float:left;margin-left:5px;" border="1" align="left" cellpadding="0"  cellspacing="0" rules="all" >
				<tr>
					<td colspan="4" align="center">Color wise Summary</td>                               
				</tr>
				<tr>
					<td>Sl</td>
					<td>Color Name</td>
					<td>Finish Fabric(kg)</td>
					<td>Grey Fabric(kg)</td>
				</tr>
				<?php
				$sl=1;
					foreach($color_wise_arr as $cid=> $val){
				?>
				<tr>
					<td width="30"><?=$sl;?></td>
					<td width="100"><?=$color_library[$cid];?></td>
					<td width="100" align="right"><?=number_format($val['finish_kg'],2);?></td>
					<td width="100" align="right"><?=number_format($val['grey_kg'],2);?></td>
				</tr>
				<?$sl++;
			
						$grand_fabric_tot+=$val['finish_kg'];
						$grand_grey_tot+=$val['grey_kg'];
			}?>
				<tr>
				  
					<td colspan="2">Total</td>
					<td align="right"><?=number_format($grand_fabric_tot,2);?></td>
					<td align="right"><?=number_format($grand_grey_tot,2);?></td>
				</tr>
			</table>
		</fieldset>
	</div>
	<br><br>
	<?
	echo signature_table(4, $cbo_company_name, "1330px");
	?>
    <p class=""></p>

    <?
	}
	$job_no_all= implode(",",array_unique($joball['job_no']));
	$style_sting_all=implode(",",array_unique($joball['style_ref_no']));

	echo "****".custom_file_name($txt_booking_no,$style_sting_all,$job_no_all);
	?>
	</div>
	<?
	exit();
}

if($action=="print_booking_4") //ISD-21-27844 4H
{
	extract($_REQUEST);
	$cbo_company_name=str_replace("'","",$cbo_company_name);
	$cbo_fabric_natu=str_replace("'","",$cbo_fabric_natu);
	$cbo_fabric_source=str_replace("'","",$cbo_fabric_source);

	$path=str_replace("'","",$path);
	if($path!="") $path=$path; else $path="../../";

	$imge_arr=return_library_array( "select master_tble_id,image_location from common_photo_library where form_name='company_details' or form_name='knit_order_entry' and file_type=1",'master_tble_id','image_location');
	$fabimge_arr=return_library_array( "select master_tble_id, image_location from common_photo_library where form_name='company_details' or form_name='fabric_color_img' and file_type=1",'master_tble_id','image_location');
	
	$color_library=return_library_array( "select id,color_name from lib_color ", "id", "color_name");
	//$marchentrArr = return_library_array("select id, team_member_name from lib_mkt_team_member_info  where status_active=1 and is_deleted=0","id","team_member_name");
	$teamArr =$marchentrArr=array();
	$teamSql = sql_select("select a.id, b.id as bid, a.team_name, a.team_leader_name, a.team_leader_email, a.user_tag_id, b.user_tag_id as user_id, b.team_member_name, b.team_member_email from lib_marketing_team a, lib_mkt_team_member_info b where a.id=b.team_id and a.status_active=1 and a.is_deleted=0 ");
	foreach($teamSql as $trow)
	{
		$teamArr[$trow[csf('id')]]['teamname']=$trow[csf('team_name')];
		$teamArr[$trow[csf('id')]]['team_leader_name']=$trow[csf('team_leader_name')];
		$teamArr[$trow[csf('id')]]['team_email']=$trow[csf('team_leader_email')];
		$marchentrArr[$trow[csf('bid')]]['team_member_name']=$trow[csf('team_member_name')];
		$marchentrArr[$trow[csf('bid')]]['team_member_email']=$trow[csf('team_member_email')];
		if($trow[csf('user_tag_id')]==$trow[csf('user_id')])
		{
			$teamArr[$trow[csf('id')]]['team_leader_email']=$trow[csf('team_member_email')];
		}
	}
	unset($teamSql);
	
	$buyer_name_arr=return_library_array( "select id, buyer_name from lib_buyer  where status_active=1 and is_deleted=0",'id','buyer_name');
	$nameArray_approved=sql_select( "select max(b.approved_no) as approved_no from wo_booking_mst a, approval_history b where a.id=b.mst_id and booking_no=$txt_booking_no and b.entry_form=7 and a.status_active =1 and a.is_deleted=0");
	list($nameArray_approved_row)=$nameArray_approved;

	$job_data_arr=array();
	$nameArray_buyer=sql_select( "select a.style_ref_no, a.style_description, a.job_no, a.buyer_name, a.team_leader, a.dealing_marchant, a.total_set_qnty, c.po_number from wo_po_details_master a, wo_booking_dtls b, wo_po_break_down c where a.job_no=b.job_no and a.id=c.job_id and b.po_break_down_id=c.id and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0 order by a.job_no ");
	$jobAll=$styleAll=$poAll="";
	foreach ($nameArray_buyer as $result_buy)
	{
		if($jobAll=="") $jobAll=$result_buy[csf('job_no')]; else $jobAll.=','.$result_buy[csf('job_no')];
		if($styleAll=="") $styleAll=$result_buy[csf('style_ref_no')]; else $styleAll.='**'.$result_buy[csf('style_ref_no')];
		if($poAll=="") $poAll=$result_buy[csf('po_number')]; else $poAll.='**'.$result_buy[csf('po_number')];
		
		$job_data_arr[$result_buy[csf('job_no')]]['style']=$result_buy[csf('style_ref_no')];
		$job_data_arr[$result_buy[csf('job_no')]]['job_no_in']="'".$result_buy[csf('job_no')]."'";
		$dealing_marchant.=$marchentrArr[$result_buy[csf('dealing_marchant')]]['team_member_name'].',';
		$team_name.=$teamArr[$result_buy[csf('team_leader')]]['teamname'].',';
		$team_email.=$teamArr[$result_buy[csf('team_leader')]]['team_email'].',';
		$team_leader_email.=$teamArr[$result_buy[csf('team_leader')]]['team_leader_email'].',';
		$team_leader.=$teamArr[$result_buy[csf('team_leader')]]['team_leader_name'].',';
		$team_member_email.=$marchentrArr[$result_buy[csf('dealing_marchant')]]['team_member_email'].',';
 	}
	unset($nameArray_buyer);
	
	$jobAll=implode(", ",array_unique(explode(",",$jobAll)));
	$styleAll=implode(", ",array_unique(explode("**",$styleAll)));
	$poAll=implode(", ",array_unique(explode("**",$poAll)));

  	//print_r($job_data_arr);
	$dealing_marchant=rtrim($dealing_marchant,',');
	$dealing_marchants=implode(",",array_unique(explode(",",$dealing_marchant)));
	
	$team_member_email=rtrim($team_member_email,',');
	$team_member_emails=implode(",",array_unique(explode(",",$team_member_email)));
	
	$team_name=rtrim($team_name,',');
	$team_names=implode(",",array_unique(explode(",",$team_name)));
	
	$team_email=rtrim($team_email,',');
	$team_emails=implode(",",array_unique(explode(",",$team_email)));
	
	$team_leader=rtrim($team_leader,',');
	$team_leaders=implode(",",array_unique(explode(",",$team_leader)));
	
	$team_leader_email=rtrim($team_leader_email,',');
	$team_leader_emails=implode(",",array_unique(explode(",",$team_leader_email)));
	
	$nameArray=sql_select( "select a.buyer_id, a.booking_date, a.supplier_id, a.ship_mode, a.delivery_date, a.fabric_source, a.remarks, a.pay_mode, a.attention, a.pay_term, a.tenor, a.is_approved, a.shippingmark_breck_down from wo_booking_mst a where a.booking_no=$txt_booking_no and a.status_active=1 and a.is_deleted=0");
	foreach ($nameArray as $result_job){
		$booking_date=$result_job[csf('booking_date')];
		$buyer_id=$result_job[csf('buyer_id')];
		$ship_mode=$result_job[csf('ship_mode')];
		$delivery_date=$result_job[csf('delivery_date')];
		$supplier_id=$result_job[csf('supplier_id')];
		$pay_mode=$result_job[csf('pay_mode')];
		$shippingmark_breck_down=$result_job[csf('shippingmark_breck_down')];
		$mstremarks=$result_job[csf('remarks')];
		$attention=$result_job[csf('attention')];
		$paytermTenor=$pay_term[$result_job[csf('pay_term')]].', '.$result_job[csf('tenor')].' Days';
		$is_approved=$result_job[csf('is_approved')];
	}
	unset($nameArray);
	//echo $booking_date.'ddd';
	
	$shippingmark_data=explode("~!~",$shippingmark_breck_down);
	$shippingmark_str="<b>".$shippingmark_data[0]."</b><br>".$shippingmark_data[1]."<br>".$shippingmark_data[2]."<br>".$shippingmark_data[3]."<br>".$shippingmark_data[4]."<br>".$shippingmark_data[5];
	
	$country_full_name = return_library_array("SELECT id,country_name from lib_country", "id", "country_name");
			
	$sqlCom="select company_name, email, website, plot_no, level_no, road_no, block_no, country_id, province, city, zip_code, contact_no from lib_company where id='$cbo_company_name' and status_active=1 and is_deleted=0";
	$sqlComRes=sql_select($sqlCom);
	$comName=$comAdd=$comPhone=$comPax=$comEmail=$comWeb=""; $consigneeDtls="";
	foreach( $sqlComRes as $row)
	{
		$comName=$row[csf("company_name")];
		
		if($row[csf("level_no")])		$level_no 	= $row[csf("level_no")].', ';
		if($row[csf("plot_no")])		$plot_no 	=$row[csf("plot_no")].', ';
		if($row[csf("road_no")]) 		$road_no 	=$row[csf("road_no")].', ';
		if($row[csf("block_no")]!='')	$block_no 	=$row[csf("block_no")].', ';
		if($row[csf("zip_code")]!='')	$zip_code 	= ' -'.$row[csf("zip_code")].' , ';
		if($row[csf("city")]!='') 		$city 		= ($zip_code!="")?$row[csf("city")]:$row[csf("city")]." ,";
		if($row[csf("country_id")]!='')	$country 	= $country_full_name[$row[csf("country_id")]].'.';
		
		$comAdd=$level_no.$plot_no.$road_no.$block_no.$city.$zip_code.$country;
		$comPhone=$row[csf("contact_no")];
		$comEmail=$row[csf("email")];
		$comWeb=$row[csf("website")];
	}
	$consigneeDtls="<b>Consignee:</b> <br>".$comName."<br>".$comAdd."<br>".$comPhone."<br>".$comPax."<br>".$comEmail."<br>".$comWeb;
	
	$beneficiaryDtls="";
	if($pay_mode==3 || $pay_mode==5)
	{
		$sqlSupp="select company_name, email, website, plot_no, level_no, road_no, block_no, country_id, province, city, zip_code, contact_no from lib_company where id='$supplier_id' and status_active=1 and is_deleted=0";
		$sqlSuppRes=sql_select($sqlSupp);
		$suppName=$suppAdd=$suppPhone=$suppPax=$suppEmail=$suppWeb="";
		foreach( $sqlSuppRes as $row)
		{
			$suppName=$row[csf("company_name")];
			
			if($row[csf("level_no")])		$level_no 	= $row[csf("level_no")].', ';
			if($row[csf("plot_no")])		$plot_no 	=$row[csf("plot_no")].', ';
			if($row[csf("road_no")]) 		$road_no 	=$row[csf("road_no")].', ';
			if($row[csf("block_no")]!='')	$block_no 	=$row[csf("block_no")].', ';
			if($row[csf("zip_code")]!='')	$zip_code 	= ' -'.$row[csf("zip_code")].' , ';
			if($row[csf("city")]!='') 		$city 		= ($zip_code!="")?$row[csf("city")]:$row[csf("city")]." ,";
			if($row[csf("country_id")]!='')	$country 	= $country_full_name[$row[csf("country_id")]].'.';
			
			$suppAdd=$level_no.$plot_no.$road_no.$block_no.$city.$zip_code.$country;
			$suppPhone=$row[csf("contact_no")];
			$suppEmail=$row[csf("email")];
			$suppWeb=$row[csf("website")];
		}
		$beneficiaryDtls="<b>Beneficiary:</b> <br>".$suppName."<br>".$suppAdd."<br>".$suppPhone."<br>".$suppPax."<br>".$suppEmail."<br>".$suppWeb;
	}
	else
	{
		$sqlSupp="select supplier_name, email, web_site, address_1, contact_no from lib_supplier where id='$supplier_id' and status_active=1 and is_deleted=0";
		$sqlSuppRes=sql_select($sqlSupp);
		$suppName=$suppAdd=$suppPhone=$suppPax=$suppEmail=$suppWeb="";
		$level_no=$plot_no=$road_no=$block_no=$city=$zip_code=$country="";
		foreach( $sqlSuppRes as $row)
		{
			$suppName=$row[csf("supplier_name")];
			$suppAdd=$row[csf("address_1")];
			$suppPhone=$row[csf("contact_no")];
			$suppEmail=$row[csf("email")];
			$suppWeb=$row[csf("web_site")];
		}
		$beneficiaryDtls="<b>Beneficiary:</b> <br>".$suppName."<br>".$suppAdd."<br>".$suppPhone."<br>".$suppPax."<br>".$suppEmail."<br>".$suppWeb;
	}

	?>
    <style>
	@media print
	{
	     .page-break { height:0; page-break-before:always; margin:0; border-top:none; }
	}
     body, p, span, td, a {font-size:10pt;font-family: Arial;}
     body{margin-left:2em; margin-right:2em; font-family: "Arial Narrow", Arial, sans-serif;}
	</style>
	<div style="width:930px" align="center">
        <table width="100%" cellpadding="0" cellspacing="0" style="border:0px solid black" >
            <tr>
                <td width="100">
                	<img src='<?=$path.$imge_arr[$cbo_company_name]; ?>' height='100%' width='100%' />
                </td>
                <td width="830">
                    <table width="100%" cellpadding="0" cellspacing="0"  border="0" >
                        <tr>
                            <td align="center" colspan="2" style="font-size:20px"><?=$comName; ?></td>
                        </tr>
                        <tr>
                            <td align="center" style="font-size:14px"><?=show_company($cbo_company_name,'',''); ?></td>  
                        </tr>
                        <tr>
                            <td align="center" colspan="2" style="font-size:16px">
                            	<span><b>Short Fabric <?=$fabric_source[$cbo_fabric_source]; ?> Order No:&nbsp;&nbsp;<?=trim($txt_booking_no,"'"); ?></span>
                                <span style="color:#FF0000"><?php if ($is_approved==1 || $is_approved==3) {echo "(Approved)";} ?></span>
                            </td>
                        </tr>
                    </table>
                </td>
            </tr>
            <tr>
            	<td width="930" colspan="2">
                	<table width="100%" cellpadding="0" cellspacing="0" border="1" rules="all" >
                        <tr>
                            <td width="50%" style="word-break:break-all"><?=$beneficiaryDtls; ?></td>
                            <td style="word-break:break-all"><?=$consigneeDtls; ?></td>
                        </tr>
                    </table>
                </td>
            </tr>
        </table>
	<div>
    <div style="width:930px" align="center">
        <table class="rpt_table" width="100%" border="1" cellpadding="0" cellspacing="0" rules="all" >
        	<thead>
            	<th width="60">Issue Date</th>
                <th width="60">Delivery Date</th>
                <th width="70">Fabric Source</th>
                <th width="60">Mode of Shipment </th>
                <th width="100">Pay Term & Tenor</th>
                <th width="70">Contact Person</th>
                <th width="90">Buyer</th>
                <th width="150">Job No</th>
                <th>Style</th>
            </thead>
            <tbody>
            	<tr>
                    <td align="center"><?=change_date_format($booking_date); ?></td>
                    <td align="center"><?=change_date_format($delivery_date); ?></td>
                    <td align="center" style="word-break:break-all"><?=$fabric_source[$cbo_fabric_source]; ?></td>
                    <td align="center" style="word-break:break-all"><?=$shipment_mode[$ship_mode]; ?></td>
                    <td align="center" style="word-break:break-all"><?=$paytermTenor; ?></td>
                    <td align="center" style="word-break:break-all"><?=$attention; ?></td>
                    <td style="word-break:break-all"><?=$buyer_name_arr[$buyer_id]; ?></td>
                    <td style="word-break:break-all"><?=$jobAll; ?></td>
                    <td style="word-break:break-all"><?=$styleAll; ?></td>
                </tr>
                <tr>
                	<td align="center">Order No</td>
                    <td style="word-break:break-all" colspan="8"><?=$poAll; ?></td>
                </tr>
            </tbody>
        </table>
	<div>
    <br>
    <?
	$sqlBookDtls="Select a.id, a.item_number_id, a.body_part_id, a.fabric_description, a.uom, a.gsm_weight, b.dia_width, a.color_type_id as color_type, b.gmts_color_id, b.fabric_color_id, b.fin_fab_qnty, b.rate, b.amount, b.remark from wo_pre_cost_fabric_cost_dtls a, wo_booking_dtls b where a.id=b.pre_cost_fabric_cost_dtls_id and b.booking_no=$txt_booking_no and b.status_active =1 and b.is_deleted=0";
	$sqlBookDtlsRes=sql_select($sqlBookDtls);
	$dtlsDataArr=array();
	foreach($sqlBookDtlsRes as $brow)
	{
		$img_ref=$brow[csf('id')].'_'.$brow[csf('fabric_color_id')];
		
		$dtlsDataArr[$brow[csf('item_number_id')]][$brow[csf('body_part_id')]][$brow[csf('fabric_description')]][$brow[csf('gsm_weight')]][$brow[csf('dia_width')]][$brow[csf('color_type')]][$brow[csf('gmts_color_id')]][$brow[csf('fabric_color_id')]][$brow[csf('uom')]]['finQty']+=$brow[csf('fin_fab_qnty')];
		$dtlsDataArr[$brow[csf('item_number_id')]][$brow[csf('body_part_id')]][$brow[csf('fabric_description')]][$brow[csf('gsm_weight')]][$brow[csf('dia_width')]][$brow[csf('color_type')]][$brow[csf('gmts_color_id')]][$brow[csf('fabric_color_id')]][$brow[csf('uom')]]['amt']+=$brow[csf('amount')];
		$dtlsDataArr[$brow[csf('item_number_id')]][$brow[csf('body_part_id')]][$brow[csf('fabric_description')]][$brow[csf('gsm_weight')]][$brow[csf('dia_width')]][$brow[csf('color_type')]][$brow[csf('gmts_color_id')]][$brow[csf('fabric_color_id')]][$brow[csf('uom')]]['remarks'].=$brow[csf('remark')]."__";
		$dtlsDataArr[$brow[csf('item_number_id')]][$brow[csf('body_part_id')]][$brow[csf('fabric_description')]][$brow[csf('gsm_weight')]][$brow[csf('dia_width')]][$brow[csf('color_type')]][$brow[csf('gmts_color_id')]][$brow[csf('fabric_color_id')]][$brow[csf('uom')]]['fabimg']=$img_ref;
	}
	unset($sqlBookDtlsRes);
	asort($dtlsDataArr);
	
	$fabspanArr=array();
	foreach($dtlsDataArr as $itemid=>$itemData)
	{
		foreach($itemData as $bodyid=>$bodyData)
		{
			foreach($bodyData as $fabric=>$fabricData)	
			{
				foreach($fabricData as $gsm=>$gsmData)
				{
					foreach($gsmData as $dia=>$diaData)
					{
						$fabspan=0;
						foreach($diaData as $colortyp=>$colortypData)
						{
							foreach($colortypData as $gmtcolor=>$gmtcolorData)
							{
								foreach($gmtcolorData as $fabcolor=>$fabcolorData)
								{
									foreach($fabcolorData as $uom=>$uomData)
									{
										$fabspan++;
									}
								}
							}
						}
						$fabspanArr[$itemid][$bodyid][$fabric][$gsm][$dia]=$fabspan;
					}
				}
			}
		}
	}
	/*echo "<pre>";
	print_r($fabspanArr);*/
	?>
    
    <div style="width:930px" align="center">
        <table class="rpt_table" width="100%" border="1" cellpadding="0" cellspacing="0" rules="all" >
        	<thead>
            	<th width="70">GMT Item Name</th>
                <th width="70">Body Part</th>
                <th width="130">Fab Description</th>
                <th width="40">GSM</th>
                <th width="40">Fab Dia</th>
                <th width="60">Color Type</th>
                <th width="80">Gmts Color</th>
                <th width="80">Fab Color</th>
                <th width="50">Fab Design IMG</th>
                
                <th width="60">Finish Fab Qty</th>
                <th width="50">UOM</th>
                <th width="50">Rate</th>
                <th width="70">Amount</th>
                <th>Reason</th>
            </thead>
            <tbody>
            <?
			foreach($dtlsDataArr as $itemid=>$itemData)
			{
				foreach($itemData as $bodyid=>$bodyData)
				{
					foreach($bodyData as $fabric=>$fabricData)	
					{
						foreach($fabricData as $gsm=>$gsmData)
						{
							foreach($gsmData as $dia=>$diaData)
							{
								$k=1; $finQtyTotal=0; $bookingAmtTotal=0;
								$fabrowspan=$fabspanArr[$itemid][$bodyid][$fabric][$gsm][$dia]+1;
								foreach($diaData as $colortyp=>$colortypData)
								{
									foreach($colortypData as $gmtcolor=>$gmtcolorData)
									{
										foreach($gmtcolorData as $fabcolor=>$fabcolorData)
										{
											foreach($fabcolorData as $uom=>$uomData)
											{
												
												$remarks=""; $avgRate=0;
												$remarks=implode(",",array_filter(array_unique(explode("__",$uomData['remarks']))));
												$avgRate=$uomData['amt']/$uomData['finQty'];
												?>
                                                <tr>
                                                    <?
                                                    if($k==1)
                                                    {
														?>
														<td style="word-break:break-all" rowspan="<?=$fabrowspan; ?>"><?=$garments_item[$itemid]; ?></td>
														<td style="word-break:break-all" rowspan="<?=$fabrowspan; ?>"><?=$body_part[$bodyid]; ?></td>
														<td style="word-break:break-all" rowspan="<?=$fabrowspan; ?>"><?=$fabric; ?></td>
														<td style="word-break:break-all" rowspan="<?=$fabrowspan; ?>" align="center"><?=$gsm; ?></td>
														<td style="word-break:break-all" rowspan="<?=$fabrowspan; ?>" align="center"><?=$dia; ?></td>
														<?
                                                    }
                                                    ?>
                                                    <td style="word-break:break-all"><?=$color_type[$colortyp]; ?></td>
                                                    <td style="word-break:break-all"><?=$color_library[$gmtcolor]; ?></td>
                                                    <td style="word-break:break-all"><?=$color_library[$fabcolor]; ?></td>
                                                    <td style="word-break:break-all" width="50"><img src='<?=$path.$fabimge_arr[$uomData['fabimg']]; ?>' height='100%' width='100%' /></td>
                                                    <td style="word-break:break-all" align="right"><?=number_format($uomData['finQty'],2); ?></td>
                                                    <td style="word-break:break-all"><?=$unit_of_measurement[$uom]; ?></td>
                                                    <td style="word-break:break-all" align="right"><?=number_format($avgRate,2); ?></td>
                                                    <td style="word-break:break-all" align="right"><?=number_format($uomData['amt'],2); ?></td>
                                                    <td style="word-break:break-all"><?=$remarks; ?></td>
                                                </tr>
                                                <?
												$k++;
												
												$finQtyTotal+=$uomData['finQty']; 
												$bookingAmtTotal+=$uomData['amt'];
												$gfinQty+=$uomData['finQty']; 
												$gbookingAmt+=$uomData['amt'];
											}
										}
									}
								}
								
								?>
                                	<tr style="background-color:#E3FDE6">
                                        <td style="word-break:break-all" colspan="4" align="right">Fabric Total : </td>
                                        <td style="word-break:break-all" align="right"><?=number_format($finQtyTotal,2); ?></td>
                                        <td style="word-break:break-all">&nbsp;</td>
                                        <td style="word-break:break-all" align="right">&nbsp;</td>
                                        <td style="word-break:break-all" align="right"><?=number_format($bookingAmtTotal,2); ?></td>
                                        <td style="word-break:break-all">&nbsp;</td>
                                    </tr>
                                <?
							}
						}
					}
				}
			}
			?>
            </tbody>
            <tfoot>
            	 <tr style="background-color:#CCC">
                    <td style="word-break:break-all" colspan="9" align="right">Grand Total : </td>
                    <td style="word-break:break-all" align="right"><?=number_format($gfinQty,2); ?></td>
                    <td style="word-break:break-all">&nbsp;</td>
                    <td style="word-break:break-all" align="right">&nbsp;</td>
                    <td style="word-break:break-all" align="right"><?=number_format($gbookingAmt,2); ?></td>
                    <td style="word-break:break-all">&nbsp;</td>
                </tr>
            </tfoot>
        </table>
	<div>
    <br>
    <div style="width:930"><?=get_spacial_instruction($txt_booking_no); ?></div>
    <br>
    <div style="width:930px" align="center">
        <table class="rpt_table" width="100%" border="1" cellpadding="0" cellspacing="0" rules="all" >
        	<thead>
            	<th width="300">Shipping Marks [One Side]</th>
                <th width="200" colspan="2">Shipping Marks [Other Side]</th>
                <th width="200" colspan="2">Order Issued By</th>
                <th>Special Instruction /Remarks</th>
            </thead>
            <tbody>
            	<tr>
                    <td style="word-break:break-all" rowspan="6"><?=$shippingmark_str; ?></td>
                    <td align="center">Customer Name :</td>
                    <td align="center"><?=$buyer_name_arr[$buyer_id]; ?></td>
                    <td align="center" style="word-break:break-all"><?=$team_names; ?></td>
                    <td align="center" style="word-break:break-all"><?=$team_emails; ?></td>
                    <td align="center" style="word-break:break-all" rowspan="6"><?=$mstremarks; ?></td>
                </tr>
                <tr>
                    <td align="center">Four H Order :</td>
                    <td align="center"><?=$txt_booking_no; ?></td>
                    <td align="center" style="word-break:break-all"><?=$team_leaders; ?></td>
                    <td align="center" style="word-break:break-all"><?=$team_leader_emails; ?></td>
                </tr>
                <tr>
                    <td align="center">Quantity :</td>
                    <td align="center"><?=number_format($gfinQty,2); ?></td>
                    <td align="center" style="word-break:break-all"><?=$dealing_marchants; ?></td>
                    <td align="center" style="word-break:break-all"><?=$team_member_emails; ?></td>
                </tr>
                <tr>
                    <td align="center">&nbsp;</td>
                    <td align="center">&nbsp;</td>
                    <td align="center" style="word-break:break-all">&nbsp;</td>
                    <td align="center" style="word-break:break-all">&nbsp;</td>
                </tr>
                <tr>
                    <td align="center">&nbsp;</td>
                    <td align="center">&nbsp;</td>
                    <td align="center" style="word-break:break-all">&nbsp;</td>
                    <td align="center" style="word-break:break-all">&nbsp;</td>
                </tr>
                <tr>
                    <td align="center">&nbsp;</td>

                    <td align="center">&nbsp;</td>
                    <td align="center" style="word-break:break-all">&nbsp;</td>
                    <td align="center" style="word-break:break-all">&nbsp;</td>
                </tr>
            </tbody>
        </table>
	<div>
    <?=signature_table(4, $cbo_company_name, "930px"); 
	exit();
}

if ($action=="load_drop_down_cause")
{
	$exdata=explode("_",$data);
	echo create_drop_down( "cbocauseid_".$exdata[1], 200, "select id, cause from booking_cause where cause_id='".$exdata[0]."' and status_active =1 and is_deleted=0 order by cause","id,cause", 1, "-- Select --", $selected, "" );
	exit();
}

if ($action=="short_booking_causes")
{
	echo load_html_head_contents("Short Booking Causes Info","../../../", 1, 1, $unicode);
	extract($_REQUEST);

	$responsible_unit="select b.id||'*'||a.id as id, a.company_name||' : '||b.location_name as location_name from lib_company a, lib_location b where a.id=b.company_id and b.status_active =1 and b.is_deleted=0 and a.status_active =1 and a.is_deleted=0 order by a.company_name";

	?>
	<script>
	var permission='<? echo $permission; ?>';

	function add_break_down_tr(i)
	{
		var row_num=$('#tbl_list_search tbody tr').length;
		if (row_num!=i)
		{
			return false;
		}
		else
		{
			i++;
			$("#tbl_list_search tr:last").clone().find("input,select").each(function() {
				$(this).attr({
					'id': function(_, id) { var id=id.split("_"); return id[0] +"_"+ i },
					'name': function(_, name) { return name + i },
					'value': function(_, value) { return value }
					});
				}).end().appendTo("#tbl_list_search");
			//
			$("#tbl_list_search tr:eq("+i+")").removeAttr('id').attr('id','tr_'+i);
			$("#tbl_list_search tr:eq("+i+")").find('td:first').html(i);
			$('#tbl_list_search tr:eq('+i+') td:eq(3)').attr('id','tdcause_'+i);
			//$('#tdsl_'+i).html(i);
			$('#cbocausetype_'+i).removeAttr("onChange").attr("onChange","load_drop_down( 'short_fabric_booking_controller',this.value+'_'+"+i+", 'load_drop_down_cause', 'tdcause_"+i+"');");
			
			$('#txtqty_'+i).removeAttr("onBlur").attr("onBlur","fnc_percent_calculate("+i+");");
			$('#txtproloss_'+i).removeAttr("onChange").attr("onChange","calculate_gray_qty("+i+");");
			$('#txtqty_'+i).removeAttr("onChange").attr("onChange","calculate_gray_qty("+i+");");
			$('#cbocausetype_'+i).val(0);
			$('#cbocauseid_'+i).val(0);
			$('#txtqty_'+i).val("");
			$('#txtproloss_'+i).val("");
			$('#txtgrayqty_'+i).val("");
			$('#txtpreqty_'+i).val("");
			$('#txtper_'+i).val("");
			$('#txtcauseDes_'+i).val("");
			$('#hidupid_'+i).val("");
			
			$('#increase_'+i).removeAttr("onClick").attr("onClick","add_break_down_tr("+i+");");
			$('#decrease_'+i).removeAttr("onClick").attr("onClick","fn_deletebreak_down_tr("+i+")");
			set_all_onclick();
			calculate_gray_qty(i);
			//alert(i);
		}
	}

	function fn_deletebreak_down_tr(rowNo)
	{
		
		var numRow = $('table#tbl_list_search tbody tr').length;
		if(rowNo!=1)
		{
			var permission_array=permission.split("_");
			var rowid=$('#tr_'+rowNo).val();
			/*if(rowid !="" && permission_array[2]==1)
			{
				var booking=return_global_ajax_value(rowid, 'delete_row', '', 'short_fabric_booking_controller');
			}*/
			var index=rowNo-1
			$('#tbl_list_search tbody tr:eq('+index+')').remove();
			var numRow = $('table#tbl_list_search tbody tr').length;
			for(i = rowNo;i <= numRow;i++)
			{
				/* $("#tbl_list_search tr:eq("+i+")").find("input,select").each(function() {
					$(this).attr({
						'id': function(_, id) { var id=id.split("_"); return id[0] +"_"+ i },
						//'name': function(_, name) { var name=name.split("_"); return name[0] +"_"+ i},
						'value': function(_, value) { return value }
					});
				})
				$("#tbl_list_search tr:eq("+i+")").removeAttr('id').attr('id','tr_'+i);
				$("#tbl_list_search tr:eq("+i+")").find('td:first').html(i);
				$('#tbl_list_search tr:eq('+i+') td:eq(2)').attr('id','tdcause_'+i); */
				//$('#tdsl_'+i).html(i);
				//$('#cbocausetype_'+i).removeAttr("onChange").attr("onChange","load_drop_down( 'short_fabric_booking_controller',this.value+'_'+"+i+", 'load_drop_down_cause', 'tdcause_"+i+"');");
				
				//$('#txtqty_'+i).removeAttr("onKeyUp").attr("onKeyUp","calculate_gray_qty("+i+");");
				//$('#txtqty_'+i).removeAttr("onBlur").attr("onBlur","fnc_percent_calculate("+i+");");
				//$('#increase_'+i).removeAttr("onClick").attr("onClick","add_break_down_tr("+i+");");
				//$('#decrease_'+i).removeAttr("onClick").attr("onClick","fn_deletebreak_down_tr("+i+")");
				//set_all_onclick();
				
				
			}
			//alert(i);
				calculate_gray_qty(i);

		}
	}
	
	function fnc_percent_calculate(i)
	{
		var finish_qnty=$('#hid_finish_qnty').val()*1;
		var grey_qnty=$('#hid_grey_qnty').val()*1;
		var qty=$('#txtqty_'+i).val()*1;
		
		var per=(qty/finish_qnty)*100;
		$('#txtper_'+i).val( number_format(per,4,'.','' ) );
		var q=i;
		var row_num = $('table#tbl_list_search tbody tr').length;
		var tot_qty=0;
		for (var i=1; i<=row_num; i++)
		{
			tot_qty+=$('#txtqty_'+i).val()*1;
		}
		
		if(tot_qty>finish_qnty)
		{
			alert("Cause Finish Qty (Kg) is over Then Actual Finish Fabric Qty.\n Total Cause Finish Qty (Kg)"+tot_qty+".\n Actual Finish Fabric Qty"+finish_qnty);
			$('#txtqty_'+q).val('');
			$('#txtproloss_'+q).val('');
			$('#txtgrayqty_'+q).val('');
			$('#txtper_'+q).val('');
			return;
		}
	}

	function calculate_gray_qty(i) {
		var txt_finish_qnty = $('#txtqty_'+i).val()*1;
		var txt_grey_qnty = $('#txtgrayqty_'+i).val()*1;
		var processloss = $('#txtproloss_'+i).val()*1;
		var WastageQty=0;var PreviousQty=0;
		WastageQty=txt_finish_qnty+txt_finish_qnty*(processloss/100);
		PreviousQty=txt_finish_qnty;
		$('#txtgrayqty_'+i).val( number_format(WastageQty,4,'.','' ) );
		//$('#txtpreqty_'+i).val( number_format(PreviousQty) );
		var numRow = $('table#tbl_list_search tbody tr').length;
		//var row_num = $('table#tbl_list_search tbody tr').length;
		var totQnty=0;
		var totGreyQnty=0;
		for(var r = 1;r <= numRow;r++)//issue id--10264
		{
			totQnty+=$('#txtqty_'+r).val()*1;
			//alert(r+'='+$('#txtqty_'+r).val()*1);
			totGreyQnty+=$('#txtgrayqty_'+r).val()*1;
			//console.log(`totGreyQnty=${$('#txtgrayqty_'+r).val()*1}`);
		}
		$("#hid_finish_qnty").val(totQnty);
		$("#hid_grey_qnty").val(totGreyQnty);
		//console.log(`hid_grey_qnty=${$('#hid_grey_qnty').val()*1}`);
	}

	function fnc_causes_info( operation )
	{
		var row_num = $('table#tbl_list_search tbody tr').length;
		var data_all='&txt_booking_no='+document.getElementById('txt_booking_no').value+'&hid_dtls_id='+document.getElementById('hid_dtls_id').value;
		for (var i=1; i<=row_num; i++)
		{
			if (form_validation('cboResUnit_'+i+'*cbocausetype_'+i+'*cbocauseid_'+i+'*txtqty_'+i,'Responsible Unit*Cause Type*Causes*Finish Qty (Kg)')==false)
			{
				return;
			}
			data_all=data_all+get_submitted_data_string('cboResUnit_'+i+'*cbocausetype_'+i+'*cbocauseid_'+i+'*txtqty_'+i+'*txtper_'+i+'*txtcauseDes_'+i+'*hidupid_'+i+'*txtproloss_'+i+'*txtgrayqty_'+i+'*txtpreqty_'+i,"../../../",i);
		}
		var data="action=save_update_delete_cause&operation="+operation+'&total_row='+row_num+data_all;
		
		//alert(data);
		//return;
		freeze_window(operation);
		http.open("POST","short_fabric_booking_controller.php",true);
		http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
		http.send(data);
		http.onreadystatechange = fnc_cause_info_reponse;
	}

	function fnc_cause_info_reponse()
	{
		if(http.readyState == 4)
		{
			var reponse=trim(http.responseText).split('**');
			if (reponse[0].length>2) reponse[0]=10;
			release_freezing();
			if(reponse[0]==0 || reponse[0]==1 || reponse[0]==2)
			{
				parent.emailwindow.hide();
			}
		}
	}
	</script>
	</head>
	<body>
	<div align="center">
		<div style="display:none"><? echo load_freeze_divs ("../../../",$permission); ?></div>
        <fieldset style="width:1040px">
        <form id="causesinfo_1" autocomplete="off">
            <table width="1040" cellspacing="0" cellpadding="0" border="1" rules="all" class="rpt_table" id="tbl_list_search">
                <thead>
                	<th width="30">SL</th>
                    <th width="100" class="must_entry_caption">Responsible Unit</th>
                    <th width="100" class="must_entry_caption">Cause Depertment</th>
                    <th width="200" class="must_entry_caption">Causes</th>
					<th width="100" class="must_entry_caption">Cause Description</th>
					<th width="80">Demand</th>		
					<th width="80" class="must_entry_caption">Finish Qty (Kg)</th>					
					<th width="80">Process Loss</th>
					<th width="80">Gray Qty</th>                    
                    <th width="80">Weight %</th>
                    <th>&nbsp;</th>
                </thead>
                <tbody>
					<?
					$short_booking_cause_arr = array(1=>"Merchandising",3=>"Yarn",4=>"Knitting",6=>"Dyeing and Finishing",11=>"AOP",23=>"Printing",24=>"Cutting",26=>"Sewing",27=>"Garments Finishing",28=>"Store",29=>"Washing");
                    $data_array=sql_select("SELECT id, res_company, res_location, cause_id, cause,previous_qty, qty, percent,cause_description, process_loss, gray_qty from wo_booking_short_cause where booking_no='$txt_booking_no' and dtls_id='$dtls_id' and entry_form=88 and status_active=1 and is_deleted=0 order by id ASC");   
                    if(count($data_array)>0)
                    {
						$i=1;
						foreach( $data_array as $row)
						{
							$res_unit=0;
							$res_unit=$row[csf("res_location")].'*'.$row[csf("res_company")];
							?>
                            <tr id="tr_<? echo $i;?>">
                                <td><? echo $i;?></td>
                                <td><? echo create_drop_down( "cboResUnit_".$i, 100, $responsible_unit,"id,location_name", 1, "-Responsible Unit-", $res_unit, "" ); ?></td>
                                <td><? echo create_drop_down( "cbocausetype_".$i, 100, $short_booking_cause_arr,"", 1, "-- Select --", $row[csf("cause_id")], "load_drop_down( 'short_fabric_booking_controller',this.value+'_'+".$i.", 'load_drop_down_cause', 'tdcause_".$i."');",0 ); ?></td>
                                <td id="tdcause_<? echo $i;?>"><? echo create_drop_down( "cbocauseid_".$i, 200, "select id, cause from booking_cause where cause_id='".$row[csf("cause_id")]."' and status_active =1 and is_deleted=0 order by cause","id,cause", 1, "-- Select --", $row[csf("cause")], "" ); ?></td>
								<td>
									<input type="text" id="txtcauseDes_<? echo $i;?>" name="txtcauseDes_<? echo $i;?>" class="text_boxes" style="width:90px;" value="<? echo $row[csf("cause_description")]; ?>" />
								</td>
								<td>
									<input type="text" id="txtpreqty_<? echo $i;?>" name="txtpreqty_<? echo $i;?>" class="text_boxes_numeric" style="width:70px;" value="<? if($row[csf("previous_qty")]==0){echo $row[csf("qty")];}else{ $row[csf("previous_qty")];}  ?>" disabled/>
								</td>
                                <td>
									<input type="text" id="txtqty_<? echo $i;?>" name="txtqty_<? echo $i;?>" class="text_boxes_numeric" style="width:70px;"  onBlur="fnc_percent_calculate(<? echo $i;?>);" onKeyUp="calculate_gray_qty(<? echo $i;?>)" value="<? echo $row[csf("qty")]; ?>"/>
								</td>
								<td>
									<input type="text" id="txtproloss_<? echo $i;?>" name="txtproloss_<? echo $i;?>" class="text_boxes_numeric" style="width:70px;" value="<? echo $row[csf("process_loss")]; ?>" onKeyUp="calculate_gray_qty(<? echo $i;?>)" />
								</td>
								<td>
									<input type="text" id="txtgrayqty_<? echo $i;?>" name="txtgrayqty_<? echo $i;?>" class="text_boxes_numeric" style="width:70px;" value="<? echo $row[csf("gray_qty")]; ?>" disabled/>
								</td>
                                <td><input type="text" id="txtper_<? echo $i;?>" name="txtper_<? echo $i;?>" class="text_boxes_numeric" style="width:70px;" value="<? echo $row[csf("percent")]; ?>" readonly/></td>
                                <td>
                                    <input type="button" id="increase_<? echo $i;?>" name="increase_<? echo $i;?>" style="width:20px" class="formbutton" value="+" onClick="add_break_down_tr(<? echo $i;?>)" />
                                    <input type="button" id="decrease_<? echo $i;?>" name="decrease_<? echo $i;?>" style="width:20px" class="formbutton" value="-" onClick="fn_deletebreak_down_tr(<? echo $i;?>);" />
                                    <input type="hidden" id="hidupid_<? echo $i;?>" value="<? echo $row[csf("id")]; ?>" />
                                </td>
                            </tr>
							<?
							$i++;
						}
                    }
                    else
                    {
						?>
						<tr id="tr_1">
                        	<td>1</td>
                            <td><? echo create_drop_down( "cboResUnit_1", 100, $responsible_unit,"id,location_name", 1, "-Responsible Unit-", $selected, "" ); ?></td>
							<td><? echo create_drop_down( "cbocausetype_1", 100, $short_booking_cause_arr,"", 1, "-- Select --", "", "load_drop_down( 'short_fabric_booking_controller',this.value+'_'+1, 'load_drop_down_cause', 'tdcause_1');",0 ); ?></td>
							<td id="tdcause_1"><? echo create_drop_down( "cbocauseid_1", 200, $blank_array,"", 1, "-- Select --", "", "",0 ); ?></td>
							<td>
							<input type="text" id="txtcauseDes_1" name="txtcauseDes_1" class="text_boxes" style="width:70px;" value="" /></td>
							<td><input type="text" id="txtpreqty_1" name="txtpreqty_1" class="text_boxes_numeric" style="width:70px;" value="" disabled /></td>
							<td><input type="text" id="txtqty_1" name="txtqty_1" class="text_boxes_numeric" style="width:70px;" onBlur="fnc_percent_calculate(1);" onKeyUp="calculate_gray_qty(1)"/></td>
							<td><input type="text" id="txtproloss_1" name="txtproloss_1" class="text_boxes_numeric" style="width:70px;" value="" onKeyUp="calculate_gray_qty(1)"/></td>
							<td><input type="text" id="txtgrayqty_1" name="txtgrayqty_1" class="text_boxes_numeric" style="width:70px;" value="" disabled/></td>
                            <td><input type="text" id="txtper_1" name="txtper_1" class="text_boxes_numeric" style="width:70px;" readonly/></td>
							<td>
								<input type="button" id="increase_1" name="increase_1" style="width:20px" class="formbutton" value="+" onClick="add_break_down_tr(1)" />
								<input type="button" id="decrease_1" name="decrease_1" style="width:20px" class="formbutton" value="-" onClick="fn_deletebreak_down_tr(1);" />
                                <input type="hidden" id="hidupid_1" value="" />
							</td>
						</tr>
						<?
                    }
                    ?>
                </tbody>
            </table>
            <div align="center" style="margin-top:10px">
            <?
            if(count($data_array)>0)
            {
            	echo load_submit_buttons( $permission, "fnc_causes_info", 1,0 ,"reset_form('causesinfo_1','','','','')",1) ;
            }
            else
            {
            	echo load_submit_buttons( $permission, "fnc_causes_info", 0,0 ,"reset_form('causesinfo_1','','','','')",1) ;
            }
            ?>
            <input type="hidden" id="hid_finish_qnty" value="<? echo $finish_qnty; ?>" />
			<input type="hidden" id="hid_grey_qnty" value="<? echo $grey_qnty; ?>" />
            <input type="hidden" id="hid_dtls_id" value="<? echo $dtls_id; ?>" />
            <input type="hidden" id="txt_booking_no" value="<? echo $txt_booking_no; ?>" />
           
            </div>
        </form>
        </fieldset>
	</div>
	<script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
	</body>
	</html>
	<?
	exit();
}

if($action=="save_update_delete_cause")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));

	if ($operation==0)  // Insert Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		//if( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0"; die;}
		$id=return_next_id( "id", "wo_booking_short_cause", 1 ) ;
		$field_array="id, booking_no, dtls_id, res_company, res_location, cause_id, cause, qty, previous_qty,process_loss, gray_qty, percent,cause_description, entry_form, inserted_by, insert_date, status_active, is_deleted";
		for ($i=1;$i<=$total_row;$i++)
		{
			$cboResUnit="cboResUnit_".$i;
			$cbocausetype="cbocausetype_".$i;
			$cbocauseid="cbocauseid_".$i;
			$txtqty="txtqty_".$i;
			$txtpreqty="txtpreqty_".$i;
			$txtproloss="txtproloss_".$i;
			$txtgrayqty="txtgrayqty_".$i;
			$txtper="txtper_".$i;
			$txtcauseDes="txtcauseDes_".$i;
			
			$hidupid="hidupid_".$i;
			
			$res_company =$res_location =0;
			if(str_replace("'","",$$cboResUnit)!=0)
			{
				$cboResUnit = explode("*",str_replace("'","",$$cboResUnit));
				$res_company = $cboResUnit[1];
				$res_location = $cboResUnit[0];
			}

			if ($i!=1) $data_array .=",";
			$data_array .="(".$id.",'".$txt_booking_no."','".$hid_dtls_id."','".$res_company."','".$res_location."',".$$cbocausetype.",".$$cbocauseid.",".$$txtqty.",".$$txtpreqty.",".$$txtproloss.",".$$txtgrayqty.",".$$txtper.",".$$txtcauseDes.",88,".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
			$id=$id+1;
		}
		$rID=sql_insert("wo_booking_short_cause",$field_array,$data_array,0);
		//check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID==1){
				mysql_query("COMMIT");
				echo "0";
			}
			else{
				mysql_query("ROLLBACK");
				echo "10";
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID==1){
				oci_commit($con);
				echo "0";
			}
			else{
				oci_rollback($con);
				echo "10";
			}
		}
		disconnect($con);
		die;
	}
	else if ($operation==1)  // Update Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		//if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0"; die;}
		
		$sql="select id from wo_booking_short_cause where booking_no='".$txt_booking_no."' and dtls_id='".$hid_dtls_id."' and entry_form=88 and status_active=1 and is_deleted=0";
		$sql_res=sql_select($sql); $dtls_update_id_arr=array();
		foreach( $sql_res as $row)
		{
			$dtls_update_id_arr[]=$row[csf('id')];
		}
		unset($sql_res);
		$add_comma=0;
		$id=return_next_id( "id", "wo_booking_short_cause", 1) ;
		$field_array="id, booking_no, dtls_id, res_company, res_location, cause_id, cause, qty,previous_qty,process_loss,gray_qty, percent,cause_description, entry_form, inserted_by, insert_date, status_active, is_deleted";
		$field_array_up="res_company*res_location*cause_id*cause*qty*previous_qty*process_loss*gray_qty*percent*cause_description*updated_by*update_date";
		for ($i=1;$i<=$total_row;$i++)
		{
			$cboResUnit="cboResUnit_".$i;
			$cbocausetype="cbocausetype_".$i;
			$cbocauseid="cbocauseid_".$i;
			$txtqty="txtqty_".$i;
			$txtpreqty="txtpreqty_".$i;
			$txtproloss="txtproloss_".$i;
			$txtgrayqty="txtgrayqty_".$i;
			$txtper="txtper_".$i;
			$txtcauseDes="txtcauseDes_".$i;
			
			$hidupid="hidupid_".$i;
			
			$res_company =$res_location =0;
			if(str_replace("'","",$$cboResUnit)!=0)
			{
				$cboResUnit = explode("*",str_replace("'","",$$cboResUnit));
				$res_company = $cboResUnit[1];
				$res_location = $cboResUnit[0];
			}
			
			if(str_replace("'",'',$$hidupid)!="")
			{
				$id_arr[]=str_replace("'",'',$$hidupid);
				$data_array_up[str_replace("'",'',$$hidupid)] =explode("*",("'".$res_company."'*'".$res_location."'*".$$cbocausetype."*".$$cbocauseid."*".$$txtqty."*".$$txtpreqty."*".$$txtproloss."*".$$txtgrayqty."*".$$txtper."*".$$txtcauseDes."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'"));
			}
			if(str_replace("'",'',$$hidupid)=="")
			{
				if ($add_comma!=0) $data_array .=",";
				$data_array .="(".$id.",'".$txt_booking_no."','".$hid_dtls_id."','".$res_company."','".$res_location."',".$$cbocausetype.",".$$cbocauseid.",".$$txtqty.",".$$txtpreqty.",".$$txtproloss.",".$$txtgrayqty.",".$$txtper.",".$$txtcauseDes.",88,".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
				$add_comma++;
				$id=$id+1;
			}
		}
		 //echo bulk_update_sql_statement( "wo_booking_short_cause", "id", $field_array_up, $data_array_up, $id_arr );die;
		//echo "10**";
		$nodeleted_ids=array_diff($dtls_update_id_arr,$id_arr);
		//echo $nodeleted_ids; die;
		$flag=1;
		$rID=execute_query(bulk_update_sql_statement( "wo_booking_short_cause", "id", $field_array_up, $data_array_up, $id_arr ));
		if($rID==1 && $flag==1) $flag=1; else $flag=0;
		if($data_array !="")
		{
			$rID1=sql_insert("wo_booking_short_cause",$field_array,$data_array,1);
			if($rID1==1 && $flag==1) $flag=1; else $flag=0;
		}
		
		foreach($nodeleted_ids as $dids)
		{
			$dsql="UPDATE wo_booking_short_cause SET status_active =0, is_deleted =1, updated_by ='".$_SESSION['logic_erp']['user_id']."', update_date ='".$pc_date_time."' where id in ($dids) and entry_form=88 and status_active =1 and is_deleted =0";
			$rID2=execute_query($dsql);
			if($rID2==1 && $flag==1) $flag=1; else $flag=0;
		}
		//echo $rID.'='.$rID1.'='.$rID2.'='.$flag; die;
		//check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($flag==1){
				mysql_query("COMMIT");
				echo "1";
			}
			else{
				mysql_query("ROLLBACK");
				echo "10";
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($flag==1){
				oci_commit($con);
				echo "1";
			}
			else{
				oci_rollback($con);
				echo "10";
			}
		}
		disconnect($con);
		die;
	}
	else if ($operation==2)  // Insert Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}

		//if  ( check_table_status( $_SESSION['menu_id'], 1 )==0 ) { echo "15**0"; die;}

		$field_array_up="status_active*is_deleted*updated_by*update_date";
		for ($i=1;$i<=$total_row;$i++)
		{
			$cbocausetype="cbocausetype_".$i;
			$cbocauseid="cbocauseid_".$i;
			$txtqty="txtqty_".$i;
			$txtper="txtper_".$i;
			$txtcauseDes="txtcauseDes_".$i;
			
			$hidupid="hidupid_".$i;
			if(str_replace("'",'',$$hidupid)!="")
			{
				$id_arr[]=str_replace("'",'',$$hidupid);
				$data_array_up[str_replace("'",'',$$hidupid)] =explode("*",("0*1*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'"));
			}
		}
		// echo bulk_update_sql_statement( "wo_po_acc_po_info", "id", $field_array_up, $data_array_up, $id_arr );
		$rID=execute_query(bulk_update_sql_statement( "wo_booking_short_cause", "id", $field_array_up, $data_array_up, $id_arr ));
		//check_table_status( $_SESSION['menu_id'],0);
		if($db_type==0)
		{
			if($rID==1){
				mysql_query("COMMIT");
				echo "2";
			}
			else{
				mysql_query("ROLLBACK");
				echo "10";
			}
		}
		else if($db_type==2 || $db_type==1 )
		{
			if($rID==1){
				oci_commit($con);
				echo "2";
			}
			else{
				oci_rollback($con);
				echo "10";
			}
		}
		disconnect($con);
		die;
	}
}

if ($action=="refusing_cause_popup")
{
	$menu_id=$_SESSION['menu_id'];
	$user_id=$_SESSION['logic_erp']['user_id'];

	echo load_html_head_contents("Un Approval Request","../../../", 1, 1, $unicode);
	extract($_REQUEST);

	$data_all=explode('_',$data);
	$booking_no=$data_all[0];
	$unapp_request=$data_all[1];

	$wo_id=return_field_value("id", "wo_booking_mst", "booking_no='$booking_no' and status_active=1 and is_deleted=0");

	//echo "SELECT refusing_reason from refusing_cause_history where mst_id='".$wo_id."'  and entry_form=12";
	//$refusing_reason=return_field_value("refusing_reason", "refusing_cause_history", "mst_id='".$wo_id."'  and entry_form=12");

	$sql_cause="select approval_cause from fabric_booking_approval_cause where page_id='413' and entry_form=12 and user_id='$user_id' and booking_id='$wo_id'  and status_active=1 and is_deleted=0 and approval_type='1' ";
	//echo $sql_cause;				
	$nameArray_cause=sql_select($sql_cause);
	$refusing_reason='';
	foreach($nameArray_cause as $row)
	{
		if(!empty($refusing_reason))
		{
			$refusing_reason.=",".$row[csf("approval_cause")];
		}
		else $refusing_reason=$row[csf("approval_cause")];
	}
	
		
	?>
    <script type="text/javascript">
    	function fnc_close()
		{
			unappv_request= $("#unappv_request").val();

			document.getElementById('hidden_appv_cause').value=unappv_request;

			parent.emailwindow.hide();
		}
    </script>
    <body>
		<div align="center" style="width:100%;">
        <? echo load_freeze_divs ("../../",$permission,1); ?>
        <form name="size_1" id="size_1">
			<fieldset style="width:450px;">
            <table align="center" cellspacing="0" width="450" class="rpt_table" border="1" rules="all" id="size_tbl" >
                <tr id="row_1">
                    <td width="150" align="center" >
                    	<textarea name="unappv_request" id="unappv_request" class="text_area" style="width:430px; height:100px;" maxlength="500" title="Maximum 500 Character" readonly><?=$refusing_reason?></textarea>
                        <input type="hidden" name="hidden_appv_cause" id="hidden_appv_cause" class="text_boxes /">
                    </td>
                </tr>
            </table>
            <table align="center" cellspacing="0" width="450" class="rpt_table" border="1" rules="all" id="" >
                <tr>
                    <td align="center">
                        <input type="button" name="close" class="formbutton" value="Close" id="main_close" onClick="fnc_close();" style="width:100px" />
                    </td>
                </tr>
            </table>
            </fieldset>
            </form>
        </div>
        <?
			$sqlHis="select approval_cause from approval_cause_refusing_his where entry_form=12 and booking_id='$wo_id' and approval_type='1' and status_active=1 and is_deleted=0 order by id Desc";
			$sqlHisRes=sql_select($sqlHis);
		?>
		<table align="center" cellspacing="0" width="420" class="rpt_table" border="1" rules="all">
			<thead>
				<th width="30">SL</th>
				<th>Refusing History</th>
			</thead>
		</table>
		<div style="width:420px; overflow-y:scroll; max-height:260px;" align="center">
			<table align="center" cellspacing="0" width="403" class="rpt_table" border="1" rules="all">
			<?
			$i=1;
			foreach($sqlHisRes as $hrow)
			{
				if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
				?>
				<tr bgcolor="<?=$bgcolor; ?>" onClick="change_color('tr_<?=$i; ?>','<?=$bgcolor; ?>');">
					<td width="30"><?=$i; ?></td>
					<td style="word-break:break-all"><?=$hrow[csf('approval_cause')]; ?></td>
				</tr>
				<?
				$i++;
			}
			?>
			</table>
		</div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
	exit();
}

if ($action=="unapp_request_popup")
{
	$menu_id=$_SESSION['menu_id'];
	$user_id=$_SESSION['logic_erp']['user_id'];

	echo load_html_head_contents("Un Approval Request","../../../", 1, 1, $unicode);
	extract($_REQUEST);
	$permission="1_1_1_1";

	$data_all=explode('_',$data);
	$booking_no=$data_all[0];
	$unapp_request=$data_all[1];

	$wo_id=return_field_value("id", "wo_booking_mst", "booking_no='$booking_no' and status_active=1 and is_deleted=0");

	$sql_req="select approval_cause from fabric_booking_approval_cause where entry_form=12 and booking_id='$wo_id' and approval_type=2 and status_active=1 and is_deleted=0";
	//echo $sql_req;				
	$nameArray_req=sql_select($sql_req);
	foreach($nameArray_req as $row)
	{
		$unappv_req=$row[csf('approval_cause')];
	}
	$unappv_req=str_replace(array("&", "*", "(", ")", "=","'","_","\r", "\n",'"','#'), "", $unappv_req);
	
	$un_sql_request="select MAX(id) as id,max(approval_no) as approved_no from fabric_booking_approval_cause where entry_form=12  and booking_id=".$wo_id." and approval_type=2 and status_active=1 and is_deleted=0";// page_id='$menu_id'
		//echo $sql_request;
		$nameArray_un_request=sql_select($un_sql_request);
		$cause_approved_no='';
		foreach($nameArray_un_request as $approw)
		{
			 
			$cause_approved_no=$approw[csf("approved_no")];
			 
		}
		
		$max_approved_no=return_field_value("max(approved_no) as max_approved_no", "approval_history", "mst_id='".$wo_id."'  and entry_form=12","max_approved_no");
		
		  
		if(count($nameArray_req)>0 && $max_approved_no!=$cause_approved_no)
		{ 
			$unappv_req='';$button_chk=0;
		}
		else { $unappv_req=$unappv_req;$button_chk=1;}
			
	?>
    <script>

		$( document ).ready(function() {
			//document.getElementById("unappv_request").value='<? echo preg_replace('/[\r\n]+/','\n',$unapp_request); ?>';
		});

		var permission='<? echo $permission; ?>';

		function fnc_appv_entry(operation)
		{
			var unappv_request = $('#unappv_request').val();

			if (form_validation('unappv_request','Un Approval Request')==false)
			{
				if (unappv_request=='')
				{
					alert("Please write request.");
				}
				return;
			}
			else
			{

				var data="action=save_update_delete_unappv_request&operation="+operation+get_submitted_data_string('unappv_request*wo_id*page_id*user_id',"../../../");
				//alert (data);return;
				freeze_window(operation);
				http.open("POST","short_fabric_booking_controller.php",true);
				http.setRequestHeader("Content-type","application/x-www-form-urlencoded");
				http.send(data);
				http.onreadystatechange=fnc_appv_entry_Reply_info;
			}
		}

		function fnc_appv_entry_Reply_info()
		{
			if(http.readyState == 4)
			{
				// alert(http.responseText);//return;
				var reponse=trim(http.responseText).split('**');
				show_msg(reponse[0]);

				set_button_status(1, permission, 'fnc_appv_entry',1);
				document.getElementById('hidden_appv_cause').value=reponse[3];
				parent.emailwindow.hide();
				
				release_freezing();

				//generate_worder_mail(reponse[2],reponse[3],reponse[4],reponse[5]);
			}
		}

		function fnc_close()
		{
			unappv_request= $("#unappv_request").val();

			document.getElementById('hidden_appv_cause').value=unappv_request;

			parent.emailwindow.hide();
		}

    </script>
    <body>
		<div align="center" style="width:100%;">
        <? echo load_freeze_divs ("../../",$permission,1); ?>
        <form name="size_1" id="size_1">
			<fieldset style="width:450px;">
            <table align="center" cellspacing="0" width="450" class="rpt_table" border="1" rules="all" id="size_tbl" >
                <tr id="row_1">
                    <td width="150" align="center" >
                    	<textarea name="unappv_request" id="unappv_request" class="text_area" style="width:430px; height:100px;" maxlength="500" title="Maximum 500 Character"><?=$unappv_req;?></textarea>
                        <Input type="hidden" name="wo_id" class="text_boxes" ID="wo_id" value="<? echo $wo_id; ?>" style="width:30px" />
                        <Input type="hidden" name="page_id" class="text_boxes" ID="page_id" value="<? echo $menu_id; ?>" style="width:30px" />
                        <Input type="hidden" name="user_id" class="text_boxes" ID="user_id" value="<? echo $user_id; ?>" style="width:30px" />
                    </td>
                </tr>
            </table>

            <table align="center" cellspacing="0" width="450" class="rpt_table" border="1" rules="all" id="" >

                <tr>
                    <td align="center" class="button_container">
                        <?
						//print_r ($id_up_all);
                            if(count($nameArray_req)>0 && $button_chk==1)
                            {
                                echo load_submit_buttons($permission, "fnc_appv_entry", 1,0,"reset_form('size_1','','','','','');",1);
                            }
                            else
                            {
                                echo load_submit_buttons($permission, "fnc_appv_entry", 0,0,"reset_form('size_1','','','','','');",1);
                            }
                        ?>
                        <input type="hidden" name="hidden_appv_cause" id="hidden_appv_cause" class="text_boxes /">

                    </td>
                </tr>
                <tr>
                    <td align="center">
                        <input type="button" name="close" class="formbutton" value="Close" id="main_close" onClick="fnc_close();" style="width:100px" />
                    </td>
                </tr>
            </table>
            </fieldset>
            </form>
            <? //fabric_booking_approval_cause
			  $sqlHis="select approval_cause from approval_cause_refusing_his where entry_form=12 and booking_id='$wo_id' and approval_type=2 and status_active=1 and is_deleted=0 order by id Desc";
			$sqlHisRes=sql_select($sqlHis);
		?>
		<table align="center" cellspacing="0" width="420" class="rpt_table" border="1" rules="all">
			<thead>
				<th width="30">SL</th>
				<th>Unapproved Request History</th>
			</thead>
		</table>
		<div style="width:420px; overflow-y:scroll; max-height:260px;" align="center">
			<table align="center" cellspacing="0" width="403" class="rpt_table" border="1" rules="all">
			<?
			$i=1;
			foreach($sqlHisRes as $hrow)
			{
				if ($i%2==0) $bgcolor="#E9F3FF"; else $bgcolor="#FFFFFF";
				?>
				<tr bgcolor="<?=$bgcolor; ?>" onClick="change_color('tr_<?=$i; ?>','<?=$bgcolor; ?>');">
					<td width="30"><?=$i; ?></td>
					<td style="word-break:break-all"><?=$hrow[csf('approval_cause')]; ?></td>
				</tr>
				<?
				$i++;
			}
			?>
			</table>
		</div>
        </div>
         
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
	exit();
}

if ($action=="save_update_delete_unappv_request")
{
	$process = array( &$_POST );
	extract(check_magic_quote_gpc( $process ));
	$approved_no=return_field_value("MAX(approved_no) as approved_no","approval_history","entry_form=12 and mst_id=$wo_id","approved_no");
	//echo "10**select approval_cause from approval_cause_refusing_his where approval_cause='".str_replace("'", "", $unappv_request)."' and entry_form=12 and booking_id='".str_replace("'", "", $wo_id)."' and approval_type=2 and status_active=1 and is_deleted=0"; die;
	$flag=1;
	/*if(is_duplicate_field( "approval_cause", "approval_cause_refusing_his", "approval_cause='".str_replace("'", "", $unappv_request)."' and entry_form=12 and booking_id='".str_replace("'", "", $wo_id)."' and approval_type=2 and status_active=1 and is_deleted=0" )==1)
	{
		//
	}
	else
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		//$id_his=return_next_id( "id", "approval_cause_refusing_his", 1);
		$idpre=return_field_value("max(id) as id", "fabric_booking_approval_cause", "booking_id=".$wo_id." and entry_form=12 and approval_type=2 group by booking_id","id");
		$sqlHis="insert into approval_cause_refusing_his( id, cause_id, page_id, entry_form, user_id, booking_id, approval_type, approval_no, approval_history_id, approval_cause, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, not_approval_cause)
			select '', id, page_id, entry_form, user_id, booking_id, approval_type, approval_no, approval_history_id, approval_cause, inserted_by, insert_date, updated_by, update_date, status_active, is_deleted, not_approval_cause from fabric_booking_approval_cause where booking_id=".$wo_id." and approval_type=2 and entry_form=12 and id ='$idpre'";
		
		if(count($sqlHis)>0)
		{
			$rID3=execute_query($sqlHis,0);
			if($flag==1)
			{
				if($rID3==1) $flag=1; else $flag=0;
			}
		}
	}*/
	
	if ($operation==0)  // Insert Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		$unapproved_request=return_field_value("id","fabric_booking_approval_cause","page_id=$page_id and entry_form=12 and user_id=$user_id and booking_id=$wo_id and approval_type=2 and approval_no=$approved_no");

		if($unapproved_request=="")
		{
			$id_mst=return_next_id( "id", "fabric_booking_approval_cause", 1 ) ;

			$field_array="id,page_id,entry_form,user_id,booking_id,approval_type,approval_no,approval_cause,inserted_by,insert_date,status_active,is_deleted";
			$data_array="(".$id_mst.",".$page_id.",12,".$user_id.",".$wo_id." ,2,".$approved_no.",".$unappv_request.",".$_SESSION['logic_erp']['user_id'].",'".$pc_date_time."',1,0)";
			$rID=sql_insert("fabric_booking_approval_cause",$field_array,$data_array,0);
			//echo $rID; die;

			if($db_type==0)
			{
				if($rID )
				{
					mysql_query("COMMIT");
					echo "0**".$rID."**".str_replace("'","",$wo_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					mysql_query("ROLLBACK");
					echo "10**".$rID;
				}
			}
			else if($db_type==2)
			{
				if($rID )
				{
					oci_commit($con);
					echo "0**".$rID."**".str_replace("'","",$wo_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					oci_rollback($con);
					echo "10**".$rID;
				}
			}
			if($db_type==1 )
			{
				echo "0**".$rID."**".$wo_id;
			}
			disconnect($con);
			die;
		}
		else
		{
			$con = connect();
			if($db_type==0)
			{
				mysql_query("BEGIN");
			}
			$update_id=return_field_value("max(id) as id", "fabric_booking_approval_cause", "booking_id=".$wo_id." and entry_form=12 and approval_type=2 group by booking_id","id");
			$field_array="page_id*entry_form*user_id*booking_id*approval_type*approval_no*approval_cause*updated_by*update_date*status_active*is_deleted";
			$data_array="".$page_id."*12*".$user_id."*".$wo_id."*2*".$approved_no."*".$unappv_request."*".$_SESSION['logic_erp']['user_id']."*'".$pc_date_time."'*1*0";
			 
			$rID=sql_update("fabric_booking_approval_cause",$field_array,$data_array,"id","".$update_id."",0);
			
			if($rID==1) $flag=1; else $flag=0;
		
			if(count($sqlHis)>0)
			{
				$rID3=execute_query($sqlHis,0);
				if($flag==1)
				{
					if($rID3==1) $flag=1; else $flag=0;
				}
			}

			if($db_type==0)
			{
				if($flag==1)
				{
					mysql_query("COMMIT");
					echo "1**".$rID."**".str_replace("'","",$wo_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					mysql_query("ROLLBACK");
					echo "10**".$rID;
				}
			}
			else if($db_type==2)
			{
				if($flag==1)
				{
					oci_commit($con);
					echo "1**".$rID."**".str_replace("'","",$wo_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
				}
				else
				{
					oci_rollback($con);
					echo "10**".$rID;
				}
			}
			if($db_type==1 )
			{
				echo "1**".$rID."**".str_replace("'","",$wo_id);
			}
			disconnect($con);
			die;
		}
	}
	else if ($operation==1)  // Update Here
	{
		$con = connect();
		if($db_type==0)
		{
			mysql_query("BEGIN");
		}
		//echo "10**";
		$update_id=return_field_value("max(id) as id", "fabric_booking_approval_cause", "booking_id=".$wo_id." and entry_form=12 and approval_type=2 group by booking_id","id");
		$field_array="page_id*entry_form*user_id*booking_id*approval_type*approval_no*approval_cause*updated_by*update_date";
		$data_array="".$page_id."*12*".$user_id."*".$wo_id."*2*'".$approved_no."'*'".str_replace("'", "", $unappv_request)."'*'".$_SESSION['logic_erp']['user_id']."'*'".$pc_date_time."'";

		$rID=sql_update("fabric_booking_approval_cause",$field_array,$data_array,"id",$update_id,0);
		if($rID==1 && $flag==1) $flag=1; else $flag=0;
		
		//echo "10**".$rID.'--'.$rID3.'--'.$flag; die;

		if($db_type==0)
		{
			if($flag==1)
			{
				mysql_query("COMMIT");
				echo "1**".$rID."**".str_replace("'","",$wo_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
			}
			else
			{
				mysql_query("ROLLBACK");
				echo "10**".$rID;
			}
		}
		else if($db_type==2)
		{
			if($flag==1)
			{
				oci_commit($con);
				echo "1**".$rID."**".str_replace("'","",$wo_id)."**".str_replace("'","",$unappv_request)."**".str_replace("'","",$user_id);
			}
			else
			{
				oci_rollback($con);
				echo "10**".$rID;
			}
		}
		if($db_type==1 )
		{
			echo "1**".$rID."**".str_replace("'","",$wo_id);
		}
		disconnect($con);
		die;
	}
}

if($action=="shipping_mark_popup")
{
	echo load_html_head_contents("Shipping Mark ","../../../", 1, 1, $unicode);
	extract($_REQUEST);
?>
	<script>
	function js_set_value()
	{
		var shippingmark_breck_down=$('#txt_company_name').val()+'~!~'+$('#txt_address').val()+'~!~'+$('#txt_phone').val()+'~!~'+$('#txt_pax').val()+'~!~'+$('#txt_mail').val()+'~!~'+$('#txt_web').val();
		var shippingmark_breck_down=shippingmark_breck_down.replace(/[ $ & () * ' " \r \n ]/g, '');//replace(/&()'"*<>{}/g,'');
		document.getElementById('hiddshippingmark_breck_down').value=shippingmark_breck_down;
		parent.emailwindow.hide();
	}
    </script>
    </head>
    
    <body>
    <div align="center" style="width:100%;" >
    <div style="display:none"><?=load_freeze_divs ("../../../",$permission); ?></div>
	<? 
	//echo $shippingmark_breck_down;
		if($shippingmark_breck_down=="")
		{
			$compnay_id=$compnay_id;
			$country_full_name = return_library_array("SELECT id,country_name from lib_country", "id", "country_name");
			
			$sqlCom="select company_name, email, website, plot_no, level_no, road_no, block_no, country_id, province, city, zip_code, contact_no from lib_company where id='$compnay_id' and status_active=1 and is_deleted=0";
			$sqlComRes=sql_select($sqlCom);
			$comName=$comAdd=$comPhone=$comPax=$comEmail=$comWeb="";
			foreach( $sqlComRes as $row)
			{
				$comName=$row[csf("company_name")];
				
				if($row[csf("level_no")])		$level_no 	= $row[csf("level_no")].', ';
				if($row[csf("plot_no")])		$plot_no 	=$row[csf("plot_no")].', ';
				if($row[csf("road_no")]) 		$road_no 	=$row[csf("road_no")].', ';
				if($row[csf("block_no")]!='')	$block_no 	=$row[csf("block_no")].', ';
				if($row[csf("zip_code")]!='')	$zip_code 	= ' -'.$row[csf("zip_code")].' , ';
				if($row[csf("city")]!='') 		$city 		= ($zip_code!="")?$row[csf("city")]:$row[csf("city")]." ,";
				if($row[csf("country_id")]!='')	$country 	= $country_full_name[$row[csf("country_id")]].'.';
				
				$comAdd=$level_no.$plot_no.$road_no.$block_no.$city.$zip_code.$country;
				$comPhone=$row[csf("contact_no")];
				$comEmail=$row[csf("email")];
				$comWeb=$row[csf("website")];
			}
			$shippingmark_breck_down=$comName.'~!~'.$comAdd.'~!~'.$comPhone.'~!~'.$comPax.'~!~'.$comEmail.'~!~'.$comWeb;
		}
		$data=explode("~!~",$shippingmark_breck_down); 
    ?>
    <fieldset>
        <form autocomplete="off">
        <input style="width:60px;" type="hidden" class="text_boxes" name="hiddshippingmark_breck_down" id="hiddshippingmark_breck_down" />
            <table width="400" class="rpt_table" border="1" rules="all">
                <thead>
                    <th>Shipping Marks [One Side]</th>
                </thead>
                <tr>
                    <td><input style="width:380px;" type="text" class="text_boxes" name="txt_company_name" id="txt_company_name" value="<?=$data[0]; ?>" placeholder="Company Name" /></td>
                </tr>
                <tr>
                    <td><input style="width:380px;" type="text" class="text_boxes" name="txt_address" id="txt_address" value="<?=$data[1]; ?>" placeholder="Address" /></td>
                </tr>
                <tr>
                    <td><input style="width:380px;" type="text" class="text_boxes" name="txt_phone" id="txt_phone" value="<?=$data[2]; ?>" placeholder="Phone" /></td>
                </tr>
                <tr>
                    <td><input style="width:380px;" type="text" class="text_boxes" name="txt_pax" id="txt_pax" value="<?=$data[3]; ?>" placeholder="Pax" /></td>
                </tr>
                <tr>
                    <td><input style="width:380px;" type="text" class="text_boxes" name="txt_mail" id="txt_mail" value="<?=$data[4]; ?>" placeholder="Mail" /></td>
                </tr>
                <tr>
                    <td><input style="width:380px;" type="text" class="text_boxes" name="txt_web" id="txt_web" value="<?=$data[5]; ?>" placeholder="Web" /></td>
                </tr>
                <tr>
                    <td align="center"  class="button_container">
                    	<input type="button" class="formbutton" value="Close" onClick="js_set_value();"/>
                    </td>
                </tr>
            </table>
        </form>
    </fieldset>
    </div>
    </body>
    <script src="../../../includes/functions_bottom.js" type="text/javascript"></script>
    </html>
    <?
	exit();
}

function get_precost_data($dataArr=array()){


	include('../../../includes/class4/class.conversions.php');
	include('../../../includes/class4/class.trims.php');
	include('../../../includes/class4/class.emblishments.php');
	include('../../../includes/class4/class.washes.php');
	include('../../../includes/class4/class.commercials.php');
	include('../../../includes/class4/class.commisions.php');
	include('../../../includes/class4/class.others.php');
	
	
	$zero_value	="1";
	$supplier_check	="0";
	$txt_job_no= "'".$dataArr[job_no]."'";
	$cbo_company_name=	$dataArr[company_id];
	$txt_po_breack_down_id=	$dataArr[po_id];
		
	//print_r($dataAr);die;
	
	$precostSql="select RATE,COSTING_DATE,COSTING_PER from WO_PRE_COST_MST where JOB_NO=$txt_job_no";
 
	//echo $precostSql;die();
	$precostSqlResult = sql_select($precostSql);
   // prinr_r($precostSqlResult);
	foreach($precostSqlResult as $rows)
	{  //echo 234565;die();
		$txt_costing_date=$rows['COSTING_DATE'];
		$cbo_costing_per=$rows['COSTING_PER'];
		$rate_amt=$rows['RATE'];
 
	}
 
	
 
	///extract($_REQUEST);
	$txt_costing_date=change_date_format(str_replace("'","",$txt_costing_date),'yyyy-mm-dd','-');
	if($txt_job_no=="") $job_no=''; else $job_no=" and a.job_no=".$txt_job_no."";
	if($cbo_company_name=="") $company_name=''; else $company_name=" and a.company_name=".$cbo_company_name."";
	if($cbo_buyer_name=="") $cbo_buyer_name=''; else $cbo_buyer_name=" and a.buyer_name=".$cbo_buyer_name."";
	if($txt_style_ref=="") $txt_style_ref=''; else $txt_style_ref=" and a.style_ref_no=".$txt_style_ref."";
	if($txt_costing_date=="") $txt_costing_date=''; else $txt_costing_date=" and c.costing_date='".$txt_costing_date."'";
	$txt_po_breack_down_id=str_replace("'",'',$txt_po_breack_down_id);
	if(str_replace("'",'',$txt_po_breack_down_id)=="") 
	{
		$txt_po_breack_down_id_cond='';  $txt_po_breack_down_id_cond1='';  $txt_po_breack_down_id_cond2='';  $txt_po_breack_down_id_cond3=''; 
	}
	else
	{
		$txt_po_breack_down_id_cond=" and b.id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond1=" and id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond2=" and po_break_down_id in(".$txt_po_breack_down_id.")";
		$txt_po_breack_down_id_cond3=" and b.id in(".$txt_po_breack_down_id.")";
	}
	
	//array for display name
	$buyer_arr=return_library_array( "select id, buyer_name from lib_buyer",'id','buyer_name');
	$comp=return_library_array( "select id, company_name from lib_company",'id','company_name');
	$imge_arr=return_library_array( "select master_tble_id,image_location from   common_photo_library where form_name='company_details' and file_type=1",'master_tble_id','image_location');
	$color_library=return_library_array( "select id, color_name from lib_color where status_active=1 and is_deleted=0", "id", "color_name");
	
	if($db_type==0) $group_gsm="group_concat( distinct b.gsm_weight) AS gsm_weight";
	if($db_type==2) $group_gsm="listagg(b.gsm_weight ,',') within group (order by b.gsm_weight) AS gsm_weight";
	
	$gsm_weight_top=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and b.status_active=1 and b.is_deleted=0 and a.body_part_type in(1,20)","gsm_weight");
	//$gsm_weight_bottom=return_field_value("$group_gsm", "lib_body_part a,wo_pre_cost_fabric_cost_dtls b", "a.id=b.body_part_id and b.job_no=$txt_job_no and a.body_part_type=20 ","gsm_weight");
	//echo $gsm_weight_bottom.'DD';
	$gmtsitem_ratio_array=array();
	$grmnt_items = "";
	$grmts_sql = sql_select("select job_no,gmts_item_id,set_item_ratio from wo_po_details_mas_set_details where job_no=$txt_job_no");
	//echo 23444565;die();
 
	foreach($grmts_sql as $key=>$val)
	{  //echo 234565;die();
		$grmnt_items .=$garments_item[$val[csf("gmts_item_id")]].",";
		$gmtsitem_ratio_array[$val[csf('job_no')]][$val[csf('gmts_item_id')]]=$val[csf('set_item_ratio')];	
	}
	
	$grmnt_items = rtrim($grmnt_items,","); 
 
	$set_order=0;
	if(count($grmts_sql)>1)
	{
		$set_order=1;
	}
	
	if($db_type==0) ///fab_knit_fin_req_kg,fab_knit_req_kg
	{	
	   $sql = "SELECT a.job_no,a.company_name, a.buyer_name,a.style_ref_no,a.ship_mode, a.gmts_item_id,a.order_uom, a.avg_unit_price,sum(b.plan_cut) as job_quantity,sum(b.po_quantity) as ord_qty,  c.costing_per,c.budget_minute,c.costing_date,c.approved,c.exchange_rate ,a.quotation_id,c.incoterm,c.sew_effi_percent,group_concat(b.sc_lc) as sc_lc, d.fab_knit_req_kg,d.fab_knit_fin_req_kg, d.fab_woven_req_yds,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg,c.sew_smv
			from wo_po_details_master a,wo_po_break_down b, wo_pre_cost_mst c left join wo_pre_cost_sum_dtls d on   c.job_no=d.job_no and d.status_active=1 and d.is_deleted=0
			where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no  and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref $txt_costing_date group by a.job_no,a.company_name, a.buyer_name,a.style_ref_no, a.gmts_item_id,a.order_uom, a.avg_unit_price, c.costing_per,c.approved,c.budget_minute,c.incoterm,c.sew_effi_percent, d.fab_knit_req_kg, d.fab_woven_req_yds,d.fab_knit_fin_req_kg,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg,c.sew_smv order by a.job_no"; 
	}
	else if($db_type==2)
	{	
		$sql = "SELECT a.job_no,a.company_name, a.buyer_name,a.ship_mode,a.style_ref_no, a.gmts_item_id,a.order_uom, a.avg_unit_price,sum(b.plan_cut) as job_quantity, sum(b.po_quantity) as ord_qty, listagg(cast(b.sc_lc as varchar2(4000)),',') within group (order by b.sc_lc) as sc_lc, c.costing_per,c.costing_date,c.budget_minute,c.approved,a.quotation_id,c.exchange_rate ,c.incoterm,c.sew_effi_percent,d.fab_knit_fin_req_kg, d.fab_knit_req_kg, d.fab_woven_req_yds,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg,c.sew_smv
		from wo_po_details_master a, wo_po_break_down b, wo_pre_cost_mst c left join  wo_pre_cost_sum_dtls d on  c.job_no=d.job_no and d.status_active=1 and d.is_deleted=0
		where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no  and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0  $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref group by a.job_no,a.company_name, a.buyer_name,a.style_ref_no, a.gmts_item_id,a.order_uom,a.ship_mode, a.avg_unit_price, c.incoterm,c.costing_date,c.exchange_rate ,a.quotation_id,c.costing_per,c.sew_effi_percent,c.approved,c.budget_minute, d.fab_knit_req_kg, d.fab_woven_req_yds,d.fab_knit_fin_req_kg,d.fab_woven_fin_req_yds, d.fab_yarn_req_kg,c.sew_smv  order by a.job_no"; //a.job_quantity as job_quantity,
	}
	
	//echo $sql;die;
	$data_array=sql_select($sql);
	$plan_cut_qty=$data_array[0][csf('job_quantity')];
	$exchange_rate=$data_array[0][csf('exchange_rate')];
	$pre_costing_smv=$data_array[0][csf('sew_smv')];
	
	 
	$preCost_histry=sql_select( "select a.id as mst_id,b.id as dtls_id,a.sew_smv as sew_smv,a.sew_effi_percent as sew_effi_percent,b.margin_dzn_percent as margin_dzn_percent ,b.fabric_cost_percent as fabric_cost_percent,
  b.trims_cost_percent  as trims_cost_percent,b.embel_cost_percent as embel_cost_percent,b.wash_cost_percent as wash_cost_percent ,b.comm_cost_percent as comm_cost_percent ,
  b.commission_percent as commission_percent,b.lab_test_percent as lab_test_percent,b.inspection_percent as inspection_percent,b.cm_cost_percent as cm_cost_percent,
  b.freight_percent as freight_percent,b.currier_percent as currier_percent,b.certificate_percent as certificate_percent,b.common_oh_percent as common_oh_percent
  from wo_pre_cost_mst_histry a,wo_pre_cost_dtls_histry b where a.job_no=b.job_no and a.job_no=$txt_job_no  order by  a.id,b.id  asc");
	
	list($preCost_histry_row)=$preCost_histry;
	$opert_profitloss_percent=$preCost_histry_row[csf('margin_dzn_percent')];
 
	//echo 1;die();
	$fabric_cost_percent=$preCost_histry_row[csf('fabric_cost_percent')];
	$trims_cost_percent=$preCost_histry_row[csf('trims_cost_percent')];
	$embel_cost_percent=$preCost_histry_row[csf('embel_cost_percent')];
	$wash_cost_percent=$preCost_histry_row[csf('wash_cost_percent')];
	$comm_cost_percent=$preCost_histry_row[csf('comm_cost_percent')];
	$commission_percent=$preCost_histry_row[csf('commission_percent')];
	$common_oh_percent=$preCost_histry_row[csf('common_oh_percent')];
	
	$lab_test_percent=$preCost_histry_row[csf('lab_test_percent')];
	$inspection_percent=$preCost_histry_row[csf('inspection_percent')];
	$cm_cost_percent=$preCost_histry_row[csf('cm_cost_percent')];
	$freight_percent=$preCost_histry_row[csf('freight_percent')];
	$currier_percent=$preCost_histry_row[csf('currier_percent')];
	$certificate_percent=$preCost_histry_row[csf('certificate_percent')];
	//$currier_percent=$preCost_histry_row[csf('currier_percent')];
	$sew_effi_percent=$data_array[0][csf('sew_effi_percent')];//
	$hissew_effi_percent=$preCost_histry_row[csf('sew_effi_percent')];
	$sew_smv=$preCost_histry_row[csf('sew_smv')];
	$first_app_date="";
	$last_app_date="";
	$preCost_approved=sql_select( "select max(b.approved_no) as approved_no, min(b.approved_date) as first_app_date, max(b.approved_date) as last_app_date,a.id from wo_pre_cost_mst a, approval_history b where b.full_approved=1 and  a.id=b.mst_id and a.job_no=$txt_job_no and b.entry_form=15 group by a.id"); 
	
	if(count($preCost_approved)>0)
	{
		foreach($preCost_approved as $preCost_approved_row)
		{  //echo 222211;die();
			$approved_no_row=$preCost_approved_row[csf('approved_no')];
			$fst_date=$preCost_approved_row[csf('first_app_date')];
			$fstapp_date=$fst_date[0];
			
			$last_date=$preCost_approved_row[csf('last_app_date')];
			$lstapp_date=$last_date[0];
			$precost_id=$preCost_approved_row[csf('id')];
		 
			
			if($approved_no_row>1){
				$revised_no=$approved_no_row-1;
			}
		}
	}
	
  
	$preCost_approved_component=sql_select( "select   max(approved_date) as last_app_date,count(approved_date) as approve_no,cost_component_id from co_com_pre_costing_app_his where mst_id=$precost_id and job_no=$txt_job_no and entry_form=15 group by cost_component_id  ");
	$higher_autorize_app_date=$preCost_approved_component[0][csf('last_app_date')];
	$higher_autorize_approve_no=$preCost_approved_component[0][csf('approve_no')];
	if($higher_autorize_app_date!="") $last_date=$higher_autorize_app_date;
	if($higher_autorize_approve_no!="") $revised_no=$revised_no+$higher_autorize_approve_no;
	
	 $company_id=str_replace("'","",$cbo_company_name);
	// echo $fstapp_date.'dddddddddd';die;
	 if($fstapp_date=="" || $fstapp_date=="00-00-0000") $first_app_dateD="";else $first_app_dateD=$fstapp_date;
	 if($lstapp_date=="" || $lstapp_date=="00-00-0000") $lstapp_dateD="";else $lstapp_dateD=$lstapp_date;
	//echo $higher_autorize_app_date."**".$lstapp_date;die;
	$img_path = ($img_path)?$img_path:'../../';
	
	//Fabric ,Trims,Emblishment,Wash Synchronize check//If color size breakdown updated found
	$sql_trim=sql_select("select Max(b.is_apply_last_update) as is_apply_last_update  from  wo_pre_cost_fabric_cost_dtls b where  b.job_no=$txt_job_no and b.is_deleted=0 and b.status_active=1");
	
	$trim_msg="";
	foreach($sql_trim as $row)
	{   
		if($row[csf("is_apply_last_update")]==2)
		{
			$trim_msg=" Trims,";
			$chk_msg=1; 
		}
	}
	
	$sql_trim=sql_select("select Max(b.is_apply_last_update) as is_apply_last_update  from  wo_pre_cost_trim_cost_dtls b where  b.job_no=$txt_job_no and b.is_deleted=0 and b.status_active=1");
	 
	$trim_msg="";
	foreach($sql_trim as $row)
	{
		if($row[csf("is_apply_last_update")]==2)
		{
			$trim_msg=" Trims,";
			$chk_msg=1; 
		}
	}
	$sql_conv=sql_select("select Max(b.is_apply_last_update) as is_apply_last_update  from  wo_pre_cost_fab_conv_cost_dtls b where  b.job_no=$txt_job_no and b.is_deleted=0 and b.status_active=1");
	
	$conv_msg="";
	foreach($sql_conv as $row)
	{
		if($row[csf("is_apply_last_update")]==2)
		{
			$conv_msg=" Conversion,";
			$chk_msg=1; 
		}
	}
	
	$sql_embl=sql_select("select Max(b.is_apply_last_update) as is_apply_last_update,emb_name  from wo_pre_cost_embe_cost_dtls b where  b.job_no=$txt_job_no and b.is_deleted=0 and b.status_active=1 and cons_dzn_gmts>0 group by emb_name");
	
	$emb_msg="";
	foreach($sql_embl as $row)
	{  // echo 211;die();
		if($row[csf("is_apply_last_update")]==2 && $row[csf("emb_name")]==3) //Wash
		{
			$wash_msg=" Wash,";
			$chk_msg=1; 
		}
		else if($row[csf("is_apply_last_update")]==2 && $row[csf("emb_name")]!=3) 
		{
			$emb_msg=" Emblishment";
			$chk_msg=1; 
		}
	}
 
	//echo 21;die();
	 if($chk_msg==1)
	 {
	$check_msg="Color size breakdown is updated. please Synchronize following heads: ";
	$check_msg.=$fabric_msg.$conv_msg.$trim_msg.$emb_msg.$wash_msg;
		//echo "document.getElementById('check_sms2').innerHTML = '".$check_msg."';\n";
	 }
	 else
	 {
		$check_msg="";
		 //echo "document.getElementById('check_sms2').innerHTML = '".$check_msg."';\n";
	 }
 
	 
	
	ob_start();
	?>
	<div style="width:972px; margin:0 auto">
	 
	<div style="width:970px; font-size:20px; font-weight:bold" align="center"><b style="float:left"> <img  src='<? echo $img_path.$imge_arr[$company_id]; ?>' height='40px' width='100px' /></b><? echo $comp[str_replace("'","",$cbo_company_name)]; ?><b style="float:right; font-size:14px; font-weight:bold"> <?  echo '&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;&nbsp; &nbsp;';?>  </b></div>
	<div style="width:970px; font-size:18px; font-weight:bold" align="center"><b style="float:left"></b>Bill Of Materials (BOM) Report<b style="float:right; font-size:18px; font-weight:bold"> <? if($revised_no!=0) echo 'Revised No &nbsp;:'.$revised_no; else echo " &nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp;&nbsp; &nbsp;"; ?>  &nbsp;  </b> </div>
	<div style="width:970px; font-size:14px; font-weight:bold" align="center"><b style="float:right; font-size:14px; font-weight:bold; color:#F00"> <? if($fst_date!="") echo "First Approval Date:".$fst_date; if($last_date!="") echo ";<br>  Last Approval Date:".$last_date; else echo " &nbsp;"; ?>  &nbsp;  </b>
	<p style="color:red"> <? echo $check_msg;?></p>
	
	 </div>
	<?
	
	foreach ($data_array as $row)
	{	
		$order_price_per_dzn=0;
		$order_job_qnty=0;
		$ord_qty=0;
		$avg_unit_price=0;
		$order_values = $row[csf("ord_qty")]*$row[csf("avg_unit_price")];
		$result =sql_select("select po_number,pub_shipment_date,file_no,excess_cut,grouping from wo_po_break_down where job_no_mst=$txt_job_no $txt_po_breack_down_id_cond1 and status_active=1 and is_deleted=0 order by pub_shipment_date DESC");
		//$tot_row=count($result);
		$job_in_orders = '';$pulich_ship_date='';$job_in_ref = '';$job_in_file = '';
		$tot_excess_cut=0;$tot_row=0;
		foreach ($result as $val)
		{
			$job_in_orders .= $val[csf('po_number')].", ";
			$pulich_ship_date = $val[csf('pub_shipment_date')];
			if($val[csf('excess_cut')]>0)
			{
				$tot_row++;	
			}
			$tot_excess_cut+= $val[csf('excess_cut')];
			
			//$job_in_ref .= $val[csf('grouping')].", ";
			//$job_in_file .= $val[csf('file_no')].", ";
		//	if($job_in_ref=='') $job_in_ref= $val[csf('grouping')]; else $job_in_ref.=",". $val[csf('grouping')];
		//	if($job_in_file=='') $job_in_file= $val[csf('file_no')]; else $job_in_file.=",". $val[csf('file_no')];
		}
		$job_in_orders = substr(trim($job_in_orders),0,-1);
		//$sew_effi_percent=$row[csf("sew_effi_percent")];
		
		?>
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px" rules="all">
				<caption><? if($row[csf("approved")]==1) echo "<font color='red' style=' font-size:15px; font-weight:bold'>THIS JOB IS APPROVED</font>"; else "";?> </caption>
					<tr>
						<td>Job No</td>
						<td><b><? echo $row[csf("job_no")]; ?></b></td>
						<td>Buyer</td>
						<td><b><? echo $buyer_arr[$row[csf("buyer_name")]]; ?></b></td>
						<td>Style Ref. No</td>
						<td><b><? echo $row[csf("style_ref_no")]; ?></b></td>
						<td>Garments Item</td>
						<td><b><? echo $grmnt_items; ?></b></td>
					</tr>
					<tr>
						<td>Incoterm</td>
						<td><b><? echo $incoterm[$row[csf("incoterm")]]; ?></b></td>
						<td>Costing for</td>
						<td><b><? echo $costing_per[$row[csf("costing_per")]]; ?></b></td>
					  
						<td>Sew. Effi. %</td>
						<td><b><? echo $row[csf("sew_effi_percent")]; ?></b></td>
						<td>Order UOM</td>
						<td><? echo $unit_of_measurement[$row[csf("order_uom")]]; ?></td>
					</tr>
					<tr>
						<td>LC/SC No</td>
						<td colspan="7"><b><? echo $row[csf("sc_lc")]; ?></b></td>
					</tr>
				</table>
 
			<?	
			if($row[csf("costing_per")]==1){$order_price_per_dzn=12;$costing_for="1 DZN";}
			else if($row[csf("costing_per")]==2){$order_price_per_dzn=1;$costing_for="1 PCS";}
			else if($row[csf("costing_per")]==3){$order_price_per_dzn=24;$costing_for="2 DZN";}
			else if($row[csf("costing_per")]==4){$order_price_per_dzn=36;$costing_for="3 DZN";}
			else if($row[csf("costing_per")]==5){$order_price_per_dzn=48;$costing_for="4 DZN";}
			else {$order_price_per_dzn=0;$costing_for="DZN";}
			$order_job_qnty=$row[csf("job_quantity")];
			$avg_unit_price=$row[csf("avg_unit_price")];
			$ord_qty=$row[csf("ord_qty")];
	}//end first foearch
	  $sql_po = "select a.job_no, a.company_name, a.set_smv, a.total_set_qnty, b.id as po_id, (e.plan_cut_qnty) as plan_cut, (b.po_quantity) as ord_qty, b.excess_cut, b.unit_price, b.po_total_price, b.po_number, b.shiping_status, b.pub_shipment_date, b.is_confirmed, b.insert_date, c.exchange_rate, c.incoterm, d.price_dzn, e.order_quantity as color_size_qty
			from wo_po_details_master a,wo_po_break_down b, wo_pre_cost_mst c, wo_pre_cost_dtls d, wo_po_color_size_breakdown e
			where a.job_no=b.job_no_mst and b.job_no_mst=c.job_no and c.job_no=d.job_no and b.id=e.po_break_down_id and a.status_active=1 and a.is_deleted =0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0 and d.status_active=1 and d.is_deleted=0 and e.status_active=1 and e.is_deleted=0 $job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref order by b.insert_date ASC"; 
			$po_data_array=sql_select($sql_po); $set_ratio=0; $exchange_rate=0;
			foreach($po_data_array as $row)
			{
				$insert_date=explode(" ",$row[csf("insert_date")]);
				$insert_date=$insert_date[0];
				$po_wise_arr[$row[csf("po_id")]]['ord_qty']=$row[csf("ord_qty")];
				$po_wise_arr[$row[csf("po_id")]]['plan_cut']+=$row[csf("plan_cut")];
				$po_wise_arr[$row[csf("po_id")]]['excess_cut']=$row[csf("excess_cut")];
				$po_wise_arr[$row[csf("po_id")]]['unit_price']=$row[csf("unit_price")];
				$po_wise_arr[$row[csf("po_id")]]['po_total_price']=$row[csf("po_total_price")];
				$po_wise_arr[$row[csf("po_id")]]['total_set_qnty']=$row[csf("total_set_qnty")];
				$po_wise_arr[$row[csf("po_id")]]['shiping_status']=$row[csf("shiping_status")];
				$po_wise_arr[$row[csf("po_id")]]['pub_shipment_date']=$row[csf("pub_shipment_date")];
				$po_wise_arr[$row[csf("po_id")]]['is_confirmed']=$row[csf("is_confirmed")];
				$po_wise_arr[$row[csf("po_id")]]['insert_date']=$insert_date;
				$po_wise_arr[$row[csf("po_id")]]['po_number']=$row[csf("po_number")];
				$po_wise_arr[$row[csf("po_id")]]['set_smv']=$row[csf("set_smv")];
				$po_wise_arr[$row[csf("po_id")]]['color_size_qty']+=$row[csf("color_size_qty")];
				
				$incoterm_id=$row[csf("incoterm")];
				$set_ratio=$row[csf("total_set_qnty")];
				$price_dzn=$row[csf("price_dzn")];
				$exchange_rate=$row[csf("exchange_rate")];
			}
			//echo $price_dzn; die;
		
			?>
			<br/>
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px; font-size:14px" rules="all">
				<caption> <b>Order Info </b></caption>
					<thead>
						<th width="20">SL</th>
						<th width="90">Order No</th>
						<th width="70">Order Qty(Pcs)</th>
						<th width="70">Breakdown Qty(Pcs)</th>
						<th width="60">Excess Cut %</th>
						<th width="70">Plan Cut Qty(Pcs)</th>
						<th width="60">Avg. Unit Price (Pcs)</td>
						<th width="70">Order Value</th>
						<th width="60">SMV</th>
						<th width="70">TTL SAH</th>
						<th width="60">Ship date</th>
						<th width="60">Insert date</th>
						<th width="70">Order Status</th>
						<th>Ship Status</th>
					</tr>
					<?
					$p=1;$total_po_qty=$total_plan_cut_qty=$total_po_value=$total_ttl_sah=0;
					 
					foreach($po_wise_arr as $poKey=>$val) 
					{     
						$ord_qty=$val["ord_qty"]*$val["total_set_qnty"];
						
						$plan_qty=$val["plan_cut"];
						$unit_price=($val["unit_price"]/$val["total_set_qnty"]);
						if(is_infinite($unit_price) || is_nan($unit_price)){$unit_price=0;}
						$po_price=$ord_qty*$unit_price;
						if($set_order>0)
						{
							$ttl_sah=($val["plan_cut"]*$val["set_smv"])/60;
							$ttl_title="Plan Cut Qty(Set=".$val["plan_cut"].")*SMV/60";
						}
						
						else
						{
							$ttl_sah=($plan_qty*$val["set_smv"])/60;
							$ttl_title="Plan Cut Qty(Pcs)*SMV/60";
						}
						
					?>
				
					<tr>
						<td><? echo $p; ?></td>
						<td style="word-break:break-all"><? echo $val["po_number"]; ?></td>
						<td align="right" title="<?=$val["ord_qty"].'='.$val["total_set_qnty"];?>"><? echo fn_number_format($ord_qty,0); ?></td>
						<td align="right"><? echo fn_number_format($val["color_size_qty"],0); ?></td>
						<td align="right"><? echo fn_number_format($val["excess_cut"],2); ?></td>
						<td align="right"><? echo fn_number_format($plan_qty,0); ?></td>
						<td align="right"><? echo fn_number_format($unit_price,3); ?></td>
						<td align="right"><? echo fn_number_format($po_price,2); ?></td>
						<td align="right"><? echo fn_number_format($val["set_smv"],3); ?></td>
						<td align="right" title="<?=$ttl_title;?>"><? echo fn_number_format($ttl_sah,2); ?></td>
						<td><? echo date('d-m-y',strtotime($val["pub_shipment_date"])); //change_date_format?></td>
						<td><? echo date('d-m-y',strtotime($val["insert_date"])); ?></td>
					  
						<td><? echo $order_status[$val["is_confirmed"]]; ?></td>
						<td style="word-break:break-all"><? echo $shipment_status[$val["shiping_status"]]; ?></td>
					</tr>
					<?
					$p++;
					$total_po_qty+=$val["ord_qty"];
					$total_plan_cut_qty+=$val["plan_cut"];
					$total_po_value+=$val["po_total_price"];
					$total_color_size_qty+=$val["color_size_qty"];
					
					$tot_po_qty+=$ord_qty;
					$tot_plan_cut_qty+=$plan_qty;
					$tot_po_value+=$po_price;
					
					$total_ttl_sah+=$ttl_sah;
					//$total_ttl_sah+=$ttl_sah;
					//$total_ttl_sah+=$ttl_sah;
					}
					
					$job_po_rate_set=$total_po_value/$total_po_qty;
					
					if(is_infinite($job_po_rate_set) || is_nan($job_po_rate_set)){$job_po_rate_set=0;}
					
					$td_qty_pcs_color="";
					if($tot_po_qty!=$total_color_size_qty) $td_qty_pcs_color="#FF0000";
					?>
					<tfoot>
					<th colspan="2">Job Total</th>
					<th align="right" bgcolor="<? echo $td_qty_pcs_color; ?>"><? echo fn_number_format($tot_po_qty,0); ?></th>
					<th align="right" bgcolor="<? echo $td_qty_pcs_color; ?>"><? echo fn_number_format($total_color_size_qty,0); ?></th>
					<th align="right" title="Total ((Plan Cut-PO Qty)/Po Qty)*100"><? 
					$excec_per=(($tot_plan_cut_qty-$tot_po_qty)/$tot_po_qty)*100;
					if(is_infinite($excec_per) || is_nan($excec_per)){$excec_per=0;}
					echo  fn_number_format($excec_per,0); 
					?></th>
					
					<th align="right"><? echo  fn_number_format($tot_plan_cut_qty,0); ?></th>
					<th align="right"><? $job_po_rate=$tot_po_value/$tot_po_qty;echo  fn_number_format($job_po_rate,3); ?></th>
					<th align="right"><? echo  fn_number_format($tot_po_value,2); ?></th>
					<th align="right" title="Total TTL SAH*60/Plan Cuts"><?  
					$tot_smv=($total_ttl_sah*60)/$tot_plan_cut_qty;
					if(is_infinite($tot_smv) || is_nan($tot_smv)){$tot_smv=0;}
					echo  fn_number_format($tot_smv,3); 
					?></th>
					<th align="right"><?  echo  fn_number_format($total_ttl_sah,2); ?></th>
					<th align="right"><? //echo  fn_number_format($total_po_qty,0); ?></th>
					<th align="right"><? //echo  fn_number_format($total_po_qty,0); ?></th>
					<th><? //echo  fn_number_format($total_po_qty,0); ?></th>
					<th><? 
					$tot_perDznValue=($tot_po_value/$tot_po_qty)*12;
					if(is_infinite($tot_perDznValue) || is_nan($tot_perDznValue)){$tot_perDznValue=0;}
					//echo  fn_number_format($total_po_qty,0); ?></th>
					</tfoot>
				</table>
				<br/>
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px" rules="all">
				<?
				//echo $txt_po_breack_down_id;die;
				$po_no=str_replace("'","",$txt_po_breack_down_id);
			$condition= new condition();
			if(str_replace("'","",$txt_job_no) !=''){
				  $condition->job_no("=$txt_job_no");
			 }
			
			  if(str_replace("'","",$txt_po_breack_down_id)!='')
			 {
				$condition->po_id("in($po_no)"); 
			 }
			
			  $condition->init();
			//$yarn= new yarn($condition);
		   $fabric= new fabric($condition);
		   //echo $fabric->getQuery(); die;
		  //$fabric_costing_arr=$fabric->getQtyArray_by_job_knitAndwoven_greyAndfinish_production();
		   $yarn= new yarn($condition);
			$yarn_costing_arr=$yarn->getJobWiseYarnAmountArray();
			
			$fabric= new fabric($condition);
			$fabric_costing_arr2=$fabric->getAmountArray_by_job_knitAndwoven_greyAndfinish();
			
			$fabric_qty_arr=$fabric->getQtyArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
			$fabric_amount_arr=$fabric->getAmountArray_by_Fabriccostid_knitAndwoven_greyAndfinish();
				
			$conversion= new conversion($condition);
			
			$conversion_costing_arr_process=$conversion->getAmountArray_by_job();
			
			$trims= new trims($condition);
			
			$trims_costing_arr=$trims->getAmountArray_by_job();
			
			$emblishment= new emblishment($condition);
			$emblishment_costing_arr=$emblishment->getAmountArray_by_job();
			$wash= new wash($condition);
			//echo $wash->getQuery(); die;
			$emblishment_costing_arr_wash=$wash->getAmountArray_by_job();
		
			$commercial= new commercial($condition);
			
			$commercial_costing_arr=$commercial->getAmountArray_by_job();
			
			$commission= new commision($condition);
			
			$commission_costing_arr=$commission->getAmountArray_by_job();
		
			$other= new other($condition);
			
			$other_costing_arr=$other->getAmountArray_by_job();
			 
			$job_no=str_replace("'","",$txt_job_no);
			//All Cost start here...
		
			///----------------AAA---------
			$ttl_conversion_cost=array_sum($conversion_costing_arr_process[$job_no]);
		
			$ttl_fab_cost=array_sum($fabric_costing_arr2['knit']['grey'][$job_no])+array_sum($fabric_costing_arr2['woven']['grey'][$job_no]);
			$total_fab_cost=$yarn_costing_arr[$job_no]+$ttl_fab_cost+$ttl_conversion_cost;
			
			$ttl_trims_cost=$trims_costing_arr[$job_no];
			$ttl_emblishment_cost=$emblishment_costing_arr[$job_no]+$emblishment_costing_arr_wash[$job_no];
			$ttl_commercial_cost=$commercial_costing_arr[$job_no];
			$ttl_commission_cost=$commission_costing_arr[$job_no];
			
			$ttl_cm_cost=$other_costing_arr[$job_no]['cm_cost'];
			
			if(is_infinite($ttl_cm_cost) || is_nan($ttl_cm_cost)){$ttl_cm_cost=0;}
			$ttl_freight_cost=$other_costing_arr[$job_no]['freight'];
			if(is_infinite($ttl_freight_cost) || is_nan($ttl_freight_cost)){$ttl_freight_cost=0;}
			$ttl_inspection_cost=$other_costing_arr[$job_no]['inspection'];
			if(is_infinite($ttl_inspection_cost) || is_nan($ttl_inspection_cost)){$ttl_inspection_cost=0;}
			$ttl_certificate_cost=$other_costing_arr[$job_no]['certificate_pre_cost'];
			if(is_infinite($ttl_certificate_cost) || is_nan($ttl_certificate_cost)){$ttl_certificate_cost=0;}
			$ttl_common_oh=$other_costing_arr[$job_no]['common_oh'];
			if(is_infinite($ttl_common_oh) || is_nan($ttl_common_oh)){$ttl_common_oh=0;}
			$ttl_currier_cost=$other_costing_arr[$job_no]['currier_pre_cost'];
			if(is_infinite($ttl_currier_cost) || is_nan($ttl_currier_cost)){$ttl_currier_cost=0;}
			$ttl_lab_test_cost=$other_costing_arr[$job_no]['lab_test'];
			if(is_infinite($ttl_lab_test_cost) || is_nan($ttl_lab_test_cost)){$ttl_lab_test_cost=0;}
			$ttl_depr_amor_pre_cost=$other_costing_arr[$job_no]['depr_amor_pre_cost'];
			if(is_infinite($ttl_depr_amor_pre_cost) || is_nan($ttl_depr_amor_pre_cost)){$ttl_depr_amor_pre_cost=0;}
			$ttl_deffdlc_cost=$other_costing_arr[$job_no]['deffdlc_cost'];
			if(is_infinite($ttl_deffdlc_cost) || is_nan($ttl_deffdlc_cost)){$ttl_deffdlc_cost=0;}			
			$ttl_other_cost=$ttl_cm_cost+$ttl_freight_cost+$ttl_inspection_cost+$ttl_certificate_cost+$ttl_common_oh+$ttl_currier_cost+$ttl_lab_test_cost+$ttl_depr_amor_pre_cost+$ttl_deffdlc_cost;
			//echo $ttl_conversion_cost.'='.$ttl_trims_cost.'='.$ttl_emblishment_cost.'='.$ttl_commercial_cost.'='.$ttl_commission_cost.'='.$ttl_other_cost;
			$ttl_total_cost=$total_fab_cost+$ttl_trims_cost+$ttl_emblishment_cost+$ttl_commercial_cost+$ttl_commission_cost+$ttl_other_cost;
			$costing_per_unit_budget=$ttl_total_cost/$tot_po_qty;
			if(is_infinite($costing_per_unit_budget) || is_nan($costing_per_unit_budget)){$costing_per_unit_budget=0;}
				
			$fab_knit_req_kg=$data_array[0][csf('fab_knit_req_kg')];
			if(is_infinite($fab_knit_req_kg) || is_nan($fab_knit_req_kg)){$fab_knit_req_kg=0;}
			$fab_knit_fin_req_kg=$data_array[0][csf('fab_knit_fin_req_kg')];
			if(is_infinite($fab_knit_fin_req_kg) || is_nan($fab_knit_fin_req_kg)){$fab_knit_fin_req_kg=0;}
			$fab_woven_req_yds=$data_array[0][csf('fab_woven_req_yds')];
			if(is_infinite($fab_woven_req_yds) || is_nan($fab_woven_req_yds)){$fab_woven_req_yds=0;}
			$fab_woven_fin_req_yds=$data_array[0][csf('fab_woven_fin_req_yds')];
			if(is_infinite($fab_woven_fin_req_yds) || is_nan($fab_woven_fin_req_yds)){$fab_woven_fin_req_yds=0;}
			
			$fab_yarn_req_kg=$data_array[0][csf('fab_yarn_req_kg')];
			if(is_infinite($fab_yarn_req_kg) || is_nan($fab_yarn_req_kg)){$fab_yarn_req_kg=0;}
			$exchange_rate=$data_array[0][csf('exchange_rate')];
			if(is_infinite($exchange_rate) || is_nan($exchange_rate)){$exchange_rate=0;}
			//$avg_unit_price=$data_array[0][csf('avg_unit_price')];\
			$avg_unit_price=$job_po_rate;
			if(is_infinite($avg_unit_price) || is_nan($avg_unit_price)){$avg_unit_price=0;}
			$ship_mode=$data_array[0][csf('ship_mode')];
			if(is_infinite($ship_mode) || is_nan($ship_mode)){$ship_mode=0;}
			$quotation_id=$data_array[0][csf('quotation_id')];
			if(is_infinite($quotation_id) || is_nan($quotation_id)){$quotation_id=0;}
			$costing_date=$data_array[0][csf('costing_date')];
			if(is_infinite($costing_date) || is_nan($costing_date)){$costing_date=0;}
			$gsm_weights_top=implode(",",array_unique(explode(",",$gsm_weight_top)));
			if(is_infinite($gsm_weights_top) || is_nan($gsm_weights_top)){$gsm_weights_top=0;}
			//$gsm_weight_bottom=implode(",",array_unique(explode(",",$gsm_weight_bottom)));
			//if($gsm_weights_top!='') $gsm_weightTop=$gsm_weights_top;else $gsm_weightTop='';
		
						//echo $gsm_weightTop .$gsm_weightBottom;
				?>
					<tr>
						<td>Knit Fabric Cons</td>
						<td align="right" ><b><? echo $fab_knit_req_kg; ?></b></td>
						<td>Woven Fab. Cons	</td>
						<td align="right" ><b><? echo $fab_woven_req_yds; ?></b></td>
						<td>Quotation Id</td>
						<td><b><? echo $quotation_id; ?></b></td>
						<td>Costing Date</td>
						<td><b><? echo  date('d-M-y',strtotime($costing_date)); ?></b></td>
					</tr>
					<tr>
						<td>Avg Yarn Req</td>
						<td align="right"><b><? echo $fab_yarn_req_kg; ?></b></td>
						<td>Woven Fin Fabric Cons</td>
						<td align="right" ><b><? echo $fab_woven_fin_req_yds; ?></b></td>
					  
						<td>Exchange Rate</td>
						<td align="right" ><b><? echo $exchange_rate; ?></b></td>
						<td>Avg Unit Price</td>
						<td align="right" ><? echo fn_number_format($avg_unit_price,3); ?></td>
					</tr>
					 <tr>
						<td>Knit Fin Fab. Cons </td>
						<td align="right"><b><? echo $fab_knit_fin_req_kg;  ?></b></td>
						<td>Incoterm</td>
						<td><b><? echo $incoterm[$incoterm_id]; ?></b></td>
					  
						<td>Ship Mode</td>
						<td><b><? echo $shipment_mode[$ship_mode]; ?></b></td>
						<td>Cost Per Unit As Budget</td>
						<td align="right"  title="Total Cost<? echo $ttl_total_cost;?>/Total PO Qty Pcs"><? echo fn_number_format($costing_per_unit_budget,3); ?></td>
					</tr>
					<tr style="background:#F9F">
						<td><b> SMV % (As 1st App) : &nbsp;<? echo $sew_smv;?></b></td>
						<td><b> Efficiency %(As 1st App) :&nbsp;<? echo $hissew_effi_percent;?> </b></td>
						<td align="right" colspan="3">Net Pft/Loss %(As 1st App)</td>
						<td align="right" ><b><? echo $opert_profitloss_percent;?></b></td>
						<td title="Total Cost/Total PO Qty">Net Profit/Loss %</td>
						<td align="right" ><b>
						<? 
						$operatin_profit_loss_per=(($avg_unit_price-$costing_per_unit_budget)/$avg_unit_price)*100;
						if(is_infinite($operatin_profit_loss_per) || is_nan($operatin_profit_loss_per)){$operatin_profit_loss_per=0;}
						echo fn_number_format($operatin_profit_loss_per,2);
						 ?>
						</b>
						</td>
					</tr>
				</table>
				
			<?
			
	//$ttl_commercial_cost=$commercial_costing_arr[$job_no];
		//2 Fabric Cost part here------------------------------------------- 	   	
		$sql = "select id, job_no, item_number_id, gsm_weight, uom, body_part_id, fab_nature_id, color_type_id, fabric_description, avg_cons, fabric_source, rate, amount, avg_finish_cons, status_active from wo_pre_cost_fabric_cost_dtls 
			where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
			
		$data_array=sql_select($sql);
		
		$knit_fab="";$woven_fab=""; 
		$knit_subtotal_amount=0;
		$woven_subtotal_amount=0;$knit_subtotal_amount_dzn=0;$knit_subtotal_amount_kg=0;$woven_subtotal_amount_dzn=0;$woven_subtotal_amount_kg=$knit_subtotal_avg_cons_dzn=$knit_subtotal_avg_finish_cons_dzn=0;
		$i=2;$j=2;
		foreach( $data_array as $row )
		{
				$set_item_ratio=return_field_value("set_item_ratio"," wo_po_details_mas_set_details", "job_no='".$row[csf('job_no')]."' and gmts_item_id='".$row[csf('item_number_id')]."'");
			 
			   $fincons=0;
			   $greycons=0;
			   $order_qty_fab=0;
			   $fab_dtls_data=sql_select("select po_break_down_id,color_number_id,gmts_sizes,cons,requirment from wo_pre_cos_fab_co_avg_con_dtls where pre_cost_fabric_cost_dtls_id=".$row[csf("id")]." $txt_po_breack_down_id_cond2 and cons !=0");
			   foreach($fab_dtls_data as $fab_dtls_data_row )
			   {
					 $sql_po_qty_fab=sql_select("select sum(c.plan_cut_qnty) as order_quantity  from wo_po_details_master a, wo_po_break_down b, wo_po_color_size_breakdown c where a.job_no=b.job_no_mst and a.job_no=c.job_no_mst and b.id=c.po_break_down_id and  b.id=".$fab_dtls_data_row[csf('po_break_down_id')]." and c.item_number_id='".$row[csf('item_number_id')]."' and size_number_id='".$fab_dtls_data_row[csf('gmts_sizes')]."' and  color_number_id= '".$fab_dtls_data_row[csf('color_number_id')]."' and a.status_active=1 and a.is_deleted=0 and b.status_active=1 and b.is_deleted=0 and c.status_active=1 and c.is_deleted=0");
					 list($sql_po_qty_row_fab)=$sql_po_qty_fab;
					 $po_qty_fab=$sql_po_qty_row_fab[csf('order_quantity')];
					 $order_qty_fab+=$po_qty_fab;
			   }
			$knit_cost_dzn=$row[csf("amount")];$woven_cost_dzn=$row[csf("amount")];
			if($row[csf("fab_nature_id")]==2)//knit fabrics
			{
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				$fincons=$fabric_qty_arr['knit']['finish'][$row[csf("id")]][$row[csf("uom")]];
				$greycons=$fabric_qty_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$row[csf("amount")]=$fabric_amount_arr['knit']['grey'][$row[csf("id")]][$row[csf("uom")]];
				 $i++;	
				$knit_fab .= '<tr>
					<td align="left">'.$item_descrition.'</td>
					<td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
					<td align="right">'.$row[csf("gsm_weight")].'</td>
					<td align="right">'.fn_number_format($row[csf("avg_cons")],3).'</td>
					<td align="right">'.fn_number_format($greycons,2).'</td>
					 <td align="right">'.fn_number_format($row[csf("avg_finish_cons")],3).'</td>
					<td align="right">'.fn_number_format($fincons,2).'</td>
					<td align="right">'.$unit_of_measurement[$row[csf("uom")]].'</td>
					<td align="right">'.fn_number_format($row[csf("rate")],3).'</td>
					<td align="right">'.fn_number_format($knit_cost_dzn,4).'</td>
					<td align="right">'.fn_number_format($row[csf("amount")],2).'</td> 
					<td align="right">'.fn_number_format((($knit_cost_dzn/$price_dzn)*100),2).'</td> 
				</tr>';	
				$knit_subtotal_avg_cons_dzn+=$row[csf("avg_cons")];
				$knit_subtotal_avg_cons+=$greycons;
				$knit_subtotal_avg_finish_cons+=$fincons;
				$knit_subtotal_avg_finish_cons_dzn+=$row[csf("avg_finish_cons")];
				$knit_subtotal_amount+=$row[csf("amount")];
				$knit_subtotal_amount_dzn+=$knit_cost_dzn;
				$knit_subtotal_amount_kg=$knit_subtotal_amount/$knit_subtotal_amount_dzn;
			}			
			if($row[csf("fab_nature_id")]==3)//woven fabrics
			{
				$fincons=$fabric_qty_arr['woven']['finish'][$row[csf("id")]][$row[csf("uom")]];
				$greycons=$fabric_qty_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$row[csf("amount")]=$fabric_amount_arr['woven']['grey'][$row[csf("id")]][$row[csf("uom")]];
				$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				$j++;
				 $woven_fab .= '<tr>
					<td align="left">'.$item_descrition.'</td>
					<td align="left">'.$fabric_source[$row[csf("fabric_source")]].'</td>
					<td align="center">'.$row[csf("gsm_weight")].'</td>
					<td align="right">'.fn_number_format($row[csf("avg_cons")],3).'</td>
					<td align="right">'.fn_number_format($greycons,2).'</td>
					<td align="right">'.fn_number_format($row[csf("avg_finish_cons")],3).'</td>
					 <td align="right">'.fn_number_format($fincons,2).'</td>
					<td align="right">'.$unit_of_measurement[$row[csf("uom")]].'</td>
					<td align="right">'.fn_number_format($row[csf("rate")],3).'</td>
					<td align="right">'.fn_number_format($woven_cost_dzn,4).'</td>
					<td align="right">'.fn_number_format($row[csf("amount")],2).'</td> 
					<td align="right">'.fn_number_format((($woven_cost_dzn/$price_dzn)*100),2).'</td> 
				</tr>';	
				$woven_subtotal_avg_cons+=$greycons;
				$woven_subtotal_avg_cons_dzn+=$row[csf("avg_cons")];
				$woven_subtotal_avg_finish_cons+=$fincons;
				$woven_subtotal_avg_finish_cons_dzn+=$row[csf("avg_finish_cons")];
				$woven_subtotal_amount+=$row[csf("amount")];
				$woven_subtotal_amount_dzn+=$woven_cost_dzn;
				$woven_subtotal_amount_kg=$woven_subtotal_amount/$woven_subtotal_amount_dzn;
			}
		}	
		
		$knit_fab= '<div style="margin-top:15px">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">		
					
					
					<label  style="float:left;background:#CCCCCC;font-size:larger;"><b>All Fabric Cost </b> </label>	
							
						<tr style="font-weight:bold"  align="center">
							<td width="80" rowspan="'.$i.'" ><div class="verticalText"><b>Knit Fabric</b></div></td>
							<td width="300">Description</td>
							<td width="100">Source</td>
							<td width="50">GSM</td>
							<td width="100">Fab. Cons/'.$costing_for.'</td>
							<td width="100">Gray Fabric Qty</td>
							<td width="100">Finish Cons/ '.$costing_for.'</td>
							<td width="100">Finish Fab Qty</td>
							<td width="50">UOM</td>
							 <td width="50">Rate</td>
							<td width="50">Amount/ '.$costing_for.'</td>
							<td width="50">TTL Amount</td>
							<td width="50">% to Ord. Value</td>
						</tr>'.$knit_fab;
		$woven_fab = '<tr>
						<td width="80" rowspan="'.$j.'"><div class="verticalText"><b>Woven Fabric</b></div></td></tr>'.$woven_fab;	
						
		//knit fabrics table here 
		$KnitFabricTotalParcentToOrdValue =(($knit_subtotal_amount_dzn/$price_dzn)*100);
		if(is_infinite($KnitFabricTotalParcentToOrdValue) || is_nan($KnitFabricTotalParcentToOrdValue)){$KnitFabricTotalParcentToOrdValue=0;}
		$precostData['Total']=$$knit_subtotal_avg_finish_cons;
		$knit_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="3">Knit Total</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_cons_dzn,3).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_cons,2).'</td>
				 
						<td align="right">'.fn_number_format($knit_subtotal_avg_finish_cons_dzn,3).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_finish_cons,2).'</td>
						<td align="right"></td>
						<td align="right"></td>
						<td align="right">'.fn_number_format($knit_subtotal_amount_dzn,4).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_amount,2).'</td>
						<td align="right">'.fn_number_format($KnitFabricTotalParcentToOrdValue,2).'</td> 
					</tr>';
		  echo $knit_fab;
		//woven fabrics table here 
		$WovenFabricTotalParcentToOrdValue=(($woven_subtotal_amount_dzn/$price_dzn)*100);
		if(is_infinite($WovenFabricTotalParcentToOrdValue) || is_nan($WovenFabricTotalParcentToOrdValue)){$WovenFabricTotalParcentToOrdValue=0;}
 
		$fabricTotalParcentToOrdValue=((($knit_subtotal_amount_dzn+$woven_subtotal_amount_dzn)/$price_dzn)*100);
		if(is_infinite($fabricTotalParcentToOrdValue) || is_nan($fabricTotalParcentToOrdValue)){$fabricTotalParcentToOrdValue=0;}
		
		$woven_fab .='<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="3">Woven Total</td>
						<td align="right">'.fn_number_format($woven_subtotal_avg_cons_dzn,3).'</td>
						<td align="right">'.fn_number_format($woven_subtotal_avg_cons,2).'</td>
						<td align="right">'.fn_number_format($woven_subtotal_avg_finish_cons_dzn,3).'</td>
						<td align="right">'.fn_number_format($woven_subtotal_avg_finish_cons,2).'</td>
						<td align="right"></td>
						<td align="right"></td>
						<td align="right">'.fn_number_format($woven_subtotal_amount_dzn,4).'</td>
						<td align="right">'.fn_number_format($woven_subtotal_amount,2).'</td>
						<td align="right">'.fn_number_format($WovenFabricTotalParcentToOrdValue,2).'</td> 
					</tr>
					<tr class="rpt_bottom" style="font-weight:bold">
						<td colspan="3">Fabric Total</td>
						<td align="right"></td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_cons_dzn+$woven_subtotal_avg_cons_dzn,3).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_cons+$woven_subtotal_avg_cons,2).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_avg_finish_cons_dzn+$woven_subtotal_avg_finish_cons_dzn,3).'</td>
						<td align="right">'.fn_number_format($finish_fab_req_qty=$knit_subtotal_avg_finish_cons+$woven_subtotal_avg_finish_cons,2).'</td>
						<td align="right"></td>
						<td align="right"></td>
						<td align="right">'.fn_number_format($knit_subtotal_amount_dzn+$woven_subtotal_amount_dzn,4).'</td>
						<td align="right">'.fn_number_format($knit_subtotal_amount+$woven_subtotal_amount,2).'</td>
						<td align="right">'.fn_number_format($fabricTotalParcentToOrdValue,2).'</td> 
					</tr>
					   </table></div>';
					   
					$precostData['FinishFabQty']=$finish_fab_req_qty;
					$precostData['finish_fab_qty']+=$knit_subtotal_avg_finish_cons+$woven_subtotal_avg_finish_cons;
					$precostData['grey_fab_qty']=$knit_subtotal_avg_cons+$woven_subtotal_avg_cons;
					
 
		   echo $woven_fab;           		
				//end 	All Fabric Cost part report-------------------------------------------
			$lib_yarn_count=return_library_array( "select yarn_count,id from lib_yarn_count", "id", "yarn_count"  );
				 $sql = "select min(id) as id, count_id, copm_one_id, percent_one, copm_two_id, percent_two, color,type_id, min(cons_ratio) as cons_ratio, sum(cons_qnty) as cons_qnty, rate, sum(amount) as amount from wo_pre_cost_fab_yarn_cost_dtls where job_no=".$txt_job_no."  and status_active=1 and is_deleted=0 group by count_id, copm_one_id, percent_one, copm_two_id, percent_two, color,type_id, rate";
				 
				$data_array=sql_select($sql); 
				$yarn_data_array=$yarn->getCountCompositionPercentTypeColorAndRateWiseYarnQtyAndAmountArray();
				//print_r($yarn_data_array);
			
		?>
		<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">
		
			<label  style="float:left;background:#CCCCCC; font-size:larger;"><b>Yarn Cost </b> </label>	
				<tr style="font-weight:bold">
				   
					<td width="350">Yarn Desc</td>
					<td width="80">Yarn Qty/<?=$costing_for; ?></td> 
					<td width="80">TTL Yarn Qty</td>
				 
					<td width="80">Rate</td>
					<td width="80">Amount/<?=$costing_for; ?></td>
					<td width="80">TTL Amount</td>
					<td width="">% to Ord. Value</td>
				</tr>
			<?
			$total_yarn_qty = 0;
			$total_yarn_amount = 0; $total_yarn_cost_dzn=$total_yarn_qty_dzn=0; $total_yarn_cost_kg=0; $total_yarn_avg_cons_qty=0;
			foreach( $data_array as $row )
			{ 
				if($row[csf("percent_one")]==100)
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
				else
					$item_descrition = $lib_yarn_count[$row[csf("count_id")]]." ".$composition[$row[csf("copm_one_id")]]." ".$row[csf("percent_one")]."% ".$composition[$row[csf("copm_two_id")]]." ".$row[csf("percent_two")]."% ".$color_library[$row[csf("color")]]." ".$yarn_type[$row[csf("type_id")]];
				 $rowcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
				$rowavgcons_qnty = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['qty'];
				$rowamount = $yarn_data_array[$row[csf("count_id")]][$row[csf("copm_one_id")]][$row[csf("percent_one")]][$row[csf("type_id")]][$row[csf("color")]][$row[csf("rate")]]['amount'];
				if(is_infinite($rowamount) || is_nan($rowamount)){$rowamount=0;}
			?>	 
				<tr>
					<td align="left"><? echo $item_descrition; ?></td>
					<td align="right"><? echo fn_number_format($row[csf("cons_qnty")],3); ?></td>
					<td align="right"><? echo fn_number_format($rowcons_qnty,2); ?></td>
				   
					<td align="right"><? echo fn_number_format($row[csf("rate")],3); ?></td>
					<td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
					<td align="right"><? echo fn_number_format($rowamount,2); ?></td>
					<td align="right"><? 
					$cv=($row[csf("amount")]/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					?></td>
				</tr>
			<?  
				  $total_yarn_qty+=$rowcons_qnty;
				  $total_yarn_qty_dzn+=$row[csf("cons_qnty")];
				  $total_avg_yarn_qty+=$rowavgcons_qnty;
				  $total_yarn_amount +=$rowamount;
				  $total_yarn_cost_dzn+=$row[csf("amount")];
				  $total_yarn_avg_cons_qty+=$rowavgcons_qnty;
				  $total_yarn_cost_kg=$total_yarn_amount/$total_yarn_qty;
				  if(is_infinite($total_yarn_cost_kg) || is_nan($total_yarn_cost_kg)){$total_yarn_cost_kg=0;}
			}
			?>
				<tr class="rpt_bottom" style="font-weight:bold">
					<td>Yarn Total</td>
					<td align="right"><? echo fn_number_format($total_yarn_qty_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($total_yarn_qty,2); ?></td>
					
					<td></td>
					<td align="right"><? echo fn_number_format($total_yarn_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($total_yarn_amount,2); ?></td>
					<td align="right"><? 
					$cv=($total_yarn_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($total_yarn_cost_dzn/$price_dzn)*100,2); 
					?></td>
				</tr>
			</table>
	  </div>
	  <?
		//End Yarn Cost part report here -------------------------------------------
		
		//start	Conversion Cost to Fabric report here -------------------------------------------
		$sql_count = "select a.cons_process as cons_process from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id and b.status_active=1 and b.is_deleted=0 where a.job_no=".$txt_job_no." and a.status_active=1 and a.is_deleted=0 group by a.cons_process order by  a.cons_process";
		$tot_data_array=sql_select($sql_count);
		foreach( $tot_data_array as $row ){
				 $process_id=$row[csf("cons_process")];
				 $process_row+=count($row[csf("cons_process")]);
		 }
		 $sql = "select a.id,a.fabric_description as pre_cost_fabric_cost_dtls_id, a.job_no, a.cons_process, a.req_qnty, a.charge_unit,a.amount,a.color_break_down, a.status_active,b.body_part_id,b.uom ,b.fab_nature_id,b.color_type_id,b.fabric_description,b.item_number_id from wo_pre_cost_fab_conv_cost_dtls a left join wo_pre_cost_fabric_cost_dtls b on a.job_no=b.job_no and a.fabric_description=b.id and b.status_active=1 and b.is_deleted=0 where a.job_no=".$txt_job_no." and a.status_active=1 and a.is_deleted=0 order by  a.cons_process";
		 $data_array=sql_select($sql);
	 ?>
		<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">
			
			<label style="float:left;background:#CCCCCC; font-size:larger"><b>Conversion Cost to Fabric </b> </label>	
				<tr style="font-weight:bold; font-size:12px">
					<td width="230">Particulars</td>
					<td width="110">Process</td>
					<td width="60">Cons/<?=$costing_for; ?></td>
					<td width="80">TTL Required</td>
					<td width="60">Uom</td>
				   
					<td width="60">Rate</td>
					<td width="60">Rate(Tk)</td>
					<td width="70">Amount/<?=$costing_for; ?></td>
					<td width="80">TTL Amount</td>
					<td>% to Ord. Value</td>
				</tr>
			<?
			$conv_data_qty=$conversion->getQtyArray_by_conversionid();
			$conv_data_amt=$conversion->getAmountArray_by_conversionid();
	
			$total_conversion_cost=$total_convsion_qty_dzn=$total_conversion_cost_dzn=0;$total_conversion_cost_dzn=0;$total_conversion_cost_kg=0;
			$total_convsion_qty=0;
			$total_avg_convsion_qty=0;$grand_total_conv_qnty=0;$grand_total_avg_convsion_qty=$grand_total_conversion_cost_dzn=$grand_total_avg_convsion_qty_dzn=0;$grand_total_conversion_cost=0;
			$process_array_check=array();$k=1;
			foreach( $data_array as $row )
			{ 
				$convsion_qty=$conv_data_qty[$row[csf('id')]][$row[csf('uom')]];
				$conversion_cost=$conv_data_amt[$row[csf('id')]][$row[csf('uom')]];
				
				if($row[csf("pre_cost_fabric_cost_dtls_id")] ==0) $item_descrition = "All Fabrics";
				else
				{
					$item_descrition = $body_part[$row[csf("body_part_id")]].", ".$color_type[$row[csf("color_type_id")]].", ".$row[csf("fabric_description")];
				}
				
				$process_id=$row[csf("cons_process")];
				if (!in_array($process_id,$process_array_check) )
				{
					if($k!=1)
					{
						?>
					   <tr>
							<td>&nbsp;</td>
							<td><strong>Process Total </strong></td>
							<td align="right"><strong><? echo fn_number_format($total_convsion_qty_dzn,3); ?></strong></td>
							<td align="right"><strong><? echo fn_number_format($total_convsion_qty,2); $precostData['knitting_day'][$process_id]=$total_convsion_qty;?></strong></td>
							<td align="right"><strong><? //echo fn_number_format($total_convsion_qty,4); ?></strong></td>
							<td>&nbsp;</td>
							<td>&nbsp;</td>
							<td align="right"><strong><? echo fn_number_format($total_conversion_cost_dzn,3); ?></strong></td>
							<td align="right"><strong><? echo fn_number_format($total_conversion_cost,2); ?></strong></td>
							<td align="right"><? 
							$cv=($total_conversion_cost_dzn/$price_dzn)*100;
							if(is_infinite($cv) || is_nan($cv)){$cv=0;}
							echo fn_number_format($cv,3); 
							//echo fn_number_format(($total_conversion_cost_dzn/$price_dzn)*100,3); 
							
							?></td>
						</tr>
						<?
					}
					?>
					<?
					unset($total_convsion_qty_dzn);unset($total_conversion_cost_dzn);
					unset($total_convsion_qty);
					unset($total_avg_convsion_qty);
					unset($total_conversion_cost);
					unset($total_convsion_qty_dzn);
					$process_array_check[]=$process_id; 
					$k++;    
				}
			?>	 
				<tr>
					<td align="left" style="font-size:14px; word-break:break-all"><? echo $item_descrition; ?></td>
					<td align="left"><? echo $conversion_cost_head_array[$row[csf("cons_process")]]; ?></td>
					<td align="right"><? echo fn_number_format($row[csf("req_qnty")],3); ?></td>
					<td align="right"><? echo fn_number_format($convsion_qty,2); ?></td>
					<td align="right"><? echo  $unit_of_measurement[$row[csf('uom')]]; ?></td>
				  
					<td align="right"><? echo fn_number_format($row[csf("charge_unit")],3); ?></td>
					<td align="right"><? echo fn_number_format($row[csf("charge_unit")]*$exchange_rate,3); ?></td>
					
					<td align="right"><? echo fn_number_format($row[csf('amount')],4); ?></td>
					<td align="right"><? echo fn_number_format($conversion_cost,2); ?></td>
					<td align="right" title="<? echo $row[csf('amount')].'='.$price_dzn;?>">
					<? 
					$cv=($row[csf('amount')]/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($row[csf('amount')]/$price_dzn)*100,2); 
					?>
					</td>
				</tr>
			<?
				$total_convsion_qty+=$convsion_qty;
				$total_convsion_qty_dzn+=$row[csf("req_qnty")];
				$total_avg_convsion_qty+=$row[csf("req_qnty")];
				$total_conversion_cost += $conversion_cost;
			//	$total_conversion_cost_dzn += $row[csf('amount')];
				$grand_total_conv_qnty+=$convsion_qty;
				$grand_total_avg_convsion_qty+=$convsion_qty;
				$grand_total_avg_convsion_qty_dzn+=$row[csf("req_qnty")];
				$grand_total_conversion_cost+= $conversion_cost;
				$grand_total_conversion_cost_dzn+= $row[csf('amount')];
				$total_conversion_cost_dzn+=$row[csf('amount')];
				$total_conversion_cost_kg=$grand_total_conversion_cost/$total_avg_yarn_qty;
				if(is_infinite($total_conversion_cost_kg) || is_nan($total_conversion_cost_kg)){$total_conversion_cost_kg=0;}
				//$grand_total_avg_convsion_qty;
				}
			?>
			<tr class="rpt_bottom" style="font-weight:bold">
				<td>&nbsp;</td>
				<td align="right">Process Total</td>
				<td align="right"><? echo fn_number_format($total_convsion_qty_dzn,3); ?></td>
				 <td align="right"><? echo fn_number_format($total_convsion_qty,2); ?></td>
				 <td align="right"><? //echo fn_number_format($total_convsion_qty,4); ?></td>
				<td>&nbsp;</td>
				<td>&nbsp;</td> 
				<td align="right"><? echo fn_number_format($total_conversion_cost_dzn,4); ?></td>                   
				<td align="right"><? echo fn_number_format($total_conversion_cost,2); ?></td>
				<td align="right"><? 
					$cv=($total_conversion_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
				//echo fn_number_format(($total_conversion_cost_dzn/$price_dzn)*100,2); 
				
				?></td>
			</tr>   
			<tr class="rpt_bottom" style="font-weight:bold">
				<td colspan="2" align="right">Conversion Total</td>
				<td align="right"><? echo fn_number_format($grand_total_avg_convsion_qty_dzn,3); ?></td>
				<td align="right"><? echo fn_number_format($grand_total_conv_qnty,2); ?></td>
				<td align="right"><? //echo fn_number_format($grand_total_conv_qnty,4); ?></td>
				<td>&nbsp;</td>
				<td>&nbsp;</td> 
				<td align="right"><? echo fn_number_format($grand_total_conversion_cost_dzn,4); ?></td>                
				<td align="right"><? echo fn_number_format($grand_total_conversion_cost,2); ?></td>
				<td align="right"  title="<? echo $grand_total_conversion_cost_dzn.'='.$price_dzn;?>">
				<? 
					$cv=($grand_total_conversion_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
				//echo fn_number_format(($grand_total_conversion_cost_dzn/$price_dzn)*100,3); 
				?>
				</td>
			</tr>     
			  <tr class="rpt_bottom" style="font-weight:bold">
				  <td>Total Fabric Cost</td>
				<td align="right" colspan="6" style="background:#F9F">Previous Fabric cost % (As 1st Approval) : <? echo fn_number_format($fabric_cost_percent,4); ?> </td>
				<td align="right" title="Fabric Cost+Yarn+Conversion(Dzn)"><? $total_fab_cost_dzn=$knit_subtotal_amount_dzn+$woven_subtotal_amount_dzn+$total_yarn_cost_dzn+$grand_total_conversion_cost_dzn;echo fn_number_format($total_fab_cost_dzn,4); ?></td>
				<td align="right"><? $all_fab_cost=$knit_subtotal_amount+$woven_subtotal_amount+$total_yarn_amount+$grand_total_conversion_cost; echo fn_number_format($all_fab_cost,2); ?></td>
				<td align="right"><? 
					$cv=($total_fab_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
				//echo fn_number_format(($total_fab_cost_dzn/$price_dzn)*100,2); 
				?></td>
			  </tr>           
			</table>
	  </div>
	  <?
	//End Conversion Cost to Fabric report here -------------------------------------------
	
	
	
	//start	Trims Cost part report here -------------------------------------------
	$supplier_library_fabric=return_library_array( "select a.id, a.supplier_name from lib_supplier a where a.is_deleted=0  and a.status_active=1 group by a.id,a.supplier_name order by a.supplier_name", "id", "supplier_name");
	
		$sql = "select id, job_no, trim_group,description,brand_sup_ref, cons_uom, cons_dzn_gmts, rate, amount, apvl_req, nominated_supp_multi, status_active from wo_pre_cost_trim_cost_dtls  where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
		$data_array=sql_select($sql);
	 ?>
		<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">
		   
			<label  style="float:left;background:#CCCCCC; font-size:larger"><b>Trims Cost</b> </label>	
				<tr style="font-weight:bold">
					<td width="110">Item Group</td>
					<td width="150">Description</td>
					<td width="100">Nominated Supp</td>
					<td width="100">Brand/Supp Ref</td>
					<td width="60">UOM</td>
					<td width="80">Cons/<?=$costing_for; ?></td>
					<td width="100">TTL Required</td>
					<td width="80">Rate</td>
					<td width="80">Amount/<?=$costing_for; ?></td>
					<td width="80">Amount</td>
					<td width="60">% to Ord. Value</td>
				</tr>
			<?
			$trim_qty_arr=$trims->getQtyArray_by_precostdtlsid();
			//print_r($trim_qty);
			$trim_amount_arr=$trims->getAmountArray_precostdtlsid();
			$total_trims_cost=0;  $total_trims_qty=$total_trims_cost_dzn=0;$total_trims_cost_dzn=0;$total_trims_cost_kg=0;
			foreach( $data_array as $row ){ 
				
				$trim_group=return_library_array( "select item_name,id from  lib_item_group where id=".$row[csf("trim_group")], "id", "item_name" ); 
				$cons_dzn_gmts= $row[csf("cons_dzn_gmts")];
				$amount_dzn= $row[csf("amount")];
				$pre_trims_qty=$trim_qty_arr[$row[csf("id")]];
				$pre_trims_amount=$trim_amount_arr[$row[csf("id")]];  
				
				$nominated_supp_str="";
				$exsupp=explode(",",$row[csf("nominated_supp_multi")]);
				foreach($exsupp as $sid)
				{
					if($nominated_supp_str=="") $nominated_supp_str=$supplier_library_fabric[$sid]; else $nominated_supp_str.=','.$supplier_library_fabric[$sid];
				}         	 
			?>	 
				<tr>
					<td align="left"><? echo $trim_group[$row[csf("trim_group")]]; ?></td>
					<td align="left"><? echo $row[csf("description")]; ?></td>
					<td align="left"><?=$nominated_supp_str; ?></td>
					<td align="left"><? echo $row[csf("brand_sup_ref")]; ?></td>
					<td align="left"><? echo $unit_of_measurement[$row[csf("cons_uom")]]; ?></td>
					<td align="right"><? echo fn_number_format($cons_dzn_gmts,3); ?></td>
					<td align="right"><? echo fn_number_format($pre_trims_qty,4); ?></td>
					<td align="right"><? echo fn_number_format($row[csf("rate")],3); ?></td>
					 <td align="right"><? echo fn_number_format($amount_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($pre_trims_amount,2); ?></td>
					<td align="right"  title="<? echo $amount_dzn.'='.$price_dzn;?>">
					<? 
					$cv=($amount_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($amount_dzn/$price_dzn)*100,2); 
					?></td>
				</tr>
			<?
				 $total_trims_cost += $pre_trims_amount;
				 $total_trims_cost_dzn += $amount_dzn;
				  $total_trims_qty += $pre_trims_qty;
			}
			?>
				<tr class="rpt_bottom" style="font-weight:bold" >
					<td>Trims Total</td>
					<td colspan="5" style="background:#F9F">Previous Trims cost % (As 1st Approval)=<? echo fn_number_format($trims_cost_percent,4);?></td>
					<td align="right"><? echo fn_number_format($total_trims_qty,4); ?></td>
					<td align="right"><? //echo fn_number_format($total_trims_cost_dzn,4); ?></td>                   
					
					<td align="right"><? echo fn_number_format($total_trims_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($total_trims_cost,2); ?></td>
					<td align="right" title="<? echo $total_trims_cost_dzn.'='.$price_dzn;?>">
					<? 
					$cv=($total_trims_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($total_trims_cost_dzn/$price_dzn)*100,2); 
					?>
					</td>
				</tr>                
			</table>
	  </div>
	  <?
	 //End Trims Cost Part report here -------------------------------------------	
	 
	 //start	Embellishment Details part report here -------------------------------------------
	 
		$sql = "select id, job_no, emb_name, emb_type, cons_dzn_gmts, rate, amount,status_active from wo_pre_cost_embe_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
		$data_array=sql_select($sql);
	?> 
		<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">
		 
			<label  style="float:left;background:#CCCCCC; font-size:larger"><b>Embellishment Cost</b> </label>	
				<tr style="font-weight:bold">
					<td width="170">Particulars</td>
					<td width="170">Type</td>
					<td width="100">Cons/<?=$costing_for; ?></td>
					<td width="120">TTL Gmts. Qty</td>
					<td width="80">Rate</td>
					<td width="100">Amount/<?=$costing_for; ?></td>
					<td width="120">TTL Amount</td>
					<td width="100">% to Ord. Value</td>
				 </tr>
			<?
			//echo $emblishment->getQuery(); die;
			$emblishment_qty_arr=$emblishment->getQtyArray_by_jobAndEmblishmentid();
			 
			$emblishment_amount_arr=$emblishment->getAmountArray_by_jobAndEmblishmentid();
			$wash_qty_arr=$wash->getQtyArray_by_jobAndEmblishmentid();
			$wash_amount_arr=$wash->getAmountArray_by_jobAndEmblishmentid();
			$cost_per_qty_arr=$condition->getCostingPerArr();
			
			
			$total_embellishment_amt=0;$total_embellishment_amt_dzn=0;  
			foreach( $data_array as $row )
			{
				$em_type =""; 
				//$total_embellishment_amt_dzn += $row[csf("amount")];
				//$emblishment_name_array=array(1=>"Printing",2=>"Embroidery",3=>"Wash",4=>"Special Works",5=>"Others");
				$cost_per_qty=$cost_per_qty_arr[$row[csf("job_no")]];
				 if($row[csf("emb_name")]==1)$em_type = $emblishment_print_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==2)$em_type = $emblishment_embroy_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==3)$em_type = $emblishment_wash_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==4)$em_type = $emblishment_spwork_type[$row[csf("emb_type")]];
				else if($row[csf("emb_name")]==5)$em_type = $emblishment_gmts_type[$row[csf("emb_type")]];
				//$row[csf("cons_dzn_gmts")] = $row[csf("cons_dzn_gmts")]/$order_price_per_dzn*$order_job_qnty;
				//$row[csf("amount")] = $row[csf("amount")]/$order_price_per_dzn*$order_job_qnty;
				if($row[csf("emb_name")] !=3){
					$embl_cons_gmts=$emblishment_qty_arr[$row[csf("job_no")]][$row[csf("id")]];
					$embl_amount=$emblishment_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
				}
				else if($row[csf("emb_name")] ==3){
					$embl_cons_gmts=$wash_qty_arr[$row[csf("job_no")]][$row[csf("id")]];
					$embl_amount=$wash_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
				}
				$embl_cons_gmts=$embl_cons_gmts;//(($embl_cons_gmts*$cost_per_qty)/$tot_plan_cut_qty)*$set_ratio;//
				$row[csf("amount")]=($row[csf("amount")]/$cost_per_qty)*$set_ratio;//*$set_ratio
				if(is_infinite($row[csf("amount")]) || is_nan($row[csf("amount")])){$row[csf("amount")]=0;}
				
				$embl_amt=$row[csf("cons_dzn_gmts")]*$row[csf("rate")];
			?>	 
				<tr>
					<td align="left"><? echo $emblishment_name_array[$row[csf("emb_name")]]; ?></td>
					<td align="left"><? echo $em_type; ?></td>
					<td align="right"><? echo fn_number_format($row[csf("cons_dzn_gmts")],3); ?></td>
					<td align="right"><? echo fn_number_format($embl_cons_gmts,0); ?></td>
					<td align="right"><? echo fn_number_format($row[csf("rate")],3); ?></td>
					<td align="right"><? echo fn_number_format($embl_amt,4); ?></td>
					<td align="right"><? echo fn_number_format($embl_amount,2); ?></td>
					<td align="right" title="<? echo $embl_amt.'='.$price_dzn;?>">
					<?
					$cv=($embl_amt/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($row[csf("amount")]/$price_dzn)*100,2); 
					?>
					</td>
				</tr>
			<?
				 $total_embellishment_amt += $embl_amount;
				 $total_embellishment_amt_dzn += $embl_amt;
				 $total_embellishment_qty += $embl_cons_gmts;
				  $total_embellishment_qty_dzn += $row[csf("cons_dzn_gmts")];
			}
			?>
				<tr class="rpt_bottom" style="font-weight:bold">
					<td>Embellishment Total</td> 
					<td colspan="2"  style="background:#F9F">Previous Embel.cost % (As 1st Approval)=<? echo fn_number_format($embel_cost_percent,4);?></td>                    
					<td align="right"><? echo fn_number_format($total_embellishment_qty,0); ?></td>
					<td align="right"><? //echo fn_number_format($total_embellishment_qty,4); ?></td>
					<td align="right"><? echo fn_number_format($total_embellishment_amt_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($total_embellishment_amt,2); ?></td>
					<td align="right" title="<? echo $total_embellishment_amt_dzn.'='.$price_dzn;?>">
					<? 
					$cv=($total_embellishment_amt_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($total_embellishment_amt_dzn/$price_dzn)*100,2); 
					?></td>
				</tr>                
			</table>
	  </div>
	  <?
	 //End Embellishment Details Part report here -------------------------------------------	
	 //start	Commercial Cost part report here -------------------------------------------
	   $sql = "select id, job_no, item_id, rate, amount, status_active from  wo_pre_cost_comarci_cost_dtls  where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	?> 
		<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">
		   
			<label  style="float:left;background:#CCCCCC; font-size:larger"><b>Commercial Cost</b> </label>	
 
				<tr style="font-weight:bold">
					<td width="250">Particulars</td>
					
					<td width="200">Rate In %</td>
					<td width="100">Amount/<?=$costing_for; ?></td>
					<td width="100">TTL Amount</td>
					<td width="100">% to Ord. Value</td>
				 </tr>
			<?
			$commarcial_amount=$commercial->getAmountArray_by_jobAndPrecostdtlsid();
			$total_commercial_cost=0;$total_commercial_cost_dzn=0;
			foreach( $data_array as $row )
			{ 
				//$total_commercial_cost_dzn+= $row[csf("amount")];
				$amount = $commarcial_amount[$row[csf("job_no")]][$row[csf("id")]];
				if(is_infinite($amount) || is_nan($amount)){$amount=0;}
			  ?>	 
				<tr>
					<td align="left"><? echo $camarcial_items[$row[csf("item_id")]]; ?></td>
					<td align="right"><? echo fn_number_format($row[csf("rate")],3); ?></td>
					<td align="right"><? echo fn_number_format($row[csf("amount")],4); ?></td>
					<td align="right"><? echo fn_number_format($amount,2); ?></td>
					<td align="right"  title="<? echo $$row[csf("amount")].'='.$price_dzn;?>">
					<? 
					$cv=($row[csf("amount")]/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($row[csf("amount")]/$price_dzn)*100,2); 
					?>
					</td>
				</tr>
			<?
				 $total_commercial_cost_dzn += $row[csf("amount")];
				  $total_commercial_cost += $amount;
			}
			?>
				<tr class="rpt_bottom" style="font-weight:bold">
					<td>Commercial Total</td>                    
					<td align="right"  style="background:#F9F">Previous Commercial % (As 1st Approval)=<?  echo fn_number_format($comm_cost_percent,4); ?></td>
					<td align="right"><? echo fn_number_format($total_commercial_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($total_commercial_cost,2); ?></td>
					<td align="right" title="<? echo $total_commercial_cost_dzn.'='.$price_dzn;?>">
					<?
					$cv=(($total_commercial_cost_dzn/$price_dzn)*100);
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format((($total_commercial_cost_dzn/$price_dzn)*100),2); 
					?>
					</td>
				</tr>                
			</table>
	  </div>
	  <?
	 //End Commercial Cost Part report here -------------------------------------------	
  
	  //start	Commission Cost part report here -------------------------------------------
	   $sql = "select id,job_no,particulars_id,commission_base_id,commision_rate,commission_amount, status_active from  wo_pre_cost_commiss_cost_dtls  where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	?> 
		<div style="margin-top:15px">
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:970px;text-align:center;" rules="all">
		  
			<label  style="float:left;background:#CCCCCC; font-size:larger"><b>Commission Cost</b> </label>	
				<tr style="font-weight:bold">
					<td width="250">Particulars</td>
					<td width="250">Commission Basis</td>
					<td width="100">Rate</td>
					<td width="100">Amount/<?=$costing_for; ?></td>
					<td width="100">TTL Amount</td>
					<td width="100">% to Ord. Value</td>
				 </tr>
			<?
			$commission_amount_arr=$commission->getAmountArray_by_jobAndPrecostdtlsid();
			$total_commission_cost=0;   $total_commission_cost_dzn=0;
			foreach( $data_array as $row )
			{ 
				$commission_amount = $commission_amount_arr[$row[csf("job_no")]][$row[csf("id")]];
				if(is_infinite($commission_amount) || is_nan($commission_amount)){$commission_amount=0;}
			  ?>	 
				<tr>
					<td align="left"><? echo $commission_particulars[$row[csf("particulars_id")]]; ?></td>
					<td align="left"><? echo $commission_base_array[$row[csf("commission_base_id")]]; ?></td>
					<td align="right"><? echo fn_number_format($row[csf("commision_rate")],3); ?></td>
					 <td align="right"><? echo fn_number_format($row[csf("commission_amount")],4); ?></td>
					<td align="right"><? echo fn_number_format($commission_amount,2); ?></td>
					<td align="right" title="<? echo $row[csf("commission_amount")].'='.$price_dzn;?>">
					<? 
					$cv=($row[csf("commission_amount")]/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($row[csf("commission_amount")]/$price_dzn)*100,2); 
					?>
					</td>
				</tr>
			<?
				 $total_commission_cost += $commission_amount;
				 $total_commission_cost_dzn+=$row[csf("commission_amount")];
				// $total_commission_cost_dzn+=$row[csf("commission_amount")];
			}
			?>
				<tr class="rpt_bottom" style="font-weight:bold">
					<td>Commission Total</td>
					<td colspan="2"  style="background:#F9F">Previous Commission % (As 1st Approval)=<? echo fn_number_format($commission_percent,4);?></td>                    
					<td align="right"><? echo fn_number_format($total_commission_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($total_commission_cost,2); ?></td>
					<td align="right"><? 
					 //echo fn_number_format(($total_commission_cost_dzn/$price_dzn)*100,2); 
					
					?></td>
				</tr>                
			</table>
	  </div>
		<br/>
		  <?
	//start	Other Components part report here -------------------------------------------
	   $sql = "select id,job_no,costing_per_id,order_uom_id,fabric_cost,fabric_cost_percent,trims_cost,depr_amor_pre_cost,deffdlc_cost,studio_cost,design_cost,trims_cost_percent,embel_cost,embel_cost_percent,comm_cost,comm_cost_percent,commission,incometax_cost,interest_cost,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,common_oh,common_oh_percent,design_percent,studio_percent,currier_pre_cost, currier_percent,certificate_pre_cost, certificate_percent, total_cost, total_cost_percent, price_dzn, price_dzn_percent, margin_dzn, margin_dzn_percent, price_pcs_or_set, price_pcs_or_set_percent, margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche  from wo_pre_cost_dtls where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
	$data_array=sql_select($sql);
	?> 
		 <div style="margin-top:15px">
		 <table>
		 <tr>
		 <td>
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:620px;text-align:center;" rules="all">
			
			<label  style="background:#CCCCCC; font-size:larger"><b style="float:left;background:#CCCCCC;">Others Cost</b> </label>	
				<tr style="font-weight:bold">
					<td width="220">Particulars</td>
					<td width="100"> Cost/<?=$costing_for; ?> (As 1st Approval)</td>
					<td width="100">Amount/<?=$costing_for; ?></td>
					<td width="100">TTL Amount</td>
					<td width="100">% to Ord. Value</td>
				 </tr>
			<?
			$total_other_components=0; $lab_test_dzn=$interest_cost=$incometax_cost=0; $lab_test = 0; $inspection = 0; $cm_cost = 0; $freight = 0; $common_oh = 0; $price_dzn=0;
		   foreach( $data_array as $row )
		   { 
				$job_no=$row[csf("job_no")];
				$cm_cost=$other_costing_arr[$row[csf("job_no")]]['cm_cost'];
				$freight_cost=$other_costing_arr[$job_no]['freight'];
				$inspection_cost=$other_costing_arr[$job_no]['inspection'];
				$certificate_cost=$other_costing_arr[$job_no]['certificate_pre_cost'];
				$common_oh=$other_costing_arr[$job_no]['common_oh'];
				$currier_cost=$other_costing_arr[$job_no]['currier_pre_cost'];
				$lab_test_cost=$other_costing_arr[$job_no]['lab_test'];
				$depr_amor_pre_cost=$other_costing_arr[$job_no]['depr_amor_pre_cost'];
				$deffdlc_cost=$other_costing_arr[$job_no]['deffdlc_cost'];
				$studio_cost=$other_costing_arr[$job_no]['studio_cost'];
				$design_cost=$other_costing_arr[$job_no]['design_cost']; 
				$interest_cost=$other_costing_arr[$job_no]['interest_cost'];
				$incometax_cost=$other_costing_arr[$job_no]['incometax_cost'];
				$price_dzn=$row[csf("price_dzn")];
				//$freight = $freight_cost;
				//$common_oh = $common_oh;
				//$currier_pre_cost = $currier_cost;
				//$certificate_pre_cost = $certificate_cost;
				$lab_test_dzn=$row[csf("lab_test")];
				$inspection_dzn=$row[csf("inspection")];
				$cm_cost_dzn =$row[csf("cm_cost")];
				$common_oh_dzn =$row[csf("common_oh")];
				$freight_dzn =$row[csf("freight")];
				$currier_pre_cost_dzn = $row[csf("currier_pre_cost")];
				$certificate_pre_cost_dzn = $row[csf("certificate_pre_cost")];
				$deffdlc_cost_dzn = $row[csf("deffdlc_cost")];
				$depr_amor_pre_cost_dzn = $row[csf("depr_amor_pre_cost")];
				$interest_cost_dzn=$row[csf("interest_cost")];
				$incometax_cost_dzn=$row[csf("incometax_cost")];
				$studio_cost_dzn=$row[csf("studio_cost")];
				$design_cost_dzn=$row[csf("design_cost")];
 
				
				$studio_cost_percent=$row[csf("studio_percent")];
				$design_cost_percent=$row[csf("design_percent")];
			   ?>	 
				<tr>
					<td align="left">Lab Test </td>
					<td align="right"  style="background:#F9F"><? echo fn_number_format($lab_test_percent,3); ?></td>
					<td align="right"><? echo fn_number_format($lab_test_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($lab_test_cost,2); ?></td>
					<td align="right"  title="<? echo $lab_test_dzn.'='.$price_dzn;?>">
					<? 
					$cv=($lab_test_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($lab_test_dzn/$price_dzn)*100,2); 
					
					?></td>
				</tr>
				<tr>
					<td align="left">Inspection Cost</td>
					<td align="right"  style="background:#F9F"><? echo fn_number_format($inspection_percent,3); ?></td>
					<td align="right"><? echo fn_number_format($inspection_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($inspection_cost,2); ?></td>
					<td align="right" title="<? echo $inspection_dzn.'='.$price_dzn;?>">
					<? 
					$cv=($inspection_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($inspection_dzn/$price_dzn)*100,2);
					 ?></td>
				</tr>
				<tr>
					<td align="left">CM Cost</td>
					<td align="right"  style="background:#F9F"><? echo fn_number_format($cm_cost_percent,3); ?></td>
					<td align="right"><? echo fn_number_format($cm_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($cm_cost,2); ?></td>
					<td align="right"><? 
					$cv=($cm_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($cm_cost_dzn/$price_dzn)*100,2); ?></td>
				</tr>
				
				 <tr>
					<td align="left">Gmts Freight Cost</td>
					<td align="right"  style="background:#F9F"><? echo fn_number_format($freight_percent,3); ?></td>
					<td align="right"><? echo fn_number_format($freight_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($freight_cost,2); ?></td>
					<td align="right"><? 
					$cv=($freight_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($freight_dzn/$price_dzn)*100,2); ?></td>
				</tr>
				 <tr>
					<td align="left">Currier Cost </td>
					<td align="right"  style="background:#F9F"><? echo fn_number_format($currier_percent,3); ?></td>
					<td align="right"><? echo fn_number_format($currier_pre_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($currier_cost,2); ?></td>
					<td align="right"><? 
					$cv=($currier_pre_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($currier_pre_cost_dzn/$price_dzn)*100,2); ?></td>
				</tr>
				 <tr>
					<td align="left">Certificate Cost </td>
					<td align="right"  style="background:#F9F"><? echo fn_number_format($certificate_percent,3); ?></td>
					<td align="right"><? echo fn_number_format($certificate_pre_cost_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($certificate_cost,2); ?></td>
					<td align="right"><? 
					$cv=($certificate_pre_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($certificate_pre_cost_dzn/$price_dzn)*100,2); ?></td>
				</tr>
				<tr>
					<td align="left">Deffd. LC Cost </td>
					<td align="right"  style="background:#F9F"><? $deffdlc_cost_percent=0; echo fn_number_format($deffdlc_cost_percent,3); ?></td>
					 <td align="right"><? echo fn_number_format($deffdlc_cost_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($deffdlc_cost,2); ?></td>
					 <td align="right"><? 
					$cv=($deffdlc_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					 //echo fn_number_format(($deffdlc_cost_dzn/$price_dzn)*100,2); ?></td>
				</tr>
				<tr>
					<td align="left">Studio Cost </td>
					<td align="right"  style="background:#F9F"><? $studio_cost_percent=0; echo fn_number_format($studio_cost_percent,3); ?></td>
					 <td align="right"><? echo fn_number_format($studio_cost_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($studio_cost,2); ?></td>
					 <td align="right"><? 
					$cv=($studio_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					 //echo fn_number_format(($deffdlc_cost_dzn/$price_dzn)*100,2); ?></td>
				</tr>
				<tr>
					<td align="left">Design  Cost </td>
					<td align="right"  style="background:#F9F"><? $design_cost_percent=0; echo fn_number_format($design_cost_percent,3); ?></td>
					 <td align="right"><? echo fn_number_format($design_cost_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($design_cost,2); ?></td>
					 <td align="right"><? 
					$cv=($design_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					 //echo fn_number_format(($deffdlc_cost_dzn/$price_dzn)*100,2); ?></td>
				</tr>
				 <tr>
					<td align="left">Interest </td>
					<td align="right"  style="background:#F9F"><? echo fn_number_format($interest_cost,3); ?></td>
					<td align="right"><? echo fn_number_format($interest_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($interest_cost,2); ?></td>
					<td align="right"><? 
					$cv=($interest_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($interest_cost_dzn/$price_dzn)*100,2); ?></td>
				</tr>
				 <tr>
					<td align="left">Income Tax </td>
					<td align="right"  style="background:#F9F"><? echo fn_number_format($incometax_cost,3); ?></td>
					<td align="right"><? echo fn_number_format($incometax_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($incometax_cost,2); ?></td>
					<td align="right"><? 
					$cv=($incometax_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($incometax_cost_dzn/$price_dzn)*100,2); ?></td>
				</tr>
				<tr>
					<td align="left">Operating Expensees</td>
					<td align="right"  style="background:#F9F"><? echo fn_number_format($common_oh_percent,3); ?></td>
					<td align="right"><? echo fn_number_format($common_oh_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($common_oh,2); ?></td>
					<td align="right"><? 
					$cv=($common_oh_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($common_oh_dzn/$price_dzn)*100,2); ?></td>
				</tr>
				 <tr>
					<td align="left">Depreciation & Amortization </td>
					<td align="right"><? //echo fn_number_format($common_oh,4); ?></td>
					<td align="right"><? echo fn_number_format($depr_amor_pre_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($depr_amor_pre_cost,2); ?></td>
					<td align="right"><? 
					$cv=($depr_amor_pre_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($depr_amor_pre_cost_dzn/$price_dzn)*100,2); ?></td>
				</tr>
			<?
				 $total_other_components_dzn = $lab_test_dzn+$inspection_dzn+$cm_cost_dzn+$freight_dzn+$currier_pre_cost_dzn+$certificate_pre_cost_dzn+$deffdlc_cost_dzn+$interest_cost_dzn+$incometax_cost_dzn+$common_oh_dzn+$depr_amor_pre_cost_dzn+$design_cost_dzn+$studio_cost_dzn;
				   $total_other_components =$lab_test_cost+$inspection_cost+$cm_cost+$freight_cost+$currier_cost+$certificate_cost+$deffdlc_cost+$interest_cost+$incometax_cost+$common_oh+$depr_amor_pre_cost+$design_cost+$studio_cost;
		   }
			?>
				<tr class="rpt_bottom" style="font-weight:bold">
					<td>Others Total</td>                    
					<td align="right"><? // echo fn_number_format($total_other_components,4); ?></td>
					<td align="right"><? echo fn_number_format($total_other_components_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($total_other_components,2); ?></td>
					<td align="right"><? 
					$cv=($total_other_components_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($total_other_components_dzn/$price_dzn)*100,2); ?></td>
				</tr> 
			</table>
			</td>
				   <td colspan="5"   valign="top">
					  <table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:260px; margin-top:20px" rules="all">
					 <?
						// image show here  -------------------------------------------
						 $sql = "select id,master_tble_id,image_location from common_photo_library   where master_tble_id=$txt_job_no and file_type=1  and rownum=1 ";
						$photo_data_array=sql_select($sql);
					 ?> 
					<? foreach($photo_data_array AS $inf){ ?>
						  <tr class="rpt_bottom" style="font-weight:bold">
							<td align="center"><img  src='../../<? echo $inf[csf("image_location")]; ?>' height='250px' width='250px' /></td>
						 </tr>
					<?  } ?>			
		
				  </table>
				   </td>
		  </tr>
		  </table>
		 <br/>
	  <?
			//End Commission Cost Part report here -------------------------------------------	
		  
			//start	all summary report here -------------------------------------------
			//job_no $txt_po_breack_down_id_cond $company_name $cbo_buyer_name $txt_style_ref
			 $sql = "select fabric_cost,fabric_cost_percent,trims_cost,trims_cost_percent,embel_cost,embel_cost_percent,wash_cost,wash_cost_percent,comm_cost,comm_cost_percent,commission,commission_percent,lab_test,lab_test_percent,inspection,inspection_percent,cm_cost,cm_cost_percent,freight,freight_percent,currier_pre_cost,currier_percent,certificate_pre_cost,certificate_percent,common_oh,common_oh_percent,total_cost,deffdlc_cost,deffdlc_percent,interest_cost,interest_percent,incometax_cost,incometax_percent,total_cost_percent,price_dzn,price_dzn_percent,margin_dzn,margin_dzn_percent,price_pcs_or_set,depr_amor_pre_cost,depr_amor_po_price,price_pcs_or_set_percent,margin_pcs_set,margin_pcs_set_percent,cm_for_sipment_sche
					from wo_pre_cost_dtls
					where job_no=".$txt_job_no." and status_active=1 and is_deleted=0";
					
			$data_array=sql_select($sql);
			$others_cost_value=0; $fabric_cost=0; $trims_cost=0; $embel_cost=0; $comm_cost=0; $commission=0; $lab_test=0; $inspection=0; $cm_cost=0; $freight=0; $currier_pre_cost=0; $certificate_pre_cost=0; $common_oh=0;
	 ?>
 
		<div style="margin-top:15px">
		 <table>
		 <tr>
		 <td>
			<table class="rpt_table" border="1" cellpadding="1" cellspacing="1" style="width:650px;text-align:center;" rules="all">
			<caption><label  style="background:#CCCCCC; font-size:larger"><b style="float:left;background:#CCCCCC;">Order Profitability Summary</b> </label> </caption>	
				<tr style="font-weight:bold">
					<td width="80">SL</td>
					<td width="250">Particulars</td>
					<td width="100">Amount/<?=$costing_for; ?></td>
					<td width="100">TTL Amount</td>
					<td width="100" title="(Net FOB Value DZN/ Per DZN Order Value)*100">% to Ord. Value</td>                     
				</tr>
			<?
			$cm_cost_method_based_on=return_field_value("cm_cost_method_based_on", "variable_order_tracking", "company_name=$cbo_company_name  and variable_list=22 and status_active=1 and is_deleted=0");
			//echo $cm_cost_method_based_on.'AAAAAAAAAA';
			if($cm_cost_method_based_on=="") $cm_cost_method_based_on=0;else $cm_cost_method_based_on=$cm_cost_method_based_on;
			if($cm_cost_method_based_on==1)
			{
				$based_on_date=return_field_value("costing_date", "wo_pre_cost_mst", "job_no=".$txt_job_no." and status_active=1 and is_deleted=0 ");
			}
			else if($cm_cost_method_based_on==2)
			{
					$based_on_date=return_field_value("min(shipment_date) as shipment_date", "wo_po_break_down", "job_no_mst=".$txt_job_no." and status_active=1 and is_deleted=0 ","shipment_date");
					//echo $based_on_date.'GGGGGGG';
			}
			else if($cm_cost_method_based_on==3)
			{
					$based_on_date=return_field_value("max(shipment_date) as shipment_date", "wo_po_break_down", "job_no_mst=".$txt_job_no." and status_active=1 and is_deleted=0 ","shipment_date");
			}
			else if($cm_cost_method_based_on==4)
			{
					$based_on_date=return_field_value("min(pub_shipment_date) as pub_shipment_date", "wo_po_break_down", "job_no_mst=".$txt_job_no." and status_active=1 and is_deleted=0 ","pub_shipment_date");
			}
			else if($cm_cost_method_based_on==5)
			{
					$based_on_date=return_field_value("max(pub_shipment_date) as pub_shipment_date", "wo_po_break_down", "job_no_mst=".$txt_job_no." and status_active=1 and is_deleted=0 ","pub_shipment_date");
			}
			else
			{
				$based_on_date=return_field_value("costing_date", "wo_pre_cost_mst", "job_no=".$txt_job_no." and status_active=1 and is_deleted=0 ");
			}
			
			$based_on_date_new =change_date_format($based_on_date,'','',1);
			//echo $cm_cost_method_based_on.'='.$based_on_date_new.'fddf';
			
			$financial_para=array();
			$sql_std_para=sql_select("select cost_per_minute,interest_expense,income_tax,applying_period_date as from_period_date,applying_period_to_date from lib_standard_cm_entry where company_id=$cbo_company_name and status_active=1 and is_deleted=0  order by id desc");	
			foreach($sql_std_para as $row)
			{
				$applying_period_date=change_date_format($row[csf('from_period_date')],'','',1);
				$applying_period_to_date=change_date_format($row[csf('applying_period_to_date')],'','',1);
				$diff=datediff('d',$applying_period_date,$applying_period_to_date);
				for($j=0;$j<$diff;$j++)
				{
					$newdate =change_date_format(add_date(str_replace("'","",$applying_period_date),$j),'','',1);
					if($based_on_date_new==$newdate)
					{
						//echo $row[csf('cost_per_minute')].',';
						$financial_para[$newdate]['cost_per_minute']=$row[csf('cost_per_minute')];
						$financial_para[$newdate]['interest_expense']=$row[csf('interest_expense')];
						$financial_para[$newdate]['income_tax']=$row[csf('income_tax')];
					}
				}
			}
			//$row[csf("sew_effi_percent")]
			$cpm_budget=(($financial_para[$based_on_date_new]['cost_per_minute']/$exchange_rate)/$sew_effi_percent)*100;
			if(is_infinite($cpm_budget) || is_nan($cpm_budget)){$cpm_budget=0;}
			//	echo $based_on_date_new.'='.$financial_para[$based_on_date_new]['cost_per_minute'].'='.$exchange_rate.'='.$sew_effi_percent;
			$price_dzn=0;
			$sl=0;
			foreach( $data_array as $row )
			{ 
			//$fab_production_knit=$fabric_costing_arr['knit']['grey'][$job_no];
			//$fab_production_finish=$fabric_costing_arr['finish']['grey'][$job_no];
			
			$fab_purchase_knit2=array_sum($fabric_costing_arr2['knit']['grey'][$job_no]);
			if(is_infinite($fab_purchase_knit2) || is_nan($fab_purchase_knit2)){$fab_purchase_knit2=0;}
			$fab_purchase_woven2=array_sum($fabric_costing_arr2['woven']['grey'][$job_no]);
			if(is_infinite($fab_purchase_woven2) || is_nan($fab_purchase_woven2)){$fab_purchase_woven2=0;}
		
			$yarn_costing=$yarn_costing_arr[$job_no];
			$tot_fabric_cost=$fab_purchase_knit2+$fab_purchase_woven2;
			$conversion_cost=array_sum($conversion_costing_arr_process[$job_no]);
			if(is_infinite($conversion_cost) || is_nan($conversion_cost)){$conversion_cost=0;}
			//$testing_cost=$other_costing_arr[$job_no]['lab_test'];
			$freight_cost=$other_costing_arr[$job_no]['freight'];
			if(is_infinite($freight_cost) || is_nan($freight_cost)){$freight_cost=0;}
			$inspection_cost=$other_costing_arr[$job_no]['inspection'];
			if(is_infinite($inspection_cost) || is_nan($inspection_cost)){$inspection_cost=0;}
			$certificate_cost=$other_costing_arr[$job_no]['certificate_pre_cost'];
			if(is_infinite($certificate_cost) || is_nan($certificate_cost)){$certificate_cost=0;}
			$common_oh=$other_costing_arr[$job_no]['common_oh'];
			if(is_infinite($common_oh) || is_nan($common_oh)){$common_oh=0;}
			$currier_cost=$other_costing_arr[$job_no]['currier_pre_cost'];
			if(is_infinite($currier_cost) || is_nan($currier_cost)){$currier_cost=0;}
			$cm_cost=$other_costing_arr[$job_no]['cm_cost'];
			if(is_infinite($cm_cost) || is_nan($cm_cost)){$cm_cost=0;}
			$lab_test_cost=$other_costing_arr[$job_no]['lab_test'];
			if(is_infinite($lab_test_cost) || is_nan($lab_test_cost)){$lab_test_cost=0;}
			$depr_amor_pre_cost=$other_costing_arr[$job_no]['depr_amor_pre_cost'];
			if(is_infinite($depr_amor_pre_cost) || is_nan($depr_amor_pre_cost)){$depr_amor_pre_cost=0;}
			$deffdlc_cost=$other_costing_arr[$job_no]['deffdlc_cost'];
			if(is_infinite($deffdlc_cost) || is_nan($deffdlc_cost)){$deffdlc_cost=0;}
			$fabric_cost=$tot_fabric_cost;
			$trims_cost=$trims_costing_arr[$job_no];
			$embel_cost=$emblishment_costing_arr[$job_no];
			$wash=$emblishment_costing_arr_wash[$job_no];
			$commercial_cost=$commercial_costing_arr[$job_no];
			$comm_cost_dzn=$row[csf("comm_cost")];
			$cm_cost_dzn=$row[csf("cm_cost")];
			$price_dzn=$row[csf("price_dzn")];
			$total_cost_dzn=$row[csf("total_cost")];
			$deffdlc_cost_dzn=$row[csf("deffdlc_cost")];
			$interest_cost_dzn=$row[csf("interest_cost")];
			$incometax_cost_dzn=$row[csf("incometax_cost")];
			$commission_dzn=$row[csf("commission")];
			$operatin_expense_dzn=$row[csf("common_oh")];
			//deffdlc_cost,deffdlc_percent,interest_cost,interest_percent,incometax_cost,incometax_percent
			$deffdlc_percent=$row[csf("deffdlc_percent")];
			$interest_percent=$row[csf("interest_percent")];
			$incometax_percent=$row[csf("incometax_percent")];
			$depr_amor_po_price=$row[csf("depr_amor_po_price")];
			$depr_amor_pre_cost_dzn=$row[csf("depr_amor_pre_cost")];
			//interest_cost,interest_percent,incometax_cost
			$tot_commission=$commission_costing_arr[$job_no];
			$lab_test=$lab_test_cost;
			$inspection=$inspection_cost;
			$cm_cost=$cm_cost;
			$freight=$freight_cost;
			$currier_pre_cost=$currier_cost;
			$certificate_pre_cost=$certificate_cost;
			$sl=$sl+1;
			  $others_cost_value=$all_total_cost-$cm_cost-$freight-$commercial_cost-$commission;
			$price_dzn=0;
			
			$price_dzn=($total_po_value/$total_po_qty)*$order_price_per_dzn;
	?>	 
				<tr> 
					<td><? echo $sl; ?></td>
					<td align="left"><b>Gross FOB Value/ <?=$costing_for; ?></b></td>
					  <td align="right" title="Order value/Order Qty*Costing Per"><b><? echo fn_number_format($price_dzn,4); ?></b></td>
					<td align="right"><b><? echo fn_number_format($total_po_value,2);//$price_dzn=$tot_order_value; ?></b></td>
					<td align="center"><? echo "100.00%"; ?></td>
					
				</tr>
				<tr>
					<td><? echo ++$sl; ?></td>
					<td align="left">Less Commission</td>
					<td align="right"><? echo fn_number_format($commission_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($tot_commission,2); ?></td>
					<td align="center"><? echo fn_number_format(($commission_dzn/$price_dzn)*100,2); ?>%</td>
				</tr>
			  
				<tr>
					<td><? echo ++$sl; ?></td>
					<td align="left">Net FOB Value (1-2)</td>
					<td align="right">
					<? 
						$net_fob_value_dzn=$price_dzn-$commission_dzn;  echo fn_number_format($net_fob_value_dzn,4);
						 
					?>
					</td>
					 <td align="right"><? $net_fob_value=$total_po_value-$tot_commission;echo fn_number_format($net_fob_value,2); ?></td>
					<td align="center" ><? 
					$cv=($net_fob_value_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($net_fob_value_dzn/$price_dzn)*100,2); ?>%</td>
				</tr>
				<tr>
					<td><? echo ++$sl; ?></td>
					<td align="left">Less: Material & Services Cost</td>
					<td align="right"><? $total_material_services_dzn=$total_fab_cost_dzn+$total_trims_cost_dzn+$total_embellishment_amt_dzn+$lab_test_dzn+$inspection_dzn+$freight_dzn+$currier_pre_cost_dzn+$certificate_pre_cost_dzn+$deffdlc_cost_dzn;
									$total_material_services=$total_trims_cost+$all_fab_cost+$total_embellishment_amt+$lab_test_cost+$inspection_cost+$freight_cost+$currier_cost+$certificate_cost+$deffdlc_cost;
 
						echo fn_number_format($total_material_services_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($total_material_services,2); ?></td>
					<td align="center"><? 
					$cv=($total_material_services_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($total_material_services_dzn/$price_dzn)*100,2);//fn_number_format($row[csf("embel_cost_percent")],2); ?>%</td>
				</tr>
				 <tr>
					<td><? echo ++$sl; ?></td>
					<td align="left">Less: Commercial Cost</td>
					<td align="right"><? echo fn_number_format($comm_cost_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($commercial_cost,2); ?></td>
					<td align="center"><? 
					$cv=($comm_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($comm_cost_dzn/$price_dzn)*100,2); ?>%</td>
				</tr>
				
				<tr>
					<td><? echo ++$sl; ?></td>
					<td align="left">Contribution Margin/CM Value (3-4-5)</td>
					<td align="right">
					<? 
						$contributions_value_dzn=$net_fob_value_dzn-$total_material_services_dzn-$comm_cost_dzn;
							$contributions_value=$net_fob_value-$total_material_services-$commercial_cost;
							echo fn_number_format($contributions_value_dzn,4); 
							$precostData['CMValue']=$contributions_value;
							$precostData['CMCost']=$cm_cost;
							
					?>
					</td>
					<td align="right"><? echo fn_number_format($contributions_value,2); ?></td>
					<td align="center"><? 
					$cv=($contributions_value_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($contributions_value_dzn/$price_dzn)*100,2); ?>%</td>
				</tr>
				<tr>
					<td><? echo ++$sl; ?></td>
					<td align="left">Less: CM Cost </td>
					<td align="right"><? echo fn_number_format($cm_cost_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($cm_cost,2); ?></td>
					<td align="center"><? 
					$cv=($cm_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($cm_cost_dzn/$price_dzn)*100,2); ?>%</td>
				</tr>
				<tr>
					<td><? echo ++$sl; ?></td>
					<td align="left">Gross Profit(6-7)</td>
					<td align="right"><? $gross_profit_dzn=$contributions_value_dzn-$cm_cost_dzn;
					$gross_profit_loss=$contributions_value-$cm_cost;
					
					echo fn_number_format($gross_profit_dzn,4); ?></td>
					 <td align="right"><? echo fn_number_format($gross_profit_loss,2); ?></td>
					<td align="center"><? 
					$cv=($gross_profit_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($gross_profit_dzn/$price_dzn)*100,2); ?>%</td>
				</tr>
			   
				<tr>
					<td><? echo ++$sl; ?></td>
					<td align="left">Less: Operating Expensees</td>
					<td align="right"><? echo fn_number_format($operatin_expense_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($common_oh,2); ?></td>
					<td align="center"><? 
					$cv=($operatin_expense_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($operatin_expense_dzn/$price_dzn)*100,2); ?>%</td>
				 </tr>
				<tr>
					<td><? echo ++$sl; ?></td>
					<td align="left">Operating Profit/Loss [8-(9)]</td>
					<td align="right">
					<? 
					$operating_profit_dzn=$gross_profit_dzn-($operatin_expense_dzn);
					$operating_profit_loss=$gross_profit_loss-($operatin_expense_dzn);
					echo fn_number_format($operating_profit_dzn,4); 
					?>
					</td>
					<td align="right"><? echo fn_number_format($operating_profit_loss,2); ?></td>
					<td align="center"><? 
					$cv=($operating_profit_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($operating_profit_dzn/$price_dzn)*100,2); ?>%</td>
				 </tr>
				<tr> 
					<td><? echo ++$sl; ?></td>
					<td align="left">Less: Depreciation & Amortization </td>
					<td align="right"><? echo fn_number_format($depr_amor_pre_cost_dzn,4); ?></td>
					<td align="right"><? echo fn_number_format($depr_amor_pre_cost,2); ?></td>
					<td align="center"><? 
					$cv=($depr_amor_pre_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($depr_amor_pre_cost_dzn/$price_dzn)*100,2); ?>%</td>
				 </tr>
				<tr>
					<td><? echo ++$sl; ?></td>
					<td align="left">Less: Interest</td>
					<td align="right"><? echo fn_number_format($interest_cost_dzn,4); ?></td>
					<td align="right"><? //echo fn_number_format($interest_cost_dzn,4); ?></td>
					<td align="center"><? 
					$cv=($interest_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($interest_cost_dzn/$price_dzn)*100,2); ?>%</td>
				 </tr>
				 <tr>
					<td><? echo ++$sl; ?></td>
					<td align="left">Less: Income Tax</td>
					<td align="right"><? echo fn_number_format($incometax_cost_dzn,4); ?></td>
					 <td align="right"><? //echo fn_number_format($incometax_cost_dzn,4); ?></td>
					<td align="center"><? 
					$cv=($incometax_cost_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					//echo fn_number_format(($incometax_cost_dzn/$price_dzn)*100,2); ?>%</td>
				 </tr>
				  <tr>
					<td><? echo ++$sl; ?></td>
					<td align="left">Net Profit [10-(11+12+13)]</td>
					<td align="right"><? $net_profit_dzn=$operating_profit_dzn-($depr_amor_pre_cost_dzn+$interest_cost_dzn+$incometax_cost_dzn);
					$net_profit=$operating_profit_loss-($depr_amor_pre_cost);
					echo fn_number_format($net_profit_dzn,4); ?></td>
					 <td align="center"><? echo fn_number_format($net_profit,2); ?></td>
					 <td align="center" title="Net Profit Dzn/Tot Fob Dzn*100">
					 <? 
					$cv=($net_profit_dzn/$price_dzn)*100;
					if(is_infinite($cv) || is_nan($cv)){$cv=0;}
					echo fn_number_format($cv,2); 
					 //echo fn_number_format(($net_profit_dzn/$price_dzn)*100,2); ?>%</td>
				 </tr>
				<tr>
					<td><? echo ++$sl; ?></td>
					<td align="left"  title="Contribution Mergin /<?=$order_price_per_dzn;?>/Tot SMV(<?  echo $pre_costing_smv;?>)">EPM (Per Pcs CM/SMV)</td>
					 <td align="right" colspan="3"><? 
					 $epm_per_pcs=($contributions_value_dzn/$order_price_per_dzn)/$pre_costing_smv;
					 if(is_infinite($epm_per_pcs) || is_nan($epm_per_pcs)){$epm_per_pcs=0;}
					 echo fn_number_format($epm_per_pcs,4); ?></td>
				 </tr>
				  <tr>
					<td><? echo ++$sl; ?></td>
					<td align="left">CPM </td>
					<td align="right" colspan="3" title="CPM/Exchange Rate/Efficiency %"><?  echo fn_number_format($cpm_budget,4); ?></td>
				 </tr>
			<?
			}
			$total_job_cost=$total_trims_cost+$all_fab_cost+$total_embellishment_amt+$total_other_components+$total_commercial_cost+$total_commission_cost;
			?>
			</table>
			</td>
			<td valign="top"> 
			 <div style="margin-top:0px;">
				<table class="rpt_table" border="1" cellpadding="1" cellspacing="1"style="width:320px;text-align:center;" rules="all">
				<label><b>Cost Summary on Total Order Qty</b></label>
					<tr style="font-weight:bold">
						<td width="130">Particulars</td>
						<td width="80">Amount (USD)</td>
						<td width="80">%</td>
					</tr>            
					<tr>
						<td align="left">Total Order Value </td>
						<td align="right"><? 
						 echo fn_number_format($total_po_value,2); ?></td>
						<td align="center"><? 
						$cv=$total_po_value/$total_po_value*100;
						if(is_infinite($cv) || is_nan($cv)){$cv=0;}
						echo fn_number_format($cv,2); 
						//echo fn_number_format($total_po_value/$total_po_value*100,2); ?></td>
					</tr> 
					 <tr>
						<td align="left">Total Cost </td>
						<td align="right" title="Total Trims+Total All Fabric Cost+Emblish+Other+Commercail+Commission "><?  //$total_cost = $total_job_cost;//$all_total_cost; 
						echo fn_number_format($total_job_cost,2);//$total_cost = $row[csf("total_cost")]/$order_price_per_dzn*$order_job_qnty; echo fn_number_format($total_cost,4); ?></td>
						<td align="center"><? 
						$cv=$total_job_cost/$total_po_value*100;
						if(is_infinite($cv) || is_nan($cv)){$cv=0;}
						echo fn_number_format($cv,2); 
						//echo fn_number_format($total_job_cost/$total_po_value*100,2); ?></td>
					</tr>
					 <tr>
						<td align="left">Total Margin </td>
						<td align="right" title="Total Order Value-Total Cost=(<?=$total_po_value.'-'.$total_job_cost; ?>)">
						
						
						<? 
						$total_margin_val = $total_po_value-$total_job_cost; 
						echo fn_number_format($total_margin_val,2); 
						
						$precostData['TotalMargin']=$total_margin_val;
						?>
						
						
						</td>
						<td align="center"><? 
						$cv=($total_margin_val/$total_po_value*100);
						if(is_infinite($cv) || is_nan($cv)){$cv=0;}
						echo fn_number_format($cv,2); 
						//echo fn_number_format(($total_margin_val/$total_po_value*100),2); 
						
							
						?></td>
					</tr>
					 <tr>
						<td align="left">Margin /<?=$costing_for; ?> </td>
						<td align="right" title="Tot Margin/PO Qty*12"><?
							$ord_val_dzn_per=($job_po_rate_set*12);
							
						 $margin_dzn=($total_margin_val/$total_po_qty)*12; 
						 if(is_infinite($margin_dzn) || is_nan($margin_dzn)){$margin_dzn=0;}
						 echo fn_number_format($margin_dzn,4); ?></td>
						<td align="center" title="<? echo $ord_val_dzn_per.'=Unit Rate*12'; ?>">
						<? 
						$cv=($margin_dzn/$ord_val_dzn_per)*100;
						if(is_infinite($cv) || is_nan($cv)){$cv=0;}
						echo fn_number_format($cv,2); 
						//echo fn_number_format(($margin_dzn/$ord_val_dzn_per)*100,2);
						
						  $margin_pcs=$margin_dzn/12;
						  if(is_infinite($margin_pcs) || is_nan($margin_pcs)){$margin_pcs=0;}
						 ?></td>
					</tr>
					<tr>
						<td align="left">Margin /Pcs </td>
						<td align="right" title="Margin Pcs=<? echo $margin_dzn/12;?>"><? echo fn_number_format($margin_pcs,4); ?></td>
						<td align="center" title="Rate=<? echo $job_po_rate;?>"><? 
						$cv=($margin_pcs/$job_po_rate_set)*100;
						if(is_infinite($cv) || is_nan($cv)){$cv=0;}
						echo fn_number_format($cv,2); 
						//echo fn_number_format(($margin_pcs/$job_po_rate_set)*100,2); ?></td>
					</tr>
				   </table>
				 </div>
			</td>
			</tr>
		</table>
	  </div>
	 <br/>
	 <?  echo signature_table(109, $cbo_company_name, "970px");?>
	 </div>
	 <?
	 disconnect($con);
	 ob_get_contents();
	 ob_end_clean();
	 
	  return $precostData;										
 
 }


 if($action=='ready_to_app_notification'){
	extract($_REQUEST);
	list($email,$is_mail_send)=explode('**',$mail_data);

	$buyer_name_arr=return_library_array( "select id,buyer_name from lib_buyer",'id','buyer_name');
	$teamArr=array();$marchentrArr=array();
	$teamSql = sql_select("select a.id, b.id as bid, a.team_name, a.team_leader_name, a.team_leader_email, a.user_tag_id, b.user_tag_id as user_id, b.team_member_name, b.team_member_email from lib_marketing_team a, lib_mkt_team_member_info b where a.id=b.team_id and a.status_active=1 and a.is_deleted=0 ");
	foreach($teamSql as $trow)
	{
		$teamArr[$trow[csf('id')]]['team_leader_name']=$trow[csf('team_leader_name')];
		$marchentrArr[$trow[csf('bid')]]['team_member_name']=$trow[csf('team_member_name')];
	}


	$sql= "select a.COMPANY_ID,a.JOB_NO,a.BUYER_ID,a.BOOKING_DATE, a.BOOKING_NO,a.SHORT_BOOKING_TYPE, b.TEAM_LEADER,b.DEALING_MARCHANT,b.FACTORY_MARCHANT ,sum(c.amount) as AMOUNT  from wo_booking_mst a, wo_po_details_master b,WO_BOOKING_DTLS c where a.job_no=b.job_no and a.BOOKING_NO=c.BOOKING_NO  and a.entry_form=88 and a.booking_type=1 and a.is_short=1 and a.id=$update_id and  a.status_active=1 and a.is_deleted=0 and  b.status_active=1 and b.is_deleted=0 group by a.COMPANY_ID,a.JOB_NO,a.BUYER_ID,a.BOOKING_DATE, a.BOOKING_NO,a.SHORT_BOOKING_TYPE, b.TEAM_LEADER,b.DEALING_MARCHANT,b.FACTORY_MARCHANT order by a.id DESC";
	//echo $sql;die;
	$sql_res=sql_select($sql);
	$row = $sql_res[0];

	ob_start();
	?>
	<b>Dear Sir,</b><br>	
	Please log in to ERP and  check below Additional Fabric Booking request for your electronic approval.<br>	

	<table border="1" rules="all">
		<tr><td>Company Name</td><td><?=$company_library[$row['COMPANY_ID']];?></td></tr>
		<tr><td>Buyer Name</td><td><?=$buyer_name_arr[$row['BUYER_ID']];?></td></tr>
		<tr><td>Booking Date</td><td><?=change_date_format($row['BOOKING_DATE']);?></td></tr>
		<tr><td>Booking No.</td><td><?=$row['BOOKING_NO'];?></td></tr>
		<tr><td>Short Booking Type</td><td><?=$short_booking_type[$row['SHORT_BOOKING_TYPE']];?></td></tr>
		<tr><td>Team Leader</td><td><?=$teamArr[$row['TEAM_LEADER']]['team_leader_name'];?></td></tr>
		<tr><td>Dealing Merchant</td><td><?=$marchentrArr[$row['DEALING_MARCHANT']]['team_member_name'];?></td></tr>
		<tr><td>Factory Merchant</td><td><?=$marchentrArr[$row['FACTORY_MARCHANT']]['team_member_name'];?></td></tr>
		<tr><td>Job No.</td><td><?=$row['JOB_NO'];?></td></tr>
		<tr><td>Budget Profit</td><td></td></tr>
		<tr><td>Additional fabric booking value</td><td></td></tr>
		<tr><td>Additional fabric booking value</td><td><?= $row['AMOUNT'];?></td></tr>
	</table>

	<?

	$mailBody=ob_get_contents();
	ob_clean();

	echo $mailBody;die;

	//Mail send------------------------------------------
		
		//require_once('../../../mailer/class.phpmailer.php');
		require_once('../../../auto_mail/setting/mail_setting.php');
		
		$mailToArr=array();
		if($msil_address){$mailToArr[]=$msil_address;}

		$elcetronicSql = "SELECT a.BUYER_ID,a.SEQUENCE_NO,a.BYPASS,b.USER_EMAIL  from electronic_approval_setup a join user_passwd b on a.user_id=b.id where a.IS_DELETED=0 and b.valid=1  AND a.ENTRY_FORM=12 and a.company_id=$cbo_company_name order by a.SEQUENCE_NO";
		
		$elcetronicSqlRes=sql_select($elcetronicSql);
		foreach($elcetronicSqlRes as $rows){
			if($rows['USER_EMAIL']){$mailToArr[]=$rows['USER_EMAIL'];}
			if($rows['BYPASS']==2){break;}
		}

		$to=implode(',',array_unique($mailToArr));

		//echo $to;die;
		$subject="Additional Fabric Booking Approval Request";
		$header=mailHeader();
		echo sendMailMailer( $to, $subject, $mailBody, $from_mail,$att_file_arr );


	//------------------------------------End;

exit();
}




?>